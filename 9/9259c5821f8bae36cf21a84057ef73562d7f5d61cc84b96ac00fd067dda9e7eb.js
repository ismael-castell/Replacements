/**
 * Wrap output of index.js in a function that is only called when dependencies
 * have loaded.
 */

function executeBundle() {
    
(()=>{var aS=Object.create;var is=Object.defineProperty,sS=Object.defineProperties,oS=Object.getOwnPropertyDescriptor,nS=Object.getOwnPropertyDescriptors,lS=Object.getOwnPropertyNames,pl=Object.getOwnPropertySymbols,cS=Object.getPrototypeOf,fl=Object.prototype.hasOwnProperty,hS=Object.prototype.propertyIsEnumerable;var gl=(i,e,t)=>e in i?is(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t,It=(i,e)=>{for(var t in e||(e={}))fl.call(e,t)&&gl(i,t,e[t]);if(pl)for(var t of pl(e))hS.call(e,t)&&gl(i,t,e[t]);return i},Si=(i,e)=>sS(i,nS(e)),uS=i=>is(i,"__esModule",{value:!0});var ka=(i,e)=>()=>(e||i((e={exports:{}}).exports,e),e.exports);var dS=(i,e,t)=>{if(e&&typeof e=="object"||typeof e=="function")for(let r of lS(e))!fl.call(i,r)&&r!=="default"&&is(i,r,{get:()=>e[r],enumerable:!(t=oS(e,r))||t.enumerable});return i},ca=i=>dS(uS(is(i!=null?aS(cS(i)):{},"default",i&&i.__esModule&&"default"in i?{get:()=>i.default,enumerable:!0}:{value:i,enumerable:!0})),i);var Hc=ka((Gc,ps)=>{(function(i,e){typeof define=="function"&&define.amd?define([],function(){return i.SeededShuffle=e()}):typeof ps=="object"&&ps.exports?ps.exports=e():i.SeededShuffle=e()})(Gc,function(){var i={strSeed:null,shuffle:function(e,t,r){if(this.getType(e)=="Array"&&this.setSeed(t)){for(var a=r?e.slice(0):e,s=a.length,o=this.genMap(s),n=s-1;n>0;n--)a[n]=a.splice(o[s-1-n],1,a[n])[0];return a}return null},unshuffle:function(e,t,r){if(this.getType(e)=="Array"&&this.setSeed(t)){for(var a=r?e.slice(0):e,s=a.length,o=this.genMap(s),n=1;n<s;n++)a[n]=a.splice(o[s-1-n],1,a[n])[0];return a}return null},genMap:function(e){for(var t=new Array(e),r=0;r<e;r++)t[r]=(this.__seed=(this.__seed*9301+49297)%233280)/233280*e|0;return t},setSeed:function(e){if(!/(number|string)/i.test(this.getType(e)))return!1;if(isNaN(e))var e=String(this.strSeed=e).split("").map(function(r){return r.charCodeAt(0)}).join("");return this.__seed=this.seed=Number(e)},getType:function(e){return Object.prototype.toString.call(e).match(/^\[object (.*)\]$/)[1]}};return Object.create(i)})});var th=ka((fs,gs)=>{(function(){"use strict";var i={};i.version="1.0.4",i.remove=function(y){var F=!1;if(y.slice(0,2)!="\xFF\xD8")if(y.slice(0,23)=="data:image/jpeg;base64,"||y.slice(0,22)=="data:image/jpg;base64,")y=h(y.split(",")[1]),F=!0;else throw new Error("Given data is not jpeg.");var b=g(y),S=b.filter(function(_){return!(_.slice(0,2)=="\xFF\xE1"&&_.slice(4,10)=="Exif\0\0")}),I=S.join("");return F&&(I="data:image/jpeg;base64,"+c(I)),I},i.insert=function(y,F){var b=!1;if(y.slice(0,6)!="Exif\0\0")throw new Error("Given data is not exif.");if(F.slice(0,2)!="\xFF\xD8")if(F.slice(0,23)=="data:image/jpeg;base64,"||F.slice(0,22)=="data:image/jpg;base64,")F=h(F.split(",")[1]),b=!0;else throw new Error("Given data is not jpeg.");var S="\xFF\xE1"+d(">H",[y.length+2])+y,I=g(F),_=v(I,S);return b&&(_="data:image/jpeg;base64,"+c(_)),_},i.load=function(y){var F;if(typeof y=="string")if(y.slice(0,2)=="\xFF\xD8")F=y;else if(y.slice(0,23)=="data:image/jpeg;base64,"||y.slice(0,22)=="data:image/jpg;base64,")F=h(y.split(",")[1]);else if(y.slice(0,4)=="Exif")F=y.slice(6);else throw new Error("'load' gots invalid file data.");else throw new Error("'load' gots invalid type argument.");var b={},S={"0th":{},Exif:{},GPS:{},Interop:{},"1st":{},thumbnail:null},I=new l(F);if(I.tiftag===null)return S;I.tiftag.slice(0,2)=="II"?I.endian_mark="<":I.endian_mark=">";var _=m(I.endian_mark+"L",I.tiftag.slice(4,8))[0];S["0th"]=I.get_ifd(_,"0th");var E=S["0th"].first_ifd_pointer;if(delete S["0th"].first_ifd_pointer,34665 in S["0th"]&&(_=S["0th"][34665],S.Exif=I.get_ifd(_,"Exif")),34853 in S["0th"]&&(_=S["0th"][34853],S.GPS=I.get_ifd(_,"GPS")),40965 in S.Exif&&(_=S.Exif[40965],S.Interop=I.get_ifd(_,"Interop")),E!="\0\0\0\0"&&(_=m(I.endian_mark+"L",E)[0],S["1st"]=I.get_ifd(_,"1st"),513 in S["1st"]&&514 in S["1st"])){var D=S["1st"][513]+S["1st"][514],w=I.tiftag.slice(S["1st"][513],D);S.thumbnail=w}return S},i.dump=function(y){var F=8,b=e(y),S="Exif\0\0MM\0*\0\0\0\b",I=!1,_=!1,E=!1,D=!1,w,N,M,z,W;"0th"in b?w=b["0th"]:w={},"Exif"in b&&Object.keys(b.Exif).length||"Interop"in b&&Object.keys(b.Interop).length?(w[34665]=1,I=!0,N=b.Exif,"Interop"in b&&Object.keys(b.Interop).length?(N[40965]=1,E=!0,M=b.Interop):Object.keys(N).indexOf(i.ExifIFD.InteroperabilityTag.toString())>-1&&delete N[40965]):Object.keys(w).indexOf(i.ImageIFD.ExifTag.toString())>-1&&delete w[34665],"GPS"in b&&Object.keys(b.GPS).length?(w[i.ImageIFD.GPSTag]=1,_=!0,z=b.GPS):Object.keys(w).indexOf(i.ImageIFD.GPSTag.toString())>-1&&delete w[i.ImageIFD.GPSTag],"1st"in b&&"thumbnail"in b&&b.thumbnail!=null&&(D=!0,b["1st"][513]=1,b["1st"][514]=1,W=b["1st"]);var j=n(w,"0th",0),J=j[0].length+I*12+_*12+4+j[1].length,ie,re="",he=0,ne,le="",Be=0,_e,pe="",Ie=0,ke,de="",Z;if(I&&(ie=n(N,"Exif",J),he=ie[0].length+E*12+ie[1].length),_&&(ne=n(z,"GPS",J+he),le=ne.join(""),Be=le.length),E){var U=J+he+Be;_e=n(M,"Interop",U),pe=_e.join(""),Ie=pe.length}if(D){var U=J+he+Be+Ie;if(ke=n(W,"1st",U),Z=t(b.thumbnail),Z.length>64e3)throw new Error("Given thumbnail is too large. max 64kB")}var k="",G="",L="",R="\0\0\0\0";if(I){var A=F+J,X=d(">L",[A]),Y=34665,ae=d(">H",[Y]),H=d(">H",[x.Long]),V=d(">L",[1]);k=ae+H+V+X}if(_){var A=F+J+he,X=d(">L",[A]),Y=34853,ae=d(">H",[Y]),H=d(">H",[x.Long]),V=d(">L",[1]);G=ae+H+V+X}if(E){var A=F+J+he+Be,X=d(">L",[A]),Y=40965,ae=d(">H",[Y]),H=d(">H",[x.Long]),V=d(">L",[1]);L=ae+H+V+X}if(D){var A=F+J+he+Be+Ie;R=d(">L",[A]);var K=A+ke[0].length+24+4+ke[1].length,ee="\0\0\0\0"+d(">L",[K]),se="\0\0\0\0"+d(">L",[Z.length]);de=ke[0]+ee+se+"\0\0\0\0"+ke[1]+Z}var ge=j[0]+k+G+R+j[1];return I&&(re=ie[0]+L+ie[1]),S+ge+re+le+pe+de};function e(y){return JSON.parse(JSON.stringify(y))}function t(y){for(var F=g(y);"\xFF\xE0"<=F[1].slice(0,2)&&F[1].slice(0,2)<="\xFF\xEF";)F=[F[0]].concat(F.slice(2));return F.join("")}function r(y){return d(">"+p("B",y.length),y)}function a(y){return d(">"+p("H",y.length),y)}function s(y){return d(">"+p("L",y.length),y)}function o(y,F,b){var S="",I="",_,E,D,w;if(F=="Byte")_=y.length,_<=4?I=r(y)+p("\0",4-_):(I=d(">L",[b]),S=r(y));else if(F=="Short")_=y.length,_<=2?I=a(y)+p("\0\0",2-_):(I=d(">L",[b]),S=a(y));else if(F=="Long")_=y.length,_<=1?I=s(y):(I=d(">L",[b]),S=s(y));else if(F=="Ascii")E=y+"\0",_=E.length,_>4?(I=d(">L",[b]),S=E):I=E+p("\0",4-_);else if(F=="Rational"){if(typeof y[0]=="number")_=1,D=y[0],w=y[1],E=d(">L",[D])+d(">L",[w]);else{_=y.length,E="";for(var N=0;N<_;N++)D=y[N][0],w=y[N][1],E+=d(">L",[D])+d(">L",[w])}I=d(">L",[b]),S=E}else if(F=="SRational"){if(typeof y[0]=="number")_=1,D=y[0],w=y[1],E=d(">l",[D])+d(">l",[w]);else{_=y.length,E="";for(var N=0;N<_;N++)D=y[N][0],w=y[N][1],E+=d(">l",[D])+d(">l",[w])}I=d(">L",[b]),S=E}else F=="Undefined"&&(_=y.length,_>4?(I=d(">L",[b]),S=y):I=y+p("\0",4-_));var M=d(">L",[_]);return[M,I,S]}function n(y,F,b){var S=8,I=Object.keys(y).length,_=d(">H",[I]),E;["0th","1st"].indexOf(F)>-1?E=2+I*12+4:E=2+I*12;var D="",w="",N;for(var N in y)if(typeof N=="string"&&(N=parseInt(N)),!(F=="0th"&&[34665,34853].indexOf(N)>-1)){{if(F=="Exif"&&N==40965)continue;if(F=="1st"&&[513,514].indexOf(N)>-1)continue}var M=y[N],z=d(">H",[N]),W=B[F][N].type,j=d(">H",[x[W]]);typeof M=="number"&&(M=[M]);var J=S+E+b+w.length,ie=o(M,W,J),re=ie[0],he=ie[1],ne=ie[2];D+=z+j+re+he,w+=ne}return[_+D,w]}function l(y){var F,b;if(y.slice(0,2)=="\xFF\xD8")F=g(y),b=f(F),b?this.tiftag=b.slice(10):this.tiftag=null;else if(["II","MM"].indexOf(y.slice(0,2))>-1)this.tiftag=y;else if(y.slice(0,4)=="Exif")this.tiftag=y.slice(6);else throw new Error("Given file is neither JPEG nor TIFF.")}if(l.prototype={get_ifd:function(y,F){var b={},S=m(this.endian_mark+"H",this.tiftag.slice(y,y+2))[0],I=y+2,_;["0th","1st"].indexOf(F)>-1?_="Image":_=F;for(var E=0;E<S;E++){y=I+12*E;var D=m(this.endian_mark+"H",this.tiftag.slice(y,y+2))[0],w=m(this.endian_mark+"H",this.tiftag.slice(y+2,y+4))[0],N=m(this.endian_mark+"L",this.tiftag.slice(y+4,y+8))[0],M=this.tiftag.slice(y+8,y+12),z=[w,N,M];D in B[_]&&(b[D]=this.convert_value(z))}return F=="0th"&&(y=I+12*S,b.first_ifd_pointer=this.tiftag.slice(y,y+4)),b},convert_value:function(y){var F=null,b=y[0],S=y[1],I=y[2],_;if(b==1)S>4?(_=m(this.endian_mark+"L",I)[0],F=m(this.endian_mark+p("B",S),this.tiftag.slice(_,_+S))):F=m(this.endian_mark+p("B",S),I.slice(0,S));else if(b==2)S>4?(_=m(this.endian_mark+"L",I)[0],F=this.tiftag.slice(_,_+S-1)):F=I.slice(0,S-1);else if(b==3)S>2?(_=m(this.endian_mark+"L",I)[0],F=m(this.endian_mark+p("H",S),this.tiftag.slice(_,_+S*2))):F=m(this.endian_mark+p("H",S),I.slice(0,S*2));else if(b==4)S>1?(_=m(this.endian_mark+"L",I)[0],F=m(this.endian_mark+p("L",S),this.tiftag.slice(_,_+S*4))):F=m(this.endian_mark+p("L",S),I);else if(b==5)if(_=m(this.endian_mark+"L",I)[0],S>1){F=[];for(var E=0;E<S;E++)F.push([m(this.endian_mark+"L",this.tiftag.slice(_+E*8,_+4+E*8))[0],m(this.endian_mark+"L",this.tiftag.slice(_+4+E*8,_+8+E*8))[0]])}else F=[m(this.endian_mark+"L",this.tiftag.slice(_,_+4))[0],m(this.endian_mark+"L",this.tiftag.slice(_+4,_+8))[0]];else if(b==7)S>4?(_=m(this.endian_mark+"L",I)[0],F=this.tiftag.slice(_,_+S)):F=I.slice(0,S);else if(b==9)S>1?(_=m(this.endian_mark+"L",I)[0],F=m(this.endian_mark+p("l",S),this.tiftag.slice(_,_+S*4))):F=m(this.endian_mark+p("l",S),I);else if(b==10)if(_=m(this.endian_mark+"L",I)[0],S>1){F=[];for(var E=0;E<S;E++)F.push([m(this.endian_mark+"l",this.tiftag.slice(_+E*8,_+4+E*8))[0],m(this.endian_mark+"l",this.tiftag.slice(_+4+E*8,_+8+E*8))[0]])}else F=[m(this.endian_mark+"l",this.tiftag.slice(_,_+4))[0],m(this.endian_mark+"l",this.tiftag.slice(_+4,_+8))[0]];else throw new Error("Exif might be wrong. Got incorrect value type to decode. type:"+b);return F instanceof Array&&F.length==1?F[0]:F}},typeof window!="undefined"&&typeof window.btoa=="function")var c=window.btoa;if(typeof c=="undefined")var c=function(F){for(var b="",S,I,_,E,D,w,N,M=0,z="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";M<F.length;)S=F.charCodeAt(M++),I=F.charCodeAt(M++),_=F.charCodeAt(M++),E=S>>2,D=(S&3)<<4|I>>4,w=(I&15)<<2|_>>6,N=_&63,isNaN(I)?w=N=64:isNaN(_)&&(N=64),b=b+z.charAt(E)+z.charAt(D)+z.charAt(w)+z.charAt(N);return b};if(typeof window!="undefined"&&typeof window.atob=="function")var h=window.atob;if(typeof h=="undefined")var h=function(F){var b="",S,I,_,E,D,w,N,M=0,z="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";for(F=F.replace(/[^A-Za-z0-9\+\/\=]/g,"");M<F.length;)E=z.indexOf(F.charAt(M++)),D=z.indexOf(F.charAt(M++)),w=z.indexOf(F.charAt(M++)),N=z.indexOf(F.charAt(M++)),S=E<<2|D>>4,I=(D&15)<<4|w>>2,_=(w&3)<<6|N,b=b+String.fromCharCode(S),w!=64&&(b=b+String.fromCharCode(I)),N!=64&&(b=b+String.fromCharCode(_));return b};function u(y){for(var F=slice2Segments(y),b,S,I,_=[192,193,194,195,197,198,199,201,202,203,205,206,207],E=0;E<F.length;E++)if(b=F[E],_.indexOf(b[1])>=0){I=b[5]*256+b[6],S=b[7]*256+b[8];break}return[S,I]}function d(y,F){if(!(F instanceof Array))throw new Error("'pack' error. Got invalid type argument.");if(y.length-1!=F.length)throw new Error("'pack' error. "+(y.length-1)+" marks, "+F.length+" elements.");var b;if(y[0]=="<")b=!0;else if(y[0]==">")b=!1;else throw new Error("");for(var S="",I=1,_=null,E=null,D=null;E=y[I];){if(E.toLowerCase()=="b"){if(_=F[I-1],E=="b"&&_<0&&(_+=256),_>255||_<0)throw new Error("'pack' error.");D=String.fromCharCode(_)}else if(E=="H"){if(_=F[I-1],_>65535||_<0)throw new Error("'pack' error.");D=String.fromCharCode(Math.floor(_%65536/256))+String.fromCharCode(_%256),b&&(D=D.split("").reverse().join(""))}else if(E.toLowerCase()=="l"){if(_=F[I-1],E=="l"&&_<0&&(_+=4294967296),_>4294967295||_<0)throw new Error("'pack' error.");D=String.fromCharCode(Math.floor(_/16777216))+String.fromCharCode(Math.floor(_%16777216/65536))+String.fromCharCode(Math.floor(_%65536/256))+String.fromCharCode(_%256),b&&(D=D.split("").reverse().join(""))}else throw new Error("'pack' error.");S+=D,I+=1}return S}function m(y,F){if(typeof F!="string")throw new Error("'unpack' error. Got invalid type argument.");for(var b=0,S=1;S<y.length;S++)if(y[S].toLowerCase()=="b")b+=1;else if(y[S].toLowerCase()=="h")b+=2;else if(y[S].toLowerCase()=="l")b+=4;else throw new Error("'unpack' error. Got invalid mark.");if(b!=F.length)throw new Error("'unpack' error. Mismatch between symbol and string length. "+b+":"+F.length);var I;if(y[0]=="<")I=!0;else if(y[0]==">")I=!1;else throw new Error("'unpack' error.");for(var _=[],E=0,D=1,w=null,N=null,M=null,z="";N=y[D];){if(N.toLowerCase()=="b")M=1,z=F.slice(E,E+M),w=z.charCodeAt(0),N=="b"&&w>=128&&(w-=256);else if(N=="H")M=2,z=F.slice(E,E+M),I&&(z=z.split("").reverse().join("")),w=z.charCodeAt(0)*256+z.charCodeAt(1);else if(N.toLowerCase()=="l")M=4,z=F.slice(E,E+M),I&&(z=z.split("").reverse().join("")),w=z.charCodeAt(0)*16777216+z.charCodeAt(1)*65536+z.charCodeAt(2)*256+z.charCodeAt(3),N=="l"&&w>=2147483648&&(w-=4294967296);else throw new Error("'unpack' error. "+N);_.push(w),E+=M,D+=1}return _}function p(y,F){for(var b="",S=0;S<F;S++)b+=y;return b}function g(y){if(y.slice(0,2)!="\xFF\xD8")throw new Error("Given data isn't JPEG.");for(var F=2,b=["\xFF\xD8"];;){if(y.slice(F,F+2)=="\xFF\xDA"){b.push(y.slice(F));break}else{var S=m(">H",y.slice(F+2,F+4))[0],I=F+S+2;b.push(y.slice(F,I)),F=I}if(F>=y.length)throw new Error("Wrong JPEG data.")}return b}function f(y){for(var F,b=0;b<y.length;b++)if(F=y[b],F.slice(0,2)=="\xFF\xE1"&&F.slice(4,10)=="Exif\0\0")return F;return null}function v(y,F){var b=!1,S=[];return y.forEach(function(I,_){I.slice(0,2)=="\xFF\xE1"&&I.slice(4,10)=="Exif\0\0"&&(b?S.unshift(_):(y[_]=F,b=!0))}),S.forEach(function(I){y.splice(I,1)}),!b&&F&&(y=[y[0],F].concat(y.slice(1))),y.join("")}function T(y){for(var F="",b=0;b<y.length;b++){var S=y.charCodeAt(b),I=(S<10?"0":"")+S.toString(16);F+=I+" "}return F}var x={Byte:1,Ascii:2,Short:3,Long:4,Rational:5,Undefined:7,SLong:9,SRational:10},B={Image:{11:{name:"ProcessingSoftware",type:"Ascii"},254:{name:"NewSubfileType",type:"Long"},255:{name:"SubfileType",type:"Short"},256:{name:"ImageWidth",type:"Long"},257:{name:"ImageLength",type:"Long"},258:{name:"BitsPerSample",type:"Short"},259:{name:"Compression",type:"Short"},262:{name:"PhotometricInterpretation",type:"Short"},263:{name:"Threshholding",type:"Short"},264:{name:"CellWidth",type:"Short"},265:{name:"CellLength",type:"Short"},266:{name:"FillOrder",type:"Short"},269:{name:"DocumentName",type:"Ascii"},270:{name:"ImageDescription",type:"Ascii"},271:{name:"Make",type:"Ascii"},272:{name:"Model",type:"Ascii"},273:{name:"StripOffsets",type:"Long"},274:{name:"Orientation",type:"Short"},277:{name:"SamplesPerPixel",type:"Short"},278:{name:"RowsPerStrip",type:"Long"},279:{name:"StripByteCounts",type:"Long"},282:{name:"XResolution",type:"Rational"},283:{name:"YResolution",type:"Rational"},284:{name:"PlanarConfiguration",type:"Short"},290:{name:"GrayResponseUnit",type:"Short"},291:{name:"GrayResponseCurve",type:"Short"},292:{name:"T4Options",type:"Long"},293:{name:"T6Options",type:"Long"},296:{name:"ResolutionUnit",type:"Short"},301:{name:"TransferFunction",type:"Short"},305:{name:"Software",type:"Ascii"},306:{name:"DateTime",type:"Ascii"},315:{name:"Artist",type:"Ascii"},316:{name:"HostComputer",type:"Ascii"},317:{name:"Predictor",type:"Short"},318:{name:"WhitePoint",type:"Rational"},319:{name:"PrimaryChromaticities",type:"Rational"},320:{name:"ColorMap",type:"Short"},321:{name:"HalftoneHints",type:"Short"},322:{name:"TileWidth",type:"Short"},323:{name:"TileLength",type:"Short"},324:{name:"TileOffsets",type:"Short"},325:{name:"TileByteCounts",type:"Short"},330:{name:"SubIFDs",type:"Long"},332:{name:"InkSet",type:"Short"},333:{name:"InkNames",type:"Ascii"},334:{name:"NumberOfInks",type:"Short"},336:{name:"DotRange",type:"Byte"},337:{name:"TargetPrinter",type:"Ascii"},338:{name:"ExtraSamples",type:"Short"},339:{name:"SampleFormat",type:"Short"},340:{name:"SMinSampleValue",type:"Short"},341:{name:"SMaxSampleValue",type:"Short"},342:{name:"TransferRange",type:"Short"},343:{name:"ClipPath",type:"Byte"},344:{name:"XClipPathUnits",type:"Long"},345:{name:"YClipPathUnits",type:"Long"},346:{name:"Indexed",type:"Short"},347:{name:"JPEGTables",type:"Undefined"},351:{name:"OPIProxy",type:"Short"},512:{name:"JPEGProc",type:"Long"},513:{name:"JPEGInterchangeFormat",type:"Long"},514:{name:"JPEGInterchangeFormatLength",type:"Long"},515:{name:"JPEGRestartInterval",type:"Short"},517:{name:"JPEGLosslessPredictors",type:"Short"},518:{name:"JPEGPointTransforms",type:"Short"},519:{name:"JPEGQTables",type:"Long"},520:{name:"JPEGDCTables",type:"Long"},521:{name:"JPEGACTables",type:"Long"},529:{name:"YCbCrCoefficients",type:"Rational"},530:{name:"YCbCrSubSampling",type:"Short"},531:{name:"YCbCrPositioning",type:"Short"},532:{name:"ReferenceBlackWhite",type:"Rational"},700:{name:"XMLPacket",type:"Byte"},18246:{name:"Rating",type:"Short"},18249:{name:"RatingPercent",type:"Short"},32781:{name:"ImageID",type:"Ascii"},33421:{name:"CFARepeatPatternDim",type:"Short"},33422:{name:"CFAPattern",type:"Byte"},33423:{name:"BatteryLevel",type:"Rational"},33432:{name:"Copyright",type:"Ascii"},33434:{name:"ExposureTime",type:"Rational"},34377:{name:"ImageResources",type:"Byte"},34665:{name:"ExifTag",type:"Long"},34675:{name:"InterColorProfile",type:"Undefined"},34853:{name:"GPSTag",type:"Long"},34857:{name:"Interlace",type:"Short"},34858:{name:"TimeZoneOffset",type:"Long"},34859:{name:"SelfTimerMode",type:"Short"},37387:{name:"FlashEnergy",type:"Rational"},37388:{name:"SpatialFrequencyResponse",type:"Undefined"},37389:{name:"Noise",type:"Undefined"},37390:{name:"FocalPlaneXResolution",type:"Rational"},37391:{name:"FocalPlaneYResolution",type:"Rational"},37392:{name:"FocalPlaneResolutionUnit",type:"Short"},37393:{name:"ImageNumber",type:"Long"},37394:{name:"SecurityClassification",type:"Ascii"},37395:{name:"ImageHistory",type:"Ascii"},37397:{name:"ExposureIndex",type:"Rational"},37398:{name:"TIFFEPStandardID",type:"Byte"},37399:{name:"SensingMethod",type:"Short"},40091:{name:"XPTitle",type:"Byte"},40092:{name:"XPComment",type:"Byte"},40093:{name:"XPAuthor",type:"Byte"},40094:{name:"XPKeywords",type:"Byte"},40095:{name:"XPSubject",type:"Byte"},50341:{name:"PrintImageMatching",type:"Undefined"},50706:{name:"DNGVersion",type:"Byte"},50707:{name:"DNGBackwardVersion",type:"Byte"},50708:{name:"UniqueCameraModel",type:"Ascii"},50709:{name:"LocalizedCameraModel",type:"Byte"},50710:{name:"CFAPlaneColor",type:"Byte"},50711:{name:"CFALayout",type:"Short"},50712:{name:"LinearizationTable",type:"Short"},50713:{name:"BlackLevelRepeatDim",type:"Short"},50714:{name:"BlackLevel",type:"Rational"},50715:{name:"BlackLevelDeltaH",type:"SRational"},50716:{name:"BlackLevelDeltaV",type:"SRational"},50717:{name:"WhiteLevel",type:"Short"},50718:{name:"DefaultScale",type:"Rational"},50719:{name:"DefaultCropOrigin",type:"Short"},50720:{name:"DefaultCropSize",type:"Short"},50721:{name:"ColorMatrix1",type:"SRational"},50722:{name:"ColorMatrix2",type:"SRational"},50723:{name:"CameraCalibration1",type:"SRational"},50724:{name:"CameraCalibration2",type:"SRational"},50725:{name:"ReductionMatrix1",type:"SRational"},50726:{name:"ReductionMatrix2",type:"SRational"},50727:{name:"AnalogBalance",type:"Rational"},50728:{name:"AsShotNeutral",type:"Short"},50729:{name:"AsShotWhiteXY",type:"Rational"},50730:{name:"BaselineExposure",type:"SRational"},50731:{name:"BaselineNoise",type:"Rational"},50732:{name:"BaselineSharpness",type:"Rational"},50733:{name:"BayerGreenSplit",type:"Long"},50734:{name:"LinearResponseLimit",type:"Rational"},50735:{name:"CameraSerialNumber",type:"Ascii"},50736:{name:"LensInfo",type:"Rational"},50737:{name:"ChromaBlurRadius",type:"Rational"},50738:{name:"AntiAliasStrength",type:"Rational"},50739:{name:"ShadowScale",type:"SRational"},50740:{name:"DNGPrivateData",type:"Byte"},50741:{name:"MakerNoteSafety",type:"Short"},50778:{name:"CalibrationIlluminant1",type:"Short"},50779:{name:"CalibrationIlluminant2",type:"Short"},50780:{name:"BestQualityScale",type:"Rational"},50781:{name:"RawDataUniqueID",type:"Byte"},50827:{name:"OriginalRawFileName",type:"Byte"},50828:{name:"OriginalRawFileData",type:"Undefined"},50829:{name:"ActiveArea",type:"Short"},50830:{name:"MaskedAreas",type:"Short"},50831:{name:"AsShotICCProfile",type:"Undefined"},50832:{name:"AsShotPreProfileMatrix",type:"SRational"},50833:{name:"CurrentICCProfile",type:"Undefined"},50834:{name:"CurrentPreProfileMatrix",type:"SRational"},50879:{name:"ColorimetricReference",type:"Short"},50931:{name:"CameraCalibrationSignature",type:"Byte"},50932:{name:"ProfileCalibrationSignature",type:"Byte"},50934:{name:"AsShotProfileName",type:"Byte"},50935:{name:"NoiseReductionApplied",type:"Rational"},50936:{name:"ProfileName",type:"Byte"},50937:{name:"ProfileHueSatMapDims",type:"Long"},50938:{name:"ProfileHueSatMapData1",type:"Float"},50939:{name:"ProfileHueSatMapData2",type:"Float"},50940:{name:"ProfileToneCurve",type:"Float"},50941:{name:"ProfileEmbedPolicy",type:"Long"},50942:{name:"ProfileCopyright",type:"Byte"},50964:{name:"ForwardMatrix1",type:"SRational"},50965:{name:"ForwardMatrix2",type:"SRational"},50966:{name:"PreviewApplicationName",type:"Byte"},50967:{name:"PreviewApplicationVersion",type:"Byte"},50968:{name:"PreviewSettingsName",type:"Byte"},50969:{name:"PreviewSettingsDigest",type:"Byte"},50970:{name:"PreviewColorSpace",type:"Long"},50971:{name:"PreviewDateTime",type:"Ascii"},50972:{name:"RawImageDigest",type:"Undefined"},50973:{name:"OriginalRawFileDigest",type:"Undefined"},50974:{name:"SubTileBlockSize",type:"Long"},50975:{name:"RowInterleaveFactor",type:"Long"},50981:{name:"ProfileLookTableDims",type:"Long"},50982:{name:"ProfileLookTableData",type:"Float"},51008:{name:"OpcodeList1",type:"Undefined"},51009:{name:"OpcodeList2",type:"Undefined"},51022:{name:"OpcodeList3",type:"Undefined"}},Exif:{33434:{name:"ExposureTime",type:"Rational"},33437:{name:"FNumber",type:"Rational"},34850:{name:"ExposureProgram",type:"Short"},34852:{name:"SpectralSensitivity",type:"Ascii"},34855:{name:"ISOSpeedRatings",type:"Short"},34856:{name:"OECF",type:"Undefined"},34864:{name:"SensitivityType",type:"Short"},34865:{name:"StandardOutputSensitivity",type:"Long"},34866:{name:"RecommendedExposureIndex",type:"Long"},34867:{name:"ISOSpeed",type:"Long"},34868:{name:"ISOSpeedLatitudeyyy",type:"Long"},34869:{name:"ISOSpeedLatitudezzz",type:"Long"},36864:{name:"ExifVersion",type:"Undefined"},36867:{name:"DateTimeOriginal",type:"Ascii"},36868:{name:"DateTimeDigitized",type:"Ascii"},37121:{name:"ComponentsConfiguration",type:"Undefined"},37122:{name:"CompressedBitsPerPixel",type:"Rational"},37377:{name:"ShutterSpeedValue",type:"SRational"},37378:{name:"ApertureValue",type:"Rational"},37379:{name:"BrightnessValue",type:"SRational"},37380:{name:"ExposureBiasValue",type:"SRational"},37381:{name:"MaxApertureValue",type:"Rational"},37382:{name:"SubjectDistance",type:"Rational"},37383:{name:"MeteringMode",type:"Short"},37384:{name:"LightSource",type:"Short"},37385:{name:"Flash",type:"Short"},37386:{name:"FocalLength",type:"Rational"},37396:{name:"SubjectArea",type:"Short"},37500:{name:"MakerNote",type:"Undefined"},37510:{name:"UserComment",type:"Ascii"},37520:{name:"SubSecTime",type:"Ascii"},37521:{name:"SubSecTimeOriginal",type:"Ascii"},37522:{name:"SubSecTimeDigitized",type:"Ascii"},40960:{name:"FlashpixVersion",type:"Undefined"},40961:{name:"ColorSpace",type:"Short"},40962:{name:"PixelXDimension",type:"Long"},40963:{name:"PixelYDimension",type:"Long"},40964:{name:"RelatedSoundFile",type:"Ascii"},40965:{name:"InteroperabilityTag",type:"Long"},41483:{name:"FlashEnergy",type:"Rational"},41484:{name:"SpatialFrequencyResponse",type:"Undefined"},41486:{name:"FocalPlaneXResolution",type:"Rational"},41487:{name:"FocalPlaneYResolution",type:"Rational"},41488:{name:"FocalPlaneResolutionUnit",type:"Short"},41492:{name:"SubjectLocation",type:"Short"},41493:{name:"ExposureIndex",type:"Rational"},41495:{name:"SensingMethod",type:"Short"},41728:{name:"FileSource",type:"Undefined"},41729:{name:"SceneType",type:"Undefined"},41730:{name:"CFAPattern",type:"Undefined"},41985:{name:"CustomRendered",type:"Short"},41986:{name:"ExposureMode",type:"Short"},41987:{name:"WhiteBalance",type:"Short"},41988:{name:"DigitalZoomRatio",type:"Rational"},41989:{name:"FocalLengthIn35mmFilm",type:"Short"},41990:{name:"SceneCaptureType",type:"Short"},41991:{name:"GainControl",type:"Short"},41992:{name:"Contrast",type:"Short"},41993:{name:"Saturation",type:"Short"},41994:{name:"Sharpness",type:"Short"},41995:{name:"DeviceSettingDescription",type:"Undefined"},41996:{name:"SubjectDistanceRange",type:"Short"},42016:{name:"ImageUniqueID",type:"Ascii"},42032:{name:"CameraOwnerName",type:"Ascii"},42033:{name:"BodySerialNumber",type:"Ascii"},42034:{name:"LensSpecification",type:"Rational"},42035:{name:"LensMake",type:"Ascii"},42036:{name:"LensModel",type:"Ascii"},42037:{name:"LensSerialNumber",type:"Ascii"},42240:{name:"Gamma",type:"Rational"}},GPS:{0:{name:"GPSVersionID",type:"Byte"},1:{name:"GPSLatitudeRef",type:"Ascii"},2:{name:"GPSLatitude",type:"Rational"},3:{name:"GPSLongitudeRef",type:"Ascii"},4:{name:"GPSLongitude",type:"Rational"},5:{name:"GPSAltitudeRef",type:"Byte"},6:{name:"GPSAltitude",type:"Rational"},7:{name:"GPSTimeStamp",type:"Rational"},8:{name:"GPSSatellites",type:"Ascii"},9:{name:"GPSStatus",type:"Ascii"},10:{name:"GPSMeasureMode",type:"Ascii"},11:{name:"GPSDOP",type:"Rational"},12:{name:"GPSSpeedRef",type:"Ascii"},13:{name:"GPSSpeed",type:"Rational"},14:{name:"GPSTrackRef",type:"Ascii"},15:{name:"GPSTrack",type:"Rational"},16:{name:"GPSImgDirectionRef",type:"Ascii"},17:{name:"GPSImgDirection",type:"Rational"},18:{name:"GPSMapDatum",type:"Ascii"},19:{name:"GPSDestLatitudeRef",type:"Ascii"},20:{name:"GPSDestLatitude",type:"Rational"},21:{name:"GPSDestLongitudeRef",type:"Ascii"},22:{name:"GPSDestLongitude",type:"Rational"},23:{name:"GPSDestBearingRef",type:"Ascii"},24:{name:"GPSDestBearing",type:"Rational"},25:{name:"GPSDestDistanceRef",type:"Ascii"},26:{name:"GPSDestDistance",type:"Rational"},27:{name:"GPSProcessingMethod",type:"Undefined"},28:{name:"GPSAreaInformation",type:"Undefined"},29:{name:"GPSDateStamp",type:"Ascii"},30:{name:"GPSDifferential",type:"Short"},31:{name:"GPSHPositioningError",type:"Rational"}},Interop:{1:{name:"InteroperabilityIndex",type:"Ascii"}}};B["0th"]=B.Image,B["1st"]=B.Image,i.TAGS=B,i.ImageIFD={ProcessingSoftware:11,NewSubfileType:254,SubfileType:255,ImageWidth:256,ImageLength:257,BitsPerSample:258,Compression:259,PhotometricInterpretation:262,Threshholding:263,CellWidth:264,CellLength:265,FillOrder:266,DocumentName:269,ImageDescription:270,Make:271,Model:272,StripOffsets:273,Orientation:274,SamplesPerPixel:277,RowsPerStrip:278,StripByteCounts:279,XResolution:282,YResolution:283,PlanarConfiguration:284,GrayResponseUnit:290,GrayResponseCurve:291,T4Options:292,T6Options:293,ResolutionUnit:296,TransferFunction:301,Software:305,DateTime:306,Artist:315,HostComputer:316,Predictor:317,WhitePoint:318,PrimaryChromaticities:319,ColorMap:320,HalftoneHints:321,TileWidth:322,TileLength:323,TileOffsets:324,TileByteCounts:325,SubIFDs:330,InkSet:332,InkNames:333,NumberOfInks:334,DotRange:336,TargetPrinter:337,ExtraSamples:338,SampleFormat:339,SMinSampleValue:340,SMaxSampleValue:341,TransferRange:342,ClipPath:343,XClipPathUnits:344,YClipPathUnits:345,Indexed:346,JPEGTables:347,OPIProxy:351,JPEGProc:512,JPEGInterchangeFormat:513,JPEGInterchangeFormatLength:514,JPEGRestartInterval:515,JPEGLosslessPredictors:517,JPEGPointTransforms:518,JPEGQTables:519,JPEGDCTables:520,JPEGACTables:521,YCbCrCoefficients:529,YCbCrSubSampling:530,YCbCrPositioning:531,ReferenceBlackWhite:532,XMLPacket:700,Rating:18246,RatingPercent:18249,ImageID:32781,CFARepeatPatternDim:33421,CFAPattern:33422,BatteryLevel:33423,Copyright:33432,ExposureTime:33434,ImageResources:34377,ExifTag:34665,InterColorProfile:34675,GPSTag:34853,Interlace:34857,TimeZoneOffset:34858,SelfTimerMode:34859,FlashEnergy:37387,SpatialFrequencyResponse:37388,Noise:37389,FocalPlaneXResolution:37390,FocalPlaneYResolution:37391,FocalPlaneResolutionUnit:37392,ImageNumber:37393,SecurityClassification:37394,ImageHistory:37395,ExposureIndex:37397,TIFFEPStandardID:37398,SensingMethod:37399,XPTitle:40091,XPComment:40092,XPAuthor:40093,XPKeywords:40094,XPSubject:40095,PrintImageMatching:50341,DNGVersion:50706,DNGBackwardVersion:50707,UniqueCameraModel:50708,LocalizedCameraModel:50709,CFAPlaneColor:50710,CFALayout:50711,LinearizationTable:50712,BlackLevelRepeatDim:50713,BlackLevel:50714,BlackLevelDeltaH:50715,BlackLevelDeltaV:50716,WhiteLevel:50717,DefaultScale:50718,DefaultCropOrigin:50719,DefaultCropSize:50720,ColorMatrix1:50721,ColorMatrix2:50722,CameraCalibration1:50723,CameraCalibration2:50724,ReductionMatrix1:50725,ReductionMatrix2:50726,AnalogBalance:50727,AsShotNeutral:50728,AsShotWhiteXY:50729,BaselineExposure:50730,BaselineNoise:50731,BaselineSharpness:50732,BayerGreenSplit:50733,LinearResponseLimit:50734,CameraSerialNumber:50735,LensInfo:50736,ChromaBlurRadius:50737,AntiAliasStrength:50738,ShadowScale:50739,DNGPrivateData:50740,MakerNoteSafety:50741,CalibrationIlluminant1:50778,CalibrationIlluminant2:50779,BestQualityScale:50780,RawDataUniqueID:50781,OriginalRawFileName:50827,OriginalRawFileData:50828,ActiveArea:50829,MaskedAreas:50830,AsShotICCProfile:50831,AsShotPreProfileMatrix:50832,CurrentICCProfile:50833,CurrentPreProfileMatrix:50834,ColorimetricReference:50879,CameraCalibrationSignature:50931,ProfileCalibrationSignature:50932,AsShotProfileName:50934,NoiseReductionApplied:50935,ProfileName:50936,ProfileHueSatMapDims:50937,ProfileHueSatMapData1:50938,ProfileHueSatMapData2:50939,ProfileToneCurve:50940,ProfileEmbedPolicy:50941,ProfileCopyright:50942,ForwardMatrix1:50964,ForwardMatrix2:50965,PreviewApplicationName:50966,PreviewApplicationVersion:50967,PreviewSettingsName:50968,PreviewSettingsDigest:50969,PreviewColorSpace:50970,PreviewDateTime:50971,RawImageDigest:50972,OriginalRawFileDigest:50973,SubTileBlockSize:50974,RowInterleaveFactor:50975,ProfileLookTableDims:50981,ProfileLookTableData:50982,OpcodeList1:51008,OpcodeList2:51009,OpcodeList3:51022,NoiseProfile:51041},i.ExifIFD={ExposureTime:33434,FNumber:33437,ExposureProgram:34850,SpectralSensitivity:34852,ISOSpeedRatings:34855,OECF:34856,SensitivityType:34864,StandardOutputSensitivity:34865,RecommendedExposureIndex:34866,ISOSpeed:34867,ISOSpeedLatitudeyyy:34868,ISOSpeedLatitudezzz:34869,ExifVersion:36864,DateTimeOriginal:36867,DateTimeDigitized:36868,ComponentsConfiguration:37121,CompressedBitsPerPixel:37122,ShutterSpeedValue:37377,ApertureValue:37378,BrightnessValue:37379,ExposureBiasValue:37380,MaxApertureValue:37381,SubjectDistance:37382,MeteringMode:37383,LightSource:37384,Flash:37385,FocalLength:37386,SubjectArea:37396,MakerNote:37500,UserComment:37510,SubSecTime:37520,SubSecTimeOriginal:37521,SubSecTimeDigitized:37522,FlashpixVersion:40960,ColorSpace:40961,PixelXDimension:40962,PixelYDimension:40963,RelatedSoundFile:40964,InteroperabilityTag:40965,FlashEnergy:41483,SpatialFrequencyResponse:41484,FocalPlaneXResolution:41486,FocalPlaneYResolution:41487,FocalPlaneResolutionUnit:41488,SubjectLocation:41492,ExposureIndex:41493,SensingMethod:41495,FileSource:41728,SceneType:41729,CFAPattern:41730,CustomRendered:41985,ExposureMode:41986,WhiteBalance:41987,DigitalZoomRatio:41988,FocalLengthIn35mmFilm:41989,SceneCaptureType:41990,GainControl:41991,Contrast:41992,Saturation:41993,Sharpness:41994,DeviceSettingDescription:41995,SubjectDistanceRange:41996,ImageUniqueID:42016,CameraOwnerName:42032,BodySerialNumber:42033,LensSpecification:42034,LensMake:42035,LensModel:42036,LensSerialNumber:42037,Gamma:42240},i.GPSIFD={GPSVersionID:0,GPSLatitudeRef:1,GPSLatitude:2,GPSLongitudeRef:3,GPSLongitude:4,GPSAltitudeRef:5,GPSAltitude:6,GPSTimeStamp:7,GPSSatellites:8,GPSStatus:9,GPSMeasureMode:10,GPSDOP:11,GPSSpeedRef:12,GPSSpeed:13,GPSTrackRef:14,GPSTrack:15,GPSImgDirectionRef:16,GPSImgDirection:17,GPSMapDatum:18,GPSDestLatitudeRef:19,GPSDestLatitude:20,GPSDestLongitudeRef:21,GPSDestLongitude:22,GPSDestBearingRef:23,GPSDestBearing:24,GPSDestDistanceRef:25,GPSDestDistance:26,GPSProcessingMethod:27,GPSAreaInformation:28,GPSDateStamp:29,GPSDifferential:30,GPSHPositioningError:31},i.InteropIFD={InteroperabilityIndex:1},i.GPSHelper={degToDmsRational:function(y){var F=Math.abs(y),b=F%1*60,S=b%1*60,I=Math.floor(F),_=Math.floor(b),E=Math.round(S*100);return[[I,1],[_,1],[E,100]]},dmsRationalToDeg:function(y,F){var b=F==="S"||F==="W"?-1:1,S=y[0][0]/y[0][1]+y[1][0]/y[1][1]/60+y[2][0]/y[2][1]/3600;return S*b}},typeof fs!="undefined"?(typeof gs!="undefined"&&gs.exports&&(fs=gs.exports=i),fs.piexif=i):window.piexif=i})()});var Ab=ka((aQ,Es)=>{(function(){function i(C,P,$){return C.call.apply(C.bind,arguments)}function e(C,P,$){if(!C)throw Error();if(2<arguments.length){var q=Array.prototype.slice.call(arguments,2);return function(){var oe=Array.prototype.slice.call(arguments);return Array.prototype.unshift.apply(oe,q),C.apply(P,oe)}}return function(){return C.apply(P,arguments)}}function t(C,P,$){return t=Function.prototype.bind&&Function.prototype.bind.toString().indexOf("native code")!=-1?i:e,t.apply(null,arguments)}var r=Date.now||function(){return+new Date};function a(C,P){this.a=C,this.o=P||C,this.c=this.o.document}var s=!!window.FontFace;function o(C,P,$,q){if(P=C.c.createElement(P),$)for(var oe in $)$.hasOwnProperty(oe)&&(oe=="style"?P.style.cssText=$[oe]:P.setAttribute(oe,$[oe]));return q&&P.appendChild(C.c.createTextNode(q)),P}function n(C,P,$){C=C.c.getElementsByTagName(P)[0],C||(C=document.documentElement),C.insertBefore($,C.lastChild)}function l(C){C.parentNode&&C.parentNode.removeChild(C)}function c(C,P,$){P=P||[],$=$||[];for(var q=C.className.split(/\s+/),oe=0;oe<P.length;oe+=1){for(var ue=!1,Te=0;Te<q.length;Te+=1)if(P[oe]===q[Te]){ue=!0;break}ue||q.push(P[oe])}for(P=[],oe=0;oe<q.length;oe+=1){for(ue=!1,Te=0;Te<$.length;Te+=1)if(q[oe]===$[Te]){ue=!0;break}ue||P.push(q[oe])}C.className=P.join(" ").replace(/\s+/g," ").replace(/^\s+|\s+$/,"")}function h(C,P){for(var $=C.className.split(/\s+/),q=0,oe=$.length;q<oe;q++)if($[q]==P)return!0;return!1}function u(C){return C.o.location.hostname||C.a.location.hostname}function d(C,P,$){function q(){we&&oe&&ue&&(we(Te),we=null)}P=o(C,"link",{rel:"stylesheet",href:P,media:"all"});var oe=!1,ue=!0,Te=null,we=$||null;s?(P.onload=function(){oe=!0,q()},P.onerror=function(){oe=!0,Te=Error("Stylesheet failed to load"),q()}):setTimeout(function(){oe=!0,q()},0),n(C,"head",P)}function m(C,P,$,q){var oe=C.c.getElementsByTagName("head")[0];if(oe){var ue=o(C,"script",{src:P}),Te=!1;return ue.onload=ue.onreadystatechange=function(){Te||this.readyState&&this.readyState!="loaded"&&this.readyState!="complete"||(Te=!0,$&&$(null),ue.onload=ue.onreadystatechange=null,ue.parentNode.tagName=="HEAD"&&oe.removeChild(ue))},oe.appendChild(ue),setTimeout(function(){Te||(Te=!0,$&&$(Error("Script load timeout")))},q||5e3),ue}return null}function p(){this.a=0,this.c=null}function g(C){return C.a++,function(){C.a--,v(C)}}function f(C,P){C.c=P,v(C)}function v(C){C.a==0&&C.c&&(C.c(),C.c=null)}function T(C){this.a=C||"-"}T.prototype.c=function(C){for(var P=[],$=0;$<arguments.length;$++)P.push(arguments[$].replace(/[\W_]+/g,"").toLowerCase());return P.join(this.a)};function x(C,P){this.c=C,this.f=4,this.a="n";var $=(P||"n4").match(/^([nio])([1-9])$/i);$&&(this.a=$[1],this.f=parseInt($[2],10))}function B(C){return b(C)+" "+(C.f+"00")+" 300px "+y(C.c)}function y(C){var P=[];C=C.split(/,\s*/);for(var $=0;$<C.length;$++){var q=C[$].replace(/['"]/g,"");q.indexOf(" ")!=-1||/^\d/.test(q)?P.push("'"+q+"'"):P.push(q)}return P.join(",")}function F(C){return C.a+C.f}function b(C){var P="normal";return C.a==="o"?P="oblique":C.a==="i"&&(P="italic"),P}function S(C){var P=4,$="n",q=null;return C&&((q=C.match(/(normal|oblique|italic)/i))&&q[1]&&($=q[1].substr(0,1).toLowerCase()),(q=C.match(/([1-9]00|normal|bold)/i))&&q[1]&&(/bold/i.test(q[1])?P=7:/[1-9]00/.test(q[1])&&(P=parseInt(q[1].substr(0,1),10)))),$+P}function I(C,P){this.c=C,this.f=C.o.document.documentElement,this.h=P,this.a=new T("-"),this.j=P.events!==!1,this.g=P.classes!==!1}function _(C){C.g&&c(C.f,[C.a.c("wf","loading")]),D(C,"loading")}function E(C){if(C.g){var P=h(C.f,C.a.c("wf","active")),$=[],q=[C.a.c("wf","loading")];P||$.push(C.a.c("wf","inactive")),c(C.f,$,q)}D(C,"inactive")}function D(C,P,$){C.j&&C.h[P]&&($?C.h[P]($.c,F($)):C.h[P]())}function w(){this.c={}}function N(C,P,$){var q=[],oe;for(oe in P)if(P.hasOwnProperty(oe)){var ue=C.c[oe];ue&&q.push(ue(P[oe],$))}return q}function M(C,P){this.c=C,this.f=P,this.a=o(this.c,"span",{"aria-hidden":"true"},this.f)}function z(C){n(C.c,"body",C.a)}function W(C){return"display:block;position:absolute;top:-9999px;left:-9999px;font-size:300px;width:auto;height:auto;line-height:normal;margin:0;padding:0;font-variant:normal;white-space:nowrap;font-family:"+y(C.c)+";"+("font-style:"+b(C)+";font-weight:"+(C.f+"00")+";")}function j(C,P,$,q,oe,ue){this.g=C,this.j=P,this.a=q,this.c=$,this.f=oe||3e3,this.h=ue||void 0}j.prototype.start=function(){var C=this.c.o.document,P=this,$=r(),q=new Promise(function(Te,we){function Le(){r()-$>=P.f?we():C.fonts.load(B(P.a),P.h).then(function(We){1<=We.length?Te():setTimeout(Le,25)},function(){we()})}Le()}),oe=null,ue=new Promise(function(Te,we){oe=setTimeout(we,P.f)});Promise.race([ue,q]).then(function(){oe&&(clearTimeout(oe),oe=null),P.g(P.a)},function(){P.j(P.a)})};function J(C,P,$,q,oe,ue,Te){this.v=C,this.B=P,this.c=$,this.a=q,this.s=Te||"BESbswy",this.f={},this.w=oe||3e3,this.u=ue||null,this.m=this.j=this.h=this.g=null,this.g=new M(this.c,this.s),this.h=new M(this.c,this.s),this.j=new M(this.c,this.s),this.m=new M(this.c,this.s),C=new x(this.a.c+",serif",F(this.a)),C=W(C),this.g.a.style.cssText=C,C=new x(this.a.c+",sans-serif",F(this.a)),C=W(C),this.h.a.style.cssText=C,C=new x("serif",F(this.a)),C=W(C),this.j.a.style.cssText=C,C=new x("sans-serif",F(this.a)),C=W(C),this.m.a.style.cssText=C,z(this.g),z(this.h),z(this.j),z(this.m)}var ie={D:"serif",C:"sans-serif"},re=null;function he(){if(re===null){var C=/AppleWebKit\/([0-9]+)(?:\.([0-9]+))/.exec(window.navigator.userAgent);re=!!C&&(536>parseInt(C[1],10)||parseInt(C[1],10)===536&&11>=parseInt(C[2],10))}return re}J.prototype.start=function(){this.f.serif=this.j.a.offsetWidth,this.f["sans-serif"]=this.m.a.offsetWidth,this.A=r(),le(this)};function ne(C,P,$){for(var q in ie)if(ie.hasOwnProperty(q)&&P===C.f[ie[q]]&&$===C.f[ie[q]])return!0;return!1}function le(C){var P=C.g.a.offsetWidth,$=C.h.a.offsetWidth,q;(q=P===C.f.serif&&$===C.f["sans-serif"])||(q=he()&&ne(C,P,$)),q?r()-C.A>=C.w?he()&&ne(C,P,$)&&(C.u===null||C.u.hasOwnProperty(C.a.c))?_e(C,C.v):_e(C,C.B):Be(C):_e(C,C.v)}function Be(C){setTimeout(t(function(){le(this)},C),50)}function _e(C,P){setTimeout(t(function(){l(this.g.a),l(this.h.a),l(this.j.a),l(this.m.a),P(this.a)},C),0)}function pe(C,P,$){this.c=C,this.a=P,this.f=0,this.m=this.j=!1,this.s=$}var Ie=null;pe.prototype.g=function(C){var P=this.a;P.g&&c(P.f,[P.a.c("wf",C.c,F(C).toString(),"active")],[P.a.c("wf",C.c,F(C).toString(),"loading"),P.a.c("wf",C.c,F(C).toString(),"inactive")]),D(P,"fontactive",C),this.m=!0,ke(this)},pe.prototype.h=function(C){var P=this.a;if(P.g){var $=h(P.f,P.a.c("wf",C.c,F(C).toString(),"active")),q=[],oe=[P.a.c("wf",C.c,F(C).toString(),"loading")];$||q.push(P.a.c("wf",C.c,F(C).toString(),"inactive")),c(P.f,q,oe)}D(P,"fontinactive",C),ke(this)};function ke(C){--C.f==0&&C.j&&(C.m?(C=C.a,C.g&&c(C.f,[C.a.c("wf","active")],[C.a.c("wf","loading"),C.a.c("wf","inactive")]),D(C,"active")):E(C.a))}function de(C){this.j=C,this.a=new w,this.h=0,this.f=this.g=!0}de.prototype.load=function(C){this.c=new a(this.j,C.context||this.j),this.g=C.events!==!1,this.f=C.classes!==!1,U(this,new I(this.c,C),C)};function Z(C,P,$,q,oe){var ue=--C.h==0;(C.f||C.g)&&setTimeout(function(){var Te=oe||null,we=q||null||{};if($.length===0&&ue)E(P.a);else{P.f+=$.length,ue&&(P.j=ue);var Le,We=[];for(Le=0;Le<$.length;Le++){var Qe=$[Le],Pt=we[Qe.c],Zt=P.a,ci=Qe;if(Zt.g&&c(Zt.f,[Zt.a.c("wf",ci.c,F(ci).toString(),"loading")]),D(Zt,"fontloading",ci),Zt=null,Ie===null)if(window.FontFace){var ci=/Gecko.*Firefox\/(\d+)/.exec(window.navigator.userAgent),la=/OS X.*Version\/10\..*Safari/.exec(window.navigator.userAgent)&&/Apple/.exec(window.navigator.vendor);Ie=ci?42<parseInt(ci[1],10):!la}else Ie=!1;Ie?Zt=new j(t(P.g,P),t(P.h,P),P.c,Qe,P.s,Pt):Zt=new J(t(P.g,P),t(P.h,P),P.c,Qe,P.s,Te,Pt),We.push(Zt)}for(Le=0;Le<We.length;Le++)We[Le].start()}},0)}function U(C,P,$){var q=[],oe=$.timeout;_(P);var q=N(C.a,$,C.c),ue=new pe(C.c,P,oe);for(C.h=q.length,P=0,$=q.length;P<$;P++)q[P].load(function(Te,we,Le){Z(C,ue,Te,we,Le)})}function k(C,P){this.c=C,this.a=P}k.prototype.load=function(C){function P(){if(ue["__mti_fntLst"+q]){var Te=ue["__mti_fntLst"+q](),we=[],Le;if(Te)for(var We=0;We<Te.length;We++){var Qe=Te[We].fontfamily;Te[We].fontStyle!=null&&Te[We].fontWeight!=null?(Le=Te[We].fontStyle+Te[We].fontWeight,we.push(new x(Qe,Le))):we.push(new x(Qe))}C(we)}else setTimeout(function(){P()},50)}var $=this,q=$.a.projectId,oe=$.a.version;if(q){var ue=$.c.o;m(this.c,($.a.api||"https://fast.fonts.net/jsapi")+"/"+q+".js"+(oe?"?v="+oe:""),function(Te){Te?C([]):(ue["__MonotypeConfiguration__"+q]=function(){return $.a},P())}).id="__MonotypeAPIScript__"+q}else C([])};function G(C,P){this.c=C,this.a=P}G.prototype.load=function(C){var P,$,q=this.a.urls||[],oe=this.a.families||[],ue=this.a.testStrings||{},Te=new p;for(P=0,$=q.length;P<$;P++)d(this.c,q[P],g(Te));var we=[];for(P=0,$=oe.length;P<$;P++)if(q=oe[P].split(":"),q[1])for(var Le=q[1].split(","),We=0;We<Le.length;We+=1)we.push(new x(q[0],Le[We]));else we.push(new x(q[0]));f(Te,function(){C(we,ue)})};function L(C,P){C?this.c=C:this.c=R,this.a=[],this.f=[],this.g=P||""}var R="https://fonts.googleapis.com/css";function A(C,P){for(var $=P.length,q=0;q<$;q++){var oe=P[q].split(":");oe.length==3&&C.f.push(oe.pop());var ue="";oe.length==2&&oe[1]!=""&&(ue=":"),C.a.push(oe.join(ue))}}function X(C){if(C.a.length==0)throw Error("No fonts to load!");if(C.c.indexOf("kit=")!=-1)return C.c;for(var P=C.a.length,$=[],q=0;q<P;q++)$.push(C.a[q].replace(/ /g,"+"));return P=C.c+"?family="+$.join("%7C"),0<C.f.length&&(P+="&subset="+C.f.join(",")),0<C.g.length&&(P+="&text="+encodeURIComponent(C.g)),P}function Y(C){this.f=C,this.a=[],this.c={}}var ae={latin:"BESbswy","latin-ext":"\xE7\xF6\xFC\u011F\u015F",cyrillic:"\u0439\u044F\u0416",greek:"\u03B1\u03B2\u03A3",khmer:"\u1780\u1781\u1782",Hanuman:"\u1780\u1781\u1782"},H={thin:"1",extralight:"2","extra-light":"2",ultralight:"2","ultra-light":"2",light:"3",regular:"4",book:"4",medium:"5","semi-bold":"6",semibold:"6","demi-bold":"6",demibold:"6",bold:"7","extra-bold":"8",extrabold:"8","ultra-bold":"8",ultrabold:"8",black:"9",heavy:"9",l:"3",r:"4",b:"7"},V={i:"i",italic:"i",n:"n",normal:"n"},K=/^(thin|(?:(?:extra|ultra)-?)?light|regular|book|medium|(?:(?:semi|demi|extra|ultra)-?)?bold|black|heavy|l|r|b|[1-9]00)?(n|i|normal|italic)?$/;function ee(C){for(var P=C.f.length,$=0;$<P;$++){var q=C.f[$].split(":"),oe=q[0].replace(/\+/g," "),ue=["n4"];if(2<=q.length){var Te,we=q[1];if(Te=[],we)for(var we=we.split(","),Le=we.length,We=0;We<Le;We++){var Qe;if(Qe=we[We],Qe.match(/^[\w-]+$/)){var Pt=K.exec(Qe.toLowerCase());if(Pt==null)Qe="";else{if(Qe=Pt[2],Qe=Qe==null||Qe==""?"n":V[Qe],Pt=Pt[1],Pt==null||Pt=="")Pt="4";else var Zt=H[Pt],Pt=Zt||(isNaN(Pt)?"4":Pt.substr(0,1));Qe=[Qe,Pt].join("")}}else Qe="";Qe&&Te.push(Qe)}0<Te.length&&(ue=Te),q.length==3&&(q=q[2],Te=[],q=q?q.split(","):Te,0<q.length&&(q=ae[q[0]])&&(C.c[oe]=q))}for(C.c[oe]||(q=ae[oe])&&(C.c[oe]=q),q=0;q<ue.length;q+=1)C.a.push(new x(oe,ue[q]))}}function se(C,P){this.c=C,this.a=P}var ge={Arimo:!0,Cousine:!0,Tinos:!0};se.prototype.load=function(C){var P=new p,$=this.c,q=new L(this.a.api,this.a.text),oe=this.a.families;A(q,oe);var ue=new Y(oe);ee(ue),d($,X(q),g(P)),f(P,function(){C(ue.a,ue.c,ge)})};function Ce(C,P){this.c=C,this.a=P}Ce.prototype.load=function(C){var P=this.a.id,$=this.c.o;P?m(this.c,(this.a.api||"https://use.typekit.net")+"/"+P+".js",function(q){if(q)C([]);else if($.Typekit&&$.Typekit.config&&$.Typekit.config.fn){q=$.Typekit.config.fn;for(var oe=[],ue=0;ue<q.length;ue+=2)for(var Te=q[ue],we=q[ue+1],Le=0;Le<we.length;Le++)oe.push(new x(Te,we[Le]));try{$.Typekit.load({events:!1,classes:!1,async:!0})}catch(We){}C(oe)}},2e3):C([])};function Ne(C,P){this.c=C,this.f=P,this.a=[]}Ne.prototype.load=function(C){var P=this.f.id,$=this.c.o,q=this;P?($.__webfontfontdeckmodule__||($.__webfontfontdeckmodule__={}),$.__webfontfontdeckmodule__[P]=function(oe,ue){for(var Te=0,we=ue.fonts.length;Te<we;++Te){var Le=ue.fonts[Te];q.a.push(new x(Le.name,S("font-weight:"+Le.weight+";font-style:"+Le.style)))}C(q.a)},m(this.c,(this.f.api||"https://f.fontdeck.com/s/css/js/")+u(this.c)+"/"+P+".js",function(oe){oe&&C([])})):C([])};var Ge=new de(window);Ge.a.c.custom=function(C,P){return new G(P,C)},Ge.a.c.fontdeck=function(C,P){return new Ne(P,C)},Ge.a.c.monotype=function(C,P){return new k(P,C)},Ge.a.c.typekit=function(C,P){return new Ce(P,C)},Ge.a.c.google=function(C,P){return new se(P,C)};var ze={load:t(Ge.load,Ge)};typeof define=="function"&&define.amd?define(function(){return ze}):typeof Es!="undefined"&&Es.exports?Es.exports=ze:(window.WebFont=ze,window.WebFontConfig&&Ge.load(window.WebFontConfig))})()});var qo=ka((Xa,Yo)=>{(function(i,e){typeof Xa=="object"&&typeof Yo=="object"?Yo.exports=e():typeof define=="function"&&define.amd?define("Fuse",[],e):typeof Xa=="object"?Xa.Fuse=e():i.Fuse=e()})(Xa,function(){return function(i){var e={};function t(r){if(e[r])return e[r].exports;var a=e[r]={i:r,l:!1,exports:{}};return i[r].call(a.exports,a,a.exports,t),a.l=!0,a.exports}return t.m=i,t.c=e,t.d=function(r,a,s){t.o(r,a)||Object.defineProperty(r,a,{enumerable:!0,get:s})},t.r=function(r){typeof Symbol!="undefined"&&Symbol.toStringTag&&Object.defineProperty(r,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(r,"__esModule",{value:!0})},t.t=function(r,a){if(1&a&&(r=t(r)),8&a||4&a&&typeof r=="object"&&r&&r.__esModule)return r;var s=Object.create(null);if(t.r(s),Object.defineProperty(s,"default",{enumerable:!0,value:r}),2&a&&typeof r!="string")for(var o in r)t.d(s,o,function(n){return r[n]}.bind(null,o));return s},t.n=function(r){var a=r&&r.__esModule?function(){return r.default}:function(){return r};return t.d(a,"a",a),a},t.o=function(r,a){return Object.prototype.hasOwnProperty.call(r,a)},t.p="",t(t.s=0)}([function(i,e,t){function r(h){return(r=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(u){return typeof u}:function(u){return u&&typeof Symbol=="function"&&u.constructor===Symbol&&u!==Symbol.prototype?"symbol":typeof u})(h)}function a(h,u){for(var d=0;d<u.length;d++){var m=u[d];m.enumerable=m.enumerable||!1,m.configurable=!0,"value"in m&&(m.writable=!0),Object.defineProperty(h,m.key,m)}}var s=t(1),o=t(7),n=o.get,l=(o.deepValue,o.isArray),c=function(){function h(p,g){var f=g.location,v=f===void 0?0:f,T=g.distance,x=T===void 0?100:T,B=g.threshold,y=B===void 0?.6:B,F=g.maxPatternLength,b=F===void 0?32:F,S=g.caseSensitive,I=S!==void 0&&S,_=g.tokenSeparator,E=_===void 0?/ +/g:_,D=g.findAllMatches,w=D!==void 0&&D,N=g.minMatchCharLength,M=N===void 0?1:N,z=g.id,W=z===void 0?null:z,j=g.keys,J=j===void 0?[]:j,ie=g.shouldSort,re=ie===void 0||ie,he=g.getFn,ne=he===void 0?n:he,le=g.sortFn,Be=le===void 0?function(R,A){return R.score-A.score}:le,_e=g.tokenize,pe=_e!==void 0&&_e,Ie=g.matchAllTokens,ke=Ie!==void 0&&Ie,de=g.includeMatches,Z=de!==void 0&&de,U=g.includeScore,k=U!==void 0&&U,G=g.verbose,L=G!==void 0&&G;(function(R,A){if(!(R instanceof A))throw new TypeError("Cannot call a class as a function")})(this,h),this.options={location:v,distance:x,threshold:y,maxPatternLength:b,isCaseSensitive:I,tokenSeparator:E,findAllMatches:w,minMatchCharLength:M,id:W,keys:J,includeMatches:Z,includeScore:k,shouldSort:re,getFn:ne,sortFn:Be,verbose:L,tokenize:pe,matchAllTokens:ke},this.setCollection(p),this._processKeys(J)}var u,d,m;return u=h,(d=[{key:"setCollection",value:function(p){return this.list=p,p}},{key:"_processKeys",value:function(p){if(this._keyWeights={},this._keyNames=[],p.length&&typeof p[0]=="string")for(var g=0,f=p.length;g<f;g+=1){var v=p[g];this._keyWeights[v]=1,this._keyNames.push(v)}else{for(var T=null,x=null,B=0,y=0,F=p.length;y<F;y+=1){var b=p[y];if(!b.hasOwnProperty("name"))throw new Error('Missing "name" property in key object');var S=b.name;if(this._keyNames.push(S),!b.hasOwnProperty("weight"))throw new Error('Missing "weight" property in key object');var I=b.weight;if(I<0||I>1)throw new Error('"weight" property in key must bein the range of [0, 1)');x=x==null?I:Math.max(x,I),T=T==null?I:Math.min(T,I),this._keyWeights[S]=I,B+=I}if(B>1)throw new Error("Total of weights cannot exceed 1")}}},{key:"search",value:function(p){var g=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{limit:!1};this._log(`---------
Search pattern: "`.concat(p,'"'));var f=this._prepareSearchers(p),v=f.tokenSearchers,T=f.fullSearcher,x=this._search(v,T);return this._computeScore(x),this.options.shouldSort&&this._sort(x),g.limit&&typeof g.limit=="number"&&(x=x.slice(0,g.limit)),this._format(x)}},{key:"_prepareSearchers",value:function(){var p=arguments.length>0&&arguments[0]!==void 0?arguments[0]:"",g=[];if(this.options.tokenize)for(var f=p.split(this.options.tokenSeparator),v=0,T=f.length;v<T;v+=1)g.push(new s(f[v],this.options));return{tokenSearchers:g,fullSearcher:new s(p,this.options)}}},{key:"_search",value:function(){var p=arguments.length>0&&arguments[0]!==void 0?arguments[0]:[],g=arguments.length>1?arguments[1]:void 0,f=this.list,v={},T=[];if(typeof f[0]=="string"){for(var x=0,B=f.length;x<B;x+=1)this._analyze({key:"",value:f[x],record:x,index:x},{resultMap:v,results:T,tokenSearchers:p,fullSearcher:g});return T}for(var y=0,F=f.length;y<F;y+=1)for(var b=f[y],S=0,I=this._keyNames.length;S<I;S+=1){var _=this._keyNames[S];this._analyze({key:_,value:this.options.getFn(b,_),record:b,index:y},{resultMap:v,results:T,tokenSearchers:p,fullSearcher:g})}return T}},{key:"_analyze",value:function(p,g){var f=this,v=p.key,T=p.arrayIndex,x=T===void 0?-1:T,B=p.value,y=p.record,F=p.index,b=g.tokenSearchers,S=b===void 0?[]:b,I=g.fullSearcher,_=g.resultMap,E=_===void 0?{}:_,D=g.results,w=D===void 0?[]:D;(function N(M,z,W,j){if(z!=null){if(typeof z=="string"){var J=!1,ie=-1,re=0;f._log(`
Key: `.concat(v===""?"--":v));var he=I.search(z);if(f._log('Full text: "'.concat(z,'", score: ').concat(he.score)),f.options.tokenize){for(var ne=z.split(f.options.tokenSeparator),le=ne.length,Be=[],_e=0,pe=S.length;_e<pe;_e+=1){var Ie=S[_e];f._log(`
Pattern: "`.concat(Ie.pattern,'"'));for(var ke=!1,de=0;de<le;de+=1){var Z=ne[de],U=Ie.search(Z),k={};U.isMatch?(k[Z]=U.score,J=!0,ke=!0,Be.push(U.score)):(k[Z]=1,f.options.matchAllTokens||Be.push(1)),f._log('Token: "'.concat(Z,'", score: ').concat(k[Z]))}ke&&(re+=1)}ie=Be[0];for(var G=Be.length,L=1;L<G;L+=1)ie+=Be[L];ie/=G,f._log("Token score average:",ie)}var R=he.score;ie>-1&&(R=(R+ie)/2),f._log("Score average:",R);var A=!f.options.tokenize||!f.options.matchAllTokens||re>=S.length;if(f._log(`
Check Matches: `.concat(A)),(J||he.isMatch)&&A){var X={key:v,arrayIndex:M,value:z,score:R};f.options.includeMatches&&(X.matchedIndices=he.matchedIndices);var Y=E[j];Y?Y.output.push(X):(E[j]={item:W,output:[X]},w.push(E[j]))}}else if(l(z))for(var ae=0,H=z.length;ae<H;ae+=1)N(ae,z[ae],W,j)}})(x,B,y,F)}},{key:"_computeScore",value:function(p){this._log(`

Computing score:
`);for(var g=this._keyWeights,f=!!Object.keys(g).length,v=0,T=p.length;v<T;v+=1){for(var x=p[v],B=x.output,y=B.length,F=1,b=0;b<y;b+=1){var S=B[b],I=S.key,_=f?g[I]:1,E=S.score===0&&g&&g[I]>0?Number.EPSILON:S.score;F*=Math.pow(E,_)}x.score=F,this._log(x)}}},{key:"_sort",value:function(p){this._log(`

Sorting....`),p.sort(this.options.sortFn)}},{key:"_format",value:function(p){var g=[];if(this.options.verbose){var f=[];this._log(`

Output:

`,JSON.stringify(p,function(S,I){if(r(I)==="object"&&I!==null){if(f.indexOf(I)!==-1)return;f.push(I)}return I},2)),f=null}var v=[];this.options.includeMatches&&v.push(function(S,I){var _=S.output;I.matches=[];for(var E=0,D=_.length;E<D;E+=1){var w=_[E];if(w.matchedIndices.length!==0){var N={indices:w.matchedIndices,value:w.value};w.key&&(N.key=w.key),w.hasOwnProperty("arrayIndex")&&w.arrayIndex>-1&&(N.arrayIndex=w.arrayIndex),I.matches.push(N)}}}),this.options.includeScore&&v.push(function(S,I){I.score=S.score});for(var T=0,x=p.length;T<x;T+=1){var B=p[T];if(this.options.id&&(B.item=this.options.getFn(B.item,this.options.id)[0]),v.length){for(var y={item:B.item},F=0,b=v.length;F<b;F+=1)v[F](B,y);g.push(y)}else g.push(B.item)}return g}},{key:"_log",value:function(){var p;this.options.verbose&&(p=console).log.apply(p,arguments)}}])&&a(u.prototype,d),m&&a(u,m),h}();i.exports=c},function(i,e,t){function r(l,c){for(var h=0;h<c.length;h++){var u=c[h];u.enumerable=u.enumerable||!1,u.configurable=!0,"value"in u&&(u.writable=!0),Object.defineProperty(l,u.key,u)}}var a=t(2),s=t(3),o=t(6),n=function(){function l(d,m){var p=m.location,g=p===void 0?0:p,f=m.distance,v=f===void 0?100:f,T=m.threshold,x=T===void 0?.6:T,B=m.maxPatternLength,y=B===void 0?32:B,F=m.isCaseSensitive,b=F!==void 0&&F,S=m.tokenSeparator,I=S===void 0?/ +/g:S,_=m.findAllMatches,E=_!==void 0&&_,D=m.minMatchCharLength,w=D===void 0?1:D,N=m.includeMatches,M=N!==void 0&&N;(function(z,W){if(!(z instanceof W))throw new TypeError("Cannot call a class as a function")})(this,l),this.options={location:g,distance:v,threshold:x,maxPatternLength:y,isCaseSensitive:b,tokenSeparator:I,findAllMatches:E,includeMatches:M,minMatchCharLength:w},this.pattern=b?d:d.toLowerCase(),this.pattern.length<=y&&(this.patternAlphabet=o(this.pattern))}var c,h,u;return c=l,(h=[{key:"search",value:function(d){var m=this.options,p=m.isCaseSensitive,g=m.includeMatches;if(p||(d=d.toLowerCase()),this.pattern===d){var f={isMatch:!0,score:0};return g&&(f.matchedIndices=[[0,d.length-1]]),f}var v=this.options,T=v.maxPatternLength,x=v.tokenSeparator;if(this.pattern.length>T)return a(d,this.pattern,x);var B=this.options,y=B.location,F=B.distance,b=B.threshold,S=B.findAllMatches,I=B.minMatchCharLength;return s(d,this.pattern,this.patternAlphabet,{location:y,distance:F,threshold:b,findAllMatches:S,minMatchCharLength:I,includeMatches:g})}}])&&r(c.prototype,h),u&&r(c,u),l}();i.exports=n},function(i,e){var t=/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g;i.exports=function(r,a){var s=arguments.length>2&&arguments[2]!==void 0?arguments[2]:/ +/g,o=new RegExp(a.replace(t,"\\$&").replace(s,"|")),n=r.match(o),l=!!n,c=[];if(l)for(var h=0,u=n.length;h<u;h+=1){var d=n[h];c.push([r.indexOf(d),d.length-1])}return{score:l?.5:1,isMatch:l,matchedIndices:c}}},function(i,e,t){var r=t(4),a=t(5);i.exports=function(s,o,n,l){for(var c=l.location,h=c===void 0?0:c,u=l.distance,d=u===void 0?100:u,m=l.threshold,p=m===void 0?.6:m,g=l.findAllMatches,f=g!==void 0&&g,v=l.minMatchCharLength,T=v===void 0?1:v,x=l.includeMatches,B=x!==void 0&&x,y=h,F=s.length,b=p,S=s.indexOf(o,y),I=o.length,_=[],E=0;E<F;E+=1)_[E]=0;if(S!==-1){var D=r(o,{errors:0,currentLocation:S,expectedLocation:y,distance:d});if(b=Math.min(D,b),(S=s.lastIndexOf(o,y+I))!==-1){var w=r(o,{errors:0,currentLocation:S,expectedLocation:y,distance:d});b=Math.min(w,b)}}S=-1;for(var N=[],M=1,z=I+F,W=1<<(I<=31?I-1:30),j=0;j<I;j+=1){for(var J=0,ie=z;J<ie;)r(o,{errors:j,currentLocation:y+ie,expectedLocation:y,distance:d})<=b?J=ie:z=ie,ie=Math.floor((z-J)/2+J);z=ie;var re=Math.max(1,y-ie+1),he=f?F:Math.min(y+ie,F)+I,ne=Array(he+2);ne[he+1]=(1<<j)-1;for(var le=he;le>=re;le-=1){var Be=le-1,_e=n[s.charAt(Be)];if(_e&&(_[Be]=1),ne[le]=(ne[le+1]<<1|1)&_e,j!==0&&(ne[le]|=(N[le+1]|N[le])<<1|1|N[le+1]),ne[le]&W&&(M=r(o,{errors:j,currentLocation:Be,expectedLocation:y,distance:d}))<=b){if(b=M,(S=Be)<=y)break;re=Math.max(1,2*y-S)}}if(r(o,{errors:j+1,currentLocation:y,expectedLocation:y,distance:d})>b)break;N=ne}var pe={isMatch:S>=0,score:M===0?.001:M};return B&&(pe.matchedIndices=a(_,T)),pe}},function(i,e){i.exports=function(t,r){var a=r.errors,s=a===void 0?0:a,o=r.currentLocation,n=o===void 0?0:o,l=r.expectedLocation,c=l===void 0?0:l,h=r.distance,u=h===void 0?100:h,d=s/t.length,m=Math.abs(c-n);return u?d+m/u:m?1:d}},function(i,e){i.exports=function(){for(var t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:[],r=arguments.length>1&&arguments[1]!==void 0?arguments[1]:1,a=[],s=-1,o=-1,n=0,l=t.length;n<l;n+=1){var c=t[n];c&&s===-1?s=n:c||s===-1||((o=n-1)-s+1>=r&&a.push([s,o]),s=-1)}return t[n-1]&&n-s>=r&&a.push([s,n-1]),a}},function(i,e){i.exports=function(t){for(var r={},a=t.length,s=0;s<a;s+=1)r[t.charAt(s)]=0;for(var o=0;o<a;o+=1)r[t.charAt(o)]|=1<<a-o-1;return r}},function(i,e){var t=function(o){return Array.isArray?Array.isArray(o):Object.prototype.toString.call(o)==="[object Array]"},r=function(o){return o==null?"":function(n){if(typeof n=="string")return n;var l=n+"";return l=="0"&&1/n==-1/0?"-0":l}(o)},a=function(o){return typeof o=="string"},s=function(o){return typeof o=="number"};i.exports={get:function(o,n){var l=[];return function c(h,u){if(u){var d=u.indexOf("."),m=u,p=null;d!==-1&&(m=u.slice(0,d),p=u.slice(d+1));var g=h[m];if(g!=null)if(p||!a(g)&&!s(g))if(t(g))for(var f=0,v=g.length;f<v;f+=1)c(g[f],p);else p&&c(g,p);else l.push(r(g))}else l.push(h)}(o,n),l},isArray:t,isString:a,isNum:s,toString:r}}])})});var z0=ka((sce,X0)=>{var cw=4,hw=.001,uw=1e-7,dw=10,Ja=11,eo=1/(Ja-1),mw=typeof Float32Array=="function";function V0(i,e){return 1-3*e+3*i}function U0(i,e){return 3*e-6*i}function G0(i){return 3*i}function to(i,e,t){return((V0(e,t)*i+U0(e,t))*i+G0(e))*i}function H0(i,e,t){return 3*V0(e,t)*i*i+2*U0(e,t)*i+G0(e)}function pw(i,e,t,r,a){var s,o,n=0;do o=e+(t-e)/2,s=to(o,r,a)-i,s>0?t=o:e=o;while(Math.abs(s)>uw&&++n<dw);return o}function fw(i,e,t,r){for(var a=0;a<cw;++a){var s=H0(e,t,r);if(s===0)return e;var o=to(e,t,r)-i;e-=o/s}return e}function gw(i){return i}X0.exports=function(e,t,r,a){if(!(0<=e&&e<=1&&0<=r&&r<=1))throw new Error("bezier x values must be in [0, 1] range");if(e===t&&r===a)return gw;for(var s=mw?new Float32Array(Ja):new Array(Ja),o=0;o<Ja;++o)s[o]=to(o*eo,e,r);function n(l){for(var c=0,h=1,u=Ja-1;h!==u&&s[h]<=l;++h)c+=eo;--h;var d=(l-s[h])/(s[h+1]-s[h]),m=c+d*eo,p=H0(m,e,r);return p>=hw?fw(l,m,e,r):p===0?m:pw(l,c,c+eo,e,r)}return function(c){return c===0?0:c===1?1:to(n(c),t,a)}}});var vl={topNavBarMaxHeight:56,topNavBarMinHeight:48,leftPrimaryMenuWidth:56,bottomPrimaryMenuHeight:50,bottomSecondaryMenuDefaultHeight:67,bottomTertiaryMenuHeight:240,imageManagerThumbSize:108,historyMenuThumbSize:24,historyMenuPreviewSize:240,sideMenuWidth:272,footerHeight:48,sideBySideImageHeight:144,sideBySideImageWidth:258,floatingElementBaseZIndex:12,appViewportBGZIndex:2e3,appViewportZIndex:2001,modalZIndex:1e3,dialogZIndex:9999999999,desktopAppMinWidth:801};var yl=["Abadi MT Condensed","Agency FB","Aharoni","Aldhabi","Algerian","American Typewriter","Andale Mono","Apple Casual","Apple Chancery","Arial","Arial Black","Arial Narrow","Athelas","Avenir","Avenir Next","Avenir Next Condensed","Bangla","Baskerville","Batang","Bell MT","Bodoni","Book Antigua","Brush Script MT","Calibri","Californian FB","Calisto MT","Cambria","Century Schoolbook","Chalkboard","Chalkduster","Charter","Chiller","Colonna MT","Comic Sans MS","Copperplate","Courier New","Didot","Diwan","Estrangelo Edessa","Euphemia","Farah","Franklin Gothic","Futura","Garamond","Gautami","Geeza","Georgia","Gill Sans","Gill Sans MT","Goudy Old Style","Harrington","Helvetica","Helvetica Neue","Hoefler","Hoefler Text","Impact","Iowan Old Style","Jokerman","Juice ITC","Kohinoor Bangla","Latha","Lucida Sans","Magneto","Marion","Marker Felt","Menlo","Modern No. 20","Noteworthy","Optima","Palatino","Papyrus","PingFang HK","Rockwell","Savoye Let","Snell RoundHand","Superclarendon","Tahoma","Telugu","Thonburi","Times","Times New Roman","Trebuchet MS","Verdana","Vivaldi","Wide Latin"],xl=[{name:"Amble",file:"amble"},{name:"Bear and Loupe",file:"bearandloupe"},{name:"Big Snow",file:"bigsnow"},{name:"Capture It",file:"captureit"},{name:"Carbon Type",file:"carbontype"},{name:"Carrington",file:"carrington"},{name:"Caviar dreams",file:"caviardreams"},{name:"Chomsky",file:"chomsky"},{name:"ChunkFive",file:"chunkfive"},{name:"Costura Light",file:"costuralight"},{name:"Crass Roots",file:"crassroots"},{name:"Deutsch Gothic",file:"deutschgothic"},{name:"Digna\u2019s Handwriting",file:"dignashand"},{name:"Eczar SemiBold",file:"eczarsemibold"},{name:"Edo",file:"edo"},{name:"Eutemia I",file:"eutemia"},{name:"Free Universal",file:"freeuniversal"},{name:"Frente H1",file:"frenteh1"},{name:"Gothic Ultra",file:"gothicultra"},{name:"Gputeks",file:"gputeks"},{name:"Handserif",file:"handserif"},{name:"Harting",file:"harting"},{name:"Helsinki",file:"helsinki"},{name:"Henry Morgan Hand",file:"henrymorganhand"},{name:"Holitter Gothic",file:"holitter"},{name:"Hominis",file:"hominis"},{name:"HVD Comic Serif Pro",file:"hvdcomic"},{name:"Inkcalig",file:"inkcalig"},{name:"Itsadzoke",file:"itsadzoke"},{name:"Kawoszeh",file:"kawoszeh"},{name:"Kingthings Trypewriter",file:"kingthings"},{name:"Komika Axis",file:"komikaaxis"},{name:"Langdon",file:"langdon"},{name:"League Gothic",file:"leaguegothic"},{name:"League Spartan Bold",file:"leaguespartanbold"},{name:"Let\u2019s Trace",file:"letstrace"},{name:"Mathlete Bulky",file:"mathletebulky"},{name:"Miama",file:"miama"},{name:"Norwester",file:"norwester"},{name:"Odstemplik",file:"odstemplik"},{name:"Okolaks",file:"okolaks"},{name:"Ostrich Sans",file:"ostrichsans"},{name:"Palitoon",file:"palitoon"},{name:"Peace Sans",file:"peacesans"},{name:"Pirou Regular",file:"pirouregular"},{name:"Pix Antiqua",file:"pixantiqua"},{name:"Playlist Script",file:"playlistscript"},{name:"Qwigley Regular",file:"qwigleyregular"},{name:"Raustila Regular",file:"raustilaregular"},{name:"Selima",file:"selima"},{name:"Silkscreen",file:"silkscreen"},{name:"Temporarium",file:"temporarium"},{name:"The Art of Illuminating",file:"artofillum"},{name:"Vavont",file:"vavont"},{name:"Veggieburger",file:"veggieburger"}],rs=["Abel","Abhaya Libre:400,500,600,700,800","Abril Fatface","Alegreya:400,500,600,700,800,900","Alegreya Sans:100,300,400,500,700,800,900","Alfa Slab One","Allerta Stencil","Amaranth:400,700","Amatic SC:400,700","Amita:400,700","Annie Use Your Telescope","Anonymous Pro:400,700","Anton","Arapey","Architects Daughter","Archivo Black","Arima Madurai:100,200,300,400,500,700,800,900","Arizonia","Arvo:400,700","Arya:400,700","Averia Serif Libre:300,400,700","Bad Script","Bahianita","Bebas Neue","Bellota:300,400,700","Berkshire Swash","Beth Ellen","Bigelow Rules","BioRhyme Expanded:200,300,400,700,800","Boogaloo","Bowlby One","Bungee","Bungee Shade","Butcherman","Butterfly Kids","Cabin:400,500,600,700","Cairo:200,300,400,600,700,900","Candal","Caveat:400,500,600,700","Chango","Charmonman:400,700","Chewy","Chilanka","Cinzel:400,500,600,700,800,900","Cinzel Decorative:400,700,900","Coiny","Comfortaa:300,400,500,600,700","Concert One","Cookie","Cormorant Unicase:300,400,500,600,700","Creepster","Croissant One","Cutive Mono","Dancing Script:400,500,600,700","Darker Grotesque:300,400,500,600,700,800,900","Didact Gothic","Domine:400,500,600,700","Dosis:200,300,400,500,600,700,800","Economica:400,700","Elsie Swash Caps:400,900","Emblema One","Englebert","Euphoria Script","Exo:100,200,300,400,500,600,700,800,900","Exo 2:100,200,300,400,500,600,700,800,900","Fahkwang:200,300,400,500,600,700","Fjalla One","Fredericka the Great","Fredoka One","Fugaz One","Galada","Gochi Hand","Graduate","Grand Hotel","Gravitas One","Great Vibes","Gruppo","Handlee","Heebo:100,200,300,400,500,600,700,800,900","Hind:300,400,500,600,700","Homemade Apple","Indie Flower","Josefin Sans:100,200,300,400,500,600,700","Josefin Slab:100,200,300,400,500,600,700","Julius Sans One","Jura:300,400,500,600,700","Just Another Hand","Just Me Again Down Here","Kalam:300,400,700","Kameron:400,700","Karla:200,300,400,500,600,700,800","Khand:300,400,500,600,700","Krona One","Kumar One Outline","La Belle Aurore","Lato:100,300,400,700,900","Leckerli One","Lexend Exa","Libre Baskerville:400,700","Life Savers:400,700,800","Lily Script One","Limelight","Lobster","Lobster Two:400,700","Londrina Outline","Londrina Shadow","Londrina Sketch","Londrina Solid:100,300,400,900","Lora:400,500,600,700","Luckiest Guy","Maiden Orange","Marvel:400,700","Medula One","Megrim","Merriweather:300,400,700,900","Metamorphous","Modak","Monoton","Montserrat:100,200,300,400,500,600,700,800,900","Montserrat Alternates:100,200,300,400,500,600,700,800,900","Mountains of Christmas:400,700","Mr Bedfort","Mrs Sheppards","Mulish:200,300,400,500,600,700,800,900","Niconne","Nixie One","Nothing You Could Do","Nova Cut","Numans","Nunito:200,300,400,600,700,800,900","Old Standard TT:400,700","Oleo Script:400,700","Open Sans:300,400,600,700,800","Open Sans Condensed:300,700","Oranienbaum","Orbitron:400,500,600,700,800,900","Oswald:200,300,400,500,600,700","Overlock:400,700,900","Oxygen:300,400,700","Pacifico","Parisienne","Passion One:400,700,900","Pathway Gothic One","Pavanam","Paytone One","Permanent Marker","Petit Formal Script","Plaster","Playball","Playfair Display:400,500,600,700,800,900","Poller One","Poppins:100,200,300,400,500,600,700,800,900","Prata","Quattrocento:400,700","Questrial","Quicksand:300,400,500,600,700","Racing Sans One","Raleway:100,200,300,400,500,600,700,800,900","Rammetto One","Ravi Prakash","Red Hat Display:400,500,700,900","Righteous","Roboto:100,300,400,500,700,900","Roboto Mono:100,200,300,400,500,600,700","Roboto Slab:100,200,300,400,500,600,700,800,900","Rock Salt","Rokkitt:100,200,300,400,500,600,700,800,900","Rubik Mono One","Sacramento","Sanchez","Sancreek","Satisfy","Shadows Into Light","Shrikhand","Sigmar One","Six Caps","Slabo 27px","Slackey","Smokum","Sofia","Source Code Pro:200,300,400,500,600,700,900","Spicy Rice","Stint Ultra Expanded","Syncopate:400,700","Tangerine:400,700","Teko:300,400,500,600,700","Tenali Ramakrishna","Tenor Sans","Ubuntu:300,400,500,700","Ultra","Underdog","Unica One","Vampiro One","Varela","Varela Round","Vast Shadow","Vidaloka","Vollkorn:400,500,600,700,800,900","Wire One","Work Sans:100,200,300,400,500,600,700,800,900","Yantramanav:100,300,400,500,700,900","Yatra One","Yellowtail"],Tl={"ChunkFive Roman":"ChunkFive",Sigmar:"Sigmar One","Bowlby One SC":"Bowlby One","Londrina Sketche":"Londrina Sketch","Mr Bedford":"Mr Bedfort",Muli:"Mulish"},Fl={"Bookman Old Style":{name:"Quattrocento"},"Claire Hand":{name:"Chilanka",isAllCaps:!0,sizeScale:.8,lineHeightScale:1.25},Forque:{name:"Anton",isAllCaps:!0,sizeScale:.83,lineHeightScale:1.25},"Good Foot":{name:"Caveat"},Idolwild:{name:"Life Savers",isBold:!0,sizeScale:.88,charSpacingIncrement:100,lineHeightScale:1.18},"My Underwood":{name:"Kingthings Trypewriter",sizeScale:.96},"Myriad Pro":{name:"Yantramanav"},Teen:{name:"Questrial",isBold:!0},"Teen Light":{name:"Questrial"}},ha=[{extension:"otf",cssFormat:"opentype",mimeType:"application/font-sfnt"},{extension:"ttf",cssFormat:"truetype",mimeType:"application/font-sfnt"},{extension:"woff",cssFormat:"woff",mimeType:"application/font-woff"}],as={100:"Thin",200:"Extra Light",300:"Light",400:"Regular",500:"Medium",600:"Semi Bold",700:"Bold",800:"Extra Bold",900:"Black"},Aa={100:"font_thickness_thin",200:"font_thickness_extra_light",300:"font_thickness_light",400:"font_thickness_regular",500:"font_thickness_medium",600:"font_thickness_semi_bold",700:"font_thickness_bold",800:"font_thickness_extra_bold",900:"font_thickness_black"};function ua(i){if(!i.length||i.includes(400))return 400;if(i.includes(500))return 500;let e=i.filter(t=>t<400);return e.length?Math.max(...e):Math.min(...i)}function Br(i){return typeof i=="number"&&i%100==0&&i>=100&&i<=900}function Ai(i){return i.replace(/"/g,"").trim().replace(/(^'+)|('+$)/g,"").trim()}function ei(i,e=!1){i=Ai(i),i=i.replace(/\\/g,"");let t=/^[a-z][a-z0-9_]+$/i,r=/^(inherit|serif|sans-serif|monospace|fantasy|cursive|initial|default)$/i;return e||(s=>s.split(" ").some(o=>!o||!t.test(o)||r.test(o)))(i)?`"${i}"`:i}var ss=class{constructor(e,t,r,{isUserDefined:a=!1,fileName:s,files:o,bgYOffset:n}={}){this._name=this.validate("name",e),this._type=this.validate("type",t),t==="befunky"&&(this._fileName=this.validate("fileName",s)),this._isUserDefined=this.validate("isUserDefined",a),this.weights=r,o&&(this.files=o),t==="system"&&(this.isAvailable=null),!a&&(t==="google"||t==="befunky")&&(this._bgYOffset=this.validate("bgYOffset",n))}validate(e,t){let r=(s="")=>{throw console.log("FontVO:",this),console.log("Value:",t),new Error(`Invalid FontVO property "${e}". ${s}`)},a={name:()=>(typeof t!="string"&&r("Not string"),t=Ai(t),t||r("empty"),t),type:()=>(["google","befunky","system","uploaded"].includes(t)||r(),t),fileName:()=>((!t||typeof t!="string")&&r(),t),isUserDefined:()=>(typeof t!="boolean"&&r(),t&&this.type==="befunky"&&r(),t),isAvailable:()=>(typeof t!="boolean"&&t!==null&&r(),this.type!=="system"&&r(),t),weights:()=>((!Array.isArray(t)||!t.every(Br))&&r(),t.unique().sort()),files:()=>{let s=({weight:o,fileName:n})=>Br(o)&&n&&typeof n=="string";return(!Array.isArray(t)||!t.every(s))&&r(),this.type!=="uploaded"&&r(),t},replacedDefaultFont:()=>((!(t instanceof ss)||t.isUserDefined&&t.type!=="system")&&r(),t),bgYOffset:()=>(typeof t!="number"&&r(),(this.isUserDefined||!["befunky","google"].includes(this.type))&&r(),t)};return a[e]||r("Property not supported"),a[e]()}get name(){return this._name}get type(){return this._type}get fileName(){return this._fileName}get isUserDefined(){return this._isUserDefined}get bgYOffset(){return this._bgYOffset}set weights(e){this._weights=this.validate("weights",e)}get weights(){return this._weights}set files(e){this._files=this.validate("files",e)}get files(){return this._files}set isAvailable(e){this._isAvailable=this.validate("isAvailable",e)}get isAvailable(){return this._isAvailable}set replacedDefaultFont(e){this._replacedDefaultFont=this.validate("replacedDefaultFont",e)}get replacedDefaultFont(){return this._replacedDefaultFont}},$i=ss;window.BFN={};BFN.CSS=vl;BFN.UI={};BFN.filters={};BFN.effects={};BFN.baseFrameRate=60;BFN.maxZipSizeMB=500;BFN.minImageSize=32;BFN.maxImageSize=window.BfnmaxImageSize||4096;BFN.maxImageSizeForArtsy=BFN.maxImageSize;BFN.maxImageUploadSizeFreeUser=2500;BFN.maxImageSizeLayer=Math.min(window.BfnmaxImageSize,3264);BFN.graphicPlaceholderTextureSize=8;BFN.minCollageSize=128;BFN.defaultCollageSize=3264;BFN.openedSections=[];BFN.imageTypes=["computer","sample","befunky_photo","befunky_layer","befunky_project","pixabay","unsplash","pexels","facebook","google_photos","patterns","graphic","text_mask","alpha_mask","collage_photo","mask_image","image","designer","template_svg","designer_template"];BFN.cluesToHideOnTablet=["cutout","erase_mode"];BFN._updatingTextTransformItem=null;Object.defineProperty(BFN,"updatingTextTransformItem",{set(i){UIToggler.showLoadScreenWhileTrue(BFN.checkUpdatingTextTransformItem,750),BFN._updatingTextTransformItem=i},get(){return BFN._updatingTextTransformItem}});BFN.checkUpdatingTextTransformItem=function(){return BFN._updatingTextTransformItem||BFN.updatingTextQueue.length||BFN.accurateBoundsQueue.length};BFN.nextUid=0;BFN.uid=function(){return++BFN.nextUid};BFN.renderTexturesPool=null;BFN.renderTextureResolution=1;BFN.renderTextureResolutionLarge=1;BFN.updatingShapeQueue=[];BFN.updatingTextQueue=[];BFN.accurateBoundsQueue=[];BFN.floatingElements=[];BFN.addFloatingElement=i=>{BFN.floatingElements.includes(i)||(BFN.floatingElements.push(i),BFN.updateFloatingElementDisplay())};BFN.focusFloatingElement=i=>{if(BFN.floatingElements.includes(i)){let e=BFN.floatingElements.indexOf(i);BFN.floatingElements.splice(e,1),BFN.floatingElements.push(i),BFN.updateFloatingElementDisplay()}};BFN.updateFloatingElementDisplayImmediately=()=>{BFN.floatingElements.forEach((i,e)=>{if(!i.hasClass("active")){i.setStyles({zIndex:-1});return}let t=BFN.CSS.floatingElementBaseZIndex+e;BFN.FabricManager&&BFN.FabricManager.currentTextTransformItem&&i.zIndexOverFabric&&(t=BFN.CSS.appViewportZIndex+e+1),BeFunky.isModalOpen()&&i.zIndexOverModal&&(t=BFN.CSS.modalZIndex+e+1),i.setStyles({zIndex:t})})};BFN.updateFloatingElementDisplay=BeFunky.debounce(BFN.updateFloatingElementDisplayImmediately,"ric");BFN.tabRecentlyReopened=!1;BFN.hasFullyOpenedEditor=!1;BFN.toolViewstates={};BFN._applyCancelMenu=null;Object.defineProperty(BFN,"applyCancelMenu",{get(){return BFN._applyCancelMenu||(BFN._applyCancelMenu=document.getElementById("editor_apply_cancel_menu")),BFN._applyCancelMenu}});BFN.textureMemoryLimitMB=BeFunky.isMobile?750:navigator.deviceMemory>=8?3e3:navigator.deviceMemory>4?1200:750;Object.defineProperty(BFN,"textureHistoryMemoryLimitMB",{get(){return BFN.textureMemoryLimitMB*.7}});BFN._smoothPicture=window.bfn_resolution<2?"auto":"never";Object.defineProperty(BFN,"smoothPicture",{set(i){["auto","always","never"].includes(i)&&(BFN._smoothPicture=i,BFN.smoothPictureDisabled=BFN.smoothPictureDisabled)},get(){return BFN._smoothPicture}});BFN._smoothPictureDisabled=!1;Object.defineProperty(BFN,"smoothPictureDisabled",{set(i){BFN._smoothPictureDisabled=BFN._smoothPicture==="auto"?i:BFN._smoothPicture!=="always",BFN.MainUI.requestRender()},get(){return BFN._smoothPictureDisabled}});BFN.smoothPictureAction=i=>{if(typeof i!="function")return;let e=BFN.smoothPicture;BFN.smoothPicture="always",i(),BFN.smoothPicture=e};BFN.retrievePresetThumbHelperGraphics=i=>{i==="texture"&&BFN.XMLGraphicLoader.loadTexturesThumbnailsXml().catch(()=>{}),i==="effect"&&BFN.XMLGraphicLoader.loadEffectsThumbnailsJson().catch(()=>{})};BFN.PhotoEditorCanvasModelViewStates={VIEWING_CANVAS:"VIEWING_CANVAS",VIEWING_TOUCH_UP:"VIEWING_TOUCH_UP",VIEWING_EFFECT:"VIEWING_EFFECT",VIEWING_ARTSY:"VIEWING_ARTSY",VIEWING_SQUARE:"VIEWING_SQUARE",VIEWING_BORDER:"VIEWING_BORDER",VIEWING_DROP_SHADOW:"VIEWING_DROP_SHADOW",VIEWING_FRAME:"VIEWING_FRAME",VIEWING_TEXTURE:"VIEWING_TEXTURE",VIEWING_OVERLAY:"VIEWING_OVERLAY",VIEWING_LENS_FLARE:"VIEWING_LENS_FLARE",VIEWING_PAINT_BRUSH:"VIEWING_PAINT_BRUSH",VIEWING_CLONE:"VIEWING_CLONE",VIEWING_BLEMISH_FIX:"VIEWING_BLEMISH_FIX",VIEWING_BACKGROUND:"VIEWING_BACKGROUND",VIEWING_CUTOUT:"VIEWING_CUTOUT",VIEWING_CROP:"VIEWING_CROP",VIEWING_ROTATE:"VIEWING_ROTATE",VIEWING_RESIZE:"VIEWING_RESIZE",VIEWING_SLIMMING:"VIEWING_SLIMMING",VIEWING_RESHAPE:"VIEWING_RESHAPE",VIEWING_TILT:"VIEWING_TILT",VIEWING_FOCUS:"VIEWING_FOCUS",VIEWING_VIGNETTE:"VIEWING_VIGNETTE"};BFN.CONST={BLEND_MODES:{NORMAL:0,ADD:1,SUBTRACT:2,MULTIPLY:3,DARKEN:4,COLOR_BURN:5,LINEAR_BURN:6,LIGHTEN:7,SCREEN:8,COLOR_DODGE:9,LINEAR_DODGE:10,OVERLAY:11,SOFT_LIGHT:12,HARD_LIGHT:13,VIVID_LIGHT:14,LINEAR_LIGHT:15,PIN_LIGHT:16,DIFFERENCE:17,EXCLUSION:18,ERASE:19,ALPHA:20,COLOR:22,HUE:23,LUMINOSITY:24},PICTURE_RENDERER_FILTERS:{BLACK_WHITE:0,COLOR:1},ANALOG_PRESETS:{PRESET_1:1,PRESET_2:2,PRESET_3:3,PRESET_4:4,PRESET_5:5,PRESET_6:6,PRESET_7:7,PRESET_8:8,PRESET_9:9,PRESET_10:10},BWFX_PRESETS:{PRESET_1:1,PRESET_2:2,PRESET_3:3,PRESET_4:4,PRESET_5:5,PRESET_6:6,PRESET_7:7,PRESET_8:8,PRESET_9:9,PRESET_10:10,PRESET_11:11,PRESET_12:12,PRESET_13:13,PRESET_14:14,PRESET_15:14},WARMFX_PRESETS:{PRESET_1:1,PRESET_2:2,PRESET_3:3,PRESET_4:4,PRESET_5:5,PRESET_6:6,PRESET_7:7,PRESET_8:8,PRESET_9:9,PRESET_10:10,PRESET_11:11},CINEMATIC_PRESETS:{FILM_GRAIN:1,COLOR_GRADING:2,ANAMORPHIC:3,LENS_DISTORTION:4,WARPED_BLUR:5,CHROMATIC_ABERRATION:6,VOLUME_LIGHT:7},MULTIMEDIA_PRESETS:{SCAN_LINES:1,TELEVISION:2,HALFTONE_DUO:3,COLOR_BLEED:4},GLITCH_ART_PRESETS:{CORRUPTED:1,DISTORTED:2,SEGMENTED:3,FRAGMENTED:4,DIGITIZED:5},BLACK_WHITE_PRESETS:{PRESET_1:1,PRESET_2:2,PRESET_3:3,PRESET_4:4,PRESET_5:5,PRESET_6:6,PRESET_7:7,PRESET_8:8,PRESET_9:9},CHROMATIC_PRESETS:{PRESET_1:1,PRESET_2:2,PRESET_3:3,PRESET_4:4,PRESET_5:5,PRESET_6:6,PRESET_7:7,PRESET_8:8,PRESET_9:9,PRESET_10:10},CHARCOAL_PRESETS:{PRESET_1:1,PRESET_2:2},CYANOTYPE_PRESETS:{PRESET_1:1,PRESET_2:2,PRESET_3:3,PRESET_4:4,PRESET_5:5,PRESET_6:6},VIEWFINDER_PRESETS:{PRESET_1:1,PRESET_2:2,PRESET_3:3,PRESET_4:4,PRESET_5:5,PRESET_6:6,PRESET_7:7,PRESET_8:8,PRESET_9:9,PRESET_10:10,PRESET_11:11,PRESET_12:12},SUMMER_PRESETS:{PRESET_1:1,PRESET_2:2},UNITED_COLORS_PRESETS:{PRESET_1:1,PRESET_2:2,PRESET_3:3,PRESET_4:4,PRESET_5:5,PRESET_6:6},INSTANT_PRESETS:{PRESET_1:1,PRESET_2:2,PRESET_3:3,PRESET_4:4,PRESET_5:5,PRESET_6:6,PRESET_10:10,PRESET_11:11,PRESET_13:13},VINTAGE_COLORS_PRESETS:{PRESET_1:1,PRESET_2:2,PRESET_3:3,PRESET_4:4,PRESET_5:5,PRESET_6:6,PRESET_7:7,PRESET_8:8,PRESET_9:9},HOLGA_ART_PRESETS:{PRESET_1:1,PRESET_2:2,PRESET_3:3,PRESET_4:4,PRESET_5:5},LINE_ARTOPIA_PRESETS:{PRESET_1:1,PRESET_2:2,PRESET_3:3,PRESET_4:4},PINHOLE_PRESETS:{PRESET_1:1,PRESET_2:2,PRESET_3:3,PRESET_4:4,PRESET_5:5},STENCILER_PRESETS:{PRESET_1:1,PRESET_2:2,PRESET_3:3,PRESET_4:4,PRESET_6:6,PRESET_7:7,PRESET_8:8,PRESET_9:9,PRESET_10:10,PRESET_11:11},GRUNGE_PRESETS:{PRESET_1:1,PRESET_2:2,PRESET_3:3,PRESET_4:4,PRESET_5:5,PRESET_6:6,PRESET_9:9,PRESET_10:10,PRESET_11:11,PRESET_13:13,PRESET_15:15,PRESET_16:16,PRESET_17:17},SUNBURST_PRESETS:{PRESET_1:1,PRESET_2:2,PRESET_3:3,PRESET_4:4,PRESET_5:5,PRESET_6:6},OLD_PHOTO_PRESETS:{PRESET_1:1,PRESET_2:2,PRESET_4:4,PRESET_5:5,PRESET_6:6,PRESET_7:7,PRESET_8:8,PRESET_9:9,PRESET_10:10,PRESET_11:11,PRESET_12:12,PRESET_13:13,PRESET_14:14,PRESET_15:15,PRESET_16:16,PRESET_17:17,PRESET_18:18,PRESET_19:19,PRESET_20:20},WINTER_PRESETS:{PRESET_1:1,PRESET_2:2},TILT_SHIFT_PRESETS:{PRESET_1:1,PRESET_2:2},PATRIOTIC_PRESETS:{PRESET_1:1,PRESET_2:2,PRESET_3:3,PRESET_4:4,PRESET_5:5,PRESET_6:6,PRESET_7:7},POPART_PRESETS:{PRESET_1:1,PRESET_2:2,PRESET_3:3,PRESET_4:4,PRESET_5:5,PRESET_6:6,PRESET_7:7,PRESET_9:9,PRESET_10:10,PRESET_11:11,PRESET_13:13,PRESET_14:14,PRESET_15:15,PRESET_16:16,PRESET_17:17,PRESET_18:18,PRESET_19:19,PRESET_20:20},MOTION_COLOR_PRESETS:{PRESET_1:1,PRESET_2:2,PRESET_3:3,PRESET_4:4,PRESET_5:5},LOMO_ART_PRESETS:{PRESET_1:1,PRESET_2:2,PRESET_3:3,PRESET_4:4,PRESET_6:6,PRESET_7:7},TOUCH_UP_PRESETS:{wrinkles:1,bronzer:2,blush:3,flashspot:4,mascara:6,eye_color:7,eye_brighten:8,eyebrow_pencil:9,fix_redeye:10,lipstick:11,teeth_whiten:12,haircolor:13,perfectskin:14},PALETTE_MAPS:{retroCol1:[[[0,28],[25,60],[44,83],[65,116],[85,135],[126,184],[148,198],[174,212],[190,223],[214,233],[234,244],[255,255]],[[0,0],[25,30],[41,53],[60,75],[88,113],[104,134],[134,173],[153,187],[169,196],[196,211],[216,219],[235,235],[255,240]],[[0,17],[23,38],[65,76],[93,104],[111,121],[121,131],[150,153],[165,171],[212,196],[232,203],[255,211]]],retroCol2:[[[0,0],[23,13],[44,28],[63,48],[83,71],[106,102],[128,131],[149,160],[170,185],[187,209],[214,231],[235,246],[255,255]],[[0,0],[23,13],[44,28],[63,48],[83,71],[106,102],[128,131],[149,160],[170,185],[187,209],[214,231],[235,246],[255,255]],[[0,31],[22,47],[41,62],[64,79],[82,95],[105,111],[128,129],[150,145],[170,161],[191,180],[212,196],[234,212],[255,224]]],retroCol3:[[[0,20],[24,46],[52,80],[61,90],[87,121],[110,143],[129,162],[152,184],[166,193],[196,209],[213,225],[232,232],[255,242]],[[0,0],[19,15],[41,43],[62,72],[88,106],[105,129],[123,152],[148,178],[172,197],[189,213],[212,226],[234,240],[255,255]],[[0,19],[22,41],[42,61],[64,86],[82,104],[104,124],[125,144],[151,164],[173,183],[215,209],[232,221],[255,232]]],retroCol4:[[[0,25],[22,56],[31,72],[78,149],[87,157],[101,175],[110,182],[129,194],[150,201],[172,202],[189,210],[214,223],[234,236],[255,255]],[[0,25],[31,55],[54,96],[65,118],[86,146],[127,185],[152,196],[169,203],[191,218],[212,230],[234,240],[255,255]],[[0,35],[23,54],[41,75],[65,107],[84,126],[108,156],[120,164],[143,182],[175,190],[198,201],[215,214],[234,225],[255,232]]],retroCol5:[[[0,0],[25,17],[44,34],[62,56],[86,95],[108,122],[130,154],[144,170],[165,193],[176,202],[211,229],[236,243],[234,236],[255,255]],[[0,0],[21,9],[46,24],[65,42],[85,65],[103,91],[128,127],[153,160],[172,182],[193,201],[213,222],[235,241],[255,255]],[[0,0],[21,9],[44,17],[66,32],[87,54],[104,75],[126,107],[150,143],[171,166],[192,189],[217,211],[238,225],[255,243]]],retroCol6:[[[0,139],[32,170],[51,173],[65,183],[76,186],[106,197],[126,208],[146,216],[168,223],[188,233],[213,240],[234,248],[255,255]],[[0,0],[24,61],[46,103],[60,124],[78,144],[102,166],[127,179],[146,193],[173,210],[195,226],[220,238],[234,244],[255,255]],[[0,58],[18,59],[42,60],[60,76],[81,105],[105,133],[126,151],[150,164],[170,179],[186,188],[207,195],[234,209],[255,211]]],retro6mask:[[[0,0],[108,137],[255,255]],[[0,0],[131,121],[255,255]],[[0,0],[33,50],[133,116],[255,255]]],retroCol7:[[[0,75],[22,81],[43,82],[63,113],[75,128],[96,151],[119,168],[147,201],[164,220],[191,222],[209,219],[235,225],[255,231]],[[0,54],[16,59],[30,55],[43,58],[77,87],[89,104],[111,124],[130,144],[155,169],[176,190],[188,202],[216,221],[237,240],[255,244]],[[0,65],[23,61],[40,65],[67,84],[90,118],[108,134],[134,167],[153,188],[175,209],[195,213],[211,210],[234,214],[255,208]]],retroCol8:[[[0,26],[15,43],[32,64],[65,114],[83,149],[109,178],[127,192],[147,201],[170,208],[195,218],[215,229],[234,242],[255,251]],[[0,0],[26,32],[49,72],[72,123],[89,147],[115,188],[148,205],[160,210],[177,222],[189,224],[215,235],[234,246],[255,254]],[[1,29],[30,72],[57,124],[74,147],[87,162],[108,175],[130,184],[152,189],[172,195],[187,203],[215,216],[239,237],[255,247]]],MegaContrast1:[[[0,0],[255,255]],[[0,0],[255,255]],[[0,0],[255,255]]],MegaContrast2:[[[0,0],[75,29],[178,204],[255,255]],[[0,25],[255,230]],[[0,0],[49,76],[255,255]]],crossProcess1:[[[0,0],[60,30],[210,255],[255,255]],[[0,0],[47,38],[101,111],[187,206],[255,255]],[[0,32],[255,216]]],crossProcess2:[[[0,0],[66,79],[195,182],[255,255]],[[0,0],[77,73],[199,177],[255,255]],[[0,0],[77,63],[186,200],[255,255]]],darkerMap:[[[0,0],[132,134],[203,173],[255,255]],[[0,0],[55,43],[171,180],[255,255]],[[0,0],[63,76],[159,138],[193,171],[255,255]]],contrast:[[[0,0],[78,51],[181,191],[255,255]],[[0,0],[78,51],[181,191],[255,255]],[[0,0],[78,51],[181,191],[255,255]]],contrastHigh:[[[0,0],[93,63],[168,195],[255,255]],[[0,0],[93,63],[168,195],[255,255]],[[0,0],[93,63],[168,195],[255,255]]],blackenCurve:[[[0,0],[201,85],[255,255]],[[0,0],[201,85],[255,255]],[[0,0],[201,85],[255,255]]]}};BFN.CONST.FONT_LIST=function(){let i=36,e=rs.map((s,o)=>{let[n,l="400"]=s.split(":");return new $i(n,"google",a(l),{bgYOffset:i*o})}),t=yl.map(s=>new $i(s,"system",[])),r=xl.map(({name:s,file:o},n)=>new $i(s,"befunky",[400],{fileName:o,bgYOffset:i*n}));return[...e,...t,...r].sort((s,o)=>s.name.toLowerCase()>o.name.toLowerCase()?1:-1);function a(s){return s.split(",").map(o=>parseInt(o))}}();BFN.reusedMenuReferences={};BFN.getReusableMenu=i=>(BFN.reusedMenuReferences[i]||(BFN.reusedMenuReferences[i]=document.getElementById(i)),BFN.reusedMenuReferences[i]);BFN.canShareNatively=function(){return Boolean((BeFunky.isIOS&&BeFunky.safariVersion>=15||BeFunky.isAndroid)&&navigator.canShare&&navigator.share)};BFN.assetsURL=BeFunky.Params.globalAssetsPath;BFN.assetsDataURL=`${BFN.assetsURL}datas/`;BFN.imagesURL=BeFunky.Params.globalImagesPath;BFN.remoteImagesURL=BeFunky.Params.IS_LC?BeFunky.Params.remoteImagesPath:BeFunky.Params.globalImagesPath;BFN.jsURL=`${BFN.assetsURL}js/`;BFN.originalTextureURl=`${BFN.remoteImagesURL}app/textures/sml/`;BFN.thumbTextureURl=`${BFN.remoteImagesURL}app/textures/texture_78/`;BFN.folderNames={goodies:"6JAN2020/",overlays:"11FEB2021/",patterns:"02FEB18/"};BFN.goodiesUrl=`${BFN.remoteImagesURL}app/graphics/goodies/${BFN.folderNames.goodies}`;BFN.overlaysUrl=`${BFN.remoteImagesURL}app/graphics/overlays/${BFN.folderNames.overlays}`;BFN.patternsUrl=`${BFN.remoteImagesURL}app/graphics/patterns/${BFN.folderNames.patterns}`;BFN.artsyThumbURL=`${BFN.imagesURL}app/graphics/artsy/preview_v4/`;BFN.designerElementsUrl=`${BFN.remoteImagesURL}app/graphics/designer_elements/svg/`;BFN.designerSourceTemplateURL=`${BeFunky.Params.remoteAssetsPath}designer_templates_v2/`;BFN.designerTemplateFlashURL=`${BeFunky.Params.remoteAssetsPath}designer_source_templates_flash/`;BFN.designerTemplatePreviewsUrl=`${BFN.remoteImagesURL}app/designer_templates_v2/previews/`;BFN.patchPreviewImageUrl=`${BFN.remoteImagesURL}app/template_patches/previews/`;BFN.assetsDataVersions={overlays_thumb:"",overlays_data:"",patterns_thumb:"",patterns_data:"",effects_thumbs_data:"_v1"};BFN.goodiesAssetsFolder={original:"org/",thumb:"t/"};var os=null,Oa=null,ns=4;window.addEventListener("resize",()=>{os=null,Oa=null});var mS=BeFunky.throttle(i=>{BeFunky.logWarning("Attempting to fix #bfn-app shifted up",i,window.innerHeight,visualViewport.height,document.activeElement),document.body.setStyles({display:"none"}),BeFunky.wait(["raf","raf"],()=>{document.body.setStyles({display:"block"}),BeFunky.wait(["raf","raf"],()=>{window.dispatchEvent(new Event("resize")),BFN.StageModel.updateStageDimensions(!0)})})},3e3);Object.defineProperty(BFN,"appRect",{get(){let i=os;if(i&&!i.usingFallback)return i;if(!BFN.appContainer)return t();let e=BFN.appContainer.getBoundingClientRect();if(e&&e.width)return e.top<-1&&BeFunky.isIOS&&window.isAppOpen&&window.innerHeight===visualViewport.height&&mS(e.top),r(e);return t();function t(){if(BeFunky.reportWarning("#bfn-app has no dimensions",BFN.appContainer),i&&i.usingFallback)return i;let a=window.innerWidth,s=window.innerHeight;return r({usingFallback:!0,x:0,y:0,top:0,left:0,width:a,right:a,height:s,bottom:s})}function r(a){let{x:s,left:o}=a,{top:n,y:l,width:c,height:h}=a;c=Math.round(c),h=Math.round(h);let u=Lr();n+=u.top,l+=u.top,c=Math.max(ns,c),h=Math.max(ns,h-u.top-u.bottom);let d=o+c,m=n+h;return os={x:s,y:l,top:n,left:o,bottom:m,right:d,width:c,height:h},os}}});function Lr(){if(Oa)return Oa;let i=getComputedStyle(document.documentElement);return Oa={top:parseInt(i.getPropertyValue("--safe-area-top"))||0,bottom:BeFunky.isAndroid?Math.max(parseInt(i.getPropertyValue("--safe-area-bottom")),15):parseInt(i.getPropertyValue("--safe-area-bottom"))||0},Oa}Object.defineProperty(BFN,"appViewportRect",{get(){let{appRect:i}=BFN,{x:e,y:t,top:r,left:a,bottom:s,width:o,height:n}=i,{right:l}=i,c=BFN.topNavBarHeight;r+=c,t+=c,n-=c;let h=BFN.getAppViewportBottomOffset();n-=h,s-=h;let u=BFN.getAppViewportLeftOffset();return a+=u,e+=u,o-=u,d({x:e,y:t,top:r,left:a,bottom:s,right:l,width:o,height:n});function d(m){return m.width=Math.max(ns,m.width),m.height=Math.max(ns,m.height),m.right=m.left+m.width,m.bottom=m.top+m.height,m}}});Object.defineProperty(BFN,"leftMenuMinimumWidth",{get(){return BeFunky.isWiderThanMobile()?BFN.CSS.leftPrimaryMenuWidth:0}});Object.defineProperty(BFN,"bottomMenuMinimumHeight",{get(){return BeFunky.isWiderThanMobile()?BFN.CSS.footerHeight:BFN.CSS.bottomPrimaryMenuHeight}});Object.defineProperty(BFN,"maxSecondaryMenuHeight",{get(){let i=24;return BFN.appRect.height-BFN.topNavBarHeight-BFN.CSS.bottomPrimaryMenuHeight-i}});Object.defineProperty(BFN,"maxMobilePopupHeight",{get(){let i=24;return BFN.appRect.height-BFN.topNavBarHeight-i}});Object.defineProperty(BFN,"topNavBarHeight",{get(){return BeFunky.isWiderThanMobile()||window.innerHeight>850?BFN.CSS.topNavBarMaxHeight:BFN.CSS.topNavBarMinHeight}});BFN.getSecondaryMenuHeightOnMobile=i=>i==="editor_image_manager_menu"?BFN.AppModel&&BFN.AppModel.sectionID==="collage"?158:113:i==="editor_graphic_menu"?153:i==="editor_text_menu"?113:i==="designer_templates_menu"?0:BFN.CSS.bottomSecondaryMenuDefaultHeight;BFN.alternateMenuBaseHeightOnMobile=237;Object.defineProperty(BFN,"alternateMenuExpandedHeightOnMobile",{get(){return Math.min(400,BFN.maxMobilePopupHeight)}});BFN.appViewportOffsets=[{name:"default",getLeft:()=>({now:()=>BFN.leftMenuMinimumWidth,future:()=>BFN.leftMenuMinimumWidth}),getBottom:()=>({now:()=>BFN.bottomMenuMinimumHeight,future:()=>BFN.bottomMenuMinimumHeight})}];BFN.getAppViewportLeftOffset=(i=!1)=>Math.max(...BFN.appViewportOffsets.map(({getLeft:e})=>{if(typeof e=="function"){let{now:t,future:r}=e();return bl(i?r():t())}return 0}));BFN.getAppViewportBottomOffset=(i=!1)=>Math.max(...BFN.appViewportOffsets.map(({getBottom:e})=>{if(typeof e=="function"){let{now:t,future:r}=e();return bl(i?r():t())}return 0}));function bl(i){return typeof i=="number"&&!Number.isNaN(i)?i:0}BeFunky.onLoad(()=>{let i=Lr(),e=parseInt(getComputedStyle(document.body).getPropertyValue("--sat"));e!==i.top&&(i.top_reported_by_device=e),console.log("Safe Areas:",i)});BFN.XHelpers={};Object.defineProperty(PIXI.DisplayObject.prototype,"isMainUIChild",{get:function(){let i=e=>e===BFN.MainUI?!0:e&&e.parent?i(e.parent):!1;return i(this)}});Object.defineProperty(PIXI.DisplayObject.prototype,"useHighQualityMask",{get:function(){return BFN.MainUI.renderingCanvas}});BFN.XHelpers.emptyContainer=new PIXI.Container;PIXI.RenderTexture.prototype.clear=function(){BFN.Stage.render(BFN.XHelpers.emptyContainer,this,!0),this.undetermineTransparency()};BFN.XHelpers.clearRect=null;PIXI.Texture.prototype.clearRect=PIXI.RenderTexture.prototype.clearRect=function(i,e,t,r){let a=BFN.Stage.gl;if(!a)return;a.disable(a.BLEND),BFN.XHelpers.clearRect||(BFN.XHelpers.clearRect=new PIXI.Graphics,BFN.XHelpers.clearRect.beginFill(0,0),BFN.XHelpers.clearRect.drawRect(0,0,100,100),BFN.XHelpers.clearRect.endFill());let s=BFN.XHelpers.clearRect;s.x=i,s.y=e,s.width=t,s.height=r,BFN.Stage.render(s,this,!1),a.enable(a.BLEND),this.undetermineTransparency()};BFN.XHelpers.fillRect=new PIXI.Graphics;PIXI.RenderTexture.prototype.fillRect=function(i,e,t,r,a,s){let o=BFN.Stage.gl;if(!o)return;o.disable(o.BLEND);let n=BFN.XHelpers.fillRect;n.clear(),n.beginFill(a,s),n.drawRect(0,0,t,r),n.endFill(),n.x=i,n.y=e,BFN.Stage.render(n,this,!1),o.enable(o.BLEND),this.undetermineTransparency()};PIXI.RenderTexture.prototype.fillColor=function(i,e=1){let t=BFN.Stage.gl;t.disable(t.BLEND);let r=BFN.XHelpers.fillRect;r.clear(),r.beginFill(i,e),r.drawRect(0,0,this.width,this.height),r.endFill(),r.x=0,r.y=0,BFN.Stage.render(r,this,!1),t.enable(t.BLEND),this.undetermineTransparency()};PIXI.RenderTexture.prototype.fillColorOverlap=function(i,e,t,r,a,s){i=i||0,e=e||1,t=t||0,r=r||0,a=a||this.width,s=s||this.height;let o=BFN.XHelpers.fillRect;o.clear(),o.beginFill(i,e),o.drawRect(0,0,a,s),o.endFill(),o.x=t,o.y=r,BFN.Stage.render(o,this,!1),this.undetermineTransparency()};PIXI.RenderTexture.prototype.determineTransparency=PIXI.Texture.prototype.determineTransparency=function(i=!1,e=48){if(!this.baseTexture)return!1;if(this.baseTexture.hasOwnProperty("isTransparent")&&!i)return this.baseTexture.isTransparent;let t=BFN.Util.getThumbTextureGL(this,Math.min(e,this.width,this.height),!1,!1);return this.isTransparent=BFN.Util.isTransparent(t),t.destroyGC(!0),t=null,this.isTransparent};PIXI.RenderTexture.prototype.undetermineTransparency=PIXI.Texture.prototype.undetermineTransparency=function(){this.baseTexture&&this.baseTexture.hasOwnProperty("isTransparent")&&delete this.baseTexture.isTransparent};Object.defineProperty(PIXI.Texture.prototype,"isTransparent",{set:function(i){this.baseTexture&&(this.baseTexture.isTransparent=!!i)},get:function(){return this.baseTexture?!!this.baseTexture.isTransparent:void 0}});Object.defineProperty(PIXI.RenderTexture.prototype,"isTransparent",{set:function(i){this.baseTexture&&(this.baseTexture.isTransparent=!!i)},get:function(){return this.baseTexture?this.baseTexture.isTransparent:void 0}});BFN.XHelpers.renderSprite=new PIXI.Sprite;BFN.XHelpers.renderSprite.pluginName="smooth_picture";BFN.XHelpers.renderContainer=new PIXI.Container;BFN.XHelpers.renderContainer.addChild(BFN.XHelpers.renderSprite);PIXI.RenderTexture.prototype.copyPixels=function(i,e,t,r,a,s){e==null&&(e={x:0,y:0}),t==null&&(t=!0),r==null&&(r=1),a==null&&(a=1);let o=typeof a=="object"&&a.hasOwnProperty("x")?a.x:a,n=typeof a=="object"&&a.hasOwnProperty("y")?a.y:a;s==null&&(s=16777215);let l=BFN.XHelpers.renderSprite,c=BFN.XHelpers.renderContainer;l.texture=i,l.x=e.x,l.y=e.y,l.alpha=r,l.scale.x=l.currentScale=o,l.scale.y=l.currentScaleY=n,l.tint=s,BFN.smoothPictureAction(()=>{BFN.Stage.render(c,this,t)}),l.texture=null,this.undetermineTransparency()};BFN.XHelpers.getFilterSprite=()=>(BFN.XHelpers.filterSprite||(BFN.XHelpers.filterSprite=new PIXI.Sprite,BFN.XHelpers.filterSprite.filterTexture=PIXI.RenderTexture.create(1,1)),BFN.XHelpers.filterSprite);BFN.XHelpers.applyFilterSprite=(i,e,t)=>{if(i&&e&&t){let r=BFN.XHelpers.getFilterSprite();r.texture=i,t instanceof PIXI.Filter?(r.pluginName="sprite",r.filters=[t]):t instanceof PIXI.Shader?(r.pluginName="filter_renderer",r.bfn_shaders=[t]):BeFunky.throwError("Provided Filter is Instance of Neither Filter Nor Shader"),i!==e?BFN.Stage.render(r,e):(r.filterTexture.resize(i.width,i.height),BFN.Stage.render(r,r.filterTexture),e.copyPixels(r.filterTexture)),BFN.XHelpers.resetFilterSprite()}};BFN.XHelpers.resetFilterSprite=()=>{BFN.XHelpers.filterSprite&&(BFN.XHelpers.filterSprite.pluginName="sprite",BFN.XHelpers.filterSprite.texture=PIXI.Texture.EMPTY,BFN.XHelpers.filterSprite.filterTexture.resize(1,1),BFN.XHelpers.filterSprite.filters=[],BFN.XHelpers.filterSprite.bfn_shaders=[])};PIXI.RenderTexture.prototype.invert=function(i=null,e=null){if(i=i!==null?i instanceof PIXI.RenderTexture?i:null:this,!i)return BeFunky.throwError("RenderTexture.invert() : Invalid _targetRenderTexture"),null;e=typeof e=="number"&&e>=0&&e<=16777215?e:-1;let t=BFN.XHelpers.getFilterSprite();return t.invertFilter=t.invertFilter?t.invertFilter:BFN.ShaderPool.InvertShader,t.invertFilter.fillColor=e===-1?e:BFN.ColorUtil.hexNumberToHexString(e),BFN.XHelpers.applyFilterSprite(this,i,t.invertFilter),i===this?this:null};PIXI.RenderTexture.prototype.fillAlpha=function(i=null,e,t=1){if(i=i!==null?i instanceof PIXI.RenderTexture?i:null:this,!i)return BeFunky.throwError("RenderTexture.fillAlpha() : Invalid _targetRenderTexture"),null;if(!(typeof e=="number"&&e>=0&&e<=16777215))return BeFunky.throwError("RenderTexture.fillAlpha() : Invalid _color",e),null;if(!(typeof t=="number"&&t>0))return i===this?this:null;t=Math.max(0,Math.min(1,t));let r=BFN.XHelpers.getFilterSprite();return r.fillAlphaFilter=r.fillAlphaFilter?r.fillAlphaFilter:BFN.ShaderPool.FillAlphaShader,r.fillAlphaFilter.color=BFN.ColorUtil.hexNumberToHexString(e),r.fillAlphaFilter.alpha=t,BFN.XHelpers.applyFilterSprite(this,i,r.fillAlphaFilter),i===this?this:null};PIXI.RenderTexture.prototype.convertLumaToAlpha=function(i=null,e=!1){if(i=i!==null?i instanceof PIXI.RenderTexture?i:null:this,!i)return BeFunky.throwError("RenderTexture.convertLumaToAlpha() : Invalid _targetRenderTexture"),null;e=!!e;let t=BFN.XHelpers.getFilterSprite();return t.lumaToAlphaFilter=t.lumaToAlphaFilter?t.lumaToAlphaFilter:BFN.ShaderPool.LumaToAlphaShader,t.lumaToAlphaFilter.invert=e,BFN.XHelpers.applyFilterSprite(this,i,t.lumaToAlphaFilter),i===this?this:null};PIXI.RenderTexture.prototype.convertAlphaToLuma=function(i=null,e=!1){if(i=i!==null?i instanceof PIXI.RenderTexture?i:null:this,!i)return BeFunky.throwError("RenderTexture.convertAlphaToLuma() : Invalid _targetRenderTexture"),null;e=!!e;let t=BFN.XHelpers.getFilterSprite();return t.alphaToLumaFilter=t.alphaToLumaFilter?t.alphaToLumaFilter:BFN.ShaderPool.AlphaToLumaShader,t.alphaToLumaFilter.invert=e,BFN.XHelpers.applyFilterSprite(this,i,t.alphaToLumaFilter),i===this?this:null};PIXI.Texture.prototype.renderClone=function(){let i=PIXI.RenderTexture.create(this.width,this.height);return i.copyPixels(this),this.baseTexture&&this.baseTexture.hasOwnProperty("isTransparent")&&(i.isTransparent=this.isTransparent),i};PIXI.RenderTexture.prototype.save=function(i="saved_render_texture",e="png",t=1,r=!1){typeof window.saveTexture!="undefined"&&window.saveTexture(this,i,e,t,r)};PIXI.RenderTexture.prototype.resizeBase=PIXI.RenderTexture.prototype.resize;PIXI.RenderTexture.prototype.resize=function(i,e,t){let r=i*e,a=this.baseTexture?this.baseTexture.width*this.baseTexture.height:r;this.baseTexture&&r<a&&this.baseTexture.dispose(),this.resizeBase(i,e,t),BFN.MainUI.requestRender()};PIXI.RenderTexture.prototype.destroyGC=function(i){if(this.baseTexture&&this.baseTexture.maskTexture){try{this.baseTexture.maskTexture.destroyGC(!0)}catch(e){}delete this.baseTexture.maskTexture}this.destroy(i)};PIXI.Texture.prototype.save=function(i="saved_texture",e="png",t=1){typeof window.saveTexture!="undefined"&&window.saveTexture(this,i,e,t)};PIXI.Texture.prototype.destroyGC=function(i){if(this.baseTexture&&this.baseTexture.maskTexture){try{this.baseTexture.maskTexture.destroyGC(!0)}catch(e){}delete this.baseTexture.maskTexture}this.destroy(i)};PIXI.Texture.prototype.setScaleMode=function(i){switch(BFN.Stage.bindTexture(this,null,!0),i){case PIXI.SCALE_MODES.NEAREST:this.baseTexture._glTextures[0].enableNearestScaling();break;case PIXI.SCALE_MODES.LINEAR:this.baseTexture._glTextures[0].enableLinearScaling();break}BFN.Stage.unbindTexture(this)};PIXI.Container.prototype.getMousePosition=function(){return BFN.Stage.plugins.interaction.mouse.getLocalPosition(this)};PIXI.Container.prototype.getPointerPosition=function(i){return i.data.getLocalPosition(this)};PIXI.Graphics.prototype.getMousePosition=function(){return BFN.Stage.plugins.interaction.mouse.getLocalPosition(this)};PIXI.Graphics.prototype.getPointerPosition=function(i){let e=null;return i?e=i.data.getLocalPosition(this):BFN.MainUI.pointerEvent&&(e=BFN.MainUI.pointerEvent.data.getLocalPosition(this)),e||new PIXI.Point};PIXI.WebGLRenderer.prototype.uploadTextureData=function(i,e){BFN.PIXITicker.started||BFN.PIXITicker.start(),BFN.PIXITicker.keepRunning=!0,this.plugins.prepare.upload(i,()=>{BFN.PIXITicker.keepRunning=!1,BFN.PIXITicker.started&&!BFN.PIXITicker.stopPending&&BFN.PIXITicker.stop(),e&&e()})};PIXI.Container.prototype.renderWebGL=function(e){if(!(!this.visible||this.worldAlpha<=0||!this.renderable||this.hidden))if(this._mask||this._filters)this.renderAdvancedWebGL(e);else{this._renderWebGL(e);for(var t=0,r=this.children.length;t<r;++t)this.children[t].renderWebGL(e)}};PIXI.Container.prototype.renderCanvas=function(e){if(!(!this.visible||this.worldAlpha<=0||!this.renderable||this.hidden)){this._mask&&e.maskManager.pushMask(this._mask),this._renderCanvas(e);for(var t=0,r=this.children.length;t<r;++t)this.children[t].renderCanvas(e);this._mask&&e.maskManager.popMask(e)}};PIXI.DisplayObject.prototype._renderCachedWebGL=function(e){!this.visible||this.worldAlpha<=0||!this.renderable||this.hidden||(this._initCachedDisplayObject(e),this._cacheData.sprite._transformID=-1,this._cacheData.sprite.worldAlpha=this.worldAlpha,this._cacheData.sprite._renderWebGL(e))};PIXI.DisplayObject.prototype._renderCachedCanvas=function(e){!this.visible||this.worldAlpha<=0||!this.renderable||this.hidden||(this._initCachedDisplayObjectCanvas(e),this._cacheData.sprite.worldAlpha=this.worldAlpha,this._cacheData.sprite.renderCanvas(e))};BFN.ReusableCanvasTarget={buffer:new PIXI.CanvasRenderTarget(1,1),release:()=>{BFN.ReusableCanvasTarget.buffer.resize(1,1),BFN.ReusableCanvasTarget.buffer.clear()},destroyAll:()=>{BFN.ReusableCanvasTarget.buffer.resize(1,1),BFN.ReusableCanvasTarget.buffer.clear(),BFN.ReusableCanvasTarget.buffer.destroy(),BFN.ReusableCanvasTarget.buffer=null},TEMP_RECT:new PIXI.Rectangle};PIXI.CanvasRenderTarget.prototype.release=function(){BFN.ReusableCanvasTarget.release()};PIXI.CanvasRenderTarget.prototype.destroyAll=function(){BFN.ReusableCanvasTarget.destroyAll()};PIXI.extract.webgl.prototype.canvasBufferBfn=function(e){var t=4,r=this.renderer,a=void 0,s=void 0,o=void 0,n=!1,l=void 0,c=!1;e&&(e instanceof PIXI.RenderTexture?l=e:(l=this.renderer.generateTexture(e),c=!0)),l?(a=l.baseTexture._glRenderTargets[this.renderer.CONTEXT_UID],s=a.resolution,o=l.frame,n=!1):(a=this.renderer.rootRenderTarget,s=a.resolution,n=!0,o=BFN.ReusableCanvasTarget.TEMP_RECT,o.width=a.size.width,o.height=a.size.height);var h=o.width*s,u=o.height*s,d=BFN.ReusableCanvasTarget.buffer;if(d==null?d=BFN.ReusableCanvasTarget.buffer=new PIXI.CanvasRenderTarget(h,u):d.resize(h,u),a){r.bindRenderTarget(a);var m=new Uint8Array(t*h*u),p=r.gl;p.readPixels(o.x*s,o.y*s,h,u,p.RGBA,p.UNSIGNED_BYTE,m);var g=d.context.createImageData(h,u);g.data.set(m),d.context.putImageData(g,0,0),n&&(d.context.scale(1,-1),d.context.drawImage(d.canvas,0,-u)),m=null,g=null,a=null,p=null}return c&&l.destroy(!0),l=null,d};BFN.reportAppBreadcrumbs=!0;BFN.reportAppBreadcrumbs&&(PIXI.Container.prototype.addChildOriginal=PIXI.Container.prototype.addChild,PIXI.Container.prototype.addChild=function(i){for(var e=0;e<arguments.length;e++){let t=this.addChildOriginal(arguments[e]);BFN.SentryManager&&BFN.SentryManager.registerDisplayObject(t,!0)}return i},PIXI.Container.prototype.addChildAtOriginal=PIXI.Container.prototype.addChildAt,PIXI.Container.prototype.addChildAt=function(i,e){let t=this.addChildAtOriginal(i,e);return BFN.SentryManager&&BFN.SentryManager.registerDisplayObject(t,!0),i},PIXI.Container.prototype.removeChildOriginal=PIXI.Container.prototype.removeChild,PIXI.Container.prototype.removeChild=function(i){for(var e=0;e<arguments.length;e++){let t=this.removeChildOriginal(arguments[e]);BFN.SentryManager&&BFN.SentryManager.unregisterDisplayObject(t)}return i},PIXI.Container.prototype.removeChildAtOriginal=PIXI.Container.prototype.removeChildAt,PIXI.Container.prototype.removeChildAt=function(i){let e=this.removeChildAtOriginal(i);return BFN.SentryManager&&BFN.SentryManager.unregisterDisplayObject(e),e},PIXI.Container.prototype.removeChildrenOriginal=PIXI.Container.prototype.removeChildren,PIXI.Container.prototype.removeChildren=function(){let i=this.removeChildrenOriginal(arguments[0],arguments[1]);if(BFN.SentryManager)for(let e=0;e<i.length;e++)BFN.SentryManager.unregisterDisplayObject(i[e]);return i});fabric.CurvedText=fabric.util.createClass(fabric.Text,{_applyIText:function(i,e=0,t=!1){if(!(i&&i instanceof fabric.Text))return;let r=128;this.sourceIText=i;let a=i.text.replace(/\r?\n/gi," ").substring(0,r);if(i.text.length>a.length){let c=a.split(" "),h=c.length;for(;--h>-1&&!c[h];)c.splice(h,1);a=c.join(" ")}this.curveAmount=Math.max(-1,Math.min(1,e)),this.text=a,this.styles={},this.charSpacing=i.charSpacing,this.outlineEnabled=i.outlineEnabled,this.highlightEnabled=i.highlightEnabled,this.backgroundColor=t?"":i.backgroundColor,this.backgroundOverrideColor=t?"":i.backgroundOverrideColor,this.backgroundOverridePadding=t?0:i.backgroundOverridePadding;let s=i.styles,o=this.styles,n=0,l=this.text.length;for(let c in s){o[0]||(o[0]={});for(let h in s[c]){o[0][n]={};for(let u in s[c][h]){let d=s[c][h][u];if(t&&d)switch(u){case"stroke":case"fill":d="white";break;case"textBackgroundColor":d="";break}o[0][n][u]=d}if(++n>=l)break}if(n>=l)break}this.initDimensions(),this._resetCurveCharData()},_resetCurveCharData:function(){delete this.curveCharData},_getCurveCharData:function(){if(this.curveCharData)return this.curveCharData;let i=15,e=this.curveAmount||0,t=0,r=this._textLines[t],a=this.width+this._getWidthOfCharSpacing(),s=this.height,o=this.curveCharData={chars:[],highlights:[],underlines:[],bounds:null,attributes:{curved:e!==0,curveAmount:e,lineW:a,lineH:s,minFontSize:0}};if(!r.length)return o.bounds={minX:0,minY:0,maxX:0,maxY:s,width:0,height:s},o;let n=null,l=(d,m,p,g=null)=>{g=g||this.getCompleteStyleDeclaration(t,d),g.textBackgroundColor?n?n.color===g.textBackgroundColor?n.end=Math.max(0,Math.min(1,(m+p)/a)):(n=null,l(d,m,p,g)):(n={color:g.textBackgroundColor,start:Math.max(0,Math.min(1,m/a)),end:Math.max(0,Math.min(1,(m+p)/a))},o.highlights.push(n)):n&&(n=null)},c=this._getTopOffset()+this.getHeightOfLine(t)/this.lineHeight*(1-this._fontSizeFraction),h=null,u=(d,m,p,g=null)=>{g=g||this.getCompleteStyleDeclaration(t,d),g.underline?h?h.color===g.fill&&h.size===g.fontSize?h.end=Math.max(0,Math.min(1,(m+p)/a)):(h=null,u(d,m,p,g)):(h={color:g.fill,size:g.fontSize,top:c+this.offsets.underline*this.getHeightOfChar(t,d),start:Math.max(0,Math.min(1,m/a)),end:Math.max(0,Math.min(1,(m+p)/a))},o.underlines.push(h)):h&&(h=null)};if(e){let d=Math.PI*2,m=e<0?-1:1,p=Math.PI/180*i,g=Math.min(d,this.text.length*p),f=Math.abs(e)*g,v=a*(d/f),T=v/d+s/4*Math.abs(e),x={x:a/2,y:s/2+T*m};o.attributes.directionFactor=m,o.attributes.activeBeta=f,o.attributes.circleRadius=T,o.attributes.circleCenter=x,o.attributes.circleCircumference=v,o.attributes.arcLength=f/d*v;let B=0;for(let y=0;y<r.length;y++){let F=this.__charBounds[t][y],b=this.getCompleteStyleDeclaration(t,y);o.attributes.minFontSize=o.attributes.minFontSize?Math.min(o.attributes.minFontSize,b.fontSize):b.fontSize,l(y,B,F.kernedWidth,b),u(y,B,F.kernedWidth,b),B+=F.kernedWidth/2;let S=(B-x.x)/x.x,I=(f/2*S-Math.PI/2)*m,_=x.x+Math.cos(I)*T,E=x.y+Math.sin(I)*T,w=Math.atan2(E-x.y,_-x.x)+Math.PI/2+(e<0?Math.PI:0),N=F.kernedWidth,M=s,z=Math.sqrt((N/2)**2+(M/2)**2);o.chars.push({x:_,y:E,rotation:w,width:N,height:M}),B+=F.kernedWidth/2;for(let W=0;W<4;W++){let j=Math.atan2(M/2*(W<2?-1:1),N/2*(W%3?-1:1)),J=w+j,ie=Math.cos(J)*z+_,re=Math.sin(J)*z+E;o.bounds?(o.bounds.minX=Math.min(o.bounds.minX,ie),o.bounds.minY=Math.min(o.bounds.minY,re),o.bounds.maxX=Math.max(o.bounds.maxX,ie),o.bounds.maxY=Math.max(o.bounds.maxY,re)):o.bounds={minX:ie,minY:re,maxX:ie,maxY:re}}}}else{let d=0;for(let m=0;m<r.length;m++){let p=this.__charBounds[t][m],g=this.getCompleteStyleDeclaration(t,m);o.attributes.minFontSize=o.attributes.minFontSize?Math.min(o.attributes.minFontSize,g.fontSize):g.fontSize,l(m,d,p.kernedWidth,g),u(m,d,p.kernedWidth,g),d+=p.kernedWidth/2,o.chars.push({x:d,y:s/2,rotation:0,width:p.kernedWidth,height:s}),d+=p.kernedWidth/2}o.bounds={minX:0,minY:0,maxX:d,maxY:s}}return o.bounds?(o.bounds.width=o.bounds.maxX-o.bounds.minX,o.bounds.height=o.bounds.maxY-o.bounds.minY):o.bounds={minX:0,minY:0,maxX:0,maxY:s,width:0,height:s},o.chars.forEach(d=>{d.offsetX=d.x-o.bounds.minX,d.offsetY=d.y-o.bounds.minY,d.offsetD=Math.sqrt(d.offsetX**2+d.offsetY**2),d.offsetB=Math.atan2(d.offsetY,d.offsetX)}),o},_arcFill:function(i,e="",t=0,r=0,a=0,s=0,o=!1){if(!i||(t=Math.max(0,t),r=Math.max(t,r),!e||t===r||a===s))return;let n=Math.PI*2,l=Math.PI/1800,c=o?s:a,h=o?a:s;for(;c<0;)c+=n;for(;h<0;)h+=n;for(;h<c;)h+=n;let u=Math.abs(h%n-c%n)<l;u&&(c=0,h=n),i.fillStyle=e,i.beginPath(),i.arc(0,0,r,c,h,0),t?i.arc(0,0,t,h,c,1):u||i.lineTo(0,0),i.fill()},_renderTextStroke:function(i){!this.outlineEnabled||(!this.stroke||this.strokeWidth===0)&&this.isEmptyStyles()||(this.shadow&&!this.shadow.affectStroke&&this._removeShadow(i),i.save(),this._setLineDash(i,this.strokeDashArray),i.beginPath(),this._renderTextCommon(i,"strokeText"),i.closePath(),i.restore())},_lineSegmentsIntersect(i,e){let t=(e.b.y-e.a.y)*(i.b.x-i.a.x)-(e.b.x-e.a.x)*(i.b.y-i.a.y);if(t===0)return null;let r=i.a.y-e.a.y,a=i.a.x-e.a.x,s=(e.b.x-e.a.x)*r-(e.b.y-e.a.y)*a,o=(i.b.x-i.a.x)*r-(i.b.y-i.a.y)*a;r=s/t,a=o/t;let n={x:i.a.x+r*(i.b.x-i.a.x),y:i.a.y+r*(i.b.y-i.a.y)},l=r>0&&r<1,c=a>0&&a<1;return l&&c?n:null},_renderBackground(i){if(this.hasOwnProperty("backgroundOverrideColor")||(this.backgroundOverrideColor=""),this.hasOwnProperty("backgroundOverridePadding")||(this.backgroundOverridePadding=0),!this.backgroundOverrideColor)return;i.save();let e=i.getTransform(),t=i.fillStyle,r=this.canvas?this.canvas.getRetinaScaling():1,a=this._getCurveCharData(),{bounds:s,chars:o,attributes:n}=a;if(o.length){let{curved:l,lineH:c}=n,h=this.angle*(Math.PI/180),u=this.backgroundOverrideColor?this.backgroundOverridePadding:this.padding,d=Math.min(1,o.length/5)*.7,m=u*d,p=u*.7,g=-m,f=s.width+m,v=-p,T=s.height+p,x=f-g,B=T-v,y=this.backgroundOverrideColor?this.backgroundOverrideColor:this.backgroundColor;if(l){let{circleCenter:F,circleRadius:b,circleCircumference:S,activeBeta:I,directionFactor:_,arcLength:E}=a.attributes,D=this.scaleX<0,w=this.scaleY<0,N=Math.pow(-1,D+w),M=(F.x-s.minX)*this.scaleX,z=(F.y-s.minY)*this.scaleY,W=Math.sqrt(M**2+z**2),J=Math.atan2(z,M)+h*N,ie=(Math.cos(J)*W+this.left)*r,re=(Math.sin(J)*W+this.top)*r,he=this.scaleX*r,ne=this.scaleY*r;i.setTransform(he,0,0,ne,ie,re),i.rotate(h);let le=Math.PI*2,Be=Math.PI/2,_e=I/le,pe=E+m*2*(1-_e),Ie=Math.min(pe/S*le,le),ke=-(Be*_)-Ie/2,Z=-(Be*_)+Ie/2-ke,U=_<0?1:0,k=_<0?0:1,G=Z*U+ke,L=Z*k+ke,R=b+c/2+p,A=b-c/2-p,X={x:Math.cos(G)*R,y:Math.sin(G)*R},Y={x:Math.cos(G)*A,y:Math.sin(G)*A},ae=s.width/2+u,H=F.y-(_<0?s.maxY+u:s.minY-u),V=F.y-(_<0?s.minY-u:s.maxY+u),K={a:Y,b:X},ee={a:{x:-ae,y:-V},b:{x:-ae,y:-H}},se={a:{x:-ae,y:-V},b:{x:ae,y:-V}},ge=!1,Ce=!1;if(Ie<Math.PI){let Ge=this._lineSegmentsIntersect(K,se);Ge&&(Object.assign(Y,Ge),ge=!0)}let Ne=this._lineSegmentsIntersect(K,ee);if(Ne&&(Object.assign(X,Ne),Ce=!0),Ne=this._lineSegmentsIntersect(K,se),Ne&&(Object.assign(X,Ne),Ce=!0),ge||Ce){A=Math.sqrt(Y.x**2+Y.y**2),R=Math.sqrt(X.x**2+X.y**2);let Ge=Math.abs(R-b),ze=Math.abs(b-A),C=Math.min(Ge,ze);A=b-C,R=b+C}this._arcFill(i,y,A,R,G,L,_<0),this.debugCurve&&((ge||Ce)&&(Y.x=Math.cos(G)*A,Y.y=Math.sin(G)*A,X.x=Math.cos(G)*R,X.y=Math.sin(G)*R),i.strokeStyle="rgb(255,0,0)",i.beginPath(),i.moveTo(ee.a.x,ee.a.y),i.lineTo(ee.b.x,ee.b.y),i.stroke(),i.beginPath(),i.moveTo(se.a.x,se.a.y),i.lineTo(se.b.x,se.b.y),i.stroke(),i.strokeStyle="rgb(0,0,255)",i.beginPath(),i.moveTo(Y.x,Y.y),i.lineTo(X.x,X.y),i.stroke(),i.fillStyle="rgb(0,0,255)",i.beginPath(),i.arc(X.x,X.y,4,0,le,0),i.fill(),i.beginPath(),i.arc(Y.x,Y.y,2,0,le,0),i.fill())}else{let F=this.left*r,b=this.top*r,S=this.scaleX*r,I=this.scaleY*r;i.fillStyle=y,i.setTransform(S,0,0,I,F,b),i.rotate(h),i.fillRect(g,v,x,B)}}i.restore(),i.setTransform(e),i.fillStyle=t,this._removeShadow(i)},_renderTextLinesBackground:function(i){if(!this.highlightEnabled&&!this.debugCurve)return;let e=this.canvas?this.canvas.getRetinaScaling():1,t=this._getCurveCharData(),{highlights:r,bounds:a}=t;if(r.length||this.debugCurve){i.save();let y=i.getTransform(),F=i.fillStyle,{curved:b,lineW:S,lineH:I}=t.attributes,_=this.angle*(Math.PI/180);if(b){let{circleCenter:E,circleRadius:D,activeBeta:w,directionFactor:N}=t.attributes,M=this.scaleX<0,z=this.scaleY<0,W=Math.pow(-1,M+z),j=(E.x-a.minX)*this.scaleX,J=(E.y-a.minY)*this.scaleY,ie=Math.sqrt(j**2+J**2),he=Math.atan2(J,j)+_*W,ne=(Math.cos(he)*ie+this.left)*e,le=(Math.sin(he)*ie+this.top)*e,Be=this.scaleX*e,_e=this.scaleY*e;i.setTransform(Be,0,0,_e,ne,le),i.rotate(_);let pe=-(Math.PI/2*N)-w/2,Ie=-(Math.PI/2*N)+w/2,ke=Ie-pe;r.forEach(de=>{let Z=N<0?1-de.start:de.start,U=N<0?1-de.end:de.end,k=ke*Z+pe,G=ke*U+pe,L=D+I/2,R=L-I;this._arcFill(i,de.color,R,L,k,G,N<0)}),this.debugCurve&&this._arcFill(i,"rgba(0,0,0,.25)",D-I/2,D+I/2,pe,Ie)}else{let E=this.left*e,D=this.top*e,w=this.scaleX*e,N=this.scaleY*e;i.setTransform(w,0,0,N,E,D),i.rotate(_),r.forEach(M=>{i.fillStyle=M.color,i.fillRect(M.start*S,0,(M.end-M.start)*S,I)}),this.debugCurve&&(i.fillStyle="rgba(0,0,0,.25)",i.fillRect(0,0,S,I))}i.restore(),i.setTransform(y),i.fillStyle=F,this._removeShadow(i)}if(!!this.debugCurve&&!(!this.textBackgroundColor&&!this.styleHas("textBackgroundColor"))){for(var s=0,o,n,l=i.fillStyle,c,h,u=this._getLeftOffset(),d=this._getTopOffset(),m=0,p=0,g,f,v=0,T=this._textLines.length;v<T;v++){if(o=this.getHeightOfLine(v),!this.textBackgroundColor&&!this.styleHas("textBackgroundColor",v)){s+=o;continue}c=this._textLines[v],n=this._getLineLeftOffset(v),p=0,m=0,h=this.getValueOfPropertyAt(v,0,"textBackgroundColor");for(var x=0,B=c.length;x<B;x++)g=this.__charBounds[v][x],f=this.getValueOfPropertyAt(v,x,"textBackgroundColor"),f!==h?(i.fillStyle=h,h&&i.fillRect(u+n+m,d+s,p,o/this.lineHeight),m=g.left,p=g.width,h=f):p+=g.kernedWidth;f&&(i.fillStyle=f,i.fillRect(u+n+m,d+s,p,o/this.lineHeight)),s+=o}i.fillStyle=l,this._removeShadow(i)}},_renderTextDecoration:function(i,e){let t=this.canvas?this.canvas.getRetinaScaling():1,r=this._getCurveCharData(),{underlines:a,bounds:s}=r;if(e==="underline"&&a.length){i.save();let D=i.getTransform(),w=i.fillStyle,{curved:N,lineW:M,lineH:z,minFontSize:W}=r.attributes,j=W/15,J=this.angle*(Math.PI/180);if(N){let{circleCenter:ie,circleRadius:re,activeBeta:he,directionFactor:ne}=r.attributes,le=this.scaleX<0,Be=this.scaleY<0,_e=Math.pow(-1,le+Be),pe=(ie.x-s.minX)*this.scaleX,Ie=(ie.y-s.minY)*this.scaleY,ke=Math.sqrt(pe**2+Ie**2),Z=Math.atan2(Ie,pe)+J*_e,U=(Math.cos(Z)*ke+this.left)*t,k=(Math.sin(Z)*ke+this.top)*t,G=this.scaleX*t,L=this.scaleY*t;i.setTransform(G,0,0,L,U,k),i.rotate(J);let R=-(Math.PI/2*ne)-he/2,X=-(Math.PI/2*ne)+he/2-R;a.forEach(Y=>{let ae=ne<0?1-Y.start:Y.start,H=ne<0?1-Y.end:Y.end,V=X*ae+R,K=X*H+R,ee=ne<0?re+Y.top+j:re-Y.top,se=ee-j;this._arcFill(i,Y.color,se,ee,V,K,ne<0)})}else{let ie=this.left*t,re=this.top*t,he=this.scaleX*t,ne=this.scaleY*t;i.setTransform(he,0,0,ne,ie,re),i.rotate(J),a.forEach(le=>{i.fillStyle=le.color,i.fillRect(le.start*M,z/2+le.top,(le.end-le.start)*M,j)})}i.restore(),i.setTransform(D),i.fillStyle=w,this._removeShadow(i)}if(!!this.debugCurve&&!(!this[e]&&!this.styleHas(e))){for(var o,n,l,c,h,u,d,m,p=this._getLeftOffset(),g=this._getTopOffset(),f,v,T,x,B,y,F,b,S=0,I=this._textLines.length;S<I;S++){if(o=this.getHeightOfLine(S),!this[e]&&!this.styleHas(e,S)){g+=o;continue}d=this._textLines[S],y=o/this.lineHeight,c=this._getLineLeftOffset(S),v=0,T=0,m=this.getValueOfPropertyAt(S,0,e),b=this.getValueOfPropertyAt(S,0,"fill"),f=g+y*(1-this._fontSizeFraction),n=this.getHeightOfChar(S,0),h=this.getValueOfPropertyAt(S,0,"deltaY");for(var _=0,E=d.length;_<E;_++)x=this.__charBounds[S][_],B=this.getValueOfPropertyAt(S,_,e),F=this.getValueOfPropertyAt(S,_,"fill"),l=this.getHeightOfChar(S,_),u=this.getValueOfPropertyAt(S,_,"deltaY"),(B!==m||F!==b||l!==n||u!==h)&&T>0?(i.fillStyle=b,m&&b&&i.fillRect(p+c+v,f+this.offsets[e]*n+h,T,this.fontSize/15),v=x.left,T=x.width,m=B,b=F,n=l,h=u):T+=x.kernedWidth;i.fillStyle=F,B&&F&&i.fillRect(p+c+v,f+this.offsets[e]*n+h,T,this.fontSize/15),g+=o}this._removeShadow(i)}},_renderCharsCurved:function(i,e,t,r,a,s){if(s)return;let o=this.canvas?this.canvas.getRetinaScaling():1;this.debugCurve&&(e.lineWidth=1/this.scaleX);let n=e.getTransform(),l=this._getCurveCharData(),{chars:c,bounds:h}=l;if(c&&h){let u=this.angle*(Math.PI/180);for(let d=0;d<c.length;d++){let m=c[d],p=(Math.cos(m.offsetB+u)*m.offsetD*this.scaleX+this.left)*o,g=(Math.sin(m.offsetB+u)*m.offsetD*this.scaleY+this.top)*o,f=this.scaleX*o,v=this.scaleY*o;e.setTransform(f,0,0,v,p,g),e.rotate(m.rotation+u),this.debugCurve&&i==="fillText"&&e.strokeRect(-(m.width/2),-(m.height/2),m.width,m.height),this._renderChar(i,e,s,d,t[d],-(m.width/2),a)}this.debugCurve&&i==="fillText"&&(e.setTransform(this.scaleX,0,0,this.scaleY,this.left,this.top),e.rotate(u),e.strokeRect(0,0,h.width,h.height))}e.setTransform(n)},_renderChars:function(i,e,t,r,a,s){var o=this.getHeightOfLine(s),n=this.textAlign.indexOf("justify")!==-1,l,c,h="",u,d=0,m,p=!n&&this.charSpacing===0&&this.isEmptyStyles(s);if(e.save(),a-=o*this._fontSizeFraction/this.lineHeight,this._renderCharsCurved(i,e,t,r,a,s),this.debugCurve){o=this.height;for(var g=0,f=t.length-1;g<=f;g++)m=!0,h+=t[g],u=this.__charBounds[s][g],d===0?(r+=u.kernedWidth-u.width,d+=u.width):d+=u.kernedWidth,n&&!m&&this._reSpaceAndTab.test(t[g])&&(m=!0),m||(l=l||this.getCompleteStyleDeclaration(s,g),c=this.getCompleteStyleDeclaration(s,g+1),m=this._hasStyleChanged(l,c)),m&&(this._renderChar(i,e,s,g,h,r,a,o),h="",l=c,r+=d,d=0)}e.restore()},_renderChar:function(i,e,t,r,a,s,o){var n=this._getStyleDeclaration(t,r),l=this.getCompleteStyleDeclaration(t,r),c=i==="fillText"&&l.fill,h=i==="strokeText"&&l.stroke&&l.strokeWidth;!h&&!c||(n&&e.save(),this._applyCharStyles(i,e,t,r,l),n&&n.textBackgroundColor&&this._removeShadow(e),n&&n.deltaY&&(o+=n.deltaY),this.debugCurve&&(e.fillStyle="rgba(0,0,0,.5)"),c&&e.fillText(a,s,o),h&&e.strokeText(a,s,o),n&&e.restore())}});fabric.TextboxPad=fabric.util.createClass(fabric.Textbox,{_renderBackground(i){if(this.hasOwnProperty("backgroundOverrideColor")||(this.backgroundOverrideColor=""),this.hasOwnProperty("backgroundOverridePadding")||(this.backgroundOverridePadding=0),!this.backgroundColor&&!this.backgroundOverrideColor)return;let e=this._getNonTransformedDimensions();i.fillStyle=this.backgroundOverrideColor?this.backgroundOverrideColor:this.backgroundColor;let t=this.backgroundOverrideColor?this.backgroundOverridePadding:this.padding;i.fillRect(-e.x/2-t,-e.y/2-t,e.x+t*2,e.y+t*2),this._removeShadow(i)}});fabric.Canvas.prototype.__onMouseDownOriginal=fabric.Canvas.prototype.__onMouseDown;fabric.Canvas.prototype.__onMouseDown=function(i){this.ignoreMouseDown||this.__onMouseDownOriginal(i)};fabric.util.object.extend(fabric.TextboxPad.prototype,{initDimensions:function(){if(!this.__skipDimension){this.isEditing&&this.initDelayedCursor(),this.clearContextTop(),this._clearCache(),this.dynamicMinWidth=0,this._styleMap=this._generateStyleMap(this._splitText()),this.dynamicMinWidth>this.width&&this._set("width",this.dynamicMinWidth),this.textAlign.indexOf("justify")!==-1&&this.enlargeSpaces(),this.height=this.calcTextHeight(),this.saveState({propertySet:"_dimensionAffectingProps"}),this.prevScaledHeight=this.prevScaledHeight||0;var i=this.height*this.scaleY;Math.abs(i-this.prevScaledHeight)>.1&&(this.fire("height:changed",{target:this,before:this.prevScaledHeight||0,after:i}),this.prevScaledHeight=i)}},_renderTextStroke:function(i){!this.outlineEnabled||(!this.stroke||this.strokeWidth===0)&&this.isEmptyStyles()||(this.shadow&&!this.shadow.affectStroke&&this._removeShadow(i),i.save(),this._setLineDash(i,this.strokeDashArray),i.beginPath(),this._renderTextCommon(i,"strokeText"),i.closePath(),i.restore())},_renderTextLinesBackground:function(i){if(!!this.highlightEnabled&&!(!this.textBackgroundColor&&!this.styleHas("textBackgroundColor"))){for(var e=0,t,r,a=i.fillStyle,s,o,n=this._getLeftOffset(),l=this._getTopOffset(),c=0,h=0,u,d,m=0,p=this._textLines.length;m<p;m++){if(t=this.getHeightOfLine(m),!this.textBackgroundColor&&!this.styleHas("textBackgroundColor",m)){e+=t;continue}s=this._textLines[m],r=this._getLineLeftOffset(m),h=0,c=0,o=this.getValueOfPropertyAt(m,0,"textBackgroundColor");for(var g=0,f=s.length;g<f;g++)u=this.__charBounds[m][g],d=this.getValueOfPropertyAt(m,g,"textBackgroundColor"),d!==o?(i.fillStyle=o,o&&i.fillRect(n+r+c,l+e,h,t/this.lineHeight),c=u.left,h=u.width,o=d):h+=u.kernedWidth;d&&(i.fillStyle=d,i.fillRect(n+r+c,l+e,h,t/this.lineHeight)),e+=t}i.fillStyle=a,this._removeShadow(i)}},_renderTextDecoration:function(i,e){if(!(!this[e]&&!this.styleHas(e))){var t=this.fontSize/15;if(e==="underline"){var r=0;for(let _ in this.styles){let E=this.styles[_];for(let D in E){let w=E[D];w.fontSize&&(r=r?Math.min(r,w.fontSize):w.fontSize)}}t=(r||this.fontSize)/15}for(var a,s,o,n,l,c,h,u,d=this._getLeftOffset(),m=this._getTopOffset(),p,g,f,v,T,x,B,y,F=0,b=this._textLines.length;F<b;F++){if(a=this.getHeightOfLine(F),!this[e]&&!this.styleHas(e,F)){m+=a;continue}h=this._textLines[F],x=a/this.lineHeight,n=this._getLineLeftOffset(F),g=0,f=0,u=this.getValueOfPropertyAt(F,0,e),y=this.getValueOfPropertyAt(F,0,"fill"),p=m+x*(1-this._fontSizeFraction),s=this.getHeightOfChar(F,0),l=this.getValueOfPropertyAt(F,0,"deltaY");for(var S=0,I=h.length;S<I;S++)v=this.__charBounds[F][S],T=this.getValueOfPropertyAt(F,S,e),B=this.getValueOfPropertyAt(F,S,"fill"),o=this.getHeightOfChar(F,S),c=this.getValueOfPropertyAt(F,S,"deltaY"),(T!==u||B!==y||o!==s||c!==l)&&f>0?(i.fillStyle=y,u&&y&&i.fillRect(d+n+g,p+this.offsets[e]*s+l,f,t),g=v.left,f=v.width,u=T,y=B,s=o,l=c):f+=v.kernedWidth;i.fillStyle=B,T&&B&&i.fillRect(d+n+g,p+this.offsets[e]*s+l,f,t),m+=a}this._removeShadow(i)}},styleIsEmpty:function(i,e=null){if(!(i&&typeof i=="string"))return;e=e||this.styles;let t=!0;for(let r in e){let a=e[r];for(let s in a){let o=a[s];t&&!!o[i]&&(t=!1)}}return t},setStyles:function(i,e=null,t=!1){if(!!(i&&i instanceof Object)){e=e||this.styles;for(let r in e){let a=e[r];for(let s in a){let o=a[s];for(let n in i)o[n]=i[n]}}t&&e!==this.styles&&this.setStyles(i)}}});fabric.enableWordBreaks=!0;fabric.wordBreakMethods={wordBreaksEnabled:!0,updateFromTextArea:function(){if(!!this.hiddenTextarea){this.cursorOffsetCache={},this.text=this.hiddenTextarea.value,this._shouldClearDimensionCache()&&(this.preventWrapTextSelectionModify=!0,this.initDimensions(),this.preventWrapTextSelectionModify=!1,this.setCoords());var i=this.fromStringToGraphemeSelection(this.hiddenTextarea.selectionStart,this.hiddenTextarea.selectionEnd,this.hiddenTextarea.value);this.selectionEnd=this.selectionStart=i.selectionEnd,this.inCompositionMode||(this.selectionStart=i.selectionStart),this.updateTextareaPosition()}},_updateTextarea:function(){if(this.cursorOffsetCache={},!!this.hiddenTextarea){if(!this.inCompositionMode){var i=this.fromGraphemeToStringSelection(this.selectionStart,this.selectionEnd,this._text);this.hiddenTextarea.selectionStart=this.hiddenTextarea.prevSelectionStart=i.selectionStart,this.hiddenTextarea.selectionEnd=this.hiddenTextarea.prevSelectionEnd=i.selectionEnd}this.updateTextareaPosition()}},fromStringToGraphemeSelection:function(i,e,t){if(this.wordBreakIndices)for(var r=0,a=0;a<this.wordBreakIndices.length;a++){var s=this.wordBreakIndices[a]+r;i>=s&&(i=Math.min(this.textLength,i+1)),e>=s&&(e=Math.min(this.textLength,e+1)),r+=1}return{selectionStart:i,selectionEnd:e}},fromGraphemeToStringSelection:function(i,e,t){if(this.wordBreakIndices)for(var r=0;r<this.wordBreakIndices.length;r++){var a=this.wordBreakIndices[r];i>a&&(i=Math.max(0,i-1)),e>a&&(e=Math.max(0,e-1))}return{selectionStart:i,selectionEnd:e}},trackStyles:function(i="trackStyles"){console.log(i);var e={};for(var t in this.styles){e[t]={};var r=this.styles[t],a=0;for(var s in r)e[t][s]=Object.assign(this.styles[t][s]),a++;console.log(t,":",a)}console.log(e),console.log("")},getSelectionStartFromPointer:function(i){if(!this.canvas)return 0;var e=this.getLocalPointer(i),t=0,r=0,a=0,s=0,o=0,n,l;this.flipX&&(e.x=this.width*this.scaleX-e.x),this.flipY&&(e.y=this.height*this.scaleY-e.y);for(var c=0,h=this._textLines.length;c<h&&a<=e.y;c++)a+=this.getHeightOfLine(c)*this.scaleY,o=c,c>0&&(s+=this._textLines[c-1].length+1);n=this._getLineLeftOffset(o),r=n*this.scaleX,l=this._textLines[o];for(var u=0,d=l.length;u<d&&(t=r,r+=this.__charBounds[o][u].kernedWidth*this.scaleX,r<=e.x);u++)s++;return this._getNewSelectionStartFromOffset(e,t,r,s,d)},_getNewSelectionStartFromOffset:function(i,e,t,r,a){var s=i.x-e,o=t-i.x,n=o>s||o<0?0:1,l=r+n;return l>(this.textLength||this._text.length)&&(l=this.textLength||this._text.length),l},onKeyDown:function(i){if(!(!this.isEditing||this.inCompositionMode)){if(i.keyCode in this.keysMap){var e=["moveCursorLeft","moveCursorRight"],t=["moveCursorUp","moveCursorDown"],r=this.keysMap[i.keyCode];this.flipX&&e.includes(r)&&(r=e[(e.indexOf(r)+1)%e.length]),this.flipY&&t.includes(r)&&(r=t[(t.indexOf(r)+1)%t.length]),this[r](i)}else if(i.keyCode in this.ctrlKeysMapDown&&(i.ctrlKey||i.metaKey))this[this.ctrlKeysMapDown[i.keyCode]](i);else return;i.stopImmediatePropagation(),i.preventDefault(),i.keyCode>=33&&i.keyCode<=40?(this.clearContextTop(),this.renderCursorOrSelection()):this.canvas&&this.canvas.requestRenderAll()}},onInput:function(i){var e=this.fromPaste;if(this.fromPaste=!1,i&&i.stopPropagation(),!!this.isEditing){this.preventWrapTextSelectionModify=!0;var t=this._splitTextIntoLines(this.hiddenTextarea.value).graphemeText,r=this._text.length,a=t.length,s,o,n=a-r;if(this.preventWrapTextSelectionModify=!1,this.hiddenTextarea.value===""){this.inputErase=!0,this.styles={},this.updateFromTextArea(),this.fire("changed"),this.canvas&&(this.canvas.fire("text:changed",{target:this}),this.canvas.requestRenderAll());return}var l={selectionStart:this.hiddenTextarea.selectionStart,selectionEnd:this.hiddenTextarea.selectionEnd},c={selectionStart:this.hiddenTextarea.prevSelectionStart,selectionEnd:this.hiddenTextarea.prevSelectionEnd};this.hiddenTextarea.prevSelectionStart=this.hiddenTextarea.selectionStart,this.hiddenTextarea.prevSelectionEnd=this.hiddenTextarea.selectionEnd;var h=c.selectionStart>l.selectionStart,u=c.selectionStart===l.selectionStart&&l.selectionStart===l.selectionEnd;if(this.inputErase=h||u,c.selectionStart!==c.selectionEnd?(s=this._text.slice(c.selectionStart,c.selectionEnd),n+=c.selectionEnd-c.selectionStart):a<r&&(h?s=this._text.slice(c.selectionEnd+n,c.selectionEnd):s=this._text.slice(c.selectionStart,c.selectionStart-n)),o=t.slice(l.selectionEnd-n,l.selectionEnd),s&&s.length&&(c.selectionStart!==c.selectionEnd?this.removeStyleFromTo(c.selectionStart,c.selectionEnd):h?this.removeStyleFromTo(c.selectionEnd-s.length,c.selectionEnd):this.removeStyleFromTo(c.selectionEnd,c.selectionEnd+s.length)),o.length)if(e&&o.join("")===fabric.copiedText)this.insertNewStyleBlock(o,c.selectionStart,fabric.copiedTextStyle);else if(e){let d=[];for(let m=0;m<o.length;m++)d.push({fromExternalPaste:!0});this.insertNewStyleBlock(o,c.selectionStart,d)}else this.insertNewStyleBlock(o,c.selectionStart);this.updateFromTextArea(),this.fire("changed"),this.canvas&&(this.canvas.fire("text:changed",{target:this}),this.canvas.requestRenderAll())}},_wrapLine:function(i,e,t,r){r=r||0,t-=r,e||(this.dynamicMinWidthWord=0,this.dynamicMinWidthWordChar=0,this.textLength=this.text.length,this.wordWrapped=!1,this.wordBreaks=0,this.wordBreakIndices?this.wordBreakIndices.splice(0):this.wordBreakIndices=[],this.isEditing&&this.hiddenTextarea&&!this.preventWrapTextSelectionModify&&(this.selectionStart=this.hiddenTextarea.selectionStart,this.selectionEnd=this.hiddenTextarea.selectionEnd));var a=this.text.split(this._reNewline),s=0,o=0;if(e<a.length)for(var x=0;x<=e;x++){var n=a[x];x<e?s+=n.length+1:o=s+n.length}var l=[],c=[],h=0,u=!0,d=0,m=0,p=0,g=" ",f=0,v=0,T=this._getWidthOfCharSpacing(),x,B,y,F,b,S,I,_,E,D,w=i.split(this._reSpaceAndTab);for(x=0;x<w.length;x++){if(y=w[x],F=fabric.util.string.graphemeSplit(y),b=this._measureWord(F,e,v),S=this.wordBreaksEnabled&&b-T>t,S||(v+=F.length),h+=b+f-T,h>=t&&!u?(l.push(c),c=[],h=b,u=!0):h+=T,u||c.push(g),f=this._measureWord([g],e,v),S)for(this.wordWrapped=!0,h=0,I=null,B=0;B<F.length;B++)_=F[B],E=this._measureWord([_],e,v,I),h+=E-(B===F.length-1?T:0),h>=t&&!u?(l.push(c),c=[],h=E,u=!0,D=s+v,this.wordBreakIndices.push(D),this.isEditing&&!this.preventWrapTextSelectionModify&&(D+this.wordBreaks+d<=this.selectionStart&&this.selectionStart++,D+this.wordBreaks+d<this.selectionEnd&&this.selectionEnd++),d++):h+=B===F.length-1?T:0,c.push(_),v++,u=!1,E>p&&(p=E);else c=c.concat(F);v++,u=!1,b>m&&(m=b)}return x&&l.push(c),this.textLength+=d,this.wordBreaks+=d,m+r>this.dynamicMinWidthWord&&(this.dynamicMinWidthWord=m-T+r),p+r>this.dynamicMinWidthWordChar&&(this.dynamicMinWidthWordChar=p-T+r),this.dynamicMinWidth=this.wordWrapped?this.dynamicMinWidthWordChar:this.dynamicMinWidthWord,l},_measureWord:function(i,e,t,r){var a=0,s=!0;t=t||0;for(var o=0,n=i.length;o<n;o++){var l=this._getGraphemeBox(i[o],e,o+t,r,s);a+=l.kernedWidth,r=i[o]}return a},getSelectedText:function(){if(this.hiddenTextarea)return this.hiddenTextarea.value.substring(this.hiddenTextarea.selectionStart,this.hiddenTextarea.selectionEnd)},_extendStyles:function(i,e){var t=this.get2DCursorLocation(i,!0);this.styles[t.lineIndex]||(this.styles[t.lineIndex]={}),this.styles[t.lineIndex][t.charIndex]?this.isEditing&&(i=this.modifySelectionIndex(i,-1),t=this.get2DCursorLocation(i,!0)):this.styles[t.lineIndex][t.charIndex]={},this.styles[t.lineIndex][t.charIndex]&&fabric.util.object.extend(this.styles[t.lineIndex][t.charIndex],e)},getSelectionStyles:function(i,e,t){typeof i=="undefined"&&(i=this.selectionStart||0),typeof e=="undefined"&&(e=this.selectionEnd||i),i=this.modifySelectionIndex(i,-1),e=this.modifySelectionIndex(e,-1),i===e&&(i>0?i--:e<this.text.length&&e++),i===e-1&&this.text.length&&e<=this.text.length&&this._reNewline.test(this.text.substring(i,e))&&e<this.text.length&&!this._reNewline.test(this.text.substring(i+1,e+1))&&(i++,e++);for(var r=[],a=i;a<e;a++)r.push(this.getStyleAtPosition(a,t,!0));return r},getStyleAtPosition:function(i,e,t){var r=this.get2DCursorLocation(i,t);this.gettingStyleAtPosition=!0;var a=e?this.getCompleteStyleDeclaration(r.lineIndex,r.charIndex):this._getStyleDeclaration(r.lineIndex,r.charIndex);return this.gettingStyleAtPosition=!1,a||{}},_getStyleDeclaration:function(i,e){if(this._styleMap&&!this.isWrapping&&!this.gettingStyleAtPosition){var t=this._styleMap[i];if(!t)return null;i=t.line,e=t.offset+e}var r=this.styles&&this.styles[i];return r?r[e]:null},getCompleteStyleDeclaration:function(i,e){let t=this._getStyleDeclaration(i,e)||{};for(var r=Object.assign({},t),a=0;a<this._styleProperties.length;a++){let s=this._styleProperties[a];r[s]=typeof t[s]=="undefined"?this[s]:t[s]}return r},modifySelectionIndex:function(i,e){if(this.wordBreakIndices){for(var t=0;t<this.wordBreakIndices.length;t++)i+=this.wordBreakIndices[t]<i?e:0;i=Math.max(0,Math.min(this.textLength,i))}return i},searchWordBoundary:function(i,e){for(var t=this._reSpace.test(this.text.charAt(i))?i-1:i,r=this.text.charAt(t),a=/[ \n\.,;!\?\-]/;!a.test(r)&&t>0&&t<this.text.length;)if(t+=e,r=this.text.charAt(t),e===-1&&a.test(r)){t-=e,r=this.text.charAt(t);break}return a.test(r)&&r!==`
`&&(t+=e===1?0:1),t},selectWord:function(i){i=this.modifySelectionIndex(i||this.selectionStart,-1),this.selectionStart=this.modifySelectionIndex(this.searchWordBoundary(i,-1),1),this.selectionEnd=this.modifySelectionIndex(this.searchWordBoundary(i,1),1),this._fireSelectionChanged(),this._updateTextarea(),this.renderCursorOrSelection()},selectLine:function(i){return i=this.modifySelectionIndex(i||this.selectionStart,-1),this.selectionStart=this.modifySelectionIndex(this.findLineBoundaryLeft(i),1),this.selectionEnd=this.modifySelectionIndex(this.findLineBoundaryRight(i),1),this._fireSelectionChanged(),this._updateTextarea(),this},renderSelection:function(i,e){for(var t=this.inCompositionMode?this.hiddenTextarea.selectionStart:this.selectionStart,r=this.inCompositionMode?this.hiddenTextarea.selectionEnd:this.selectionEnd,a=this.textAlign.indexOf("justify")!==-1,s=this.get2DCursorLocation(t),o=this.get2DCursorLocation(r),n=s.lineIndex,l=o.lineIndex,c=s.charIndex<0?0:s.charIndex,h=o.charIndex<0?0:o.charIndex,u=n;u<=l;u++){var d=this._getLineLeftOffset(u)||0,m=this.getHeightOfLine(u),p=0,g=0,f=0;u===n&&(g=this.__charBounds[n][c].left),u>=n&&u<l?f=a?this.width:this.getLineWidth(u)+this._getWidthOfCharSpacing()||5:u===l&&(h===0?f=this.__charBounds[l][h].left:f=this.__charBounds[l][h-1].left+this.__charBounds[l][h-1].width),p=m,(this.lineHeight<1||u===l&&this.lineHeight>1)&&(m/=this.lineHeight),this.inCompositionMode?(e.fillStyle=this.compositionColor||"black",e.fillRect(i.left+d+g,i.top+i.topOffset+m,f-g,1)):(e.fillStyle=this.selectionColor,e.fillRect(i.left+d+g,i.top+i.topOffset,f-g,m)),i.topOffset+=p}}};fabric.enableWordBreaks&&fabric.util.object.extend(fabric.TextboxPad.prototype,fabric.wordBreakMethods);BFN.getCanvasCoordinates=function(i,e,t){i=typeof i=="number"&&i>=0?i:0,e=typeof e=="number"&&e>=0?e:0,t=t||BFN.AppModel.sectionValue(BFN.PhotoEditorCanvas,BFN.CollageMakerCanvas,BFN.DesignerCanvas);let r=t.scale.x,a=(i-BFN.leftMenuMinimumWidth-BFN.MainUI.x-t.x)/r,s=(e-BFN.topNavBarHeight-BFN.MainUI.y-t.y)/r;return new PIXI.Point(a,s)};BFN.getImageType=function(i){if(typeof i!="string"){BeFunky.throwError(`MenuImageVO id must be a string: ${i} (${BeFunky.getType(i)})`);return}let e=BFN.imageTypes.find(t=>i.startsWith(`${t}_`));if(!e){BeFunky.throwError(`MenuImageVO id "${i}" does not have a valid type`);return}return e};BFN.toTitleCase=function(i){let e=/^(a|an|and|as|at|but|by|en|for|if|in|nor|of|on|or|per|the|to|vs?\.?|via)$/i;return i.replace(/[A-Za-z0-9\u00C0-\u00FF]+[^\s-]*/g,(t,r,a)=>r>0&&r+t.length!==a.length&&t.search(e)>-1&&a.charAt(r-2)!==":"&&(a.charAt(r+t.length)!=="-"||a.charAt(r-1)==="-")&&a.charAt(r-1).search(/[^\s-]/)<0?t.toLowerCase():t.substr(1).search(/[A-Z]|\../)>-1?t:t.charAt(0).toUpperCase()+t.substr(1))};BFN.getDateParts=(i=new Date)=>{let e=`${i.getMonth()+1}`,t=`${i.getDate()}`,r=`${i.getFullYear()}`;e.length<2&&(e=`0${e}`),t.length<2&&(t=`0${t}`);let a=i.toTimeString().split(" ")[0].split(":");return[r,e,t,...a]};BFN.getExtension=i=>{if(!i.includes("."))return"";let e;try{if(e=i.split(".").pop().toLowerCase(),e==="jpg_large"&&(e="jpg"),!/^[a-z0-9]{1,10}$/.test(e))throw"invalid_extension"}catch(t){e=""}return e};BFN.formatKeyString=(i,e="",t=[],r=!0)=>{if(typeof i!="string")return"";let a=[...t];a.forEach((n,l)=>{a[l]=n.toLowerCase()});let s=i.split("_").join(" ").split(" "),o=[];return s.forEach(n=>{a.includes(n.toLowerCase())||o.push(r?n.charAt(0).toUpperCase()+n.slice(1).toLowerCase():n.toLowerCase())}),o.join(e)};BFN.shortcutText=i=>{let e="\u2009";return[BeFunky.isMac?"\u2318":"Ctrl",...i.split("")].join(BeFunky.isMac?e:`${e}+${e}`)};BFN.shortcutString=i=>{let e=document.createElement("string");return e.className="shortcut",BeFunky.isMac||e.setStyles({letterSpacing:"-0.5px"}),e.textContent=i,e};function Bl(){}Object.assign(Bl.prototype,{addEventListener(i,e){this._listeners===void 0&&(this._listeners={});let t=this._listeners;t[i]===void 0&&(t[i]=[]),t[i].indexOf(e)===-1&&t[i].push(e)},hasEventListener(i,e){if(this._listeners===void 0)return!1;let t=this._listeners;return t[i]!==void 0&&t[i].indexOf(e)!==-1},removeEventListener(i,e){if(this._listeners===void 0)return;let r=this._listeners[i];if(r!==void 0){let a=r.indexOf(e);a!==-1&&r.splice(a,1)}},dispatchEvent(i){if(this._listeners===void 0)return;let t=this._listeners[i.type];if(t!==void 0){i.dispatcher=this;let r=t.slice(0);for(let a=0,s=r.length;a<s;a++)r[a].call(this,i)}}});BFN.EventDispatcher=Bl;BFN.FilterHelper={getNextPowerOfTwo:function(i){return i+=i===0,--i,i|=i>>>1,i|=i>>>2,i|=i>>>4,i|=i>>>8,i|=i>>>16,i+1},hex2rgb:function(i,e){i.indexOf("0x")==-1&&(i="0x"+i);let t=[];return t[0]=(i>>16&255)/255,t[1]=(i>>8&255)/255,t[2]=(i&255)/255,e==!0&&(i.length>8?t[3]=(i>>24&255)/255:t[3]=1),t},hex2rgbForPlugin(i,e){return e=e||[],e[0]=(i>>16&255)/255,e[1]=(i>>8&255)/255,e[2]=(i&255)/255,e},hex32torgba:function(i){let e=[];return e[3]=((i&4278190080)>>>24)/255,e[0]=((i&16711680)>>>16)/255,e[1]=((i&65280)>>>8)/255,e[2]=(i&255)/255,e},hex2rgbFactor:function(i){let e=[];return e[0]=(i>>16&255)/255,e[1]=(i>>8&255)/255,e[2]=(i&255)/255,e},normalize:function(i,e,t){return(i-e)/(t-e)},calculateFilterClamp:function(i,e,t){let r=i.size.width-e.destinationFrame.width,a=i.size.height-e.destinationFrame.height,s=r==0?1:1-r/i.size.width,o=a==0?1:1-a/i.size.height;if(t!=null){let n=t.width!=e.defaultFrame.width?Math.abs(e.defaultFrame.width-t.width):t.height!=e.defaultFrame.height?Math.abs(e.defaultFrame.height-t.height):null;n!=null&&(s=s+n/i.size.width,o=o+n/i.size.height)}return{x:1/s,y:1/o}},createLinearGradient:function(i,e,t,r,a,s,o,n,l,c,h){if(i==null&&(i=["rgba(255, 0 ,0, 1.0)","rgba(255, 0 ,255, 1.0)","rgba(0, 0 ,255, 1.0)","rgba(0, 255 ,255, 1.0)","rgba(0, 255 ,0, 1.0)","rgba(255, 255 ,0, 1.0)","rgba(255, 0 ,0, 1.0)"]),e==null&&(e=[0,38,85,128,170,214,255],c=!0),e=BFN.FilterHelper.copy(e),c==!0)for(let p=0;p<e.length;p++)e[p]=e[p]/255;t==null&&(t=0),r==null&&(r=0),a==null&&(a=256),s==null&&(s=3);let u=document.createElement("canvas");u.width=a<<1,u.height=s<<1,u.ctx=u.getContext("2d"),u.ctx.save();let d=null;l==-Math.PI/2?d=u.ctx.createLinearGradient(0,s,0,0):l==-Math.PI/4?d=u.ctx.createLinearGradient(0,s,a,0):d=u.ctx.createLinearGradient(0,0,a,0);for(let p=0,g=i.length;p<g;p++)d.addColorStop(e[p],i[p]);u.ctx.fillStyle=d,u.ctx.fillRect(t,r,a,s);let m=null;if(h==!0){let p=new PIXI.Sprite(PIXI.Texture.fromCanvas(u,BFN.PIXIScaleMode));m=PIXI.RenderTexture.create(o,n),BFN.Stage.render(p,m)}else m=PIXI.Texture.fromCanvas(u,BFN.PIXIScaleMode);return u.ctx.clearRect(0,0,a,s),u.ctx.restore(),m},GetCurvesTexture:function(i,e,t){var r=function(g,f,v){return Math.max(g,Math.min(f,v))},a=function(g){for(var f=new BFN.FilterHelper.SplineInterpolator(g),v=[],T=0;T<256;T++)v.push(r(0,Math.floor(f.interpolate(T/255)*256),255));return v},s=i!=null?BFN.FilterHelper.copy(i):null,o=e!=null?BFN.FilterHelper.copy(e):null,n=t!=null?BFN.FilterHelper.copy(t):null;if(s!=null)for(var l=0;l<s.length;l++)s[l][0]/=255,s[l][1]/=255;if(o!=null)for(var l=0;l<o.length;l++)o[l][0]/=255,o[l][1]/=255;if(n!=null)for(var l=0;l<n.length;l++)n[l][0]/=255,n[l][1]/=255;s=a(s),arguments.length==1?o=n=s:(o=a(o),n=a(n));for(var c=[],h=0;h<256;h++)c.splice(c.length,0,s[h],o[h],n[h],255);var u=document.createElement("canvas");u.width=256,u.height=1;var d=new PIXI.BaseTexture(u);BFN.Stage.textureManager.updateTexture(d),d._glTextures[0].uploadData(new Uint8Array(c),256,1);var m=new PIXI.Sprite(new PIXI.Texture(d)),p=PIXI.RenderTexture.create(m.texture.width,m.texture.height);BFN.Stage.render(m,p),m.destroy(!0);try{d.destroyGC(!0)}catch(g){}return d=null,m=null,u=null,c=null,s=null,o=null,n=null,p},SplineInterpolator:function(i){var e=i.length;this.xa=[],this.ya=[],this.u=[],this.y2=[],i.sort(function(n,l){return n[0]-l[0]});for(var t=0;t<e;t++)this.xa.push(i[t][0]),this.ya.push(i[t][1]);this.u[0]=0,this.y2[0]=0;for(var t=1;t<e-1;++t){var r=this.xa[t+1]-this.xa[t-1],a=(this.xa[t]-this.xa[t-1])/r,s=a*this.y2[t-1]+2;this.y2[t]=(a-1)/s;var o=(this.ya[t+1]-this.ya[t])/(this.xa[t+1]-this.xa[t])-(this.ya[t]-this.ya[t-1])/(this.xa[t]-this.xa[t-1]);this.u[t]=(6*o/r-a*this.u[t-1])/s}this.y2[e-1]=0;for(var t=e-2;t>=0;--t)this.y2[t]=this.y2[t]*this.y2[t+1]+this.u[t]},copy:function(i){var e,t,r;e=Array.isArray(i)?[]:{};for(r in i)t=i[r],e[r]=typeof t=="object"?BFN.FilterHelper.copy(t):t;return e},getUnmaskedInfo:function(){var i=BFN.Stage.gl,e={renderer:"",vendor:""},t=i.getExtension("WEBGL_debug_renderer_info");return t!=null&&(e.renderer=i.getParameter(t.UNMASKED_RENDERER_WEBGL),e.vendor=i.getParameter(t.UNMASKED_VENDOR_WEBGL)),e},emptyPoolForFilter(){BFN.Stage.filterManager.emptyPool()}};BFN.FilterHelper.SplineInterpolator.prototype.interpolate=function(i){for(var e=this.ya.length,t=0,r=e-1;r-t>1;){var a=r+t>>1;this.xa[a]>i?r=a:t=a}var s=this.xa[r]-this.xa[t],o=(this.xa[r]-i)/s,n=(i-this.xa[t])/s;return o*this.ya[t]+n*this.ya[r]+((o*o*o-o)*this.y2[t]+(n*n*n-n)*this.y2[r])*(s*s)/6};var Sl=class extends PIXI.Sprite{constructor(e){super(e)}_renderWebGL(e){this.updateGeometry?this.updateGeometry():this.calculateVertices(),e.setObjectRenderer(e.plugins.picture),e.plugins.picture.render(this)}},Il=Sl;var _l=class extends PIXI.extras.TilingSprite{constructor(e,t,r){super(e,t,r)}_renderWebGL(e){this.updateGeometry&&this.updateGeometry();let t=this._texture;!t||!t.valid||(this.tileTransform.updateLocalTransform(),this.uvTransform.update(),e.setObjectRenderer(e.plugins.picture),e.plugins.picture.render(this))}},Cl=_l;var El="attribute vec2 aVertexPosition;attribute vec2 aTextureCoord;attribute vec4 aColor;uniform mat3 projectionMatrix;varying vec2 vTextureCoord;void main(void){gl_Position=vec4((projectionMatrix*vec3(aVertexPosition,1.)).xy,0.,1.);vTextureCoord=aTextureCoord;}";var Pl="const int A=2;const vec3 B=vec3(0.496,0.284,-0.032);vec4 C(vec4 D){return pow(D,vec4(1./2.2));}vec4 E(vec4 D){return pow(D,vec4(2.2));}vec4 F(sampler2D G,vec2 H,vec2 I,float J,vec2 K,vec2 L,vec4 M,vec4 N,float O){vec2 P=vec2(J/I.x,J/I.y);vec2 Q=1.-P*2.;vec2 R=(H-P)/Q;vec4 S=vec4(0.);if(K.x<1.){vec2 T=1./L/K*0.25;S=E(texture2D(G,R))*0.20;S+=E(texture2D(G,R+vec2(-T.x,0.)))*0.20;S+=E(texture2D(G,R+vec2(T.x,0.)))*0.20;S+=E(texture2D(G,R+vec2(0.,T.y)))*0.20;S+=E(texture2D(G,R+vec2(0.,-T.y)))*0.20;S=C(S)*M;S=mix(S,N*S.a,O);}else{S=texture2D(G,R)*M;S=mix(S,N*S.a,O);}return S;}vec4 U(vec4 V,vec2 W,vec2 X,float Y,vec4 Z,float a,vec4 b){vec2 c=X/vec2(abs(b.z-b.x),abs(b.w-b.y));vec2 P=vec2(Y/c);vec2 d=W-vec2(b.x,b.y);vec2 e;vec2 f;vec2 g;float h;vec2 i;if(a==0.){e=P;g=step(e,clamp(d,vec2(0.),vec2(1.)));h=g.x*g.y;i=step(e,clamp(1.-d,vec2(0.),vec2(1.)));h*=i.x*i.y;}else{e=P-vec2(1./c.x,1./c.y);f=P+P;g=smoothstep(e,f,d);g=max(g,(vec2(1.)-Z.xz));h=g.x*g.y;i=smoothstep(e,f,vec2(b.z-b.x,b.w-b.y)-d);i=max(i,(vec2(1.)-Z.yw));h*=i.x*i.y;}h=pow(h,1.5);vec4 j=mix(vec4(0.),V,h);return j;}varying vec2 vTextureCoord;varying vec4 vColor;uniform sampler2D uSampler;uniform vec4 uColor;uniform vec4 fillColor;uniform float intensity;uniform vec4 uTextureClamp;uniform vec2 dims;uniform vec2 smoothingScaleFactor;uniform vec2 eDimensions;uniform float gap;uniform vec4 gapFactor;uniform float isRotated;void main(void){vec2 R=clamp(vTextureCoord,uTextureClamp.xy,uTextureClamp.zw);vec2 c=eDimensions/vec2(abs(uTextureClamp.z-uTextureClamp.x),abs(uTextureClamp.w-uTextureClamp.y));vec4 S=F(uSampler,R,c,gap,smoothingScaleFactor,dims,uColor,fillColor,intensity);gl_FragColor=U(S,R,eDimensions,gap,gapFactor,isRotated,uTextureClamp);}";var Nl=class extends PIXI.Shader{constructor(e,t,r,a){super(e,t,r);this.bind(),this.tilingMode=a,this.tempQuad=new PIXI.Quad(e),this.tempQuad.initVao(this),this.uniforms.uColor=new Float32Array([1,1,1,1]),this.uniforms.uSampler=[0,1],this.uniforms.fillColor=new Float32Array([0,0,0,1]),this.uniforms.intensity=0}},ls=Nl;var Ml=class extends ls{constructor(e,t){super(e,El,Pl,t);this.bind(),this.uniforms.uColor=new Float32Array(1,1,1,1)}},Dl=Ml;var wl="vec4 A(vec4 B,vec2 C,vec2 D,float E,vec4 F,float G,vec4 H){vec2 I=D/vec2(abs(H.z-H.x),abs(H.w-H.y));vec2 J=vec2(E/I);vec2 K=C-vec2(H.x,H.y);vec2 L;vec2 M;vec2 N;float O;vec2 P;if(G==0.){L=J;N=step(L,clamp(K,vec2(0.),vec2(1.)));O=N.x*N.y;P=step(L,clamp(1.-K,vec2(0.),vec2(1.)));O*=P.x*P.y;}else{L=J-vec2(1./I.x,1./I.y);M=J+J;N=smoothstep(L,M,K);N=max(N,(vec2(1.)-F.xz));O=N.x*N.y;P=smoothstep(L,M,vec2(H.z-H.x,H.w-H.y)-K);P=max(P,(vec2(1.)-F.yw));O*=P.x*P.y;}O=pow(O,1.5);vec4 Q=mix(vec4(0.),B,O);return Q;}const int R=2;const vec3 S=vec3(0.496,0.284,-0.032);vec4 T(vec4 U){return pow(U,vec4(1./2.2));}vec4 V(vec4 U){return pow(U,vec4(2.2));}vec4 W(sampler2D X,vec2 Y,vec2 Z,float a,vec2 b,vec2 c,vec4 d,vec4 e,float f){vec2 J=vec2(a/Z.x,a/Z.y);vec2 g=1.-J*2.;vec2 h=(Y-J)/g;vec4 i=vec4(0.);if(b.x<1.){vec2 j=1./c/b*0.25;i=V(texture2D(X,h))*0.20;i+=V(texture2D(X,h+vec2(-j.x,0.)))*0.20;i+=V(texture2D(X,h+vec2(j.x,0.)))*0.20;i+=V(texture2D(X,h+vec2(0.,j.y)))*0.20;i+=V(texture2D(X,h+vec2(0.,-j.y)))*0.20;i=T(i)*d;i=mix(i,e*i.a,f);}else{i=texture2D(X,h)*d;i=mix(i,e*i.a,f);}return i;}vec3 k(vec4 l,int m){if(m==1){return l.rgb/(l.a+0.000001);}else{return l.rgb/l.a;}}vec4 n(vec3 o,vec3 p,float q,float r){vec4 s;s.xyz=(1.-q)*o+q*p;s.a=q+r*(1.-q);return s;}varying vec2 vTextureCoord;varying vec2 vMapCoord;varying vec4 vColor;uniform sampler2D uSampler[2];uniform vec4 uColor;uniform vec4 fillColor;uniform float intensity;uniform vec4 uTextureClamp;uniform vec2 dims;uniform vec2 smoothingScaleFactor;uniform vec2 eDimensions;uniform float gap;uniform vec4 gapFactor;uniform float isRotated;vec3 t(vec3 i,vec3 u){return i+u;}void main(void){vec2 h=clamp(vTextureCoord,uTextureClamp.xy,uTextureClamp.zw);vec2 I=eDimensions/vec2(abs(uTextureClamp.z-uTextureClamp.x),abs(uTextureClamp.w-uTextureClamp.y));vec4 i=W(uSampler[0],h,I,gap,smoothingScaleFactor,dims,uColor,fillColor,intensity);vec4 u=texture2D(uSampler[1],vMapCoord);if(i.a==0.){gl_FragColor=vec4(0,0,0,0);return;}if(u.a==0.){gl_FragColor=i;return;}vec3 v=k(i,0);vec3 w=k(u,1);vec3 x=clamp(t(v.xyz,w.xyz),0.,1.);vec4 s=n(w,x,i.a,u.a);vec4 Q=vec4(s.xyz*s.a,s.a);Q=mix(i,Q,u.a);gl_FragColor=isRotated==1.?A(Q,h,eDimensions,gap,gapFactor,isRotated,uTextureClamp):Q;}";var kl="vec4 A(vec4 B,vec2 C,vec2 D,float E,vec4 F,float G,vec4 H){vec2 I=D/vec2(abs(H.z-H.x),abs(H.w-H.y));vec2 J=vec2(E/I);vec2 K=C-vec2(H.x,H.y);vec2 L;vec2 M;vec2 N;float O;vec2 P;if(G==0.){L=J;N=step(L,clamp(K,vec2(0.),vec2(1.)));O=N.x*N.y;P=step(L,clamp(1.-K,vec2(0.),vec2(1.)));O*=P.x*P.y;}else{L=J-vec2(1./I.x,1./I.y);M=J+J;N=smoothstep(L,M,K);N=max(N,(vec2(1.)-F.xz));O=N.x*N.y;P=smoothstep(L,M,vec2(H.z-H.x,H.w-H.y)-K);P=max(P,(vec2(1.)-F.yw));O*=P.x*P.y;}O=pow(O,1.5);vec4 Q=mix(vec4(0.),B,O);return Q;}const int R=2;const vec3 S=vec3(0.496,0.284,-0.032);vec4 T(vec4 U){return pow(U,vec4(1./2.2));}vec4 V(vec4 U){return pow(U,vec4(2.2));}vec4 W(sampler2D X,vec2 Y,vec2 Z,float a,vec2 b,vec2 c,vec4 d,vec4 e,float f){vec2 J=vec2(a/Z.x,a/Z.y);vec2 g=1.-J*2.;vec2 h=(Y-J)/g;vec4 i=vec4(0.);if(b.x<1.){vec2 j=1./c/b*0.25;i=V(texture2D(X,h))*0.20;i+=V(texture2D(X,h+vec2(-j.x,0.)))*0.20;i+=V(texture2D(X,h+vec2(j.x,0.)))*0.20;i+=V(texture2D(X,h+vec2(0.,j.y)))*0.20;i+=V(texture2D(X,h+vec2(0.,-j.y)))*0.20;i=T(i)*d;i=mix(i,e*i.a,f);}else{i=texture2D(X,h)*d;i=mix(i,e*i.a,f);}return i;}vec3 k(vec4 l,int m){if(m==1){return l.rgb/(l.a+0.000001);}else{return l.rgb/l.a;}}vec4 n(vec3 o,vec3 p,float q,float r){vec4 s;s.xyz=(1.-q)*o+q*p;s.a=q+r*(1.-q);return s;}varying vec2 vTextureCoord;varying vec2 vMapCoord;varying vec4 vColor;uniform sampler2D uSampler[2];uniform vec4 uColor;uniform vec4 fillColor;uniform float intensity;uniform vec4 uTextureClamp;uniform vec2 dims;uniform vec2 smoothingScaleFactor;const vec3 t=vec3(0.496,0.284,-0.032);const int u=2;uniform vec2 eDimensions;uniform float gap;uniform vec4 gapFactor;uniform float isRotated;vec3 v(vec3 i,vec3 w){return w-i;}void main(void){vec2 h=clamp(vTextureCoord,uTextureClamp.xy,uTextureClamp.zw);vec2 I=eDimensions/vec2(abs(uTextureClamp.z-uTextureClamp.x),abs(uTextureClamp.w-uTextureClamp.y));vec4 i=W(uSampler[0],h,I,gap,smoothingScaleFactor,dims,uColor,fillColor,intensity);vec4 w=texture2D(uSampler[1],vMapCoord);if(i.a==0.){gl_FragColor=vec4(0,0,0,0);return;}if(w.a==0.){gl_FragColor=i;return;}vec3 x=k(i,0);vec3 y=k(w,1);vec3 z=clamp(v(x.xyz,y.xyz),0.,1.);vec4 s=n(y,z,i.a,w.a);vec4 Q=vec4(s.xyz*s.a,s.a);Q=mix(i,Q,w.a);gl_FragColor=isRotated==1.?A(Q,h,eDimensions,gap,gapFactor,isRotated,uTextureClamp):Q;}";var Al="vec4 A(vec4 B,vec2 C,vec2 D,float E,vec4 F,float G,vec4 H){vec2 I=D/vec2(abs(H.z-H.x),abs(H.w-H.y));vec2 J=vec2(E/I);vec2 K=C-vec2(H.x,H.y);vec2 L;vec2 M;vec2 N;float O;vec2 P;if(G==0.){L=J;N=step(L,clamp(K,vec2(0.),vec2(1.)));O=N.x*N.y;P=step(L,clamp(1.-K,vec2(0.),vec2(1.)));O*=P.x*P.y;}else{L=J-vec2(1./I.x,1./I.y);M=J+J;N=smoothstep(L,M,K);N=max(N,(vec2(1.)-F.xz));O=N.x*N.y;P=smoothstep(L,M,vec2(H.z-H.x,H.w-H.y)-K);P=max(P,(vec2(1.)-F.yw));O*=P.x*P.y;}O=pow(O,1.5);vec4 Q=mix(vec4(0.),B,O);return Q;}const int R=2;const vec3 S=vec3(0.496,0.284,-0.032);vec4 T(vec4 U){return pow(U,vec4(1./2.2));}vec4 V(vec4 U){return pow(U,vec4(2.2));}vec4 W(sampler2D X,vec2 Y,vec2 Z,float a,vec2 b,vec2 c,vec4 d,vec4 e,float f){vec2 J=vec2(a/Z.x,a/Z.y);vec2 g=1.-J*2.;vec2 h=(Y-J)/g;vec4 i=vec4(0.);if(b.x<1.){vec2 j=1./c/b*0.25;i=V(texture2D(X,h))*0.20;i+=V(texture2D(X,h+vec2(-j.x,0.)))*0.20;i+=V(texture2D(X,h+vec2(j.x,0.)))*0.20;i+=V(texture2D(X,h+vec2(0.,j.y)))*0.20;i+=V(texture2D(X,h+vec2(0.,-j.y)))*0.20;i=T(i)*d;i=mix(i,e*i.a,f);}else{i=texture2D(X,h)*d;i=mix(i,e*i.a,f);}return i;}vec3 k(vec4 l,int m){if(m==1){return l.rgb/(l.a+0.000001);}else{return l.rgb/l.a;}}vec4 n(vec3 o,vec3 p,float q,float r){vec4 s;s.xyz=(1.-q)*o+q*p;s.a=q+r*(1.-q);return s;}varying vec2 vTextureCoord;varying vec2 vMapCoord;varying vec4 vColor;uniform sampler2D uSampler[2];uniform vec4 uColor;uniform vec4 fillColor;uniform float intensity;uniform vec4 uTextureClamp;uniform vec2 dims;uniform vec2 smoothingScaleFactor;const vec3 t=vec3(0.496,0.284,-0.032);const int u=2;uniform vec2 eDimensions;uniform float gap;uniform vec4 gapFactor;uniform float isRotated;vec3 v(vec3 i,vec3 w){return i*w;}void main(void){vec2 h=clamp(vTextureCoord,uTextureClamp.xy,uTextureClamp.zw);vec2 I=eDimensions/vec2(abs(uTextureClamp.z-uTextureClamp.x),abs(uTextureClamp.w-uTextureClamp.y));vec4 i=W(uSampler[0],h,I,gap,smoothingScaleFactor,dims,uColor,fillColor,intensity);vec4 w=texture2D(uSampler[1],vMapCoord);if(i.a==0.){gl_FragColor=vec4(0,0,0,0);return;}if(w.a==0.){gl_FragColor=i;return;}vec3 x=k(i,0);vec3 y=k(w,1);vec3 z=clamp(v(x.xyz,y.xyz),0.,1.);vec4 s=n(y,z,i.a,w.a);vec4 Q=vec4(s.xyz*s.a,s.a);Q=mix(i,Q,w.a);gl_FragColor=isRotated==1.?A(Q,h,eDimensions,gap,gapFactor,isRotated,uTextureClamp):Q;}";var Ol="vec4 A(vec4 B,vec2 C,vec2 D,float E,vec4 F,float G,vec4 H){vec2 I=D/vec2(abs(H.z-H.x),abs(H.w-H.y));vec2 J=vec2(E/I);vec2 K=C-vec2(H.x,H.y);vec2 L;vec2 M;vec2 N;float O;vec2 P;if(G==0.){L=J;N=step(L,clamp(K,vec2(0.),vec2(1.)));O=N.x*N.y;P=step(L,clamp(1.-K,vec2(0.),vec2(1.)));O*=P.x*P.y;}else{L=J-vec2(1./I.x,1./I.y);M=J+J;N=smoothstep(L,M,K);N=max(N,(vec2(1.)-F.xz));O=N.x*N.y;P=smoothstep(L,M,vec2(H.z-H.x,H.w-H.y)-K);P=max(P,(vec2(1.)-F.yw));O*=P.x*P.y;}O=pow(O,1.5);vec4 Q=mix(vec4(0.),B,O);return Q;}const int R=2;const vec3 S=vec3(0.496,0.284,-0.032);vec4 T(vec4 U){return pow(U,vec4(1./2.2));}vec4 V(vec4 U){return pow(U,vec4(2.2));}vec4 W(sampler2D X,vec2 Y,vec2 Z,float a,vec2 b,vec2 c,vec4 d,vec4 e,float f){vec2 J=vec2(a/Z.x,a/Z.y);vec2 g=1.-J*2.;vec2 h=(Y-J)/g;vec4 i=vec4(0.);if(b.x<1.){vec2 j=1./c/b*0.25;i=V(texture2D(X,h))*0.20;i+=V(texture2D(X,h+vec2(-j.x,0.)))*0.20;i+=V(texture2D(X,h+vec2(j.x,0.)))*0.20;i+=V(texture2D(X,h+vec2(0.,j.y)))*0.20;i+=V(texture2D(X,h+vec2(0.,-j.y)))*0.20;i=T(i)*d;i=mix(i,e*i.a,f);}else{i=texture2D(X,h)*d;i=mix(i,e*i.a,f);}return i;}vec3 k(vec4 l,int m){if(m==1){return l.rgb/(l.a+0.000001);}else{return l.rgb/l.a;}}vec4 n(vec3 o,vec3 p,float q,float r){vec4 s;s.xyz=(1.-q)*o+q*p;s.a=q+r*(1.-q);return s;}varying vec2 vTextureCoord;varying vec2 vMapCoord;varying vec4 vColor;uniform sampler2D uSampler[2];uniform vec4 uColor;uniform vec4 fillColor;uniform float intensity;uniform vec4 uTextureClamp;uniform vec2 dims;uniform vec2 smoothingScaleFactor;const vec3 t=vec3(0.496,0.284,-0.032);const int u=2;uniform vec2 eDimensions;uniform float gap;uniform vec4 gapFactor;uniform float isRotated;vec3 v(vec3 i,vec3 w){return min(i,w);}void main(void){vec2 h=clamp(vTextureCoord,uTextureClamp.xy,uTextureClamp.zw);vec2 I=eDimensions/vec2(abs(uTextureClamp.z-uTextureClamp.x),abs(uTextureClamp.w-uTextureClamp.y));vec4 i=W(uSampler[0],h,I,gap,smoothingScaleFactor,dims,uColor,fillColor,intensity);vec4 w=texture2D(uSampler[1],vMapCoord);if(i.a==0.){gl_FragColor=vec4(0,0,0,0);return;}if(w.a==0.){gl_FragColor=i;return;}vec3 x=k(i,0);vec3 y=k(w,1);vec3 z=clamp(v(x.xyz,y.xyz),0.,1.);vec4 s=n(y,z,i.a,w.a);vec4 Q=vec4(s.xyz*s.a,s.a);Q=mix(i,Q,w.a);gl_FragColor=isRotated==1.?A(Q,h,eDimensions,gap,gapFactor,isRotated,uTextureClamp):Q;}";var Rl="vec4 A(vec4 B,vec2 C,vec2 D,float E,vec4 F,float G,vec4 H){vec2 I=D/vec2(abs(H.z-H.x),abs(H.w-H.y));vec2 J=vec2(E/I);vec2 K=C-vec2(H.x,H.y);vec2 L;vec2 M;vec2 N;float O;vec2 P;if(G==0.){L=J;N=step(L,clamp(K,vec2(0.),vec2(1.)));O=N.x*N.y;P=step(L,clamp(1.-K,vec2(0.),vec2(1.)));O*=P.x*P.y;}else{L=J-vec2(1./I.x,1./I.y);M=J+J;N=smoothstep(L,M,K);N=max(N,(vec2(1.)-F.xz));O=N.x*N.y;P=smoothstep(L,M,vec2(H.z-H.x,H.w-H.y)-K);P=max(P,(vec2(1.)-F.yw));O*=P.x*P.y;}O=pow(O,1.5);vec4 Q=mix(vec4(0.),B,O);return Q;}const int R=2;const vec3 S=vec3(0.496,0.284,-0.032);vec4 T(vec4 U){return pow(U,vec4(1./2.2));}vec4 V(vec4 U){return pow(U,vec4(2.2));}vec4 W(sampler2D X,vec2 Y,vec2 Z,float a,vec2 b,vec2 c,vec4 d,vec4 e,float f){vec2 J=vec2(a/Z.x,a/Z.y);vec2 g=1.-J*2.;vec2 h=(Y-J)/g;vec4 i=vec4(0.);if(b.x<1.){vec2 j=1./c/b*0.25;i=V(texture2D(X,h))*0.20;i+=V(texture2D(X,h+vec2(-j.x,0.)))*0.20;i+=V(texture2D(X,h+vec2(j.x,0.)))*0.20;i+=V(texture2D(X,h+vec2(0.,j.y)))*0.20;i+=V(texture2D(X,h+vec2(0.,-j.y)))*0.20;i=T(i)*d;i=mix(i,e*i.a,f);}else{i=texture2D(X,h)*d;i=mix(i,e*i.a,f);}return i;}vec3 k(vec4 l,int m){if(m==1){return l.rgb/(l.a+0.000001);}else{return l.rgb/l.a;}}vec4 n(vec3 o,vec3 p,float q,float r){vec4 s;s.xyz=(1.-q)*o+q*p;s.a=q+r*(1.-q);return s;}varying vec2 vTextureCoord;varying vec2 vMapCoord;varying vec4 vColor;uniform sampler2D uSampler[2];uniform vec4 uColor;uniform vec4 fillColor;uniform float intensity;uniform vec4 uTextureClamp;uniform vec2 dims;uniform vec2 smoothingScaleFactor;const vec3 t=vec3(0.496,0.284,-0.032);const int u=2;uniform vec2 eDimensions;uniform float gap;uniform vec4 gapFactor;uniform float isRotated;vec3 v(vec3 i,vec3 w){return vec3((i.x==0.)?0.:(1.-((1.-w.x)/i.x)),(i.y==0.)?0.:(1.-((1.-w.y)/i.y)),(i.z==0.)?0.:(1.-((1.-w.z)/i.z)));}void main(void){vec2 h=clamp(vTextureCoord,uTextureClamp.xy,uTextureClamp.zw);vec2 I=eDimensions/vec2(abs(uTextureClamp.z-uTextureClamp.x),abs(uTextureClamp.w-uTextureClamp.y));vec4 i=W(uSampler[0],h,I,gap,smoothingScaleFactor,dims,uColor,fillColor,intensity);vec4 w=texture2D(uSampler[1],vMapCoord);if(i.a==0.){gl_FragColor=vec4(0,0,0,0);return;}if(w.a==0.){gl_FragColor=i;return;}vec3 x=k(i,0);vec3 y=k(w,1);vec3 z=clamp(v(x.xyz,y.xyz),0.,1.);vec4 s=n(y,z,i.a,w.a);vec4 Q=vec4(s.xyz*s.a,s.a);Q=mix(i,Q,w.a);gl_FragColor=isRotated==1.?A(Q,h,eDimensions,gap,gapFactor,isRotated,uTextureClamp):Q;}";var Ll="vec4 A(vec4 B,vec2 C,vec2 D,float E,vec4 F,float G,vec4 H){vec2 I=D/vec2(abs(H.z-H.x),abs(H.w-H.y));vec2 J=vec2(E/I);vec2 K=C-vec2(H.x,H.y);vec2 L;vec2 M;vec2 N;float O;vec2 P;if(G==0.){L=J;N=step(L,clamp(K,vec2(0.),vec2(1.)));O=N.x*N.y;P=step(L,clamp(1.-K,vec2(0.),vec2(1.)));O*=P.x*P.y;}else{L=J-vec2(1./I.x,1./I.y);M=J+J;N=smoothstep(L,M,K);N=max(N,(vec2(1.)-F.xz));O=N.x*N.y;P=smoothstep(L,M,vec2(H.z-H.x,H.w-H.y)-K);P=max(P,(vec2(1.)-F.yw));O*=P.x*P.y;}O=pow(O,1.5);vec4 Q=mix(vec4(0.),B,O);return Q;}const int R=2;const vec3 S=vec3(0.496,0.284,-0.032);vec4 T(vec4 U){return pow(U,vec4(1./2.2));}vec4 V(vec4 U){return pow(U,vec4(2.2));}vec4 W(sampler2D X,vec2 Y,vec2 Z,float a,vec2 b,vec2 c,vec4 d,vec4 e,float f){vec2 J=vec2(a/Z.x,a/Z.y);vec2 g=1.-J*2.;vec2 h=(Y-J)/g;vec4 i=vec4(0.);if(b.x<1.){vec2 j=1./c/b*0.25;i=V(texture2D(X,h))*0.20;i+=V(texture2D(X,h+vec2(-j.x,0.)))*0.20;i+=V(texture2D(X,h+vec2(j.x,0.)))*0.20;i+=V(texture2D(X,h+vec2(0.,j.y)))*0.20;i+=V(texture2D(X,h+vec2(0.,-j.y)))*0.20;i=T(i)*d;i=mix(i,e*i.a,f);}else{i=texture2D(X,h)*d;i=mix(i,e*i.a,f);}return i;}vec3 k(vec4 l,int m){if(m==1){return l.rgb/(l.a+0.000001);}else{return l.rgb/l.a;}}vec4 n(vec3 o,vec3 p,float q,float r){vec4 s;s.xyz=(1.-q)*o+q*p;s.a=q+r*(1.-q);return s;}varying vec2 vTextureCoord;varying vec2 vMapCoord;varying vec4 vColor;uniform sampler2D uSampler[2];uniform vec4 uColor;uniform vec4 fillColor;uniform float intensity;uniform vec4 uTextureClamp;uniform vec2 dims;uniform vec2 smoothingScaleFactor;const vec3 t=vec3(0.496,0.284,-0.032);const int u=2;uniform vec2 eDimensions;uniform float gap;uniform vec4 gapFactor;uniform float isRotated;vec3 v(vec3 i,vec3 w){return(i+w)-1.;}void main(void){vec2 h=clamp(vTextureCoord,uTextureClamp.xy,uTextureClamp.zw);vec2 I=eDimensions/vec2(abs(uTextureClamp.z-uTextureClamp.x),abs(uTextureClamp.w-uTextureClamp.y));vec4 i=W(uSampler[0],h,I,gap,smoothingScaleFactor,dims,uColor,fillColor,intensity);vec4 w=texture2D(uSampler[1],vMapCoord);if(i.a==0.){gl_FragColor=vec4(0,0,0,0);return;}if(w.a==0.){gl_FragColor=i;return;}vec3 x=k(i,0);vec3 y=k(w,1);vec3 z=clamp(v(x.xyz,y.xyz),0.,1.);vec4 s=n(y,z,i.a,w.a);vec4 Q=vec4(s.xyz*s.a,s.a);Q=mix(i,Q,w.a);gl_FragColor=isRotated==1.?A(Q,h,eDimensions,gap,gapFactor,isRotated,uTextureClamp):Q;}";var Vl="vec4 A(vec4 B,vec2 C,vec2 D,float E,vec4 F,float G,vec4 H){vec2 I=D/vec2(abs(H.z-H.x),abs(H.w-H.y));vec2 J=vec2(E/I);vec2 K=C-vec2(H.x,H.y);vec2 L;vec2 M;vec2 N;float O;vec2 P;if(G==0.){L=J;N=step(L,clamp(K,vec2(0.),vec2(1.)));O=N.x*N.y;P=step(L,clamp(1.-K,vec2(0.),vec2(1.)));O*=P.x*P.y;}else{L=J-vec2(1./I.x,1./I.y);M=J+J;N=smoothstep(L,M,K);N=max(N,(vec2(1.)-F.xz));O=N.x*N.y;P=smoothstep(L,M,vec2(H.z-H.x,H.w-H.y)-K);P=max(P,(vec2(1.)-F.yw));O*=P.x*P.y;}O=pow(O,1.5);vec4 Q=mix(vec4(0.),B,O);return Q;}const int R=2;const vec3 S=vec3(0.496,0.284,-0.032);vec4 T(vec4 U){return pow(U,vec4(1./2.2));}vec4 V(vec4 U){return pow(U,vec4(2.2));}vec4 W(sampler2D X,vec2 Y,vec2 Z,float a,vec2 b,vec2 c,vec4 d,vec4 e,float f){vec2 J=vec2(a/Z.x,a/Z.y);vec2 g=1.-J*2.;vec2 h=(Y-J)/g;vec4 i=vec4(0.);if(b.x<1.){vec2 j=1./c/b*0.25;i=V(texture2D(X,h))*0.20;i+=V(texture2D(X,h+vec2(-j.x,0.)))*0.20;i+=V(texture2D(X,h+vec2(j.x,0.)))*0.20;i+=V(texture2D(X,h+vec2(0.,j.y)))*0.20;i+=V(texture2D(X,h+vec2(0.,-j.y)))*0.20;i=T(i)*d;i=mix(i,e*i.a,f);}else{i=texture2D(X,h)*d;i=mix(i,e*i.a,f);}return i;}vec3 k(vec4 l,int m){if(m==1){return l.rgb/(l.a+0.000001);}else{return l.rgb/l.a;}}vec4 n(vec3 o,vec3 p,float q,float r){vec4 s;s.xyz=(1.-q)*o+q*p;s.a=q+r*(1.-q);return s;}varying vec2 vTextureCoord;varying vec2 vMapCoord;varying vec4 vColor;uniform sampler2D uSampler[2];uniform vec4 uColor;uniform vec4 fillColor;uniform float intensity;uniform vec4 uTextureClamp;uniform vec2 dims;uniform vec2 smoothingScaleFactor;const vec3 t=vec3(0.496,0.284,-0.032);const int u=2;uniform vec2 eDimensions;uniform float gap;uniform vec4 gapFactor;uniform float isRotated;vec3 v(vec3 i,vec3 w){return max(i,w);}void main(void){vec2 h=clamp(vTextureCoord,uTextureClamp.xy,uTextureClamp.zw);vec2 I=eDimensions/vec2(abs(uTextureClamp.z-uTextureClamp.x),abs(uTextureClamp.w-uTextureClamp.y));vec4 i=W(uSampler[0],h,I,gap,smoothingScaleFactor,dims,uColor,fillColor,intensity);vec4 w=texture2D(uSampler[1],vMapCoord);if(i.a==0.){gl_FragColor=vec4(0,0,0,0);return;}if(w.a==0.){gl_FragColor=i;return;}vec3 x=k(i,0);vec3 y=k(w,1);vec3 z=clamp(v(x.xyz,y.xyz),0.,1.);vec4 s=n(y,z,i.a,w.a);vec4 Q=vec4(s.xyz*s.a,s.a);Q=mix(i,Q,w.a);gl_FragColor=isRotated==1.?A(Q,h,eDimensions,gap,gapFactor,isRotated,uTextureClamp):Q;}";var Ul="vec4 A(vec4 B,vec2 C,vec2 D,float E,vec4 F,float G,vec4 H){vec2 I=D/vec2(abs(H.z-H.x),abs(H.w-H.y));vec2 J=vec2(E/I);vec2 K=C-vec2(H.x,H.y);vec2 L;vec2 M;vec2 N;float O;vec2 P;if(G==0.){L=J;N=step(L,clamp(K,vec2(0.),vec2(1.)));O=N.x*N.y;P=step(L,clamp(1.-K,vec2(0.),vec2(1.)));O*=P.x*P.y;}else{L=J-vec2(1./I.x,1./I.y);M=J+J;N=smoothstep(L,M,K);N=max(N,(vec2(1.)-F.xz));O=N.x*N.y;P=smoothstep(L,M,vec2(H.z-H.x,H.w-H.y)-K);P=max(P,(vec2(1.)-F.yw));O*=P.x*P.y;}O=pow(O,1.5);vec4 Q=mix(vec4(0.),B,O);return Q;}const int R=2;const vec3 S=vec3(0.496,0.284,-0.032);vec4 T(vec4 U){return pow(U,vec4(1./2.2));}vec4 V(vec4 U){return pow(U,vec4(2.2));}vec4 W(sampler2D X,vec2 Y,vec2 Z,float a,vec2 b,vec2 c,vec4 d,vec4 e,float f){vec2 J=vec2(a/Z.x,a/Z.y);vec2 g=1.-J*2.;vec2 h=(Y-J)/g;vec4 i=vec4(0.);if(b.x<1.){vec2 j=1./c/b*0.25;i=V(texture2D(X,h))*0.20;i+=V(texture2D(X,h+vec2(-j.x,0.)))*0.20;i+=V(texture2D(X,h+vec2(j.x,0.)))*0.20;i+=V(texture2D(X,h+vec2(0.,j.y)))*0.20;i+=V(texture2D(X,h+vec2(0.,-j.y)))*0.20;i=T(i)*d;i=mix(i,e*i.a,f);}else{i=texture2D(X,h)*d;i=mix(i,e*i.a,f);}return i;}vec3 k(vec4 l,int m){if(m==1){return l.rgb/(l.a+0.000001);}else{return l.rgb/l.a;}}vec4 n(vec3 o,vec3 p,float q,float r){vec4 s;s.xyz=(1.-q)*o+q*p;s.a=q+r*(1.-q);return s;}varying vec2 vTextureCoord;varying vec2 vMapCoord;varying vec4 vColor;uniform sampler2D uSampler[2];uniform vec4 uColor;uniform vec4 fillColor;uniform float intensity;uniform vec4 uTextureClamp;uniform vec2 dims;uniform vec2 smoothingScaleFactor;const vec3 t=vec3(0.496,0.284,-0.032);const int u=2;uniform vec2 eDimensions;uniform float gap;uniform vec4 gapFactor;uniform float isRotated;vec3 v(vec3 i,vec3 w){return(i+w)-(i*w);}void main(void){vec2 h=clamp(vTextureCoord,uTextureClamp.xy,uTextureClamp.zw);vec2 I=eDimensions/vec2(abs(uTextureClamp.z-uTextureClamp.x),abs(uTextureClamp.w-uTextureClamp.y));vec4 i=W(uSampler[0],h,I,gap,smoothingScaleFactor,dims,uColor,fillColor,intensity);vec4 w=texture2D(uSampler[1],vMapCoord);if(i.a==0.){gl_FragColor=vec4(0,0,0,0);return;}if(w.a==0.){gl_FragColor=i;return;}vec3 x=k(i,0);vec3 y=k(w,1);vec3 z=clamp(v(x.xyz,y.xyz),0.,1.);vec4 s=n(y,z,i.a,w.a);vec4 Q=vec4(s.xyz*s.a,s.a);Q=mix(i,Q,w.a);gl_FragColor=isRotated==1.?A(Q,h,eDimensions,gap,gapFactor,isRotated,uTextureClamp):Q;}";var Gl="vec4 A(vec4 B,vec2 C,vec2 D,float E,vec4 F,float G,vec4 H){vec2 I=D/vec2(abs(H.z-H.x),abs(H.w-H.y));vec2 J=vec2(E/I);vec2 K=C-vec2(H.x,H.y);vec2 L;vec2 M;vec2 N;float O;vec2 P;if(G==0.){L=J;N=step(L,clamp(K,vec2(0.),vec2(1.)));O=N.x*N.y;P=step(L,clamp(1.-K,vec2(0.),vec2(1.)));O*=P.x*P.y;}else{L=J-vec2(1./I.x,1./I.y);M=J+J;N=smoothstep(L,M,K);N=max(N,(vec2(1.)-F.xz));O=N.x*N.y;P=smoothstep(L,M,vec2(H.z-H.x,H.w-H.y)-K);P=max(P,(vec2(1.)-F.yw));O*=P.x*P.y;}O=pow(O,1.5);vec4 Q=mix(vec4(0.),B,O);return Q;}const int R=2;const vec3 S=vec3(0.496,0.284,-0.032);vec4 T(vec4 U){return pow(U,vec4(1./2.2));}vec4 V(vec4 U){return pow(U,vec4(2.2));}vec4 W(sampler2D X,vec2 Y,vec2 Z,float a,vec2 b,vec2 c,vec4 d,vec4 e,float f){vec2 J=vec2(a/Z.x,a/Z.y);vec2 g=1.-J*2.;vec2 h=(Y-J)/g;vec4 i=vec4(0.);if(b.x<1.){vec2 j=1./c/b*0.25;i=V(texture2D(X,h))*0.20;i+=V(texture2D(X,h+vec2(-j.x,0.)))*0.20;i+=V(texture2D(X,h+vec2(j.x,0.)))*0.20;i+=V(texture2D(X,h+vec2(0.,j.y)))*0.20;i+=V(texture2D(X,h+vec2(0.,-j.y)))*0.20;i=T(i)*d;i=mix(i,e*i.a,f);}else{i=texture2D(X,h)*d;i=mix(i,e*i.a,f);}return i;}vec3 k(vec4 l,int m){if(m==1){return l.rgb/(l.a+0.000001);}else{return l.rgb/l.a;}}vec4 n(vec3 o,vec3 p,float q,float r){vec4 s;s.xyz=(1.-q)*o+q*p;s.a=q+r*(1.-q);return s;}varying vec2 vTextureCoord;varying vec2 vMapCoord;varying vec4 vColor;uniform sampler2D uSampler[2];uniform vec4 uColor;uniform vec4 fillColor;uniform float intensity;uniform vec4 uTextureClamp;uniform vec2 dims;uniform vec2 smoothingScaleFactor;const vec3 t=vec3(0.496,0.284,-0.032);const int u=2;uniform vec2 eDimensions;uniform float gap;uniform vec4 gapFactor;uniform float isRotated;vec3 v(vec3 i,vec3 w){return vec3((i.x==1.)?1.:min(1.,w.x/(1.-i.x)),(i.y==1.)?1.:min(1.,w.y/(1.-i.y)),(i.z==1.)?1.:min(1.,w.z/(1.-i.z)));}void main(void){vec2 h=clamp(vTextureCoord,uTextureClamp.xy,uTextureClamp.zw);vec2 I=eDimensions/vec2(abs(uTextureClamp.z-uTextureClamp.x),abs(uTextureClamp.w-uTextureClamp.y));vec4 i=W(uSampler[0],h,I,gap,smoothingScaleFactor,dims,uColor,fillColor,intensity);vec4 w=texture2D(uSampler[1],vMapCoord);if(i.a==0.){gl_FragColor=vec4(0,0,0,0);return;}if(w.a==0.){gl_FragColor=i;return;}vec3 x=k(i,0);vec3 y=k(w,1);vec3 z=clamp(v(x.xyz,y.xyz),0.,1.);vec4 s=n(y,z,i.a,w.a);vec4 Q=vec4(s.xyz*s.a,s.a);Q=mix(i,Q,w.a);gl_FragColor=isRotated==1.?A(Q,h,eDimensions,gap,gapFactor,isRotated,uTextureClamp):Q;}";var Hl="vec4 A(vec4 B,vec2 C,vec2 D,float E,vec4 F,float G,vec4 H){vec2 I=D/vec2(abs(H.z-H.x),abs(H.w-H.y));vec2 J=vec2(E/I);vec2 K=C-vec2(H.x,H.y);vec2 L;vec2 M;vec2 N;float O;vec2 P;if(G==0.){L=J;N=step(L,clamp(K,vec2(0.),vec2(1.)));O=N.x*N.y;P=step(L,clamp(1.-K,vec2(0.),vec2(1.)));O*=P.x*P.y;}else{L=J-vec2(1./I.x,1./I.y);M=J+J;N=smoothstep(L,M,K);N=max(N,(vec2(1.)-F.xz));O=N.x*N.y;P=smoothstep(L,M,vec2(H.z-H.x,H.w-H.y)-K);P=max(P,(vec2(1.)-F.yw));O*=P.x*P.y;}O=pow(O,1.5);vec4 Q=mix(vec4(0.),B,O);return Q;}const int R=2;const vec3 S=vec3(0.496,0.284,-0.032);vec4 T(vec4 U){return pow(U,vec4(1./2.2));}vec4 V(vec4 U){return pow(U,vec4(2.2));}vec4 W(sampler2D X,vec2 Y,vec2 Z,float a,vec2 b,vec2 c,vec4 d,vec4 e,float f){vec2 J=vec2(a/Z.x,a/Z.y);vec2 g=1.-J*2.;vec2 h=(Y-J)/g;vec4 i=vec4(0.);if(b.x<1.){vec2 j=1./c/b*0.25;i=V(texture2D(X,h))*0.20;i+=V(texture2D(X,h+vec2(-j.x,0.)))*0.20;i+=V(texture2D(X,h+vec2(j.x,0.)))*0.20;i+=V(texture2D(X,h+vec2(0.,j.y)))*0.20;i+=V(texture2D(X,h+vec2(0.,-j.y)))*0.20;i=T(i)*d;i=mix(i,e*i.a,f);}else{i=texture2D(X,h)*d;i=mix(i,e*i.a,f);}return i;}vec3 k(vec4 l,int m){if(m==1){return l.rgb/(l.a+0.000001);}else{return l.rgb/l.a;}}vec4 n(vec3 o,vec3 p,float q,float r){vec4 s;s.xyz=(1.-q)*o+q*p;s.a=q+r*(1.-q);return s;}varying vec2 vTextureCoord;varying vec2 vMapCoord;varying vec4 vColor;uniform sampler2D uSampler[2];uniform vec4 uColor;uniform vec4 fillColor;uniform float intensity;uniform vec4 uTextureClamp;uniform vec2 dims;uniform vec2 smoothingScaleFactor;const vec3 t=vec3(0.496,0.284,-0.032);const int u=2;uniform vec2 eDimensions;uniform float gap;uniform vec4 gapFactor;uniform float isRotated;vec3 v(vec3 i,vec3 w){return i+w;}void main(void){vec2 h=clamp(vTextureCoord,uTextureClamp.xy,uTextureClamp.zw);vec2 I=eDimensions/vec2(abs(uTextureClamp.z-uTextureClamp.x),abs(uTextureClamp.w-uTextureClamp.y));vec4 i=W(uSampler[0],h,I,gap,smoothingScaleFactor,dims,uColor,fillColor,intensity);vec4 w=texture2D(uSampler[1],vMapCoord);if(i.a==0.){gl_FragColor=vec4(0,0,0,0);return;}if(w.a==0.){gl_FragColor=i;return;}vec3 x=k(i,0);vec3 y=k(w,1);vec3 z=clamp(v(x.xyz,y.xyz),0.,1.);vec4 s=n(y,z,i.a,w.a);vec4 Q=vec4(s.xyz*s.a,s.a);Q=mix(i,Q,w.a);gl_FragColor=isRotated==1.?A(Q,h,eDimensions,gap,gapFactor,isRotated,uTextureClamp):Q;}";var Xl="vec4 A(vec4 B,vec2 C,vec2 D,float E,vec4 F,float G,vec4 H){vec2 I=D/vec2(abs(H.z-H.x),abs(H.w-H.y));vec2 J=vec2(E/I);vec2 K=C-vec2(H.x,H.y);vec2 L;vec2 M;vec2 N;float O;vec2 P;if(G==0.){L=J;N=step(L,clamp(K,vec2(0.),vec2(1.)));O=N.x*N.y;P=step(L,clamp(1.-K,vec2(0.),vec2(1.)));O*=P.x*P.y;}else{L=J-vec2(1./I.x,1./I.y);M=J+J;N=smoothstep(L,M,K);N=max(N,(vec2(1.)-F.xz));O=N.x*N.y;P=smoothstep(L,M,vec2(H.z-H.x,H.w-H.y)-K);P=max(P,(vec2(1.)-F.yw));O*=P.x*P.y;}O=pow(O,1.5);vec4 Q=mix(vec4(0.),B,O);return Q;}const int R=2;const vec3 S=vec3(0.496,0.284,-0.032);vec4 T(vec4 U){return pow(U,vec4(1./2.2));}vec4 V(vec4 U){return pow(U,vec4(2.2));}vec4 W(sampler2D X,vec2 Y,vec2 Z,float a,vec2 b,vec2 c,vec4 d,vec4 e,float f){vec2 J=vec2(a/Z.x,a/Z.y);vec2 g=1.-J*2.;vec2 h=(Y-J)/g;vec4 i=vec4(0.);if(b.x<1.){vec2 j=1./c/b*0.25;i=V(texture2D(X,h))*0.20;i+=V(texture2D(X,h+vec2(-j.x,0.)))*0.20;i+=V(texture2D(X,h+vec2(j.x,0.)))*0.20;i+=V(texture2D(X,h+vec2(0.,j.y)))*0.20;i+=V(texture2D(X,h+vec2(0.,-j.y)))*0.20;i=T(i)*d;i=mix(i,e*i.a,f);}else{i=texture2D(X,h)*d;i=mix(i,e*i.a,f);}return i;}vec3 k(vec4 l,int m){if(m==1){return l.rgb/(l.a+0.000001);}else{return l.rgb/l.a;}}vec4 n(vec3 o,vec3 p,float q,float r){vec4 s;s.xyz=(1.-q)*o+q*p;s.a=q+r*(1.-q);return s;}varying vec2 vTextureCoord;varying vec2 vMapCoord;varying vec4 vColor;uniform sampler2D uSampler[2];uniform vec4 uColor;uniform vec4 fillColor;uniform float intensity;uniform vec4 uTextureClamp;uniform vec2 dims;uniform vec2 smoothingScaleFactor;const vec3 t=vec3(0.496,0.284,-0.032);const int u=2;uniform vec2 eDimensions;uniform float gap;uniform vec4 gapFactor;uniform float isRotated;vec3 v(vec3 i,vec3 w){return vec3((w.x<=0.5)?(2.*i.x*w.x):(1.-2.*(1.-w.x)*(1.-i.x)),(w.y<=0.5)?(2.*i.y*w.y):(1.-2.*(1.-w.y)*(1.-i.y)),(w.z<=0.5)?(2.*i.z*w.z):(1.-2.*(1.-w.z)*(1.-i.z)));}void main(void){vec2 h=clamp(vTextureCoord,uTextureClamp.xy,uTextureClamp.zw);vec2 I=eDimensions/vec2(abs(uTextureClamp.z-uTextureClamp.x),abs(uTextureClamp.w-uTextureClamp.y));vec4 i=W(uSampler[0],h,I,gap,smoothingScaleFactor,dims,uColor,fillColor,intensity);vec4 w=texture2D(uSampler[1],vMapCoord);if(i.a==0.){gl_FragColor=vec4(0,0,0,0);return;}if(w.a==0.){gl_FragColor=i;return;}vec3 x=k(i,0);vec3 y=k(w,1);vec3 z=clamp(v(x.xyz,y.xyz),0.,1.);vec4 s=n(y,z,i.a,w.a);vec4 Q=vec4(s.xyz*s.a,s.a);Q=mix(i,Q,w.a);gl_FragColor=isRotated==1.?A(Q,h,eDimensions,gap,gapFactor,isRotated,uTextureClamp):Q;}";var zl="vec4 A(vec4 B,vec2 C,vec2 D,float E,vec4 F,float G,vec4 H){vec2 I=D/vec2(abs(H.z-H.x),abs(H.w-H.y));vec2 J=vec2(E/I);vec2 K=C-vec2(H.x,H.y);vec2 L;vec2 M;vec2 N;float O;vec2 P;if(G==0.){L=J;N=step(L,clamp(K,vec2(0.),vec2(1.)));O=N.x*N.y;P=step(L,clamp(1.-K,vec2(0.),vec2(1.)));O*=P.x*P.y;}else{L=J-vec2(1./I.x,1./I.y);M=J+J;N=smoothstep(L,M,K);N=max(N,(vec2(1.)-F.xz));O=N.x*N.y;P=smoothstep(L,M,vec2(H.z-H.x,H.w-H.y)-K);P=max(P,(vec2(1.)-F.yw));O*=P.x*P.y;}O=pow(O,1.5);vec4 Q=mix(vec4(0.),B,O);return Q;}const int R=2;const vec3 S=vec3(0.496,0.284,-0.032);vec4 T(vec4 U){return pow(U,vec4(1./2.2));}vec4 V(vec4 U){return pow(U,vec4(2.2));}vec4 W(sampler2D X,vec2 Y,vec2 Z,float a,vec2 b,vec2 c,vec4 d,vec4 e,float f){vec2 J=vec2(a/Z.x,a/Z.y);vec2 g=1.-J*2.;vec2 h=(Y-J)/g;vec4 i=vec4(0.);if(b.x<1.){vec2 j=1./c/b*0.25;i=V(texture2D(X,h))*0.20;i+=V(texture2D(X,h+vec2(-j.x,0.)))*0.20;i+=V(texture2D(X,h+vec2(j.x,0.)))*0.20;i+=V(texture2D(X,h+vec2(0.,j.y)))*0.20;i+=V(texture2D(X,h+vec2(0.,-j.y)))*0.20;i=T(i)*d;i=mix(i,e*i.a,f);}else{i=texture2D(X,h)*d;i=mix(i,e*i.a,f);}return i;}vec3 k(vec4 l,int m){if(m==1){return l.rgb/(l.a+0.000001);}else{return l.rgb/l.a;}}vec4 n(vec3 o,vec3 p,float q,float r){vec4 s;s.xyz=(1.-q)*o+q*p;s.a=q+r*(1.-q);return s;}varying vec2 vTextureCoord;varying vec2 vMapCoord;varying vec4 vColor;uniform sampler2D uSampler[2];uniform vec4 uColor;uniform vec4 fillColor;uniform float intensity;uniform vec4 uTextureClamp;uniform vec2 dims;uniform vec2 smoothingScaleFactor;const vec3 t=vec3(0.496,0.284,-0.032);const int u=2;uniform vec2 eDimensions;uniform float gap;uniform vec4 gapFactor;uniform float isRotated;vec3 v(vec3 i,vec3 w){return vec3((i.x<=0.5)?(w.x-(1.-2.*i.x)*w.x*(1.-w.x)):(((i.x>0.5)&&(w.x<=0.25))?(w.x+(2.*i.x-1.)*(4.*w.x*(4.*w.x+1.)*(w.x-1.)+7.*w.x)):(w.x+(2.*i.x-1.)*(sqrt(w.x)-w.x))),(i.y<=0.5)?(w.y-(1.-2.*i.y)*w.y*(1.-w.y)):(((i.y>0.5)&&(w.y<=0.25))?(w.y+(2.*i.y-1.)*(4.*w.y*(4.*w.y+1.)*(w.y-1.)+7.*w.y)):(w.y+(2.*i.y-1.)*(sqrt(w.y)-w.y))),(i.z<=0.5)?(w.z-(1.-2.*i.z)*w.z*(1.-w.z)):(((i.z>0.5)&&(w.z<=0.25))?(w.z+(2.*i.z-1.)*(4.*w.z*(4.*w.z+1.)*(w.z-1.)+7.*w.z)):(w.z+(2.*i.z-1.)*(sqrt(w.z)-w.z))));}void main(void){vec2 h=clamp(vTextureCoord,uTextureClamp.xy,uTextureClamp.zw);vec2 I=eDimensions/vec2(abs(uTextureClamp.z-uTextureClamp.x),abs(uTextureClamp.w-uTextureClamp.y));vec4 i=W(uSampler[0],h,I,gap,smoothingScaleFactor,dims,uColor,fillColor,intensity);vec4 w=texture2D(uSampler[1],vMapCoord);if(i.a==0.){gl_FragColor=vec4(0,0,0,0);return;}if(w.a==0.){gl_FragColor=i;return;}vec3 x=k(i,0);vec3 y=k(w,1);vec3 z=clamp(v(x.xyz,y.xyz),0.,1.);vec4 s=n(y,z,i.a,w.a);vec4 Q=vec4(s.xyz*s.a,s.a);Q=mix(i,Q,w.a);gl_FragColor=isRotated==1.?A(Q,h,eDimensions,gap,gapFactor,isRotated,uTextureClamp):Q;}";var Wl="vec4 A(vec4 B,vec2 C,vec2 D,float E,vec4 F,float G,vec4 H){vec2 I=D/vec2(abs(H.z-H.x),abs(H.w-H.y));vec2 J=vec2(E/I);vec2 K=C-vec2(H.x,H.y);vec2 L;vec2 M;vec2 N;float O;vec2 P;if(G==0.){L=J;N=step(L,clamp(K,vec2(0.),vec2(1.)));O=N.x*N.y;P=step(L,clamp(1.-K,vec2(0.),vec2(1.)));O*=P.x*P.y;}else{L=J-vec2(1./I.x,1./I.y);M=J+J;N=smoothstep(L,M,K);N=max(N,(vec2(1.)-F.xz));O=N.x*N.y;P=smoothstep(L,M,vec2(H.z-H.x,H.w-H.y)-K);P=max(P,(vec2(1.)-F.yw));O*=P.x*P.y;}O=pow(O,1.5);vec4 Q=mix(vec4(0.),B,O);return Q;}const int R=2;const vec3 S=vec3(0.496,0.284,-0.032);vec4 T(vec4 U){return pow(U,vec4(1./2.2));}vec4 V(vec4 U){return pow(U,vec4(2.2));}vec4 W(sampler2D X,vec2 Y,vec2 Z,float a,vec2 b,vec2 c,vec4 d,vec4 e,float f){vec2 J=vec2(a/Z.x,a/Z.y);vec2 g=1.-J*2.;vec2 h=(Y-J)/g;vec4 i=vec4(0.);if(b.x<1.){vec2 j=1./c/b*0.25;i=V(texture2D(X,h))*0.20;i+=V(texture2D(X,h+vec2(-j.x,0.)))*0.20;i+=V(texture2D(X,h+vec2(j.x,0.)))*0.20;i+=V(texture2D(X,h+vec2(0.,j.y)))*0.20;i+=V(texture2D(X,h+vec2(0.,-j.y)))*0.20;i=T(i)*d;i=mix(i,e*i.a,f);}else{i=texture2D(X,h)*d;i=mix(i,e*i.a,f);}return i;}vec3 k(vec4 l,int m){if(m==1){return l.rgb/(l.a+0.000001);}else{return l.rgb/l.a;}}vec4 n(vec3 o,vec3 p,float q,float r){vec4 s;s.xyz=(1.-q)*o+q*p;s.a=q+r*(1.-q);return s;}varying vec2 vTextureCoord;varying vec2 vMapCoord;varying vec4 vColor;uniform sampler2D uSampler[2];uniform vec4 uColor;uniform vec4 fillColor;uniform float intensity;uniform vec4 uTextureClamp;uniform vec2 dims;uniform vec2 smoothingScaleFactor;const vec3 t=vec3(0.496,0.284,-0.032);const int u=2;uniform vec2 eDimensions;uniform float gap;uniform vec4 gapFactor;uniform float isRotated;vec3 v(vec3 i,vec3 w){return vec3((i.x<=0.5)?(2.*i.x*w.x):(1.-2.*(1.-i.x)*(1.-w.x)),(i.y<=0.5)?(2.*i.y*w.y):(1.-2.*(1.-i.y)*(1.-w.y)),(i.z<=0.5)?(2.*i.z*w.z):(1.-2.*(1.-i.z)*(1.-w.z)));}void main(void){vec2 h=clamp(vTextureCoord,uTextureClamp.xy,uTextureClamp.zw);vec2 I=eDimensions/vec2(abs(uTextureClamp.z-uTextureClamp.x),abs(uTextureClamp.w-uTextureClamp.y));vec4 i=W(uSampler[0],h,I,gap,smoothingScaleFactor,dims,uColor,fillColor,intensity);vec4 w=texture2D(uSampler[1],vMapCoord);if(i.a==0.){gl_FragColor=vec4(0,0,0,0);return;}if(w.a==0.){gl_FragColor=i;return;}vec3 x=k(i,0);vec3 y=k(w,1);vec3 z=clamp(v(x.xyz,y.xyz),0.,1.);vec4 s=n(y,z,i.a,w.a);vec4 Q=vec4(s.xyz*s.a,s.a);Q=mix(i,Q,w.a);gl_FragColor=isRotated==1.?A(Q,h,eDimensions,gap,gapFactor,isRotated,uTextureClamp):Q;}";var $l="vec4 A(vec4 B,vec2 C,vec2 D,float E,vec4 F,float G,vec4 H){vec2 I=D/vec2(abs(H.z-H.x),abs(H.w-H.y));vec2 J=vec2(E/I);vec2 K=C-vec2(H.x,H.y);vec2 L;vec2 M;vec2 N;float O;vec2 P;if(G==0.){L=J;N=step(L,clamp(K,vec2(0.),vec2(1.)));O=N.x*N.y;P=step(L,clamp(1.-K,vec2(0.),vec2(1.)));O*=P.x*P.y;}else{L=J-vec2(1./I.x,1./I.y);M=J+J;N=smoothstep(L,M,K);N=max(N,(vec2(1.)-F.xz));O=N.x*N.y;P=smoothstep(L,M,vec2(H.z-H.x,H.w-H.y)-K);P=max(P,(vec2(1.)-F.yw));O*=P.x*P.y;}O=pow(O,1.5);vec4 Q=mix(vec4(0.),B,O);return Q;}const int R=2;const vec3 S=vec3(0.496,0.284,-0.032);vec4 T(vec4 U){return pow(U,vec4(1./2.2));}vec4 V(vec4 U){return pow(U,vec4(2.2));}vec4 W(sampler2D X,vec2 Y,vec2 Z,float a,vec2 b,vec2 c,vec4 d,vec4 e,float f){vec2 J=vec2(a/Z.x,a/Z.y);vec2 g=1.-J*2.;vec2 h=(Y-J)/g;vec4 i=vec4(0.);if(b.x<1.){vec2 j=1./c/b*0.25;i=V(texture2D(X,h))*0.20;i+=V(texture2D(X,h+vec2(-j.x,0.)))*0.20;i+=V(texture2D(X,h+vec2(j.x,0.)))*0.20;i+=V(texture2D(X,h+vec2(0.,j.y)))*0.20;i+=V(texture2D(X,h+vec2(0.,-j.y)))*0.20;i=T(i)*d;i=mix(i,e*i.a,f);}else{i=texture2D(X,h)*d;i=mix(i,e*i.a,f);}return i;}vec3 k(vec4 l,int m){if(m==1){return l.rgb/(l.a+0.000001);}else{return l.rgb/l.a;}}vec4 n(vec3 o,vec3 p,float q,float r){vec4 s;s.xyz=(1.-q)*o+q*p;s.a=q+r*(1.-q);return s;}varying vec2 vTextureCoord;varying vec2 vMapCoord;varying vec4 vColor;uniform sampler2D uSampler[2];uniform vec4 uColor;uniform vec4 fillColor;uniform float intensity;uniform vec4 uTextureClamp;uniform vec2 dims;uniform vec2 smoothingScaleFactor;const vec3 t=vec3(0.496,0.284,-0.032);const int u=2;uniform vec2 eDimensions;uniform float gap;uniform vec4 gapFactor;uniform float isRotated;vec3 v(vec3 i,vec3 w){return vec3((i.x<=0.5)?(1.-(1.-w.x)/(2.*i.x)):(w.x/(2.*(1.-i.x))),(i.y<=0.5)?(1.-(1.-w.y)/(2.*i.y)):(w.y/(2.*(1.-i.y))),(i.z<=0.5)?(1.-(1.-w.z)/(2.*i.z)):(w.z/(2.*(1.-i.z))));}void main(void){vec2 h=clamp(vTextureCoord,uTextureClamp.xy,uTextureClamp.zw);vec2 I=eDimensions/vec2(abs(uTextureClamp.z-uTextureClamp.x),abs(uTextureClamp.w-uTextureClamp.y));vec4 i=W(uSampler[0],h,I,gap,smoothingScaleFactor,dims,uColor,fillColor,intensity);vec4 w=texture2D(uSampler[1],vMapCoord);if(i.a==0.){gl_FragColor=vec4(0,0,0,0);return;}if(w.a==0.){gl_FragColor=i;return;}vec3 x=k(i,0);vec3 y=k(w,1);vec3 z=clamp(v(x.xyz,y.xyz),0.,1.);vec4 s=n(y,z,i.a,w.a);vec4 Q=vec4(s.xyz*s.a,s.a);Q=mix(i,Q,w.a);gl_FragColor=isRotated==1.?A(Q,h,eDimensions,gap,gapFactor,isRotated,uTextureClamp):Q;}";var jl="vec4 A(vec4 B,vec2 C,vec2 D,float E,vec4 F,float G,vec4 H){vec2 I=D/vec2(abs(H.z-H.x),abs(H.w-H.y));vec2 J=vec2(E/I);vec2 K=C-vec2(H.x,H.y);vec2 L;vec2 M;vec2 N;float O;vec2 P;if(G==0.){L=J;N=step(L,clamp(K,vec2(0.),vec2(1.)));O=N.x*N.y;P=step(L,clamp(1.-K,vec2(0.),vec2(1.)));O*=P.x*P.y;}else{L=J-vec2(1./I.x,1./I.y);M=J+J;N=smoothstep(L,M,K);N=max(N,(vec2(1.)-F.xz));O=N.x*N.y;P=smoothstep(L,M,vec2(H.z-H.x,H.w-H.y)-K);P=max(P,(vec2(1.)-F.yw));O*=P.x*P.y;}O=pow(O,1.5);vec4 Q=mix(vec4(0.),B,O);return Q;}const int R=2;const vec3 S=vec3(0.496,0.284,-0.032);vec4 T(vec4 U){return pow(U,vec4(1./2.2));}vec4 V(vec4 U){return pow(U,vec4(2.2));}vec4 W(sampler2D X,vec2 Y,vec2 Z,float a,vec2 b,vec2 c,vec4 d,vec4 e,float f){vec2 J=vec2(a/Z.x,a/Z.y);vec2 g=1.-J*2.;vec2 h=(Y-J)/g;vec4 i=vec4(0.);if(b.x<1.){vec2 j=1./c/b*0.25;i=V(texture2D(X,h))*0.20;i+=V(texture2D(X,h+vec2(-j.x,0.)))*0.20;i+=V(texture2D(X,h+vec2(j.x,0.)))*0.20;i+=V(texture2D(X,h+vec2(0.,j.y)))*0.20;i+=V(texture2D(X,h+vec2(0.,-j.y)))*0.20;i=T(i)*d;i=mix(i,e*i.a,f);}else{i=texture2D(X,h)*d;i=mix(i,e*i.a,f);}return i;}vec3 k(vec4 l,int m){if(m==1){return l.rgb/(l.a+0.000001);}else{return l.rgb/l.a;}}vec4 n(vec3 o,vec3 p,float q,float r){vec4 s;s.xyz=(1.-q)*o+q*p;s.a=q+r*(1.-q);return s;}varying vec2 vTextureCoord;varying vec2 vMapCoord;varying vec4 vColor;uniform sampler2D uSampler[2];uniform vec4 uColor;uniform vec4 fillColor;uniform float intensity;uniform vec4 uTextureClamp;uniform vec2 dims;uniform vec2 smoothingScaleFactor;const vec3 t=vec3(0.496,0.284,-0.032);const int u=2;uniform vec2 eDimensions;uniform float gap;uniform vec4 gapFactor;uniform float isRotated;vec3 v(vec3 i,vec3 w){return 2.*i+w-1.;}void main(void){vec2 h=clamp(vTextureCoord,uTextureClamp.xy,uTextureClamp.zw);vec2 I=eDimensions/vec2(abs(uTextureClamp.z-uTextureClamp.x),abs(uTextureClamp.w-uTextureClamp.y));vec4 i=W(uSampler[0],h,I,gap,smoothingScaleFactor,dims,uColor,fillColor,intensity);vec4 w=texture2D(uSampler[1],vMapCoord);if(i.a==0.){gl_FragColor=vec4(0,0,0,0);return;}if(w.a==0.){gl_FragColor=i;return;}vec3 x=k(i,0);vec3 y=k(w,1);vec3 z=clamp(v(x.xyz,y.xyz),0.,1.);vec4 s=n(y,z,i.a,w.a);vec4 Q=vec4(s.xyz*s.a,s.a);Q=mix(i,Q,w.a);gl_FragColor=isRotated==1.?A(Q,h,eDimensions,gap,gapFactor,isRotated,uTextureClamp):Q;}";var Yl="vec4 A(vec4 B,vec2 C,vec2 D,float E,vec4 F,float G,vec4 H){vec2 I=D/vec2(abs(H.z-H.x),abs(H.w-H.y));vec2 J=vec2(E/I);vec2 K=C-vec2(H.x,H.y);vec2 L;vec2 M;vec2 N;float O;vec2 P;if(G==0.){L=J;N=step(L,clamp(K,vec2(0.),vec2(1.)));O=N.x*N.y;P=step(L,clamp(1.-K,vec2(0.),vec2(1.)));O*=P.x*P.y;}else{L=J-vec2(1./I.x,1./I.y);M=J+J;N=smoothstep(L,M,K);N=max(N,(vec2(1.)-F.xz));O=N.x*N.y;P=smoothstep(L,M,vec2(H.z-H.x,H.w-H.y)-K);P=max(P,(vec2(1.)-F.yw));O*=P.x*P.y;}O=pow(O,1.5);vec4 Q=mix(vec4(0.),B,O);return Q;}const int R=2;const vec3 S=vec3(0.496,0.284,-0.032);vec4 T(vec4 U){return pow(U,vec4(1./2.2));}vec4 V(vec4 U){return pow(U,vec4(2.2));}vec4 W(sampler2D X,vec2 Y,vec2 Z,float a,vec2 b,vec2 c,vec4 d,vec4 e,float f){vec2 J=vec2(a/Z.x,a/Z.y);vec2 g=1.-J*2.;vec2 h=(Y-J)/g;vec4 i=vec4(0.);if(b.x<1.){vec2 j=1./c/b*0.25;i=V(texture2D(X,h))*0.20;i+=V(texture2D(X,h+vec2(-j.x,0.)))*0.20;i+=V(texture2D(X,h+vec2(j.x,0.)))*0.20;i+=V(texture2D(X,h+vec2(0.,j.y)))*0.20;i+=V(texture2D(X,h+vec2(0.,-j.y)))*0.20;i=T(i)*d;i=mix(i,e*i.a,f);}else{i=texture2D(X,h)*d;i=mix(i,e*i.a,f);}return i;}vec3 k(vec4 l,int m){if(m==1){return l.rgb/(l.a+0.000001);}else{return l.rgb/l.a;}}vec4 n(vec3 o,vec3 p,float q,float r){vec4 s;s.xyz=(1.-q)*o+q*p;s.a=q+r*(1.-q);return s;}varying vec2 vTextureCoord;varying vec2 vMapCoord;varying vec4 vColor;uniform sampler2D uSampler[2];uniform vec4 uColor;uniform vec4 fillColor;uniform float intensity;uniform vec4 uTextureClamp;uniform vec2 dims;uniform vec2 smoothingScaleFactor;const vec3 t=vec3(0.496,0.284,-0.032);const int u=2;uniform vec2 eDimensions;uniform float gap;uniform vec4 gapFactor;uniform float isRotated;vec3 v(vec3 i,vec3 w){return vec3((i.x>0.5)?max(w.x,2.*(i.x-0.5)):min(w.x,2.*i.x),(i.x>0.5)?max(w.y,2.*(i.y-0.5)):min(w.y,2.*i.y),(i.z>0.5)?max(w.z,2.*(i.z-0.5)):min(w.z,2.*i.z));}void main(void){vec2 h=clamp(vTextureCoord,uTextureClamp.xy,uTextureClamp.zw);vec2 I=eDimensions/vec2(abs(uTextureClamp.z-uTextureClamp.x),abs(uTextureClamp.w-uTextureClamp.y));vec4 i=W(uSampler[0],h,I,gap,smoothingScaleFactor,dims,uColor,fillColor,intensity);vec4 w=texture2D(uSampler[1],vMapCoord);if(i.a==0.){gl_FragColor=vec4(0,0,0,0);return;}if(w.a==0.){gl_FragColor=i;return;}vec3 x=k(i,0);vec3 y=k(w,1);vec3 z=clamp(v(x.xyz,y.xyz),0.,1.);vec4 s=n(y,z,i.a,w.a);vec4 Q=vec4(s.xyz*s.a,s.a);Q=mix(i,Q,w.a);gl_FragColor=isRotated==1.?A(Q,h,eDimensions,gap,gapFactor,isRotated,uTextureClamp):Q;}";var ql="vec4 A(vec4 B,vec2 C,vec2 D,float E,vec4 F,float G,vec4 H){vec2 I=D/vec2(abs(H.z-H.x),abs(H.w-H.y));vec2 J=vec2(E/I);vec2 K=C-vec2(H.x,H.y);vec2 L;vec2 M;vec2 N;float O;vec2 P;if(G==0.){L=J;N=step(L,clamp(K,vec2(0.),vec2(1.)));O=N.x*N.y;P=step(L,clamp(1.-K,vec2(0.),vec2(1.)));O*=P.x*P.y;}else{L=J-vec2(1./I.x,1./I.y);M=J+J;N=smoothstep(L,M,K);N=max(N,(vec2(1.)-F.xz));O=N.x*N.y;P=smoothstep(L,M,vec2(H.z-H.x,H.w-H.y)-K);P=max(P,(vec2(1.)-F.yw));O*=P.x*P.y;}O=pow(O,1.5);vec4 Q=mix(vec4(0.),B,O);return Q;}const int R=2;const vec3 S=vec3(0.496,0.284,-0.032);vec4 T(vec4 U){return pow(U,vec4(1./2.2));}vec4 V(vec4 U){return pow(U,vec4(2.2));}vec4 W(sampler2D X,vec2 Y,vec2 Z,float a,vec2 b,vec2 c,vec4 d,vec4 e,float f){vec2 J=vec2(a/Z.x,a/Z.y);vec2 g=1.-J*2.;vec2 h=(Y-J)/g;vec4 i=vec4(0.);if(b.x<1.){vec2 j=1./c/b*0.25;i=V(texture2D(X,h))*0.20;i+=V(texture2D(X,h+vec2(-j.x,0.)))*0.20;i+=V(texture2D(X,h+vec2(j.x,0.)))*0.20;i+=V(texture2D(X,h+vec2(0.,j.y)))*0.20;i+=V(texture2D(X,h+vec2(0.,-j.y)))*0.20;i=T(i)*d;i=mix(i,e*i.a,f);}else{i=texture2D(X,h)*d;i=mix(i,e*i.a,f);}return i;}vec3 k(vec4 l,int m){if(m==1){return l.rgb/(l.a+0.000001);}else{return l.rgb/l.a;}}vec4 n(vec3 o,vec3 p,float q,float r){vec4 s;s.xyz=(1.-q)*o+q*p;s.a=q+r*(1.-q);return s;}varying vec2 vTextureCoord;varying vec2 vMapCoord;varying vec4 vColor;uniform sampler2D uSampler[2];uniform vec4 uColor;uniform vec4 fillColor;uniform float intensity;uniform vec4 uTextureClamp;uniform vec2 dims;uniform vec2 smoothingScaleFactor;const vec3 t=vec3(0.496,0.284,-0.032);const int u=2;uniform vec2 eDimensions;uniform float gap;uniform vec4 gapFactor;uniform float isRotated;vec3 v(vec3 i,vec3 w){return abs(w-i);}void main(void){vec2 h=clamp(vTextureCoord,uTextureClamp.xy,uTextureClamp.zw);vec2 I=eDimensions/vec2(abs(uTextureClamp.z-uTextureClamp.x),abs(uTextureClamp.w-uTextureClamp.y));vec4 i=W(uSampler[0],h,I,gap,smoothingScaleFactor,dims,uColor,fillColor,intensity);vec4 w=texture2D(uSampler[1],vMapCoord);if(i.a==0.){gl_FragColor=vec4(0,0,0,0);return;}if(w.a==0.){gl_FragColor=i;return;}vec3 x=k(i,0);vec3 y=k(w,1);vec3 z=clamp(v(x.xyz,y.xyz),0.,1.);vec4 s=n(y,z,i.a,w.a);vec4 Q=vec4(s.xyz*s.a,s.a);Q=mix(i,Q,w.a);gl_FragColor=isRotated==1.?A(Q,h,eDimensions,gap,gapFactor,isRotated,uTextureClamp):Q;}";var Kl="vec4 A(vec4 B,vec2 C,vec2 D,float E,vec4 F,float G,vec4 H){vec2 I=D/vec2(abs(H.z-H.x),abs(H.w-H.y));vec2 J=vec2(E/I);vec2 K=C-vec2(H.x,H.y);vec2 L;vec2 M;vec2 N;float O;vec2 P;if(G==0.){L=J;N=step(L,clamp(K,vec2(0.),vec2(1.)));O=N.x*N.y;P=step(L,clamp(1.-K,vec2(0.),vec2(1.)));O*=P.x*P.y;}else{L=J-vec2(1./I.x,1./I.y);M=J+J;N=smoothstep(L,M,K);N=max(N,(vec2(1.)-F.xz));O=N.x*N.y;P=smoothstep(L,M,vec2(H.z-H.x,H.w-H.y)-K);P=max(P,(vec2(1.)-F.yw));O*=P.x*P.y;}O=pow(O,1.5);vec4 Q=mix(vec4(0.),B,O);return Q;}const int R=2;const vec3 S=vec3(0.496,0.284,-0.032);vec4 T(vec4 U){return pow(U,vec4(1./2.2));}vec4 V(vec4 U){return pow(U,vec4(2.2));}vec4 W(sampler2D X,vec2 Y,vec2 Z,float a,vec2 b,vec2 c,vec4 d,vec4 e,float f){vec2 J=vec2(a/Z.x,a/Z.y);vec2 g=1.-J*2.;vec2 h=(Y-J)/g;vec4 i=vec4(0.);if(b.x<1.){vec2 j=1./c/b*0.25;i=V(texture2D(X,h))*0.20;i+=V(texture2D(X,h+vec2(-j.x,0.)))*0.20;i+=V(texture2D(X,h+vec2(j.x,0.)))*0.20;i+=V(texture2D(X,h+vec2(0.,j.y)))*0.20;i+=V(texture2D(X,h+vec2(0.,-j.y)))*0.20;i=T(i)*d;i=mix(i,e*i.a,f);}else{i=texture2D(X,h)*d;i=mix(i,e*i.a,f);}return i;}vec3 k(vec4 l,int m){if(m==1){return l.rgb/(l.a+0.000001);}else{return l.rgb/l.a;}}vec4 n(vec3 o,vec3 p,float q,float r){vec4 s;s.xyz=(1.-q)*o+q*p;s.a=q+r*(1.-q);return s;}varying vec2 vTextureCoord;varying vec2 vMapCoord;varying vec4 vColor;uniform sampler2D uSampler[2];uniform vec4 uColor;uniform vec4 fillColor;uniform float intensity;uniform vec4 uTextureClamp;uniform vec2 dims;uniform vec2 smoothingScaleFactor;const vec3 t=vec3(0.496,0.284,-0.032);const int u=2;uniform vec2 eDimensions;uniform float gap;uniform vec4 gapFactor;uniform float isRotated;vec3 v(vec3 i,vec3 w){return i+w-2.*i*w;}void main(void){vec2 h=clamp(vTextureCoord,uTextureClamp.xy,uTextureClamp.zw);vec2 I=eDimensions/vec2(abs(uTextureClamp.z-uTextureClamp.x),abs(uTextureClamp.w-uTextureClamp.y));vec4 i=W(uSampler[0],h,I,gap,smoothingScaleFactor,dims,uColor,fillColor,intensity);vec4 w=texture2D(uSampler[1],vMapCoord);if(i.a==0.){gl_FragColor=vec4(0,0,0,0);return;}if(w.a==0.){gl_FragColor=i;return;}vec3 x=k(i,0);vec3 y=k(w,1);vec3 z=clamp(v(x.xyz,y.xyz),0.,1.);vec4 s=n(y,z,i.a,w.a);vec4 Q=vec4(s.xyz*s.a,s.a);Q=mix(i,Q,w.a);gl_FragColor=isRotated==1.?A(Q,h,eDimensions,gap,gapFactor,isRotated,uTextureClamp):Q;}";var Jl="vec4 A(vec4 B,vec2 C,vec2 D,float E,vec4 F,float G,vec4 H){vec2 I=D/vec2(abs(H.z-H.x),abs(H.w-H.y));vec2 J=vec2(E/I);vec2 K=C-vec2(H.x,H.y);vec2 L;vec2 M;vec2 N;float O;vec2 P;if(G==0.){L=J;N=step(L,clamp(K,vec2(0.),vec2(1.)));O=N.x*N.y;P=step(L,clamp(1.-K,vec2(0.),vec2(1.)));O*=P.x*P.y;}else{L=J-vec2(1./I.x,1./I.y);M=J+J;N=smoothstep(L,M,K);N=max(N,(vec2(1.)-F.xz));O=N.x*N.y;P=smoothstep(L,M,vec2(H.z-H.x,H.w-H.y)-K);P=max(P,(vec2(1.)-F.yw));O*=P.x*P.y;}O=pow(O,1.5);vec4 Q=mix(vec4(0.),B,O);return Q;}const int R=2;const vec3 S=vec3(0.496,0.284,-0.032);vec4 T(vec4 U){return pow(U,vec4(1./2.2));}vec4 V(vec4 U){return pow(U,vec4(2.2));}vec4 W(sampler2D X,vec2 Y,vec2 Z,float a,vec2 b,vec2 c,vec4 d,vec4 e,float f){vec2 J=vec2(a/Z.x,a/Z.y);vec2 g=1.-J*2.;vec2 h=(Y-J)/g;vec4 i=vec4(0.);if(b.x<1.){vec2 j=1./c/b*0.25;i=V(texture2D(X,h))*0.20;i+=V(texture2D(X,h+vec2(-j.x,0.)))*0.20;i+=V(texture2D(X,h+vec2(j.x,0.)))*0.20;i+=V(texture2D(X,h+vec2(0.,j.y)))*0.20;i+=V(texture2D(X,h+vec2(0.,-j.y)))*0.20;i=T(i)*d;i=mix(i,e*i.a,f);}else{i=texture2D(X,h)*d;i=mix(i,e*i.a,f);}return i;}vec3 k(vec4 l,int m){if(m==1){return l.rgb/(l.a+0.000001);}else{return l.rgb/l.a;}}vec4 n(vec3 o,vec3 p,float q,float r){vec4 s;s.xyz=(1.-q)*o+q*p;s.a=q+r*(1.-q);return s;}varying vec2 vTextureCoord;varying vec2 vMapCoord;varying vec4 vColor;uniform sampler2D uSampler[2];uniform vec4 uColor;uniform vec4 fillColor;uniform float intensity;uniform vec4 uTextureClamp;uniform vec2 dims;uniform vec2 smoothingScaleFactor;uniform vec2 eDimensions;uniform float gap;uniform vec4 gapFactor;uniform float isRotated;float t(vec3 u){return dot(u,vec3(0.3,0.59,0.11));}vec3 v(vec3 u){float w=t(u);float x=min(min(u.r,u.g),u.b);float y=max(max(u.r,u.g),u.b);if(x<0.){u.r=w+((u.r-w)*w)/(w-x);u.g=w+((u.g-w)*w)/(w-x);u.b=w+((u.b-w)*w)/(w-x);}if(y>1.){u.r=w+((u.r-w)*(1.-w))/(y-w);u.g=w+((u.g-w)*(1.-w))/(y-w);u.b=w+((u.b-w)*(1.-w))/(y-w);}return u;}vec3 z(vec3 u,float w){float AA=w-t(u);u=u+vec3(AA);return v(u);}void main(void){vec2 h=clamp(vTextureCoord,uTextureClamp.xy,uTextureClamp.zw);vec2 I=eDimensions/vec2(abs(uTextureClamp.z-uTextureClamp.x),abs(uTextureClamp.w-uTextureClamp.y));vec4 i=W(uSampler[0],h,I,gap,smoothingScaleFactor,dims,uColor,fillColor,intensity);vec4 AB=texture2D(uSampler[1],vMapCoord);if(i.a==0.){gl_FragColor=vec4(0,0,0,0);return;}if(AB.a==0.){gl_FragColor=i;return;}vec3 AC=k(i,0);vec3 AD=k(AB,1);vec3 AE=clamp(z(AC.xyz,t(AD.xyz)),0.,1.);vec4 s=n(AD,AE,i.a,AB.a);vec4 Q=vec4(s.xyz*s.a,s.a);Q=mix(i,Q,AB.a);gl_FragColor=isRotated==1.?A(Q,h,eDimensions,gap,gapFactor,isRotated,uTextureClamp):Q;}";var Ql="vec4 A(vec4 B,vec2 C,vec2 D,float E,vec4 F,float G,vec4 H){vec2 I=D/vec2(abs(H.z-H.x),abs(H.w-H.y));vec2 J=vec2(E/I);vec2 K=C-vec2(H.x,H.y);vec2 L;vec2 M;vec2 N;float O;vec2 P;if(G==0.){L=J;N=step(L,clamp(K,vec2(0.),vec2(1.)));O=N.x*N.y;P=step(L,clamp(1.-K,vec2(0.),vec2(1.)));O*=P.x*P.y;}else{L=J-vec2(1./I.x,1./I.y);M=J+J;N=smoothstep(L,M,K);N=max(N,(vec2(1.)-F.xz));O=N.x*N.y;P=smoothstep(L,M,vec2(H.z-H.x,H.w-H.y)-K);P=max(P,(vec2(1.)-F.yw));O*=P.x*P.y;}O=pow(O,1.5);vec4 Q=mix(vec4(0.),B,O);return Q;}const int R=2;const vec3 S=vec3(0.496,0.284,-0.032);vec4 T(vec4 U){return pow(U,vec4(1./2.2));}vec4 V(vec4 U){return pow(U,vec4(2.2));}vec4 W(sampler2D X,vec2 Y,vec2 Z,float a,vec2 b,vec2 c,vec4 d,vec4 e,float f){vec2 J=vec2(a/Z.x,a/Z.y);vec2 g=1.-J*2.;vec2 h=(Y-J)/g;vec4 i=vec4(0.);if(b.x<1.){vec2 j=1./c/b*0.25;i=V(texture2D(X,h))*0.20;i+=V(texture2D(X,h+vec2(-j.x,0.)))*0.20;i+=V(texture2D(X,h+vec2(j.x,0.)))*0.20;i+=V(texture2D(X,h+vec2(0.,j.y)))*0.20;i+=V(texture2D(X,h+vec2(0.,-j.y)))*0.20;i=T(i)*d;i=mix(i,e*i.a,f);}else{i=texture2D(X,h)*d;i=mix(i,e*i.a,f);}return i;}vec3 k(vec4 l,int m){if(m==1){return l.rgb/(l.a+0.000001);}else{return l.rgb/l.a;}}vec4 n(vec3 o,vec3 p,float q,float r){vec4 s;s.xyz=(1.-q)*o+q*p;s.a=q+r*(1.-q);return s;}varying vec2 vTextureCoord;varying vec2 vMapCoord;varying vec4 vColor;uniform sampler2D uSampler[2];uniform vec4 uColor;uniform vec4 fillColor;uniform float intensity;uniform vec4 uTextureClamp;uniform vec2 dims;uniform vec2 smoothingScaleFactor;uniform vec2 eDimensions;uniform float gap;uniform vec4 gapFactor;uniform float isRotated;float t(vec3 u){return dot(u,vec3(0.3,0.59,0.11));}vec3 v(vec3 u){float w=t(u);float x=min(min(u.r,u.g),u.b);float y=max(max(u.r,u.g),u.b);if(x<0.){u.r=w+((u.r-w)*w)/(w-x);u.g=w+((u.g-w)*w)/(w-x);u.b=w+((u.b-w)*w)/(w-x);}if(y>1.){u.r=w+((u.r-w)*(1.-w))/(y-w);u.g=w+((u.g-w)*(1.-w))/(y-w);u.b=w+((u.b-w)*(1.-w))/(y-w);}return u;}vec3 z(vec3 u,float w){float AA=w-t(u);u=u+vec3(AA);return v(u);}float AB(vec3 u){float x=min(min(u.r,u.g),u.b);float y=max(max(u.r,u.g),u.b);return y-x;}float AC(float AD,float AE,float AF,float AG){return((AE-AD)*AG)/(AF-AD);}vec3 AH(vec3 u,float AG){if(u.r>u.g){if(u.r>u.b){if(u.g>u.b){u.g=AC(u.b,u.g,u.r,AG);u.b=0.;}else{u.b=AC(u.g,u.b,u.r,AG);u.g=0.;}u.r=AG;}else{u.r=AC(u.g,u.r,u.b,AG);u.b=AG;u.r=0.;}}else if(u.r>u.b){u.r=AC(u.b,u.r,u.g,AG);u.g=AG;u.b=0.;}else if(u.g>u.b){u.b=AC(u.r,u.b,u.g,AG);u.g=AG;u.r=0.;}else if(u.b>u.g){u.g=AC(u.r,u.g,u.b,AG);u.b=AG;u.r=0.;}else{u=vec3(0.);}return u;}vec3 AI(vec3 AJ,vec3 AK){return z(AH(AJ.rgb,AB(AK.rgb)),t(AK.rgb));}void main(void){vec2 h=clamp(vTextureCoord,uTextureClamp.xy,uTextureClamp.zw);vec2 I=eDimensions/vec2(abs(uTextureClamp.z-uTextureClamp.x),abs(uTextureClamp.w-uTextureClamp.y));vec4 i=W(uSampler[0],h,I,gap,smoothingScaleFactor,dims,uColor,fillColor,intensity);vec4 AL=texture2D(uSampler[1],vMapCoord);if(i.a==0.){gl_FragColor=vec4(0,0,0,0);return;}if(AL.a==0.){gl_FragColor=i;return;}vec3 AM=k(i,0);vec3 AN=k(AL,1);vec3 AO=clamp(AI(AM.xyz,AN.xyz),0.,1.);vec4 s=n(AN,AO,i.a,AL.a);vec4 Q=vec4(s.xyz*s.a,s.a);Q=mix(i,Q,AL.a);gl_FragColor=isRotated==1.?A(Q,h,eDimensions,gap,gapFactor,isRotated,uTextureClamp):Q;}";var Zl="vec4 A(vec4 B,vec2 C,vec2 D,float E,vec4 F,float G,vec4 H){vec2 I=D/vec2(abs(H.z-H.x),abs(H.w-H.y));vec2 J=vec2(E/I);vec2 K=C-vec2(H.x,H.y);vec2 L;vec2 M;vec2 N;float O;vec2 P;if(G==0.){L=J;N=step(L,clamp(K,vec2(0.),vec2(1.)));O=N.x*N.y;P=step(L,clamp(1.-K,vec2(0.),vec2(1.)));O*=P.x*P.y;}else{L=J-vec2(1./I.x,1./I.y);M=J+J;N=smoothstep(L,M,K);N=max(N,(vec2(1.)-F.xz));O=N.x*N.y;P=smoothstep(L,M,vec2(H.z-H.x,H.w-H.y)-K);P=max(P,(vec2(1.)-F.yw));O*=P.x*P.y;}O=pow(O,1.5);vec4 Q=mix(vec4(0.),B,O);return Q;}const int R=2;const vec3 S=vec3(0.496,0.284,-0.032);vec4 T(vec4 U){return pow(U,vec4(1./2.2));}vec4 V(vec4 U){return pow(U,vec4(2.2));}vec4 W(sampler2D X,vec2 Y,vec2 Z,float a,vec2 b,vec2 c,vec4 d,vec4 e,float f){vec2 J=vec2(a/Z.x,a/Z.y);vec2 g=1.-J*2.;vec2 h=(Y-J)/g;vec4 i=vec4(0.);if(b.x<1.){vec2 j=1./c/b*0.25;i=V(texture2D(X,h))*0.20;i+=V(texture2D(X,h+vec2(-j.x,0.)))*0.20;i+=V(texture2D(X,h+vec2(j.x,0.)))*0.20;i+=V(texture2D(X,h+vec2(0.,j.y)))*0.20;i+=V(texture2D(X,h+vec2(0.,-j.y)))*0.20;i=T(i)*d;i=mix(i,e*i.a,f);}else{i=texture2D(X,h)*d;i=mix(i,e*i.a,f);}return i;}vec3 k(vec4 l,int m){if(m==1){return l.rgb/(l.a+0.000001);}else{return l.rgb/l.a;}}vec4 n(vec3 o,vec3 p,float q,float r){vec4 s;s.xyz=(1.-q)*o+q*p;s.a=q+r*(1.-q);return s;}varying vec2 vTextureCoord;varying vec2 vMapCoord;varying vec4 vColor;uniform sampler2D uSampler[2];uniform vec4 uColor;uniform vec4 fillColor;uniform float intensity;uniform vec4 uTextureClamp;uniform vec2 dims;uniform vec2 smoothingScaleFactor;uniform vec2 eDimensions;uniform float gap;uniform vec4 gapFactor;uniform float isRotated;float t(vec3 u){return dot(u,vec3(0.3,0.59,0.11));}vec3 v(vec3 u){float w=t(u);float x=min(min(u.r,u.g),u.b);float y=max(max(u.r,u.g),u.b);if(x<0.){u.r=w+((u.r-w)*w)/(w-x);u.g=w+((u.g-w)*w)/(w-x);u.b=w+((u.b-w)*w)/(w-x);}if(y>1.){u.r=w+((u.r-w)*(1.-w))/(y-w);u.g=w+((u.g-w)*(1.-w))/(y-w);u.b=w+((u.b-w)*(1.-w))/(y-w);}return u;}vec3 z(vec3 u,float w){float AA=w-t(u);u=u+vec3(AA);return v(u);}vec3 AB(vec3 AC,vec3 AD){return z(AD.rgb,t(AC.rgb));}void main(void){vec2 h=clamp(vTextureCoord,uTextureClamp.xy,uTextureClamp.zw);vec2 I=eDimensions/vec2(abs(uTextureClamp.z-uTextureClamp.x),abs(uTextureClamp.w-uTextureClamp.y));vec4 i=W(uSampler[0],h,I,gap,smoothingScaleFactor,dims,uColor,fillColor,intensity);vec4 AE=texture2D(uSampler[1],vMapCoord);if(i.a==0.){gl_FragColor=vec4(0,0,0,0);return;}if(AE.a==0.){gl_FragColor=i;return;}vec3 AF=k(i,0);vec3 AG=k(AE,1);vec3 AH=clamp(AB(AF.xyz,AG.xyz),0.,1.);vec4 s=n(AG,AH,i.a,AE.a);vec4 Q=vec4(s.xyz*s.a,s.a);Q=mix(i,Q,AE.a);gl_FragColor=isRotated==1.?A(Q,h,eDimensions,gap,gapFactor,isRotated,uTextureClamp):Q;}";var ec="attribute vec2 aVertexPosition;attribute vec2 aTextureCoord;attribute vec4 aColor;uniform mat3 projectionMatrix;uniform mat3 mapMatrix;varying vec2 vTextureCoord;varying vec2 vMapCoord;void main(void){gl_Position=vec4((projectionMatrix*vec3(aVertexPosition,1.)).xy,0.,1.);vTextureCoord=aTextureCoord;vMapCoord=(mapMatrix*vec3(aVertexPosition,1.)).xy;}";var tc=class extends ls{constructor(e,t,r){var a=wl;switch(r){case BFN.CONST.BLEND_MODES.SUBTRACT:a=kl;break;case BFN.CONST.BLEND_MODES.MULTIPLY:a=Al;break;case BFN.CONST.BLEND_MODES.DARKEN:a=Ol;break;case BFN.CONST.BLEND_MODES.COLOR_BURN:a=Rl;break;case BFN.CONST.BLEND_MODES.LINEAR_BURN:a=Ll;break;case BFN.CONST.BLEND_MODES.LIGHTEN:a=Vl;break;case BFN.CONST.BLEND_MODES.SCREEN:a=Ul;break;case BFN.CONST.BLEND_MODES.COLOR_DODGE:a=Gl;break;case BFN.CONST.BLEND_MODES.LINEAR_DODGE:a=Hl;break;case BFN.CONST.BLEND_MODES.OVERLAY:a=Xl;break;case BFN.CONST.BLEND_MODES.SOFT_LIGHT:a=zl;break;case BFN.CONST.BLEND_MODES.HARD_LIGHT:a=Wl;break;case BFN.CONST.BLEND_MODES.VIVID_LIGHT:a=$l;break;case BFN.CONST.BLEND_MODES.LINEAR_LIGHT:a=jl;break;case BFN.CONST.BLEND_MODES.PIN_LIGHT:a=Yl;break;case BFN.CONST.BLEND_MODES.DIFFERENCE:a=ql;break;case BFN.CONST.BLEND_MODES.EXCLUSION:a=Kl;break;case BFN.CONST.BLEND_MODES.COLOR:a=Jl;break;case BFN.CONST.BLEND_MODES.HUE:a=Ql;break;case BFN.CONST.BLEND_MODES.LUMINOSITY:a=Zl;break}super(e,ec,a,t);this.bind(),this.uniforms.uSampler=[0,1]}},ic=tc;function LS(i,e,t){e=e||[];var r=[BFN.CONST.BLEND_MODES.ADD,BFN.CONST.BLEND_MODES.SUBTRACT,BFN.CONST.BLEND_MODES.MULTIPLY,BFN.CONST.BLEND_MODES.DARKEN,BFN.CONST.BLEND_MODES.COLOR_BURN,BFN.CONST.BLEND_MODES.LINEAR_BURN,BFN.CONST.BLEND_MODES.LIGHTEN,BFN.CONST.BLEND_MODES.SCREEN,BFN.CONST.BLEND_MODES.COLOR_DODGE,BFN.CONST.BLEND_MODES.LINEAR_DODGE,BFN.CONST.BLEND_MODES.OVERLAY,BFN.CONST.BLEND_MODES.SOFT_LIGHT,BFN.CONST.BLEND_MODES.HARD_LIGHT,BFN.CONST.BLEND_MODES.VIVID_LIGHT,BFN.CONST.BLEND_MODES.LINEAR_LIGHT,BFN.CONST.BLEND_MODES.PIN_LIGHT,BFN.CONST.BLEND_MODES.DIFFERENCE,BFN.CONST.BLEND_MODES.EXCLUSION,BFN.CONST.BLEND_MODES.COLOR,BFN.CONST.BLEND_MODES.HUE,BFN.CONST.BLEND_MODES.LUMINOSITY];return t!=null&&r.includes(t)&&!e[t]&&(e[t]=[new ic(i,0,t)]),e}var rc=LS;var lo=PIXI.WRAP_MODES;function co(i){return i+=i===0,--i,i|=i>>>1,i|=i>>>2,i|=i>>>4,i|=i>>>8,i|=i>>>16,i+1}var ho=class extends PIXI.ObjectRenderer{constructor(e){super(e)}onContextChange(){this._tempClamp=new Float32Array(4),this._tempColor=new Float32Array(4),this._tempRect=new PIXI.Rectangle,this._tempRect2=new PIXI.Rectangle,this._tempRect3=new PIXI.Rectangle,this._tempMatrix=new PIXI.Matrix,this._tempMatrix2=new PIXI.Matrix,this._bigBuf=new Uint8Array(1<<20);var e=this.renderer.gl;this.drawModes=[],this.normalShader=[new Dl(e,0)],this._renderTexture=new PIXI.BaseRenderTexture(1024,1024)}start(){}flush(){}_getRenderTexture(e,t){return(this._renderTexture.width<e||this._renderTexture.height<t)&&(e=co(e),t=co(t),this._renderTexture.resize(e,t)),this._renderTexture}_getBuf(e){let t=this._bigBuf;return t.length<e&&(e=co(e),t=new Uint8Array(e),this._bigBuf=t),t}render(e){if(!e.texture.valid)return;let t=0;e.tileTransform&&(t=this._isSimpleSprite(e)?1:2);let r=null;if(e.blendMode){if(e.blendMode=parseInt(e.blendMode),this.drawModes.length<1||!this.drawModes[e.blendMode]){let a=this.renderer.gl;this.drawModes=rc(a,this.drawModes,e.blendMode)}this.drawModes[e.blendMode]&&(r=this.drawModes[e.blendMode])}r?this._renderBlend(e,r[t]):this._renderNormal(e,this.normalShader[t])}_renderNormal(e,t){let r=this.renderer;r.bindShader(t),r.state.setBlendMode(e.blendMode),this._renderInner(e,t)}_renderBlend(e,t){let r=this.renderer,a=e.getBounds();a.x-=1,a.y-=1,a.width+=2,a.height+=2;let s=r._activeRenderTarget,o=s.projectionMatrix,n=o.a<0,l=o.d<0,c=s.resolution,h=this._tempRect,u=s.sourceFrame||s.destinationFrame;h.x=0,h.y=0,h.width=u.width*c,h.height=u.height*c;let d=this._tempRect2,m=u.width*c,p=u.height*c;d.x=(a.x+o.tx/o.a)*c+m/2,d.y=(a.y+o.ty/o.d)*c+p/2,d.width=a.width*c,d.height=a.height*c,n&&(d.y=m-d.width-d.x),l&&(d.y=p-d.height-d.y);let g=this._tempRect3,f=Math.floor(Math.max(h.x,d.x)),v=Math.ceil(Math.min(h.x+h.width,d.x+d.width)),T=Math.floor(Math.max(h.y,d.y)),x=Math.ceil(Math.min(h.y+h.height,d.y+d.height)),B=v-f,y=x-T;if(B<=0||y<=0)return;let F=this._getRenderTexture(B,y);r.bindTexture(F,1,!0);let b=r.gl;if(r.renderingToScreen&&s.root){let S=this._getBuf(B*y*4);b.readPixels(f,T,B,y,b.RGBA,b.UNSIGNED_BYTE,this._bigBuf),b.texSubImage2D(b.TEXTURE_2D,0,0,0,B,y,b.RGBA,b.UNSIGNED_BYTE,this._bigBuf)}else b.copyTexSubImage2D(b.TEXTURE_2D,0,0,0,f,T,B,y);if(r.bindShader(t),r.state.setBlendMode(PIXI.BLEND_MODES.NORMAL),t.uniforms.mapMatrix){let S=this._tempMatrix;S.a=d.width/F.width/a.width,n?(S.a=-S.a,S.tx=(d.x-f)/F.width-(a.x+a.width)*S.a):S.tx=(d.x-f)/F.width-a.x*S.a,S.d=d.height/F.height/a.height,l?(S.d=-S.d,S.ty=(d.y-T)/F.height-(a.y+a.height)*S.d):S.ty=(d.y-T)/F.height-a.y*S.d,t.uniforms.mapMatrix=S.toArray(!0)}this._renderInner(e,t)}_renderInner(e,t){let r=this.renderer;t.tilingMode>0?this._renderWithShader(e,t.tilingMode===1,t):this._renderSprite(e,t)}_renderSprite(e,t){let r=this.renderer,a=t.tempQuad;r.bindVao(a.vao);let s=e.texture._uvs,o=a.vertices,n=e.vertexData;var l,c=Math.abs(e.transform.worldTransform.b),h,u,d;let m=e.hasOwnProperty("smoothEdges")?e.smoothEdges:!0,p=e.gapFactor||null;c>1e-5&&m?(l=1,h=BFN.Util.expandVertices(e.vertexData,l,p),u=BFN.Util.getDistance(h[0],h[1],h[2],h[3]),d=BFN.Util.getDistance(h[2],h[3],h[4],h[5]),t.uniforms.isRotated=1):(l=0,h=e.vertexData,u=e.texture.baseTexture.width,d=e.texture.baseTexture.height,t.uniforms.isRotated=0),a.vertices[0]=h[0],a.vertices[1]=h[1],a.vertices[2]=h[2],a.vertices[3]=h[3],a.vertices[4]=h[4],a.vertices[5]=h[5],a.vertices[6]=h[6],a.vertices[7]=h[7];let g=e.texture.frame,f=e.texture.baseTexture;if(t.uniforms.eDimensions=[u,d],t.uniforms.gap=l,t.uniforms.gapFactor=p||[1,1,1,1],a.uvs[0]=s.x0,a.uvs[1]=s.y0,a.uvs[2]=s.x1,a.uvs[3]=s.y1,a.uvs[4]=s.x2,a.uvs[5]=s.y2,a.uvs[6]=s.x3,a.uvs[7]=s.y3,a.upload(),!g||!f)return;let v=this._tempClamp,T=0/f.resolution;v[0]=(g.x-T)/f.width,v[1]=(g.y-T)/f.height,v[2]=(g.x+g.width+T)/f.width,v[3]=(g.y+g.height+T)/f.height,t.uniforms.uTextureClamp=v;let x=this._tempColor;PIXI.utils.hex2rgb(e.tint,x);let B=e.worldAlpha;x[0]*=B,x[1]*=B,x[2]*=B,x[3]=B,t.uniforms.uColor=x;let y=e.hasOwnProperty("fillColor")?PIXI.utils.hex2rgb(e.fillColor):new Float32Array([0,0,0,1]);y[0]*=B,y[1]*=B,y[2]*=B,y[3]=B;let F=e.hasOwnProperty("intensity")?e.intensity:0;t.uniforms.fillColor=y,t.uniforms.intensity=F,t.uniforms.dims=[f.width,f.height];let b=BFN.smoothPictureDisabled?1:e.hasOwnProperty("currentScale")?e.currentScale:1,S=BFN.smoothPictureDisabled?1:e.hasOwnProperty("currentScaleY")?e.currentScaleY:b;t.uniforms.smoothingScaleFactor=[b*window.bfn_resolution,S*window.bfn_resolution],r.bindTexture(f,0,!0),a.vao.draw(this.renderer.gl.TRIANGLES,6,0)}_isSimpleSprite(e){let t=this.renderer,r=e._texture,a=r.baseTexture,s=a.isPowerOfTwo&&r.frame.width===a.width&&r.frame.height===a.height;return s&&(a._glTextures[t.CONTEXT_UID]?s=a.wrapMode!==lo.CLAMP:a.wrapMode===lo.CLAMP&&(a.wrapMode=lo.REPEAT)),s}_renderWithShader(e,t,r){let a=r.tempQuad,s=this.renderer;s.bindVao(a.vao);let o=a.vertices,n=e._width,l=e._height,c=e._anchor._x,h=e._anchor._y,u=n*(1-c),d=n*-c,m=l*(1-h),p=l*-h,g=e.transform.worldTransform,f=g.a,v=g.b,T=g.c,x=g.d,B=g.tx,y=g.ty;o[0]=f*d+T*p+B,o[1]=x*p+v*d+y,o[2]=f*u+T*p+B,o[3]=x*p+v*u+y,o[4]=f*u+T*m+B,o[5]=x*m+v*u+y,o[6]=f*d+T*m+B,o[7]=x*m+v*d+y,o=a.uvs,o[0]=o[6]=-e.anchor.x,o[1]=o[3]=-e.anchor.y,o[2]=o[4]=1-e.anchor.x,o[5]=o[7]=1-e.anchor.y,a.upload();let F=e._texture,b=e.tileTransform.localTransform,S=e.uvTransform,I=S.mapCoord,_=S.uClampFrame,E=S.uClampOffset,D=F.width,w=F.height,N=n,M=l,z=this._tempMatrix2;z.set(b.a*D/N,b.b*D/M,b.c*w/N,b.d*w/M,b.tx/N,b.ty/M),z.invert(),t?z.append(I):(r.uniforms.uMapCoord=I.toArray(!0),r.uniforms.uClampFrame=_,r.uniforms.uClampOffset=E),r.uniforms.uTransform=z.toArray(!0);let W=this._tempColor,j=e.worldAlpha;PIXI.utils.hex2rgb(e.tint,W),W[0]*=j,W[1]*=j,W[2]*=j,W[3]=j,r.uniforms.uColor=W;let J=e.hasOwnProperty("fillColor")?PIXI.utils.hex2rgb(e.fillColor):new Float32Array([0,0,0,1]);J[0]*=j,J[1]*=j,J[2]*=j,J[3]=j;let ie=e.hasOwnProperty("intensity")?e.intensity:0;r.uniforms.fillColor=J,r.uniforms.intensity=ie,s.bindTexture(F,0,!0),a.vao.draw(this.renderer.gl.TRIANGLES,6,0)}};PIXI.WebGLRenderer.registerPlugin("blend_picture",ho);var ac=ho;var VS={PictureSprite:Il,PictureTilingSprite:Cl,PictureRenderer:ac};Object.assign(PIXI.extras,VS);var sc="attribute vec2 aVertexPosition;attribute vec2 aTextureCoord;attribute vec4 aColor;uniform vec2 kernelDim;uniform vec2 gapRatio;uniform vec2 scaleRatio;uniform mat3 projectionMatrix;varying vec2 vSmoothTexCoordsLeft;varying vec2 vSmoothTexCoordsRight;varying vec2 vSmoothTexCoordsTop;varying vec2 vSmoothTexCoordsBottom;varying vec2 gapTextureCoord;varying vec2 vTextureCoord;void main(void){gl_Position=vec4((projectionMatrix*vec3(aVertexPosition,1.)).xy,0.,1.);gapTextureCoord=(aTextureCoord-gapRatio)/scaleRatio;vSmoothTexCoordsLeft=gapTextureCoord+vec2(-kernelDim.x,0.);vSmoothTexCoordsRight=gapTextureCoord+vec2(kernelDim.x,0.);vSmoothTexCoordsTop=gapTextureCoord+vec2(0.,kernelDim.y);vSmoothTexCoordsBottom=gapTextureCoord+vec2(0.,-kernelDim.y);vTextureCoord=aTextureCoord;}";var oc="varying vec2 vTextureCoord;varying vec4 vColor;varying vec2 vSmoothTexCoordsLeft;varying vec2 vSmoothTexCoordsRight;varying vec2 vSmoothTexCoordsTop;varying vec2 vSmoothTexCoordsBottom;varying vec2 gapTextureCoord;uniform sampler2D uSampler;uniform vec4 uColor;uniform vec2 eDimensions;uniform float gap;uniform float isRotated;const vec3 A=vec3(0.496,0.284,-0.032);const int B=1;vec4 C(vec4 D){vec4 E;if(gap==0.){E=D;}else{vec2 F=vec2(gap/eDimensions.x,gap/eDimensions.y);vec2 G=vTextureCoord;vec2 H;vec2 I;vec2 J;float K;vec2 L;if(isRotated==0.){H=F;J=step(H,clamp(G,vec2(0.),vec2(1.)));K=J.x*J.y;L=step(H,clamp(1.-G,vec2(0.),vec2(1.)));K*=L.x*L.y;}else{H=max(F-vec2(1./eDimensions.x,1./eDimensions.y),vec2(0.,0.));I=F+F/gap;J=smoothstep(H,I,G);K=J.x*J.y;L=smoothstep(H,I,1.-G);K*=L.x*L.y;}K=pow(K,1.5);E=mix(vec4(0.),D,K);}return E;}void main(void){vec4 M=vec4(0.);M=texture2D(uSampler,gapTextureCoord)*0.20;M+=texture2D(uSampler,vSmoothTexCoordsLeft)*0.20;M+=texture2D(uSampler,vSmoothTexCoordsRight)*0.20;M+=texture2D(uSampler,vSmoothTexCoordsTop)*0.20;M+=texture2D(uSampler,vSmoothTexCoordsBottom)*0.20;gl_FragColor=isRotated==1.?C(M*uColor):M*uColor;}";var nc=class extends PIXI.Shader{constructor(e){super(e,sc,oc);this.bind(),this.uniforms.uColor=new Float32Array(1,1,1,1)}},lc=nc;var cc="attribute vec2 aVertexPosition;attribute vec2 aTextureCoord;attribute vec4 aColor;uniform mat3 projectionMatrix;uniform vec2 kernelDim;varying vec2 vSmoothTexCoordsLeft;varying vec2 vSmoothTexCoordsRight;varying vec2 vSmoothTexCoordsTop;varying vec2 vSmoothTexCoordsBottom;varying vec2 vTextureCoord;void main(void){gl_Position=vec4((projectionMatrix*vec3(aVertexPosition,1.)).xy,0.,1.);vSmoothTexCoordsLeft=aTextureCoord+vec2(-kernelDim.x,0.);vSmoothTexCoordsRight=aTextureCoord+vec2(kernelDim.x,0.);vSmoothTexCoordsTop=aTextureCoord+vec2(0.,kernelDim.y);vSmoothTexCoordsBottom=aTextureCoord+vec2(0.,-kernelDim.y);vTextureCoord=aTextureCoord;}";var hc="varying vec2 vTextureCoord;varying vec4 vColor;varying vec2 vSmoothTexCoordsLeft;varying vec2 vSmoothTexCoordsRight;varying vec2 vSmoothTexCoordsTop;varying vec2 vSmoothTexCoordsBottom;uniform sampler2D uSampler;uniform vec4 uColor;vec4 A(vec4 B){return pow(B,vec4(1./2.2));}vec4 C(vec4 B){return pow(B,vec4(2.2));}void main(void){vec4 B=vec4(0.);B=C(texture2D(uSampler,vTextureCoord))*0.20;B+=C(texture2D(uSampler,vSmoothTexCoordsLeft))*0.20;B+=C(texture2D(uSampler,vSmoothTexCoordsRight))*0.20;B+=C(texture2D(uSampler,vSmoothTexCoordsTop))*0.20;B+=C(texture2D(uSampler,vSmoothTexCoordsBottom))*0.20;gl_FragColor=A(B)*uColor;}";var uc=class extends PIXI.Shader{constructor(e){super(e,cc,hc);this.bind(),this.uniforms.uColor=new Float32Array(1,1,1,1)}},dc=uc;var mc="attribute vec2 aVertexPosition;attribute vec2 aTextureCoord;attribute vec4 aColor;uniform mat3 projectionMatrix;uniform vec2 kernelDim;varying vec2 vSmoothTexCoordsLeft;varying vec2 vSmoothTexCoordsRight;varying vec2 vSmoothTexCoordsTop;varying vec2 vSmoothTexCoordsBottom;varying vec2 vSmoothTexCoordsTopLeft;varying vec2 vSmoothTexCoordsTopRight;varying vec2 vSmoothTexCoordsBottomLeft;varying vec2 vSmoothTexCoordsBottomRight;varying vec2 vTextureCoord;void main(void){gl_Position=vec4((projectionMatrix*vec3(aVertexPosition,1.)).xy,0.,1.);vSmoothTexCoordsLeft=aTextureCoord+vec2(-kernelDim.x,0.);vSmoothTexCoordsRight=aTextureCoord+vec2(kernelDim.x,0.);vSmoothTexCoordsTop=aTextureCoord+vec2(0.,kernelDim.y);vSmoothTexCoordsBottom=aTextureCoord+vec2(0.,-kernelDim.y);vSmoothTexCoordsTopLeft=aTextureCoord+vec2(-kernelDim.x,-kernelDim.y);vSmoothTexCoordsTopRight=aTextureCoord+vec2(kernelDim.x,-kernelDim.y);vSmoothTexCoordsBottomLeft=aTextureCoord+vec2(-kernelDim.x,kernelDim.y);vSmoothTexCoordsBottomRight=aTextureCoord+vec2(kernelDim.x,kernelDim.y);vTextureCoord=aTextureCoord;}";var pc="varying vec2 vTextureCoord;varying vec4 vColor;varying vec2 vSmoothTexCoordsLeft;varying vec2 vSmoothTexCoordsRight;varying vec2 vSmoothTexCoordsTop;varying vec2 vSmoothTexCoordsBottom;varying vec2 vSmoothTexCoordsTopLeft;varying vec2 vSmoothTexCoordsTopRight;varying vec2 vSmoothTexCoordsBottomLeft;varying vec2 vSmoothTexCoordsBottomRight;uniform sampler2D uSampler;uniform vec4 uColor;vec4 A(vec4 B){return pow(B,vec4(1./2.2));}vec4 C(vec4 B){return pow(B,vec4(2.2));}void main(void){vec4 B=vec4(0.);B=C(texture2D(uSampler,vTextureCoord))*0.195346;B+=C(texture2D(uSampler,vSmoothTexCoordsLeft))*0.123317;B+=C(texture2D(uSampler,vSmoothTexCoordsRight))*0.123317;B+=C(texture2D(uSampler,vSmoothTexCoordsTop))*0.123317;B+=C(texture2D(uSampler,vSmoothTexCoordsBottom))*0.123317;B+=C(texture2D(uSampler,vSmoothTexCoordsTopLeft))*0.077847;B+=C(texture2D(uSampler,vSmoothTexCoordsTopRight))*0.077847;B+=C(texture2D(uSampler,vSmoothTexCoordsBottomLeft))*0.077847;B+=C(texture2D(uSampler,vSmoothTexCoordsBottomRight))*0.077847;gl_FragColor=A(B)*uColor;}";var fc=class extends PIXI.Shader{constructor(e){super(e,mc,pc);this.bind(),this.uniforms.uColor=new Float32Array(1,1,1,1)}},gc=fc;var vc="attribute vec2 aVertexPosition;attribute vec2 aTextureCoord;attribute vec4 aColor;uniform mat3 projectionMatrix;varying vec2 vTextureCoord;void main(void){gl_Position=vec4((projectionMatrix*vec3(aVertexPosition,1.)).xy,0.,1.);vTextureCoord=aTextureCoord;}";var yc="varying vec2 vTextureCoord;uniform sampler2D uSampler;uniform vec4 uColor;uniform vec2 eDimensions;uniform float gap;uniform float isRotated;vec4 A(vec4 B){vec4 C;if(gap==0.){C=B;}else{vec2 D=vec2(gap/eDimensions.x,gap/eDimensions.y);vec2 E=vTextureCoord;vec2 F;vec2 G;vec2 H;float I;vec2 J;if(isRotated==0.){F=D;H=step(F,clamp(E,vec2(0.),vec2(1.)));I=H.x*H.y;J=step(F,clamp(1.-E,vec2(0.),vec2(1.)));I*=J.x*J.y;}else{F=max(D-vec2(1./eDimensions.x,1./eDimensions.y),vec2(0.,0.));G=D+D/gap;H=smoothstep(F,G,E);I=H.x*H.y;J=smoothstep(F,G,1.-E);I*=J.x*J.y;}I=pow(I,1.5);C=mix(vec4(0.),B,I);}return C;}void main(void){vec2 D=vec2(gap/eDimensions.x,gap/eDimensions.y);vec2 K=1.-D*2.;vec2 L;if(gap==0.){L=vTextureCoord;}else{L=(vTextureCoord-D)/K;}vec4 B=texture2D(uSampler,L)*uColor;gl_FragColor=isRotated==1.?A(B):B;}";var xc=class extends PIXI.Shader{constructor(e){super(e,vc,yc);this.bind(),this.uniforms.uColor=new Float32Array(1,1,1,1)}},Tc=xc;var Fc="attribute vec2 aVertexPosition;attribute vec2 aTextureCoord;attribute vec4 aColor;uniform mat3 projectionMatrix;varying vec2 vTextureCoord;void main(void){gl_Position=vec4((projectionMatrix*vec3(aVertexPosition,1.)).xy,0.,1.);vTextureCoord=aTextureCoord;}";var bc="varying vec2 vTextureCoord;uniform sampler2D uSampler;uniform vec4 uColor;void main(void){vec4 A=texture2D(uSampler,vTextureCoord)*uColor;gl_FragColor=A;}";var Bc=class extends PIXI.Shader{constructor(e){super(e,Fc,bc);this.bind(),this.uniforms.uColor=new Float32Array(1,1,1,1)}},Sc=Bc;var LA=PIXI.glCore,uo=class extends PIXI.ObjectRenderer{constructor(e){super(e)}onContextChange(){let e=this,t=this.renderer.gl;this.quad=new PIXI.Quad(t),this.smoothRotationShader=new lc(t),this.smoothShader=new dc(t),this.smoothResizeShader=new gc(t),this.normalShader=new Sc(t),this.normalRotationShader=new Tc(t),this.quad.initVao(e.normalShader),this._tempColor=new Float32Array(4)}start(){}flush(){}render(e){if(!e.texture.valid)return;let t=e.hasOwnProperty("currentScale")?e.currentScale:1,r=e.hasOwnProperty("currentScaleY")?e.currentScaleY:t,a=Math.abs(e.transform.worldTransform.b),s=e.hasOwnProperty("smoothEdges")?e.smoothEdges:!0,o=e.hasOwnProperty("isResize")?e.isResize:!1;t<1&&!BFN.smoothPictureDisabled?a>1e-5&&s?this._renderSmoothRotation(e,this.smoothRotationShader,t,r,a,s):o?this._renderSmooth(e,this.smoothResizeShader,t,r):this._renderSmooth(e,this.smoothShader,t,r):a>1e-5&&s?this._renderNormalRotation(e,this.normalRotationShader,a,s):this._renderNormal(e,this.normalShader)}_renderNormal(e,t){let r=this.renderer;r.bindShader(t),r.state.setBlendMode(e.blendMode);let a=this.quad;r.bindVao(a.vao);let s=e.vertexData;for(let h=0;h<8;h++)a.vertices[h]=s[h];let o=e.texture._uvs;a.uvs[0]=o.x0,a.uvs[1]=o.y0,a.uvs[2]=o.x1,a.uvs[3]=o.y1,a.uvs[4]=o.x2,a.uvs[5]=o.y2,a.uvs[6]=o.x3,a.uvs[7]=o.y3,a.upload();let n=this._tempColor;PIXI.utils.hex2rgb(e.tint,n);let l=e.worldAlpha;n[0]*=l,n[1]*=l,n[2]*=l,n[3]=l,t.uniforms.uColor=n;let c=e.texture.baseTexture;r.bindTexture(c,0,!0),a.vao.draw(this.renderer.gl.TRIANGLES,6,0)}_renderNormalRotation(e,t,r,a){let s=this.renderer;s.bindShader(t),s.state.setBlendMode(e.blendMode);let o=this.quad;s.bindVao(o.vao);let n=e.texture._uvs;var l,c,h,u;r>1e-5&&a?(l=1,c=BFN.Util.expandVertices(e.vertexData,l),h=BFN.Util.getDistance(c[0],c[1],c[2],c[3]),u=BFN.Util.getDistance(c[2],c[3],c[4],c[5]),t.uniforms.isRotated=1):(l=0,c=e.vertexData,h=e.texture.baseTexture.width,u=e.texture.baseTexture.height,t.uniforms.isRotated=0),o.uvs[0]=n.x0,o.uvs[1]=n.y0,o.uvs[2]=n.x1,o.uvs[3]=n.y1,o.uvs[4]=n.x2,o.uvs[5]=n.y2,o.uvs[6]=n.x3,o.uvs[7]=n.y3,o.vertices[0]=c[0],o.vertices[1]=c[1],o.vertices[2]=c[2],o.vertices[3]=c[3],o.vertices[4]=c[4],o.vertices[5]=c[5],o.vertices[6]=c[6],o.vertices[7]=c[7],t.uniforms.eDimensions=[h,u],t.uniforms.gap=l,o.upload();let d=this._tempColor;PIXI.utils.hex2rgb(e.tint,d);let m=e.worldAlpha;d[0]*=m,d[1]*=m,d[2]*=m,d[3]=m,t.uniforms.uColor=d;let p=e.texture.baseTexture;s.bindTexture(p,0,!0),o.vao.draw(this.renderer.gl.TRIANGLES,6,0)}_renderSmooth(e,t,r,a){let s=this.renderer;s.bindShader(t),s.state.setBlendMode(e.blendMode);let o=this.quad;s.bindVao(o.vao);let n=e.vertexData;for(let d=0;d<8;d++)o.vertices[d]=n[d];let l=e.texture._uvs;o.uvs[0]=l.x0,o.uvs[1]=l.y0,o.uvs[2]=l.x1,o.uvs[3]=l.y1,o.uvs[4]=l.x2,o.uvs[5]=l.y2,o.uvs[6]=l.x3,o.uvs[7]=l.y3,o.upload();let c=e.texture.baseTexture;t.uniforms.kernelDim=[1/c.width/r/window.bfn_resolution*.25,1/c.height/a/window.bfn_resolution*.25];let h=this._tempColor;PIXI.utils.hex2rgb(e.tint,h);let u=e.worldAlpha;h[0]*=u,h[1]*=u,h[2]*=u,h[3]=u,t.uniforms.uColor=h,s.bindTexture(c,0,!0),o.vao.draw(this.renderer.gl.TRIANGLES,6,0)}_renderSmoothRotation(e,t,r,a,s,o){let n=this.renderer;n.bindShader(t),n.state.setBlendMode(e.blendMode);let l=this.quad;n.bindVao(l.vao);let c=e.texture._uvs;var h,u,d,m;s>1e-5&&o?(m=1,h=BFN.Util.expandVertices(e.vertexData,m),u=BFN.Util.getDistance(h[0],h[1],h[2],h[3]),d=BFN.Util.getDistance(h[2],h[3],h[4],h[5]),t.uniforms.isRotated=1):(m=0,h=e.vertexData,u=e.texture.baseTexture.width,d=e.texture.baseTexture.height,t.uniforms.isRotated=0),l.uvs[0]=c.x0,l.uvs[1]=c.y0,l.uvs[2]=c.x1,l.uvs[3]=c.y1,l.uvs[4]=c.x2,l.uvs[5]=c.y2,l.uvs[6]=c.x3,l.uvs[7]=c.y3,l.vertices[0]=h[0],l.vertices[1]=h[1],l.vertices[2]=h[2],l.vertices[3]=h[3],l.vertices[4]=h[4],l.vertices[5]=h[5],l.vertices[6]=h[6],l.vertices[7]=h[7],t.uniforms.gap=m,t.uniforms.eDimensions=[u,d],t.uniforms.gapRatio=[m/u,m/d],t.uniforms.scaleRatio=[1-t.uniforms.gapRatio[0]*2,1-t.uniforms.gapRatio[1]*2],l.upload();let p=e.texture.baseTexture;t.uniforms.kernelDim=[1/p.width/r*.25,1/p.height/a*.25];let g=this._tempColor;PIXI.utils.hex2rgb(e.tint,g);let f=e.worldAlpha;g[0]*=f,g[1]*=f,g[2]*=f,g[3]=f,t.uniforms.uColor=g,n.bindTexture(p,0,!0),l.vao.draw(this.renderer.gl.TRIANGLES,6,0)}};PIXI.WebGLRenderer.registerPlugin("smooth_picture",uo);PIXI.CanvasRenderer.registerPlugin("smooth_picture",PIXI.CanvasSpriteRenderer);var Ic=uo;var KS={SmoothPictureRenderer:Ic};Object.assign(PIXI.extras,KS);var mo=class extends PIXI.ObjectRenderer{constructor(e){super(e)}onContextChange(){BFN.ObjectRenderer=this.renderer}bindShaderParams(e){if(!e.tempQuad){if(e.tempQuad=new PIXI.Quad(this.renderer.gl),e.tempQuad.initVao(e),e.bind(),typeof e.channelTextures!="undefined"&&e.channelTextures!=null){let t=[];for(let r in e.channelTextures)t.push(parseInt(r));e.uniforms.uSampler=t}if(typeof e.initParams!="undefined")try{e.initParams()}catch(t){}}}render(e){let t=this.renderer,r=e.bfn_shaders[0];this.bindShaderParams(r),t.bindShader(r),t.state.setBlendMode(e.blendMode);let a=r.tempQuad;t.bindVao(a.vao);let s=e.vertexData;for(let l=0;l<8;l++)a.vertices[l]=s[l];let o=e.texture._uvs;a.uvs[0]=o.x0,a.uvs[1]=o.y0,a.uvs[2]=o.x1,a.uvs[3]=o.y1,a.uvs[4]=o.x2,a.uvs[5]=o.y2,a.uvs[6]=o.x3,a.uvs[7]=o.y3,a.upload();let n=e.texture.baseTexture;if(typeof r.applyParams!="undefined")try{r.applyParams(n)}catch(l){}if(t.bindTexture(n,0,!0),typeof r.channelTextures!="undefined"&&r.channelTextures!==null)for(let l in r.channelTextures)r.channelTextures[parseInt(l)]!="def"&&t.bindTexture(r[r.channelTextures[parseInt(l)]].baseTexture,parseInt(l),!0);a.vao.draw(this.renderer.gl.TRIANGLES,6,0)}};PIXI.WebGLRenderer.registerPlugin("filter_renderer",mo);var _c=mo;var JS={FilterRenderer:_c};Object.assign(PIXI.extras,JS);var Cc=class{constructor(){this.init()}init(){BeFunky.log("SingletonQueue Init"),this.queue=[]}add(e){this.queue.push(e)}process(){for(;this.queue.length;)this.queue.shift()()}};BFN.SingletonQueue=new Cc;function qe(i=0,e=0,t=0,r=0){this._x=i,this._y=e,this._width=t,this._height=r,this._left=i,this._top=e,this._right=i+t,this._bottom=e+r,this._minX=Math.min(this._left,this._right),this._minY=Math.min(this._top,this._bottom),this._maxX=Math.max(this._left,this._right),this._maxY=Math.max(this._top,this._bottom)}qe.prototype.contains=function(i,e){return i>=this.minX&&i<=this.maxX&&e>=this.minY&&e<=this.maxY};qe.prototype.containsRect=function(i=null){return i&&i.left>=this.left&&i.right<=this.right&&i.top>=this.top&&i.bottom<=this.bottom};qe.prototype.intersects=function(i=null,e=0,t=!1){if(i)try{if(t){if(this.minX>i.maxX+e||i.minX>this.maxX+e||this.minY>i.maxY+e||i.minY>this.maxY+e)return!1}else if(this.minX>=i.maxX+e||i.minX>=this.maxX+e||this.minY>=i.maxY+e||i.minY>=this.maxY+e)return!1;return!0}catch(r){}return!1};qe.prototype.overlaps=function(i=null){if(i)try{return!!(e(this.left,this.right,i.left)&&(e(this.top,this.bottom,i.top)||e(this.top,this.bottom,i.bottom))||e(this.top,this.bottom,i.top)&&(e(this.left,this.right,i.left)||e(this.left,this.right,i.right))||e(this.left,this.right,i.right)&&(e(this.top,this.bottom,i.top)||e(this.top,this.bottom,i.bottom))||e(this.top,this.bottom,i.bottom)&&(e(this.left,this.right,i.left)||e(this.left,this.right,i.right)))}catch(t){}function e(t,r,a){return a>t&&a<r}return!1};qe.prototype.intersectsH=function(i=null){return!(Math.floor(this.top)>Math.ceil(i.bottom)||Math.floor(i.top)>Math.ceil(this.bottom))};qe.prototype.intersectsV=function(i=null){return!(Math.floor(this.left)>Math.ceil(i.right)||Math.floor(i.left)>Math.ceil(this.right))};qe.prototype.neighbors=function(i=null,e=!0){if(i)try{let t=new BFN.Rectangle;if(this.intersectsH(i)){if(i.right<this.left){if(!e)return"left";t.x=i.right,t.y=Math.min(this.top,i.top),t.width=this.left-i.right,t.height=Math.max(this.bottom,i.bottom)-Math.min(this.top,i.top);let s=t.clone();return s.y=Math.max(this.top,i.top),s.height=Math.min(this.bottom,i.bottom)-Math.max(this.top,i.top),{side:"left",direction:"horizontal",distance:t.width,rect:i,gapRect:t,intersectRect:s}}if(i.left>this.right){if(!e)return"right";t.x=this.right,t.y=Math.min(this.top,i.top),t.width=i.left-this.right,t.height=Math.max(this.bottom,i.bottom)-Math.min(this.top,i.top);let s=t.clone();return s.y=Math.max(this.top,i.top),s.height=Math.min(this.bottom,i.bottom)-Math.max(this.top,i.top),{side:"right",direction:"horizontal",distance:t.width,rect:i,gapRect:t,intersectRect:s}}}if(this.intersectsV(i)){if(i.bottom<this.top){if(!e)return"top";t.x=Math.min(this.left,i.left),t.y=i.bottom,t.width=Math.max(this.right,i.right)-Math.min(this.left,i.left),t.height=this.top-i.bottom;let s=t.clone();return s.x=Math.max(this.left,i.left),s.width=Math.min(this.right,i.right)-Math.max(this.left,i.left),{side:"top",direction:"vertical",distance:t.height,rect:i,gapRect:t,intersectRect:s}}if(i.top>this.bottom){if(!e)return"bottom";t.x=Math.min(this.left,i.left),t.y=this.bottom,t.width=Math.max(this.right,i.right)-Math.min(this.left,i.left),t.height=i.top-this.bottom;let s=t.clone();return s.x=Math.max(this.left,i.left),s.width=Math.min(this.right,i.right)-Math.max(this.left,i.left),{side:"bottom",direction:"vertical",distance:t.height,rect:i,gapRect:t,intersectRect:s}}}}catch(t){}return null};qe.prototype.intersectsLine=function(i,e){let t=(c,h,u)=>h.x<=Math.max(c.x,u.x)&&h.x>=Math.min(c.x,u.x)&&h.y<=Math.max(c.y,u.y)&&h.y>=Math.min(c.y,u.y),r=(c,h,u)=>{let d=parseInt((h.y-c.y)*(u.x-h.x)-(h.x-c.x)*(u.y-h.y));return d==0?0:d>0?1:2},a=(c,h,u,d)=>{let m=r(c,h,u),p=r(c,h,d),g=r(u,d,c),f=r(u,d,h);return!!(m!==p&&g!==f||m===0&&t(c,u,h)||p===0&&t(c,d,h)||g===0&&t(u,c,d)||f===0&&t(u,h,d))},s={a:i,b:e},o={tl:new PIXI.Point(this._left,this._top),tr:new PIXI.Point(this._right,this.top),bl:new PIXI.Point(this._left,this._bottom),br:new PIXI.Point(this._right,this._bottom)},n={tltr:{a:o.tl,b:o.tr},trbr:{a:o.tr,b:o.br},brbl:{a:o.br,b:o.bl},bltl:{a:o.bl,b:o.tl}},l=0;for(let c in n){let h=n[c];a(s.a,s.b,h.a,h.b)&&l++}return l};qe.prototype.clone=function(){return new BFN.Rectangle(this._x,this._y,this._width,this._height)};qe.prototype.updateAttributes=function(i=null){switch(i){case"x":this._left=this._x,this._right=this._left+this._width;break;case"y":this._top=this._y,this._bottom=this._top+this._height;break;case"width":this._right=this._left+this._width;break;case"height":this._bottom=this._top+this._height;break;case"left":this._x=this._left,this._width=this._right-this._left;break;case"right":this._width=this._right-this._left;break;case"top":this._y=this._top,this._height=this._bottom-this._top;break;case"bottom":this._height=this._bottom-this._top;break}this._minX=Math.min(this._left,this._right),this._minY=Math.min(this._top,this._bottom),this._maxX=Math.max(this._left,this._right),this._maxY=Math.max(this._top,this._bottom)};Object.defineProperty(qe.prototype,"x",{set:function(i){this._x=i,this.updateAttributes("x")},get:function(){return this._x}});Object.defineProperty(qe.prototype,"y",{set:function(i){this._y=i,this.updateAttributes("y")},get:function(){return this._y}});Object.defineProperty(qe.prototype,"width",{set:function(i){this._width=i,this.updateAttributes("width")},get:function(){return this._width}});Object.defineProperty(qe.prototype,"height",{set:function(i){this._height=i,this.updateAttributes("height")},get:function(){return this._height}});Object.defineProperty(qe.prototype,"left",{set:function(i){this._left=i,this.updateAttributes("left")},get:function(){return this._left}});Object.defineProperty(qe.prototype,"right",{set:function(i){this._right=i,this.updateAttributes("right")},get:function(){return this._right}});Object.defineProperty(qe.prototype,"center",{get:function(){return this.centerX}});Object.defineProperty(qe.prototype,"top",{set:function(i){this._top=i,this.updateAttributes("top")},get:function(){return this._top}});Object.defineProperty(qe.prototype,"bottom",{set:function(i){this._bottom=i,this.updateAttributes("bottom")},get:function(){return this._bottom}});Object.defineProperty(qe.prototype,"middle",{get:function(){return this.centerY}});Object.defineProperty(qe.prototype,"centerX",{get:function(){return this._x+this._width/2}});Object.defineProperty(qe.prototype,"centerY",{get:function(){return this._y+this._height/2}});Object.defineProperty(qe.prototype,"minX",{get:function(){return this._minX}});Object.defineProperty(qe.prototype,"maxX",{get:function(){return this._maxX}});Object.defineProperty(qe.prototype,"minY",{get:function(){return this._minY}});Object.defineProperty(qe.prototype,"maxY",{get:function(){return this._maxY}});Object.defineProperty(qe.prototype,"rectangleObject",{get:function(){return{x:this._x,y:this._y,width:this._width,height:this._height}}});Object.defineProperty(qe.prototype,"rectanglePolygon",{get:function(){return[new PIXI.Point(this._minX,this._minY),new PIXI.Point(this._maxX,this._minY),new PIXI.Point(this._maxX,this._maxY),new PIXI.Point(this._minX,this._maxY)]}});BFN.Rectangle=qe;function ti(i=0,e=0,t=0,r=0,a=0,s=0){this.x1=i,this.y1=e,this.x2=t,this.y2=r,this.x3=a,this.y3=s}ti.prototype.contains=function(i,e){let t=(e-this.y1)*(this.x2-this.x1)-(i-this.x1)*(this.y2-this.y1),r=(e-this.y3)*(this.x1-this.x3)-(i-this.x3)*(this.y1-this.y3),a=(e-this.y2)*(this.x3-this.x2)-(i-this.x2)*(this.y3-this.y2);return t*a>0&&r*a>0};ti.prototype.clone=function(){return new BFN.Triangle(this.x1,this.y1,this.x2,this.y2,this.x3,this.y3)};Object.defineProperty(ti.prototype,"width",{get:function(){return Math.max(this.x1,this.x2,this.x3)-Math.min(this.x1,this.x2,this.x3)}});Object.defineProperty(ti.prototype,"height",{get:function(){return Math.max(this.y1,this.y2,this.y3)-Math.min(this.y1,this.y2,this.y3)}});Object.defineProperty(ti.prototype,"left",{get:function(){return Math.min(this.x1,this.x2,this.x3)}});Object.defineProperty(ti.prototype,"right",{get:function(){Math.max(this.x1,this.x2,this.x3)}});Object.defineProperty(ti.prototype,"top",{get:function(){return Math.min(this.y1,this.y2,this.y3)}});Object.defineProperty(ti.prototype,"bottom",{get:function(){Math.max(this.y1,this.y2,this.y3)}});Object.defineProperty(ti.prototype,"centerX",{get:function(){return this.left+this.width/2}});Object.defineProperty(ti.prototype,"centerY",{get:function(){return this.top+this.height/2}});Object.defineProperty(ti.prototype,"minX",{get:function(){return this.left}});Object.defineProperty(ti.prototype,"maxX",{get:function(){return this.right}});Object.defineProperty(ti.prototype,"minY",{get:function(){return this.top}});Object.defineProperty(ti.prototype,"maxY",{get:function(){return this.bottom}});Object.defineProperty(ti.prototype,"triangleObject",{get:function(){return{x1:this.x1,y1:this.y1,x2:this.x2,y2:this.y2,x3:this.x3,y3:this.y3}}});BFN.Triangle=ti;BFN.FrameDisplayEvents={FRAME_LOADED:new Event("FRAME_LOADED"),FRAME_UPDATED:new Event("FRAME_UPDATED")};function Ze(){PIXI.Sprite.call(this),BFN.EventDispatcher.call(this),this.init()}Ze.prototype=window.azrc.extend(Object.create(PIXI.Sprite.prototype),Object.create(BFN.EventDispatcher.prototype));Ze.prototype.init=function(){BeFunky.log("FrameDisplay Init"),this.initDefaultValues(),this.initGraphicLoader(),this.initDisplay(),this.initWindow(),this.initFrame()};Ze.prototype.initDefaultValues=function(){this._scale=1,this._itemWidth=0,this._itemHeight=0,this.minW=this.minH=10,this.maxW=this.maxH=BFN.maxImageSize,this.isThumb=!1,this.scaleOffsetFactor=1,this.smoothPadding=20,this.frameTexturesDestroyed=!0,this.windowTexture=null,this.frameTexture=null,this.frameTextureData=null,this.frameW=0,this.frameH=0,this.windowX=0,this.windowY=0,this.windowW=0,this.windowH=0,this.frameScale=1,this.windowScale=1,this.frameAngle=0,this.renderPending=!1,this.colorOverlayFilter=new BFN.filters.ColorOverlayFilter,this.handleGraphicCompleteBind=this.handleGraphicComplete.bind(this),this.handleMainUIPreRenderBind=this.handleMainUIPreRender.bind(this)};Ze.prototype.initGraphicLoader=function(){this.graphicLoader=new BFN.GraphicLoader};Ze.prototype.initDisplay=function(){this.displayContainer=new PIXI.Container,this.addChild(this.displayContainer)};Ze.prototype.initWindow=function(){this.windowContainer=new PIXI.Container,this.displayContainer.addChild(this.windowContainer),this.windowSprite=new PIXI.Sprite,this.windowSprite.pluginName="blend_picture",this.windowSprite.currentScale=1,this.windowSprite.anchor.x=this.windowSprite.anchor.y=.5,this.windowContainer.addChild(this.windowSprite),this.windowMask=new PIXI.Sprite(PIXI.RenderTexture.create(32,32)),this.windowMask.pluginName="blend_picture",this.windowMask.currentScale=1,this.windowContainer.addChild(this.windowMask),this.windowSprite.mask=this.windowMask};Ze.prototype.initFrame=function(){this.frameTextureSprite=new PIXI.Sprite,this.frameSprite=new PIXI.Sprite,this.frameSprite.pluginName="blend_picture",this.frameSprite.currentScale=1,this.frameSprite.blendMode=BFN.CONST.BLEND_MODES.NORMAL,this.displayContainer.addChild(this.frameSprite)};Ze.prototype.setupFrame=function(i,e,t,r,a,s,o,n,l){if(this.windowTexture=i,this.frameTextureData=t,this.minW=r,this.minH=a,this.maxW=s,this.maxH=o,this.isThumb=n,this.scaleOffsetFactor=1,n&&t.hasOwnProperty("frameW")&&(this.scaleOffsetFactor=t.frameW/l),this.updateFrame(),this.destroyFrameTextures(),e.includes("smart:")){let c=e.split(":");if(c.length!==5){BeFunky.throwError('Incorect Smart Frame URL Syntax, should be "smart:category:name:scale:padding"',e),this.dispatchEvent(BFN.FrameDisplayEvents.FRAME_LOADED);return}let h=this.windowTexture.width*(this.isThumb?2:1),u=this.windowTexture.height*(this.isThumb?2:1);BFN.SmartFrameManager.getFrameTexture(Object.assign({category:c[1],name:c[2],dstW:h,dstH:u,dstScale:parseFloat(c[3]),dstPadding:parseFloat(c[4]),updating:n},t),d=>{if(this.isThumb){let m=BFN.Util.resizeTexture(d,this.windowTexture.width,this.windowTexture.height,!1,!0);d.destroyGC(!0),d=m}this.frameTextureSprite.texture=d,this.frameSprite.texture=d.renderClone(),this.frameSprite.anchor.x=0,this.frameSprite.anchor.y=0,this.frameTexturesDestroyed=!1,this.dispatchEvent(BFN.FrameDisplayEvents.FRAME_LOADED),BFN.MainUI.requestRender()})}else this.graphicLoader.reset(),this.graphicLoader.graphicsData[e]=e,this.graphicLoader.addEventListener(BFN.GraphicLoaderEvents.GRAPHIC_COMPLETE.type,this.handleGraphicCompleteBind),this.graphicLoader.loadGraphics()};Ze.prototype.destroyFrameTextures=function(){if(!this.frameTexturesDestroyed){this.frameTextureSprite.texture.srcTexture&&(this.frameTextureSprite.texture.srcTexture.destroyGC(!0),delete this.frameTextureSprite.texture.srcTexture);try{this.frameTextureSprite.texture.destroyGC(!0)}catch(i){}this.frameTextureSprite.texture=PIXI.Texture.EMPTY;try{this.frameSprite.texture.destroyGC(!0)}catch(i){}this.frameSprite.texture=PIXI.Texture.EMPTY,this.frameTexturesDestroyed=!0}};Ze.prototype.updateFrame=function(){if(this.frameW=this.frameTextureData.hasOwnProperty("frameW")?this.frameTextureData.frameW:this.windowTexture.width,this.frameH=this.frameTextureData.hasOwnProperty("frameH")?this.frameTextureData.frameH:this.windowTexture.height,this.windowX=this.frameTextureData.hasOwnProperty("windowX")?this.frameTextureData.windowX:0,this.windowY=this.frameTextureData.hasOwnProperty("windowY")?this.frameTextureData.windowY:0,this.windowW=this.frameTextureData.hasOwnProperty("windowW")?this.frameTextureData.windowW:this.frameW,this.windowH=this.frameTextureData.hasOwnProperty("windowH")?this.frameTextureData.windowH:this.frameH,this.frameAngle>0){let r;switch(this.frameAngle){case 90:r=this.windowX,this.windowX=this.frameH-this.windowH-this.windowY,this.windowY=r;break;case 180:this.windowX=this.frameW-this.windowW-this.windowX,this.windowY=this.frameH-this.windowH-this.windowY;break;case 270:r=this.windowX,this.windowX=this.windowY,this.windowY=this.frameW-this.windowW-r;break}this.frameAngle%180&&(r=this.frameW,this.frameW=this.frameH,this.frameH=r,r=this.windowW,this.windowW=this.windowH,this.windowH=r)}this.frameAngle%180?(this.frameTextureSprite.scale.y<0&&(this.windowX=this.frameW-(this.windowX+this.windowW)),this.frameTextureSprite.scale.x<0&&(this.windowY=this.frameH-(this.windowY+this.windowH))):(this.frameTextureSprite.scale.x<0&&(this.windowX=this.frameW-(this.windowX+this.windowW)),this.frameTextureSprite.scale.y<0&&(this.windowY=this.frameH-(this.windowY+this.windowH)));let i=Math.min(this.maxW/this.frameW,this.maxH/this.frameH),e=Math.max(this.minW/this.frameW,this.minH/this.frameH),t=Math.min(this.windowTexture.width/this.windowW,this.windowTexture.height/this.windowH);this.frameScale=Math.min(i,Math.max(e,t)),this.frameW=Math.round(this.frameW*this.frameScale),this.frameH=Math.round(this.frameH*this.frameScale),this.windowX=Math.round(this.windowX*this.frameScale),this.windowY=Math.round(this.windowY*this.frameScale),this.windowW=Math.round(this.windowW*this.frameScale),this.windowH=Math.round(this.windowH*this.frameScale),this.windowScale=Math.max(this.windowW/this.windowTexture.width,this.windowH/this.windowTexture.height),this.frameSprite.scale.x=this.frameSprite.scale.y=this.frameScale*this.scaleOffsetFactor,this.windowSprite.texture=this.windowTexture,this.windowSprite.scale.x=this.windowSprite.scale.y=this.windowScale,this.windowSprite.x=this.windowX+this.windowW/2,this.windowSprite.y=this.windowY+this.windowH/2,this.windowMask.texture.resize(this.windowW+this.smoothPadding*2,this.windowH+this.smoothPadding*2),this.windowMask.x=this.windowX-this.smoothPadding,this.windowMask.y=this.windowY-this.smoothPadding,BFN.graphics.drawShape("roundedRect",this.windowMask.texture,{fillColor:4294967295,edgePadding:0,paddingX:this.smoothPadding,paddingY:this.smoothPadding}),this.updateSmoothing(),this._itemWidth=this.frameW,this._itemHeight=this.frameH,this.dispatchEvent(BFN.FrameDisplayEvents.FRAME_UPDATED),BFN.MainUI.requestRender()};Ze.prototype.updateSmoothing=function(){this.frameSprite.currentScale=this.frameScale*this.scaleOffsetFactor*this._scale,this.windowSprite.currentScale=this.windowScale*this._scale,this.windowMask.currentScale=this.windowScale*this._scale,BFN.MainUI.requestRender()};Ze.prototype.resetFrame=function(){this.setColor(-1),this.setOpacity(1),this.setBlendMode(BFN.CONST.BLEND_MODES.NORMAL),this.setPosition(0),this.frameAngle=0,this.frameTextureSprite.x=this.frameTextureSprite.y=0,this.frameTextureSprite.scale.x=this.frameTextureSprite.scale.y=1,this.updateFrame(),this.updateFrameOrientation(),this.updateFrameTexture()};Ze.prototype.setColor=function(i,e){e=e!=null&&e>=0?e:1,i>=0?(this.colorOverlayFilter.color=i,this.colorOverlayFilter.intensity=e,this.frameTextureSprite.filters=[this.colorOverlayFilter]):this.frameTextureSprite.filters=[],this.updateFrameTexture()};Ze.prototype.setOpacity=function(i){this.frameSprite.alpha=i,BFN.MainUI.requestRender()};Ze.prototype.setBlendMode=function(i){this.frameSprite.blendMode=i,BFN.MainUI.requestRender()};Ze.prototype.setPosition=function(i){let e=(this.windowSprite.texture.width*this.windowSprite.scale.x-this.windowW)/2/this.windowSprite.texture.width,t=(this.windowSprite.texture.height*this.windowSprite.scale.y-this.windowH)/2/this.windowSprite.texture.height;this.windowSprite.anchor.x=.5-e*i,this.windowSprite.anchor.y=.5-t*i,BFN.MainUI.requestRender()};Ze.prototype.rotateCounterClockwise=function(){this.frameAngle=(this.frameAngle-90+360)%360,this.updateFrame(),this.updateFrameOrientation()};Ze.prototype.rotateClockwise=function(){this.frameAngle=(this.frameAngle+90)%360,this.updateFrame(),this.updateFrameOrientation()};Ze.prototype.flipHorizontal=function(){this.frameAngle%180?(this.frameTextureSprite.scale.y*=-1,this.frameTextureSprite.y=this.frameTextureSprite.scale.y>0?0:this.frameTextureSprite.texture.height):(this.frameTextureSprite.scale.x*=-1,this.frameTextureSprite.x=this.frameTextureSprite.scale.x>0?0:this.frameTextureSprite.texture.width),this.updateFrame(),this.updateFrameTexture()};Ze.prototype.flipVertical=function(){this.frameAngle%180?(this.frameTextureSprite.scale.x*=-1,this.frameTextureSprite.x=this.frameTextureSprite.scale.x>0?0:this.frameTextureSprite.texture.width):(this.frameTextureSprite.scale.y*=-1,this.frameTextureSprite.y=this.frameTextureSprite.scale.y>0?0:this.frameTextureSprite.texture.height),this.updateFrame(),this.updateFrameTexture()};Ze.prototype.updateFrameTexture=function(){try{BFN.Stage.render(this.frameTextureSprite,this.frameSprite.texture),BFN.MainUI.requestRender()}catch(i){}};Ze.prototype.updateFrameOrientation=function(){switch(this.frameAngle){case 0:this.frameSprite.x=0,this.frameSprite.y=0;break;case 90:this.frameSprite.x=this.itemWidth,this.frameSprite.y=0;break;case 180:this.frameSprite.x=this.itemWidth,this.frameSprite.y=this.itemHeight;break;case 270:this.frameSprite.x=0,this.frameSprite.y=this.itemHeight;break}this.frameSprite.rotation=this.frameAngle*(Math.PI/180),BFN.MainUI.requestRender()};Ze.prototype.handleGraphicComplete=function(i){if(this.graphicLoader.removeEventListener(BFN.GraphicLoaderEvents.GRAPHIC_COMPLETE.type,this.handleGraphicCompleteBind),this.isThumb)this.frameTextureSprite.texture=i.data.graphic.renderClone();else{let e=PIXI.RenderTexture.create(i.data.graphic.width+this.smoothPadding*2,i.data.graphic.height+this.smoothPadding*2);e.copyPixels(i.data.graphic,new PIXI.Point(this.smoothPadding,this.smoothPadding),!1),this.frameTextureSprite.texture=e}this.frameSprite.texture=this.frameTextureSprite.texture.renderClone(),this.frameSprite.anchor.x=this.isThumb?0:this.smoothPadding/this.frameSprite.texture.width,this.frameSprite.anchor.y=this.isThumb?0:this.smoothPadding/this.frameSprite.texture.height,this.graphicLoader.reset(),this.frameTexturesDestroyed=!1,this.dispatchEvent(BFN.FrameDisplayEvents.FRAME_LOADED),BFN.MainUI.requestRender()};Ze.prototype.handleMainUIPreRender=function(i){this.renderPending&&(this.renderPending=!1,BFN.Stage.render(this.displayContainer,this.displayTexture))};Object.defineProperty(Ze.prototype,"canvasScale",{set(i){this._scale=i,this.updateSmoothing()},get(){return this._scale}});Object.defineProperty(Ze.prototype,"itemWidth",{get(){return this._itemWidth}});Object.defineProperty(Ze.prototype,"itemHeight",{get(){return this._itemHeight}});BFN.FrameDisplay=Ze;function QS(){this.originPoint=new PIXI.Point,this.undoRegionTexture=null,this.redoRegionTexture=null,this.totalPixels=0}BFN.ImagePainterRegionVO=QS;function ZS(){this.timestamp=0,this.historyTag=null,this.historyTranslation=null,this.thumbImage=null,this.previewImage=null,this.isText=!1,this.isGroup=!1,this.useTextIcon=!1,this.useGroupIcon=!1}BFN.GlobalHistoryVO=ZS;function eI(){this.id=-1,this.name=null,this.translation=null,this.historyAction=null,this.timestamp=Date.now(),this.imageTexture=null,this.imageW=0,this.imageH=0,this.thumbTexture=null,this.thumbImage=null,this.thumbW=0,this.thumbH=0,this.previewTexture=null,this.previewImage=null,this.previewW=0,this.previewH=0}BFN.HistoryVO=eI;function tI(){this.id=BeFunky.randomString(10),this.parent=null,this.zIndex=null,this.locked=!1,this.hidden=!1,this.creationTime=performance.now(),this.x=0,this.y=0,this.scaleX=1,this.scaleY=1,this.rotation=0,this.accurateBounds=null,this.basicShapeValues=null,this.borderEnabled=!1,this.borderValues=null,this.dropShadowValues=null,this.shapeColorMap=null,this.refreshDropShadow=!1,this.opacity=1,this.blendMode=BFN.CONST.BLEND_MODES.NORMAL,this.tintEnabled=!1,this.tint=-1,this.overlayColorEnabled=!1,this.overlayColor=-1,this.overlayColorIntensity=0,this.flippedHorizontal=!1,this.flippedVertical=!1,this.text=null,this.textStyle=null,this.textWidth=0,this.textScale=1,this.textItemScale=1,this.textBackgroundEnabled=!1,this.textBackgroundColor=-1,this.textBackgroundIntensity=1,this.textBackgroundPadding=0,this.textOutlineEnabled=!1,this.textHighlightEnabled=!1,this.textCurveEnabled=!1,this.textCurveAmount=null,this.imageID=null,this.imageTexture=null,this.maskImageFrameWidth=0,this.maskImageFrameHeight=0,this.maskImageOffsetFactorX=.5,this.maskImageOffsetFactorY=.5,this.maskImageTextureScale={x:1,y:1},this.collageSettings={},this.designerSettings={}}BFN.TransformItemStateVO=tI;function iI(){this.id=null,this.translation=null,this.batchID=null,this.batchIDPlaceholder=null,this.timestamp=Date.now(),this.transformItem=null,this.startState=new BFN.TransformItemStateVO,this.endState=new BFN.TransformItemStateVO,this.isCreateTransition=!1,this.isGroupTransition=!1,this.isSettingsTransition=!1,this.useGroupIcon=!1,this.useTextIcon=!1,this.alternateHistoryAction=null,this.previewTexture=null,this.previewImage=null,this.thumbTexture=null,this.thumbImage=null}BFN.TransformItemTransitionVO=iI;function rI(){this.id=null,this.name=null,this.itemIDs=[]}BFN.TransformItemGroupVO=rI;function aI(){this.url=null,this.width=0,this.height=0,this.size=0,this.resizedUrl=null,this.resizedWidth=0,this.resizedHeight=0,this.resizedSize=0}BFN.UploadVO=aI;function sI(){this.categoryID=null,this.assetID=null,this.static=!1,this.imageURL=null,this.thumbURL=null,this.imageTexture=null,this.thumbTexture=null}BFN.LensFlareAssetVO=sI;function oI(){this.presetID=null,this.presetName=null,this.isPlus=!1,this.elementVOs=[]}BFN.LensFlarePresetVO=oI;BFN.LensFlareElementVOConstants={propertyOrder:["assetID","active","color","colorGlobal","colorGlobalGroup","blendMode","intensityFactor","intensityFactorGlobal","sizeFactor","sizeFactorGlobal","rotationOffset","rotationLock","stretchXFactor","stretchYFactor","sourceDistanceFactor","centerDistanceFactor"],defaultProperties:{assetID:null,active:!0,color:-1,colorGlobal:-1,colorGlobalGroup:0,blendMode:"screen",intensityFactor:1,intensityFactorGlobal:0,sizeFactor:1,sizeFactorGlobal:0,rotationOffset:0,rotationLock:!1,stretchXFactor:1,stretchYFactor:1,sourceDistanceFactor:0,centerDistanceFactor:0}};BFN.LensFlareElementVOEvents={ASSET_UPDATED:new Event("ASSET_UPDATED"),PROPERTY_UPDATED:new Event("PROPERTY_UPDATED"),POSITION_UPDATED:new Event("POSITION_UPDATED")};function Vr(){BFN.EventDispatcher.call(this),this.init()}Vr.prototype=Object.create(BFN.EventDispatcher.prototype);Vr.prototype.init=function(){this.initDefaultValues()};Vr.prototype.initDefaultValues=function(){this.properties={};for(let i in BFN.LensFlareElementVOConstants.defaultProperties)this.properties[i]=BFN.LensFlareElementVOConstants.defaultProperties[i]};Vr.prototype.setProperty=function(i,e){this.properties.hasOwnProperty(i)&&(this.properties[i]=e,i=="assetID"||i=="color"||i=="colorGlobal"?this.dispatchEvent(BFN.LensFlareElementVOEvents.ASSET_UPDATED):i=="sourceDistanceFactor"||i=="centerDistanceFactor"?this.dispatchEvent(BFN.LensFlareElementVOEvents.POSITION_UPDATED):this.dispatchEvent(BFN.LensFlareElementVOEvents.PROPERTY_UPDATED))};Vr.prototype.getProperty=function(i){return this.properties.hasOwnProperty(i)?this.properties[i]:null};Vr.prototype.clone=function(){let i=new BFN.LensFlareElementVO;for(let e in this.properties)i.properties[e]=this.properties[e];return i};BFN.LensFlareElementVO=Vr;var Ec=class{constructor(){this.name=null,this.extension=null,this.id=null,this.indexedDBKey=null,this.imageURL=null,this.imageTexture=null,this.imageWidth=null,this.imageHeight=null,this.thumbURL=null,this.thumbTexture=null,this.thumbWidth=null,this.thumbHeight=null,this.isRemovable=!0,this.isSaved=!1,this.isTransparent=!1,this.isSVG=!1,this.date=null,this.isPattern=!1,this.author=null,this.authorURL=null}createId(e,t=BeFunky.randomString(10)){if(!BFN.imageTypes.includes(e))throw new Error(`Invalid MenuImageVO type: ${BeFunky.stringValue(e)}`);return this.id=`${e}_${t}`,this.id}hasUsableTexture(){return this.imageTexture&&this.imageTexture.valid&&this.imageTexture.baseTexture&&!this.imageTexture.baseTexture._destroyed}getObject(){return Object.assign({},this,{imageTexture:null})}setObject(e){let t=Object.keys(this);t.push("isPlus","trackingID"),t.forEach(r=>{e.hasOwnProperty(r)&&(this[r]=e[r])})}};BFN.MenuImageVO=Ec;function nI(){this.name=null,this.categoryID=null,this.isPlus=null,this.preset=null,this.spritePosition=null}BFN.TemplateVO=nI;function lI(){this.id=null,this.name=null,this.graphic=null,this.templateVOs=[]}BFN.TemplateCategoryVO=lI;function cI(){this.rect=new BFN.Rectangle,this.texture=null,this.offsetFactorX=.5,this.offsetFactorY=.5,this.rotate=0,this.textureScale=1,this.menuImageVO=null}BFN.PhotoGridSnapshotChildVO=cI;function hI(){this.historyAction=null,this.snapshotWidth=0,this.snapshotHeight=0,this.gridWidth=0,this.gridHeight=0,this.rounding=0,this.gap=0,this.backgroundColor="FFFFFF",this.backgroundPatternBaseTexture=null,this.timestamp=Date.now(),this.thumbTexture=null,this.thumbImage=null,this.previewTexture=null,this.previewImage=null,this.snapshotChildren=[]}BFN.PhotoGridSnapshotVO=hI;function uI(){this.filename=null,this.time=Date.now(),this.sourceTemplateID=null,this.version=null,this.section=null,this.thumbBase64=null,this.projectWidth=0,this.projectHeight=0,this.isPlusTemplate=!1,this.printDPI=null,this.editorImageBase64=null,this.collageFreeform=!1,this.collageBackgroundColor=-1,this.collageBackgroundPatternBase64=null,this.collageGridWidth=0,this.collageGridHeight=0,this.collageRounding=0,this.collageGap=0,this.collageGridChildren=[],this.designerBackgroundColor=-1,this.transformGraphics=[],this.transformImages=[],this.transformMaskImages=[],this.transformLabels=[],this.transformGroups=[],this.transformGuides=[],this.transformGuidesLocked=!1,this.imageDataKeys=[],this.imageData={},this.svgDataKeys=[],this.svgData={}}BFN.ProjectVO=uI;function po(){this.itemID=null,this.type=null,this.layerName=null,this.layerNum=-1,this.basicShapeValues=null,this.borderEnabled=!1,this.borderValues=null,this.dropShadowValues=null,this.graphicID=null,this.graphicStyle=null,this.shapeColorMap=null,this.imageID=null,this.isGoodie=!1,this.maskImageID=null,this.maskImageMaskID=null,this.maskImageMaskFlippedHorizontal=!1,this.maskImageMaskFlippedVertical=!1,this.maskImageFrameWidth=0,this.maskImageFrameHeight=0,this.maskImageOffsetFactorX=.5,this.maskImageOffsetFactorY=.5,this.maskImageTextureScale=1,this.labelText="",this.labelTextStyles={},this.labelWidth=0,this.labelTextScale=1,this.labelTextItemScale=1,this.labelTextBackgroundEnabled=!1,this.labelTextBackgroundColor=-1,this.labelTextBackgroundIntensity=1,this.labelTextBackgroundPadding=0,this.labelTextOutlineEnabled=!1,this.labelTextHighlightEnabled=!1,this.labelTextCurveEnabled=!1,this.labelTextCurveAmount=null,this.labelWordBreaksEnabled=!1,this.gridCellImageID=null,this.gridCellRect=null,this.gridCellTextureOffsetFactorX=.5,this.gridCellTextureOffsetFactorY=.5,this.gridCellTextureRotate=0,this.gridCellTextureScale=1,this.gridCellTextureTint=-1,this.transformZIndex=0,this.transformLocked=!1,this.transformHidden=!1,this.transformX=0,this.transformY=0,this.transformRotation=0,this.transformScaleX=1,this.transformScaleY=1,this.transformWidth=0,this.transformHeight=0,this.transformFlippedHorizontal=!1,this.transformFlippedVertical=!1,this.transformOpacity=100,this.transformBlendMode=0,this.transformOverlayColorEnabled=!1,this.transformOverlayColor=-1,this.transformOverlayColorIntensity=0,this.transformTintColorEnabled=!1,this.transformTintColor=-1}po.prototype.clone=function(){let i=Object.assign(new po,this);return i.labelTextStyles instanceof Object&&(i.labelTextStyles=JSON.parse(JSON.stringify(i.labelTextStyles))),i};BFN.ProjectItemVO=po;function cs(i=null){this.timestamp=i,this.baseTextures=[]}cs.prototype.addUsedTexture=function(i,e){i&&i.baseTexture&&!this.baseTextures.includes(i.baseTexture)&&this.baseTextures.push(i.baseTexture)};cs.prototype.addUsedBaseTexture=function(i,e){i&&!this.baseTextures.includes(i)&&this.baseTextures.push(i)};cs.prototype.clear=function(){this.baseTextures.splice(0)};BFN.TextureHistoryVO=cs;function Pc(){this.originalName=null,this.originalTransparent=!1,this.name=null,this.extension=null,this.imageBlob=null,this.imageW=0,this.imageH=0,this.thumbSRC=null,this.thumbTexture=null,this.thumbW=0,this.thumbH=0,this.backgroundColor=-1,this.imageType="jpg",this.resizeData={},this.cropData={},this.actions=null}Pc.prototype.addAction=function(i){i&&typeof i=="string"&&(this.actions||(this.actions=[]),this.actions.includes(i)||this.actions.push(i))};BFN.BatchImageVO=Pc;function hs(){this.active=!0,this.eventID=null,this.eventObject=null,this.superObject=null,this.peopleObject=null,this.actionSection=null,this.actionTimestamp=null,this.transformItem=null,this.transformItems=null}hs.prototype.register=function(){this.isValid&&BFN.UserActionManager.registerUserAction(this)};hs.prototype.track=function(){this.isValid&&window.bfn_mp&&BFN.UserActionManager.isTrackable&&(window.bfn_mp.track(this.eventID,this.eventObject,this.superObject,this.peopleObject),console.log(`Mixpanel tracked: ${this.eventID}`,this.eventObject))};Object.defineProperty(hs.prototype,"isValid",{get(){return!!(this.eventID&&window.bfn_mp&&window.bfn_mp.property_map.hasOwnProperty(this.eventID))}});BFN.UserActionVO=hs;function Qi(i=null,e={}){this.type=BFN.BasicShapeManager.validShapeTypes.includes(i)?i:"ellipse",this.fill="FFFFFF",this.fillAlpha=1,this.stroke=-1,this.strokeAlpha=1,this.strokeWidth=10,this.fillBak=-1,this.strokeBak=-1,this.shape=new PIXI.Graphics,this.shapeW=64,this.shapeH=64,this.attributes={},this.maxShapeSize=BFN.maxImageSize,this.fitScale=1,this.hitAreaPolygonPoints=null,i==="line"&&(this.shapeH=Math.max(20,e.hasOwnProperty("strokeWidth")?e.strokeWidth:this.strokeWidth)),i==="arrow"&&(this.shapeH/=2),this.setValues(e)}Qi.prototype.setValues=function(i={}){let e=i.hasOwnProperty("fill")?i.fill:this.fill;i.hasOwnProperty("fill")&&i.fill!==-1&&i.useFillBak&&this.fillBak!==-1&&(e=this.fillBak);let t=i.hasOwnProperty("stroke")?i.stroke:this.stroke;i.hasOwnProperty("stroke")&&i.stroke!==-1&&i.useStrokeBak&&this.strokeBak!==-1&&(t=this.strokeBak),this.type=i.hasOwnProperty("type")&&BFN.BasicShapeManager.validShapeTypes.includes(i.type)?i.type:this.type,this.fill=e,this.fillColor=this.fill!==-1?parseInt("0x"+this.fill):null,this.fillAlpha=i.hasOwnProperty("fillAlpha")?i.fillAlpha:this.fillAlpha,this.stroke=t,this.strokeColor=this.stroke!==-1?parseInt("0x"+this.stroke):null,this.strokeAlpha=i.hasOwnProperty("strokeAlpha")?i.strokeAlpha:this.strokeAlpha,this.strokeWidth=i.hasOwnProperty("strokeWidth")?i.strokeWidth:this.strokeWidth,this.fillBak=i.hasOwnProperty("fillBak")?i.fillBak:this.fill!==-1?this.fill:this.fillBak,this.strokeBak=i.hasOwnProperty("strokeBak")?i.strokeBak:this.stroke!==-1?this.stroke:this.strokeBak;let r=(a,s)=>{this.attributes[a]=i.hasOwnProperty(a)?i[a]:this.attributes.hasOwnProperty(a)?this.attributes[a]:s};switch(this.type){case"line":r("lineStyle","solid"),r("lineSegmentWidth",3),r("lineGapSize",.5);break;case"rectangle":r("rectangleCornerRounding",0);break;case"polygon":r("polygonSides",6),r("polygonShiftOrientation",!1);break;case"star":r("starPoints",5),r("starInsetWeight",.5),r("starShiftOrientation",!1);break;case"arrow":r("arrowStyle","thick"),r("arrowWeight",.25),r("arrowDoubleSided",!1);break}this.drawShape()};Qi.prototype.getValues=function(){let i={type:this.type,fill:this.fill,fillAlpha:this.fillAlpha,stroke:this.stroke,strokeAlpha:this.strokeAlpha,strokeWidth:this.strokeWidth,fillBak:this.fillBak,strokeBak:this.strokeBak};return Object.assign(i,this.attributes),i};Qi.prototype.resize=function(i,e,t=!0){if(!i||!e){this.shape.clear();return}i=Math.abs(i),e=Math.abs(e),this.fitScale=Math.min(1,this.maxShapeSize/Math.max(i,e)),this.shapeW=Math.round(this.fitScale*i),this.shapeH=Math.round(this.fitScale*e),t&&this.drawShape()};Qi.prototype.drawShape=function(){this.type!=="group"&&BFN.BasicShapeManager.drawShape(this)};Qi.prototype.updateTexture=function(i,e=0,t=0,r=!1){if(!(!i||!e||!t))if(e=Math.abs(e),t=Math.abs(t),(this.shapeW!=e||this.shapeH!=t)&&this.resize(e,t,!1),(i.width!=this.shapeW||i.height!=this.shapeH)&&i.resize(this.shapeW,this.shapeH),this.drawShape(),r){let a=this.getCanvasTexture(),s={x:(i.width-a.width)/2,y:(i.height-a.height)/2};i.copyPixels(a,s),a.destroyGC(!0)}else BFN.Stage.render(this.shape,i)};Qi.prototype.convertToMaskValues=function(){if(this.fill===-1)this.stroke===-1?this.setValues({fill:"FFFFFF",fillAlpha:1}):this.setValues({stroke:"FFFFFF"});else{let i={fill:"FFFFFF"};this.stroke!==-1&&this.strokeAlpha===this.fillAlpha?(i.stroke=-1,i.strokeAlpha=1,i.strokeWidth=10):this.stroke!==-1&&(i.stroke="FFFFFF"),this.setValues(i)}};Qi.prototype.getCanvasTexture=function(){return BFN.BasicShapeManager.dummyTexture||(BFN.BasicShapeManager.dummyTexture=PIXI.RenderTexture.create(16,16)),BFN.Stage.render(this.shape,BFN.BasicShapeManager.dummyTexture),this.shape.generateCanvasTexture()};Qi.prototype.clone=function(i={}){return new BFN.BasicShapeVO(this.type,Object.assign(this.getValues(),i))};Object.defineProperty(Qi.prototype,"isSolidRectangle",{get(){let i=!0;return i=i&&this.type==="rectangle",i=i&&this.attributes.rectangleCornerRounding===0,i&&(this.stroke===-1?this.fill!==-1&&this.fillAlpha!==1&&this.fillAlpha!==0&&(i=!1):(this.fill===-1||this.fill!==-1&&this.fillAlpha!==1||this.strokeAlpha!==1)&&(i=!1)),i}});BFN.BasicShapeVO=Qi;function fo(i={}){this.enabled=!1,this.color=-1,this.blend_mode=0,this.distance=25,this.angle=-45,this.size=10,this.density=0,this.opacity=75,this.scale=100,this.setValues(i)}fo.prototype.setValues=function(i={}){!i||typeof i!="object"||(this.enabled=i.hasOwnProperty("enabled")?i.enabled:this.enabled,this.color=i.hasOwnProperty("color")?i.color:this.color,this.blend_mode=i.hasOwnProperty("blend_mode")?i.blend_mode:this.blend_mode,this.distance=i.hasOwnProperty("distance")?i.distance:this.distance,this.angle=i.hasOwnProperty("angle")?i.angle:this.angle,this.size=i.hasOwnProperty("size")?i.size:this.size,this.density=i.hasOwnProperty("density")?i.density:this.density,this.opacity=i.hasOwnProperty("opacity")?i.opacity:this.opacity,this.scale=i.hasOwnProperty("scale")?i.scale:this.scale)};fo.prototype.getValues=function(){return{enabled:this.enabled,color:this.color,blend_mode:this.blend_mode,distance:this.distance,angle:this.angle,size:this.size,density:this.density,opacity:this.opacity,scale:this.scale}};BFN.DropShadowVO=fo;function dI(){this.id="patch_"+BeFunky.randomString(10),this.name="BeFunkyPatch",this.version="1.0",this.thumbBase64=null,this.loaded=!1,this.width=0,this.height=0,this.transformGraphics=[],this.transformImages=[],this.transformMaskImages=[],this.transformLabels=[],this.imageData={},this.svgData={}}BFN.PatchVO=dI;var Nc=BeFunky.loggingFlags.includes("blob_perf"),go={},Mc=Nc?i=>{go[i]=Date.now()}:()=>{},us=Nc?i=>{BeFunky.logFeature("blob_perf",i,Date.now()-go[i]),delete go[i]}:()=>{};BFN.BlobUtils={blobToBase64:(i,e)=>BFN.BlobUtils.fileReader("readAsDataURL",i,e),blobToArrayBuffer:(i,e,t)=>{BFN.BlobUtils.fileReader("readAsArrayBuffer",i,t).then(r=>e({arrayBuffer:r}),r=>e({error:`Unable to read blob as array buffer: ${BeFunky.stringValue(r)}`}))},blobToText:(i,e,t)=>{BFN.BlobUtils.fileReader("readAsText",i,t).then(r=>e({text:r}),r=>e({error:`Unable to read blob as string: ${BeFunky.stringValue(r)}`}))},blobToBinaryString:(i,e,t)=>{BFN.BlobUtils.fileReader("readAsBinaryString",i,t).then(r=>e({binaryString:r}),r=>e({error:`Unable to read blob as binary string: ${BeFunky.stringValue(r)}`}))},async blobToImage(i,{cleanUpMemory:e=!0}={}){let t=i.type.startsWith("image/svg+xml");if(BeFunky.isImageBitmapSupported&&!t){let r=`Blob ${i.name?`${i.name} `:""}${BeFunky.formatBytes(i.size)} -> ImageBitmap`;Mc(r);try{let a=await createImageBitmap(i);return us(r),e&&setTimeout(()=>a.close()),{imageBitmap:a}}catch(a){us(r),BeFunky.logError("Unable to create ImageBitmap from blob:",a,`
Falling back to Image Element w/ object URL`)}}return BFN.BlobUtils.blobToImageElement(i,{cleanUpMemory:e}).then(r=>({imageElement:r}))},blobToImageElement(i,{cleanUpMemory:e=!0,isSvgSanitized:t=!1}={}){return new Promise((r,a)=>{let s=new Image,o=1,n=3,l="",c=`Blob ${i.name?`${i.name} `:""}${BeFunky.formatBytes(i.size)} -> ImageElement`;s.onerror=u=>{us(c),URL.revokeObjectURL(l),o<n?(BeFunky.logError(`Unable to load image from object URL on attempt #${o}. Trying again...`),o++,BFN.MainUI.addIdleRenderFunction(h)):(BeFunky.logError(`Unable to load image from object URL after ${n} attempts`,u),a(u))},s.onload=()=>{us(c),BeFunky.isFirefox&&!t&&!s.naturalWidth&&i.type.startsWith("image/svg+xml")?(URL.revokeObjectURL(l),BeFunky.logError("Re-attempting SVG -> Image conversion in Firefox b/c resulting image is missing dimensions"),BFN.BlobUtils.blobToText(i,({text:u,error:d})=>{if(d)return a(d);let m=BFN.SVGManager.sanitizeSVG(u);if(!m)return a("failed_to_parse_svg");let p=new Blob([m],{type:"image/svg+xml"});BFN.BlobUtils.blobToImageElement(p,{cleanUpMemory:e,isSvgSanitized:!0}).then(r,a)})):r(s),e&&URL.revokeObjectURL(l),s.onerror=void 0},h();function h(){try{l=URL.createObjectURL(i)}catch(u){return BeFunky.logError("Unable to create object URL from blob",u),a(u)}Mc(c),s.src=l}})},getOrientationAndEXIF:(i,e=!1)=>{let t={orientation:1,exif:void 0};return new Promise(a=>{if(i.type!=="image/jpeg")return a(t);BFN.ExifTool.load(i,({error:n,exif:l})=>{if(n)return BeFunky.logError("Unable to read EXIF data from Blob:",BeFunky.stringValue(n)),e?a(t):s(a);if(!l)return a(t);try{let c=r(BFN.ExifTool.getOrientation(l));return a({orientation:c,exif:l})}catch(c){return a(t)}});function s(n){let l=Date.now();o(c=>{let h=r(c);return BeFunky.logError(`Blob size = ${BeFunky.formatBytes(i.size)}. Detected orientation = ${c}. Time = ${Date.now()-l}ms`),h===c?BeFunky.logError("Orientation fallback was successful"):BeFunky.logError("Orientation fallback failed"),n({orientation:h,exif:void 0})})}function o(n){BFN.BlobUtils.blobToArrayBuffer(i,({error:l,arrayBuffer:c})=>{if(l)return n(-3);let h=new DataView(c);if(h.getUint16(0,!1)!==65496)return n(-2);let u=h.byteLength,d=2;for(;d<u;){if(h.getUint16(d+2,!1)<=8)return n(-1);let m=h.getUint16(d,!1);if(d+=2,m===65505){if(h.getUint32(d+=2,!1)!==1165519206)return n(-1);let p=h.getUint16(d+=6,!1)===18761;d+=h.getUint32(d+4,p);let g=h.getUint16(d,p);d+=2;for(let f=0;f<g;f++)if(h.getUint16(d+f*12,p)===274)return n(h.getUint16(d+f*12+8,p))}else{if((m&65280)!=65280)break;d+=h.getUint16(d,!1)}}return n(-1)},{timeoutMs:2e3,reportErrors:!1})}});function r(a){return!Number.isInteger(a)||a<1||a>8?1:a}},base64ToBlob:i=>{let e=i.split(","),t=e[0].includes("base64")?atob(e[1]):decodeURIComponent(e[1]),r=null;try{r=e[0].split(":")[1].split(";")[0]}catch(s){}let a=new Uint8Array(t.length);for(let s=0;s<t.length;s++)a[s]=t.charCodeAt(s);return r!=null?new Blob([a],{type:r}):new Blob([a])},fileReader:(i,e,{timeoutMs:t=15e3,reportErrors:r=!0}={})=>{let a=new FileReader;return new Promise((s,o)=>{if(!(e instanceof Blob))throw new Error(`${BeFunky.stringValue(e)} passed to FileReader`);let n;t>9e3&&(n=setTimeout(()=>{console.log(`Blob size: ${BeFunky.formatBytes(e.size)}  Blob type: ${e.type}`),console.log("FileReader readystate:",a.readyState);let u=`FileReader ${i} took over 9 seconds`;r?BeFunky.throwError(u):BeFunky.logError(u)},9e3));let l=!1,c=setTimeout(()=>{l=!0,console.log(`Blob size: ${BeFunky.formatBytes(e.size)}  Blob type: ${e.type}`),console.log("FileReader readystate:",a.readyState);let u=`FileReader ${i} timed out after ${t}ms`;r?BeFunky.reportWarning(u):BeFunky.logError(u),a.abort(),o(new Error(u))},t);a.onload=()=>h({result:a.result}),a.onerror=u=>h({error:u});try{a[i](e)}catch(u){h({error:u})}function h({result:u,error:d}){if(clearTimeout(n),clearTimeout(c),l){let p=`FileReader called ${u?"onload":"onerror"} after ${t}ms timeout rejected Promise. Consider increasing timeout period.`;r?BeFunky.throwError(p):BeFunky.logError(p);return}return u?s(u):o(d)}})},downsizeImageBlob(i,{maxSize:e=BFN.maxImageSizeLayer,quality:t=.95,skipSmallImages:r=!0}={}){let a=Date.now(),s=this.blobToImageElement(i),n=BeFunky.safariVersion>=13.1||BeFunky.chromiumVersion>=81||BeFunky.firefoxVersion>=77?Promise.resolve({orientation:1}):this.getOrientationAndEXIF(i,!0);return Promise.all([s,n]).then(([c,{orientation:h}])=>{let u=c.naturalWidth,d=c.naturalHeight,m=`${i.size/1e6}MB (${u} x ${d})`,p=Math.min(e/u,e/d);if(p>=1){if(r)throw console.log(`Blob "${i.name}" ${m} is already smaller than maxSize (${e}px). Skipping downsizing...`),"skipped_small_image";console.log(`Blob "${i.name}" ${m} is smaller than maxSize (${e}px), but will still be compressed to desired quality.`),p=1}let g=document.createElement("canvas"),f=g.getContext("2d"),v=Math.round(u*p),T=Math.round(d*p);return l(g,f,h,v,T),f.mozImageSmoothingEnabled=!0,f.imageSmoothingQuality="medium",f.webkitImageSmoothingEnabled=!0,f.msImageSmoothingEnabled=!0,f.imageSmoothingEnabled=!0,f.drawImage(c,0,0,v,T),this.canvasToBlob(g,i.type,t).then(x=>{let B=`${x.size/1e6}MB (${g.width} x ${g.height})`;return console.log(`Blob "${i.name}" resized ${m} -> ${B} in ${Date.now()-a}ms ${i.type==="image/jpeg"?`at ${t*100}% quality`:""}`),x})});function l(c,h,u,d,m){[5,6,7,8].includes(u)?(c.width=m,c.height=d):(c.width=d,c.height=m);let p={2:()=>h.transform(-1,0,0,1,d,0),3:()=>h.transform(-1,0,0,-1,d,m),4:()=>h.transform(1,0,0,-1,0,m),5:()=>h.transform(0,1,1,0,0,0),6:()=>h.transform(0,1,-1,0,m,0),7:()=>h.transform(0,-1,-1,0,m,d),8:()=>h.transform(0,-1,1,0,0,d)};p[u]&&p[u]()}},canvasToBlob(i,e,t){return new Promise((r,a)=>{i.toBlob(s=>{s instanceof Blob?r(s):a("canvas_to_blob_failed")},e,t)})},async pixelsToBlob({pixels:i,mimeType:e="image/jpeg",quality:t=1,width:r=1,height:a=1}){let s=document.createElement("canvas"),o=s.getContext("2d");s.width=r,s.height=a;let n=o.getImageData(0,0,r,a);n.data.set(i),o.putImageData(n,0,0);let l=BFN.BlobUtils.canvasToBlob(s,e,t);return s.width=1,s.height=1,o.setTransform(1,0,0,1,0,0),o.clearRect(0,0,s.width,s.height),s=null,o=null,n=null,l}};var Dc=class{constructor(){this.init()}init(){}getJSON(e,t){let a={fallbackURLs:[`${e}${e.includes("?")?"&":"?"}nocache=${Math.random().toString().split(".")[1]}`]};BeFunky.request(e,a,({error:s,response:o})=>s?(s!=="request_failed"&&BeFunky.throwError(`Unable to get valid JSON from server: ${s}`),t({error:s})):t({response:o}))}getBlob(e,t){return BeFunky.request(e,{responseType:"blob"},({response:r,error:a})=>{if(a)return t({error:a});if(!(r instanceof Blob))return BeFunky.logError("Blob requested but server returned a different type of response"),t({error:"invalid_response"});if(!r.size)return BeFunky.logError("Server responded with an empty Blob"),t({error:"invalid_response"});t({blob:r})})}getTexture(e,t,r){BFN.RequestUtils.getBlob(e,({error:a,blob:s})=>{if(a)return r({error:a});BFN.TextureUtils.blobOrBase64ToTexture(s,({texture:o,error:n})=>{if(n)return r({error:n});r({texture:o})},t)})}getImageBlobWithCorsFallback(e){return new Promise((t,r)=>{this.getBlob(e,({error:a,blob:s})=>{if(s)return t(s);if(e.startsWith(BeFunky.Params.globalImagesPath))return r(a);let o=`${BeFunky.Params.uplUri}/loadImage.php?c=${encodeURIComponent(e)}`;this.getBlob(o,({error:n,blob:l})=>{if(l)return t(l);r(n)})})})}getBase64(e,t){this.getBlob(e,({blob:r,error:a})=>{if(a)return t({error:a});BFN.BlobUtils.blobToBase64(r).then(s=>t({base64:s}),s=>t({error:s}))})}getBase64WithFallback(e,t,r){this.getBase64(e,({base64:a})=>{if(a){r({base64:a});return}this.getBase64(t,r)})}getText(e,t){BeFunky.request(e,{responseType:"blob"},({response:r,error:a})=>{if(a)return t({error:a});BFN.BlobUtils.blobToText(r,t)})}};BFN.SingletonQueue.add(()=>{BFN.RequestUtils=new Dc});var wc=BeFunky.loggingFlags.includes("texture_perf"),vo={},mI=wc?i=>{vo[i]=Date.now()}:()=>{},pI=wc?i=>{BeFunky.logFeature("texture_perf",i,Date.now()-vo[i]),delete vo[i]}:()=>{};BFN.TextureUtils={blobOrBase64ToTexture(i,e,{textureSize:t=BFN.maxImageSizeLayer,readEXIF:r=!0,reportImageSize:a=!1}={}){if(!i)return BeFunky.logError("No blob or base64 provided"),e({error:"No blob or base64 provided"});let s=i;if(typeof i=="string")try{s=BFN.BlobUtils.base64ToBlob(i)}catch(n){return e({error:`Unable to convert base64 to blob: ${n}`})}let o=r?BFN.BlobUtils.getOrientationAndEXIF(s):Promise.resolve({orientation:1,exif:void 0});BFN.BlobUtils.blobToImage(s).then(({imageBitmap:n,imageElement:l})=>{let c=n?n.width:l.naturalWidth,h=n?n.height:l.naturalHeight;a&&this.reportImageSize(c,h);let u=s.type.startsWith("image/svg+xml"),d=BFN.TextureUtils.imageToTexture(n||l,{textureSize:t,scaleUp:u,couldBeTransparent:s.type!=="image/jpeg"});Math.min(d.width,d.height)<BFN.minImageSize&&BeFunky.throwError("Texture is too small",`Dimensions = ${d.width} x ${d.height}. Blob type = ${s.type}`),o.then(({orientation:m,exif:p})=>{let g=l&&(BeFunky.safariVersion>=13.1||BeFunky.chromiumVersion>=81||BeFunky.firefoxVersion>=77)||n&&(BeFunky.chromiumVersion>=84||BeFunky.firefoxVersion>=77);if(m===1||g||BeFunky.isAppleAppStoreApp)return e({texture:d,exif:p,imageWidth:c,imageHeight:h});let f=d.width;if(BFN.Util.orientTexture(d,m),d.width!==f){let v=c;c=h,h=v}return e({texture:d,exif:p,imageWidth:c,imageHeight:h})})},n=>e({error:n}))},imageToTexture(i,{textureSize:e=BFN.maxImageSizeLayer,scaleUp:t=!1,couldBeTransparent:r=!0}={}){let a=BFN.Stage.gl.getParameter(BFN.Stage.gl.MAX_TEXTURE_SIZE)||BFN.maxImageSize,s=i instanceof HTMLImageElement?i.naturalWidth:i.width,o=i instanceof HTMLImageElement?i.naturalHeight:i.height,n=Math.max(s,o),l=`${i instanceof HTMLImageElement?"ImageElement":"ImageBitmap"} ${s} x ${o} -> Texture`;mI(l),e=Math.min(e,a),t||(e=Math.min(e,n));let c=s/o;e=Math.max(e,Math.ceil(BFN.minImageSize*(c>1?c:1/c)));let h=e/n;h!==1&&BeFunky.Params.IS_LC&&console.log(`Scaling ${h>1?"up":"down"} image ${h.toFixed(1)}x`,{width:s,height:o},"->",{width:Math.round(s*h),height:Math.round(o*h)});let u,d,m,p;if(i instanceof HTMLImageElement||n>a){p=!0;let f=document.createElement("canvas"),v=f.getContext("2d");d=Math.round(s*h),m=Math.round(o*h),f.width=d,f.height=m,v.drawImage(i,0,0,f.width,f.height),!r&&[87,88,89].includes(BeFunky.chromiumVersion)&&v.getImageData(0,0,1,1).data.every(x=>x===0)&&(n<=a?(p=!1,BeFunky.reportWarning("drawImage failed due to Chromium bug - rendering directly to texture")):BeFunky.throwError("drawImage failed due to Chromium bug - image too large")),u=p?PIXI.Texture.fromCanvas(f):new PIXI.Texture(new PIXI.BaseTexture(i))}else p=!1,u=new PIXI.Texture(new PIXI.BaseTexture(i)),d=Math.round(u.width*h),m=Math.round(u.height*h);let g=PIXI.RenderTexture.create(d,m);return!p&&h!==1?g.copyPixels(u,null,null,null,{x:d/u.width,y:m/u.height}):g.copyPixels(u),u.destroyGC(!0),pI(l),g},svgStringToTexture(i,e,{textureSize:t=BFN.maxImageSizeLayer}={}){if(typeof i!="string")return BeFunky.logError(`Invalid svgString provided: ${BeFunky.getType(i)}`),e({error:"Invalid svgString provided"});let r=!0;BFN.SVGManager.getSVGShape(i,a=>{let s=BFN.SVGManager.getTexture(a,()=>{if(a.width&&a.height){let n=a.width/a.height,l=n>1?t:t*n,c=n<1?t:t/n;return BFN.SVGManager.updateTexture(s,1,1,l,c),e({texture:s})}BeFunky.logError("Unable to convert SVG to Fabric Shape. Falling back to rendering it in an ImageElement");let o=new Blob([i],{type:"image/svg+xml"});BFN.TextureUtils.blobOrBase64ToTexture(o,e,{textureSize:t,readEXIF:!1})})},null,r)},async textureToBlob(i,e={}){let{isTransparent:t,quality:r,mimeType:a}=this.validateQualityAndMimeType(e),s=BFN.TextureUtils.textureToCanvas(i,{isTransparent:t,useBuffer:!0}),o=BFN.BlobUtils.canvasToBlob(s.canvas,a,r);return s.release(),s=null,o},textureToBase64(i,e={}){let{isTransparent:t,quality:r,mimeType:a}=this.validateQualityAndMimeType(e),s=BFN.TextureUtils.textureToCanvas(i,{isTransparent:t,useBuffer:!0}),o=s.canvas.toDataURL(a,r);return s.release(),s=null,o},textureToPixels(i){return BFN.Stage.extract.pixels(i)},pixelsToRenderTexture(i,e,t){let r=PIXI.RenderTexture.create(e,t);return r.clear(),r.baseTexture._glTextures[0].uploadData(i,e,t),r},validateQualityAndMimeType({isTransparent:i,mimeType:e="image/png",quality:t=.99}){if(typeof i=="boolean"?e=i?"image/png":"image/jpeg":i=e==="image/png",!["image/png","image/jpeg"].includes(e))throw new Error(`Invalid mime-type: ${e}`);if(e==="image/jpeg"&&(t=parseFloat(t),!t||t<0||t>1))throw new Error(`Invalid quality: ${t}`);return{isTransparent:i,quality:t,mimeType:e}},textureToCanvas(i,{isTransparent:e=!1,useBuffer:t=!1}={}){this.canvasTexture||(this.canvasTexture=PIXI.RenderTexture.create(1,1));let r;if(e)this.unPremultiplySprite||(this.unPremultiplySprite=new PIXI.Sprite,this.unPremultiplySprite.filters=[new BFN.filters.UnPremultiplyFilter]),this.unPremultiplySprite.texture=i,this.canvasTexture.resize(i.width,i.height),BFN.Stage.render(this.unPremultiplySprite,this.canvasTexture),r=t?BFN.Stage.extract.canvasBufferBfn(this.canvasTexture):BFN.Stage.extract.canvas(this.canvasTexture),this.unPremultiplySprite.texture=PIXI.Texture.EMPTY;else{let a;!i.baseTexture.hasOwnProperty("isTransparent")||i.isTransparent?(this.canvasTexture.resize(i.width,i.height),i.fillAlpha(this.canvasTexture,16777215),a=this.canvasTexture):a=i,r=t?BFN.Stage.extract.canvasBufferBfn(a):BFN.Stage.extract.canvas(a)}return this.canvasTexture.resize(1,1),r},getScaledDimensions(i,{maxWidth:e,maxHeight:t,scaleUp:r=!1}){let a=i.width/i.height,s=e/t,o,n,l;return a>s?(o=r?e:Math.min(e,i.width),n=o/i.width,l=Math.round(i.height*n)):(l=r?t:Math.min(t,i.height),n=l/i.height,o=Math.round(i.width*n)),[o,l]},reportImageSize(i,e){let t;i===e?t="UPLOAD_SQUARE":t=i>e?"UPLOAD_LANDSCAPE":"UPLOAD_PORTRAIT";let r=Math.max(i,e),a;r<=1e3?a="1000-0":r<=2e3?a="2000-1001":r<=3e3?a="3000-2001":r<=4088?a="4088-3001":r<=5e3?a="5000-4089":r<=6e3?a="6000-5001":r<=7e3?a="7000-6001":r<=8e3?a="8000-7001":a="8001+",BFN.BfnService.track("EXTERNAL",t,a)}};var ds=class{constructor(e="keyval-store",t="keyval"){this.storeName=t,this._dbp=new Promise((r,a)=>{let s=indexedDB.open(e,1);s.onerror=()=>a(s.error),s.onsuccess=()=>r(s.result),s.onupgradeneeded=()=>{s.result.createObjectStore(t)}})}_withIDBStore(e,t){return this._dbp.then(r=>new Promise((a,s)=>{let o=r.transaction(this.storeName,e);o.oncomplete=()=>a(),o.onabort=o.onerror=()=>s(o.error),t(o.objectStore(this.storeName))}))}},yo;function Ra(){return yo||(yo=new ds),yo}function kc(i,e=Ra()){let t;return e._withIDBStore("readonly",r=>{t=r.get(i)}).then(()=>t.result)}function xo(i,e,t=Ra()){return t._withIDBStore("readwrite",r=>{r.put(e,i)})}function Ac(i,e=Ra()){return e._withIDBStore("readwrite",t=>{t.delete(i)})}function ms(i=Ra()){return i._withIDBStore("readwrite",e=>{e.clear()})}function To(i=Ra()){let e=[];return i._withIDBStore("readonly",t=>{(t.openKeyCursor||t.openCursor).call(t).onsuccess=function(){!this.result||(e.push(this.result.key),this.result.continue())}}).then(()=>e)}var Oc=class{constructor(){this.init()}init(){this.version="0.4",this.fallbackStore={},this.disabledReason=null,this.errorsRemaining=10,this.indexedDBReady=new Promise(e=>{let t=(n,l)=>{this.logError("Disabling IndexedDB during initial setup:",n),l&&this.reportError("Failed to setup IndexedDB",l),this.disabledReason=n,e(!1)},r=n=>{this.forceLog("Handing QuotaExceededError during startup");let l=c=>this.get(c,{readyPromise:Promise.resolve(!0)}).then(h=>{this.fallbackStore[c]=h}).catch(h=>this.logError(`Unable to copy ${c} into memory`,h));To(this.store).then(c=>Promise.all(c.map(l))).then(()=>ms(this.store)).then(()=>{this.forceLog("Successfully copied all keys into memory & cleared IndexedDB")}).catch(c=>{this.reportError("Failed to handle QuotaExceededError during startup",c)}).then(n)},a=(n="",l={})=>{if(BeFunky.isFirefox&&l.name==="InvalidStateError")return this.setPrivateBrowsingTag(!0),t("Firefox is in Private Browsing mode.");if(BeFunky.isFirefox&&l.name==="UnknownError")return t("Firefox ESR user profile might be corrupted.");if(BeFunky.isSafari&&l.message.includes("BlobURLs are not yet supported."))return this.setPrivateBrowsingTag(!0),t("Safari is in Private Browsing mode.");if(l.name==="QuotaExceededError")return r(()=>t(n,l));t(n,l)},s=()=>{xo("test_blob",new Blob,this.store).then(()=>e(!0),n=>a("Unable to set empty Blob",n))},o=()=>{this.log("Connected");let n="__IndexedDB_version",l=this.version,c;try{c=localStorage.getItem(n)}catch(h){return t(`Unable to read ${n} from localStorage`,h)}if(c===l)return s();c!==l&&(c!==null&&this.logError("Clearing IndexedDB while upgrading version",c,"->",l),ms(this.store).then(()=>{try{localStorage.setItem(n,l)}catch(h){return t(`Unable to write ${n} to localStorage`,h)}s()}).catch(h=>{a("Unable to clear keys while upgrading version",h)}))};if(BeFunky.testingFlags.includes("disable_indexeddb"))return t("Automated testing");try{this.store=new ds}catch(n){return a("new idbKeyval.Store failed",n)}this.store._dbp.then(o,n=>a("indexedDB.open failed",n))}),this.usagePercent=null,this.hasLoggedUsage=!1,navigator.storage&&navigator.storage.estimate?this.logUsage=BeFunky.debounce(this.logUsage.bind(this),1e3):(BeFunky.logWarning("Unable to calculate storage usage or quota in this browser"),this.logUsage=()=>{},this.hasLoggedUsage=!0),this.newBeFunkyTabOpened=!1,this.indexedDBReady.then(e=>{e?this.log("Allowing IndexedDB lookups"):this.logError("Using memory store b/c IndexedDB failed to initialize"),this.logUsage(),e&&this.listenForNewTabOpen()}),BeFunky.loggingFlags.includes("indexeddb")&&this.monitorLookups(),this.ignoreAutosaveNextSession=!1}disable(e,t,r=!1){t?this.reportError("Disabling IndexedDB",t,e):this.logError("Disabling IndexedDB",t,e),this.indexedDBReady=Promise.resolve(!1),this.disabledReason=e,r&&!this.ignoreAutosaveNextSession&&(this.ignoreAutosaveNextSession=!0,BeFunky.setLocal(`ignore_autosave__${BFN.AppModel.sectionID}`,"true"),BFN.AppModel.addEventListener(BFN.AppModelEvents.VIEWSTATE_UPDATED.type,()=>{BeFunky.setLocal(`ignore_autosave__${BFN.AppModel.sectionID}`,"true")}))}log(...e){BeFunky.logFeature("indexeddb",...e)}forceLog(...e){BeFunky.loggingFlags.includes("indexeddb")?BeFunky.logFeature("indexeddb",...e):console.log("IndexedDB >",...e)}logWarning(...e){BeFunky.loggingFlags.includes("indexeddb")?BeFunky.logFeature("indexeddb",...e):BeFunky.logWarning("IndexedDB >",...e)}logError(...e){BeFunky.loggingFlags.includes("indexeddb")?BeFunky.logFeature("indexeddb",...e):BeFunky.logError("IndexedDB >",...e)}retryAndTimeout({attempt:e,retryAfter:t,onRetry:r,timeoutAfter:a,onTimeout:s}){return new Promise((o,n)=>{e().then(o,n).then(h,h);let l=setTimeout(()=>{e().then(o,n).then(h,h),r()},t),c=setTimeout(()=>{n("timeout"),s(),h()},a);function h(){clearTimeout(l),clearTimeout(c)}})}reportError(e,t,...r){let a=t&&t.name?t.name:t;typeof a=="string"&&t&&t.message&&(a=`${a}: ${t.message}`),this.errorsRemaining>0?(BeFunky.throwError(`${e} - ${a}`,...r),this.errorsRemaining--):BeFunky.logError(`${e} - ${a}`,...r)}get(e,{useFallback:t=!0,readyPromise:r=this.indexedDBReady}={}){return r.then(a=>{if(t&&this.fallbackStore.hasOwnProperty(e))return this.fallbackStore[e];if(!!a)return this.retryAndTimeout({attempt:()=>kc(e,this.store).then(s=>(s instanceof Blob&&(s.idbKeyName=e),s)),retryAfter:3e3,onRetry:()=>this.logError("IndexedDB.get retried after 3 seconds",e),timeoutAfter:1e4,onTimeout:()=>this.reportError("IndexedDB.get took over 10 seconds","timeout",e)})})}set(e,t,{useFallback:r=!0,saveAttempt:a=1}={}){return new Promise((s,o)=>{this.indexedDBReady.then(n=>{if(this.fallbackStore.hasOwnProperty(e)&&delete this.fallbackStore[e],!n)return r?(this.fallbackStore[e]=t,s({store:"memory"})):o(this.disabledReason);t instanceof Blob&&t.idbKeyName&&(t.idbKeyName===e?this.logWarning(`Blob from IndexedDB saved there again with same key "${e}"`):this.logWarning(`Blob from IndexedDB saved there again with new key "${t.idbKeyName}" ->  "${e}"`)),e==="image__editor_canvas_image"&&console.time(`Save editor image ${t instanceof Blob?"blob":"pixel object"} -> IndexedDB`),xo(e,t,this.store).then(()=>{e==="image__editor_canvas_image"&&console.timeEnd(`Save editor image ${t instanceof Blob?"blob":"pixel object"} -> IndexedDB`),t instanceof Blob&&BeFunky.isSafari?BFN.BlobUtils.blobToArrayBuffer(t,({error:l})=>{l?(this.logError(`Unable to read Blob ${e} (size = ${BeFunky.formatBytes(t.size)}) as ArrayBuffer after saving to IndexedDB.`),o("invalid_blob")):s({store:"IndexedDB"})}):s({store:"IndexedDB"}),this.logUsage()},l=>{if(!r)return o(l);this.fallbackStore[e]=t,s({store:"memory"});let c=l&&l.name?l.name:l;this.logError(c,`Storing ${e} (${BeFunky.getType(t)}) in memory storage instead of IndexedDB`);let h=()=>{if(l&&l.message&&/connection is closing/i.test(l.message))return this.disable("Fatal error during set()",l,!0);this.reportError("IndexedDB set failed",l)};BeFunky.isChrome?BeFunky.waitUntil({condition:()=>this.hasLoggedUsage,onSuccess:h,onTimeout:h}):h()})})})}delete(e){return this.indexedDBReady.then(t=>{if(this.fallbackStore.hasOwnProperty(e)){delete this.fallbackStore[e];return}if(!!t)return Ac(e,this.store)})}keys({prefix:e,includeFallback:t=!0}={}){return this.indexedDBReady.then(r=>{let a=s=>(t&&(s=s.concat(Object.keys(this.fallbackStore))),e&&(s=s.filter(o=>typeof o=="string"&&o.startsWith(e))),s);return r?To(this.store).then(a).catch(s=>t?(this.logError("Unable to list IndexedDB keys",s),a([])):Promise.reject(s)):a([])})}clear(){return this.indexedDBReady.then(e=>{if(this.fallbackStore={},!!e)return ms(this.store)})}getFile(e,t,r){return new Promise((a,s)=>{this.indexedDBReady.then(o=>{let n=`${e}__${t}`;if(!o)return l();BFN.IndexedDB.get(n).then(u=>{u?c(u):l()}).catch(u=>{BeFunky.logError("Unable lookup key in IndexedDB:",n,u),l()});function l(){BFN.RequestUtils.getJSON(r,({error:u,response:d})=>{if(u)return BeFunky.logError("Unable to fetch valid JSON file from server",u),o?h(m=>{if(!m.length)return s(u);BFN.IndexedDB.get(m[m.length-1]).then(p=>{!p||(BeFunky.logError("Falling back to outdated file",m[m.length-1]),c(p,!1))})}):s(u);c(d),!!o&&BFN.IndexedDB.set(n,d,{useFallback:!1}).catch(m=>BeFunky.logError("Unable to store file in IndexedDB",n,m))})}function c(u,d=!0){a(u),d&&h(m=>m.forEach(p=>BFN.IndexedDB.delete(p)))}function h(u){BFN.IndexedDB.keys({prefix:e,includeFallback:!1}).then(d=>u(d.filter(m=>m!==n))).catch(()=>u([]))}})})}listenForNewTabOpen(){let e="__latest_tab",t=Date.now().toString();try{localStorage.setItem(e,t)}catch(a){this.disable(`Unable to write ${e} to localStorage`,a)}let r=a=>{a.key!==e||BeFunky.getLocal(e)===t||(this.newBeFunkyTabOpened=!0,console.log("A new tab was opened. Timestamp = ",a.newValue),window.removeEventListener("storage",r),!this.disabledReason&&(this.keys({includeFallback:!1}).then(s=>Promise.all(s.map(o=>this.get(o).then(n=>{this.fallbackStore[o]=n})))).catch(s=>{this.reportError("Unable to copy IndexedDB values to memory when new tab was opened",s)}).then(()=>{this.disable("A new tab was opened")}),BeFunky.acknowledge("auto_save_disabled")))};window.addEventListener("storage",r)}logUsage(e=!1){requestIdleCallback(()=>{navigator.storage.estimate().then(({usage:t,quota:r})=>{let a=(100*t/r).toFixed(2);if(!e&&a===this.usagePercent)return;this.usagePercent=a;let s=[`Using ${a}% of allowed storage, ${BeFunky.formatBytes(t)} of ${BeFunky.formatBytes(r)}`];a>100?this.logError(...s):e||!this.hasLoggedUsage?this.forceLog(...s):this.log(...s),BeFunky.isChrome&&!this.hasLoggedUsage&&this.setPrivateBrowsingTag(r/1024**2<110)},t=>{this.logError("Unable to calculate storage usage or quota",t)}).then(()=>{this.hasLoggedUsage=!0})})}monitorLookups(){let e=[],t=r=>{let a=this[r];this[r]=(...s)=>{let o=[r,...s],n=setTimeout(()=>{this.log("Lookup taking a long time",o)},3e3);return e.push(o),a.call(this,...s).then((...l)=>(clearTimeout(n),e=e.filter(c=>c!==o),Promise.resolve(...l)),(...l)=>(clearTimeout(n),e=e.filter(c=>c!==o),Promise.reject(...l)))}};t("get"),t("set"),t("clear"),t("delete"),t("keys"),Object.defineProperty(this,"pendingLookups",{get(){return e.slice()}})}setPrivateBrowsingTag(e){BeFunky.setSentryTag("private_browsing",e),this.log("Private browsing =",e)}};BFN.SingletonQueue.add(()=>{BFN.IndexedDB=new Oc});BFN.ExtractImageEvents={IMAGE_COMPRESS_FINISHED:new Event("IMAGE_COMPRESS_FINISHED"),WAITING_COMPRESS_STARTED:new Event("WAITING_COMPRESS_STARTED"),UPLOAD_STARTED:new Event("UPLOAD_STARTED"),UPLOAD_CANCELLED:new Event("UPLOAD_CANCELLED"),UPLOAD_FAILED:new Event("UPLOAD_FAILED"),UPLOAD_COMPLETED:new Event("UPLOAD_COMPLETED")};var Rc=class extends BFN.EventDispatcher{constructor(){super();this.init()}init(){this.initDefaultValues()}initDefaultValues(){this.quality=.95,this.mimeType="image/jpeg",this.fileName="BeFunkyArtwork",this._currentTexture=null,this.xhr=null,BFN.uploadVo=null,this.binaryData=null,this.UPDATE_PGOGRESS_EVENT_HANDLER=this.updateProgress.bind(this),this.TRANSFER_FAILED_HANDLER=this.transferFailed.bind(this),this.TRANSFER_CANCELED_HANDLER=this.transferCanceled.bind(this)}compress(e,t,r,a){if(e!=null&&e!=this.quality&&(this.quality=e),t!=null&&t!=this.mimeType&&(this.mimeType=t),r!==!0&&(this.blobData=null),this.currentTexture!=null){let s=null,o;if(this.mimeType==="image/png"){let c=new BFN.filters.UnPremultiplyFilter;o=new PIXI.Sprite(this.currentTexture),o.filters=[c],s=PIXI.RenderTexture.create(this.currentTexture.width,this.currentTexture.height),BFN.Stage.render(o,s);try{o.texture=null,o=null}catch(h){}c=null;try{BFN.FilterHelper.emptyPoolForFilter()}catch(h){}}else s=PIXI.RenderTexture.create(this.currentTexture.width,this.currentTexture.height),s.fillColor(16777215),s.copyPixels(this.currentTexture,null,!1);let n=s!==null?BFN.Stage.extract.canvasBufferBfn(s):BFN.Stage.extract.canvasBufferBfn(this.currentTexture),l=this;if(r!==!0)setTimeout(()=>{n.canvas.toBlob(c=>{n.release(),n=null,l.blobData=c,s!==null&&(s.destroyGC(!0),s=null),a!=null?a(l.blobData):l.dispatchEvent(BFN.ExtractImageEvents.IMAGE_COMPRESS_FINISHED)},l.mimeType,l.quality)},0);else{let c=extractedCanvas.toDataURL(this.mimeType,this.quality);return c=c.replace(`data:${this.mimeType};base64,`,""),c}}else console.warn("-[ExtractImage:compress] : currentTexture parameter is null");if(r==!0)return null}saveToDesktop(){if(this.blobData==null)return;this.fileName.length<1&&(this.fileName="BeFunky-artwork");let e=this.fileName.replace(/\.(jpe?g|png)$/,"")+(this.mimeType==="image/jpeg"?".jpg":".png");saveAs(this.blobData,e)}upload(e,t){BFN.uploadVo=null;let r=e==null?"https://upload.befunky.com/restupload/uploadbinv6.bfn?fromFlash=1&method=befunky.uploadFile":e;t.CSRFtoken=getCsToken();let a=t,s=this;if(this.currentTexture!=null){this.dispatchEvent(BFN.ExtractImageEvents.UPLOAD_STARTED);let o=BFN.Stage.extract.canvas(this.currentTexture);o.toBlob(n=>{s.binaryData=n,o=null,s.xhr=new XMLHttpRequest,s.xhr.onload=()=>{let l=s.xhr.response!=null?s.xhr.response:s.xhr.responseText;if(l!=null)l=l.replace(`
`,"");else{s.transferFailed();return}let c=null;try{c=window.parseXml(l)}catch(h){s.transferFailed();return}if(c!=null){let h=null;try{h=c}catch(u){s.transferFailed();return}if(h==null||h.getElementsByTagName("url")!=null&&h.getElementsByTagName("url")[0].childNodes[0].nodeValue.length<1){this.transferFailed();return}BFN.uploadVo=new BFN.UploadVO,BFN.uploadVo.url=h.getElementsByTagName("url")[0].childNodes[0].nodeValue,BFN.uploadVo.width=h.getElementsByTagName("width")[0].childNodes[0].nodeValue,BFN.uploadVo.height=h.getElementsByTagName("height")[0].childNodes[0].nodeValue,BFN.uploadVo.size=h.getElementsByTagName("size")[0].childNodes[0].nodeValue,BFN.uploadVo.resizedUrl=h.getElementsByTagName("url")[1].childNodes[0].nodeValue,BFN.uploadVo.resizedWidth=h.getElementsByTagName("width")[1].childNodes[0].nodeValue,BFN.uploadVo.resizedHeight=h.getElementsByTagName("height")[1].childNodes[0].nodeValue,BFN.uploadVo.resizedSize=h.getElementsByTagName("size")[1].childNodes[0].nodeValue,s.dispatchEvent(BFN.ExtractImageEvents.UPLOAD_COMPLETED)}else{s.transferFailed();return}s.removeUploadEvent(),BeFunky.log(`Upload completed : ${BFN.uploadVo.url}`)},s.xhr.upload.addEventListener("progress",s.UPDATE_PGOGRESS_EVENT_HANDLER),s.xhr.upload.addEventListener("error",s.TRANSFER_FAILED_HANDLER),s.xhr.upload.addEventListener("abort",s.TRANSFER_CANCELED_HANDLER),s.xhr.withCredentials=!0,s.xhr.open("POST",r,!0),s.xhr.setRequestHeader("Content-Type","application/octet-stream"),s.xhr.responseType="text",s.xhr.send(s.binaryData)},"image/jpeg",1)}else this.dispatchEvent(BFN.ExtractImageEvents.UPLOAD_FAILED)}cancelUpload(){if(this.xhr!=null)try{this.xhr.abort()}catch(e){}}removeUploadEvent(){try{this.xhr.upload.removeEventListener("progress",this.UPDATE_PGOGRESS_EVENT_HANDLER),this.xhr.upload.removeEventListener("error",this.TRANSFER_FAILED_HANDLER),this.xhr.upload.removeEventListener("abort",this.TRANSFER_CANCELED_HANDLER)}catch(e){}try{this.xhr.onload=null}catch(e){}this.xhr=null,this.binaryData=null}updateProgress(e){if(e.lengthComputable){let t=e.loaded/e.total*100;BeFunky.log(`uploading progress : %${t}`)}else BeFunky.log("Unable to compute progress information since the total size is unknown")}transferFailed(e){BeFunky.log("An error occurred while transferring the file."),this.removeUploadEvent(),this.dispatchEvent(BFN.ExtractImageEvents.UPLOAD_FAILED)}transferCanceled(e){BeFunky.log("The transfer has been canceled by the user."),this.removeUploadEvent(),this.dispatchEvent(BFN.ExtractImageEvents.UPLOAD_CANCELLED)}set quality(e){this._quality=e}get quality(){return this._quality}set mimeType(e){this._mimeType=e}get mimeType(){return this._mimeType}set fileName(e){this._fileName=e}get fileName(){return this._fileName}set binaryData(e){this._binaryData=e}get binaryData(){return this._binaryData}set blobData(e){this._blobData=e}get blobData(){return this._blobData}set currentTexture(e){this._currentTexture=e}get currentTexture(){return this._currentTexture}};BFN.SingletonQueue.add(()=>{BFN.ExtractImage=new Rc});BFN.ArtsyServiceEvents={FAILED:new Event("ARTSY_SERVICE_FAILED"),COMPLETED:new Event("ARTSY_SERVICE_COMPLETED")};var Lc=class extends BFN.EventDispatcher{constructor(){super();this.init()}init(){this.initDefaultValues()}initDefaultValues(){this.isArtsy=!0,this.maxPixels=null,this.xhr=null,this._currentTexture=null,this._uploadTexture=null,this.artsyServiceURL="https://upload.befunky.com/artsy/",this.currentArtsyID=233,this.currentArtsyParams={color_detail:350,sketch_smoothness:20,clutter_cleaner:3,sketch_brightness:35,sketch_detail:17,color_smoothness:100},this.PROCESS_FAILED_EVENT_HANDLER=this.processFailed.bind(this),this.UPLOAD_COMPLETE_EVENT_HANDLER=this.processImage.bind(this)}processImage(){if(BFN.uploadVo==null){this.uploadImage();return}try{this._uploadTexture.destroyGC(!0),this._uploadTexture=null}catch(r){}this.isArtsy?UIMessages.display("processing_image"):UIMessages.display("enhancing_your_photo"),this.removeUploadEvent(),this.xhr!=null&&this.removeArtsyEvent();let e=getCsToken(),t;if(["a_i_enhancer","a_i_portrait"].includes(this.currentArtsyID)){let r=this.currentArtsyID==="a_i_enhancer"?"enhancer":"portrait";t={method:"api/auto-enhancer/",image:BFN.uploadVo.url,CSRFtoken:e,model:r}}else if(this.currentArtsyID.startsWith("AI_ARTSY_STYLE_")){let r=this.currentArtsyID.replace("AI_ARTSY_STYLE_","");t={method:"api/artsy-style/",image:BFN.uploadVo.url,CSRFtoken:e,style:r}}else t={method:"befunky.runTemplateEffect",template_id:this.currentArtsyID,url:BFN.uploadVo.url,CSRFtoken:e,adjustment:"",vm:""};BeFunky.Params.isAdmin&&(t.is_beta=1);for(let r in this.currentArtsyParams)t[r]=this.currentArtsyParams[r];if(BeFunky.isAppleAppStoreApp){this.xhr=null,window.execNative({type:"request",req_params:t,req_url:this.artsyServiceURL,CSRFtoken:e},r=>{this.processCompleted(r)});return}this.xhr=BeFunky.request(this.artsyServiceURL,{headers:{"Content-Type":"application/x-www-form-urlencoded","X-CSRF-Token":e},method:"POST",body:Object.entries(t).map(([r,a])=>`${r}=${encodeURIComponent(a)}`).join("&")},({error:r,response:a})=>{let{wasAborted:s}=this.xhr||{};r?this.processFailed(s?"cancelled_by_user":r):this.processCompleted(a)})}uploadImage(){if(this._currentTexture){let e=this._currentTexture.determineTransparency(),t=this._currentTexture.renderClone();if(e){let a=PIXI.RenderTexture.create(t.width,t.height);a.fillColor(16777215),a.copyPixels(t,null,!1);try{t.destroyGC(!0)}catch(s){}t=a}let r=BFN.BfnService.userIsPlus;if(r||t.width<BFN.maxImageUploadSizeFreeUser&&t.height<BFN.maxImageUploadSizeFreeUser)if(this.maxPixels!=null&&this.maxPixels>0){let a=BFN.Util.conformImageSizeMegaPixels(t,BFN.minImageSize,this.maxPixels);t.destroyGC(!0),t=a}else{let a=BFN.Util.conformImageSize(t,BFN.minImageSize,BFN.maxImageSizeForArtsy);t.destroyGC(!0),t=a}else if(r&&this.maxPixels!=null&&this.maxPixels>0){let a=BFN.Util.conformImageSizeMegaPixels(t,BFN.minImageSize,this.maxPixels);t.destroyGC(!0),t=a}else{let a=BFN.maxImageUploadSizeFreeUser;(["a_i_enhancer","a_i_portrait"].includes(this.currentArtsyID)||this.currentArtsyID.startsWith("AI_ARTSY_STYLE_"))&&(a=BFN.maxImageSizeForArtsy),t=BFN.Util.conformImageSize(t,BFN.minImageSize,a)}if(this._uploadTexture=t,typeof window.DirectUPL=="undefined")BFN.ExtractImage.currentTexture=this._uploadTexture,BFN.ExtractImage.addEventListener(BFN.ExtractImageEvents.UPLOAD_FAILED.type,this.PROCESS_FAILED_EVENT_HANDLER),BFN.ExtractImage.addEventListener(BFN.ExtractImageEvents.UPLOAD_COMPLETED.type,this.UPLOAD_COMPLETE_EVENT_HANDLER),BFN.ExtractImage.upload();else{let a=null,s=BFN.Stage.extract.canvasBufferBfn(this._uploadTexture);s.canvas.toBlob(o=>{a=o,s.release(),s=null,window.DirectUPL.upload(n=>{if(a=null,n&&n.url&&n.s3_name)BFN.uploadVo=new BFN.UploadVO,BFN.uploadVo.url=n.url,this.processImage();else try{if(n!=="abort"&&typeof n!="undefined"&&typeof n.abort=="undefined")try{BFN.ExtractImage.currentTexture=this._uploadTexture,BFN.ExtractImage.addEventListener(BFN.ExtractImageEvents.UPLOAD_FAILED.type,this.PROCESS_FAILED_EVENT_HANDLER),BFN.ExtractImage.addEventListener(BFN.ExtractImageEvents.UPLOAD_COMPLETED.type,this.UPLOAD_COMPLETE_EVENT_HANDLER),BFN.ExtractImage.upload()}catch(l){this.processFailed("error")}else this.processFailed()}catch(l){this.processFailed()}},{bucket:["a_i_enhancer","a_i_portrait"].includes(this.currentArtsyID)||this.currentArtsyID.startsWith("AI_ARTSY_STYLE_")?"ai-enhancer":"artsyupload",content_type:"image/jpeg",blob:a})},"image/jpeg",["a_i_enhancer","a_i_portrait"].includes(this.currentArtsyID)||this.currentArtsyID.startsWith("AI_ARTSY_STYLE_")?.99:.9)}UIMessages.display("preparing_image")}}processCompleted(e){this.removeUploadEvent();try{this._uploadTexture.destroyGC(!0),this._uploadTexture=null}catch(a){}let t=(a,s)=>{console.log(a,s),this.processFailed("error")};if(e&&e.error)return t("Artsy request failed",e.error);if(!(e&&e.data))return t("Artsy request failed","no_response");let r=e.data.url||e.data.image;if(r){UIMessages.display("downloading_processed_image");let a=document.createElement("img");a.setAttribute("crossOrigin","Anonymous"),a.onload=()=>{let s=new PIXI.Texture(new PIXI.BaseTexture(a)),o=s.renderClone();s.destroyGC(!0),BFN.ArtsyServiceEvents.COMPLETED.data=o,this.dispatchEvent(BFN.ArtsyServiceEvents.COMPLETED),BFN.ArtsyServiceEvents.COMPLETED.data=null,o.destroyGC(!0)},a.onerror=()=>{this.processFailed("error")},BeFunky.isAppleAppStoreApp?BFN.RequestUtils.getBase64(r,({base64:s,error:o})=>{o||(a.src=s)}):a.src=r}else return this.processFailed("error");this.removeArtsyEvent()}processFailed(e){try{this._uploadTexture.destroyGC(!0),this._uploadTexture=null}catch(r){}if(this.removeUploadEvent(),this.removeArtsyEvent(),this.dispatchEvent(BFN.ArtsyServiceEvents.FAILED),!e||e==="cancelled_by_user")return;let t=BeFunky.LanguageManager.isTranslated(`error_${e}`)?`error_${e}`:"error_invalid_response";UIMessages.display(t)}cancel(){try{this._uploadTexture.destroyGC(!0),this._uploadTexture=null}catch(e){}if(this.removeUploadEvent(),BFN.ExtractImage.cancelUpload(),typeof window.DirectUPL!="undefined")try{if(typeof window.DirectUPL.signReq!="undefined"&&window.DirectUPL.signReq!=null){try{window.DirectUPL.signReq.abort()}catch(e){}window.DirectUPL.signReq=null}if(typeof window.DirectUPL.uploadReq!="undefined"&&window.DirectUPL.uploadReq!=null){try{window.DirectUPL.uploadReq.abort()}catch(e){}window.DirectUPL.uploadReq=null}}catch(e){}if(this.xhr)try{this.xhr.abort()}catch(e){}this.removeArtsyEvent()}reset(){try{this._uploadTexture.destroyGC(!0),this._uploadTexture=null}catch(e){}BFN.uploadVo!=null&&(BFN.uploadVo=null),this._currentTexture=null}removeUploadEvent(){try{BFN.ExtractImage.removeEventListener(BFN.ExtractImageEvents.UPLOAD_FAILED.type,this.PROCESS_FAILED_EVENT_HANDLER),BFN.ExtractImage.removeEventListener(BFN.ExtractImageEvents.UPLOAD_COMPLETED.type,this.UPLOAD_COMPLETE_EVENT_HANDLER)}catch(e){}}removeArtsyEvent(){try{this._uploadTexture.destroyGC(!0),this._uploadTexture=null}catch(e){}this.xhr=null}set currentArtsyID(e){this._currentArtsyID=e}get currentArtsyID(){return this._currentArtsyID}set currentArtsyParams(e){this._currentArtsyParams=e}get currentArtsyParams(){return this._currentArtsyParams}set currentTexture(e){this._currentTexture=e}get currentTexture(){return this._currentTexture}};BFN.SingletonQueue.add(()=>{BFN.ArtsyService=new Lc});BFN.BfnServiceEvents={USER_DATA_CHANGED:new Event("USER_DATA_CHANGED"),CUSTOM_RESIZE_EVENT:new Event("CUSTOM_RESIZE_EVENT"),TRANSFER_FAILED:new Event("TRANSFER_FAILED"),TRANSFER_CANCELLED:new Event("TRANSFER_CANCELLED"),TRANSFER_COMPLETED:new Event("TRANSFER_COMPLETED")};var Vc=class extends BFN.EventDispatcher{constructor(){super();this.init()}init(){this.initDefaultValues()}initDefaultValues(){this.hashtagRegExp=/(#[a-zA-Z0-9_%-]*)/g,this.initCompleteFired=!1,window.addEventListener("INIT_COMPLETE",()=>{this.initCompleteFired=!0})}updateUserData(){this.initCompleteFired?this.dispatchEvent(BFN.BfnServiceEvents.USER_DATA_CHANGED):setTimeout(()=>{window.addEventListener("INIT_COMPLETE",()=>{this.dispatchEvent(BFN.BfnServiceEvents.USER_DATA_CHANGED)})},0)}login(e){BeFunky.openLoginPanel("SIGNIN",e)}register(e){BeFunky.openLoginPanel("REGISTER",e)}signOut(){BFN.IndexedDB.indexedDBReady.then(r=>{if(!r)return t();BeFunky.confirm("confirm_keep_projects",{onConfirm:t,onCancel:a=>{a&&e().then(t)},confirmText:"yes",cancelText:"no_clear_them",isCritical:!0})});function e(){Object.values(BFN.ProjectManager.autoSave).forEach(n=>{n.allowAutoSave=!1}),["editor","collage","designer"].forEach(n=>BFN.UnsavedOpenProjectManager.setSaved(n,!0,"clear_on_logout"));let r=["editor","collage","designer"].map(n=>BFN.IndexedDB.delete(`project__${n}`)),a=BFN.ProjectService.clearLocalAssets("all"),s=BFN.IndexedDB.delete("options__selectedMenuImageVOs"),o=BFN.IndexedDB.delete("options__selectedGraphics");return Promise.all([...r,a,s,o]).catch(n=>{BeFunky.logError("Unable to delete all projects and their assets:",n)})}function t(){BeFunky.signOut()}}upgrade(e,t,r){typeof e=="string"&&BFN.BfnService.track("CREATE",e.toUpperCase(),t?t.toUpperCase():"UPGRADE"),BeFunky.openTeaserModal(r)}onUserLogin(e){if(this.userLoggedIn)return e(this.userIsPlus);let t=()=>{this.removeEventListener(BFN.BfnServiceEvents.USER_DATA_CHANGED.type,t),this.userLoggedIn&&e(this.userIsPlus)};this.addEventListener(BFN.BfnServiceEvents.USER_DATA_CHANGED.type,t)}importDropBoxImage(){BFN.DropboxManager.chooseImage().then(({blob:e,filename:t})=>{t=t?t.replace(/\.[^/.]+$/,""):"",BFN.PhotoEditorModel.confirmEditorLoadImage(()=>{BFN.PhotoEditorModel.loadNewImage(e,{filename:t,reportImageSize:!0})})}).catch(e=>{e!=="cancelled_by_user"&&BeFunky.reportWarning(`Dropbox import failed: ${e}`,e)})}importGoogleDriveImage(){window.drv_OpenPicker()}hideEditor(){window.hideEditor(),BFN.BfnService.track("CREATE","GLOBALMENU","HIDE_APP")}callbackFromJs(e,t){if(!t){this.tmpCallback!=null&&(this.tmpCallback("cancel"),this.tmpCallback=null);return}this.tmpInternalCallback!=null&&(this.tmpInternalCallback(),this.tmpInternalCallback=null)}callbackDriveInsertFile(e){if(this.tmpCallback!=null){if(e!=="error"){let t=BFN.AppModel.sectionValue("SAVE","SAVE_COLLAGE","SAVE_DESIGNER");BFN.BfnService.track("CREATE",t,"GOOGLE_DRIVE")}this.tmpCallback(e==="error"?"error":e==="cancel"?"cancel":null),this.tmpCallback=null,this.tempParams=null}}ToJsBase64Uploader(e,t,r){BFN.AppModel.viewingEditor||BeFunky.throwError("ToJsBase64Uploader requested while not in Editor"),e.includes("data:image")||(e=`data:image/png;base64,${e}`),typeof r=="string"?BFN.BfnService.trackMediaOpened("image",r):BeFunky.logError("Unable to track ToJsBase64Uploader media open b/c no source was provided"),typeof t=="string"&&t.includes(".")&&(t=t.split(".").slice(0,-1).join(".")),BFN.BfnService.ToJsUrlUploader(e,t,r)}ToJsUrlUploader(e,t,r){if(BFN.AppModel.viewingEditor||BeFunky.throwError("ToJsUrlUploader requested while not in Editor"),!BFN.hasFullyOpenedEditor&&!BFN.ImageEditManager.editingImage){console.log("Waiting for Photo Editor to initialize before opening external image"),BeFunky.editorExternalImage={behavior:"load_instead_of_autosave",loadImage:()=>{if(!BFN.hasFullyOpenedEditor)return BeFunky.throwError("BeFunky.editorExternalImage.loadImage called before hasFullyOpenedEditor");this.ToJsUrlUploader(e,t,r)}};return}(()=>{if(e.startsWith("data:image")){BFN.PhotoEditorModel.loadNewImage(e,{filename:t});return}if(!this.isUrl(e)&&!e.toLowerCase().startsWith("../")){BeFunky.logError("Invalid url provided",e);return}typeof r=="string"?BFN.BfnService.track("CREATE","UPLOAD",r.toUpperCase()):BFN.BfnService.track("CREATE","UPLOAD","WEB"),typeof r=="string"?BFN.BfnService.trackMediaOpened("image",r):BeFunky.logError("Unable to track ToJsUrlUploader media open b/c no source was provided");let s=!1;BeFunky.showLoadScreen({onCancel:()=>{s=!0}}),typeof t!="string"&&(t=e.substring(e.lastIndexOf("/")+1).replace(/\.[^/.]+$/,"").trim()||"External Image"),BFN.RequestUtils.getImageBlobWithCorsFallback(e).then(o=>{s||BFN.PhotoEditorModel.loadNewImage(o,{filename:t})}).catch(o=>{BeFunky.logError(o),BeFunky.hideLoadScreen()})})()}track(e,t,r,a){BeFunky.log("TRACKING:",e,t,r),window.bf_eventTrack(e,t,r,a)}trackMediaOpened(e,t){BFN.imageTypes.includes(t)&&t.startsWith("befunky_")&&(t="befunky");let r={image:"Image",project:"Project"},a={computer:"Computer",facebook:"Facebook",drive:"Drive",dropbox:"Dropbox",befunky:"BeFunky",webcam:"Webcam",sample:"Sample",unsplash:"Unsplash",pixabay:"Pixabay",pexels:"Pexels",chrome_extension:"chrome_extension",google_photos:"Google Photos"};if(!r.hasOwnProperty(e))return BeFunky.throwError(`Invalid media type: ${e}`);if(!a.hasOwnProperty(t))return BeFunky.throwError(`Invalid media source: ${t}`);let s=new BFN.UserActionVO;s.eventID="media_opened",s.eventObject={mediaType:r[e],mediaOpenLocation:a[t]},s.peopleObject={lastMediaOpenDate:window.bfn_mp?window.bfn_mp.getISODate():"n/a",lifetimeMediaOpenCount:1,lifetimeImagesOpenCount:e==="project"?0:1},s.track()}saveToGoogleDrive(e,t){return new Promise((r,a)=>{this.tmpCallback=s=>{if(s)return a(s);r()},this.tmpInternalCallback=()=>{BFN.BlobUtils.blobToBase64(e).then(s=>{s=s.replace(/^data:[a-z/]+;base64,/,""),window.insertDriveFile(s,BFN.UploadSaveShareManager.getValidFilename(t,e))}).catch(s=>{this.tmpCallback(s),this.tmpCallback=null})},window.driveInmediateDisplay(!0)})}saveToDropBox(e,t){let r=BFN.UploadSaveShareManager.getValidFilename(t,e),a=BFN.AppModel.sectionValue("SAVE","SAVE_COLLAGE","SAVE_DESIGNER");return BFN.DropboxManager.saveImage(e,r).then(()=>{BFN.BfnService.track("CREATE",a,"DROP_BOX")}).catch(s=>{throw s!=="cancelled_by_user"&&BeFunky.reportWarning(`Dropbox save failed: ${s}`,s),s||"unknown_dropbox_error"})}isUrl(e){return/^(ftp|http|https):\/\/(\w+:?\w*@)?(\S+)(:[0-9]+)?(\/|\/([\w#!:.?+=&%@\-/]))?/.test(e)}async getImageBlobOrSVG(e){let t;if(e.indexedDBKey)try{let s=await BFN.IndexedDB.get(e.indexedDBKey);if(s instanceof Blob)return{blob:s};if(typeof s=="string"&&e.isSVG)return{svgString:s};if(typeof s=="string")return{blob:BFN.BlobUtils.base64ToBlob(s)}}catch(s){t=s,BeFunky.logWarning(`Failed to get image from IndexedDB: ${s.name||s}`,s,e.id)}else t="missing_indexeddbkey";if(!e.imageURL)throw t;let r=e.imageURL;BFN.ImageLibraryService.trackImageDownload(BFN.getImageType(e.id),r);try{let s=await BFN.RequestUtils.getImageBlobWithCorsFallback(r);return e.isPattern&&(s=await BFN.CollageMakerPatternManager.doubleBlobDimensions(e,s)),e.isSVG?new Promise((o,n)=>BFN.BlobUtils.blobToText(s,({error:l,text:c})=>{if(l)return n(l);let h=BFN.SVGManager.sanitizeSVG(c);return h?o({svgString:h}):n("failed_to_parse_svg")})):{blob:s}}catch(s){if(BFN.getImageType(e.id)==="pixabay")return a();throw s}async function a(){BeFunky.logWarning("Failed to load expired Pixabay full-size image. Trying again...");try{let s=await BFN.ImageLibraryService.getPixabayImageById(e.id.replace("pixabay_",""));return e.imageURL=s.imageURL,e.thumbURL=s.thumbURL,requestIdleCallback(()=>BFN.ImageLibraryManager.updateImageStore()),{blob:await BFN.RequestUtils.getImageBlobWithCorsFallback(e.imageURL)}}catch(s){throw BeFunky.reportWarning("Unable to get updated Pixabay image",s),s}}}async getTexturesForMenuImageVOs(e,{saveAssetsSectionID:t}={}){let r=e.some(o=>!o.hasUsableTexture()&&!o.indexedDBKey);BeFunky.showLoadScreen({message:r?"downloading":void 0});let a=[];if(await Promise.all(e.map(async o=>{try{await s(o)}catch(n){let l=BFN.getImageType(o.id);l==="befunky_photo"&&!BeFunky.isLoggedIn()?a.push(o):BeFunky.reportWarning(`Unable to get texture for ${l} MenuImageVO: ${n&&n.name||n}`,n,o)}})),BeFunky.hideLoadScreen(),a.length)return new Promise(o=>{BeFunky.confirm("sign_in_saved_images",{onCancel:o,confirmText:"sign_in",onConfirm:()=>{BeFunky.openLoginPanel("SIGNIN",()=>this.getTexturesForMenuImageVOs(a),o)}})});async function s(o){if(o.hasUsableTexture())return;let{blob:n,svgString:l}=await BFN.BfnService.getImageBlobOrSVG(o),c=n?"image":"svg",h=n||l;if(t&&(await BFN.ProjectService.localAssetExists(c,o.id)||await BFN.ProjectService.setLocalAsset(t,c,o.id,h)),!o.hasUsableTexture())return c==="image"?new Promise((u,d)=>{BFN.TextureUtils.blobOrBase64ToTexture(n,({error:m,texture:p})=>{if(m)return d(m);o.imageTexture=p,u()})}):new Promise((u,d)=>{BFN.TextureUtils.svgStringToTexture(l,({error:m,texture:p})=>{if(m)return d(m);o.imageTexture=p,u()},{textureSize:BFN.getImageType(o.id)==="graphic"?BFN.graphicPlaceholderTextureSize:BFN.maxImageSizeLayer})})}}get userLoggedIn(){return BeFunky.isLoggedIn()}get userIsPlus(){return Boolean(BeFunky.isPlus()||BeFunky.isPaywallEnabled()||BeFunky.isInDemoMode())}};BFN.SingletonQueue.add(()=>{BFN.BfnService=new Vc});var Uc=class{constructor(){this.init()}init(){this.helpCluesPromise=null}fetchHelpClues(){return this.helpCluesPromise?this.helpCluesPromise:(this.helpCluesPromise=BeFunky.requestAPI("get/help-clues").then(({data:e})=>e).catch(e=>{this.helpCluesPromise=null,e!=="request_failed"&&BeFunky.throwError(`Failed to fetch help clues: ${e.name||e}`,e)}),this.helpCluesPromise)}async fetchArticleContent(e){let{data:{zendesk_article:t,vimeo_images:r}}=await BeFunky.requestAPI(`get/zendesk/article/${e}`);return{article:t,vimeoImages:r}}async fetchCategories(){let{data:e}=await BeFunky.requestAPI("get/zendesk/categories");return e}async fetchSections(){let{data:e}=await BeFunky.requestAPI("get/zendesk/sections");return e}async fetchArticles(){let{data:e}=await BeFunky.requestAPI("get/zendesk/articles");return e}async fetchSearchResults(e){let{data:t}=await BeFunky.requestAPI(`get/zendesk/search/${encodeURIComponent(e)}`);return t}};BFN.SingletonQueue.add(()=>{BFN.HelpClueService=new Uc});var Xc=ca(Hc()),zc=class{constructor(){this.init()}init(){this.imagesPerPage=50,this.shuffleSeed=Math.random(),this.stockImageCache={},this.stockImagePageCounts={},this.downloadedImageUrls=[]}deleteBeFunkyPhoto(e,t){return BFN.BfnService.userLoggedIn?BeFunky.requestAPI("photo/delete-image",{imgIds:e},t).then(r=>{if(r.data!=="success")throw"invalid_response";return r}):Promise.reject("not_logged_in")}getStockImages(e=1,t){return new Promise((a,s)=>{if([/black leaders?/i,/black power/i].find(d=>d.test(t)))return s("no_relevant_results");let n={pixabay:this.getPixabayImages.bind(this),pexels:this.getPexelsImages.bind(this)},l=Object.keys(n),c=[],h=25;u=u.bind(this),r=r.bind(this),this.stockImagePageCounts[t]=this.stockImagePageCounts[t]||{},l.forEach(d=>{let m=this.stockImagePageCounts[t];if(m.hasOwnProperty(d)&&m[d]<e)return u({error:"no_results"});let p=[d,e,h,t].join("|");(()=>this.stockImageCache[p]?Promise.resolve(this.stockImageCache[p]):n[d]({page:e,imagesPerPage:h,keywords:t}))().then(f=>{f.hasOwnProperty("totalPages")&&(m[d]=f.totalPages),this.stockImageCache[p]=f,u(f)},f=>{f==="no_results"&&(m[d]=0),u({error:f})})});function u(d){if(c.push(d),c.length<l.length)return;let m=c.map(f=>f.error).filter(Boolean);if(m.length===l.length){let f="no_results";return m.every(v=>v!=="no_results")&&(f=m[0]),s(f)}let p=[],g=0;c.filter(f=>!f.error).forEach(({data:f,totalPages:v})=>{p=p.concat(f),g=Math.max(g,v)}),a({data:r(p),totalPages:g})}});function r(a){return a.sort((s,o)=>s.imageURL>o.imageURL),Xc.default.shuffle(a,this.shuffleSeed),a}}async getPixabayImages({page:e=1,imagesPerPage:t,keywords:r}){r==="featured"&&(r="urban");let{data:a}=await BeFunky.requestAPI("get/search-pixabay",{page_number:e,per_page:t,search_query:r},{responseHeadersHandler:this.trackRequestUnlessCached(()=>BFN.BfnService.track("EXTERNAL","STOCK_IMAGE_API_REQUEST","Pixabay Search"))});if(!Array.isArray(a.hits)||typeof a.totalHits!="number")throw"invalid_response";if(a.hits.length===0)throw"no_results";return{data:a.hits.map(s=>this.createPixabayMenuImageVO(s)),totalImages:a.totalHits,totalPages:Math.ceil(a.totalHits/t)}}createPixabayMenuImageVO(e){let t=new BFN.MenuImageVO;t.createId("pixabay",e.id_hash);let r=e.imageWidth/e.imageHeight;t.imageURL=l(e.fullHDURL?e.fullHDURL:e.largeImageURL);let a=e.fullHDURL?1920:1280;t.imageWidth=r>=1?a:Math.floor(a*r),t.imageHeight=r<=1?a:Math.floor(a/r);let s=BFN.getExtension(t.imageURL.split("?")[0]);t.isTransparent=s==="png";let o=180;return t.thumbURL=l(e.webformatURL.replace("_640",`_${o}`)),t.thumbWidth=Math.floor(o*r),t.thumbHeight=o,t.getImageURL=c=>n(e.webformatURL,c),t.author=e.user,t.authorURL=`https://pixabay.com/en/users/${e.user}-${e.user_id}/`,t;function n(c,h){let u=[150,180,240,340,480,640],m=h/r*(BeFunky.isRetina()?1.5:1),p=u.find(g=>g>m)||640;return c.replace("_640",`_${p}`)}function l(c){return c.startsWith("http://")&&(c=c.replace("http://","https://")),`${c}?permalink=befunky`}}async getPixabayImageById(e){let{data:t}=await BeFunky.requestAPI("get/pixabay-image-by-id",{image_id:e},{responseHeadersHandler:this.trackRequestUnlessCached(()=>BFN.BfnService.track("EXTERNAL","STOCK_IMAGE_API_REQUEST","Pixabay Image Metadata"))});if(!t.id_hash)throw"invalid_response";return this.createPixabayMenuImageVO(t)}async getPexelsImages({page:e=1,imagesPerPage:t,keywords:r}){r==="featured"&&(r="outdoors");let{data:a}=await BeFunky.requestAPI("get/search-pexels",{page_number:e,per_page:t,search_query:r},{responseHeadersHandler:this.trackRequestUnlessCached(()=>BFN.BfnService.track("EXTERNAL","STOCK_IMAGE_API_REQUEST","Pexels Search"))});if(!Array.isArray(a.photos)||typeof a.total_results!="number")throw"invalid_response";if(a.photos.length===0)throw"no_results";return{data:a.photos.map(s),totalImages:a.total_results,totalPages:Math.ceil(a.total_results/t)};function s(o){let n=new BFN.MenuImageVO;n.createId("pexels",o.id),n.imageURL=o.src.original;let l=o.width/o.height;return n.thumbURL=o.src.medium,n.thumbWidth=Math.round(350*l),n.thumbHeight=350,n.author=o.photographer,n.authorURL=o.photographer_url,n}}trackRequestUnlessCached(e){let t=new Date(Math.floor(Date.now()/1e3)*1e3);return r=>{parseInt(r.age)===0&&(!r.date||t>new Date(r.date)||e())}}trackImageDownload(e,t){if(!["unsplash","pexels","pixabay"].includes(e)||this.downloadedImageUrls.includes(t))return;this.downloadedImageUrls.push(t),BFN.BfnService.track("EXTERNAL","STOCK_IMAGE_DOWNLOAD",`${r(e)} Image`);function r(a){return a.charAt(0).toUpperCase()+a.slice(1).toLowerCase()}}};BFN.SingletonQueue.add(()=>{BFN.ImageLibraryService=new zc});var Wc=class{constructor(){this.init()}init(){this.fetchingTagsPromise=null,this.fetchingEditorsChoicePromise=null}getTags(){return this.fetchingTagsPromise?this.fetchingTagsPromise:(this.fetchingTagsPromise=BeFunky.requestAPI("get/photo/all-graphic-tags").then(({data:e})=>{if(!Array.isArray(e.items))throw"invalid_response";return e.items.includes("all_items")||e.items.push("all_items"),this.tags=e.items,e.items}).catch(e=>(this.fetchingTagsPromise=null,Promise.reject(e))),this.fetchingTagsPromise)}getGraphics(e,t="all",r=1,a=100,s=!1){e=e.toLowerCase().trim().replace(/\s+/g,"_"),e.length===0&&(e="all_items");let o=this.tags.includes(e),n={t:e,isq:o?1:0,v:t,start:(r-1)*100,end:a};s===!0&&(n.rev_0=1);let l=BeFunky.requestAPI("photo/search-graphics",n),c=l.then(h=>{let{items:u}=h.data;if(!Array.isArray(u))throw"invalid_response";if(!u.length)throw"no_results";let d=this.graphicDataToMenuImageVO(u).filter((m,p,g)=>g.findIndex(({id:f})=>f===m.id)===p);return d.length!==u.length&&BeFunky.logError(`Ignoring ${u.length-d.length} duplicate graphics`),d.sort((m,p)=>{let g=m.isPlus?1:0,f=p.isPlus?1:0;return g-f}),d});return c.request=l.request,c}getEditorsChoiceGraphics(){return this.fetchingEditorsChoicePromise?this.fetchingEditorsChoicePromise:(this.fetchingEditorsChoicePromise=BeFunky.requestAPI("get/photo/editors-choice-graphics").then(({data:e})=>{if(typeof e!="object")throw"invalid_response";return e}).catch(e=>(e!=="request_failed"&&BeFunky.throwError("Invalid data received from graphics editors choice JSON",e),this.fetchingEditorsChoicePromise=null,Promise.reject(e))),this.fetchingEditorsChoicePromise)}graphicDataToMenuImageVO(e){let t=BeFunky.isRetina();return e.map(({f:r,g:a,t:s,rev:o,v:n})=>{let l=parseInt(r)!==1,c=a.split(".")[0],u=BFN.getExtension(a)==="svg",d=new BFN.MenuImageVO;d.createId("graphic",c);let m=`${BFN.goodiesUrl+BFN.goodiesAssetsFolder.original}${a}`;d.isTransparent=!0,d.isSVG=u,d.indexedDBKey=u?`svg__${d.id}`:`image__${d.id}`,d.isPlus=l,d.trackingID=`${s}_${c}`,d.style=n,d.isReviewed=o===1,d.isGraphic=!0;let p=t?200:130;return u?(d.thumbURL=m,d.imageURL=m):(d.thumbURL=`${m}?w=${p}&h=${p}&fit=bounds`,d.imageURL=`${m}?io=off`),d})}};BFN.SingletonQueue.add(()=>{BFN.GraphicLibraryService=new Wc});var $c=class{constructor(){this.init()}init(){this.initDefaultValues()}initDefaultValues(){this.localAssetIDs=null,this.localAssetSections=["editor","collage","designer","imagemanager","graphicmanager"],this.localAssetTypes=["image","svg"],this.getLocalAssetIDs=new Promise(e=>{BFN.IndexedDB.get("options__localAssetIDs").then(t=>{if(!t||typeof t!="object")throw"";this.localAssetIDs=t}).catch(()=>{this.localAssetIDs={}}).then(e)}),this.getLocalAssetIDs.then(()=>{BFN.IndexedDB.keys().then(e=>{e.filter(t=>!!this.localAssetTypes.find(r=>t.startsWith(`${r}__`))).filter(t=>!Array.isArray(this.localAssetIDs[t])).forEach(t=>{BFN.IndexedDB.delete(t)})}).catch(BeFunky.logError)}),this.persistLocalAssetIDs=BeFunky.debounce(this.persistLocalAssetIDs.bind(this),100)}getLocalAsset(e,t){return this.localAssetTypes.includes(e)?typeof t!="string"||!t.includes("_")?Promise.reject("Invalid key"):new Promise((r,a)=>{let s=`${e}__${t}`;BFN.IndexedDB.get(s).then(o=>{if(!o)throw`Local asset ${s} could not be found in IndexedDB`;r(o)}).catch(a)}):Promise.reject("Invalid type")}localAssetExists(e,t){return this.getLocalAssetIDs.then(()=>Array.isArray(this.localAssetIDs[`${e}__${t}`])?this.getLocalAsset(e,t).then(()=>!0).catch(()=>!1):!1)}setLocalAsset(e,t,r,a,s=!1){return this.getLocalAssetIDs.then(()=>{if(!this.localAssetSections.includes(e))throw"Invalid sectionID";if(!this.localAssetTypes.includes(t))throw"Invalid type";if(typeof r!="string"||!r.includes("_"))throw"Invalid key";if(!s&&typeof a!="string"&&!(a instanceof Blob)&&!this.isPixelObject(a))throw`Invalid value: ${BeFunky.getType(a)}`;let o=`${t}__${r}`,n=this.localAssetIDs[o];if(Array.isArray(n)?n.includes(e)||(n.push(e),this.persistLocalAssetIDs()):(this.localAssetIDs[o]=[e],this.persistLocalAssetIDs()),!s)return BFN.IndexedDB.set(o,a)})}isPixelObject(e){return e&&e.pixels instanceof Uint8Array&&typeof e.width=="number"&&typeof e.height=="number"&&typeof e.isTransparent=="boolean"}removeLocalAsset(e,t,r){return this.getLocalAssetIDs.then(()=>{if(!this.localAssetSections.includes(e))throw"Invalid sectionID";if(!this.localAssetTypes.includes(t))throw"Invalid type";if(typeof r!="string"||!r.includes("_"))throw"Invalid key";let a=`${t}__${r}`,s=this.localAssetIDs[a];Array.isArray(s)&&s.includes(e)&&(s.splice(s.indexOf(e),1),s.length||(delete this.localAssetIDs[a],BFN.IndexedDB.delete(a)),this.persistLocalAssetIDs())})}clearLocalAssets(e,t=[]){return this.getLocalAssetIDs.then(()=>{if(!this.localAssetSections.includes(e)&&e!=="all")return Promise.reject("Invalid sectionID");Object.keys(this.localAssetIDs).filter(r=>!t.includes(r)).forEach(r=>{let a=this.localAssetIDs[r],s=a.indexOf(e);s!==-1?a.splice(s,1):e==="all"&&a.splice(0),a.length||(delete this.localAssetIDs[r],BFN.IndexedDB.delete(r))}),this.persistLocalAssetIDs()})}persistLocalAssetIDs(){BFN.IndexedDB.set("options__localAssetIDs",this.localAssetIDs)}getLocalProject(e,{logLevel:t="console",showLoadScreen:r=!1,excludeAssets:a=!1,excludeThumbnail:s=!1,fallbackToCanvas:o=!0,convertPixelObjectToBlob:n=!0}={}){return new Promise((l,c)=>{if(!["editor","collage","designer"].includes(e))return c("Invalid sectionID");let h=!1;r&&BeFunky.showLoadScreen({onCancel:()=>{h=!0,BeFunky.logError(`User cancelled ${e} project load`),c("Cancelled by user")}});let u=BFN.IndexedDB.get(`project__${e}`),d=e==="editor"?this.getLocalAsset("image","editor_canvas_image").then(p=>n&&this.isPixelObject(p)?BFN.BlobUtils.pixelsToBlob({pixels:p.pixels,mimeType:p.isTransparent?"image/png":"image/jpeg",width:p.width,height:p.height}):p).then(p=>{if(p instanceof Blob&&!h){let g=p;return new Promise(f=>{BFN.BlobUtils.blobToArrayBuffer(g,({error:v})=>{if(!v)return f(g);BeFunky.logError("Unable to read main image blob from IndexedDB. Extracting from texture..."),BFN.PhotoEditorModel.getCurrentTextureBlob(!1).then(T=>f(T),T=>{BeFunky.logError("Unable to extract Blob from texture:",T),f("invalid_editor_image_blob")})})})}return p}).catch(()=>{}):Promise.resolve(),m=s?Promise.resolve(null):this.getLocalAsset("image",`${e}_thumb`).catch(()=>null);Promise.all([u,m,d]).then(([p,g,f])=>{if(!h){if(!p)throw"no_autosave_project";if(e==="editor"&&f==="invalid_editor_image_blob")throw"invalid_editor_image_blob";if(e==="editor"&&(p.editorImageBase64=p.editorImageBase64||f),e==="editor"&&!p.editorImageBase64)throw"missing_editor_image_blob";if(!BFN.ProjectManager.validateProject(p,{logLevel:t}))throw`Saved ${e} project is invalid`;if(s?p.thumbBase64=null:(p.thumbBase64=p.thumbBase64||g,!p.thumbBase64&&!p._wasReset&&BeFunky.logError(`${e} project thumbnail was not found in IndexedDB`)),a)return r&&BeFunky.hideLoadScreen(),l(p);BFN.ProjectService.addImagesToProject(p,{showLoadScreen:r,fallbackToCanvas:o}).then(l)}}).catch(p=>{r&&BeFunky.hideLoadScreen(),c(p)})})}async getAutosavedProjectThumbnail(e){if(!["editor","collage","designer"].includes(e))throw"invalid_section_id";try{let a=await this.getLocalAsset("image",`${e}_thumb`);if(r(a))return{image:a}}catch(a){}if(BFN.ProjectManager.checkThumbnailAvailability(e).isAvailable)try{let a=await BFN.ProjectManager.createThumbnail(e,"blob",!1);if(r(a))return{image:a}}catch(a){}let t;try{if(t=await BFN.IndexedDB.get(`project__${e}`),t&&r(t.thumbBase64))return{image:t.thumbBase64}}catch(a){}if(t&&t._wasReset&&t.projectWidth&&t.projectHeight)return{aspectRatio:t.projectWidth/t.projectHeight};if(!BFN.openedSections.includes(e)&&!t)throw"no_autosave_project_found";throw BeFunky.reportWarning(`Unable to get autosave thumbnail for ${e}`,BFN.ProjectManager.checkThumbnailAvailability(e),t),"no_autosave_thumbnail_found";function r(a){return a instanceof Blob||typeof a=="string"&&a.startsWith("data:image")}}addImagesToProject(e,{showLoadScreen:t=!1,fallbackToCanvas:r=!0}={}){return new Promise(a=>{let s=!1;t&&BeFunky.showLoadScreen({message:"loading_project_assets",onCancel:()=>{s=!0,BeFunky.logError(`User cancelled ${e.section} project asset loading`),a(e)}});let o=0,n=0,{imageDataKeys:l,svgDataKeys:c}=e;e.imageDataKeys=[],e.svgDataKeys=[];let h=l.map(d=>BFN.ProjectService.getLocalAsset("image",d).catch(m=>{if(o++,BeFunky.logError(`Unable to fetch project image blob ${d} from IndexedDB:`,m),!s&&!!r)return this.getAssetBlobFromTextureOnCanvas(e.section,d).then(p=>(n++,console.log(`Extracted project image blob ${d} from canvas`),p),p=>{BeFunky.logError(`Unable to extract project image blob ${d} from canvas:`,p)})}).then(m=>{s||!m||(e.imageData[d]=m)})),u=c.map(d=>BFN.ProjectService.getLocalAsset("svg",d).then(m=>{s||(e.svgData[d]=m)}).catch(m=>{o++,BeFunky.logError(`Unable to fetch project svg string ${d} from IndexedDB:`,m)}));Promise.all([...h,...u]).then(()=>{if(o)if(o===n)BeFunky.throwError("Recovered one or more project images from canvas",{errorCount:o,recoveredCount:n});else{let d=BFN.IndexedDB.disabledReason?"memory":"IndexedDB";BeFunky.throwError(`Unable to fetch one or more project images from ${d}${r?" w/ canvas fallback":""}`,{errorCount:o,recoveredCount:n})}!s&&t&&BeFunky.hideLoadScreen(),a(e)})})}saveLocalProject(e,t){return["editor","collage","designer"].includes(e)?BFN.IndexedDB.set(`project__${e}`,t):Promise.reject("Invalid sectionID")}removeLocalProject(e){return["editor","collage","designer"].includes(e)?BFN.IndexedDB.delete(`project__${e}`):Promise.reject("Invalid sectionID")}getAssetBlobFromTextureOnCanvas(e,t){let a={editor:BFN.PhotoEditorCanvas,collage:BFN.CollageMakerCanvas,designer:BFN.DesignerCanvas}[e].transformLayer.children,s=e==="collage"?BFN.CollageMakerCanvasPhotoGrid.photoGrid.gridChildren:[],o=a.filter(m=>m instanceof BFN.TransformItem).find(m=>m.type==="frame_texture"&&m.projectItemVO.maskImageID===t||m.type==="texture"&&m.projectItemVO.imageID===t),n=s.find(m=>m.projectItemVO.gridCellImageID===t);if(!o&&!n)return Promise.reject("No matching Transform Item or Grid Cell");let l=o?o.itemContent.texture:n.childContent.image.texture,{baseTexture:c}=l||{};if(!c)return Promise.reject(`No baseTexture in ${o?"Transform Item":"Grid Cell"}`);let h=new PIXI.Texture(c),u=l.determineTransparency(),d=BeFunky.isFirefox||u?.99:1;return console.log("Got texture for asset",t,`${c.width} x ${c.height}`,{isTransparent:u}),setTimeout(()=>{h.destroyGC(!1)},0),BFN.TextureUtils.textureToBlob(h,{isTransparent:u,quality:d})}async saveLocalAssetForMenuImageVO(e,t){let r=e.isSVG?"svg":"image";if(await this.localAssetExists(r,e.id))return;let{blob:s,svgString:o}=await BFN.BfnService.getImageBlobOrSVG(e);return this.setLocalAsset(t,r,e.id,s||o)}};BFN.SingletonQueue.add(()=>{BFN.ProjectService=new $c});var jc=class{constructor(){this.init()}init(){this.fetchingTextPatchesPromise=null}getTextPatches(){return this.fetchingTextPatchesPromise?this.fetchingTextPatchesPromise:(this.fetchingTextPatchesPromise=BeFunky.requestAPI("get/photo/text-patches").then(({data:e})=>{if(!Array.isArray(e.items))throw"invalid_response";return e.items}).catch(e=>(this.fetchingTextPatchesPromise=null,Promise.reject(e))),this.fetchingTextPatchesPromise)}fetchBfp(e,{showLoadScreen:t=!0}={}){return new Promise((r,a)=>{console.log("Downloading BFP",e);let s=d=>{t&&BeFunky.hideLoadScreen(),r(d)},o=d=>{t&&BeFunky.hideLoadScreen(),a(d)},n=!1,l,c=()=>{o("cancelled_by_user"),n=!0,l.abort()},h=!1;setTimeout(()=>{n||(h=!0)},200),t&&BeFunky.showLoadScreen({onCancel:c,message:"downloading"});let u={responseType:"json",downloadProgressHandler:(d,m)=>{!h||!t||BeFunky.updateLoadScreenProgress("downloading",100*d/m)}};l=BeFunky.request(e,u,({response:d,error:m})=>{if(!n){if(m)return o(m);typeof d=="object"&&d.id&&d.width&&d.height?s(d):o("invalid_bfp")}})})}};BFN.SingletonQueue.add(()=>{BFN.PatchService=new jc});var Yc=class{constructor(){this.init()}init(){}resetProjectData(){BeFunky.SavedProjectFetcher.resetProjectData()}getFirst100Projects(){return BeFunky.SavedProjectFetcher.getFirst100Projects()}getAllProjects(){return BeFunky.SavedProjectFetcher.getAllProjects()}searchProjects(e){return BeFunky.SavedProjectFetcher.searchProjects(e)}fetchBFD(e,{showLoadScreen:t=!0}={}){return new Promise((r,a)=>{console.log("Downloading BFD",e);let s=d=>{t&&BeFunky.hideLoadScreen(),r(d)},o=d=>{t&&BeFunky.hideLoadScreen(),a(d)},n=!1,l,c=()=>{o("cancelled_by_user"),n=!0,l.abort()},h=!1;setTimeout(()=>{n||(h=!0)},200),t&&BeFunky.showLoadScreen({onCancel:c,message:"downloading"});let u={responseType:"blob",downloadProgressHandler:(d,m)=>{!h||!t||BeFunky.updateLoadScreenProgress("downloading",100*d/m)}};l=BeFunky.request(e,u,({response:d,error:m})=>{if(!n){if(m)return o(m);this.decodeProjectFile(d,({data:p,error:g})=>{if(g)return o(g);BFN.ObjectCompressor.decompress(p).then(f=>{if(typeof f!="object"||!f)throw"invalid_bfd";s(f)}).catch(o)})}})})}decodeProjectFile(e,t){BFN.BlobUtils.blobToText(e,({text:r,error:a})=>t(a?{error:a}:{data:r}))}saveBfdFileToBeFunky({bfdBlob:e,thumbnailBlob:t,uploadProgressHandler:r,date:a,projectObject:s},o){if(!BFN.BfnService.userLoggedIn)return o({error:"not_logged_in"});let n={bucket:"befunkydesigner",content_type:"text/plain",blob:e};window.DirectUPL.upload(c=>{if(!c||!c.url||!c.s3_name)return o({error:"invalid_response"});let h=c.s3_name,u=`${h}_thumb.${t.type==="image/png"?"png":"jpg"}`,d={bucket:"befunkydesigner",content_type:t.type,blob:t,filename:u};window.DirectUPL.upload(m=>{if(!m||!m.url||!m.s3_name)return o({error:"invalid_response"});let p=s.transformLabels.map(v=>v.labelText).map(v=>v.replace(/\s+/g," ").trim()).filter(v=>v&&!BFN.FabricManager.isDefaultText(v)).join(" ").normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[^\x20-\x7E]/g,"").slice(0,1e3),g=v=>btoa(encodeURIComponent(v)),f={bfdname:h,thumbname:u,filename:g(s.filename||"BeFunky-project"),content:g(p),p_type:s.section,source_template:s.sourceTemplateID||"",width:s.projectWidth,height:s.projectHeight,size:Math.round(e.size/1024),folder:s.folder||""};a&&(f.creation_date=a),BeFunky.requestAPI("photo/projects/add",f).then(({data:v})=>{if(v!=="success")throw"invalid_response";o({data:"success"})}).catch(v=>{o({error:v})})},d)},n);let l=typeof window.DirectUPL!="undefined"&&window.DirectUPL!==null?window.DirectUPL.uploadReq:void 0;BeFunky.addProgressHandler(l,r,!0)}};BFN.SingletonQueue.add(()=>{BFN.SavedProjectService=new Yc});var qc=class{constructor(){this.init()}init(){}uploadImage(e,t){if(!BFN.BfnService.userLoggedIn)return t({error:"not_logged_in"});let r="bfnwatermark",a=()=>{let s=`${BeFunky.Params.uplUri}/restupload/bfns3uploader.bfn`,o={method:"POST",body:BeFunky.createFormData({image_type:e.type,bucket:r,image:e,CSRFtoken:getCsToken()})};BeFunky.request(s,o,({response:n,error:l})=>{if(l)return t({error:l});n&&n.url&&n.s3_name?t({url:n.url,name:n.s3_name}):t({error:"invalid_response"})})};typeof window.DirectUPL!="undefined"?window.DirectUPL.upload(s=>{s&&s.url&&s.s3_name?t({url:s.url,name:s.s3_name}):a()},{bucket:r,content_type:e.type,blob:e}):a()}deleteImage(e,t){t&&t({success:!0,url:e})}};BFN.SingletonQueue.add(()=>{BFN.BfnWatermarkService=new qc});var Kc=class{constructor(){this.init()}init(){this.tags=[],this.fetchingTagsPromise=null}getTags(){return Array.isArray(this.tags)&&this.tags.length?Promise.resolve(this.tags):this.fetchingTagsPromise?this.fetchingTagsPromise:(this.fetchingTagsPromise=BeFunky.requestAPI("get/photo/all-designer-template-tags").then(({data:e})=>{if(!Array.isArray(e.items))throw"invalid_response";return this.tags=e.items,e.items}).catch(e=>(this.fetchingTagsPromise=null,Promise.reject(e))),this.fetchingTagsPromise)}getTemplates(e,t=1,r=100,a=!1){if(typeof e!="string")return Promise.reject("invalid_tag");e=e.toLowerCase().trim().replace(/\s+/g,"_");let s=this.tags.includes(e),o={t:e,isq:s?1:0,start:(t-1)*100,end:r,all_templates:a?1:0};return BeFunky.requestAPI("photo/search-designer-templates",o).then(n=>{let{items:l}=n.data;if(!Array.isArray(l))throw"invalid_response";if(!l.length)throw"no_results";return l.map(this.cleanupTemplateObject).filter(c=>c.hasValidDimensions)})}getTemplate(e){return BeFunky.requestAPI("photo/get-designer-template",{id:e}).then(({data:t})=>{if(!Array.isArray(t.items))throw"invalid_response";if(!t.items.length)throw"no_results";let r=t.items,a=["blank","dim","f","n","rev","tmp"],s=[];r.length>1&&r.slice(1).forEach(n=>{a.forEach(l=>{n[l]!==r[0][l]&&s.push(l)})}),s.length&&BeFunky.throwError(`Invalid tag data for template ${e}: Mismatched ${s.unique().join(", ")}`);let o=this.cleanupTemplateObject(r[0]);return o.tags=r.map(n=>n.t),o})}getEditorsChoiceTemplates(){return BeFunky.requestAPI("get/photo/editors-choice-templates").then(e=>{if(!Array.isArray(e.data.tags))throw"invalid_response";let{tags:t}=e.data;return t.forEach(r=>{r.items=r.items.map(this.cleanupTemplateObject)}),t}).catch(e=>(BeFunky.throwError("Invalid data received from editors choice JSON",e),[]))}cleanupTemplateObject({f:e,tmp:t,n:r,dim:a,blank:s,t:o,rev:n,version:l,creation:c}){let h=Boolean(BFN.DesignerTemplateManager.parseDimensions(a));return h||BeFunky.throwError(`Designer template has invalid dimensions: ${t} -- ${a}`),{id:t,isPlus:parseInt(e)!==1,isBlank:parseInt(s)>0,isReviewed:parseInt(n)===1,tagID:o,version:l,displayName:r,dimensions:a,hasValidDimensions:h,creationDate:c}}templateObjectsToMenuImageVOs(e){let t=BeFunky.isRetina();return e.map(({id:r,isPlus:a,isBlank:s,isReviewed:o,tagID:n,version:l,displayName:c,dimensions:h,creationDate:u})=>{let d=new BFN.MenuImageVO;return d.createId("designer_template",r),d.isBlank=s,d.isReviewed=o,d.version=l,d.displayName=c,d.dimensions=h,d.projectFileName=`${r}.bfd`,d.groupID=u,d.setObject({isPlus:a,trackingID:`${n}_${r}`}),Object.assign(d,BFN.DesignerTemplateManager.getTemplateImages({id:r,isBlank:s,dimensions:h,version:l,isRetina:t})),d})}};BFN.SingletonQueue.add(()=>{BFN.DesignerTemplateService=new Kc});var Jc={CONST:{NOT_SUPPORTED:0,hdConstraints:{video:{width:{exact:1280},height:{exact:720}}},vgaConstraints:{video:{width:{exact:640},height:{exact:360}}},hdMandatory:{video:{width:1280,height:720}}}};BFN.isWebCamSupported=()=>!!(navigator.getUserMedia||navigator.mozGetUserMedia||navigator.mediaDevices&&navigator.mediaDevices.getUserMedia);var Qc=class{constructor(e,t,r,a){this.supported=!1,this.errCallback=t,this.videoElement=e,this.constraints=a||Jc.CONST.hdConstraints,this.isAudio=r||!1,this.localMediStream=null,this.init()}init(){this.supported=BFN.isWebCamSupported();let e=this.constraints;if(e.audio=this.isAudio,this.supported){let t=r=>{navigator.mediaDevices.getUserMedia(e).then(a=>this.handleStream(a)).catch(()=>{r?(e=Jc.CONST.hdMandatory,e.audio=!1,t()):this.errCallback("not_available")})};t(!0)}}handleStream(e){if(this.localMediStream=e,navigator.mozGetUserMedia)try{this.videoElement.mozSrcObject=this.localMediStream,this.videoElement.srcObject=this.localMediStream}catch(t){}else try{this.videoElement.srcObject=this.localMediStream}catch(t){try{let r=URL.createObjectURL(this.localMediStream);this.videoElement.src=r}catch(r){}}this.videoElement.onloadedmetadata=()=>{this.start()}}getSnapshot(e){let t=document.createElement("canvas");t.width=this.constraints.video.width.exact,t.height=this.constraints.video.height.exact;let r=t.getContext("2d");r.drawImage(this.videoElement,0,0),t.toBlob(a=>{r=null,t=null,e(a)},"image/webp")}stop(e){try{this.videoElement.pause()}catch(t){}if(!e){try{this.localMediStream.getTracks().forEach(r=>{r.stop()})}catch(t){try{this.localMediStream.getVideoTracks()[0].stop()}catch(r){try{this.localMediStream.stop()}catch(a){}}}try{URL.revokeObjectURL(this.videoElement.src),this.videoElement.src="",this.videoElement.srcObject=null}catch(t){}}}start(){try{this.videoElement.play()}catch(e){}}};BFN.WebcamRecorder=Qc;var Zc=class{isJSONString(e){if(typeof e!="string")return!1;try{JSON.parse(e)}catch(t){return!1}return!0}compress(e){return new Promise(t=>{let r=JSON.stringify(e);t(r)})}decompress(e,t=!0){return new Promise((r,a)=>{if(typeof e!="string")return a("not_a_string");if(t)try{let s=JSON.parse(e);return r(s)}catch(s){}try{e=atob(e)}catch(s){}r(t?JSON.parse(e):e)})}};BFN.SingletonQueue.add(()=>{BFN.ObjectCompressor=new Zc});var eh=class{constructor(){this.init()}init(){this.initDefaultValues()}initDefaultValues(){this.inFlightMaskImageURLs=[],this.swappedFonts={}}objectToProjectVO(e){return new Promise((t,r)=>{e.version==="1.0"?this.prepareV1(e).then(a=>BFN.FlashProjectParser.parseFlashProject(a,t)):this.prepareV2(e).then(a=>BFN.ProjectManager.getProjectVO(a)).catch(r).then(t)})}prepareV1(e,{isSourceTemplate:t=!1}={}){t?(this.swappedFonts={},console.log("Loading Flash source template")):console.log("Loading BFD v1 saved from Flash");let r=!1;t||BeFunky.showLoadScreen({message:"loading_project_assets",onCancel:()=>{r=!0,this.abortPrepare()}});let a=[...e.transformLabelStates.map(this.translateLabelState.bind(this)),this.fetchDesignerElementSvgData(e),this.decodeTemplateElementSvgData(e),this.fetchMaskImages(e)];return t||a.push(this.fetchSourceTemplate(e)),Promise.all(a).then(()=>{if(r)throw"User cancelled BFD asset loading.";return t||BeFunky.hideLoadScreen(),e})}prepareV2(e){this.swappedFonts={};let t=!1;BeFunky.showLoadScreen({onCancel:()=>{t=!0,this.abortPrepare()}});let r=[...e.transformLabels.map(a=>{let{labelTextStyles:s,labelText:o}=a;return s.compressedStyles&&(s.styles=this.decompressCharacterStyles(s.compressedStyles),delete s.compressedStyles),this.loadAndValidateFonts(s,o).then(n=>{a.labelText=n})})];return Promise.all(r).then(()=>{if(t)throw"cancelled_by_user";return BeFunky.hideLoadScreen(),e})}abortPrepare(){BeFunky.hideLoadScreen(),this.inFlightMaskImageURLs.map(e=>BeFunky.inFlightRequests[e]).filter(Boolean).forEach(e=>e.abort())}translateLabelState(e){return this.translateLabelHTML(e).then(({labelText:t,labelTextStyles:r})=>{e.labelText=t,e.labelTextStyles=r,["labelHTMLText","labelLetterSpacing","labelTextAlign","labelFontFamily","labelTintColor","labelTintColorEnabled","labelTintMultiplier","labelStrokeAlpha","labelStrokeColor","labelStrokeEnabled","labelBackgroundAlpha","labelBackgroundColor","labelBackgroundEnabled"].forEach(s=>{delete e[s]})})}translateLabelHTML(e){let t=new DOMParser,r=t.parseFromString(e.labelHTMLText,"text/html"),a=[...r.querySelectorAll("p")];return new Promise(l=>{let c="",h={textAlign:o(a[0]),charSpacing:n(a[0]),lineHeight:BFN.TransformItemTextBaseLineHeight,styles:{}},u={fontFamily:{attributeName:"face",transform:d=>d},fontSize:{attributeName:"size",transform:d=>(d=parseInt(d)||20,d)},fill:{attributeName:"color",transform:d=>{if(!e.labelTintColorEnabled)return"#00000000";let m=d&&d.startsWith("#")?d.replace("#",""):BFN.ColorUtil.hexNumberToHexString(e.labelTintColor),p=e.labelTintMultiplier;return BFN.ColorUtil.hexStringObjectToRGBAString({hex:m,alpha:p})}},stroke:{transform:()=>{if(!e.labelStrokeEnabled)return"";let d=BFN.ColorUtil.hexNumberToHexString(e.labelStrokeColor),m=e.labelStrokeAlpha;return BFN.ColorUtil.hexStringObjectToRGBAString({hex:d,alpha:m})}},fontWeight:{transform:()=>""},textBackgroundColor:{transform:()=>{if(!e.labelBackgroundEnabled)return"";let d=BFN.ColorUtil.hexNumberToHexString(e.labelBackgroundColor),m=e.labelBackgroundAlpha;return BFN.ColorUtil.hexStringObjectToRGBAString({hex:d,alpha:m})}}};a.forEach((d,m)=>{m>0&&(c+=`
`);let p=0,g={};h.styles[m]=g;let f=d.children[0];[...f.childNodes].forEach(v=>{let T=v.nodeType===1,x={};Object.keys(u).forEach(y=>{let{attributeName:F,transform:b}=u[y],S;F&&(S=T&&v.getAttribute(F)||f.getAttribute(F)),x[y]=b(S)}),s(v.textContent).split("").forEach(y=>{c+=y,g[p]=Object.assign({},x),p++})})}),this.loadAndValidateFonts(h,c).then(d=>{l({labelTextStyles:h,labelText:d})})});function s(l){return decodeURIComponent(Array.prototype.map.call(l,c=>`%${`00${c.charCodeAt(0).toString(16)}`.slice(-2)}`).join(""))}function o(l){let c="left",h=["left","center","right"],u;try{u=l.getAttribute("align").toLowerCase()}catch(d){}return h.includes(u)?u:c}function n(l){let c;try{c=l.children[0].getAttribute("letterspacing")}catch(h){}return c=parseInt(c)||0,c<=0?c=0:c=Math.round(100+c/2.5*100),c=Math.min(1e3,c),c}}fetchDesignerElementSvgData(e){return new Promise(t=>{let r=e.designerElementStates,a={},s=0,o=0;Object.keys(r).forEach(l=>{Object.keys(r[l]).forEach(c=>{s++;let h=`${BFN.designerElementsUrl+c}.svg`;BFN.RequestUtils.getText(h,({text:u,error:d})=>{o++,d?(BeFunky.logError(d),a[c]=null):a[c]=u,n()})})}),n();function n(){s>o||(e.designerElementSvgData=a,t())}})}decodeTemplateElementSvgData(e){return new Promise(t=>{if(!e.templateElementSvgData)return t();let r=Object.keys(e.templateElementSvgData).map(a=>BFN.ObjectCompressor.decompress(e.templateElementSvgData[a],!1).then(s=>{e.templateElementSvgData[a]=s}).catch(BeFunky.logError));Promise.all(r).then(t)})}fetchMaskImages(e){return new Promise(t=>{if(!e.transformMaskImageStates)return t();let r={},a=s=>(r[s]||(r[s]=new Promise((o,n)=>{let l=`${BeFunky.Params.uplUri}/loadImage.php?c=${encodeURIComponent(s)}`;this.inFlightMaskImageURLs.push(s,l),BFN.RequestUtils.getBase64WithFallback(s,l,({error:c,base64:h})=>{c&&n(c),o(h),[s,l].forEach(u=>{let d=this.inFlightMaskImageURLs.indexOf(u);d!==-1&&this.inFlightMaskImageURLs.splice(d,1)})})})),r[s]);e.transformMaskImageStates.forEach(s=>{s.maskImageBase64=s.maskImageBase64||null,!(s.maskImageBase64||!s.maskImageURL)&&a(s.maskImageURL).then(o=>{s.maskImageBase64=o}).catch(o=>{BeFunky.logError("Unable to load mask image base64:",o)})}),Promise.all(Object.values(r).map(s=>s.catch(()=>{}))).then(t)})}fetchSourceTemplate(e){return new Promise(t=>{if(!e.sourceTemplateID)return t();let r=`${BFN.designerTemplateFlashURL}${e.sourceTemplateID}.bfd`,a=s=>{BeFunky.logError(s),e.sourceTemplate=null,t()};BFN.SavedProjectService.fetchBFD(r,{showLoadScreen:!1}).then(s=>{this.prepareV1(s,{isSourceTemplate:!0}).then(o=>{e.sourceTemplate=o,t()}).catch(o=>{a(`Unable to prepare source template: ${o}`)})},s=>a(`Unable to fetch source template: ${s}`))})}loadAndValidateFonts(e,t){let r=e.styles,a=e.charSpacing,s=e.lineHeight,o=[],n={},{defaultFontFamily:l}=BFN.FontManager,c=t.split(`
`).map(m=>`${m}
`),h=[];return new Promise(m=>{let p=l;if(this.forEachCharacterStyle(r,(T,x,B)=>{let y=parseInt(x),F=parseInt(B),b=c[y]?c[y][F]:void 0;(!b||b===`
`)&&(h.push({character:b,font:T.fontFamily}),T.fontFamily=void 0);let S=p;T.fontFamily&&(S=u.call(this,T.fontFamily)),p=S;let I;typeof S=="string"?I=ei(S):(I=ei(S.name),S.isBold&&(T.fontWeight="bold"),S.isAllCaps&&t[F]&&(t=d(t,F,t[F].toUpperCase())),S.sizeScale&&(T.fontSize=(T.fontSize*S.sizeScale).toFixed(1)),S.charSpacingIncrement&&(e.charSpacing=a+S.charSpacingIncrement),S.lineHeightScale&&(e.lineHeight=(s*S.lineHeightScale).toFixed(2)),T.fontFamily&&(this.swappedFonts[T.fontFamily]=S.name)),T.fontFamily=I}),!h.every(({character:T})=>T===`
`)){let T=h.reduce((B,{font:y})=>[...B,y].unique(),[]),x=t.replace(/\n/g," ");x.length>20&&(x=`${x.slice(0,20)}...`),BeFunky.logError(`Ignored font of ${h.length} character styles in label "${x}" Fonts = ${T.join(", ")}`)}let g=Object.keys(n),f=0;if(!g.length)return v();g.forEach(T=>{n[T].catch(x=>{BeFunky.logError(x);let B=ei(T);BFN.ParseBFD.forEachCharacterStyle(r,y=>{if(y.fontFamily===B){let F=this.swappedFonts[T]||l;y.fontFamily=ei(F),this.swappedFonts[T]=F}})}).then(v)});function v(){f++,!(f<g.length)&&m(t)}});function u(m){let p=BFN.FontManager.findSimilarFont(m);if(p)return BFN.FontManager.isLoaded(p)||(n[p]=BFN.FontManager.load(p)),p;if(!o.includes(m)){if(BFN.FontManager.addUserDefinedSystemFont(m))return m;BeFunky.logError(`Unable to find custom font needed by BFD: "${m}"`),o.push(m)}let g=Fl[m];if(g){let f=g.name;return BFN.FontManager.isLoaded(f)||(n[f]=BFN.FontManager.load(f)),this.swappedFonts[m]=f,g}return this.swappedFonts[m]?this.swappedFonts[m]:(this.swappedFonts[m]=l,l)}function d(m,p,g){return m.substr(0,p)+g+m.substr(p+g.length)}}forEachCharacterStyle(e,t){Object.keys(e).forEach(r=>{let a=e[r];Object.keys(a).forEach(s=>{t(a[s],r,s)})})}decompressCharacterStyles(e){return e.reduce((t,{indexes:r,styles:a})=>(r.forEach(s=>{let[o,n]=s.split(",");t[o]||(t[o]={}),t[o][n]=Object.assign({},a)}),t),{})}compressCharacterStyles(e){let t=[];return this.forEachCharacterStyle(e,(r,a,s)=>{let o=`${a},${s}`,n=JSON.stringify(r),l=t.find(c=>c.stylesString===n);l?l.indexes.push(o):t.push({indexes:[o],stylesString:n,styles:r})}),t.map(r=>(delete r.stylesString,r))}};BFN.SingletonQueue.add(()=>{BFN.ParseBFD=new eh});var Ft=ca(th());function fI(){let i=new Int32Array(256);for(let e=0;e<256;e++){let t=e;for(let r=0;r<8;r++)t=t&1?3988292384^t>>>1:t>>>1;i[e]=t}return i}function gI(i){let e=-1;Fo||(Fo=fI());for(let t=0;t<i.length;t++)e=Fo[(e^i[t])&255]^e>>>8;return e^-1}var Fo,vI="image/png",yI="image/jpeg";var ih="p".charCodeAt(0),rh="H".charCodeAt(0),ah="Y".charCodeAt(0),sh="s".charCodeAt(0);function bo(i,e){let t=i.slice(0,33),r=1e3;return new Promise((a,s)=>{BFN.BlobUtils.blobToArrayBuffer(t,({arrayBuffer:o,error:n})=>{if(n)return s(n);let l=new Uint8Array(o),c=i.slice(33),h=TI(l,e,i.type);a(new Blob([h,c],{type:i.type}))},{timeoutMs:r,reportErrors:!1})})}function xI(i){let e=i.length-1;for(let t=e;t>=4;t--)if(i[t-4]===9&&i[t-3]===ih&&i[t-2]===rh&&i[t-1]===ah&&i[t]===sh)return t-3}function TI(i,e,t,r){if(t===yI)return i[13]=1,i[14]=e>>8,i[15]=e&255,i[16]=e>>8,i[17]=e&255,i;if(t===vI){let a=new Uint8Array(13);e*=39.3701,a[0]=ih,a[1]=rh,a[2]=ah,a[3]=sh,a[4]=e>>>24,a[5]=e>>>16,a[6]=e>>>8,a[7]=e&255,a[8]=a[4],a[9]=a[5],a[10]=a[6],a[11]=a[7],a[12]=1;let s=gI(a),o=new Uint8Array(4);if(o[0]=s>>>24,o[1]=s>>>16,o[2]=s>>>8,o[3]=s&255,r){let n=xI(i);return i.set(a,n),i.set(o,n+13),i}else{let n=new Uint8Array(4);n[0]=0,n[1]=0,n[2]=0,n[3]=9;let l=new Uint8Array(54);return l.set(i,0),l.set(n,33),l.set(a,37),l.set(o,50),l}}}var oh=class{constructor(){this.default_dpi=300}load(e,t){let r=BeFunky.callbackTimeout("ExifTool.load (with promise)",2500);BFN.BlobUtils.blobToBinaryString(e,({binaryString:a,error:s})=>{if(r(),s)return t({error:s});let o=null;try{o=Ft.default.load(a),o.thumbnail=null}catch(n){}t({exif:o,binaryString:a})},{timeoutMs:2e3,reportErrors:!1})}getOrientation(e){return e["0th"][Ft.default.ImageIFD.Orientation]}changeOrientation(e,t){e["0th"][Ft.default.ImageIFD.Orientation]=t}getDPI(e){return{x:e["0th"][Ft.default.ImageIFD.XResolution],y:e["0th"][Ft.default.ImageIFD.YResolution]}}changeDPI(e,t,r){e["0th"][Ft.default.ImageIFD.XResolution]=[t,1],e["0th"][Ft.default.ImageIFD.YResolution]=[r,1],e["0th"][Ft.default.ImageIFD.ResolutionUnit]=2}changeDPIForPNG(e,t,r){t=t||this.getDpiFromExif(r)||this.default_dpi;let a=Date.now();return bo(e,t).then(s=>(console.log(`Added ${t} DPI to PNG blob in ${Date.now()-a}ms`),s)).catch(s=>(BeFunky.logError("Failed to add DPI to PNG blob:",s),e))}getDpiFromExif(e){if(!e||!e["0th"]||!Array.isArray(e["0th"][Ft.default.ImageIFD.XResolution]))return;let[t,r]=e["0th"][Ft.default.ImageIFD.XResolution].map(s=>parseInt(s)),a=t;return r>1&&(a=t/r),e["0th"][Ft.default.ImageIFD.ResolutionUnit]===3&&(a*=2.54),a=Math.round(a),a||void 0}generateExif(e,t){let r={};return r[Ft.default.ImageIFD.Make]="BeFunky",r[Ft.default.ImageIFD.Software]="BeFunky Photo Editor",t||(t=1),r[Ft.default.ImageIFD.Orientation]=t,e||(e=this.default_dpi),r[Ft.default.ImageIFD.XResolution]=[e,1],r[Ft.default.ImageIFD.YResolution]=[e,1],r[Ft.default.ImageIFD.ResolutionUnit]=2,{"0th":r}}async insert(e,t,r){r=r||this.getDpiFromExif(t)||this.default_dpi,t?(this.changeDPI(t,r,r),this.changeOrientation(t,1)):t=this.generateExif(r),delete t["0th"][Ft.default.ImageIFD.WhitePoint],delete t["0th"][Ft.default.ImageIFD.PrimaryChromaticities];let a=Date.now(),s;try{s=await bo(e,r),console.log(`Added ${r} DPI to JPEG blob in ${Date.now()-a}ms`)}catch(o){BeFunky.logError("Failed to add DPI to JPEG blob:",o)}return new Promise((o,n)=>{let l=Date.now();this.load(s||e,({error:c,binaryString:h})=>{if(c)return n(c);let u;try{let d=Ft.default.dump(t),m=Ft.default.insert(d,h);u=BFN.ByteArrayUtil.convertBinaryStringToUint8Array(m),console.log(`Added EXIF to JPEG blob in ${Date.now()-l}ms`)}catch(d){return BeFunky.logError("Unable to add EXIF data to blob using Piexif"),Math.random()>.9&&(console.log("Exif data",t),BeFunky.throwError(d)),n(`Unable to generate blob: ${d.message?d.message:d}`)}return o(new Blob([u],{type:"image/jpeg"}))})})}};BFN.SingletonQueue.add(()=>{BFN.ExifTool=new oh});var nh=class{constructor(){this.holder=new PIXI.Sprite,this.filter=null}drawShape(e,t,r,a){this.currentTexture=t,this.currentParams=r||{},this.renderer=a||BFN.Stage;let s=Math.min(Math.min(this.currentTexture.width,this.currentTexture.height)/2,Math.max(0,this.currentParams.hasOwnProperty("padding")?this.currentParams.padding:0)),o=Math.min(this.currentTexture.width/2,Math.max(0,this.currentParams.hasOwnProperty("paddingX")?this.currentParams.paddingX:s)),n=Math.min(this.currentTexture.height/2,Math.max(0,this.currentParams.hasOwnProperty("paddingY")?this.currentParams.paddingY:s)),l=this.currentParams.hasOwnProperty("paddingL")?Math.min(this.currentTexture.width/2,Math.max(0,this.currentParams.paddingL||0)):o,c=this.currentParams.hasOwnProperty("paddingR")?Math.min(this.currentTexture.width/2,Math.max(0,this.currentParams.paddingR||0)):o,h=this.currentParams.hasOwnProperty("paddingT")?Math.min(this.currentTexture.height/2,Math.max(0,this.currentParams.paddingT||0)):n,u=this.currentParams.hasOwnProperty("paddingB")?Math.min(this.currentTexture.height/2,Math.max(0,this.currentParams.paddingB||0)):n;switch(this.holder.width=this.currentTexture.width-(l+c),this.holder.height=this.currentTexture.height-(h+u),this.holder.x=l,this.holder.y=h,e){case"ellipse":this.ellipse();break;case"roundedRect":this.roundedRect();break;default:break}}apply(){this.currentParams.hasOwnProperty("backgroundColor")&&this.currentParams.backgroundColor!==-1&&(this.currentTexture.fillColor(this.currentParams.backgroundColor,this.currentParams.backgroundAlpha||1),this.currentParams.clear=!1),this.filter.autoFit=!1,this.holder.filters=[this.filter],this.renderer.render(this.holder,this.currentTexture,this.currentParams.hasOwnProperty("clear")?this.currentParams.clear:!0);try{this.holder.destroyGC(!0)}catch(e){}this.currentParams=null,this.filter=null,this.currentTexture=null}ellipse(){this.filter=new BFN.filters.EllipseFilter,this.filter.quality=this.currentParams.hasOwnProperty("quality")?this.currentParams.quality:.75,this.filter.edgePadding=this.currentParams.hasOwnProperty("edgePadding")?this.currentParams.edgePadding:1,this.filter.strokeWidth=this.currentParams.hasOwnProperty("strokeWidth")?this.currentParams.strokeWidth:0,this.filter.strokeColor=this.currentParams.hasOwnProperty("strokeColor")?this.currentParams.strokeColor:4278190080,this.filter.fillColor=this.currentParams.hasOwnProperty("fillColor")?this.currentParams.fillColor:0,this.apply()}roundedRect(){this.filter=new BFN.filters.RoundedRectFilter,this.filter.quality=this.currentParams.hasOwnProperty("quality")?this.currentParams.quality:.75,this.filter.edgePadding=this.currentParams.hasOwnProperty("edgePadding")?this.currentParams.edgePadding:1,this.filter.strokeWidth=this.currentParams.hasOwnProperty("strokeWidth")?this.currentParams.strokeWidth:0,this.filter.cornerRadius=this.currentParams.hasOwnProperty("cornerRadius")?this.currentParams.cornerRadius:1,this.filter.strokeColor=this.currentParams.hasOwnProperty("strokeColor")?this.currentParams.strokeColor:4278190080,this.filter.fillColor=this.currentParams.hasOwnProperty("fillColor")?this.currentParams.fillColor:0,this.filter.outerColor=this.currentParams.hasOwnProperty("outerColor")?this.currentParams.outerColor:0,this.apply()}};BFN.graphics=new nh;function Sr(){}Sr.prototype.hexStringToHexNumber=function(i){return parseInt("0x"+i)};Sr.prototype.hexNumberToHexString=function(i){let e=this.hexNumberToRGBAObject(i),t=this.rgbaObjectToHexStringObject(e);return i<=16777215?t.hex:(256|t.alpha*255).toString(16).slice(1)+t.hex};Sr.prototype.hexNumberToRGBAObject=function(i){let e={};return e.r=i>>16&255,e.g=i>>8&255,e.b=i&255,e.a=i<=16777215?1:(i>>24&255)/255,e};Sr.prototype.rgbaObjectToHexStringObject=function(i){let e={};return e.hex=(16777216|i.b|i.g<<8|i.r<<16).toString(16).slice(1),e.alpha=i.a,e};Sr.prototype.hexNumberToRGBAString=function(i){let e=this.hexNumberToRGBAObject(i);return"rgba("+e.r+","+e.g+","+e.b+","+e.a+")"};Sr.prototype.hexStringObjectToRGBAString=function(i){let e=this.hexStringToHexNumber(i.hex),t=this.hexNumberToRGBAObject(e);return t.a=i.alpha,t.a>=1?"rgb("+t.r+","+t.g+","+t.b+")":"rgba("+t.r+","+t.g+","+t.b+","+t.a+")"};Sr.prototype.rgbaStringToHexStringObject=function(i){let e=i.replace("rgb(","").replace("rgba(","").replace(")","").split(",");if(e&&e.length){for(let t=0;t<e.length;t++)if(e[t]=parseFloat(e[t]),typeof e[t]!="number"||isNaN(e[t]))return null;if(e.length>=3){let t={};return t.r=e[0],t.g=e[1],t.b=e[2],t.a=1,e.length>3&&(t.a=e[3]),this.rgbaObjectToHexStringObject(t)}}return{hex:"000000",alpha:0}};BFN.SingletonQueue.add(function(){BFN.ColorUtil=new Sr});BFN.transformItemPoolTexture=PIXI.RenderTexture.create(256,256,PIXI.SCALE_MODES.NEAREST);BFN.transformItemTempParent=new PIXI.Sprite;var Bo=[],lh=class{interpolateNumber(e,t,r){return e*(1-r)+t*r}polygonHitTest(e,t){let r=[e,t],a,s,o,n,l;for(let c=0;c<r.length;c++){let h=r[c];for(let u=0;u<h.length;u++){let d=(u+1)%h.length,m=h[u],p=h[d],g={x:p.y-m.y,y:m.x-p.x};s=o=void 0;for(let f=0;f<e.length;f++)a=g.x*e[f].x+g.y*e[f].y,(s===void 0||a<s)&&(s=a),(o===void 0||a>o)&&(o=a);n=l=void 0;for(let f=0;f<t.length;f++)a=g.x*t[f].x+g.y*t[f].y,(n===void 0||a<n)&&(n=a),(l===void 0||a>l)&&(l=a);if(o<n||l<s)return!1}}return!0}isTransparent(e){let t=BFN.Stage.gl,r=t.createFramebuffer(),a=e.baseTexture._glTextures[0],s=e.width,o=e.height;if(!(a&&a.texture))return!1;let n=null;t.bindFramebuffer(t.FRAMEBUFFER,r),t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,a.texture,0);function l(){t.deleteFramebuffer(r),t.bindFramebuffer(t.FRAMEBUFFER,null),r=null,n=null}if(t.checkFramebufferStatus(t.FRAMEBUFFER)==t.FRAMEBUFFER_COMPLETE){let h=s*o*4;n=new Uint8Array(h),t.readPixels(0,0,s,o,t.RGBA,t.UNSIGNED_BYTE,n);for(let u=0;u<h;u+=4)if(n[u+3]<255)return l(),!0}return l(),!1}isSolidColor(e){let t=BFN.Stage.gl,r=t.createFramebuffer(),a=e.baseTexture._glTextures[0],s=e.width,o=e.height;if(!(a&&a.texture))return!1;let n=null;t.bindFramebuffer(t.FRAMEBUFFER,r),t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,a.texture,0);function l(){t.deleteFramebuffer(r),t.bindFramebuffer(t.FRAMEBUFFER,null),r=null,n=null}let c=t.checkFramebufferStatus(t.FRAMEBUFFER),h=[0,0,0,0];if(c==t.FRAMEBUFFER_COMPLETE){let u=s*o*4;n=new Uint8Array(u),t.readPixels(0,0,s,o,t.RGBA,t.UNSIGNED_BYTE,n);for(let d=0;d<u;d+=4)if(!d)h=[n[d+0],n[d+1],n[d+2],n[d+3]];else if(n[d+0]!=h[0]||n[d+1]!=h[1]||n[d+2]!=h[2]||n[d+3]!=h[3])return l(),!1}return l(),!0}getTextureAverageColor(e,t,r,a,s){let o=BFN.Stage.gl,n=o.createFramebuffer(),l=e.baseTexture._glTextures[0],c=e.width,h=e.height,u=null,d=null;o.bindFramebuffer(o.FRAMEBUFFER,n),o.framebufferTexture2D(o.FRAMEBUFFER,o.COLOR_ATTACHMENT0,o.TEXTURE_2D,l.texture,0);function m(){o.deleteFramebuffer(n),o.bindFramebuffer(o.FRAMEBUFFER,null),n=null,u=null}let p=o.checkFramebufferStatus(o.FRAMEBUFFER),g=0,f=0,v=0;if(p==o.FRAMEBUFFER_COMPLETE){let T=c*h*4;u=new Uint8Array(T),o.readPixels(0,0,c,h,o.RGBA,o.UNSIGNED_BYTE,u);let x=0;for(let B=0;B<T;B+=4)u[B+3]>0&&(x++,g+=u[B],a?(f=g,v=g):(f+=u[B+1],v+=u[B+2]));if(g/=x,f/=x,v/=x,s==!0){x=0;let B=g;for(let y=0;y<T;y+=4)u[y+3]>0&&u[y]<=B&&(x++,g+=u[y]);g/=x,f=g,v=g}r&&(g/=255,f/=255,v/=255),t?d=g<<16|f<<8|v:d=[g,f,v]}return m(),d}getAlphaBounds(e,t=null,r=1,a=!1,s=!0,o=!1){let n=BFN.Stage.gl,l={minX:0,minY:0,maxX:e.width,maxY:e.height,left:0,right:0,top:0,bottom:0,width:e.width,height:e.height,centerX:e.width/2,centerY:e.height/2,centerOffsetX:0,centerOffsetY:0,noBounds:!1},c=e.baseTexture._glTextures[0],h=e.width,u=e.height;if(!c)return BeFunky.throwError("Util.getAlphaBounds() : Undefined glTexture for provided RenderTexture.baseTexture"),l.maxX*=r,l.maxY*=r,l.width*=r,l.height*=r,l.centerX=l.width/2,l.centerY=l.height/2,l;let d,m,p,g,f,v,T=null;t||(t=["left","right","top","bottom"]);let x=n.createFramebuffer();n.bindFramebuffer(n.FRAMEBUFFER,x),n.framebufferTexture2D(n.FRAMEBUFFER,n.COLOR_ATTACHMENT0,n.TEXTURE_2D,c.texture,0);function B(w,N){return a?(g=(N*e.width+w)*4,(T[g]+T[g+1]+T[g+2])/3):(g=(N*e.width+w)*4+3,T[g])}function y(w,N){return o?N:w}function F(w,N){return B(w,N)>0}function b(){n.deleteFramebuffer(x),n.bindFramebuffer(n.FRAMEBUFFER,null),x=null,T=null}function S(w=!1){l.minX=l.minY=l.maxX=l.maxY=l.left=l.right=l.top=l.bottom=l.width=l.height=l.centerX=l.centerY=l.centerOffsetX=l.centerOffsetY=0,l.noBounds=w}let I=new PIXI.Point,_=.5;function E(w,N){let M={x:w.x,y:w.y,alpha:w.alpha};if(y(M.alpha<_,M.alpha>_)){let z=!1;for(let W=1;W<=2;W++){for(let j=-2;j<=2;j++){switch(N){case"left":I.x=w.x-W,I.y=w.y+j;break;case"right":I.x=w.x+W,I.y=w.y-j;break;case"up":I.x=w.x-j,I.y=w.y-W;break;case"down":I.x=w.x+j,I.y=w.y+W;break}if(I.x>=0&&I.y<h&&I.y>=0&&I.y<u){let J=B(I.x,I.y)/255;if(y(J>M.alpha,J<M.alpha)&&(M.x=I.x,M.y=I.y,M.alpha=J,y(J>=_,J<=_))){z=!0;break}}}if(z)break}}return{x:M.x-w.x,y:M.y-w.y}}if(n.checkFramebufferStatus(n.FRAMEBUFFER)==n.FRAMEBUFFER_COMPLETE){if(T=new Uint8Array(h*u*4),n.readPixels(0,0,h,u,n.RGBA,n.UNSIGNED_BYTE,T),v=null,t.indexOf("left")!=-1){for(d=!1,m=l.minX;m<l.maxX;m++){for(p=l.minY;p<l.maxY;p++)if(f=B(m,p)/255,y(f>0,f<1))if(d=!0,s){l.minX=m;break}else v?y(f>v.alpha,f<v.alpha)&&(v.x=m,v.y=p,v.alpha=f):(l.minX=m,v={x:m,y:p,alpha:f});if(v&&y(v.alpha!==1,v.alpha!==0)&&(l.minX+=E(v,"right").x),d)break}if(!d)return b(),S(!0),l}if(v=null,t.indexOf("top")!=-1){for(d=!1,p=l.minY;p<l.maxY;p++){for(m=l.minX;m<l.maxX;m++)if(f=B(m,p)/255,y(f>0,f<1))if(d=!0,s){l.minY=p;break}else v?y(f>v.alpha,f<v.alpha)&&(v.x=m,v.y=p,v.alpha=f):(l.minY=p,v={x:m,y:p,alpha:f});if(v&&y(v.alpha!==1,v.alpha!==0)&&(l.minY+=E(v,"down").y),d)break}if(!d)return b(),S(!0),l}if(v=null,t.indexOf("right")!=-1){for(d=!1,m=l.maxX;--m>l.minX-1;){for(p=l.minY;p<l.maxY;p++)if(f=B(m,p)/255,y(f>0,f<1))if(d=!0,s){l.maxX=m;break}else v?y(f>v.alpha,f<v.alpha)&&(v.x=m,v.y=p,v.alpha=f):(l.maxX=m,v={x:m,y:p,alpha:f});if(v&&y(v.alpha!==1,v.alpha!==0)&&(l.maxX+=E(v,"left").x),d)break}if(!d)return b(),S(!0),l}if(v=null,t.indexOf("bottom")!=-1){for(d=!1,p=l.maxY;--p>l.minY-1;){for(m=l.minX;m<l.maxX;m++)if(f=B(m,p)/255,y(f>0,f<1))if(d=!0,s){l.maxY=p;break}else v?y(f>v.alpha,f<v.alpha)&&(v.x=m,v.y=p,v.alpha=f):(l.maxY=p,v={x:m,y:p,alpha:f});if(v&&y(v.alpha!==1,v.alpha!==0)&&(l.maxY+=E(v,"up").y),d)break}if(!d)return b(),S(!0),l}l.left=l.minX,l.top=l.minY,l.right=l.width-l.maxX-1,l.bottom=l.height-l.maxY-1,l.minX*=r,l.minY*=r,l.maxX*=r,l.maxY*=r,l.width*=r,l.height*=r,l.left*=r,l.top*=r,l.right*=r,l.bottom*=r,l.width=l.width-l.left-l.right,l.height=l.height-l.top-l.bottom,l.centerX=l.left+l.width/2,l.centerY=l.top+l.height/2,l.centerOffsetX=l.centerX-e.width*r/2,l.centerOffsetY=l.centerY-e.height*r/2}return b(),(l.width===0||l.height===0)&&(l.noBounds=!0),l}getTransformItemBounds(e,t=!1){let r={minX:void 0,maxX:void 0,minY:void 0,maxY:void 0,left:0,right:0,top:0,bottom:0,centerOffsetX:0,centerOffsetY:0};if(e&&e.parent){let a=e.type=="text"&&!t?e.globalTextPolygon:e.globalBorderPolygon;for(let s=0;s<a.length;s++){let o=e.parent.toLocal(a[s],BFN.MainUI);(r.minX===void 0||o.x<r.minX)&&(r.minX=o.x),(r.maxX===void 0||o.x>r.maxX)&&(r.maxX=o.x),(r.minY===void 0||o.y<r.minY)&&(r.minY=o.y),(r.maxY===void 0||o.y>r.maxY)&&(r.maxY=o.y)}return r.width=r.maxX-r.minX,r.height=r.maxY-r.minY,r.centerX=r.minX+r.width/2,r.centerY=r.minY+r.height/2,r}return r.minX=r.minY=r.maxX=r.maxY=0,r}getTransformItemTexture(e,t=null,r=!1,a=null,s=!1){if(e&&e.parent){let o=1024,n=e.rotation;r&&(e.rotation=0,t=null),t=t||BFN.Util.getTransformItemBounds(e,!1),a=a||BFN.transformItemPoolTexture;let l=Math.min(1,o/t.width,o/t.height),c=Math.round(t.width*l),h=Math.round(t.height*l),u=c/t.width,d=h/t.height;a!==BFN.transformItemPoolTexture&&(a.adjustScale=a.adjustScale||{},a.adjustScale.x=u,a.adjustScale.y=d);let m=e.x,p=e.y,g=e.scale.x,f=e.scale.y,v=e.alpha,T=e.visible,x=e.renderable,B=e.hidden,y=e.parent,F=y.getChildIndex(e),b=e.itemBlendMode,S=e.itemContent.visible,I=e.hiResTextSprite?e.hiResTextSprite.visible:!1,_=e.hiResTextHelper?e.hiResTextHelper.visible:!1,E=e.curvedText?e.curvedText.visible:!1;return e.x=Math.round((e.x-t.minX)*l),e.y=Math.round((e.y-t.minY)*l),e.scale.x*=u,e.scale.y*=d,e.alpha=1,e.hidden=!1,e.visible=!0,e.renderable=!0,e.setBlendMode(BFN.CONST.BLEND_MODES.NORMAL),e.updateSmoothingScale(1,!1),e.itemContent.visible=!e.textCurveActive,e.itemContentShadow.visible=!1,e.hiResTextSprite&&(e.hiResTextSprite.visible=!1),e.hiResTextHelper&&(e.hiResTextHelper.visible=!1),e.textCurveActive&&(e.curvedText.visible=!0),BFN.transformItemTempParent.addChild(e),a.resize(Math.round(t.width*l),Math.round(t.height*l)),BFN.Stage.render(BFN.transformItemTempParent,a),s&&BFN.Stage.render(BFN.transformItemTempParent,a),e.rotation=n,e.x=m,e.y=p,e.scale.x=g,e.scale.y=f,e.alpha=v,e.visible=T,e.renderable=x,e.hidden=B,e.setBlendMode(b),e.updateSmoothingScale(),e.itemContent.visible=S,e.itemContentShadow.visible=!0,e.hiResTextSprite&&(e.hiResTextSprite.visible=I),e.hiResTextHelper&&(e.hiResTextHelper.visible=_),e.curvedText&&(e.curvedText.visible=E),y.addChildAt(e,F),a}return null}getThumbTextureGL(e,t,r,a){if(e==null)return null;t==null&&(t=50),r==null&&(r=!1),a==null&&(a=!1);let s=new PIXI.Sprite(e);s.pluginName="smooth_picture";let o=Math.max(e.width,e.height),n=Math.min(e.width,e.height),l=r&&a?t/n:t/o,c=Math.floor(e.width*l),h=Math.floor(e.height*l);s.x=r?t/2-c/2:0,s.y=r?t/2-h/2:0;let u=PIXI.RenderTexture.create(r?t:c,r?t:h);return s.scale.x=c/e.width,s.scale.y=h/e.height,s.currentScale=s.scale.x,s.currentScaleY=s.scale.y,BFN.smoothPictureAction(()=>{BFN.Stage.render(s,u)}),s.destroy(!1),s=null,e.baseTexture&&e.baseTexture.hasOwnProperty("isTransparent")&&!r&&!a&&(u.isTransparent=e.baseTexture.isTransparent),u}getThumbTexture(e,t,r,a){if(e==null)return null;t=t||50,r=r||!1,a=a||!1;let s=8,o=new PIXI.Texture(e.baseTexture);o.frame=e.frame,o.orig=e.orig,o.trim=e.trim;let n=Math.min(o.width,o.height),l=Math.max(o.width,o.height),c=null;if(l>t*3){let v=t*3/l,T=Math.max(s,Math.round(o.width*v)),x=Math.max(s,Math.round(o.height*v));c=this.resizeTexture(o,T,x,!1,!0),o.destroy(!1),o=c}else if(n<t){let v=r&&a?t/n:t/l,T=Math.max(s,Math.min(t,Math.round(o.width*v))),x=Math.max(s,Math.min(t,Math.round(o.height*v)));c=this.resizeTexture(o,T,x,r&&a),o.destroy(!1),o=c}let h=Math.max(o.width,o.height),u=Math.min(o.width,o.height),d=r&&a?t/u:t/h,m=Math.max(s,Math.round(o.width*d)),p=Math.max(s,Math.round(o.height*d)),g=new PIXI.Sprite(o);g.pluginName="smooth_picture",g.x=r?t/2-m/2:0,g.y=r?t/2-p/2:0,g.scale.x=g.currentScale=m/o.width,g.scale.y=g.currentScaleY=p/o.height;let f=PIXI.RenderTexture.create(r?t:m,r?t:p);return BFN.smoothPictureAction(()=>{BFN.Stage.render(g,f)}),g.destroy(!1),g=null,c&&c.destroyGC(!0),e.baseTexture&&e.baseTexture.hasOwnProperty("isTransparent")&&!r&&!a&&(f.isTransparent=e.baseTexture.isTransparent),f}getHTMLImage(e=null,t=null,r=!1){if(!e)return t&&t(null),null;let a=null;if(r&&(this.unPremultiplySprite||(this.unPremultiplySprite=new PIXI.Sprite,this.unPremultiplyFilter=new BFN.filters.UnPremultiplyFilter,this.unPremultiplySprite.filters=[this.unPremultiplyFilter]),this.unPremultiplySprite.texture=e,a=e.renderClone(),BFN.Stage.render(this.unPremultiplySprite,a)),t==null){let s=BFN.Stage.extract.image(r?a:e);return r&&(this.unPremultiplySprite.texture=PIXI.Texture.EMPTY,a.destroyGC(!0),a=null),s}if(t){let s=BFN.Stage.extract.canvasBufferBfn(r?a:e);r&&(this.unPremultiplySprite.texture=PIXI.Texture.EMPTY);let o=r?"image/png":"image/jpeg";s.canvas.toBlob(n=>{s.release(),s=null,BFN.BlobUtils.blobToBase64(n).catch(l=>(BeFunky.throwError("Unable to convert blob -> base64 in getHTMLImage",l),"")).then(l=>{let c=new Image;c.src=l,r&&a.destroyGC(!0),a=null,t(c)})},o,.99)}}getRandomInt(e=0,t=2147483647){return Math.round(Math.random()*(t-e))+e}orientTexture(e,t=1){if(e&&e.valid&&t>=2&&t<=8){let r=[5,6,7,8].indexOf(t)>=0,a=r?e.height:e.width,s=r?e.width:e.height,o=e.renderClone(),n=new PIXI.Sprite(o),l={2:12,3:4,4:8,5:10,6:6,7:14,8:2};o.rotate=l[t],n.width=a,n.height=s,r&&e.resize(a,s,!1),BFN.Stage.render(n,e),o.destroyGC(!0),n.destroy(!1)}}resizeTexture(e,t,r,a=!1,s=!1){try{if(e&&e.width&&e.height&&t&&r){let o=new PIXI.Sprite(e);a?(o.scale.x=o.scale.y=Math.max(Math.abs(t)/e.width,Math.abs(r)/e.height),o.x=(t-e.width*o.scale.x)/2,o.y=(r-e.height*o.scale.y)/2):(o.scale.x=Math.abs(t)/e.width,o.scale.y=Math.abs(r)/e.height),s&&(o.pluginName="smooth_picture",o.currentScale=o.scale.x,o.currentScaleY=o.scale.y);let n=PIXI.RenderTexture.create(t,r);return BFN.smoothPictureAction(()=>{BFN.Stage.render(o,n)}),o.destroy(!1),o=null,e&&e.baseTexture&&e.baseTexture.hasOwnProperty("isTransparent")&&(n.isTransparent=e.baseTexture.isTransparent),n}}catch(o){BeFunky.logError("resizeTexture failed",o)}return null}fitTextureInRect(e,t,r,a=!1,s=-1){try{if(e&&e.width&&e.height&&t&&r){let o=PIXI.RenderTexture.create(t,r);if(a)o.copyPixels(e,{x:0,y:0},!0,1,{x:t/e.width,y:r/e.height});else{s==-1?o.clear():o.fillColor(parseInt(`0x${s}`),1);let n=Math.min(t/e.width,r/e.height),l=Math.round(t/2-e.width*n/2),c=Math.round(r/2-e.height*n/2);o.copyPixels(e,{x:l,y:c},!1,1,n)}return o}}catch(o){}return null}conformImageSizeMegaPixels(e,t,r){try{if(e&&e.width&&e.height){let a=e.width,s=e.height,o=s/a,n=a*s,l=t,c=t,h=a*Math.sqrt(r/n),u=s*Math.sqrt(r/n);if(a<l||a>h||s<c||s>u){let d=Math.round(o>1?Math.max(l/o,Math.min(h/o,a/o)):Math.max(l,Math.min(h,a))),m=Math.round(o>1?Math.max(l,Math.min(h,a)):Math.max(l*o,Math.min(h*o,a*o)));return this.resizeTexture(e,d,m,!1)}}}catch(a){}return e.renderClone()}conformImageSize(e,t,r){try{if(e&&e.width&&e.height){let a=e.width,s=e.height,o=s/a,n=t,l=r,c=t,h=r;if(a<n||a>l||s<c||s>h){let u=-1,d=-1;if(o>1?a<n?(u=n,d=Math.min(h,Math.round(u*o))):s>h&&(d=h,u=Math.max(n,Math.round(d/o))):s<c?(d=c,u=Math.min(l,Math.round(d/o))):a>l&&(u=l,d=Math.max(c,Math.round(u*o))),u>0&&d>0)return this.resizeTexture(e,u,d,!1)}}}catch(a){}return e.renderClone()}hex2rgbVec3(e){let t=[];return t[0]=(e>>16&255)/255,t[1]=(e>>8&255)/255,t[2]=(e&255)/255,t}rgbToHex(e,t,r){return e<<16|t<<8|r}cloneTexture(e){let t=new PIXI.Sprite(e),r=PIXI.RenderTexture.create(e.width,e.height);return BFN.Stage.render(t,r),t.destroy(!1),t=null,r}createRenderTexturePool(){BFN.renderTexturesPool||(BFN.renderTextureHolder=new PIXI.Sprite,BFN.renderTexturesPool=[{is_protected:!0,description:"photo-edit-model",used:!0,texture:PIXI.RenderTexture.create(512,512)},{is_protected:!0,description:"multiple-file-uploader",used:!0,texture:PIXI.RenderTexture.create(512,512)},{used:!1,texture:PIXI.RenderTexture.create(512,512)}])}getNonUsedRenderTexturePool(e,t){let r=!1,a=null;for(let s=0;s<BFN.renderTexturesPool.length;s++)if(BFN.renderTexturesPool[s]!=null&&BFN.renderTexturesPool[s].used!=!0&&BFN.renderTexturesPool[s].hasOwnProperty("is_protected")==!1){BFN.renderTexturesPool[s].used=!0,(e!=BFN.renderTexturesPool[s].texture.width||t!=BFN.renderTexturesPool[s].texture.height)&&BFN.renderTexturesPool[s].texture.resize(e,t,r),a=BFN.renderTexturesPool[s].texture;break}if(a==null){let s=BFN.renderTexturesPool.length;BFN.renderTexturesPool[s]={used:!0,texture:PIXI.RenderTexture.create(e,t)},a=BFN.renderTexturesPool[s].texture}return a}destroyRenderTexturePool(){if(BFN.renderTexturesPool!=null){for(let e=0;e<BFN.renderTexturesPool.length;e++)if(BFN.renderTexturesPool[e]!=null&&BFN.renderTexturesPool[e].used==!0&&BFN.renderTexturesPool[e].hasOwnProperty("is_protected")==!1){BFN.renderTexturesPool[e].used=!1;try{BFN.renderTexturesPool[e].texture.resize(512,512)}catch(t){}}BFN.renderTextureHolder.texture=null,BFN.renderTextureHolder.filters=[]}}calculateRes(e,t){let r={small:1,large:1},a=Math.max(e,t);return a<=8192&&(r.small=.25/1,r.large=.25/2),a<=4096&&(r.small=.5/1,r.large=.5/2),a<=2048&&(r.small=r.large=.5),a<1024&&(r.small=r.large=1),r}expandVertices(e,t=10,r=null){if(e&&e.length==8){let a=[];for(let s=0;s<8;s+=2){let o=Math.atan2(e[s+1]-e[(s+7)%8],e[s]-e[(s+6)%8]),n=Math.atan2(e[s+1]-e[(s+3)%8],e[s]-e[(s+2)%8]),l=Math.cos(o)*t,c=Math.sin(o)*t,h=Math.cos(n)*t,u=Math.sin(n)*t;if(r&&r.length===4)switch(Math.floor(s/2)){case 0:l*=r[2],c*=r[2],h*=r[0],u*=r[0];break;case 1:l*=r[1],c*=r[1],h*=r[2],u*=r[2];break;case 2:l*=r[3],c*=r[3],h*=r[1],u*=r[1];break;case 3:l*=r[0],c*=r[0],h*=r[3],u*=r[3];break}let d=l+h,m=c+u;a.push(e[s]+d),a.push(e[s+1]+m)}return a}return e}getDistance(e,t,r,a){return Math.sqrt(Math.pow(r-e,2)+Math.pow(a-t,2))}hsv2rgb({h:e,s:t,v:r}){let a,s,o,n,l;e=e%360/60,l=r*t,n=l*(1-Math.abs(e%2-1)),a=s=o=r-l,e=~~e,a+=[l,n,0,0,n,l][e],s+=[n,l,l,n,0,0][e],o+=[0,0,n,l,l,n][e];let c=Math.floor(a*255),h=Math.floor(s*255),u=Math.floor(o*255);return{r:c,g:h,b:u,hex:`#${(16777216|u|h<<8|c<<16).toString(16).slice(1)}`}}rgb2hsv({r:e,g:t,b:r}){(e>1||t>1||r>1)&&(e/=255,t/=255,r/=255);let a,s,o,n;return o=Math.max(e,t,r),n=o-Math.min(e,t,r),a=n===0?null:o===e?(t-r)/n+(t<r?6:0):o===t?(r-e)/n+2:(e-t)/n+4,a=a%6*60,s=n===0?0:n/o,{h:a,s,v:o}}hex2rgb(e){return{r:e>>16&255,g:e>>8&255,b:e&255}}hex2hsv(e){return this.rgb2hsv(this.hex2rgb(e))}getArrayDifference(e,t){return e.filter(a=>!t.includes(a))}bytesToMB(e){return e*4/Math.pow(1024,2)}getTotalTextureMemory(){let e=[];try{e.push(...BFN.Stage.textureManager._managedTextures)}catch(o){return BeFunky.logError("Unable to get PIXI _managedTextures array"),0}try{let o=[].concat(...Object.values(BFN.Stage.filterManager.pool)).map(n=>n.texture);e.push(...o)}catch(o){return BeFunky.logError("Unable to get PIXI pooled filter textures"),0}let t=this.getArrayDifference(e,Bo),r=Bo.reduce((o,n)=>{let l=parseInt(n.width)||0,c=parseInt(n.height)||0,h=typeof n.resolution=="number"?n.resolution:1;return l<=0||c<=0?(BeFunky.logError("Found texture with invalid width/height",n,n.width,n.height),o):o+l*c*h},0);if(Bo=e,t.length>0){let o=t.reduce((n,l)=>{let c=parseInt(l.width)||0,h=parseInt(l.height)||0,u=typeof l.resolution=="number"?l.resolution:1;return n+c*h*u},0)}let a=e.reduce((o,n)=>{let l=parseInt(n.width)||0,c=parseInt(n.height)||0,h=typeof n.resolution=="number"?n.resolution:1;return l<=0||c<=0?(BeFunky.logError("Found texture with invalid width/height",n,n.width,n.height),o):o+l*c*h},0),s=this.bytesToMB(a);return Math.round(s*10)/10}getBaseTexturesMemoryMB(e=[]){return!(e instanceof Array)||!e.length?0:e.unique().reduce((t,r)=>t+this.getBaseTextureMemoryMB(r),0)}getBaseTextureMemoryMB(e){return!(e instanceof PIXI.BaseTexture)||e._destroyed?0:this.bytesToMB(e.width*e.height*e.resolution)}addSetterCallback(e,t,r){let a=this.getPropertyDescriptor(e,t);a&&a.set&&a.get&&(e[`${t}Set`]=a.set,e[`${t}Get`]=a.get,e[`${t}SetCB`]=r,Object.defineProperty(e,t,{set(s){this[`${t}Set`](s),this[`${t}SetCB`](s)},get(){return this[`${t}Get`]()}}))}getPropertyDescriptor(e,t){let r;do r=Object.getOwnPropertyDescriptor(e,t);while(!r&&(e=Object.getPrototypeOf(e)));return r}hasPropertyDescriptor(e,t){return!!this.getPropertyDescriptor(e,t)}rotatePoint(e,t,r){t.x-=e.x,t.y-=e.y;let a=Math.sqrt(Math.pow(t.x,2)+Math.pow(t.y,2)),s=Math.atan2(t.y,t.x)+r;return new PIXI.Point(Math.cos(s)*a+e.x,Math.sin(s)*a+e.y)}rectFromPointCloud(e=[],t=0){let r=new PIXI.Point,a={rotation:t,width:0,height:0,tl:new PIXI.Point,tr:new PIXI.Point,bl:new PIXI.Point,br:new PIXI.Point};if(t!==0){let s=[];e.forEach(o=>{s.push(this.rotatePoint(r,o,-t))}),e=s}if(e.length){let s,o,n,l;e.forEach((c,h)=>{h?(s=Math.min(s,c.x),o=Math.min(o,c.y),n=Math.max(n,c.x),l=Math.max(l,c.y)):(s=n=c.x,o=l=c.y)}),a.width=n-s,a.height=l-o,a.tl.set(s,o),a.tr.set(n,o),a.bl.set(s,l),a.br.set(n,l),t!==0&&(a.tl=this.rotatePoint(r,a.tl,a.rotation),a.tr=this.rotatePoint(r,a.tr,a.rotation),a.bl=this.rotatePoint(r,a.bl,a.rotation),a.br=this.rotatePoint(r,a.br,a.rotation))}return a}};BFN.Util=new lh;function Ur(){this.init()}Ur.prototype.init=function(){BeFunky.log("SpritePool Init"),this.initDefaultValues()};Ur.prototype.initDefaultValues=function(){this.sprites=[],this.spriteAnchor=new PIXI.Point(.5,.5)};Ur.prototype.makeSprite=function(){let i=new PIXI.Sprite;return i.anchor.x=this.spriteAnchor.x,i.anchor.y=this.spriteAnchor.y,i};Ur.prototype.grow=function(i=0){for(let e=0;e<i;e++)this.sprites.push(this.makeSprite())};Ur.prototype.growTo=function(i=0){let e=i-this.sprites.length;e>0&&this.grow(e)};Ur.prototype.getSprite=function(i,e=null,t=null){i>=this.sprites.length&&this.growTo(i+1);let r=this.sprites[i];return e&&(r.x=e.x,r.y=e.y),t&&(r.texture=t),r};BFN.SpritePool=Ur;var ch=class{convertBinaryStringToUint8Array(e){let t=e.length,r=new Uint8Array(t);for(let a=0;a<t;a++)r[a]=e.charCodeAt(a);return r}AS3ByteArrayToPixel(e,t=110,r=110,a=s=>{console.log(s.src)}){let s=m=>{let p=null,g=m.length;for(let f=0;f<g/2;f+=1){p=g-1-f;let v=m[f],T=m[p];v^=T,T^=v,v^=T,m[f]=v,m[p]=T}return m},n=(m=>{let p,g,f=[];for(let v=0;v<m.length;v++){p=m.charCodeAt(v),g=[];do g.push(p&255),p=p>>8;while(p);g=s(g);try{Array.prototype.push.apply(f,g)}catch(T){}}return p=null,g=null,f})(atob(e)),l=document.createElement("canvas");l.width=t,l.height=r;let c=l.getContext("2d"),h=c.createImageData(t,r);for(let m=0;m<n.length;m+=4)h.data[m+0]=n[m+1],h.data[m+1]=n[m+2],h.data[m+2]=n[m+3],h.data[m+3]=n[m+0];c.putImageData(h,0,0);let u=l.toDataURL();c=null,h=null,l=null,n=null;let d=document.createElement("img");d.onload=function(){a(d)},d.src=u}};BFN.SingletonQueue.add(()=>{BFN.ByteArrayUtil=new ch});BFN.GraphicLoaderEvents={GRAPHIC_COMPLETE:new Event("GRAPHIC_COMPLETE"),LOADING_COMPLETE:new Event("LOADING_COMPLETE")};var hh=class extends BFN.EventDispatcher{constructor(){super();this.init()}init(){BeFunky.log("GraphicLoader Init"),this.initDefaultValues()}initDefaultValues(){this._graphicsLoaded=!1,this._graphicsData={},this._graphics={},this._blobs={},this.activeLoaders={},this.loaderCount=0,this.maxImageSize=BFN.maxImageSize,this.handleImageLoadErrorBind=this.handleImageLoadError.bind(this),this.handleImageLoadCompleteBind=this.handleImageLoadComplete.bind(this)}loadGraphics(){for(let e in this._graphicsData){let t=this._graphicsData[e];if(this._graphics[e]&&this._graphics[e]!=this.missingTexture&&this._graphics[e].destroyGC(!0),this._graphics[e]=null,BeFunky.isAppleAppStoreApp)BFN.RequestUtils.getBlob(t,({error:r,blob:a})=>{r&&this.completeEvent(e),this.loadTexture(a,e)});else{let r=new XMLHttpRequest;r.onerror=this.handleImageLoadErrorBind,r.onload=this.handleImageLoadCompleteBind,r.open("GET",t,!0),r.responseType=BeFunky.firefoxVersion===57?"arraybuffer":"blob",this.activeLoaders[e]=r,r.send()}this.loaderCount++,this._graphicsData[e]=null,delete this._graphicsData[e]}this.loaderCount||(this._graphicsLoaded=!0,this.dispatchEvent(BFN.GraphicLoaderEvents.LOADING_COMPLETE))}reset(){for(let e in this._graphicsData)this._graphicsData[e]=null,delete this._graphicsData[e];for(let e in this._graphics)this._graphics[e]&&this._graphics[e]!=this.missingTexture&&this._graphics[e].destroyGC(!0),this._graphics[e]=null,delete this._graphics[e];for(let e in this._blobs)this._blobs[e]=null,delete this._blobs[e];for(let e in this.activeLoaders){let t=this.activeLoaders[e];t=null,delete this.activeLoaders[e]}this.loaderCount=0,this._graphicsLoaded=!1}handleImageLoadError(e){let t=e.currentTarget;for(let r in this.activeLoaders)if(this.activeLoaders[r]==t){this._graphics[r]=this.missingTexture,this._blobs[r]=null,t=null,delete this.activeLoaders[r],this.completeEvent(r);return}}handleImageLoadComplete(e){let t=e.currentTarget;for(let r in this.activeLoaders)if(this.activeLoaders[r]==t){if(t.status==200){let a=t.response;t.responseType==="arraybuffer"&&(a=new Blob([new Uint8Array(a)])),this.loadTexture(a,r,e,t)}else this.handleImageLoadError(e);return}}completeEvent(e){let t=new Event(BFN.GraphicLoaderEvents.GRAPHIC_COMPLETE.type);t.data={graphicID:e,graphic:this._graphics[e],blob:this._blobs[e]},this.dispatchEvent(t),--this.loaderCount||(this._graphicsLoaded=!0,this.dispatchEvent(BFN.GraphicLoaderEvents.LOADING_COMPLETE))}loadTexture(e,t,r,a){BFN.TextureUtils.blobOrBase64ToTexture(e,({texture:s,error:o})=>{if(o){r?this.handleImageLoadError(r):this.completeEvent(t);return}this._graphics[t]=s,this._blobs[t]=e,a&&(a=null,delete this.activeLoaders[t]),this.completeEvent(t)},{textureSize:this.maxImageSize,readEXIF:!1})}get graphicsLoaded(){return this._graphicsLoaded}get graphicsData(){return this._graphicsData}get graphics(){return this._graphics}get blobs(){return this._blobs}get loading(){return this.loaderCount>0}get missingTexture(){if(!this._missingTexture){let e=new PIXI.Graphics;e.beginFill(16711680),e.drawRect(0,0,5,5),e.endFill(),this._missingTexture=PIXI.RenderTexture.create(5,5),BFN.Stage.render(e,this._missingTexture)}return this._missingTexture}};BFN.GraphicLoader=hh;BFN.EffectTextureLoaderEvents={TEXTURE_LOADED:new Event("TEXTURE_LOADED")};function fr(){BFN.EventDispatcher.call(this),this.init()}fr.prototype=Object.create(BFN.EventDispatcher.prototype);fr.prototype.init=function(){BeFunky.log("EffectTextureLoader Init"),this.initDefaultValues(),this.initGraphicLoader()};fr.prototype.initDefaultValues=function(){this.loadedTextures={}};fr.prototype.initGraphicLoader=function(){this.graphicLoader=new BFN.GraphicLoader,this.graphicLoader.addEventListener(BFN.GraphicLoaderEvents.GRAPHIC_COMPLETE.type,this.handleGraphicLoaderGraphicComplete.bind(this))};fr.prototype.getTexture=function(i,e,t){return e==null&&(e=0),t==null&&(t=0),this.loadedTextures.hasOwnProperty(i)?(e>0&&t>0||(e=this.loadedTextures[i].width,t=this.loadedTextures[i].height),BFN.Util.resizeTexture(this.loadedTextures[i],e,t)):(this.graphicLoader.reset(),this.graphicLoader.graphicsData[i]=i,this.graphicLoader.loadGraphics(),null)};fr.prototype.handleGraphicLoaderGraphicComplete=function(i){let e=i.data.graphicID,t=i.data.graphic;this.loadedTextures.hasOwnProperty(e)&&this.loadedTextures[e].destroyGC(!0),this.loadedTextures[e]=PIXI.RenderTexture.create(t.width,t.height),this.loadedTextures[e].copyPixels(t),this.graphicLoader.reset();try{try{t.destroyGC(!0)}catch(r){}try{i.data=null}catch(r){}try{i=null}catch(r){}}catch(r){}this.dispatchEvent(BFN.EffectTextureLoaderEvents.TEXTURE_LOADED)};fr.prototype.destroy=function(){let i=this;Object.keys(i.loadedTextures).forEach(function(e){if(i.loadedTextures.hasOwnProperty(e)&&i.loadedTextures[e]!=null)try{i.loadedTextures[e].destroyGC(!0),i.loadedTextures[e]=null}catch(t){}})};Object.defineProperty(fr.prototype,"loading",{get:function(){return this.graphicLoader.loading}});BFN.EffectTextureLoader=fr;var uh=class{constructor(){this.init()}init(){this.initDefaultValues()}initDefaultValues(){this._base64graphics={},this._textureGraphics={},this.texturesThumbsPromise=void 0,this.effectsThumbsPromise=void 0,this.warningReported=!1}loadTexturesThumbnailsXml(){let e=`${BFN.assetsURL}datas/textures_thumbs.xml`;return this.texturesThumbsPromise?this.texturesThumbsPromise:(this.texturesThumbsPromise=new Promise((t,r)=>{BeFunky.request(e,{responseType:"text"},({error:a,response:s})=>{if(a)return a==="request_failed"?BeFunky.logWarning(`Failed to load textures thumb XML: ${a}`):BeFunky.reportWarning(`Failed to load textures thumb XML: ${a}`),this.texturesThumbsPromise=null,r(a);let n=window.parseXml(s).getElementsByTagName("image"),l=n.length,c=[];for(let h=0;h<l;h++){let u=n[h],d=u.getAttribute("name");this._base64graphics[d]=u.childNodes[0].nodeValue,c.push(d)}t(this.waitForImageToTextureConversion(c))})}),this.texturesThumbsPromise)}loadEffectsThumbnailsJson(){let e=`${BFN.assetsURL}datas/effect_thumbs${BFN.assetsDataVersions.effects_thumbs_data}.json`;return this.effectsThumbsPromise?this.effectsThumbsPromise:(this.effectsThumbsPromise=new Promise((t,r)=>{BFN.RequestUtils.getJSON(e,({error:a,response:s})=>{if(a||!s.images)return a==="request_failed"?BeFunky.logWarning(`Failed to load effects thumb JSON: ${a||"invalid_response"}`):BeFunky.reportWarning(`Failed to load effects thumb JSON: ${a||"invalid_response"}`),this.effectsThumbsPromise=null,r(a||"invalid_response");let o=s.images.length,n=[];for(let l=0;l<o;l++){let c=s.images[l];if(c&&c.hasOwnProperty("image")&&c.hasOwnProperty("name")){let h=c.image,{name:u}=c;this._base64graphics[u]=h,n.push(u)}}t(this.waitForImageToTextureConversion(n))})}),this.effectsThumbsPromise)}loadBase64ToTexture(e){return new Promise((t,r)=>{let a=document.createElement("img"),s=206,o=140;a.onload=()=>{let n=new PIXI.Sprite(new PIXI.Texture(new PIXI.BaseTexture(a)));e.includes("lut_")||e.includes("_grad")||e.includes("texture_halftone")||e.includes("frost_pattern.jpg")||e.includes("snow_texture.jpg")||e.includes("256star")||e.includes("analog_fx")||e.includes("bw_fx")||e.includes("warm_fx")?e.includes("texture_halftone")?(s=BFN.FilterHelper.getNextPowerOfTwo(n.texture.width),o=BFN.FilterHelper.getNextPowerOfTwo(n.texture.height),n.scale.x=s/n.texture.width,n.scale.y=o/n.texture.height):(s=n.texture.width,o=n.texture.height):(n.scale.x=s/n.texture.width,n.scale.y=o/n.texture.height);let l=PIXI.RenderTexture.create(s,o);BFN.Stage.render(n,l),n.destroy(!0),n=null,this._textureGraphics[e]=l,BeFunky.log(`LOADED THUMB : ${e}`),a=null,t()},a.onerror=()=>r(`Failed to load thumbnail ${e}`),a.src=this._base64graphics[e]})}getGraphicByName(e,t=0,r=0){if(this._textureGraphics.hasOwnProperty(e)){let o=BFN.Util.cloneTexture(this._textureGraphics[e]);if(t>0&&r>0||(t=o.width,r=o.height),t!==o.width||r!==o.height){let n=BFN.Util.resizeTexture(o,t,r);return o.destroyGC(!0),o=null,n}return o}this._base64graphics.hasOwnProperty(e)?(this.reportOnce("Thumbnail requested before texture generated",e),this.loadBase64ToTexture(e)):this.reportOnce("Thumbnail requested before base64 loaded",e);let s=PIXI.RenderTexture.create(10,10);return s.fillColor(16711680),s}reportOnce(e,...t){this.warningReported||(BeFunky.reportWarning(e,...t),this.warningReported=!0,setTimeout(()=>{this.warningReported=!1},1e3))}async waitForImageToTextureConversion(e){try{let r=0,a=8,s=[];for(;r<e.length;){await t();for(let o=0;o<a;o++)e[r+o]&&s.push(this.loadBase64ToTexture(e[r+o]));r+=a}await Promise.all(s)}catch(r){return BeFunky.reportWarning("Failed to convert thumbnail base64(s) to texture",r),t()}function t(){return new Promise(r=>requestIdleCallback(()=>r()))}}};BFN.SingletonQueue.add(()=>{BFN.XMLGraphicLoader=new uh});var dh=class{constructor(){this.init()}init(){this.baseTextures={}}};BFN.SingletonQueue.add(()=>{BFN.GoodiesItemLoader=new dh});BFN.OverlaysThumbLoaderEvents={LOADED:new Event("OVERLAYS_THUMBS_LOADED")};function Gr(){BFN.EventDispatcher.call(this),this.init()}Gr.prototype=Object.create(BFN.EventDispatcher.prototype);Gr.prototype.init=function(){this.initDefaultValues()};Gr.prototype.initDefaultValues=function(){this.thumbs={}};Gr.prototype.load=function(i){if(this.thumbs[i])return this.dispatchEvent(BFN.OverlaysThumbLoaderEvents.LOADED);let e=`${BFN.overlaysUrl}_thumbs/${i}${BFN.assetsDataVersions.overlays_thumb}.json`;BFN.RequestUtils.getJSON(e,({error:t,response:r})=>{if(t)return BeFunky.throwError(`Unable to load Overlays category ${i}`,t);r&&r.thumbs&&(this.thumbs[i]=r.thumbs,this.dispatchEvent(BFN.OverlaysThumbLoaderEvents.LOADED))})};Gr.prototype.getBase64=function(i,e){if(this.thumbs!=null&&this.thumbs.hasOwnProperty(i))for(let t=0;t<this.thumbs[i].length;t++){let r=this.thumbs[i][t];if(r.id==e)return r.data}return null};Gr.prototype.getImage=function(i,e,t,r){let a=null;if(this.thumbs!=null&&this.thumbs.hasOwnProperty(i))for(let s=0;s<this.thumbs[i].length&&(a=this.thumbs[i][s],a.id!=e);s++)a=null;if(a!=null){let s=document.createElement("img");s.id=a.id,s.onload=function(){if(t==!0){let o=new PIXI.Texture(new PIXI.BaseTexture(s)),n=PIXI.RenderTexture.create(o.width,o.height),l=new PIXI.Sprite(o);BFN.Stage.render(l,n),l.destroy(!0);try{o.destroyGC(!0)}catch(c){}s.src="",r!=null&&r(n)}else r(s)},s.src=a.data}else r()};BFN.SingletonQueue.add(()=>{BFN.OverlaysThumbLoader=new Gr});var mh=class{constructor(){this.init()}init(){}load(e,t,r,a){e=e.split(" ").join("-");let s=`${BFN.overlaysUrl+e}/${t}.png`;BFN.RequestUtils.getBase64(s,({error:o,base64:n})=>{if(o){BeFunky.logError(o),BeFunky.hideLoadScreen();return}if(n.includes("data:image")||(n=`data:image/png;base64,${n}`),a)return r(n);let l=new Image;l.onload=()=>{let c=new PIXI.Texture(new PIXI.BaseTexture(l)),h=PIXI.RenderTexture.create(c.width,c.height);h.copyPixels(c),c.destroyGC(!0),c=null,r(h)},l.src=n})}};BFN.SingletonQueue.add(()=>{BFN.OverlaysItemLoader=new mh});var ph=class{constructor(){}getPotRenderTarget(){BFN.Stage.filterManager.getPotRenderTarget=function(t,r,a,s){r=r*s,a=a*s;var o=(r&65535)<<16|a&65535;BFN.Stage.filterManager.pool[o]||(BFN.Stage.filterManager.pool[o]=[]);var n=BFN.Stage.filterManager.pool[o].pop();if(!n){var l=BFN.Stage.filterManager.renderer.boundTextures[0];t.activeTexture(t.TEXTURE0),n=new PIXI.RenderTarget(t,r,a,null,1),t.bindTexture(t.TEXTURE_2D,l._glTextures[BFN.Stage.CONTEXT_UID].texture)}return n.resolution=s,n.defaultFrame.width=n.size.width=r/s,n.defaultFrame.height=n.size.height=a/s,n}}};BFN.FilterManagerOverrider=new ph;function gr(){BFN.EventDispatcher.call(this),this.init()}gr.prototype=Object.create(BFN.EventDispatcher.prototype);gr.prototype.init=function(){BeFunky.log("FlashProjectParser Init"),this.initDefaultValues()};gr.prototype.initDefaultValues=function(){this.blendModeMap={add:BFN.CONST.BLEND_MODES.ADD,alpha:BFN.CONST.BLEND_MODES.ALPHA,darken:BFN.CONST.BLEND_MODES.DARKEN,difference:BFN.CONST.BLEND_MODES.DIFFERENCE,erase:BFN.CONST.BLEND_MODES.ERASE,hardlight:BFN.CONST.BLEND_MODES.HARD_LIGHT,invert:BFN.CONST.BLEND_MODES.DIFFERENCE,layer:BFN.CONST.BLEND_MODES.NORMAL,lighten:BFN.CONST.BLEND_MODES.LIGHTEN,multiply:BFN.CONST.BLEND_MODES.MULTIPLY,normal:BFN.CONST.BLEND_MODES.NORMAL,overlay:BFN.CONST.BLEND_MODES.OVERLAY,screen:BFN.CONST.BLEND_MODES.SCREEN,shader:BFN.CONST.BLEND_MODES.NORMAL,subtract:BFN.CONST.BLEND_MODES.SUBTRACT},this.projectVO=null,this.callback=null,this.itemOffsetX=0,this.itemOffsetY=0,this.templateElementSvgData=null,this.templateElementStates=null,this.templateElementStatesArray=[],this.queuedTemplateElementStates=[],this.designerElementSvgData=null,this.designerElementStates=null,this.designerElementStatesArray=[],this.transformImageStates=[],this.transformMaskImageStates=null,this.queuedTransformMaskImageStates=[],this.transformLabelStates=null};gr.prototype.parseFlashProject=function(i,e){if(this.projectVO)return BeFunky.logError("Already Parsing Project"),null;if(i.version!="1.0")return BeFunky.logError("Project Already Parsed"),null;if(BeFunky.showLoadScreen({isCancellable:!1}),this.projectVO=new BFN.ProjectVO,this.projectVO.version=2,this.projectVO.section="designer",this.projectVO.sourceTemplateID=i.hasOwnProperty("sourceTemplateID")?i.sourceTemplateID:null,this.projectVO.projectWidth=i.sourceTemplateWidth,this.projectVO.projectHeight=i.sourceTemplateHeight,this.projectVO.designerBackgroundColor=i.sourceTemplateBackgroundColor.toString(16),this.callback=e,this.itemOffsetX=-(this.projectVO.projectWidth/2),this.itemOffsetY=-(this.projectVO.projectHeight/2),i.sourceTemplate){if(i.sourceTemplate.hasOwnProperty("templateElementSvgData")){i.hasOwnProperty("templateElementSvgData")||(i.templateElementSvgData={});for(let t in i.templateElementStates)if(i.sourceTemplate.templateElementStates.hasOwnProperty(t)){let r=i.sourceTemplate.templateElementStates[t],a=i.templateElementStates[t];for(let s=0;s<a.length;s++)if(s<r.length){let o=r[s],n=a[s];if(o.hasOwnProperty("graphicSvgShapeData")){for(let l=0;l<o.graphicSvgShapeData.length;l++){let h=o.graphicSvgShapeData[l].svgID;i.sourceTemplate.templateElementSvgData.hasOwnProperty(h)&&!i.templateElementSvgData.hasOwnProperty(h)&&(i.templateElementSvgData[h]=i.sourceTemplate.templateElementSvgData[h])}n.graphicSvgShapeData=o.graphicSvgShapeData}}}}for(let t=0;t<i.transformMaskImageStates.length;t++){let r=i.transformMaskImageStates[t];if(r.maskImageURL&&r.maskImageBase64&&(r.maskImageOriginalTemplateID=null),r.maskImageOriginalTemplateID)for(let a=0;a<i.sourceTemplate.transformMaskImageStates.length;a++){let s=i.sourceTemplate.transformMaskImageStates[a];s.maskImageOriginalTemplateID&&s.maskImageOriginalTemplateID==r.maskImageOriginalTemplateID&&s.maskImageBase64&&(r.maskImageBase64=s.maskImageBase64)}}}this.templateElementSvgData=i.templateElementSvgData,this.templateElementStates=i.templateElementStates,this.templateElementStatesArray.splice(0),this.queuedTemplateElementStates.splice(0);for(let t in this.templateElementStates){let r=this.templateElementStates[t];for(let a=0;a<r.length;a++)r[a].svgID=t+"_"+a,this.templateElementStatesArray.push(r[a]),this.queuedTemplateElementStates.push(r[a])}this.designerElementSvgData=i.designerElementSvgData,this.designerElementStates=i.designerElementStates,this.designerElementStatesArray.splice(0);for(let t in this.designerElementStates)for(let r in this.designerElementStates[t])if(this.designerElementSvgData.hasOwnProperty(r)){let a=this.designerElementStates[t][r];for(let s=0;s<a.length;s++)a[s].svgID=r,this.designerElementStatesArray.push(a[s])}this.transformImageStates.splice(0),this.transformMaskImageStates=i.transformMaskImageStates,this.queuedTransformMaskImageStates.splice(0);for(let t=0;t<this.transformMaskImageStates.length;t++)this.queuedTransformMaskImageStates.push(this.transformMaskImageStates[t]);this.transformLabelStates=i.transformLabelStates,this.processQueuedTemplateElementStates()};gr.prototype.processQueuedTemplateElementStates=function(){if(this.queuedTemplateElementStates.length){let i=this.queuedTemplateElementStates.shift();if(i.graphicSvgShapeData&&i.graphicSvgShapeData.length){let e=null,t=i.graphicSvgShapeData.length;for(;--t>-1;){let r=i.graphicSvgShapeData[t];if(r.hasOwnProperty("svgImage")){e=r;break}}if(e){i.graphicSvgShapeData.splice(0),i.graphicSvgShapeData=null,delete i.graphicSvgShapeData,i.imageID=e.svgID,i.imageBase64=e.svgImage;for(let r=0;r<this.templateElementStatesArray.length;r++)if(this.templateElementStatesArray[r]==i){this.templateElementStatesArray.splice(r,1);break}this.transformImageStates.push(i),this.processQueuedTemplateElementStates()}else BFN.SVGManager.combineSVGs(i.graphicSvgShapeData,this.templateElementSvgData,function(r){if(r)i.svgID=r;else{let a=this.templateElementStates.indexOf(i);a!=-1&&this.templateElementStates.splice(a,1)}this.processQueuedTemplateElementStates()}.bind(this))}else this.processQueuedTemplateElementStates()}else this.processQueuedTransformMaskImageStates()};gr.prototype.processQueuedTransformMaskImageStates=function(){if(this.queuedTransformMaskImageStates.length){let i=this.queuedTransformMaskImageStates.shift();if(i.hasOwnProperty("maskImageMaskSvgShapeData")){let e=i.maskImageMaskSvgShapeData;e&&e.length?BFN.SVGManager.combineSVGs(e,this.templateElementSvgData,function(t){if(t)i.maskSvgID=t;else{let r=this.transformMaskImageStates.indexOf(i);r!=-1&&this.transformMaskImageStates.splice(r,1)}this.processQueuedTemplateElementStates()}.bind(this),!0,!0):this.processQueuedTransformMaskImageStates()}else this.processQueuedTransformMaskImageStates()}else this.buildProjectVO()};gr.prototype.buildProjectVO=function(){if(this.projectVO&&this.callback){for(let i in this.designerElementSvgData)this.projectVO.svgData.hasOwnProperty(i)||(this.projectVO.svgData[i]=this.designerElementSvgData[i]);for(let i in BFN.SVGManager.cachedCombinedSVGs)this.projectVO.svgData.hasOwnProperty(i)||(this.projectVO.svgData[i]=BFN.SVGManager.cachedCombinedSVGs[i]);BFN.SVGManager.clearCache();for(let i=0;i<this.templateElementStatesArray.length;i++){let e=this.templateElementStatesArray[i],t=new BFN.ProjectItemVO;t.type="graphic",t.graphicID=e.svgID,this.transferTransformProperties(t,e),this.projectVO.transformGraphics.push(t)}for(let i=0;i<this.designerElementStatesArray.length;i++){let e=this.designerElementStatesArray[i],t=new BFN.ProjectItemVO;t.type="graphic",t.graphicID=e.svgID,this.transferTransformProperties(t,e),this.projectVO.transformGraphics.push(t)}for(let i=0;i<this.transformImageStates.length;i++){let e=this.transformImageStates[i],t=null;if(e.hasOwnProperty("imageID")&&e.imageID!=null&&(t="image_"+BeFunky.hash(e.imageID).toString(36)),t&&e.imageBase64){this.projectVO.imageData.hasOwnProperty(t)||(this.projectVO.imageData[t]=e.imageBase64);let r=new BFN.ProjectItemVO;r.type="image",r.imageID=t,this.transferTransformProperties(r,e),this.projectVO.transformImages.push(r)}}for(let i=0;i<this.transformMaskImageStates.length;i++){let e=this.transformMaskImageStates[i],t=null;if(e.hasOwnProperty("maskImageOriginalTemplateID")&&e.maskImageOriginalTemplateID!=null?t="mask_image_"+BeFunky.hash(e.maskImageOriginalTemplateID).toString(36):e.hasOwnProperty("maskImageURL")&&e.maskImageURL!=null&&(t="mask_image_"+BeFunky.hash(e.maskImageURL).toString(36)),t&&e.maskImageBase64){this.projectVO.imageData.hasOwnProperty(t)||(this.projectVO.imageData[t]=e.maskImageBase64);let r=new BFN.ProjectItemVO;r.type="mask_image",r.maskImageID=t,r.maskImageFlashVars={},r.maskImageFlashVars.maskImageX=e.maskImageBitmapX,r.maskImageFlashVars.maskImageY=e.maskImageBitmapY,r.maskImageFlashVars.maskImageScaleX=e.maskImageBitmapScaleX,r.maskImageFlashVars.maskImageScaleY=e.maskImageBitmapScaleY,r.maskImageFlashVars.maskImageWidth=e.maskImageItemWidth,r.maskImageFlashVars.maskImageHeight=e.maskImageItemHeight,e.hasOwnProperty("maskSvgID")&&(r.maskImageMaskID=e.maskSvgID),this.transferTransformProperties(r,e),this.projectVO.transformMaskImages.push(r)}}for(let i=0;i<this.transformLabelStates.length;i++){let e=this.transformLabelStates[i],t=new BFN.ProjectItemVO;t.type="label",t.labelText=e.labelText,t.labelTextStyles=e.labelTextStyles,t.labelWidth=Math.ceil(e.labelWidth)+2;let r=(t.labelWidth+BFN.TransformItemTextBaseFontSize)*e.scale;if(t.labelTextScale=r>BFN.maxImageSize?BFN.maxImageSize/t.labelWidth:e.scale,t.labelTextItemScale=r>BFN.maxImageSize?r/BFN.maxImageSize:1,e.hasOwnProperty("accurateBounds")&&e.accurateBounds)t.labelBounds=new BFN.Rectangle(e.accurateBounds.x+this.itemOffsetX,e.accurateBounds.y+this.itemOffsetY,e.accurateBounds.width,e.accurateBounds.x.height);else{let a=e.rotation*(Math.PI/180),s={distance:e.scale*5,direction:Math.PI/4+a};if(t.positionOffsetVectors=[s],t.labelText.length&&t.labelTextStyles.styles[0]&&t.labelTextStyles.styles[0][0]){let o=t.labelTextStyles.styles[0][0],n={distance:e.scale*2,direction:Math.PI/4+a};if(t.positionOffsetVectors.push(n),o.hasOwnProperty("fontFamily")&&o.hasOwnProperty("fontSize")&&BFN.FontOffsetVectors.hasOwnProperty(o.fontFamily)){let l=BFN.FontOffsetVectors[o.fontFamily],c=l.distance/100*(o.fontSize*e.scale),h=l.direction+a;t.positionOffsetVectors.push({distance:c,direction:h})}else console.log(o.fontFamily+" not found in BFN.FontOffsetVectors, Final Offset Not Applied : "+t.labelText)}}this.transferTransformProperties(t,e),this.projectVO.transformLabels.push(t)}BeFunky.hideLoadScreen(),this.callback(this.projectVO),this.projectVO=null}};gr.prototype.transferTransformProperties=function(i,e){i.transformZIndex=e.zIndex,i.transformLocked=e.locked,i.transformX=e.x+this.itemOffsetX,i.transformY=e.y+this.itemOffsetY,i.transformRotation=e.rotation*(Math.PI/180),i.transformScale=e.scale,i.transformScaleX=e.scaleX,i.transformScaleY=e.scaleY,i.transformFlippedHorizontal=e.flippedHorizontal,i.transformFlippedVertical=e.flippedVertical,i.transformOpacity=e.opacity,i.transformBlendMode=this.blendModeMap.hasOwnProperty(e.blendMode)?this.blendModeMap[e.blendMode]:BFN.CONST.BLEND_MODES.NORMAL,i.transformOverlayColor=e.tintColorEnabled?e.tintColor.toString(16):-1,i.transformOverlayColorIntensity=e.tintColorEnabled?e.tintMultiplier:0,i.transformTintColor=-1};BFN.SingletonQueue.add(function(){BFN.FlashProjectParser=new gr});var Ir=!(BeFunky.isTWA||BeFunky.isAppleAppStoreApp);BFN.UIMenuData={mainMenus:{editor:[{id:"editor_main_image_manager",name:"image_manager",icon:"image-icon"},{id:"editor_main_edit",name:"edit",icon:"edit-icon"},{id:"editor_main_touch_up",name:"touchup",icon:"touchup-icon"},{id:"editor_main_effect",name:"effects",icon:"effects-icon"},{id:"editor_main_artsy",name:"artsy",icon:"artsy-icon"},{id:"editor_main_frame",name:"frames",icon:"frames-icon"},{id:"editor_main_graphic",name:"graphics",icon:"graphics-icon"},{id:"editor_main_overlay",name:"overlays",icon:"overlays-icon"},{id:"editor_main_text",name:"text",icon:"text-icon"},{id:"editor_main_texture",name:"textures",icon:"textures-icon"}],collage:[{id:"collage_main_image_manager",name:"image_manager",icon:"image-icon"},{id:"collage_main_customize",name:"customize",icon:"edit-horizontal-icon"},{id:"collage_main_layouts",name:"layouts",icon:"layouts-icon"},{id:"collage_main_patterns",name:"patterns",icon:"patterns-icon"},{id:"collage_main_graphic",name:"graphics",icon:"graphics-icon"},{id:"collage_main_text",name:"text",icon:"text-icon"}],designer:[{id:"designer_main_image_manager",name:"image_manager",icon:"image-icon"},{id:"designer_main_customize",name:"customize",icon:"edit-horizontal-icon"},{id:"designer_main_templates",name:"templates",icon:"templates-icon"},{id:"designer_main_graphic",name:"graphics",icon:"graphics-icon"},{id:"designer_main_text",name:"text",icon:"text-icon"}]},accordionMenus:{editor_edit:[{name:"enhance_dlx",isOpen:!1,items:[{id:"editor_edit_hdr_dlx",name:"HDR DLX",icon:"hdr-dlx-icon",isPlus:!0},{id:"editor_edit_sharpen_dlx",name:"Sharpen DLX",icon:"sharpen-dlx-icon",isPlus:!0},{id:"editor_edit_vibrant_colors_dlx",name:"Vibrant Colors DLX",icon:"vibrant-colors-dlx-icon",isPlus:!0},{id:"editor_edit_denoise_dlx",name:"Denoise DLX",icon:"denoise-dlx-icon",isPlus:!0}]},{name:"essentials",items:[{id:"editor_edit_crop",name:"crop",icon:"crop-icon",iconStroke:!1},{id:"editor_edit_resize",name:"resize",icon:"resize-icon"},{id:"editor_edit_rotate",name:"rotate",icon:"rotate-icon"},{id:"editor_edit_cutout",name:"cutout",icon:"cutout-icon",isPlus:!0},{id:"editor_edit_background",name:"background",icon:"background-icon",isPlus:!0},{id:"editor_edit_replace_color",name:"replace_color",icon:"color-picker-icon",isPlus:!0},{id:"editor_edit_exposure",name:"exposure",icon:"exposure-icon"},{id:"editor_edit_fill_light",name:"fill_light",icon:"fill-light-icon",isPlus:Ir},{id:"editor_edit_auto_enhance",name:"auto_enhance",icon:"auto-enhance-icon",isPlus:!0},{id:"editor_edit_beautify",name:"beautify",icon:"beautify-icon"},{id:"editor_edit_color",name:"color",icon:"color-icon"},{id:"editor_edit_vibrance",name:"vibrance",icon:"vibrance-icon",isPlus:Ir},{id:"editor_edit_sharpen",name:"sharpen",icon:"sharpen-icon"},{id:"editor_edit_clarity",name:"clarity",icon:"clarity-icon",isPlus:!0},{id:"editor_edit_glow",name:"glow",icon:"glow-icon",isPlus:!0},{id:"editor_edit_funky_vignette",name:"vignette",icon:"vignette-icon",isPlus:Ir}]},{name:"blur_and_smooth",items:[{id:"editor_edit_smoothing",name:"smoothing",icon:"smoothing-icon"},{id:"editor_edit_blur",name:"blur",icon:"blur-icon"},{id:"editor_edit_lens_blur",name:"lens_blur",icon:"lens-blur-icon",isPlus:!0},{id:"editor_edit_funky_focus",name:"funky_focus",icon:"funky-focus-icon",isPlus:!0},{id:"editor_edit_soften",name:"soften",icon:"soften-icon"},{id:"editor_edit_blur_edges",name:"blur_edges",icon:"blur-edges-icon"}]},{name:"miscellaneous",items:[{id:"editor_edit_tilt",name:"tilt",icon:"tilt-icon"},{id:"editor_edit_tint",name:"tint",icon:"tint-icon"},{id:"editor_edit_levels",name:"levels",icon:"levels-icon",isPlus:!0},{id:"editor_edit_color_mixer",name:"color_mixer",icon:"color-mixer-icon"}]}],editor_touch_up:[{name:"skin",items:[{id:"editor_touch_up_perfectskin",name:"skin_heal",icon:"perfect-skin-icon",isPlus:!0},{id:"editor_touch_up_wrinkles",name:"wrinkles",icon:"wrinkles-icon",isPlus:Ir},{id:"editor_touch_up_blemish_fix",name:"blemish_fix",icon:"blemish-fix-icon"},{id:"editor_touch_up_bronzer",name:"bronzer",icon:"bronzer-icon",isPlus:Ir},{id:"editor_touch_up_blush",name:"blush",icon:"blush-icon"},{id:"editor_touch_up_flashspot",name:"flashspot",icon:"flash-spot-icon",isPlus:Ir},{id:"editor_touch_up_clone",name:"clone",icon:"clone-icon",isPlus:!0}]},{name:"eyes",items:[{id:"editor_touch_up_mascara",name:"mascara",icon:"mascara-icon",isPlus:!0},{id:"editor_touch_up_eye_color",name:"eye_color",icon:"eye-color-icon",isPlus:Ir},{id:"editor_touch_up_eye_brighten",name:"eye_brighten",icon:"eye-brighten-icon",isPlus:!0},{id:"editor_touch_up_eyebrow_pencil",name:"eyebrow_pencil",icon:"eyebrow-pencil-icon",isPlus:!0},{id:"editor_touch_up_fix_redeye",name:"fix_redeye",icon:"fix-red-eye-icon"}]},{name:"mouth",items:[{id:"editor_touch_up_lipstick",name:"lipstick",icon:"lipstick-icon",isPlus:Ir},{id:"editor_touch_up_teeth_whiten",name:"teeth_whiten",icon:"teeth-whiten-icon"}]},{name:"miscellaneous",items:[{id:"editor_touch_up_hair_color",name:"hair_color",icon:"hair-color-icon",isPlus:!0},{id:"editor_touch_up_reshape",name:"reshape",icon:"reshape-icon",isPlus:!0},{id:"editor_touch_up_paint_brush",name:"paint_brush",icon:"paintbrush-icon"},{id:"editor_touch_up_slimming",name:"slimming",icon:"slimming-icon",isPlus:!0}]}]},categoryMenus:{editor_effect:[{id:"editor_effect_effect_featured",name:"Featured",icon:"featured-icon"},{id:"editor_effect_effect_favorites",name:"Favorites",icon:"favorite-star-fill-icon"},{id:"editor_effect_bwfx",name:"B&W Tones",imageName:"effect-v6"},{id:"editor_effect_warmfx",name:"Warmer Tones",imageName:"effect-v6"},{id:"editor_effect_analog",name:"Analog Tones",imageName:"effect-v6"},{id:"editor_effect_lens_flares",name:"Lens Flare",imageName:"effect-v6"},{id:"editor_effect_glitch_art",name:"Glitch Art",imageName:"effect-v6"},{id:"editor_effect_chromatic",name:"Chromatic",imageName:"effect-v6"},{id:"editor_effect_bw",name:"Black & White",imageName:"effect-v6"},{id:"editor_effect_charcoal",name:"Charcoal",imageName:"effect-v6"},{id:"editor_effect_cinematic",name:"Cinematic",imageName:"effect-v6"},{id:"editor_effect_colorpinhole",name:"Color Pinhole",imageName:"effect-v6"},{id:"editor_effect_cooler",name:"Cooler",imageName:"effect-v6"},{id:"editor_effect_crossprocess",name:"Cross Process",imageName:"effect-v6"},{id:"editor_effect_cyanotype",name:"Cyanotype",imageName:"effect-v6"},{id:"editor_effect_grungefx",name:"Grunge",imageName:"effect-v6"},{id:"editor_effect_hdr",name:"HDR",imageName:"effect-v6"},{id:"editor_effect_holgaart",name:"Holga Art",imageName:"effect-v6"},{id:"editor_effect_instant",name:"Instant",imageName:"effect-v6"},{id:"editor_effect_lineartopia",name:"Line Artopia",imageName:"effect-v6"},{id:"editor_effect_lomoart",name:"Lomo Art",imageName:"effect-v6"},{id:"editor_effect_motioncolor",name:"Motion Color",imageName:"effect-v6"},{id:"editor_effect_multimedia",name:"Multimedia",imageName:"effect-v6"},{id:"editor_effect_oldphotofx",name:"Old Photo",imageName:"effect-v6"},{id:"editor_effect_orton_style",name:"Orton Style",imageName:"effect-v6"},{id:"editor_effect_patrioticfx",name:"Patriotic",imageName:"effect-v6"},{id:"editor_effect_pinhole",name:"Pinhole",imageName:"effect-v6"},{id:"editor_effect_popartfx",name:"Pop Art",imageName:"effect-v6"},{id:"editor_effect_sepia",name:"Sepia",imageName:"effect-v6"},{id:"editor_effect_stenciler",name:"Stenciler",imageName:"effect-v6"},{id:"editor_effect_summer",name:"Summer",imageName:"effect-v6"},{id:"editor_effect_sunburst",name:"Sunburst",imageName:"effect-v6"},{id:"editor_effect_tiltshiftfx",name:"Tilt Shift",imageName:"effect-v6"},{id:"editor_effect_tinytype",name:"Tin Type",imageName:"effect-v6"},{id:"editor_effect_unitedcolors",name:"United Colors",imageName:"effect-v6"},{id:"editor_effect_warmer",name:"Warmer",imageName:"effect-v6"},{id:"editor_effect_viewfinder",name:"Viewfinder",imageName:"effect-v6"},{id:"editor_effect_vintagecolors",name:"Vintage Colors",imageName:"effect-v6"},{id:"editor_effect_winterfx",name:"Winter",imageName:"effect-v6"}].filter(Boolean),editor_artsy:[{id:"editor_artsy_artsy_favorites",name:"favorites",icon:"favorite-star-fill-icon"},{id:"editor_artsy_digitalart",name:"artsy_digital_art",imageName:"artsy-v4"},{id:"editor_artsy_cartoonizer",name:"artsy_cartoonizer",imageName:"artsy-v4"},{id:"editor_artsy_polyart",name:"artsy_poly_art",imageName:"artsy-v4"},{id:"editor_artsy_mosaic",name:"artsy_mosaic",imageName:"artsy-v4"},{id:"editor_artsy_pastel",name:"artsy_pastel",imageName:"artsy-v4"},{id:"editor_artsy_penart",name:"artsy_pen_art",imageName:"artsy-v4"},{id:"editor_artsy_gouache",name:"artsy_gouache",imageName:"artsy-v4"},{id:"editor_artsy_impressionist",name:"artsy_impressionist",imageName:"artsy-v4"},{id:"editor_artsy_inkify",name:"artsy_inkify",imageName:"artsy-v4"},{id:"editor_artsy_oilpainting",name:"artsy_oil_painting",imageName:"artsy-v4"},{id:"editor_artsy_pointillism",name:"artsy_pointillism",imageName:"artsy-v4"},{id:"editor_artsy_sketcher",name:"artsy_sketcher",imageName:"artsy-v4"},{id:"editor_artsy_underpainting",name:"artsy_underpainting",imageName:"artsy-v4"},{id:"editor_artsy_watercolor",name:"artsy_watercolor",imageName:"artsy-v4"}].filter(Boolean),editor_frame:[{id:"editor_frame_frame_featured",name:"featured",icon:"featured-icon"},{id:"editor_frame_frame_square",name:"frame_square",imageName:"frame-v3"},{id:"editor_frame_frame_border",name:"frame_border",imageName:"frame-v3"},{id:"editor_frame_frame_drop_shadow",name:"frame_drop_shadow",imageName:"frame-v3"},{id:"editor_frame_frame_decorative",name:"frame_decorative",imageName:"frame-v3"},{id:"editor_frame_frame_vintage",name:"frame_vintage",imageName:"frame-v3"},{id:"editor_frame_frame_art_deco",name:"frame_art_deco",imageName:"frame-v3"},{id:"editor_frame_frame_floral",name:"frame_floral",imageName:"frame-v3"},{id:"editor_frame_frame_rustic",name:"frame_rustic",imageName:"frame-v3"},{id:"editor_frame_frame_lace",name:"frame_lace",imageName:"frame-v3"},{id:"editor_frame_frame_ornament",name:"frame_ornament",imageName:"frame-v3"},{id:"editor_frame_frame_hand_drawn",name:"frame_hand_drawn",imageName:"frame-v3"},{id:"editor_frame_frame_instant",name:"frame_instant",imageName:"frame-v3"},{id:"editor_frame_frame_grunge",name:"frame_grunge",imageName:"frame-v3"},{id:"editor_frame_frame_filmstrip",name:"frame_film_strip",imageName:"frame-v3"},{id:"editor_frame_frame_realistic",name:"frame_realistic",imageName:"frame-v3"}],editor_overlay:[{id:"editor_overlay_circular",name:"overlay_circular",imageName:"overlay-v2"},{id:"editor_overlay_brushes",name:"overlay_brushes",imageName:"overlay-v2"},{id:"editor_overlay_floral",name:"overlay_floral",imageName:"overlay-v2"},{id:"editor_overlay_holiday_earth_day",name:"overlay_earth_day",imageName:"overlay-v2"},{id:"editor_overlay_geometry",name:"overlay_geometry",imageName:"overlay-v2"},{id:"editor_overlay_a_z",name:"overlay_alphabet",imageName:"overlay-v2"},{id:"editor_overlay_animals",name:"overlay_animals",imageName:"overlay-v2"},{id:"editor_overlay_hearts",name:"overlay_hearts",imageName:"overlay-v2"},{id:"editor_overlay_halloween",name:"overlay_halloween",imageName:"overlay-v2"},{id:"editor_overlay_st_patricks_day",name:"overlay_st_patricks_day",imageName:"overlay-v2"},{id:"editor_overlay_valentines_day",name:"overlay_valentines_day",imageName:"overlay-v2"},{id:"editor_overlay_numbers",name:"overlay_numbers",imageName:"overlay-v2"},{id:"editor_overlay_patterns",name:"overlay_patterns",imageName:"overlay-v2"},{id:"editor_overlay_sports",name:"overlay_sports",imageName:"overlay-v2"},{id:"editor_overlay_symbols",name:"overlay_symbols",imageName:"overlay-v2"},{id:"editor_overlay_winter_holidays",name:"overlay_winter_holidays",imageName:"overlay-v2"}],editor_text:[],editor_texture:[{id:"editor_texture_texture_featured",name:"featured",icon:"featured-icon"},{id:"editor_texture_bokeh",name:"texture_bokeh",imageName:"textures-v2"},{id:"editor_texture_scratches",name:"texture_scratches",imageName:"textures-v2"},{id:"editor_texture_light",name:"texture_light_trails",imageName:"textures-v2"},{id:"editor_texture_lightleak",name:"texture_light_leaks",imageName:"textures-v2"},{id:"editor_texture_fabric",name:"texture_fabric",imageName:"textures-v2"},{id:"editor_texture_grunge",name:"texture_grunge",imageName:"textures-v2"},{id:"editor_texture_paint",name:"texture_paint",imageName:"textures-v2"},{id:"editor_texture_metal",name:"texture_metal",imageName:"textures-v2"},{id:"editor_texture_bricks",name:"texture_bricks",imageName:"textures-v2"},{id:"editor_texture_paper",name:"texture_paper",imageName:"textures-v2"}],collage_layouts:[{id:"collage_layouts_featured",name:"Featured",icon:"featured-icon"},{id:"collage_layouts_grid",name:"Grid",icon:"collage-grid-icon"},{id:"collage_layouts_big_photo_wrap",name:"Big Photo Wrap",icon:"collage-photo-wrap-icon"},{id:"collage_layouts_shape",name:"Shape",icon:"collage-shape-icon"},{id:"collage_layouts_facebook",name:"Facebook Cover",icon:"facebook-social-icon"},{id:"collage_layouts_pinterest",name:"Pinterest",icon:"pinterest-circle-icon"}],collage_patterns:[{id:"collage_patterns_featured",name:"featured",icon:"featured-icon"},{id:"collage_patterns_autumn",name:"pattern_autumn",imageName:"pattern-v2"},{id:"collage_patterns_fabric",name:"pattern_fabric",imageName:"pattern-v2"},{id:"collage_patterns_fancy",name:"pattern_fancy",imageName:"pattern-v2"},{id:"collage_patterns_geometric",name:"pattern_geometric",imageName:"pattern-v2"},{id:"collage_patterns_polka_dots",name:"pattern_polka_dots",imageName:"pattern-v2"},{id:"collage_patterns_stripes",name:"pattern_stripes",imageName:"pattern-v2"},{id:"collage_patterns_summer",name:"pattern_summer",imageName:"pattern-v2"},{id:"collage_patterns_love",name:"pattern_love",imageName:"pattern-v2"},{id:"collage_patterns_winter",name:"pattern_winter",imageName:"pattern-v2"}],customize_submenu:[{id:"customize_submenu_background",name:"background_color",icon:"color-swatch-icon"},{id:"customize_submenu_spacing",name:"spacing",icon:"spacing-icon",onlyCollage:!0},{id:"customize_submenu_resize",name:"resize",icon:"resize-icon"},{id:"customize_submenu_rotate",name:"rotate",icon:"rotate-icon",onlyCollage:!0}]}};BFN.accordionMenuPlusIDs=[];for(let i in BFN.UIMenuData.accordionMenus){let e=BFN.UIMenuData.accordionMenus[i];for(let t=0;t<e.length;t++){let r=e[t];for(let a=0;a<r.items.length;a++){let s=r.items[a];s.hasOwnProperty("isPlus")&&s.isPlus&&BFN.accordionMenuPlusIDs.push(s.id.replace(`${i}_`,""))}}}BFN.customizeTertiaryMenus={};BFN.UIMenuData.categoryMenus.customize_submenu.forEach(i=>{BFN.customizeTertiaryMenus[`${i.id}_menu`]=i});var So=["dark","light"],Io=FI();function Ii(){return Io}function FI(){let i=BeFunky.getLocal("app_theme");return So.includes(i)?i:So[0]}var vs=[];Hr(i=>{BeFunky.setLocal("app_theme",i),window.isAppOpen&&BeFunky.updateThemeColor("app")});function fh(i){if(!So.includes(i))throw new Error(`Invalid theme value: ${BeFunky.stringValue(i)}`);Io=i,vs.forEach(e=>e(i))}function Hr(i,e=!0){vs.push(i),e&&i(Io)}function gh(i){vs=vs.filter(e=>e!==i)}BFN.getTheme=Ii;var _o=[{name:"dark",hex:1842470},{name:"light",hex:16448250}],vh=bI();function ht(){return vh}function bI(){let i=BeFunky.getLocal("app_canvas_bg");return _o.find(({name:e})=>e===i)||_o[0]}var yh=[];ui(({name:i})=>BeFunky.setLocal("app_canvas_bg",i));function xh(i){let e=_o.find(({name:t})=>t===i);if(!e)throw new Error(`Invalid bgColorName value: ${BeFunky.stringValue(i)}`);vh=e,yh.forEach(t=>t(e))}function ui(i){yh.push(i)}BFN.getCanvasBgColor=ht;var Co=!(BeFunky.isTWA||BeFunky.isAppleAppStoreApp);BFN.DropDownData={blendModes:[{name:"normal",value:BFN.CONST.BLEND_MODES.NORMAL},{name:"overlay",value:BFN.CONST.BLEND_MODES.OVERLAY},{name:"soft_light",value:BFN.CONST.BLEND_MODES.SOFT_LIGHT},{name:"multiply",value:BFN.CONST.BLEND_MODES.MULTIPLY},{name:"screen",value:BFN.CONST.BLEND_MODES.SCREEN},{name:"add",value:BFN.CONST.BLEND_MODES.ADD,hasDivider:!0},{name:"lighten",value:BFN.CONST.BLEND_MODES.LIGHTEN},{name:"darken",value:BFN.CONST.BLEND_MODES.DARKEN},{name:"color_dodge",value:BFN.CONST.BLEND_MODES.COLOR_DODGE},{name:"color_burn",value:BFN.CONST.BLEND_MODES.COLOR_BURN},{name:"linear_burn",value:BFN.CONST.BLEND_MODES.LINEAR_BURN,hasDivider:!0},{name:"hard_light",value:BFN.CONST.BLEND_MODES.HARD_LIGHT},{name:"vivid_light",value:BFN.CONST.BLEND_MODES.VIVID_LIGHT},{name:"linear_light",value:BFN.CONST.BLEND_MODES.LINEAR_LIGHT},{name:"pin_light",value:BFN.CONST.BLEND_MODES.PIN_LIGHT,hasDivider:!0},{name:"difference",value:BFN.CONST.BLEND_MODES.DIFFERENCE},{name:"exclusion",value:BFN.CONST.BLEND_MODES.EXCLUSION},{name:"subtract",value:BFN.CONST.BLEND_MODES.SUBTRACT},{name:"color",value:BFN.CONST.BLEND_MODES.COLOR},{name:"hue",value:BFN.CONST.BLEND_MODES.HUE},{name:"luminosity",value:BFN.CONST.BLEND_MODES.LUMINOSITY}],languages:BeFunky.LanguageManager.getLanguageNames().map(({id:i,name:e})=>({name:e,value:i})),cropAspectRatios:[{name:"freeform",value:"freeform"},{name:"original_ratio",value:"original_ratio"},{name:"golden_ratio",value:"golden_ratio"},{name:"square_1x1",value:"square_1x1"},{name:"photo_4x6",value:"photo_4x6"},{name:"photo_5x7",value:"photo_5x7"},{name:"photo_8x10",value:"photo_8x10"},{name:"photo_11x14",value:"photo_11x14"},{name:"photo_16x9",value:"photo_16x9"},{name:"image_3x2",value:"image_3x2"},{name:"image_4x3",value:"image_4x3"},{name:"cinema_1_375x1",value:"cinema_1_375x1"},{name:"cinema_1_85x1",value:"cinema_1_85x1"},{name:"cinema_2_20x1",value:"cinema_2_20x1"},{name:"facebook_cover",value:"facebook_cover"},{name:"photo_twitter",value:"photo_twitter"},{name:"photo_youtube_cover",value:"photo_youtube_cover"},{name:"photo_pinterest_pin",value:"photo_pinterest_pin"}],batchResizeOptions:[{name:"scale",value:"scale"},{name:"longest_side",value:"longest_side"},{name:"width",value:"width"},{name:"height",value:"height"},{name:"exact_size",value:"exact_size"}],resizeTemplateSizes:[{name:"Freeform",value:"freeform"},{name:"social_media",isHeader:!0},{name:"Presentation (4:3)",description:"1024 x 768px",value:"1024 x 768"},{name:"Presentation (16:9)",description:"1920 x 1080px",value:"1920 x 1080"},{name:"Social Media Story",description:"1080 x 1920px",value:"1080 x 1920"},{name:"Instagram Post",description:"1080 x 1080px",value:"1080 x 1080"},{name:"Facebook Post",description:"1200 x 1200px",value:"1200 x 1200"},{name:"Facebook Cover / Page Cover",description:"1702 x 630px",value:"1702 x 630"},{name:"Facebook Event Cover",description:"1920 x 1080px",value:"1920 x 1080(2)"},{name:"YouTube Channel Art",description:"2560 x 1440px",value:"2560 x 1440"},{name:"YouTube Thumbnail",description:"1280 x 720px",value:"1280 x 720"},{name:"Twitter Post",description:"1200 x 675px",value:"1200 x 675"},{name:"Twitter Header",description:"1500 x 500px",value:"1500 x 500"},{name:"Pinterest Pin",description:"1000 x 1500px",value:"1000 x 1500"},{name:"Etsy Big Banner",description:"3360 x 840px",value:"3360 x 840"},{name:"Etsy Mini Banner",description:"3360 x 448px",value:"3360 x 448"},{name:"Etsy Order Receipt Banner",description:"760 x 100px",value:"760 x 100"},{name:"print",isHeader:!0},{name:"Square",description:'11 x 11"',value:"3300 x 3300"},{name:"Business Card",description:'3.5 x 2"',value:"1050 x 600"},{name:"Thank You Card",description:'5 x 3"',value:"1500 x 900"},{name:"Postcard",description:'6 x 4"',value:"1800 x 1200"},{name:"Greeting Card",description:'7 x 5"',value:"2100 x 1500"},{name:"Half Letter",description:'5.5 x 8.5"',value:"1650 x 2550"},{name:"Rack Card",description:"4 x 9",value:"1200 x 2700"},{name:"Letter",description:'8.5 x 11"',value:"2550 x 3300"},{name:"A4",description:"21 x 29.7cm",value:"2481 x 3507"},{name:"Poster",description:'11 x 17"',value:"2640 x 4080"},{name:"online_advertising",isHeader:!0},{name:"Facebook Ad",description:"1200 x 628px",value:"1200 x 628"},{name:"Skyscraper",description:"120 x 600px",value:"120 x 600"},{name:"Wide Skyscraper",description:"160 x 600px",value:"160 x 600"},{name:"Leaderboard",description:"728 x 90px",value:"728 x 90"},{name:"Large Leaderboard",description:"728 x 210px",value:"728 x 210"},{name:"Medium Rectangle",description:"300 x 250px",value:"300 x 250"},{name:"Large Rectangle",description:"336 x 280px",value:"336 x 280"},{name:"Half Page",description:"300 x 600px",value:"300 x 600"},{name:"Large Mobile",description:"320 x 100px",value:"320 x 100"}],autosaveOptions:[{name:"autosave_yes",value:"yes"},{name:"autosave_no",value:"no"},{name:"ask_me",value:"ask"}],addTextModes:[{name:"after_name",value:"after"},{name:"before_name",value:"before"}],watermarkPlacements:[{name:"top_left",value:"tl"},{name:"top_center",value:"tc"},{name:"top_right",value:"tr"},{name:"middle_left",value:"ml"},{name:"middle_center",value:"mc"},{name:"middle_right",value:"mr"},{name:"bottom_left",value:"bl"},{name:"bottom_center",value:"bc"},{name:"bottom_right",value:"br"}],noise_distributions:[{name:"uniform",value:1},{name:"triangular",value:2},{name:"gaussian",value:3},{name:"gaussian_plus",value:4}]};BFN.CropRatioMap={freeform:-1,original_ratio:-1,golden_ratio:1/1.61803398875,square_1x1:1,photo_4x6:4/6,photo_5x7:5/7,photo_8x10:8/10,photo_11x14:11/14,photo_16x9:9/16,image_3x2:2/3,image_4x3:3/4,cinema_1_375x1:1/1.375,cinema_1_85x1:1/1.85,cinema_2_20x1:1/2.2,facebook_cover:315/851,photo_twitter:500/1500,photo_youtube_cover:1440/2560,photo_pinterest_pin:735/1102};BFN.UIToolData={app_goto:{controls:{app_goto_photo_editor:{type:"button"},app_goto_collage_maker:{type:"button"},app_goto_designer:{type:"button"},app_goto_edit_source_section:{type:"button"}}},editor_load_image:{controls:{editor_load_image_computer:{type:"button"},editor_load_image_befunky:{type:"button"},editor_load_image_google_drive:{type:"button"},editor_load_image_google_photos:{type:"button"},editor_load_image_stock_images:{type:"button"},editor_load_image_facebook:{type:"button"},editor_load_image_dropbox:{type:"button"},editor_load_image_webcam:{type:"button"},editor_load_image_camera:{type:"button"}}},designer_open:{controls:{designer_open_blank_canvas:{type:"button"},designer_open_template:{type:"button"}}},open_project:{controls:{open_project_computer:{type:"button"},open_project_befunky:{type:"button"}}},editor_save_image:{controls:{editor_save_image_computer:{type:"button"},editor_save_image_navigator_share:{type:"button"},editor_save_image_befunky:{type:"button"},editor_save_image_google_drive:{type:"button"},editor_save_image_google_photos:{type:"button"},editor_save_image_dropbox:{type:"button"},editor_save_image_project:{type:"button"},editor_save_image_more_for_mobile:{type:"button"},editor_save_image_facebook:{type:"button"},editor_save_image_pinterest:{type:"button"},editor_save_image_twitter:{type:"button"}}},editor_history_action:{controls:{editor_history_action_undo:{type:"button"},editor_history_action_redo:{type:"button"},editor_history_action_reset:{type:"button"}}},user_account:{ignoreInitialControlRegister:!0,controls:{user_account_upgrade:{type:"button"},user_account_sign_in:{type:"button"},user_account_sign_up:{type:"button"},user_account_logout:{type:"button"},user_account_settings:{type:"button"},user_account_feedback:{type:"button"},user_account_canvas_bg_color:{type:"button"},user_account_theme:{type:"button"}}},user_settings:{controls:{user_settings_autosave:{type:"dropdown_item",name:"autosave",data:BFN.DropDownData.autosaveOptions,defaultValue:"ask",useLabel:!1},user_settings_theme_color:{type:"radio",defaultValue:Ii(),buttons:[{value:"dark",langID:"theme_dark"},{value:"light",langID:"theme_light"}]},user_settings_canvas_bg_color:{type:"radio",defaultValue:ht().name,buttons:[{value:"dark",langID:"theme_dark"},{value:"light",langID:"theme_light"}]}}},editor_flatten:{controls:{editor_flatten_flatten_layers:{type:"button"}}},batch_processing:{controls:{batch_processing_open_modal:{type:"button"},batch_processing_section:{type:"static",defaultValue:null},batch_processing_manage_tools:{type:"button"},batch_processing_cancel:{type:"button"},batch_processing_apply:{type:"button"},batch_processing_load_images:{type:"button"},batch_processing_clear_images:{type:"button"},batch_processing_save_images:{type:"button"},batch_processing_upgrade:{type:"button"},batch_processing_background_color:{type:"color_item",name:"background_color",defaultValue:-1,fineChangeEnabled:!0},batch_processing_image_type:{type:"toggle_group",defaultValue:"jpg",buttons:[{value:"jpg",langID:"JPG"},{value:"png",langID:"PNG"}]},batch_processing_image_quality:{type:"slider_item",name:"quality",unit:"",multiplier:1,min:0,max:100,step:1,defaultValue:98},batch_processing_add_text:{type:"textinput",defaultValue:""},batch_processing_add_text_mode:{type:"dropdown_item",name:"add_text_mode",data:BFN.DropDownData.addTextModes,defaultValue:"after",useLabel:!1}}},batch_resize:{controls:{batch_resize_mode:{type:"dropdown_item",name:"resize_by",data:BFN.DropDownData.batchResizeOptions},batch_resize_scale:{type:"scrubber",min:0,defaultValue:100,unit:"%"},batch_resize_longest_side:{type:"scrubber",min:BFN.minImageSize,max:BFN.maxImageSize,defaultValue:800,unit:"px"},batch_resize_width:{type:"scrubber",min:BFN.minImageSize,max:BFN.maxImageSize,defaultValue:800,unit:"px"},batch_resize_height:{type:"scrubber",min:BFN.minImageSize,max:BFN.maxImageSize,defaultValue:600,unit:"px"},batch_resize_exact_width:{type:"scrubber",min:BFN.minImageSize,max:BFN.maxImageSize,defaultValue:800,unit:"px"},batch_resize_exact_height:{type:"scrubber",min:BFN.minImageSize,max:BFN.maxImageSize,defaultValue:600,unit:"px"},batch_resize_use_padding:{type:"checkbox_item",name:"use_padding",defaultValue:!0}}},batch_crop:{controls:{batch_crop_aspect_ratio:{type:"dropdown_item",name:"aspect_ratio",data:BFN.DropDownData.cropAspectRatios},batch_crop_orientation:{type:"toggle_group",defaultValue:"landscape",buttons:["landscape","portrait"]},batch_crop_focal_point_auto:{type:"button"},batch_crop_focal_point_align:{type:"button"},batch_crop_focal_point_tl:{type:"button"},batch_crop_focal_point_tc:{type:"button"},batch_crop_focal_point_tr:{type:"button"},batch_crop_focal_point_ml:{type:"button"},batch_crop_focal_point_mc:{type:"button"},batch_crop_focal_point_mr:{type:"button"},batch_crop_focal_point_bl:{type:"button"},batch_crop_focal_point_bc:{type:"button"},batch_crop_focal_point_br:{type:"button"},batch_crop_reset:{type:"button"}}},watermark:{controls:{watermark_upload:{type:"button"},watermark_placement_popover_button:{type:"button"},watermark_placement:{type:"toggle_group",defaultValue:"br",buttons:[{value:"tl",colorClass:"button--grey-200",icon:"arrow-icon",iconSize:16,iconStyle:"transform: rotate(225deg)"},{value:"tc",colorClass:"button--grey-200",icon:"arrow-icon",iconSize:16,iconStyle:"transform: rotate(270deg)"},{value:"tr",colorClass:"button--grey-200",icon:"arrow-icon",iconSize:16,iconStyle:"transform: rotate(315deg)"},{value:"ml",colorClass:"button--grey-200",icon:"arrow-icon",iconSize:16,iconStyle:"transform: rotate(180deg)"},{value:"mc",colorClass:"button--grey-200",text:"\u2022"},{value:"mr",colorClass:"button--grey-200",icon:"arrow-icon",iconSize:16,iconStyle:""},{value:"bl",colorClass:"button--grey-200",icon:"arrow-icon",iconSize:16,iconStyle:"transform: rotate(135deg)"},{value:"bc",colorClass:"button--grey-200",icon:"arrow-icon",iconSize:16,iconStyle:"transform: rotate(90deg)"},{value:"br",colorClass:"button--grey-200",icon:"arrow-icon",iconSize:16,iconStyle:"transform: rotate(45deg)"}]},watermark_size:{type:"slider_item",name:"size",unit:"%",multiplier:1,min:5,max:100,step:1,defaultValue:25},watermark_padding:{type:"slider_item",name:"padding",unit:"%",multiplier:1,min:0,max:100,step:1,defaultValue:5},watermark_opacity:{type:"slider_item",name:"opacity",unit:"%",multiplier:1,min:1,max:100,step:1,defaultValue:75},watermark_save:{type:"button"}}},editor_main:{viewstate:BFN.PhotoEditorCanvasModelViewStates.VIEWING_CANVAS,controls:{editor_main_image_manager:{type:"button"},editor_main_edit:{type:"button"},editor_main_touch_up:{type:"button"},editor_main_effect:{type:"button"},editor_main_artsy:{type:"button"},editor_main_frame:{type:"button"},editor_main_graphic:{type:"button"},editor_main_overlay:{type:"button"},editor_main_text:{type:"button"},editor_main_texture:{type:"button"}}},collage_main:{controls:{collage_main_image_manager:{type:"button"},collage_main_customize:{type:"button"},collage_main_layouts:{type:"button"},collage_main_patterns:{type:"button"},collage_main_graphic:{type:"button"},collage_main_text:{type:"button"}}},designer_main:{controls:{designer_main_image_manager:{type:"button"},designer_main_customize:{type:"button"},designer_main_templates:{type:"button"},designer_main_graphic:{type:"button"},designer_main_text:{type:"button"}}},editor_edit:{viewstate:BFN.PhotoEditorCanvasModelViewStates.VIEWING_CANVAS,controls:{editor_edit_ai_image:{type:"button"},editor_edit_ai_portrait:{type:"button"},editor_edit_hdr_dlx:{type:"button"},editor_edit_sharpen_dlx:{type:"button"},editor_edit_vibrant_colors_dlx:{type:"button"},editor_edit_denoise_dlx:{type:"button"},editor_edit_crop:{type:"button"},editor_edit_rotate:{type:"button"},editor_edit_resize:{type:"button"},editor_edit_background:{type:"button"},editor_edit_cutout:{type:"button"},editor_edit_funky_focus:{type:"button"},editor_edit_funky_vignette:{type:"button"},editor_edit_blur:{type:"button"},editor_edit_lens_blur:{type:"button"},editor_edit_exposure:{type:"button"},editor_edit_levels:{type:"button"},editor_edit_vibrance:{type:"button"},editor_edit_color:{type:"button"},editor_edit_replace_color:{type:"button"},editor_edit_fill_light:{type:"button"},editor_edit_sharpen:{type:"button"},editor_edit_clarity:{type:"button"},editor_edit_tint:{type:"button"},editor_edit_tilt:{type:"button"},editor_edit_beautify:{type:"button"},editor_edit_color_mixer:{type:"button"},editor_edit_soften:{type:"button"},editor_edit_smoothing:{type:"button"},editor_edit_blur_edges:{type:"button"},editor_edit_auto_enhance:{type:"button"},editor_edit_glow:{type:"button"}}},editor_touch_up:{viewstate:BFN.PhotoEditorCanvasModelViewStates.VIEWING_CANVAS,controls:{editor_touch_up_perfectskin:{type:"button"},editor_touch_up_wrinkles:{type:"button"},editor_touch_up_blemish_fix:{type:"button"},editor_touch_up_bronzer:{type:"button"},editor_touch_up_blush:{type:"button"},editor_touch_up_flashspot:{type:"button"},editor_touch_up_clone:{type:"button"},editor_touch_up_mascara:{type:"button"},editor_touch_up_eye_color:{type:"button"},editor_touch_up_eye_brighten:{type:"button"},editor_touch_up_eyebrow_pencil:{type:"button"},editor_touch_up_fix_redeye:{type:"button"},editor_touch_up_lipstick:{type:"button"},editor_touch_up_teeth_whiten:{type:"button"},editor_touch_up_hair_color:{type:"button"},editor_touch_up_reshape:{type:"button"},editor_touch_up_paint_brush:{type:"button"},editor_touch_up_slimming:{type:"button"}}},editor_effect:{viewstate:BFN.PhotoEditorCanvasModelViewStates.VIEWING_CANVAS,controls:{editor_effect_effect_featured:{type:"button"},editor_effect_effect_favorites:{type:"button"},editor_effect_lens_flares:{type:"button"},editor_effect_bwfx:{type:"button"},editor_effect_warmfx:{type:"button"},editor_effect_analog:{type:"button"},editor_effect_cinematic:{type:"button"},editor_effect_multimedia:{type:"button"},editor_effect_glitch_art:{type:"button"},editor_effect_bw:{type:"button"},editor_effect_chromatic:{type:"button"},editor_effect_charcoal:{type:"button"},editor_effect_cyanotype:{type:"button"},editor_effect_orton_style:{type:"button"},editor_effect_sepia:{type:"button"},editor_effect_viewfinder:{type:"button"},editor_effect_summer:{type:"button"},editor_effect_unitedcolors:{type:"button"},editor_effect_instant:{type:"button"},editor_effect_cooler:{type:"button"},editor_effect_warmer:{type:"button"},editor_effect_tinytype:{type:"button"},editor_effect_crossprocess:{type:"button"},editor_effect_vintagecolors:{type:"button"},editor_effect_holgaart:{type:"button"},editor_effect_lineartopia:{type:"button"},editor_effect_hdr:{type:"button"},editor_effect_pinhole:{type:"button"},editor_effect_colorpinhole:{type:"button"},editor_effect_stenciler:{type:"button"},editor_effect_grungefx:{type:"button"},editor_effect_sunburst:{type:"button"},editor_effect_oldphotofx:{type:"button"},editor_effect_winterfx:{type:"button"},editor_effect_tiltshiftfx:{type:"button"},editor_effect_patrioticfx:{type:"button"},editor_effect_popartfx:{type:"button"},editor_effect_motioncolor:{type:"button"},editor_effect_lomoart:{type:"button"}}},editor_artsy:{viewstate:BFN.PhotoEditorCanvasModelViewStates.VIEWING_CANVAS,controls:{editor_artsy_artsy_favorites:{type:"button"},editor_artsy_digitalart:{type:"button"},editor_artsy_cartoonizer:{type:"button"},editor_artsy_polyart:{type:"button"},editor_artsy_mosaic:{type:"button"},editor_artsy_pastel:{type:"button"},editor_artsy_penart:{type:"button"},editor_artsy_gouache:{type:"button"},editor_artsy_impressionist:{type:"button"},editor_artsy_inkify:{type:"button"},editor_artsy_oilpainting:{type:"button"},editor_artsy_pointillism:{type:"button"},editor_artsy_sketcher:{type:"button"},editor_artsy_underpainting:{type:"button"},editor_artsy_watercolor:{type:"button"}}},editor_frame:{viewstate:BFN.PhotoEditorCanvasModelViewStates.VIEWING_CANVAS,controls:{editor_frame_frame_featured:{type:"button"},editor_frame_frame_square:{type:"button"},editor_frame_frame_border:{type:"button"},editor_frame_frame_drop_shadow:{type:"button"},editor_frame_frame_decorative:{type:"button"},editor_frame_frame_vintage:{type:"button"},editor_frame_frame_art_deco:{type:"button"},editor_frame_frame_floral:{type:"button"},editor_frame_frame_rustic:{type:"button"},editor_frame_frame_lace:{type:"button"},editor_frame_frame_ornament:{type:"button"},editor_frame_frame_hand_drawn:{type:"button"},editor_frame_frame_instant:{type:"button"},editor_frame_frame_grunge:{type:"button"},editor_frame_frame_filmstrip:{type:"button"},editor_frame_frame_realistic:{type:"button"}}},editor_texture:{viewstate:BFN.PhotoEditorCanvasModelViewStates.VIEWING_CANVAS,controls:{editor_texture_texture_featured:{type:"button"},editor_texture_bokeh:{type:"button"},editor_texture_scratches:{type:"button"},editor_texture_light:{type:"button"},editor_texture_lightleak:{type:"button"},editor_texture_fabric:{type:"button"},editor_texture_grunge:{type:"button"},editor_texture_paint:{type:"button"},editor_texture_metal:{type:"button"},editor_texture_bricks:{type:"button"},editor_texture_paper:{type:"button"}}},editor_overlay:{viewstate:BFN.PhotoEditorCanvasModelViewStates.VIEWING_CANVAS,controls:{editor_overlay_featured:{type:"button"},editor_overlay_floral:{type:"button"},editor_overlay_holiday_earth_day:{type:"button"},editor_overlay_geometry:{type:"button"},editor_overlay_brushes:{type:"button"},editor_overlay_circular:{type:"button"},editor_overlay_a_z:{type:"button"},editor_overlay_animals:{type:"button"},editor_overlay_hearts:{type:"button"},editor_overlay_halloween:{type:"button"},editor_overlay_st_patricks_day:{type:"button"},editor_overlay_valentines_day:{type:"button"},editor_overlay_numbers:{type:"button"},editor_overlay_patterns:{type:"button"},editor_overlay_sports:{type:"button"},editor_overlay_symbols:{type:"button"},editor_overlay_winter_holidays:{type:"button"}}},editor_text:{viewstate:BFN.PhotoEditorCanvasModelViewStates.VIEWING_CANVAS,controls:{editor_text_add_text:{type:"button",preventDeselectOnDoubleClick:!0}}},editor_graphic:{viewstate:BFN.PhotoEditorCanvasModelViewStates.VIEWING_CANVAS,controls:{editor_graphic_add_layer:{type:"button"}}},collage_customize:{controls:{collage_customize_background_color:{name:"color_palette",type:"color_palette",defaultValue:"FFFFFF",colors:[["FFFFFF",BeFunky.isWiderThanMobile()?"":"DBDBDB","9B9B9B","4A4A4A","000000"],["A70C2C","DA9A15","F8E71D","47821A","4990E2",BeFunky.isWiderThanMobile()?"":"9359DB"]],presetsOnly:!1,emptyEnabled:!0,fineChangeEnabled:!0},collage_customize_spacing:{type:"slider_item",name:"spacing",unit:"%",multiplier:1,min:0,max:100,step:1,defaultValue:5},collage_customize_corner_rounding:{type:"slider_item",name:"corner_rounding",unit:"%",multiplier:1,min:0,max:100,step:1,defaultValue:0},collage_customize_rotate_ccw:{type:"button"},collage_customize_rotate_cw:{type:"button"},collage_customize_flip_h:{type:"button"},collage_customize_flip_v:{type:"button"},collage_customize_aspect_ratio:{type:"dropdown_item",name:"aspect_ratio",data:BFN.DropDownData.cropAspectRatios,hideModalVeil:!0},collage_customize_orientation:{type:"toggle_group",defaultValue:"landscape",buttons:["portrait","landscape"]},collage_customize_width:{type:"scrubber",min:BFN.minCollageSize,max:1024,defaultValue:BFN.maxImageSize,unit:"px"},collage_customize_height:{type:"scrubber",min:BFN.minCollageSize,max:1024,defaultValue:BFN.maxImageSize,unit:"px"},collage_customize_lock_aspect_ratio:{type:"checkbox_item",name:"lock_aspect_ratio",defaultValue:!1}}},customize_submenu:{controls:{customize_submenu_background:{type:"button"},customize_submenu_spacing:{type:"button"},customize_submenu_resize:{type:"button"},customize_submenu_rotate:{type:"button"}}},collage_layouts_custom:{controls:{collage_layouts_custom_collage_wizard:{type:"button"},collage_layouts_custom_create_your_own:{type:"button"}}},collage_layouts:{controls:{collage_layouts_featured:{type:"button"},collage_layouts_grid:{type:"button"},collage_layouts_big_photo_wrap:{type:"button"},collage_layouts_shape:{type:"button"},collage_layouts_facebook:{type:"button"},collage_layouts_pinterest:{type:"button"}}},collage_patterns:{controls:{collage_patterns_featured:{type:"button"},collage_patterns_autumn:{type:"button"},collage_patterns_fabric:{type:"button"},collage_patterns_fancy:{type:"button"},collage_patterns_geometric:{type:"button"},collage_patterns_polka_dots:{type:"button"},collage_patterns_stripes:{type:"button"},collage_patterns_summer:{type:"button"},collage_patterns_love:{type:"button"},collage_patterns_winter:{type:"button"}}},crop:{viewstate:BFN.PhotoEditorCanvasModelViewStates.VIEWING_CROP,applyCancelMenuID:"editor_apply_cancel_menu",controls:{crop_aspect_ratio:{type:"dropdown_item",name:"aspect_ratio",data:BFN.DropDownData.cropAspectRatios,hideModalVeil:!0},crop_orientation:{type:"toggle_group",defaultValue:"landscape",buttons:["portrait","landscape"],useLabel:!0,name:"orientation"},crop_crop_width:{type:"scrubber",min:0,max:0,defaultValue:0,unit:"px",name:"width",column:"left"},crop_crop_height:{type:"scrubber",min:0,max:0,defaultValue:0,unit:"px",name:"height",column:"right"},crop_lock_aspect_ratio:{type:"checkbox_item",name:"lock_aspect_ratio"}}},rotate:{viewstate:BFN.PhotoEditorCanvasModelViewStates.VIEWING_ROTATE,applyCancelMenuID:"editor_apply_cancel_menu",controls:{rotate_rotate_counter_clockwise:{type:"button"},rotate_rotate_clockwise:{type:"button"},rotate_flip_horizontal:{type:"button"},rotate_flip_vertical:{type:"button"},rotate_straighten:{type:"slider_item",name:"straighten",unit:"\xB0",multiplier:1,min:-90,max:90,step:1,defaultValue:0,enableStartEvent:!0}}},resize:{viewstate:BFN.PhotoEditorCanvasModelViewStates.VIEWING_RESIZE,applyCancelMenuID:"editor_apply_cancel_menu",controls:{resize_resize_width:{type:"scrubber",min:BFN.minImageSize,max:BFN.maxImageSize,defaultValue:0,unit:"px",name:"width",column:"left"},resize_resize_height:{type:"scrubber",min:BFN.minImageSize,max:BFN.maxImageSize,defaultValue:0,unit:"px",name:"height",column:"right"},resize_resize_xscale:{type:"scrubber",unit:"%",name:"xscale",column:"left"},resize_resize_yscale:{type:"scrubber",unit:"%",name:"yscale",column:"right"},resize_lock_aspect_ratio:{type:"checkbox_item",name:"lock_aspect_ratio"}}},slimming:{viewstate:BFN.PhotoEditorCanvasModelViewStates.VIEWING_SLIMMING,applyCancelMenuID:"editor_apply_cancel_menu",controls:{slimming_amount:{type:"slider_item",name:"amount",unit:"%",multiplier:1,min:0,max:100,step:1,defaultValue:30}}},reshape:{viewstate:BFN.PhotoEditorCanvasModelViewStates.VIEWING_RESHAPE,applyCancelMenuID:"editor_apply_cancel_menu",controls:{reshape_mode:{type:"toggle_group",defaultValue:"smudge",buttons:[{value:"smudge",icon:"smudge-icon",tooltip:"smudge"},{value:"grow",icon:"grow-icon",tooltip:"grow"},{value:"shrink",icon:"shrink-icon",tooltip:"shrink"},{value:"erase",icon:"erase-icon",tooltip:"erase"}]},reshape_reset:{type:"button"},reshape_pressure:{type:"slider_item",name:"pressure",unit:"%",multiplier:1,min:10,max:100,step:1,defaultValue:50},reshape_brush_size:{type:"slider_item",name:"brush_size",unit:"%",multiplier:1,min:0,max:100,step:1,defaultValue:50},reshape_strength:{type:"slider_item",name:"strength",unit:"%",multiplier:1,min:0,max:100,step:1,defaultValue:100}}},funky_focus:{viewstate:BFN.PhotoEditorCanvasModelViewStates.VIEWING_FOCUS,applyCancelMenuID:"editor_apply_cancel_menu",isPlus:!0,controls:{funky_focus_mode:{type:"toggle_group",defaultValue:"radial",buttons:[{value:"radial",icon:"vignette-icon",tooltip:"radial"},{value:"linear",icon:"vignette-linear-icon",iconSize:18,tooltip:"linear"}]},funky_focus_grayscale:{type:"checkbox"},funky_focus_mosaic:{type:"checkbox"},funky_focus_inverse:{type:"checkbox"},funky_focus_blur_amount:{type:"slider_item",name:"blur_amount",unit:"%",multiplier:1,min:0,max:100,step:1,defaultValue:15},funky_focus_opacity:{type:"slider_item",name:"opacity",unit:"%",multiplier:1,min:0,max:100,step:1,defaultValue:100}}},funky_vignette:{viewstate:BFN.PhotoEditorCanvasModelViewStates.VIEWING_VIGNETTE,applyCancelMenuID:"editor_apply_cancel_menu",isPlus:Co,controls:{funky_vignette_mode:{type:"toggle_group",defaultValue:"radial",buttons:["radial","square","linear"]},funky_vignette_color:{type:"color_item",name:"color",defaultValue:"000000",emptyEnabled:!1,fineChangeEnabled:!0},funky_vignette_blend_mode:{type:"dropdown_item",name:"blend_mode",data:BFN.DropDownData.blendModes,hideModalVeil:!0,defaultValue:BFN.CONST.BLEND_MODES.NORMAL},funky_vignette_opacity:{type:"slider_item",name:"opacity",unit:"%",multiplier:100,min:0,max:1,step:.01,defaultValue:.75}}},cutout:{viewstate:BFN.PhotoEditorCanvasModelViewStates.VIEWING_CUTOUT,applyCancelMenuID:"editor_apply_cancel_menu",controls:{cutout_show_mask:{type:"checkbox"},cutout_invert:{type:"button"},cutout_clear:{type:"button"},cutout_remove_background:{type:"button"},cutout_mode:{type:"toggle_group",defaultValue:"brush",buttons:[{value:"brush",icon:"paintbrush-icon",tooltip:"paint"},{value:"magic_brush",icon:"auto-enhance-icon",tooltip:"magic_brush"},{value:"lasso",icon:"lasso-icon",tooltip:"lasso"},{value:"polygon",icon:"polygonal-lasso-icon",tooltip:"polygon"},{value:"circle",icon:"dashed-circle-icon",tooltip:"circle"},{value:"rectangle",icon:"dashed-rectangle-icon",tooltip:"rectangle"}]},cutout_select_action:{type:"toggle_group",defaultValue:"subtract",buttons:[{value:"subtract",langID:"remove",tooltip:"remove_selection"},{value:"add",langID:"keep",tooltip:"keep_selection"}]},cutout_strength:{type:"slider_item",name:"strength",unit:"%",multiplier:1,min:0,max:100,step:1,defaultValue:100},cutout_hardness:{type:"slider_item",name:"hardness",unit:"%",multiplier:1,min:0,max:100,step:1,defaultValue:100},cutout_brush_size:{type:"slider_item",name:"brush_size",unit:"%",multiplier:1,min:10,max:100,step:1,defaultValue:50},cutout_tolerance:{type:"slider_item",name:"tolerance",unit:"%",multiplier:1,min:0,max:100,step:1,defaultValue:25},cutout_background_color:{type:"color_item",name:"background_color",defaultValue:-1,emptyEnabled:!0,fineChangeEnabled:!0},cutout_trim_transparency:{type:"checkbox_item",name:"trim_transparency",defaultValue:!1,description:"cutout_guide_trim_transparency"},cutout_export_as_layer:{type:"checkbox_item",name:"export_as_layer",defaultValue:!1,description:"cutout_guide_export_as_layer"},cutout_options_modal_cancel:{type:"button"},cutout_options_modal_apply:{type:"button"}}},blur:{viewstate:BFN.PhotoEditorCanvasModelViewStates.VIEWING_EFFECT,brushMenuID:"effect_brush_menu",applyCancelMenuID:"editor_apply_cancel_menu",controls:{blur_blur_amount:{type:"slider_item",name:"blur_amount",unit:"%",multiplier:100,min:0,max:1,step:.01,defaultValue:.3}}},lens_blur:{viewstate:BFN.PhotoEditorCanvasModelViewStates.VIEWING_EFFECT,brushMenuID:"effect_brush_menu",applyCancelMenuID:"editor_apply_cancel_menu",controls:{lens_blur_blur_amount:{type:"slider_item",name:"blur_amount",defaultValue:50,min:1,max:100,step:1,unit:"%",multiplier:1},lens_blur_bokeh_intensity:{type:"slider_item",name:"bokeh_intensity",defaultValue:50,min:0,max:100,step:1,unit:"",multiplier:1},lens_blur_blade_curvature:{type:"slider_item",name:"blade_curvature",defaultValue:50,min:0,max:100,step:1,unit:"%",multiplier:1},lens_blur_blade_count:{type:"toggle_group",name:"blade_count",defaultValue:6,useLabel:!0,buttons:[{langID:"3",value:3},{langID:"4",value:4},{langID:"5",value:5},{langID:"6",value:6},{langID:"7",value:7},{langID:"8",value:8},{langID:"9",value:9}]},lens_blur_real_time:{type:"static",name:"real_time",defaultValue:!1},lens_blur_passes:{type:"static",name:"passes",defaultValue:4,min:1,max:10,step:1,unit:"",multiplier:1},lens_blur_pass1Radius:{type:"static",name:"pass1Radius",defaultValue:1,min:1,max:200,step:.5,unit:"",multiplier:1},lens_blur_pass1Layers:{type:"static",name:"pass1Layers",defaultValue:1,min:1,max:4,step:1,unit:"",multiplier:1},lens_blur_pass2Radius:{type:"static",name:"pass2Radius",defaultValue:50,min:1,max:200,step:.5,unit:"",multiplier:1},lens_blur_pass2Layers:{type:"static",name:"pass2Layers",defaultValue:4,min:1,max:4,step:1,unit:"",multiplier:1},lens_blur_pass3Radius:{type:"static",name:"pass3Radius",defaultValue:20,min:1,max:200,step:.5,unit:"",multiplier:1},lens_blur_pass3Layers:{type:"static",name:"pass3Layers",defaultValue:3,min:1,max:4,step:1,unit:"",multiplier:1},lens_blur_pass4Radius:{type:"static",name:"pass4Radius",defaultValue:8.5,min:1,max:200,step:.5,unit:"",multiplier:1},lens_blur_pass4Layers:{type:"static",name:"pass4Layers",defaultValue:2,min:1,max:4,step:1,unit:"",multiplier:1},lens_blur_finalBlur:{type:"static",name:"finalBlur",defaultValue:!0}}},exposure:{viewstate:BFN.PhotoEditorCanvasModelViewStates.VIEWING_EFFECT,brushMenuID:"effect_brush_menu",applyCancelMenuID:"editor_apply_cancel_menu",controls:{exposure_brightness:{type:"slider_item",name:"brightness",unit:"",multiplier:100,min:-1,max:1,step:.01,defaultValue:0},exposure_contrast:{type:"slider_item",name:"contrast",unit:"",multiplier:100,min:-1,max:1,step:.01,defaultValue:0},exposure_highlights:{type:"slider_item",name:"highlights",unit:"",multiplier:100,min:-1,max:1,step:.01,defaultValue:0},exposure_shadows:{type:"slider_item",name:"shadows",unit:"",multiplier:100,min:-1,max:1,step:.01,defaultValue:0}}},levels:{viewstate:BFN.PhotoEditorCanvasModelViewStates.VIEWING_EFFECT,brushMenuID:"effect_brush_menu",applyCancelMenuID:"editor_apply_cancel_menu",controls:{levels_min_input:{type:"slider_item",name:"Min Input",unit:"",multiplier:100,min:0,max:1,step:.01,defaultValue:0},levels_gamma:{type:"slider_item",name:"Gamma",unit:"",multiplier:100,min:0,max:3,step:.01,defaultValue:1},levels_max_input:{type:"slider_item",name:"Max Input",unit:"",multiplier:100,min:0,max:1,step:.01,defaultValue:1},levels_min_output:{type:"slider_item",name:"Min Output",unit:"",multiplier:100,min:0,max:1,step:.01,defaultValue:0},levels_max_output:{type:"slider_item",name:"Max Output",unit:"",multiplier:100,min:0,max:1,step:.01,defaultValue:1}}},invert:{viewstate:BFN.PhotoEditorCanvasModelViewStates.VIEWING_EFFECT,brushMenuID:"effect_brush_menu",applyCancelMenuID:"editor_apply_cancel_menu",controls:{invert_invert_amount:{type:"slider",min:0,max:1,step:.001,defaultValue:1}}},vibrance:{viewstate:BFN.PhotoEditorCanvasModelViewStates.VIEWING_EFFECT,brushMenuID:"effect_brush_menu",applyCancelMenuID:"editor_apply_cancel_menu",isPlus:Co,controls:{vibrance_vibrance_amount:{type:"slider_item",name:"amount",unit:"%",multiplier:100,min:0,max:1,step:.01,defaultValue:.3}}},desaturate:{viewstate:BFN.PhotoEditorCanvasModelViewStates.VIEWING_EFFECT,brushMenuID:"effect_brush_menu",applyCancelMenuID:"editor_apply_cancel_menu",controls:{desaturate_gray_amount:{type:"slider",min:0,max:1,step:.001,defaultValue:1}}},color:{viewstate:BFN.PhotoEditorCanvasModelViewStates.VIEWING_EFFECT,brushMenuID:"effect_brush_menu",applyCancelMenuID:"editor_apply_cancel_menu",controls:{color_hue:{type:"slider_item",name:"hue",unit:"\xB0",multiplier:1,min:-180,max:180,step:1,defaultValue:0,customClasses:["slider-custom","slider-custom-hue"]},color_saturation:{type:"slider_item",name:"saturation",unit:"",multiplier:100,min:-1,max:1,step:.01,defaultValue:0,customClasses:["slider-custom","slider-custom-saturation"]},color_temperature:{type:"slider_item",name:"temperature",unit:"",multiplier:100,min:-.25,max:.25,step:.01,defaultValue:0,customClasses:["slider-custom","slider-custom-temperature"]}}},replace_color:{viewstate:BFN.PhotoEditorCanvasModelViewStates.VIEWING_EFFECT,brushMenuID:"effect_brush_menu",applyCancelMenuID:"editor_apply_cancel_menu",controls:{replace_color_reset:{type:"button",name:"reset",icon:"reset-icon",iconSize:18},replace_color_source_color:{type:"color_item",name:"source_color",defaultValue:-1,fineChangeEnabled:!0},replace_color_target_color:{type:"color_item",name:"target_color",defaultValue:-1,fineChangeEnabled:!0,intensityEnabled:!0},replace_color_tolerance:{type:"slider_item",name:"tolerance",unit:"%",multiplier:1,min:0,max:100,step:1,defaultValue:50},replace_color_preserve_luminosity:{type:"checkbox_item",name:"preserve_luminosity",defaultValue:!0}}},fill_light:{viewstate:BFN.PhotoEditorCanvasModelViewStates.VIEWING_EFFECT,brushMenuID:"effect_brush_menu",applyCancelMenuID:"editor_apply_cancel_menu",isPlus:Co,controls:{fill_light_light_amount:{type:"slider_item",name:"amount",unit:"%",multiplier:100,min:0,max:1,step:.01,defaultValue:.3}}},sharpen:{viewstate:BFN.PhotoEditorCanvasModelViewStates.VIEWING_EFFECT,brushMenuID:"effect_brush_menu",applyCancelMenuID:"editor_apply_cancel_menu",controls:{sharpen_mode:{name:"mode",type:"toggle_group",defaultValue:"smart",buttons:[{value:"smart",icon:"smart-sharpen-icon",tooltip:"smart_sharpen"},{value:"normal",icon:"sharpen-icon",tooltip:"sharpen"}]},sharpen_unsharp_amount:{type:"slider_item",name:"amount",unit:"%",multiplier:100,min:0,max:1,step:.01,defaultValue:.2}}},clarity:{viewstate:BFN.PhotoEditorCanvasModelViewStates.VIEWING_EFFECT,brushMenuID:"effect_brush_menu",applyCancelMenuID:"editor_apply_cancel_menu",isPlus:!0,controls:{clarity_clarity_amount:{type:"slider_item",name:"amount",unit:"%",multiplier:100,min:0,max:1,step:.01,defaultValue:.3}}},vignette:{viewstate:BFN.PhotoEditorCanvasModelViewStates.VIEWING_EFFECT,brushMenuID:"effect_brush_menu",applyCancelMenuID:"editor_apply_cancel_menu",controls:{vignette_vignette_amount:{type:"slider_item",name:"vignette_amount",unit:"%",multiplier:100,min:0,max:1,step:.01,defaultValue:.2},vignette_vignette_softness:{type:"slider_item",name:"softness",unit:"%",multiplier:100,min:0,max:1,step:.01,defaultValue:.7}}},tint:{viewstate:BFN.PhotoEditorCanvasModelViewStates.VIEWING_EFFECT,brushMenuID:"effect_brush_menu",applyCancelMenuID:"editor_apply_cancel_menu",controls:{tint_color_1:{type:"color_item",name:"color_value_1",defaultValue:"FFFFFF",emptyEnabled:!1,fineChangeEnabled:!0},tint_color_2:{type:"color_item",name:"color_value_2",defaultValue:-1,fineChangeEnabled:!0},tint_opacity:{type:"slider_item",name:"opacity",unit:"%",multiplier:100,min:0,max:1,step:.01,defaultValue:1}}},tilt:{viewstate:BFN.PhotoEditorCanvasModelViewStates.VIEWING_TILT,applyCancelMenuID:"editor_apply_cancel_menu",controls:{tilt_background_color:{type:"color_item",name:"background_color",defaultValue:-1},tilt_tilt_amount:{type:"slider_item",name:"tilt_amount",unit:"\xB0",multiplier:1,min:-90,max:90,step:1,defaultValue:0}}},beautify:{viewstate:BFN.PhotoEditorCanvasModelViewStates.VIEWING_EFFECT,brushMenuID:"effect_brush_menu",applyCancelMenuID:"editor_apply_cancel_menu",controls:{beautify_beautify_amount:{type:"slider_item",name:"amount",unit:"%",multiplier:100,min:0,max:1,step:.01,defaultValue:.35}}},color_mixer:{viewstate:BFN.PhotoEditorCanvasModelViewStates.VIEWING_EFFECT,brushMenuID:"effect_brush_menu",applyCancelMenuID:"editor_apply_cancel_menu",controls:{color_mixer_bw:{name:"black_and_white",type:"checkbox",defaultValue:!1,icon:"black-and-white-icon",iconSize:18,tooltip:"black_and_white",customClasses:["control-item--border-bottom"]},color_mixer_red:{type:"slider_item",name:"red",unit:"%",multiplier:1,min:-100,max:100,step:1,defaultValue:0},color_mixer_green:{type:"slider_item",name:"green",unit:"%",multiplier:1,min:-100,max:100,step:1,defaultValue:0},color_mixer_blue:{type:"slider_item",name:"blue",unit:"%",multiplier:1,min:-100,max:100,step:1,defaultValue:0}}},soften:{viewstate:BFN.PhotoEditorCanvasModelViewStates.VIEWING_EFFECT,brushMenuID:"effect_brush_menu",applyCancelMenuID:"editor_apply_cancel_menu",controls:{soften_softness:{type:"slider_item",name:"softness",unit:"%",multiplier:1,min:5,max:100,step:1,defaultValue:30},soften_lightness:{type:"slider_item",name:"lightness",unit:"%",multiplier:1,min:0,max:100,step:1,defaultValue:40}}},smoothing:{viewstate:BFN.PhotoEditorCanvasModelViewStates.VIEWING_EFFECT,brushMenuID:"effect_brush_menu",applyCancelMenuID:"editor_apply_cancel_menu",controls:{smoothing_smoothing_amount:{type:"slider_item",name:"amount",unit:"%",multiplier:1,min:0,max:100,step:1,defaultValue:40}}},blur_edges:{viewstate:BFN.PhotoEditorCanvasModelViewStates.VIEWING_EFFECT,brushMenuID:"effect_brush_menu",applyCancelMenuID:"editor_apply_cancel_menu",controls:{blur_edges_edge_size:{type:"slider_item",name:"size",unit:"%",multiplier:1,min:0,max:100,step:1,defaultValue:50},blur_edges_blur_amount:{type:"slider_item",name:"blur_amount",unit:"%",multiplier:1,min:0,max:100,step:1,defaultValue:10},blur_edges_shift_vertical:{type:"slider_item",name:"shift_vertical",unit:"",multiplier:1,min:-100,max:100,step:1,defaultValue:0},blur_edges_shift_horizontal:{type:"slider_item",name:"shift_horizontal",unit:"",multiplier:1,min:-100,max:100,step:1,defaultValue:0}}},auto_enhance:{viewstate:BFN.PhotoEditorCanvasModelViewStates.VIEWING_EFFECT,brushMenuID:"effect_brush_menu",applyCancelMenuID:"editor_apply_cancel_menu",isPlus:!0,controls:{auto_enhance_intensity:{type:"slider_item",name:"amount",unit:"%",multiplier:1,min:0,max:100,step:1,defaultValue:100}}},glow:{viewstate:BFN.PhotoEditorCanvasModelViewStates.VIEWING_EFFECT,brushMenuID:"effect_brush_menu",applyCancelMenuID:"editor_apply_cancel_menu",controls:{glow_intensity_mode:{type:"toggle_group",defaultValue:"normal",buttons:["normal","intense"]},glow_intensity:{type:"slider_item",name:"amount",unit:"%",multiplier:1,min:0,max:100,step:1,defaultValue:100},glow_glow_size:{type:"slider_item",name:"glow_size",unit:"%",multiplier:1,min:0,max:100,step:1,defaultValue:25},glow_glint_size:{type:"slider_item",name:"glint_size",unit:"%",multiplier:1,min:0,max:100,step:1,defaultValue:25},glow_tolerance:{type:"slider_item",name:"tolerance",unit:"%",multiplier:1,min:0,max:100,step:1,defaultValue:50},glow_tint_color:{type:"color_item",name:"tint",defaultValue:-1,fineChangeEnabled:!0}}},background:{viewstate:BFN.PhotoEditorCanvasModelViewStates.VIEWING_BACKGROUND,brushMenuID:"background_brush_menu",applyCancelMenuID:"editor_apply_cancel_menu",controls:{background_transparent:{type:"checkbox_item",name:"transparent",defaultValue:!0},background_fill_color:{type:"color_item",name:"fill_color",defaultValue:"FFFFFF",emptyEnabled:!1,fineChangeEnabled:!0},background_fill_amount:{type:"slider_item",name:"fill_amount",unit:"%",multiplier:1,min:0,max:100,step:1,defaultValue:100},background_opacity:{type:"slider_item",name:"opacity",unit:"%",multiplier:1,min:0,max:100,step:1,defaultValue:100}}},ai_image:{viewstate:BFN.PhotoEditorCanvasModelViewStates.VIEWING_ARTSY,genericMenuID:"artsy_generic_menu",brushMenuID:"artsy_brush_menu",applyCancelMenuID:"editor_apply_cancel_menu",isPlus:!0,name:"A.I. Image Enhancer",type:"edit",controls:{ai_image_id:{type:"static",defaultValue:"a_i_enhancer"}}},ai_portrait:{viewstate:BFN.PhotoEditorCanvasModelViewStates.VIEWING_ARTSY,genericMenuID:"artsy_generic_menu",brushMenuID:"artsy_brush_menu",applyCancelMenuID:"editor_apply_cancel_menu",isPlus:!0,name:"A.I. Portrait Enhancer",type:"touch_up",controls:{ai_portrait_id:{type:"static",defaultValue:"a_i_portrait"}}},hdr_dlx:{viewstate:BFN.PhotoEditorCanvasModelViewStates.VIEWING_ARTSY,genericMenuID:"artsy_generic_menu",brushMenuID:"artsy_brush_menu",applyCancelMenuID:"editor_apply_cancel_menu",name:"HDR DLX",type:"edit",controls:{hdr_dlx_id:{type:"static",defaultValue:"ART_0023"},hdr_dlx_local_exposure:{type:"slider_item",name:"local_exposure",defaultValue:25,min:0,max:100,step:1,unit:"",multiplier:1},hdr_dlx_local_regions:{type:"slider_item",name:"local_regions",defaultValue:12,min:1,max:25,step:1,unit:"",multiplier:1}}},sharpen_dlx:{viewstate:BFN.PhotoEditorCanvasModelViewStates.VIEWING_ARTSY,genericMenuID:"artsy_generic_menu",brushMenuID:"artsy_brush_menu",applyCancelMenuID:"editor_apply_cancel_menu",name:"Sharpen DLX",type:"edit",controls:{sharpen_dlx_id:{type:"static",defaultValue:"ART_0021"},sharpen_dlx_strength:{type:"slider_item",name:"strength",defaultValue:25,min:0,max:100,step:1,unit:"",multiplier:1},sharpen_dlx_detail_level:{type:"slider_item",name:"detail_level",defaultValue:50,min:0,max:100,step:1,unit:"",multiplier:1}}},vibrant_colors_dlx:{viewstate:BFN.PhotoEditorCanvasModelViewStates.VIEWING_ARTSY,genericMenuID:"artsy_generic_menu",brushMenuID:"artsy_brush_menu",applyCancelMenuID:"editor_apply_cancel_menu",name:"Vibrant Colors DLX",type:"edit",controls:{vibrant_colors_dlx_id:{type:"static",defaultValue:"ART_0022"},vibrant_colors_dlx_color_amount:{type:"slider_item",name:"color_amount",defaultValue:60,min:-100,max:100,step:1,unit:"",multiplier:1}}},denoise_dlx:{viewstate:BFN.PhotoEditorCanvasModelViewStates.VIEWING_ARTSY,genericMenuID:"artsy_generic_menu",brushMenuID:"artsy_brush_menu",applyCancelMenuID:"editor_apply_cancel_menu",name:"Denoise DLX",type:"edit",controls:{denoise_dlx_id:{type:"static",defaultValue:"ART_0020"},denoise_dlx_smoothness:{type:"slider_item",name:"smoothness",defaultValue:50,min:10,max:100,step:1,unit:"",multiplier:1},denoise_dlx_fine_details:{type:"slider_item",name:"fine_details",defaultValue:25,min:0,max:100,step:1,unit:"",multiplier:1}}},perfectskin:{viewstate:BFN.PhotoEditorCanvasModelViewStates.VIEWING_TOUCH_UP,genericMenuID:"touch_up_generic_menu",brushMenuID:"touch_up_brush_menu",applyCancelMenuID:"editor_apply_cancel_menu",controls:{perfectskin_strength:{type:"slider_item",name:"strength",unit:"%",multiplier:100,min:0,max:1,step:.01,defaultValue:1},perfectskin_isBlur:{type:"static",defaultValue:!0},perfectskin_isBlur2:{type:"static",defaultValue:!0},perfectskin_presetID:{type:"static",defaultValue:BFN.CONST.TOUCH_UP_PRESETS.perfectskin},perfectskin_brush_size:{type:"static",defaultValue:.3},perfectskin_brush_hardness:{type:"static",defaultValue:.9}}},wrinkles:{viewstate:BFN.PhotoEditorCanvasModelViewStates.VIEWING_TOUCH_UP,genericMenuID:"touch_up_generic_menu",brushMenuID:"touch_up_brush_menu",applyCancelMenuID:"editor_apply_cancel_menu",controls:{wrinkles_strength:{type:"slider_item",name:"strength",unit:"%",multiplier:100,min:0,max:1,step:.01,defaultValue:.4},wrinkles_isBlur:{type:"static",defaultValue:!0},wrinkles_presetID:{type:"static",defaultValue:BFN.CONST.TOUCH_UP_PRESETS.wrinkles},wrinkles_brush_size:{type:"static",defaultValue:.25},wrinkles_brush_hardness:{type:"static",defaultValue:.7}}},bronzer:{viewstate:BFN.PhotoEditorCanvasModelViewStates.VIEWING_TOUCH_UP,genericMenuID:"touch_up_generic_menu",brushMenuID:"touch_up_brush_menu",applyCancelMenuID:"editor_apply_cancel_menu",controls:{bronzer_color_palette:{name:"color_palette",type:"color_palette",defaultValue:"724301",colors:[["724301","9A7035","D2AF7E","FCDDB1"]],presetsOnly:!1,emptyEnabled:!1,hueLocked:!0,fineChangeEnabled:!0},bronzer_strength:{type:"slider_item",name:"strength",unit:"%",multiplier:100,min:0,max:1,step:.01,defaultValue:.5},bronzer_isBlur:{type:"static",defaultValue:!1},bronzer_presetID:{type:"static",defaultValue:BFN.CONST.TOUCH_UP_PRESETS.bronzer},bronzer_brush_size:{type:"static",defaultValue:.25},bronzer_brush_hardness:{type:"static",defaultValue:.5}}},blush:{viewstate:BFN.PhotoEditorCanvasModelViewStates.VIEWING_TOUCH_UP,genericMenuID:"touch_up_generic_menu",brushMenuID:"touch_up_brush_menu",applyCancelMenuID:"editor_apply_cancel_menu",controls:{blush_color_palette:{name:"color_palette",type:"color_palette",defaultValue:"FFCDD9",colors:[["FFCDD9","ECB4Bf","DA798A","A16B72","703D42"],["D9BA9A","CEA989","A9856B","B28061","825436"]],presetsOnly:!0,emptyEnabled:!1},blush_strength:{type:"slider_item",name:"strength",unit:"%",multiplier:100,min:0,max:1,step:.01,defaultValue:.5},blush_isBlur:{type:"static",defaultValue:!1},blush_presetID:{type:"static",defaultValue:BFN.CONST.TOUCH_UP_PRESETS.blush},blush_brush_size:{type:"static",defaultValue:.25},blush_brush_hardness:{type:"static",defaultValue:.5}}},flashspot:{viewstate:BFN.PhotoEditorCanvasModelViewStates.VIEWING_TOUCH_UP,genericMenuID:"touch_up_generic_menu",brushMenuID:"touch_up_brush_menu",applyCancelMenuID:"editor_apply_cancel_menu",controls:{flashspot_strength:{type:"slider_item",name:"strength",unit:"%",multiplier:100,min:0,max:1,step:.01,defaultValue:1},flashspot_isBlur:{type:"static",defaultValue:!1},flashspot_presetID:{type:"static",defaultValue:BFN.CONST.TOUCH_UP_PRESETS.flashspot},flashspot_brush_size:{type:"static",defaultValue:.25},flashspot_brush_hardness:{type:"static",defaultValue:.5}}},mascara:{viewstate:BFN.PhotoEditorCanvasModelViewStates.VIEWING_TOUCH_UP,genericMenuID:"touch_up_generic_menu",brushMenuID:"touch_up_brush_menu",applyCancelMenuID:"editor_apply_cancel_menu",controls:{mascara_strength:{type:"slider_item",name:"strength",unit:"%",multiplier:100,min:0,max:1,step:.01,defaultValue:1},mascara_isBlur:{type:"static",defaultValue:!0},mascara_presetID:{type:"static",defaultValue:BFN.CONST.TOUCH_UP_PRESETS.mascara},mascara_brush_size:{type:"static",defaultValue:.25},mascara_brush_hardness:{type:"static",defaultValue:.8}}},eye_color:{viewstate:BFN.PhotoEditorCanvasModelViewStates.VIEWING_TOUCH_UP,genericMenuID:"touch_up_generic_menu",brushMenuID:"touch_up_brush_menu",applyCancelMenuID:"editor_apply_cancel_menu",controls:{eye_color_color_palette:{name:"color_palette",type:"color_palette",defaultValue:"64C4FF",colors:[["64C4FF","81BC36","7A5C3A","BBBEBA"]],emptyEnabled:!1,fineChangeEnabled:!0},eye_color_strength:{type:"slider_item",name:"strength",unit:"%",multiplier:100,min:0,max:1,step:.01,defaultValue:.7},eye_color_isBlur:{type:"static",defaultValue:!1},eye_color_presetID:{type:"static",defaultValue:BFN.CONST.TOUCH_UP_PRESETS.eye_color},eye_color_brush_size:{type:"static",defaultValue:.25},eye_color_brush_hardness:{type:"static",defaultValue:.8}}},eye_brighten:{viewstate:BFN.PhotoEditorCanvasModelViewStates.VIEWING_TOUCH_UP,genericMenuID:"touch_up_generic_menu",brushMenuID:"touch_up_brush_menu",applyCancelMenuID:"editor_apply_cancel_menu",controls:{eye_brighten_isBlur:{type:"static",defaultValue:!0},eye_brighten_presetID:{type:"static",defaultValue:BFN.CONST.TOUCH_UP_PRESETS.eye_brighten},eye_brighten_brush_size:{type:"static",defaultValue:.25},eye_brighten_brush_hardness:{type:"static",defaultValue:.3}}},eyebrow_pencil:{viewstate:BFN.PhotoEditorCanvasModelViewStates.VIEWING_TOUCH_UP,genericMenuID:"touch_up_generic_menu",brushMenuID:"touch_up_brush_menu",applyCancelMenuID:"editor_apply_cancel_menu",controls:{eyebrow_pencil_color_palette:{name:"color_palette",type:"color_palette",defaultValue:"3D3A33",colors:[["3D3A33","74717A","835836","A58646"]],emptyEnabled:!1,fineChangeEnabled:!0},eyebrow_pencil_strength:{type:"slider_item",name:"strength",unit:"%",multiplier:100,min:0,max:1,step:.01,defaultValue:1},eyebrow_pencil_isBlur:{type:"static",defaultValue:!0},eyebrow_pencil_curves:{type:"static",defaultValue:"blackenCurve"},eyebrow_pencil_presetID:{type:"static",defaultValue:BFN.CONST.TOUCH_UP_PRESETS.eyebrow_pencil},eyebrow_pencil_brush_size:{type:"static",defaultValue:.25},eyebrow_pencil_brush_hardness:{type:"static",defaultValue:.3}}},fix_redeye:{viewstate:BFN.PhotoEditorCanvasModelViewStates.VIEWING_TOUCH_UP,genericMenuID:"touch_up_generic_menu",brushMenuID:"touch_up_brush_menu",applyCancelMenuID:"editor_apply_cancel_menu",controls:{fix_redeye_isBlur:{type:"static",defaultValue:!1},fix_redeye_presetID:{type:"static",defaultValue:BFN.CONST.TOUCH_UP_PRESETS.fix_redeye},fix_redeye_brush_size:{type:"static",defaultValue:.25},fix_redeye_brush_hardness:{type:"static",defaultValue:.7}}},lipstick:{viewstate:BFN.PhotoEditorCanvasModelViewStates.VIEWING_TOUCH_UP,genericMenuID:"touch_up_generic_menu",brushMenuID:"touch_up_brush_menu",applyCancelMenuID:"editor_apply_cancel_menu",controls:{lipstick_color_palette:{name:"color_palette",type:"color_palette",defaultValue:"EF4292",colors:[["EF4292","D7058C","DA085F","E12438"]],emptyEnabled:!1,fineChangeEnabled:!0},lipstick_strength:{type:"slider_item",name:"strength",unit:"%",multiplier:100,min:0,max:1,step:.01,defaultValue:.7},lipstick_isBlur:{type:"static",defaultValue:!1},lipstick_presetID:{type:"static",defaultValue:BFN.CONST.TOUCH_UP_PRESETS.lipstick},lipstick_brush_size:{type:"static",defaultValue:.25},lipstick_brush_hardness:{type:"static",defaultValue:.6}}},teeth_whiten:{viewstate:BFN.PhotoEditorCanvasModelViewStates.VIEWING_TOUCH_UP,genericMenuID:"touch_up_generic_menu",brushMenuID:"touch_up_brush_menu",applyCancelMenuID:"editor_apply_cancel_menu",controls:{teeth_whiten_isBlur:{type:"static",defaultValue:!0},teeth_whiten_presetID:{type:"static",defaultValue:BFN.CONST.TOUCH_UP_PRESETS.teeth_whiten},teeth_whiten_brush_size:{type:"static",defaultValue:.25},teeth_whiten_brush_hardness:{type:"static",defaultValue:.3}}},hair_color:{viewstate:BFN.PhotoEditorCanvasModelViewStates.VIEWING_TOUCH_UP,genericMenuID:"touch_up_generic_menu",brushMenuID:"touch_up_brush_menu",applyCancelMenuID:"editor_apply_cancel_menu",controls:{hair_color_color_palette:{name:"color_palette",type:"color_palette",defaultValue:"E8D18A",colors:[["E8D18A","935118","C58B4E","0C0C17"]],emptyEnabled:!1},hair_color_strength:{type:"slider_item",name:"strength",unit:"%",multiplier:100,min:0,max:1,step:.01,defaultValue:.7},hair_color_isBlur:{type:"static",defaultValue:!1},hair_color_presetID:{type:"static",defaultValue:BFN.CONST.TOUCH_UP_PRESETS.haircolor},hair_color_brush_size:{type:"static",defaultValue:.25},hair_color_brush_hardness:{type:"static",defaultValue:.6}}},paint_brush:{viewstate:BFN.PhotoEditorCanvasModelViewStates.VIEWING_PAINT_BRUSH,applyCancelMenuID:"editor_apply_cancel_menu",controls:{paint_brush_clear:{type:"button"},paint_brush_erase:{type:"checkbox",defaultValue:!1},paint_brush_color:{type:"color_item",name:"color",defaultValue:"FFFFFF",emptyEnabled:!1},paint_brush_blend_mode:{type:"dropdown_item",name:"blend_mode",data:BFN.DropDownData.blendModes,hideModalVeil:!0,defaultValue:BFN.CONST.BLEND_MODES.NORMAL},paint_brush_opacity:{type:"slider_item",name:"opacity",unit:"%",multiplier:100,min:0,max:1,step:.01,defaultValue:.5},paint_brush_strength:{type:"slider_item",name:"strength",unit:"%",multiplier:1,min:0,max:100,step:1,defaultValue:100},paint_brush_size:{type:"slider_item",name:"brush_size",unit:"%",multiplier:1,min:0,max:100,step:1,defaultValue:25},paint_brush_hardness:{type:"slider_item",name:"brush_hardness",unit:"%",multiplier:1,min:0,max:100,step:1,defaultValue:100}}},clone:{viewstate:BFN.PhotoEditorCanvasModelViewStates.VIEWING_CLONE,applyCancelMenuID:"editor_apply_cancel_menu",controls:{clone_target_reset:{type:"button"},clone_brush_clear:{type:"button"},clone_brush_erase:{type:"checkbox",defaultValue:!1},clone_brush_size:{type:"slider_item",name:"brush_size",unit:"%",multiplier:1,min:0,max:100,step:1,defaultValue:50},clone_brush_hardness:{type:"slider_item",name:"brush_hardness",unit:"%",multiplier:1,min:0,max:100,step:1,defaultValue:25},clone_brush_strength:{type:"slider_item",name:"brush_strength",unit:"%",multiplier:1,min:0,max:100,step:1,defaultValue:100}}},blemish_fix:{viewstate:BFN.PhotoEditorCanvasModelViewStates.VIEWING_BLEMISH_FIX,applyCancelMenuID:"editor_apply_cancel_menu",controls:{blemish_fix_brush_erase:{type:"checkbox",defaultValue:!1},blemish_fix_brush_clear:{type:"button"},blemish_fix_brush_size:{type:"slider_item",name:"brush_size",unit:"%",multiplier:1,min:0,max:100,step:1,defaultValue:50},blemish_fix_brush_hardness:{type:"slider_item",name:"brush_hardness",unit:"%",multiplier:1,min:0,max:100,step:1,defaultValue:40}}},frame_square:{viewstate:BFN.PhotoEditorCanvasModelViewStates.VIEWING_SQUARE,applyCancelMenuID:"editor_apply_cancel_menu",controls:{frame_square_crop:{type:"slider_item",name:"crop",unit:"%",multiplier:1,min:0,max:100,step:1,defaultValue:0},frame_square_position:{type:"slider_item",name:"position",unit:"%",multiplier:1,min:-100,max:100,step:1,defaultValue:0},frame_square_background_color:{type:"color_item",defaultValue:"FFFFFF",fineChangeEnabled:!0,emptyEnabled:!0,intensityEnabled:!0,name:"background_color"},frame_square_use_avg_color:{type:"button",name:"use_avg_color"}}},frame_border:{viewstate:BFN.PhotoEditorCanvasModelViewStates.VIEWING_BORDER,applyCancelMenuID:"editor_apply_cancel_menu",controls:{frame_border_outer_color:{type:"color_item",defaultValue:"000000",fineChangeEnabled:!0,intensityEnabled:!0,name:"outer_color"},frame_border_inner_color:{type:"color_item",defaultValue:"FFFFFF",fineChangeEnabled:!0,intensityEnabled:!0,name:"inner_color"},frame_border_matte_color:{type:"color_item",defaultValue:-1,fineChangeEnabled:!0,intensityEnabled:!0,name:"matte_color"},frame_border_outer_thickness:{type:"slider_item",name:"outer_thickness",unit:"%",multiplier:1,min:0,max:100,step:1,defaultValue:50},frame_border_inner_thickness:{type:"slider_item",name:"inner_thickness",unit:"%",multiplier:1,min:0,max:100,step:1,defaultValue:50},frame_border_corner_radius:{type:"slider_item",name:"corner_radius",unit:"%",multiplier:1,min:0,max:100,step:1,defaultValue:0},frame_border_preserve_aspect_ratio:{type:"checkbox_item",name:"preserve_aspect_ratio"}}},frame_drop_shadow:{viewstate:BFN.PhotoEditorCanvasModelViewStates.VIEWING_DROP_SHADOW,applyCancelMenuID:"editor_apply_cancel_menu",controls:{frame_drop_shadow_type:{type:"toggle_group",defaultValue:"outer",buttons:[{langID:"outer",value:"outer"},{langID:"inner",value:"inner"}]},frame_drop_shadow_background_color:{type:"color_item",defaultValue:-1,fineChangeEnabled:!0,name:"background_color"},frame_drop_shadow_shadow_color:{type:"color_item",defaultValue:"000000",emptyEnabled:!1,fineChangeEnabled:!0,name:"shadow_color"},frame_drop_shadow_distance:{type:"slider_item",name:"distance",unit:"%",multiplier:1,min:0,max:100,step:1,defaultValue:0},frame_drop_shadow_angle:{type:"slider_item",name:"angle",unit:"\xB0",multiplier:1,min:-180,max:180,step:1,defaultValue:45},frame_drop_shadow_size:{type:"slider_item",name:"size",unit:"%",multiplier:1,min:0,max:100,step:1,defaultValue:25},frame_drop_shadow_density:{type:"slider_item",name:"density",unit:"%",multiplier:1,min:0,max:100,step:1,defaultValue:5},frame_drop_shadow_opacity:{type:"slider_item",name:"opacity",unit:"%",multiplier:1,min:0,max:100,step:1,defaultValue:75}}},background_brush:{controls:{background_brush_show_mask:{type:"checkbox"},background_brush_invert:{type:"button"},background_brush_clear:{type:"button"},background_brush_isolate_subject:{type:"button"},background_brush_select_action:{type:"toggle_group",name:"select_action",defaultValue:"subtract",buttons:[{langID:"keep",value:"subtract",tooltip:"keep_selection"},{langID:"remove",value:"add",tooltip:"remove_selection"}]},background_brush_size:{type:"slider_item",name:"brush_size",unit:"%",multiplier:1,min:0,max:100,step:1,defaultValue:50},background_brush_hardness:{type:"slider_item",name:"brush_hardness",unit:"%",multiplier:1,min:0,max:100,step:1,defaultValue:75},background_brush_strength:{type:"slider_item",name:"brush_strength",unit:"%",multiplier:1,min:0,max:100,step:1,defaultValue:100}}},touch_up_brush:{controls:{touch_up_brush_clear:{type:"button"},touch_up_brush_erase:{type:"checkbox",defaultValue:!1},touch_up_brush_size:{type:"slider_item",name:"brush_size",unit:"%",multiplier:1,min:0,max:100,step:1,defaultValue:35},touch_up_brush_hardness:{type:"slider_item",name:"brush_hardness",unit:"%",multiplier:1,min:0,max:100,step:1,defaultValue:50}}},effect_generic:{controls:{effect_generic_amount:{type:"slider_item",name:"amount",unit:"%",multiplier:1,min:0,max:100,step:1,defaultValue:100}}},effect_brush:{controls:{effect_brush_show_mask:{type:"checkbox"},effect_brush_invert:{type:"button"},effect_brush_clear:{type:"button"},effect_brush_isolate_subject:{type:"button"},effect_brush_select_action:{type:"toggle_group",name:"select_action",defaultValue:"subtract",buttons:[{langID:"remove",value:"subtract",tooltip:"remove_selection"},{langID:"keep",value:"add",tooltip:"keep_selection"}]},effect_brush_size:{type:"slider_item",name:"brush_size",unit:"%",multiplier:1,min:0,max:100,step:1,defaultValue:50},effect_brush_hardness:{type:"slider_item",name:"brush_hardness",unit:"%",multiplier:1,min:0,max:100,step:1,defaultValue:100},effect_brush_strength:{type:"slider_item",name:"brush_strength",unit:"%",multiplier:1,min:0,max:100,step:1,defaultValue:100}}},artsy_generic:{controls:{artsy_generic_amount:{type:"slider_item",name:"amount",unit:"%",multiplier:1,min:0,max:100,step:1,defaultValue:100}}},artsy_brush:{controls:{artsy_brush_show_mask:{type:"checkbox"},artsy_brush_invert:{type:"button"},artsy_brush_clear:{type:"button"},artsy_brush_isolate_subject:{type:"button"},artsy_brush_select_action:{type:"toggle_group",name:"select_action",defaultValue:"subtract",buttons:[{langID:"remove",value:"subtract",tooltip:"remove_selection"},{langID:"keep",value:"add",tooltip:"keep_selection"}]},artsy_brush_size:{type:"slider_item",name:"brush_size",unit:"%",multiplier:1,min:0,max:100,step:1,defaultValue:50},artsy_brush_hardness:{type:"slider_item",name:"brush_hardness",unit:"%",multiplier:1,min:0,max:100,step:1,defaultValue:100},artsy_brush_strength:{type:"slider_item",name:"brush_strength",unit:"%",multiplier:1,min:0,max:100,step:1,defaultValue:100}}},frame_crop_rotate_generic:{controls:{frame_crop_rotate_generic_rotate_counter_clockwise:{type:"button"},frame_crop_rotate_generic_rotate_clockwise:{type:"button"},frame_crop_rotate_generic_flip_horizontal:{type:"button"},frame_crop_rotate_generic_flip_vertical:{type:"button"},frame_crop_rotate_generic_background_color:{type:"color_item",name:"background_color",defaultValue:-1,fineChangeEnabled:!0},frame_crop_rotate_generic_position:{type:"slider_item",name:"position",unit:"",multiplier:1,min:-100,max:100,step:1,defaultValue:0},frame_crop_rotate_generic_tilt:{type:"slider_item",name:"tilt",unit:"\xB0",multiplier:1,min:-90,max:90,step:1,defaultValue:0}}},frame_crop_generic:{controls:{frame_crop_generic_rotate_counter_clockwise:{type:"button"},frame_crop_generic_rotate_clockwise:{type:"button"},frame_crop_generic_flip_horizontal:{type:"button"},frame_crop_generic_flip_vertical:{type:"button"},frame_crop_generic_position:{type:"slider_item",name:"position",unit:"",multiplier:1,min:-100,max:100,step:1,defaultValue:0}}},frame_full_generic:{controls:{frame_full_generic_color_overlay:{type:"color_item",name:"color_overlay",defaultValue:-1,intensityEnabled:!0,fineChangeEnabled:!0},frame_full_generic_blend_mode:{type:"dropdown_item",name:"blend_mode",data:BFN.DropDownData.blendModes,hideModalVeil:!0},frame_full_generic_rotate_counter_clockwise:{type:"button"},frame_full_generic_rotate_clockwise:{type:"button"},frame_full_generic_flip_horizontal:{type:"button"},frame_full_generic_flip_vertical:{type:"button"},frame_full_generic_position:{type:"slider_item",name:"position",unit:"",multiplier:1,min:-100,max:100,step:1,defaultValue:0},frame_full_generic_opacity:{type:"slider_item",name:"opacity",unit:"%",multiplier:1,min:0,max:100,step:1,defaultValue:100}}},frame_smart_generic:{controls:{frame_smart_generic_color_overlay:{type:"color_item",name:"color_overlay",defaultValue:-1,intensityEnabled:!0,fineChangeEnabled:!0},frame_smart_generic_blend_mode:{type:"dropdown_item",name:"blend_mode",data:BFN.DropDownData.blendModes,hideModalVeil:!0},frame_smart_generic_opacity:{type:"slider_item",name:"opacity",unit:"%",multiplier:1,min:0,max:100,step:1,defaultValue:100},frame_smart_generic_scale:{type:"slider_item",name:"scale",unit:"%",multiplier:1,min:0,max:100,step:1,defaultValue:50},frame_smart_generic_padding:{type:"slider_item",name:"padding",unit:"%",multiplier:1,min:0,max:100,step:1,defaultValue:50}}},texture_generic:{controls:{texture_generic_opacity:{type:"slider_item",name:"opacity",unit:"%",multiplier:100,min:0,max:1,step:.01,defaultValue:1},texture_generic_blend_mode:{type:"dropdown_item",name:"blend_mode",data:BFN.DropDownData.blendModes,hideModalVeil:!0},texture_generic_rotate_counter_clockwise:{type:"button"},texture_generic_rotate_clockwise:{type:"button"},texture_generic_flip_horizontal:{type:"button"},texture_generic_flip_vertical:{type:"button"}}},texture_brush:{controls:{texture_brush_show_mask:{type:"checkbox"},texture_brush_invert:{type:"button"},texture_brush_clear:{type:"button"},texture_brush_isolate_subject:{type:"button"},texture_brush_select_action:{type:"toggle_group",name:"select_action",defaultValue:"subtract",buttons:[{langID:"remove",value:"subtract",tooltip:"remove_selection"},{langID:"keep",value:"add",tooltip:"keep_selection"}],useLabel:!1},texture_brush_size:{type:"slider_item",name:"brush_size",unit:"%",multiplier:1,min:0,max:100,step:1,defaultValue:50},texture_brush_hardness:{type:"slider_item",name:"brush_hardness",unit:"%",multiplier:1,min:0,max:100,step:1,defaultValue:100},texture_brush_strength:{type:"slider_item",name:"brush_strength",unit:"%",multiplier:1,min:0,max:100,step:1,defaultValue:100}}},overlay_generic:{controls:{overlay_generic_reset:{type:"button"},overlay_generic_color:{type:"color",defaultValue:"FFFFFF",emptyEnabled:!1,fineChangeEnabled:!0},overlay_generic_opacity:{type:"slider_item",name:"opacity",unit:"%",multiplier:100,min:0,max:1,step:.01,defaultValue:1},overlay_generic_size:{type:"slider_item",name:"size",unit:"%",multiplier:100,min:0,max:1,step:.01,defaultValue:1},overlay_generic_rotation:{type:"slider_item",name:"rotation",unit:"\xB0",multiplier:1,min:-180,max:180,step:1,defaultValue:0},overlay_generic_blur_amount:{type:"slider_item",name:"blur_amount",unit:"%",multiplier:100,min:0,max:1,step:.01,defaultValue:0},overlay_generic_shadow_amount:{type:"slider_item",name:"shadow_amount",unit:"%",multiplier:100,min:0,max:1,step:.01,defaultValue:0}}},lens_flare_generic:{controls:{lens_flare_generic_intense_mode:{type:"toggle_group",defaultValue:"normal",buttons:["normal","intense"]},lens_flare_generic_intensity:{type:"slider_item",name:"intensity",unit:"",multiplier:1,min:-100,max:100,step:1,defaultValue:0}}},editor_apply_cancel:{controls:{editor_apply_cancel_cancel:{type:"button"},editor_apply_cancel_apply:{type:"button"}}},transform:{controls:{transform_shape_fill_enabled:{type:"expandable_checkbox",defaultValue:!1},transform_shape_fill_color:{type:"color_item",name:"color",pickerName:"fill_color",defaultValue:"FFFFFF",intensityEnabled:!0,fineChangeEnabled:!0,emptyEnabled:!1},transform_shape_stroke_enabled:{type:"expandable_checkbox",defaultValue:!1},transform_shape_stroke_color:{type:"color_item",name:"color",pickerName:"stroke_color",defaultValue:-1,intensityEnabled:!0,fineChangeEnabled:!0,emptyEnabled:!1},transform_shape_stroke_width:{type:"slider_item",name:"thickness",min:1,max:100,step:1,defaultValue:5,unit:"px"},transform_shape_line_style:{type:"toggle_group",defaultValue:"solid",buttons:["solid","dashed","dotted"]},transform_shape_line_segment_width:{type:"slider_item",name:"segment_width",unit:"",multiplier:1,min:0,max:100,step:1,defaultValue:50},transform_shape_line_gap_size:{type:"slider_item",name:"gap_size",unit:"",multiplier:1,min:0,max:100,step:1,defaultValue:50},transform_shape_rectangle_corner_rounding:{type:"slider_item",name:"corner_rounding",unit:"%",multiplier:1,min:0,max:100,step:1,defaultValue:0},transform_shape_polygon_sides:{type:"slider_item",name:"sides",unit:"",multiplier:1,min:3,max:12,step:1,defaultValue:6},transform_shape_polygon_shift_orientation:{type:"checkbox_item",name:"shift_orientation",defaultValue:!1},transform_shape_star_points:{type:"slider_item",name:"points",unit:"",multiplier:1,min:3,max:32,step:1,defaultValue:5},transform_shape_star_inset_weight:{type:"slider_item",name:"inset_weight",unit:"%",multiplier:1,min:0,max:100,step:1,defaultValue:50},transform_shape_star_shift_orientation:{type:"checkbox_item",name:"shift_orientation",defaultValue:!1},transform_shape_arrow_style:{type:"toggle_group",defaultValue:"thick",buttons:["thick","thin"]},transform_shape_arrow_weight:{type:"slider_item",name:"weight",unit:"%",multiplier:1,min:0,max:100,step:1,defaultValue:25},transform_shape_arrow_double_sided:{type:"checkbox_item",name:"double_sided",defaultValue:!1},transform_graphic_color_group_color:{name:"graphic_colors",type:"color_group",defaultValue:"FFFFFF",emptyEnabled:!1,resetColorEnabled:!0,fineChangeEnabled:!0,intensityEnabled:!0,intensityWhileTransparent:!0,useLabel:!0,maxVisibleRows:3,colorsPerRow:6,rowMarginAdjustment:4},transform_image_border_enabled:{type:"expandable_checkbox",defaultValue:!1},transform_image_border_color:{type:"color_item",name:"color",pickerName:"border_color",defaultValue:-1,intensityEnabled:!0,fineChangeEnabled:!0,emptyEnabled:!1},transform_image_border_thickness:{type:"slider_item",name:"thickness",min:1,max:100,step:1,defaultValue:5,unit:"px"},transform_text_curve_enabled:{type:"expandable_checkbox",defaultValue:!1},transform_text_curve_amount:{type:"slider_item",name:"amount",min:-100,max:100,step:1,defaultValue:50,unit:"%"},transform_drop_shadow_enabled:{type:"expandable_checkbox",defaultValue:!1},transform_drop_shadow_distance:{type:"slider_item",name:"distance",unit:"px",multiplier:1,min:0,max:500,step:1,defaultValue:25},transform_drop_shadow_angle:{type:"slider_item",name:"angle",unit:"\xB0",multiplier:1,min:-180,max:180,step:1,defaultValue:-45},transform_drop_shadow_size:{type:"slider_item",name:"blur",unit:"px",multiplier:1,min:0,max:100,step:1,defaultValue:10},transform_drop_shadow_scale:{type:"slider_item",name:"size",unit:"%",multiplier:1,min:100,max:150,step:1,defaultValue:100},transform_drop_shadow_density:{type:"slider_item",name:"density",unit:"%",multiplier:1,min:0,max:100,step:1,defaultValue:0},transform_drop_shadow_opacity:{type:"slider_item",name:"opacity",unit:"%",multiplier:1,min:0,max:100,step:1,defaultValue:75},transform_drop_shadow_color:{type:"color_item",name:"color",pickerName:"drop_shadow",defaultValue:"000000",emptyEnabled:!1,fineChangeEnabled:!0},transform_blend_mode:{type:"dropdown_item",name:"blend_mode",data:BFN.DropDownData.blendModes,hideModalVeil:!0},transform_overlay_color_enabled:{type:"expandable_checkbox",defaultValue:!1},transform_overlay_color:{type:"color_item",name:"color",defaultValue:-1,intensityEnabled:!0,fineChangeEnabled:!0,emptyEnabled:!1},transform_tint_color_enabled:{type:"expandable_checkbox",defaultValue:!1},transform_tint_color:{type:"color_item",name:"color",defaultValue:-1,fineChangeEnabled:!0,emptyEnabled:!1},transform_opacity:{type:"slider_item",name:"opacity",unit:"%",multiplier:1,min:0,max:100,step:1,defaultValue:100},transform_create_group:{type:"button"},transform_delete:{type:"button"},transform_duplicate:{type:"button"},transform_flip_horizontal:{type:"button"},transform_flip_vertical:{type:"button"},transform_move_backwards:{type:"button"},transform_move_forwards:{type:"button"},transform_align_left:{type:"button"},transform_align_center:{type:"button"},transform_align_right:{type:"button"},transform_align_top:{type:"button"},transform_align_middle:{type:"button"},transform_align_bottom:{type:"button"},transform_fit_to_canvas:{type:"button"},transform_fill_canvas:{type:"button"},transform_menu_popover_button:{type:"button"}}},layer:{controls:{layer_save_as_image:{type:"button"},layer_image_cutout:{type:"button"},layer_image_edit_layer:{type:"button"},layer_mask_image_crop:{type:"button"},layer_mask_image_replace:{type:"button"},layer_mask_image_crop_size:{type:"scrubber",min:100,max:100,defaultValue:100,unit:"%",maxLength:5},layer_mask_image_crop_fit_to_frame:{type:"button"},layer_mask_image_crop_fit_to_image:{type:"button"},layer_isolator_edit_complete:{type:"button"},layer_isolator_display_canvas:{type:"checkbox_item",name:"display_canvas",defaultValue:!0,checkboxColor:"light"}}},text_edit:{controls:{text_edit_bold:{type:"checkbox",defaultValue:!1},text_edit_italic:{type:"checkbox",defaultValue:!1},text_edit_underline:{type:"checkbox",defaultValue:!1},text_edit_background_enabled:{type:"expandable_checkbox",defaultValue:!1},text_edit_background_color:{type:"color_item",name:"color",pickerName:"background_color",defaultValue:"000000",intensityEnabled:!0,fineChangeEnabled:!0,emptyEnabled:!1},text_edit_background_padding:{type:"slider_item",name:"padding",min:0,max:100,step:1,defaultValue:0,unit:"%"},text_edit_highlight_enabled:{type:"expandable_checkbox",defaultValue:!1},text_edit_highlight_color:{type:"color_item",name:"color",pickerName:"highlight_color",defaultValue:"000000",intensityEnabled:!0,fineChangeEnabled:!0},text_edit_text_color:{type:"color",name:"text_color",defaultValue:"FF0000",intensityEnabled:!0,fineChangeEnabled:!0},text_edit_stroke_enabled:{type:"expandable_checkbox",defaultValue:!1},text_edit_stroke_color:{type:"color_item",name:"color",pickerName:"outline_color",defaultValue:"000000",intensityEnabled:!0,fineChangeEnabled:!0},text_edit_stroke_width:{type:"slider_item",name:"thickness",min:1,max:100,step:1,defaultValue:1,unit:"%"},text_edit_size:{type:"scrubber",min:6,max:9999,defaultValue:20,unit:"px",maxLength:4},text_edit_align:{type:"toggle_group",defaultValue:"left",buttons:[{value:"left",icon:"paragraph-left-align-icon",iconSize:14,tooltip:"alight_left"},{value:"center",icon:"paragraph-center-align-icon",iconSize:14,tooltip:"align_center"},{value:"right",icon:"paragraph-right-align-icon",iconSize:14,tooltip:"align_right"},{value:"justify",icon:"paragraph-justify-align-icon",iconSize:14,tooltip:"align_justify"}]},text_edit_spacing:{type:"slider_item",name:"letter_spacing",min:0,max:10,step:1,defaultValue:0,unit:""},text_edit_line_height:{type:"slider_item",name:"line_height",min:50,max:200,step:1,defaultValue:100,unit:"%"},text_edit_spacing_menu_popover_button:{type:"button"}}},collage_image:{controls:{collage_image_size:{type:"slider_item",name:"size",min:100,max:500,step:1,defaultValue:100,unit:"%"},collage_image_rotate_counter_clockwise:{type:"button"},collage_image_rotate_clockwise:{type:"button"},collage_image_flip_horizontal:{type:"button"},collage_image_flip_vertical:{type:"button"},collage_image_open_in_editor:{type:"button"}}},collage_pattern:{controls:{collage_pattern_size:{type:"slider_item",name:"size",min:100,max:500,step:1,defaultValue:100,unit:"%"},collage_pattern_color:{type:"color_item",name:"color",defaultValue:"000000",emptyEnabled:!0,fineChangeEnabled:!1}}},layers:{controls:{layers_toggle_panel:{type:"checkbox",defaultValue:!1}}},alignment:{controls:{alignment_toggle_panel:{type:"checkbox",defaultValue:!1},alignment_snapping:{type:"toggle_switch",defaultValue:!1},alignment_display_distances:{type:"toggle_switch",defaultValue:!1},alignment_guides:{type:"toggle_switch",defaultValue:!1}}},history:{controls:{history_toggle_panel:{type:"checkbox",defaultValue:!1}}},language:{controls:{language_select:{type:"dropdown_item",name:"language",data:BFN.DropDownData.languages,defaultValue:BeFunky.LanguageManager.language.app,useLabel:!1}}},zoom:{controls:{zoom_minus:{type:"button",interval:80,intervalDelay:240},zoom_plus:{type:"button",interval:80,intervalDelay:240},zoom_amount:{type:"slider_item",min:10,max:200,step:1,defaultValue:100,unit:"%",enableStartEvent:!0},zoom_exact_fit:{type:"button"},zoom_full_screen:{type:"button"},zoom_stagger_factor:{type:"static",defaultValue:1}}},color_picker_panel:{controls:{color_picker_panel_intensity:{type:"slider_item",name:"intensity",min:0,max:100,step:1,defaultValue:100}}},sas:{controls:{sas_image_type:{type:"toggle_group",defaultValue:"jpg",buttons:[{value:"jpg",langID:"JPG"},{value:"png",langID:"PNG"},{value:"pdf",langID:"PDF"}]},sas_image_quality:{type:"slider_item",name:"quality",unit:"",multiplier:1,min:0,max:100,step:1,defaultValue:98},sas_pdf_quality:{type:"toggle_group",defaultValue:"print",buttons:[{value:"print",langID:"pdf_print_quality_label"},{value:"web",langID:"pdf_web_quality_label"}]},sas_disable_save_complete_modal:{type:"checkbox",defaultValue:!1},sas_project_location:{type:"toggle_group",defaultValue:`${BeFunky.isChromeOnIOS?"befunky":"computer"}`,buttons:[{value:"computer",langID:"computer"},{value:"befunky",langID:"BeFunky"}]}}}};BFN.ArtsyAdjustAndPaintToolObjects={};BFN.ArtsyAdjustAndPaintIDMap={};for(let i in BFN.UIToolData){let e=BFN.UIToolData[i];e.hasOwnProperty("viewstate")&&(BFN.toolViewstates[i]=e.viewstate,e.viewstate===BFN.PhotoEditorCanvasModelViewStates.VIEWING_ARTSY&&e.controls&&e.controls[`${i}_id`]&&e.controls[`${i}_id`].defaultValue&&(BFN.ArtsyAdjustAndPaintToolObjects[i]=e,BFN.ArtsyAdjustAndPaintIDMap[e.controls[`${i}_id`].defaultValue]=i)),BFN.accordionMenuPlusIDs.indexOf(i)!==-1&&(e.isPlus=!0)}BFN.FeaturedData={effect:["hipster_preset2","orton_style_preset1","vintage_colors_preset6","tinytype_preset3","bw_preset2","oldphoto_preset18"],artsy:["ART_0004","ART_0016","ART_0010","ART_0012","ART_0013","ART_0018"],frame:["filmstrip_2","grunge_1","instant_2","lace_1","rustic_7","art_deco_7"],texture:["bokeh_2","bokeh_4","grunge_6","metal_4","paper_6"]};BFN.lowPerformanceCanvas=!!(BeFunky.isChromeOS||window.failed_webgl_tests.includes("no_high_perf_canvas"));var Lt=!(BeFunky.isTWA||BeFunky.isAppleAppStoreApp);BFN.EffectData=[{id:"effect_featured",name:"Featured",graphic:"tba",presets:[]},{id:"effect_favorites",name:"Favorites",graphic:"tba",presets:[]},{id:"bwfx",name:"B&W Tones",graphic:"tba",presets:[{id:"bwfx_preset1",isPlus:!0,thumb:"tba",effectID:"bwfx",params:[{type:"slider_item",name:"highlights",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"slider_item",name:"shadows",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"static",name:"imageURL",defaultValue:"bw_fx_1.jpg"},{type:"static",name:"presetID",defaultValue:BFN.CONST.BWFX_PRESETS.PRESET_1}]},{id:"bwfx_preset2",isPlus:!0,thumb:"tba",effectID:"bwfx",params:[{type:"slider_item",name:"highlights",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"slider_item",name:"shadows",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"static",name:"imageURL",defaultValue:"bw_fx_2.jpg"},{type:"static",name:"presetID",defaultValue:BFN.CONST.BWFX_PRESETS.PRESET_2}]},{id:"bwfx_preset3",isPlus:!0,thumb:"tba",effectID:"bwfx",params:[{type:"slider_item",name:"highlights",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"slider_item",name:"shadows",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"static",name:"imageURL",defaultValue:"bw_fx_3.jpg"},{type:"static",name:"presetID",defaultValue:BFN.CONST.BWFX_PRESETS.PRESET_3}]},{id:"bwfx_preset4",isPlus:!0,thumb:"tba",effectID:"bwfx",params:[{type:"slider_item",name:"highlights",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"slider_item",name:"shadows",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"static",name:"imageURL",defaultValue:"bw_fx_4.jpg"},{type:"static",name:"presetID",defaultValue:BFN.CONST.BWFX_PRESETS.PRESET_4}]},{id:"bwfx_preset5",isPlus:!0,thumb:"tba",effectID:"bwfx",params:[{type:"slider_item",name:"highlights",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"slider_item",name:"shadows",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"static",name:"imageURL",defaultValue:"bw_fx_5.jpg"},{type:"static",name:"presetID",defaultValue:BFN.CONST.BWFX_PRESETS.PRESET_5}]},{id:"bwfx_preset6",isPlus:!0,thumb:"tba",effectID:"bwfx",params:[{type:"slider_item",name:"highlights",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"slider_item",name:"shadows",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"static",name:"imageURL",defaultValue:"bw_fx_6.jpg"},{type:"static",name:"presetID",defaultValue:BFN.CONST.BWFX_PRESETS.PRESET_6}]},{id:"bwfx_preset7",isPlus:!0,thumb:"tba",effectID:"bwfx",params:[{type:"slider_item",name:"highlights",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"slider_item",name:"shadows",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"static",name:"imageURL",defaultValue:"bw_fx_7.jpg"},{type:"static",name:"presetID",defaultValue:BFN.CONST.BWFX_PRESETS.PRESET_7}]},{id:"bwfx_preset8",isPlus:!0,thumb:"tba",effectID:"bwfx",params:[{type:"slider_item",name:"highlights",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"slider_item",name:"shadows",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"static",name:"imageURL",defaultValue:"bw_fx_8.jpg"},{type:"static",name:"presetID",defaultValue:BFN.CONST.BWFX_PRESETS.PRESET_8}]},{id:"bwfx_preset9",isPlus:!0,thumb:"tba",effectID:"bwfx",params:[{type:"slider_item",name:"highlights",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"slider_item",name:"shadows",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"static",name:"imageURL",defaultValue:"bw_fx_9.jpg"},{type:"static",name:"presetID",defaultValue:BFN.CONST.BWFX_PRESETS.PRESET_9}]},{id:"bwfx_preset10",isPlus:!0,thumb:"tba",effectID:"bwfx",params:[{type:"slider_item",name:"highlights",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"slider_item",name:"shadows",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"static",name:"imageURL",defaultValue:"bw_fx_10.jpg"},{type:"static",name:"presetID",defaultValue:BFN.CONST.BWFX_PRESETS.PRESET_10}]},{id:"bwfx_preset11",isPlus:!0,thumb:"tba",effectID:"bwfx",params:[{type:"slider_item",name:"highlights",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"slider_item",name:"shadows",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"static",name:"imageURL",defaultValue:"bw_fx_11.jpg"},{type:"static",name:"presetID",defaultValue:BFN.CONST.BWFX_PRESETS.PRESET_11}]},{id:"bwfx_preset12",isPlus:!0,thumb:"tba",effectID:"bwfx",params:[{type:"slider_item",name:"highlights",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"slider_item",name:"shadows",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"static",name:"imageURL",defaultValue:"bw_fx_12.jpg"},{type:"static",name:"presetID",defaultValue:BFN.CONST.BWFX_PRESETS.PRESET_12}]},{id:"bwfx_preset13",isPlus:!0,thumb:"tba",effectID:"bwfx",params:[{type:"slider_item",name:"highlights",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"slider_item",name:"shadows",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"static",name:"imageURL",defaultValue:"bw_fx_13.jpg"},{type:"static",name:"presetID",defaultValue:BFN.CONST.BWFX_PRESETS.PRESET_13}]},{id:"bwfx_preset14",isPlus:!0,thumb:"tba",effectID:"bwfx",params:[{type:"slider_item",name:"highlights",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"slider_item",name:"shadows",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"static",name:"imageURL",defaultValue:"bw_fx_14.jpg"},{type:"static",name:"presetID",defaultValue:BFN.CONST.BWFX_PRESETS.PRESET_14}]},{id:"bwfx_preset15",isPlus:!0,thumb:"tba",effectID:"bwfx",params:[{type:"slider_item",name:"highlights",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"slider_item",name:"shadows",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"static",name:"imageURL",defaultValue:"bw_fx_15.jpg"},{type:"static",name:"presetID",defaultValue:BFN.CONST.BWFX_PRESETS.PRESET_15}]}]},{id:"warmfx",name:"Warmer Tones",graphic:"tba",presets:[{id:"warmfx_preset1",isPlus:!0,thumb:"tba",effectID:"warmfx",params:[{type:"slider_item",name:"highlights",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"slider_item",name:"shadows",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"static",name:"imageURL",defaultValue:"warm_fx_1.jpg"},{type:"static",name:"presetID",defaultValue:BFN.CONST.WARMFX_PRESETS.PRESET_1}]},{id:"warmfx_preset2",isPlus:!0,thumb:"tba",effectID:"warmfx",params:[{type:"slider_item",name:"highlights",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"slider_item",name:"shadows",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"static",name:"imageURL",defaultValue:"warm_fx_2.jpg"},{type:"static",name:"presetID",defaultValue:BFN.CONST.WARMFX_PRESETS.PRESET_2}]},{id:"warmfx_preset3",isPlus:Lt,thumb:"tba",effectID:"warmfx",params:[{type:"slider_item",name:"highlights",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"slider_item",name:"shadows",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"static",name:"imageURL",defaultValue:"warm_fx_3.jpg"},{type:"static",name:"presetID",defaultValue:BFN.CONST.WARMFX_PRESETS.PRESET_3}]},{id:"warmfx_preset4",isPlus:!0,thumb:"tba",effectID:"warmfx",params:[{type:"slider_item",name:"highlights",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"slider_item",name:"shadows",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"static",name:"imageURL",defaultValue:"warm_fx_4.jpg"},{type:"static",name:"presetID",defaultValue:BFN.CONST.WARMFX_PRESETS.PRESET_4}]},{id:"warmfx_preset5",isPlus:!0,thumb:"tba",effectID:"warmfx",params:[{type:"slider_item",name:"highlights",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"slider_item",name:"shadows",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"static",name:"imageURL",defaultValue:"warm_fx_5.jpg"},{type:"static",name:"presetID",defaultValue:BFN.CONST.WARMFX_PRESETS.PRESET_5}]},{id:"warmfx_preset6",isPlus:!0,thumb:"tba",effectID:"warmfx",params:[{type:"slider_item",name:"highlights",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"slider_item",name:"shadows",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"static",name:"imageURL",defaultValue:"warm_fx_6.jpg"},{type:"static",name:"presetID",defaultValue:BFN.CONST.WARMFX_PRESETS.PRESET_6}]},{id:"warmfx_preset7",isPlus:!0,thumb:"tba",effectID:"warmfx",params:[{type:"slider_item",name:"highlights",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"slider_item",name:"shadows",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"static",name:"imageURL",defaultValue:"warm_fx_7.jpg"},{type:"static",name:"presetID",defaultValue:BFN.CONST.WARMFX_PRESETS.PRESET_7}]},{id:"warmfx_preset8",isPlus:!0,thumb:"tba",effectID:"warmfx",params:[{type:"slider_item",name:"highlights",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"slider_item",name:"shadows",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"static",name:"imageURL",defaultValue:"warm_fx_8.jpg"},{type:"static",name:"presetID",defaultValue:BFN.CONST.WARMFX_PRESETS.PRESET_8}]},{id:"warmfx_preset9",isPlus:!0,thumb:"tba",effectID:"warmfx",params:[{type:"slider_item",name:"highlights",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"slider_item",name:"shadows",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"static",name:"imageURL",defaultValue:"warm_fx_9.jpg"},{type:"static",name:"presetID",defaultValue:BFN.CONST.WARMFX_PRESETS.PRESET_9}]},{id:"warmfx_preset10",isPlus:!0,thumb:"tba",effectID:"warmfx",params:[{type:"slider_item",name:"highlights",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"slider_item",name:"shadows",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"static",name:"imageURL",defaultValue:"warm_fx_10.jpg"},{type:"static",name:"presetID",defaultValue:BFN.CONST.WARMFX_PRESETS.PRESET_10}]},{id:"warmfx_preset11",isPlus:!0,thumb:"tba",effectID:"warmfx",params:[{type:"slider_item",name:"highlights",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"slider_item",name:"shadows",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"static",name:"imageURL",defaultValue:"warm_fx_11.jpg"},{type:"static",name:"presetID",defaultValue:BFN.CONST.WARMFX_PRESETS.PRESET_11}]}]},{id:"analog",name:"Analog Tones",graphic:"tba",presets:[{id:"analog_preset1",isPlus:!0,thumb:"tba",effectID:"analog",params:[{type:"slider_item",name:"highlights",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"slider_item",name:"shadows",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"static",name:"imageURL",defaultValue:"analog_fx_1.jpg"},{type:"static",name:"presetID",defaultValue:BFN.CONST.ANALOG_PRESETS.PRESET_1}]},{id:"analog_preset2",isPlus:!0,thumb:"tba",effectID:"analog",params:[{type:"slider_item",name:"highlights",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"slider_item",name:"shadows",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"static",name:"imageURL",defaultValue:"analog_fx_2.jpg"},{type:"static",name:"presetID",defaultValue:BFN.CONST.ANALOG_PRESETS.PRESET_2}]},{id:"analog_preset3",isPlus:!0,thumb:"tba",effectID:"analog",params:[{type:"slider_item",name:"highlights",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"slider_item",name:"shadows",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"static",name:"imageURL",defaultValue:"analog_fx_3.jpg"},{type:"static",name:"presetID",defaultValue:BFN.CONST.ANALOG_PRESETS.PRESET_3}]},{id:"analog_preset4",isPlus:!0,thumb:"tba",effectID:"analog",params:[{type:"slider_item",name:"highlights",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"slider_item",name:"shadows",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"static",name:"imageURL",defaultValue:"analog_fx_4.jpg"},{type:"static",name:"presetID",defaultValue:BFN.CONST.ANALOG_PRESETS.PRESET_4}]},{id:"analog_preset5",isPlus:!0,thumb:"tba",effectID:"analog",params:[{type:"slider_item",name:"highlights",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"slider_item",name:"shadows",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"static",name:"imageURL",defaultValue:"analog_fx_5.jpg"},{type:"static",name:"presetID",defaultValue:BFN.CONST.ANALOG_PRESETS.PRESET_5}]},{id:"analog_preset6",isPlus:!0,thumb:"tba",effectID:"analog",params:[{type:"slider_item",name:"highlights",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"slider_item",name:"shadows",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"static",name:"imageURL",defaultValue:"analog_fx_6.jpg"},{type:"static",name:"presetID",defaultValue:BFN.CONST.ANALOG_PRESETS.PRESET_6}]},{id:"analog_preset7",isPlus:!0,thumb:"tba",effectID:"analog",params:[{type:"slider_item",name:"highlights",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"slider_item",name:"shadows",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"static",name:"imageURL",defaultValue:"analog_fx_7.jpg"},{type:"static",name:"presetID",defaultValue:BFN.CONST.ANALOG_PRESETS.PRESET_7}]},{id:"analog_preset8",isPlus:!0,thumb:"tba",effectID:"analog",params:[{type:"slider_item",name:"highlights",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"slider_item",name:"shadows",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"static",name:"imageURL",defaultValue:"analog_fx_8.jpg"},{type:"static",name:"presetID",defaultValue:BFN.CONST.ANALOG_PRESETS.PRESET_8}]},{id:"analog_preset9",isPlus:!0,thumb:"tba",effectID:"analog",params:[{type:"slider_item",name:"highlights",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"slider_item",name:"shadows",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"static",name:"imageURL",defaultValue:"analog_fx_9.jpg"},{type:"static",name:"presetID",defaultValue:BFN.CONST.ANALOG_PRESETS.PRESET_9}]},{id:"analog_preset10",isPlus:!0,thumb:"tba",effectID:"analog",params:[{type:"slider_item",name:"highlights",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"slider_item",name:"shadows",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"static",name:"imageURL",defaultValue:"analog_fx_10.jpg"},{type:"static",name:"presetID",defaultValue:BFN.CONST.ANALOG_PRESETS.PRESET_10}]}]},{id:"cinematic",name:"Cinematic",graphic:"tba",presets:[{id:"film_grain",name:"Film Grain",isPlus:!0,useBasicAmount:!1,useGeneric:!1,thumb:"tba",effectID:"cinematic",params:[{type:"static",name:"presetID",defaultValue:BFN.CONST.CINEMATIC_PRESETS.FILM_GRAIN},{type:"slider_item",name:"intensity",defaultValue:100,min:1,max:400,step:1,unit:"%",multiplier:1},{type:"button",name:"generate"},{type:"checkbox_item",name:"monochromatic",defaultValue:!1}]},{id:"color_grading",name:"Color Grading",isPlus:!0,thumb:"tba",effectID:"cinematic",params:[{type:"static",name:"presetID",defaultValue:BFN.CONST.CINEMATIC_PRESETS.COLOR_GRADING},{type:"color_item",name:"shadows",defaultValue:"000000",emptyEnabled:!1,intensityEnabled:!0,fineChangeEnabled:!0},{type:"color_item",name:"midtones",defaultValue:"808080",emptyEnabled:!1,intensityEnabled:!0,fineChangeEnabled:!0},{type:"color_item",name:"highlights",defaultValue:"FFFFFF",emptyEnabled:!1,intensityEnabled:!0,fineChangeEnabled:!0}]},{id:"anamorphic",name:"Anamorphic",isPlus:!0,useBasicAmount:!1,useGeneric:!1,thumb:"tba",effectID:"cinematic",params:[{type:"static",name:"presetID",defaultValue:BFN.CONST.CINEMATIC_PRESETS.ANAMORPHIC},{type:"slider_item",name:"stretch",defaultValue:50,min:0,max:100,step:1,unit:"%",multiplier:1},{type:"slider_item",name:"distortion",defaultValue:50,min:0,max:100,step:1,unit:"%",multiplier:1},{type:"slider_item",name:"vignette_opacity",defaultValue:50,min:0,max:100,step:1,unit:"%",multiplier:1},{type:"slider_item",name:"edge_blur",defaultValue:50,min:0,max:100,step:1,unit:"%",multiplier:1}]},{id:"lens_distortion",name:"Lens Distortion",isPlus:!0,useBasicAmount:!1,useGeneric:!1,thumb:"tba",effectID:"cinematic",params:[{type:"static",name:"presetID",defaultValue:BFN.CONST.CINEMATIC_PRESETS.LENS_DISTORTION},{type:"slider_item",name:"distortion",defaultValue:50,min:-100,max:100,step:1,unit:"%",multiplier:1}]},{id:"warped_blur",name:"Warped Blur",isPlus:!0,useBasicAmount:!1,useGeneric:!1,thumb:"tba",effectID:"cinematic",params:[{type:"static",name:"presetID",defaultValue:BFN.CONST.CINEMATIC_PRESETS.WARPED_BLUR},{type:"slider_item",name:"blur_amount",defaultValue:100,min:0,max:100,step:1,unit:"%",multiplier:1},{type:"slider_item",name:"phase",defaultValue:100,min:0,max:100,step:1,unit:"",multiplier:1},{type:"slider_item",name:"scale",defaultValue:100,min:0,max:100,step:1,unit:"%",multiplier:1},{type:"slider_item",name:"lightness",defaultValue:0,min:-100,max:100,step:1,unit:"%",multiplier:1}]},{id:"chromatic_aberration",name:"Chromatic Aberration",isPlus:!0,thumb:"tba",effectID:"cinematic",params:[{type:"static",name:"presetID",defaultValue:BFN.CONST.CINEMATIC_PRESETS.CHROMATIC_ABERRATION},{type:"slider_item",name:"distortion",defaultValue:50,min:0,max:100,step:1,unit:"%",multiplier:1},{type:"slider_item",name:"focal_point_x",defaultValue:50,min:0,max:100,step:1,unit:"%",multiplier:1},{type:"slider_item",name:"focal_point_y",defaultValue:50,min:0,max:100,step:1,unit:"%",multiplier:1}]},{id:"volume_light",name:"Volume Light",isPlus:!0,thumb:"tba",effectID:"cinematic",params:[{type:"static",name:"presetID",defaultValue:BFN.CONST.CINEMATIC_PRESETS.VOLUME_LIGHT},{type:"static",name:"real_time",defaultValue:!BFN.lowPerformanceCanvas},{type:"color_item",name:"color",defaultValue:-1,emptyEnabled:!0,intensityEnabled:!0,fineChangeEnabled:!0},{type:"slider_item",name:"strength",defaultValue:50,min:0,max:100,step:1,unit:"%",multiplier:1},{type:"slider_item",name:"tolerance",defaultValue:50,min:0,max:100,step:1,unit:"%",multiplier:1},{type:"slider_item",name:"focal_point_x",defaultValue:50,min:0,max:100,step:1,unit:"%",multiplier:1},{type:"slider_item",name:"focal_point_y",defaultValue:50,min:0,max:100,step:1,unit:"%",multiplier:1}]}]},{id:"multimedia",name:"Multimedia",graphic:"tba",presets:[{id:"color_bleed",name:"Color Bleed",isPlus:!0,thumb:"tba",effectID:"multimedia",params:[{type:"static",name:"presetID",defaultValue:BFN.CONST.MULTIMEDIA_PRESETS.COLOR_BLEED},{type:"static",name:"real_time",defaultValue:!BFN.lowPerformanceCanvas},{type:"toggle_group",name:"color_mode",defaultValue:"darken",buttons:[{langID:"darken",value:"darken"},{langID:"lighten",value:"lighten"}]},{type:"slider_item",name:"distance",defaultValue:50,min:0,max:100,step:1,unit:"%",multiplier:1},{type:"slider_item",name:"density",defaultValue:50,min:0,max:100,step:1,unit:"%",multiplier:1},{type:"slider_item",name:"scatter",defaultValue:50,min:0,max:100,step:1,unit:"%",multiplier:1},{type:"slider_item",name:"scale",defaultValue:50,min:0,max:100,step:1,unit:"%",multiplier:1},{type:"slider_item",name:"phase",defaultValue:50,min:0,max:100,step:1,unit:"%",multiplier:1}]},{id:"scan_lines",name:"Scan Lines",isPlus:!1,useBasicAmount:!1,useGeneric:!1,thumb:"tba",effectID:"multimedia",params:[{type:"static",name:"presetID",defaultValue:BFN.CONST.MULTIMEDIA_PRESETS.SCAN_LINES},{type:"color_item",name:"line_color",defaultValue:"000000",fineChangeEnabled:!0,emptyEnabled:!1,intensityEnabled:!1},{type:"slider_item",name:"opacity",defaultValue:50,min:0,max:100,step:1,unit:"%",multiplier:1},{type:"slider_item",name:"spacing",defaultValue:2,min:1,max:Math.floor(BFN.minImageSize/2),step:1,unit:"px",multiplier:1},{type:"checkbox_item",name:"invert",defaultValue:!1}]},{id:"television",name:"Television",isPlus:!0,thumb:"tba",effectID:"multimedia",params:[{type:"static",name:"presetID",defaultValue:BFN.CONST.MULTIMEDIA_PRESETS.TELEVISION}]},{id:"halftone_duo",name:"Halftone Duo",isPlus:!0,thumb:"tba",effectID:"multimedia",params:[{type:"static",name:"presetID",defaultValue:BFN.CONST.MULTIMEDIA_PRESETS.HALFTONE_DUO},{type:"slider_item",name:"density",defaultValue:50,min:1,max:100,step:1,unit:"",multiplier:1},{type:"slider_item",name:"tolerance",defaultValue:50,min:1,max:100,step:1,unit:"",multiplier:1},{type:"color_item",name:"shadow_color",defaultValue:-1,emptyEnabled:!0,fineChangeEnabled:!0},{type:"color_item",name:"highlight_color",defaultValue:-1,emptyEnabled:!0,fineChangeEnabled:!0},{type:"checkbox_item",name:"invert",defaultValue:!1}]}]},{id:"glitch_art",name:"Glitch Art",graphic:"tba",presets:[{id:"corrupted",name:"Corrupted",isPlus:!0,thumb:"tba",effectID:"glitch_art",params:[{type:"static",name:"presetID",defaultValue:BFN.CONST.GLITCH_ART_PRESETS.CORRUPTED},{type:"slider_item",name:"complexity",defaultValue:4,min:1,max:8,step:1,unit:"",multiplier:1,pips:{mode:"count",values:8,density:8},customClasses:["slider-notch"]},{type:"slider_item",name:"phase",defaultValue:50,min:0,max:100,step:1,unit:"",multiplier:1},{type:"slider_item",name:"strength",defaultValue:50,min:0,max:100,step:1,unit:"",multiplier:1}]},{id:"distorted",name:"Distorted",isPlus:!0,thumb:"tba",effectID:"glitch_art",params:[{type:"static",name:"presetID",defaultValue:BFN.CONST.GLITCH_ART_PRESETS.DISTORTED},{type:"toggle_group",name:"grayscale",defaultValue:1,buttons:[{langID:"color",value:0},{langID:"grayscale",value:1}]},{type:"slider_item",name:"phase",defaultValue:10,min:0,max:100,step:1,unit:"%",multiplier:1},{type:"slider_item",name:"length",defaultValue:10,min:0,max:100,step:1,unit:"%",multiplier:1},{type:"slider_item",name:"slide_horizontal",defaultValue:10,min:0,max:100,step:1,unit:"%",multiplier:1}]},{id:"segmented",name:"Segmented",isPlus:!0,thumb:"tba",effectID:"glitch_art",params:[{type:"static",name:"presetID",defaultValue:BFN.CONST.GLITCH_ART_PRESETS.SEGMENTED},{type:"toggle_group",name:"grayscale",defaultValue:0,buttons:[{langID:"color",value:0},{langID:"grayscale",value:1}]},{type:"color_palette",name:"colors",defaultValue:"0",colors:[["0","1","2","3","4","5"]],presetsOnly:!0,useLabel:!0,styleOverrides:{global:{width:"1.5rem",height:"1.5rem",borderRadius:"50%"},unique:[[{backgroundColor:"rgb(255,0,0)",background:"linear-gradient(135deg, rgba(255,0,0,1) 20%, rgba(0,255,0,1) 50%, rgba(0,0,255,1) 80%)"},{backgroundColor:"rgb(0,255,0)",background:"linear-gradient(135deg, rgba(255,0,0,1) 20%, rgba(0,0,255,1) 50%, rgba(0,255,0,1) 80%)"},{backgroundColor:"rgb(0,0,255)",background:"linear-gradient(135deg, rgba(0,255,0,1) 20%, rgba(255,0,0,1) 50%, rgba(0,0,255,1) 80%)"},{backgroundColor:"rgb(255,0,255)",background:"linear-gradient(135deg, rgba(0,255,0,1) 20%, rgba(255,0,255,1) 80%)"},{backgroundColor:"rgb(255,255,0)",background:"linear-gradient(135deg, rgba(255,255,0,1) 20%, rgba(0,0,255,1) 80%)"},{backgroundColor:"rgb(0,255,255)",background:"linear-gradient(135deg, rgba(0,255,255,1) 20%, rgba(255,0,0,1) 80%)"}]]}},{type:"slider_item",name:"slide_horizontal",defaultValue:10,min:-100,max:100,step:1,unit:"%",multiplier:1},{type:"slider_item",name:"slide_vertical",defaultValue:0,min:-100,max:100,step:1,unit:"%",multiplier:1}]},{id:"fragmented",name:"Fragmented",isPlus:!0,thumb:"tba",effectID:"glitch_art",params:[{type:"static",name:"presetID",defaultValue:BFN.CONST.GLITCH_ART_PRESETS.FRAGMENTED},{type:"toggle_group",name:"grayscale",defaultValue:0,buttons:[{langID:"color",value:0},{langID:"grayscale",value:1}]},{type:"slider_item",name:"highlights",defaultValue:50,min:0,max:100,step:1,unit:"%",multiplier:1},{type:"slider_item",name:"offset",defaultValue:50,min:0,max:100,step:1,unit:"%",multiplier:1}]},{id:"digitized",name:"Digitized",isPlus:!0,thumb:"tba",effectID:"glitch_art",params:[{type:"static",name:"presetID",defaultValue:BFN.CONST.GLITCH_ART_PRESETS.DIGITIZED},{type:"static",name:"useHiResThumb",defaultValue:!0},{type:"color_palette",name:"color_picker",defaultValue:-1,colors:[["FF5555","55CC55","8888FF",-1]],fineChangeEnabled:!0,emptyEnabled:!0},{type:"slider_item",name:"highlights",defaultValue:50,min:0,max:100,step:1,unit:"%",multiplier:1},{type:"slider_item",name:"weight",defaultValue:50,min:0,max:100,step:1,unit:"%",multiplier:1},{type:"slider_item",name:"slide_horizontal",defaultValue:50,min:0,max:100,step:1,unit:"%",multiplier:1}]}]},{id:"bw",name:"Black & White",graphic:"tba",presets:[{id:"bw_preset2",isPlus:Lt,thumb:"tba",effectID:"bw",params:[{type:"slider_item",name:"highlights",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"slider_item",name:"shadows",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"static",name:"presetID",defaultValue:BFN.CONST.BLACK_WHITE_PRESETS.PRESET_2}]},{id:"bw_preset3",isPlus:!0,thumb:"tba",effectID:"bw",params:[{type:"slider_item",name:"highlights",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"slider_item",name:"shadows",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"static",name:"presetID",defaultValue:BFN.CONST.BLACK_WHITE_PRESETS.PRESET_3}]},{id:"bw_preset4",isPlus:!0,thumb:"tba",effectID:"bw",params:[{type:"slider_item",name:"highlights",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"slider_item",name:"shadows",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"static",name:"presetID",defaultValue:BFN.CONST.BLACK_WHITE_PRESETS.PRESET_4}]},{id:"bw_preset5",isPlus:!0,thumb:"tba",effectID:"bw",params:[{type:"slider_item",name:"highlights",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"slider_item",name:"shadows",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"static",name:"presetID",defaultValue:BFN.CONST.BLACK_WHITE_PRESETS.PRESET_5}]},{id:"bw_warmer",isPlus:!0,thumb:"tba",effectID:"bw",params:[{type:"toggle_group",name:"modeBW",defaultValue:1,buttons:[{langID:"lighter",value:0},{langID:"medium",value:1},{langID:"darker",value:2}]},{type:"color_palette",name:"modeColor",defaultValue:"8A7874",colors:[["8A7874","85748A","926C6C","A08D5E"]],presetsOnly:!0},{type:"slider_item",name:"highlights",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"slider_item",name:"shadows",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"static",name:"presetID",defaultValue:BFN.CONST.BLACK_WHITE_PRESETS.PRESET_6}]},{id:"bw_cooler",isPlus:!0,thumb:"tba",effectID:"bw",params:[{type:"toggle_group",name:"modeBW",defaultValue:1,buttons:[{langID:"lighter",value:0},{langID:"medium",value:1},{langID:"darker",value:2}]},{type:"color_palette",name:"modeColor",defaultValue:"818A74",colors:[["818A74","6E917E","6E7791","606D9B"]],presetsOnly:!0},{type:"slider_item",name:"highlights",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"slider_item",name:"shadows",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"static",name:"presetID",defaultValue:BFN.CONST.BLACK_WHITE_PRESETS.PRESET_7}]},{id:"bw_new_preset1",isPlus:!0,thumb:"tba",effectID:"bw",params:[{type:"static",name:"presetID",defaultValue:BFN.CONST.BLACK_WHITE_PRESETS.PRESET_8}]},{id:"bw_new_preset2",isPlus:!0,thumb:"tba",effectID:"bw",params:[{type:"static",name:"imageURL",defaultValue:"bw_overlay.jpg"},{type:"static",name:"presetID",defaultValue:BFN.CONST.BLACK_WHITE_PRESETS.PRESET_9}]}]},{id:"chromatic",name:"Chromatic",graphic:"tba",presets:[{id:"hipster_preset1",isPlus:Lt,thumb:"tba",effectID:"chromatic",fixTransparency:!1,params:[{type:"static",name:"imageURL",defaultValue:"retro1_vignette.jpg"},{type:"static",name:"presetID",defaultValue:BFN.CONST.CHROMATIC_PRESETS.PRESET_1}]},{id:"hipster_preset2",isPlus:Lt,thumb:"tba",effectID:"chromatic",fixTransparency:!1,params:[{type:"static",name:"imageURL",defaultValue:"retro2_vignette.jpg"},{type:"static",name:"presetID",defaultValue:BFN.CONST.CHROMATIC_PRESETS.PRESET_2}]},{id:"hipster_preset3",isPlus:!0,thumb:"tba",effectID:"chromatic",fixTransparency:!1,params:[{type:"static",name:"presetID",defaultValue:BFN.CONST.CHROMATIC_PRESETS.PRESET_3}]},{id:"hipster_preset4",isPlus:!0,thumb:"tba",effectID:"chromatic",fixTransparency:!1,params:[{type:"static",name:"imageURL",defaultValue:"retro3_vignette.jpg"},{type:"static",name:"presetID",defaultValue:BFN.CONST.CHROMATIC_PRESETS.PRESET_4}]},{id:"hipster_preset5",isPlus:!0,thumb:"tba",effectID:"chromatic",fixTransparency:!1,params:[{type:"static",name:"imageURL",defaultValue:"retro2_vignette.jpg"},{type:"static",name:"presetID",defaultValue:BFN.CONST.CHROMATIC_PRESETS.PRESET_5}]},{id:"hipster_preset6",isPlus:!0,thumb:"tba",effectID:"chromatic",fixTransparency:!1,params:[{type:"static",name:"imageURL",defaultValue:"retro4_vignette.jpg"},{type:"static",name:"presetID",defaultValue:BFN.CONST.CHROMATIC_PRESETS.PRESET_6}]},{id:"hipster_preset7",isPlus:!0,thumb:"tba",effectID:"chromatic",fixTransparency:!1,params:[{type:"static",name:"presetID",defaultValue:BFN.CONST.CHROMATIC_PRESETS.PRESET_7}]},{id:"hipster_preset8",isPlus:!0,thumb:"tba",effectID:"chromatic",fixTransparency:!1,params:[{type:"static",name:"presetID",defaultValue:BFN.CONST.CHROMATIC_PRESETS.PRESET_8}]},{id:"hipster_preset9",isPlus:!0,thumb:"tba",effectID:"chromatic",fixTransparency:!1,params:[{type:"static",name:"imageURL",defaultValue:"retro2_vignette.jpg"},{type:"static",name:"presetID",defaultValue:BFN.CONST.CHROMATIC_PRESETS.PRESET_9}]},{id:"hipster_preset10",isPlus:!0,thumb:"tba",effectID:"chromatic",fixTransparency:!1,params:[{type:"static",name:"imageURL",defaultValue:"retro5_vignette.jpg"},{type:"static",name:"presetID",defaultValue:BFN.CONST.CHROMATIC_PRESETS.PRESET_10}]}]},{id:"charcoal",name:"Charcoal",graphic:"tba",presets:[{id:"charcoal_preset1",isPlus:!0,thumb:"tba",effectID:"charcoal",params:[{type:"static",name:"imageURL",defaultValue:"tex_Charcola_preset3.jpg"},{type:"static",name:"presetID",defaultValue:BFN.CONST.CHARCOAL_PRESETS.PRESET_1},{type:"color_item",name:"color_value_1",defaultValue:"FFFFFF",fineChangeEnabled:!0},{type:"color_item",name:"color_value_2",defaultValue:"000000",fineChangeEnabled:!0},{type:"slider_item",name:"detail_level",defaultValue:.6,min:0,max:1,step:.01,unit:"",multiplier:100}]},{id:"charcoal_preset3",isPlus:!0,thumb:"tba",effectID:"charcoal",params:[{type:"static",name:"imageURL",defaultValue:"tex_Charcola_preset3.jpg"},{type:"static",name:"presetID",defaultValue:BFN.CONST.CHARCOAL_PRESETS.PRESET_2},{type:"color_item",name:"color_value_1",defaultValue:"FFFFFF",fineChangeEnabled:!0},{type:"color_item",name:"color_value_2",defaultValue:"93E25F",fineChangeEnabled:!0},{type:"slider_item",name:"detail_level",defaultValue:.6,min:0,max:1,step:.01,unit:"",multiplier:100}]}]},{id:"colorpinhole",name:"Color Pinhole",graphic:"tba",presets:[{id:"colorpinhole_preset1",isPlus:!1,thumb:"tba",effectID:"colorpinhole",params:[{type:"slider_item",name:"fisheye_amount",defaultValue:1.1,min:1,max:1.5,step:.01,unit:"",multiplier:100},{type:"static",name:"imageURL",defaultValue:"tex_colorpinhole_preset1.jpg"},{type:"static",name:"presetID",defaultValue:BFN.CONST.PINHOLE_PRESETS.PRESET_1}]},{id:"colorpinhole_preset2",isPlus:!0,thumb:"tba",effectID:"colorpinhole",params:[{type:"slider_item",name:"vignette_amount",defaultValue:.15,min:0,max:1,step:.01,unit:"",multiplier:100},{type:"slider_item",name:"fisheye_amount",defaultValue:1.1,min:1,max:1.5,step:.01,unit:"",multiplier:100},{type:"static",name:"imageURL",defaultValue:"tex_colorpinhole_preset2_2.jpg"},{type:"static",name:"presetID",defaultValue:BFN.CONST.PINHOLE_PRESETS.PRESET_2}]},{id:"colorpinhole_preset3",isPlus:!0,thumb:"tba",effectID:"colorpinhole",params:[{type:"slider_item",name:"fisheye_amount",defaultValue:1.1,min:1,max:1.5,step:.01,unit:"",multiplier:100},{type:"static",name:"imageURL",defaultValue:"tex_colorpinhole_preset3_2.jpg"},{type:"static",name:"presetID",defaultValue:BFN.CONST.PINHOLE_PRESETS.PRESET_3}]},{id:"colorpinhole_preset4",isPlus:!0,thumb:"tba",effectID:"colorpinhole",params:[{type:"static",name:"vignette_amount",defaultValue:.2},{type:"static",name:"fisheye_amount",defaultValue:1.05},{type:"static",name:"imageURL",defaultValue:"tex_colorpinhole_preset4_2.jpg"},{type:"static",name:"presetID",defaultValue:BFN.CONST.PINHOLE_PRESETS.PRESET_4}]},{id:"colorpinhole_preset5",isPlus:Lt,thumb:"tba",effectID:"colorpinhole",params:[{type:"slider_item",name:"vignette_amount",defaultValue:.15,min:0,max:1,step:.01,unit:"",multiplier:100},{type:"slider_item",name:"fisheye_amount",defaultValue:1.05,min:1,max:1.5,step:.01,unit:"",multiplier:100},{type:"static",name:"presetID",defaultValue:BFN.CONST.PINHOLE_PRESETS.PRESET_5}]}]},{id:"cooler",name:"Cooler",graphic:"tba",presets:[{id:"cooling_filter_preset1",isPlus:Lt,thumb:"tba",effectID:"cooler",params:[{type:"slider_item",name:"highlights",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"slider_item",name:"shadows",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"static",name:"color",defaultValue:"006dff"},{type:"static",name:"amount",defaultValue:40}]},{id:"cooling_filter_preset2",isPlus:!0,thumb:"tba",effectID:"cooler",params:[{type:"slider_item",name:"highlights",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"slider_item",name:"shadows",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"static",name:"color",defaultValue:"00b5ff"},{type:"static",name:"amount",defaultValue:50}]}]},{id:"crossprocess",name:"Cross Process",graphic:"tba",presets:[{id:"cross_process_preset1",isPlus:!1,thumb:"tba",effectID:"crossprocess",params:[{type:"slider_item",name:"highlights",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"slider_item",name:"shadows",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"slider_item",name:"contrast",defaultValue:10,min:0,max:100,step:1,unit:"",multiplier:1},{type:"static",name:"color",defaultValue:"fcff00"},{type:"static",name:"curves",defaultValue:"crossProcess1"}]},{id:"cross_process_preset2",isPlus:!1,thumb:"tba",effectID:"crossprocess",params:[{type:"slider_item",name:"highlights",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"slider_item",name:"shadows",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"slider_item",name:"contrast",defaultValue:10,min:0,max:100,step:1,unit:"",multiplier:1},{type:"static",name:"color",defaultValue:"47a5f5"},{type:"static",name:"curves",defaultValue:"crossProcess2"}]}]},{id:"cyanotype",name:"Cyanotype",graphic:"tba",presets:[{id:"cyanotype_preset1",isPlus:Lt,thumb:"tba",effectID:"cyanotype",params:[{type:"slider_item",name:"highlights",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"slider_item",name:"shadows",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"static",name:"imageURL",defaultValue:"tex_cyanotype_preset1.jpg"},{type:"static",name:"presetID",defaultValue:BFN.CONST.CYANOTYPE_PRESETS.PRESET_1}]},{id:"cyanotype_preset2",isPlus:!0,thumb:"tba",effectID:"cyanotype",params:[{type:"slider_item",name:"highlights",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"slider_item",name:"shadows",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"static",name:"imageURL",defaultValue:"tex_cyanotype_preset2.jpg"},{type:"static",name:"presetID",defaultValue:BFN.CONST.CYANOTYPE_PRESETS.PRESET_2}]},{id:"cyanotype_preset3",isPlus:!0,thumb:"tba",effectID:"cyanotype",params:[{type:"slider_item",name:"highlights",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"slider_item",name:"shadows",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"static",name:"imageURL",defaultValue:"tex_cyanotype_preset3.jpg"},{type:"static",name:"presetID",defaultValue:BFN.CONST.CYANOTYPE_PRESETS.PRESET_3}]},{id:"cyanotype_preset4",isPlus:!0,thumb:"tba",effectID:"cyanotype",params:[{type:"slider_item",name:"highlights",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"slider_item",name:"shadows",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"static",name:"imageURL",defaultValue:"tex_cyanotype_preset4.jpg"},{type:"static",name:"presetID",defaultValue:BFN.CONST.CYANOTYPE_PRESETS.PRESET_4}]},{id:"cyanotype_preset5",isPlus:!0,thumb:"tba",effectID:"cyanotype",params:[{type:"slider_item",name:"highlights",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"slider_item",name:"shadows",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"static",name:"imageURL",defaultValue:"tex_cyanotype_preset5.jpg"},{type:"static",name:"presetID",defaultValue:BFN.CONST.CYANOTYPE_PRESETS.PRESET_5}]},{id:"cyanotype_preset6",isPlus:!0,thumb:"tba",effectID:"cyanotype",params:[{type:"slider_item",name:"highlights",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"slider_item",name:"shadows",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"static",name:"imageURL",defaultValue:"tex_cyanotype_preset6.jpg"},{type:"static",name:"presetID",defaultValue:BFN.CONST.CYANOTYPE_PRESETS.PRESET_6}]}]},{id:"grungefx",name:"Grunge",graphic:"tba",presets:[{id:"grunge_preset1",isPlus:!1,thumb:"tba",effectID:"grungefx",params:[{type:"static",name:"imageURL",defaultValue:"tex_grunge_preset1.jpg"},{type:"static",name:"presetID",defaultValue:BFN.CONST.GRUNGE_PRESETS.PRESET_1},{type:"slider_item",name:"silhouette_amount",defaultValue:102,min:25,max:126,step:1,unit:"",multiplier:1}]},{id:"grunge_preset2",isPlus:Lt,thumb:"tba",effectID:"grungefx",params:[{type:"static",name:"imageURL",defaultValue:"tex_grunge_preset2.jpg"},{type:"static",name:"presetID",defaultValue:BFN.CONST.GRUNGE_PRESETS.PRESET_2},{type:"static",name:"useBlur",defaultValue:!0}]},{id:"grunge_preset3",isPlus:!0,thumb:"tba",effectID:"grungefx",params:[{type:"static",name:"imageURL",defaultValue:"tex_grunge_preset3.jpg"},{type:"static",name:"presetID",defaultValue:BFN.CONST.GRUNGE_PRESETS.PRESET_3},{type:"slider_item",name:"shadow_amount",defaultValue:124,min:50,max:154,step:1,unit:"",multiplier:1}]},{id:"grunge_preset4",isPlus:!0,thumb:"tba",effectID:"grungefx",params:[{type:"static",name:"imageURL",defaultValue:"tex_grunge_preset4_2.jpg"},{type:"static",name:"presetID",defaultValue:BFN.CONST.GRUNGE_PRESETS.PRESET_4}]},{id:"grunge_preset5",isPlus:!0,thumb:"tba",effectID:"grungefx",params:[{type:"static",name:"imageURL",defaultValue:"tex_grunge_preset5.jpg"},{type:"static",name:"presetID",defaultValue:BFN.CONST.GRUNGE_PRESETS.PRESET_5},{type:"slider_item",name:"silhouette_amount",defaultValue:102,min:50,max:153,step:1,unit:"",multiplier:1}]},{id:"grunge_preset6",isPlus:!0,thumb:"tba",effectID:"grungefx",params:[{type:"static",name:"imageURL",defaultValue:"tex_grunge_preset6.jpg"},{type:"static",name:"presetID",defaultValue:BFN.CONST.GRUNGE_PRESETS.PRESET_6},{type:"slider_item",name:"silhouette_amount",defaultValue:56,min:50,max:153,step:1,unit:"",multiplier:1}]},{id:"grunge_preset9",isPlus:!0,thumb:"tba",effectID:"grungefx",params:[{type:"static",name:"imageURL",defaultValue:"tex_grunge_preset9.jpg"},{type:"static",name:"presetID",defaultValue:BFN.CONST.GRUNGE_PRESETS.PRESET_9},{type:"static",name:"useBlur",defaultValue:!0},{type:"slider_item",name:"detail_level",defaultValue:127,min:50,max:153,step:1,unit:"",multiplier:1}]},{id:"grunge_preset10",isPlus:!0,thumb:"tba",effectID:"grungefx",params:[{type:"static",name:"imageURL",defaultValue:"tex_grunge_preset10.jpg"},{type:"static",name:"presetID",defaultValue:BFN.CONST.GRUNGE_PRESETS.PRESET_10},{type:"slider_item",name:"silhouette_amount",defaultValue:56,min:50,max:153,step:1,unit:"",multiplier:1}]},{id:"grunge_preset11",isPlus:!1,thumb:"tba",effectID:"grungefx",params:[{type:"static",name:"imageURL",defaultValue:"tex_grunge_preset11.jpg"},{type:"static",name:"presetID",defaultValue:BFN.CONST.GRUNGE_PRESETS.PRESET_11},{type:"slider_item",name:"silhouette_amount",defaultValue:56,min:50,max:153,step:1,unit:"",multiplier:1}]},{id:"grunge_preset13",isPlus:!0,thumb:"tba",effectID:"grungefx",params:[{type:"static",name:"imageURL",defaultValue:"tex_grunge_preset13.jpg"},{type:"static",name:"presetID",defaultValue:BFN.CONST.GRUNGE_PRESETS.PRESET_13},{type:"slider_item",name:"silhouette_amount",defaultValue:56,min:50,max:153,step:1,unit:"",multiplier:1}]},{id:"grunge_preset15",isPlus:!1,thumb:"tba",effectID:"grungefx",params:[{type:"static",name:"imageURL",defaultValue:"tex_grunge_preset15.jpg"},{type:"static",name:"presetID",defaultValue:BFN.CONST.GRUNGE_PRESETS.PRESET_15},{type:"slider_item",name:"silhouette_amount",defaultValue:56,min:50,max:153,step:1,unit:"",multiplier:1}]},{id:"grunge_preset16",isPlus:!1,thumb:"tba",effectID:"grungefx",params:[{type:"static",name:"imageURL",defaultValue:"tex_grunge_preset16.jpg"},{type:"static",name:"presetID",defaultValue:BFN.CONST.GRUNGE_PRESETS.PRESET_16}]},{id:"grunge_preset17",isPlus:!0,thumb:"tba",effectID:"grungefx",params:[{type:"static",name:"imageURL",defaultValue:"tex_grunge_preset17.jpg"},{type:"static",name:"presetID",defaultValue:BFN.CONST.GRUNGE_PRESETS.PRESET_17},{type:"slider_item",name:"silhouette_amount",defaultValue:127,min:50,max:153,step:1,unit:"",multiplier:1}]}]},{id:"hdr",name:"HDR",graphic:"tba",presets:[{id:"imitate_hdr_preset1",isPlus:Lt,thumb:"tba",effectID:"hdr",params:[]},{id:"imitate_hdr_preset2",isPlus:!0,thumb:"tba",effectID:"hdr",params:[{type:"static",name:"useFragment",defaultValue:!0}]}]},{id:"holgaart",name:"Holga Art",graphic:"tba",presets:[{id:"holgaart_preset1",isPlus:Lt,thumb:"tba",effectID:"holgaart",params:[{type:"slider_item",name:"slide_right",defaultValue:.03,min:.01,max:.1,step:.001,unit:"",multiplier:1e3},{type:"slider_item",name:"slide_left",defaultValue:-.025,min:-.1,max:-.01,step:.001,unit:"",multiplier:1e3},{type:"static",name:"presetID",defaultValue:BFN.CONST.HOLGA_ART_PRESETS.PRESET_1}]},{id:"holgaart_preset2",isPlus:!0,thumb:"tba",effectID:"holgaart",params:[{type:"slider_item",name:"slide_vertical",defaultValue:.5,min:-.9,max:.9,step:.001,unit:"",multiplier:1e3},{type:"slider_item",name:"slide_horizontal",defaultValue:.5,min:-.9,max:.9,step:.001,unit:"",multiplier:1e3},{type:"static",name:"presetID",defaultValue:BFN.CONST.HOLGA_ART_PRESETS.PRESET_2}]},{id:"holgaart_preset3",isPlus:!0,thumb:"tba",effectID:"holgaart",params:[{type:"slider_item",name:"slide_vertical",defaultValue:.1,min:-.9,max:.9,step:.001,unit:"",multiplier:1e3},{type:"slider_item",name:"slide_horizontal",defaultValue:.5,min:-.9,max:.9,step:.001,unit:"",multiplier:1e3},{type:"static",name:"presetID",defaultValue:BFN.CONST.HOLGA_ART_PRESETS.PRESET_3}]},{id:"holgaart_preset4",isPlus:!0,thumb:"tba",effectID:"holgaart",params:[{type:"slider_item",name:"slide_right",defaultValue:.25,min:0,max:.9,step:.001,unit:"",multiplier:1e3},{type:"slider_item",name:"slide_left",defaultValue:-.25,min:-.9,max:0,step:.001,unit:"",multiplier:1e3},{type:"slider_item",name:"vignette_amount",defaultValue:.45,min:.01,max:.99,step:.01,unit:"",multiplier:100},{type:"static",name:"presetID",defaultValue:BFN.CONST.HOLGA_ART_PRESETS.PRESET_4},{type:"static",name:"imageURL",defaultValue:"tex_holga_preset4.jpg"}]},{id:"holgaart_preset5",isPlus:!0,thumb:"tba",effectID:"holgaart",params:[{type:"slider_item",name:"slide_right",defaultValue:.5,min:0,max:.9,step:.001,unit:"",multiplier:1e3},{type:"slider_item",name:"slide_left",defaultValue:-.25,min:-.9,max:0,step:.001,unit:"",multiplier:1e3},{type:"static",name:"presetID",defaultValue:BFN.CONST.HOLGA_ART_PRESETS.PRESET_5},{type:"static",name:"imageURL",defaultValue:"tex_holgaart_preset5.jpg"}]}]},{id:"instant",name:"Instant",graphic:"tba",presets:[{id:"instant_preset1",isPlus:!1,thumb:"tba",effectID:"instant",params:[{type:"slider_item",name:"highlights",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"slider_item",name:"shadows",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"static",name:"presetID",defaultValue:BFN.CONST.INSTANT_PRESETS.PRESET_1}]},{id:"instant_preset2",isPlus:!1,thumb:"tba",effectID:"instant",params:[{type:"slider_item",name:"highlights",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"slider_item",name:"shadows",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"static",name:"presetID",defaultValue:BFN.CONST.INSTANT_PRESETS.PRESET_2}]},{id:"instant_preset3",isPlus:!0,thumb:"tba",effectID:"instant",params:[{type:"slider_item",name:"highlights",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"slider_item",name:"shadows",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"static",name:"presetID",defaultValue:BFN.CONST.INSTANT_PRESETS.PRESET_3}]},{id:"instant_preset4",isPlus:!0,thumb:"tba",effectID:"instant",params:[{type:"slider_item",name:"highlights",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"slider_item",name:"shadows",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"static",name:"presetID",defaultValue:BFN.CONST.INSTANT_PRESETS.PRESET_4}]},{id:"instant_preset5",isPlus:!0,thumb:"tba",effectID:"instant",params:[{type:"slider_item",name:"highlights",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"slider_item",name:"shadows",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"static",name:"imageURL",defaultValue:"tex_instant5.jpg"},{type:"static",name:"presetID",defaultValue:BFN.CONST.INSTANT_PRESETS.PRESET_5}]},{id:"instant_preset6",isPlus:!0,thumb:"tba",effectID:"instant",params:[{type:"slider_item",name:"highlights",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"slider_item",name:"shadows",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"static",name:"imageURL",defaultValue:"tex_instant6.jpg"},{type:"static",name:"presetID",defaultValue:BFN.CONST.INSTANT_PRESETS.PRESET_6}]},{id:"instant_preset10",isPlus:!0,thumb:"tba",effectID:"instant",params:[{type:"slider_item",name:"highlights",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"slider_item",name:"shadows",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"static",name:"imageURL",defaultValue:"tex_instant10.jpg"},{type:"static",name:"presetID",defaultValue:BFN.CONST.INSTANT_PRESETS.PRESET_10}]},{id:"instant_preset11",isPlus:!0,thumb:"tba",effectID:"instant",params:[{type:"slider_item",name:"highlights",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"slider_item",name:"shadows",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"static",name:"imageURL",defaultValue:"tex_instant11.jpg"},{type:"static",name:"presetID",defaultValue:BFN.CONST.INSTANT_PRESETS.PRESET_11}]},{id:"instant_preset13",isPlus:!0,thumb:"tba",effectID:"instant",params:[{type:"slider_item",name:"highlights",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"slider_item",name:"shadows",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"static",name:"imageURL",defaultValue:"tex_instant13.jpg"},{type:"static",name:"presetID",defaultValue:BFN.CONST.INSTANT_PRESETS.PRESET_13}]}]},{id:"lineartopia",name:"Line Artopia",graphic:"tba",presets:[{id:"line_artopia_preset1",isPlus:!1,thumb:"tba",effectID:"lineartopia",params:[{type:"slider_item",name:"sketch_detail",defaultValue:30,min:10,max:126,step:1,unit:"",multiplier:1},{type:"slider_item",name:"line_width",defaultValue:5,min:4,max:50,step:1,unit:"",multiplier:1},{type:"slider_item",name:"line_angle",defaultValue:45,min:1,max:180,step:1,unit:"",multiplier:1},{type:"color_item",name:"color",defaultValue:"9e5724",fineChangeEnabled:!0},{type:"static",name:"presetID",defaultValue:BFN.CONST.LINE_ARTOPIA_PRESETS.PRESET_1}]},{id:"line_artopia_preset2",isPlus:!0,thumb:"tba",effectID:"lineartopia",params:[{type:"slider_item",name:"sketch_detail",defaultValue:30,min:10,max:126,step:1,unit:"",multiplier:1},{type:"slider_item",name:"line_width",defaultValue:5,min:4,max:50,step:1,unit:"",multiplier:1},{type:"slider_item",name:"line_angle",defaultValue:45,min:1,max:180,step:1,unit:"",multiplier:1},{type:"color_item",name:"color",defaultValue:"38a9ff",fineChangeEnabled:!0},{type:"static",name:"presetID",defaultValue:BFN.CONST.LINE_ARTOPIA_PRESETS.PRESET_2}]},{id:"line_artopia_preset3",isPlus:!0,thumb:"tba",effectID:"lineartopia",params:[{type:"slider_item",name:"sketch_detail",defaultValue:30,min:10,max:126,step:1,unit:"",multiplier:1},{type:"slider_item",name:"line_width",defaultValue:5,min:4,max:50,step:1,unit:"",multiplier:1},{type:"color_item",name:"color",defaultValue:"c22c2c",fineChangeEnabled:!0},{type:"static",name:"presetID",defaultValue:BFN.CONST.LINE_ARTOPIA_PRESETS.PRESET_3},{type:"static",name:"imageURL",defaultValue:"tex_drafting_preset3.jpg"}]},{id:"line_artopia_preset4",isPlus:!0,thumb:"tba",effectID:"lineartopia",params:[{type:"slider_item",name:"sketch_detail",defaultValue:30,min:10,max:126,step:1,unit:"",multiplier:1},{type:"slider_item",name:"line_width",defaultValue:5,min:4,max:50,step:1,unit:"",multiplier:1},{type:"color_item",name:"color",defaultValue:"505050",fineChangeEnabled:!0},{type:"static",name:"presetID",defaultValue:BFN.CONST.LINE_ARTOPIA_PRESETS.PRESET_4},{type:"static",name:"imageURL",defaultValue:"tex_line_artopia_preset4.jpg"}]}]},{id:"lomoart",name:"Lomo Art",graphic:"tba",presets:[{id:"lomoart_preset7",isPlus:!1,thumb:"tba",effectID:"lomoart",params:[{type:"color_item",name:"border_color",defaultValue:"FFFFFF",fineChangeEnabled:!0},{type:"slider_item",name:"border_thickness",defaultValue:25,min:0,max:100,step:1,unit:"",multiplier:1},{type:"slider_item",name:"vignette_amount",defaultValue:.1,min:.01,max:.99,step:.01,unit:"",multiplier:100},{type:"slider_item",name:"highlights",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"slider_item",name:"shadows",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"static",name:"gradURL",defaultValue:"lomoart_7_grad.jpg"},{type:"static",name:"presetID",defaultValue:BFN.CONST.LOMO_ART_PRESETS.PRESET_7}]},{id:"lomoart_preset1",isPlus:!0,thumb:"tba",effectID:"lomoart",params:[{type:"color_item",name:"border_color",defaultValue:"FFFFFF",fineChangeEnabled:!0},{type:"slider_item",name:"border_thickness",defaultValue:25,min:0,max:100,step:1,unit:"",multiplier:1},{type:"slider_item",name:"vignette_amount",defaultValue:.5,min:.01,max:.99,step:.01,unit:"",multiplier:100},{type:"slider_item",name:"highlights",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"slider_item",name:"shadows",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"static",name:"imageURL",defaultValue:"tex_lomoart_preset1.jpg"},{type:"static",name:"presetID",defaultValue:BFN.CONST.LOMO_ART_PRESETS.PRESET_1}]},{id:"lomoart_preset2",isPlus:!1,thumb:"tba",effectID:"lomoart",params:[{type:"color_item",name:"border_color",defaultValue:"FFFFFF",fineChangeEnabled:!0},{type:"slider_item",name:"border_thickness",defaultValue:25,min:0,max:100,step:1,unit:"",multiplier:1},{type:"slider_item",name:"vignette_amount",defaultValue:.5,min:.01,max:.99,step:.01,unit:"",multiplier:100},{type:"slider_item",name:"highlights",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"slider_item",name:"shadows",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"static",name:"imageURL",defaultValue:"tex_lomoart_preset2.jpg"},{type:"static",name:"presetID",defaultValue:BFN.CONST.LOMO_ART_PRESETS.PRESET_2}]},{id:"lomoart_preset3",isPlus:!0,thumb:"tba",effectID:"lomoart",params:[{type:"color_item",name:"border_color",defaultValue:"FFFFFF",fineChangeEnabled:!0},{type:"slider_item",name:"border_thickness",defaultValue:25,min:0,max:100,step:1,unit:"",multiplier:1},{type:"slider_item",name:"vignette_amount",defaultValue:.5,min:.01,max:.99,step:.01,unit:"",multiplier:100},{type:"slider_item",name:"highlights",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"slider_item",name:"shadows",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"static",name:"imageURL",defaultValue:"tex_lomoart_preset3.jpg"},{type:"static",name:"presetID",defaultValue:BFN.CONST.LOMO_ART_PRESETS.PRESET_3}]},{id:"lomoart_preset4",isPlus:!0,thumb:"tba",effectID:"lomoart",params:[{type:"color_item",name:"border_color",defaultValue:"FFFFFF",fineChangeEnabled:!0},{type:"slider_item",name:"border_thickness",defaultValue:25,min:0,max:100,step:1,unit:"",multiplier:1},{type:"slider_item",name:"vignette_amount",defaultValue:.5,min:.01,max:.99,step:.01,unit:"",multiplier:100},{type:"slider_item",name:"highlights",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"slider_item",name:"shadows",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"static",name:"imageURL",defaultValue:"tex_lomoart_preset4.jpg"},{type:"static",name:"presetID",defaultValue:BFN.CONST.LOMO_ART_PRESETS.PRESET_4}]},{id:"lomoart_preset6",isPlus:!0,thumb:"tba",effectID:"lomoart",params:[{type:"color_item",name:"border_color",defaultValue:"FFFFFF",fineChangeEnabled:!0},{type:"slider_item",name:"border_thickness",defaultValue:25,min:0,max:100,step:1,unit:"",multiplier:1},{type:"slider_item",name:"vignette_amount",defaultValue:.15,min:.01,max:.99,step:.01,unit:"",multiplier:100},{type:"slider_item",name:"highlights",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"slider_item",name:"shadows",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"static",name:"presetID",defaultValue:BFN.CONST.LOMO_ART_PRESETS.PRESET_6}]}]},{id:"motioncolor",name:"Motion Color",graphic:"tba",presets:[{id:"motioncolor_preset1",isPlus:!1,thumb:"tba",effectID:"motioncolor",params:[{type:"slider_item",name:"vignette_amount",defaultValue:.7,min:.01,max:.99,step:.01,unit:"",multiplier:100},{type:"static",name:"presetID",defaultValue:BFN.CONST.MOTION_COLOR_PRESETS.PRESET_1}]},{id:"motioncolor_preset2",isPlus:!0,thumb:"tba",effectID:"motioncolor",params:[{type:"slider_item",name:"vignette_amount",defaultValue:.7,min:.01,max:.99,step:.01,unit:"",multiplier:100},{type:"static",name:"presetID",defaultValue:BFN.CONST.MOTION_COLOR_PRESETS.PRESET_2}]},{id:"motioncolor_preset3",isPlus:!0,thumb:"tba",effectID:"motioncolor",params:[{type:"slider_item",name:"vignette_amount",defaultValue:.7,min:.01,max:.99,step:.01,unit:"",multiplier:100},{type:"static",name:"imageURL",defaultValue:"tex_motioncolort_preset3.jpg"},{type:"static",name:"presetID",defaultValue:BFN.CONST.MOTION_COLOR_PRESETS.PRESET_3}]},{id:"motioncolor_preset4",isPlus:!0,thumb:"tba",effectID:"motioncolor",params:[{type:"slider_item",name:"vignette_amount",defaultValue:.7,min:.01,max:.99,step:.01,unit:"",multiplier:100},{type:"static",name:"imageURL",defaultValue:"tex_motioncolort_preset3.jpg"},{type:"static",name:"presetID",defaultValue:BFN.CONST.MOTION_COLOR_PRESETS.PRESET_4}]},{id:"motioncolor_preset5",isPlus:!1,thumb:"tba",effectID:"motioncolor",params:[{type:"slider_item",name:"vignette_amount",defaultValue:.7,min:.01,max:.99,step:.01,unit:"",multiplier:100},{type:"static",name:"imageURL",defaultValue:"tex_motioncolor_preset5_2.jpg"},{type:"static",name:"presetID",defaultValue:BFN.CONST.MOTION_COLOR_PRESETS.PRESET_5}]}]},{id:"oldphotofx",name:"Old Photo",graphic:"tba",presets:[{id:"oldphoto_preset1",isPlus:!1,thumb:"tba",effectID:"oldphotofx",params:[{type:"static",name:"presetID",defaultValue:BFN.CONST.OLD_PHOTO_PRESETS.PRESET_1},{type:"slider_item",name:"grain_amount",defaultValue:.6,min:.2,max:5,step:.01,unit:"",multiplier:100},{type:"slider_item",name:"silhouette_amount",defaultValue:100,min:0,max:127,step:1,unit:"",multiplier:1},{type:"slider_item",name:"highlights",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"slider_item",name:"shadows",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1}]},{id:"oldphoto_preset2",isPlus:!0,thumb:"tba",effectID:"oldphotofx",params:[{type:"static",name:"presetID",defaultValue:BFN.CONST.OLD_PHOTO_PRESETS.PRESET_2},{type:"slider_item",name:"highlights",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"slider_item",name:"shadows",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1}]},{id:"oldphoto_preset4",isPlus:!0,thumb:"tba",effectID:"oldphotofx",params:[{type:"static",name:"imageURL",defaultValue:"tex_oldphoto_preset4.jpg"},{type:"static",name:"presetID",defaultValue:BFN.CONST.OLD_PHOTO_PRESETS.PRESET_4},{type:"slider_item",name:"silhouette_amount",defaultValue:100,min:50,max:152,step:1,unit:"",multiplier:1},{type:"slider_item",name:"highlights",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"slider_item",name:"shadows",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1}]},{id:"oldphoto_preset5",isPlus:!0,thumb:"tba",effectID:"oldphotofx",params:[{type:"static",name:"imageURL",defaultValue:"tex_oldphoto_preset5_1.jpg"},{type:"static",name:"presetID",defaultValue:BFN.CONST.OLD_PHOTO_PRESETS.PRESET_5},{type:"static",name:"useBlur",defaultValue:!0},{type:"slider_item",name:"color_amount",defaultValue:110,min:50,max:152,step:1,unit:"",multiplier:1},{type:"slider_item",name:"focal_blur",defaultValue:1,min:.1,max:1.5,step:.01,unit:"",multiplier:100},{type:"slider_item",name:"highlights",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"slider_item",name:"shadows",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1}]},{id:"oldphoto_preset6",isPlus:!0,thumb:"tba",effectID:"oldphotofx",params:[{type:"static",name:"imageURL",defaultValue:"tex_oldphoto_preset6.jpg"},{type:"static",name:"presetID",defaultValue:BFN.CONST.OLD_PHOTO_PRESETS.PRESET_6},{type:"slider_item",name:"brightness",defaultValue:1,min:1,max:10,step:1,unit:"",multiplier:1},{type:"slider_item",name:"highlights",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"slider_item",name:"shadows",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1}]},{id:"oldphoto_preset7",isPlus:!0,thumb:"tba",effectID:"oldphotofx",params:[{type:"static",name:"imageURL",defaultValue:"tex_oldphoto_preset7.jpg"},{type:"static",name:"presetID",defaultValue:BFN.CONST.OLD_PHOTO_PRESETS.PRESET_7},{type:"slider_item",name:"silhouette_amount",defaultValue:100,min:50,max:152,step:1,unit:"",multiplier:1},{type:"slider_item",name:"highlights",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"slider_item",name:"shadows",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1}]},{id:"oldphoto_preset8",isPlus:!0,thumb:"tba",effectID:"oldphotofx",params:[{type:"static",name:"presetID",defaultValue:BFN.CONST.OLD_PHOTO_PRESETS.PRESET_8},{type:"slider_item",name:"highlights",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"slider_item",name:"shadows",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1}]},{id:"oldphoto_preset9",isPlus:!0,thumb:"tba",effectID:"oldphotofx",params:[{type:"static",name:"imageURL",defaultValue:"tex_oldphoto_preset9.jpg"},{type:"static",name:"presetID",defaultValue:BFN.CONST.OLD_PHOTO_PRESETS.PRESET_9},{type:"slider_item",name:"highlights",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"slider_item",name:"shadows",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1}]},{id:"oldphoto_preset10",isPlus:!0,thumb:"tba",effectID:"oldphotofx",params:[{type:"static",name:"imageURL",defaultValue:"tex_oldphoto_preset6.jpg"},{type:"static",name:"presetID",defaultValue:BFN.CONST.OLD_PHOTO_PRESETS.PRESET_10},{type:"slider_item",name:"silhouette_amount",defaultValue:100,min:50,max:152,step:1,unit:"",multiplier:1},{type:"slider_item",name:"highlights",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"slider_item",name:"shadows",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1}]},{id:"oldphoto_preset11",isPlus:!0,thumb:"tba",effectID:"oldphotofx",params:[{type:"static",name:"imageURL",defaultValue:"tex_oldphoto_preset11.jpg"},{type:"static",name:"presetID",defaultValue:BFN.CONST.OLD_PHOTO_PRESETS.PRESET_11},{type:"slider_item",name:"silhouette_amount",defaultValue:105,min:50,max:152,step:1,unit:"",multiplier:1},{type:"slider_item",name:"highlights",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"slider_item",name:"shadows",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1}]},{id:"oldphoto_preset12",isPlus:!0,thumb:"tba",effectID:"oldphotofx",params:[{type:"static",name:"presetID",defaultValue:BFN.CONST.OLD_PHOTO_PRESETS.PRESET_12},{type:"slider_item",name:"silhouette_amount",defaultValue:105,min:50,max:152,step:1,unit:"",multiplier:1},{type:"slider_item",name:"highlights",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"slider_item",name:"shadows",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1}]},{id:"oldphoto_preset13",isPlus:!0,thumb:"tba",effectID:"oldphotofx",params:[{type:"static",name:"imageURL",defaultValue:"tex_oldphoto_preset13_2.jpg"},{type:"static",name:"presetID",defaultValue:BFN.CONST.OLD_PHOTO_PRESETS.PRESET_13},{type:"slider_item",name:"silhouette_amount",defaultValue:105,min:50,max:152,step:1,unit:"",multiplier:1},{type:"slider_item",name:"highlights",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"slider_item",name:"shadows",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1}]},{id:"oldphoto_preset14",isPlus:!0,thumb:"tba",effectID:"oldphotofx",params:[{type:"static",name:"imageURL",defaultValue:"tex_oldphoto_preset6.jpg"},{type:"static",name:"presetID",defaultValue:BFN.CONST.OLD_PHOTO_PRESETS.PRESET_14},{type:"slider_item",name:"silhouette_amount",defaultValue:105,min:50,max:152,step:1,unit:"",multiplier:1},{type:"slider_item",name:"highlights",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"slider_item",name:"shadows",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1}]},{id:"oldphoto_preset15",isPlus:!0,thumb:"tba",effectID:"oldphotofx",params:[{type:"static",name:"imageURL",defaultValue:"tex_oldphoto_preset_15.jpg"},{type:"static",name:"presetID",defaultValue:BFN.CONST.OLD_PHOTO_PRESETS.PRESET_15},{type:"slider_item",name:"silhouette_amount",defaultValue:115,min:50,max:152,step:1,unit:"",multiplier:1},{type:"slider_item",name:"highlights",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"slider_item",name:"shadows",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1}]},{id:"oldphoto_preset16",isPlus:!0,thumb:"tba",effectID:"oldphotofx",params:[{type:"static",name:"imageURL",defaultValue:"tex_oldphoto_preset16.jpg"},{type:"static",name:"presetID",defaultValue:BFN.CONST.OLD_PHOTO_PRESETS.PRESET_16},{type:"static",name:"useBlur",defaultValue:!0},{type:"slider_item",name:"blur_amount",defaultValue:.2,min:0,max:1,step:.01,unit:"",multiplier:100},{type:"slider_item",name:"highlights",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"slider_item",name:"shadows",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1}]},{id:"oldphoto_preset17",isPlus:!0,thumb:"tba",effectID:"oldphotofx",params:[{type:"static",name:"presetID",defaultValue:BFN.CONST.OLD_PHOTO_PRESETS.PRESET_17},{type:"slider_item",name:"silhouette_amount",defaultValue:105,min:50,max:152,step:1,unit:"",multiplier:1},{type:"slider_item",name:"highlights",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"slider_item",name:"shadows",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1}]},{id:"oldphoto_preset18",isPlus:!0,thumb:"tba",effectID:"oldphotofx",params:[{type:"static",name:"presetID",defaultValue:BFN.CONST.OLD_PHOTO_PRESETS.PRESET_18},{type:"slider_item",name:"contrast",defaultValue:.1,min:0,max:.5,step:.01,unit:"",multiplier:100},{type:"slider_item",name:"highlights",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"slider_item",name:"shadows",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1}]},{id:"oldphoto_preset19",isPlus:!0,thumb:"tba",effectID:"oldphotofx",params:[{type:"static",name:"imageURL",defaultValue:"oldies_texture19.jpg"},{type:"static",name:"presetID",defaultValue:BFN.CONST.OLD_PHOTO_PRESETS.PRESET_19}]},{id:"oldphoto_preset20",isPlus:!0,thumb:"tba",effectID:"oldphotofx",params:[{type:"static",name:"imageURL",defaultValue:"oldies_texture20.jpg"},{type:"static",name:"presetID",defaultValue:BFN.CONST.OLD_PHOTO_PRESETS.PRESET_20}]}]},{id:"orton_style",name:"Orton Style",graphic:"tba",presets:[{id:"orton_style_preset1",isPlus:Lt,thumb:"tba",effectID:"orton_style",params:[{type:"slider_item",name:"blur_amount",defaultValue:.5,min:.05,max:1,step:.01,unit:"",multiplier:100}]}]},{id:"patrioticfx",name:"Patriotic",graphic:"tba",presets:[{id:"patriotic_preset1",isPlus:!0,thumb:"tba",effectID:"patrioticfx",params:[{type:"slider_item",name:"silhouette_amount",defaultValue:102,min:50,max:152,step:1,unit:"",multiplier:1},{type:"slider_item",name:"color_space",defaultValue:0,min:-180,max:180,step:1,unit:"",multiplier:1},{type:"static",name:"imageURL",defaultValue:"tex_patriot_preset1.jpg"},{type:"static",name:"presetID",defaultValue:BFN.CONST.PATRIOTIC_PRESETS.PRESET_1}]},{id:"patriotic_preset2",isPlus:!0,thumb:"tba",effectID:"patrioticfx",params:[{type:"slider_item",name:"silhouette_amount",defaultValue:86,min:50,max:152,step:1,unit:"",multiplier:1},{type:"slider_item",name:"color_space",defaultValue:0,min:-180,max:180,step:1,unit:"",multiplier:1},{type:"static",name:"presetID",defaultValue:BFN.CONST.PATRIOTIC_PRESETS.PRESET_2}]},{id:"patriotic_preset3",isPlus:!1,thumb:"tba",effectID:"patrioticfx",params:[{type:"slider_item",name:"halftone_size",defaultValue:4,min:3,max:50,step:1,unit:"",multiplier:1},{type:"color_item",name:"line_color",defaultValue:"aa0000",fineChangeEnabled:!0},{type:"color_item",name:"background_color",defaultValue:"437fff",fineChangeEnabled:!0},{type:"static",name:"presetID",defaultValue:BFN.CONST.PATRIOTIC_PRESETS.PRESET_3}]},{id:"patriotic_preset4",isPlus:!0,thumb:"tba",effectID:"patrioticfx",params:[{type:"static",name:"imageURL",defaultValue:"tex_patriot_preset4.jpg"},{type:"static",name:"presetID",defaultValue:BFN.CONST.PATRIOTIC_PRESETS.PRESET_4}]},{id:"patriotic_preset5",isPlus:!1,thumb:"tba",effectID:"patrioticfx",params:[{type:"static",name:"imageURL",defaultValue:"tex_patriot_preset4.jpg"},{type:"static",name:"presetID",defaultValue:BFN.CONST.PATRIOTIC_PRESETS.PRESET_5}]},{id:"patriotic_preset6",isPlus:!0,thumb:"tba",effectID:"patrioticfx",params:[{type:"slider_item",name:"silhouette_amount",defaultValue:86,min:50,max:152,step:1,unit:"",multiplier:1},{type:"slider_item",name:"color_space",defaultValue:0,min:-180,max:180,step:1,unit:"",multiplier:1},{type:"slider_item",name:"star_size",defaultValue:.3,min:.1,max:1,step:.01,unit:"",multiplier:100},{type:"static",name:"imageURL",defaultValue:"tex_patriot_preset6_4.jpg"},{type:"static",name:"tileURL",defaultValue:"256star.jpg"},{type:"static",name:"presetID",defaultValue:BFN.CONST.PATRIOTIC_PRESETS.PRESET_6}]},{id:"patriotic_preset7",isPlus:!0,thumb:"tba",effectID:"patrioticfx",params:[{type:"slider_item",name:"smoothness",defaultValue:.03,min:.03,max:1,step:.01,unit:"",multiplier:100},{type:"slider_item",name:"red",defaultValue:.4,min:.1,max:.6,step:.01,unit:"",multiplier:100},{type:"slider_item",name:"navy",defaultValue:.14,min:.1,max:.6,step:.01,unit:"",multiplier:100},{type:"static",name:"useBlur",defaultValue:!0},{type:"static",name:"presetID",defaultValue:BFN.CONST.PATRIOTIC_PRESETS.PRESET_7}]}]},{id:"pinhole",name:"Pinhole",graphic:"tba",presets:[{id:"pinhole_preset1",isPlus:!1,thumb:"tba",effectID:"pinhole",params:[{type:"slider_item",name:"vignette_amount",defaultValue:.15,min:0,max:1,step:.01,unit:"",multiplier:100},{type:"slider_item",name:"motion_angle",defaultValue:120,min:0,max:360,step:1,unit:"",multiplier:1},{type:"slider_item",name:"motion_amount",defaultValue:10,min:0,max:100,step:1,unit:"",multiplier:1},{type:"static",name:"presetID",defaultValue:BFN.CONST.PINHOLE_PRESETS.PRESET_1}]},{id:"pinhole_preset2",isPlus:!0,thumb:"tba",effectID:"pinhole",params:[{type:"slider_item",name:"vignette_amount",defaultValue:.15,min:0,max:1,step:.01,unit:"",multiplier:100},{type:"slider_item",name:"fisheye_amount",defaultValue:1.1,min:1,max:1.5,step:.01,unit:"",multiplier:100},{type:"static",name:"imageURL",defaultValue:"tex_pinhole_preset2_b.jpg"},{type:"static",name:"presetID",defaultValue:BFN.CONST.PINHOLE_PRESETS.PRESET_2}]},{id:"pinhole_preset3",isPlus:!0,thumb:"tba",effectID:"pinhole",params:[{type:"slider_item",name:"fisheye_amount",defaultValue:1.1,min:1,max:1.5,step:.01,unit:"",multiplier:100},{type:"static",name:"imageURL",defaultValue:"tex_pinhole3.jpg"},{type:"static",name:"presetID",defaultValue:BFN.CONST.PINHOLE_PRESETS.PRESET_3}]},{id:"pinhole_preset4",isPlus:!0,thumb:"tba",effectID:"pinhole",params:[{type:"slider_item",name:"vignette_amount",defaultValue:.15,min:0,max:1,step:.01,unit:"",multiplier:100},{type:"slider_item",name:"motion_angle",defaultValue:0,min:0,max:360,step:1,unit:"",multiplier:1},{type:"slider_item",name:"motion_amount",defaultValue:10,min:5,max:100,step:1,unit:"",multiplier:1},{type:"slider_item",name:"fisheye_amount",defaultValue:1,min:1,max:1.5,step:.01,unit:"",multiplier:100},{type:"static",name:"imageURL",defaultValue:"tex_pinhole_preset4_r.jpg"},{type:"static",name:"presetID",defaultValue:BFN.CONST.PINHOLE_PRESETS.PRESET_4}]},{id:"pinhole_preset5",isPlus:!0,thumb:"tba",effectID:"pinhole",params:[{type:"slider_item",name:"vignette_amount",defaultValue:.15,min:0,max:1,step:.01,unit:"",multiplier:100},{type:"slider_item",name:"fisheye_amount",defaultValue:1.05,min:1,max:1.5,step:.01,unit:"",multiplier:100},{type:"static",name:"imageURL",defaultValue:"tex_colorpinhole_preset4_2.jpg"},{type:"static",name:"presetID",defaultValue:BFN.CONST.PINHOLE_PRESETS.PRESET_5}]}]},{id:"popartfx",name:"Pop Art",graphic:"tba",presets:[{id:"popart_preset1",isPlus:!1,thumb:"tba",effectID:"popartfx",params:[{type:"slider_item",name:"halftone_size",defaultValue:4,min:3,max:50,step:1,unit:"",multiplier:1},{type:"static",name:"isAdaptive",defaultValue:!0},{type:"static",name:"gradURL",defaultValue:"popart_preset1_grad.jpg"},{type:"static",name:"presetID",defaultValue:BFN.CONST.POPART_PRESETS.PRESET_1}]},{id:"popart_preset2",isPlus:!1,thumb:"tba",effectID:"popartfx",params:[{type:"slider_item",name:"halftone_size",defaultValue:4,min:3,max:50,step:1,unit:"",multiplier:1},{type:"slider_item",name:"detail_level",defaultValue:204,min:50,max:230,step:1,unit:"",multiplier:1},{type:"static",name:"imageURL",defaultValue:"tex_popart_preset3.jpg"},{type:"static",name:"gradURL",defaultValue:"popart_preset1_grad.jpg"},{type:"static",name:"isAdaptive",defaultValue:!0},{type:"static",name:"isBlur",defaultValue:!0},{type:"static",name:"presetID",defaultValue:BFN.CONST.POPART_PRESETS.PRESET_2}]},{id:"popart_preset3",isPlus:!0,thumb:"tba",effectID:"popartfx",params:[{type:"slider_item",name:"halftone_size",defaultValue:4,min:3,max:50,step:1,unit:"",multiplier:1},{type:"slider_item",name:"detail_level",defaultValue:204,min:50,max:230,step:1,unit:"",multiplier:1},{type:"static",name:"isBlur",defaultValue:!0},{type:"static",name:"imageURL",defaultValue:"tex_popart_preset3.jpg"},{type:"static",name:"presetID",defaultValue:BFN.CONST.POPART_PRESETS.PRESET_3}]},{id:"popart_preset4",isPlus:!0,thumb:"tba",effectID:"popartfx",params:[{type:"slider_item",name:"halftone_size",defaultValue:4,min:3,max:50,step:1,unit:"",multiplier:1},{type:"static",name:"isAdaptive",defaultValue:!0},{type:"static",name:"presetID",defaultValue:BFN.CONST.POPART_PRESETS.PRESET_4}]},{id:"popart_preset5",isPlus:!0,thumb:"tba",effectID:"popartfx",params:[{type:"slider_item",name:"halftone_size",defaultValue:3,min:3,max:50,step:1,unit:"",multiplier:1},{type:"static",name:"isAdaptive",defaultValue:!0},{type:"static",name:"presetID",defaultValue:BFN.CONST.POPART_PRESETS.PRESET_5}]},{id:"popart_preset6",isPlus:!0,thumb:"tba",effectID:"popartfx",params:[{type:"slider_item",name:"halftone_size",defaultValue:4,min:3,max:50,step:1,unit:"",multiplier:1},{type:"static",name:"isAdaptive",defaultValue:!0},{type:"static",name:"imageURL",defaultValue:"tex_popart_preset6.jpg"},{type:"static",name:"gradURL",defaultValue:"popart_preset6_grad.jpg"},{type:"static",name:"presetID",defaultValue:BFN.CONST.POPART_PRESETS.PRESET_6}]},{id:"popart_preset7",isPlus:!1,thumb:"tba",effectID:"popartfx",params:[{type:"slider_item",name:"halftone_size",defaultValue:4,min:3,max:50,step:1,unit:"",multiplier:1},{type:"static",name:"isAdaptive",defaultValue:!0},{type:"static",name:"gradURL",defaultValue:"popart_preset1_grad.jpg"},{type:"static",name:"presetID",defaultValue:BFN.CONST.POPART_PRESETS.PRESET_7}]},{id:"popart_preset9",isPlus:!0,useBasicAmount:!1,useGeneric:!1,usePaint:!1,thumb:"tba",effectID:"popartfx",params:[{type:"slider_item",name:"halftone_size",defaultValue:4,min:3,max:50,step:1,unit:"",multiplier:1},{type:"slider_item",name:"silhouette_amount",defaultValue:102,min:50,max:152,step:1,unit:"",multiplier:1},{type:"static",name:"isHalftone",defaultValue:!0},{type:"static",name:"presetID",defaultValue:BFN.CONST.POPART_PRESETS.PRESET_9}]},{id:"popart_preset10",isPlus:!0,useBasicAmount:!1,useGeneric:!1,usePaint:!1,thumb:"tba",effectID:"popartfx",params:[{type:"slider_item",name:"halftone_size",defaultValue:4,min:3,max:50,step:1,unit:"",multiplier:1},{type:"slider_item",name:"smooth_amount",defaultValue:.02,min:.02,max:1,step:.01,unit:"",multiplier:100},{type:"slider_item",name:"color_detail",defaultValue:4,min:4,max:15,step:.01,unit:"",multiplier:100},{type:"static",name:"isHalftone",defaultValue:!0},{type:"static",name:"isBlur",defaultValue:!0},{type:"static",name:"presetID",defaultValue:BFN.CONST.POPART_PRESETS.PRESET_10}]},{id:"popart_preset11",isPlus:!0,useBasicAmount:!1,useGeneric:!1,usePaint:!1,thumb:"tba",effectID:"popartfx",params:[{type:"slider_item",name:"halftone_size",defaultValue:4,min:3,max:50,step:1,unit:"",multiplier:1},{type:"slider_item",name:"silhouette_amount",defaultValue:102,min:50,max:152,step:1,unit:"",multiplier:1},{type:"static",name:"gradURL",defaultValue:"popart_preset11_grad.jpg"},{type:"static",name:"isHalftone",defaultValue:!0},{type:"static",name:"presetID",defaultValue:BFN.CONST.POPART_PRESETS.PRESET_11}]},{id:"popart_preset13",isPlus:!0,useBasicAmount:!1,useGeneric:!1,usePaint:!1,thumb:"tba",effectID:"popartfx",params:[{type:"slider_item",name:"silhouette_amount",defaultValue:102,min:50,max:152,step:1,unit:"",multiplier:1},{type:"color_item",name:"color_value_1",defaultValue:"ff0000",fineChangeEnabled:!0},{type:"color_item",name:"color_value_2",defaultValue:"ffea00",fineChangeEnabled:!0},{type:"color_item",name:"color_value_3",defaultValue:"00d1ff",fineChangeEnabled:!0},{type:"color_item",name:"color_value_4",defaultValue:"37ff00",fineChangeEnabled:!0},{type:"static",name:"isBlur",defaultValue:!0},{type:"static",name:"presetID",defaultValue:BFN.CONST.POPART_PRESETS.PRESET_13}]},{id:"popart_preset14",isPlus:!0,useBasicAmount:!1,useGeneric:!1,usePaint:!1,thumb:"tba",effectID:"popartfx",params:[{type:"static",name:"isAdaptive",defaultValue:!0},{type:"static",name:"presetID",defaultValue:BFN.CONST.POPART_PRESETS.PRESET_14}]},{id:"popart_preset15",isPlus:!0,useBasicAmount:!1,useGeneric:!1,usePaint:!1,thumb:"tba",effectID:"popartfx",params:[{type:"slider_item",name:"halftone_size",defaultValue:4,min:3,max:50,step:1,unit:"",multiplier:1},{type:"slider_item",name:"silhouette_amount",defaultValue:102,min:50,max:152,step:1,unit:"",multiplier:1},{type:"static",name:"isHalftone",defaultValue:!0},{type:"static",name:"presetID",defaultValue:BFN.CONST.POPART_PRESETS.PRESET_15}]},{id:"popart_preset16",isPlus:!0,thumb:"tba",effectID:"popartfx",params:[{type:"slider_item",name:"silhouette_amount",defaultValue:102,min:50,max:152,step:1,unit:"",multiplier:1},{type:"static",name:"presetID",defaultValue:BFN.CONST.POPART_PRESETS.PRESET_16}]},{id:"popart_preset17",isPlus:!0,thumb:"tba",effectID:"popartfx",params:[{type:"slider_item",name:"silhouette_amount",defaultValue:102,min:50,max:152,step:1,unit:"",multiplier:1},{type:"static",name:"presetID",defaultValue:BFN.CONST.POPART_PRESETS.PRESET_17}]},{id:"popart_preset18",isPlus:!0,thumb:"tba",effectID:"popartfx",params:[{type:"slider_item",name:"silhouette_amount",defaultValue:102,min:50,max:152,step:1,unit:"",multiplier:1},{type:"static",name:"presetID",defaultValue:BFN.CONST.POPART_PRESETS.PRESET_18}]},{id:"popart_preset19",isPlus:!0,thumb:"tba",effectID:"popartfx",params:[{type:"slider_item",name:"silhouette_amount",defaultValue:102,min:50,max:152,step:1,unit:"",multiplier:1},{type:"static",name:"halftoneURL",defaultValue:"popart_texture_halftone.jpg"},{type:"static",name:"presetID",defaultValue:BFN.CONST.POPART_PRESETS.PRESET_19}]},{id:"popart_preset20",isPlus:!0,thumb:"tba",effectID:"popartfx",params:[{type:"slider_item",name:"silhouette_amount",defaultValue:102,min:50,max:152,step:1,unit:"",multiplier:1},{type:"static",name:"presetID",defaultValue:BFN.CONST.POPART_PRESETS.PRESET_20}]}]},{id:"sepia",name:"Sepia",graphic:"tba",presets:[{id:"sepia_preset1",isPlus:!1,thumb:"tba",effectID:"sepia",params:[{type:"slider_item",name:"highlights",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"slider_item",name:"shadows",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1}]}]},{id:"stenciler",name:"Stenciler",graphic:"tba",presets:[{id:"stenciler_preset1",isPlus:!1,thumb:"tba",effectID:"stenciler",params:[{type:"static",name:"imageURL",defaultValue:"tex_stenciler_preset1.jpg"},{type:"static",name:"presetID",defaultValue:BFN.CONST.STENCILER_PRESETS.PRESET_1},{type:"static",name:"useBlur",defaultValue:!0},{type:"color_item",name:"color",defaultValue:"000000",fineChangeEnabled:!0},{type:"slider_item",name:"detail_level",defaultValue:.6,min:0,max:1,step:.01,unit:"",multiplier:100}]},{id:"stenciler_preset2",isPlus:!1,thumb:"tba",effectID:"stenciler",params:[{type:"static",name:"imageURL",defaultValue:"tex_stenciler_preset2.jpg"},{type:"static",name:"presetID",defaultValue:BFN.CONST.STENCILER_PRESETS.PRESET_2},{type:"static",name:"useBlur",defaultValue:!0},{type:"color_item",name:"color",defaultValue:"4590d1",fineChangeEnabled:!0},{type:"slider_item",name:"detail_level",defaultValue:.6,min:0,max:1,step:.01,unit:"",multiplier:100}]},{id:"stenciler_preset3",isPlus:!0,thumb:"tba",effectID:"stenciler",params:[{type:"static",name:"imageURL",defaultValue:"tex_stenciler_preset3.jpg"},{type:"static",name:"presetID",defaultValue:BFN.CONST.STENCILER_PRESETS.PRESET_3},{type:"color_item",name:"color",defaultValue:"000000",fineChangeEnabled:!0},{type:"slider_item",name:"detail_level",defaultValue:.45,min:0,max:.75,step:.01,unit:"",multiplier:100}]},{id:"stenciler_preset4",isPlus:!0,thumb:"tba",effectID:"stenciler",params:[{type:"static",name:"imageURL",defaultValue:"tex_stenciler_preset4.jpg"},{type:"static",name:"presetID",defaultValue:BFN.CONST.STENCILER_PRESETS.PRESET_4},{type:"slider_item",name:"detail_level",defaultValue:.45,min:0,max:.75,step:.01,unit:"",multiplier:100}]},{id:"stenciler_preset6",isPlus:!0,thumb:"tba",effectID:"stenciler",params:[{type:"static",name:"imageURL",defaultValue:"tex_stenciler_preset6.jpg"},{type:"static",name:"presetID",defaultValue:BFN.CONST.STENCILER_PRESETS.PRESET_6},{type:"static",name:"useBlur",defaultValue:!0},{type:"slider_item",name:"color_detail",defaultValue:4,min:2,max:15,step:.01,unit:"",multiplier:100}]},{id:"stenciler_preset7",isPlus:!0,thumb:"tba",effectID:"stenciler",params:[{type:"static",name:"imageURL",defaultValue:"tex_stenciler_preset7.jpg"},{type:"static",name:"presetID",defaultValue:BFN.CONST.STENCILER_PRESETS.PRESET_7},{type:"slider_item",name:"detail_level",defaultValue:.45,min:0,max:.75,step:.01,unit:"",multiplier:100}]},{id:"stenciler_preset8",isPlus:!0,thumb:"tba",effectID:"stenciler",params:[{type:"static",name:"imageURL",defaultValue:"tex_stenciler_preset8.jpg"},{type:"static",name:"presetID",defaultValue:BFN.CONST.STENCILER_PRESETS.PRESET_8},{type:"slider_item",name:"detail_level",defaultValue:.45,min:0,max:.75,step:.01,unit:"",multiplier:100}]},{id:"stenciler_preset9",isPlus:!0,thumb:"tba",effectID:"stenciler",params:[{type:"static",name:"imageURL",defaultValue:"tex_stenciler_preset9.jpg"},{type:"static",name:"presetID",defaultValue:BFN.CONST.STENCILER_PRESETS.PRESET_9},{type:"slider_item",name:"detail_level",defaultValue:.45,min:0,max:.75,step:.01,unit:"",multiplier:100}]},{id:"stenciler_preset10",isPlus:!0,thumb:"tba",effectID:"stenciler",params:[{type:"static",name:"imageURL",defaultValue:"tex_stenciler_preset10.jpg"},{type:"static",name:"presetID",defaultValue:BFN.CONST.STENCILER_PRESETS.PRESET_10},{type:"slider_item",name:"detail_level",defaultValue:.45,min:0,max:.75,step:.01,unit:"",multiplier:100}]},{id:"stenciler_preset11",isPlus:!0,thumb:"tba",effectID:"stenciler",params:[{type:"static",name:"imageURL",defaultValue:"tex_stenciler_preset11.jpg"},{type:"static",name:"presetID",defaultValue:BFN.CONST.STENCILER_PRESETS.PRESET_11},{type:"slider_item",name:"detail_level",defaultValue:.45,min:0,max:.75,step:.01,unit:"",multiplier:100}]}]},{id:"summer",name:"Summer",graphic:"tba",presets:[{id:"summer_preset1",isPlus:!1,thumb:"tba",effectID:"summer",params:[{type:"slider_item",name:"highlights",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"slider_item",name:"shadows",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"static",name:"imageURL",defaultValue:"summer_texture.png"},{type:"static",name:"presetID",defaultValue:BFN.CONST.SUMMER_PRESETS.PRESET_1}]},{id:"summer_preset2",isPlus:Lt,thumb:"tba",effectID:"summer",params:[{type:"slider_item",name:"highlights",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"slider_item",name:"shadows",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"static",name:"imageURL",defaultValue:"summer_texture3.png"},{type:"static",name:"presetID",defaultValue:BFN.CONST.SUMMER_PRESETS.PRESET_2}]}]},{id:"sunburst",name:"Sunburst",graphic:"tba",presets:[{id:"sunburst_preset1",isPlus:!1,thumb:"tba",effectID:"sunburst",params:[{type:"static",name:"imageURL",defaultValue:"tex_sunburst_preset1.jpg"},{type:"static",name:"presetID",defaultValue:BFN.CONST.SUNBURST_PRESETS.PRESET_1},{type:"slider_item",name:"halftone_size",defaultValue:4,min:3,max:50,step:1,unit:"",multiplier:1},{type:"slider_item",name:"silhouette_amount",defaultValue:204,min:102,max:255,step:1,unit:"",multiplier:1}]},{id:"sunburst_preset2",isPlus:!1,thumb:"tba",effectID:"sunburst",params:[{type:"static",name:"presetID",defaultValue:BFN.CONST.SUNBURST_PRESETS.PRESET_2},{type:"color_item",name:"color",defaultValue:"e9e9e9",fineChangeEnabled:!0},{type:"slider_item",name:"halftone_size",defaultValue:4,min:3,max:50,step:1,unit:"",multiplier:1},{type:"slider_item",name:"sunburst_amount",defaultValue:30,min:5,max:50,step:1,unit:"",multiplier:1}]},{id:"sunburst_preset3",isPlus:!0,thumb:"tba",effectID:"sunburst",params:[{type:"static",name:"imageURL",defaultValue:"tex_sunburst_preset3.jpg"},{type:"static",name:"presetID",defaultValue:BFN.CONST.SUNBURST_PRESETS.PRESET_3},{type:"slider_item",name:"grain_amount",defaultValue:1,min:.1,max:5,step:.01,unit:"",multiplier:100},{type:"slider_item",name:"sunburst_amount",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1}]},{id:"sunburst_preset4",isPlus:!0,thumb:"tba",effectID:"sunburst",params:[{type:"static",name:"presetID",defaultValue:BFN.CONST.SUNBURST_PRESETS.PRESET_4},{type:"slider_item",name:"grain_amount",defaultValue:1.1,min:.1,max:5,step:.01,unit:"",multiplier:100}]},{id:"sunburst_preset5",isPlus:!0,thumb:"tba",effectID:"sunburst",params:[{type:"static",name:"imageURL",defaultValue:"tex_sunburst_preset5.jpg"},{type:"static",name:"presetID",defaultValue:BFN.CONST.SUNBURST_PRESETS.PRESET_5},{type:"slider_item",name:"grain_amount",defaultValue:.8,min:.1,max:5,step:.01,unit:"",multiplier:100}]},{id:"sunburst_preset6",isPlus:!0,thumb:"tba",effectID:"sunburst",params:[{type:"static",name:"presetID",defaultValue:BFN.CONST.SUNBURST_PRESETS.PRESET_6},{type:"slider_item",name:"grain_amount",defaultValue:1.1,min:.1,max:5,step:.01,unit:"",multiplier:100}]}]},{id:"tiltshiftfx",name:"Tilt Shift",graphic:"tba",presets:[{id:"tiltshift_preset1",isPlus:!1,thumb:"tba",effectID:"tiltshiftfx",params:[{type:"slider_item",name:"size",defaultValue:3.5,min:1,max:10,step:.01,unit:"",multiplier:100},{type:"slider_item",name:"blur_amount",defaultValue:.5,min:.05,max:1,step:.01,unit:"",multiplier:100},{type:"slider_item",name:"angle",defaultValue:0,min:-180,max:180,step:1,unit:"",multiplier:1},{type:"slider_item",name:"slide_vertical",defaultValue:0,min:-.5,max:.5,step:.01,unit:"",multiplier:100},{type:"static",name:"useBlur",defaultValue:!0},{type:"static",name:"presetID",defaultValue:BFN.CONST.TILT_SHIFT_PRESETS.PRESET_1}]},{id:"tiltshift_preset2",isPlus:Lt,thumb:"tba",effectID:"tiltshiftfx",params:[{type:"slider_item",name:"size",defaultValue:2.5,min:1,max:5,step:.01,unit:"",multiplier:100},{type:"slider_item",name:"blur_amount",defaultValue:.5,min:.05,max:1,step:.01,unit:"",multiplier:100},{type:"slider_item",name:"slide_vertical",defaultValue:0,min:-.5,max:.5,step:.01,unit:"",multiplier:100},{type:"slider_item",name:"slide_horizontal",defaultValue:0,min:-.5,max:.5,step:.01,unit:"",multiplier:100},{type:"static",name:"useBlur",defaultValue:!0},{type:"static",name:"presetID",defaultValue:BFN.CONST.TILT_SHIFT_PRESETS.PRESET_2}]}]},{id:"tinytype",name:"Tin Type",graphic:"tba",presets:[{id:"tinytype_preset1",isPlus:!0,thumb:"tba",effectID:"tinytype",params:[{type:"toggle_group",name:"modeBW",defaultValue:1,buttons:[{langID:"lighter",value:0},{langID:"medium",value:1},{langID:"darker",value:2}]},{type:"color_palette",name:"modeColor",defaultValue:"8A8174",colors:[["8A8174","818A74","8A7874","85748A","6a5f37"],["926C6C","A08D5E","6E7791","6E917E","4d3846"]],presetsOnly:!0},{type:"static",name:"imageURL",defaultValue:"tintype_texture_1.jpg"}]},{id:"tinytype_preset2",isPlus:!0,thumb:"tba",effectID:"tinytype",params:[{type:"toggle_group",name:"modeBW",defaultValue:1,buttons:[{langID:"lighter",value:0},{langID:"medium",value:1},{langID:"darker",value:2}]},{type:"color_palette",name:"modeColor",defaultValue:"818A74",colors:[["8A8174","818A74","8A7874","85748A","6a5f37"],["926C6C","A08D5E","6E7791","6E917E","4d3846"]],presetsOnly:!0},{type:"static",name:"imageURL",defaultValue:"tintype_texture_2.jpg"}]},{id:"tinytype_preset3",isPlus:!0,thumb:"tba",effectID:"tinytype",params:[{type:"toggle_group",name:"modeBW",defaultValue:1,buttons:[{langID:"lighter",value:0},{langID:"medium",value:1},{langID:"darker",value:2}]},{type:"color_palette",name:"modeColor",defaultValue:"8A8174",colors:[["8A8174","818A74","8A7874","85748A","6a5f37"],["926C6C","A08D5E","6E7791","6E917E","4d3846"]],presetsOnly:!0},{type:"static",name:"imageURL",defaultValue:"tintype_texture_3.jpg"}]},{id:"tinytype_preset4",isPlus:!0,thumb:"tba",effectID:"tinytype",params:[{type:"toggle_group",name:"modeBW",defaultValue:1,buttons:[{langID:"lighter",value:0},{langID:"medium",value:1},{langID:"darker",value:2}]},{type:"color_palette",name:"modeColor",defaultValue:"8A8174",colors:[["8A8174","818A74","8A7874","85748A","6a5f37"],["926C6C","A08D5E","6E7791","6E917E","4d3846"]],presetsOnly:!0},{type:"static",name:"imageURL",defaultValue:"tintype_texture_4.jpg"}]},{id:"tinytype_preset5",isPlus:!0,thumb:"tba",effectID:"tinytype",params:[{type:"toggle_group",name:"modeBW",defaultValue:1,buttons:[{langID:"lighter",value:0},{langID:"medium",value:1},{langID:"darker",value:2}]},{type:"color_palette",name:"modeColor",defaultValue:"8A8174",colors:[["8A8174","818A74","8A7874","85748A","6a5f37"],["926C6C","A08D5E","6E7791","6E917E","4d3846"]],presetsOnly:!0},{type:"static",name:"imageURL",defaultValue:"tintype_texture_5.jpg"}]},{id:"tinytype_preset6",isPlus:!0,thumb:"tba",effectID:"tinytype",params:[{type:"toggle_group",name:"modeBW",defaultValue:1,buttons:[{langID:"lighter",value:0},{langID:"medium",value:1},{langID:"darker",value:2}]},{type:"color_palette",name:"modeColor",defaultValue:"8A8174",colors:[["8A8174","818A74","8A7874","85748A","6a5f37"],["926C6C","A08D5E","6E7791","6E917E","4d3846"]],presetsOnly:!0},{type:"static",name:"imageURL",defaultValue:"tintype_texture_6.jpg"}]},{id:"tinytype_preset7",isPlus:!0,thumb:"tba",effectID:"tinytype",params:[{type:"toggle_group",name:"modeBW",defaultValue:1,buttons:[{langID:"lighter",value:0},{langID:"medium",value:1},{langID:"darker",value:2}]},{type:"color_palette",name:"modeColor",defaultValue:"8A8174",colors:[["8A8174","818A74","8A7874","85748A","6a5f37"],["926C6C","A08D5E","6E7791","6E917E","4d3846"]],presetsOnly:!0},{type:"static",name:"imageURL",defaultValue:"tintype_texture_7.jpg"}]},{id:"tinytype_preset8",isPlus:!0,thumb:"tba",effectID:"tinytype",params:[{type:"toggle_group",name:"modeBW",defaultValue:1,buttons:[{langID:"lighter",value:0},{langID:"medium",value:1},{langID:"darker",value:2}]},{type:"color_palette",name:"modeColor",defaultValue:"8A8174",colors:[["8A8174","818A74","8A7874","85748A","6a5f37"],["926C6C","A08D5E","6E7791","6E917E","4d3846"]],presetsOnly:!0},{type:"static",name:"imageURL",defaultValue:"tintype_texture_8.jpg"}]}]},{id:"unitedcolors",name:"United Colors",graphic:"tba",presets:[{id:"unitedcolors_preset1",isPlus:!1,thumb:"tba",effectID:"unitedcolors",params:[{type:"static",name:"presetID",defaultValue:BFN.CONST.UNITED_COLORS_PRESETS.PRESET_1},{type:"color_item",name:"color_value_1",defaultValue:"fff700",fineChangeEnabled:!0},{type:"color_item",name:"color_value_2",defaultValue:"ff0000",fineChangeEnabled:!0}]},{id:"unitedcolors_preset2",isPlus:!0,thumb:"tba",effectID:"unitedcolors",params:[{type:"static",name:"presetID",defaultValue:BFN.CONST.UNITED_COLORS_PRESETS.PRESET_2},{type:"color_item",name:"color_value_1",defaultValue:"f3ff00",fineChangeEnabled:!0},{type:"color_item",name:"color_value_2",defaultValue:"0084ff",fineChangeEnabled:!0}]},{id:"unitedcolors_preset3",isPlus:!1,thumb:"tba",effectID:"unitedcolors",params:[{type:"static",name:"presetID",defaultValue:BFN.CONST.UNITED_COLORS_PRESETS.PRESET_3},{type:"color_item",name:"color_value_1",defaultValue:"bcff6f",fineChangeEnabled:!0},{type:"color_item",name:"color_value_2",defaultValue:"ad3232",fineChangeEnabled:!0}]},{id:"unitedcolors_preset4",isPlus:!0,thumb:"tba",effectID:"unitedcolors",params:[{type:"static",name:"presetID",defaultValue:BFN.CONST.UNITED_COLORS_PRESETS.PRESET_4},{type:"color_item",name:"color_value_1",defaultValue:"ffa1db",fineChangeEnabled:!0},{type:"color_item",name:"color_value_2",defaultValue:"1b6826",fineChangeEnabled:!0}]}]},{id:"warmer",name:"Warmer",graphic:"tba",presets:[{id:"warming_filter_preset1",isPlus:!1,thumb:"tba",effectID:"warmer",params:[{type:"slider_item",name:"highlights",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"slider_item",name:"shadows",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"static",name:"color",defaultValue:"ec8a00"},{type:"static",name:"amount",defaultValue:40}]},{id:"warming_filter_preset2",isPlus:!0,thumb:"tba",effectID:"warmer",params:[{type:"slider_item",name:"highlights",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"slider_item",name:"shadows",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"static",name:"color",defaultValue:"ebb113"},{type:"static",name:"amount",defaultValue:50}]}]},{id:"viewfinder",name:"Viewfinder",graphic:"tba",presets:[{id:"viewfinder_preset1",isPlus:!1,thumb:"tba",effectID:"viewfinder",params:[{type:"slider_item",name:"highlights",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"slider_item",name:"shadows",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"static",name:"imageURL",defaultValue:"org_viewfinder_effect1_hardlight.jpg"},{type:"static",name:"presetID",defaultValue:BFN.CONST.VIEWFINDER_PRESETS.PRESET_1}]},{id:"viewfinder_preset2",isPlus:Lt,thumb:"tba",effectID:"viewfinder",params:[{type:"slider_item",name:"highlights",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"slider_item",name:"shadows",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"static",name:"imageURL",defaultValue:"org_viewfinder_effect2_overlay.jpg"},{type:"static",name:"presetID",defaultValue:BFN.CONST.VIEWFINDER_PRESETS.PRESET_2}]},{id:"viewfinder_preset3",isPlus:!1,thumb:"tba",effectID:"viewfinder",params:[{type:"slider_item",name:"highlights",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"slider_item",name:"shadows",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"static",name:"imageURL",defaultValue:"org_viewfinder_effect3_overlay.jpg"},{type:"static",name:"presetID",defaultValue:BFN.CONST.VIEWFINDER_PRESETS.PRESET_3}]},{id:"viewfinder_preset4",isPlus:!0,thumb:"tba",effectID:"viewfinder",params:[{type:"slider_item",name:"highlights",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"slider_item",name:"shadows",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"static",name:"imageURL",defaultValue:"org_viewfinder_effect4_overlay.jpg"},{type:"static",name:"presetID",defaultValue:BFN.CONST.VIEWFINDER_PRESETS.PRESET_4}]},{id:"viewfinder_preset5",isPlus:!0,thumb:"tba",effectID:"viewfinder",params:[{type:"slider_item",name:"highlights",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"slider_item",name:"shadows",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"static",name:"imageURL",defaultValue:"org_viewfinder_effect5_lighten_opacity50.jpg"},{type:"static",name:"presetID",defaultValue:BFN.CONST.VIEWFINDER_PRESETS.PRESET_5}]},{id:"viewfinder_preset6",isPlus:!0,thumb:"tba",effectID:"viewfinder",params:[{type:"slider_item",name:"highlights",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"slider_item",name:"shadows",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"static",name:"imageURL",defaultValue:"org_viewfinder_effect6_overlay.jpg"},{type:"static",name:"presetID",defaultValue:BFN.CONST.VIEWFINDER_PRESETS.PRESET_6}]},{id:"viewfinder_preset7",isPlus:!0,thumb:"tba",effectID:"viewfinder",params:[{type:"slider_item",name:"highlights",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"slider_item",name:"shadows",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"static",name:"imageURL",defaultValue:"org_viewfinder_effect7_multiply.jpg"},{type:"static",name:"presetID",defaultValue:BFN.CONST.VIEWFINDER_PRESETS.PRESET_7}]},{id:"viewfinder_preset8",isPlus:!0,thumb:"tba",effectID:"viewfinder",params:[{type:"slider_item",name:"highlights",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"slider_item",name:"shadows",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"static",name:"imageURL",defaultValue:"org_viewfinder_effect8_overlay.jpg"},{type:"static",name:"presetID",defaultValue:BFN.CONST.VIEWFINDER_PRESETS.PRESET_8}]},{id:"viewfinder_preset9",isPlus:!0,thumb:"tba",effectID:"viewfinder",params:[{type:"slider_item",name:"highlights",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"slider_item",name:"shadows",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"static",name:"imageURL",defaultValue:"org_viewfinder_effect9_darken.jpg"},{type:"static",name:"presetID",defaultValue:BFN.CONST.VIEWFINDER_PRESETS.PRESET_9}]},{id:"viewfinder_preset10",isPlus:!0,thumb:"tba",effectID:"viewfinder",params:[{type:"slider_item",name:"highlights",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"slider_item",name:"shadows",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"static",name:"imageURL",defaultValue:"org_viewfinder_effect10_overlay.jpg"},{type:"static",name:"presetID",defaultValue:BFN.CONST.VIEWFINDER_PRESETS.PRESET_10}]},{id:"viewfinder_preset11",isPlus:!0,thumb:"tba",effectID:"viewfinder",params:[{type:"slider_item",name:"highlights",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"slider_item",name:"shadows",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"static",name:"imageURL",defaultValue:"org_viewfinder_effect11_hardlight.jpg"},{type:"static",name:"presetID",defaultValue:BFN.CONST.VIEWFINDER_PRESETS.PRESET_11}]},{id:"viewfinder_preset12",isPlus:!0,thumb:"tba",effectID:"viewfinder",params:[{type:"slider_item",name:"highlights",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"slider_item",name:"shadows",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"static",name:"imageURL",defaultValue:"org_viewfinder_effect12_overlay.jpg"},{type:"static",name:"presetID",defaultValue:BFN.CONST.VIEWFINDER_PRESETS.PRESET_12}]}]},{id:"vintagecolors",name:"Vintage Colors",graphic:"tba",presets:[{id:"vintage_colors_preset6",isPlus:Lt,thumb:"tba",effectID:"vintagecolors",params:[{type:"slider_item",name:"highlights",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"slider_item",name:"shadows",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"static",name:"presetID",defaultValue:BFN.CONST.VINTAGE_COLORS_PRESETS.PRESET_6}]},{id:"vintage_colors_preset1",isPlus:Lt,thumb:"tba",effectID:"vintagecolors",params:[{type:"slider_item",name:"highlights",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"slider_item",name:"shadows",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"static",name:"presetID",defaultValue:BFN.CONST.VINTAGE_COLORS_PRESETS.PRESET_1},{type:"static",name:"color1",defaultValue:"bcff6f"},{type:"static",name:"color2",defaultValue:"ad3232"}]},{id:"vintage_colors_preset2",isPlus:Lt,thumb:"tba",effectID:"vintagecolors",params:[{type:"slider_item",name:"highlights",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"slider_item",name:"shadows",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"static",name:"presetID",defaultValue:BFN.CONST.VINTAGE_COLORS_PRESETS.PRESET_2},{type:"static",name:"color1",defaultValue:"ffff9d"},{type:"static",name:"color2",defaultValue:"c61689"}]},{id:"vintage_colors_preset3",isPlus:!0,thumb:"tba",effectID:"vintagecolors",params:[{type:"slider_item",name:"highlights",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"slider_item",name:"shadows",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"static",name:"presetID",defaultValue:BFN.CONST.VINTAGE_COLORS_PRESETS.PRESET_3},{type:"static",name:"color1",defaultValue:"fff77d"},{type:"static",name:"color2",defaultValue:"419dff"}]},{id:"vintage_colors_preset4",isPlus:!0,thumb:"tba",effectID:"vintagecolors",params:[{type:"slider_item",name:"highlights",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"slider_item",name:"shadows",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"static",name:"presetID",defaultValue:BFN.CONST.VINTAGE_COLORS_PRESETS.PRESET_4},{type:"static",name:"color1",defaultValue:"ffc6e7"},{type:"static",name:"color2",defaultValue:"0f9800"}]},{id:"vintage_colors_preset5",isPlus:!0,useBasicAmount:!1,useGeneric:!1,usePaint:!1,thumb:"tba",effectID:"vintagecolors",params:[{type:"static",name:"presetID",defaultValue:BFN.CONST.VINTAGE_COLORS_PRESETS.PRESET_5},{type:"static",name:"color1",defaultValue:["bcff6f","ffff9d","fff77d","ffc6e7"]},{type:"static",name:"color2",defaultValue:["ad3232","c61689","419dff","0f9800"]}]},{id:"vintage_colors_preset7",isPlus:!0,thumb:"tba",effectID:"vintagecolors",params:[{type:"slider_item",name:"highlights",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"slider_item",name:"shadows",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"static",name:"presetID",defaultValue:BFN.CONST.VINTAGE_COLORS_PRESETS.PRESET_7},{type:"static",name:"imageURL",defaultValue:"lut_vintage_preset7.jpg"}]},{id:"vintage_colors_preset8",isPlus:!0,thumb:"tba",effectID:"vintagecolors",params:[{type:"slider_item",name:"highlights",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"slider_item",name:"shadows",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"static",name:"presetID",defaultValue:BFN.CONST.VINTAGE_COLORS_PRESETS.PRESET_8},{type:"static",name:"imageURL",defaultValue:"lut_vintage_preset8.jpg"}]},{id:"vintage_colors_preset9",isPlus:!0,thumb:"tba",effectID:"vintagecolors",params:[{type:"slider_item",name:"highlights",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"slider_item",name:"shadows",defaultValue:0,min:0,max:100,step:1,unit:"",multiplier:1},{type:"static",name:"presetID",defaultValue:BFN.CONST.VINTAGE_COLORS_PRESETS.PRESET_9},{type:"static",name:"imageURL",defaultValue:"lut_vintage_preset9.jpg"}]}]},{id:"winterfx",name:"Winter",graphic:"tba",presets:[{id:"frosteffect",isPlus:!1,thumb:"tba",effectID:"winterfx",params:[{type:"slider_item",name:"frost_amount",defaultValue:1,min:0,max:1,step:.01,unit:"",multiplier:100},{type:"static",name:"imageURL",defaultValue:"frost_pattern.jpg"},{type:"static",name:"presetID",defaultValue:BFN.CONST.WINTER_PRESETS.PRESET_1}]},{id:"wintereffect",isPlus:!0,thumb:"tba",effectID:"winterfx",params:[{type:"slider_item",name:"opacity",defaultValue:1,min:0,max:1,step:.01,unit:"",multiplier:100},{type:"static",name:"imageURL",defaultValue:"snow_texture.jpg"},{type:"static",name:"presetID",defaultValue:BFN.CONST.WINTER_PRESETS.PRESET_2}]}]},{id:"touchup",name:"Touch Up",graphic:"tba",presets:[{id:"perfectskin",isPlus:!1,thumb:"tba",effectID:"touchup",params:[{type:"slider_item",name:"strength",defaultValue:.5,min:0,max:1,step:.01,unit:"",multiplier:100},{type:"static",name:"isBlur",defaultValue:!0},{type:"static",name:"isBlur2",defaultValue:!0},{type:"static",name:"presetID",defaultValue:BFN.CONST.TOUCH_UP_PRESETS.perfectskin}]},{id:"wrinkles",isPlus:!1,thumb:"tba",effectID:"touchup",params:[{type:"slider_item",name:"strength",defaultValue:.5,min:0,max:1,step:.01,unit:"",multiplier:100},{type:"static",name:"isBlur",defaultValue:!0},{type:"static",name:"presetID",defaultValue:BFN.CONST.TOUCH_UP_PRESETS.wrinkles}]},{id:"bronzer",isPlus:!1,thumb:"tba",effectID:"touchup",params:[{type:"slider_item",name:"strength",defaultValue:.5,min:0,max:1,step:.01,unit:"",multiplier:100},{type:"color_palette",name:"color_palette",defaultValue:"724301",colors:["724301","9A7035","D2AF7E","FCDDB1"]},{type:"static",name:"isBlur",defaultValue:!1},{type:"static",name:"presetID",defaultValue:BFN.CONST.TOUCH_UP_PRESETS.bronzer}]},{id:"blush",isPlus:!1,thumb:"tba",effectID:"touchup",params:[{type:"slider_item",name:"strength",defaultValue:.5,min:0,max:1,step:.01,unit:"",multiplier:100},{type:"color",name:"color_palette",defaultValue:"FFCDD9",colors:["FFCDD9","ECB4Bf","DA798A","A16B72","703D42","D9BA9A","CEA989","A9856B","B28061","825436"]},{type:"static",name:"isBlur",defaultValue:!1},{type:"static",name:"presetID",defaultValue:BFN.CONST.TOUCH_UP_PRESETS.blush}]},{id:"flashspot",isPlus:!1,thumb:"tba",effectID:"touchup",params:[{type:"slider_item",name:"strength",defaultValue:1,min:0,max:1,step:.01,unit:"",multiplier:100},{type:"static",name:"isBlur",defaultValue:!1},{type:"static",name:"presetID",defaultValue:BFN.CONST.TOUCH_UP_PRESETS.flashspot}]},{id:"mascara",isPlus:!1,thumb:"tba",effectID:"touchup",params:[{type:"slider_item",name:"strength",defaultValue:1,min:0,max:1,step:.01,unit:"",multiplier:100},{type:"static",name:"isBlur",defaultValue:!0},{type:"static",name:"presetID",defaultValue:BFN.CONST.TOUCH_UP_PRESETS.mascara}]},{id:"eye_color",isPlus:!1,thumb:"tba",effectID:"touchup",params:[{type:"slider_item",name:"strength",defaultValue:.7,min:0,max:1,step:.01,unit:"",multiplier:100},{type:"color",name:"color_palette",defaultValue:"64C4FF",colors:["64C4FF","81BC36","7A5C3A","BBBEBA"]},{type:"static",name:"isBlur",defaultValue:!1},{type:"static",name:"presetID",defaultValue:BFN.CONST.TOUCH_UP_PRESETS.eye_color}]},{id:"eye_brighten",isPlus:!1,thumb:"tba",effectID:"touchup",params:[{type:"static",name:"isBlur",defaultValue:!0},{type:"static",name:"presetID",defaultValue:BFN.CONST.TOUCH_UP_PRESETS.eye_brighten}]},{id:"eyebrow_pencil",isPlus:!1,thumb:"tba",effectID:"touchup",params:[{type:"slider_item",name:"strength",defaultValue:1,min:0,max:1,step:.01,unit:"",multiplier:100},{type:"color",name:"color_palette",defaultValue:"3D3A33",colors:["3D3A33","74717A","835836","A58646"]},{type:"static",name:"isBlur",defaultValue:!1},{type:"static",name:"curves",defaultValue:"blackenCurve"},{type:"static",name:"presetID",defaultValue:BFN.CONST.TOUCH_UP_PRESETS.eyebrow_pencil}]},{id:"fix_redeye",isPlus:!1,thumb:"tba",effectID:"touchup",params:[{type:"static",name:"isBlur",defaultValue:!1},{type:"static",name:"presetID",defaultValue:BFN.CONST.TOUCH_UP_PRESETS.fix_redeye}]},{id:"lipstick",isPlus:!1,thumb:"tba",effectID:"touchup",params:[{type:"slider_item",name:"strength",defaultValue:.7,min:0,max:1,step:.01,unit:"",multiplier:100},{type:"color",name:"color_palette",defaultValue:"EF4292",colors:["EF4292","D7058C","DA085F","E12438"]},{type:"static",name:"isBlur",defaultValue:!1},{type:"static",name:"presetID",defaultValue:BFN.CONST.TOUCH_UP_PRESETS.lipstick}]},{id:"teeth_whiten",isPlus:!1,thumb:"tba",effectID:"touchup",params:[{type:"static",name:"isBlur",defaultValue:!0},{type:"static",name:"presetID",defaultValue:BFN.CONST.TOUCH_UP_PRESETS.teeth_whiten}]},{id:"hair_color",isPlus:!1,thumb:"tba",effectID:"touchup",params:[{type:"slider_item",name:"strength",defaultValue:.7,min:0,max:1,step:.01,unit:"",multiplier:100},{type:"color",name:"color_palette",defaultValue:"e8D18A",colors:["e8D18A","935118","C58B4E","0C0C17"]},{type:"static",name:"isBlur",defaultValue:!1},{type:"static",name:"presetID",defaultValue:BFN.CONST.TOUCH_UP_PRESETS.haircolor}]}]}].filter(Boolean);BFN.EffectsNoPaint=[];for(let i=0;i<BFN.EffectData.length;i++){let e=BFN.EffectData[i];for(let t=0;t<e.presets.length;t++){let r=e.presets[t],a=r.hasOwnProperty("name")?r.name:`${e.name} ${t+1}`;r.params.push({type:"static",name:"effectName",defaultValue:a});let s=`${e.id}_${r.id}`;BFN.toolViewstates[s]=BFN.PhotoEditorCanvasModelViewStates.VIEWING_EFFECT,r.hasOwnProperty("usePaint")&&!r.usePaint&&BFN.EffectsNoPaint.push(s);for(let o=0;o<r.params.length;o++){let n=r.params[o];(n.type==="color"||n.type==="color_item")&&(n.emptyEnabled||(n.emptyEnabled=!1))}r.params.push({type:"static",name:"fadeable",defaultValue:!0}),r.params.push({type:"static",name:"fixTransparency",defaultValue:!!r.fixTransparency}),r.translation=r.name||`${e.name} ${t+1}`}}BFN.ArtsyData=[{id:"artsy_favorites",name:"Favorites",translationId:"favorites",presets:[]},{id:"digitalart",name:"Digital Art",translationId:"artsy_digital_art",presets:[{id:"ART_0001",name:"Cartoonizer DLX",translationId:"artsy_cartoonizer",isPlus:!0,thumb:"cartoonizer-dlx.jpg",params:[{type:"slider_item",name:"sharpen",defaultValue:50,min:0,max:100,step:1,unit:"",multiplier:1}]},{id:"ART_0002",name:"Underpainting DLX ",translationId:"artsy_underpainting",isPlus:!0,thumb:"underpainting-dlx.jpg",params:[{type:"slider_item",name:"sharpen",defaultValue:50,min:0,max:100,step:1,unit:"",multiplier:1}]},{id:"ART_0004",name:"Oil Painting DLX",translationId:"artsy_oil_painting",isPlus:!0,thumb:"oil-painting-dlx.jpg",params:[{type:"slider_item",name:"sharpen",defaultValue:50,min:0,max:100,step:1,unit:"",multiplier:1}]},{id:"ART_0007",name:"Graphic Novel DLX",translationId:"artsy_graphic_novel",isPlus:!0,thumb:"graphic-novel-dlx.jpg",params:[{type:"slider_item",name:"sharpen",defaultValue:75,min:0,max:100,step:1,unit:"",multiplier:1},{type:"slider_item",name:"color_amount",defaultValue:30,min:0,max:100,step:1,unit:"",multiplier:1}]},{id:"ART_0008",name:"Impressionist DLX",translationId:"artsy_impressionist",isPlus:!0,thumb:"impressionist-dlx.jpg",params:[{type:"slider_item",name:"sharpen",defaultValue:50,min:0,max:100,step:1,unit:"",multiplier:1},{type:"slider_item",name:"color_amount",defaultValue:20,min:0,max:100,step:1,unit:"",multiplier:1},{type:"slider_item",name:"highlight_area",defaultValue:50,min:0,max:100,step:1,unit:"",multiplier:1}]},{id:"ART_0009",name:"Ink Wash DLX",translationId:"artsy_ink_wash",isPlus:!0,thumb:"ink-wash-dlx.jpg",params:[{type:"slider_item",name:"detail_level",defaultValue:50,min:0,max:100,step:1,unit:"",multiplier:1}]},{id:"ART_0006",name:"Watercolor DLX",translationId:"artsy_watercolor",isPlus:!0,thumb:"watercolor-dlx.jpg",params:[{type:"slider_item",name:"sharpen",defaultValue:50,min:0,max:100,step:1,unit:"",multiplier:1}]},{id:"ART_0003",name:"Cross Hatch DLX",translationId:"artsy_cross_hatch",isPlus:!0,thumb:"cross-hatch-dlx.jpg",params:[{type:"slider_item",name:"sharpen",defaultValue:50,min:0,max:100,step:1,unit:"",multiplier:1}]},{id:"ART_0005",name:"Pop Art DLX",translationId:"artsy_pop_art",isPlus:!0,thumb:"pop-art-dlx.jpg",params:[]}]},{id:"cartoonizer",name:"Cartoonizer",translationId:"artsy_cartoonizer",presets:[{id:"ART_0016",isPlus:!0,thumb:"cartoonizer-1.jpg",params:[{type:"slider_item",name:"clutter_cleaner",defaultValue:40,min:0,max:100,step:1,unit:"",multiplier:1},{type:"slider_item",name:"sketch_detail",defaultValue:20,min:0,max:100,step:1,unit:"",multiplier:1},{type:"slider_item",name:"color_detail",defaultValue:60,min:12,max:100,step:1,unit:"",multiplier:1}]},{id:"233",isPlus:!0,thumb:"cartoonizer-2.jpg",params:[{type:"slider_item",name:"sketch_brightness",defaultValue:35,min:0,max:100,step:1,unit:"",multiplier:1},{type:"slider_item",name:"color_smoothness",defaultValue:100,min:10,max:200,step:1,unit:"",multiplier:1},{type:"slider_item",name:"sketch_detail",defaultValue:17,min:5,max:51,step:2,unit:"",multiplier:1},{type:"slider_item",name:"sketch_smoothness",defaultValue:20,min:1,max:30,step:1,unit:"",multiplier:1},{type:"slider_item",name:"clutter_cleaner",defaultValue:3,min:3,max:5,step:.1,unit:"",multiplier:10},{type:"slider_item",name:"color_detail",defaultValue:350,min:4,max:1024,step:1,unit:"",multiplier:1}]},{id:"172",isPlus:!0,thumb:"cartoonizer-3.jpg",params:[{type:"slider_item",name:"sketch_detail",defaultValue:15,min:5,max:91,step:2,unit:"",multiplier:1},{type:"slider_item",name:"sketch_smoothness",defaultValue:20,min:1,max:51,step:1,unit:"",multiplier:1},{type:"slider_item",name:"clutter_cleaner",defaultValue:3,min:1,max:5,step:.1,unit:"",multiplier:10},{type:"slider_item",name:"color_detail",defaultValue:36,min:10,max:80,step:2,unit:"",multiplier:1}]},{id:"13",isPlus:!0,thumb:"cartoonizer-4.jpg",params:[{type:"slider_item",name:"clutter_cleaner",defaultValue:3,min:3,max:5,step:.1,unit:"",multiplier:10},{type:"slider_item",name:"color_detail",defaultValue:30,min:10,max:80,step:1,unit:"",multiplier:1},{type:"slider_item",name:"sketch_detail",defaultValue:13,min:5,max:51,step:1,unit:"",multiplier:1},{type:"slider_item",name:"halftone_size",defaultValue:5,min:3,max:45,step:2,unit:"",multiplier:1}]},{id:"14",isPlus:!0,thumb:"cartoonizer-5.jpg",params:[{type:"slider_item",name:"sketch_detail",defaultValue:31,min:3,max:91,step:1,unit:"",multiplier:1},{type:"slider_item",name:"color_detail",defaultValue:50,min:10,max:80,step:1,unit:"",multiplier:1}]},{id:"48",isPlus:!0,thumb:"cartoonizer-6.jpg",params:[{type:"slider_item",name:"clutter_cleaner",defaultValue:3,min:3,max:5,step:.1,unit:"",multiplier:10},{type:"slider_item",name:"color_detail",defaultValue:45,min:10,max:80,step:1,unit:"",multiplier:1},{type:"slider_item",name:"sketch_detail",defaultValue:13,min:5,max:51,step:1,unit:"",multiplier:1}]}]},{id:"polyart",name:"Poly Art",translationId:"artsy_poly_art",presets:[{id:"AI_ARTSY_STYLE_0",name:"Poly Art DLX 1",isPlus:!0,thumb:"poly-art-1.jpg",params:[]},{id:"AI_ARTSY_STYLE_1",name:"Poly Art DLX 2",isPlus:!0,thumb:"poly-art-2.jpg",params:[]},{id:"AI_ARTSY_STYLE_2",name:"Poly Art DLX 3",isPlus:!0,thumb:"poly-art-3.jpg",params:[]},{id:"AI_ARTSY_STYLE_3",name:"Poly Art DLX 4",isPlus:!0,thumb:"poly-art-4.jpg",params:[]},{id:"AI_ARTSY_STYLE_4",name:"Poly Art DLX 5",isPlus:!0,thumb:"poly-art-5.jpg",params:[]},{id:"AI_ARTSY_STYLE_5",name:"Poly Art DLX 6",isPlus:!0,thumb:"poly-art-6.jpg",params:[]}]},{id:"mosaic",name:"Mosaic",translationId:"artsy_mosaic",presets:[{id:"AI_ARTSY_STYLE_6",name:"Mosaic DLX 1",isPlus:!0,thumb:"mosaic-1.jpg",params:[]},{id:"AI_ARTSY_STYLE_7",name:"Mosaic DLX 2",isPlus:!0,thumb:"mosaic-2.jpg",params:[]}]},{id:"pastel",name:"Pastel",translationId:"artsy_pastel",presets:[{id:"AI_ARTSY_STYLE_12",name:"Pastel DLX 1",isPlus:!0,thumb:"pastel-1.jpg",params:[]},{id:"AI_ARTSY_STYLE_18",name:"Pastel DLX 2",isPlus:!0,thumb:"pastel-2.jpg",params:[]}]},{id:"penart",name:"Pen Art",translationId:"artsy_pen_art",presets:[{id:"AI_ARTSY_STYLE_23",name:"Pen Art DLX 1",isPlus:!0,thumb:"pen-art-1.jpg",params:[]},{id:"AI_ARTSY_STYLE_24",name:"Pen Art DLX 2",isPlus:!0,thumb:"pen-art-2.jpg",params:[]}]},{id:"gouache",name:"Gouache",translationId:"artsy_gouache",presets:[{id:"AI_ARTSY_STYLE_11",name:"Gouache DLX 1",isPlus:!0,thumb:"gouache-dlx-1.jpg",params:[]},{id:"259",name:"Gouache 1",isPlus:!0,thumb:"gouache-1.jpg",maxPixels:78e5,params:[{type:"slider_item",name:"smoothness",defaultValue:30,min:1,max:50,step:1,unit:"",multiplier:1},{type:"slider_item",name:"brush_size",defaultValue:10,min:2,max:100,step:1,unit:"",multiplier:1}]},{id:"251",name:"Gouache 2",isPlus:!0,thumb:"gouache-2.jpg",maxPixels:78e5,params:[{type:"slider_item",name:"smoothness",defaultValue:25,min:1,max:51,step:1,unit:"",multiplier:1},{type:"slider_item",name:"brush_size",defaultValue:15,min:3,max:51,step:1,unit:"",multiplier:1}]},{id:"258",name:"Gouache 3",isPlus:!0,thumb:"gouache-3.jpg",maxPixels:78e5,params:[{type:"slider_item",name:"smoothness",defaultValue:30,min:1,max:30,step:1,unit:"",multiplier:1},{type:"slider_item",name:"brush_size",defaultValue:10,min:2,max:100,step:1,unit:"",multiplier:1}]}]},{id:"impressionist",name:"Impressionist",translationId:"artsy_impressionist",presets:[{id:"AI_ARTSY_STYLE_16",name:"Impressionist DLX 1",isPlus:!0,thumb:"impressionist-dlx-1.jpg",params:[]},{id:"AI_ARTSY_STYLE_17",name:"Impressionist DLX 2",isPlus:!0,thumb:"impressionist-dlx-2.jpg",params:[]},{id:"AI_ARTSY_STYLE_19",name:"Impressionist DLX 3",isPlus:!0,thumb:"impressionist-dlx-3.jpg",params:[]},{id:"59",name:"Impressionist 1",isPlus:!0,thumb:"impressionist-1.jpg",params:[{type:"slider_item",name:"brush_length",defaultValue:4,min:1,max:8,step:1,unit:"",multiplier:1},{type:"slider_item",name:"brush_size",defaultValue:3,min:1,max:15,step:1,unit:"",multiplier:1},{type:"slider_item",name:"highlight_area",defaultValue:120,min:40,max:160,step:1,unit:"",multiplier:1}]},{id:"60",name:"Impressionist 2",isPlus:!0,thumb:"impressionist-2.jpg",params:[{type:"slider_item",name:"brush_length",defaultValue:4,min:1,max:8,step:1,unit:"",multiplier:1},{type:"slider_item",name:"brush_size",defaultValue:3,min:1,max:15,step:1,unit:"",multiplier:1},{type:"slider_item",name:"highlight_area",defaultValue:150,min:40,max:200,step:1,unit:"",multiplier:1}]},{id:"61",name:"Impressionist 3",isPlus:!0,thumb:"impressionist-3.jpg",params:[{type:"slider_item",name:"brush_length",defaultValue:4,min:1,max:8,step:1,unit:"",multiplier:1},{type:"slider_item",name:"brush_size",defaultValue:3,min:1,max:15,step:1,unit:"",multiplier:1},{type:"slider_item",name:"highlight_area",defaultValue:120,min:40,max:160,step:1,unit:"",multiplier:1}]},{id:"62",name:"Impressionist 4",isPlus:!0,thumb:"impressionist-4.jpg",params:[{type:"slider_item",name:"brush_length",defaultValue:4,min:1,max:8,step:1,unit:"",multiplier:1},{type:"slider_item",name:"brush_size",defaultValue:3,min:1,max:15,step:1,unit:"",multiplier:1},{type:"slider_item",name:"highlight_area",defaultValue:120,min:40,max:160,step:1,unit:"",multiplier:1}]},{id:"63",name:"Impressionist 5",isPlus:!0,thumb:"impressionist-5.jpg",params:[{type:"slider_item",name:"brush_length",defaultValue:4,min:1,max:8,step:1,unit:"",multiplier:1},{type:"slider_item",name:"highlight_area",defaultValue:120,min:20,max:160,step:1,unit:"",multiplier:1},{type:"slider_item",name:"brush_size",defaultValue:3,min:1,max:15,step:1,unit:"",multiplier:1}]}]},{id:"inkify",name:"Inkify",translationId:"artsy_inkify",presets:[{id:"AI_ARTSY_STYLE_25",name:"Inkify DLX 1",isPlus:!0,thumb:"inkify-dlx-1.jpg",params:[]},{id:"ART_0011",name:"Inkify 1",isPlus:!0,thumb:"inkify-1.jpg",params:[{type:"slider_item",name:"detail_level",defaultValue:43,min:1,max:100,step:1,unit:"",multiplier:1},{type:"slider_item",name:"smoothness",defaultValue:50,min:1,max:100,step:1,unit:"",multiplier:1},{type:"slider_item",name:"sharpen",defaultValue:0,min:1,max:100,step:1,unit:"",multiplier:1}]},{id:"ART_0014",name:"Inkify 2",isPlus:!0,thumb:"inkify-2.jpg",params:[{type:"slider_item",name:"smoothness",defaultValue:50,min:1,max:100,step:1,unit:"",multiplier:1},{type:"slider_item",name:"detail_level",defaultValue:0,min:-50,max:50,step:1,unit:"",multiplier:1},{type:"color_item",name:"sketch_color",defaultValue:"C800FF"}]},{id:"ART_0015",name:"Inkify 3",isPlus:!0,thumb:"inkify-3.jpg",params:[{type:"slider_item",name:"smoothness",defaultValue:50,min:1,max:100,step:1,unit:"",multiplier:1},{type:"slider_item",name:"detail_level",defaultValue:0,min:-50,max:50,step:1,unit:"",multiplier:1},{type:"color_item",name:"sketch_color",defaultValue:"75A458"}]},{id:"ART_0012",name:"Inkify 4",isPlus:!0,thumb:"inkify-4.jpg",params:[{type:"slider_item",name:"detail_level",defaultValue:32,min:1,max:75,step:1,unit:"",multiplier:1},{type:"slider_item",name:"smoothness",defaultValue:50,min:1,max:100,step:1,unit:"",multiplier:1},{type:"slider_item",name:"sharpen",defaultValue:0,min:1,max:100,step:1,unit:"",multiplier:1}]}]},{id:"oilpainting",name:"Oil Painting",translationId:"artsy_oil_painting",presets:[{id:"AI_ARTSY_STYLE_8",name:"Oil Painting DLX 1",isPlus:!0,thumb:"oil-painting-dlx-1.jpg",params:[]},{id:"AI_ARTSY_STYLE_10",name:"Oil Painting DLX 2",isPlus:!0,thumb:"oil-painting-dlx-2.jpg",params:[]},{id:"AI_ARTSY_STYLE_15",name:"Oil Painting DLX 3",isPlus:!0,thumb:"oil-painting-dlx-3.jpg",params:[]},{id:"AI_ARTSY_STYLE_20",name:"Oil Painting DLX 4",isPlus:!0,thumb:"oil-painting-dlx-4.jpg",params:[]},{id:"84",name:"Oil Painting 1",isPlus:!0,thumb:"oil-painting-1.jpg",maxPixels:78e5,params:[{type:"slider_item",name:"paint_amount",defaultValue:0,min:-100,max:100,step:1,unit:"",multiplier:1},{type:"slider_item",name:"brush_size",defaultValue:8,min:3,max:20,step:1,unit:"",multiplier:1},{type:"slider_item",name:"brush_length",defaultValue:8,min:3,max:19,step:1,unit:"",multiplier:1}]},{id:"86",name:"Oil Painting 2",isPlus:!0,thumb:"oil-painting-2.jpg",params:[{type:"slider_item",name:"brush_size",defaultValue:5,min:3,max:31,step:1,unit:"",multiplier:1},{type:"slider_item",name:"brush_length",defaultValue:12,min:3,max:41,step:1,unit:"",multiplier:1},{type:"slider_item",name:"paint_amount",defaultValue:0,min:-100,max:100,step:1,unit:"",multiplier:1}]},{id:"85",name:"Oil Painting 3",isPlus:!0,thumb:"oil-painting-3.jpg",maxPixels:78e5,params:[{type:"slider_item",name:"brush_size",defaultValue:8,min:3,max:51,step:1,unit:"",multiplier:1},{type:"slider_item",name:"brush_length",defaultValue:8,min:3,max:19,step:1,unit:"",multiplier:1},{type:"slider_item",name:"paint_amount",defaultValue:0,min:-100,max:100,step:1,unit:"",multiplier:1}]},{id:"88",name:"Oil Painting 4",isPlus:!0,thumb:"oil-painting-4.jpg",params:[{type:"slider_item",name:"color_detail",defaultValue:30,min:10,max:80,step:1,unit:"",multiplier:1},{type:"slider_item",name:"brush_size",defaultValue:21,min:3,max:51,step:2,unit:"",multiplier:1}]},{id:"89",name:"Oil Painting 5",isPlus:!0,thumb:"oil-painting-5.jpg",params:[{type:"slider_item",name:"brush_size",defaultValue:21,min:3,max:51,step:2,unit:"",multiplier:1},{type:"slider_item",name:"color_detail",defaultValue:25,min:17,max:80,step:1,unit:"",multiplier:1},{type:"slider_item",name:"paint_amount",defaultValue:0,min:-100,max:100,step:1,unit:"",multiplier:1}]},{id:"90",name:"Oil Painting 6",isPlus:!0,thumb:"oil-painting-6.jpg",params:[{type:"slider_item",name:"brush_length",defaultValue:18,min:11,max:65,step:1,unit:"",multiplier:1},{type:"slider_item",name:"brush_size",defaultValue:10,min:2,max:45,step:1,unit:"",multiplier:1},{type:"slider_item",name:"paint_amount",defaultValue:0,min:-100,max:100,step:1,unit:"",multiplier:1}]}]},{id:"pointillism",name:"Pointillism",translationId:"artsy_pointillism",presets:[{id:"AI_ARTSY_STYLE_13",name:"Pointillism DLX 1",isPlus:!0,thumb:"pointillism-dlx-1.jpg",params:[]},{id:"273",name:"Pointillism 1",isPlus:!0,thumb:"pointillism-1.jpg",params:[{type:"slider_item",name:"underpainting_brush_detail",defaultValue:21,min:1,max:21,step:1,unit:"",multiplier:1},{type:"slider_item",name:"underpainting_brush_size",defaultValue:3,min:1,max:70,step:1,unit:"",multiplier:1},{type:"slider_item",name:"overpainting_brush_detail",defaultValue:25,min:5,max:51,step:2,unit:"",multiplier:1},{type:"slider_item",name:"overpainting_brush_size",defaultValue:2,min:2,max:100,step:1,unit:"",multiplier:1}]},{id:"274",name:"Pointillism 2",isPlus:!0,thumb:"pointillism-2.jpg",params:[{type:"slider_item",name:"brush_size",defaultValue:8,min:3,max:100,step:1,unit:"",multiplier:1}]},{id:"275",name:"Pointillism 3",isPlus:!0,thumb:"pointillism-3.jpg",params:[{type:"slider_item",name:"brush_size",defaultValue:8,min:2,max:100,step:1,unit:"",multiplier:1}]},{id:"276",name:"Pointillism 4",isPlus:!0,thumb:"pointillism-4.jpg",params:[{type:"slider_item",name:"brush_detail",defaultValue:15,min:5,max:51,step:2,unit:"",multiplier:1},{type:"slider_item",name:"brush_size",defaultValue:8,min:3,max:100,step:1,unit:"",multiplier:1}]}]},{id:"sketcher",name:"Sketcher",translationId:"artsy_sketcher",presets:[{id:"ART_0013",isPlus:!0,thumb:"sketcher-1.jpg",params:[{type:"slider_item",name:"clutter_cleaner",defaultValue:40,min:0,max:100,step:1,unit:"",multiplier:1},{type:"slider_item",name:"sketch_detail",defaultValue:20,min:0,max:100,step:1,unit:"",multiplier:1},{type:"color_item",name:"background_color",defaultValue:"FFFFFF"},{type:"color_item",name:"sketch_color",defaultValue:"000000"}]},{id:"269",isPlus:!0,thumb:"sketcher-2.jpg",params:[{type:"slider_item",name:"clutter_cleaner",defaultValue:2,min:1,max:5,step:.1,unit:"",multiplier:10},{type:"slider_item",name:"sketch_detail",defaultValue:11,min:5,max:51,step:2,unit:"",multiplier:1},{type:"color_item",name:"background_color",defaultValue:"FFFFFF"},{type:"color_item",name:"sketch_color",defaultValue:"000000"}]},{id:"239",isPlus:!0,thumb:"sketcher-3.jpg",params:[{type:"slider_item",name:"halftone_size",defaultValue:5,min:3,max:31,step:2,unit:"",multiplier:1},{type:"slider_item",name:"clutter_cleaner",defaultValue:2,min:2,max:5,step:.1,unit:"",multiplier:10},{type:"slider_item",name:"sketch_detail",defaultValue:11,min:5,max:51,step:2,unit:"",multiplier:1}]},{id:"243",isPlus:!0,thumb:"sketcher-4.jpg",params:[{type:"slider_item",name:"dot_size",defaultValue:5,min:3,max:31,step:2,unit:"",multiplier:1},{type:"slider_item",name:"clutter_cleaner",defaultValue:2,min:2,max:5,step:.1,unit:"",multiplier:10},{type:"slider_item",name:"sketch_detail",defaultValue:11,min:5,max:51,step:2,unit:"",multiplier:1},{type:"slider_item",name:"color_detail",defaultValue:30,min:10,max:80,step:1,unit:"",multiplier:1},{type:"color_item",name:"highlight_color",defaultValue:"CAF8FF"},{type:"color_item",name:"shadow_color",defaultValue:"00A6FF"}]},{id:"250",isPlus:!0,thumb:"sketcher-5.jpg",params:[{type:"slider_item",name:"clutter_cleaner",defaultValue:2,min:2,max:5,step:.1,unit:"",multiplier:10},{type:"slider_item",name:"sketch_detail",defaultValue:13,min:5,max:51,step:2,unit:"",multiplier:1},{type:"slider_item",name:"halftone_size",defaultValue:5,min:3,max:31,step:2,unit:"",multiplier:1},{type:"color_item",name:"background_color",defaultValue:"FFFF00"},{type:"color_item",name:"sketch_color",defaultValue:"DD2020"}]},{id:"264",isPlus:!0,thumb:"sketcher-6.jpg",params:[{type:"slider_item",name:"clutter_cleaner",defaultValue:2,min:1,max:5,step:.1,unit:"",multiplier:10},{type:"slider_item",name:"sketch_detail",defaultValue:11,min:5,max:51,step:2,unit:"",multiplier:1},{type:"slider_item",name:"dot_size",defaultValue:7,min:3,max:31,step:2,unit:"",multiplier:1},{type:"color_item",name:"sketch_color",defaultValue:"FF3DEF"},{type:"color_item",name:"background_color",defaultValue:"FFFFFF"}]}]},{id:"underpainting",name:"Underpainting",translationId:"artsy_underpainting",presets:[{id:"ART_0010",isPlus:!0,thumb:"underpainting-1.jpg",params:[{type:"slider_item",name:"smoothness",defaultValue:50,min:1,max:100,step:1,unit:"",multiplier:1},{type:"slider_item",name:"sharpen",defaultValue:50,min:1,max:100,step:1,unit:"",multiplier:1}]},{id:"ART_0017",isPlus:!0,thumb:"underpainting-2.jpg",params:[{type:"slider_item",name:"paint_amount",defaultValue:48,min:8,max:100,step:1,unit:"",multiplier:1},{type:"slider_item",name:"sharpen",defaultValue:25,min:1,max:100,step:1,unit:"",multiplier:1}]}]},{id:"watercolor",name:"Watercolor",translationId:"artsy_watercolor",presets:[{id:"AI_ARTSY_STYLE_9",name:"Watercolor DLX 1",isPlus:!0,thumb:"watercolor-dlx-1.jpg",params:[]},{id:"AI_ARTSY_STYLE_14",name:"Watercolor DLX 2",isPlus:!0,thumb:"watercolor-dlx-2.jpg",params:[]},{id:"AI_ARTSY_STYLE_21",name:"Watercolor DLX 3",isPlus:!0,thumb:"watercolor-dlx-3.jpg",params:[]},{id:"AI_ARTSY_STYLE_22",name:"Watercolor DLX 4",isPlus:!0,thumb:"watercolor-dlx-4.jpg",params:[]},{id:"ART_0018",name:"Watercolor 1",isPlus:!0,thumb:"watercolor-1.jpg",params:[{type:"slider_item",name:"paint_amount",defaultValue:30,min:8,max:100,step:1,unit:"",multiplier:1},{type:"slider_item",name:"sharpen",defaultValue:25,min:1,max:100,step:1,unit:"",multiplier:1},{type:"slider_item",name:"smoothness",defaultValue:50,min:1,max:100,step:1,unit:"",multiplier:1}]},{id:"ART_0019",name:"Watercolor 2",isPlus:!0,thumb:"watercolor-2.jpg",params:[{type:"slider_item",name:"brush_size",defaultValue:50,min:10,max:100,step:1,unit:"",multiplier:1},{type:"slider_item",name:"smoothness",defaultValue:50,min:1,max:100,step:1,unit:"",multiplier:1}]},{id:"245",name:"Watercolor 3",isPlus:!0,thumb:"watercolor-3.jpg",params:[]},{id:"238",name:"Watercolor 4",isPlus:!0,thumb:"watercolor-4.jpg",params:[{type:"slider_item",name:"overpainting_brush_size",defaultValue:9,min:5,max:51,step:2,unit:"",multiplier:1},{type:"slider_item",name:"underpainting_brush_size",defaultValue:17,min:2,max:100,step:1,unit:"",multiplier:1}]}]}].filter(Boolean);BFN.ArtsyToolIDs={};BFN.ArtsyToolParams={};BFN.ArtsyToolColorParams={};BFN.ArtsyPresetObjects={};BFN.artsyPresetMap={};BFN.artsyIDMap={};for(let i=0;i<BFN.ArtsyData.length;i++){let e=BFN.ArtsyData[i];for(let t=0;t<e.presets.length;t++){let r=e.presets[t];r.isArtsy=!0,r.hasOwnProperty("name")||(r.name=`${e.name} ${t+1}`);let a=r.name.match(/(?: )(\d+)$/),s=a?a[1]:"",o=r.translationId||e.translationId,n="";r.name.includes("DLX")?n=s?`DLX ${s}`:"DLX":n=s||t+1,r.translation=[o,{suffix:n}];let l=`${e.id}_${r.id}`;BFN.toolViewstates[l]=BFN.PhotoEditorCanvasModelViewStates.VIEWING_ARTSY,BFN.ArtsyToolIDs[l]=r.id,BFN.ArtsyToolParams[l]=[],BFN.ArtsyToolColorParams[l]=[],BFN.ArtsyPresetObjects[l]=r,BFN.artsyPresetMap[l]=e.id,BFN.artsyIDMap[r.id]=e.id;for(let c=0;c<r.params.length;c++){let h=r.params[c];BFN.ArtsyToolParams[l].push(h.name),(h.type==="color"||h.type==="color_item")&&(h.emptyEnabled=!1,BFN.ArtsyToolColorParams[l].push(h.name))}r.params.push({type:"static",name:"id",defaultValue:r.id})}}var Eo=!(BeFunky.isTWA||BeFunky.isAppleAppStoreApp);BFN.FrameData={crop_rotate:[{id:"frame_featured",name:"Featured",translationId:"featured",frame:"tba",presets:[]},{id:"frame_instant",name:"Instant",translationId:"frame_instant",frame:"tba",presets:[{id:"instant_1",isPlus:!1,params:[{type:"static",name:"texture",defaultValue:"frames_instant_1"},{type:"static",name:"texture_data",defaultValue:{frameW:1652,frameH:2e3,windowX:106,windowY:109,windowW:1443,windowH:1488}}]},{id:"instant_2",isPlus:!0,params:[{type:"static",name:"texture",defaultValue:"frames_instant_2"},{type:"static",name:"texture_data",defaultValue:{frameW:900,frameH:900,windowX:52,windowY:42,windowW:793,windowH:663}}]},{id:"instant_3",isPlus:!0,params:[{type:"static",name:"texture",defaultValue:"frames_instant_3"},{type:"static",name:"texture_data",defaultValue:{frameW:2e3,frameH:2e3,windowX:110,windowY:106,windowW:1761,windowH:1754}}]},{id:"instant_4",isPlus:!0,params:[{type:"static",name:"texture",defaultValue:"frames_instant_4"},{type:"static",name:"texture_data",defaultValue:{frameW:2e3,frameH:1419,windowX:85,windowY:85,windowW:1830,windowH:1130}}]},{id:"instant_5",isPlus:!0,params:[{type:"static",name:"texture",defaultValue:"frames_instant_5"},{type:"static",name:"texture_data",defaultValue:{frameW:2e3,frameH:1547,windowX:92,windowY:94,windowW:1815,windowH:1360}}]},{id:"instant_6",isPlus:!0,params:[{type:"static",name:"texture",defaultValue:"frames_instant_6"},{type:"static",name:"texture_data",defaultValue:{frameW:1647,frameH:2e3,windowX:109,windowY:108,windowW:1431,windowH:1431}}]},{id:"instant_7",isPlus:!0,params:[{type:"static",name:"texture",defaultValue:"frames_instant_7"},{type:"static",name:"texture_data",defaultValue:{frameW:1652,frameH:2e3,windowX:104,windowY:107,windowW:1447,windowH:1492}}]},{id:"instant_8",isPlus:!0,params:[{type:"static",name:"texture",defaultValue:"frames_instant_8"},{type:"static",name:"texture_data",defaultValue:{frameW:1547,frameH:2e3,windowX:94,windowY:93,windowW:1358,windowH:1813}}]},{id:"instant_9",isPlus:!0,params:[{type:"static",name:"texture",defaultValue:"frames_instant_9"},{type:"static",name:"texture_data",defaultValue:{frameW:1652,frameH:2e3,windowX:106,windowY:109,windowW:1443,windowH:1488}}]}]}],crop:[{id:"frame_realistic",name:"Realistic",translationId:"frame_realistic",frame:"tba",presets:[{id:"realistic_1",isPlus:!1,params:[{type:"static",name:"texture",defaultValue:"frames_realistic_1"},{type:"static",name:"texture_data",defaultValue:{frameW:2e3,frameH:1e3,windowX:145,windowY:135,windowW:1710,windowH:730}}]},{id:"realistic_2",isPlus:!0,params:[{type:"static",name:"texture",defaultValue:"frames_realistic_2"},{type:"static",name:"texture_data",defaultValue:{frameW:1e3,frameH:1e3,windowX:125,windowY:135,windowW:750,windowH:730}}]},{id:"realistic_3",isPlus:!0,params:[{type:"static",name:"texture",defaultValue:"frames_realistic_3"},{type:"static",name:"texture_data",defaultValue:{frameW:2e3,frameH:2e3,windowX:60,windowY:65,windowW:1880,windowH:1870}}]},{id:"realistic_4",isPlus:!0,params:[{type:"static",name:"texture",defaultValue:"frames_realistic_4"},{type:"static",name:"texture_data",defaultValue:{frameW:2e3,frameH:2e3,windowX:430,windowY:415,windowW:1140,windowH:1170}}]},{id:"realistic_5",isPlus:!0,params:[{type:"static",name:"texture",defaultValue:"frames_realistic_5"},{type:"static",name:"texture_data",defaultValue:{frameW:2e3,frameH:2e3,windowX:430,windowY:415,windowW:1140,windowH:1170}}]},{id:"realistic_6",isPlus:!0,params:[{type:"static",name:"texture",defaultValue:"frames_realistic_6"},{type:"static",name:"texture_data",defaultValue:{frameW:2e3,frameH:1615,windowX:405,windowY:380,windowW:1180,windowH:845}}]},{id:"realistic_7",isPlus:!0,params:[{type:"static",name:"texture",defaultValue:"frames_realistic_7"},{type:"static",name:"texture_data",defaultValue:{frameW:2e3,frameH:1615,windowX:400,windowY:375,windowW:1200,windowH:845}}]},{id:"realistic_8",isPlus:!0,params:[{type:"static",name:"texture",defaultValue:"frames_realistic_8"},{type:"static",name:"texture_data",defaultValue:{frameW:2e3,frameH:2e3,windowX:430,windowY:415,windowW:1140,windowH:1170}}]},{id:"realistic_9",isPlus:!0,params:[{type:"static",name:"texture",defaultValue:"frames_realistic_9"},{type:"static",name:"texture_data",defaultValue:{frameW:2e3,frameH:1615,windowX:330,windowY:330,windowW:1340,windowH:955}}]}]}],full:[{id:"frame_decorative",name:"Decorative",translationId:"frame_decorative",frame:"tba",presets:[{id:"decorative_1",isPlus:!1,params:[{type:"static",name:"texture",defaultValue:"frames_decorative_1"},{type:"static",name:"texture_data",defaultValue:{frameW:1800,frameH:1200}}]},{id:"decorative_2",isPlus:!0,params:[{type:"static",name:"texture",defaultValue:"frames_decorative_2"},{type:"static",name:"texture_data",defaultValue:{frameW:1800,frameH:1200}}]},{id:"decorative_3",isPlus:!0,params:[{type:"static",name:"texture",defaultValue:"frames_decorative_3"},{type:"static",name:"texture_data",defaultValue:{frameW:1800,frameH:1200}}]},{id:"decorative_4",isPlus:!0,params:[{type:"static",name:"texture",defaultValue:"frames_decorative_4"},{type:"static",name:"texture_data",defaultValue:{frameW:1800,frameH:1200}}]},{id:"decorative_5",isPlus:!0,params:[{type:"static",name:"texture",defaultValue:"frames_decorative_5"},{type:"static",name:"texture_data",defaultValue:{frameW:1800,frameH:1200}}]},{id:"decorative_6",isPlus:!0,params:[{type:"static",name:"texture",defaultValue:"frames_decorative_6"},{type:"static",name:"texture_data",defaultValue:{frameW:1800,frameH:1200}}]},{id:"decorative_7",isPlus:!0,params:[{type:"static",name:"texture",defaultValue:"frames_decorative_7"},{type:"static",name:"texture_data",defaultValue:{frameW:1800,frameH:1200}}]},{id:"decorative_8",isPlus:!0,params:[{type:"static",name:"texture",defaultValue:"frames_decorative_8"},{type:"static",name:"texture_data",defaultValue:{frameW:1800,frameH:1200}}]},{id:"decorative_9",isPlus:!0,params:[{type:"static",name:"texture",defaultValue:"frames_decorative_9"},{type:"static",name:"texture_data",defaultValue:{frameW:1800,frameH:1200}}]},{id:"decorative_10",isPlus:!0,params:[{type:"static",name:"texture",defaultValue:"frames_decorative_10"},{type:"static",name:"texture_data",defaultValue:{frameW:1800,frameH:1200}}]},{id:"decorative_11",isPlus:!0,params:[{type:"static",name:"texture",defaultValue:"frames_decorative_11"},{type:"static",name:"texture_data",defaultValue:{frameW:1800,frameH:1200}}]},{id:"decorative_12",isPlus:!0,params:[{type:"static",name:"texture",defaultValue:"frames_decorative_12"},{type:"static",name:"texture_data",defaultValue:{frameW:1800,frameH:1200}}]}]},{id:"frame_vintage",name:"Vintage",translationId:"frame_vintage",frame:"tba",presets:[{id:"vintage_1",isPlus:!1,params:[{type:"static",name:"texture",defaultValue:"frames_vintage_1"},{type:"static",name:"texture_data",defaultValue:{frameW:1800,frameH:1200}}]},{id:"vintage_2",isPlus:!0,params:[{type:"static",name:"texture",defaultValue:"frames_vintage_2"},{type:"static",name:"texture_data",defaultValue:{frameW:1800,frameH:1200}}]},{id:"vintage_3",isPlus:!0,params:[{type:"static",name:"texture",defaultValue:"frames_vintage_3"},{type:"static",name:"texture_data",defaultValue:{frameW:1800,frameH:1200}}]},{id:"vintage_4",isPlus:!0,params:[{type:"static",name:"texture",defaultValue:"frames_vintage_4"},{type:"static",name:"texture_data",defaultValue:{frameW:1800,frameH:1200}}]},{id:"vintage_5",isPlus:!0,params:[{type:"static",name:"texture",defaultValue:"frames_vintage_5"},{type:"static",name:"texture_data",defaultValue:{frameW:1800,frameH:1200}}]},{id:"vintage_6",isPlus:!0,params:[{type:"static",name:"texture",defaultValue:"frames_vintage_6"},{type:"static",name:"texture_data",defaultValue:{frameW:1800,frameH:1200}}]},{id:"vintage_7",isPlus:!0,params:[{type:"static",name:"texture",defaultValue:"frames_vintage_7"},{type:"static",name:"texture_data",defaultValue:{frameW:1800,frameH:1200}}]},{id:"vintage_8",isPlus:!0,params:[{type:"static",name:"texture",defaultValue:"frames_vintage_8"},{type:"static",name:"texture_data",defaultValue:{frameW:1800,frameH:1200}}]},{id:"vintage_9",isPlus:!0,params:[{type:"static",name:"texture",defaultValue:"frames_vintage_9"},{type:"static",name:"texture_data",defaultValue:{frameW:1800,frameH:1200}}]},{id:"vintage_10",isPlus:!0,params:[{type:"static",name:"texture",defaultValue:"frames_vintage_10"},{type:"static",name:"texture_data",defaultValue:{frameW:1800,frameH:1200}}]},{id:"vintage_11",isPlus:!0,params:[{type:"static",name:"texture",defaultValue:"frames_vintage_11"},{type:"static",name:"texture_data",defaultValue:{frameW:1800,frameH:1200}}]}]},{id:"frame_floral",name:"Floral",translationId:"frame_floral",frame:"tba",presets:[{id:"floral_1",isPlus:!1,params:[{type:"static",name:"texture",defaultValue:"frames_floral_1"},{type:"static",name:"texture_data",defaultValue:{frameW:1800,frameH:1200}}]},{id:"floral_2",isPlus:!0,params:[{type:"static",name:"texture",defaultValue:"frames_floral_2"},{type:"static",name:"texture_data",defaultValue:{frameW:1800,frameH:1200}}]},{id:"floral_3",isPlus:!0,params:[{type:"static",name:"texture",defaultValue:"frames_floral_3"},{type:"static",name:"texture_data",defaultValue:{frameW:1800,frameH:1200}}]},{id:"floral_4",isPlus:!0,params:[{type:"static",name:"texture",defaultValue:"frames_floral_4"},{type:"static",name:"texture_data",defaultValue:{frameW:1800,frameH:1200}}]},{id:"floral_5",isPlus:!0,params:[{type:"static",name:"texture",defaultValue:"frames_floral_5"},{type:"static",name:"texture_data",defaultValue:{frameW:1800,frameH:1200}}]},{id:"floral_6",isPlus:!0,params:[{type:"static",name:"texture",defaultValue:"frames_floral_6"},{type:"static",name:"texture_data",defaultValue:{frameW:1800,frameH:1200}}]},{id:"floral_7",isPlus:!0,params:[{type:"static",name:"texture",defaultValue:"frames_floral_7"},{type:"static",name:"texture_data",defaultValue:{frameW:1800,frameH:1200}}]},{id:"floral_8",isPlus:!0,params:[{type:"static",name:"texture",defaultValue:"frames_floral_8"},{type:"static",name:"texture_data",defaultValue:{frameW:1800,frameH:1200}}]},{id:"floral_9",isPlus:!0,params:[{type:"static",name:"texture",defaultValue:"frames_floral_9"},{type:"static",name:"texture_data",defaultValue:{frameW:1800,frameH:1200}}]},{id:"floral_10",isPlus:!0,params:[{type:"static",name:"texture",defaultValue:"frames_floral_10"},{type:"static",name:"texture_data",defaultValue:{frameW:1800,frameH:1200}}]},{id:"floral_11",isPlus:!0,params:[{type:"static",name:"texture",defaultValue:"frames_floral_11"},{type:"static",name:"texture_data",defaultValue:{frameW:1800,frameH:1200}}]},{id:"floral_12",isPlus:!0,params:[{type:"static",name:"texture",defaultValue:"frames_floral_12"},{type:"static",name:"texture_data",defaultValue:{frameW:1800,frameH:1200}}]},{id:"floral_13",isPlus:!0,params:[{type:"static",name:"texture",defaultValue:"frames_floral_13"},{type:"static",name:"texture_data",defaultValue:{frameW:1800,frameH:1200}}]},{id:"floral_14",isPlus:!0,params:[{type:"static",name:"texture",defaultValue:"frames_floral_14"},{type:"static",name:"texture_data",defaultValue:{frameW:1800,frameH:1200}}]},{id:"floral_15",isPlus:!0,params:[{type:"static",name:"texture",defaultValue:"frames_floral_15"},{type:"static",name:"texture_data",defaultValue:{frameW:1800,frameH:1200}}]},{id:"floral_16",isPlus:!0,params:[{type:"static",name:"texture",defaultValue:"frames_floral_16"},{type:"static",name:"texture_data",defaultValue:{frameW:1800,frameH:1200}}]},{id:"floral_17",isPlus:!0,params:[{type:"static",name:"texture",defaultValue:"frames_floral_17"},{type:"static",name:"texture_data",defaultValue:{frameW:1800,frameH:1200}}]},{id:"floral_18",isPlus:!0,params:[{type:"static",name:"texture",defaultValue:"frames_floral_18"},{type:"static",name:"texture_data",defaultValue:{frameW:1800,frameH:1200}}]},{id:"floral_19",isPlus:!0,params:[{type:"static",name:"texture",defaultValue:"frames_floral_19"},{type:"static",name:"texture_data",defaultValue:{frameW:1800,frameH:1200}}]},{id:"floral_20",isPlus:!0,params:[{type:"static",name:"texture",defaultValue:"frames_floral_20"},{type:"static",name:"texture_data",defaultValue:{frameW:1800,frameH:1200}}]},{id:"floral_21",isPlus:!0,params:[{type:"static",name:"texture",defaultValue:"frames_floral_21"},{type:"static",name:"texture_data",defaultValue:{frameW:1800,frameH:1200}}]},{id:"floral_22",isPlus:!0,params:[{type:"static",name:"texture",defaultValue:"frames_floral_22"},{type:"static",name:"texture_data",defaultValue:{frameW:1800,frameH:1200}}]},{id:"floral_23",isPlus:!0,params:[{type:"static",name:"texture",defaultValue:"frames_floral_23"},{type:"static",name:"texture_data",defaultValue:{frameW:1800,frameH:1200}}]},{id:"floral_24",isPlus:!0,params:[{type:"static",name:"texture",defaultValue:"frames_floral_24"},{type:"static",name:"texture_data",defaultValue:{frameW:1800,frameH:1200}}]},{id:"floral_25",isPlus:!0,params:[{type:"static",name:"texture",defaultValue:"frames_floral_25"},{type:"static",name:"texture_data",defaultValue:{frameW:1800,frameH:1200}}]}]},{id:"frame_rustic",name:"Rustic",translationId:"frame_rustic",frame:"tba",presets:[{id:"rustic_1",isPlus:!1,params:[{type:"static",name:"texture",defaultValue:"frames_rustic_1"},{type:"static",name:"texture_data",defaultValue:{frameW:1800,frameH:1200}}]},{id:"rustic_2",isPlus:!0,params:[{type:"static",name:"texture",defaultValue:"frames_rustic_2"},{type:"static",name:"texture_data",defaultValue:{frameW:1800,frameH:1200}}]},{id:"rustic_3",isPlus:!0,params:[{type:"static",name:"texture",defaultValue:"frames_rustic_3"},{type:"static",name:"texture_data",defaultValue:{frameW:1800,frameH:1200}}]},{id:"rustic_4",isPlus:!0,params:[{type:"static",name:"texture",defaultValue:"frames_rustic_4"},{type:"static",name:"texture_data",defaultValue:{frameW:1800,frameH:1200}}]},{id:"rustic_5",isPlus:!0,params:[{type:"static",name:"texture",defaultValue:"frames_rustic_5"},{type:"static",name:"texture_data",defaultValue:{frameW:1800,frameH:1200}}]},{id:"rustic_6",isPlus:!0,params:[{type:"static",name:"texture",defaultValue:"frames_rustic_6"},{type:"static",name:"texture_data",defaultValue:{frameW:1800,frameH:1200}}]},{id:"rustic_7",isPlus:!0,params:[{type:"static",name:"texture",defaultValue:"frames_rustic_7"},{type:"static",name:"texture_data",defaultValue:{frameW:1800,frameH:1200}}]},{id:"rustic_8",isPlus:!0,params:[{type:"static",name:"texture",defaultValue:"frames_rustic_8"},{type:"static",name:"texture_data",defaultValue:{frameW:1800,frameH:1200}}]},{id:"rustic_9",isPlus:!0,params:[{type:"static",name:"texture",defaultValue:"frames_rustic_9"},{type:"static",name:"texture_data",defaultValue:{frameW:1800,frameH:1200}}]},{id:"rustic_10",isPlus:!0,params:[{type:"static",name:"texture",defaultValue:"frames_rustic_10"},{type:"static",name:"texture_data",defaultValue:{frameW:1800,frameH:1200}}]},{id:"rustic_11",isPlus:!0,params:[{type:"static",name:"texture",defaultValue:"frames_rustic_11"},{type:"static",name:"texture_data",defaultValue:{frameW:1800,frameH:1200}}]}]},{id:"frame_lace",name:"Lace",translationId:"frame_lace",frame:"tba",presets:[{id:"lace_1",isPlus:!1,params:[{type:"static",name:"texture",defaultValue:"frames_lace_1"},{type:"static",name:"texture_data",defaultValue:{frameW:1800,frameH:1200}}]},{id:"lace_2",isPlus:!0,params:[{type:"static",name:"texture",defaultValue:"frames_lace_2"},{type:"static",name:"texture_data",defaultValue:{frameW:1800,frameH:1200}}]},{id:"lace_3",isPlus:!0,params:[{type:"static",name:"texture",defaultValue:"frames_lace_3"},{type:"static",name:"texture_data",defaultValue:{frameW:1800,frameH:1200}}]},{id:"lace_4",isPlus:!0,params:[{type:"static",name:"texture",defaultValue:"frames_lace_4"},{type:"static",name:"texture_data",defaultValue:{frameW:1800,frameH:1200}}]},{id:"lace_5",isPlus:!0,params:[{type:"static",name:"texture",defaultValue:"frames_lace_5"},{type:"static",name:"texture_data",defaultValue:{frameW:1800,frameH:1200}}]},{id:"lace_6",isPlus:!0,params:[{type:"static",name:"texture",defaultValue:"frames_lace_6"},{type:"static",name:"texture_data",defaultValue:{frameW:1800,frameH:1200}}]},{id:"lace_7",isPlus:!0,params:[{type:"static",name:"texture",defaultValue:"frames_lace_7"},{type:"static",name:"texture_data",defaultValue:{frameW:1800,frameH:1200}}]},{id:"lace_8",isPlus:!0,params:[{type:"static",name:"texture",defaultValue:"frames_lace_8"},{type:"static",name:"texture_data",defaultValue:{frameW:1800,frameH:1200}}]},{id:"lace_9",isPlus:!0,params:[{type:"static",name:"texture",defaultValue:"frames_lace_9"},{type:"static",name:"texture_data",defaultValue:{frameW:1800,frameH:1200}}]},{id:"lace_10",isPlus:!0,params:[{type:"static",name:"texture",defaultValue:"frames_lace_10"},{type:"static",name:"texture_data",defaultValue:{frameW:1800,frameH:1200}}]},{id:"lace_11",isPlus:!0,params:[{type:"static",name:"texture",defaultValue:"frames_lace_11"},{type:"static",name:"texture_data",defaultValue:{frameW:1800,frameH:1200}}]},{id:"lace_12",isPlus:!0,params:[{type:"static",name:"texture",defaultValue:"frames_lace_12"},{type:"static",name:"texture_data",defaultValue:{frameW:1800,frameH:1200}}]},{id:"lace_13",isPlus:!0,params:[{type:"static",name:"texture",defaultValue:"frames_lace_13"},{type:"static",name:"texture_data",defaultValue:{frameW:1800,frameH:1200}}]},{id:"lace_14",isPlus:!0,params:[{type:"static",name:"texture",defaultValue:"frames_lace_14"},{type:"static",name:"texture_data",defaultValue:{frameW:1800,frameH:1200}}]},{id:"lace_15",isPlus:!0,params:[{type:"static",name:"texture",defaultValue:"frames_lace_15"},{type:"static",name:"texture_data",defaultValue:{frameW:1800,frameH:1200}}]},{id:"lace_16",isPlus:!0,params:[{type:"static",name:"texture",defaultValue:"frames_lace_16"},{type:"static",name:"texture_data",defaultValue:{frameW:1800,frameH:1200}}]}]},{id:"frame_ornament",name:"Ornament",translationId:"frame_ornament",frame:"tba",presets:[{id:"ornament_1",isPlus:!1,params:[{type:"static",name:"texture",defaultValue:"frames_ornament_1"},{type:"static",name:"texture_data",defaultValue:{frameW:1800,frameH:1200}}]},{id:"ornament_2",isPlus:!0,params:[{type:"static",name:"texture",defaultValue:"frames_ornament_2"},{type:"static",name:"texture_data",defaultValue:{frameW:1800,frameH:1200}}]},{id:"ornament_3",isPlus:!0,params:[{type:"static",name:"texture",defaultValue:"frames_ornament_3"},{type:"static",name:"texture_data",defaultValue:{frameW:1800,frameH:1200}}]},{id:"ornament_4",isPlus:!0,params:[{type:"static",name:"texture",defaultValue:"frames_ornament_4"},{type:"static",name:"texture_data",defaultValue:{frameW:1800,frameH:1200}}]},{id:"ornament_5",isPlus:!0,params:[{type:"static",name:"texture",defaultValue:"frames_ornament_5"},{type:"static",name:"texture_data",defaultValue:{frameW:1800,frameH:1200}}]},{id:"ornament_6",isPlus:!0,params:[{type:"static",name:"texture",defaultValue:"frames_ornament_6"},{type:"static",name:"texture_data",defaultValue:{frameW:1800,frameH:1200}}]},{id:"ornament_7",isPlus:!0,params:[{type:"static",name:"texture",defaultValue:"frames_ornament_7"},{type:"static",name:"texture_data",defaultValue:{frameW:1800,frameH:1200}}]},{id:"ornament_8",isPlus:!0,params:[{type:"static",name:"texture",defaultValue:"frames_ornament_8"},{type:"static",name:"texture_data",defaultValue:{frameW:1800,frameH:1200}}]},{id:"ornament_9",isPlus:!0,params:[{type:"static",name:"texture",defaultValue:"frames_ornament_9"},{type:"static",name:"texture_data",defaultValue:{frameW:1800,frameH:1200}}]},{id:"ornament_10",isPlus:!0,params:[{type:"static",name:"texture",defaultValue:"frames_ornament_10"},{type:"static",name:"texture_data",defaultValue:{frameW:1800,frameH:1200}}]},{id:"ornament_11",isPlus:!0,params:[{type:"static",name:"texture",defaultValue:"frames_ornament_11"},{type:"static",name:"texture_data",defaultValue:{frameW:1800,frameH:1200}}]},{id:"ornament_12",isPlus:!0,params:[{type:"static",name:"texture",defaultValue:"frames_ornament_12"},{type:"static",name:"texture_data",defaultValue:{frameW:1800,frameH:1200}}]},{id:"ornament_13",isPlus:!0,params:[{type:"static",name:"texture",defaultValue:"frames_ornament_13"},{type:"static",name:"texture_data",defaultValue:{frameW:1800,frameH:1200}}]},{id:"ornament_14",isPlus:!0,params:[{type:"static",name:"texture",defaultValue:"frames_ornament_14"},{type:"static",name:"texture_data",defaultValue:{frameW:1800,frameH:1200}}]},{id:"ornament_15",isPlus:!0,params:[{type:"static",name:"texture",defaultValue:"frames_ornament_15"},{type:"static",name:"texture_data",defaultValue:{frameW:1800,frameH:1200}}]}]},{id:"frame_hand_drawn",name:"Hand Drawn",translationId:"frame_hand_drawn",frame:"tba",presets:[{id:"hand_drawn_1",isPlus:!1,params:[{type:"static",name:"texture",defaultValue:"frames_hand_drawn_1"},{type:"static",name:"texture_data",defaultValue:{frameW:1800,frameH:1200}}]},{id:"hand_drawn_2",isPlus:!0,params:[{type:"static",name:"texture",defaultValue:"frames_hand_drawn_2"},{type:"static",name:"texture_data",defaultValue:{frameW:1800,frameH:1200}}]},{id:"hand_drawn_3",isPlus:!0,params:[{type:"static",name:"texture",defaultValue:"frames_hand_drawn_3"},{type:"static",name:"texture_data",defaultValue:{frameW:1800,frameH:1200}}]},{id:"hand_drawn_4",isPlus:!0,params:[{type:"static",name:"texture",defaultValue:"frames_hand_drawn_4"},{type:"static",name:"texture_data",defaultValue:{frameW:1800,frameH:1200}}]},{id:"hand_drawn_5",isPlus:!0,params:[{type:"static",name:"texture",defaultValue:"frames_hand_drawn_5"},{type:"static",name:"texture_data",defaultValue:{frameW:1800,frameH:1200}}]},{id:"hand_drawn_6",isPlus:!0,params:[{type:"static",name:"texture",defaultValue:"frames_hand_drawn_6"},{type:"static",name:"texture_data",defaultValue:{frameW:1800,frameH:1200}}]},{id:"hand_drawn_7",isPlus:!0,params:[{type:"static",name:"texture",defaultValue:"frames_hand_drawn_7"},{type:"static",name:"texture_data",defaultValue:{frameW:1800,frameH:1200}}]},{id:"hand_drawn_8",isPlus:!0,params:[{type:"static",name:"texture",defaultValue:"frames_hand_drawn_8"},{type:"static",name:"texture_data",defaultValue:{frameW:1800,frameH:1200}}]},{id:"hand_drawn_9",isPlus:!0,params:[{type:"static",name:"texture",defaultValue:"frames_hand_drawn_9"},{type:"static",name:"texture_data",defaultValue:{frameW:1800,frameH:1200}}]}]},{id:"frame_grunge",name:"Grunge",translationId:"frame_grunge",frame:"tba",presets:[{id:"grunge_1",isPlus:!1,params:[{type:"static",name:"texture",defaultValue:"frames_grunge_1"},{type:"static",name:"texture_data",defaultValue:{frameW:1600,frameH:1200}}]},{id:"grunge_2",isPlus:Eo,params:[{type:"static",name:"texture",defaultValue:"frames_grunge_2"},{type:"static",name:"texture_data",defaultValue:{frameW:1600,frameH:1200}}]},{id:"grunge_3",isPlus:Eo,params:[{type:"static",name:"texture",defaultValue:"frames_grunge_3"},{type:"static",name:"texture_data",defaultValue:{frameW:2e3,frameH:2e3}}]},{id:"grunge_4",isPlus:!0,params:[{type:"static",name:"texture",defaultValue:"frames_grunge_4"},{type:"static",name:"texture_data",defaultValue:{frameW:1600,frameH:1200}}]},{id:"grunge_5",isPlus:!0,params:[{type:"static",name:"texture",defaultValue:"frames_grunge_5"},{type:"static",name:"texture_data",defaultValue:{frameW:1600,frameH:1200}}]},{id:"grunge_6",isPlus:!0,params:[{type:"static",name:"texture",defaultValue:"frames_grunge_6"},{type:"static",name:"texture_data",defaultValue:{frameW:1600,frameH:1200}}]},{id:"grunge_7",isPlus:!0,params:[{type:"static",name:"texture",defaultValue:"frames_grunge_7"},{type:"static",name:"texture_data",defaultValue:{frameW:1600,frameH:1200}}]},{id:"grunge_8",isPlus:!0,params:[{type:"static",name:"texture",defaultValue:"frames_grunge_8"},{type:"static",name:"texture_data",defaultValue:{frameW:2e3,frameH:2e3}}]},{id:"grunge_9",isPlus:!0,params:[{type:"static",name:"texture",defaultValue:"frames_grunge_9"},{type:"static",name:"texture_data",defaultValue:{frameW:1500,frameH:2e3}}]}]},{id:"frame_filmstrip",name:"Film Strip",translationId:"frame_film_strip",frame:"tba",presets:[{id:"filmstrip_1",isPlus:!1,params:[{type:"static",name:"texture",defaultValue:"frames_filmstrip_1"},{type:"static",name:"texture_data",defaultValue:{frameW:2e3,frameH:1614}},{type:"static",name:"blendMode",defaultValue:BFN.CONST.BLEND_MODES.MULTIPLY}]},{id:"filmstrip_2",isPlus:!0,params:[{type:"static",name:"texture",defaultValue:"frames_filmstrip_2"},{type:"static",name:"texture_data",defaultValue:{frameW:2e3,frameH:1536}},{type:"static",name:"blendMode",defaultValue:BFN.CONST.BLEND_MODES.MULTIPLY}]},{id:"filmstrip_3",isPlus:!0,params:[{type:"static",name:"texture",defaultValue:"frames_filmstrip_3"},{type:"static",name:"texture_data",defaultValue:{frameW:2e3,frameH:1614}},{type:"static",name:"blendMode",defaultValue:BFN.CONST.BLEND_MODES.MULTIPLY}]},{id:"filmstrip_4",isPlus:!0,params:[{type:"static",name:"texture",defaultValue:"frames_filmstrip_4"},{type:"static",name:"texture_data",defaultValue:{frameW:2e3,frameH:1536}},{type:"static",name:"blendMode",defaultValue:BFN.CONST.BLEND_MODES.MULTIPLY}]},{id:"filmstrip_5",isPlus:Eo,params:[{type:"static",name:"texture",defaultValue:"frames_filmstrip_5"},{type:"static",name:"texture_data",defaultValue:{frameW:2e3,frameH:1380}},{type:"static",name:"blendMode",defaultValue:BFN.CONST.BLEND_MODES.MULTIPLY}]},{id:"filmstrip_6",isPlus:!0,params:[{type:"static",name:"texture",defaultValue:"frames_filmstrip_6"},{type:"static",name:"texture_data",defaultValue:{frameW:2e3,frameH:1358}},{type:"static",name:"blendMode",defaultValue:BFN.CONST.BLEND_MODES.DARKEN}]},{id:"filmstrip_7",isPlus:!0,params:[{type:"static",name:"texture",defaultValue:"frames_filmstrip_7"},{type:"static",name:"texture_data",defaultValue:{frameW:1024,frameH:1024}},{type:"static",name:"blendMode",defaultValue:BFN.CONST.BLEND_MODES.MULTIPLY}]},{id:"filmstrip_8",isPlus:!0,params:[{type:"static",name:"texture",defaultValue:"frames_filmstrip_8"},{type:"static",name:"texture_data",defaultValue:{frameW:1024,frameH:727}},{type:"static",name:"blendMode",defaultValue:BFN.CONST.BLEND_MODES.OVERLAY}]},{id:"filmstrip_9",isPlus:!0,params:[{type:"static",name:"texture",defaultValue:"frames_filmstrip_9"},{type:"static",name:"texture_data",defaultValue:{frameW:1024,frameH:813}},{type:"static",name:"blendMode",defaultValue:BFN.CONST.BLEND_MODES.OVERLAY}]}]}],smart:[{id:"frame_art_deco",name:"Art Deco",translationId:"frame_art_deco",frame:"tba",presets:[{id:"art_deco_01",isPlus:!0,params:[{type:"static",name:"texture",defaultValue:"frames_art_deco_01"},{type:"static",name:"texture_data",defaultValue:{srcW:1e3,srcH:1e3,srcGrid:"f220-d560-f220_f220-d560-f220"}}]},{id:"art_deco_02",isPlus:!0,params:[{type:"static",name:"texture",defaultValue:"frames_art_deco_02"},{type:"static",name:"texture_data",defaultValue:{srcW:1e3,srcH:1e3,srcGrid:"f140-d720-f140_f140-d720-f140"}}]},{id:"art_deco_03",isPlus:!0,params:[{type:"static",name:"texture",defaultValue:"frames_art_deco_03"},{type:"static",name:"texture_data",defaultValue:{srcW:1e3,srcH:1e3,srcGrid:"f130-d740-f130_f130-d740-f130"}}]},{id:"art_deco_04",isPlus:!0,params:[{type:"static",name:"texture",defaultValue:"frames_art_deco_04"},{type:"static",name:"texture_data",defaultValue:{srcW:1e3,srcH:1e3,srcGrid:"f190-d620-f190_f190-d620-f190"}}]},{id:"art_deco_05",isPlus:!0,params:[{type:"static",name:"texture",defaultValue:"frames_art_deco_05"},{type:"static",name:"texture_data",defaultValue:{srcW:1e3,srcH:1e3,srcGrid:"f70-d860-f70_f70-d860-f70"}}]},{id:"art_deco_06",isPlus:!0,params:[{type:"static",name:"texture",defaultValue:"frames_art_deco_06"},{type:"static",name:"texture_data",defaultValue:{srcW:1e3,srcH:1e3,srcGrid:"f160-d680-f160_f160-d680-f160"}}]},{id:"art_deco_07",isPlus:!0,params:[{type:"static",name:"texture",defaultValue:"frames_art_deco_07"},{type:"static",name:"texture_data",defaultValue:{srcW:1e3,srcH:1e3,srcGrid:"f400-d200-f400_f400-d200-f400"}}]},{id:"art_deco_08",isPlus:!0,params:[{type:"static",name:"texture",defaultValue:"frames_art_deco_08"},{type:"static",name:"texture_data",defaultValue:{srcW:1e3,srcH:1e3,srcGrid:"f200-d600-f200_f200-d600-f200"}}]},{id:"art_deco_09",isPlus:!0,params:[{type:"static",name:"texture",defaultValue:"frames_art_deco_09"},{type:"static",name:"texture_data",defaultValue:{srcW:1e3,srcH:1e3,srcGrid:"f200-d600-f200_f200-d600-f200"}}]},{id:"art_deco_10",isPlus:!0,params:[{type:"static",name:"texture",defaultValue:"frames_art_deco_10"},{type:"static",name:"texture_data",defaultValue:{srcW:1e3,srcH:1e3,srcGrid:"f200-d600-f200_f200-d600-f200"}}]}]}]};BFN.frameCategoryIDMap={};BFN.framePresetMap={};BFN.frameIDMap={};for(let i in BFN.FrameData){let e=BFN.FrameData[i];for(let t=0;t<e.length;t++){let r=e[t];for(let a=0;a<r.presets.length;a++){let s=r.presets[a];s.usePaint=!1,s.params.push({type:"static",name:"texture_category",defaultValue:r.id.replace("frame_","")}),s.params.push({type:"static",name:"frame_type",defaultValue:i}),s.params.push({type:"static",name:"frameName",defaultValue:`${r.name} ${a+1}`}),BFN.toolViewstates[`${r.id}_${s.id}`]=BFN.PhotoEditorCanvasModelViewStates.VIEWING_FRAME,BFN.frameCategoryIDMap[`${r.id}_${s.id}`]=s.id,BFN.frameIDMap[s.id]=r.id,BFN.framePresetMap[s.id]=s,s.translation=[r.translationId,{suffix:`${a+1}`}],s.params.push({type:"static",name:"frameTranslation",defaultValue:s.translation})}}}BFN.TextureData=[{id:"texture_featured",name:"Featured",translationId:"featured",graphic:"tba",presets:[]},{id:"bokeh",name:"Bokeh",translationId:"texture_bokeh",graphic:"graphic_textures_bokeh",presets:[{id:"bokeh_1",isPlus:!1,params:[{type:"static",name:"texture",defaultValue:"1_bokeh_overlay_100.jpg"},{type:"static",name:"blendMode",defaultValue:BFN.CONST.BLEND_MODES.SCREEN},{type:"static",name:"alpha",defaultValue:.75}]},{id:"bokeh_2",isPlus:!0,params:[{type:"static",name:"texture",defaultValue:"2_bokeh_overlay_100.jpg"},{type:"static",name:"blendMode",defaultValue:BFN.CONST.BLEND_MODES.SCREEN},{type:"static",name:"alpha",defaultValue:.8}]},{id:"bokeh_3",isPlus:!0,params:[{type:"static",name:"texture",defaultValue:"3_bokeh_overlay_100.jpg"},{type:"static",name:"blendMode",defaultValue:BFN.CONST.BLEND_MODES.SCREEN},{type:"static",name:"alpha",defaultValue:.88}]},{id:"bokeh_4",isPlus:!0,params:[{type:"static",name:"texture",defaultValue:"4_bokeh_overlay_100.jpg"},{type:"static",name:"blendMode",defaultValue:BFN.CONST.BLEND_MODES.SCREEN},{type:"static",name:"alpha",defaultValue:1}]},{id:"bokeh_5",isPlus:!0,params:[{type:"static",name:"texture",defaultValue:"5_bokeh_overlay_75.jpg"},{type:"static",name:"blendMode",defaultValue:BFN.CONST.BLEND_MODES.MULTIPLY},{type:"static",name:"alpha",defaultValue:.75}]},{id:"bokeh_6",isPlus:!0,params:[{type:"static",name:"texture",defaultValue:"6_bokeh_overlay_50.jpg"},{type:"static",name:"blendMode",defaultValue:BFN.CONST.BLEND_MODES.SCREEN},{type:"static",name:"alpha",defaultValue:.9}]}]},{id:"scratches",translationId:"texture_scratches",name:"Scratches",graphic:"graphic_textures_scratches",presets:[{id:"scratches_1",isPlus:!1,params:[{type:"static",name:"texture",defaultValue:"1_scratch_overlay_100.jpg"},{type:"static",name:"blendMode",defaultValue:BFN.CONST.BLEND_MODES.OVERLAY},{type:"static",name:"alpha",defaultValue:1}]},{id:"scratches_2",isPlus:!0,params:[{type:"static",name:"texture",defaultValue:"2_scratch_overlay_100.jpg"},{type:"static",name:"blendMode",defaultValue:BFN.CONST.BLEND_MODES.OVERLAY},{type:"static",name:"alpha",defaultValue:1}]},{id:"scratches_3",isPlus:!0,params:[{type:"static",name:"texture",defaultValue:"3_scratch_overlay_100.jpg"},{type:"static",name:"blendMode",defaultValue:BFN.CONST.BLEND_MODES.OVERLAY},{type:"static",name:"alpha",defaultValue:1}]},{id:"scratches_4",isPlus:!0,params:[{type:"static",name:"texture",defaultValue:"4_scratch_overlay_100.jpg"},{type:"static",name:"blendMode",defaultValue:BFN.CONST.BLEND_MODES.OVERLAY},{type:"static",name:"alpha",defaultValue:1}]},{id:"scratches_5",isPlus:!0,params:[{type:"static",name:"texture",defaultValue:"5_scratch_overlay_100.jpg"},{type:"static",name:"blendMode",defaultValue:BFN.CONST.BLEND_MODES.OVERLAY},{type:"static",name:"alpha",defaultValue:1}]},{id:"scratches_6",isPlus:!0,params:[{type:"static",name:"texture",defaultValue:"6_scratch_overlay_100.jpg"},{type:"static",name:"blendMode",defaultValue:BFN.CONST.BLEND_MODES.OVERLAY},{type:"static",name:"alpha",defaultValue:1}]},{id:"scratches_7",isPlus:!0,params:[{type:"static",name:"texture",defaultValue:"7_scratch_overlay_100.jpg"},{type:"static",name:"blendMode",defaultValue:BFN.CONST.BLEND_MODES.OVERLAY},{type:"static",name:"alpha",defaultValue:1}]},{id:"scratches_8",isPlus:!0,params:[{type:"static",name:"texture",defaultValue:"8_scratch_overlay_100.jpg"},{type:"static",name:"blendMode",defaultValue:BFN.CONST.BLEND_MODES.OVERLAY},{type:"static",name:"alpha",defaultValue:1}]},{id:"scratches_9",isPlus:!0,params:[{type:"static",name:"texture",defaultValue:"9_scratch_overlay_100.jpg"},{type:"static",name:"blendMode",defaultValue:BFN.CONST.BLEND_MODES.OVERLAY},{type:"static",name:"alpha",defaultValue:1}]}]},{id:"light",translationId:"texture_light_trails",name:"Light Trails",graphic:"graphic_textures_light_trails",presets:[{id:"light_trail_1",isPlus:!1,params:[{type:"static",name:"texture",defaultValue:"1_light_lighten_80.jpg"},{type:"static",name:"blendMode",defaultValue:BFN.CONST.BLEND_MODES.SCREEN},{type:"static",name:"alpha",defaultValue:.7}]},{id:"light_trail_2",isPlus:!0,params:[{type:"static",name:"texture",defaultValue:"2_light_lighten_100.jpg"},{type:"static",name:"blendMode",defaultValue:BFN.CONST.BLEND_MODES.SCREEN},{type:"static",name:"alpha",defaultValue:.75}]},{id:"light_trail_3",isPlus:!0,params:[{type:"static",name:"texture",defaultValue:"3_light_screen_100.jpg"},{type:"static",name:"blendMode",defaultValue:BFN.CONST.BLEND_MODES.SCREEN},{type:"static",name:"alpha",defaultValue:1}]},{id:"light_trail_4",isPlus:!0,params:[{type:"static",name:"texture",defaultValue:"4_light_screen_100.jpg"},{type:"static",name:"blendMode",defaultValue:BFN.CONST.BLEND_MODES.SCREEN},{type:"static",name:"alpha",defaultValue:1}]},{id:"light_trail_5",isPlus:!0,params:[{type:"static",name:"texture",defaultValue:"5_light_screen_100.jpg"},{type:"static",name:"blendMode",defaultValue:BFN.CONST.BLEND_MODES.SCREEN},{type:"static",name:"alpha",defaultValue:1}]},{id:"light_trail_6",isPlus:!0,params:[{type:"static",name:"texture",defaultValue:"6_light_overlay_100.jpg"},{type:"static",name:"blendMode",defaultValue:BFN.CONST.BLEND_MODES.OVERLAY},{type:"static",name:"alpha",defaultValue:1}]},{id:"light_trail_7",isPlus:!0,params:[{type:"static",name:"texture",defaultValue:"7_light_screen_100.jpg"},{type:"static",name:"blendMode",defaultValue:BFN.CONST.BLEND_MODES.SCREEN},{type:"static",name:"alpha",defaultValue:1}]},{id:"light_trail_8",isPlus:!0,params:[{type:"static",name:"texture",defaultValue:"8_light_screen_100.jpg"},{type:"static",name:"blendMode",defaultValue:BFN.CONST.BLEND_MODES.SCREEN},{type:"static",name:"alpha",defaultValue:1}]},{id:"light_trail_9",isPlus:!0,params:[{type:"static",name:"texture",defaultValue:"9_light_screen_100.jpg"},{type:"static",name:"blendMode",defaultValue:BFN.CONST.BLEND_MODES.SCREEN},{type:"static",name:"alpha",defaultValue:1}]}]},{id:"lightleak",translationId:"texture_light_leaks",name:"Light Leaks",graphic:"graphic_textures_light_leaks",presets:[{id:"light_leak_1",isPlus:!1,params:[{type:"static",name:"texture",defaultValue:"1_leak_screen_65.jpg"},{type:"static",name:"blendMode",defaultValue:BFN.CONST.BLEND_MODES.SCREEN},{type:"static",name:"alpha",defaultValue:.65}]},{id:"light_leak_2",isPlus:!0,params:[{type:"static",name:"texture",defaultValue:"2_leak_screen_70.jpg"},{type:"static",name:"blendMode",defaultValue:BFN.CONST.BLEND_MODES.SCREEN},{type:"static",name:"alpha",defaultValue:.7}]},{id:"light_leak_3",isPlus:!0,params:[{type:"static",name:"texture",defaultValue:"3_leak_screen_80.jpg"},{type:"static",name:"blendMode",defaultValue:BFN.CONST.BLEND_MODES.SCREEN},{type:"static",name:"alpha",defaultValue:.8}]},{id:"light_leak_4",isPlus:!0,params:[{type:"static",name:"texture",defaultValue:"4_leak_screen_75.jpg"},{type:"static",name:"blendMode",defaultValue:BFN.CONST.BLEND_MODES.SCREEN},{type:"static",name:"alpha",defaultValue:.75}]},{id:"light_leak_5",isPlus:!0,params:[{type:"static",name:"texture",defaultValue:"5_leak_screen_80.jpg"},{type:"static",name:"blendMode",defaultValue:BFN.CONST.BLEND_MODES.SCREEN},{type:"static",name:"alpha",defaultValue:.8}]},{id:"light_leak_6",isPlus:!0,params:[{type:"static",name:"texture",defaultValue:"6_leak_screen_100.jpg"},{type:"static",name:"blendMode",defaultValue:BFN.CONST.BLEND_MODES.SCREEN},{type:"static",name:"alpha",defaultValue:1}]},{id:"light_leak_7",isPlus:!0,params:[{type:"static",name:"texture",defaultValue:"7_leak_screen_100.jpg"},{type:"static",name:"blendMode",defaultValue:BFN.CONST.BLEND_MODES.SCREEN},{type:"static",name:"alpha",defaultValue:1}]},{id:"light_leak_8",isPlus:!0,params:[{type:"static",name:"texture",defaultValue:"8_leak_screen_100.jpg"},{type:"static",name:"blendMode",defaultValue:BFN.CONST.BLEND_MODES.SCREEN},{type:"static",name:"alpha",defaultValue:1}]},{id:"light_leak_9",isPlus:!0,params:[{type:"static",name:"texture",defaultValue:"9_leak_screen_100.jpg"},{type:"static",name:"blendMode",defaultValue:BFN.CONST.BLEND_MODES.SCREEN},{type:"static",name:"alpha",defaultValue:1}]}]},{id:"fabric",translationId:"texture_fabric",name:"Fabric",graphic:"graphic_textures_fabric",presets:[{id:"fabric_1",isPlus:!1,params:[{type:"static",name:"texture",defaultValue:"1_fabric_multiply_100.jpg"},{type:"static",name:"blendMode",defaultValue:BFN.CONST.BLEND_MODES.MULTIPLY},{type:"static",name:"alpha",defaultValue:1}]},{id:"fabric_2",isPlus:!0,params:[{type:"static",name:"texture",defaultValue:"2_fabric_multiply_100.jpg"},{type:"static",name:"blendMode",defaultValue:BFN.CONST.BLEND_MODES.MULTIPLY},{type:"static",name:"alpha",defaultValue:1}]},{id:"fabric_3",isPlus:!0,params:[{type:"static",name:"texture",defaultValue:"3_fabric_overlay_100.jpg"},{type:"static",name:"blendMode",defaultValue:BFN.CONST.BLEND_MODES.OVERLAY},{type:"static",name:"alpha",defaultValue:1}]}]},{id:"grunge",translationId:"texture_grunge",name:"Grunge",graphic:"graphic_textures_grunge",presets:[{id:"grunge_1",isPlus:!1,params:[{type:"static",name:"texture",defaultValue:"1_grunge_overlay_60.jpg"},{type:"static",name:"blendMode",defaultValue:BFN.CONST.BLEND_MODES.OVERLAY},{type:"static",name:"alpha",defaultValue:.6}]},{id:"grunge_2",isPlus:!0,params:[{type:"static",name:"texture",defaultValue:"2_grunge_overlay_100.jpg"},{type:"static",name:"blendMode",defaultValue:BFN.CONST.BLEND_MODES.HARD_LIGHT},{type:"static",name:"alpha",defaultValue:.8}]},{id:"grunge_3",isPlus:!0,params:[{type:"static",name:"texture",defaultValue:"3_grunge_overlay_70.jpg"},{type:"static",name:"blendMode",defaultValue:BFN.CONST.BLEND_MODES.OVERLAY},{type:"static",name:"alpha",defaultValue:.7}]},{id:"grunge_4",isPlus:!0,params:[{type:"static",name:"texture",defaultValue:"4_grunge_multiply_30.jpg"},{type:"static",name:"blendMode",defaultValue:BFN.CONST.BLEND_MODES.MULTIPLY},{type:"static",name:"alpha",defaultValue:.3}]},{id:"grunge_5",isPlus:!0,params:[{type:"static",name:"texture",defaultValue:"5_grunge_overlay_60.jpg"},{type:"static",name:"blendMode",defaultValue:BFN.CONST.BLEND_MODES.OVERLAY},{type:"static",name:"alpha",defaultValue:.6}]},{id:"grunge_6",isPlus:!0,params:[{type:"static",name:"texture",defaultValue:"6_grunge_overlay_60.jpg"},{type:"static",name:"blendMode",defaultValue:BFN.CONST.BLEND_MODES.OVERLAY},{type:"static",name:"alpha",defaultValue:.6}]},{id:"grunge_7",isPlus:!0,params:[{type:"static",name:"texture",defaultValue:"7_grunge_hardlight_40.jpg"},{type:"static",name:"blendMode",defaultValue:BFN.CONST.BLEND_MODES.HARD_LIGHT},{type:"static",name:"alpha",defaultValue:.4}]},{id:"grunge_8",isPlus:!0,params:[{type:"static",name:"texture",defaultValue:"8_grunge_overlay_80.jpg"},{type:"static",name:"blendMode",defaultValue:BFN.CONST.BLEND_MODES.OVERLAY},{type:"static",name:"alpha",defaultValue:.8}]}]},{id:"paint",translationId:"texture_paint",name:"Paint",graphic:"graphic_textures_paint",presets:[{id:"paint_1",isPlus:!1,params:[{type:"static",name:"texture",defaultValue:"1_paint_overlay_100.jpg"},{type:"static",name:"blendMode",defaultValue:BFN.CONST.BLEND_MODES.OVERLAY},{type:"static",name:"alpha",defaultValue:1}]},{id:"paint_2",isPlus:!0,params:[{type:"static",name:"texture",defaultValue:"2_paint_overlay_100.jpg"},{type:"static",name:"blendMode",defaultValue:BFN.CONST.BLEND_MODES.OVERLAY},{type:"static",name:"alpha",defaultValue:1}]},{id:"paint_3",isPlus:!0,params:[{type:"static",name:"texture",defaultValue:"3_paint_overlay_100.jpg"},{type:"static",name:"blendMode",defaultValue:BFN.CONST.BLEND_MODES.OVERLAY},{type:"static",name:"alpha",defaultValue:1}]},{id:"paint_4",isPlus:!0,params:[{type:"static",name:"texture",defaultValue:"4_paint_overlay_100.jpg"},{type:"static",name:"blendMode",defaultValue:BFN.CONST.BLEND_MODES.OVERLAY},{type:"static",name:"alpha",defaultValue:1}]},{id:"paint_5",isPlus:!0,params:[{type:"static",name:"texture",defaultValue:"5_paint_overlay_100.jpg"},{type:"static",name:"blendMode",defaultValue:BFN.CONST.BLEND_MODES.OVERLAY},{type:"static",name:"alpha",defaultValue:.5}]},{id:"paint_6",isPlus:!0,params:[{type:"static",name:"texture",defaultValue:"6_paint_overlay_100.jpg"},{type:"static",name:"blendMode",defaultValue:BFN.CONST.BLEND_MODES.OVERLAY},{type:"static",name:"alpha",defaultValue:1}]}]},{id:"metal",translationId:"texture_metal",name:"Metal",graphic:"graphic_textures_metal",presets:[{id:"metal_1",isPlus:!1,params:[{type:"static",name:"texture",defaultValue:"1_metal_overlay_100.jpg"},{type:"static",name:"blendMode",defaultValue:BFN.CONST.BLEND_MODES.OVERLAY},{type:"static",name:"alpha",defaultValue:1}]},{id:"metal_2",isPlus:!0,params:[{type:"static",name:"texture",defaultValue:"2_metal_overlay_100.jpg"},{type:"static",name:"blendMode",defaultValue:BFN.CONST.BLEND_MODES.OVERLAY},{type:"static",name:"alpha",defaultValue:1}]},{id:"metal_3",isPlus:!0,params:[{type:"static",name:"texture",defaultValue:"3_metal_overlay_100.jpg"},{type:"static",name:"blendMode",defaultValue:BFN.CONST.BLEND_MODES.OVERLAY},{type:"static",name:"alpha",defaultValue:1}]},{id:"metal_4",isPlus:!0,params:[{type:"static",name:"texture",defaultValue:"4_metal_overlay_100.jpg"},{type:"static",name:"blendMode",defaultValue:BFN.CONST.BLEND_MODES.OVERLAY},{type:"static",name:"alpha",defaultValue:1}]},{id:"metal_5",isPlus:!0,params:[{type:"static",name:"texture",defaultValue:"5_metal_overlay_50.jpg"},{type:"static",name:"blendMode",defaultValue:BFN.CONST.BLEND_MODES.OVERLAY},{type:"static",name:"alpha",defaultValue:.5}]},{id:"metal_6",isPlus:!0,params:[{type:"static",name:"texture",defaultValue:"6_metal_overlay_100.jpg"},{type:"static",name:"blendMode",defaultValue:BFN.CONST.BLEND_MODES.OVERLAY},{type:"static",name:"alpha",defaultValue:1}]},{id:"metal_7",isPlus:!0,params:[{type:"static",name:"texture",defaultValue:"7_metal_overlay_100.jpg"},{type:"static",name:"blendMode",defaultValue:BFN.CONST.BLEND_MODES.OVERLAY},{type:"static",name:"alpha",defaultValue:1}]},{id:"metal_8",isPlus:!0,params:[{type:"static",name:"texture",defaultValue:"8_metal_overlay_100.jpg"},{type:"static",name:"blendMode",defaultValue:BFN.CONST.BLEND_MODES.OVERLAY},{type:"static",name:"alpha",defaultValue:1}]}]},{id:"bricks",translationId:"texture_bricks",name:"Bricks",graphic:"graphic_textures_bricks",presets:[{id:"bricks_1",isPlus:!1,params:[{type:"static",name:"texture",defaultValue:"1_Bricks_Multiply_40.jpg"},{type:"static",name:"blendMode",defaultValue:BFN.CONST.BLEND_MODES.MULTIPLY},{type:"static",name:"alpha",defaultValue:.4}]},{id:"bricks_2",isPlus:!0,params:[{type:"static",name:"texture",defaultValue:"2_Bricks_Overlay_100.jpg"},{type:"static",name:"blendMode",defaultValue:BFN.CONST.BLEND_MODES.OVERLAY},{type:"static",name:"alpha",defaultValue:1}]},{id:"bricks_3",isPlus:!0,params:[{type:"static",name:"texture",defaultValue:"3_Bricks_Overlay_100.jpg"},{type:"static",name:"blendMode",defaultValue:BFN.CONST.BLEND_MODES.OVERLAY},{type:"static",name:"alpha",defaultValue:1}]},{id:"bricks_4",isPlus:!0,params:[{type:"static",name:"texture",defaultValue:"4_Bricks_Overlay_100.jpg"},{type:"static",name:"blendMode",defaultValue:BFN.CONST.BLEND_MODES.OVERLAY},{type:"static",name:"alpha",defaultValue:1}]}]},{id:"paper",translationId:"texture_paper",name:"Paper",graphic:"graphic_textures_paper",presets:[{id:"paper_1",isPlus:!1,params:[{type:"static",name:"texture",defaultValue:"1_Paper_Overlay_100.jpg"},{type:"static",name:"blendMode",defaultValue:BFN.CONST.BLEND_MODES.OVERLAY},{type:"static",name:"alpha",defaultValue:1}]},{id:"paper_2",isPlus:!0,params:[{type:"static",name:"texture",defaultValue:"2_Paper_Overlay_100.jpg"},{type:"static",name:"blendMode",defaultValue:BFN.CONST.BLEND_MODES.OVERLAY},{type:"static",name:"alpha",defaultValue:1}]},{id:"paper_3",isPlus:!0,params:[{type:"static",name:"texture",defaultValue:"3_Paper_Overlay_100.jpg"},{type:"static",name:"blendMode",defaultValue:BFN.CONST.BLEND_MODES.OVERLAY},{type:"static",name:"alpha",defaultValue:1}]},{id:"paper_4",isPlus:!0,params:[{type:"static",name:"texture",defaultValue:"4_Paper_Overlay_100.jpg"},{type:"static",name:"blendMode",defaultValue:BFN.CONST.BLEND_MODES.OVERLAY},{type:"static",name:"alpha",defaultValue:1}]},{id:"paper_5",isPlus:!0,params:[{type:"static",name:"texture",defaultValue:"5_Paper_Overlay_100.jpg"},{type:"static",name:"blendMode",defaultValue:BFN.CONST.BLEND_MODES.OVERLAY},{type:"static",name:"alpha",defaultValue:.5}]},{id:"paper_6",isPlus:!0,params:[{type:"static",name:"texture",defaultValue:"6_Paper_Overlay_100.jpg"},{type:"static",name:"blendMode",defaultValue:BFN.CONST.BLEND_MODES.OVERLAY},{type:"static",name:"alpha",defaultValue:1}]},{id:"paper_7",isPlus:!0,params:[{type:"static",name:"texture",defaultValue:"7_Paper_Overlay_100.jpg"},{type:"static",name:"blendMode",defaultValue:BFN.CONST.BLEND_MODES.OVERLAY},{type:"static",name:"alpha",defaultValue:1}]},{id:"paper_8",isPlus:!0,params:[{type:"static",name:"texture",defaultValue:"8_Paper_Overlay_100.jpg"},{type:"static",name:"blendMode",defaultValue:BFN.CONST.BLEND_MODES.OVERLAY},{type:"static",name:"alpha",defaultValue:1}]}]}];BFN.textureCategoryIDMap={};BFN.texturePresetMap={};BFN.textureIDMap={};for(let i=0;i<BFN.TextureData.length;i++){let e=BFN.TextureData[i];for(let t=0;t<e.presets.length;t++){let r=e.presets[t];r.params.push({type:"static",name:"textureName",defaultValue:`${e.name} ${t+1}`}),BFN.toolViewstates[`${e.id}_${r.id}`]=BFN.PhotoEditorCanvasModelViewStates.VIEWING_TEXTURE,BFN.textureCategoryIDMap[`${e.id}_${r.id}`]=r.id,BFN.textureIDMap[r.id]=e.id,BFN.texturePresetMap[r.id]=r,r.translation=[e.translationId,{suffix:`${t+1}`}],r.params.push({type:"static",name:"textureTranslation",defaultValue:r.translation})}}function _r(){this.init()}_r.prototype.init=function(){BeFunky.log("LensFlareData Init"),this.initDefaultValues(),this.initAssetData(),this.initPresetData(),this.initAssets(),this.initPresets(),this.initMenuData()};_r.prototype.initDefaultValues=function(){this.assetPath=`${BFN.remoteImagesURL}app/graphics/lens_flare_assets/`};_r.prototype.initAssetData=function(){this.assetData=[{categoryID:"glows",name:"Glows",assets:[{assetID:"Glow_01",static:!1},{assetID:"Glow_02",static:!1},{assetID:"Glow_03",static:!1},{assetID:"Glow_04",static:!1},{assetID:"Glow_05",static:!1},{assetID:"Glow_06",static:!1},{assetID:"Glow_07",static:!1},{assetID:"Glow_08",static:!1},{assetID:"Glow_09",static:!1},{assetID:"Glow_10",static:!1}]},{categoryID:"glints",name:"Glints",assets:[{assetID:"Glint_01",static:!1},{assetID:"Glint_02",static:!1},{assetID:"Glint_03",static:!1},{assetID:"Glint_04",static:!1},{assetID:"Glint_05",static:!1},{assetID:"Glint_06",static:!1},{assetID:"Glint_07",static:!1},{assetID:"Glint_08",static:!1}]},{categoryID:"shapes",name:"Shapes",assets:[{assetID:"Circle",static:!1},{assetID:"Circle_Gradient",static:!1},{assetID:"Octagon",static:!1},{assetID:"Octagon_Gradient",static:!1},{assetID:"Hexagon",static:!1},{assetID:"Hexagon_Gradient",static:!1},{assetID:"Square",static:!1},{assetID:"Square_Gradient",static:!1}]},{categoryID:"orbs",name:"Orbs",assets:[{assetID:"Orb_01",static:!1},{assetID:"Orb_02",static:!1},{assetID:"Orb_03",static:!1},{assetID:"Orb_04",static:!1},{assetID:"Orb_05",static:!1},{assetID:"Orb_06",static:!1},{assetID:"Orb_07",static:!1},{assetID:"Orb_08",static:!1},{assetID:"Orb_09",static:!1},{assetID:"Orb_10",static:!1},{assetID:"Orb_11",static:!1},{assetID:"Orb_12",static:!1},{assetID:"Orb_13",static:!1},{assetID:"Orb_14",static:!1},{assetID:"Orb_15",static:!1},{assetID:"Orb_16",static:!1}]},{categoryID:"irises",name:"Irises",assets:[{assetID:"Iris_01",static:!1},{assetID:"Iris_02",static:!1},{assetID:"Iris_03",static:!1},{assetID:"Iris_04",static:!1},{assetID:"Iris_05",static:!1},{assetID:"Iris_06",static:!1},{assetID:"Iris_07",static:!1},{assetID:"Iris_08",static:!1},{assetID:"Iris_09",static:!1},{assetID:"Iris_10",static:!1}]},{categoryID:"streaks",name:"Streaks",assets:[{assetID:"Streak_01",static:!1},{assetID:"Streak_02",static:!1},{assetID:"Streak_03",static:!1},{assetID:"Streak_04",static:!1},{assetID:"Streak_05",static:!1},{assetID:"Streak_06",static:!1},{assetID:"Streak_07",static:!1},{assetID:"Streak_08",static:!1},{assetID:"Streak_09",static:!1},{assetID:"Streak_10",static:!1},{assetID:"Streak_11",static:!1},{assetID:"Streak_12",static:!1},{assetID:"Streak_13",static:!1},{assetID:"Streak_14",static:!1},{assetID:"Streak_15",static:!1},{assetID:"Streak_16",static:!1}]},{categoryID:"caustics",name:"Caustics",assets:[{assetID:"Caustic_01",static:!1},{assetID:"Caustic_02",static:!1},{assetID:"Caustic_03",static:!1},{assetID:"Caustic_04",static:!1},{assetID:"Caustic_05",static:!1},{assetID:"Caustic_06",static:!1},{assetID:"Caustic_07",static:!1},{assetID:"Caustic_08",static:!1},{assetID:"Caustic_09",static:!1},{assetID:"Caustic_10",static:!1},{assetID:"Caustic_11",static:!1},{assetID:"Caustic_12",static:!1},{assetID:"Caustic_13",static:!1},{assetID:"Caustic_14",static:!1},{assetID:"Caustic_15",static:!1},{assetID:"Caustic_16",static:!1},{assetID:"Caustic_17",static:!1},{assetID:"Caustic_18",static:!1},{assetID:"Caustic_19",static:!1},{assetID:"Caustic_20",static:!1},{assetID:"Caustic_21",static:!1},{assetID:"Caustic_22",static:!1},{assetID:"Caustic_23",static:!1},{assetID:"Caustic_24",static:!1}]},{categoryID:"lenses",name:"Lenses",assets:[{assetID:"Lens_01",static:!0},{assetID:"Lens_02",static:!0},{assetID:"Lens_03",static:!0},{assetID:"Lens_04",static:!0},{assetID:"Lens_05",static:!0},{assetID:"Lens_06",static:!0},{assetID:"Lens_07",static:!0},{assetID:"Lens_08",static:!0},{assetID:"Lens_09",static:!0},{assetID:"Lens_10",static:!0},{assetID:"Lens_11",static:!0},{assetID:"Lens_12",static:!0},{assetID:"Lens_13",static:!0},{assetID:"Lens_14",static:!0},{assetID:"Lens_15",static:!0},{assetID:"Lens_16",static:!0},{assetID:"Lens_17",static:!0},{assetID:"Lens_18",static:!0},{assetID:"Lens_19",static:!0},{assetID:"Lens_20",static:!0}]}]};_r.prototype.initPresetData=function(){this.presetData=[{categoryID:"basic_presets",name:"Basic Presets",presets:[{presetID:"simple",presetName:"Simple",isPlus:!0,elements:[{assetID:"Glow_01",color:8421504,intensityFactor:.3,sizeFactor:2.5,sizeFactorGlobal:.5},{assetID:"Glow_01",color:8421504,intensityFactor:.5,sizeFactor:.5,sizeFactorGlobal:.5},{assetID:"Glint_08",color:8421504,intensityFactor:.4,sizeFactor:.6,sizeFactorGlobal:.5},{assetID:"Glow_01",color:8421504,blendMode:"add",intensityFactor:.35,sizeFactor:.3,sizeFactorGlobal:.75},{assetID:"Orb_07",color:14352384,blendMode:"add",intensityFactor:.3,intensityFactorGlobal:.35,sizeFactor:.2},{assetID:"Circle",intensityFactor:.15,intensityFactorGlobal:.5,sizeFactor:.7,sourceDistanceFactor:-.1},{assetID:"Circle",blendMode:"add",intensityFactor:.05,intensityFactorGlobal:.5,sizeFactor:.3,sourceDistanceFactor:-.22},{assetID:"Circle_Gradient",intensityFactor:.3,intensityFactorGlobal:.5,sizeFactor:.08,sourceDistanceFactor:-.14},{assetID:"Circle_Gradient",color:4077973,blendMode:"add",intensityFactor:.4,intensityFactorGlobal:.5,sizeFactor:.13,sourceDistanceFactor:.24},{assetID:"Circle_Gradient",color:4077973,blendMode:"add",intensityFactor:.4,intensityFactorGlobal:.5,sizeFactor:.06,sourceDistanceFactor:.27},{assetID:"Circle_Gradient",color:4077973,blendMode:"add",intensityFactor:.4,intensityFactorGlobal:.5,sizeFactor:.04,sourceDistanceFactor:.21},{assetID:"Circle",blendMode:"add",intensityFactor:.4,intensityFactorGlobal:.5,sizeFactor:.04,sourceDistanceFactor:.35},{assetID:"Circle_Gradient",blendMode:"add",intensityFactor:.3,intensityFactorGlobal:.5,sizeFactor:.15,sourceDistanceFactor:.7},{assetID:"Circle",intensityFactor:.2,intensityFactorGlobal:.5,sizeFactor:.08,sourceDistanceFactor:.68},{assetID:"Circle",blendMode:"add",intensityFactor:.2,intensityFactorGlobal:.5,sizeFactor:.03,sourceDistanceFactor:.71},{assetID:"Circle",blendMode:"add",intensityFactor:.25,intensityFactorGlobal:.5,sizeFactor:.07,sourceDistanceFactor:.78},{assetID:"Glow_01",color:4077973,blendMode:"add",intensityFactor:.5,intensityFactorGlobal:.25,sizeFactor:.05,sourceDistanceFactor:.78},{assetID:"Circle_Gradient",blendMode:"add",intensityFactor:.65,intensityFactorGlobal:.5,sizeFactor:.2,sourceDistanceFactor:.91},{assetID:"Orb_12",blendMode:"add",intensityFactor:.2,intensityFactorGlobal:.5,sizeFactor:.45,sourceDistanceFactor:1},{assetID:"Glow_01",color:4077973,blendMode:"add",intensityFactor:.96,intensityFactorGlobal:.25,sizeFactor:.05,sourceDistanceFactor:.63}]}]},{categoryID:"advanced_presets",name:"Advanced Presets",presets:[{presetID:"sunny_day",presetName:"Sunny Day",isPlus:!0,elements:[{assetID:"Glow_01",color:16746496,colorGlobalGroup:1,blendMode:"add",intensityFactor:.3,sizeFactor:1.5,sizeFactorGlobal:.75},{assetID:"Glow_10",color:16746496,intensityFactor:.5,sizeFactor:.7,sizeFactorGlobal:.75},{assetID:"Glow_02",intensityFactorGlobal:.5,sizeFactor:.4,sizeFactorGlobal:.5},{assetID:"Glow_09",color:16746496,colorGlobalGroup:1,blendMode:"add",intensityFactor:.5,sizeFactor:1.1,sizeFactorGlobal:.5},{assetID:"Iris_10",color:16746496,colorGlobalGroup:1,blendMode:"add",intensityFactor:.2,intensityFactorGlobal:.25,sizeFactor:1.2,sourceDistanceFactor:1},{assetID:"Iris_10",color:16746496,colorGlobalGroup:1,blendMode:"add",intensityFactor:.1,intensityFactorGlobal:.5,sizeFactor:.3,sourceDistanceFactor:.6},{assetID:"Iris_10",color:16746496,colorGlobalGroup:1,blendMode:"add",intensityFactor:.15,intensityFactorGlobal:.5,sizeFactor:.05,sourceDistanceFactor:.25},{assetID:"Iris_10",color:16746496,colorGlobalGroup:1,blendMode:"add",intensityFactor:.15,intensityFactorGlobal:.5,sizeFactor:.03,sourceDistanceFactor:.31},{assetID:"Iris_10",color:16746496,colorGlobalGroup:1,blendMode:"add",intensityFactor:.15,intensityFactorGlobal:.5,sizeFactor:.06,sourceDistanceFactor:.32},{assetID:"Iris_10",color:16746496,colorGlobalGroup:1,blendMode:"add",intensityFactor:.1,intensityFactorGlobal:.5,sizeFactor:.06,sourceDistanceFactor:.65},{assetID:"Iris_10",color:16746496,colorGlobalGroup:1,blendMode:"add",intensityFactor:.05,intensityFactorGlobal:.5,sizeFactor:.2,sourceDistanceFactor:.4},{assetID:"Iris_10",color:16746496,colorGlobalGroup:1,blendMode:"add",intensityFactor:.1,intensityFactorGlobal:.5,sizeFactor:.03,sourceDistanceFactor:.7},{assetID:"Glow_01",color:16746496,colorGlobalGroup:1,intensityFactorGlobal:.25,sizeFactor:.02,sourceDistanceFactor:.7},{assetID:"Glow_01",color:16746496,colorGlobalGroup:1,intensityFactorGlobal:.25,sizeFactor:.04,sourceDistanceFactor:.35},{assetID:"Caustic_01",color:16746496,colorGlobalGroup:1,intensityFactor:.3,intensityFactorGlobal:.5,sizeFactor:.55,rotationLock:!0,sourceDistanceFactor:-.5},{assetID:"Caustic_21",color:16746496,colorGlobalGroup:1,blendMode:"add",intensityFactor:.1,intensityFactorGlobal:.25,sizeFactor:.3,rotationOffset:180,rotationLock:!0,stretchYFactor:1.5,sourceDistanceFactor:1.3},{assetID:"Caustic_09",color:16746496,colorGlobalGroup:1,blendMode:"add",intensityFactor:.4,intensityFactorGlobal:.5,sizeFactor:.52,rotationLock:!0,sourceDistanceFactor:.6},{assetID:"Orb_14",blendMode:"add",intensityFactor:.1,intensityFactorGlobal:.5,sizeFactor:1.25,rotationOffset:180,rotationLock:!0,sourceDistanceFactor:1},{assetID:"Lens_15",color:16746496,colorGlobalGroup:1,blendMode:"add",intensityFactor:.4,intensityFactorGlobal:.5,sizeFactor:1.5}]},{presetID:"sun_beam",presetName:"Sun Beam",isPlus:!0,elements:[{assetID:"Streak_05",color:13861167,colorGlobalGroup:1,intensityFactor:.8,intensityFactorGlobal:.4,sizeFactor:.98,sizeFactorGlobal:.2,rotationLock:!0,stretchXFactor:2.2,stretchYFactor:.8},{assetID:"Streak_05",color:13861167,colorGlobalGroup:1,blendMode:"add",intensityFactorGlobal:.4,sizeFactor:1.16,sizeFactorGlobal:.2,rotationOffset:180,rotationLock:!0,stretchXFactor:2.2,stretchYFactor:.8},{assetID:"Streak_13",colorGlobalGroup:1,intensityFactor:.8,sizeFactorGlobal:.6,rotationLock:!0},{assetID:"Streak_10",color:13861167,colorGlobalGroup:1,blendMode:"add",intensityFactor:.8,sizeFactorGlobal:.6,rotationOffset:-90,rotationLock:!0,stretchXFactor:1.5},{assetID:"Orb_10",color:13861167,colorGlobalGroup:1,blendMode:"add",intensityFactor:.25,intensityFactorGlobal:.6,sizeFactor:.53,sizeFactorGlobal:.2,rotationLock:!0},{assetID:"Glow_09",color:13861167,colorGlobalGroup:1,blendMode:"add",intensityFactor:.4,sizeFactor:1.5,sizeFactorGlobal:.3},{assetID:"Glow_04",color:13861167,colorGlobalGroup:1,blendMode:"add",intensityFactor:.8,sizeFactor:.35,sizeFactorGlobal:.4,rotationLock:!0,stretchYFactor:3},{assetID:"Caustic_03",color:13861167,colorGlobalGroup:1,blendMode:"add",intensityFactor:.6,sizeFactor:.15,sizeFactorGlobal:.8},{assetID:"Orb_15",color:13861167,colorGlobalGroup:1,blendMode:"add",intensityFactor:.2,sizeFactor:.5,sizeFactorGlobal:.8},{assetID:"Orb_01",color:13861167,colorGlobalGroup:1,blendMode:"add",intensityFactor:.6,intensityFactorGlobal:.25,sizeFactor:3},{assetID:"Orb_03",color:13861167,blendMode:"add",intensityFactor:.5,sizeFactor:2,rotationLock:!0,sourceDistanceFactor:1}]},{presetID:"warm_sun",presetName:"Warm Sun",isPlus:!0,elements:[{assetID:"Glow_10",color:13850903,colorGlobalGroup:1,blendMode:"add",intensityFactor:.8,intensityFactorGlobal:.59,sizeFactor:.46,sizeFactorGlobal:.19,rotationOffset:17,stretchXFactor:.75,stretchYFactor:.82},{assetID:"Glow_02",color:14376216,blendMode:"add",intensityFactor:.5,sizeFactor:.1,sizeFactorGlobal:.25},{assetID:"Octagon",color:14376216,colorGlobalGroup:1,intensityFactor:.85,intensityFactorGlobal:.57,sizeFactor:.04,sizeFactorGlobal:.16,sourceDistanceFactor:.24},{assetID:"Octagon_Gradient",color:14376216,colorGlobalGroup:1,intensityFactor:.32,intensityFactorGlobal:.24,sizeFactor:.08,sizeFactorGlobal:.33,sourceDistanceFactor:.14},{assetID:"Iris_01",color:14376216,colorGlobalGroup:1,intensityFactor:.71,intensityFactorGlobal:.6,sizeFactor:.14,sizeFactorGlobal:.27,rotationOffset:-180,rotationLock:!0,sourceDistanceFactor:.35},{assetID:"Orb_04",intensityFactor:.58,intensityFactorGlobal:.3,sizeFactor:.09,sizeFactorGlobal:.24,rotationOffset:-151,sourceDistanceFactor:.44},{assetID:"Octagon_Gradient",color:14376216,colorGlobalGroup:1,intensityFactor:.12,intensityFactorGlobal:.39,sizeFactor:.27,sizeFactorGlobal:.12,sourceDistanceFactor:.16},{assetID:"Octagon_Gradient",color:14376216,colorGlobalGroup:1,intensityFactor:.07,intensityFactorGlobal:.39,sizeFactor:.27,sizeFactorGlobal:.12,sourceDistanceFactor:.88},{assetID:"Octagon_Gradient",color:14376216,colorGlobalGroup:1,intensityFactor:.07,intensityFactorGlobal:.39,sizeFactor:.17,sizeFactorGlobal:.12,sourceDistanceFactor:1.1},{assetID:"Octagon_Gradient",color:14376216,colorGlobalGroup:1,intensityFactor:.08,intensityFactorGlobal:.17,sizeFactor:.17,sizeFactorGlobal:.19,sourceDistanceFactor:.24},{assetID:"Octagon_Gradient",color:14376216,colorGlobalGroup:1,intensityFactor:.08,intensityFactorGlobal:.2,sizeFactor:.25,sizeFactorGlobal:.15,sourceDistanceFactor:.27,centerDistanceFactor:.01},{assetID:"Streak_06",color:14376216,colorGlobalGroup:1,intensityFactor:.88,intensityFactorGlobal:.63,sizeFactor:.96,sizeFactorGlobal:.22,rotationOffset:100,rotationLock:!0,stretchXFactor:1.6,stretchYFactor:.68},{assetID:"Streak_06",color:14376216,colorGlobalGroup:1,intensityFactor:.66,intensityFactorGlobal:.54,sizeFactor:.96,sizeFactorGlobal:.34,rotationOffset:22,rotationLock:!0,stretchXFactor:1.6,stretchYFactor:.68},{assetID:"Streak_06",color:14376216,colorGlobalGroup:1,intensityFactor:.88,intensityFactorGlobal:.52,sizeFactor:.96,sizeFactorGlobal:.24,rotationOffset:67,rotationLock:!0,stretchXFactor:.65,stretchYFactor:.74},{assetID:"Streak_06",color:14376216,colorGlobalGroup:1,intensityFactor:.66,sizeFactor:.96,rotationOffset:-23,rotationLock:!0,stretchXFactor:.96,stretchYFactor:.41},{assetID:"Orb_15",color:14376216,colorGlobalGroup:1,blendMode:"add",intensityFactor:.23,intensityFactorGlobal:.4,sizeFactor:2.42,sizeFactorGlobal:.32,rotationOffset:105,rotationLock:!0,stretchXFactor:1.08,sourceDistanceFactor:.13},{assetID:"Octagon_Gradient",color:14376216,colorGlobalGroup:1,intensityFactor:.16,intensityFactorGlobal:.56,sizeFactor:.07,sizeFactorGlobal:.14,stretchXFactor:1.02,sourceDistanceFactor:.58},{assetID:"Octagon_Gradient",color:14376216,colorGlobalGroup:1,intensityFactor:.14,intensityFactorGlobal:.56,sizeFactor:.09,sizeFactorGlobal:.14,stretchXFactor:1.02,sourceDistanceFactor:1},{assetID:"Octagon",color:14376216,colorGlobalGroup:1,intensityFactor:.14,intensityFactorGlobal:.56,sizeFactor:.15,sizeFactorGlobal:.14,stretchXFactor:1.02,sourceDistanceFactor:.74},{assetID:"Lens_14",color:14376216,colorGlobalGroup:1,intensityFactor:.12,intensityFactorGlobal:1,sizeFactor:.9,sourceDistanceFactor:.08}]},{presetID:"sunset",presetName:"Sunset",isPlus:!0,elements:[{assetID:"Streak_14",blendMode:"add",sizeFactorGlobal:.8,rotationOffset:90,rotationLock:!0,stretchXFactor:.8},{assetID:"Streak_05",color:14783541,blendMode:"add",sizeFactorGlobal:.8,rotationOffset:95,rotationLock:!0,stretchXFactor:1.8},{assetID:"Streak_05",color:14783541,blendMode:"add",sizeFactorGlobal:.8,rotationOffset:-95,rotationLock:!0,stretchXFactor:1.8},{assetID:"Streak_05",color:14783541,sizeFactorGlobal:.6,rotationOffset:-115,rotationLock:!0,stretchYFactor:5},{assetID:"Streak_05",color:14783541,sizeFactorGlobal:.6,rotationOffset:115,rotationLock:!0,stretchYFactor:5},{assetID:"Streak_05",color:14783541,intensityFactor:.6,sizeFactorGlobal:.6,rotationOffset:180,rotationLock:!0,stretchYFactor:5},{assetID:"Glow_10",intensityFactor:.5,sizeFactor:.5,sizeFactorGlobal:.6,stretchXFactor:2.5,stretchYFactor:.75},{assetID:"Orb_03",intensityFactor:.8,sizeFactorGlobal:.4,rotationLock:!0,sourceDistanceFactor:1},{assetID:"Orb_03",intensityFactor:.2,sizeFactor:.2,sizeFactorGlobal:.4,rotationLock:!0,sourceDistanceFactor:.65},{assetID:"Caustic_09",intensityFactor:.2,rotationOffset:180,rotationLock:!0,sourceDistanceFactor:1}]},{presetID:"flash",presetName:"Flash",isPlus:!0,elements:[{assetID:"Glow_10",color:5471734,colorGlobalGroup:1,sizeFactorGlobal:.75},{assetID:"Glow_01",color:5669375,colorGlobalGroup:1,sizeFactor:.51,sizeFactorGlobal:.75},{assetID:"Caustic_09",color:5669375,colorGlobalGroup:1,intensityFactorGlobal:.5,sizeFactor:.45,rotationOffset:180,rotationLock:!0,sourceDistanceFactor:1.33},{assetID:"Lens_09",color:5669375,colorGlobalGroup:1,intensityFactorGlobal:.25,sizeFactor:1.75},{assetID:"Orb_10",intensityFactor:.48,intensityFactorGlobal:.25,sizeFactor:.94,sizeFactorGlobal:.5,rotationLock:!0},{assetID:"Orb_13",color:5669375,colorGlobalGroup:1,intensityFactor:.53,intensityFactorGlobal:.5,sizeFactor:1.14,sourceDistanceFactor:1.46},{assetID:"Orb_04",intensityFactor:.8,intensityFactorGlobal:.25,sizeFactor:.25,rotationLock:!0,sourceDistanceFactor:.85}]},{presetID:"strobe",presetName:"Strobe",isPlus:!0,elements:[{assetID:"Streak_07",color:3372953,colorGlobalGroup:1,intensityFactor:.85,sizeFactor:1.8,sizeFactorGlobal:.6,stretchXFactor:1.7},{assetID:"Streak_07",color:3372953,colorGlobalGroup:1,intensityFactor:.85,sizeFactor:1.2,sizeFactorGlobal:.6,rotationOffset:10,rotationLock:!0},{assetID:"Streak_07",color:3372953,colorGlobalGroup:1,intensityFactor:.55,sizeFactor:1.2,sizeFactorGlobal:.6,rotationOffset:150,rotationLock:!0,stretchYFactor:2.2},{assetID:"Streak_07",color:3372953,colorGlobalGroup:1,intensityFactor:.5,sizeFactor:1.2,sizeFactorGlobal:.6,rotationOffset:100,rotationLock:!0,stretchXFactor:.8,stretchYFactor:2.2},{assetID:"Streak_07",color:3372953,colorGlobalGroup:1,intensityFactor:.5,sizeFactor:1.2,sizeFactorGlobal:.7,rotationOffset:90,rotationLock:!0,stretchXFactor:1.2,stretchYFactor:4.5},{assetID:"Streak_07",color:3372953,colorGlobalGroup:1,intensityFactor:.6,sizeFactor:1.2,sizeFactorGlobal:.55,rotationOffset:65,rotationLock:!0,stretchXFactor:1.4,stretchYFactor:1.7},{assetID:"Streak_07",color:3372953,colorGlobalGroup:1,intensityFactor:.6,sizeFactor:1.2,sizeFactorGlobal:.45,rotationOffset:60,rotationLock:!0,stretchXFactor:1.4,stretchYFactor:2},{assetID:"Streak_07",color:3372953,colorGlobalGroup:1,intensityFactor:.6,sizeFactor:1.2,sizeFactorGlobal:.5,rotationOffset:50,rotationLock:!0,stretchXFactor:1.4,stretchYFactor:2},{assetID:"Streak_07",color:3372953,colorGlobalGroup:1,intensityFactor:.6,sizeFactor:1.2,sizeFactorGlobal:.6,rotationOffset:20,rotationLock:!0,stretchXFactor:.9,stretchYFactor:2},{assetID:"Orb_15",color:3372953,colorGlobalGroup:1,blendMode:"add",intensityFactor:.2,sizeFactor:.2,sizeFactorGlobal:.6},{assetID:"Orb_06",blendMode:"add",intensityFactor:.15,intensityFactorGlobal:.25,sizeFactor:.51,rotationLock:!0,stretchXFactor:1.2,sourceDistanceFactor:.65},{assetID:"Orb_05",blendMode:"add",intensityFactor:.3,intensityFactorGlobal:.25,sizeFactor:.51,rotationLock:!0,stretchXFactor:1.2,sourceDistanceFactor:.65},{assetID:"Iris_08",color:3372953,colorGlobalGroup:1,intensityFactor:.3,intensityFactorGlobal:.35,sizeFactor:.2,rotationOffset:60,sourceDistanceFactor:.55},{assetID:"Lens_09",color:3372953,colorGlobalGroup:1,blendMode:"add",intensityFactorGlobal:.3,sizeFactorGlobal:.25},{assetID:"Iris_01",color:3372953,colorGlobalGroup:1,intensityFactor:.5,intensityFactorGlobal:.5,sizeFactor:2.5,rotationLock:!0,sourceDistanceFactor:1.25}]},{presetID:"spotlight",presetName:"Spotlight",isPlus:!0,elements:[{assetID:"Caustic_02",blendMode:"add",intensityFactor:.4,intensityFactorGlobal:.25,sizeFactor:.4,sizeFactorGlobal:.35,rotationOffset:85,rotationLock:!0,sourceDistanceFactor:-.08},{assetID:"Streak_02",color:16777215,colorGlobalGroup:1,intensityFactor:.3,sizeFactor:.6,sizeFactorGlobal:.35,stretchXFactor:5,stretchYFactor:.2},{assetID:"Glint_04",color:16777215,colorGlobalGroup:1,intensityFactor:.3,sizeFactor:.4,sizeFactorGlobal:.75,rotationOffset:20},{assetID:"Orb_16",color:16777215,colorGlobalGroup:1,intensityFactor:.3,sizeFactor:.5,sizeFactorGlobal:.75,rotationOffset:40,rotationLock:!0},{assetID:"Glow_09",color:16777215,colorGlobalGroup:1,blendMode:"add",intensityFactor:.25,sizeFactor:.7,sizeFactorGlobal:.8},{assetID:"Glow_01",color:16777215,colorGlobalGroup:1,blendMode:"add",intensityFactor:.5,sizeFactor:.1,sizeFactorGlobal:.8},{assetID:"Orb_10",blendMode:"add",intensityFactor:.2,intensityFactorGlobal:.25,sizeFactor:.4,sizeFactorGlobal:.5},{assetID:"Caustic_02",blendMode:"add",intensityFactor:.3,intensityFactorGlobal:.25,sizeFactor:.5,rotationOffset:85,rotationLock:!0,stretchXFactor:.75,sourceDistanceFactor:-.75},{assetID:"Caustic_02",blendMode:"add",intensityFactor:.3,intensityFactorGlobal:.25,sizeFactor:.7,rotationOffset:-105,rotationLock:!0,stretchXFactor:.75,sourceDistanceFactor:1.1},{assetID:"Orb_03",color:3363892,colorGlobalGroup:2,blendMode:"add",intensityFactor:.7,intensityFactorGlobal:.5,sizeFactor:.07,rotationOffset:135,rotationLock:!0,sourceDistanceFactor:-.15,centerDistanceFactor:-.15},{assetID:"Orb_03",color:3363892,colorGlobalGroup:2,blendMode:"add",intensityFactor:.7,intensityFactorGlobal:.5,sizeFactor:.07,rotationOffset:135,rotationLock:!0,sourceDistanceFactor:.25,centerDistanceFactor:-.25},{assetID:"Orb_03",color:3363892,colorGlobalGroup:2,blendMode:"add",intensityFactor:.7,intensityFactorGlobal:.5,sizeFactor:.05,rotationLock:!0,sourceDistanceFactor:.25,centerDistanceFactor:.05},{assetID:"Orb_03",color:3363892,colorGlobalGroup:2,blendMode:"add",intensityFactor:.7,intensityFactorGlobal:.5,sizeFactor:.2,rotationLock:!0,sourceDistanceFactor:1.3},{assetID:"Orb_03",color:3363892,colorGlobalGroup:2,blendMode:"add",intensityFactor:.7,intensityFactorGlobal:.5,sizeFactor:.9,rotationLock:!0,sourceDistanceFactor:1},{assetID:"Orb_03",color:5711050,colorGlobalGroup:3,blendMode:"add",intensityFactor:.7,intensityFactorGlobal:.5,sizeFactor:.1,rotationLock:!0,sourceDistanceFactor:1.2},{assetID:"Orb_03",color:5711050,colorGlobalGroup:3,blendMode:"add",intensityFactor:.5,intensityFactorGlobal:.5,sizeFactor:.05,rotationLock:!0,sourceDistanceFactor:1.1,centerDistanceFactor:.05},{assetID:"Orb_03",color:5711050,colorGlobalGroup:3,blendMode:"add",intensityFactor:.5,intensityFactorGlobal:.5,sizeFactor:.25,rotationOffset:180,rotationLock:!0,sourceDistanceFactor:-.85,centerDistanceFactor:.05},{assetID:"Orb_03",color:3363892,colorGlobalGroup:2,blendMode:"add",intensityFactor:.5,intensityFactorGlobal:.5,sizeFactor:.15,rotationOffset:180,rotationLock:!0,sourceDistanceFactor:.7,centerDistanceFactor:.05},{assetID:"Orb_03",color:3363892,colorGlobalGroup:2,blendMode:"add",intensityFactor:.5,intensityFactorGlobal:.5,sizeFactor:.15,rotationOffset:180,rotationLock:!0,sourceDistanceFactor:-.55,centerDistanceFactor:.05},{assetID:"Orb_13",color:3363892,colorGlobalGroup:2,blendMode:"add",intensityFactor:.6,intensityFactorGlobal:.5,sizeFactor:.03,rotationOffset:-92,rotationLock:!0,sourceDistanceFactor:.3,centerDistanceFactor:-.05},{assetID:"Orb_13",color:3363892,colorGlobalGroup:2,blendMode:"add",intensityFactor:.5,intensityFactorGlobal:.5,sizeFactor:.1,rotationOffset:-92,rotationLock:!0,sourceDistanceFactor:1.35,centerDistanceFactor:-.05},{assetID:"Orb_13",color:5711050,colorGlobalGroup:2,blendMode:"add",intensityFactor:.2,intensityFactorGlobal:.5,sizeFactor:.05,rotationOffset:-90,rotationLock:!0,sourceDistanceFactor:.8},{assetID:"Orb_13",color:3363892,colorGlobalGroup:2,blendMode:"add",intensityFactor:.3,intensityFactorGlobal:.5,sizeFactor:.3,rotationOffset:-92,rotationLock:!0,sourceDistanceFactor:1.25,centerDistanceFactor:.05},{assetID:"Octagon_Gradient",color:3363892,colorGlobalGroup:2,blendMode:"add",intensityFactor:.15,intensityFactorGlobal:.5,sizeFactor:.2,rotationOffset:-92,rotationLock:!0,stretchYFactor:1.1,sourceDistanceFactor:.85,centerDistanceFactor:.05},{assetID:"Octagon_Gradient",color:3363892,colorGlobalGroup:2,blendMode:"add",intensityFactor:.15,intensityFactorGlobal:.5,sizeFactor:.05,rotationOffset:-92,rotationLock:!0,sourceDistanceFactor:.45,centerDistanceFactor:.05},{assetID:"Octagon_Gradient",color:5711050,colorGlobalGroup:3,blendMode:"add",intensityFactor:.25,intensityFactorGlobal:.5,sizeFactor:.15,rotationOffset:-92,rotationLock:!0,stretchYFactor:1.1,sourceDistanceFactor:.5,centerDistanceFactor:.05},{assetID:"Octagon_Gradient",color:5711050,colorGlobalGroup:3,blendMode:"add",intensityFactor:.25,intensityFactorGlobal:.5,sizeFactor:.1,rotationOffset:-92,rotationLock:!0,sourceDistanceFactor:.35,centerDistanceFactor:.05},{assetID:"Octagon_Gradient",color:5711050,colorGlobalGroup:3,blendMode:"add",intensityFactor:.25,intensityFactorGlobal:.5,sizeFactor:.05,rotationOffset:-92,rotationLock:!0,centerDistanceFactor:.1},{assetID:"Orb_14",blendMode:"add",intensityFactor:.1,intensityFactorGlobal:.5,sizeFactor:1.9,rotationLock:!0,sourceDistanceFactor:.75},{assetID:"Caustic_16",color:5711050,blendMode:"add",intensityFactor:.3,intensityFactorGlobal:.5,sizeFactor:.4,rotationOffset:-101,rotationLock:!0,sourceDistanceFactor:1.64,centerDistanceFactor:-.05},{assetID:"Caustic_16",color:3363892,blendMode:"add",intensityFactor:.3,intensityFactorGlobal:.5,sizeFactor:.4,rotationOffset:-101,rotationLock:!0,sourceDistanceFactor:.6,centerDistanceFactor:-.05},{assetID:"Lens_09",colorGlobalGroup:4,blendMode:"add",intensityFactor:.5,intensityFactorGlobal:.5,sizeFactor:1.1,sizeFactorGlobal:.5}]},{presetID:"performance",presetName:"Performance",isPlus:!0,elements:[{assetID:"Orb_01",color:12072548,blendMode:"add",intensityFactorGlobal:.5,sizeFactor:1.65},{assetID:"Orb_01",color:923038,blendMode:"add",intensityFactor:.3,intensityFactorGlobal:.5,sizeFactor:.55,sizeFactorGlobal:.5},{assetID:"Orb_10",blendMode:"add",intensityFactor:.4,intensityFactorGlobal:.5,sizeFactor:.3,sizeFactorGlobal:.5},{assetID:"Orb_04",blendMode:"add",intensityFactor:.3,intensityFactorGlobal:.5,sizeFactor:.55,sizeFactorGlobal:.5,rotationLock:!0},{assetID:"Orb_09",blendMode:"add",intensityFactor:.2,intensityFactorGlobal:.5,sizeFactor:.8,sizeFactorGlobal:.5},{assetID:"Streak_14",intensityFactor:.2,sizeFactor:.78,sizeFactorGlobal:.5,stretchXFactor:2.5},{assetID:"Streak_11",color:12072548,intensityFactor:.5,intensityFactorGlobal:.5,sizeFactor:1.7,sizeFactorGlobal:.25,rotationOffset:90,stretchYFactor:2.5},{assetID:"Glow_09",blendMode:"add",intensityFactorGlobal:.4,sizeFactor:.2,sizeFactorGlobal:.29,stretchXFactor:.7},{assetID:"Orb_01",blendMode:"add",intensityFactor:.3,intensityFactorGlobal:.5,sizeFactor:.15,sizeFactorGlobal:.5},{assetID:"Glow_08",color:12072548,blendMode:"add",intensityFactor:.4,sizeFactor:.7,sizeFactorGlobal:.3,rotationLock:!0},{assetID:"Streak_16",color:12072548,blendMode:"add",intensityFactorGlobal:.5,sizeFactorGlobal:.25,stretchXFactor:1.5},{assetID:"Streak_16",color:12072548,blendMode:"add",intensityFactorGlobal:.5,stretchXFactor:1.5,stretchYFactor:.25,sourceDistanceFactor:.98},{assetID:"Streak_16",color:12072548,blendMode:"add",intensityFactorGlobal:.5,stretchYFactor:1.25,sourceDistanceFactor:1},{assetID:"Streak_16",color:12072548,blendMode:"add",intensityFactorGlobal:.5,stretchXFactor:1.5,stretchYFactor:.25,sourceDistanceFactor:1.02},{assetID:"Streak_02",blendMode:"add",intensityFactorGlobal:.5,sizeFactor:1.4,sourceDistanceFactor:1},{assetID:"Streak_04",color:12072548,blendMode:"add",intensityFactor:.7,intensityFactorGlobal:.5,sizeFactor:1.4,sourceDistanceFactor:.75},{assetID:"Streak_13",color:12072548,blendMode:"add",intensityFactorGlobal:.5,sizeFactor:.5,stretchXFactor:3.2,sourceDistanceFactor:.71},{assetID:"Circle_Gradient",color:3890493,intensityFactor:.3,intensityFactorGlobal:.5,sizeFactor:.1,sourceDistanceFactor:.7},{assetID:"Circle_Gradient",color:3890493,intensityFactor:.3,intensityFactorGlobal:.5,sizeFactor:.09,sourceDistanceFactor:.55},{assetID:"Circle_Gradient",color:3890493,intensityFactor:.3,intensityFactorGlobal:.5,sizeFactor:.08,sourceDistanceFactor:.4},{assetID:"Circle_Gradient",color:3890493,intensityFactor:.3,intensityFactorGlobal:.5,sizeFactor:.07,sourceDistanceFactor:.3},{assetID:"Circle_Gradient",color:4015509,intensityFactor:.3,intensityFactorGlobal:.5,sizeFactor:.05,sourceDistanceFactor:.47},{assetID:"Circle_Gradient",color:4015509,intensityFactor:.3,intensityFactorGlobal:.5,sizeFactor:.04,sourceDistanceFactor:.62},{assetID:"Lens_06",blendMode:"add",intensityFactor:.5,sizeFactor:.5}]},{presetID:"iris",presetName:"Iris",isPlus:!0,elements:[{assetID:"Orb_01",color:923038,blendMode:"add",intensityFactor:.3,sizeFactor:.55,sizeFactorGlobal:.5},{assetID:"Orb_10",blendMode:"add",intensityFactor:.4,sizeFactor:.3,sizeFactorGlobal:.5},{assetID:"Orb_04",blendMode:"add",intensityFactor:.5,sizeFactor:.55,sizeFactorGlobal:.5,rotationLock:!0},{assetID:"Orb_09",blendMode:"add",intensityFactor:.3,sizeFactor:.8,sizeFactorGlobal:.5},{assetID:"Streak_16",sizeFactorGlobal:.5,stretchXFactor:1.5},{assetID:"Streak_14",sizeFactor:.78,sizeFactorGlobal:.5},{assetID:"Glow_09",blendMode:"add",sizeFactor:.21,sizeFactorGlobal:.5},{assetID:"Streak_16",color:11099294,blendMode:"add",sizeFactor:.28,sizeFactorGlobal:.25,rotationOffset:90,centerDistanceFactor:.05},{assetID:"Streak_16",color:11099294,blendMode:"add",sizeFactor:.28,sizeFactorGlobal:.25,rotationOffset:90,stretchXFactor:1.25,centerDistanceFactor:.01},{assetID:"Streak_16",color:11099294,blendMode:"add",sizeFactor:.28,sizeFactorGlobal:.25,rotationOffset:90,stretchXFactor:1.5,centerDistanceFactor:-.01},{assetID:"Streak_16",color:11099294,blendMode:"add",sizeFactor:.28,sizeFactorGlobal:.25,rotationOffset:90,centerDistanceFactor:-.05},{assetID:"Orb_01",blendMode:"add",intensityFactor:.3,sizeFactor:.15,sizeFactorGlobal:.5},{assetID:"Caustic_07",blendMode:"add",intensityFactor:.5,intensityFactorGlobal:.5,sizeFactor:.9,sizeFactorGlobal:.5,rotationLock:!0}]},{presetID:"nova",presetName:"Nova",isPlus:!0,elements:[{assetID:"Glow_01",color:16747374,colorGlobalGroup:1,intensityFactor:.5,sizeFactor:2.5,sizeFactorGlobal:.6,stretchYFactor:.4},{assetID:"Glint_08",color:16747374,blendMode:"add",intensityFactor:.5,sizeFactor:.3,sizeFactorGlobal:.4},{assetID:"Streak_11",color:16747374,colorGlobalGroup:1,blendMode:"add",intensityFactor:.4,intensityFactorGlobal:.5,sizeFactorGlobal:.25,rotationOffset:-90,rotationLock:!0},{assetID:"Orb_04",color:16747374,colorGlobalGroup:1,blendMode:"add",intensityFactor:.4,intensityFactorGlobal:.7,sizeFactor:.27,rotationOffset:-90},{assetID:"Streak_11",color:12751103,colorGlobalGroup:2,blendMode:"add",intensityFactor:.4,intensityFactorGlobal:.5,stretchXFactor:2.5},{assetID:"Streak_09",color:12751103,colorGlobalGroup:2,blendMode:"add",intensityFactor:.71,sizeFactorGlobal:.35,stretchXFactor:2.5,sourceDistanceFactor:-.02},{assetID:"Streak_08",color:12751103,colorGlobalGroup:2,blendMode:"add",intensityFactorGlobal:.5,sizeFactorGlobal:.15,stretchXFactor:2.3,sourceDistanceFactor:-.1},{assetID:"Streak_04",color:12751103,colorGlobalGroup:2,intensityFactorGlobal:.5,sizeFactorGlobal:.25,sourceDistanceFactor:.05},{assetID:"Orb_04",color:12751103,blendMode:"add",intensityFactor:.3,intensityFactorGlobal:.25,sizeFactor:2,rotationLock:!0,sourceDistanceFactor:.95}]},{presetID:"elysium",presetName:"Elysium",isPlus:!0,elements:[{assetID:"Glow_09",color:13265151,colorGlobalGroup:2,blendMode:"add",intensityFactor:.4,sizeFactor:1.6,sizeFactorGlobal:.75},{assetID:"Caustic_09",color:16742667,colorGlobalGroup:1,blendMode:"add",intensityFactor:.1,sizeFactor:.2,sizeFactorGlobal:.25,rotationOffset:90,rotationLock:!0,stretchYFactor:2},{assetID:"Caustic_09",color:16742667,colorGlobalGroup:1,blendMode:"add",intensityFactor:.1,sizeFactor:.2,sizeFactorGlobal:.25,rotationOffset:-90,rotationLock:!0,stretchYFactor:2},{assetID:"Glow_03",color:16742667,colorGlobalGroup:1,blendMode:"add",sizeFactor:.5,sizeFactorGlobal:.6,stretchXFactor:2.5},{assetID:"Streak_13",color:16742667,colorGlobalGroup:1,blendMode:"add",intensityFactor:.4,sizeFactor:1.25,sizeFactorGlobal:.5,stretchXFactor:1.5},{assetID:"Streak_02",color:13265151,colorGlobalGroup:2,blendMode:"add",intensityFactor:.2,intensityFactorGlobal:.25,sizeFactor:1.25,sizeFactorGlobal:.25,rotationOffset:180,sourceDistanceFactor:.05},{assetID:"Streak_02",color:13265151,colorGlobalGroup:2,blendMode:"add",intensityFactor:.2,intensityFactorGlobal:.25,sizeFactor:1.25,sizeFactorGlobal:.25,sourceDistanceFactor:-.05},{assetID:"Streak_05",color:13265151,colorGlobalGroup:2,blendMode:"add",intensityFactor:.2,intensityFactorGlobal:.5,sizeFactor:3,sizeFactorGlobal:.5,rotationOffset:180,rotationLock:!0},{assetID:"Streak_05",color:13265151,colorGlobalGroup:2,blendMode:"add",intensityFactor:.1,intensityFactorGlobal:.5,sizeFactor:3,sizeFactorGlobal:.5,rotationOffset:120,rotationLock:!0},{assetID:"Streak_05",color:13265151,colorGlobalGroup:2,blendMode:"add",intensityFactor:.1,intensityFactorGlobal:.5,sizeFactor:3,sizeFactorGlobal:.5,rotationOffset:-120,rotationLock:!0},{assetID:"Orb_03",color:16742667,colorGlobalGroup:1,blendMode:"add",intensityFactor:.3,intensityFactorGlobal:.25,sizeFactor:.64,rotationOffset:180,rotationLock:!0,sourceDistanceFactor:.6},{assetID:"Orb_03",color:16742667,colorGlobalGroup:1,blendMode:"add",intensityFactor:.2,intensityFactorGlobal:.5,sizeFactor:.05,rotationOffset:180,rotationLock:!0,sourceDistanceFactor:.1},{assetID:"Orb_03",color:16742667,colorGlobalGroup:1,blendMode:"add",intensityFactor:.2,intensityFactorGlobal:.5,sizeFactor:.03,rotationOffset:180,rotationLock:!0,sourceDistanceFactor:.13},{assetID:"Orb_03",color:16742667,colorGlobalGroup:1,blendMode:"add",intensityFactor:.2,intensityFactorGlobal:.5,sizeFactor:.05,rotationOffset:180,rotationLock:!0,sourceDistanceFactor:.2},{assetID:"Orb_03",color:16742667,colorGlobalGroup:1,blendMode:"add",intensityFactor:.2,intensityFactorGlobal:.5,sizeFactor:.04,rotationOffset:180,rotationLock:!0,sourceDistanceFactor:.31},{assetID:"Orb_03",color:16742667,colorGlobalGroup:1,blendMode:"add",intensityFactor:.2,intensityFactorGlobal:.5,sizeFactor:.06,rotationOffset:180,rotationLock:!0,sourceDistanceFactor:.38},{assetID:"Orb_03",color:16742667,colorGlobalGroup:1,blendMode:"add",intensityFactor:.2,intensityFactorGlobal:.5,sizeFactor:.04,rotationOffset:180,rotationLock:!0,sourceDistanceFactor:.49},{assetID:"Orb_03",color:16742667,colorGlobalGroup:1,blendMode:"add",intensityFactor:.2,intensityFactorGlobal:.5,sizeFactor:.02,rotationOffset:180,rotationLock:!0,sourceDistanceFactor:.53},{assetID:"Orb_03",color:16742667,colorGlobalGroup:1,blendMode:"add",intensityFactor:.2,intensityFactorGlobal:.5,sizeFactor:.05,rotationOffset:180,rotationLock:!0,sourceDistanceFactor:.58},{assetID:"Orb_03",color:16742667,colorGlobalGroup:1,blendMode:"add",intensityFactor:.8,intensityFactorGlobal:.5,sizeFactor:.01,rotationOffset:180,rotationLock:!0,sourceDistanceFactor:.9},{assetID:"Orb_03",color:16742667,colorGlobalGroup:1,blendMode:"add",intensityFactor:.4,intensityFactorGlobal:.5,sizeFactor:.02,rotationOffset:180,rotationLock:!0,sourceDistanceFactor:.87}]},{presetID:"headlight",presetName:"Headlight",isPlus:!0,elements:[{assetID:"Glow_04",color:16579836,colorGlobalGroup:1,blendMode:"add",intensityFactor:.23,sizeFactor:.64,sizeFactorGlobal:.1,rotationOffset:41,rotationLock:!0,sourceDistanceFactor:-.02},{assetID:"Glow_04",color:16579836,colorGlobalGroup:1,blendMode:"add",intensityFactor:.52,sizeFactor:.54,sizeFactorGlobal:.45,rotationOffset:40,rotationLock:!0},{assetID:"Glow_04",color:16579836,colorGlobalGroup:1,blendMode:"add",intensityFactor:.46,sizeFactor:.37,sizeFactorGlobal:.7,rotationOffset:-35,rotationLock:!0},{assetID:"Glow_06",color:14345441,colorGlobalGroup:1,blendMode:"add",intensityFactor:.71,intensityFactorGlobal:.49,sizeFactor:.25,sizeFactorGlobal:.3,rotationOffset:-84,rotationLock:!0},{assetID:"Glow_08",color:16579836,colorGlobalGroup:1,intensityFactor:.17,sizeFactor:.46,sizeFactorGlobal:.64},{assetID:"Glow_10",color:16579836,colorGlobalGroup:1,intensityFactor:.66,sizeFactor:.29,sizeFactorGlobal:.32},{assetID:"Glow_10",color:16579836,colorGlobalGroup:1,blendMode:"add",intensityFactor:.35,sizeFactor:.1,sizeFactorGlobal:.32},{assetID:"Orb_10",intensityFactor:.13,intensityFactorGlobal:.26,sizeFactor:.47,sizeFactorGlobal:.65},{assetID:"Orb_02",color:15576700,colorGlobalGroup:2,intensityFactor:.28,sizeFactor:.25,sizeFactorGlobal:.69,sourceDistanceFactor:.12,centerDistanceFactor:-.02},{assetID:"Orb_02",color:13869175,colorGlobalGroup:2,blendMode:"add",intensityFactor:.25,intensityFactorGlobal:.3,sizeFactor:.35,sizeFactorGlobal:.1,sourceDistanceFactor:1.1,centerDistanceFactor:-.04},{assetID:"Caustic_07",color:16763554,colorGlobalGroup:2,intensityFactor:.18,intensityFactorGlobal:.2,sizeFactor:.09,sizeFactorGlobal:.68,sourceDistanceFactor:.13,centerDistanceFactor:-.1},{assetID:"Caustic_07",color:16169355,colorGlobalGroup:2,intensityFactor:.17,sizeFactor:.08,sizeFactorGlobal:.74,sourceDistanceFactor:.11,centerDistanceFactor:-.11},{assetID:"Orb_16",color:1265627,colorGlobalGroup:3,intensityFactor:.85,intensityFactorGlobal:.25,sizeFactor:.15,rotationOffset:-131,stretchXFactor:.98,sourceDistanceFactor:.55},{assetID:"Orb_16",color:960731,colorGlobalGroup:3,blendMode:"add",intensityFactor:.96,intensityFactorGlobal:.35,sizeFactor:.15,rotationOffset:-131,stretchXFactor:.98,sourceDistanceFactor:.67,centerDistanceFactor:-.04},{assetID:"Lens_15",color:10665727,colorGlobalGroup:4,intensityFactor:.35,intensityFactorGlobal:.2,sizeFactor:.85,sizeFactorGlobal:.4}]},{presetID:"glint",presetName:"Glint",isPlus:!0,elements:[{assetID:"Streak_13",color:11184895,colorGlobalGroup:1,blendMode:"add",intensityFactor:.6,sizeFactor:.2,sizeFactorGlobal:.8,rotationOffset:30,rotationLock:!0,stretchXFactor:2,stretchYFactor:.6},{assetID:"Streak_13",color:11184895,colorGlobalGroup:1,blendMode:"add",intensityFactor:.6,sizeFactor:.2,sizeFactorGlobal:.8,rotationOffset:-30,rotationLock:!0,stretchXFactor:2,stretchYFactor:.6},{assetID:"Streak_13",color:11184895,colorGlobalGroup:1,blendMode:"add",intensityFactor:.6,sizeFactor:.2,sizeFactorGlobal:.8,rotationOffset:90,rotationLock:!0,stretchXFactor:2,stretchYFactor:.6},{assetID:"Orb_15",color:11184895,colorGlobalGroup:1,intensityFactor:.6,sizeFactor:.4,sizeFactorGlobal:.8},{assetID:"Glow_09",color:11184895,colorGlobalGroup:1,blendMode:"add",intensityFactor:.5,sizeFactor:.2,sizeFactorGlobal:.8},{assetID:"Streak_07",color:11184895,colorGlobalGroup:1,intensityFactor:.8,sizeFactor:.3,sizeFactorGlobal:.8,rotationOffset:30,rotationLock:!0},{assetID:"Streak_07",color:11184895,colorGlobalGroup:1,intensityFactor:.8,sizeFactor:.3,sizeFactorGlobal:.8,rotationOffset:-30,rotationLock:!0},{assetID:"Streak_07",color:11184895,colorGlobalGroup:1,intensityFactor:.8,sizeFactor:.3,sizeFactorGlobal:.8,rotationOffset:90,rotationLock:!0}]},{presetID:"xenon",presetName:"Xenon",isPlus:!0,elements:[{assetID:"Orb_15",color:499229,colorGlobalGroup:1,blendMode:"add",sizeFactor:.05,sizeFactorGlobal:.7},{assetID:"Streak_05",color:499229,colorGlobalGroup:1,blendMode:"add",intensityFactorGlobal:.3,sizeFactorGlobal:.5,rotationLock:!0,stretchYFactor:.2},{assetID:"Streak_05",color:499229,colorGlobalGroup:1,blendMode:"add",intensityFactorGlobal:.3,sizeFactorGlobal:.5,rotationOffset:72,rotationLock:!0,stretchYFactor:.2},{assetID:"Streak_05",color:499229,colorGlobalGroup:1,blendMode:"add",intensityFactorGlobal:.3,sizeFactorGlobal:.5,rotationOffset:144,rotationLock:!0,stretchYFactor:.2},{assetID:"Streak_05",color:499229,colorGlobalGroup:1,blendMode:"add",intensityFactorGlobal:.3,sizeFactorGlobal:.5,rotationOffset:-144,rotationLock:!0,stretchYFactor:.2},{assetID:"Streak_05",color:499229,colorGlobalGroup:1,blendMode:"add",intensityFactorGlobal:.3,sizeFactorGlobal:.5,rotationOffset:-72,rotationLock:!0,stretchYFactor:.2},{assetID:"Orb_15",color:499229,colorGlobalGroup:1,intensityFactor:.5,sizeFactor:.4},{assetID:"Glow_09",color:499229,colorGlobalGroup:1,sizeFactor:.29,sizeFactorGlobal:.4,rotationLock:!0},{assetID:"Orb_01",color:499229,colorGlobalGroup:1,blendMode:"add",intensityFactor:.5,sizeFactor:2,sizeFactorGlobal:.1},{assetID:"Streak_03",color:499229,colorGlobalGroup:1,intensityFactor:.5,sizeFactorGlobal:.6,stretchYFactor:4},{assetID:"Caustic_03",color:499229,colorGlobalGroup:1,blendMode:"add",intensityFactor:.1},{assetID:"Orb_16",color:499229,colorGlobalGroup:1,intensityFactor:.8,intensityFactorGlobal:.25,rotationLock:!0,sourceDistanceFactor:1},{assetID:"Iris_07",color:499229,colorGlobalGroup:1,intensityFactor:.2,intensityFactorGlobal:.5,sizeFactor:.05,sourceDistanceFactor:.1},{assetID:"Iris_07",color:499229,colorGlobalGroup:1,intensityFactor:.2,intensityFactorGlobal:.5,sizeFactor:.07,sourceDistanceFactor:.2},{assetID:"Iris_07",color:499229,colorGlobalGroup:1,intensityFactor:.15,intensityFactorGlobal:.5,sizeFactor:.1,sourceDistanceFactor:.3},{assetID:"Iris_07",color:499229,colorGlobalGroup:1,intensityFactor:.1,intensityFactorGlobal:.5,sizeFactor:.25,sourceDistanceFactor:.6},{assetID:"Lens_15",color:499229,intensityFactor:.6,sizeFactor:.7,sizeFactorGlobal:.25}]},{presetID:"laser",presetName:"Laser",isPlus:!0,elements:[{assetID:"Streak_16",color:16729896,colorGlobalGroup:1,blendMode:"add",sizeFactor:2,sizeFactorGlobal:.75,stretchYFactor:.29,sourceDistanceFactor:-.03},{assetID:"Streak_16",color:16729896,colorGlobalGroup:1,blendMode:"add",sizeFactor:2,sizeFactorGlobal:.75,stretchYFactor:.29,sourceDistanceFactor:.03},{assetID:"Glow_10",color:16729896,colorGlobalGroup:1,blendMode:"add",intensityFactor:.6,sizeFactor:.3,sizeFactorGlobal:.75,stretchXFactor:2},{assetID:"Streak_01",color:16729896,colorGlobalGroup:1,blendMode:"add",intensityFactor:.6,sizeFactorGlobal:.5,stretchXFactor:2},{assetID:"Orb_15",color:16729896,colorGlobalGroup:1,sizeFactor:.8,sizeFactorGlobal:.35,stretchXFactor:1.5,stretchYFactor:.2},{assetID:"Glow_04",color:16729896,colorGlobalGroup:1,sizeFactor:.3,sizeFactorGlobal:.5,stretchXFactor:1.5},{assetID:"Streak_09",color:16729896,colorGlobalGroup:1,intensityFactorGlobal:.5,sizeFactor:.4,sizeFactorGlobal:.5,stretchXFactor:2.5,stretchYFactor:.35,sourceDistanceFactor:.03},{assetID:"Streak_09",color:16729896,colorGlobalGroup:1,intensityFactorGlobal:.5,sizeFactor:.4,sizeFactorGlobal:.5,rotationOffset:180,stretchXFactor:2.5,stretchYFactor:.35,sourceDistanceFactor:-.03}]}]}]};_r.prototype.initMenuData=function(){let i=[];for(let e=0;e<this.presetData.length;e++){let t=this.presetData[e];for(let r=0;r<t.presets.length;r++){let a=t.presets[r],s={id:`lens_flare_${a.presetID}`,name:a.presetName,isPlus:a.isPlus,thumb:"tba",effectID:"lens_flare",usePaint:!1,params:[{type:"static",name:"presetID",defaultValue:a.presetID}],translation:a.presetName},o=[];for(let n=0;n<a.elements.length;n++){let l=a.elements[n];if(l.hasOwnProperty("colorGlobalGroup")){let{colorGlobalGroup:c}=l;c>0&&o.indexOf(c)===-1&&o.push(c)}}if(o.length){o.sort((n,l)=>n-l);for(let n=0;n<o.length;n++)s.params.push({type:"color_item",name:`color_value_${o[n]}`,defaultValue:-1})}i.push(s)}}this.menuData=[{id:"lens_flares",name:"Lens Flare",graphic:"tba",presets:i}];for(let e=0;e<this.menuData.length;e++){let t=this.menuData[e];for(let r=0;r<t.presets.length;r++){let a=t.presets[r];BFN.toolViewstates[`${t.id}_${a.id}`]=BFN.PhotoEditorCanvasModelViewStates.VIEWING_LENS_FLARE}}};_r.prototype.initAssets=function(){this.assets={},this.assetIDs=[];for(let i=0;i<this.assetData.length;i++){let e=this.assetData[i];for(let t=0;t<e.assets.length;t++){let r=e.assets[t],a=new BFN.LensFlareAssetVO;a.categoryID=e.categoryID,a.assetID=r.assetID,a.static=r.static,a.imageURL=`${this.assetPath+a.categoryID}/images/${a.assetID}.jpg`,a.thumbURL=`${this.assetPath+a.categoryID}/thumbs/${a.assetID}.jpg`,this.assets[a.assetID]=a,this.assetIDs.push(a.assetID)}}};BFN.lensFlarePresetMap={};_r.prototype.initPresets=function(){this.presets={},this.presetIDs=[];for(let i=0;i<this.presetData.length;i++){let e=this.presetData[i];for(let t=0;t<e.presets.length;t++){let r=e.presets[t],a=new BFN.LensFlarePresetVO;a.presetID=r.presetID,a.presetName=r.presetName,a.isPlus=r.isPlus;for(let s=0;s<r.elements.length;s++){let o=r.elements[s],n=new BFN.LensFlareElementVO;for(let l in o)n.setProperty(l,o[l]);a.elementVOs.push(n)}this.presets[a.presetID]=a,this.presetIDs.push(a.presetID),BFN.lensFlarePresetMap[`lens_flares_lens_flare_${a.presetID}`]=a.presetID}}};BFN.SingletonQueue.add(()=>{BFN.LensFlareData=new _r});var Th=class{constructor(){this.init()}init(){BFN.OverlaysData={}}load(){let e=`overlays-data${BFN.assetsDataVersions.overlays_data}.json`,t=`${BFN.overlaysUrl}${e}`;return BFN.IndexedDB.getFile("overlays",BFN.folderNames.overlays+e,t).then(r=>{r["overlays-data"].forEach(s=>{BFN.OverlaysData[s.id]=s})},r=>{BeFunky.logError("Unable to get overlays data from IndexedDB or server",r)})}};BFN.SingletonQueue.add(()=>{BFN.OverlaysDataLoader=new Th});var Fh=class{constructor(){this.init()}init(){BFN.PatternsData={}}load(e){let t=`patterns-data${BFN.assetsDataVersions.patterns_data}.json`,r=`${BFN.assetsDataURL}${t}`;BFN.IndexedDB.getFile("patterns",BFN.folderNames.patterns+t,r).then(a=>{if(!a.hasOwnProperty("patterns-data"))return BeFunky.logError("Patterns data missing 'patterns-data' property",a);a["patterns-data"].forEach(o=>{BFN.PatternsData[o.id]=o}),e&&e(!0)}).catch(a=>{BeFunky.logError("Unable to get patterns data from IndexedDB or server",a||"")})}};BFN.SingletonQueue.add(()=>{BFN.PatternsDataLoader=new Fh});var bh=class{constructor(){this.init()}init(){this.initDefaultValues()}initDefaultValues(){this.fetchingLayoutsPromise=null,this.templateCategories=[]}loadTemplateData({showLoadScreen:e=!0}={}){return e&&BeFunky.showLoadScreen(),this.fetchingLayoutsPromise?this.fetchingLayoutsPromise:(this.fetchingLayoutsPromise=new Promise((t,r)=>{let a=`${BFN.assetsURL}datas/collage_layouts_data_v2.json`;BeFunky.request(a,{},({response:s,error:o})=>{if(e&&BeFunky.hideLoadScreen(),o)return this.fetchingLayoutsPromise=null,r(o);this.templateCategories=s,this.setupTemplates(),t()})}),this.fetchingLayoutsPromise)}setupTemplates(){this._templateCategoryVOs=[];let e=["big_rectangle_3_square_right","grid17","grid18","grid19","3x3_square","grid22","grid28","grid37","big_rectangle_6_square_all","big_rectangle_6_square_left_bottom","overlay1","big_photo_15","big_photo_17","big_photo_24","fb7","fb16","pin2","pin4","pin8"],t=new BFN.TemplateCategoryVO;t.id="featured",t.name="Featured",t.graphic="collage_template_featured",this._templateCategoryVOs.push(t),this.templateCategories.forEach(v=>{let T=new BFN.TemplateCategoryVO;T.id=v.id,T.name=v.name,T.graphic=v.graphic,this._templateCategoryVOs.push(T),v.presets.forEach(x=>{let B=new BFN.TemplateVO;B.name=x.name,B.categoryID=T.id,B.isPlus=x.hasOwnProperty("isPlus")&&x.isPlus==1,B.preset=x,T.templateVOs.push(B),e.includes(B.name)&&t.templateVOs.push(B)})});let r=[].concat(...this._templateCategoryVOs.slice(1).map(({templateVOs:v})=>v)),a=68,s=2,o=a*s,n=o/4,l=4,c=n+l,h=o-l,u=3,d=a-l/2,m=d/h,p=h*u+c*(u-1)+l,g=h*Math.ceil(r.length/u)+c*Math.floor(r.length/u)+l;p*=m,g*=m;let f=`${p}px ${g}px`;r.forEach((v,T)=>{let x=(h+c)*(T%u),B=(h+c)*Math.floor(T/u);v.spritePosition=`-${x*m}px -${B*m}px`,v.spriteSize=f})}get templateCategoryVOs(){return this._templateCategoryVOs}};BFN.SingletonQueue.add(function(){BFN.CollageMakerTemplateData=new bh});BFN.FontOffsetVectors={"Abril Fatface":{distance:17.11724276862369,direction:1.687905071361761},Alegreya:{distance:12.165525060596439,direction:1.7359450042095235},"Alegreya Sans":{distance:10.198039027185569,direction:-1.7681918866447774},Amaranth:{distance:15.132745950421556,direction:-1.7033478590915707},"Amatic SC":{distance:13.038404810405298,direction:1.6475682180646747},Amble:{distance:13.152946437965905,direction:-1.7234456551901618},"Anonymous Pro":{distance:8.246211251235321,direction:-1.8157749899217608},"Architects Daughter":{distance:9.055385138137417,direction:-1.6814535479687924},Arizonia:{distance:2,direction:3.141592653589793},"The Art of Illuminating":{distance:17.11724276862369,direction:-1.687905071361761},Arvo:{distance:13.152946437965905,direction:-1.7234456551901618},"Bear and Loupe":{distance:15.132745950421556,direction:-1.7033478590915707},"Bebas Neue":{distance:15.132745950421556,direction:-1.7033478590915707},Bellota:{distance:2.23606797749979,direction:-2.677945044588987},"Berkshire Swash":{distance:8.246211251235321,direction:1.8157749899217608},Boogaloo:{distance:5.385164807134504,direction:1.9513027039072617},"Bookman Old Style":{distance:17.11724276862369,direction:-1.687905071361761},"Bowlby One":{distance:21.213203435596427,direction:1.7126933813990606},"Brush Script MT":{distance:29.017236257093817,direction:-1.6052654277944047},Cabin:{distance:8.06225774829855,direction:1.6951513213416582},"Capture It":{distance:17.26267650163207,direction:-1.7454685258031364},"Carbon Type":{distance:17.029386365926403,direction:-1.6295521495106193},Carrington:{distance:3.605551275463989,direction:-2.1587989303424644},"Caviar dreams":{distance:12.165525060596439,direction:-1.7359450042095235},ChunkFive:{distance:14.142135623730951,direction:-1.7126933813990606},"Claire Hand":{distance:19.1049731745428,direction:-1.6756732655251305},"Comic Sans MS":{distance:10.198039027185569,direction:-1.7681918866447774},Cookie:{distance:12.041594578792296,direction:-1.653937558683338},"Crass Roots":{distance:3.605551275463989,direction:-2.1587989303424644},"Dancing Script":{distance:19,direction:-1.5707963267948966},"Deutsch Gothic":{distance:11.180339887498949,direction:-1.750649826587375},Edo:{distance:17.11724276862369,direction:-1.687905071361761},"Eutemia I":{distance:16.1245154965971,direction:-1.6951513213416582},Exo:{distance:9.055385138137417,direction:-1.6814535479687924},Forque:{distance:19.1049731745428,direction:-1.6756732655251305},"Free Universal":{distance:10.198039027185569,direction:-1.7681918866447774},"Frente H1":{distance:10.198039027185569,direction:-1.7681918866447774},Georgia:{distance:14.142135623730951,direction:-1.7126933813990606},"Good Foot":{distance:2.23606797749979,direction:2.677945044588987},"Gothic Ultra":{distance:14.142135623730951,direction:-1.7126933813990606},Gputeks:{distance:10.198039027185569,direction:-1.7681918866447774},"Grand Hotel":{distance:5.385164807134504,direction:1.9513027039072617},"Great Vibes":{distance:4.47213595499958,direction:-2.0344439357957027},Handserif:{distance:17.11724276862369,direction:-1.687905071361761},Harting:{distance:12.165525060596439,direction:-1.7359450042095235},Helsinki:{distance:17.029386365926403,direction:-1.6295521495106193},"Henry Morgan Hand":{distance:2.23606797749979,direction:-2.677945044588987},"Holitter Gothic":{distance:16.0312195418814,direction:-1.633215136790854},Hominis:{distance:10.198039027185569,direction:-1.7681918866447774},"HVD Comic Serif Pro":{distance:15.132745950421556,direction:-1.7033478590915707},Idolwild:{distance:2.8284271247461903,direction:-2.356194490192345},Inkcalig:{distance:17.029386365926403,direction:-1.6295521495106193},Itsadzoke:{distance:4.123105625617661,direction:-1.8157749899217608},"Josefin Slab":{distance:14.142135623730951,direction:-1.7126933813990606},Karla:{distance:2.8284271247461903,direction:2.356194490192345},Kawoszeh:{distance:16.0312195418814,direction:-1.633215136790854},"Kingthings Trypewriter":{distance:16.1245154965971,direction:-1.6951513213416582},"Komika Axis":{distance:2.8284271247461903,direction:-2.356194490192345},"La Belle Aurore":{distance:20.09975124224178,direction:-1.6704649792860586},Langdon:{distance:15.132745950421556,direction:-1.7033478590915707},Lato:{distance:9.219544457292887,direction:-1.7894652726688387},"League Gothic":{distance:15.132745950421556,direction:-1.7033478590915707},"Leckerli One":{distance:14.142135623730951,direction:-1.7126933813990606},"Lobster Two":{distance:10.198039027185569,direction:1.7681918866447774},"Londrina Outline":{distance:15,direction:-1.5707963267948966},"Londrina Shadow":{distance:16.0312195418814,direction:-1.633215136790854},"Londrina Sketch":{distance:16.0312195418814,direction:-1.633215136790854},"Londrina Solid":{distance:17.029386365926403,direction:-1.6295521495106193},"Luckiest Guy":{distance:19.1049731745428,direction:-1.6756732655251305},"Maiden Orange":{distance:20.09975124224178,direction:-1.6704649792860586},"Mathlete Bulky":{distance:10.198039027185569,direction:-1.7681918866447774},Merriweather:{distance:9.219544457292887,direction:1.7894652726688387},Miama:{distance:13.038404810405298,direction:-1.6475682180646747},Montserrat:{distance:8.246211251235321,direction:1.8157749899217608},"Myriad Pro":{distance:15.132745950421556,direction:-1.7033478590915707},"My Underwood":{distance:15.132745950421556,direction:-1.7033478590915707},Niconne:{distance:4.47213595499958,direction:2.0344439357957027},Norwester:{distance:10.198039027185569,direction:-1.7681918866447774},Odstemplik:{distance:19.1049731745428,direction:-1.6756732655251305},Okolaks:{distance:11.180339887498949,direction:-1.750649826587375},"Old Standard TT":{distance:14.142135623730951,direction:-1.7126933813990606},"Open Sans":{distance:12.165525060596439,direction:-1.7359450042095235},"Ostrich Sans":{distance:14.142135623730951,direction:-1.7126933813990606},Oswald:{distance:19.4164878389476,direction:1.7782925532300993},Overlock:{distance:8.246211251235321,direction:1.8157749899217608},Pacifico:{distance:50.00999900019995,direction:1.5907936607680473},Palitoon:{distance:10.198039027185569,direction:-1.7681918866447774},"Pix Antiqua":{distance:8.246211251235321,direction:-1.8157749899217608},"Playfair Display":{distance:19.1049731745428,direction:1.6756732655251305},Quicksand:{distance:5.385164807134504,direction:1.1902899496825317},Raleway:{distance:5.385164807134504,direction:1.9513027039072617},Roboto:{distance:14.142135623730951,direction:-1.7126933813990606},"Roboto Slab":{distance:16.1245154965971,direction:1.6951513213416582},"Rock Salt":{distance:9.219544457292887,direction:-1.7894652726688387},Sacramento:{distance:4.47213595499958,direction:2.0344439357957027},"Sigmar One":{distance:28.071337695236398,direction:1.642103791580187},Silkscreen:{distance:15.132745950421556,direction:-1.7033478590915707},Sofia:{distance:24.08318915758459,direction:1.653937558683338},"Spicy Rice":{distance:12.165525060596439,direction:1.7359450042095235},"Teen Light":{distance:12.041594578792296,direction:-1.653937558683338},Teen:{distance:12.165525060596439,direction:-1.7359450042095235},Temporarium:{distance:13.152946437965905,direction:-1.7234456551901618},"Times New Roman":{distance:21.095023109728988,direction:-1.665748033137653},"Trebuchet MS":{distance:16.1245154965971,direction:-1.6951513213416582},Ubuntu:{distance:12.041594578792296,direction:-1.653937558683338},"Varela Round":{distance:5.385164807134504,direction:2.761086276477428},Vavont:{distance:10.198039027185569,direction:-1.7681918866447774},Veggieburger:{distance:7.280109889280518,direction:-1.849095985800008},Verdana:{distance:12.165525060596439,direction:-1.7359450042095235},Vollkorn:{distance:19.1049731745428,direction:-1.6756732655251305},Yellowtail:{distance:7.0710678118654755,direction:1.7126933813990606},"Adobe Caslon Pro":{distance:16.1245154965971,direction:-1.6951513213416582},"Adobe Devanagari":{distance:18.24828759089466,direction:-1.7359450042095235},"Adobe Garamond Pro":{distance:17.11724276862369,direction:-1.687905071361761},"Adobe Gurmukhi":{distance:15.297058540778355,direction:-1.7681918866447774},"Al Nile":{distance:21.213203435596427,direction:-1.7126933813990606},"American Typewriter":{distance:22.090722034374522,direction:-1.661456213995642},"Andale Mono":{distance:20.09975124224178,direction:-1.6704649792860586},"Apple Chancery":{distance:11.180339887498949,direction:-1.750649826587375},"Apple Color Emoji":{distance:21.213203435596427,direction:-1.7126933813990606},"Apple Symbols":{distance:23.08679276123039,direction:-1.6575346654708818},Arial:{distance:18.027756377319946,direction:-1.6262948320406136},"Arial Black":{distance:19.1049731745428,direction:-1.6756732655251305},"Arial Hebrew":{distance:21.213203435596427,direction:-1.7126933813990606},"Arial Hebrew Scholar":{distance:21.213203435596427,direction:-1.7126933813990606},"Arial Narrow":{distance:18.027756377319946,direction:-1.6262948320406136},"Arial Rounded MT Bold":{distance:18.110770276274835,direction:-1.6814535479687924},"Arial Unicode MS":{distance:18.027756377319946,direction:-1.6262948320406136},Ayuthaya:{distance:17.11724276862369,direction:1.687905071361761},"Bangla MN":{distance:4.47213595499958,direction:-2.0344439357957027},"Bangla Sangam MN":{distance:19.1049731745428,direction:-1.6756732655251305},Baskerville:{distance:3,direction:3.141592653589793},"Birch Std":{distance:16.1245154965971,direction:-1.6951513213416582},"Blackoak Std":{distance:16.1245154965971,direction:-1.6951513213416582},"Bodoni Ornaments":{distance:10.44030650891055,direction:-1.8622531212727638},Chalkboard:{distance:7.280109889280518,direction:1.849095985800008},Chalkduster:{distance:8.246211251235321,direction:1.8157749899217608},"Chaparral Pro":{distance:17.11724276862369,direction:-1.687905071361761},Cochin:{distance:19.1049731745428,direction:-1.6756732655251305},Copperplate:{distance:13.152946437965905,direction:-1.7234456551901618},"Corsiva Hebrew":{distance:21.213203435596427,direction:-1.7126933813990606},"Courier New":{distance:28.071337695236398,direction:-1.642103791580187},"Devanagari MT":{distance:21.213203435596427,direction:-1.7126933813990606},"Devanagari Sangam MN":{distance:8.06225774829855,direction:-1.6951513213416582},Didot:{distance:3.605551275463989,direction:2.1587989303424644},"Euphemia UCAS":{distance:13.152946437965905,direction:-1.7234456551901618},Geneva:{distance:11.180339887498949,direction:-1.750649826587375},"Gill Sans":{distance:21.095023109728988,direction:-1.665748033137653},"Gujarati MT":{distance:21.213203435596427,direction:-1.7126933813990606},"Gujarati Sangam MN":{distance:24.08318915758459,direction:1.653937558683338},"Gurmukhi MN":{distance:14.142135623730951,direction:-1.7126933813990606},"Gurmukhi MT":{distance:21.213203435596427,direction:-1.7126933813990606},"Gurmukhi Sangam MN":{distance:15.132745950421556,direction:-1.7033478590915707},Helvetica:{distance:16.1245154965971,direction:-1.6951513213416582},"Helvetica Neue":{distance:6.324555320336759,direction:1.892546881191539},Herculanum:{distance:2.8284271247461903,direction:2.356194490192345},"Hoefler Text":{distance:4.47213595499958,direction:2.0344439357957027},Impact:{distance:12.165525060596439,direction:-1.7359450042095235},InaiMathi:{distance:23.08679276123039,direction:-1.6575346654708818},"Kannada MN":{distance:14.142135623730951,direction:-1.7126933813990606},"Kannada Sangam MN":{distance:22.090722034374522,direction:-1.661456213995642},"Khmer MN":{distance:20.09975124224178,direction:-1.6704649792860586},"Khmer Sangam MN":{distance:22.02271554554524,direction:1.6162196062164738},"Kohinoor Bangla":{distance:15.033296378372908,direction:1.6373644905707205},"Kohinoor Telugu":{distance:15.033296378372908,direction:1.6373644905707205},Krungthep:{distance:10.198039027185569,direction:1.7681918866447774},"Lao MN":{distance:8.246211251235321,direction:-1.8157749899217608},"Lao Sangam MN":{distance:15.033296378372908,direction:-1.6373644905707205},"Lithos Pro":{distance:17.11724276862369,direction:-1.687905071361761},"Lucida Grande":{distance:11.045361017187261,direction:-1.661456213995642},Luminari:{distance:8.246211251235321,direction:1.8157749899217608},"Malayalam MN":{distance:14.142135623730951,direction:-1.7126933813990606},"Malayalam Sangam MN":{distance:9.219544457292887,direction:-1.7894652726688387},"Microsoft Sans Serif":{distance:18.027756377319946,direction:-1.6262948320406136},"Minion Pro":{distance:17.26267650163207,direction:-1.7454685258031364},Mshtakan:{distance:21.213203435596427,direction:-1.7126933813990606},"Myanmar MN":{distance:5.385164807134504,direction:-1.9513027039072617},"Myanmar Sangam MN":{distance:15.033296378372908,direction:-1.6373644905707205},"Myriad Arabic":{distance:23.08679276123039,direction:-1.6575346654708818},"Myriad Hebrew":{distance:15.132745950421556,direction:-1.7033478590915707},"New Peninim MT":{distance:21.213203435596427,direction:-1.7126933813990606},"OCR A Std":{distance:13.152946437965905,direction:-1.7234456551901618},"Oriya MN":{distance:14.142135623730951,direction:-1.7126933813990606},"Oriya Sangam MN":{distance:10.198039027185569,direction:-1.7681918866447774},Palatino:{distance:8.246211251235321,direction:-1.8157749899217608},Papyrus:{distance:3.605551275463989,direction:2.1587989303424644},"Plantagenet Cherokee":{distance:21.095023109728988,direction:-1.665748033137653},"PT Mono":{distance:13.152946437965905,direction:-1.7234456551901618},"PT Sans":{distance:15.033296378372908,direction:-1.6373644905707205},"PT Sans Caption":{distance:15.033296378372908,direction:-1.6373644905707205},"PT Sans Narrow":{distance:15.132745950421556,direction:-1.7033478590915707},"PT Serif":{distance:13.341664064126334,direction:-1.7975951748487826},"PT Serif Caption":{distance:13.341664064126334,direction:-1.7975951748487826},Raanana:{distance:21.213203435596427,direction:-1.7126933813990606},Sathu:{distance:2.23606797749979,direction:2.677945044588987},Seravek:{distance:2.23606797749979,direction:2.0344439357957027},"SignPainter-HouseScript":{distance:20.09975124224178,direction:-1.6704649792860586},Silom:{distance:5.385164807134504,direction:1.9513027039072617},"Sinhala MN":{distance:9.219544457292887,direction:-1.7894652726688387},"Sinhala Sangam MN":{distance:12.041594578792296,direction:1.653937558683338},"Snell RoundHand":{distance:21.095023109728988,direction:-1.665748033137653},"Source Sans Pro":{distance:16.1245154965971,direction:-1.6951513213416582},"STIXGeneral-Bold":{distance:15.132745950421556,direction:-1.7033478590915707},"STIXGeneral-BoldItalic":{distance:15.132745950421556,direction:-1.7033478590915707},"STIXGeneral-Italic":{distance:16.1245154965971,direction:-1.6951513213416582},"STIXGeneral-Regular":{distance:15.132745950421556,direction:-1.7033478590915707},"STIXVariants-Regular":{distance:21.213203435596427,direction:-1.7126933813990606},STSong:{distance:5.385164807134504,direction:-1.9513027039072617},Symbol:{distance:21.213203435596427,direction:-1.7126933813990606},Tahoma:{distance:13.152946437965905,direction:-1.7234456551901618},"Tamil MN":{distance:2.23606797749979,direction:-2.677945044588987},"Tamil Sangam MN":{distance:54.037024344425184,direction:-1.6078164426688268},"Telugu MN":{distance:14.142135623730951,direction:-1.7126933813990606},"Telugu Sangam MN":{distance:16.1245154965971,direction:-1.6951513213416582},Thonburi:{distance:5.385164807134504,direction:1.9513027039072617},Trattatello:{distance:15.132745950421556,direction:-1.7033478590915707},Webdings:{distance:11.40175425099138,direction:-1.837048375945822},Wingdings:{distance:7.280109889280518,direction:-1.849095985800008},Zapfino:{distance:80.05623023850174,direction:1.6082787634865583}};BFN.AppModelViewStates={VIEWING_PHOTO_EDITOR:"VIEWING_PHOTO_EDITOR",VIEWING_COLLAGE_MAKER:"VIEWING_COLLAGE_MAKER",VIEWING_DESIGNER:"VIEWING_DESIGNER"};BFN.AppModelEvents={APP_READY:new Event("APP_READY"),APP_COMPLETE:new Event("APP_COMPLETE"),VIEWSTATE_UPDATED:new Event("VIEWSTATE_UPDATED")};var Bh=class extends BFN.EventDispatcher{constructor(){super();this.init()}init(){BeFunky.log("AppModel Init"),this.initViewState(),this.initDefaultValues(),this.appReady=!1,window.addEventListener("INIT",()=>{this.appReady=!0,this.dispatchEvent(BFN.AppModelEvents.APP_READY)}),window.addEventListener("INIT_COMPLETE",()=>{this.dispatchEvent(BFN.AppModelEvents.APP_COMPLETE)})}initDefaultValues(){}initViewState(){this.viewStateChangeReason=null;let{type:e}=window.currentDeepLinkParameters||{};e==="collage"?this._viewState=BFN.AppModelViewStates.VIEWING_COLLAGE_MAKER:e==="designer"?this._viewState=BFN.AppModelViewStates.VIEWING_DESIGNER:(this._viewState=BFN.AppModelViewStates.VIEWING_PHOTO_EDITOR,e||BeFunky.throwError("Missing currentDeepLinkParameters",window.currentDeepLinkParameters)),window.addEventListener("INIT_COMPLETE",()=>{setTimeout(()=>{this.changeAppSection(window.currentDeepLinkParameters.type)},0)})}changeAppSection(e){e==="collage"?BFN.AppModel.viewState=BFN.AppModelViewStates.VIEWING_COLLAGE_MAKER:e==="designer"?BFN.AppModel.viewState=BFN.AppModelViewStates.VIEWING_DESIGNER:BFN.AppModel.viewState=BFN.AppModelViewStates.VIEWING_PHOTO_EDITOR}handleAppGoto(){switch(UITools.getToolVO("app_goto").updating_id){case"photo_editor":this.viewStateChangeReason="Top Menu",this.changeAppSection("editor");break;case"collage_maker":this.viewStateChangeReason="Top Menu",this.changeAppSection("collage");break;case"designer":this.viewStateChangeReason="Top Menu",this.changeAppSection("designer");break;case"edit_source_section":BFN.ImageEditManager.targetViewstate&&(this.viewState=BFN.ImageEditManager.targetViewstate);break}this.viewStateChangeReason=null}isFullScreen(){return!!(document.fullscreenElement||document.webkitFullscreenElement||document.mozFullScreenElement||document.msFullscreenElement)}toggleFullscreen(){if(this.isFullScreen()){this.exitFullscreen();return}if(BFN.BfnService.userIsPlus||BeFunky.isMobile){BFN.BfnService.track("CREATE","TOOLBAR","FULLSCREEN"),this.showFullscreen();return}BFN.BfnService.track("CREATE","TOOLBAR","FULLSCREEN_PREVIEW"),BeFunky.confirm("confirm_fullscreen_mode",{onConfirm:()=>{this.showFullscreen(),setTimeout(()=>{this.isFullScreen()&&this.exitFullscreen()},1e4)},confirmText:"yes",cancelText:"no"})}showFullscreen(){let e=document.documentElement,t=e.requestFullScreen||e.webkitRequestFullScreen||e.mozRequestFullScreen;t&&t.call(e)}exitFullscreen(){let e=document,t=e.cancelFullScreen||e.webkitCancelFullScreen||e.mozCancelFullScreen||e.exitFullscreen;t&&t.call(e),BFN.BfnService.userIsPlus||setTimeout(()=>{UIMessages.display("confirm_fullscreen_mode_message",1e3)},500)}sectionValue(e,t,r){if(this.viewingEditor)return e;if(this.viewingCollage)return t;if(this.viewingDesigner)return r;BeFunky.throwError("sectionValue called to early")}getSectionValue(e=null,t=null,r=null,a=null){switch(e){case"editor":case BFN.AppModelViewStates.VIEWING_PHOTO_EDITOR:return t;case"collage":case BFN.AppModelViewStates.VIEWING_COLLAGE_MAKER:return r;case"designer":case BFN.AppModelViewStates.VIEWING_DESIGNER:return a}return null}getAppTextureMemoryMB(){let t=[].concat(...Object.values(BFN.Stage.filterManager.pool)).map(s=>s.texture).reduce((s,o)=>s+o.width*o.height,0),r=BFN.Util.bytesToMB(t),a=BFN.Util.getBaseTexturesMemoryMB(BFN.Stage.textureManager._managedTextures);return r+a}set viewState(e){if(BFN.ImageEditManager.editingImage&&this._viewState===BFN.AppModelViewStates.VIEWING_PHOTO_EDITOR&&e!==BFN.AppModelViewStates.VIEWING_PHOTO_EDITOR){BFN.ImageEditManager.overrideSetAppViewState(e);return}if(BFN.TransformItemIsolator.active){BFN.TransformModel.isolatorEditComplete();return}this._viewState=e,BeFunky.setLocal("lastAppSection",BFN.AppModel.sectionValue("Photo Editor","Collage Maker","Designer"));let t=BeFunky.LanguageManager.language.app,r;t==="es"?r=this.sectionValue("es/crear","es/crear/collage","es/crear/disenador"):t==="pt"?r=this.sectionValue("pt/criar","pt/criar/colagem","pt/criar/design"):t==="de"?r=this.sectionValue("de/erstellen","de/erstellen/collagen","de/erstellen/designer"):t==="fr"?r=this.sectionValue("fr/creer","fr/creer/collage","fr/creer/designer"):r=this.sectionValue("create","create/collage","create/designer");let{type:a}=window.currentDeepLinkParameters;BeFunky.isCreateRoute()?this.viewingEditor&&["collage","designer"].includes(a)?(BeFunky.pushRoute(r),window.currentDeepLinkParameters={type:"photoeditor"}):this.viewingCollage&&a!=="collage"?(BeFunky.pushRoute(r),window.currentDeepLinkParameters={type:"collage"}):this.viewingDesigner&&a!=="designer"&&(BeFunky.pushRoute(r),window.currentDeepLinkParameters={type:"designer"}):BeFunky.reportWarning("App section changed when user is not in create route",window.location.href,window.isAppOpen);let s=BeFunky.getCurrentRoute(),o=c=>c.split("?")[0].split("#")[0],n=this.sectionValue("photo_editor","collage_maker","graphic_designer"),l=BeFunky.LanguageManager.getString(n);BeFunky.isInstalled()?document.title=`${l} | BeFunky`:o(BeFunky.initialRoute)===o(s)?document.title=BeFunky.originalPageTitle:document.title.includes("|")&&(document.title=`${l} |${document.title.split("|").slice(1).join("|")}`),BeFunky.setSentryTag("app_section",this.sectionID),this.dispatchEvent(BFN.AppModelEvents.VIEWSTATE_UPDATED)}get viewState(){return this._viewState}get viewingEditor(){return this._viewState===BFN.AppModelViewStates.VIEWING_PHOTO_EDITOR}get viewingCollage(){return this._viewState===BFN.AppModelViewStates.VIEWING_COLLAGE_MAKER}get viewingDesigner(){return this._viewState===BFN.AppModelViewStates.VIEWING_DESIGNER}get sectionID(){return this.sectionValue("editor","collage","designer")}};BFN.SingletonQueue.add(()=>{BFN.AppModel=new Bh});BFN.StageModelEvents={STAGE_DIMENSIONS_UPDATED:new Event("STAGE_DIMENSIONS_UPDATED")};var Sh=class extends BFN.EventDispatcher{constructor(){super();this.init()}init(){BeFunky.log("StageModel Init"),this.appStage=document.getElementById("appStage");let e=this.appStage.getBoundingClientRect();this._stageW=e.width,this._stageH=e.height,this.appViewport=document.getElementById("appViewport"),PIXI.settings.MIPMAP_TEXTURES=!1,window.webglUnmaskedRenderer&&(console.log(`GRAPHIC: ${window.webglUnmaskedRenderer}`),navigator.deviceMemory&&BeFunky.setSentryTag("memory",`${navigator.deviceMemory}GB`));try{BFN.Stage=new PIXI.WebGLRenderer(Math.ceil(BFN.appRect.width-BFN.leftMenuMinimumWidth),Math.ceil(BFN.appRect.height-BFN.topNavBarHeight),{transparent:!0,autoResize:!0,preserveDrawingBuffer:!BeFunky.Params.isBeta,antialias:!1,resolution:window.bfn_resolution?window.bfn_resolution:1})}catch(r){return BeFunky.logError(`WebGL is unavailable. Telling user... ${BeFunky.stringValue(r)}`),this.handleWebGLUnavailable()}this.appStage.appendChild(BFN.Stage.view),BFN.Stage.view.oncontextmenu=()=>!1;try{BFN.Stage.gl.getExtension("OES_standard_derivatives")}catch(r){}BFN.Stage.state&&(BFN.Stage.state.blendModes[21]=[WebGLRenderingContext.ONE_MINUS_DST_COLOR,WebGLRenderingContext.ONE_MINUS_SRC_COLOR,1,1],BFN.Stage.state.blendModes[22]=[WebGLRenderingContext.ONE,WebGLRenderingContext.ONE_MINUS_SRC_ALPHA,1,1],BFN.Stage.state.blendModes[23]=[WebGLRenderingContext.ONE,WebGLRenderingContext.ONE_MINUS_SRC_ALPHA,1,1],BFN.Stage.state.blendModes[24]=[WebGLRenderingContext.ONE,WebGLRenderingContext.ONE_MINUS_SRC_ALPHA,1,1]),BFN.renderTexturesPool||BFN.Util.createRenderTexturePool(),this.debouncedResize=BeFunky.debounce(this.debouncedResize.bind(this),250),this.updatePixiRectangle(),BFN.Stage.view.addEventListener("webglcontextlost",this.handleWebGLContextLost.bind(this)),BFN.PIXITicker=PIXI.ticker.shared,BFN.PIXITicker.autoStart=!1,BFN.PIXITicker.stop(),BFN.PIXITicker.keepRunning=!1,BFN.PIXITicker.stopPending=!1,BFN.PIXITicker.nudge=function(){BFN.PIXITicker.started||BFN.PIXITicker.start(),BFN.PIXITicker.stopPending=!0,BFN.PIXITicker.completeNudge()},BFN.PIXITicker.completeNudge=BeFunky.debounce(()=>{BFN.PIXITicker.keepRunning||BFN.PIXITicker.stop(),BFN.PIXITicker.stopPending=!1},500),this.updateRendererDimensions(),this.setRefreshFactor(1),BFN.AppModel.addEventListener(BFN.AppModelEvents.APP_READY.type,this.handleAppReady.bind(this)),BFN.BfnService.addEventListener(BFN.BfnServiceEvents.CUSTOM_RESIZE_EVENT.type,()=>setTimeout(()=>{this.updateStageDimensions(),this.updateAppViewportDimensions()},0)),this.appStageContainer=document.getElementById("canvas_container");let t=({name:r,hex:a})=>{this.appStage.setStyles({backgroundColor:`#${BFN.ColorUtil.hexNumberToHexString(a)}`}),this.appStageContainer.setClass(`canvas canvas--${r}`)};t(ht()),ui(t)}debouncedResize(){requestAnimationFrame(()=>{this.updateRendererDimensions()})}updateStageDimensions(e=!1){let t=BFN.appViewportRect;t.width<1&&t.height<1||(this.debouncedResize(),!(!e&&this._stageH===t.height&&this._stageW===t.width)&&(BFN.MainUI.x=t.left-BFN.leftMenuMinimumWidth,BFN.MainUI.y=0,this._stageW=t.width,this._stageH=t.height,this.dispatchEvent(BFN.StageModelEvents.STAGE_DIMENSIONS_UPDATED)))}updateAppViewportDimensions(){BFN.StageModel.appViewport.setStyles({left:`${BFN.getAppViewportLeftOffset(!0)}px`,bottom:`${BFN.getAppViewportBottomOffset(!0)}px`})}updatePixiRectangle(e){let{width:t=BFN.appRect.width-BFN.leftMenuMinimumWidth,height:r=BFN.appRect.height-BFN.topNavBarHeight-BFN.bottomMenuMinimumHeight}=e||{},a=BFN.appRect.top+BFN.topNavBarHeight,s=BFN.leftMenuMinimumWidth,o={width:t,height:r,top:a,y:a,left:s,x:s,bottom:r+a,right:t+s};if(BeFunky.Params.IS_LC){let n=this.appStage.getBoundingClientRect();Object.keys(o).forEach(l=>{Math.round(o[l])!==Math.round(n[l])&&BeFunky.logWarning("befunkyCanvasRect outdated",l,o[l],n[l])})}try{BFN.Stage.plugins.interaction.befunkyCanvasRect=o}catch(n){}}updateRendererDimensions(){let e={width:BFN.appRect.width-BFN.leftMenuMinimumWidth,height:BFN.appRect.height-BFN.topNavBarHeight-BFN.bottomMenuMinimumHeight};(e.width*BFN.Stage.resolution!==BFN.Stage.width||e.height*BFN.Stage.resolution!==BFN.Stage.height)&&(BFN.Stage.resize(Math.ceil(e.width),Math.ceil(e.height)),this.updatePixiRectangle(e),BFN.MainUI&&(BFN.MainUI.renderCanvas(),BFN.MainUI.renderCanvas()))}setRefreshFactor(e){this._refreshFactor!==e&&(BeFunky.log(`SETTING REFRESH FACTOR : ${e}`),this._refreshFactor=e,BFN.frameRate=Math.round(BFN.baseFrameRate*this._refreshFactor),BFN.frameInterval=Math.round(1e3/BFN.frameRate))}handleAppReady(){this.updateStageDimensions(!0)}handleWebGLUnavailable(){window.onbeforeunload=null,["editor","collage","designer"].forEach(r=>{BeFunky.setLocal(`force_use_autosave__${r}`,"true")}),e(),t();function e(){let r;BeFunky.isChrome?r="Chrome":BeFunky.isFirefox?r="Firefox":BeFunky.isSafari?r="Safari":BeFunky.isEdge?r="Microsoft Edge":r=BeFunky.LanguageManager.getString("your_browser");let a="error_webgl_unavailable",s={your_browser:r,alternate_browser:BeFunky.isChrome?"Firefox":"Chrome",contact_support:BeFunky.toLinkHTML("SUPPORT",!0)};BeFunky.acknowledge([a,s],{isCritical:!0,disableClose:!0}),BeFunky.logError("User message:",BeFunky.LanguageManager.getStringReplacements(a,s))}function t(){let r="webgl unavailable during app initialization";throw document.visibilityState!=="visible"?new Error(`${r} - tab not visible`):BFN.tabRecentlyReopened?new Error(`${r} - tab recently re-opened`):new Error(r)}}handleWebGLContextLost(){BeFunky.webglContextWasLost=!0,BeFunky.logError("webglTextureSize:",window.webglTextureSize);try{if(typeof window.webglUnmaskedRenderer!="undefined"){BeFunky.logError("webglUnmaskedRenderer: ",window.webglUnmaskedRenderer);try{BFN.BfnService.track("EXTERNAL","WEBGL_GRAPHIC_PROBLEM",window.webglUnmaskedRenderer)}catch(r){}}}catch(r){}BeFunky.logError(`Texture Memory: ${BFN.Util.getTotalTextureMemory()} MB`),navigator.deviceMemory&&BeFunky.logError(`Device Memory: ${navigator.deviceMemory} GB`),BeFunky.logError("appRect:",`${BFN.appRect.width} x ${BFN.appRect.height}`),BFN.AppModel.viewingEditor&&(BeFunky.logError("Current tool:",BFN.PhotoEditorCanvasModel.viewState),BeFunky.logError("Photo Editor canvas size:",`${BFN.PhotoEditorModel.currentTextureDimensions.width} x ${BFN.PhotoEditorModel.currentTextureDimensions.height}`)),Object.values(BFN.ProjectManager.autoSave).forEach(r=>{r.allowAutoSave=!1});try{window.onbeforeunload=null}catch(r){}["editor","collage","designer"].forEach(r=>{BeFunky.setLocal(`force_use_autosave__${r}`,"true")}),e(),t();function e(){let{sectionID:r}=BFN.AppModel,a=BFN.ProjectManager.autoSave[r].lastSaveLocation==="IndexedDB",s=window.failed_webgl_tests.includes("no_high_perf_canvas"),o=parseInt(BeFunky.getLocal("last_webgl_crash"))||0,n=Date.now();BeFunky.setLocal("last_webgl_crash",n.toString());let l=1e3*60*60*24*8,c=n-o<l,{html:h,appLang:u}=BeFunky.lit,d=()=>h`
                <p>${u("error_webglcontextlost")} ${u(a?"error_webglcontextlost_autosave":"")}</p>
                ${s?h`<p>${u(["error_webglcontextlost_low_perf",{learn_how_to_fix:BeFunky.toLinkHTML(BeFunky.getArticleForPerfIssue(),!0)}])}</p>`:""}
                <p>${u(["error_webglcontextlost_restart",{alternate_browser:BeFunky.isChrome?"Firefox":"Chrome"}])}</p>
                ${c?h`<p>${u(["optionally_contact_support",{contact_support:BeFunky.toLinkHTML("SUPPORT",!0)}])}</p>`:""}
            `;return BeFunky.openDialog({body:d,modalOptions:{isCritical:!0,disableClose:!0}})}function t(){let r="webgl context lost";throw setTimeout(()=>{console.log("Stop Sentry from sending further errors "),Sentry.captureException=()=>{},Sentry.getCurrentHub&&(Sentry.getCurrentHub().getClient().getOptions().enabled=!1)},0),document.visibilityState!=="visible"?new Error(`${r} - tab not visible`):BFN.tabRecentlyReopened?new Error(`${r} - tab recently re-opened`):new Error(r)}}get stageW(){return this._stageW}get stageH(){return this._stageH}get mouseX(){return BFN.Stage.plugins.interaction.mouse.global.x}get mouseY(){return BFN.Stage.plugins.interaction.mouse.global.y}};BFN.SingletonQueue.add(()=>{BFN.StageModel=new Sh});BFN.TransformModelEvents={TRANSFORM_ITEM_UPDATED:new Event("TRANSFORM_ITEM_UPDATED"),TRANSFORM_ITEM_TEXT_UPDATED:new Event("TRANSFORM_ITEM_TEXT_UPDATED")};function _t(){BFN.EventDispatcher.call(this),this.init()}_t.prototype=Object.create(BFN.EventDispatcher.prototype);_t.prototype.init=function(){BeFunky.log("TransformModel Init"),this.initDefaultValues(),window.addEventListener("INIT",()=>{this.initContextMenu()})};_t.prototype.initDefaultValues=function(){this._selectedTransformItem=null,this._selectedTransformItemText=null,this._selectedGroupType=null,this.tempTransformItem=null,this.addedTransformItem=null,this.selectItemOnAdd=!0,this.startValue=null,this.maskImageSizeUpdating=!1,this.opacityUpdating=!1,this.overlayColorUpdating=!1,this.tintColorUpdating=!1,this.shapeAttributeUpdating=!1,this.borderAttributeUpdating=!1,this.dropShadowAttributeUpdating=!1,this.defaultLayerColors={overlay:"FF0000",tint:"FF0000",border:"FF0000"},this.defaultDropShadowVO=new BFN.DropShadowVO({color:"000000"}),this.layerItem=null,this._awaitingDrop=!1,this._focusedTransformItem=null,this._targetTransformItem=null,this.snappingEnabled=!0,this.showMeasurements=!1,this.handleSelectItemAfterEditBind=this.handleSelectItemAfterEdit.bind(this)};_t.prototype.initContextMenu=function(){this.contextMenu=document.getElementById("context_menu_transform");let i={delete_item:{onClick:()=>{e("transform_delete"),this.contextMenu.hide()},shortcutText:"Del"},duplicate_item:{onClick:()=>e("transform_duplicate"),hasDivider:!0,shortcutText:BFN.shortcutText("D")},align:{hasDivider:!0,children:{align_left:{onClick:()=>e("transform_align_left")},align_center:{onClick:()=>e("transform_align_center")},align_right:{onClick:()=>e("transform_align_right")},align_top:{onClick:()=>e("transform_align_top")},align_middle:{onClick:()=>e("transform_align_middle")},align_bottom:{onClick:()=>e("transform_align_bottom")}}},flip:{onClick:()=>{},hasDivider:!0,children:{horizontal:{onClick:()=>e("transform_flip_horizontal")},vertical:{onClick:()=>e("transform_flip_vertical")}}},layer_order:{onClick:()=>{},hasDivider:!0,children:{move_backwards:{onClick:()=>e("transform_move_backwards")},move_forwards:{onClick:()=>e("transform_move_forwards")}}},select_group:{children:{}},add_to_group:{children:{}},remove_from_group:{children:{}},canvas:{children:{fit_to_canvas:{onClick:()=>e("transform_fit_to_canvas")},fill_canvas:{onClick:()=>e("transform_fill_canvas")}}}};BeFunky.Params.isAdmin&&(i.patch={hasDivider:!0,children:{}}),BeFunky.contextMenu(this.contextMenu,i,{hideOnClick:!1}),BeFunky.Params.isAdmin&&this.contextMenu.hideButton("patch"),this.contextMenu.enabled=!1,this.contextMenu.target=document.querySelector("#appStage canvas");function e(t){UITools.setControlValue(t,!0),UITools.applyToolControl(t),UITools.setControlValue(t,!1)}};_t.prototype.handleTransform=function(){let i=UITools.getToolVO("transform"),e=i.updating_id;if(this._selectedTransformItem){let t=this._selectedTransformItem,r=t.type==="group",{basicShapeVO:a}=t;if(a){let o=(l,c,h=!1)=>{if(r)h&&(this.shapeAttributeUpdating!=i.updating&&(this.shapeAttributeUpdating=i.updating,this.shapeAttributeUpdating?(t.clearDropShadow(),t.createTransition(l)):(a.setValues(c),t.selectedItems.forEach(u=>{u.basicShapeVO&&u.basicShapeVO.setValues(c)}),t.updateShapeTexture(),t.registerTransition(),BFN.BasicShapeManager.updateDefaultValues(c))),this.shapeAttributeUpdating&&(a.setValues(c),t.selectedItems.forEach(u=>{u.basicShapeVO&&u.basicShapeVO.setValues(c)}),t.updateShapeTexture(!1)));else{if(this.shapeAttributeUpdating!=i.updating)if(this.shapeAttributeUpdating=i.updating,this.shapeAttributeUpdating)this.startValue=Object.assign({},a.getValues()),t.clearDropShadow(),t.createTransition(l);else{let u=!1;for(let d in c)c[d]!==this.startValue[d]&&(u=!0);u?(t.registerTransition(),BFN.BasicShapeManager.updateDefaultValues(c)):t.updateDropShadowSource()}a.setValues(c),t.updateShapeTexture(!i.updating)}},n=(l,c,h=!1,u=!0)=>{i.updating||(r?h&&(t.clearDropShadow(),t.createTransition(l),a.setValues(c),t.selectedItems.forEach(d=>{d.basicShapeVO&&d.basicShapeVO.setValues(c)}),t.updateShapeTexture(),t.registerTransition(),u&&BFN.BasicShapeManager.updateDefaultValues(c)):(t.clearDropShadow(),t.createTransition(l),a.setValues(c),t.updateShapeTexture(),t.registerTransition(),u&&BFN.BasicShapeManager.updateDefaultValues(c)))};switch(e){case"shape_fill_enabled":if(n(i.shape_fill_enabled?"history_shape_fill_on":"history_shape_fill_off",{fill:i.shape_fill_enabled?BFN.BasicShapeManager.defaultValues.fill!==-1?BFN.BasicShapeManager.defaultValues.fill:BFN.BasicShapeManager.defaultFill:-1,useFillBak:!0},!0,!1),i.shape_fill_enabled)if(r){let l=t.getGroupItemData(),c=l.shapeFill&&l.shapeFill!=="mixed"?l.shapeFill:-1,h=-1,u=1;c!==-1&&l.shapeFillAlpha!=="mixed"&&(h=c,u=l.shapeFillAlpha),UITools.setToolValue("transform","shape_fill_color",h),UITools.setToolValue("transform","shape_fill_color_intensity",u),UITools.updateToolControl("transform_shape_fill_color"),h!==-1&&BFN.BasicShapeManager.updateDefaultValues({fill:h})}else UITools.setToolValue("transform","shape_fill_color",a.fill),UITools.setToolValue("transform","shape_fill_color_intensity",a.fillAlpha),UITools.updateToolControl("transform_shape_fill_color"),a.fill!==-1&&BFN.BasicShapeManager.updateDefaultValues({fill:a.fill});else BFN.BasicShapeManager.updateDefaultValues({fill:-1});break;case"shape_stroke_enabled":if(n(i.shape_stroke_enabled?"history_shape_stroke_on":"history_shape_stroke_off",{stroke:i.shape_stroke_enabled?BFN.BasicShapeManager.defaultValues.stroke!==-1?BFN.BasicShapeManager.defaultValues.stroke:BFN.BasicShapeManager.defaultStroke:-1,useStrokeBak:!0},!0,!1),i.shape_stroke_enabled)if(r){let l=t.getGroupItemData(),c=l.shapeStroke&&l.shapeStroke!=="mixed"?l.shapeStroke:-1,h=-1,u=1;c!==-1&&l.shapeStrokeAlpha!=="mixed"&&(h=c,u=l.shapeStrokeAlpha),UITools.setToolValue("transform","shape_stroke_color",h),UITools.setToolValue("transform","shape_stroke_color_intensity",u),UITools.updateToolControl("transform_shape_stroke_color"),h!==-1&&BFN.BasicShapeManager.updateDefaultValues({stroke:h})}else UITools.setToolValue("transform","shape_stroke_color",a.stroke),UITools.setToolValue("transform","shape_stroke_color_intensity",a.strokeAlpha),UITools.updateToolControl("transform_shape_stroke_color"),a.stroke!==-1&&BFN.BasicShapeManager.updateDefaultValues({stroke:a.stroke});else BFN.BasicShapeManager.updateDefaultValues({stroke:-1});break;case"shape_fill_color":o("history_shape_fill_color",{fill:i.shape_fill_color,fillAlpha:parseFloat(i.shape_fill_color_intensity)},!0);break;case"shape_stroke_color":o("history_shape_stroke_color",{stroke:i.shape_stroke_color,strokeAlpha:parseFloat(i.shape_stroke_color_intensity)},!0);break;case"shape_stroke_width":o("history_shape_stroke_width",{strokeWidth:parseInt(i.shape_stroke_width)},!0);break;case"shape_line_style":n("history_shape_line_style",{lineStyle:i.shape_line_style}),UITools.toggleControlItem("transform_shape_line_segment_width",i.shape_line_style==="dashed"),UITools.toggleControlItem("transform_shape_line_gap_size",i.shape_line_style!=="solid");break;case"shape_line_segment_width":o("history_shape_line_segment_width",{lineSegmentWidth:parseInt(i.shape_line_segment_width)/100*9+1});break;case"shape_line_gap_size":o("history_shape_line_gap_size",{lineGapSize:parseInt(i.shape_line_gap_size)/50});break;case"shape_rectangle_corner_rounding":o("history_shape_rectangle_corner_rounding",{rectangleCornerRounding:parseInt(i.shape_rectangle_corner_rounding)/100});break;case"shape_polygon_sides":o("history_shape_polygon_sides",{polygonSides:parseInt(i.shape_polygon_sides)});break;case"shape_polygon_shift_orientation":n("history_shape_polygon_shift_orientation",{polygonShiftOrientation:i.shape_polygon_shift_orientation});break;case"shape_star_points":o("history_shape_star_points",{starPoints:parseInt(i.shape_star_points)});break;case"shape_star_inset_weight":o("history_shape_star_inset_weight",{starInsetWeight:parseInt(i.shape_star_inset_weight)/100});break;case"shape_star_shift_orientation":n("history_shape_star_shift_orientation",{starShiftOrientation:i.shape_star_shift_orientation});break;case"shape_arrow_style":n("history_shape_arrow_style",{arrowStyle:i.shape_arrow_style});break;case"shape_arrow_weight":o("history_shape_arrow_weight",{arrowWeight:parseInt(i.shape_arrow_weight)/100});break;case"shape_arrow_double_sided":n("history_shape_arrow_double_sided",{arrowDoubleSided:i.shape_arrow_double_sided});break}}let{borderBasicShapeVO:s}=t;if(s){let o=(n,l)=>{if(r)this.borderAttributeUpdating!=i.updating&&(this.borderAttributeUpdating=i.updating,this.borderAttributeUpdating?(t.clearDropShadow(),t.createTransition(n)):(s.setValues(l),t.selectedItems.forEach(c=>{c.borderBasicShapeVO&&c.borderBasicShapeVO.setValues(l)}),t.updateBorderTexture(),t.registerTransition())),this.borderAttributeUpdating&&(s.setValues(l),t.selectedItems.forEach(c=>{c.borderBasicShapeVO&&c.borderBasicShapeVO.setValues(l)}),t.updateBorderTexture(!1));else{if(this.borderAttributeUpdating!=i.updating)if(this.borderAttributeUpdating=i.updating,this.borderAttributeUpdating)this.startValue=Object.assign({},s.getValues()),t.clearDropShadow(),t.createTransition(n);else{let c=!1;for(let h in l)l[h]!==this.startValue[h]&&(c=!0);c?t.registerTransition():t.updateDropShadowSource()}s.setValues(l),t.updateBorderTexture(!i.updating)}};switch(e){case"image_border_enabled":if(!i.updating)if(r){let n=BFN.TransformItemGroup.getGroupItemData();if(n.borderEnabled!==i.image_border_enabled&&(t.clearDropShadow(),t.createTransition(i.image_border_enabled?"history_image_border_on":"history_image_border_off"),t.selectedItems.forEach(l=>{l.borderBasicShapeVO&&(l.borderEnabled=i.image_border_enabled,l.borderBasicShapeVO.stroke===-1&&l.borderBasicShapeVO.setValues({stroke:this.defaultLayerColors.border,strokeAlpha:1}))}),t.registerTransition(),t.updateBorderTexture(!0),i.image_border_enabled&&n.borderColorEmpty)){n=BFN.TransformItemGroup.getGroupItemData();let l=n.borderColor&&n.borderColor!=="mixed"?n.borderColor:-1,c=-1,h=1;l!==-1&&n.borderAlpha!=="mixed"&&(c=l,h=n.borderAlpha),UITools.setToolValue("transform","image_border_color",c),UITools.setToolValue("transform","image_border_color_intensity",h),UITools.updateToolControl("transform_image_border_color")}}else t.borderEnabled!==i.image_border_enabled&&(t.clearDropShadow(),t.createTransition(i.image_border_enabled?"history_image_border_on":"history_image_border_off"),t.borderBasicShapeVO&&(t.borderEnabled=i.image_border_enabled,t.borderBasicShapeVO.stroke===-1&&(t.borderBasicShapeVO.setValues({stroke:this.defaultLayerColors.border,strokeAlpha:1}),UITools.setToolValue("transform","image_border_color",t.borderBasicShapeVO.stroke),UITools.setToolValue("transform","image_border_color_intensity",t.borderBasicShapeVO.strokeAlpha),UITools.updateToolControl("transform_image_border_color"))),t.registerTransition(),t.updateBorderTexture(!0));break;case"image_border_color":this.setDefaultLayerColor("border",i.image_border_color),o("history_image_border_color",{stroke:i.image_border_color,strokeAlpha:parseFloat(i.image_border_color_intensity)});break;case"image_border_thickness":o("history_image_border_thickness",{strokeWidth:parseInt(i.image_border_thickness)});break}}if(t.type==="text"||t.type==="group"&&t.groupType==="text"){let o=()=>{BFN.TransformItemGroup.transformLayer.transformTool.updateDisplay(),BFN.TransformItemGroup.transformLayer.transformTool.fadeAnimator.increase()};switch(e){case"text_curve_enabled":{if(!i.updating)if(r){let n=BFN.TransformItemGroup.getGroupItemData();if(n.textCurveEnabled!==i.text_curve_enabled&&(t.clearDropShadow(),t.createTransition(i.text_curve_enabled?"history_text_curve_on":"history_text_curve_off"),t.selectedItems.forEach(l=>{l.textCurveSizeChanged=!0,l.textCurveEnabled=i.text_curve_enabled,l.toggleHiResText(!1)}),BFN.TransformItemGroup.transformLayer.transformTool.fadeAnimator.decrease(),BFN.TransformItemGroup.strokeRectanglePool.clear(),BFN.TransformItemGroup.registerTransition(void 0,!0,!0,o,!0),i.text_curve_enabled&&n.textCurveAmountEmpty)){n=BFN.TransformItemGroup.getGroupItemData();let l=n.hasOwnProperty("textCurveAmount")&&n.textCurveAmount!=="mixed"&&n.textCurveAmount!==null?n.textCurveAmount:25;UITools.setToolValue("transform","text_curve_amount",l),UITools.updateToolControl("transform_text_curve_amount"),document.getElementById("transform_text_curve_amount").isMixed=n.textCurveEnabled==="mixed"}}else t.textCurveEnabled!==i.text_curve_enabled&&(t.clearDropShadow(),t.createTransition(i.text_curve_enabled?"history_text_curve_on":"history_text_curve_off"),t.textCurveSizeChanged=!0,t.textCurveEnabled=i.text_curve_enabled,t.toggleHiResText(!1),UITools.setToolValue("transform","text_curve_amount",t.textCurveAmount),UITools.updateToolControl("transform_text_curve_amount"),t.registerTransition());break}case"text_curve_amount":{if(r){i.updating||(this._selectedTransformItem.clearDropShadow(),this._selectedTransformItem.createTransition("history_text_curve_amount"),t.selectedItems.forEach(n=>{n.textCurveSizeChanged=!0,n.textCurveAmount=i.text_curve_amount,n.toggleHiResText(!1)}),BFN.TransformItemGroup.transformLayer.transformTool.fadeAnimator.decrease(),BFN.TransformItemGroup.strokeRectanglePool.clear(),BFN.TransformItemGroup.registerTransition(void 0,!0,!0,o,!0));return}this.textCurveAmountUpdating!=i.updating&&(this.textCurveAmountUpdating=i.updating,this.textCurveAmountUpdating?(BFN.FabricManager.showTransformItemIText(this._selectedTransformItem),BFN.FabricManager.styleUpdating=!0,this.startValue=this._selectedTransformItem.textCurveAmount,this._selectedTransformItem.clearDropShadow(),this._selectedTransformItem.createTransition("history_text_curve_amount")):(BFN.FabricManager.hideTransformItemIText(),BFN.FabricManager.styleUpdating=!1,this._selectedTransformItem.textCurveSizeChanged=!0,this._selectedTransformItem.updateCurvedTextDisplay(),this.startValue!=this._selectedTransformItem.textCurveAmount?(this._selectedTransformItem.toggleHiResText(!1),this._selectedTransformItem.registerTransition(!0)):(this._selectedTransformItem.toggleHiResText(!0),this._selectedTransformItem.updateDropShadowSource()))),this._selectedTransformItem.textCurveSizeChanged=!0,this._selectedTransformItem.textCurveAmount=i.text_curve_amount;break}}}if(e.includes("drop_shadow")){let o=(c,h,u)=>{let d=u==="updateDropShadowTexture";if(r){let m=u!=="updateDropShadowSource";if(c==="enabled"&&!i.updating&&t.dropShadowVO.enabled!==h){let p=t.dropShadowEmpty;t.createTransition(h?"history_layer_drop_shadow_on":"history_layer_drop_shadow_off"),t.setDropShadowValues("enabled",h),t.registerTransition(),t.dropShadowVO.enabled&&p&&this.updateGroupDropShadowControls(!1)}else this.dropShadowAttributeUpdating!=i.updating&&(this.dropShadowAttributeUpdating=i.updating,this.dropShadowAttributeUpdating?(m||t.clearDropShadow(),t.createTransition(`history_layer_${e}`),t.selectedItems.forEach(p=>{p.dropShadowRequiresRefresh=d})):(t.setDropShadowValues(c,h),t.registerTransition(),t.selectedItems.forEach(p=>{delete p.dropShadowRequiresRefresh})));this.defaultDropShadowVO[c]=h,t.setDropShadowValues(c,h),m&&t.selectedItems.forEach(p=>{p[u]()})}else{if(c==="enabled"&&!i.updating&&t.dropShadowVO.enabled!==h){if(t.createTransition(h?"history_layer_drop_shadow_on":"history_layer_drop_shadow_off"),t.dropShadowVO.enabled=h,t.dropShadowVO.color===-1){let m=this.defaultDropShadowVO.getValues();delete m.enabled,t.dropShadowVO.setValues(m);for(let p in m)UITools.setControlValue(`transform_drop_shadow_${p}`,m[p]),UITools.updateToolControl(`transform_drop_shadow_${p}`)}t.registerTransition()}else this.dropShadowAttributeUpdating!=i.updating&&(this.dropShadowAttributeUpdating=i.updating,this.dropShadowAttributeUpdating?(this.startValue=t.dropShadowVO[c],t.createTransition(`history_layer_${e}`),t.dropShadowRequiresRefresh=d):(t.dropShadowVO[c]!==this.startValue&&t.registerTransition(!0),delete t.dropShadowRequiresRefresh));this.defaultDropShadowVO[c]=h,t.dropShadowVO[c]=h,t[u]()}},n=e.replace("drop_shadow_",""),l=null;switch(n){case"enabled":{l="updateDropShadowSource";break}case"color":case"opacity":case"blend_mode":{l="updateDropShadowVisuals";break}case"distance":case"angle":{l="updateDropShadowOffset";break}case"size":case"density":{l="updateDropShadowTexture";break}case"scale":{l="updateDropShadowScale";break}}l&&o(n,i[e],l)}switch(e){case"graphic_color_group_color":{let o=parseInt(i.graphic_color_group_color_group_id);if(this.shapeAttributeUpdating!=i.updating)if(this.shapeAttributeUpdating=i.updating,this.shapeAttributeUpdating)this.startValue=this._selectedTransformItem.getShapeColorGroupColor(o),t.createTransition("history_shape_fill_color");else{let n=this._selectedTransformItem.getShapeColorGroupColor(o);i.graphic_color_group_color===-1&&(UITools.setToolValue("transform","graphic_color_group_color",n.color),UITools.setToolValue("transform","graphic_color_group_color_intensity",n.opacity),UITools.updateToolControl("transform_graphic_color_group_color"),BFN.ColorPickerPanel.colorButton&&(BFN.ColorPickerPanel.colorButton.hashColor=n.color,BFN.ColorPickerPanel.colorButton.intensity=n.opacity,BFN.ColorPickerPanel.handleColorButtonUpdated())),(n.color!==this.startValue.color||n.opacity!==this.startValue.opacity)&&t.registerTransition()}this._selectedTransformItem.setShapeColorGroupColor(o,i.graphic_color_group_color,i.graphic_color_group_color_intensity,!i.updating,BFN.ColorPickerPanel._emptyButtonClicked);break}}switch(e){case"delete":this._selectedTransformItem.removeItem();break;case"duplicate":this._selectedTransformItem.type==="group"?this._selectedTransformItem.duplicateGroup():this._selectedTransformItem.duplicateItem();break;case"opacity":if(r){i.updating||(this._selectedTransformItem.createTransition("history_opacity"),this._selectedTransformItem.setOpacity(i.opacity),this._selectedTransformItem.registerTransition(!0));return}this.opacityUpdating!=i.updating&&(this.opacityUpdating=i.updating,this.opacityUpdating?(this.startValue=this._selectedTransformItem.alpha,this._selectedTransformItem.createTransition("history_opacity")):this.startValue!=this._selectedTransformItem.alpha&&this._selectedTransformItem.registerTransition(!0)),this._selectedTransformItem.alpha=i.opacity/100;break;case"overlay_color_enabled":if(!i.updating)if(r){let l=BFN.TransformItemGroup.getGroupItemData();if(l.overlayColorEnabled!==i.overlay_color_enabled&&(t.createTransition(i.overlay_color_enabled?"history_color_overlay_on":"history_color_overlay_off"),t.selectedItems.forEach(c=>{c.overlayColorEnabled=i.overlay_color_enabled,c.overlayColor===-1&&(c.overlayColor=this.defaultLayerColors.overlay,c.overlayColorIntensity=1)}),t.registerTransition(),i.overlay_color_enabled&&l.overlayColorEmpty)){l=BFN.TransformItemGroup.getGroupItemData();let c=l.overlayColor&&l.overlayColor!=="mixed"?l.overlayColor:-1,h=-1,u=1;c!==-1&&l.overlayColorIntensity!=="mixed"&&(h=c,u=l.overlayColorIntensity),UITools.setToolValue("transform","overlay_color",h),UITools.setToolValue("transform","overlay_color_intensity",u),UITools.updateToolControl("transform_overlay_color")}}else t.overlayColorEnabled!==i.overlay_color_enabled&&(t.createTransition(i.overlay_color_enabled?"history_color_overlay_on":"history_color_overlay_off"),t.overlayColorEnabled=i.overlay_color_enabled,t.overlayColor===-1&&(t.overlayColor=this.defaultLayerColors.overlay,t.overlayColorIntensity=1,UITools.setToolValue("transform","overlay_color",t.overlayColor),UITools.setToolValue("transform","overlay_color_intensity",t.overlayColorIntensity),UITools.updateToolControl("transform_overlay_color")),t.registerTransition());break;case"overlay_color":if(this.setDefaultLayerColor("overlay",i.overlay_color),r){let l=!0;if(this.overlayColorUpdating!=i.updating)if(this.overlayColorUpdating=i.updating,this.overlayColorUpdating){this._selectedTransformItem.createTransition("history_color_overlay");let c=BFN.TransformItemGroup.getGroupItemData(),h=c.overlayColor==="mixed"||c.overlayColor===-1||c.overlayColorIntensity==="mixed",u=i.overlay_color==-1;h&&!u?(UITools.setToolValue("transform","overlay_color_intensity",1),UITools.updateToolControl("transform_overlay_color"),BFN.ColorPickerPanel.refreshIntensitySlider()):!h&&u&&(UITools.setToolValue("transform","overlay_color_intensity",0),UITools.updateToolControl("transform_overlay_color"),BFN.ColorPickerPanel.refreshIntensitySlider())}else l=!1,this._selectedTransformItem.setOverlayColor(i.overlay_color,i.overlay_color_intensity),this._selectedTransformItem.registerTransition();l&&this._selectedTransformItem.setOverlayColor(i.overlay_color,i.overlay_color_intensity)}else this.overlayColorUpdating!=i.updating&&(this.overlayColorUpdating=i.updating,this.overlayColorUpdating?(this.startValue={color:this._selectedTransformItem.overlayColor,intensity:this._selectedTransformItem.overlayColorIntensity},this._selectedTransformItem.createTransition("history_color_overlay"),this.startValue.color===-1&&i.overlay_color!==-1?(UITools.setToolValue("transform","overlay_color_intensity",1),UITools.updateToolControl("transform_overlay_color"),BFN.ColorPickerPanel.refreshIntensitySlider()):this.startValue.color!==-1&&i.overlay_color==-1&&(UITools.setToolValue("transform","overlay_color_intensity",0),UITools.updateToolControl("transform_overlay_color"),BFN.ColorPickerPanel.refreshIntensitySlider())):(this.startValue.color!=this._selectedTransformItem.overlayColor||this.startValue.intensity!=this._selectedTransformItem.overlayColorIntensity)&&this._selectedTransformItem.registerTransition()),this._selectedTransformItem.overlayColor=i.overlay_color,this._selectedTransformItem.overlayColorIntensity=i.overlay_color_intensity;break;case"tint_color_enabled":if(!i.updating)if(r){let l=BFN.TransformItemGroup.getGroupItemData();if(l.tintColorEnabled!==i.tint_color_enabled&&(t.createTransition(i.tint_color_enabled?"history_tint_on":"history_tint_off"),t.selectedItems.forEach(c=>{c.tintColorEnabled=i.tint_color_enabled,c.tintColor===-1&&(c.tintColor=this.defaultLayerColors.tint,c.tintColorIntensity=1)}),t.registerTransition(),i.tint_color_enabled&&l.tintColorEmpty)){l=BFN.TransformItemGroup.getGroupItemData();let c=l.tintColor&&l.tintColor!=="mixed"?l.tintColor:-1,h=-1;c!==-1&&(h=c),UITools.setControlValue("transform_tint_color",h),UITools.updateToolControl("transform_tint_color")}}else t.tintColorEnabled!==i.tint_color_enabled&&(t.createTransition(i.tint_color_enabled?"history_tint_on":"history_tint_off"),t.tintColorEnabled=i.tint_color_enabled,t.tintColor===-1&&(t.tintColor=this.defaultLayerColors.tint,UITools.setControlValue("transform_tint_color",t.tintColor),UITools.updateToolControl("transform_tint_color")),t.registerTransition());break;case"tint_color":if(this.setDefaultLayerColor("tint",i.tint_color),r){let l=!0;this.tintColorUpdating!=i.updating&&(this.tintColorUpdating=i.updating,this.tintColorUpdating?this._selectedTransformItem.createTransition("tint"):(l=!1,this._selectedTransformItem.setTintColor(i.tint_color),this._selectedTransformItem.registerTransition())),l&&this._selectedTransformItem.setTintColor(i.tint_color)}else this.tintColorUpdating!=i.updating&&(this.tintColorUpdating=i.updating,this.tintColorUpdating?(this.startValue=this._selectedTransformItem.tintColor,this._selectedTransformItem.createTransition("tint")):this.startValue!=this._selectedTransformItem.tintColor&&this._selectedTransformItem.registerTransition()),this._selectedTransformItem.tintColor=i.tint_color;break;case"blend_mode":let o=parseInt(i.blend_mode),n=Object.values(BFN.CONST.BLEND_MODES);!isNaN(o)&&n.indexOf(o)!==-1&&(this._selectedTransformItem.createTransition("history_blend_mode"),this._selectedTransformItem.setBlendMode(o),this._selectedTransformItem.registerTransition(!0));break;case"flip_horizontal":this._selectedTransformItem.clearDropShadow(),this._selectedTransformItem.createTransition("history_flip_horizontal"),this._selectedTransformItem.flipHorizontal(),this._selectedTransformItem.registerTransition();break;case"flip_vertical":this._selectedTransformItem.clearDropShadow(),this._selectedTransformItem.createTransition("history_flip_vertical"),this._selectedTransformItem.flipVertical(),this._selectedTransformItem.registerTransition();break;case"create_group":r&&BFN.GroupManager.openCreateGroupModal();break;case"move_backwards":r?this._selectedTransformItem.moveBackwards():(this._selectedTransformItem.createTransition("history_layer_order"),this._selectedTransformItem.moveBackwards()&&this._selectedTransformItem.registerTransition());break;case"move_forwards":r?this._selectedTransformItem.moveForwards():(this._selectedTransformItem.createTransition("history_layer_order"),this._selectedTransformItem.moveForwards()&&this._selectedTransformItem.registerTransition());break;case"align_left":if(r&&this._selectedTransformItem.accurateBoundsUpdating)return;this.startValue=Math.floor(this._selectedTransformItem.x),this._selectedTransformItem.createTransition(r?"history_selection_align_left":"history_align_left"),this._selectedTransformItem.align="left",(this.startValue!=Math.floor(this._selectedTransformItem.x)||r)&&this._selectedTransformItem.registerTransition(void 0,!0);break;case"align_center":if(r&&this._selectedTransformItem.accurateBoundsUpdating)return;this.startValue=Math.floor(this._selectedTransformItem.x),this._selectedTransformItem.createTransition(r?"history_selection_align_center":"history_align_center"),this._selectedTransformItem.align="center",(this.startValue!=Math.floor(this._selectedTransformItem.x)||r)&&this._selectedTransformItem.registerTransition(void 0,!0);break;case"align_right":if(r&&this._selectedTransformItem.accurateBoundsUpdating)return;this.startValue=Math.floor(this._selectedTransformItem.x),this._selectedTransformItem.createTransition(r?"history_selection_align_right":"history_align_right"),this._selectedTransformItem.align="right",(this.startValue!=Math.floor(this._selectedTransformItem.x)||r)&&this._selectedTransformItem.registerTransition(void 0,!0);break;case"align_top":if(r&&this._selectedTransformItem.accurateBoundsUpdating)return;this.startValue=Math.floor(this._selectedTransformItem.y),this._selectedTransformItem.createTransition(r?"history_selection_align_top":"history_align_top"),this._selectedTransformItem.align="top",(this.startValue!=Math.floor(this._selectedTransformItem.y)||r)&&this._selectedTransformItem.registerTransition(void 0,!0);break;case"align_middle":if(r&&this._selectedTransformItem.accurateBoundsUpdating)return;this.startValue=Math.floor(this._selectedTransformItem.y),this._selectedTransformItem.createTransition(r?"history_selection_align_middle":"history_align_middle"),this._selectedTransformItem.align="middle",(this.startValue!=Math.floor(this._selectedTransformItem.y)||r)&&this._selectedTransformItem.registerTransition(void 0,!0);break;case"align_bottom":if(r&&this._selectedTransformItem.accurateBoundsUpdating)return;this.startValue=Math.floor(this._selectedTransformItem.y),this._selectedTransformItem.createTransition(r?"history_selection_align_bottom":"history_align_bottom"),this._selectedTransformItem.align="bottom",(this.startValue!=Math.floor(this._selectedTransformItem.y)||r)&&this._selectedTransformItem.registerTransition(void 0,!0);break;case"fit_to_canvas":this._selectedTransformItem.transformTool.fitItemToCanvas(!1),this.contextMenu.hide();break;case"fill_canvas":this._selectedTransformItem.transformTool.fitItemToCanvas(!0),this.contextMenu.hide();break}BFN.MainUI.requestRender()}else this._selectedTransformItemText&&(e!=="delete"&&e!=="duplicate"&&(this.tempTransformItem=this._selectedTransformItemText,this.tempTransformItem.addEventListener(BFN.TransformItemEvents.SELECT_ITEM.type,this.handleSelectItemAfterEditBind)),this._selectedTransformItemText.exitTextEditing());e==="menu_popover_button"&&i.menu_popover_button&&(BFN.alternateMenu.popupMenuId=BFN.alternateMenu.popupMenuId==="transform"?"":"transform")};_t.prototype.handleLayer=function(){let i=UITools.getToolVO("layer"),e=i.updating_id;if(this._selectedTransformItem){let t=this._selectedTransformItem;if(["texture","frame_texture"].includes(t.type)&&!t.isGoodie)switch(e){case"save_as_image":switch(t.type){case"texture":BFN.UploadSaveShareManager.altSaveTexture=this.selectedTransformItem.itemContent.texture;let r="";try{let g=t.projectItemVO.imageID;r=BFN.ImageLibraryManager.selectedMenuImageVOs[BFN.ImageLibraryManager.getIndex(g)].name||""}catch(g){}BFN.UploadSaveShareManager.setFileName(void 0,"layer",r),BFN.UploadSaveShareManager.openSaveOrShareImageModal("computer");break;case"frame_texture":let a=[0,12,8,4][t.flippedHorizontal+t.flippedVertical*2],s=t.itemContent,o=new PIXI.Texture(s.baseTexture),n=o.renderClone();o.destroyGC(!1),n.frame=new PIXI.Rectangle(Math.round(s.texture.frame.x),Math.round(s.texture.frame.y),Math.round(s.texture.frame.width),Math.round(s.texture.frame.height));let l=Math.min(n.frame.width/s.frameWidth,n.frame.height/s.height),c=Math.round(s.frameWidth*l),h=Math.round(s.frameHeight*l);n.orig=n.trim=new PIXI.Rectangle(0,0,c,h),n.rotate=a;let u=new PIXI.Container,d=new PIXI.Sprite(n);d.pluginName="blend_picture",d.fillColor=t.itemContent.fillColor||0,d.intensity=t.itemContent.intensity||0,d.tint=t.itemContent.tint,u.addChild(d);let m=new PIXI.Sprite;if(u.addChild(m),t.isShape&&t.hasOwnProperty("itemContentMask")){let g=t.itemContentMask;t.basicShapeVO?t.basicShapeVO.updateTexture(g.texture,c,h,!0):BFN.SVGManager.updateTexture(g.texture,null,null,c,h);let f=g.texture.renderClone();f.rotate=a,m.texture=f,d.mask=m,t.updateShapeTexture()}let p=PIXI.RenderTexture.create(c,h);BFN.Stage.render(u,p);try{d.mask=null,d.texture.destroyGC(!0),d.destroy(!1)}catch(g){}u.removeChild(d);try{m.texture.destroyGC(!0),m.destroy(!1)}catch(g){}u.removeChild(m),BFN.UploadSaveShareManager.destroyAltSaveTextureOnDispose=!0,BFN.UploadSaveShareManager.altSaveTexture=p,BFN.UploadSaveShareManager.setFileName(void 0,"layer","befunky_layer"),BFN.UploadSaveShareManager.openSaveOrShareImageModal("computer");break}break;case"lock_aspect_ratio":break;case"image_cutout":BFN.EditLayerManager.editTransformItemAlternateMenu("cutout",()=>{BFN.ImageCutout.readyCallback=()=>{requestAnimationFrame(()=>{UIToggler.openAlternateMenu("",["layer_isolator_tool_menu"]),BFN.HelpClueManager.show("cutout")})}},()=>{if(BFN.ImageCutout.readyCallback=null,BFN.ImageCutout.exportedItemObject){let r=BFN.AppModel.sectionValue(BFN.PhotoEditorCanvasModel,BFN.CollageMakerCanvasModel,BFN.DesignerCanvasModel);r.addedItem=BFN.ImageCutout.exportedItemObject,delete BFN.ImageCutout.exportedItemObject}});break;case"image_edit_layer":if(!BFN.BfnService.userIsPlus){BFN.BfnService.upgrade(BFN.AppModel.sectionValue("EDITOR","COLLAGE","DESIGNER"),"EDIT_LAYER_UPGRADE","edit_layer"),BFN.UserActionManager.addUpgradeAction(["Edit Image Layer"]);return}BFN.EditLayerManager.editTransformItem(),BeFunky.showAnnouncementOnce("edit_layer");break;case"image_open_in_editor":if(!BFN.BfnService.userIsPlus){BFN.BfnService.upgrade(BFN.AppModel.sectionValue("EDITOR","COLLAGE","DESIGNER"),"EDIT_LAYER_UPGRADE"),BFN.UserActionManager.addUpgradeAction(["Open Layer Image in Editor"]);return}t.deselectItem(),BFN.PhotoEditorModel.currentTexture&&BFN.IndexedDB.disabledReason?BeFunky.confirm("confirm_edit_image",{onConfirm:()=>{BFN.ImageEditManager.openImageInEditor(t)},onCancel:()=>{t.selectItem()},focusConfirmButton:!1}):BFN.ImageEditManager.openImageInEditor(t);break;case"mask_image_crop":t.type==="frame_texture"&&t.transformTool.transformToolFrame.setup(t);break;case"mask_image_replace":(t.type="frame_texture")&&BFN.ImageLibraryManager.uploadImages(r=>{!r.isComplete&&r.menuImageVO&&(BFN.TransformModel.targetTransformItem=t,BFN.ImageLibraryManager.addImageToCanvas(r.menuImageVO))},{allowMultiple:!1});break;case"mask_image_open_in_editor":if(!BFN.BfnService.userIsPlus){BFN.BfnService.upgrade(BFN.AppModel.sectionValue("EDITOR","COLLAGE","DESIGNER"),"EDIT_LAYER_UPGRADE"),BFN.UserActionManager.addUpgradeAction(["Open Layer Image in Editor"]);return}t.deselectItem(),BFN.PhotoEditorModel.currentTexture&&BFN.IndexedDB.disabledReason?BeFunky.confirm("confirm_edit_image",{onConfirm:()=>{BFN.ImageEditManager.openMaskImageInEditor(t)},onCancel:()=>{t.selectItem()},focusConfirmButton:!1}):BFN.ImageEditManager.openMaskImageInEditor(t);break;case"mask_image_crop_lock_aspect_ratio":break;case"mask_image_crop_size":t.type==="frame_texture"&&t.transformTool.transformToolFrame.transformItem===t&&BFN.TransformModel.transformToolFrame.setImageScale(i.mask_image_crop_size/100,i.updating);break;case"mask_image_crop_fit_to_frame":t.type==="frame_texture"&&t.transformTool.transformToolFrame.transformItem===t&&t.resetFrameTexture();break;case"mask_image_crop_fit_to_image":t.type==="frame_texture"&&t.transformTool.transformToolFrame.transformItem===t&&t.fitFrameToImage();break}}else if(e==="isolator_display_canvas"){let t=i[e];UITools.setToolValue("layer","isolator_display_canvas",t),UITools.updateToolControl("layer_isolator_display_canvas"),BFN.TransformItemIsolator.toggleBackground(t)}else e==="isolator_edit_complete"&&this.isolatorEditComplete()};_t.prototype.isolatorEditComplete=function(){if(BFN.TransformItemIsolator.active&&!BFN.TransformItemIsolator.animating)if(BFN.PhotoEditorCanvasModel.viewState!==BFN.PhotoEditorCanvasModelViewStates.VIEWING_CANVAS){let i=()=>{BFN.applyCancelMenu.applyButton.click(),setTimeout(()=>{BFN.PhotoEditorCanvasModel.viewState===BFN.PhotoEditorCanvasModelViewStates.VIEWING_CANVAS&&(BeFunky.showLoadScreen({isCancellable:!1}),BeFunky.waitUntil({condition:()=>!BFN.MainUI.viewportUpdating,onSuccess:()=>{BeFunky.hideLoadScreen(),BFN.TransformItemIsolator.releaseTransformItem()},onTimeout:()=>{BeFunky.hideLoadScreen(),BFN.TransformItemIsolator.releaseTransformItem()},interval:10,maxAttempts:500}))},0)};BeFunky.confirm("apply_changes_leave_editor",{onConfirm:i,confirmText:"yes",cancelText:"no_keep_editing"})}else BFN.TransformItemIsolator.releaseTransformItem()};_t.prototype.setDefaultLayerColor=function(i,e){this.defaultLayerColors[i]&&this.defaultLayerColors[i]!==e&&e!==-1&&typeof e=="string"&&e.length===6&&(this.defaultLayerColors[i]=e)};_t.prototype.updateGroupMenu=function(){let i=this._selectedTransformItem&&this._selectedTransformItem.type==="group"?this._selectedTransformItem:null;UITools.disableControlItem("text_edit_spacing_menu_popover_button",!!i,"button");let e=document.getElementById("text_edit_size");if(!i&&e.isMixed&&(e.isMixed=!1),!i)return;let t=i.getGroupItemData(),r=UITools.getToolValue("transform","updating_id");UITools.setToolValue("transform","opacity",t.opacity==="mixed"?100:t.opacity),UITools.updateToolControl("transform_opacity"),document.getElementById("transform_opacity").isMixed=t.opacity==="mixed",document.getElementById("transform_blend_mode").isMixed=t.blendMode==="mixed",UITools.toggleControlItem("transform_blend_mode",!i.containsMask),t.blendMode!=="mixed"&&(UITools.setToolValue("transform","blend_mode",t.blendMode),UITools.updateToolControl("transform_blend_mode"));let a=document.getElementById("transform_overlay_color_enabled");a.checked=t.overlayColorEnabled?t.overlayColorEnabled==="mixed"?"mixed":"on":"off",a.openWhenChecked=!!t.overlayColorEmpty;let s=t.overlayColor&&t.overlayColor!=="mixed"?t.overlayColor:-1,o=-1,n=t.overlayColor==="mixed"?1:0;s!==-1&&t.overlayColorIntensity!=="mixed"&&(o=s,n=t.overlayColorIntensity),UITools.setToolValue("transform","overlay_color",o),UITools.setToolValue("transform","overlay_color_intensity",n),UITools.updateToolControl("transform_overlay_color"),document.getElementById("transform_overlay_color").isMixed=t.overlayColor==="mixed";let l=document.getElementById("transform_tint_color_enabled");l.checked=t.tintColorEnabled?t.tintColorEnabled==="mixed"?"mixed":"on":"off",l.openWhenChecked=!!t.tintColorEmpty;let c=t.tintColor&&t.tintColor!=="mixed"?t.tintColor:-1,h=-1;c!==-1&&(h=c),UITools.setToolValue("transform","tint_color",h),UITools.updateToolControl("transform_tint_color"),document.getElementById("transform_tint_color").isMixed=t.tintColor==="mixed";let u=document.getElementById("transform_image_border_enabled");u.checked=t.borderEnabled?t.borderEnabled==="mixed"?"mixed":"on":"off",u.openWhenChecked=!!t.borderColorEmpty;let d=t.borderColor&&t.borderColor!=="mixed"?t.borderColor:-1,m=-1,p=1;d!==-1&&t.borderAlpha!=="mixed"&&(m=d,p=t.borderAlpha),UITools.setToolValue("transform","image_border_color",m),UITools.setToolValue("transform","image_border_color_intensity",p),UITools.updateToolControl("transform_image_border_color"),document.getElementById("transform_image_border_color").isMixed=t.borderColor==="mixed",UITools.toggleElement("transform_image_border_enabled",!t.borderHide);let g=t.hasOwnProperty("borderThickness")&&t.borderThickness!=="mixed"?t.borderThickness:10;UITools.setToolValue("transform","image_border_thickness",g),UITools.updateToolControl("transform_image_border_thickness"),document.getElementById("transform_image_border_thickness").isMixed=!!t.borderThicknessMixed;let f=document.getElementById("transform_text_curve_enabled");f.checked=t.textCurveEnabled?t.textCurveEnabled==="mixed"?"mixed":"on":"off",f.openWhenChecked=!!t.textCurveAmountEmpty;let v=t.hasOwnProperty("textCurveAmount")&&t.textCurveAmount!=="mixed"&&t.textCurveAmount!==null?t.textCurveAmount:BFN.CurvedTextManager.defaultCurveAmount;UITools.setToolValue("transform","text_curve_amount",v),UITools.updateToolControl("transform_text_curve_amount"),document.getElementById("transform_text_curve_amount").isMixed=t.textCurveAmount==="mixed",this.updateGroupDropShadowControls();let T=document.getElementById("transform_shape_fill_enabled");T.checked=t.shapeFillExists?t.shapeFillExists==="mixed"?"mixed":"on":"off",T.openWhenChecked=!!t.shapeFillBakEmpty;let x=t.shapeFill&&t.shapeFill!=="mixed"?t.shapeFill:-1,B=-1,y=1;x!==-1&&t.shapeFillAlpha!=="mixed"&&(B=x,y=t.shapeFillAlpha),UITools.setToolValue("transform","shape_fill_color",B),UITools.setToolValue("transform","shape_fill_color_intensity",y),UITools.updateToolControl("transform_shape_fill_color"),document.getElementById("transform_shape_fill_color").isMixed=t.shapeFill==="mixed",UITools.toggleElement("transform_shape_fill_enabled",t.hasOwnProperty("shapeHideFill")?!t.shapeHideFill:!0);let F=document.getElementById("transform_shape_stroke_enabled");F.checked=t.shapeStrokeExists?t.shapeStrokeExists==="mixed"?"mixed":"on":"off",F.openWhenChecked=!!t.shapeStrokeBakEmpty;let b=t.shapeStroke&&t.shapeStroke!=="mixed"?t.shapeStroke:-1,S=-1,I=1;b!==-1&&t.shapeStrokeAlpha!=="mixed"&&(S=b,I=t.shapeStrokeAlpha),UITools.setToolValue("transform","shape_stroke_color",S),UITools.setToolValue("transform","shape_stroke_color_intensity",I),UITools.updateToolControl("transform_shape_stroke_color"),document.getElementById("transform_shape_stroke_color").isMixed=t.shapeStroke==="mixed",UITools.toggleElement("transform_shape_stroke_enabled",t.hasOwnProperty("shapeHideStroke")?!t.shapeHideStroke:!0);let _=t.hasOwnProperty("shapeStrokeWidth")&&t.shapeStrokeWidth!=="mixed"?t.shapeStrokeWidth:10;switch(UITools.setToolValue("transform","shape_stroke_width",_),UITools.updateToolControl("transform_shape_stroke_width"),document.getElementById("transform_shape_stroke_width").isMixed=!!t.shapeStrokeWidthMixed,this.updateBasicShapeAttributeControls(),UITools.getToolVO("transform").updating_id=r,i.groupType){case"image":break;case"graphic":break;case"shape":break;case"graphic_image_mix":break;case"text":break;case"mixed":default:}};_t.prototype.updateGroupDropShadowControls=function(i=!0){if(this.selectedTransformItem!==BFN.TransformItemGroup)return;BFN.TransformItemGroup.updateDropShadowValues();let e=BFN.TransformItemGroup.dropShadowVO.getValues(),{dropShadowMixedValues:t}=BFN.TransformItemGroup,{dropShadowEmpty:r}=BFN.TransformItemGroup;for(let a in e){UITools.setToolValue("transform",`drop_shadow_${a}`,e[a]);let s=`transform_drop_shadow_${a}`;UITools.updateToolControl(s);let o=document.getElementById(s);if(o&&(a==="enabled"&&i&&(o.openWhenChecked=r),t.includes(a)))switch(a){case"enabled":o.checked="mixed";break;case"color":UITools.setToolValue("transform","drop_shadow_color",-1),UITools.updateToolControl(s),o.isMixed=!0;break;case"blend_mode":o.setState({isMixed:!0});break;default:o.isMixed=!0}}};_t.prototype.updateBasicShapeAttributeControls=function(i=null){switch(i||(i={type:null}),UITools.toggleControlItem("transform_shape_line_style",i.type==="line"),UITools.toggleControlItem("transform_shape_line_segment_width",i.type==="line"&&i.attributes.lineStyle==="dashed"),UITools.toggleControlItem("transform_shape_line_gap_size",i.type==="line"&&i.attributes.lineStyle!=="solid"),UITools.toggleControlItem("transform_shape_rectangle_corner_rounding",i.type==="rectangle"),UITools.toggleControlItem("transform_shape_polygon_sides",i.type==="polygon"),UITools.toggleControlItem("transform_shape_polygon_shift_orientation",i.type==="polygon"),UITools.toggleControlItem("transform_shape_star_points",i.type==="star"),UITools.toggleControlItem("transform_shape_star_inset_weight",i.type==="star"),UITools.toggleControlItem("transform_shape_star_shift_orientation",i.type==="star"),UITools.toggleControlItem("transform_shape_arrow_style",i.type==="arrow"),UITools.toggleControlItem("transform_shape_arrow_weight",i.type==="arrow"),UITools.toggleControlItem("transform_shape_arrow_double_sided",i.type==="arrow"),i.type){case"line":UITools.setToolValue("transform","shape_line_style",i.attributes.lineStyle),UITools.setToolValue("transform","shape_line_segment_width",Math.round((i.attributes.lineSegmentWidth-1)/9*100)),UITools.setToolValue("transform","shape_line_gap_size",Math.round(i.attributes.lineGapSize*50));break;case"rectangle":UITools.setToolValue("transform","shape_rectangle_corner_rounding",Math.round(i.attributes.rectangleCornerRounding*100));break;case"polygon":UITools.setToolValue("transform","shape_polygon_sides",i.attributes.polygonSides),UITools.setToolValue("transform","shape_polygon_shift_orientation",i.attributes.polygonShiftOrientation);break;case"star":UITools.setToolValue("transform","shape_star_points",i.attributes.starPoints),UITools.setToolValue("transform","shape_star_inset_weight",Math.round(i.attributes.starInsetWeight*100)),UITools.setToolValue("transform","shape_star_shift_orientation",i.attributes.starShiftOrientation);break;case"arrow":UITools.setToolValue("transform","shape_arrow_style",i.attributes.arrowStyle),UITools.setToolValue("transform","shape_arrow_weight",Math.round(i.attributes.arrowWeight*100)),UITools.setToolValue("transform","shape_arrow_double_sided",i.attributes.arrowDoubleSided);break}};_t.prototype.removeSelection=function(){if(this.selectedTransformItem){let i=this.selectedTransformItem;i.type==="group"?i.transformLayer.removeItem(i):i.removeItem()}};_t.prototype.handleSelectItemAfterEdit=function(i){this.tempTransformItem.removeEventListener(BFN.TransformItemEvents.SELECT_ITEM.type,this.handleSelectItemAfterEditBind),this.tempTransformItem=null,this.handleTransform()};Object.defineProperty(_t.prototype,"selectedTransformItem",{set(i){if(this._selectedTransformItem=i,this.dispatchEvent(BFN.TransformModelEvents.TRANSFORM_ITEM_UPDATED),this._selectedGroupType=null,document.getElementById("transform_blend_mode").isMixed=!1,UITools.toggleControlItem("transform_blend_mode",!0),UITools.toggleElement("transform_image_border_enabled",!1),UITools.toggleElement("transform_text_curve_enabled",!0),BFN.TransformItemBoundingBoxes.clear(),this._selectedTransformItem){let e=this._selectedTransformItem;if(e.type==="group")switch(this._selectedGroupType=this._selectedTransformItem.groupType,this._selectedGroupType){case"image":UIToggler.openAlternateMenu("image_properties",["transform_menu","graphic_menu","drop_shadow_menu"]);break;case"shape":UIToggler.openAlternateMenu("shape_properties_multiple",["shape_menu","transform_menu","drop_shadow_menu"]);break;case"graphic":UIToggler.openAlternateMenu("graphic_properties",["transform_menu","graphic_menu","drop_shadow_menu"]);break;case"graphic_image_mix":UIToggler.openAlternateMenu("selection_properties",["transform_menu","graphic_menu","drop_shadow_menu"]);break;case"text":UIToggler.openAlternateMenu("text_properties",["text_menu","transform_menu","text_addon_menu","drop_shadow_menu"]);break;case"mixed":default:UIToggler.openAlternateMenu("selection_properties",["transform_menu","drop_shadow_menu"]);return}else{let t=UITools.getToolValue("transform","updating_id");BFN.TransformItemBoundingBoxes.selectItems(e.getAvailableGroupItems()),this.updateGroupMenu();let{basicShapeVO:r}=this._selectedTransformItem;r&&(document.getElementById("transform_shape_fill_enabled").openWhenChecked=r.fillBak===-1,UITools.setToolValue("transform","shape_fill_enabled",r.fill!==-1),r.fill===-1?(UITools.setToolValue("transform","shape_fill_color",-1),UITools.setToolValue("transform","shape_fill_color_intensity",1)):(UITools.setToolValue("transform","shape_fill_color",r.fill),UITools.setToolValue("transform","shape_fill_color_intensity",r.fillAlpha)),UITools.toggleElement("transform_shape_fill_enabled",r.type!=="line"),document.getElementById("transform_shape_stroke_enabled").openWhenChecked=r.strokeBak===-1,UITools.setToolValue("transform","shape_stroke_enabled",r.stroke!==-1),r.stroke===-1?(UITools.setToolValue("transform","shape_stroke_color",-1),UITools.setToolValue("transform","shape_stroke_color_intensity",1)):(UITools.setToolValue("transform","shape_stroke_color",r.stroke),UITools.setToolValue("transform","shape_stroke_color_intensity",r.strokeAlpha)),UITools.toggleElement("transform_shape_stroke_enabled",!["star","arrow"].includes(r.type)),UITools.setToolValue("transform","shape_stroke_width",r.strokeWidth),this.updateBasicShapeAttributeControls(r));let{borderBasicShapeVO:a}=this._selectedTransformItem;a&&(document.getElementById("transform_image_border_enabled").openWhenChecked=a.stroke===-1,UITools.setToolValue("transform","image_border_enabled",this._selectedTransformItem.borderEnabled),a.stroke===-1?(UITools.setToolValue("transform","image_border_color",-1),UITools.setToolValue("transform","image_border_color_intensity",1)):(UITools.setToolValue("transform","image_border_color",a.stroke),UITools.setToolValue("transform","image_border_color_intensity",a.strokeAlpha)),UITools.setToolValue("transform","image_border_thickness",a.strokeWidth),UITools.toggleElement("transform_image_border_enabled",!0));let{dropShadowVO:s}=this._selectedTransformItem;if(s){let o=s.getValues();for(let n in o)n==="color"&&(document.getElementById("transform_drop_shadow_enabled").openWhenChecked=o.color===-1),UITools.setToolValue("transform",`drop_shadow_${n}`,o[n])}if(this._selectedTransformItem.type==="text"&&(document.getElementById("transform_text_curve_enabled").openWhenChecked=this._selectedTransformItem.textCurveAmount===null,UITools.setToolValue("transform","text_curve_enabled",this._selectedTransformItem.textCurveEnabled),UITools.setToolValue("transform","text_curve_amount",this._selectedTransformItem.textCurveAmount===null?BFN.CurvedTextManager.defaultCurveAmount:this._selectedTransformItem.textCurveAmount)),UITools.setToolValue("transform","opacity",this._selectedTransformItem.alpha*100),document.getElementById("transform_overlay_color_enabled").openWhenChecked=this._selectedTransformItem.overlayColor===-1,UITools.setToolValue("transform","overlay_color_enabled",this._selectedTransformItem.overlayColorEnabled),UITools.setToolValue("transform","overlay_color",this._selectedTransformItem.overlayColor),UITools.setToolValue("transform","overlay_color_intensity",this._selectedTransformItem.overlayColorIntensity),document.getElementById("transform_tint_color_enabled").openWhenChecked=this._selectedTransformItem.tintColor===-1,UITools.setToolValue("transform","tint_color_enabled",this._selectedTransformItem.tintColorEnabled),UITools.setToolValue("transform","tint_color",this._selectedTransformItem.tintColor),UITools.setToolValue("transform","blend_mode",this._selectedTransformItem.itemBlendMode),UITools.updateToolControls("transform"),UITools.getToolVO("transform").updating_id=t,this._selectedTransformItem.type==="frame_texture"&&this.transformToolFrame&&this.transformToolFrame.active&&this.transformToolFrame.transformItem===this._selectedTransformItem)UIToggler.openAlternateMenu("crop_image",["mask_image_crop_menu"]);else if(this._selectedTransformItem.type==="text")BFN.FabricManager.updateTextMenu(this._selectedTransformItem.getTextStyleData()),UIToggler.openAlternateMenu("text_properties",["text_menu","transform_menu","text_addon_menu","drop_shadow_menu"]),BFN.HelpClueManager.show("text_properties");else if(this._selectedTransformItem.isGoodie)if(r)UIToggler.openAlternateMenu(["shape_properties",{shape:()=>BeFunky.LanguageManager.getString(r.type)}],["shape_menu","transform_menu","drop_shadow_menu"]);else{let o=e.shapeColorMap&&e.shapeColorGroupsNum>(e.shapeObjectFills?0:1);if(o){let n=[];for(let l in e.shapeColorMap){let c=e.shapeColorMap[l];c.objects&&n.push({id:l,color:c.colorHash,intensity:c.colorOpacity})}document.getElementById("transform_graphic_color_group_color").colorGroup.setColorGroupData(n)}o?(UIToggler.openAlternateMenu("graphic_properties",["graphic_svg_color_menu","transform_menu","graphic_menu","drop_shadow_menu"]),BFN.HelpClueManager.show("graphic_properties")):UIToggler.openAlternateMenu("graphic_properties",["transform_menu","graphic_menu","drop_shadow_menu"])}else this._selectedTransformItem.type==="frame_texture"?(UITools.toggleControlItem("transform_blend_mode",!this._selectedTransformItem.hasOwnProperty("itemContentMask")),UITools.toggleElement("layer_mask_image_replace",!0),UIToggler.openAlternateMenu("image_properties",["layer_image_menu","transform_menu","graphic_menu","drop_shadow_menu"]),BFN.HelpClueManager.show("image_properties")):(UITools.toggleElement("layer_mask_image_replace",!1),UIToggler.openAlternateMenu("image_properties",["layer_image_menu","transform_menu","graphic_menu","drop_shadow_menu"]))}}else UIToggler.closeAlternateMenu();BFN.TransformLayerManager.updateSelectedItems()},get(){return this._selectedTransformItem}});Object.defineProperty(_t.prototype,"selectedTransformItemText",{set(i){this._selectedTransformItemText=null,i&&i.type==="text"&&(this._selectedTransformItemText=i,BFN.TransformItemBoundingBoxes.selectItems(this._selectedTransformItemText.getAvailableGroupItems())),this.dispatchEvent(BFN.TransformModelEvents.TRANSFORM_ITEM_TEXT_UPDATED),this._selectedTransformItemText&&(UITools.toggleElement("transform_text_curve_enabled",!1),UIToggler.openAlternateMenu("text_properties",["text_menu","transform_menu","text_addon_menu"]))},get(){return this._selectedTransformItemText}});Object.defineProperty(_t.prototype,"selectedGroupType",{get(){return this._selectedGroupType}});Object.defineProperty(_t.prototype,"awaitingDrop",{set(i){this._awaitingDrop!=i&&(this._awaitingDrop=i,i?BeFunky.globalPointerEvent.pointerType==="touch"&&BFN.TransformTouchDragManager.startTouchDragHoverDetection():BFN.TransformTouchDragManager.stopTouchDragHoverDetection()),this._focusedTransformItem&&this._focusedTransformItem.hideImageDropState()},get(){return this._awaitingDrop}});Object.defineProperty(_t.prototype,"focusedTransformItem",{set(i){this._focusedTransformItem&&this._focusedTransformItem!==i&&this._focusedTransformItem.hideImageDropState(),this._focusedTransformItem=i,this._focusedTransformItem&&this._focusedTransformItem.showImageDropState()},get(){return this._focusedTransformItem}});Object.defineProperty(_t.prototype,"targetTransformItem",{set(i){this._targetTransformItem=i},get(){return this._targetTransformItem}});Object.defineProperty(_t.prototype,"transformToolFrame",{get(){return this._selectedTransformItem&&this._selectedTransformItem.type==="frame_texture"?this._selectedTransformItem.transformTool.transformToolFrame:null}});BFN.SingletonQueue.add(()=>{BFN.TransformModel=new _t});BFN.TransformStateModelEvents={TRANSITIONS_UPDATED:new Event("TRANSITIONS_UPDATED")};function Ke(){BFN.EventDispatcher.call(this),this.init()}Ke.prototype=Object.create(BFN.EventDispatcher.prototype);Ke.prototype.init=function(){BeFunky.log("TransformStateModel Init"),this.initDefaultValues()};Ke.prototype.initDefaultValues=function(){this.blockAddedTransitions=!1,this.transitionsHash={},this.transitionIndexHash={},this.directionHash={},this.transitions=null,this.transitionIndex=null,this.batchTransitionID=null,this.safeBaseTextures=[],this.safeThumbImages=[],this.currentBatchID=null,this.nextBatchID=null,this.udc=null};Ke.prototype.startBulkTransition=function(i){this.batchTransitionID=i};Ke.prototype.stopBulkTransition=function(){this.batchTransitionID=null};Ke.prototype.addTransition=function(i){if(!this.blockAddedTransitions){if(i.batchID=this.batchTransitionID,i.transformItem&&!i.transformItem.thumbTexture&&!i.transformItem.thumbImage&&(i.transformItem.type=="text"||BeFunky.isSmartphone?(i.transformItem.thumbTexture=null,i.transformItem.thumbImage=null):(i.transformItem.thumbTexture=this.getThumb(i.transformItem),i.transformItem.thumbImage=null)),BFN.AppModel.viewState==BFN.AppModelViewStates.VIEWING_PHOTO_EDITOR)BFN.PhotoEditorHistoryModel.purgeLaterHistory();else if(BFN.AppModel.viewState==BFN.AppModelViewStates.VIEWING_COLLAGE_MAKER){let e=i.transformItem&&i.transformItem.itemContent.texture.baseTexture?i.transformItem.itemContent.texture.baseTexture:null;BFN.CollageMakerHistoryModel.purgeLaterHistory(e)}if(this.purgeLaterTransitions(i),this.transitions=this.getTransitions(),this.transitions.push(i),this.transitionIndex=this.transitions.length-1,this.setTransitionIndex(this.transitionIndex),this.direction="redo",this.tracePosition(),!i.batchID)if(i.alternateHistoryAction){let e=BFN.formatKeyString(i.id," ",["history"]);BFN.SentryManager.reportBreadcrumb(e,i.alternateHistoryAction,"app_history")}else if(i.batchIDPlaceholder){let e=i.id.includes("selection")&&BFN.SentryManager.getDisplayObjectInfo(BFN.TransformItemGroup)||"";BFN.SentryManager.reportBreadcrumb(e,BFN.formatKeyString(i.id,"_",["history"],!1),"app_history")}else i.transformItem&&BFN.SentryManager.reportBreadcrumb(BFN.SentryManager.getDisplayObjectInfo(i.transformItem),BFN.formatKeyString(i.id,"_",["history"],!1),"app_history");if(!i.batchID&&i.transformItem&&(i.id.includes("history_new")||i.id==="replace_image")){let e=i.transformItem,t=new BFN.UserActionVO;switch(i.id){case"history_new_text":t.eventID="text_added",t.eventObject={textType:"Freeform"};break;case"history_new_graphic":{t.eventID="image_layer_added";let r=e.isShape?e.basicShapeVO?"Basic Shape":"Vector":"Rasterized";t.eventObject={imageLayerTypes:[r],imageLayerSources:[e.assetOrigin]};let s={line:"Outline",solid:"Solid",color:"Multicolor"}[e.projectItemVO.graphicStyle];s&&(t.eventObject.imageLayerGraphicsStyle=[s]);break}case"history_new_image":case"replace_image":{t.eventID="image_layer_added";let r=e.isShape?e.basicShapeVO?"Basic Shape":"Vector":"Rasterized";t.eventObject={imageLayerTypes:[r],imageLayerSources:[e.assetOrigin]};break}}t.actionSection=BFN.AppModel.sectionID,t.actionTimestamp=i.timestamp,t.transformItem=e,t.register()}BFN.TextureHistoryManager.addTextureHistory(i.timestamp,null,i.transformItem?[i.transformItem.itemContent.texture]:[]),this.dispatchEvent(BFN.TransformStateModelEvents.TRANSITIONS_UPDATED)}};Ke.prototype.purgeLaterTransitions=function(i=null){if(BFN.UserActionManager.purgeInactiveUserActionVOs(),this.transitions=this.getTransitions(),this.transitionIndex=this.getTransitionIndex(),this.transitionIndex<this.transitions.length){let e=this.transitions[this.transitionIndex],t=[],r=BFN.AppModel.sectionValue(BFN.PhotoEditorCanvas,BFN.CollageMakerCanvas,BFN.DesignerCanvas).transformLayer;t.push(...r.children),t.includes(BFN.TransformItemGroup)&&t.splice(t.indexOf(BFN.TransformItemGroup),1);let a=this.direction=="redo"?this.transitionIndex+1:this.transitionIndex,s=[];for(let d=0;d<a;d++){let m=this.transitions[d];s.push(m.timestamp),m.transformItem&&!t.includes(m.transformItem)&&t.push(m.transformItem)}i&&i.transformItem&&!t.includes(i.transformItem)&&t.push(i.transformItem);let o=BFN.TextureHistoryManager.getBaseTextures(BFN.AppModel.viewState,s),n=t.map(d=>d.previewImage),l=t.map(d=>d.thumbImage);r.usedBaseTextures=BFN.GlobalHistoryModel.getUsedBaseTextures(r.appViewState);let c=a<this.transitions.length?this.transitions[a]:null,h=c!==null?c.endState.creationTime:null,u=[];for(let d=a;d<this.transitions.length;d++){let m=this.transitions[d];m.transformItem&&!u.includes(m.transformItem)&&(m.transformItem.destroyPresetItemThumbTextures(h),u.push(m.transformItem))}for(let d=a;d<this.transitions.length;d++){let m=this.transitions[d];m.previewTexture&&m.previewTexture.destroyGC(!0),m.previewTexture=null,m.previewImage&&!n.includes(m.previewImage)&&(m.previewImage.src=""),m.previewImage=null,m.thumbTexture&&m.thumbTexture.destroyGC(!0),m.thumbTexture=null,m.thumbImage&&!l.includes(m.thumbImage)&&!this.safeThumbImages.includes(m.thumbImage)&&(m.thumbImage.src=""),m.thumbImage=null,m.transformItem&&!t.includes(m.transformItem)&&!m.transformItem.destroyed&&this.hasCreateTransition(m.transformItem)&&(m.transformItem.preventBaseTextureDestroy=!1,i&&i.transformItem&&(m.transformItem.preventBaseTextureDestroy=i.transformItem.itemContent.texture.baseTexture==m.transformItem.itemContent.texture.baseTexture),m.transformItem.preventBaseTextureDestroy||(m.transformItem.preventBaseTextureDestroy=m.transformItem.preventBaseTextureDestroy||o.includes(m.transformItem.itemContent.texture.baseTexture)||this.safeBaseTextures.includes(m.transformItem.itemContent.texture.baseTexture)),m.transformItem.destroyItem(),m.transformItem=null)}this.transitions.splice(a),t.splice(0),this.transitionIndex=this.transitions.length-1,this.setTransitionIndex(this.transitionIndex),this.direction="redo",this.dispatchEvent(BFN.TransformStateModelEvents.TRANSITIONS_UPDATED)}};Ke.prototype.purgeEarlierTransitions=function(i,e,t){let r=0;this.transitions=this.getTransitions(i),this.transitionIndex=this.getTransitionIndex(i);let a=this.transitions.length;for(;--a>-1;){let s=this.transitions[a];if(s.timestamp<=e){let o=s.transformItem||null;if(o&&!o.destroyed){let n=o.itemContent.texture.baseTexture;if(!t.includes(n)){let l=n?n._destroyed:!0;o.destroyItem();let c=n?n._destroyed:!0;l!=c&&r++}s.transformItem=null}s.previewTexture&&s.previewTexture.destroyGC(!0),s.previewTexture=null,s.previewImage&&(s.previewImage.src=""),s.previewImage=null,(!o||o&&o.destroyed)&&(s.thumbTexture&&s.thumbTexture.destroyGC(!0),s.thumbImage&&(s.thumbImage.src="")),s.thumbTexture=null,s.thumbImage=null,this.transitions.splice(a,1),this.transitionIndex--}}return this.setTransitionIndex(this.transitionIndex,i),this.direction="redo",r};Ke.prototype.undo=function(i=!1){if(this.transitions=this.getTransitions(),this.transitionIndex=this.getTransitionIndex(),i||(this.currentBatchID=null,this.nextBatchID=null,this.udc=0),this.transitions.length&&(this.direction!="undo"||this.transitionIndex>0)){let e=this.transitions.length&&this.transitionIndex>0?this.transitions[this.transitionIndex-1].batchID!=null:!1;this.directionChanged=!1,this.direction!="undo"?(this.direction="undo",this.directionChanged=!0):this.setTransitionIndex(--this.transitionIndex);let t=this.transitions[this.transitionIndex];!i&&(t.batchID||t.batchIDPlaceholder)&&(this.currentBatchID=t.batchIDPlaceholder?t.batchIDPlaceholder:t.batchID),this.transitionIndex>0&&this.transitions[this.transitionIndex-1].batchID!=null&&(this.nextBatchID=this.transitions[this.transitionIndex-1].batchID),BeFunky.log("UNDO",t.batchID,this.currentBatchID),this.repeatAction=this.directionChanged&&t.startState.parent!=t.endState.parent&&!e,t.transformItem&&t.transformItem.setTransition(t),i&&!t.batchID?(this.direction="redo",t.transformItem?t.transformItem.applyTransformItemState(t.endState):t.alternateHistoryAction&&this.performAlternateHistoryAction(t.alternateHistoryAction,t.endState)):t.transformItem?t.transformItem.applyTransformItemState(t.startState):t.alternateHistoryAction&&this.performAlternateHistoryAction(t.alternateHistoryAction,t.startState),this.tracePosition(),(this.repeatAction||this.currentBatchID&&this.nextBatchID&&(t.batchID||t.batchIDPlaceholder)&&this.currentBatchID==this.nextBatchID&&(this.currentBatchID==t.batchID||this.currentBatchID==t.batchIDPlaceholder))&&this.undo(!0)}else++this.udc>10&&BeFunky.log("DIE")};Ke.prototype.redo=function(i=!1){if(this.transitions=this.getTransitions(),this.transitionIndex=this.getTransitionIndex(),i||(this.currentBatchID=null,this.nextBatchID=null),this.transitions.length&&(this.direction!="redo"||this.transitionIndex<this.transitions.length-1)){this.direction!="redo"?this.direction="redo":this.setTransitionIndex(++this.transitionIndex);let e=this.transitions[this.transitionIndex];if(!i&&e.batchID&&(this.currentBatchID=e.batchID),this.transitionIndex<this.transitions.length-1){let t=this.transitions[this.transitionIndex+1];t.batchID!==null?this.nextBatchID=t.batchID:t.batchIDPlaceholder===this.currentBatchID&&(this.nextBatchID=t.batchIDPlaceholder)}e.transformItem?(e.transformItem.setTransition(e),e.transformItem.applyTransformItemState(e.endState)):e.alternateHistoryAction&&this.performAlternateHistoryAction(e.alternateHistoryAction,e.endState),this.tracePosition(),this.currentBatchID&&this.nextBatchID&&e.batchID&&this.currentBatchID==this.nextBatchID&&this.currentBatchID==e.batchID?this.redo(!0):this.currentBatchID=="removeall"&&this.nextBatchID=="removeall"&&!e.batchID&&this.undo()}};Ke.prototype.applyAlternate=function(i,e,t){i==null&&(i=-1),e==null&&(e=!1),(t==null||isNaN(t))&&(t=-1),this.transitions=this.getTransitions();let r=!1;if(i>=0){for(let s=0;s<this.transitions.length;s++)if(this.transitions[s].timestamp==i){r=!0,this.setTransitionIndex(s);break}}if(e&&!r)return!1;this.transitionIndex=this.getTransitionIndex();let a=this.transitions[this.transitionIndex];return a.alternateHistoryAction&&a.timestamp>t&&(this.performAlternateHistoryAction(a.alternateHistoryAction,a.endState),BeFunky.log("APPLIED ALTERNATE",a.id)),!0};Ke.prototype.clearTransitions=function(i=null){let e=i||BFN.AppModel.viewState;this.transitions=this.getTransitions(e),this.transitionIndex=this.getTransitionIndex(e);for(let t=0;t<this.transitions.length;t++){let r=this.transitions[t];r.transformItem=null,r.previewTexture&&r.previewTexture.destroyGC(!0),r.previewTexture=null,r.previewImage&&(r.previewImage.src=""),r.previewImage=null,r.thumbTexture&&r.thumbTexture.destroyGC(!0),r.thumbTexture=null,r.thumbImage&&(r.thumbImage.src=""),r.thumbImage=null}this.transitions.splice(0),this.setTransitionIndex(0,e),this.dispatchEvent(BFN.TransformStateModelEvents.TRANSITIONS_UPDATED)};Ke.prototype.getTimestamp=function(){return this.transitions=this.getTransitions(),this.transitionIndex=this.getTransitionIndex(),this.transitions.length?this.transitions[this.transitionIndex].timestamp:NaN};Ke.prototype.getLastTimestamp=function(){return this.transitions=this.getTransitions(),this.transitionIndex=this.getTransitionIndex(),this.transitions.length&&(this.transitions.length>1&&this.transitionIndex>0||this.transitionIndex==0&&this.direction=="redo")?(this.direction=="undo"?this.transitions[this.transitionIndex-1]:this.transitions[this.transitionIndex]).timestamp:this.transitionIndex==0&&this.direction=="undo"?0:NaN};Ke.prototype.getNextTimestamp=function(){return this.transitions=this.getTransitions(),this.transitionIndex=this.getTransitionIndex(),this.transitionIndex<this.transitions.length-1||this.transitionIndex==this.transitions.length-1&&this.direction=="undo"?(this.direction=="redo"?this.transitions[this.transitionIndex+1]:this.transitions[this.transitionIndex]).timestamp:NaN};Ke.prototype.performAlternateHistoryAction=function(i,e){if(e&&e.collageSettings)switch(i){case"designer_background_color":break;case"collage_settings_updated":BFN.CollageMakerCanvasPhotoGridModel.collageSettings=e.collageSettings;break;case"designer_settings_updated":BFN.DesignerCanvasModel.designerSettings=e.designerSettings;break;case"collage_background_pattern":break}};Ke.prototype.getTransitions=function(i=null){let e=i||BFN.AppModel.viewState;return this.transitionsHash.hasOwnProperty(e)||(this.transitionsHash[e]=[]),this.transitionsHash[e]};Ke.prototype.getTransitionIndex=function(i=null){let e=i||BFN.AppModel.viewState;return this.transitionIndexHash.hasOwnProperty(e)||(this.transitionIndexHash[e]=0),this.transitionIndexHash[e]};Ke.prototype.setTransitionIndex=function(i,e){let t=e||BFN.AppModel.viewState;this.transitionIndexHash[t]=i};Ke.prototype.tracePosition=function(){let i="";for(let e=0;e<this.transitions.length;e++){let t=this.transitions[e];i+="[",i+=t.batchID?"~":" ",i+=this.transitionIndex==e?this.direction=="undo"?"<":">":" ",i+=t.batchID?"~":" ",i+="]"}i+=` ${this.transitionIndex}`,BeFunky.log("HISTORY: ",i)};Ke.prototype.getThumb=function(i){if(i){if(i.isShape&&i.basicShapeVO&&i.projectItemVO.type==="graphic"){this.thumbBasicShapeVO||(this.thumbBasicShapeVO=new BFN.BasicShapeVO("group",{fill:"FFFFFF",fillAlpha:1,stroke:-1,strokeAlpha:1,strokeWidth:0}),this.thumbBasicShapeVO.resize(BFN.GlobalHistoryModel.globalHistoryMenuThumbSize,BFN.GlobalHistoryModel.globalHistoryMenuThumbSize));let t=i.basicShapeVO.type==="line";this.thumbBasicShapeVO.setValues({type:i.basicShapeVO.type,stroke:t?"FFFFFF":-1,strokeAlpha:t?1:0,strokeWidth:t?BFN.GlobalHistoryModel.globalHistoryMenuThumbSize/5:0});let r=i.basicShapeVO.type==="arrow";this.thumbBasicShapeVO.resize(BFN.GlobalHistoryModel.globalHistoryMenuThumbSize,Math.round(BFN.GlobalHistoryModel.globalHistoryMenuThumbSize*(r?.7:1)));let a=PIXI.RenderTexture.create(BFN.GlobalHistoryModel.globalHistoryMenuThumbSize,BFN.GlobalHistoryModel.globalHistoryMenuThumbSize),s=this.thumbBasicShapeVO.getCanvasTexture();return a.copyPixels(s,{x:(a.width-s.width)/2,y:(a.height-s.height)/2}),s.destroyGC(!0),a}if(i.itemContent&&i.itemContent.texture){let r=i.isGoodie&&i.isShape&&BFN.SVGManager.textureHasModifiedShapeColors(i.itemContent.texture);r&&i.updateShapeTexture(!0,!0);let a;try{a=BFN.Util.getThumbTexture(i.itemContent.texture,BFN.GlobalHistoryModel.globalHistoryMenuThumbSize,!0,!1)}catch(s){}return r&&i.updateShapeTexture(),a}}let e=PIXI.RenderTexture.create(BFN.GlobalHistoryModel.globalHistoryMenuThumbSize,BFN.GlobalHistoryModel.globalHistoryMenuThumbSize);return e.fillColor(16711680),e};Ke.prototype.hasCreateTransition=function(i){for(let e=0;e<this.transitions.length;e++){let t=this.transitions[e];if(t.transformItem==i&&t.isCreateTransition)return!0}return!1};Object.defineProperty(Ke.prototype,"undoIsBatch",{get(){return this.transitions=this.getTransitions(),this.transitionIndex=this.getTransitionIndex(),this.transitions.length&&this.transitionIndex>0?this.direction=="redo"?this.transitions[this.transitionIndex].batchID:this.transitions[this.transitionIndex-1].batchID:null}});Object.defineProperty(Ke.prototype,"redoIsBatch",{get(){if(this.transitions=this.getTransitions(),this.transitionIndex=this.getTransitionIndex(),this.transitions.length){if(this.transitionIndex<this.transitions.length-1)return this.direction=="undo"?this.transitions[this.transitionIndex].batchID:this.transitions[this.transitionIndex+1].batchID;if(this.direction=="undo"&&this.transitionIndex==this.transitions.length-1)return this.transitions[this.transitionIndex].batchID}return null}});Object.defineProperty(Ke.prototype,"undoIsAlternate",{get(){return this.transitions=this.getTransitions(),this.transitionIndex=this.getTransitionIndex(),this.transitions.length?this.transitionIndex>0?this.direction=="redo"?this.transitions[this.transitionIndex].alternateHistoryAction!=null:this.transitions[this.transitionIndex-1].alternateHistoryAction!=null:this.transitions[0].alternateHistoryAction!=null:!1}});Object.defineProperty(Ke.prototype,"redoIsAlternate",{get(){return this.transitions=this.getTransitions(),this.transitionIndex=this.getTransitionIndex(),this.transitions.length?this.transitionIndex<this.transitions.length-1?this.direction=="undo"?this.transitions[this.transitionIndex].alternateHistoryAction!=null:this.transitions[this.transitionIndex+1].alternateHistoryAction!=null:this.transitions[this.transitions.length-1].alternateHistoryAction!=null:!1}});Object.defineProperty(Ke.prototype,"direction",{set(i){this.directionHash[BFN.AppModel.viewState]=i},get(){return this.directionHash.hasOwnProperty(BFN.AppModel.viewState)||(this.directionHash[BFN.AppModel.viewState]="redo"),this.directionHash[BFN.AppModel.viewState]}});Object.defineProperty(Ke.prototype,"currentTransition",{get(){return this.transitions=this.getTransitions(),this.transitionIndex=this.getTransitionIndex(),this.transitions.length?this.transitions[this.transitionIndex]:null}});BFN.SingletonQueue.add(()=>{BFN.TransformStateModel=new Ke});BFN.PhotoEditorHistoryModelEvents={HISTORY_UPDATED:new Event("HISTORY_UPDATED"),HISTORY_INDEX_UPDATED:new Event("HISTORY_INDEX_UPDATED")};function ii(){BFN.EventDispatcher.call(this),this.init()}ii.prototype=Object.create(BFN.EventDispatcher.prototype);ii.prototype.init=function(){BeFunky.log("PhotoEditorHistoryModel Init"),this.historyVOs=[],this._historyIndex=0,this.memoryFreed=!1};ii.prototype.addTextureToHistory=function(i,e,t){if(BFN.TransformStateModel.purgeLaterTransitions(),e){let r=this.historyVOs.length;for(;--r>this._historyIndex;){let o=this.historyVOs[r];o.imageTexture&&o.imageTexture!==BFN.PhotoEditorModel.sourceTexture&&(o.imageTexture.destroyGC(!0),o.previewTexture&&(o.previewTexture.destroyGC(!0),o.previewTexture=null),o.thumbTexture&&(o.thumbTexture.destroyGC(!0),o.thumbTexture=null)),o.imageTexture=null,o.thumbImage=null,o.previewImage=null,this.historyVOs.splice(r,1)}let a=new BFN.HistoryVO;a.id=this.historyVOs.length,a.name=i,a.translation=t||i,a.historyAction=i,a.imageTexture=e,a.imageW=a.imageTexture.width,a.imageH=a.imageTexture.height,BeFunky.isSmartphone||(a.previewTexture=BFN.Util.getThumbTextureGL(e,Math.min(Math.max(e.width,e.height),BFN.GlobalHistoryModel.globalHistoryMenuPreviewSize),!1,!1),a.previewW=a.previewTexture.width,a.previewH=a.previewTexture.height,a.thumbTexture=BFN.Util.getThumbTextureGL(e,BFN.GlobalHistoryModel.globalHistoryMenuThumbSize,!0,!1),a.thumbW=a.thumbTexture.width,a.thumbH=a.thumbTexture.height),this.historyVOs.push(a),this._historyIndex=this.historyVOs.length-1,this.historyIndex=this.historyIndex,BFN.TextureHistoryManager.addTextureHistory(a.timestamp),this.dispatchEvent(BFN.PhotoEditorHistoryModelEvents.HISTORY_UPDATED);let s=`${BFN.formatKeyString(i," ")} ( ${BFN.formatKeyString(BFN.PhotoEditorCanvasModel.viewState,"",["viewing"])} )`;return BFN.SentryManager.reportBreadcrumb(s,"image_edited","app_history"),a.timestamp}};ii.prototype.resetHistory=function(){let i=this.historyVOs.length;for(;--i>-1;){let e=this.historyVOs[i];e.imageTexture&&e.imageTexture!==BFN.PhotoEditorModel.sourceTexture&&e.imageTexture.destroyGC(!0),e.imageTexture=null,e.thumbTexture&&e.thumbTexture.destroyGC(!0),e.thumbTexture=null,e.thumbImage&&(e.thumbImage.src=""),e.thumbImage=null,e.previewTexture&&e.previewTexture.destroyGC(!0),e.previewTexture=null,e.previewImage&&(e.previewImage.src=""),e.previewImage=null}this.historyVOs.splice(0),this.memoryFreed=!1,this.dispatchEvent(BFN.PhotoEditorHistoryModelEvents.HISTORY_UPDATED)};ii.prototype.purgeLaterHistory=function(){let i=this.historyVOs.length;for(;--i>this.historyIndex;){let e=this.historyVOs[i];e.imageTexture&&e.imageTexture.destroyGC(!0),e.imageTexture=null,e.thumbTexture&&e.thumbTexture.destroyGC(!0),e.thumbTexture=null,e.thumbImage&&(e.thumbImage.src=""),e.thumbImage=null,e.previewTexture&&e.previewTexture.destroyGC(!0),e.previewTexture=null,e.previewImage&&(e.previewImage.src=""),e.previewImage=null,this.historyVOs.splice(i,1)}this.dispatchEvent(BFN.PhotoEditorHistoryModelEvents.HISTORY_UPDATED)};ii.prototype.purgeEarlierHistory=function(i,e){let t=0,r=this.historyVOs.length;for(;--r>-1;){let a=this.historyVOs[r];if(a.timestamp<=i){if(a.imageTexture&&a.imageTexture!==BFN.PhotoEditorModel.sourceTexture&&!e.includes(a.imageTexture.baseTexture)){let{baseTexture:s}=a.imageTexture,o=s?s._destroyed:!0;a.imageTexture.destroyGC(!0);let n=s?s._destroyed:!0;o!==n&&t++}a.imageTexture=null,a.thumbTexture&&a.thumbTexture.destroyGC(!0),a.thumbTexture=null,a.thumbImage&&(a.thumbImage.src=""),a.thumbImage=null,a.previewTexture&&a.previewTexture.destroyGC(!0),a.previewTexture=null,a.previewImage&&(a.previewImage.src=""),a.previewImage=null,this.historyVOs.splice(r,1),this.historyIndex--}}return this.memoryFreed=!!(t||this.memoryFreed),t};ii.prototype.undo=function(){if(this.historyVOs.length>1&&this._historyIndex>0){this.historyIndex--;let i=this.historyVOs[this._historyIndex];i.imageTexture?BFN.PhotoEditorModel.updateCurrentTexture(i.imageTexture):this.historyIndex++}};ii.prototype.redo=function(){if(this._historyIndex<this.historyVOs.length-1){this.historyIndex++;let i=this.historyVOs[this._historyIndex];i.imageTexture?BFN.PhotoEditorModel.updateCurrentTexture(i.imageTexture):this.historyIndex--}};ii.prototype.getTimestamp=function(){return this.historyVOs.length?this.historyVOs[this._historyIndex].timestamp:NaN};ii.prototype.getLastTimestamp=function(){return this.historyVOs.length&&this._historyIndex>0?this.historyVOs[this._historyIndex-1].timestamp:NaN};ii.prototype.getNextTimestamp=function(){return this.historyVOs.length&&this._historyIndex<this.historyVOs.length-1?this.historyVOs[this._historyIndex+1].timestamp:NaN};Object.defineProperty(ii.prototype,"historyIndex",{set(i){this._historyIndex=Math.max(0,Math.min(this.historyVOs.length-1,i)),this.dispatchEvent(BFN.PhotoEditorHistoryModelEvents.HISTORY_INDEX_UPDATED)},get(){return this._historyIndex}});Object.defineProperty(ii.prototype,"currentHistoryAction",{get(){return this.historyVOs.length?this.historyVOs[this._historyIndex].historyAction:null}});Object.defineProperty(ii.prototype,"lastHistoryAction",{get(){return this.historyVOs.length&&this._historyIndex>0?this.historyVOs[this._historyIndex-1].historyAction:null}});Object.defineProperty(ii.prototype,"nextHistoryAction",{get(){return this.historyVOs.length&&this._historyIndex<this.historyVOs.length-1?this.historyVOs[this._historyIndex+1].historyAction:null}});BFN.SingletonQueue.add(()=>{BFN.PhotoEditorHistoryModel=new ii});BFN.CollageMakerHistoryModelEvents={HISTORY_UPDATED:new Event("CANVAS_SCALE_UPDATED"),HISTORY_INDEX_UPDATED:new Event("CANVAS_SCALING_UPDATED"),APPLY_CURRENT_SNAPSHOT:new Event("ITEM_ADDED")};var Ih=class extends BFN.EventDispatcher{constructor(){super();this.init()}init(){BeFunky.log("CollageMakerHistoryModel Init"),this.initDefaultValues()}initDefaultValues(){this._ignoreSnapshot=!1,this._ignoreSnapshotApply=!1,this._historyAction=null,this._snapshotVOs=[],this._snapshotIndex=0,this._currentSnapshotVO=null,this._usedBaseTextures=[],this._focusedGridChild=null,this.lastFocusedGridChild=null}addPhotoGridSnapshotToHistory(e){this._focusedGridChild&&this._focusedGridChild===this.lastFocusedGridChild&&this.currentHistoryAction===e.historyAction?this.undo(!1):this.lastFocusedGridChild=null,BFN.TransformStateModel.purgeLaterTransitions();let t=[];if(this._snapshotIndex<this._snapshotVOs.length)for(let r=0;r<=this._snapshotIndex;r++){let a=this._snapshotVOs[r];a.backgroundPatternBaseTexture&&!t.includes(a.backgroundPatternBaseTexture)&&t.push(a.backgroundPatternBaseTexture);for(let s=0;s<a.snapshotChildren.length;s++){let o=a.snapshotChildren[s];o.texture&&o.texture.valid&&!t.includes(o.texture.baseTexture)&&t.push(o.texture.baseTexture)}}if(!this._ignoreSnapshot&&e){let r=this._snapshotVOs.length;for(;--r>this._snapshotIndex;){let s=this._snapshotVOs[r];try{s.thumbTexture.destroyGC(!0)}catch(o){}s.thumbTexture=null,s.thumbImage=null;try{s.previewTexture.destroyGC(!0)}catch(o){}s.previewTexture=null,s.previewImage=null,this._snapshotVOs.splice(r,1),this.updateUsedBaseTextures();for(let o=0;o<s.snapshotChildren.length;o++){let n=s.snapshotChildren[o];if(n.texture&&n.texture.valid){let l=this._usedBaseTextures.indexOf(n.texture.baseTexture),c=t.indexOf(n.texture.baseTexture);if(l===-1&&c===-1)try{n.texture.destroyGC(!0),console.log("disposing unused image - [ addPhotoGridSnapshotToHistory ]")}catch(h){}else console.log("avoiding dispose, image still used - [ addPhotoGridSnapshotToHistory ]")}n.texture=null}s.snapshotChildren.splice(0),s.snapshotChildren=null}let a=BFN.formatKeyString(e.historyAction," ");return BFN.SentryManager.reportBreadcrumb(a,"collage_edited","app_history"),this._snapshotVOs.push(e),this._snapshotIndex=this._snapshotVOs.length-1,this.snapshotIndex=this.snapshotIndex,BFN.TextureHistoryManager.addTextureHistory(e.timestamp),this.updateUsedBaseTextures(),t.splice(0),this.dispatchEvent(BFN.CollageMakerHistoryModelEvents.HISTORY_UPDATED),e.timestamp}}updateUsedBaseTextures(){this._usedBaseTextures.splice(0);for(let e=0;e<this._snapshotVOs.length;e++){let t=this._snapshotVOs[e];for(let r=0;r<t.snapshotChildren.length;r++){let a=t.snapshotChildren[r];a.texture&&a.texture.valid&&this._usedBaseTextures.indexOf(a.texture.baseTexture)===-1&&this._usedBaseTextures.push(a.texture.baseTexture)}}if(BFN.PhotoGrid.gridChildren.forEach(e=>{if(!e.content.isEmpty&&e.content.image&&e.content.image.frameSprite&&e.content.image.frameSprite.texture&&e.content.image.frameSprite.texture.baseTexture&&!e.content.image.frameSprite.texture.baseTexture.destroyed){let{baseTexture:t}=e.content.image.frameSprite.texture;this._usedBaseTextures.indexOf(t)===-1&&this._usedBaseTextures.push(t)}}),BFN.AppModel.viewState===BFN.AppModelViewStates.VIEWING_COLLAGE_MAKER){let e=BFN.TransformStateModel.getTransitions();for(let t=0;t<e.length;t++){let r=e[t];r.startState&&r.startState.imageTexture&&r.startState.imageTexture.valid&&this._usedBaseTextures.indexOf(r.startState.imageTexture.baseTexture)===-1&&this._usedBaseTextures.push(r.startState.imageTexture.baseTexture),r.endState&&r.endState.imageTexture&&r.endState.imageTexture.valid&&this._usedBaseTextures.indexOf(r.endState.imageTexture.baseTexture)===-1&&this._usedBaseTextures.push(r.endState.imageTexture.baseTexture)}}}resetHistory(){let e=BFN.GlobalHistoryModel.getUsedBaseTextures(BFN.AppModelViewStates.VIEWING_COLLAGE_MAKER),t=this._snapshotVOs.length;for(;--t>-1;){let r=this._snapshotVOs[t];try{r.thumbTexture.destroyGC(!0)}catch(a){}r.thumbTexture=null,r.thumbImage=null;try{r.previewTexture.destroyGC(!0)}catch(a){}r.previewTexture=null,r.previewImage=null;for(let a=0;a<r.snapshotChildren.length;a++){let s=r.snapshotChildren[a];if(s.texture&&s.texture.valid){if(e.indexOf(s.texture.baseTexture)===-1&&!s.menuImageVO.isPattern)try{s.texture.baseTexture&&s.texture.destroyGC(!0)}catch(n){}s.texture=null}}r.snapshotChildren.splice(0),r.snapshotChildren=null}this._snapshotVOs.splice(0),this.updateUsedBaseTextures(),this.dispatchEvent(BFN.CollageMakerHistoryModelEvents.HISTORY_UPDATED)}purgeLaterHistory(e=null){if(this._snapshotVOs.length){let t=BFN.GlobalHistoryModel.getUsedBaseTextures(BFN.AppModelViewStates.VIEWING_COLLAGE_MAKER);e&&!t.includes(e)&&t.push(e),BFN.TransformStateModel.safeBaseTextures.forEach(s=>{t.includes(s)||t.push(s)});let r=[];for(let s=0;s<=this._snapshotIndex;s++){let o=this._snapshotVOs[s];o.backgroundPatternBaseTexture&&!r.includes(o.backgroundPatternBaseTexture)&&r.push(o.backgroundPatternBaseTexture);for(let n=0;n<o.snapshotChildren.length;n++){let l=o.snapshotChildren[n];l.texture&&l.texture.valid&&!r.includes(l.texture.baseTexture)&&r.push(l.texture.baseTexture)}}let a=this._snapshotVOs.length;for(;--a>this._snapshotIndex;){let s=this._snapshotVOs[a];try{s.thumbTexture.destroyGC(!0)}catch(o){}s.thumbTexture=null,s.thumbImage=null;try{s.previewTexture.destroyGC(!0)}catch(o){}s.previewTexture=null,s.previewImage=null;for(let o=0;o<s.snapshotChildren.length;o++){let n=s.snapshotChildren[o];if(n.texture&&n.texture.valid&&n.texture.baseTexture&&!n.texture.baseTexture.isPattern){let l=t.indexOf(n.texture.baseTexture),c=r.indexOf(n.texture.baseTexture);if(l===-1&&c===-1)try{n.texture.destroyGC(!0)}catch(h){}}}s.snapshotChildren.splice(0),s.snapshotChildren=null,this._snapshotVOs.splice(a,1)}r.splice(0),this.dispatchEvent(BFN.CollageMakerHistoryModelEvents.HISTORY_UPDATED)}}purgeEarlierHistory(e,t){let r=!1;if(this._snapshotVOs.length){let a=this._snapshotVOs.length;for(;--a>-1;){let s=this._snapshotVOs[a];if(s.timestamp<=e){try{s.thumbTexture.destroyGC(!0)}catch(o){}s.thumbTexture=null,s.thumbImage=null;try{s.previewTexture.destroyGC(!0)}catch(o){}s.previewTexture=null,s.previewImage=null;for(let o=0;o<s.snapshotChildren.length;o++){let n=s.snapshotChildren[o];if(n.texture&&n.texture.baseTexture){let{baseTexture:l}=n.texture,c=l?l._destroyed:!0;n.texture.destroyGC(!t.includes(n.texture.baseTexture));let h=l?l._destroyed:!0;c!=h&&r++}}s.snapshotChildren.splice(0),s.snapshotChildren=null,this._snapshotVOs.splice(a,1),this._snapshotIndex--}}}return r}undo(e=!0){this._snapshotVOs.length>1&&this._snapshotIndex>0&&(this.snapshotIndex--,e&&this.applySnapshot())}redo(e=!0){this._snapshotIndex<this._snapshotVOs.length-1&&(this.snapshotIndex++,e&&this.applySnapshot())}applySnapshot(){if(!this._ignoreSnapshotApply){let e=this._snapshotVOs[this._snapshotIndex];this._currentSnapshotVO=e,this.dispatchEvent(BFN.CollageMakerHistoryModelEvents.APPLY_CURRENT_SNAPSHOT),this._currentSnapshotVO=null,this.updateUsedBaseTextures()}}getTimestamp(){return this._snapshotVOs.length?this._snapshotVOs[this._snapshotIndex].timestamp:NaN}getLastTimestamp(){return this._snapshotVOs.length&&this._snapshotIndex>0?this._snapshotVOs[this._snapshotIndex-1].timestamp:NaN}getNextTimestamp(){return this._snapshotVOs.length&&this._snapshotIndex<this._snapshotVOs.length-1?this._snapshotVOs[this._snapshotIndex+1].timestamp:NaN}textureInUse(e){return this._usedBaseTextures.indexOf(e)!==-1}get currentSnapshotVO(){return this._currentSnapshotVO}set ignoreSnapshot(e){this._ignoreSnapshot=e}get ignoreSnapshot(){return this._ignoreSnapshot}set ignoreSnapshotApply(e){this._ignoreSnapshotApply=e}get ignoreSnapshotApply(){return this._ignoreSnapshotApply}get usedBaseTextures(){return this._usedBaseTextures}set historyAction(e){this._historyAction=e}get historyAction(){return this._historyAction}set focusedGridChild(e){this._focusedGridChild&&(this.lastFocusedGridChild=this._focusedGridChild),this._focusedGridChild=e}get focusedGridChild(){return this._focusedGridChild}get snapshotVOs(){return this._snapshotVOs}set snapshotIndex(e){this._snapshotIndex=Math.max(0,Math.min(this._snapshotVOs.length-1,e)),this.dispatchEvent(BFN.CollageMakerHistoryModelEvents.HISTORY_INDEX_UPDATED)}get snapshotIndex(){return this._snapshotIndex}get currentHistoryAction(){return this._snapshotVOs.length?this._snapshotVOs[this._snapshotIndex].historyAction:null}get lastHistoryAction(){return this._snapshotVOs.length&&this._snapshotIndex>0?this._snapshotVOs[this._snapshotIndex-1].historyAction:null}get nextHistoryAction(){return this._snapshotVOs.length&&this._snapshotIndex<this._snapshotVOs.length-1?this._snapshotVOs[this._snapshotIndex+1].historyAction:null}};BFN.SingletonQueue.add(()=>{BFN.CollageMakerHistoryModel=new Ih});BFN.GlobalHistoryModelEvents={HISTORY_UPDATED:new Event("HISTORY_UPDATED"),HISTORY_ID_UPDATED:new Event("HISTORY_ID_UPDATED"),HISTORY_BUTTONS_UPDATED:new Event("HISTORY_BUTTONS_UPDATED"),SELECT_HISTORY_ITEM:new Event("SELECT_HISTORY_ITEM")};var _h=class extends BFN.EventDispatcher{constructor(){super();this.init()}init(){BeFunky.log("GlobalHistoryModel Init"),this.initDefaultValues()}initDefaultValues(){this.logTextureMemory=!1;let e=BeFunky.isRetina();this.globalHistoryMenuThumbSize=BFN.CSS.historyMenuThumbSize*(e?2:1),this.globalHistoryMenuPreviewSize=BFN.CSS.historyMenuPreviewSize*(e?1.5:1),this.selectedHistoryID={},this.selectedHistoryID[BFN.AppModelViewStates.VIEWING_PHOTO_EDITOR]=null,this.selectedHistoryID[BFN.AppModelViewStates.VIEWING_COLLAGE_MAKER]=null,this.selectedHistoryID[BFN.AppModelViewStates.VIEWING_DESIGNER]=null,this.historyItemPrefixHash={},this.historyItemPrefixHash[BFN.AppModelViewStates.VIEWING_PHOTO_EDITOR]="history_item_editor_",this.historyItemPrefixHash[BFN.AppModelViewStates.VIEWING_COLLAGE_MAKER]="history_item_collage_",this.historyItemPrefixHash[BFN.AppModelViewStates.VIEWING_DESIGNER]="history_item_designer_",this.historyItemPrefix=this.historyItemPrefixHash[BFN.AppModel.viewState],this.globalHistoryVOs=[],this.globalHistoryVOHash={},this.historyUpdateQueued=!1,BFN.AppModel.addEventListener(BFN.AppModelEvents.VIEWSTATE_UPDATED.type,this.handleAppModelViewstateUpdated.bind(this)),BFN.TransformStateModel.addEventListener(BFN.TransformStateModelEvents.TRANSITIONS_UPDATED.type,this.handleTransitionsUpdated.bind(this)),BFN.PhotoEditorHistoryModel.addEventListener(BFN.PhotoEditorHistoryModelEvents.HISTORY_UPDATED.type,this.handlePhotoEditorHistoryUpdated.bind(this)),BFN.CollageMakerHistoryModel.addEventListener(BFN.CollageMakerHistoryModelEvents.HISTORY_UPDATED.type,this.handleCollageMakerHistoryUpdated.bind(this)),this.addEventListener(BFN.GlobalHistoryModelEvents.SELECT_HISTORY_ITEM.type,this.handleSelectHistoryItem.bind(this)),setTimeout(()=>{BFN.UndoManager.addEventListener(BFN.UndoManagerEvents.TIMESTAMP_UPDATED.type,this.handleUndoManagerTimestampUpdated.bind(this))},50)}queueHistoryUpdate(){this.historyUpdateQueued||(this.historyUpdateQueued=!0,setTimeout(()=>{BFN.MainUI.addIdleRenderFunction(()=>{this.historyUpdateQueued=!1,this.updateHistory()})},200))}getTimestamps(e=null){e=e||BFN.AppModel.viewState;let t=[];return BFN.TransformStateModel.getTransitions(e).forEach(a=>{t.push(a.timestamp)}),e==BFN.AppModelViewStates.VIEWING_PHOTO_EDITOR?BFN.PhotoEditorHistoryModel.historyVOs.forEach(a=>{t.push(a.timestamp)}):t.includes(0)||t.push(0),e==BFN.AppModelViewStates.VIEWING_COLLAGE_MAKER&&BFN.CollageMakerHistoryModel.snapshotVOs.forEach(a=>{t.push(a.timestamp)}),t.sort((a,s)=>a-s),t}cleanupHistory(){let e=h=>Math.round(h*100)/100,t=()=>{let h=BFN.CollageMakerPatternManager.destroyUnusedPatternBaseTextures();return this.logTextureMemory&&h>0&&console.log(`Texture Memory: Clear ${e(h)} MB of Pattern Memory`),h>0},r=Math.min(BFN.textureHistoryMemoryLimitMB,BFN.TextureHistoryManager.allowedTextureMegaBytes),a=BFN.AppModel.getAppTextureMemoryMB(),s=r-a,o=s<0?Math.abs(s):0,n=(h=!1)=>{!this.logTextureMemory||(h&&console.log(""),a=BFN.AppModel.getAppTextureMemoryMB(),console.log(`Texture Memory: Using ${e(a)} MB / ${e(r)} MB`))};if(n(!0),!o){let h=t();if(!this.logTextureMemory)return;h>0?n():console.log("Texture Memory: Unnecessary to Clear Memory from History"),console.log("");return}let l=[BFN.ImageEditManager.editingImage?BFN.ImageEditManager.targetViewstate:BFN.AppModel.viewState];for(let h in BFN.AppModelViewStates)l.includes(h)||l.splice(0,0,h);let c=!1;for(let h=0;h<l.length;h++){let u=l[h],d=BFN.TextureHistoryManager.getTextureHistoryStatus(u).megabytes,m=Math.max(0,d-o);if(BFN.TextureHistoryManager.cleanupTextureHistory(u,m)){c=!0,BFN.TextureHistoryManager.updateTextureHistory(this.getTimestamps(u),u);let g=BFN.AppModel.getAppTextureMemoryMB(),f=a-g;if(this.logTextureMemory&&f>0&&console.log(`Texture Memory: Clear ${e(f)} MB from ${u.replace("VIEWING_","")} History`),a=g,s=r-a,o=s<0?Math.abs(s):0,!o)break}}c=t()>0||c,!!this.logTextureMemory&&(c?n():console.log("Texture Memory: Unable to Clear Memory from History"),console.log(""))}updateHistory(){BFN.TextureHistoryManager.updateTextureHistory(this.getTimestamps()),BFN.TextureHistoryManager.printTextureHistory(),this.cleanupHistory(),this.globalHistoryVOs.splice(0);let e=BFN.TextureHistoryManager.historyModifiedHash[BFN.AppModel.viewState];if(BFN.AppModel.viewState!=BFN.AppModelViewStates.VIEWING_PHOTO_EDITOR&&!e){let a=new BFN.GlobalHistoryVO;a.timestamp=0,BFN.AppModel.viewState==BFN.AppModelViewStates.VIEWING_COLLAGE_MAKER?BFN.CollageMakerCanvasPhotoGridModel.freeform&&(a.historyTag="blank_canvas",a.thumbImage=this.blankThumbImage,this.globalHistoryVOs.push(a)):(a.historyTag="new_template",a.thumbImage=this.blankThumbImage,this.globalHistoryVOs.push(a))}let t=BFN.TransformStateModel.getTransitions();for(let a=0;a<t.length;a++){let s=t[a];if(!s.batchID){let o=new BFN.GlobalHistoryVO;o.timestamp=s.timestamp,o.historyTag=s.id,o.historyTranslation=s.translation,o.thumbImage=null,o.isText=s.transformItem&&s.transformItem.type==="text",o.useTextIcon=s.useTextIcon,o.isGroup=!!s.batchIDPlaceholder&&!s.isSettingsTransition&&!s.transformItem&&!o.useTextIcon,o.useGroupIcon=s.useGroupIcon,!o.isText&&!o.useTextIcon&&(s.transformItem?(s.transformItem.itemObject.thumbImage&&(s.transformItem.thumbImage=s.transformItem.itemObject.thumbImage,delete s.transformItem.itemObject.thumbImage),!s.transformItem.thumbImage&&s.transformItem.thumbTexture&&(s.transformItem.thumbImage=BFN.Util.getHTMLImage(s.transformItem.thumbTexture,null,!0),s.transformItem.thumbTexture.destroyGC(!0),s.transformItem.thumbTexture=null),!s.thumbImage&&s.transformItem.thumbImage&&(s.thumbImage=s.transformItem.thumbImage),s.thumbImage&&(o.thumbImage=s.thumbImage)):(!s.previewImage&&s.previewTexture&&(s.previewImage=BFN.Util.getHTMLImage(s.previewTexture,null,!0),s.previewTexture.destroyGC(!0),s.previewTexture=null),s.previewImage&&(o.previewImage=s.previewImage),!s.thumbImage&&s.thumbTexture&&(s.thumbImage=BFN.Util.getHTMLImage(s.thumbTexture,null,!0),s.thumbTexture.destroyGC(!0),s.thumbTexture=null),s.thumbImage&&(o.thumbImage=s.thumbImage))),this.globalHistoryVOs.push(o)}}if(BFN.AppModel.viewState==BFN.AppModelViewStates.VIEWING_PHOTO_EDITOR)for(let a=0;a<BFN.PhotoEditorHistoryModel.historyVOs.length;a++){let s=BFN.PhotoEditorHistoryModel.historyVOs[a],o=new BFN.GlobalHistoryVO;o.timestamp=s.timestamp,o.historyTag=s.historyAction,o.historyTranslation=s.translation,o.thumbImage=null,o.previewImage=null,!s.previewImage&&s.previewTexture&&(s.previewImage=BFN.Util.getHTMLImage(s.previewTexture,null,!0),s.previewTexture.destroyGC(!0),s.previewTexture=null),s.previewImage&&(o.previewImage=s.previewImage),!s.thumbImage&&s.thumbTexture&&(s.thumbImage=BFN.Util.getHTMLImage(s.thumbTexture,null,!0),s.thumbTexture.destroyGC(!0),s.thumbTexture=null),s.thumbImage&&(o.thumbImage=s.thumbImage),this.globalHistoryVOs.push(o)}if(BFN.AppModel.viewState==BFN.AppModelViewStates.VIEWING_COLLAGE_MAKER)for(let a=0;a<BFN.CollageMakerHistoryModel.snapshotVOs.length;a++){let s=BFN.CollageMakerHistoryModel.snapshotVOs[a],o=new BFN.GlobalHistoryVO;o.timestamp=s.timestamp,o.historyTag=s.historyAction,o.thumbImage=null,o.previewImage=null,!s.previewImage&&s.previewTexture&&(s.previewImage=BFN.Util.getHTMLImage(s.previewTexture,null,!0),s.previewTexture.destroyGC(!0),s.previewTexture=null),s.previewImage&&(o.previewImage=s.previewImage),!s.thumbImage&&s.thumbTexture&&(s.thumbImage=BFN.Util.getHTMLImage(s.thumbTexture,null,!0),s.thumbTexture.destroyGC(!0),s.thumbTexture=null),s.thumbImage&&(o.thumbImage=s.thumbImage),this.globalHistoryVOs.push(o)}this.globalHistoryVOs.sort((a,s)=>a.timestamp-s.timestamp),this.globalHistoryVOHash={},BFN.GlobalHistoryModelEvents.HISTORY_UPDATED.ids=[],BFN.GlobalHistoryModelEvents.HISTORY_UPDATED.data=[],BFN.GlobalHistoryModelEvents.HISTORY_UPDATED.selectedID=this.selectedHistoryID[BFN.AppModel.viewState];for(let a=0;a<this.globalHistoryVOs.length;a++){let s=this.globalHistoryVOs[a],o=this.historyItemPrefix+s.timestamp;this.globalHistoryVOHash[o]=s,BFN.GlobalHistoryModelEvents.HISTORY_UPDATED.ids.push(o),BFN.GlobalHistoryModelEvents.HISTORY_UPDATED.data.push({id:o,name:s.historyTag,translation:s.historyTranslation||s.historyTag,thumb:s.thumbImage,preview:s.previewImage,isText:s.isText,isGroup:s.isGroup,useTextIcon:s.useTextIcon,useGroupIcon:s.useGroupIcon})}this.dispatchEvent(BFN.GlobalHistoryModelEvents.HISTORY_UPDATED),this.updateGlobalHistoryMenuState(this.globalHistoryVOs.length>0),this.updateGlobalHistoryButtons();let r=this.selectedHistoryID[BFN.AppModel.viewState];r&&this.globalHistoryVOHash.hasOwnProperty(r)&&(BFN.GlobalHistoryModelEvents.HISTORY_ID_UPDATED.data=r,BFN.GlobalHistoryModel.dispatchEvent(BFN.GlobalHistoryModelEvents.HISTORY_ID_UPDATED))}updateGlobalHistoryMenuState(e=!0){}updateGlobalHistoryButtons(){let e=BFN.UndoManager.undoExists,t=BFN.UndoManager.redoExists;BFN.AppModel.viewState==BFN.AppModelViewStates.VIEWING_PHOTO_EDITOR&&BFN.PhotoEditorCanvasModel.viewState!=BFN.PhotoEditorCanvasModelViewStates.VIEWING_CANVAS&&!BFN.ImagePainterUndoManager.imagePainterOpen&&(e=!0),BFN.GlobalHistoryModelEvents.HISTORY_BUTTONS_UPDATED.data={undoExists:e,redoExists:t},BFN.GlobalHistoryModel.dispatchEvent(BFN.GlobalHistoryModelEvents.HISTORY_BUTTONS_UPDATED)}getUsedBaseTextures(e=null,t=!0){let r=Object.values(BFN.ProjectManager.projectImageBaseTextures);t&&Object.values(BFN.PatchManager.clipboardBaseTextures).forEach(n=>{a(n)}),Object.values(BFN.AppModelViewStates).forEach(o=>{o!=e&&(BFN.TextureHistoryManager.getBaseTextures(o).forEach(h=>{r.includes(h)||r.push(h)}),BFN.AppModel.getSectionValue(o,BFN.PhotoEditorCanvas,BFN.CollageMakerCanvas,BFN.DesignerCanvas).transformLayer.children.filter(h=>h instanceof BFN.TransformItem).forEach(h=>{h.itemContent&&s(h.itemContent.texture),h.itemContentMask&&s(h.itemContentMask.texture)}),BFN.TransformStateModel.getTransitions(o).forEach(({transformItem:h,startState:u,endState:d})=>{h&&h.itemContentMask&&s(h.itemContentMask.texture),u&&s(u.imageTexture),d&&s(d.imageTexture)}),BFN.CollageMakerCanvasPhotoGrid.pendingAutoCollageBaseTextures.forEach(h=>{r.includes(h)||r.push(h)}))}),e!=BFN.AppModelViewStates.VIEWING_COLLAGE_MAKER&&BFN.CollageMakerHistoryModel.snapshotVOs&&BFN.CollageMakerHistoryModel.snapshotVOs.forEach(o=>{o.snapshotChildren&&o.snapshotChildren.forEach(n=>{s(n.texture)})}),e!=BFN.AppModelViewStates.VIEWING_PHOTO_EDITOR&&BFN.PhotoEditorHistoryModel.historyVOs&&BFN.PhotoEditorHistoryModel.historyVOs.forEach(o=>{s(o.imageTexture)});function a(o){o&&!r.includes(o)&&r.push(o)}function s(o){o&&a(o.baseTexture)}return r}handleAppModelViewstateUpdated(e){this.historyItemPrefix=this.historyItemPrefixHash[BFN.AppModel.viewState],this.queueHistoryUpdate()}handleTransitionsUpdated(e){this.selectedHistoryID[BFN.AppModel.viewState]=null,this.queueHistoryUpdate()}handlePhotoEditorHistoryUpdated(e){this.selectedHistoryID[BFN.AppModel.viewState]=null,BFN.AppModel.viewState==BFN.AppModelViewStates.VIEWING_PHOTO_EDITOR&&this.queueHistoryUpdate()}handleCollageMakerHistoryUpdated(e){this.selectedHistoryID[BFN.AppModel.viewState]=null,BFN.AppModel.viewState==BFN.AppModelViewStates.VIEWING_COLLAGE_MAKER&&this.queueHistoryUpdate()}handleSelectHistoryItem(e){if(e.data&&this.globalHistoryVOHash.hasOwnProperty(e.data)){let t=this.globalHistoryVOHash[e.data];BFN.UndoManager.gotoTimestamp(t.timestamp)}}updateSelectedHistoryID(){this.selectedHistoryID[BFN.AppModel.viewState]=this.historyItemPrefix+BFN.UndoManager.getTimestamp()}handleUndoManagerTimestampUpdated(e){this.updateSelectedHistoryID(),BFN.GlobalHistoryModelEvents.HISTORY_ID_UPDATED.data=this.selectedHistoryID[BFN.AppModel.viewState],BFN.GlobalHistoryModel.dispatchEvent(BFN.GlobalHistoryModelEvents.HISTORY_ID_UPDATED),this.updateGlobalHistoryButtons()}get blankThumbImage(){return this.blankThumbTexture||(this.blankThumbTexture=PIXI.RenderTexture.create(this.globalHistoryMenuThumbSize,this.globalHistoryMenuThumbSize),this.blankThumbTexture.fillColor(15922165),this._blankThumbImage=BFN.Util.getHTMLImage(this.blankThumbTexture)),this._blankThumbImage}};BFN.SingletonQueue.add(()=>{BFN.GlobalHistoryModel=new _h});BFN.PhotoEditorModelEvents={SOURCE_IMAGE_UPDATED:new Event("SOURCE_IMAGE_UPDATED"),CURRENT_IMAGE_UPDATED:new Event("CURRENT_IMAGE_UPDATED"),CURRENT_IMAGE_RESET:new Event("CURRENT_IMAGE_RESET"),EDITOR_IMAGE_LOAD_COMPLETE:new Event("EDITOR_IMAGE_LOAD_COMPLETE"),EDITOR_IMAGE_LOAD_ERROR:new Event("EDITOR_IMAGE_LOAD_ERROR"),PROJECT_UPDATED:new Event("PROJECT_UPDATED")};var Ch=class extends BFN.EventDispatcher{constructor(){super();this.init()}init(){BeFunky.log("PhotoEditorModel Init"),this.initDefaultValues(),this.updateProjectVO=BeFunky.debounce(this.updateProjectVO.bind(this),10),this.webcamModal=null}initDefaultValues(){this.sourceTexture=BFN.renderTexturesPool[0].texture,this._currentTexture=null,this.currentTextureDimensions={width:-1,height:-1},this.currentTextureBlobSaveTimeout=null,this.currentTextureBlobSaveInProgress=!1,this.currentEXIF=null,this._projectVO=new BFN.ProjectVO,this._projectVO.version=2,this._projectVO.section="editor"}openSampleImage(e,t=!1){t&&(BFN.DeepLinkManager.isNeedToOpenTouchUp=!0),BFN.BfnService.ToJsUrlUploader(e,"BeFunky-sample","sample")}confirmEditorLoadImage(e,t){this.currentTexture&&(!BFN.UnsavedOpenProjectManager.getSaved("editor")||BFN.PhotoEditorCanvasModel.viewState!==BFN.PhotoEditorCanvasModelViewStates.VIEWING_CANVAS&&BFN.PhotoEditorCanvasTools.currentTool)?BeFunky.confirm("confirm_photo_change",{onConfirm:e,onCancel:t,confirmText:"yes",cancelText:"no"}):e()}handleEditorLoadImage(){let e={allowMultiple:!1,createMenuImageVO:!1};BFN.MultipleFileUploader.upload(this.onEditorImageUpload.bind(this),e)}onEditorImageUpload({file:e}){if(!e)return;BFN.BfnService.track("CREATE","UPLOAD","DESKTOP"),BFN.BfnService.trackMediaOpened("image","computer");let t=e.name?e.name.replace(/\.[^/.]+$/,""):"";this.loadNewImage(e,{filename:t,reportImageSize:!0})}loadNewImage(e,{showLoadScreen:t=!0,filename:r="",callback:a=()=>{},clearLocalAssets:s=!BFN.ImageEditManager.editingImage,saveBlobAsIs:o=!1,reportImageSize:n=!1,hasUnsavedChanges:l=!1}={}){let c=!1;t&&BeFunky.showLoadScreen({onCancel:()=>{c=!0}});let h=(u,d)=>{BFN.PhotoEditorCanvasModel.exitCurrentEditorTool();let m;o&&(e instanceof Blob||BFN.ProjectService.isPixelObject(e))&&(m=e),this.handleTextureLoaded(u,s,m),BFN.UnsavedOpenProjectManager.setSaved("editor",!l,"new image"),typeof r=="string"&&(BFN.UploadSaveShareManager.setFileName("editor","image",r),BFN.UploadSaveShareManager.setFileName("editor","project",r),this._projectVO.filename=r),this.currentEXIF=d||null};if(BFN.ProjectService.isPixelObject(e)){let u=BFN.TextureUtils.pixelsToRenderTexture(e.pixels,e.width,e.height);a({success:!0}),(u.width>BFN.maxImageSize||u.height>BFN.maxImageSize)&&BeFunky.reportWarning("Photo Editor texture too large",u.width,u.height),h(u,e.exif)}else{let u={textureSize:BFN.maxImageSize,reportImageSize:n};BFN.TextureUtils.blobOrBase64ToTexture(e,({error:d,texture:m,exif:p})=>{if(c)return;t&&BeFunky.hideLoadScreen();let g=Boolean(m&&m.width);if(a({success:g}),!g)return this.handleTextureFileLoaderTextureError(d,e instanceof Blob?e:void 0);h(m,p)},u)}}openWebcamModal(){this.webcamModal||(this.webcamModal=document.getElementById("webcam_modal"),BFN.UI.webcamModal(this.webcamModal)),this.webcamModal.open()}updateCurrentTexture(e){e!=null&&(this.currentTexture=e,this.dispatchEvent(BFN.PhotoEditorModelEvents.CURRENT_IMAGE_UPDATED),this.saveCurrentTextureBlob(),this.updateProjectVO(!1))}saveCurrentTextureBlob(e=2e3,t){let r=()=>{if(this.currentTextureBlobSaveInProgress||BFN.ImageEditManager.editingImage)return;this.currentTextureBlobSaveInProgress=!0,(t?Promise.resolve(t):this.getCurrentTextureBlob(!0,!0)).then(s=>BFN.ProjectService.setLocalAsset("editor","image","editor_canvas_image",s)).then(()=>{this.currentTextureBlobSaveInProgress=!1}).catch(s=>{BeFunky.logWarning("Unable to autosave editor main image",s),this.currentTextureBlobSaveInProgress=!1,this.currentTexture&&this.currentTexture.valid&&this.saveCurrentTextureBlob(e)})};clearTimeout(this.currentTextureBlobSaveTimeout),this.currentTextureBlobSaveTimeout=setTimeout(r,e)}async getCurrentTextureBlob(e=!0,t=!1){let{autoSaveID:r}=this.currentTexture||{},a=()=>this.currentTexture?this.currentTexture.valid?this.currentTexture.autoSaveID!==r?"texture_changed":!1:"invalid_texture":"no_texture",s=()=>{let g=a();if(g)throw g},o=Date.now(),n=(...g)=>BeFunky.logFeature("editor_image",...g),l=g=>{n(r,g,Date.now()-o),o=Date.now()},c=()=>{if(!!e)return new Promise((g,f)=>{BFN.MainUI.addIdleRenderFunction(()=>{if(a())return f(a());l("idle"),g()})})};s();let h=this.currentTexture.determineTransparency();if(l("check transparency"),await c(),t)return{pixels:BFN.TextureUtils.textureToPixels(this.currentTexture),width:this.currentTexture.width,height:this.currentTexture.height,isTransparent:h,exif:this.currentEXIF};let u=BeFunky.isFirefox?.99:1,d=BFN.TextureUtils.textureToCanvas(this.currentTexture,{isTransparent:h,useBuffer:!0});l("texture -> canvas"),await c();let m=await BFN.BlobUtils.canvasToBlob(d.canvas,h?"image/png":"image/jpeg",u);if(d.destroyAll(),d=null,l("canvas -> blob"),s(),m.type==="image/png")return m;await c();let p;try{p=await BFN.ExifTool.insert(m,this.currentEXIF),l("add EXIF")}catch(g){BeFunky.logError("Unable to add EXIF data to image blob. Falling back to original blob.",g)}return s(),p||m}updateProjectVO(e=!0,t=!0){let r=Boolean(this.currentTexture&&this.currentTexture.valid);this._projectVO.projectWidth=r?this.currentTexture.width:0,this._projectVO.projectHeight=r?this.currentTexture.height:0,this._projectVO.editorImageBase64=null,e&&BFN.ProjectManager.updateProjectVOItems(this,BFN.PhotoEditorCanvas.transformLayer),this._projectVO.transformGroups=BFN.GroupManager.getSectionGroupObjects("editor",!0),t&&BFN.ProjectManager.requestLocalSave({sectionID:"editor",allowReset:!r})}applySourceTexture(e=!0,t){this.currentTexture&&this.currentTexture!==this.sourceTexture&&this.currentTexture.destroyGC(!0),this.currentTexture=this.sourceTexture,this.saveCurrentTextureBlob(0,t),this.updateProjectVO(!0),this.dispatchEvent(BFN.PhotoEditorModelEvents.SOURCE_IMAGE_UPDATED),this.dispatchEvent(BFN.PhotoEditorModelEvents.CURRENT_IMAGE_UPDATED),BFN.PhotoEditorCanvasModel.dispatchEvent(BFN.PhotoEditorCanvasModelEvents.FIT_IMAGE_TO_FRAME),BFN.TransformStateModel.clearTransitions(),BFN.PhotoEditorCanvasModel.dispatchEvent(BFN.PhotoEditorCanvasModelEvents.CLEAR_ITEMS),BFN.PhotoEditorHistoryModel.resetHistory(),BFN.PhotoEditorHistoryModel.addTextureToHistory("new_image",this.currentTexture),BFN.TransformGuides.setTransformGuideData(),e&&BFN.ProjectService.clearLocalAssets("editor")}handleTextureLoaded(e,t=!0,r){let a=!this.currentTexture;if(this.sourceTexture.baseTexture.maskTexture){try{this.sourceTexture.baseTexture.maskTexture.destroyGC(!0)}catch(o){}delete this.sourceTexture.baseTexture.maskTexture}BFN.ArtsyService.reset(),BFN.BackgroundRemovalManager.reset(),this.sourceTexture.resize(e.frame.width,e.frame.height),this.sourceTexture.copyPixels(e),this.sourceTexture.determineTransparency(),e.destroyGC(!0),BFN.PhotoEditorMenuModel.createCurrentImageThumb(this.sourceTexture);let s=BFN.Util.calculateRes(this.sourceTexture.width,this.sourceTexture.height);BFN.renderTextureResolution=s.small,BFN.renderTextureResolutionLarge=s.large,this.applySourceTexture(t,r),UIToggler.toggleMainMenu(!0),UIToggler.toggleZoomMenu(!0),this.dispatchEvent(BFN.PhotoEditorModelEvents.EDITOR_IMAGE_LOAD_COMPLETE),a&&BFN.DeepLinkManager.handleEditorImageDeepLink(()=>{BFN.PhotoEditorCanvasModel.dispatchEvent(BFN.PhotoEditorCanvasModelEvents.FIT_IMAGE_TO_FRAME_ANIMATED)})}handleTextureFileLoaderTextureError(e,t){BeFunky.logError("Unable to generate Photo Editor texture",e),t&&t.name&&BFN.MultipleFileUploader.acknowledgeInvalidImageFiles([{error:e,file:t}]),this.dispatchEvent(BFN.PhotoEditorModelEvents.EDITOR_IMAGE_LOAD_ERROR)}set projectVO(e){this._projectVO=e,this.dispatchEvent(BFN.PhotoEditorModelEvents.PROJECT_UPDATED)}get projectVO(){return this._projectVO}set currentTexture(e){if(this._currentTexture=e,this._currentTexture&&(this._currentTexture.autoSaveID=Math.random()),this.currentTextureDimensions.width=this.currentTextureDimensions.height=-1,this._currentTexture){try{this.currentTextureDimensions.width=this._currentTexture.width}catch(t){}try{this.currentTextureDimensions.height=this._currentTexture.height}catch(t){}}UIToggler.toggleSampleImagePopover()}get currentTexture(){return this._currentTexture}};BFN.SingletonQueue.add(()=>{BFN.PhotoEditorModel=new Ch});BFN.PhotoEditorMenuModelEvents={CURRENT_IMAGE_THUMB_UPDATED:new Event("CURRENT_IMAGE_THUMB_UPDATED")};function La(){BFN.EventDispatcher.call(this),this.init()}La.prototype=Object.create(BFN.EventDispatcher.prototype);La.prototype.init=function(){BeFunky.log("PhotoEditorMenuModel Init"),this.currentImageThumbTexture=null,this.currentImageThumbImage=null;let i=BeFunky.isRetina()?2:1;this.presetItemThumbW=224*i,this.presetItemThumbH=130*i};La.prototype.createCurrentImageThumb=function(i,e=!1){if(!i)return;this.currentImageThumbTexture&&(delete this.currentImageThumbTexture.originalBaseTexture,this.currentImageThumbTexture.destroyGC(!0)),this.currentImageThumbImage&&(URL.revokeObjectURL(this.currentImageThumbImage),this.currentImageThumbImage=null),this.currentImageThumbTexture=e?i.renderClone():this.getPresetItemThumbTexture(i),i.originalBaseTexture&&!i.originalBaseTexture._destroyed&&(this.currentImageThumbTexture.originalBaseTexture=i.originalBaseTexture);let t=BFN.Stage.extract.canvasBufferBfn(this.currentImageThumbTexture);t.canvas.toBlob(r=>{t.release(),t=null,this.currentImageThumbImage=window.URL.createObjectURL(r),this.dispatchEvent(BFN.PhotoEditorMenuModelEvents.CURRENT_IMAGE_THUMB_UPDATED)},"image/jpeg",.9)};La.prototype.getPresetItemThumbTexture=function(i){let e=BFN.Util.resizeTexture(i,this.presetItemThumbW,this.presetItemThumbH,!0,!0);return e||null};BFN.SingletonQueue.add(()=>{BFN.PhotoEditorMenuModel=new La});BFN.PhotoEditorCanvasModelEvents={VIEWSTATE_UPDATED:new Event("VIEWSTATE_UPDATED"),CANVAS_SCALE_UPDATED:new Event("CANVAS_SCALE_UPDATED"),CANVAS_SCALING_UPDATED:new Event("CANVAS_SCALING_UPDATED"),ITEM_ADDED:new Event("ITEM_ADDED"),FIT_IMAGE_TO_FRAME:new Event("FIT_IMAGE_TO_FRAME"),FIT_IMAGE_TO_FRAME_ANIMATED:new Event("FIT_IMAGE_TO_FRAME_ANIMATED"),OFFSET_ITEMS:new Event("OFFSET_ITEMS"),FLATTEN_ITEMS:new Event("FLATTEN_ITEMS"),CLEAR_ITEMS:new Event("CLEAR_ITEMS"),ITEMS_UPDATED:new Event("ITEMS_UPDATED")};function Vt(){BFN.EventDispatcher.call(this),this.init()}Vt.prototype=Object.create(BFN.EventDispatcher.prototype);Vt.prototype.init=function(){BeFunky.log("PhotoEditorCanvasModel Init"),this.initDefaultValues(),this.initContextMenu()};Vt.prototype.initDefaultValues=function(){this.usePixelGrid=!1,this._viewState=BFN.PhotoEditorCanvasModelViewStates.VIEWING_CANVAS,this._canvasScale=1,this._canvasScaling=!1,this._addedItem=null,this._itemOffsetPoint=null,this._itemsExist=!1,this.minCanvasScale=1,this.maxCanvasScale=this.usePixelGrid?16:4,this.imageFitPaddingX=40,this.imageFitPaddingY=60,this.disregardScaleRange=!1,BFN.AppModel.addEventListener(BFN.AppModelEvents.VIEWSTATE_UPDATED.type,this.handleAppModelViewstateUpdated.bind(this)),BFN.PhotoEditorModel.addEventListener(BFN.PhotoEditorModelEvents.CURRENT_IMAGE_UPDATED.type,this.handleCurrentImageUpdated.bind(this))};Vt.prototype.initContextMenu=function(){this.contextMenu=document.getElementById("context_menu_photo_editor"),BeFunky.contextMenu(this.contextMenu,{open_from_computer:{onClick:i=>{UITools.onButtonControlClick(i,"open_project_computer")},hasDivider:!0},undo:{onClick:i=>{UITools.onButtonControlClick(i,"editor_history_action_undo")}},redo:{onClick:i=>{UITools.onButtonControlClick(i,"editor_history_action_redo")}},reset:{onClick:i=>{UITools.onButtonControlClick(i,"editor_history_action_reset")},hasDivider:!0},save_to_image_manager:{onClick:()=>{BeFunky.showLoadScreen({isCancellable:!1});let i=BFN.PhotoEditorCanvas.getFlattenedImage();BFN.ImageLibraryManager.createMenuImageVOFromTexture(i,()=>{UITools.setToolValue("editor_main","image_manager",!0),UITools.applyTool("editor_main"),UITools.setToolValue("editor_main","image_manager",!1),BeFunky.hideLoadScreen()})}}}),this.contextMenu.enabled=!1,this.contextMenu.target=document.querySelector("#appStage canvas")};Vt.prototype.handleEditorFlatten=function(){UITools.getToolValue("editor_flatten","flatten_layers")&&(i()?e(()=>{this.dispatchEvent(BFN.PhotoEditorCanvasModelEvents.FLATTEN_ITEMS)}):this.dispatchEvent(BFN.PhotoEditorCanvasModelEvents.FLATTEN_ITEMS));function i(){return BFN.AppModel.sectionValue(BFN.PhotoEditorCanvas,BFN.CollageMakerCanvas,BFN.DesignerCanvas).transformLayer.hasText()}function e(t){let r="flatten_layers_warning";BFN.SettingsManager.getSetting("dismissed_messages").then(a=>{if(a.includes(r))return t();let{elem:s,lang:o}=BeFunky.lit;BeFunky.acknowledge(s`
            <div>
                <p>${o("flatten_layers_warning")}</p>
                <p style="margin-bottom: 0"><a href="https://support.befunky.com/hc/en-us/articles/360040712632}" target="_blank" rel="noopener">${o("learn_more")}</a></p>
            </div>`,{onAcknowledge:t}),BFN.SettingsManager.updateSetting("dismissed_messages",[...a,r])})}};Vt.prototype.handleEditorOverlay=function(){let i=UITools.getToolVO("editor_overlay");BFN.OverlaysManager.setupCategoryItems(i.updating_id)};Vt.prototype.handleUpdateTool=function(i){if(BFN.toolViewstates.hasOwnProperty(i)){let e=BFN.toolViewstates[i],t=null,r=null;switch(i){case"editor_edit":case"editor_touch_up":case"editor_frame":r=UITools.getToolVO(i),t=r.updating_id,BFN.toolViewstates.hasOwnProperty(t)&&(e=BFN.toolViewstates[t]);break}if(i==="editor_edit"&&t&&e===BFN.PhotoEditorCanvasModelViewStates.VIEWING_EFFECT&&(r=UITools.getToolVO(t),r&&r.hasOwnProperty("defaultValues"))){for(let a in r.defaultValues)r.hasOwnProperty(a)&&UITools.setToolValue(t,a,r.defaultValues[a],!1);UITools.updateToolControls(t)}this.viewState!==e&&(console.log(`SET VIEWSTATE : ${e}`),this.viewState=e),t&&UITools.applyTool(t)}};Vt.prototype.exitCurrentEditorTool=function(){(BFN.PhotoEditorCanvasModel.viewState!==BFN.PhotoEditorCanvasModelViewStates.VIEWING_CANVAS||BFN.PhotoEditorCanvasTools.currentTool||BFN.tertiaryMenu.activePresetId)&&(UITools.setToolValue("editor_apply_cancel","cancel",!0),UITools.applyTool("editor_apply_cancel"),UITools.setToolValue("editor_apply_cancel","cancel",!1),BFN.tertiaryMenu.activePresetId="")};Vt.prototype.handleAppModelViewstateUpdated=function(i){this.itemsExist=this.itemsExist};Vt.prototype.handleCurrentImageUpdated=function(i){BFN.ZoomManager.updateZoomRange()};Object.defineProperty(Vt.prototype,"viewState",{set(i){if(this._viewState!==BFN.PhotoEditorCanvasModelViewStates.VIEWING_CANVAS)switch(this._viewState){case BFN.PhotoEditorCanvasModelViewStates.VIEWING_TOUCH_UP:case BFN.PhotoEditorCanvasModelViewStates.VIEWING_EFFECT:BFN.EffectManager.reset();break}this._viewState=i,this.dispatchEvent(BFN.PhotoEditorCanvasModelEvents.VIEWSTATE_UPDATED),BFN.GlobalHistoryModel.updateGlobalHistoryButtons()},get(){return this._viewState}});Object.defineProperty(Vt.prototype,"canvasScale",{set(i){this._canvasScale=this.disregardScaleRange?i:Math.max(this.minCanvasScale,Math.min(this.maxCanvasScale,i)),this.dispatchEvent(BFN.PhotoEditorCanvasModelEvents.CANVAS_SCALE_UPDATED);let e=UITools.getToolVO("zoom");(!e.updating||e.updating_id!=="amount")&&(UITools.setToolValue("zoom","amount",this._canvasScale*100),UITools.updateToolControls("zoom"))},get(){return this._canvasScale}});Object.defineProperty(Vt.prototype,"canvasScaling",{set(i){this._canvasScaling=i,BFN.smoothPictureDisabled=i,this.dispatchEvent(BFN.PhotoEditorCanvasModelEvents.CANVAS_SCALING_UPDATED)},get(){return this._canvasScaling}});Object.defineProperty(Vt.prototype,"addedItem",{set(i){this._addedItem=i,this._addedItem&&this.dispatchEvent(BFN.PhotoEditorCanvasModelEvents.ITEM_ADDED)},get(){return this._addedItem}});Object.defineProperty(Vt.prototype,"itemOffsetPoint",{set(i){this._itemOffsetPoint=i,this.dispatchEvent(BFN.PhotoEditorCanvasModelEvents.OFFSET_ITEMS),this._itemOffsetPoint=null},get(){return this._itemOffsetPoint}});Object.defineProperty(Vt.prototype,"itemsExist",{set(i){this._itemsExist=i,this.dispatchEvent(BFN.PhotoEditorCanvasModelEvents.ITEMS_UPDATED)},get(){return this._itemsExist}});BFN.SingletonQueue.add(()=>{BFN.PhotoEditorCanvasModel=new Vt});BFN.CollageMakerModelEvents={PROJECT_UPDATED:new Event("PROJECT_UPDATED")};var Eh=class extends BFN.EventDispatcher{constructor(){super();this.init()}init(){BeFunky.log("CollageMakerModel Init"),this.initDefaultValues()}initDefaultValues(){this._projectVO=new BFN.ProjectVO,this._projectVO.version=2,this._projectVO.section="collage",this._projectVO._wasReset=!0,this.updateProjectVO=BeFunky.debounce(this.updateProjectVO.bind(this),10)}updateProjectVO(){this._projectVO.projectWidth=BFN.CollageMakerCanvasPhotoGrid.gridWidth,this._projectVO.projectHeight=BFN.CollageMakerCanvasPhotoGrid.gridHeight,this._projectVO.collageFreeform=BFN.CollageMakerCanvasPhotoGridModel.freeform,this._projectVO.collageBackgroundColor=BFN.CollageMakerCanvasBackground.color,this._projectVO.collageBackgroundPatternBase64=BFN.CollageMakerCanvasPhotoGridModel.backgroundPatternBase64,this._projectVO.collageGridWidth=BFN.PhotoGrid.itemWidth,this._projectVO.collageGridHeight=BFN.PhotoGrid.itemHeight,this._projectVO.collageRounding=BFN.PhotoGrid.rounding*100,this._projectVO.collageGap=BFN.PhotoGrid.gap*100,BFN.ProjectManager.updateProjectVOItems(this,BFN.CollageMakerCanvas.transformLayer),this._projectVO.transformGroups=BFN.GroupManager.getSectionGroupObjects("collage",!0),this._projectVO.collageGridChildren.splice(0);for(let e=0;e<BFN.PhotoGrid.gridChildren.length;e++){let t=BFN.PhotoGrid.gridChildren[e];t.updateRect(),t.updateProjectItemVO();let{projectItemVO:r}=t,a=t.childContent.image.frameSprite.texture.baseTexture.fabricShape?"svg":"image",s=this._projectVO[`${a}DataKeys`];r.gridCellImageID&&(s.includes(r.gridCellImageID)||(s.push(r.gridCellImageID),BFN.ProjectService.setLocalAsset("collage",a,r.gridCellImageID,void 0,!0))),this._projectVO.collageGridChildren.push(r)}BFN.ProjectManager.requestLocalSave({sectionID:"collage"})}set projectVO(e){this._projectVO=e,this.dispatchEvent(BFN.CollageMakerModelEvents.PROJECT_UPDATED)}get projectVO(){return this._projectVO}};BFN.SingletonQueue.add(()=>{BFN.CollageMakerModel=new Eh});var{html:Xr,defineCustomElement:BI,appLang:Va,icon:Po,useMediaQuery:SI,useLayoutEffect:ys,useState:No,ifDefined:II}=BeFunky.lit;function Mo(){BI("collage-wizard-modal",_I)}function _I({isOpen:i=!1,disablePrevButton:e=!0,disableNextButton:t=!0,previewImage:r,disableSelectCollageButton:a=!0}){let s=this,o=224,[n,l]=No([]),[c,h]=No([]),[u,d]=No(o),m=SI(`(min-width: ${BFN.CSS.desktopAppMinWidth}px)`);return ys(()=>{BFN.HelpClueManager.setup("collage_wizard",{side:"right",positionFactor:0,container:s.querySelector(".collage-wizard__popover-placeholder")})},[]),ys(()=>{t||BFN.HelpClueManager.show("collage_wizard")},[t]),ys(y,[i]),ys(()=>{i&&M()},[i]),m?p():B();function p(){return Xr`
        <panel-header .langId=${"collage_wizard"} .modifier=${"modal"} .buttons=${"close"} .isPlus=${!0}></panel-header>
        <div class="modal__body collage-wizard__body">
            <div class="collage-wizard__left-panel">
                ${f()}
            </div>
            <div class="collage-wizard__right-panel">
                ${v()}
                ${x()}
            </div>
        </div>
        `}function g(){return Xr`
            <image-gallery
                .rowHeight=${80}
                .currentWidth=${u}
                .gutterWidth=${4}
                .onClickItem=${(j,{isSelected:J})=>{let ie=j.id;h(J?[...c,ie]:c.filter(re=>re!==ie)),BFN.AutoCollage.reset()}}
                .images=${n}
                .selectedImageIDs=${c}>
            </image-gallery>`}function f(){return Xr`
            <panel-header
                .langId=${"select_images"}
                .modifier=${"modal-section"}
                .buttons=${"select,deselect"}
                @SELECT=${b}
                @DESELECT=${S}
            ></panel-header>
            <button
                class="collage-wizard__use-images button button--fullwidth button--blue"
                .disabled=${!c.length}
                @click=${F}
            >
                ${Va("use_images")}
            </button>
            <div class="scrollable-content">
                ${g()}
            </div>`}function v(){let W=r?"collage-wizard__preview-inner--has-image":"",j=BFN.CollageMakerCanvasBackground.color===-1?"":`#${BFN.CollageMakerCanvasBackground.color}`,J=j?"":"collage-wizard__preview-image--is-transparent";return Xr`
        <div class="collage-wizard__preview-outer">
            <div class=${`collage-wizard__preview-inner ${W}`}>
                <img
                    class=${`collage-wizard__preview-image ${J}`}
                    src=${II(r)}
                    style=${`background-color: ${j}`}
                    alt="Collage Preview"/>
                <p class="collage-wizard__preview-message">${Va("collage_wizard_empty_guide")}</p>
                <button
                    class="button button--icon button--grey-300 collage-wizard__prev-button"
                    @click=${w}
                    .disabled=${e}
                    data-tooltip="previous"
                >
                    ${Po("chevron-icon","icon icon--10")}
                </button>
                <button
                    class="button button--icon button--grey-300 collage-wizard__next-button"
                    @click=${N}
                    .disabled=${t}
                     data-tooltip="next"
                >
                    ${Po("chevron-icon","icon icon--10")}
                </button>
                <div class="collage-wizard__popover-placeholder"></div>
            </div>
        </div>`}function T(){return Xr`
        <div class="tutorial">
            ${Po("info-icon","icon icon--18 tutorial__icon")}
            <p>
                <string class="tutorial__text">${Va("need_help")}</string>
                <a
                    aria-label="Collage Wizard - Heres a Tutorial"
                    href=${`${BeFunky.Params.siteUrl}learn/collage-wizard/`}
                    data-bfntrack="CREATE|HELP|COLLAGE_WIZARD"
                    class="tutorial__link"
                    target="_blank"
                    rel="noopener"
                >
                    <string>${Va("tutorial_link")}</string>
                </a>
            </p>
        </div>`}function x(){return Xr`
        <div class="collage-wizard__footer">
            ${m?T():""}
            <button
                class="button button--blue collage-wizard__select-collage"
                @click=${I}
                .disabled=${a}
            >
                ${Va("select_this_collage")}
            </button>
        </div>`}function B(){return Xr`
        <panel-header .langId=${"collage_wizard"} .modifier=${"modal"} .buttons=${"close"} .isPlus=${!0}></panel-header>
        <div class="modal__body collage-wizard__body">
            <div class="collage-wizard__image-selection">
                ${f()}
            </div>
            ${v()}
            ${x()}
        </div>
        `}function y(){i?BeFunky.openModal(s,{onClose:()=>{s.isOpen=!1,BFN.AutoCollage.reset(),z()},isFullWidthOnMobile:!0,onWindowResize:E}):BeFunky.closeModal(s,!1)}function F(){let W=n.filter(({id:j})=>c.includes(j));W.length&&(BFN.BfnService.track("CREATE","COLLAGE","COLLAGE_WIZARD_USEDIMAGES"),BFN.AutoCollage.generateAutoCollage(W))}function b(){h(n.map(({id:W})=>W)),BFN.AutoCollage.reset()}function S(){h([]),BFN.AutoCollage.reset()}function I(){if(!BFN.BfnService.userIsPlus){BFN.BfnService.upgrade("COLLAGE","COLLAGE_WIZARD_UPGRADE","collage_wizard"),BFN.UserActionManager.addUpgradeAction(["Select Collage Wizard Layout"]);return}BFN.CollageMakerCanvasPhotoGridModel.freeform&&BFN.CollageMakerCanvasModel.itemsExist?BeFunky.confirm("confirm_template_change",{onConfirm:_}):_()}function _(){BFN.AutoCollage.selectCurrentLayout(),BFN.BfnService.track("CREATE","COLLAGE","COLLAGE_WIZARD_SELECTED"),s.isOpen=!1}function E({availableWidth:W,availableHeight:j}){let J=17*16,ie=56,re=48,he={width:672,height:528},[ne,le]=BFN.TextureUtils.getScaledDimensions(he,{maxWidth:W-J,maxHeight:j-ie-re});BeFunky.isWiderThanMobile()?d(o):d(W-32),s.setStyles({width:`${ne+J}px`,height:BeFunky.isWiderThanMobile()?`${le+ie+re}px`:`${j}px`})}function D(W){return!!BFN.PhotoGrid.getGridMenuImageVOs().find(j=>j.id===W)}function w(){BFN.AutoCollage.prevLayout()}function N(){BFN.BfnService.track("CREATE","COLLAGE","COLLAGE_WIZARD_BROWSED"),BFN.AutoCollage.nextLayout(),BFN.HelpClueManager.hide("collage_wizard")}function M(){let W=BFN.ImageLibraryManager.selectedMenuImageVOs;W.length||(W=BFN.ImageLibraryManager.sampleMenuImageVOs),W=W.map(J=>(J.thumbWidth=J.thumbHeight=Math.min(J.thumbWidth,J.thumbHeight),J)),l(W);let j=W.map(({id:J})=>J).filter(J=>D(J));h(j)}function z(){l([])}}BFN.CollageMakerCanvasModelEvents={CANVAS_SCALE_UPDATED:new Event("CANVAS_SCALE_UPDATED"),CANVAS_SCALING_UPDATED:new Event("CANVAS_SCALING_UPDATED"),ITEM_ADDED:new Event("ITEM_ADDED"),FIT_COLLAGE_TO_FRAME:new Event("FIT_COLLAGE_TO_FRAME"),FIT_COLLAGE_TO_FRAME_ANIMATED:new Event("FIT_COLLAGE_TO_FRAME_ANIMATED"),CLEAR_ITEMS:new Event("CLEAR_ITEMS"),ITEMS_UPDATED:new Event("ITEMS_UPDATED")};var Ph=class extends BFN.EventDispatcher{constructor(){super();this.init()}init(){this.initDefaultValues(),this.initContextMenu()}initDefaultValues(){this._canvasScale=1,this._canvasScaling=!1,this._addedItem=null,this._itemsExist=!1,this.minCanvasScale=1,this.maxCanvasScale=1.5,this.collageFitPaddingX=60,this.collageFitPaddingY=60,this.disregardScaleRange=!1}initContextMenu(){this.contextMenu=document.getElementById("context_menu_collage_maker"),BeFunky.contextMenu(this.contextMenu,{undo:{onClick:e=>{UITools.onButtonControlClick(e,"editor_history_action_undo")}},redo:{onClick:e=>{UITools.onButtonControlClick(e,"editor_history_action_redo")}},reset:{onClick:e=>{UITools.onButtonControlClick(e,"editor_history_action_reset")},hasDivider:!0},save_to_image_manager:{onClick:()=>{BeFunky.showLoadScreen({isCancellable:!1});let e=BFN.CollageMakerCanvas.getFlattenedImage();BFN.ImageLibraryManager.createMenuImageVOFromTexture(e,()=>{UITools.setToolValue("collage_main","image_manager",!0),UITools.applyTool("collage_main"),UITools.setToolValue("collage_main","image_manager",!1),BeFunky.hideLoadScreen()})}}}),this.contextMenu.enabled=!1,this.contextMenu.target=document.querySelector("#appStage canvas")}handleCollageLayoutsCustom(){switch(UITools.getToolVO("collage_layouts_custom").updating_id){case"collage_wizard":BFN.CollageWizardModal||(Mo(),BFN.CollageWizardModal=BeFunky.lit.elem`<collage-wizard-modal id="collage_wizard" class="modal modal--button-sm collage-wizard"></collage-wizard-modal>`),BFN.CollageWizardModal.isOpen=!0,BFN.BfnService.track("CREATE","COLLAGE","COLLAGE_WIZARD");break;case"create_your_own":BFN.CollageMakerTemplateModel.dispatchEvent(BFN.CollageMakerTemplateModelEvents.FREEFORM),BFN.BfnService.track("CREATE","COLLAGE","CREATE_YOUR_OWN");break}}set canvasScale(e){this._canvasScale=this.disregardScaleRange?e:Math.max(this.minCanvasScale,Math.min(this.maxCanvasScale,e)),this.dispatchEvent(BFN.CollageMakerCanvasModelEvents.CANVAS_SCALE_UPDATED);let t=UITools.getToolVO("zoom");(!t.updating||t.updating_id!=="amount")&&(UITools.setToolValue("zoom","amount",this._canvasScale*100),UITools.updateToolControls("zoom"))}get canvasScale(){return this._canvasScale}set canvasScaling(e){this._canvasScaling=e,BFN.smoothPictureDisabled=e,this.dispatchEvent(BFN.CollageMakerCanvasModelEvents.CANVAS_SCALING_UPDATED)}get canvasScaling(){return this._canvasScaling}set addedItem(e){this._addedItem=e,this._addedItem&&this.dispatchEvent(BFN.CollageMakerCanvasModelEvents.ITEM_ADDED)}get addedItem(){return this._addedItem}set itemsExist(e){this._itemsExist=e,this.dispatchEvent(BFN.CollageMakerCanvasModelEvents.ITEMS_UPDATED)}get itemsExist(){return this._itemsExist}};BFN.SingletonQueue.add(()=>{BFN.CollageMakerCanvasModel=new Ph});BFN.CollageMakerCanvasPhotoGridModelEvents={FREEFORM_UPDATED:new Event("FREEFORM_UPDATED"),CORNER_ROUNDING_UPDATED:new Event("CORNER_ROUNDING_UPDATED"),ASPECT_LOCK_CHANGED:new Event("ASPECT_LOCK_CHANGED"),MANUAL_GRID_RESIZE:new Event("MANUAL_GRID_RESIZE"),COLLAGE_SETTINGS_UPDATED:new Event("COLLAGE_SETTINGS_UPDATED"),GRID_SIZE_CHANGED:new Event("GRID_SIZE_CHANGED"),CLEAR_ALL:new Event("CLEAR_ALL"),AUTO_COLLAGE_LAYOUT_OBJECT:new Event("AUTO_COLLAGE_LAYOUT_OBJECT")};var Nh=class extends BFN.EventDispatcher{constructor(e){super(e);this.init()}init(){BeFunky.log("CollageMakerCanvasPhotoGridModel Init"),this.initDefaultValues()}initDefaultValues(){this._freeform=!1,this._cornerRounding=0,this._collageSettings=null,this._autoCollageLayoutObject=null,this._backgroundPatternTexture=null,this._backgroundPatternBase64=null}set freeform(e){this._freeform!==e&&(this._freeform=e,this._freeform,this.dispatchEvent(BFN.CollageMakerCanvasPhotoGridModelEvents.FREEFORM_UPDATED))}get freeform(){return this._freeform}set cornerRounding(e){this._cornerRounding=e,this.dispatchEvent(BFN.CollageMakerCanvasPhotoGridModelEvents.CORNER_ROUNDING_UPDATED)}get cornerRounding(){return this._cornerRounding}set collageSettings(e){this._collageSettings=e}get collageSettings(){return this._collageSettings}set autoCollageLayoutObject(e){this._autoCollageLayoutObject=e,this.dispatchEvent(BFN.CollageMakerCanvasPhotoGridModelEvents.AUTO_COLLAGE_LAYOUT_OBJECT),this._autoCollageLayoutObject=null}get autoCollageLayoutObject(){return this._autoCollageLayoutObject}set backgroundPatternTexture(e){if(this._backgroundPatternTexture=e,this._backgroundPatternTexture){let t=this._backgroundPatternTexture.renderClone();BFN.Util.getHTMLImage(t,r=>{this._backgroundPatternBase64=r.src,t.destroyGC(!0),BFN.CollageMakerModel.updateProjectVO()})}else this._backgroundPatternBase64=null,BFN.CollageMakerModel.updateProjectVO()}get backgroundPatternTexture(){return this._backgroundPatternTexture}get backgroundPatternBase64(){return this._backgroundPatternBase64}};BFN.SingletonQueue.add(()=>{BFN.CollageMakerCanvasPhotoGridModel=new Nh});BFN.CollageMakerTemplateModelEvents={CURRENT_TEMPLATE_UPDATED:new Event("CURRENT_TEMPLATE_UPDATED"),FREEFORM:new Event("FREEFORM")};var Mh=class extends BFN.EventDispatcher{constructor(){super();this.init()}init(){BeFunky.log("CollageMakerTemplateModel Init"),this.initDefaultValues()}initDefaultValues(){this.freeformWidth=2400,this.freeformHeight=1800,this._currentTemplate=null}set currentTemplate(e){this._currentTemplate=e,this.dispatchEvent(BFN.CollageMakerTemplateModelEvents.CURRENT_TEMPLATE_UPDATED)}get currentTemplate(){return this._currentTemplate}};BFN.SingletonQueue.add(()=>{BFN.CollageMakerTemplateModel=new Mh});BFN.DesignerModelEvents={PROJECT_UPDATED:new Event("PROJECT_UPDATED")};var Dh=class extends BFN.EventDispatcher{constructor(){super();this.init()}init(){BeFunky.log("DesignerModel Init"),this.initDefaultValues()}initDefaultValues(){this._projectVO=new BFN.ProjectVO,this._projectVO.version=2,this._projectVO.section="designer",this.updateProjectVO=BeFunky.debounce(this.updateProjectVO.bind(this),10)}loadBlankProject(){let e=new BFN.ProjectVO;e.version=2,e.section="designer",e.projectWidth=this.projectVO.projectWidth||2550,e.projectHeight=this.projectVO.projectHeight||3300,e.designerBackgroundColor="FFFFFF";let t=BFN.DesignerTemplateManager.parseDimensions([e.projectWidth,e.projectHeight]);return e.printDPI=t?t.dpi:300,e._wasReset=!0,BFN.ProjectManager.loadProject(e)}updateProjectVO(e=!0){this._projectVO.projectWidth=BFN.DesignerCanvas.canvasWidth,this._projectVO.projectHeight=BFN.DesignerCanvas.canvasHeight,this._projectVO.designerBackgroundColor=BFN.DesignerCanvasBackground.color,e&&BFN.ProjectManager.updateProjectVOItems(this,BFN.DesignerCanvas.transformLayer),this._projectVO.transformGroups=BFN.GroupManager.getSectionGroupObjects("designer",!0),BFN.ProjectManager.requestLocalSave({sectionID:"designer"})}set projectVO(e){this._projectVO=e,this.dispatchEvent(BFN.DesignerModelEvents.PROJECT_UPDATED)}get projectVO(){return this._projectVO}};BFN.SingletonQueue.add(()=>{BFN.DesignerModel=new Dh});BFN.DesignerCanvasModelEvents={CANVAS_SCALE_UPDATED:new Event("CANVAS_SCALE_UPDATED"),CANVAS_SCALING_UPDATED:new Event("CANVAS_SCALING_UPDATED"),ITEM_ADDED:new Event("ITEM_ADDED"),FIT_DESIGNER_TO_FRAME:new Event("FIT_DESIGNER_TO_FRAME"),FIT_DESIGNER_TO_FRAME_ANIMATED:new Event("FIT_DESIGNER_TO_FRAME_ANIMATED"),CLEAR_ITEMS:new Event("CLEAR_ITEMS"),ITEMS_UPDATED:new Event("ITEMS_UPDATED"),DESIGNER_SETTINGS_UPDATED:new Event("DESIGNER_SETTINGS_UPDATED")};function Zi(){BFN.EventDispatcher.call(this),this.init()}Zi.prototype=Object.create(BFN.EventDispatcher.prototype);Zi.prototype.init=function(){BeFunky.log("DesignerCanvasModel Init"),this.initDefaultValues(),this.initContextMenu()};Zi.prototype.initDefaultValues=function(){this._canvasScale=1,this._canvasScaling=!1,this._addedItem=null,this._itemsExist=!1,this.minCanvasScale=1,this.maxCanvasScale=4,this.designerFitPaddingX=60,this.designerFitPaddingY=60,this.disregardScaleRange=!1};Zi.prototype.initContextMenu=function(){this.contextMenu=document.getElementById("context_menu_designer"),BeFunky.contextMenu(this.contextMenu,{undo:{onClick:i=>{UITools.onButtonControlClick(i,"editor_history_action_undo")}},redo:{onClick:i=>{UITools.onButtonControlClick(i,"editor_history_action_redo")}},reset:{onClick:i=>{UITools.onButtonControlClick(i,"editor_history_action_reset")},hasDivider:!0},save_to_image_manager:{onClick:()=>{BeFunky.showLoadScreen({isCancellable:!1});let i=BFN.DesignerCanvas.getFlattenedImage();BFN.ImageLibraryManager.createMenuImageVOFromTexture(i,()=>{UITools.setToolValue("designer_main","image_manager",!0),UITools.applyTool("designer_main"),UITools.setToolValue("designer_main","image_manager",!1),BeFunky.hideLoadScreen()})}}}),this.contextMenu.enabled=!1,this.contextMenu.target=document.querySelector("#appStage canvas")};Object.defineProperty(Zi.prototype,"canvasScale",{set(i){this._canvasScale=this.disregardScaleRange?i:Math.max(this.minCanvasScale,Math.min(this.maxCanvasScale,i)),this.dispatchEvent(BFN.DesignerCanvasModelEvents.CANVAS_SCALE_UPDATED);let e=UITools.getToolVO("zoom");(!e.updating||e.updating_id!=="amount")&&(UITools.setToolValue("zoom","amount",this._canvasScale*100),UITools.updateToolControls("zoom"))},get(){return this._canvasScale}});Object.defineProperty(Zi.prototype,"canvasScaling",{set(i){this._canvasScaling=i,BFN.smoothPictureDisabled=i,this.dispatchEvent(BFN.DesignerCanvasModelEvents.CANVAS_SCALING_UPDATED)},get(){return this._canvasScaling}});Object.defineProperty(Zi.prototype,"addedItem",{set(i){this._addedItem=i,this._addedItem&&this.dispatchEvent(BFN.DesignerCanvasModelEvents.ITEM_ADDED)},get(){return this._addedItem}});Object.defineProperty(Zi.prototype,"itemsExist",{set(i){this._itemsExist=i,this.dispatchEvent(BFN.DesignerCanvasModelEvents.ITEMS_UPDATED)},get(){return this._itemsExist}});Object.defineProperty(Zi.prototype,"designerSettings",{set(i){this._designerSettings=i},get(){return this._designerSettings}});BFN.SingletonQueue.add(()=>{BFN.DesignerCanvasModel=new Zi});var wh=class{constructor(){this.initDefaultValues(),this.initFileUploadInput()}initDefaultValues(){this.uploadQueue=[],this.uploadInput=null,this.thumbSize=BFN.CSS.imageManagerThumbSize*(BeFunky.isRetina()?1.5:1),this.supportedImages=["jpg","jpeg","png","gif","bmp","svg"],(BeFunky.isChromium||BeFunky.firefoxVersion>=65||BeFunky.safariVersion>=14)&&this.supportedImages.push("webp"),BeFunky.isSafari&&this.supportedImages.push("tif","tiff"),this.accept={images:BeFunky.isIOS||BeFunky.isSafari&&!("sendBeacon"in navigator)?"image/*":this.supportedImages.map(e=>`.${e}`).join(", "),bfd:".bfd",svg:".svg",imagesAndBFD:this.supportedImages.concat("bfd").map(e=>`.${e}`).join(", "),imagesExceptSVG:this.supportedImages.filter(e=>e!=="svg").map(e=>`.${e}`).join(", "),all:"",fonts:ha.map(e=>e.extension).map(e=>`.${e}`).join(", ")},this.transparentImages=["png","gif","svg","webp"],this.currentCallback=null,this.currentOptions=null,this.currentFailedImageUploads=[],this.progressIndex=0,this.progressTotal=0}initFileUploadInput(){let e="file_upload_input",t=`<input id="${e}" type="file" style="display: none;">`;BFN.appContainer.insertAdjacentHTML("beforeend",t),this.uploadInput=document.getElementById(e),this.uploadInput.addEventListener("change",r=>this.handleUpload([...r.target.files]))}upload(e,{allowMultiple:t=!0,fileType:r="images",createMenuImageVO:a=!0,saveInIndexedDB:s,files:o=[],keepImageTexture:n=!1,keepThumbTexture:l=!1,thumbnailLongestSide:c,onBeforeUpload:h,openNativeCamera:u=!1}={}){if(r==="bfd"&&(a=!1),Object.keys(this.accept).includes(r)||(BeFunky.throwError("Invalid fileType passed to MultipleFileUploader"),r="images"),typeof s!="boolean"&&(s=a),this.currentCallback=e,this.currentOptions={createMenuImageVO:a,keepImageTexture:n,fileType:r,saveInIndexedDB:s,thumbnailLongestSide:c,keepThumbTexture:l,onBeforeUpload:h},this.currentFailedImageUploads=[],o.length)return this.handleUpload(o);try{this.uploadInput.multiple=t}catch(d){throw BeFunky.logError('Unable to set "multiple" property on file upload input'),BeFunky.logError("this.uploadInput",typeof this.uploadInput,this.uploadInput),d}this.uploadInput.accept=this.accept[r],u?(this.uploadInput.accept="image/*",this.uploadInput.capture="environment"):this.uploadInput.removeAttribute("capture"),this.uploadInput.click()}processNextFile(e){let t=this.uploadQueue.shift(),r=/^image\/+/.test(t.type),a=/^image\/svg\+xml/.test(t.type)||t.name.split(".").pop().toLowerCase()==="svg",s=o=>{let n=o?{file:t,menuImageVO:o,isComplete:!1}:{file:t,isComplete:!1};this.progressTotal&&(this.progressIndex++,this.showLoadScreen("uploading",`${this.progressIndex} / ${this.progressTotal}`)),this.uploadQueue.length?(e(n),this.processNextFile(e)):(BeFunky.hideLoadScreen(),e(n),this.uploadProcessingComplete(e))};if(!this.currentOptions.createMenuImageVO)return s();if(!r)return BeFunky.logError('Uploaded file does not have an "image/*" mimetype',t),this.currentFailedImageUploads.push({error:"Not an image",file:t}),s();if(this.currentOptions.fileType==="imagesExceptSVG"&&a)return BeFunky.logError("Uploaded file is an SVG, but SVGs are not supported by this feature",t),this.currentFailedImageUploads.push({error:"SVGs are not supported by this feature",file:t}),s();this.createMenuImageVO(t,({error:o,menuImageVO:n})=>{if(e===this.currentCallback)return o?(BeFunky.logError("Unable to create MenuImageVO for uploaded image",t,o),this.currentFailedImageUploads.push({error:o,file:t}),s()):s(n)},this.currentOptions)}uploadProcessingComplete(e){this.uploadQueue=[],this.acknowledgeInvalidImageFiles(this.currentFailedImageUploads),e({isComplete:!0})}createMenuImageVO(e,t,{keepImageTexture:r=!1,saveInIndexedDB:a=!0,thumbnailLongestSide:s,keepThumbTexture:o}){let n=new BFN.MenuImageVO;n.createId("computer"),s=parseInt(s)||-1,n.name=e.name.replace(/\.[^/.]+$/,"");let l=BFN.getExtension(e.name),c=this.transparentImages.includes(l);if(n.extension=l,l==="svg")return n.isSVG=!0,n.isTransparent=!0,BFN.BlobUtils.blobToText(e,({error:m,text:p})=>{if(m)return t({error:m});let g=BFN.SVGManager.sanitizeSVG(p);if(!g)return t({error:"Unable to parse SVG"});let f=g.length>1e5;if(!f&&(n.thumbURL=BFN.SVGManager.createDataURI(g),!r))return d(g);BFN.TextureUtils.svgStringToTexture(g,({error:v,texture:T})=>{if(v)return t({error:v});if(f){let x=T.width/T.height,B=Math.round(this.thumbSize*(x>1?x:1/x)),y=BFN.Util.getThumbTexture(T,B,!1);n.thumbURL=BFN.TextureUtils.textureToBase64(y),n.thumbWidth=y.width,n.thumbHeight=y.height,y.destroyGC(!0)}r?n.imageTexture=T:T.destroyGC(!0),d(g)})});let h={reportImageSize:!0};r||(h.textureSize=s>0?s:this.thumbSize*4),BFN.TextureUtils.blobOrBase64ToTexture(e,({error:m,texture:p,imageWidth:g,imageHeight:f})=>{if(m)return t({error:m});n.imageWidth=g,n.imageHeight=f;let v=p.width/p.height,T=s>0?s:Math.round(this.thumbSize*(v>1?v:1/v)),x=BFN.Util.getThumbTexture(p,T,!1),B=c?BFN.Util.isTransparent(x):!1;n.thumbURL=BFN.TextureUtils.textureToBase64(x,{isTransparent:B}),n.thumbWidth=x.width,n.thumbHeight=x.height,n.isTransparent=B,o?n.thumbTexture=x:x.destroyGC(!0),r?n.imageTexture=p:p.destroyGC(!0),u()},h);function u(){if(!a){t({menuImageVO:n});return}n.indexedDBKey=`image__${n.id}`,BFN.IndexedDB.set(n.indexedDBKey,e).then(()=>t({menuImageVO:n}),m=>{BeFunky.logError(`Unable to store blob "${e.name}" in IndexedDB`,m),t({error:m})})}function d(m){if(!a){t({menuImageVO:n});return}n.indexedDBKey=`svg__${n.id}`,BFN.IndexedDB.set(n.indexedDBKey,m).then(()=>t({menuImageVO:n}),p=>{BeFunky.logError("Unable to store SVG string in IndexedDB",p),t({error:p})})}}acknowledgeInvalidImageFiles(e){if(!Array.isArray(e)||!e.length||!e.every(s=>s.error&&s.file))return;let{elem:t,html:r,lang:a}=BeFunky.lit;BeFunky.acknowledge(t`
        <div>
            <p>${a("error_invalid_image")}</p>
            <ul>
            ${e.map(s=>{let o=s.file.name||"(unknown file name)",n=typeof s.error=="string"?`- ${s.error}`:"";return r`<li>${`${o} ${n}`}</li>`})}
            </ul>
        </div>
        `)}showLoadScreen(e,t){BeFunky.showLoadScreen({message:e,progress:t,showIris:!1,onCancel:()=>{BeFunky.hideLoadScreen(),this.uploadProcessingComplete(this.currentCallback)}})}handleUpload(e){if(!e.length)return this.uploadProcessingComplete(this.currentCallback);if(typeof this.currentOptions.onBeforeUpload=="function"){let r=this.currentOptions.onBeforeUpload;return this.currentOptions.onBeforeUpload=void 0,r(e,this.handleUpload.bind(this))}this.progressIndex=1,this.progressTotal=e.length>1&&this.currentOptions.createMenuImageVO?e.length:0;let t=this.progressTotal?`${BeFunky.LanguageManager.getString("uploading")} ${this.progressIndex} / ${this.progressTotal}`:"uploading";this.showLoadScreen(t),this.uploadQueue=e,setTimeout(()=>this.processNextFile(this.currentCallback),0),this.uploadInput.value=""}};BFN.SingletonQueue.add(()=>{BFN.MultipleFileUploader=new wh});window.UIToolsEvents={TOOL_PROPERTY_UPDATED:new Event("TOOL_PROPERTY_UPDATED"),UPDATE_TOOL:new Event("UPDATE_TOOL")};var kh=class extends BFN.EventDispatcher{constructor(){super();this.init()}init(){BeFunky.log("UITools Init"),this.initDefaultValues(),this.initUIToolVOs(),this.initToolVOs(BFN.EffectData),this.initToolVOs(BFN.ArtsyData),this.initToolVOs(BFN.TextureData),this.initToolVOs(BFN.LensFlareData.menuData),this.initToolVOs(BFN.FrameData.crop_rotate),this.initToolVOs(BFN.FrameData.crop),this.initToolVOs(BFN.FrameData.full),this.initToolVOs(BFN.FrameData.smart)}initDefaultValues(){this.toolVOs={},this.toolControlIDs={},this.controlToolIDs={},this.controlParamObjects={},this.toolPlusHash={},this.printToolVOs=!1,this.controlCallbacks={},this.lastClickTime=0}initUIToolVOs(){for(let e in BFN.UIToolData){let t=this.createToolVO(e),r=BFN.UIToolData[e];if(r.hasOwnProperty("controls")){let{controls:a}=r;for(let s in a){let o=a[s],n=s.replace(`${e}_`,""),l=o.type;this.toolControlIDs[e].push(s),this.controlToolIDs[s]=e,this.controlParamObjects[s]=o;let c=this.getDefaultValue(l,o);switch(this.setToolValue(e,n,c),l){case"color":case"color_item":case"color_palette":case"color_group":o.hasOwnProperty("intensityEnabled")&&o.intensityEnabled&&this.setToolValue(e,`${n}_intensity`,1),l==="color_group"&&(this.setToolValue(e,`${n}_index`,0),this.setToolValue(e,`${n}_group_id`,0));break}t.defaultValues[n]=c}}this.toolPlusHash[e]=r.hasOwnProperty("isPlus")?r.isPlus:!1}}initToolVOs(e){for(let t=0;t<e.length;t++){let r=e[t];for(let a=0;a<r.presets.length;a++){let s=r.presets[a],o=`${r.id}_${s.id}`;this.toolPlusHash[o]=s.hasOwnProperty("isPlus")?s.isPlus:!1;let n=this.createToolVO(o);for(let l=0;l<s.params.length;l++){let c=s.params[l],h=c.name,u=`${o}_${h}`,d=c.type;this.toolControlIDs[o].push(u),this.controlToolIDs[u]=o,this.controlParamObjects[u]=c;let m=this.getDefaultValue(d,c);switch(this.setToolValue(o,c.name,m),d){case"color":case"color_item":case"color_palette":case"color_group":c.hasOwnProperty("intensityEnabled")&&c.intensityEnabled&&this.setToolValue(o,`${c.name}_intensity`,1),d==="color_group"&&(this.setToolValue(o,`${c.name}_index`,0),this.setToolValue(o,`${c.name}_group_id`,0));break}n.defaultValues[h]=m}}}}createToolVO(e){return e?(this.toolVOs.hasOwnProperty(e)||(this.toolVOs[e]={toolID:e,updating:!1,updating_id:null,defaultValues:{}}),this.toolControlIDs.hasOwnProperty(e)||(this.toolControlIDs[e]=[]),this.toolVOs[e]):null}removeToolVO(e){if(e&&(this.toolVOs.hasOwnProperty(e)&&delete this.toolVOs[e],this.toolControlIDs.hasOwnProperty(e))){let t=this.toolControlIDs[e],r=t.length;for(;--r>-1;){let a=t[r];this.controlToolIDs.hasOwnProperty(a)&&delete this.controlToolIDs[a],this.controlParamObjects.hasOwnProperty(a)&&delete this.controlParamObjects[a]}delete this.toolControlIDs[e]}}getToolVO(e){return e&&this.toolVOs.hasOwnProperty(e)?this.toolVOs[e]:null}setToolValue(e,t,r,a=!1){let s=this.createToolVO(e);s[t]=r,s.updating=a,s.updating_id=t;let o=new Event(UIToolsEvents.TOOL_PROPERTY_UPDATED.type);o.data={toolID:e,paramID:t,value:r},this.dispatchEvent(o)}getToolValue(e,t){if(this.toolVOs.hasOwnProperty(e)&&this.toolVOs[e].hasOwnProperty(t))return this.toolVOs[e][t]}setControlValue(e,t,r=!1){if(this.controlToolIDs.hasOwnProperty(e)){let a=this.controlToolIDs[e],s=e.replace(`${a}_`,"");this.setToolValue(a,s,t,r)}}getControlValue(e){if(this.controlToolIDs.hasOwnProperty(e)){let t=this.controlToolIDs[e],r=e.replace(`${t}_`,"");return this.getToolValue(t,r)}}getParamObject(e){return this.controlParamObjects.hasOwnProperty(e)?this.controlParamObjects[e]:null}updateParamObject(e,t){let r=this.getParamObject(e);Object.assign(r,t),this.controlCallbacks[e]&&this.controlCallbacks[e](!0)}getDefaultValue(e,t){return t.hasOwnProperty("defaultValue")?t.defaultValue:e==="dropdown_item"?t.data[0].value:!1}registerControl(e){if(this.controlParamObjects.hasOwnProperty(e)){let t=this.controlParamObjects[e];if(t.hasOwnProperty("type")){switch(t.type){case"button":this.registerButtonControl(e);break;case"slider":this.registerSliderControl(e);break;case"slider_item":this.registerSliderItemControl(e);break;case"scrubber":this.registerScrubberControl(e);break;case"color":this.registerColorControl(e);break;case"color_item":this.registerColorItemControl(e);break;case"color_palette":this.registerColorPaletteControl(e);break;case"color_group":this.registerColorGroupControl(e);break;case"radio":this.registerRadioControl(e);break;case"checkbox":this.registerCheckBoxControl(e);break;case"checkbox_item":this.registerCheckBoxItemControl(e);break;case"expandable_checkbox":this.registerExpandableCheckBoxControl(e);break;case"toggle_switch":this.registerToggleSwitchControl(e);break;case"dropdown_item":this.registerDropdownItemControl(e);break;case"textinput":this.registerTextInputControl(e);break;case"textarea":this.registerTextAreaControl(e);break;case"toggle_group":this.registerToggleGroupControl(e);break}this.updateToolControl(e)}}else BeFunky.log(`-- NO DATA ENTRY FOR ELEMENT WITH ID : ${e}`)}registerButtonControl(e,t){let r=this.controlParamObjects[e],a=t||document.getElementById(e);r&&r.hasOwnProperty("interval")?(a.interval=r.interval,a.intervalDelay=r.hasOwnProperty("intervalDelay")?r.intervalDelay:r.interval,a.pressed=!1,a.pressMethod=function(s){this.pressed&&(s==null&&(s=this.interval),UITools.setControlValue(e,!0,!0),UITools.applyToolControl(e),UITools.setControlValue(e,!1,!1),setTimeout(this.pressMethod,s))}.bind(a),a.releaseMethod=function(){UITools.setToolValue("zoom","updating",!1,!1),UITools.applyToolControl(e),document.removeEventListener(BeFunky.pointerup,this.releaseMethod),this.pressed=!1}.bind(a),a.addEventListener(BeFunky.pointerdown,function(s){a.disabled||s.button===0&&(document.addEventListener(BeFunky.pointerup,this.releaseMethod),this.pressed=!0,this.pressMethod(this.intervalDelay),s.stopPropagation())}.bind(a))):a.addEventListener("click",s=>{r.preventDeselectOnDoubleClick&&(UITools.lastClickTime=Date.now()),UITools.setControlValue(e,!0),UITools.applyToolControl(e),UITools.setControlValue(e,!1),s.stopPropagation()})}onButtonControlClick(e,t){let r=this.getParamObject(t);r&&r.preventDeselectOnDoubleClick&&(UITools.lastClickTime=Date.now()),UITools.setControlValue(t,!0),UITools.applyToolControl(t),UITools.setControlValue(t,!1),e&&e.stopPropagation()}registerSliderControl(e,t){let r=t||document.getElementById(e),a=this.getParamObject(e),{defaultValue:s,step:o,min:n,max:l,pips:c,enableStartEvent:h}=a;return BFN.UI.slider(r,{start:s,step:o,min:n,max:l,pips:c,enableStartEvent:h},u),r;function u(d,m){let p=d!=="end";UITools.setControlValue(e,Math.round(parseFloat(m)*100)/100,p),UITools.applyToolControl(e)}}registerSliderItemControl(e,t){let r=this.controlToolIDs[e],a=e.replace(`${r}_`,""),s=this.getParamObject(e),o=t||document.getElementById(e);return BFN.UI.sliderItem(o,{toolID:r,paramID:a,controlID:e,paramObject:s})}registerScrubberControl(e,t){let r=this.getParamObject(e),a=t||document.getElementById(e);a.addEventListener("change",function(s){UITools.setControlValue(e,this.value,s.detail.isUpdating),UITools.applyToolControl(e)}),r.hasOwnProperty("unit")&&(a.unit=r.unit),r.hasOwnProperty("min")&&r.min!==a.minValue&&(a.minValue=r.min),r.hasOwnProperty("max")&&r.max!==a.maxValue&&(a.maxValue=r.max),r.hasOwnProperty("defaultValue")&&r.defaultValue!==a.value&&(a.value=r.defaultValue),r.hasOwnProperty("maxLength")&&(a.maxLength=r.maxLength)}registerColorControl(e,t){let r=this.getParamObject(e),a=t||document.getElementById(e),s=BFN.ColorPickerPanel;BFN.UI.colorButton(a),a.intensityEnabled=r.intensityEnabled||!1,a.emptyEnabled=r.hasOwnProperty("emptyEnabled")?r.emptyEnabled:!0,a.hueLocked=r.hueLocked||!1,a.borderEnabled=!0,a.fineChangeEnabled=r.fineChangeEnabled||!1,a.pickerName=r.hasOwnProperty("pickerName")?r.pickerName:r.hasOwnProperty("name")?r.name:null,a.addEventListener("click",function(){a.ignoreNextClick||(s.hasClass("active")?s.removeClass("active"):(s.colorButton=this,s.addClass("active")))}.bind(a)),a.addEventListener("change",function(){let o=UITools.controlToolIDs[this.id],n=this.id.replace(`${o}_`,"");this.intensityEnabled&&UITools.setToolValue(o,`${n}_intensity`,this.intensity),UITools.setToolValue(o,n,this.hashColor),UITools.applyToolControl(this.id)}.bind(a)),!!a.fineChangeEnabled&&a.addEventListener("finechange",function(){let o=UITools.controlToolIDs[this.id],n=this.id.replace(`${o}_`,"");this.intensityEnabled&&UITools.setToolValue(o,`${n}_intensity`,this.intensity),UITools.setToolValue(o,n,this.hashColor,!0),UITools.applyToolControl(this.id)}.bind(a))}registerColorItemControl(e){let t=this.getParamObject(e);BFN.UI.colorItem(document.getElementById(e),{controlID:e,paramObject:t})}registerColorPaletteControl(e,t){let r=this.getParamObject(e);BFN.UI.colorPalette(t||document.getElementById(e),{controlID:e,paramObject:r})}registerColorGroupControl(e){let t=this.getParamObject(e);BFN.UI.colorGroup(document.getElementById(e),{controlID:e,paramObject:t})}registerRadioControl(e){let t=document.getElementById(e),r=this.getParamObject(e);t.buttons=r.buttons,t.value=r.defaultValue,t.addEventListener("change",()=>{UITools.setControlValue(e,t.value),UITools.applyToolControl(e)})}registerToggleGroupControl(e){let t=document.getElementById(e);t.nodeName!=="TOGGLE-GROUP"&&BeFunky.logError(`${e} is not a <toggle-group>`);let r=this.getParamObject(e);t.buttons=r.buttons,t.value=r.defaultValue,t.addEventListener("change",function(){UITools.setControlValue(this.id,this.value),UITools.applyToolControl(this.id)})}registerCheckBoxControl(e){let t=document.getElementById(e);t.activeElement=t.dataset.activeElement?document.getElementById(t.dataset.activeElement):null,t.inactiveElement=t.dataset.inactiveElement?document.getElementById(t.dataset.inactiveElement):null;let r=function(a){a.activeElement&&a.activeElement.setStyles({display:a.checked?"block":"none"}),a.inactiveElement&&a.inactiveElement.setStyles({display:a.checked?"none":"block"})};this.updateToolControl(e),r(t),t.addEventListener("change",function(){r(this),UITools.setControlValue(this.id,this.checked),UITools.applyToolControl(this.id)}.bind(t))}registerToggleSwitchControl(e){let t=document.getElementById(e);this.updateToolControl(e),t.addEventListener("change",function(){UITools.setControlValue(this.id,this.checked),UITools.applyToolControl(this.id)}.bind(t))}registerCheckBoxItemControl(e){let t=this.getParamObject(e);BFN.UI.checkboxItem(document.getElementById(e),{controlID:e,paramObject:t})}registerExpandableCheckBoxControl(e){let t=document.getElementById(e);t.nodeName!=="EXPANDABLE-CHECKBOX"&&BeFunky.logError(`${e} is not an <expandable-checkbox>`);let r=this.getParamObject(e);t.checked=r.defaultValue?"on":"off",t.isOpen=!1,t.openWhenChecked=!1,t.addEventListener("change",function(){UITools.setControlValue(this.id,this.checked==="on"),UITools.applyToolControl(this.id)})}registerDropdownItemControl(e,t){let r=this.getParamObject(e),a=t||document.getElementById(e);a.options=r.data,a.useLabel=Boolean(r.useLabel),a.label=r.name||"",a.value=UITools.getControlValue(e),a.hideModalVeil=Boolean(r.hideModalVeil),a.onChange=o=>{UITools.setControlValue(e,o),UITools.applyToolControl(e)};let s=a.value;typeof s!="string"&&typeof s!="number"&&BeFunky.logError("Default value missing",e)}registerTextInputControl(e){let t=document.getElementById(e);t.addEventListener("change",function(){UITools.setControlValue(this.id,this.value,!0),UITools.applyToolControl(this.id)}.bind(t)),t.addEventListener("keyup",function(){UITools.setControlValue(this.id,this.value,!1),UITools.applyToolControl(this.id)}.bind(t))}registerTextAreaControl(e){let t=document.getElementById(e);t.addEventListener("change",function(){UITools.setControlValue(this.id,this.value),UITools.applyToolControl(this.id)}.bind(t))}updateToolControls(e){this.toolControlIDs.hasOwnProperty(e)&&this.toolControlIDs[e].forEach(r=>this.updateToolControl(r))}updateToolControl(e){if(this.controlParamObjects.hasOwnProperty(e)){let t=this.controlParamObjects[e].type,r=this.getControlValue(e),a=this.controlCallbacks[e];if(a)a(!1);else if(!(t===void 0||r===void 0))switch(t){case"button":break;case"slider":case"slider_item":{let s=document.getElementById(e);s&&s.noUiSlider&&(s.noUiSlider.set(r),s.updateValueLabel&&s.updateValueLabel());break}case"scrubber":{let s=document.getElementById(e);if(s){let o=this.getParamObject(e);o.hasOwnProperty("min")&&o.min!==s.minValue&&(s.minValue=o.min),o.hasOwnProperty("max")&&o.max!==s.maxValue&&(s.maxValue=o.max),s.value=r}break}case"color":case"color_item":case"color_palette":case"color_group":{let s=document.getElementById(e);if(s){if(s.hashColor=r,s.intensityEnabled){let o=this.controlToolIDs[e],n=e.replace(`${o}_`,"");s.intensity=this.getToolValue(o,`${n}_intensity`)}t==="color_palette"&&s.hasOwnProperty("presetButtons")&&s.presetButtons.updateColorPresetButtons()}break}case"radio":case"toggle_group":{let s=document.getElementById(e);s&&s.value!==r&&(s.value=r);break}case"dropdown_item":{let s=document.getElementById(e);s&&(s.value!==r||s.isMixed)&&(s.value=r);break}case"checkbox":case"checkbox_item":case"toggle_switch":{let s=document.getElementById(e);s&&s.checked!==r&&(s.checked=r);break}case"expandable_checkbox":{let s=document.getElementById(e),o=r?"on":"off";s&&s.checked!==o&&(s.checked=o);break}case"textinput":{let s=document.getElementById(e);s&&s.value!==r&&(s.value=r);break}case"textarea":{let s=document.getElementById(e);s&&s.value!==r&&(s.value=r);break}}}}applyToolControl(e){if(this.controlToolIDs.hasOwnProperty(e)){let t=this.controlToolIDs[e];this.applyTool(t)}}applyTool(e){let t=this.getToolVO(e);if(!t)return;this.printToolVOs&&console.log(Object.keys(t).map(a=>`[ ${a}: ${t[a]} ]`).join(""));let r=new Event(UIToolsEvents.UPDATE_TOOL.type);r.data=e,this.dispatchEvent(r)}setupControlItems(e,t){if(!e||!t)return;let r="";e.forEach((a,s)=>{let{toolID:o,controlID:n,controlName:l,controlParamObject:c}=a,h=BFN.effectPresetMap.hasOwnProperty(o),{customClasses:u=[],name:d=l,icon:m,tooltip:p,type:g,useLabel:f,iconSize:v=20,column:T}=c;switch(T==="left"&&(r+='<div class="control-item-columns">'),g){case"button":{let x=["button","button--fullwidth",d==="reset"?"button--grey-outline":"button--blue",m?"button--has-icon button--centered":""].filter(Boolean).join(" ");m?r+=`
                        <div class="control-item">
                            <button id="${n}" class="${x}">
                                ${m?BeFunky.getSvgHtml(m,{classes:`icon icon--${v}`}):""}
                                <string data-lang="${d}">${BeFunky.LanguageManager.getString(d)}</string>
                            </button>
                        </div>`:r+=`
                        <div class="control-item">
                            <button id="${n}" class="${x}" data-lang="${d}">${BeFunky.LanguageManager.getString(d)}</button>
                        </div>`;break}case"slider":r+=`
                    <div class="control-item control-item--slider ${u.join(" ")}">
                        <label class="control-item-label" data-lang="${d}">${BeFunky.LanguageManager.getString(d)}</label>
                        <div id="${n}"></div>
                    </div>`;break;case"slider_item":r+=`
                    <div class="control-item control-item--slider ${u.join(" ")}">
                        <div id="${n}"></div>
                    </div>`;break;case"color":r+=`
                    <div class="control-item ${u.join(" ")}">
                        <label class="control-item-label" data-lang="${d}">${BeFunky.LanguageManager.getString(d)}</label>
                        <div id="${n}"></div>
                    </div>`;break;case"color_item":r+=`<div class="control-item"><div id="${n}"></div></div>`;break;case"toggle_group":r+=`<div class="control-item">
                        ${f?`<label class="control-item-label" data-lang="${d}">${BeFunky.LanguageManager.getString(d)}</label>`:""}
                        <toggle-group id="${n}"></toggle-group>
                    </div>`;break;case"color_palette":r+=`
                    <div class="control-item">`,h||(r+=`
                        <label class="control-item-label color-palette-label" data-lang="color_palette">
                            ${BeFunky.LanguageManager.getString("color_palette")}
                        </label>`),r+=`
                        <div id="${n}"></div>
                    </div>`;break;case"color_group":r+=`
                    <div class="control-item">`,h||(r+=`
                        <label class="control-item-label color-palette-label" data-lang="color_group">
                            ${BeFunky.LanguageManager.getString("color_group")}
                        </label>`),r+=`
                        <div id="${n}"></div>
                    </div>`;break;case"checkbox":{let x=e[s-1];(!x||x.controlParamObject.type!=="checkbox")&&(r+=`<div class="control-item button-group ${u.join(" ")}">`),r+=`
                    <input type="checkbox" id="${n}" />
                    <label class="button button--white-outline button--toggle button--icon" for="${n}" ${p?`data-tooltip="${p}"`:""} >
                        <svg class="icon icon--${v}">
                            <use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="#${m}"></use>
                        </svg>
                    </label>`;let B=e[s+1];(!B||B.controlParamObject.type!=="checkbox")&&(r+="</div>");break}case"checkbox_item":r+=`<div class="control-item"><div id="${n}"></div></div>`;break;case"dropdown_item":r+=`
                    <div class="control-item">
                        <dropdown-select id="${n}"></dropdown-select>
                    </div>
                `;break;case"scrubber":r+=`
                    <div class="control-item">
                        <label class="control-item-label" data-lang="${d}">${BeFunky.LanguageManager.getString(d)}</label>
                        <scrubber-input id="${n}"></scrubber-input>
                    </div>
                    `;break}T==="right"&&(r+="</div>")}),t.insertAdjacentHTML("beforeend",r)}disableControlItem(e,t,r="control-item",a=null){let s=document.getElementById(e),o=s?s.closestParent(n=>n.hasClass(r)):null;o?(o.toggleClass("control-item-disabled",!!t),o.setStyles({opacity:t&&typeof a=="number"?a:""})):BeFunky.logError("Unable to find control item to disable",{_controlID:e,_class:r})}toggleControlItem(e,t){let r=document.getElementById(e),a=r?r.closestParent(s=>s.hasClass("control-item")):null;if(a){!a.hasOwnProperty("activeDisplayMode")&&a.style.display!=="none"&&(a.activeDisplayMode=a.style.display);let s=typeof a.activeDisplayMode=="string"?a.activeDisplayMode:"block";return a.setStyles(t?{display:s}:{display:"none"}),!0}return!1}toggleElement(e,t){let r=document.getElementById(e);if(r){if(!r.hasOwnProperty("activeDisplayMode")){let s=getComputedStyle(r).getPropertyValue("display");s&&s!=="none"&&(r.activeDisplayMode=s)}let a=r.activeDisplayMode||"block";return r.setStyles(t?{display:a}:{display:"none"}),!0}return!1}};BFN.SingletonQueue.add(()=>{window.UITools=new kh});var Ah=class{constructor(){this.init()}init(){this.initDefaultValues()}initDefaultValues(){this.mainMenuContainer=document.getElementById("main_menu_panels"),this.topNavBar=document.getElementById("top_nav_bar"),this.sampleImagePopover=null}cancelActiveEditorTool(){BFN.PhotoEditorCanvasModel.exitCurrentEditorTool()}toggleNavBar(e){this.topNavBar.setStyles({pointerEvents:e?"":"none",opacity:e?1:.5})}toggleMainMenu(e){this.mainMenuContainer.toggleClass("main-menu--disabled",!e)}toggleZoomMenu(e){BFN.canvasFooter.zoomEnabled=Boolean(e)}setupSampleImagePopover(){let{appLang:e,elem:t,html:r}=BeFunky.lit,a=["blue-vw-van","woman-headshot-pink-coat","venice-sunset"];a.map(c=>n(c).largeUrl).forEach(c=>BeFunky.addToServiceWorkerCache("ui-images",c));let s=t`
        <div class="sample-images">
            <div data-lang="guide_upload_photo" class="sample-images__main-text">${e("guide_upload_photo",!0)}</div>
            <div class="sample-images__sub-text">
                <hr><span data-lang="guide_upload_photo_samples" >${e("guide_upload_photo_samples",!0)}</span>
            </div>
            <div class="sample-images__container">
                ${a.map(c=>l(c))}
            </div>
        </div>`,o=document.getElementById("sample_image_popover");return o.container.appendChild(s),o;function n(c){return{thumbUrl:`${BFN.imagesURL}app/sample-images/${c}-thumb.jpg?width=144`,largeUrl:`${BFN.imagesURL}app/sample-images/${c}-large.jpg`}}function l(c){let{thumbUrl:h,largeUrl:u}=n(c);return r`<button @click=${()=>BFN.PhotoEditorModel.openSampleImage(u,c==="woman-headshot-pink-coat")} class="sample-images__button">
                <div class="sample-images__hover-container"></div>
                <img alt="Sample Image" src=${h} />
            </button>`}}toggleSampleImagePopover(){let e=Boolean(this.sampleImagePopover&&this.sampleImagePopover.hasClass("active")),t=Boolean(BFN.AppModel.viewingEditor&&!BFN.PhotoEditorModel.currentTexture);e!==t&&(this.sampleImagePopover=this.sampleImagePopover||this.setupSampleImagePopover(),t?this.sampleImagePopover.show():this.sampleImagePopover.hide(),document.getElementById("appViewport").toggleClass("show-drag-drop-area--initial",t),document.getElementById("canvas_drag_drop_area").toggleClass("drag-drop-area--initial",t),this.topNavBar.allowSave=!t,BFN.secondaryMenu.isDisabledOnMobile=t)}openAlternateMenu(e,t){let r={graphic_properties:"graphic_properties",image_properties:"image_properties",text_properties:"text_properties"};BFN.alternateMenu.heading=e,BFN.alternateMenu.clueId=r[e]||"",BFN.alternateMenu.menuIds=t,BFN.alternateMenu.isOpen=!0,BFN.alternateMenu.isDisabled=!1}closeAlternateMenu(){if(this.topNavBar.isEditingLayerInAlternateMenu){BFN.alternateMenu.isDisabled=!1;return}BFN.alternateMenu.isOpen=!1}showLoadScreenWhileTrue(e,t=0){this.testMethods||(this.testMethods=[]),e&&!this.testMethods.includes(e)&&(e.active=!0,this.testMethods.length?this.testMethods.push(e):(this.testMethods.push(e),this.processLoadScreenTestMethods(t)))}processLoadScreenTestMethods(e){if(this.testMethods.length){let t=!1,r=!1;this.testMethods.forEach(a=>{a.active?r=r||a():t=!0}),r||t?(r&&!BeFunky.isLoadScreenActive()?BeFunky.showLoadScreen({isCancellable:!1,visibilityDelay:e}):!r&&BeFunky.isLoadScreenActive()&&BeFunky.hideLoadScreen(),requestAnimationFrame(this.processLoadScreenTestMethods.bind(this))):(this.testMethods.forEach(a=>{delete a.active}),this.testMethods.splice(0),BeFunky.isLoadScreenActive()&&BeFunky.hideLoadScreen())}}};BFN.SingletonQueue.add(()=>{window.UIToggler=new Ah});window.UIHistoryEvents={HISTORY_ITEMS_UPDATED:new Event("HISTORY_ITEMS_UPDATED")};var Oh=class extends BFN.EventDispatcher{constructor(){super();BFN.AppModel.addEventListener(BFN.AppModelEvents.APP_READY.type,()=>{this.init()})}init(){this.initDefaultValues()}initDefaultValues(){this.historyItemObjects=[],this.historyItemIds=[],this.mouseEvent=null,this.updateHistoryAvailable(),this.handleGlobalHistoryIDUpdated=BeFunky.debounce(this.handleGlobalHistoryIDUpdated.bind(this),10),BFN.GlobalHistoryModel.addEventListener(BFN.GlobalHistoryModelEvents.HISTORY_UPDATED.type,this.handleGlobalHistoryUpdated.bind(this)),BFN.GlobalHistoryModel.addEventListener(BFN.GlobalHistoryModelEvents.HISTORY_ID_UPDATED.type,this.handleGlobalHistoryIDUpdated.bind(this)),BFN.GlobalHistoryModel.addEventListener(BFN.GlobalHistoryModelEvents.HISTORY_BUTTONS_UPDATED.type,this.handleGlobalHistoryButtonsUpdated.bind(this)),BFN.AppModel.addEventListener(BFN.AppModelEvents.VIEWSTATE_UPDATED.type,this.updateHistoryAvailable.bind(this)),BFN.PhotoEditorModel.addEventListener(BFN.PhotoEditorModelEvents.SOURCE_IMAGE_UPDATED.type,this.updateHistoryAvailable.bind(this)),BFN.PhotoEditorCanvasModel.addEventListener(BFN.PhotoEditorCanvasModelEvents.VIEWSTATE_UPDATED.type,this.updateHistoryAvailable.bind(this))}handleHistory(){let e=UITools.getToolVO("history");switch(e.updating_id){case"toggle_panel":this.toggleHistoryPanel(e.toggle_panel);break}}setupHistoryPanel(){this.historyPanel=document.getElementById("history_panel"),this.updateHistoryPanel(),this.panelHeader=this.historyPanel.querySelector("panel-header"),BFN.UI.draggablePanel(this.historyPanel);let e;BFN.HelpClueManager.setup("global_history",{side:"right",positionFactor:.37,left:"-12px",container:()=>e||(e=BeFunky.lit.elem`<div></div>`,this.panelHeader.insertAdjacentElement("afterend",e),e)}),this.panelHeader.addEventListener("CLOSE",()=>{UITools.setToolValue("history","toggle_panel",!1,!1),UITools.applyTool("history"),UITools.updateToolControls("history")}),this.buttonContainer=this.historyPanel.querySelector(".history-panel__list"),this.buttonContainerInner=this.buttonContainer.firstElementChild,this.buttonContainer.addEventListener("click",t=>{if(!t.target.historyItemId)return;let r=t.target;BFN.GlobalHistoryModel.historyUpdateQueued||!UIHistory.historyItemIds.includes(r.historyItemId)||(r.historyItemId!==this.selectedItemId?(BFN.GlobalHistoryModelEvents.SELECT_HISTORY_ITEM.data=r.historyItemId,BFN.GlobalHistoryModel.dispatchEvent(BFN.GlobalHistoryModelEvents.SELECT_HISTORY_ITEM),BFN.BfnService.track("CREATE","HISTORYPANEL","LIST")):BFN.AppModel.viewingEditor&&BFN.PhotoEditorCanvasModel.viewState!==BFN.PhotoEditorCanvasModelViewStates.VIEWING_CANVAS&&BFN.ImagePainterUndoManager.currentImagePainter&&document.getElementById("editor_apply_cancel_cancel").click())}),BeFunky.LanguageManager.addLanguageUpdateListener(t=>{t.includes("app")&&this.updateHistoryPanel()}),this.handleButtonContainerOverBind=this.handleButtonContainerOver.bind(this),this.handleButtonContainerOutBind=this.handleButtonContainerOut.bind(this),this.handleButtonContainerMoveBind=this.handleButtonContainerMove.bind(this),this.historyPreviewPopover=document.getElementById("history_preview_popover"),BFN.UI.popover(this.historyPreviewPopover),this.historyPreviewImage=new Image,this.historyPreviewImage.onload=function(){let t=document.getElementById("history_preview_image_container");t.innerHTML="",t.appendChild(this.historyPreviewImage),this.updateHistoryPreviewPopoverDisplay()}.bind(this),this.buttonContainer.addEventListener(BeFunky.pointerover,this.handleButtonContainerOverBind),this.buttonContainer.addEventListener(BeFunky.pointerout,this.handleButtonContainerOutBind)}updateHistoryPanel(){!this.historyPanel||BeFunky.lit.render(this.historyPanelTemplate(),this.historyPanel)}historyPanelTemplate(){let e=this.historyItemObjects,t=e.findIndex(n=>n.id===this.selectedItemId),{html:r,icon:a,appLang:s}=BeFunky.lit;return r`
        <panel-header .langId=${"history"} .modifier=${"alternate"} .buttons=${"close,help"} .clueId=${"global_history"}></panel-header>

        <div class="history-panel__list">
            <div class="scrollable-content">
                ${e.map(o)}
            </div>
        </div>

        <div id="history_preview_popover" class="popover" data-side="right" data-strong="true" style="position:absolute;left:-10px;top:0;">
            <div id="history_preview_image_container"></div>
        </div>
        `;function o(n,l){let{id:c,translation:h,isGroup:u,useGroupIcon:d,isText:m,useTextIcon:p,thumb:g,preview:f}=n,v="";u||d?v=r`<span class="button__image">${a("history-group-icon","icon icon--16")}</span>`:m||p?v=r`<span class="button__image">${a("text-icon","icon icon--16")}</span>`:g?v=r`<img class="button__image" alt="" src=${g.src} />`:BeFunky.isSmartphone||BeFunky.reportWarning("No icon or image for history button",n);let T=["history-panel__button","button button--sm button--fullwidth button--has-icon button--grey-200",t===-1||l<=t?"active":"",t===l?"button--selected":""].filter(Boolean).join(" ");return r`<button .historyItemId=${c} .previewSrc=${f?f.src:""} class="${T}">
                ${v}
                <string>${s(h)}</string>
            </button>`}}toggleHistoryPanel(e){e&&!this.historyPanel&&this.setupHistoryPanel();let t=()=>{if(!BFN.MainUI.viewportUpdating||!e||e&&this.temporarilyHidePanel)if(e){let r=10,{panelSize:a}=this.historyPanel,s=BFN.appViewportRect;this.temporarilyHidePanel?(this.temporarilyHidePanel=!1,this.historyPanel.show()):this.historyPanel.show(s.x+s.width-a.width-r,s.y+s.height-a.height-r),BFN.HelpClueManager.show("global_history")}else this.hasOwnProperty(this.togglePanelTimeoutID)&&(clearTimeout(this.togglePanelTimeoutID),delete this.togglePanelTimeoutID),this.historyPanel&&(this.historyPanel.hide(),BFN.HelpClueManager.hide("global_history"));else this.togglePanelTimeoutID=setTimeout(()=>{t(e)},10)};t()}updateHistoryAvailable(){let e=BFN.PhotoEditorCanvasModel.viewState===BFN.PhotoEditorCanvasModelViewStates.VIEWING_CANVAS&&!BFN.TransformItemIsolator.active;BFN.AppModel.viewingEditor?e=e&&BFN.PhotoEditorModel.currentTexture:e&&this.temporarilyHidePanel&&(UITools.setToolValue("history","toggle_panel",!0),UITools.applyTool("history"),UITools.updateToolControls("history")),!e&&UITools.getToolValue("history","toggle_panel")?this.temporarilyHidePanel=!0:e&&this.temporarilyHidePanel&&(UITools.setToolValue("history","toggle_panel",!0),UITools.applyTool("history"),UITools.updateToolControls("history")),BFN.canvasFooter.historyEnabled=Boolean(e),!e&&UITools.getToolValue("history","toggle_panel")&&(UITools.setToolValue("history","toggle_panel",!1),UITools.applyTool("history"),UITools.updateToolControls("history"))}updateHistoryPreviewPopoverDisplay(){if(this.mouseEvent){let e=parseInt(this.historyPanel.style.top),t=Math.round(this.mouseEvent.pageY);this.historyPreviewPopover.setStyles({top:`${t-e}px`});let r=224,a=38,s=230,o=e+a,n=t-o,l=this.historyPreviewPopover.container.getBoundingClientRect().height,c=n/s,h=Math.min(1,s/l);this.historyPreviewPopover.positionFactor=(1-h)/2+c*h,parseInt(this.historyPanel.style.left)+r/2>BFN.appRect.width/2?(this.historyPreviewPopover.setStyles({left:"-10px"}),this.historyPreviewPopover.side="right"):(this.historyPreviewPopover.setStyles({left:`${r+10}px`}),this.historyPreviewPopover.side="left")}}handleGlobalHistoryUpdated(e){this.historyItemObjects=e.data,this.historyItemIds=e.ids,this.selectedItemId=e.data.length?e.data[e.data.length-1].id:this.selectedItemId,this.updateHistoryPanel(),this.buttonContainerInner&&(this.buttonContainerInner.scrollTop=this.buttonContainerInner.scrollHeight),this.dispatchEvent(UIHistoryEvents.HISTORY_ITEMS_UPDATED)}handleGlobalHistoryIDUpdated(e){let t=e.data;if(this.selectedItemId!==t&&(this.selectedItemId=t,this.updateHistoryPanel(),this.buttonContainerInner&&this.historyItemIds.length&&this.historyItemIds.includes(t))){let{scrollTop:r}=this.buttonContainerInner,a=34,s=this.historyItemIds.indexOf(t)*a;if(s<r)this.buttonContainerInner.scrollTop=s;else{let o=this.buttonContainerInner.getBoundingClientRect().height;s+a>o+r&&(this.buttonContainerInner.scrollTop=s+a-o)}}}handleGlobalHistoryButtonsUpdated(e){let t=Boolean(e.data.undoExists),r=Boolean(e.data.redoExists),a=Boolean((!BFN.AppModel.viewingEditor||BFN.AppModel.viewingEditor&&BFN.PhotoEditorModel.currentTexture)&&!BFN.TransformItemIsolator.active&&!BFN.ImageEditManager.editingImage);UIToggler.topNavBar.undoEnabled=t,UIToggler.topNavBar.redoEnabled=r,BFN.canvasFooter.resetEnabled=a,BFN.canvasFooter.undoEnabled=t,BFN.canvasFooter.redoEnabled=r}handleButtonContainerOver(e){if(!e.target.historyItemId)return;this.mouseEvent=e;let t=e.target;t.previewSrc?(this.historyPreviewImage.src=t.previewSrc,this.showPreview()):this.hidePreview()}handleButtonContainerOut(e){if(!e.target.historyItemId)return;this.mouseEvent=e;let t=e.target;this.historyPreviewImage.src&&this.historyPreviewImage.src===t.previewSrc&&(this.hidePreview(),this.buttonContainer.removeEventListener(BeFunky.pointermove,this.handleButtonContainerMoveBind))}handleButtonContainerMove(e){this.mouseEvent=e,this.updateHistoryPreviewPopoverDisplay()}showPreview(){this.historyPreviewPopover.isActive||(this.updateHistoryPreviewPopoverDisplay(),this.historyPreviewPopover.show(),this.buttonContainer.addEventListener(BeFunky.pointermove,this.handleButtonContainerMoveBind))}hidePreview(){!this.historyPreviewPopover.isActive||(this.historyPreviewPopover.hide(),this.buttonContainer.removeEventListener(BeFunky.pointermove,this.handleButtonContainerMoveBind))}};BFN.SingletonQueue.add(()=>{window.UIHistory=new Oh});var Rh=class extends BFN.EventDispatcher{constructor(){super();this.init()}init(){BeFunky.log("UIMessages Init"),this.initDefaultValues(),this.initMessageScreen()}initDefaultValues(){}initMessageScreen(){this.messageScreen=document.getElementById("messageScreen"),BFN.UI.messageScreen(this.messageScreen)}display(e,t){this.messageScreen.show(e||"< MESSAGE MISSING >",t)}};BFN.SingletonQueue.add(()=>{window.UIMessages=new Rh});var Lh=class extends BFN.EventDispatcher{constructor(){super();setTimeout(this.init.bind(this),0)}init(){BeFunky.log("UIScreens Init"),this.initTooltipScreen(),this.initDragScreen(),this.initCursorScreen()}initTooltipScreen(){this.tooltipScreen=document.getElementById("tooltipScreen"),BFN.UI.tooltipScreen(this.tooltipScreen),BFN.TooltipScreen=this.tooltipScreen,this.tooltipDelay=50,this.tooltipMouseEvent=null,this.attemptToShowTooltip=BeFunky.debounce(()=>{if(this.tooltipScreen.reserved)return;let{tooltip:e,isAbove:t,element:r,isBelow:a}=this.getTooltip(this.tooltipMouseEvent.target);if(e){let s=e.startsWith("shortcut__")?BFN.KeyboardManager.getShortcutTooltip(e.replace("shortcut__","")):BeFunky.LanguageManager.getString(e),o=/^[a-z0-9_!]+$/.test(e)&&s.includes("<");this.tooltipScreen.show(s,!1,!1,o);let{prevY:n,prevX:l}=this.tooltipScreen,c=r.getBoundingClientRect(),h=r.nodeName==="CANVAS";if(c.width===0&&c.height===0)return;let u,d;if(h?(u=this.tooltipMouseEvent.pageX,d=c.y):t?(u=c.x+c.width/2,d=c.y):a?(u=c.x+c.width/2,d=c.bottom):(u=c.x+c.width,d=c.y+c.height/2),l===u&&n===d)return;this.tooltipScreen.prevTooltip=e,this.tooltipScreen.prevY=d,this.tooltipScreen.prevX=u,this.tooltipScreen.setPosition(u,d,{isAbove:t,isOnCanvas:h,isBelow:a,elementRect:c})}},this.tooltipDelay),this.handleDocumentMouseDown=this.handleDocumentMouseDown.bind(this),this.handleDocumentMouseMove=this.handleDocumentMouseMove.bind(this),this.handleDocumentMouseUp=this.handleDocumentMouseUp.bind(this),this.isMouseListened=!1,this.toggleMouseEvent(!0)}toggleMouseEvent(e){this.isMouseListened!==e&&(this.isMouseListened=e,e?(document.addEventListener(BeFunky.pointerdown,this.handleDocumentMouseDown),document.addEventListener(BeFunky.pointerup,this.handleDocumentMouseUp),document.addEventListener(BeFunky.pointermove,this.handleDocumentMouseMove)):(document.removeEventListener(BeFunky.pointerdown,this.handleDocumentMouseDown),document.removeEventListener(BeFunky.pointerup,this.handleDocumentMouseUp),document.removeEventListener(BeFunky.pointermove,this.handleDocumentMouseMove)))}initDragScreen(){this.dragScreen=document.getElementById("dragScreen"),BeFunky.dragScreen(this.dragScreen),BFN.DragScreen=this.dragScreen}initCursorScreen(){let{appStage:e}=BFN.StageModel;BFN.UI.cursorScreen(e),BFN.CursorScreen=e}getTooltip(e){if(!e||!e.getAttribute)return{};if(e===BFN.Stage.view)return BFN.MainUI.tooltip?{tooltip:BFN.MainUI.tooltip,isAbove:!1,element:e}:{};let t=e.getAttribute("data-tooltip");if(t)return{tooltip:t,isAbove:e.hasAttribute("data-tooltip-above"),isBelow:e.hasAttribute("data-tooltip-below"),element:e};let r=e.parentElement;return r&&r.id!=="bfn-app"?this.getTooltip(r):{}}handleDocumentMouseDown(){this.tooltipScreen.reserved||this.tooltipScreen.hide()}handleDocumentMouseMove(e){if(this.tooltipScreen.reserved||BeFunky.isPointerDown)return;this.tooltipMouseEvent=e;let{tooltip:t}=this.getTooltip(this.tooltipMouseEvent.target);this.tooltipScreen.hide(t),this.attemptToShowTooltip()}handleDocumentMouseUp(e){this.tooltipScreen.reserved||BeFunky.isPointerDown||!this.tooltipScreen.active||!this.tooltipMouseEvent||!["BUTTON","INPUT"].includes(this.tooltipMouseEvent.target.nodeName)||(this.tooltipMouseEvent=e,this.attemptToShowTooltip())}};BFN.SingletonQueue.add(()=>{window.UIScreens=new Lh});var{html:_i,setupState:CI,render:Ua,appLang:Do,icon:da,elem:Ga}=BeFunky.lit;function wo({onGroupSelection:i,onDeleteGroup:e,isLayerSelectedMostRecently:t,selectLayer:r,onLayerClick:a,onLayerPointerDown:s,onLayerLockOrUnlock:o,onLayerHideOrShow:n}){let l=Ga`<div id="layers_groups_panel" class="layers-groups"></div>`,c,h,u,d,m=!0,p,g={layers:[],groups:[],expandedGroupIDs:[],selectedLayerIDs:[],renamingLayer:null,renamingGroup:null,lastClickedGroupID:null},f=BeFunky.debounce(()=>{!d||(m?(Ua(b(),h),Ua(I(),u),m=!1):c.activeTab==="layers"?Ua(b(),h):Ua(I(),u),p&&p())},"raf"),[v,T]=CI(g,f);BeFunky.LanguageManager.addLanguageUpdateListener(f);let x=j();J(),Ua(F(),l),BFN.UI.draggablePanel(l);let{show:B,hide:y}=l;return Object.assign(l,{state:v,setState:T,switchTabs:he,show:ie,hide:re}),l;function F(){return _i`
            ${x}
            ${c}
        `}function b(){if(!v.layers.length)return _i`<p class="layers-groups__no-layers">${Do("no_layers")}</p>`;let H=v.layers.map(V=>S(V));return setTimeout(()=>{h.isSortableList?h.refreshList():BFN.UI.sortableList(h,{handleTargetIndexUpdated:A,handleOrderUpdated:X})},0),H}function S(H){let{id:V,item:K}=H,ee=["layer-item","button button--grey-200 button--has-image","sortable-list__item",v.selectedLayerIDs.includes(V)?"button--selected":""].filter(Boolean).join(" ");return _i`
        <div
            @click=${ge=>{ge.detail===0&&r(H),a(H)}}
            @mousedown=${ge=>pe(ge,H)}
            @pointerdown=${ge=>pe(ge,H)}
            @contextmenu=${ge=>ge.preventDefault()}
            .layerObject=${H}
            .draggingEnabled=${v.renamingLayer===null}
            class=${ee}
        >
            ${N(K.type,K.thumbImage?K.thumbImage.src:"")}
            ${w(H)}
            ${M(H)}
            ${z(H)}
        </div>
        `}function I(){return v.groups.length?v.groups.map(_):_i`<p class="layers-groups__no-groups">
                <img src="${BFN.imagesURL}illustrations/no-groups.svg" alt="">
                ${Do(["no_groups",{learn_more:`<a href="${BeFunky.Params.blogUrl}layers-and-groups/" target="_blank" class="tutorial-link">${Do("learn_more",!0)}</a>`}])}
            </p>`}function _(H){let{id:V,itemIDs:K}=H,ee=K.length>0,se=v.expandedGroupIDs.includes(V),ge=ee&&K.every(Ne=>v.selectedLayerIDs.includes(Ne)),Ce=K.map(Ne=>v.layers.find(Ge=>Ge.id===Ne));return Ce.every(Boolean)||(BeFunky.logError("Unable to find layer for group",JSON.stringify({group:H,layers:v.layers.map(Ne=>Ne&&{id:Ne.id,name:Ne.name,item:Ne.item instanceof BFN.TransformItem?"TransformItem":BeFunky.stringValue(Ne.item)})})),Ce=Ce.filter(Boolean)),_i`
        <div @contextmenu=${Ne=>Ne.preventDefault()} class=${`group-item ${ee?"":"group-item--empty"}`}>
            <div @click=${Ne=>R(Ne,V)} class="${`group-item__header button button--grey-200 ${ge?"button--selected":""}`}">
                <button
                    @click=${Ne=>G(Ne,V)}
                    class=${`button button--icon button--xs button--transparent group-item__header-button group-item__header-button--${se?"collapse":"expand"}`}
                    data-tooltip=${se?"collapse":"expand"}
                    data-tooltip-above
                >
                    ${da("chevron-icon","icon icon--8")}
                </button>
                ${da("layers-icon","icon icon--16 group-item__header-icon")}
                ${E(H)}
                <button
                    @click=${Ne=>L(Ne,V)}
                    class="button button--icon button--sm button--transparent group-item__header-button--delete"
                    data-tooltip="delete_group"
                    data-tooltip-above
                >
                    ${da("delete-icon","icon icon--16")}
                </button>
            </div>
            <div class=${`group-item__members ${se?"":"focus-avoid"}`} style=${`height: ${se?(32+2)*K.length:0}px`}>
                ${Ce.map(Ne=>D(Ne))}
            </div>
        </div>
        `}function E(H){return v.renamingGroup===H?W(H):_i`<string
            @click=${V=>Z(V,H)}
            class="group-item__header-name"
            data-tooltip=${ae(H)?"rename_group":""}
            data-tooltip-above
        >
            ${H.name}
        </string>`}function D(H){let{id:V,item:K}=H,ee=["layer-item","button button--grey-200 button--has-image","button--sm",v.selectedLayerIDs.includes(V)?"button--selected":""].filter(Boolean).join(" ");return _i`
        <div
            @click=${Ce=>{Ce.detail===0&&r(H),a(H)}}
            @keyup=${Ce=>{Ce.key==="Enter"&&Ce.target.click()}}
            @mousedown=${Ce=>pe(Ce,H)}
            @pointerdown=${Ce=>pe(Ce,H)}
            @contextmenu=${Ce=>Ce.preventDefault()}
            .layerObject=${H}
            class=${ee}
            tabindex="0"
        >
            ${N(K.type,K.thumbImage?K.thumbImage.src:"")}
            ${w(H)}
            ${M(H)}
            ${z(H)}
        </div>
        `}function w(H){return v.renamingLayer===H?W(H):_i`<string @click=${V=>Ie(V,H)} class="layer-item__name">${H.name}</string>`}function N(H,V){return H==="text"?_i`<span class="button__image">${da("text-icon","icon icon--16")}</span>`:V?_i`<img class="button__image" src=${V} alt="" />`:""}function M(H){let{item:V}=H,{locked:K}=V;return _i`<button
            @mousedown=${Y}
            @pointerdown=${Y}
            @click=${se=>{se.stopPropagation(),o(H),f(),se.target.blur()}}
            class=${`button button--icon button--transparent ${K?"button--visible":""}`}
            data-tooltip="${K?"unlock_layer":"lock_layer"}"
            data-tooltip-above
        >
            ${da(`${K?"lock-icon":"unlocked-icon"}`,"icon icon--16")}
        </button>`}function z(H){let{item:V}=H,{hidden:K}=V;return _i`<button
            @mousedown=${Y}
            @pointerdown=${Y}
            @click=${se=>{se.stopPropagation(),n(H),f(),se.target.blur()}}
            class=${`button button--icon button--transparent ${K?"button--visible":""}`}
            data-tooltip="${K?"show_layer":"hide_layer"}"
            data-tooltip-above
        >
            ${da(`${K?"hidden-icon":"touchup-icon"}`,"icon icon--16")}
        </button>`}function W(H){let V=Boolean(H.itemIDs),K=`edit_name_${H.id}`;return!document.getElementById(K)&&requestAnimationFrame(()=>{let se=document.getElementById(K);se&&(se.focus(),se.select())}),_i`<input
            id=${K}
            type="text"
            class="input"
            value=${H.name}
            @click=${se=>se.stopPropagation()}
            @keydown=${se=>V?U(se,H):ke(se,H)}
            @blur=${se=>V?k(se,H):de(se,H)}
        />`}function j(){let H=Ga`<panel-header lang-id="layers_and_groups" modifier="alternate" buttons="help,close" clue-id="layers_groups"></panel-header>`;return H.addEventListener("CLOSE",()=>{UITools.setToolValue("layers","toggle_panel",!1,!1),UITools.applyTool("layers"),UITools.updateToolControls("layers")}),H}function J(){c=Ga`<tabbed-layout class="layers-groups__tabs"></tabbed-layout>`;let H=Ga`<div class="layers-groups__layers"><div class="scrollable-content"></div></div>`;h=H.firstElementChild;let V=Ga`<div class="layers-groups__groups"><div class="scrollable-content"></div></div>`;u=V.firstElementChild,c.tabs={layers:H,groups:V},c.activeTab="layers",c.addEventListener("TAB_CHANGE",_e),requestAnimationFrame(()=>{c.querySelector(".tabs__nav").addEventListener(BeFunky.pointerdown,K=>{K.stopImmediatePropagation(),BFN.ColorPickerPanel.colorButton&&(BFN.ColorPickerPanel.colorButton=null)},!0)})}function ie(...H){d=!0,f(),B.call(l,...H);let{top:V,right:K}=l.getBoundingClientRect(),ee=408,se=308;BFN.HelpClueManager.show("layers_groups",{renderOptions:{left:`${K+10}px`,top:`${V-(ee-se)}px`}})}function re(){d=!1,y.call(l)}function he(H){c.activeTab=H}function ne(H,V,K){H.setItemZIndex(V,K),H.transformLayer.lastClickedItem=H,H.transformLayer.transformItems.includes(H)||BeFunky.throwError("TransformItem is in layers & groups panel but not in TransformLayer")}function le(H,V){if(v.renamingLayer!==V)return;let K=H.target.value.trim();K&&V.name!==K?(V.item.itemName=K,T({renamingLayer:null,layers:v.layers.map(ee=>(ee.id===V.id&&(ee.name=K),ee))})):T({renamingLayer:null})}function Be(H,V){if(v.renamingGroup!==V)return;let K=H.target.value.trim();K&&V.name!==K?(BFN.GroupManager.renameGroup(V.id,K),T({renamingGroup:null,groups:v.groups.map(ee=>(ee.id===V.id&&(ee.name=K),ee))})):T({renamingGroup:null})}function _e(){v.lastClickedGroupID?T({lastClickedGroupID:null}):f()}function pe(H,V){if(H.type!==BeFunky.pointerdown)return;let K=c.activeTab==="layers"&&v.selectedLayerIDs.length>1;return s(H,V,K)}function Ie(H,V){H.shiftKey||H.ctrlKey||H.metaKey||!t(V)||T({renamingLayer:V})}function ke(H,V){H.keyCode===27?T({renamingLayer:null}):H.keyCode===13&&le(H,V)}function de(H,V){le(H,V)}function Z(H,V){H.shiftKey||H.ctrlKey||H.metaKey||!ae(V)||T({renamingGroup:V})}function U(H,V){H.keyCode===27?T({renamingGroup:null}):H.keyCode===13&&Be(H,V)}function k(H,V){Be(H,V)}function G(H,V){H.stopPropagation(),v.expandedGroupIDs.includes(V)?T({expandedGroupIDs:v.expandedGroupIDs.filter(K=>K!==V)}):T({expandedGroupIDs:[...v.expandedGroupIDs,V]})}function L(H,V){H.stopPropagation(),e(V)}function R(H,V){if(T({lastClickedGroupID:V}),!(H.ctrlKey||H.metaKey))return i([V]);let ee=v.groups.filter(({itemIDs:se})=>se.every(ge=>v.selectedLayerIDs.includes(ge))).map(se=>se.id).unique();ee.includes(V)||i([...ee,V])}function A(H,V,K){let ee=v.layers.length-K-1;ne(H.layerObject.item,ee,!0)}function X(H,V,K){let ee=v.layers.length-K-1;return ne(H.layerObject.item,ee,!1),new Promise(se=>{let ge=setTimeout(()=>{BeFunky.throwError("handleOrderUpdated timed out"),se()},1e3);p=()=>{clearTimeout(ge),se()}})}function Y(H){H.stopPropagation()}function ae(H){return v.lastClickedGroupID!==H.id?!1:H.itemIDs.length>0&&H.itemIDs.every(V=>v.selectedLayerIDs.includes(V))}}var Vh=class{constructor(){this.init()}init(){window.addEventListener("INIT_COMPLETE",()=>{this.initDefaultValues(),this.updateLayersAvailable()})}initDefaultValues(){this.updateLayersAvailable=BeFunky.debounce(this.updateLayersAvailable.bind(this),10),this.handleItemsUpdated=BeFunky.debounce(this.handleItemsUpdatedImmediately.bind(this),10),BFN.AppModel.addEventListener(BFN.AppModelEvents.VIEWSTATE_UPDATED.type,this.updateLayersAvailable),BFN.PhotoEditorCanvasModel.addEventListener(BFN.PhotoEditorCanvasModelEvents.VIEWSTATE_UPDATED.type,this.updateLayersAvailable),BFN.TransformLayerManager.addEventListener(BFN.TransformLayerManagerEvents.ITEMS_UPDATED.type,this.updateLayersAvailable),BFN.TransformLayerManager.addEventListener(BFN.TransformLayerManagerEvents.ITEMS_UPDATED.type,this.handleItemsUpdated),BFN.TransformLayerManager.addEventListener(BFN.TransformLayerManagerEvents.SELECTION_UPDATED.type,this.handleSelectionUpdated.bind(this)),BFN.GroupManager.addEventListener(BFN.GroupManagerEvents.GROUPS_UPDATED.type,this.handleGroupsUpdated.bind(this)),BeFunky.LanguageManager.addLanguageUpdateListener(this.handleLanguageChanged.bind(this))}setupLayersPanel(){this.layersPanel||(this.layersPanel=wo({onGroupSelection:e=>BFN.GroupManager.selectGroups(e),onDeleteGroup:e=>BFN.GroupManager.deleteGroup(e),isLayerSelectedMostRecently:({item:e})=>BFN.TransformModel.selectedTransformItem===e&&e.transformLayer.lastClickedItem===e,onLayerClick:({item:e})=>{e.transformLayer.lastClickedItem=e},selectLayer:({item:e})=>{e.selectItem()},onLayerPointerDown:(e,t,r)=>{e.stopPropagation(),BFN.ColorPickerPanel.colorButton&&(BFN.ColorPickerPanel.colorButton=null);let{item:a}=t,{lastPressedItem:s}=a.transformLayer,{lastSelectedItem:o}=a.transformLayer;if(a.transformLayer.lastPressedItem=a,BFN.TransformModel.selectedTransformItem===a&&e.button!==2){a.initiateLongPress();return}if(e.button===2&&(a.transformLayer.lastClickedItem=a),e.button===2&&r){BFN.TransformItemGroup.pressItem(e);return}if(e.shiftKey&&!e.ctrlKey&&!e.metaKey&&!e.altKey){if(BFN.TransformLayerManager.selectedItems.length===1&&BFN.TransformLayerManager.selectedItems[0]===a||!s||!o){a.pressItem(e);return}let n=[...BFN.TransformLayerManager.selectedItems],l=BFN.TransformLayerManager.transformItems.indexOf(s),c=BFN.TransformLayerManager.transformItems.indexOf(o),h=BFN.TransformLayerManager.transformItems.indexOf(a),u=BFN.TransformLayerManager.transformItems.slice(Math.min(h,l),Math.max(h,l)+1),d=n.length;for(;--d>-1;){let p=n[d];u.includes(p)&&n.splice(d,1)}BFN.TransformLayerManager.transformItems.slice(Math.min(h,c),Math.max(h,c)+1).forEach(p=>{n.includes(p)||n.push(p)}),BFN.GroupManager.selectItems(n)}else a.pressItem(e),a.initiateLongPress()},onLayerLockOrUnlock:e=>{let{item:t}=e;t.createTransition(`history_${t.locked?"unlock":"lock"}_layer`),t.locked=!t.locked,t.registerTransition(!1,!1),t.transformTool.item===t&&t.transformTool.updateDisplay(),BFN.MainUI.requestRender()},onLayerHideOrShow:e=>{let{item:t}=e;t.createTransition(`history_${t.hidden?"show":"hide"}_layer`),t.hidden=!t.hidden,t.registerTransition(!1,!1),t.transformTool.item===t&&t.transformTool.updateDisplay(),t.hidden&&t.transformLayer.selectedItem===BFN.TransformItemGroup||t.transformLayer.selectedItem===t&&t.hidden,BFN.TransformItemBoundingBoxes.includesItem(t)&&BFN.TransformItemBoundingBoxes.updateItems(),BFN.MainUI.requestRender()}}),BFN.appContainer.querySelector(".overlays-container").appendChild(this.layersPanel))}handleLayers(){let e=UITools.getToolVO("layers");switch(e.updating_id){case"toggle_panel":this.toggleLayersPanel(e.toggle_panel);break}}toggleLayersPanel(e){if(!this.layersPanel){if(!e)return;this.setupLayersPanel(),this.handleItemsUpdatedImmediately()}let t=()=>{if(!BFN.MainUI.viewportUpdating||!e||e&&this.temporarilyHidePanel)if(e){let r=10,a=50,{panelSize:s}=this.layersPanel,o=BFN.appViewportRect;this.temporarilyHidePanel?(this.temporarilyHidePanel=!1,this.layersPanel.show()):this.layersPanel.show(o.x+r,o.y+o.height-s.height-a)}else this.hasOwnProperty(this.togglePanelTimeoutID)&&(clearTimeout(this.togglePanelTimeoutID),delete this.togglePanelTimeoutID),this.layersPanel.hide();else this.togglePanelTimeoutID=setTimeout(()=>{t(e)},10)};t()}updateLayersAvailable(){let e=BFN.AppModel.sectionValue(BFN.PhotoEditorCanvas.transformLayer,BFN.CollageMakerCanvas.transformLayer,BFN.DesignerCanvas.transformLayer),t=Boolean(BFN.PhotoEditorCanvasModel.viewState===BFN.PhotoEditorCanvasModelViewStates.VIEWING_CANVAS&&e&&e.itemsExist&&!BFN.TransformItemIsolator.active);BFN.AppModel.viewingEditor?!t&&UITools.getToolValue("layers","toggle_panel")?this.temporarilyHidePanel=!0:t&&this.temporarilyHidePanel&&(UITools.setToolValue("layers","toggle_panel",!0),UITools.applyTool("layers"),UITools.updateToolControls("layers")):t&&this.temporarilyHidePanel&&(UITools.setToolValue("layers","toggle_panel",!0),UITools.applyTool("layers"),UITools.updateToolControls("layers")),BFN.canvasFooter.layersEnabled=t,!t&&UITools.getToolValue("layers","toggle_panel")&&(UITools.setToolValue("layers","toggle_panel",!1),UITools.applyTool("layers"),UITools.updateToolControls("layers"))}updateGroups(){!this.layersPanel||this.layersPanel.setState({groups:BFN.GroupManager.getSectionGroupObjects(null,!0)})}switchToGroupsTab(){!this.layersPanel||this.layersPanel.switchTabs("groups")}handleItemsUpdatedImmediately(){if(!this.layersPanel)return;let{transformItems:e}=BFN.TransformLayerManager;this.layersPanel.setState({layers:e.slice().reverse().map(t=>({id:t.itemID,name:t.itemName,item:t}))}),this.updateGroups(),this.handleSelectionUpdated()}handleSelectionUpdated(){!this.layersPanel||this.layersPanel.state.selectedLayerIDs.isIdenticalTo(BFN.TransformLayerManager.selectedItemIDs)||this.layersPanel.setState({selectedLayerIDs:BFN.TransformLayerManager.selectedItemIDs.slice()})}handleGroupsUpdated(){this.updateGroups()}handleLanguageChanged(){BFN.AppModel.sectionValue(BFN.PhotoEditorCanvas.transformLayer,BFN.CollageMakerCanvas.transformLayer,BFN.DesignerCanvas.transformLayer).children.forEach(t=>{t instanceof BFN.TransformItem&&t.refreshItemName()})}};BFN.SingletonQueue.add(()=>{window.UILayers=new Vh});var O="attribute vec2 aVertexPosition;attribute vec2 aTextureCoord;uniform mat3 projectionMatrix;varying vec2 vTextureCoord;void main(void){gl_Position=vec4((projectionMatrix*vec3(aVertexPosition,1.)).xy,0.,1.);vTextureCoord=aTextureCoord;}";var Uh="varying vec2 vTextureCoord;uniform sampler2D uSampler;void main(void){vec4 A=texture2D(uSampler,vTextureCoord);gl_FragColor=A;}";var Gh=class extends PIXI.Filter{constructor(){super(O,Uh);this.padding=0}},Hh=Gh;var Xh="varying vec2 vTextureCoord;uniform sampler2D uSampler;uniform float hue;uniform float saturation;uniform float temperature;const float A=3.14159265;void main(void){vec4 B=texture2D(uSampler,vTextureCoord);if(B.a==0.){gl_FragColor=vec4(0,0,0,0);return;}B.rgb/=B.a;float C=(hue/180.)*A;float D=sin(C),E=cos(C);vec3 F=(vec3(2.*E,-sqrt(3.)*D-E,sqrt(3.)*D-E)+1.)/3.;B.rgb=vec3(dot(B.rgb,F.xyz),dot(B.rgb,F.zxy),dot(B.rgb,F.yzx));float G=(B.r+B.g+B.b)/3.;if(saturation>0.){B.rgb+=(G-B.rgb)*(1.-1./(1.001-saturation/2.));}else{B.rgb+=(G-B.rgb)*(-saturation);}B.r+=temperature;B.b-=temperature;B.rgb*=B.a;gl_FragColor=B;}";var zh=class extends PIXI.Shader{constructor(e){super(e,O,Xh)}get hue(){return this._hue}set hue(e){this._hue=e}get saturation(){return this._saturation}set saturation(e){this._saturation=e}get temperature(){return this._temperature}set temperature(e){this._temperature=e}applyParams(e){this.uniforms.hue=this.hue,this.uniforms.saturation=this.saturation,this.uniforms.temperature=this.temperature}},Wh=zh;var $h="varying vec2 vTextureCoord;uniform sampler2D uSampler[2];uniform float shadows;uniform float highlights;uniform float contrast;uniform float brightness;vec3 A(vec3 B,vec3 C){return mix(2.*B*C,1.-2.*(1.-B)*(1.-C),step(0.5,C));}float D(vec3 E){return dot(E,vec3(0.299,0.587,0.114));}float F(vec3 E){return dot(E,vec3(0.299,0.587,0.114));}vec3 G(vec3 E){float H=F(E);float I=min(min(E.r,E.g),E.b);float J=max(max(E.r,E.g),E.b);if(I<0.){max((E-H)*H/(H-I)+H,0.);}if(J>1.){min((E-H)*(1.-H)/(J-H)+H,1.);}return E;}float K(vec3 E){return dot(E,vec3(0.299,0.587,0.114));}vec3 L(vec3 E,float H){float M=H-K(E);E=E+vec3(M);return G(E);}float N(vec3 O){float P=min(min(O.r,O.g),O.b);float Q=max(max(O.r,O.g),O.b);return Q-P;}float R(float P,float S,float Q,float T){return((S-P)*T)/(Q-P);}vec3 U(vec3 O,float T){float P=min(min(O.b,O.g),O.r);float Q=max(max(O.b,O.g),O.r);vec3 V=vec3(0.);if(P<Q){if(O.b==Q&&O.r==P){V.r=0.;V.g=R(P,O.g,Q,T);V.b=T;}else if(O.g==Q&&O.r==P){V.r=0.;V.b=R(P,O.b,Q,T);V.g=T;}else if(O.b==Q&&O.g==P){V.g=0.;V.r=R(P,O.r,Q,T);V.b=T;}else if(O.r==Q&&O.g==P){V.g=0.;V.b=R(P,O.b,Q,T);V.r=T;}else if(O.r==Q&&O.b==P){V.b=0.;V.g=R(P,O.g,Q,T);V.r=T;}else{V.b=0.;V.r=R(P,O.r,Q,T);V.g=T;}}return V;}void main(void){vec4 W=texture2D(uSampler[0],vTextureCoord);vec4 X=texture2D(uSampler[1],vTextureCoord);W.rgb=W.rgb/W.a;X.rgb=X.rgb/X.a;float Y=(highlights>0.)?highlights:highlights*5.;float Z=(shadows<0.)?shadows*5.:shadows*0.90;float a=mix(Y,Z,1.-D(X.rgb));vec3 V=mix(W.rgb,vec3(1.),a);vec3 b=mix(vec3(1.),pow(W.rgb,vec3(1.25)),a);V=max(1.-((1.-V)/b),0.);float c=clamp(brightness+1.,0.1,2.);V=(c<1.)?pow(V,vec3(1./sqrt(c))):pow(V,vec3(1./pow(c,2.)));vec3 d=mix(vec3(0.5),V,contrast);V=A(d,V);V=L(U(W.rgb,N(V)),D(V));V=V*W.a;gl_FragColor=vec4(V,W.a);}";var jh=class extends PIXI.Shader{constructor(e){super(e,O,$h);this.channelTextures={0:"def",1:"blurImage"}}get brightness(){return this._brightness}set brightness(e){this._brightness=e}get contrast(){return this._contrast}set contrast(e){this._contrast=e}get highlights(){return this._highlights}set highlights(e){this._highlights=e}get shadows(){return this._shadows}set shadows(e){this._shadows=e}get blurImage(){return this._blurImage}set blurImage(e){this._blurImage=e}applyParams(e){this.uniforms.shadows=this.shadows,this.uniforms.highlights=this.highlights,this.uniforms.contrast=this.contrast,this.uniforms.brightness=this.brightness}},Yh=jh;var qh="vec3 A(vec3 B,vec3 C){return mix(2.*B*C,1.-2.*(1.-B)*(1.-C),step(0.5,C));}varying vec2 vTextureCoord;uniform sampler2D uSampler;uniform vec3 color;void main(void){vec4 D=texture2D(uSampler,vTextureCoord);float E=dot(D.rgb,vec3(0.3086,0.6094,0.082));D.rgb=A(color,vec3(E));gl_FragColor=D;}";var Kh=class extends PIXI.Filter{constructor(){super(O,qh);this.padding=0}apply(e,t,r,a){e.applyFilter(this,t,r,a)}get color(){return this.uniforms.color}set color(e){e=BFN.FilterHelper.hex2rgb(e),this.uniforms.color=e}},Jh=Kh;var Qh="uniform sampler2D uSampler;varying vec2 vTextureCoord;uniform float shadows;uniform float highlights;void main(void){vec4 A=texture2D(uSampler,vTextureCoord);if(A.a==0.){gl_FragColor=vec4(0,0,0,0);return;}A.rgb/=A.a;vec3 B=1.-A.rgb;float C=shadows/200.;float D=1.+highlights/200.;A.rgb=(A.rgb-B*C)*D*A.a;gl_FragColor=A;}";var Zh=class extends PIXI.Filter{constructor(){super(O,Qh);this.padding=0}get highlights(){return this.uniforms.highlights}set highlights(e){this.uniforms.highlights=e}get shadows(){return this.uniforms.shadows}set shadows(e){this.uniforms.shadows=e}},eu=Zh;var tu="varying vec2 vTextureCoord;varying vec2 vMapCoord;uniform sampler2D uSampler[2];uniform float intensity;vec3 A(vec3 B){vec3 C=B/vec3(95.047,100,108.883);vec3 D;D.x=(C.x>0.008856)?pow(C.x,1./3.):(7.787*C.x)+(16./116.);D.y=(C.y>0.008856)?pow(C.y,1./3.):(7.787*C.y)+(16./116.);D.z=(C.z>0.008856)?pow(C.z,1./3.):(7.787*C.z)+(16./116.);return vec3((116.*D.y)-16.,500.*(D.x-D.y),200.*(D.y-D.z));}vec3 E(vec3 B){vec3 F;F.x=(B.r>0.04045)?pow((B.r+0.055)/1.055,2.4):B.r/12.92;F.y=(B.g>0.04045)?pow((B.g+0.055)/1.055,2.4):B.g/12.92,F.z=(B.b>0.04045)?pow((B.b+0.055)/1.055,2.4):B.b/12.92;return 100.*F*mat3(0.4124,0.3576,0.1805,0.2126,0.7152,0.0722,0.0193,0.1192,0.9505);}vec3 G(vec3 B){vec3 H=A(E(B));return vec3(H.x/100.,0.5+0.5*(H.y/127.),0.5+0.5*(H.z/127.));}vec3 I(vec3 B){float J=(B.x+16.)/116.;float K=B.y/500.+J;float L=J-B.z/200.;return vec3(95.047*((K>0.206897)?K*K*K:(K-16./116.)/7.787),100.000*((J>0.206897)?J*J*J:(J-16./116.)/7.787),108.883*((L>0.206897)?L*L*L:(L-16./116.)/7.787));}vec3 M(vec3 B){vec3 D=B/100.*mat3(3.2406,-1.5372,-0.4986,-0.9689,1.8758,0.0415,0.0557,-0.2040,1.0570);vec3 N;N.x=(D.r>0.0031308)?((1.055*pow(D.r,(1./2.4)))-0.055):12.92*D.r;N.y=(D.g>0.0031308)?((1.055*pow(D.g,(1./2.4)))-0.055):12.92*D.g;N.z=(D.b>0.0031308)?((1.055*pow(D.b,(1./2.4)))-0.055):12.92*D.b;return N;}vec3 O(vec3 B){return M(I(vec3(100.*B.x,2.*127.*(B.y-0.5),2.*127.*(B.z-0.5))));}float P(float Q,float R){return mix(2.*Q*R,1.-2.*(1.-Q)*(1.-R),step(0.5,R));}void main(void){vec4 S=texture2D(uSampler[0],vTextureCoord);vec4 T=texture2D(uSampler[1],vTextureCoord);S.rgb=S.rgb/S.a;T.rgb=T.rgb/T.a;vec3 U=G(S.rgb);vec3 V=G(T.rgb);float W=P(1.-V.r,U.r);vec3 X=O(vec3(W,U.g,U.b));X=X*S.a;S.rgb=S.rgb*S.a;gl_FragColor=vec4(mix(S,vec4(X,S.a),intensity));}";var iu="attribute vec2 aVertexPosition;attribute vec2 aTextureCoord;uniform mat3 projectionMatrix;varying vec2 vTextureCoord;void main(void){gl_Position=vec4((projectionMatrix*vec3(aVertexPosition,1.)).xy,0.,1.);vTextureCoord=aTextureCoord;}";var ru=class extends PIXI.Shader{constructor(e){super(e,iu,tu);this.channelTextures={0:"def",1:"blurImage"}}get intensity(){return this._intensity}set intensity(e){this._intensity=e}get blurImage(){return this._blurImage}set blurImage(e){this._blurImage=e}applyParams(e){this.uniforms.intensity=this.intensity}},au=ru;var su="varying vec2 vTextureCoord;uniform sampler2D uSampler;uniform float strength;uniform vec4 filterClamp;uniform vec4 filterArea;uniform float clipPadding;void main(void){vec4 A=vec4(filterClamp.x,filterClamp.y,filterClamp.z,filterClamp.w);A.xy+=clipPadding/filterArea.xy;A.zw-=clipPadding/filterArea.xy;vec4 B=vec4(0.);vec2 C=vec2(1.)*vec2(strength,0.);vec2 D=vec2(2.)*vec2(strength,0.);vec2 E=vec2(3.)*vec2(strength,0.);vec2 F=vTextureCoord;B+=texture2D(uSampler,F)*0.22;B+=texture2D(uSampler,clamp(F+C,A.xy,A.zw))*0.18;B+=texture2D(uSampler,clamp(F-C,A.xy,A.zw))*0.18;B+=texture2D(uSampler,clamp(F+D,A.xy,A.zw))*0.13;B+=texture2D(uSampler,clamp(F-D,A.xy,A.zw))*0.13;B+=texture2D(uSampler,clamp(F+E,A.xy,A.zw))*0.08;B+=texture2D(uSampler,clamp(F-E,A.xy,A.zw))*0.08;gl_FragColor=B;}";var xs="attribute vec2 aVertexPosition;attribute vec2 aTextureCoord;uniform mat3 projectionMatrix;varying vec2 vTextureCoord;void main(void){gl_Position=vec4((projectionMatrix*vec3(aVertexPosition,1.)).xy,0.,1.);vTextureCoord=aTextureCoord;}";var ou=class extends PIXI.Filter{constructor(e,t){super(xs,su);let r;BFN.Stage.filterManager.shaderCache[this.glShaderKey]||(r=new PIXI.Shader(BFN.Stage.gl,this.vertexSrc,this.fragmentSrc),this.glShaders[BFN.Stage.CONTEXT_UID]=BFN.Stage.filterManager.shaderCache[this.glShaderKey]=r),this.resolution=t||1,this.strength=e||.5,this.padding=0,this.adjustedStrength=null,this.clipPadding=1}apply(e,t,r,a){let s=e.getRenderTarget(!0),o=t,n=s;this.uniforms.clipPadding=this.clipPadding;for(var l=0;l<2;l++){l==0?(this.adjustedStrength=this.strength*10/this.resolution*.75,this.uniforms.strength=this.adjustedStrength/t.size.width):(this.adjustedStrength=this.strength*5/this.resolution*.75,this.uniforms.strength=this.adjustedStrength/t.size.width),e.applyFilter(this,o,n,!0);let c=n;n=o,o=c}this.adjustedStrength=this.strength*2.5/this.resolution*.65,this.uniforms.strength=this.adjustedStrength/t.size.width,e.applyFilter(this,t,r,a),e.returnRenderTarget(s)}get blur(){return this.strength}set blur(e){this.strength=e}},nu=ou;var lu="varying vec2 vTextureCoord;uniform sampler2D uSampler;uniform float strength;uniform vec4 filterClamp;uniform vec4 filterArea;uniform float clipPadding;void main(void){vec4 A=vec4(filterClamp.x,filterClamp.y,filterClamp.z,filterClamp.w);A.xy+=clipPadding/filterArea.xy;A.zw-=clipPadding/filterArea.xy;vec4 B=vec4(0.);vec2 C=vec2(1.)*vec2(0.,strength);vec2 D=vec2(2.)*vec2(0.,strength);vec2 E=vec2(3.)*vec2(0.,strength);vec2 F=vTextureCoord;B+=texture2D(uSampler,F)*0.22;B+=texture2D(uSampler,clamp(F+C,A.xy,A.zw))*0.18;B+=texture2D(uSampler,clamp(F-C,A.xy,A.zw))*0.18;B+=texture2D(uSampler,clamp(F+D,A.xy,A.zw))*0.13;B+=texture2D(uSampler,clamp(F-D,A.xy,A.zw))*0.13;B+=texture2D(uSampler,clamp(F+E,A.xy,A.zw))*0.08;B+=texture2D(uSampler,clamp(F-E,A.xy,A.zw))*0.08;gl_FragColor=B;}";var cu=class extends PIXI.Filter{constructor(e,t){super(xs,lu);let r;BFN.Stage.filterManager.shaderCache[this.glShaderKey]||(r=new PIXI.Shader(BFN.Stage.gl,this.vertexSrc,this.fragmentSrc),this.glShaders[BFN.Stage.CONTEXT_UID]=BFN.Stage.filterManager.shaderCache[this.glShaderKey]=r),this.resolution=t||1,this.strength=e||.5,this.padding=0,this.adjustedStrength=null,this.clipPadding=1}apply(e,t,r,a){let s=e.getRenderTarget(!0),o=t,n=s;this.uniforms.clipPadding=this.clipPadding;for(var l=0;l<2;l++){l==0?(this.adjustedStrength=this.strength*10/this.resolution*.75,this.uniforms.strength=this.adjustedStrength/t.size.height):(this.adjustedStrength=this.strength*5/this.resolution*.75,this.uniforms.strength=this.adjustedStrength/t.size.height),e.applyFilter(this,o,n,!0);let c=n;n=o,o=c}this.adjustedStrength=this.strength*2.5/this.resolution*.65,this.uniforms.strength=this.adjustedStrength/t.size.height,e.applyFilter(this,o,r,a),e.returnRenderTarget(s)}get blur(){return this.strength}set blur(e){this.strength=e}},hu=cu;var uu=class extends PIXI.Filter{constructor(e,t,r,a,s){super();this.blurXFilter=new nu(e,r),this.blurYFilter=new hu(e,r),this.kSize=a,this.res1=r||null,this.resolution=r||(a=="large"?BFN.renderTextureResolutionLarge:BFN.renderTextureResolution),this.quality=t||1,this.oneDirection=s,s||(this.blur=e||5),this.setParameters()}setInputDimensions(e,t){if(!(e>0&&t>0)||this.inputW===e&&this.inputH===t)return;this.inputW=e,this.inputH=t;let r=BFN.Util.calculateRes(this.inputW,this.inputH);this.resSmall=r.small,this.resLarge=r.large}setParameters(){this.resolution=this.res1||(this.kSize=="large"?this.resLarge||BFN.renderTextureResolutionLarge:this.resSmall||BFN.renderTextureResolution),this.padding=Math.max(.5/this.resolution,1),this.blurXFilter.clipPadding=this.padding*2,this.blurYFilter.clipPadding=this.padding*2,this.oneDirection?this.oneDirection=="x"?this.blurXFilter.resolution=this.resolution:this.blurYFilter.resolution=this.resolution:(this.blurXFilter.resolution=this.resolution,this.blurYFilter.resolution=this.resolution)}apply(e,t,r){if(this.setParameters(),this.oneDirection)this.oneDirection=="x"?this.blurXFilter.apply(e,t,r):this.blurYFilter.apply(e,t,r);else{var a=e.getRenderTarget(!0);this.blurXFilter.apply(e,t,a,!0),this.blurYFilter.apply(e,a,r,!1),e.returnRenderTarget(a)}}get blur(){return this.blurXFilter.blur}set blur(e){this.blurXFilter.blur=this.blurYFilter.blur=e}get blurX(){return this.blurXFilter.blur}set blurX(e){this.blurXFilter.blur=e}get blurY(){return this.blurYFilter.blur}set blurY(e){this.blurYFilter.blur=e}},du=uu;var mu="attribute vec2 aVertexPosition;attribute vec2 aTextureCoord;uniform mat3 projectionMatrix;varying vec2 vTextureCoord;void main(void){gl_Position=vec4((projectionMatrix*vec3(aVertexPosition,1.)).xy,0.,1.);vTextureCoord=aTextureCoord;}";var pu="varying vec2 vTextureCoord;uniform sampler2D uSampler;uniform float amount;void main(void){lowp vec4 A=texture2D(uSampler,vTextureCoord);lowp float B=(A.r+A.g+A.b)/3.;A.rgb=mix(A.rgb,vec3(B),amount);gl_FragColor=A;}";var fu=class extends PIXI.Filter{constructor(){super(mu,pu);this.amount=1,this.padding=0}apply(e,t,r,a){e.applyFilter(this,t,r,a)}get amount(){return this.uniforms.amount}set amount(e){this.uniforms.amount=e}},gu=fu;var Ts="vec4 A(vec4 B,vec4 C){if(B.a==0.){return C;}else if(C.a==0.){return B;}else{float D=clamp((B.a+((1.-B.a)*C.a)),0.,1.);if(D==0.){return vec4(0.);}else{float E=clamp((C.a/(D+0.000001)),0.,1.);vec3 F=(B.a>0.)?(B.rgb/(B.a+0.000001)):vec3(0.);vec3 G=(C.a>0.)?(C.rgb/(C.a+0.000001)):vec3(0.);vec3 H=clamp(((F*(1.-E))+(G*E)),0.,1.);vec4 I=clamp(vec4((H*D),D),0.,1.);return I;}}}uniform sampler2D uSampler;varying vec2 vTextureCoord;uniform float amount;uniform vec3 fillColor;void main(void){vec4 J=texture2D(uSampler,vTextureCoord);vec4 K=((J.a==0.)?vec4(0.):vec4(vec3((1.-(J.rgb/J.a))*J.a),J.a));vec4 L=mix(J,K,amount);gl_FragColor=(fillColor.r>=0.)?A(vec4(fillColor,1.),L):L;}";var vu=class extends PIXI.Filter{constructor(){super(O,Ts);this.amount=1,this.fillColor=-1}get amount(){return this.uniforms.amount}set amount(e){this.uniforms.amount=e}get fillColor(){return this.uniforms.fillColor}set fillColor(e){this.uniforms.fillColor=e===-1?[-1,-1,-1]:BFN.FilterHelper.hex2rgb(e)}},yu=vu;var xu=class extends PIXI.Shader{constructor(e){super(e,O,Ts);this.amount=1,this.fillColor=-1}get amount(){return this._amount}set amount(e){this._amount=Math.max(0,Math.min(1,e))}get fillColor(){return this._fillColor}set fillColor(e){this._fillColor=e,this._fillColorVec3=e===-1?[-1,-1,-1]:BFN.FilterHelper.hex2rgb(this._fillColor)}applyParams(e){this.uniforms.amount=this._amount,this.uniforms.fillColor=this._fillColorVec3}},Tu=xu;var Fs="vec4 A(vec4 B,vec4 C){if(B.a==0.){return C;}else if(C.a==0.){return B;}else{float D=clamp((B.a+((1.-B.a)*C.a)),0.,1.);if(D==0.){return vec4(0.);}else{float E=clamp((C.a/(D+0.000001)),0.,1.);vec3 F=(B.a>0.)?(B.rgb/(B.a+0.000001)):vec3(0.);vec3 G=(C.a>0.)?(C.rgb/(C.a+0.000001)):vec3(0.);vec3 H=clamp(((F*(1.-E))+(G*E)),0.,1.);vec4 I=clamp(vec4((H*D),D),0.,1.);return I;}}}uniform sampler2D uSampler;varying vec2 vTextureCoord;uniform vec3 colorRGB;uniform float colorA;void main(){vec4 J=texture2D(uSampler,vTextureCoord);vec4 K=(colorRGB.r==-1.)?vec4(0.):vec4((colorRGB*colorA),colorA);gl_FragColor=A(K,J);}";var Fu=class extends PIXI.Filter{constructor(){super(O,Fs);this.padding=0,this.color=-1,this.alpha=1}get color(){return this.uniforms.colorRGB}set color(e){this.uniforms.colorRGB=e===-1?[-1,-1,-1]:BFN.FilterHelper.hex2rgb(e)}get alpha(){return this.uniforms.colorA}set alpha(e){this.uniforms.colorA=Math.max(0,Math.min(1,e))}},bu=Fu;var Bu=class extends PIXI.Shader{constructor(e){super(e,O,Fs);this.color=-1,this.alpha=1}get color(){return this._color}set color(e){this._color=e,this._colorRGB=e===-1?[-1,-1,-1]:BFN.FilterHelper.hex2rgb(this._color)}get alpha(){return this._alpha}set alpha(e){this._alpha=e,this._colorA=Math.max(0,Math.min(1,this._alpha))}applyParams(e){this.uniforms.colorRGB=this._colorRGB,this.uniforms.colorA=this._colorA}},Su=Bu;var bs="uniform sampler2D uSampler;varying vec2 vTextureCoord;uniform float invert;void main(){vec4 A=texture2D(uSampler,vTextureCoord);gl_FragColor=vec4(vec3(abs(invert-A.a)),1.);}";var Iu=class extends PIXI.Filter{constructor(){super(O,bs);this.padding=0,this.invert=!1}get invert(){return!!this.uniforms.invert}set invert(e){this.uniforms.invert=Number(!!e)}},_u=Iu;var Cu=class extends PIXI.Shader{constructor(e){super(e,O,bs);this.invert=!1}get invert(){return!!this._invert}set invert(e){this._invert=Number(!!e)}applyParams(e){this.uniforms.invert=this._invert}},Eu=Cu;var Bs="vec4 A(vec4 B,vec4 C){if(B.a==0.){return C;}else if(C.a==0.){return B;}else{float D=clamp((B.a+((1.-B.a)*C.a)),0.,1.);if(D==0.){return vec4(0.);}else{float E=clamp((C.a/(D+0.000001)),0.,1.);vec3 F=(B.a>0.)?(B.rgb/(B.a+0.000001)):vec3(0.);vec3 G=(C.a>0.)?(C.rgb/(C.a+0.000001)):vec3(0.);vec3 H=clamp(((F*(1.-E))+(G*E)),0.,1.);vec4 I=clamp(vec4((H*D),D),0.,1.);return I;}}}float J(vec3 K){return dot(K,vec3(0.299,0.587,0.114));}uniform sampler2D uSampler;varying vec2 vTextureCoord;uniform float invert;const vec4 L=vec4(vec3(0.),1.);const vec4 M=vec4(1.);void main(){vec4 N=texture2D(uSampler,vTextureCoord);if(N.a<1.){N=A(L,N);}float O=J(N.rgb);gl_FragColor=(M*abs(invert-O));}";var Pu=class extends PIXI.Filter{constructor(){super(O,Bs);this.padding=0,this.invert=!1}get invert(){return!!this.uniforms.invert}set invert(e){this.uniforms.invert=Number(!!e)}},Nu=Pu;var Mu=class extends PIXI.Shader{constructor(e){super(e,O,Bs);this.invert=!1}get invert(){return!!this._invert}set invert(e){this._invert=Number(!!e)}applyParams(e){this.uniforms.invert=this._invert}},Du=Mu;var wu="varying vec2 vTextureCoord;uniform sampler2D uSampler;uniform float minInputValue;uniform float gamma;uniform float maxInputValue;uniform float minOutputValue;uniform float maxOutputValue;vec3 A(vec3 B,float gamma){return pow(B,1./vec3(gamma));}vec3 C(vec3 B,float D,float E){return min(max(B-D,0.)/(E-D+0.0001),1.);}vec3 F(vec3 B,float D,float gamma,float E){return A(C(B,D,E),gamma);}vec3 G(vec3 B,float H,float I){return mix(vec3(H),vec3(I),B);}vec3 J(vec3 B,float D,float gamma,float E,float H,float I){return G(F(B,D,gamma,E),H,I);}void main(void){vec4 B=texture2D(uSampler,vTextureCoord);if(B.a==0.){gl_FragColor=vec4(0,0,0,0);return;}B.rgb/=B.a;B.rgb=J(B.rgb,minInputValue,gamma,maxInputValue,minOutputValue,maxOutputValue)*B.a;gl_FragColor=B;}";var ku=class extends PIXI.Filter{constructor(){super(O,wu);let e;BFN.Stage.filterManager.shaderCache[this.glShaderKey]||(e=new PIXI.Shader(BFN.Stage.gl,this.vertexSrc,this.fragmentSrc),this.glShaders[BFN.Stage.CONTEXT_UID]=BFN.Stage.filterManager.shaderCache[this.glShaderKey]=e),this.minInputValue=0,this.gamma=1,this.maxInputValue=1,this.minOutputValue=0,this.maxOutputValue=1}apply(e,t,r,a){let s=BFN.FilterHelper.calculateFilterClamp(t,r);this.uniforms.clampX=s.x,this.uniforms.clampY=s.y,e.applyFilter(this,t,r,a)}get minInputValue(){return this.uniforms.minInputValue}set minInputValue(e){this.uniforms.minInputValue=e}get gamma(){return this.uniforms.gamma}set gamma(e){this.uniforms.gamma=e}get maxInputValue(){return this.uniforms.maxInputValue}set maxInputValue(e){this.uniforms.maxInputValue=e}get minOutputValue(){return this.uniforms.minOutputValue}set minOutputValue(e){this.uniforms.minOutputValue=e}get maxOutputValue(){return this.uniforms.maxOutputValue}set maxOutputValue(e){this.uniforms.maxOutputValue=e}},Au=ku;var Ou=`precision highp float;
#define GLSLIFY 1
varying vec2 vTextureCoord;varying vec2 vMapCoord;varying vec4 vColor;uniform sampler2D uSampler;uniform sampler2D iChannel1;uniform float intensity;void main(void){vec4 A=texture2D(uSampler,vTextureCoord);if(A.a==0.){gl_FragColor=vec4(0,0,0,0);return;}A.rgb/=A.a;A=clamp(A,0.,1.);mediump float B=A.b*63.;mediump vec2 C;C.y=floor(floor(B)/8.);C.x=floor(B)-(C.y*8.);mediump vec2 D;D.y=floor(ceil(B)/8.);D.x=ceil(B)-(D.y*8.);highp vec2 E;E.x=(C.x*0.125)+0.5/512.+((0.125-1./512.)*A.r);E.y=(C.y*0.125)+0.5/512.+((0.125-1./512.)*A.g);highp vec2 F;F.x=(D.x*0.125)+0.5/512.+((0.125-1./512.)*A.r);F.y=(D.y*0.125)+0.5/512.+((0.125-1./512.)*A.g);lowp vec4 G=texture2D(iChannel1,E);lowp vec4 H=texture2D(iChannel1,F);lowp vec4 I=mix(G,H,fract(B));if(A.a>0.){gl_FragColor=mix(A,vec4(I.rgb,A.w),intensity);gl_FragColor.rgb*=gl_FragColor.a;}else{gl_FragColor=vec4(0.);}}`;var Ru="attribute vec2 aVertexPosition;attribute vec2 aTextureCoord;uniform mat3 projectionMatrix;varying vec2 vTextureCoord;void main(void){gl_Position=vec4((projectionMatrix*vec3(aVertexPosition,1.)).xy,0.,1.);vTextureCoord=aTextureCoord;}";var Lu=class extends PIXI.Filter{constructor(){super(Ru,Ou);this.intensity=1}get intensity(){return this.uniforms.intensity}set intensity(e){this.uniforms.intensity=e}get iChannel1(){return this.uniforms.iChannel1}set iChannel1(e){e.baseTexture.isPowerOfTwo=!1,this.uniforms.iChannel1=e}},Vu=Lu;var Uu="varying vec2 vTextureCoord;uniform sampler2D uSampler;uniform float strength;uniform float clampCoord;uniform float threshold;const float A=20.;float B(float C,float D){D*=-2.;return exp(C*C/D);}void main(void){vec2 E=vTextureCoord;vec4 F=texture2D(uSampler,vTextureCoord);if(F.a==0.){gl_FragColor=vec4(0,0,0,0);return;}F.rgb/=F.a;vec3 G;vec3 H=vec3(0.);float I=0.;for(float J=-A;J<=A;J++){G=texture2D(uSampler,clamp(vTextureCoord+vec2(J*strength,0.),vec2(0.,0.),vec2(clampCoord,1.))).rgb;float K=step(distance(G,F.rgb),threshold);float L=K*B(J,A);I+=L;H+=L*G;}gl_FragColor=vec4(H/I*F.a,F.a);}";var Ss="attribute vec2 aVertexPosition;attribute vec2 aTextureCoord;uniform mat3 projectionMatrix;varying vec2 vTextureCoord;void main(void){gl_Position=vec4((projectionMatrix*vec3(aVertexPosition,1.)).xy,0.,1.);vTextureCoord=aTextureCoord;}";var Gu=class extends PIXI.Filter{constructor(e,t,r){super(Ss,Uu);this.threshold=t||.2,this.resolution=r||1,this.strength=e||1}apply(e,t,r,a){let s=null,o=t.size.width-r.destinationFrame.width;o==0?s=1:s=1-(o+2+1/this.resolution)/t.size.width,this.uniforms.strength=1/r.size.width*(r.size.width/t.size.width),this.uniforms.strength*=this.strength,this.uniforms.clampCoord=s,e.applyFilter(this,t,r,a)}get blur(){return this.strength}set blur(e){this.strength=e}get threshold(){return this.uniforms.threshold}set threshold(e){this.uniforms.threshold=e}},Hu=Gu;var Xu="varying vec2 vTextureCoord;uniform sampler2D uSampler;uniform float strength;uniform float clampCoord;uniform float threshold;const float A=20.;float B(float C,float D){D*=-2.;return exp(C*C/D);}void main(void){float E=0.;vec2 F=vTextureCoord;vec4 G=texture2D(uSampler,vTextureCoord);if(G.a==0.){gl_FragColor=vec4(0,0,0,0);return;}G.rgb/=G.a;vec3 H;vec3 I=vec3(0.);float J=0.;for(float K=-A;K<=A;K++){H=texture2D(uSampler,clamp(vTextureCoord+vec2(0.,K*strength),vec2(0.,0.),vec2(1.,clampCoord))).rgb;float L=step(distance(H,G.rgb),threshold);float M=L*B(K,A);J+=M;I+=M*H;}gl_FragColor=vec4(I/J*G.a,G.a);}";var zu=class extends PIXI.Filter{constructor(e,t,r){super(Ss,Xu);this.threshold=t||.2,this.resolution=r||1,this.strength=e||1}apply(e,t,r,a){let s=null,o=t.size.height-r.destinationFrame.height;o==0?s=1:s=1-(o+2+1/this.resolution)/t.size.height,this.uniforms.strength=1/r.size.height*(r.size.height/t.size.height),this.uniforms.strength*=this.strength,this.uniforms.clampCoord=s,e.applyFilter(this,t,r,a)}get blur(){return this.strength}set blur(e){this.strength=e}get threshold(){return this.uniforms.threshold}set threshold(e){this.uniforms.threshold=e}},Wu=zu;var $u="varying vec2 vTextureCoord;uniform sampler2D uSampler;vec3 A(vec3 B){vec3 C=B/vec3(95.047,100,108.883);vec3 D;D.x=(C.x>0.008856)?pow(C.x,1./3.):(7.787*C.x)+(16./116.);D.y=(C.y>0.008856)?pow(C.y,1./3.):(7.787*C.y)+(16./116.);D.z=(C.z>0.008856)?pow(C.z,1./3.):(7.787*C.z)+(16./116.);return vec3((116.*D.y)-16.,500.*(D.x-D.y),200.*(D.y-D.z));}vec3 E(vec3 B){vec3 F;F.x=(B.r>0.04045)?pow((B.r+0.055)/1.055,2.4):B.r/12.92;F.y=(B.g>0.04045)?pow((B.g+0.055)/1.055,2.4):B.g/12.92,F.z=(B.b>0.04045)?pow((B.b+0.055)/1.055,2.4):B.b/12.92;return 100.*F*mat3(0.4124,0.3576,0.1805,0.2126,0.7152,0.0722,0.0193,0.1192,0.9505);}vec3 G(vec3 B){vec3 H=A(E(B));return vec3(H.x/100.,0.5+0.5*(H.y/127.),0.5+0.5*(H.z/127.));}void main(void){vec4 I=texture2D(uSampler,vTextureCoord);I.rgb=G(I.rgb);gl_FragColor=vec4(I.rgb,I.a);}";var ju="attribute vec2 aVertexPosition;attribute vec2 aTextureCoord;uniform mat3 projectionMatrix;varying vec2 vTextureCoord;void main(void){gl_Position=vec4((projectionMatrix*vec3(aVertexPosition,1.)).xy,0.,1.);vTextureCoord=aTextureCoord;}";var Yu=class extends PIXI.Filter{constructor(){super(ju,$u)}apply(e,t,r,a){e.applyFilter(this,t,r,a)}},qu=Yu;var Ku=class extends PIXI.Filter{constructor(e,t,r){super();this.blurXFilter=new Hu,this.blurYFilter=new Wu,this.padding=0,this.resolution=r||1,this.blur=e||1,this.threshold=t||.1}apply(e,t,r){var a=e.getRenderTarget(!0);this.blurXFilter.resolution=this.resolution,this.blurYFilter.resolution=this.resolution,this.blurXFilter.apply(e,t,a,!1),this.blurYFilter.apply(e,a,r,!1),e.returnRenderTarget(a)}get blur(){return this.blurXFilter.blur}set blur(e){this.blurXFilter.blur=this.blurYFilter.blur=e}get blurX(){return this.blurXFilter.blur}set blurX(e){this.blurXFilter.blur=e}get blurY(){return this.blurYFilter.blur}set blurY(e){this.blurYFilter.blur=e}get threshold(){return this.blurYFilter.blur}set threshold(e){this.blurXFilter.threshold=this.blurYFilter.threshold=e}},Ju=Ku;var Qu="varying vec2 vTextureCoord;varying vec2 vMapCoord;varying vec4 vColor;uniform sampler2D uSampler;uniform sampler2D blurImage;uniform float intensity;uniform float intensityMultiplier;uniform float clampX;uniform float clampY;vec3 A(vec3 B){vec3 C=B/vec3(95.047,100,108.883);vec3 D;D.x=(C.x>0.008856)?pow(C.x,1./3.):(7.787*C.x)+(16./116.);D.y=(C.y>0.008856)?pow(C.y,1./3.):(7.787*C.y)+(16./116.);D.z=(C.z>0.008856)?pow(C.z,1./3.):(7.787*C.z)+(16./116.);return vec3((116.*D.y)-16.,500.*(D.x-D.y),200.*(D.y-D.z));}vec3 E(vec3 B){vec3 F;F.x=(B.r>0.04045)?pow((B.r+0.055)/1.055,2.4):B.r/12.92;F.y=(B.g>0.04045)?pow((B.g+0.055)/1.055,2.4):B.g/12.92,F.z=(B.b>0.04045)?pow((B.b+0.055)/1.055,2.4):B.b/12.92;return 100.*F*mat3(0.4124,0.3576,0.1805,0.2126,0.7152,0.0722,0.0193,0.1192,0.9505);}vec3 G(vec3 B){vec3 H=A(E(B));return vec3(H.x/100.,0.5+0.5*(H.y/127.),0.5+0.5*(H.z/127.));}vec3 I(vec3 B){float J=(B.x+16.)/116.;float K=B.y/500.+J;float L=J-B.z/200.;return vec3(95.047*((K>0.206897)?K*K*K:(K-16./116.)/7.787),100.000*((J>0.206897)?J*J*J:(J-16./116.)/7.787),108.883*((L>0.206897)?L*L*L:(L-16./116.)/7.787));}vec3 M(vec3 B){vec3 D=B/100.*mat3(3.2406,-1.5372,-0.4986,-0.9689,1.8758,0.0415,0.0557,-0.2040,1.0570);vec3 N;N.x=(D.r>0.0031308)?((1.055*pow(D.r,(1./2.4)))-0.055):12.92*D.r;N.y=(D.g>0.0031308)?((1.055*pow(D.g,(1./2.4)))-0.055):12.92*D.g;N.z=(D.b>0.0031308)?((1.055*pow(D.b,(1./2.4)))-0.055):12.92*D.b;return N;}vec3 O(vec3 B){return M(I(vec3(100.*B.x,2.*127.*(B.y-0.5),2.*127.*(B.z-0.5))));}void main(void){vec4 P=texture2D(uSampler,vTextureCoord);vec4 Q=texture2D(blurImage,vTextureCoord*vec2(clampX,clampY));P.rgb=P.rgb/P.a;Q.rgb=Q.rgb/Q.a;vec3 R=G(P.rgb);vec3 S=G(Q.rgb);float T=mix(S.r,R.r,1.+intensity*intensityMultiplier);vec3 U=O(vec3(T,R.g,R.b));U=U*P.a;P.rgb=P.rgb*P.a;gl_FragColor=vec4(U,P.a);}";var Zu="attribute vec2 aVertexPosition;attribute vec2 aTextureCoord;uniform mat3 projectionMatrix;varying vec2 vTextureCoord;void main(void){gl_Position=vec4((projectionMatrix*vec3(aVertexPosition,1.)).xy,0.,1.);vTextureCoord=aTextureCoord;}";var ed=class extends PIXI.Filter{constructor(){let e=Zu,t=Qu;super(e,t);this.padding=0,this.intensity=1,this.intensityMultiplier=1.5}apply(e,t,r,a){var s=BFN.FilterHelper.calculateFilterClamp(t,r,this.blurImage||null);this.uniforms.clampX=s.x,this.uniforms.clampY=s.y,e.applyFilter(this,t,r,a)}get intensity(){return this.uniforms.intensity}set intensity(e){this.uniforms.intensity=e}get intensityMultiplier(){return this.uniforms.intensityMultiplier}set intensityMultiplier(e){this.uniforms.intensityMultiplier=e}get blurImage(){return this.uniforms.blurImage}set blurImage(e){e.baseTexture.isPowerOfTwo=!0,this.uniforms.blurImage=e}},td=ed;var id="varying vec2 vTextureCoord;varying vec2 vMapCoord;varying vec4 vColor;uniform sampler2D uSampler;uniform sampler2D blurImage;uniform float intensity;uniform float clampX;uniform float clampY;void main(void){vec4 A=texture2D(uSampler,vTextureCoord);vec4 B=texture2D(blurImage,vTextureCoord*vec2(clampX,clampY));if(A.a==0.){gl_FragColor=vec4(0,0,0,0);return;}A.rgb/=A.a;if(B.a>0.){B.rgb/=B.a;}vec3 C=clamp(A.rgb-B.rgb,0.,1.);vec3 D=clamp(B.rgb-A.rgb,0.,1.);vec3 E=clamp(A.rgb-D+C,0.,1.);gl_FragColor=vec4(mix(A.rgb,E,intensity*2.)*A.a,A.a);}";var rd="attribute vec2 aVertexPosition;attribute vec2 aTextureCoord;uniform mat3 projectionMatrix;varying vec2 vTextureCoord;void main(void){gl_Position=vec4((projectionMatrix*vec3(aVertexPosition,1.)).xy,0.,1.);vTextureCoord=aTextureCoord;}";var ad=class extends PIXI.Filter{constructor(){super(rd,id);this.padding=0,this.intensity=1}apply(e,t,r,a){let s=BFN.FilterHelper.calculateFilterClamp(t,r,this.blurImage||null);this.uniforms.clampX=s.x,this.uniforms.clampY=s.y,e.applyFilter(this,t,r,a)}get intensity(){return this.uniforms.intensity}set intensity(e){this.uniforms.intensity=e}get blurImage(){return this.uniforms.blurImage}set blurImage(e){e.baseTexture.isPowerOfTwo=!0,this.uniforms.blurImage=e}},sd=ad;var od="varying vec2 vTextureCoord;uniform sampler2D uSampler;uniform float amount;vec3 A(vec3 B,float C){return pow(B,1./vec3(C));}vec3 D(vec3 B,float E,float F){return min(max(B-E,0.)/(F-E+0.0001),1.);}vec3 G(vec3 B,float E,float C,float F){return A(D(B,E,F),C);}vec3 H(vec3 B,float I,float J){return mix(vec3(I),vec3(J),B);}vec3 K(vec3 B,float E,float C,float F,float I,float J){return H(G(B,E,C,F),I,J);}vec3 L(vec3 M){vec4 N=vec4(0.,-1./3.,2./3.,-1.);vec4 O=mix(vec4(M.bg,N.wz),vec4(M.gb,N.xy),step(M.b,M.g));vec4 P=mix(vec4(O.xyw,M.r),vec4(M.r,O.yzx),step(O.x,M.r));float Q=P.x-min(P.w,P.y);float R=1.0e-10;return vec3(abs(P.z+(P.w-P.y)/(6.*Q+R)),Q/(P.x+R),P.x);}vec3 S(vec3 M){vec4 N=vec4(1.,2./3.,1./3.,3.);vec3 O=abs(fract(M.xxx+N.xyz)*6.-N.www);return M.z*mix(N.xxx,clamp(O-N.xxx,0.,1.),M.y);}float T(float U,float V){return mix(2.*U*V,1.-2.*(1.-U)*(1.-V),step(0.5,V));}void main(void){vec4 W=texture2D(uSampler,vTextureCoord);W.rgb=W.rgb/W.a;vec3 X=L(W.rgb);float Y=K(vec3(X.g),0.,pow(amount+1.,1.5),1.,0.,1.).r;float Z=T(X.g,mix(0.5,Y,1.-X.g));vec3 a=S(vec3(X.r,Z,X.b));a=a*W.a;gl_FragColor=vec4(vec3(a),W.a);}";var nd="attribute vec2 aVertexPosition;attribute vec2 aTextureCoord;uniform mat3 projectionMatrix;varying vec2 vTextureCoord;void main(void){gl_Position=vec4((projectionMatrix*vec3(aVertexPosition,1.)).xy,0.,1.);vTextureCoord=aTextureCoord;}";var ld=class extends PIXI.Shader{constructor(e){super(e,nd,od)}get amount(){return this._amount}set amount(e){this._amount=e}applyParams(e){this.uniforms.amount=this.amount}},cd=ld;var hd="varying vec2 vTextureCoord;varying vec2 vMapCoord;varying vec4 vColor;uniform sampler2D uSampler;uniform sampler2D blurImage;uniform float intensity;uniform float clampX;uniform float clampY;float A(float B,float C){return mix(2.*B*C,1.-2.*(1.-B)*(1.-C),step(0.5,C));}float D(vec3 E){return dot(E,vec3(0.299,0.587,0.114));}vec3 F(vec3 E){vec3 G=E/vec3(95.047,100,108.883);vec3 H;H.x=(G.x>0.008856)?pow(G.x,1./3.):(7.787*G.x)+(16./116.);H.y=(G.y>0.008856)?pow(G.y,1./3.):(7.787*G.y)+(16./116.);H.z=(G.z>0.008856)?pow(G.z,1./3.):(7.787*G.z)+(16./116.);return vec3((116.*H.y)-16.,500.*(H.x-H.y),200.*(H.y-H.z));}vec3 I(vec3 E){vec3 J;J.x=(E.r>0.04045)?pow((E.r+0.055)/1.055,2.4):E.r/12.92;J.y=(E.g>0.04045)?pow((E.g+0.055)/1.055,2.4):E.g/12.92,J.z=(E.b>0.04045)?pow((E.b+0.055)/1.055,2.4):E.b/12.92;return 100.*J*mat3(0.4124,0.3576,0.1805,0.2126,0.7152,0.0722,0.0193,0.1192,0.9505);}vec3 K(vec3 E){vec3 L=F(I(E));return vec3(L.x/100.,0.5+0.5*(L.y/127.),0.5+0.5*(L.z/127.));}vec3 M(vec3 E){float N=(E.x+16.)/116.;float O=E.y/500.+N;float P=N-E.z/200.;return vec3(95.047*((O>0.206897)?O*O*O:(O-16./116.)/7.787),100.000*((N>0.206897)?N*N*N:(N-16./116.)/7.787),108.883*((P>0.206897)?P*P*P:(P-16./116.)/7.787));}vec3 Q(vec3 E){vec3 H=E/100.*mat3(3.2406,-1.5372,-0.4986,-0.9689,1.8758,0.0415,0.0557,-0.2040,1.0570);vec3 R;R.x=(H.r>0.0031308)?((1.055*pow(H.r,(1./2.4)))-0.055):12.92*H.r;R.y=(H.g>0.0031308)?((1.055*pow(H.g,(1./2.4)))-0.055):12.92*H.g;R.z=(H.b>0.0031308)?((1.055*pow(H.b,(1./2.4)))-0.055):12.92*H.b;return R;}vec3 S(vec3 E){return Q(M(vec3(100.*E.x,2.*127.*(E.y-0.5),2.*127.*(E.z-0.5))));}float T(float B,float C){return mix(max(0.,1.-min(1.,(1.-C)/(2.*B))),min(1.,C/(2.*(1.-B))),step(0.5,B));}float U(float V,float W){return pow(V,W);}void main(void){vec4 X=texture2D(uSampler,vTextureCoord);vec4 Y=texture2D(blurImage,vTextureCoord*vec2(clampX,clampY));X.rgb=X.rgb/X.a;Y.rgb=Y.rgb/Y.a;vec3 Z=K(X.rgb);vec3 a=K(Y.rgb);float b=1.-U(Z.r,1.85);float c=T(1.-a.r,Z.r);float d=mix(0.5,c,b);float e=A(d,Z.r);vec3 f=S(vec3(e,Z.g,Z.b));f=f*X.a;X.rgb=X.rgb*X.a;gl_FragColor=mix(X,vec4(vec3(f),X.a),intensity*1.2);}";var ud="attribute vec2 aVertexPosition;attribute vec2 aTextureCoord;uniform mat3 projectionMatrix;varying vec2 vTextureCoord;void main(void){gl_Position=vec4((projectionMatrix*vec3(aVertexPosition,1.)).xy,0.,1.);vTextureCoord=aTextureCoord;}";var dd=class extends PIXI.Filter{constructor(){super(ud,hd);this.padding=0,this.intensity=1}apply(e,t,r,a){let s=BFN.FilterHelper.calculateFilterClamp(t,r,this.blurImage||null);this.uniforms.clampX=s.x,this.uniforms.clampY=s.y,e.applyFilter(this,t,r,a)}get intensity(){return this.uniforms.intensity}set intensity(e){this.uniforms.intensity=e}get blurImage(){return this.uniforms.blurImage}set blurImage(e){e.baseTexture.isPowerOfTwo=!0,this.uniforms.blurImage=e}},md=dd;var pd="varying vec2 vTextureCoord;uniform sampler2D uSampler;uniform float amount;uniform float softness;uniform float realWidth;uniform float realHeight;void main(void){vec4 A=texture2D(uSampler,vTextureCoord);vec2 B=vTextureCoord-vec2(0.5*realWidth,0.5*realHeight);B.x*=realHeight/realWidth;float C=length(B);float D=realHeight*(0.5+(1.-amount)*0.5);float E=clamp(softness,0.001,1.00);float F=smoothstep(D,D-E,C);A.rgb*=F;gl_FragColor=vec4(A.rgb,A.a);}";var fd=class extends PIXI.Filter{constructor(){let e=O,t=pd;super(e,t);this.uniforms.amount=.35,this.uniforms.softness=.6,this.padding=0}apply(e,t,r,a){this.uniforms.realWidth=r.destinationFrame.width/t.size.width,this.uniforms.realHeight=r.destinationFrame.height/t.size.height,e.applyFilter(this,t,r,a)}get amount(){return this.uniforms.amount}set amount(e){this.uniforms.amount=e}get softness(){return this.uniforms.softness}set softness(e){this.uniforms.softness=e}},gd=fd;var vd=`precision highp float;
#define GLSLIFY 1
varying vec2 vTextureCoord;uniform sampler2D uSampler;uniform float mode;uniform bool inverse;uniform float mapSize;uniform float centerX;uniform float centerY;uniform float outerRadius;uniform float innerRadius;uniform float strength;uniform vec2 dimensions;uniform float opacity;float A(vec2 B,vec2 C,float D){float E=length(B);float F=smoothstep(D-(outerRadius-innerRadius),D,E);return mix(1.,F,opacity);}void main(void){lowp vec4 G=texture2D(uSampler,vTextureCoord.xy);G.rgb/=G.a;float H=(vTextureCoord.x*mapSize);float I=(vTextureCoord.y*mapSize);float J=(centerX-H);float K=(centerY-I);float L=sqrt((J*J)+(K*K));vec4 F=vec4(0.);if(mode==3.){vec2 M=vTextureCoord*dimensions;vec2 N=vec2(dimensions.x,dimensions.y);vec2 C=N/2.;vec2 O=N/2.;vec2 P=M-O;P.x*=N.y/N.x;float Q=(N.y/2.);float R=A(P,C,Q);F=mix(vec4(G.rgb,1.),vec4(0.),R);}else if((mode==0.&&L<outerRadius)||mode>0.){float S=0.;if(mode==0.){S=min(1.,max(0.,(L-innerRadius))/(outerRadius-innerRadius));}else if(mode==1.){float T=(outerRadius-innerRadius);vec2 U=vec2(((H<centerX)?T:(mapSize-T)),((I<centerY)?T:(mapSize-T)));if((H<T&&I<T)||(H>(mapSize-T)&&I<T)||(H<T&&(I>mapSize-T))||(H>(mapSize-T)&&(I>mapSize-T))){J=(U.x-H);K=(U.y-I);L=sqrt((J*J)+(K*K));S=min(1.,max(0.,L)/T);}else{float V=min(1.,max(0.,(abs(J)-innerRadius))/(outerRadius-innerRadius));float W=min(1.,max(0.,(abs(K)-innerRadius))/(outerRadius-innerRadius));S=max(V,W);}}else if(mode==2.){S=min(1.,max(0.,(abs(K)-innerRadius))/(outerRadius-innerRadius));}S*=S;if(inverse){S+=((1.-S)*(1.-strength));}G.a*=S;}if(!inverse){G.a=(1.-G.a);G.a*=strength;}G.rgb*=G.a;if(mode==3.){gl_FragColor=F;}else{gl_FragColor=G;}}`;var yd="attribute vec2 aVertexPosition;attribute vec2 aTextureCoord;uniform mat3 projectionMatrix;varying vec2 vTextureCoord;void main(void){gl_Position=vec4((projectionMatrix*vec3(aVertexPosition,1.)).xy,0.,1.);vTextureCoord=aTextureCoord;}";var xd=class extends PIXI.Shader{constructor(e){super(e,yd,vd);this.modes=["radial","square","linear","paint"],this._radius=50,this._hardness=1,this._strength=1,this._opacity=1,this._mode=this.modes.indexOf("radial"),this._inverse=!1}initParams(){this.uniforms.mode=!1,this.uniforms.inverse=!1,this.uniforms.mapSize=0,this.uniforms.centerX=0,this.uniforms.centerY=0,this.uniforms.outerRadius=1,this.uniforms.innerRadius=1}updateBrush(){this.uniforms.mode=this._mode,this.uniforms.inverse=this._inverse,this.uniforms.mapSize=this._radius*2,this.uniforms.centerX=this._radius,this.uniforms.centerY=this._radius,this.uniforms.outerRadius=this._radius,this.uniforms.innerRadius=Math.max(0,Math.min(this._radius-2,this._radius*this._hardness)),this.uniforms.strength=this._strength,this.uniforms.opacity=this._opacity}applyParams(e){try{this.uniforms.dimensions=[e.width,e.height]}catch(t){this.uniforms.dimensions=[512,512]}this.updateBrush()}get mode(){return this._mode}set mode(e){this.modes.indexOf(e)!=-1&&(this._mode=this.modes.indexOf(e))}get radius(){return this._radius}set radius(e){this._radius=Math.round(e)}get hardness(){this._hardness=Math.max(0,Math.min(1,value))}set hardness(e){this._hardness=e}get strength(){return this._strength}set strength(e){this._strength=Math.max(0,Math.min(1,e))}get inverse(){return this._inverse}set inverse(e){this._inverse=e}get opacity(){return this._opacity}set opacity(e){this._opacity=e}},Td=xd;var Fd="varying vec2 vTextureCoord;uniform sampler2D uSampler;uniform float segmentsX;uniform float segmentsY;uniform float textureW;uniform float textureH;uniform float mapW;uniform float mapH;void main(void){float A=(textureW/segmentsX);float B=(textureH/segmentsY);float C=(vTextureCoord.x*mapW);float D=(vTextureCoord.y*mapH);lowp vec2 E=vec2((((floor(C/A)*A)+(A/2.))/mapW),(((floor(D/B)*B)+(B/2.))/mapH));gl_FragColor=texture2D(uSampler,E.xy);}";var bd="attribute vec2 aVertexPosition;attribute vec2 aTextureCoord;uniform mat3 projectionMatrix;varying vec2 vTextureCoord;void main(void){gl_Position=vec4((projectionMatrix*vec3(aVertexPosition,1.)).xy,0.,1.);vTextureCoord=aTextureCoord;}";var Bd=class extends PIXI.Filter{constructor(){super(bd,Fd);this.padding=0,this.resolution=1,this.segmentsX=0,this.segmentsY=0,this.textureW=0,this.textureH=0}apply(e,t,r,a){e.applyFilter(this,t,r,a)}get segmentsX(){return this.uniforms.segmentsX}set segmentsX(e){this.uniforms.segmentsX=Math.round(e)}get segmentsY(){return this.uniforms.segmentsY}set segmentsY(e){this.uniforms.segmentsY=Math.round(e)}get textureW(){return this.uniforms.textureW}set textureW(e){this.uniforms.textureW=Math.round(e),this.uniforms.mapW=BFN.FilterHelper.getNextPowerOfTwo(Math.round(e))}get textureH(){return this.uniforms.textureH}set textureH(e){this.uniforms.textureH=Math.round(e),this.uniforms.mapH=BFN.FilterHelper.getNextPowerOfTwo(Math.round(e))}},Sd=Bd;var Id="varying vec2 vTextureCoord;varying vec2 vMapCoord;varying vec4 vColor;uniform sampler2D uSampler;uniform sampler2D topImage;uniform float intensity;uniform float clampX;uniform float clampY;void main(void){vec4 A=texture2D(uSampler,vTextureCoord);vec4 B=texture2D(topImage,vTextureCoord*vec2(clampX,clampY));gl_FragColor=mix(A,B,intensity);}";var _d=class extends PIXI.Filter{constructor(){super(O,Id);this.padding=0,this.intensity=1}apply(e,t,r,a){let s=BFN.FilterHelper.calculateFilterClamp(t,r);this.uniforms.clampX=s.x,this.uniforms.clampY=s.y,e.applyFilter(this,t,r,a)}get intensity(){return this.uniforms.intensity}set intensity(e){this.uniforms.intensity=e}get topImage(){return this.uniforms.topImage}set topImage(e){this.uniforms.topImage=e}},Cd=_d;var Ed="vec2 A(vec2 B,vec4 C){B*=C.xy;B+=C.zw;return B;}vec2 D(vec2 B,vec4 C){B-=C.zw;B/=C.xy;return B;}float E(vec3 F){return dot(F,vec3(0.299,0.587,0.114));}vec3 G(vec3 H,vec3 I,vec3 J){float K=max(max(H.r,H.g),H.b);return I*K+J*(1.-K);}varying vec2 vTextureCoord;uniform sampler2D uSampler;uniform vec4 filterArea;uniform float clampX;uniform float clampY;uniform float dotSize;uniform vec3 background_color;uniform vec3 dot_color;vec2 L(vec2 M,float N){return floor(M/N)*N;}void main(void){vec2 O=A(vTextureCoord,filterArea);vec2 P=vec2(1./filterArea.xy);vec2 Q=vec2(1./clampX-P.x,1./clampY-P.y);vec2 R=L(O,dotSize)+0.5*dotSize;float S=min(length(O-R)/((dotSize)*0.5),1.);R=D(R,filterArea);vec3 T=texture2D(uSampler,clamp(R,vec2(0.),Q)).rgb;float U=1.-E(T);S=smoothstep(min(max(U,0.2),0.8),max(min(U+0.1,1.),0.25),S);vec3 V=G(vec3(S),background_color,dot_color);gl_FragColor=vec4(V,1.);}";var Pd=class extends PIXI.Filter{constructor(){super(O,Ed);this.dotSize=1,this.background_color="0xFFFFFF",this.dot_color="0xFF0000",this.padding=0}apply(e,t,r,a){let s=BFN.FilterHelper.calculateFilterClamp(t,r);this.uniforms.clampX=s.x,this.uniforms.clampY=s.y,e.applyFilter(this,t,r,a)}get dotSize(){return this.uniforms.dotSize}set dotSize(e){this.uniforms.dotSize=e}get background_color(){return this.uniforms.background_color}set background_color(e){e=BFN.FilterHelper.hex2rgb(e),this.uniforms.background_color=e}get dot_color(){return this.uniforms.dot_color}set dot_color(e){e=BFN.FilterHelper.hex2rgb(e),this.uniforms.dot_color=e}},Nd=Pd;var Md="attribute vec2 aVertexPosition;attribute vec2 aTextureCoord;attribute vec4 aColor;uniform mat3 projectionMatrix;uniform mat3 mapMatrix;varying vec2 vTextureCoord;varying vec2 vMapCoord;void main(void){gl_Position=vec4((projectionMatrix*vec3(aVertexPosition,1.)).xy,0.,1.);vTextureCoord=aTextureCoord;vMapCoord=(mapMatrix*vec3(aVertexPosition,1.)).xy;}";var Dd="varying vec2 vTextureCoord;varying vec2 vMapCoord;uniform sampler2D uSampler;uniform sampler2D iChannel1;uniform float intensity;uniform float clampX;uniform float clampY;void main(void){vec4 A=texture2D(uSampler,vTextureCoord);vec4 B=texture2D(iChannel1,vTextureCoord*vec2(clampX,clampY));float C=clamp((B.a*intensity),0.,1.);A.rgb*=C;A.a=C;gl_FragColor=A;}";var wd="varying vec2 vTextureCoord;varying vec2 vMapCoord;uniform sampler2D uSampler;uniform sampler2D iChannel1;uniform float intensity;uniform float clampX;uniform float clampY;void main(void){vec4 A=texture2D(uSampler,vTextureCoord);vec4 B=texture2D(iChannel1,vTextureCoord*vec2(clampX,clampY));if(B.a==0.){gl_FragColor=A;return;}A.a=clamp((A.a-(B.a*intensity)),0.,1.);gl_FragColor=A;}";var kd="varying vec2 vTextureCoord;varying vec2 vMapCoord;uniform sampler2D uSampler;uniform sampler2D iChannel1;uniform float intensity;uniform float clampX;uniform float clampY;vec3 A(vec3 B,vec3 C,float D){return(B+C-2.*B*C)*D+C*(1.-D);}void main(void){vec4 C=texture2D(uSampler,vTextureCoord);vec4 B=texture2D(iChannel1,vTextureCoord*vec2(clampX,clampY));if(B.a==0.){gl_FragColor=vec4(0,0,0,0);return;}vec3 E=B.rgb/B.a;vec3 F=vec3(0.);if(C.a>0.){F=C.rgb/C.a;}vec3 G=clamp(A(E.xyz,F.xyz,intensity),0.,1.);vec4 H;H.xyz=(1.-B.a)*F+B.a*G;H.a=B.a+C.a*(1.-B.a);gl_FragColor=vec4(H.xyz*H.a,H.a)*C.a;}";var Ad="varying vec2 vTextureCoord;varying vec2 vMapCoord;uniform sampler2D uSampler;uniform sampler2D iChannel1;uniform float intensity;uniform float clampX;uniform float clampY;vec3 A(vec3 B,vec3 C,float D){return abs(B-C)*D+C*(1.-D);}void main(void){vec4 C=texture2D(uSampler,vTextureCoord);vec4 B=texture2D(iChannel1,vTextureCoord*vec2(clampX,clampY));if(B.a==0.){gl_FragColor=vec4(0,0,0,0);return;}vec3 E=B.rgb/B.a;vec3 F=vec3(0.);if(C.a>0.){F=C.rgb/C.a;}vec3 G=clamp(A(E.xyz,F.xyz,intensity),0.,1.);vec4 H;H.xyz=(1.-B.a)*F+B.a*G;H.a=B.a+C.a*(1.-B.a);gl_FragColor=vec4(H.xyz*H.a,H.a)*C.a;}";var Od="varying vec2 vTextureCoord;varying vec2 vMapCoord;uniform sampler2D uSampler;uniform sampler2D iChannel1;uniform float intensity;uniform float clampX;uniform float clampY;vec3 A(vec3 B,vec3 C,float D){return vec3((B.x>0.5)?max(C.x,2.*(B.x-0.5)):min(C.x,2.*B.x),(B.x>0.5)?max(C.y,2.*(B.y-0.5)):min(C.y,2.*B.y),(B.z>0.5)?max(C.z,2.*(B.z-0.5)):min(C.z,2.*B.z))*D+C*(1.-D);}void main(void){vec4 C=texture2D(uSampler,vTextureCoord);vec4 B=texture2D(iChannel1,vTextureCoord*vec2(clampX,clampY));if(B.a==0.){gl_FragColor=vec4(0,0,0,0);return;}vec3 E=B.rgb/B.a;vec3 F=vec3(0.);if(C.a>0.){F=C.rgb/C.a;}vec3 G=clamp(A(E.xyz,F.xyz,intensity),0.,1.);vec4 H;H.xyz=(1.-B.a)*F+B.a*G;H.a=B.a+C.a*(1.-B.a);gl_FragColor=vec4(H.xyz*H.a,H.a)*C.a;}";var Rd="varying vec2 vTextureCoord;varying vec2 vMapCoord;uniform sampler2D uSampler;uniform sampler2D iChannel1;uniform float intensity;uniform float clampX;uniform float clampY;vec3 A(vec3 B,vec3 C,float D){return(2.*B+C-1.)*D+C*(1.-D);}void main(void){vec4 C=texture2D(uSampler,vTextureCoord);vec4 B=texture2D(iChannel1,vTextureCoord*vec2(clampX,clampY));if(B.a==0.){gl_FragColor=vec4(0,0,0,0);return;}vec3 E=B.rgb/B.a;vec3 F=vec3(0.);if(C.a>0.){F=C.rgb/C.a;}vec3 G=clamp(A(E.xyz,F.xyz,intensity),0.,1.);vec4 H;H.xyz=(1.-B.a)*F+B.a*G;H.a=B.a+C.a*(1.-B.a);gl_FragColor=vec4(H.xyz*H.a,H.a)*C.a;}";var Ld="varying vec2 vTextureCoord;varying vec2 vMapCoord;uniform sampler2D uSampler;uniform sampler2D iChannel1;uniform float intensity;uniform float clampX;uniform float clampY;vec3 A(vec3 B,vec3 C,float D){return mix(max(vec3(0.),1.-min(vec3(1.),(1.-C)/(2.*B))),min(vec3(1.),C/(2.*(1.-B))),step(0.5,B))*D+C*(1.-D);}void main(void){vec4 C=texture2D(uSampler,vTextureCoord);vec4 B=texture2D(iChannel1,vTextureCoord*vec2(clampX,clampY));if(B.a==0.){gl_FragColor=vec4(0,0,0,0);return;}vec3 E=B.rgb/B.a;vec3 F=vec3(0.);if(C.a>0.){F=C.rgb/C.a;}vec3 G=clamp(A(E.xyz,F.xyz,intensity),0.,1.);vec4 H;H.xyz=(1.-B.a)*F+B.a*G;H.a=B.a+C.a*(1.-B.a);gl_FragColor=vec4(H.xyz*H.a,H.a)*C.a;}";var Vd="varying vec2 vTextureCoord;varying vec2 vMapCoord;uniform sampler2D uSampler;uniform sampler2D iChannel1;uniform float intensity;uniform float clampX;uniform float clampY;vec3 A(vec3 B,vec3 C,float D){return vec3((B.x<=0.5)?(2.*B.x*C.x):(1.-2.*(1.-B.x)*(1.-C.x)),(B.y<=0.5)?(2.*B.y*C.y):(1.-2.*(1.-B.y)*(1.-C.y)),(B.z<=0.5)?(2.*B.z*C.z):(1.-2.*(1.-B.z)*(1.-C.z)))*D+C*(1.-D);}void main(void){vec4 C=texture2D(uSampler,vTextureCoord);vec4 B=texture2D(iChannel1,vTextureCoord*vec2(clampX,clampY));if(B.a==0.){gl_FragColor=vec4(0,0,0,0);return;}vec3 E=B.rgb/B.a;vec3 F=vec3(0.);if(C.a>0.){F=C.rgb/C.a;}vec3 G=clamp(A(E.xyz,F.xyz,intensity),0.,1.);vec4 H;H.xyz=(1.-B.a)*F+B.a*G;H.a=B.a+C.a*(1.-B.a);gl_FragColor=vec4(H.xyz*H.a,H.a)*C.a;}";var Ud="varying vec2 vTextureCoord;varying vec2 vMapCoord;uniform sampler2D uSampler;uniform sampler2D iChannel1;uniform float intensity;uniform float clampX;uniform float clampY;vec3 A(vec3 B,vec3 C,float D){return vec3((B.x<=0.5)?(C.x-(1.-2.*B.x)*C.x*(1.-C.x)):(((B.x>0.5)&&(C.x<=0.25))?(C.x+(2.*B.x-1.)*(4.*C.x*(4.*C.x+1.)*(C.x-1.)+7.*C.x)):(C.x+(2.*B.x-1.)*(sqrt(C.x)-C.x))),(B.y<=0.5)?(C.y-(1.-2.*B.y)*C.y*(1.-C.y)):(((B.y>0.5)&&(C.y<=0.25))?(C.y+(2.*B.y-1.)*(4.*C.y*(4.*C.y+1.)*(C.y-1.)+7.*C.y)):(C.y+(2.*B.y-1.)*(sqrt(C.y)-C.y))),(B.z<=0.5)?(C.z-(1.-2.*B.z)*C.z*(1.-C.z)):(((B.z>0.5)&&(C.z<=0.25))?(C.z+(2.*B.z-1.)*(4.*C.z*(4.*C.z+1.)*(C.z-1.)+7.*C.z)):(C.z+(2.*B.z-1.)*(sqrt(C.z)-C.z))))*D+C*(1.-D);}void main(void){vec4 C=texture2D(uSampler,vTextureCoord);vec4 B=texture2D(iChannel1,vTextureCoord*vec2(clampX,clampY));if(B.a==0.){gl_FragColor=vec4(0,0,0,0);return;}vec3 E=B.rgb/B.a;vec3 F=vec3(0.);if(C.a>0.){F=C.rgb/C.a;}vec3 G=clamp(A(E.xyz,F.xyz,intensity),0.,1.);vec4 H;H.xyz=(1.-B.a)*F+B.a*G;H.a=B.a+C.a*(1.-B.a);gl_FragColor=vec4(H.xyz*H.a,H.a)*C.a;}";var Gd="varying vec2 vTextureCoord;varying vec2 vMapCoord;uniform sampler2D uSampler;uniform sampler2D iChannel1;uniform float intensity;uniform int alphadir;uniform float clampX;uniform float clampY;vec3 A(vec3 B,vec3 C,float D,int E){return vec3((C.x<=0.5)?(2.*B.x*C.x):(1.-2.*(1.-C.x)*(1.-B.x)),(C.y<=0.5)?(2.*B.y*C.y):(1.-2.*(1.-C.y)*(1.-B.y)),(C.z<=0.5)?(2.*B.z*C.z):(1.-2.*(1.-C.z)*(1.-B.z)))*D+((E==0)?C:B)*(1.-D);}void main(void){vec4 C=texture2D(uSampler,vTextureCoord);vec4 B=texture2D(iChannel1,vTextureCoord*vec2(clampX,clampY));if(B.a==0.){gl_FragColor=vec4(0,0,0,0);return;}if(C.a==0.&&alphadir==0){gl_FragColor=vec4(0,0,0,0);return;}vec3 F=B.rgb/B.a;vec3 G=vec3(0.);if(C.a>0.){G=C.rgb/C.a;}vec3 H=clamp(A(F.xyz,G.xyz,intensity,alphadir),0.,1.);vec4 I;I.xyz=(1.-B.a)*G+B.a*H;I.a=B.a+C.a*(1.-B.a);gl_FragColor=vec4(I.xyz*I.a,I.a)*C.a;}";var Hd="varying vec2 vTextureCoord;varying vec2 vMapCoord;uniform sampler2D uSampler;uniform sampler2D iChannel1;uniform float intensity;uniform float clampX;uniform float clampY;vec3 A(vec3 B,vec3 C,float D){return(B+C)*D+C*(1.-D);}void main(void){vec4 C=texture2D(uSampler,vTextureCoord);vec4 B=texture2D(iChannel1,vTextureCoord*vec2(clampX,clampY));if(B.a==0.){gl_FragColor=vec4(0,0,0,0);return;}vec3 E=B.rgb/B.a;vec3 F=vec3(0.);if(C.a>0.){F=C.rgb/C.a;}vec3 G=clamp(A(E.xyz,F.xyz,intensity),0.,1.);vec4 H;H.xyz=(1.-B.a)*F+B.a*G;H.a=B.a+C.a*(1.-B.a);gl_FragColor=vec4(H.xyz*H.a,H.a)*C.a;}";var Xd="varying vec2 vTextureCoord;varying vec2 vMapCoord;uniform sampler2D uSampler;uniform sampler2D iChannel1;uniform float intensity;uniform float clampX;uniform float clampY;vec3 A(vec3 B,vec3 C,float D){return vec3((B.x==1.)?1.:min(1.,C.x/(1.-B.x)),(B.y==1.)?1.:min(1.,C.y/(1.-B.y)),(B.z==1.)?1.:min(1.,C.z/(1.-B.z)))*D+C*(1.-D);}void main(void){vec4 C=texture2D(uSampler,vTextureCoord);vec4 B=texture2D(iChannel1,vTextureCoord*vec2(clampX,clampY));if(B.a==0.){gl_FragColor=vec4(0,0,0,0);return;}vec3 E=B.rgb/B.a;vec3 F=vec3(0.);if(C.a>0.){F=C.rgb/C.a;}vec3 G=clamp(A(E.xyz,F.xyz,intensity),0.,1.);vec4 H;H.xyz=(1.-B.a)*F+B.a*G;H.a=B.a+C.a*(1.-B.a);gl_FragColor=vec4(H.xyz*H.a,H.a)*C.a;}";var zd="varying vec2 vTextureCoord;varying vec2 vMapCoord;uniform sampler2D uSampler;uniform sampler2D iChannel1;uniform float intensity;uniform float clampX;uniform float clampY;vec3 A(vec3 B,vec3 C,float D){return((B+C)-(B*C))*D+C*(1.-D);}void main(void){vec4 C=texture2D(uSampler,vTextureCoord);vec4 B=texture2D(iChannel1,vTextureCoord*vec2(clampX,clampY));if(B.a==0.){gl_FragColor=vec4(0,0,0,0);return;}vec3 E=B.rgb/B.a;vec3 F=vec3(0.);if(C.a>0.){F=C.rgb/C.a;}vec3 G=clamp(A(E.xyz,F.xyz,intensity),0.,1.);vec4 H;H.xyz=(1.-B.a)*F+B.a*G;H.a=B.a+C.a*(1.-B.a);gl_FragColor=vec4(H.xyz*H.a,H.a)*C.a;}";var Wd="varying vec2 vTextureCoord;varying vec2 vMapCoord;uniform sampler2D uSampler;uniform sampler2D iChannel1;uniform float intensity;uniform float clampX;uniform float clampY;vec3 A(vec3 B,vec3 C,float D){return max(B,C)*D+C*(1.-D);}void main(void){vec4 C=texture2D(uSampler,vTextureCoord);vec4 B=texture2D(iChannel1,vTextureCoord*vec2(clampX,clampY));if(B.a==0.){gl_FragColor=vec4(0,0,0,0);return;}vec3 E=B.rgb/B.a;vec3 F=vec3(0.);if(C.a>0.){F=C.rgb/C.a;}vec3 G=clamp(A(E.xyz,F.xyz,intensity),0.,1.);vec4 H;H.xyz=(1.-B.a)*F+B.a*G;H.a=B.a+C.a*(1.-B.a);gl_FragColor=vec4(H.xyz*H.a,H.a)*C.a;}";var $d="varying vec2 vTextureCoord;varying vec2 vMapCoord;uniform sampler2D uSampler;uniform sampler2D iChannel1;uniform float intensity;uniform float clampX;uniform float clampY;vec3 A(vec3 B,vec3 C,float D){return((B+C)-1.)*D+C*(1.-D);}void main(void){vec4 C=texture2D(uSampler,vTextureCoord);vec4 B=texture2D(iChannel1,vTextureCoord*vec2(clampX,clampY));if(B.a==0.){gl_FragColor=vec4(0,0,0,0);return;}vec3 E=B.rgb/B.a;vec3 F=vec3(0.);if(C.a>0.){F=C.rgb/C.a;}vec3 G=clamp(A(E.xyz,F.xyz,intensity),0.,1.);vec4 H;H.xyz=(1.-B.a)*F+B.a*G;H.a=B.a+C.a*(1.-B.a);gl_FragColor=vec4(H.xyz*H.a,H.a)*C.a;}";var jd="varying vec2 vTextureCoord;varying vec2 vMapCoord;uniform sampler2D uSampler;uniform sampler2D iChannel1;uniform float intensity;uniform float clampX;uniform float clampY;vec3 A(vec3 B,vec3 C,float D){return vec3((B.x==0.)?0.:(1.-((1.-C.x)/B.x)),(B.y==0.)?0.:(1.-((1.-C.y)/B.y)),(B.z==0.)?0.:(1.-((1.-C.z)/B.z)))*D+C*(1.-D);}void main(void){vec4 C=texture2D(uSampler,vTextureCoord);vec4 B=texture2D(iChannel1,vTextureCoord*vec2(clampX,clampY));if(B.a==0.){gl_FragColor=vec4(0,0,0,0);return;}vec3 E=B.rgb/B.a;vec3 F=vec3(0.);if(C.a>0.){F=C.rgb/C.a;}vec3 G=clamp(A(E.xyz,F.xyz,intensity),0.,1.);vec4 H;H.xyz=(1.-B.a)*F+B.a*G;H.a=B.a+C.a*(1.-B.a);gl_FragColor=vec4(H.xyz*H.a,H.a)*C.a;}";var Yd="varying vec2 vTextureCoord;varying vec2 vMapCoord;uniform sampler2D uSampler;uniform sampler2D iChannel1;uniform float intensity;uniform float clampX;uniform float clampY;vec3 A(vec3 B,vec3 C,float D){float E=min(B.r,C.r);float F=min(B.g,C.g);float G=min(B.b,C.b);return vec3(E,F,G)*D+C*(1.-D);}void main(void){vec4 C=texture2D(uSampler,vTextureCoord);vec4 B=texture2D(iChannel1,vTextureCoord*vec2(clampX,clampY));if(B.a==0.){gl_FragColor=vec4(0,0,0,0);return;}vec3 H=B.rgb/B.a;vec3 I=vec3(0.);if(C.a>0.){I=C.rgb/C.a;}vec3 J=clamp(A(H.xyz,I.xyz,intensity),0.,1.);vec4 K;K.xyz=(1.-B.a)*I+B.a*J;K.a=B.a+C.a*(1.-B.a);gl_FragColor=vec4(K.xyz*K.a,K.a)*C.a;}";var qd="varying vec2 vTextureCoord;varying vec2 vMapCoord;uniform sampler2D uSampler;uniform sampler2D iChannel1;uniform float intensity;uniform float clampX;uniform float clampY;vec3 A(vec3 B,vec3 C,float D){return(B*C)*D+C*(1.-D);}void main(void){vec4 C=texture2D(uSampler,vTextureCoord);vec4 B=texture2D(iChannel1,vTextureCoord*vec2(clampX,clampY));if(B.a==0.){gl_FragColor=vec4(0,0,0,0);return;}vec3 E=B.rgb/B.a;vec3 F=vec3(0.);if(C.a>0.){F=C.rgb/C.a;}vec3 G=clamp(A(E.xyz,F.xyz,intensity),0.,1.);vec4 H;H.xyz=(1.-B.a)*F+B.a*G;H.a=B.a+C.a*(1.-B.a);gl_FragColor=vec4(H.xyz*H.a,H.a)*C.a;}";var Kd="varying vec2 vTextureCoord;varying vec2 vMapCoord;uniform sampler2D uSampler;uniform sampler2D iChannel1;uniform float intensity;uniform float clampX;uniform float clampY;vec3 A(vec3 B,vec3 C,float D){return(C-B)*D+C*(1.-D);}void main(void){vec4 C=texture2D(uSampler,vTextureCoord);vec4 B=texture2D(iChannel1,vTextureCoord*vec2(clampX,clampY));if(B.a==0.){gl_FragColor=vec4(0,0,0,0);return;}vec3 E=B.rgb/B.a;vec3 F=vec3(0.);if(C.a>0.){F=C.rgb/C.a;}vec3 G=clamp(A(E.xyz,F.xyz,intensity),0.,1.);vec4 H;H.xyz=(1.-B.a)*F+B.a*G;H.a=B.a+C.a*(1.-B.a);gl_FragColor=vec4(H.xyz*H.a,H.a)*C.a;}";var Jd="varying vec2 vTextureCoord;varying vec2 vMapCoord;uniform sampler2D uSampler;uniform sampler2D iChannel1;uniform float intensity;uniform float clampX;uniform float clampY;vec3 A(vec3 B,vec3 C,float D){return(B+C)*D+C*(1.-D);}void main(void){vec4 C=texture2D(uSampler,vTextureCoord);vec4 B=texture2D(iChannel1,vTextureCoord*vec2(clampX,clampY));if(B.a==0.){gl_FragColor=vec4(0,0,0,0);return;}vec3 E=B.rgb/B.a;vec3 F=vec3(0.);if(C.a>0.){F=C.rgb/C.a;}vec3 G=clamp(A(E.xyz,F.xyz,intensity),0.,1.);vec4 H;H.xyz=(1.-B.a)*F+B.a*G;H.a=B.a+C.a*(1.-B.a);gl_FragColor=vec4(H.xyz*H.a,H.a)*C.a;}";var Qd="varying vec2 vTextureCoord;varying vec2 vMapCoord;uniform sampler2D uSampler;uniform sampler2D iChannel1;uniform float intensity;uniform float clampX;uniform float clampY;vec3 A(vec3 B,vec3 C,float D){return B*D+C*(1.-D);}void main(void){vec4 C=texture2D(uSampler,vTextureCoord);vec4 B=texture2D(iChannel1,vTextureCoord*vec2(clampX,clampY));if(B.a==0.){gl_FragColor=vec4(0,0,0,0);return;}vec3 E=B.rgb/B.a;vec3 F=vec3(0.);if(C.a>0.){F=C.rgb/C.a;}vec3 G=clamp(A(E.xyz,F.xyz,intensity),0.,1.);vec4 H;H.xyz=(1.-B.a)*F+B.a*G;H.a=B.a+C.a*(1.-B.a);gl_FragColor=vec4(H.xyz*H.a,H.a)*C.a;}";var Zd="varying vec2 vTextureCoord;varying vec2 vMapCoord;uniform sampler2D uSampler;uniform sampler2D iChannel1;uniform float intensity;uniform float clampX;uniform float clampY;float A(vec3 B){return dot(B,vec3(0.3,0.59,0.11));}vec3 C(vec3 B){float D=A(B);float E=min(min(B.r,B.g),B.b);float F=max(max(B.r,B.g),B.b);if(E<0.){B.r=D+((B.r-D)*D)/(D-E);B.g=D+((B.g-D)*D)/(D-E);B.b=D+((B.b-D)*D)/(D-E);}if(F>1.){B.r=D+((B.r-D)*(1.-D))/(F-D);B.g=D+((B.g-D)*(1.-D))/(F-D);B.b=D+((B.b-D)*(1.-D))/(F-D);}return B;}vec3 G(vec3 B,float D){float H=D-A(B);B=B+vec3(H);return C(B);}vec3 I(vec3 J,vec3 K,float L){return G(J,A(K))*L+K*(1.-L);}void main(void){vec4 K=texture2D(uSampler,vTextureCoord);vec4 J=texture2D(iChannel1,vTextureCoord*vec2(clampX,clampY));if(J.a==0.){gl_FragColor=vec4(0,0,0,0);return;}vec3 M=J.rgb/J.a;vec3 N=vec3(0.);if(K.a>0.){N=K.rgb/K.a;}vec3 O=clamp(I(M.xyz,N.xyz,intensity),0.,1.);vec4 P;P.xyz=(1.-J.a)*N+J.a*O;P.a=J.a+K.a*(1.-J.a);gl_FragColor=vec4(P.xyz*P.a,P.a)*K.a;}";var em="varying vec2 vTextureCoord;varying vec2 vMapCoord;uniform sampler2D uSampler;uniform sampler2D iChannel1;uniform float intensity;uniform float clampX;uniform float clampY;float A(vec3 B){return dot(B,vec3(0.3,0.59,0.11));}vec3 C(vec3 B){float D=A(B);float E=min(min(B.r,B.g),B.b);float F=max(max(B.r,B.g),B.b);if(E<0.){B.r=D+((B.r-D)*D)/(D-E);B.g=D+((B.g-D)*D)/(D-E);B.b=D+((B.b-D)*D)/(D-E);}if(F>1.){B.r=D+((B.r-D)*(1.-D))/(F-D);B.g=D+((B.g-D)*(1.-D))/(F-D);B.b=D+((B.b-D)*(1.-D))/(F-D);}return B;}vec3 G(vec3 B,float D){float H=D-A(B);B=B+vec3(H);return C(B);}float I(vec3 B){float E=min(min(B.r,B.g),B.b);float F=max(max(B.r,B.g),B.b);return F-E;}float J(float K,float L,float M,float N){return((L-K)*N)/(M-K);}vec3 O(vec3 B,float N){if(B.r>B.g){if(B.r>B.b){if(B.g>B.b){B.g=J(B.b,B.g,B.r,N);B.b=0.;}else{B.b=J(B.g,B.b,B.r,N);B.g=0.;}B.r=N;}else{B.r=J(B.g,B.r,B.b,N);B.b=N;B.r=0.;}}else if(B.r>B.b){B.r=J(B.b,B.r,B.g,N);B.g=N;B.b=0.;}else if(B.g>B.b){B.b=J(B.r,B.b,B.g,N);B.g=N;B.r=0.;}else if(B.b>B.g){B.g=J(B.r,B.g,B.b,N);B.b=N;B.r=0.;}else{B=vec3(0.);}return B;}vec3 P(vec3 Q,vec3 R,float S){return G(O(Q.rgb,I(R.rgb)),A(R.rgb))*S+R*(1.-S);}void main(void){vec4 R=texture2D(uSampler,vTextureCoord);vec4 Q=texture2D(iChannel1,vTextureCoord*vec2(clampX,clampY));if(Q.a==0.){gl_FragColor=vec4(0,0,0,0);return;}vec3 T=Q.rgb/Q.a;vec3 U=vec3(0.);if(R.a>0.){U=R.rgb/R.a;}vec3 V=clamp(P(T.xyz,U.xyz,intensity),0.,1.);vec4 W;W.xyz=(1.-Q.a)*U+Q.a*V;W.a=Q.a+R.a*(1.-Q.a);gl_FragColor=vec4(W.xyz*W.a,W.a)*R.a;}";var tm="varying vec2 vTextureCoord;varying vec2 vMapCoord;uniform sampler2D uSampler;uniform sampler2D iChannel1;uniform float intensity;uniform float clampX;uniform float clampY;float A(vec3 B){return dot(B,vec3(0.3,0.59,0.11));}vec3 C(vec3 B){float D=A(B);float E=min(min(B.r,B.g),B.b);float F=max(max(B.r,B.g),B.b);if(E<0.){B.r=D+((B.r-D)*D)/(D-E);B.g=D+((B.g-D)*D)/(D-E);B.b=D+((B.b-D)*D)/(D-E);}if(F>1.){B.r=D+((B.r-D)*(1.-D))/(F-D);B.g=D+((B.g-D)*(1.-D))/(F-D);B.b=D+((B.b-D)*(1.-D))/(F-D);}return B;}vec3 G(vec3 B,float D){float H=D-A(B);B=B+vec3(H);return C(B);}vec3 I(vec3 J,vec3 K,float L){return G(K.rgb,A(J.rgb))*L+K*(1.-L);}void main(void){vec4 K=texture2D(uSampler,vTextureCoord);vec4 J=texture2D(iChannel1,vTextureCoord*vec2(clampX,clampY));if(J.a==0.){gl_FragColor=vec4(0,0,0,0);return;}vec3 M=J.rgb/J.a;vec3 N=vec3(0.);if(K.a>0.){N=K.rgb/K.a;}vec3 O=clamp(I(M.xyz,N.xyz,intensity),0.,1.);vec4 P;P.xyz=(1.-J.a)*N+J.a*O;P.a=J.a+K.a*(1.-J.a);gl_FragColor=vec4(P.xyz*P.a,P.a)*K.a;}";var im=class extends PIXI.Filter{constructor(e){let t=Qd;switch(e){case BFN.CONST.BLEND_MODES.ADD:t=Jd;break;case BFN.CONST.BLEND_MODES.SUBTRACT:t=Kd;break;case BFN.CONST.BLEND_MODES.MULTIPLY:t=qd;break;case BFN.CONST.BLEND_MODES.DARKEN:t=Yd;break;case BFN.CONST.BLEND_MODES.COLOR_BURN:t=jd;break;case BFN.CONST.BLEND_MODES.LINEAR_BURN:t=$d;break;case BFN.CONST.BLEND_MODES.LIGHTEN:t=Wd;break;case BFN.CONST.BLEND_MODES.SCREEN:t=zd;break;case BFN.CONST.BLEND_MODES.COLOR_DODGE:t=Xd;break;case BFN.CONST.BLEND_MODES.LINEAR_DODGE:t=Hd;break;case BFN.CONST.BLEND_MODES.OVERLAY:t=Gd;break;case BFN.CONST.BLEND_MODES.SOFT_LIGHT:t=Ud;break;case BFN.CONST.BLEND_MODES.HARD_LIGHT:t=Vd;break;case BFN.CONST.BLEND_MODES.VIVID_LIGHT:t=Ld;break;case BFN.CONST.BLEND_MODES.LINEAR_LIGHT:t=Rd;break;case BFN.CONST.BLEND_MODES.PIN_LIGHT:t=Od;break;case BFN.CONST.BLEND_MODES.DIFFERENCE:t=Ad;break;case BFN.CONST.BLEND_MODES.EXCLUSION:t=kd;break;case BFN.CONST.BLEND_MODES.ERASE:t=wd;break;case BFN.CONST.BLEND_MODES.ALPHA:t=Dd;break;case BFN.CONST.BLEND_MODES.COLOR:t=Zd;break;case BFN.CONST.BLEND_MODES.HUE:t=em;break;case BFN.CONST.BLEND_MODES.LUMINOSITY:t=tm;break}super(Md,t);this.uniforms.intensity=1,e==BFN.CONST.BLEND_MODES.OVERLAY&&(this.alphadir=0),this.padding=0}apply(e,t,r,a){let s=BFN.FilterHelper.calculateFilterClamp(t,r);this.uniforms.clampX=s.x,this.uniforms.clampY=s.y,e.applyFilter(this,t,r,a)}get intensity(){return this.uniforms.intensity}set intensity(e){this.uniforms.intensity=e}get alphadir(){return this.uniforms.alphadir}set alphadir(e){this.uniforms.alphadir=e}get iChannel1(){return this.uniforms.iChannel1}set iChannel1(e){this.uniforms.iChannel1=e}},rm=im;var am="float A(vec3 B){return dot(B,vec3(0.299,0.587,0.114));}float C(float D,float E){return pow(D,E);}vec3 F(vec3 G,vec2 H,float I,float J,float E,float K){vec2 L=H-vec2(0.5*I,0.5*J);L.x*=J/I;float M=length(L);float N=J*(0.5+(1.-E)*0.5);float O=clamp(smoothstep(N,N-0.2,M),0.,1.);G*=mix(O,1.,K);return G;}float P(float Q,float R){return mix(2.*Q*R,1.-2.*(1.-Q)*(1.-R),step(0.5,R));}float S(vec3 B,vec3 T){return dot(B,vec3(T.r,T.g,T.b));}uniform sampler2D uSampler;varying vec2 vTextureCoord;uniform float realWidth;uniform float realHeight;void main(void){vec4 U=texture2D(uSampler,vTextureCoord);if(U.a==0.){gl_FragColor=vec4(0,0,0,0);return;}U.rgb/=U.a;float V=F(vec3(1.),vTextureCoord,realWidth,realHeight,0.8,0.22).r;float W=S(U.rgb,vec3(0.25,0.75,0.));float X=C(W,0.60);float Y=mix(0.5,X,0.5);X=P(Y,X);float Z=C(W,1.5);float a=mix(Z,X,V);gl_FragColor=vec4(vec3(a)*U.a,U.a);}";var sm="float A(vec3 B){return float(B.r);}float C(vec3 B){return float(B.g);}float D(vec3 B){return float(B.b);}vec3 E(vec3 F,vec3 G){return mix(2.*F*G,1.-2.*(1.-F)*(1.-G),step(0.5,G));}float H(vec3 B){return dot(B,vec3(0.299,0.587,0.114));}varying vec2 vTextureCoord;uniform sampler2D uSampler;uniform vec3 color;uniform float mode;void main(void){vec4 I=texture2D(uSampler,vTextureCoord);if(I.a==0.){gl_FragColor=vec4(0,0,0,0);return;}I.rgb/=I.a;gl_FragColor=vec4(E(color,vec3((mode==0.)?A(I.rgb)*I.a:((mode==1.)?H(I.rgb)*I.a:D(I.rgb)*I.a))),I.a);}";var om="float A(vec3 B){return dot(B,vec3(0.299,0.587,0.114));}float C(float D,float E,float F){float G=(2.+(F*20.));return E/(1.+exp(G*(0.5-D)));}float H(float I,float J){return 1.-(1.-I)*(1.-J);}uniform sampler2D uSampler;varying vec2 vTextureCoord;void main(void){vec4 K=texture2D(uSampler,vTextureCoord);if(K.a==0.){gl_FragColor=vec4(0,0,0,0);return;}K.rgb/=K.a;float L=A(K.rgb);float M=C(L,0.77,0.59);L=H(M,L);gl_FragColor=vec4(vec3(L)*K.a,K.a);}";var nm="float A(vec3 B){return dot(B,vec3(0.299,0.587,0.114));}uniform sampler2D uSampler;varying vec2 vTextureCoord;void main(void){vec4 C=texture2D(uSampler,vTextureCoord);if(C.a==0.){gl_FragColor=vec4(0,0,0,0);return;}C.rgb/=C.a;float D=A(C.rgb);gl_FragColor=vec4(vec3(D)*C.a,C.a);}";var lm="float A(vec3 B){return float(B.b);}uniform sampler2D uSampler;varying vec2 vTextureCoord;void main(void){vec4 C=texture2D(uSampler,vTextureCoord);if(C.a==0.){gl_FragColor=vec4(0,0,0,0);return;}C.rgb/=C.a;gl_FragColor=vec4(vec3(A(C.rgb))*C.a,C.a);}";var cm="float A(vec3 B){return float(B.g);}uniform sampler2D uSampler;varying vec2 vTextureCoord;void main(void){vec4 C=texture2D(uSampler,vTextureCoord);if(C.a==0.){gl_FragColor=vec4(0,0,0,0);return;}C.rgb/=C.a;gl_FragColor=vec4(vec3(A(C.rgb))*C.a,C.a);}";var hm="float A(vec3 B){return float(B.r);}uniform sampler2D uSampler;varying vec2 vTextureCoord;void main(void){vec4 C=texture2D(uSampler,vTextureCoord);if(C.a==0.){gl_FragColor=vec4(0,0,0,0);return;}C.rgb/=C.a;gl_FragColor=vec4(vec3(A(C.rgb))*C.a,C.a);}";var um=class extends PIXI.Filter{constructor(e){let t=hm;switch(e){case BFN.CONST.BLACK_WHITE_PRESETS.PRESET_2:t=cm;break;case BFN.CONST.BLACK_WHITE_PRESETS.PRESET_3:t=lm;break;case BFN.CONST.BLACK_WHITE_PRESETS.PRESET_4:t=nm;break;case BFN.CONST.BLACK_WHITE_PRESETS.PRESET_5:t=om;break;case BFN.CONST.BLACK_WHITE_PRESETS.PRESET_6:case BFN.CONST.BLACK_WHITE_PRESETS.PRESET_7:t=sm;break;case BFN.CONST.BLACK_WHITE_PRESETS.PRESET_8:t=am;break}super(O,t);this.currentPreset=e,this.padding=0}apply(e,t,r,a){this.currentPreset==BFN.CONST.BLACK_WHITE_PRESETS.PRESET_8&&(this.uniforms.realWidth=r.destinationFrame.width/t.size.width,this.uniforms.realHeight=r.destinationFrame.height/t.size.height),e.applyFilter(this,t,r,a)}get color(){return this.uniforms.color}set color(e){e=BFN.FilterHelper.hex2rgb(e),this.uniforms.color=e}get mode(){return this.uniforms.mode}set mode(e){this.uniforms.mode=e}},dm=um;var mm="varying vec2 vTextureCoord;varying vec2 vMapCoord;uniform sampler2D uSampler;uniform sampler2D iChannel1;void main(){lowp vec4 A=texture2D(uSampler,vTextureCoord);if(A.a==0.){gl_FragColor=vec4(0,0,0,0);return;}A.rgb/=A.a;A.r=texture2D(iChannel1,vec2(A.r,0.)).r;A.g=texture2D(iChannel1,vec2(A.g,0.)).g;A.b=texture2D(iChannel1,vec2(A.b,0.)).b;A.rgb*=A.a;gl_FragColor=A;}";var pm=class extends PIXI.Filter{constructor(e,t,r){super(O,mm);this.padding=0,!(!e||!t||!r)&&this.doFilter(e,t,r)}doFilter(e,t,r){this.iChannel1=BFN.FilterHelper.GetCurvesTexture(e,t,r)}dispose(){try{this.iChannel1.destroyGC(!0)}catch(e){}this.iChannel1=null}apply(e,t,r,a){e.applyFilter(this,t,r,a)}get iChannel1(){return this.uniforms.iChannel1}set iChannel1(e){e!=null&&(e.baseTexture.isPowerOfTwo=!0,this.uniforms.iChannel1=e)}},fm=pm;var gm="float A(vec3 B,vec3 C){return dot(B,vec3(C.r,C.g,C.b));}varying vec2 vTextureCoord;uniform sampler2D uSampler;uniform float redAmount;uniform float greenAmount;uniform float blueAmount;void main(void){vec4 D=texture2D(uSampler,vTextureCoord);gl_FragColor=vec4(vec3(A(D.rgb,vec3(redAmount,greenAmount,blueAmount))),D.a);}";var vm=class extends PIXI.Filter{constructor(){super(O,gm);this.padding=0}get redAmount(){return this.uniforms.redAmount}set redAmount(e){this.uniforms.redAmount=e}get greenAmount(){return this.uniforms.greenAmount}set greenAmount(e){this.uniforms.greenAmount=e}get blueAmount(){return this.uniforms.blueAmount}set blueAmount(e){this.uniforms.blueAmount=e}},ym=vm;var xm="float A(vec3 B){return dot(B,vec3(0.299,0.587,0.114));}float C(float D,float E,float F){float G=(2.+(F*20.));return E/(1.+exp(G*(0.5-D)));}vec3 H(vec3 I,vec3 J){return 1.-(1.-I)*(1.-J);}varying vec2 vTextureCoord;uniform sampler2D uSampler;uniform sampler2D iChannel1;uniform sampler2D blurImage;uniform float clampX;uniform float clampY;void main(void){vec4 K=texture2D(uSampler,vTextureCoord);if(K.a==0.){gl_FragColor=vec4(0,0,0,0);return;}K.rgb/=K.a;vec4 L=texture2D(iChannel1,vTextureCoord*vec2(clampX,clampY));vec4 M=texture2D(blurImage,vTextureCoord*vec2(clampX,clampY));float N=C(A(M.rgb),0.55,0.74);vec3 O=clamp(H(vec3(N),K.rgb),0.,1.);vec3 P=clamp(L.rgb*O,0.,1.);P=P.bgr*K.a;gl_FragColor=vec4(P,K.a);}";var Tm="float A(float B,float C){return(B<0.5)?2.*B*C:1.-2.*(1.-B)*(1.-C);}vec3 D(vec3 B,vec3 C){vec3 E;E.r=A(B.r,C.r);E.g=A(B.g,C.g);E.b=A(B.b,C.b);return E;}vec3 F(vec3 G,vec3 H,vec3 I){float J=max(max(G.r,G.g),G.b);return H*J+I*(1.-J);}varying vec2 vTextureCoord;uniform sampler2D uSampler;uniform sampler2D iChannel1;uniform float clampX;uniform float clampY;void main(void){vec4 K=texture2D(uSampler,vTextureCoord);if(K.a==0.){gl_FragColor=vec4(0,0,0,0);return;}K.rgb/=K.a;vec4 L=texture2D(iChannel1,vTextureCoord*vec2(clampX,clampY));vec3 M=F(vec3(K.g),vec3(0.33,0.66,1.),vec3(0.04,0.,0.24));K.rgb=D(M,L.rgb)*K.a;gl_FragColor=K;}";var Fm="float A(float B,float C){return(((2.*B)==0.)?(2.*B):max((1.-((1.-C)/(2.*B))),0.));}vec3 D(vec3 B,vec3 C){vec3 E;E.r=A(B.r,C.r);E.g=A(B.g,C.g);E.b=A(B.b,C.b);return E;}varying vec2 vTextureCoord;uniform sampler2D uSampler;uniform sampler2D iChannel1;uniform float clampX;uniform float clampY;void main(void){vec4 F=texture2D(uSampler,vTextureCoord);if(F.a==0.){gl_FragColor=vec4(0,0,0,0);return;}F.rgb/=F.a;vec4 G=texture2D(iChannel1,vTextureCoord*vec2(clampX,clampY));float H=F.g;F.rgb=D(vec3(H),G.rgb)*F.a;gl_FragColor=F;}";var bm="float A(float B,float C){return(B<0.5)?2.*B*C:1.-2.*(1.-B)*(1.-C);}vec3 D(vec3 B,vec3 C){vec3 E;E.r=A(B.r,C.r);E.g=A(B.g,C.g);E.b=A(B.b,C.b);return E;}varying vec2 vTextureCoord;uniform sampler2D uSampler;uniform sampler2D iChannel1;uniform float clampX;uniform float clampY;void main(void){vec4 F=texture2D(uSampler,vTextureCoord);if(F.a==0.){gl_FragColor=vec4(0,0,0,0);return;}F.rgb/=F.a;vec4 G=texture2D(iChannel1,vTextureCoord*vec2(clampX,clampY));float H=F.b;F.rgb=D(vec3(H),G.rgb)*F.a;gl_FragColor=F;}";var Bm="float A(float B,float C){return(((2.*B)==0.)?(2.*B):max((1.-((1.-C)/(2.*B))),0.));}vec3 D(vec3 B,vec3 C){vec3 E;E.r=A(B.r,C.r);E.g=A(B.g,C.g);E.b=A(B.b,C.b);return E;}varying vec2 vTextureCoord;uniform sampler2D uSampler;uniform sampler2D iChannel1;uniform float clampX;uniform float clampY;void main(void){vec4 F=texture2D(uSampler,vTextureCoord);if(F.a==0.){gl_FragColor=vec4(0,0,0,0);return;}F.rgb/=F.a;vec4 G=texture2D(iChannel1,vTextureCoord*vec2(clampX,clampY));float H=F.b;F.rgb=D(vec3(H),G.rgb)*F.a;gl_FragColor=F;}";var Sm="float A(float B,float C){return(B<0.5)?2.*B*C:1.-2.*(1.-B)*(1.-C);}vec3 D(vec3 B,vec3 C){vec3 E;E.r=A(B.r,C.r);E.g=A(B.g,C.g);E.b=A(B.b,C.b);return E;}varying vec2 vTextureCoord;uniform sampler2D uSampler;uniform sampler2D iChannel1;uniform float clampX;uniform float clampY;void main(void){vec4 F=texture2D(uSampler,vTextureCoord);if(F.a==0.){gl_FragColor=vec4(0,0,0,0);return;}F.rgb/=F.a;vec4 G=texture2D(iChannel1,vTextureCoord*vec2(clampX,clampY));float H=F.b;F.rgb=D(vec3(H),G.rgb)*F.a;gl_FragColor=F;}";var Im=class extends PIXI.Filter{constructor(e){var t=Sm;switch(e){case BFN.CONST.CYANOTYPE_PRESETS.PRESET_2:t=Bm;break;case BFN.CONST.CYANOTYPE_PRESETS.PRESET_3:t=bm;break;case BFN.CONST.CYANOTYPE_PRESETS.PRESET_4:t=Fm;break;case BFN.CONST.CYANOTYPE_PRESETS.PRESET_5:t=Tm;break;case BFN.CONST.CYANOTYPE_PRESETS.PRESET_6:t=xm;break}super(O,t);this.currentPreset=e,this.padding=0}apply(e,t,r,a){let s=BFN.FilterHelper.calculateFilterClamp(t,r,this.blurImage||null);this.uniforms.clampX=s.x,this.uniforms.clampY=s.y,e.applyFilter(this,t,r,a)}get iChannel1(){return this.uniforms.iChannel1}set iChannel1(e){this.uniforms.iChannel1=e}get blurImage(){return this.uniforms.blurImage}set blurImage(e){e.baseTexture.isPowerOfTwo=!0,this.uniforms.blurImage=e}},_m=Im;var Cm="vec3 A(vec3 B,vec2 C,float D,float E,float F,float G){vec2 H=C-vec2(0.5*D,0.5*E);H.x*=E/D;float I=length(H);float J=E*(0.5+(1.-F)*0.5);float K=clamp(smoothstep(J,J-0.2,I),0.,1.);B*=mix(K,1.,G);return B;}varying vec2 vTextureCoord;uniform sampler2D uSampler;uniform sampler2D iChannel1;uniform float realWidth;uniform float realHeight;uniform float clampX;uniform float clampY;void main(void){vec4 L=texture2D(uSampler,vTextureCoord);vec4 M=texture2D(iChannel1,vTextureCoord*vec2(clampX,clampY));float N=A(vec3(1.),vTextureCoord,realWidth,realHeight,0.8,0.22).r;vec3 O=mix(M.rgb,L.rgb,vec3(N));gl_FragColor=vec4(O,L.a);}";var Em=class extends PIXI.Filter{constructor(){super(O,Cm);this.padding=0}apply(e,t,r,a){let s=BFN.FilterHelper.calculateFilterClamp(t,r);this.uniforms.clampX=s.x,this.uniforms.clampY=s.y,this.uniforms.realWidth=r.destinationFrame.width/t.size.width,this.uniforms.realHeight=r.destinationFrame.height/t.size.height,e.applyFilter(this,t,r,a)}get iChannel1(){return this.uniforms.iChannel1}set iChannel1(e){this.uniforms.iChannel1=e}},Pm=Em;var Nm="float A(vec3 B){return dot(B,vec3(0.299,0.587,0.114));}float C(float D,float E){return E/(1.-D);}vec3 F(vec3 G,vec3 H,vec3 I){float J=max(max(G.r,G.g),G.b);return H*J+I*(1.-J);}vec3 K(vec3 L,float M,float N){float O=L.r*0.309+L.g*0.609+L.b*0.082;float P=clamp(O-M,0.,1.)/clamp(abs(N-M),0.,1.);return vec3(clamp(vec3(P),0.,1.));}varying vec2 vTextureCoord;uniform sampler2D uSampler;uniform sampler2D blurSampler;uniform sampler2D textureSampler;uniform vec3 color1;uniform vec3 color2;uniform float detail_level;uniform float clampX;uniform float clampY;void main(void){vec4 Q=texture2D(uSampler,vTextureCoord);if(Q.a==0.){gl_FragColor=vec4(0,0,0,0);return;}Q.rgb/=Q.a;vec4 R=texture2D(blurSampler,vTextureCoord*vec2(clampX,clampY));vec4 S=texture2D(textureSampler,vTextureCoord*vec2(clampX,clampY));float T=A(Q.rgb);float U=clamp(1.-A(R.rgb),0.,1.);float V=C(U,T);vec3 W=K(vec3(V),detail_level,1.);vec3 X=clamp(F(W,color1,color2)*S.rgb,0.,1.);gl_FragColor=vec4(vec3(X)*Q.a,Q.a);}";var Mm=class extends PIXI.Filter{constructor(){super(O,Nm);this.padding=0}apply(e,t,r,a){let s=BFN.FilterHelper.calculateFilterClamp(t,r,this.blurImage||null);this.uniforms.clampX=s.x,this.uniforms.clampY=s.y,e.applyFilter(this,t,r,a)}get blurImage(){return this.uniforms.blurSampler}set blurImage(e){e.baseTexture.isPowerOfTwo=!0,this.uniforms.blurSampler=e}get textureSampler(){return this.uniforms.textureSampler}set textureSampler(e){this.uniforms.textureSampler=e}get color1(){return this.uniforms.color1}set color1(e){e=BFN.FilterHelper.hex2rgb(e),this.uniforms.color1=e}get color2(){return this.uniforms.color2}set color2(e){e=BFN.FilterHelper.hex2rgb(e),this.uniforms.color2=e}get detail_level(){return this.uniforms.detail_level}set detail_level(e){this.uniforms.detail_level=e}},Dm=Mm;var wm="float A(vec3 B){return dot(B,vec3(0.299,0.587,0.114));}vec3 C(vec3 B){float D=A(B);float E=min(min(B.r,B.g),B.b);float F=max(max(B.r,B.g),B.b);if(E<0.){max((B-D)*D/(D-E)+D,0.);}if(F>1.){min((B-D)*(1.-D)/(F-D)+D,1.);}return B;}float G(vec3 B){return dot(B,vec3(0.299,0.587,0.114));}vec3 H(vec3 B,float D){float I=D-G(B);B=B+vec3(I);return C(B);}float J(vec3 B){return dot(B,vec3(0.299,0.587,0.114));}vec3 K(vec3 L,vec3 M){return H(M,J(L));}varying vec2 vTextureCoord;uniform sampler2D uSampler;uniform vec3 color;uniform float amount;void main(void){vec4 N=texture2D(uSampler,vTextureCoord);if(N.a==0.){gl_FragColor=vec4(0,0,0,0);return;}N.rgb/=N.a;vec3 O=K(N.rgb,color);N.rgb=mix(N.rgb,O,amount);N.rgb*=N.a;gl_FragColor=N;}";var km=class extends PIXI.Filter{constructor(){super(O,wm);this.padding=0}get color(){return this.uniforms.color}set color(e){e=BFN.FilterHelper.hex2rgb(e),this.uniforms.color=e}get amount(){return this.uniforms.amount}set amount(e){this.uniforms.amount=e}},Am=km;var Om="float A(vec3 B){return dot(B,vec3(0.299,0.587,0.114));}vec3 C(vec3 D,vec3 E,vec3 F){float G=max(max(D.r,D.g),D.b);return E*G+F*(1.-G);}vec3 H(vec3 B){vec3 I=B/vec3(95.047,100,108.883);vec3 G;G.x=(I.x>0.008856)?pow(I.x,1./3.):(7.787*I.x)+(16./116.);G.y=(I.y>0.008856)?pow(I.y,1./3.):(7.787*I.y)+(16./116.);G.z=(I.z>0.008856)?pow(I.z,1./3.):(7.787*I.z)+(16./116.);return vec3((116.*G.y)-16.,500.*(G.x-G.y),200.*(G.y-G.z));}vec3 J(vec3 B){vec3 K;K.x=(B.r>0.04045)?pow((B.r+0.055)/1.055,2.4):B.r/12.92;K.y=(B.g>0.04045)?pow((B.g+0.055)/1.055,2.4):B.g/12.92,K.z=(B.b>0.04045)?pow((B.b+0.055)/1.055,2.4):B.b/12.92;return 100.*K*mat3(0.4124,0.3576,0.1805,0.2126,0.7152,0.0722,0.0193,0.1192,0.9505);}vec3 L(vec3 B){vec3 M=H(J(B));return vec3(M.x/100.,0.5+0.5*(M.y/127.),0.5+0.5*(M.z/127.));}vec3 N(vec3 B){float O=(B.x+16.)/116.;float P=B.y/500.+O;float Q=O-B.z/200.;return vec3(95.047*((P>0.206897)?P*P*P:(P-16./116.)/7.787),100.000*((O>0.206897)?O*O*O:(O-16./116.)/7.787),108.883*((Q>0.206897)?Q*Q*Q:(Q-16./116.)/7.787));}vec3 R(vec3 B){vec3 G=B/100.*mat3(3.2406,-1.5372,-0.4986,-0.9689,1.8758,0.0415,0.0557,-0.2040,1.0570);vec3 S;S.x=(G.r>0.0031308)?((1.055*pow(G.r,(1./2.4)))-0.055):12.92*G.r;S.y=(G.g>0.0031308)?((1.055*pow(G.g,(1./2.4)))-0.055):12.92*G.g;S.z=(G.b>0.0031308)?((1.055*pow(G.b,(1./2.4)))-0.055):12.92*G.b;return S;}vec3 T(vec3 B){return R(N(vec3(100.*B.x,2.*127.*(B.y-0.5),2.*127.*(B.z-0.5))));}vec3 U(vec3 V,vec3 W,float X){vec3 Y=L(V);vec3 Z=L(W);float a=mix(Z.r,Y.r,1.+X*1.5);vec3 b=T(vec3(a,Y.g,Y.b));return b;}varying vec2 vTextureCoord;uniform sampler2D uSampler;uniform sampler2D blurImage;uniform vec3 color1;uniform vec3 color2;uniform float clampX;uniform float clampY;uniform float bwmode;void main(void){vec4 c=texture2D(uSampler,vTextureCoord);if(c.a==0.){gl_FragColor=vec4(0,0,0,0);return;}c.rgb/=c.a;vec4 d=texture2D(blurImage,vTextureCoord*vec2(clampX,clampY));float e=A(c.rgb);if(bwmode==0.){e=c.r;}if(bwmode==2.){e=c.b;}c.rgb=C(vec3(e),color1,color2);c.rgb=U(c.rgb,d.rgb,0.1)*c.a;gl_FragColor=c;}";var Rm=class extends PIXI.Filter{constructor(){let e=O,t=Om;super(e,t);this.padding=0}apply(e,t,r,a){var s=BFN.FilterHelper.calculateFilterClamp(t,r,this.blurImage||null);this.uniforms.clampX=s.x,this.uniforms.clampY=s.y,e.applyFilter(this,t,r,a)}get color1(){return this.uniforms.color1}set color1(e){e=BFN.FilterHelper.hex2rgb(e),this.uniforms.color1=e}get color2(){return this.uniforms.color2}set color2(e){e=BFN.FilterHelper.hex2rgb(e),this.uniforms.color2=e}get blurImage(){return this.uniforms.blurImage}set blurImage(e){e.baseTexture.isPowerOfTwo=!0,this.uniforms.blurImage=e}get bwmode(){return this.uniforms.bwmode}set bwmode(e){this.uniforms.bwmode=e}},Lm=Rm;var Vm="vec3 A(vec3 B,float C){return pow(B,vec3(C));}vec3 D(vec3 E,vec3 F){return mix(2.*E*F,1.-2.*(1.-E)*(1.-F),step(0.5,F));}vec3 G(vec3 B,float H,float I){vec3 J=A(B,H);vec3 K=mix(vec3(0.5),J,I);return D(K,J);}float L(vec3 M){return dot(M,vec3(0.299,0.587,0.114));}vec3 N(vec3 E,vec3 F){return max(E,F);}vec3 O(vec3 E,vec3 F){return mix(2.*E*F,1.-2.*(1.-E)*(1.-F),step(0.5,F));}vec3 P(vec3 Q,vec2 R,float S,float T,float C,float H){vec2 U=R-vec2(0.5*S,0.5*T);U.x*=T/S;float V=length(U);float W=T*(0.5+(1.-C)*0.5);float X=clamp(smoothstep(W,W-0.2,V),0.,1.);Q*=mix(X,1.,H);return Q;}varying vec2 vTextureCoord;uniform sampler2D uSampler;uniform sampler2D iChannel1;uniform float clampX;uniform float clampY;uniform float realWidth;uniform float realHeight;void main(void){vec4 Y=texture2D(uSampler,vTextureCoord);if(Y.a==0.){gl_FragColor=vec4(0,0,0,0);return;}Y.rgb/=Y.a;vec4 Z=texture2D(iChannel1,vTextureCoord*vec2(clampX,clampY));vec3 a=G(Y.rgb,1.,0.6);vec3 b=N(Z.rgb,a);b=mix(a,b,0.55);vec3 c=O(vec3(L(Y.rgb)),b);c=mix(b,c,0.45);Y.rgb=P(c,vTextureCoord,realWidth,realHeight,0.55,0.)*Y.a;gl_FragColor=Y;}";var Um="vec3 A(vec3 B,float C){return pow(B,vec3(C));}vec3 D(vec3 E,vec3 F){return mix(2.*E*F,1.-2.*(1.-E)*(1.-F),step(0.5,F));}vec3 G(vec3 B,float H,float I){vec3 J=A(B,H);vec3 K=mix(vec3(0.5),J,I);return D(K,J);}float L(vec3 M){return dot(M,vec3(0.299,0.587,0.114));}vec3 N(vec3 E,vec3 F){return max(E,F);}vec3 O(vec3 E,vec3 F){return mix(2.*E*F,1.-2.*(1.-E)*(1.-F),step(0.5,F));}vec3 P(vec3 Q,vec2 R,float S,float T,float C,float H){vec2 U=R-vec2(0.5*S,0.5*T);U.x*=T/S;float V=length(U);float W=T*(0.5+(1.-C)*0.5);float X=clamp(smoothstep(W,W-0.2,V),0.,1.);Q*=mix(X,1.,H);return Q;}varying vec2 vTextureCoord;uniform sampler2D uSampler;uniform sampler2D iChannel1;uniform float clampX;uniform float clampY;uniform float realWidth;uniform float realHeight;void main(void){vec4 Y=texture2D(uSampler,vTextureCoord);if(Y.a==0.){gl_FragColor=vec4(0,0,0,0);return;}Y.rgb/=Y.a;vec4 Z=texture2D(iChannel1,vTextureCoord*vec2(clampX,clampY));vec3 a=G(Y.rgb,1.,0.6);vec3 b=N(Z.rgb,a);b=mix(a,b,0.55);vec3 c=O(vec3(L(Y.rgb)),b);c=mix(b,c,0.45);Y.rgb=P(c,vTextureCoord,realWidth,realHeight,0.55,0.)*Y.a;gl_FragColor=Y;}";var Gm="vec3 A(vec3 B,float C){return pow(B,vec3(C));}vec3 D(vec3 E,vec3 F){return mix(2.*E*F,1.-2.*(1.-E)*(1.-F),step(0.5,F));}vec3 G(vec3 B,float H,float I){vec3 J=A(B,H);vec3 K=mix(vec3(0.5),J,I);return D(K,J);}float L(vec3 M){return dot(M,vec3(0.299,0.587,0.114));}vec3 N(vec3 E,vec3 F){return 1.-(1.-E)*(1.-F);}vec3 O(vec3 E,vec3 F){return mix(2.*E*F,1.-2.*(1.-E)*(1.-F),step(0.5,F));}vec3 P(vec3 Q,vec2 R,float S,float T,float C,float H){vec2 U=R-vec2(0.5*S,0.5*T);U.x*=T/S;float V=length(U);float W=T*(0.5+(1.-C)*0.5);float X=clamp(smoothstep(W,W-0.2,V),0.,1.);Q*=mix(X,1.,H);return Q;}varying vec2 vTextureCoord;uniform sampler2D uSampler;uniform sampler2D iChannel1;uniform float clampX;uniform float clampY;uniform float realWidth;uniform float realHeight;void main(void){vec4 Y=texture2D(uSampler,vTextureCoord);if(Y.a==0.){gl_FragColor=vec4(0,0,0,0);return;}Y.rgb/=Y.a;vec4 Z=texture2D(iChannel1,vTextureCoord*vec2(clampX,clampY));vec3 a=mix(Y.rgb,vec3(L(Y.rgb)),0.6);a=G(a,1.,0.6);a=mix(a,Z.rgb,0.56);vec3 b=N(a,Y.rgb);b=mix(Y.rgb,b,0.7);Y.rgb=P(b,vTextureCoord,realWidth,realHeight,0.55,0.)*Y.a;gl_FragColor=Y;}";var Hm="vec3 A(vec3 B,float C){return pow(B,vec3(C));}vec3 D(vec3 E,vec3 F){return mix(2.*E*F,1.-2.*(1.-E)*(1.-F),step(0.5,F));}vec3 G(vec3 B,float H,float I){vec3 J=A(B,H);vec3 K=mix(vec3(0.5),J,I);return D(K,J);}float L(vec3 M){return dot(M,vec3(0.299,0.587,0.114));}vec3 N(vec3 E,vec3 F){return max(E,F);}vec3 O(vec3 E,vec3 F){return mix(2.*E*F,1.-2.*(1.-E)*(1.-F),step(0.5,F));}vec3 P(vec3 Q,vec2 R,float S,float T,float C,float H){vec2 U=R-vec2(0.5*S,0.5*T);U.x*=T/S;float V=length(U);float W=T*(0.5+(1.-C)*0.5);float X=clamp(smoothstep(W,W-0.2,V),0.,1.);Q*=mix(X,1.,H);return Q;}varying vec2 vTextureCoord;uniform sampler2D uSampler;uniform sampler2D iChannel1;uniform float clampX;uniform float clampY;uniform float realWidth;uniform float realHeight;void main(void){vec4 Y=texture2D(uSampler,vTextureCoord);if(Y.a==0.){gl_FragColor=vec4(0,0,0,0);return;}Y.rgb/=Y.a;vec4 Z=texture2D(iChannel1,vTextureCoord*vec2(clampX,clampY));vec3 a=G(Y.rgb,1.,0.6);vec3 b=N(Z.rgb,a);b=mix(a,b,0.55);vec3 c=O(vec3(L(Y.rgb)),b);c=mix(b,c,0.45);Y.rgb=P(c,vTextureCoord,realWidth,realHeight,0.55,0.)*Y.a;gl_FragColor=Y;}";var Xm="vec3 A(vec3 B,float C){return pow(B,vec3(C));}vec3 D(vec3 E,vec3 F){return mix(2.*E*F,1.-2.*(1.-E)*(1.-F),step(0.5,F));}vec3 G(vec3 B,float H,float I){vec3 J=A(B,H);vec3 K=mix(vec3(0.5),J,I);return D(K,J);}float L(vec3 M){return dot(M,vec3(0.299,0.587,0.114));}vec3 N(vec3 E,vec3 F){return max(E,F);}vec3 O(vec3 E,vec3 F){return mix(2.*E*F,1.-2.*(1.-E)*(1.-F),step(0.5,F));}vec3 P(vec3 Q,vec2 R,float S,float T,float C,float H){vec2 U=R-vec2(0.5*S,0.5*T);U.x*=T/S;float V=length(U);float W=T*(0.5+(1.-C)*0.5);float X=clamp(smoothstep(W,W-0.2,V),0.,1.);Q*=mix(X,1.,H);return Q;}varying vec2 vTextureCoord;uniform sampler2D uSampler;uniform sampler2D iChannel1;uniform float clampX;uniform float clampY;uniform float realWidth;uniform float realHeight;void main(void){vec4 Y=texture2D(uSampler,vTextureCoord);if(Y.a==0.){gl_FragColor=vec4(0,0,0,0);return;}Y.rgb/=Y.a;vec4 Z=texture2D(iChannel1,vTextureCoord*vec2(clampX,clampY));vec3 a=G(Y.rgb,1.,0.6);vec3 b=N(Z.rgb,a);b=mix(a,b,0.55);vec3 c=O(vec3(L(Y.rgb)),b);c=mix(b,c,0.45);Y.rgb=P(c,vTextureCoord,realWidth,realHeight,0.55,0.)*Y.a;gl_FragColor=Y;}";var zm="vec3 A(vec3 B,float C){return pow(B,vec3(C));}vec3 D(vec3 E,vec3 F){return mix(2.*E*F,1.-2.*(1.-E)*(1.-F),step(0.5,F));}vec3 G(vec3 B,float H,float I){vec3 J=A(B,H);vec3 K=mix(vec3(0.5),J,I);return D(K,J);}vec3 L(vec3 E,vec3 F){return(0.5-2.*(F-0.5)*(E-0.5));}vec3 M(vec3 E,vec3 F){vec3 N;N.r=(E.r>0.5)?(1.-(1.-F.r)*(1.-(E.r-0.5))):(F.r*(E.r+0.5));N.g=(E.g>0.5)?(1.-(1.-F.g)*(1.-(E.g-0.5))):(F.g*(E.g+0.5));N.b=(E.b>0.5)?(1.-(1.-F.b)*(1.-(E.b-0.5))):(F.b*(E.b+0.5));return N;}varying vec2 vTextureCoord;uniform sampler2D uSampler;void main(void){vec4 O=texture2D(uSampler,vTextureCoord);if(O.a==0.){gl_FragColor=vec4(0,0,0,0);return;}O.rgb/=O.a;vec3 P=vec3(0.87,0.60,0.51);vec3 Q=M(O.rgb,O.rgb);vec3 R=L(Q,vec3(0.027,0.,0.258));vec3 S=M(P,R);vec3 T=L(S,vec3(0.027,0.,0.26));O.rgb=M(O.rgb,T)*O.a;gl_FragColor=O;}";var Wm="vec3 A(vec3 B,float C){return pow(B,vec3(C));}vec3 D(vec3 E,vec3 F){return mix(2.*E*F,1.-2.*(1.-E)*(1.-F),step(0.5,F));}vec3 G(vec3 B,float H,float I){vec3 J=A(B,H);vec3 K=mix(vec3(0.5),J,I);return D(K,J);}vec3 L(vec3 E,vec3 F){return(0.5-2.*(F-0.5)*(E-0.5));}varying vec2 vTextureCoord;uniform sampler2D uSampler;void main(void){vec4 M=texture2D(uSampler,vTextureCoord);if(M.a==0.){gl_FragColor=vec4(0,0,0,0);return;}M.rgb/=M.a;M.rgb=G(M.rgb,1.,1.);M.rgb=L(M.rgb,vec3(0.243,0.,0.062))*M.a;gl_FragColor=M;}";var $m="vec3 A(vec3 B,float C){return pow(B,vec3(C));}vec3 D(vec3 E,vec3 F){return mix(2.*E*F,1.-2.*(1.-E)*(1.-F),step(0.5,F));}vec3 G(vec3 B,float H,float I){vec3 J=A(B,H);vec3 K=mix(vec3(0.5),J,I);return D(K,J);}vec3 L(vec3 E,vec3 F){return(0.5-2.*(F-0.5)*(E-0.5));}varying vec2 vTextureCoord;uniform sampler2D uSampler;void main(void){vec4 M=texture2D(uSampler,vTextureCoord);if(M.a==0.){gl_FragColor=vec4(0,0,0,0);return;}M.rgb/=M.a;M.rgb=G(M.rgb,1.,1.);M.rgb=L(M.rgb,vec3(0.,0.2,0.4))*M.a;gl_FragColor=M;}";var jm="vec3 A(vec3 B,float C){return pow(B,vec3(C));}vec3 D(vec3 E,vec3 F){return mix(2.*E*F,1.-2.*(1.-E)*(1.-F),step(0.5,F));}vec3 G(vec3 B,float H,float I){vec3 J=A(B,H);vec3 K=mix(vec3(0.5),J,I);return D(K,J);}vec3 L(vec3 E,vec3 F){return(0.5-2.*(F-0.5)*(E-0.5));}varying vec2 vTextureCoord;uniform sampler2D uSampler;void main(void){vec4 M=texture2D(uSampler,vTextureCoord);if(M.a==0.){gl_FragColor=vec4(0,0,0,0);return;}M.rgb/=M.a;M.rgb=G(M.rgb,1.,1.);M.rgb=L(M.rgb,vec3(0.027,0.,0.258))*M.a;gl_FragColor=M;}";var Ym=class extends PIXI.Filter{constructor(e){let t=jm;switch(e){case BFN.CONST.INSTANT_PRESETS.PRESET_2:t=$m;break;case BFN.CONST.INSTANT_PRESETS.PRESET_3:t=Wm;break;case BFN.CONST.INSTANT_PRESETS.PRESET_4:t=zm;break;case BFN.CONST.INSTANT_PRESETS.PRESET_5:t=Xm;break;case BFN.CONST.INSTANT_PRESETS.PRESET_6:t=Hm;break;case BFN.CONST.INSTANT_PRESETS.PRESET_10:t=Gm;break;case BFN.CONST.INSTANT_PRESETS.PRESET_11:t=Um;break;case BFN.CONST.INSTANT_PRESETS.PRESET_13:t=Vm;break}super(O,t);this.currentPreset=e,this.padding=0}apply(e,t,r,a){switch(this.currentPreset){case BFN.CONST.INSTANT_PRESETS.PRESET_5:case BFN.CONST.INSTANT_PRESETS.PRESET_6:case BFN.CONST.INSTANT_PRESETS.PRESET_10:case BFN.CONST.INSTANT_PRESETS.PRESET_11:case BFN.CONST.INSTANT_PRESETS.PRESET_13:let s=BFN.FilterHelper.calculateFilterClamp(t,r);this.uniforms.clampX=s.x,this.uniforms.clampY=s.y,this.uniforms.realWidth=r.destinationFrame.width/t.size.width,this.uniforms.realHeight=r.destinationFrame.height/t.size.height;break}e.applyFilter(this,t,r,a)}get iChannel1(){return this.uniforms.iChannel1}set iChannel1(e){this.uniforms.iChannel1=e}},qm=Ym;var Km="float A(vec3 B){return dot(B,vec3(0.299,0.587,0.114));}vec3 C(vec3 B){float D=A(B);float E=min(min(B.r,B.g),B.b);float F=max(max(B.r,B.g),B.b);if(E<0.){max((B-D)*D/(D-E)+D,0.);}if(F>1.){min((B-D)*(1.-D)/(F-D)+D,1.);}return B;}float G(vec3 B){return dot(B,vec3(0.299,0.587,0.114));}vec3 H(vec3 B,float D){float I=D-G(B);B=B+vec3(I);return C(B);}float J(vec3 B){return dot(B,vec3(0.299,0.587,0.114));}vec3 K(vec3 L,vec3 M){return H(M,J(L));}varying vec2 vTextureCoord;uniform sampler2D uSampler;uniform vec3 color;void main(void){vec4 N=texture2D(uSampler,vTextureCoord);if(N.a==0.){gl_FragColor=vec4(0,0,0,0);return;}N.rgb/=N.a;N.rgb=K(N.rgb,color)*N.a;gl_FragColor=N;}";var Jm=class extends PIXI.Filter{constructor(){let e=O,t=Km;super(e,t);this.padding=0}get color(){return this.uniforms.color}set color(e){e=BFN.FilterHelper.hex2rgb(e),this.uniforms.color=e}},Qm=Jm;var Zm="float A(vec3 B){return float(B.r);}float C(vec3 B){return float(B.g);}float D(vec3 B){return float(B.b);}vec3 E(vec3 F,vec3 G){return mix(2.*F*G,1.-2.*(1.-F)*(1.-G),step(0.5,G));}float H(vec3 B){return dot(B,vec3(0.299,0.587,0.114));}varying vec2 vTextureCoord;uniform sampler2D uSampler;uniform sampler2D iChannel1;uniform vec3 color;uniform float mode;uniform float clampX;uniform float clampY;void main(void){vec4 I=texture2D(uSampler,vTextureCoord);if(I.a==0.){gl_FragColor=vec4(0,0,0,0);return;}I.rgb/=I.a;vec4 J=texture2D(iChannel1,vTextureCoord*vec2(clampX,clampY));vec3 K=vec3((mode==0.)?A(I.rgb):((mode==1.)?H(I.rgb):D(I.rgb)));vec3 L=E(J.rgb,K);gl_FragColor=vec4(E(color,L)*I.a,I.a);}";var ep=class extends PIXI.Filter{constructor(){let e=O,t=Zm;super(e,t);this.padding=0}apply(e,t,r,a){var s=BFN.FilterHelper.calculateFilterClamp(t,r);this.uniforms.clampX=s.x,this.uniforms.clampY=s.y,e.applyFilter(this,t,r,a)}get iChannel1(){return this.uniforms.iChannel1}set iChannel1(e){this.uniforms.iChannel1=e}get color(){return this.uniforms.color}set color(e){e=BFN.FilterHelper.hex2rgb(e),this.uniforms.color=e}get mode(){return this.uniforms.mode}set mode(e){this.uniforms.mode=e}},tp=ep;var ip="uniform sampler2D uSampler;varying vec2 vTextureCoord;uniform float contrast;uniform float brightness;vec3 A(vec3 B,float C){return pow(B,vec3(C));}vec3 D(vec3 E,vec3 F){return mix(2.*E*F,1.-2.*(1.-E)*(1.-F),step(0.5,F));}vec3 G(vec3 B,float H,float I){vec3 J=A(B,H);vec3 K=mix(vec3(0.5),J,I);return D(K,J);}void main(void){vec4 L=texture2D(uSampler,vTextureCoord);L.rgb=G(L.rgb,brightness,contrast);gl_FragColor=L;}";var rp=class extends PIXI.Filter{constructor(){super(O,ip);this.padding=0}get brightness(){return this.uniforms.brightness}set brightness(e){this.uniforms.brightness=e}get contrast(){return this.uniforms.contrast}set contrast(e){this.uniforms.contrast=e}},ap=rp;var sp="varying vec2 vTextureCoord;uniform sampler2D uSampler;void main(void){vec4 A=texture2D(uSampler,vTextureCoord);gl_FragColor=A;}";var op="vec3 A(vec3 B,vec3 C,vec3 D){float E=max(max(B.r,B.g),B.b);return C*E+D*(1.-E);}vec4 F(sampler2D G,vec2 H,vec2 I,vec2 J,vec2 K,int L,int M,vec4 N){if(M==1){J=J/K;I=I/K;K=vec2(1.,1.);}float O=(((H.x*K.x)-I.x)/J.x);float P=(((H.y*K.y)-I.y)/J.y);if(L==0&&(O<0.||O>1.||P<0.||P>1.)){return N;}else{O=mod((mod(O,1.)+1.),1.);P=mod((mod(P,1.)+1.),1.);vec2 Q=vec2((O/K.x),(P/K.y));return texture2D(G,Q);}}varying vec2 vTextureCoord;uniform sampler2D uSampler;uniform sampler2D blurImage;uniform vec3 color1_1;uniform vec3 color1_2;uniform vec3 color2_1;uniform vec3 color2_2;uniform vec3 color3_1;uniform vec3 color3_2;uniform vec3 color4_1;uniform vec3 color4_2;uniform float clampX;uniform float clampY;void main(void){vec4 R=texture2D(uSampler,vTextureCoord);vec4 S=texture2D(blurImage,vTextureCoord*vec2(clampX,clampY));vec4 N=vec4(0.,0.,0.,0.);vec2 T=vec2(0.5,0.5);vec2 U=vec2(clampX,clampY);vec4 V=F(blurImage,vTextureCoord,vec2(0.,0.),T,U,0,1,N);vec4 W=F(blurImage,vTextureCoord,vec2(0.5,0.),T,U,0,1,N);vec4 X=F(blurImage,vTextureCoord,vec2(0.,0.5),T,U,0,1,N);vec4 Y=F(blurImage,vTextureCoord,vec2(0.5,0.5),T,U,0,1,N);vec4 Z=F(uSampler,vTextureCoord,vec2(0.,0.),T,U,0,0,N);vec4 a=F(uSampler,vTextureCoord,vec2(0.5,0.),T,U,0,0,N);vec4 b=F(uSampler,vTextureCoord,vec2(0.,0.5),T,U,0,0,N);vec4 c=F(uSampler,vTextureCoord,vec2(0.5,0.5),T,U,0,0,N);Z.rgb=mix(Z.rgb,A(V.rgb,color1_1,color1_2),0.6)*Z.a;a.rgb=mix(a.rgb,A(W.rgb,color2_1,color2_2),0.6)*a.a;b.rgb=mix(b.rgb,A(X.rgb,color3_1,color3_2),0.6)*b.a;c.rgb=mix(c.rgb,A(Y.rgb,color4_1,color4_2),0.6)*c.a;gl_FragColor=Z+a+b+c;}";var np="vec3 A(vec3 B,vec3 C,vec3 D){float E=max(max(B.r,B.g),B.b);return C*E+D*(1.-E);}varying vec2 vTextureCoord;uniform sampler2D uSampler;uniform sampler2D blurImage;uniform vec3 color1;uniform vec3 color2;uniform float clampX;uniform float clampY;void main(void){vec4 F=texture2D(uSampler,vTextureCoord);vec4 G=texture2D(blurImage,vTextureCoord*vec2(clampX,clampY));if(F.a==0.){gl_FragColor=vec4(0,0,0,0);return;}F.rgb/=F.a;if(G.a>0.){G.rgb/=G.a;}float H=G.b;vec3 I=A(vec3(H),color1,color2);F.rgb=mix(F.rgb,I,0.6)*F.a;gl_FragColor=F;}";var lp="varying vec2 vTextureCoord;uniform sampler2D uSampler;void main(void){vec4 A=texture2D(uSampler,vTextureCoord);gl_FragColor=A;}";var cp="vec3 A(vec3 B,float C){return pow(B,vec3(C));}vec3 D(vec3 B,float E,float F){vec3 G=A(B,E);vec3 H=((G-0.5)*F)+0.5;return H;}vec3 I(vec3 B,float C){return pow(B,vec3(C));}vec3 J(vec3 K,vec3 L){return mix(2.*K*L,1.-2.*(1.-K)*(1.-L),step(0.5,L));}vec3 M(vec3 B,float N,float O){vec3 G=I(B,N);vec3 H=mix(vec3(0.5),G,O);return J(H,G);}vec3 P(vec3 K,vec3 L){return mix(2.*K*L,1.-2.*(1.-K)*(1.-L),step(0.5,L));}float Q(vec3 R){return dot(R,vec3(0.299,0.587,0.114));}varying vec2 vTextureCoord;uniform sampler2D uSampler;void main(void){vec4 S=texture2D(uSampler,vTextureCoord);if(S.a==0.){gl_FragColor=vec4(0,0,0,0);return;}S.rgb/=S.a;vec3 T=D(S.rgb,1.5,0.66);T=M(T,1.,0.5);float U=Q(T);vec3 V=P(vec3(0.81,0.78,0.69),vec3(U));V=mix(vec3(U),V,0.85);gl_FragColor=vec4(V*S.a,S.a);}";var hp="vec3 A(vec3 B,float C){return pow(B,vec3(C));}vec3 D(vec3 E,vec3 F){return mix(2.*E*F,1.-2.*(1.-E)*(1.-F),step(0.5,F));}vec3 G(vec3 B,float H,float I){vec3 J=A(B,H);vec3 K=mix(vec3(0.5),J,I);return D(K,J);}vec3 L(vec3 E,vec3 F){return max(E,F);}vec3 M(vec3 E,vec3 F){return 1.-(1.-E)*(1.-F);}vec3 N(vec3 E,vec3 F){return mix(2.*E*F,1.-2.*(1.-E)*(1.-F),step(0.5,F));}varying vec2 vTextureCoord;uniform sampler2D uSampler;void main(void){vec4 O=texture2D(uSampler,vTextureCoord);if(O.a==0.){gl_FragColor=vec4(0,0,0,0);return;}O.rgb/=O.a;vec3 P=G(O.rgb,1.,1.);vec3 Q=vec3(0.42,0.27,0.53);vec3 R=vec3(0.32,0.05,0.51);vec3 S=M(O.rgb,P);S=mix(S,L(Q,S),0.73);S=mix(S,N(R,S),0.60);O.rgb=S*O.a;gl_FragColor=O;}";var up=class extends PIXI.Filter{constructor(e){let t=O,r=np,a=!1;switch(e){case BFN.CONST.VINTAGE_COLORS_PRESETS.PRESET_5:r=op;break;case BFN.CONST.VINTAGE_COLORS_PRESETS.PRESET_6:a=!0,r=hp;break;case BFN.CONST.VINTAGE_COLORS_PRESETS.PRESET_7:a=!0,r=cp;break;case BFN.CONST.VINTAGE_COLORS_PRESETS.PRESET_8:a=!0,r=lp;break;case BFN.CONST.VINTAGE_COLORS_PRESETS.PRESET_9:a=!0,r=sp;break}super(t,r);this.padding=0,this.currentPreset=e,this.isNoClamp=a}apply(e,t,r,a){if(this.isNoClamp==!1){var s=BFN.FilterHelper.calculateFilterClamp(t,r,this.blurImage||null);this.uniforms.clampX=s.x,this.uniforms.clampY=s.y}e.applyFilter(this,t,r,a)}get blurImage(){return this.uniforms.textureSampler}set blurImage(e){e.baseTexture.isPowerOfTwo=!0,this.uniforms.blurImage=e}get color1(){return this.uniforms.color1}set color1(e){e=BFN.FilterHelper.hex2rgb(e),this.uniforms.color1=e}get color2(){return this.uniforms.color2}set color2(e){e=BFN.FilterHelper.hex2rgb(e),this.uniforms.color2=e}get color1_1(){return this.uniforms.color1_1}set color1_1(e){e=BFN.FilterHelper.hex2rgb(e),this.uniforms.color1_1=e}get color1_2(){return this.uniforms.color1_2}set color1_2(e){e=BFN.FilterHelper.hex2rgb(e),this.uniforms.color1_2=e}get color2_1(){return this.uniforms.color2_1}set color2_1(e){e=BFN.FilterHelper.hex2rgb(e),this.uniforms.color2_1=e}get color2_2(){return this.uniforms.color2_2}set color2_2(e){e=BFN.FilterHelper.hex2rgb(e),this.uniforms.color2_2=e}get color3_1(){return this.uniforms.color3_1}set color3_1(e){e=BFN.FilterHelper.hex2rgb(e),this.uniforms.color3_1=e}get color3_2(){return this.uniforms.color3_2}set color3_2(e){e=BFN.FilterHelper.hex2rgb(e),this.uniforms.color3_2=e}get color4_1(){return this.uniforms.color4_1}set color4_1(e){e=BFN.FilterHelper.hex2rgb(e),this.uniforms.color4_1=e}get color4_2(){return this.uniforms.color4_2}set color4_2(e){e=BFN.FilterHelper.hex2rgb(e),this.uniforms.color4_2=e}},dp=up;var mp="float A(float B,float C){return C/(1.-B);}vec3 D(vec3 B,vec3 C){vec3 E;E.r=A(B.r,C.r);E.g=A(B.g,C.g);E.b=A(B.b,C.b);return E;}float F(float B,float C){return(((2.*B)==0.)?(2.*B):max((1.-((1.-C)/(2.*B))),0.));}vec3 G(vec3 B,vec3 C){vec3 E;E.r=F(B.r,C.r);E.g=F(B.g,C.g);E.b=F(B.b,C.b);return E;}vec4 H(sampler2D I,vec2 J,vec2 K,vec2 L,vec2 M,int N,int O,vec4 P){if(O==1){L=L/M;K=K/M;M=vec2(1.,1.);}float Q=(((J.x*M.x)-K.x)/L.x);float R=(((J.y*M.y)-K.y)/L.y);if(N==0&&(Q<0.||Q>1.||R<0.||R>1.)){return P;}else{Q=mod((mod(Q,1.)+1.),1.);R=mod((mod(R,1.)+1.),1.);vec2 S=vec2((Q/M.x),(R/M.y));return texture2D(I,S);}}varying vec2 vTextureCoord;uniform sampler2D uSampler;uniform sampler2D iChannel1;uniform float slide_right;uniform float slide_left;uniform float clampX;uniform float clampY;void main(void){vec4 T=texture2D(iChannel1,vTextureCoord*vec2(clampX,clampY));vec4 P=vec4(1.);vec2 U=vec2(1.,1.);vec2 V=vec2(clampX,clampY);vec4 W=H(uSampler,vTextureCoord,vec2(slide_left,0.05),U,V,1,0,P);vec4 X=H(uSampler,vTextureCoord,vec2(slide_right,0.07),U,V,1,0,P);X.rgb=D(W.rgb,X.rgb);X.rgb=G(X.rgb,T.rgb);gl_FragColor=X;}";var pp="float A(float B,float C){return(B<0.5)?2.*B*C:1.-2.*(1.-B)*(1.-C);}vec3 D(vec3 B,vec3 C){vec3 E;E.r=A(B.r,C.r);E.g=A(B.g,C.g);E.b=A(B.b,C.b);return E;}vec4 F(sampler2D G,vec2 H,vec2 I,vec2 J,vec2 K,int L,int M,vec4 N){if(M==1){J=J/K;I=I/K;K=vec2(1.,1.);}float O=(((H.x*K.x)-I.x)/J.x);float P=(((H.y*K.y)-I.y)/J.y);if(L==0&&(O<0.||O>1.||P<0.||P>1.)){return N;}else{O=mod((mod(O,1.)+1.),1.);P=mod((mod(P,1.)+1.),1.);vec2 Q=vec2((O/K.x),(P/K.y));return texture2D(G,Q);}}vec3 R(vec3 S,vec2 T,float U,float V,float W,float X){vec2 Y=T-vec2(0.5*U,0.5*V);Y.x*=V/U;float Z=length(Y);float a=V*(0.5+(1.-W)*0.5);float b=clamp(smoothstep(a,a-0.2,Z),0.,1.);S*=mix(b,1.,X);return S;}varying vec2 vTextureCoord;uniform sampler2D uSampler;uniform sampler2D iChannel1;uniform float slide_right;uniform float slide_left;uniform float vignette_amount;uniform float clampX;uniform float clampY;uniform float realWidth;uniform float realHeight;void main(void){vec4 c=texture2D(iChannel1,vTextureCoord*vec2(clampX,clampY));vec4 N=vec4(1.);vec2 d=vec2(1.,1.);vec2 e=vec2(clampX,clampY);vec4 f=F(uSampler,vTextureCoord,vec2(slide_right,0.07),d,e,0,0,N);vec4 g=F(uSampler,vTextureCoord,vec2(slide_left,0.05),d,e,1,0,N);g.rgb=D(g.rgb,f.rgb);g.rgb=clamp(c.rgb*g.rgb,0.,1.);g.rgb=R(g.rgb,vTextureCoord,realWidth,realHeight,vignette_amount,0.15);gl_FragColor=g;}";var fp="float A(float B,float C){return(B<0.5)?2.*B*C:1.-2.*(1.-B)*(1.-C);}vec3 D(vec3 B,vec3 C){vec3 E;E.r=A(B.r,C.r);E.g=A(B.g,C.g);E.b=A(B.b,C.b);return E;}vec4 F(sampler2D G,vec2 H,vec2 I,vec2 J,vec2 K,int L,int M,vec4 N){if(M==1){J=J/K;I=I/K;K=vec2(1.,1.);}float O=(((H.x*K.x)-I.x)/J.x);float P=(((H.y*K.y)-I.y)/J.y);if(L==0&&(O<0.||O>1.||P<0.||P>1.)){return N;}else{O=mod((mod(O,1.)+1.),1.);P=mod((mod(P,1.)+1.),1.);vec2 Q=vec2((O/K.x),(P/K.y));return texture2D(G,Q);}}varying vec2 vTextureCoord;uniform sampler2D uSampler;uniform float slide_vertical;uniform float slide_horizontal;uniform float clampX;uniform float clampY;void main(void){vec4 N=vec4(1.);vec2 R=vec2(1.,1.);vec2 S=vec2(clampX,clampY);vec4 T=F(uSampler,vTextureCoord,vec2(0.10,slide_vertical),R,S,0,0,N);vec4 U=F(uSampler,vTextureCoord,vec2(slide_horizontal,0.),R,S,1,0,N);vec4 V;V.rgb=D(U.rgb,T.rgb);V.a=1.;V=vec4(vec3(U.r,T.g,V.b),1.);gl_FragColor=V;}";var gp="float A(float B,float C){return(B<0.5)?2.*B*C:1.-2.*(1.-B)*(1.-C);}vec3 D(vec3 B,vec3 C){vec3 E;E.r=A(B.r,C.r);E.g=A(B.g,C.g);E.b=A(B.b,C.b);return E;}vec4 F(sampler2D G,vec2 H,vec2 I,vec2 J,vec2 K,int L,int M,vec4 N){if(M==1){J=J/K;I=I/K;K=vec2(1.,1.);}float O=(((H.x*K.x)-I.x)/J.x);float P=(((H.y*K.y)-I.y)/J.y);if(L==0&&(O<0.||O>1.||P<0.||P>1.)){return N;}else{O=mod((mod(O,1.)+1.),1.);P=mod((mod(P,1.)+1.),1.);vec2 Q=vec2((O/K.x),(P/K.y));return texture2D(G,Q);}}varying vec2 vTextureCoord;uniform sampler2D uSampler;uniform float slide_vertical;uniform float slide_horizontal;uniform float clampX;uniform float clampY;void main(void){vec4 N=vec4(1.);vec2 R=vec2(1.,1.);vec2 S=vec2(clampX,clampY);vec4 T=F(uSampler,vTextureCoord,vec2(slide_horizontal,slide_vertical),R,S,1,0,N);vec4 U=F(uSampler,vTextureCoord,vec2(0.10,0.10),R,S,1,0,N);U.rgb=D(T.rgb,U.rgb);gl_FragColor=U;}";var ko="float A(float B,float C){return(B<0.5)?2.*B*C:1.-2.*(1.-B)*(1.-C);}vec3 D(vec3 B,vec3 C){vec3 E;E.r=A(B.r,C.r);E.g=A(B.g,C.g);E.b=A(B.b,C.b);return E;}vec4 F(sampler2D G,vec2 H,vec2 I,vec2 J,vec2 K,int L,int M,vec4 N){if(M==1){J=J/K;I=I/K;K=vec2(1.,1.);}float O=(((H.x*K.x)-I.x)/J.x);float P=(((H.y*K.y)-I.y)/J.y);if(L==0&&(O<0.||O>1.||P<0.||P>1.)){return N;}else{O=mod((mod(O,1.)+1.),1.);P=mod((mod(P,1.)+1.),1.);vec2 Q=vec2((O/K.x),(P/K.y));return texture2D(G,Q);}}varying vec2 vTextureCoord;uniform sampler2D uSampler;uniform float slide_right;uniform float slide_left;uniform float clampX;uniform float clampY;void main(void){vec4 N=vec4(0.);vec2 R=vec2(1.,1.);vec2 S=vec2(clampX,clampY);vec4 T=F(uSampler,vTextureCoord,vec2(slide_left,0.),R,S,1,0,N);vec4 U=F(uSampler,vTextureCoord,vec2(slide_right,0.),R,S,1,0,N);T.rgb=T.rbb;U.rgb=U.brr;U.rgb=D(T.rgb,U.rgb);gl_FragColor=U;}";var vp=class extends PIXI.Filter{constructor(e){let t=ko;switch(e){case BFN.CONST.HOLGA_ART_PRESETS.PRESET_1:t=ko;break;case BFN.CONST.HOLGA_ART_PRESETS.PRESET_2:t=gp;break;case BFN.CONST.HOLGA_ART_PRESETS.PRESET_3:t=fp;break;case BFN.CONST.HOLGA_ART_PRESETS.PRESET_4:t=pp;break;case BFN.CONST.HOLGA_ART_PRESETS.PRESET_5:t=mp;break}super(O,t);this.padding=0,this.currentPreset=e}apply(e,t,r,a){let s=BFN.FilterHelper.calculateFilterClamp(t,r);switch(this.uniforms.clampX=s.x,this.uniforms.clampY=s.y,this.currentPreset){case BFN.CONST.HOLGA_ART_PRESETS.PRESET_4:this.uniforms.realWidth=r.destinationFrame.width/t.size.width,this.uniforms.realHeight=r.destinationFrame.height/t.size.height;break}e.applyFilter(this,t,r,a)}get iChannel1(){return this.uniforms.iChannel1}set iChannel1(e){this.uniforms.iChannel1=e}get slide_right(){return this.uniforms.slide_right}set slide_right(e){this.uniforms.slide_right=e}get slide_left(){return this.uniforms.slide_left}set slide_left(e){this.uniforms.slide_left=e}get slide_vertical(){return this.uniforms.slide_vertical}set slide_vertical(e){this.uniforms.slide_vertical=e}get slide_horizontal(){return this.uniforms.slide_horizontal}set slide_horizontal(e){this.uniforms.slide_horizontal=e}get vignette_amount(){return this.uniforms.vignette_amount}set vignette_amount(e){this.uniforms.vignette_amount=e}},yp=vp;var xp="vec3 A(vec3 B,vec3 C,vec3 D){float E=max(max(B.r,B.g),B.b);return C*E+D*(1.-E);}vec2 F(vec2 G,vec4 H){G*=H.xy;G+=H.zw;return G;}vec3 I(vec2 G,vec4 J,float K,float L,vec3 M,vec3 N){G=F(G,J);float O=radians(L);G*=mat2(cos(O),-sin(O),sin(O),cos(O));G.x=G.x/K;float P=mod(G.x,1.);P=(P<0.5)?P=pow(P,2.5)*2.:P=pow(1.-P,2.5)*1.;P=smoothstep(0.00+min(K/1250.,0.04),0.05,P);return A(vec3(P),N,M);}vec3 Q(vec3 B,float R){return pow(B,vec3(R));}vec3 S(vec3 B,float T,float U){vec3 V=Q(B,T);vec3 W=((V-0.5)*U)+0.5;return W;}float X(vec3 Y,float Z,float a){vec3 b=vec3(0.2125,0.7154,0.0721);float c=dot(Y,b);float d=smoothstep(max(Z-a,0.),min(Z+a,1.),c);return d;}vec3 e(vec3 B,vec3 C,vec3 D){float E=max(max(B.r,B.g),B.b);return C*E+D*(1.-E);}vec3 f(vec3 B,vec3 C,vec3 D){float E=max(max(B.r,B.g),B.b);return C*E+D*(1.-E);}vec3 g(vec2 G,vec3 h,vec3 i){float j;float k=12.9898;float l=151.7182;float m=43758.5453;float n=dot(G,vec2(k,l));float o=mod(n,3.14);float p=fract(sin(o)*m);return f(vec3(p),h,i);}float q(vec3 l){return dot(l,vec3(0.299,0.587,0.114));}varying vec2 vTextureCoord;uniform sampler2D uSampler;uniform sampler2D iChannel1;uniform float sketch_detail;uniform float line_width;uniform vec3 color;uniform vec4 filterArea;uniform float clampX;uniform float clampY;void main(void){vec4 r=texture2D(uSampler,vTextureCoord);if(r.a==0.){gl_FragColor=vec4(0,0,0,0);return;}r.rgb/=r.a;vec4 s=texture2D(iChannel1,vTextureCoord*vec2(clampX,clampY));vec3 t=I(vTextureCoord,filterArea,line_width,45.,vec3(0.5),vec3(1.));vec3 u=clamp(r.rgb*t,0.,1.);u=S(u,1.,1.8);vec3 v=vec3(X(u,sketch_detail/255.,0.1));v=e(v,vec3(1.),color);v=clamp(s.rgb*v,0.,1.);gl_FragColor=vec4(vec3(v)*r.a,r.a);}";var Tp="vec3 A(vec3 B,vec3 C,vec3 D){float E=max(max(B.r,B.g),B.b);return C*E+D*(1.-E);}vec2 F(vec2 G,vec4 H){G*=H.xy;G+=H.zw;return G;}vec3 I(vec2 G,vec4 J,float K,float L,vec3 M,vec3 N){G=F(G,J);float O=radians(L);G*=mat2(cos(O),-sin(O),sin(O),cos(O));G.x=G.x/K;float P=mod(G.x,1.);P=(P<0.5)?P=pow(P,2.5)*2.:P=pow(1.-P,2.5)*1.;P=smoothstep(0.00+min(K/1250.,0.04),0.05,P);return A(vec3(P),N,M);}vec3 Q(vec3 B,float R){return pow(B,vec3(R));}vec3 S(vec3 B,float T,float U){vec3 V=Q(B,T);vec3 W=((V-0.5)*U)+0.5;return W;}float X(vec3 Y,float Z,float a){vec3 b=vec3(0.2125,0.7154,0.0721);float c=dot(Y,b);float d=smoothstep(max(Z-a,0.),min(Z+a,1.),c);return d;}vec3 e(vec3 B,vec3 C,vec3 D){float E=max(max(B.r,B.g),B.b);return C*E+D*(1.-E);}vec3 f(vec3 B,vec3 C,vec3 D){float E=max(max(B.r,B.g),B.b);return C*E+D*(1.-E);}vec3 g(vec2 G,vec3 h,vec3 i){float j;float k=12.9898;float l=151.7182;float m=43758.5453;float n=dot(G,vec2(k,l));float o=mod(n,3.14);float p=fract(sin(o)*m);return f(vec3(p),h,i);}float q(vec3 l){return dot(l,vec3(0.299,0.587,0.114));}varying vec2 vTextureCoord;uniform sampler2D uSampler;uniform sampler2D iChannel1;uniform float sketch_detail;uniform float line_width;uniform vec3 color;uniform vec4 filterArea;uniform float clampX;uniform float clampY;void main(void){vec4 r=texture2D(uSampler,vTextureCoord);if(r.a==0.){gl_FragColor=vec4(0,0,0,0);return;}r.rgb/=r.a;vec4 s=texture2D(iChannel1,vTextureCoord*vec2(clampX,clampY));vec3 t=I(vTextureCoord,filterArea,line_width,45.,vec3(0.5),vec3(1.));vec3 u=clamp(r.rgb*t,0.,1.);u=S(u,1.,1.8);vec3 v=vec3(X(u,sketch_detail/255.,0.1));v=e(v,vec3(1.),color);v=clamp(s.rgb*v,0.,1.);gl_FragColor=vec4(vec3(v)*r.a,r.a);}";var Fp="vec3 A(vec3 B,vec3 C,vec3 D){float E=max(max(B.r,B.g),B.b);return C*E+D*(1.-E);}vec2 F(vec2 G,vec4 H){G*=H.xy;G+=H.zw;return G;}vec3 I(vec2 G,vec4 J,float K,float L,vec3 M,vec3 N){G=F(G,J);float O=radians(L);G*=mat2(cos(O),-sin(O),sin(O),cos(O));G.x=G.x/K;float P=mod(G.x,1.);P=(P<0.5)?P=pow(P,2.5)*2.:P=pow(1.-P,2.5)*1.;P=smoothstep(0.00+min(K/1250.,0.04),0.05,P);return A(vec3(P),N,M);}vec3 Q(vec3 B,float R){return pow(B,vec3(R));}vec3 S(vec3 B,float T,float U){vec3 V=Q(B,T);vec3 W=((V-0.5)*U)+0.5;return W;}float X(vec3 Y,float Z,float a){vec3 b=vec3(0.2125,0.7154,0.0721);float c=dot(Y,b);float d=smoothstep(max(Z-a,0.),min(Z+a,1.),c);return d;}vec3 e(vec3 B,vec3 C,vec3 D){float E=max(max(B.r,B.g),B.b);return C*E+D*(1.-E);}vec3 f(vec3 B,vec3 C,vec3 D){float E=max(max(B.r,B.g),B.b);return C*E+D*(1.-E);}vec3 g(vec2 G,vec3 h,vec3 i){float j;float k=12.9898;float l=151.7182;float m=43758.5453;float n=dot(G,vec2(k,l));float o=mod(n,3.14);float p=fract(sin(o)*m);return f(vec3(p),h,i);}float q(vec3 l){return dot(l,vec3(0.299,0.587,0.114));}varying vec2 vTextureCoord;uniform sampler2D uSampler;uniform float sketch_detail;uniform float line_width;uniform float line_angle;uniform vec3 color;uniform vec4 filterArea;void main(void){vec4 r=texture2D(uSampler,vTextureCoord);if(r.a==0.){gl_FragColor=vec4(0,0,0,0);return;}r.rgb/=r.a;vec3 s=I(vTextureCoord,filterArea,line_width,line_angle,vec3(0.5),vec3(1.));vec3 t=clamp(r.rgb*s,0.,1.);t=S(t,1.,1.8);vec3 u=vec3(X(t,sketch_detail/255.,0.1));u=e(u,vec3(1.),color);gl_FragColor=vec4(vec3(u)*r.a,r.a);}";var Ao="vec3 A(vec3 B,vec3 C,vec3 D){float E=max(max(B.r,B.g),B.b);return C*E+D*(1.-E);}vec2 F(vec2 G,vec4 H){G*=H.xy;G+=H.zw;return G;}vec3 I(vec2 G,vec4 J,float K,float L,vec3 M,vec3 N){G=F(G,J);float O=radians(L);G*=mat2(cos(O),-sin(O),sin(O),cos(O));G.x=G.x/K;float P=mod(G.x,1.);P=(P<0.5)?P=pow(P,2.5)*2.:P=pow(1.-P,2.5)*1.;P=smoothstep(0.00+min(K/1250.,0.04),0.05,P);return A(vec3(P),N,M);}vec3 Q(vec3 B,float R){return pow(B,vec3(R));}vec3 S(vec3 B,float T,float U){vec3 V=Q(B,T);vec3 W=((V-0.5)*U)+0.5;return W;}float X(vec3 Y,float Z,float a){vec3 b=vec3(0.2125,0.7154,0.0721);float c=dot(Y,b);float d=smoothstep(max(Z-a,0.),min(Z+a,1.),c);return d;}vec3 e(vec3 B,vec3 C,vec3 D){float E=max(max(B.r,B.g),B.b);return C*E+D*(1.-E);}vec3 f(vec3 B,vec3 C,vec3 D){float E=max(max(B.r,B.g),B.b);return C*E+D*(1.-E);}vec3 g(vec2 G,vec3 h,vec3 i){float j;float k=12.9898;float l=151.7182;float m=43758.5453;float n=dot(G,vec2(k,l));float o=mod(n,3.14);float p=fract(sin(o)*m);return f(vec3(p),h,i);}float q(vec3 l){return dot(l,vec3(0.299,0.587,0.114));}varying vec2 vTextureCoord;uniform sampler2D uSampler;uniform float sketch_detail;uniform float line_width;uniform float line_angle;uniform vec3 color;uniform vec4 filterArea;void main(void){vec4 r=texture2D(uSampler,vTextureCoord);if(r.a==0.){gl_FragColor=vec4(0,0,0,0);return;}r.rgb/=r.a;vec3 s=I(vTextureCoord,filterArea,line_width,line_angle,vec3(0.5),vec3(1.));vec3 t=clamp(r.rgb*s,0.,1.);t=S(t,1.,1.8);vec3 u=vec3(X(t,sketch_detail/255.,0.1));u=e(u,vec3(1.),color);vec3 v=g(vTextureCoord,vec3(0.),vec3(1.));v=mix(vec3(q(r.rgb)),v,0.6);vec3 w=e(v,vec3(1.,0.8,0.29),vec3(1.,1.,0.74));w=clamp(w*u,0.,1.);gl_FragColor=vec4(vec3(w)*r.a,r.a);}";var bp=class extends PIXI.Filter{constructor(e){let t=Ao,r=!0;switch(e){case BFN.CONST.LINE_ARTOPIA_PRESETS.PRESET_1:t=Ao;break;case BFN.CONST.LINE_ARTOPIA_PRESETS.PRESET_2:t=Fp;break;case BFN.CONST.LINE_ARTOPIA_PRESETS.PRESET_3:r=!1,t=Tp;break;case BFN.CONST.LINE_ARTOPIA_PRESETS.PRESET_4:r=!1,t=xp;break}super(O,t);this.currentPreset=e,this.isNoClamp=r,this.padding=0}apply(e,t,r,a){if(this.isNoClamp==!1){let s=BFN.FilterHelper.calculateFilterClamp(t,r);this.uniforms.clampX=s.x,this.uniforms.clampY=s.y}e.applyFilter(this,t,r,a)}get iChannel1(){return this.uniforms.iChannel1}set iChannel1(e){this.uniforms.iChannel1=e}get color(){return this.uniforms.color}set color(e){e=BFN.FilterHelper.hex2rgb(e),this.uniforms.color=e}get sketch_detail(){return this.uniforms.sketch_detail}set sketch_detail(e){this.uniforms.sketch_detail=e}get line_width(){return this.uniforms.line_width}set line_width(e){this.uniforms.line_width=e}get line_angle(){return this.uniforms.line_angle}set line_angle(e){this.uniforms.line_angle=e}},Bp=bp;var Sp="varying vec2 vTextureCoord;uniform sampler2D uSampler;uniform sampler2D iChannel1;uniform float clampX;uniform float clampY;void main(void){vec4 A=texture2D(uSampler,vTextureCoord);vec4 B=texture2D(iChannel1,vTextureCoord*vec2(clampX,clampY));gl_FragColor=A;}";var Ip=class extends PIXI.Filter{constructor(){super(O,Sp);this.padding=0}apply(e,t,r,a){let s=BFN.FilterHelper.calculateFilterClamp(t,r);this.uniforms.clampX=s.x,this.uniforms.clampY=s.y,e.applyFilter(this,t,r,a)}get iChannel1(){return this.uniforms.iChannel1}set iChannel1(e){this.uniforms.iChannel1=e}},_p=Ip;var Cp="uniform sampler2D uSampler;varying vec2 vTextureCoord;uniform float strength;uniform float angleDegree;uniform float clampX;uniform float clampY;uniform vec4 filterArea;const float A=9.;void main(void){float B=radians(angleDegree);vec2 C=vec2(A/filterArea.xy);vec2 D=vec2(C.x*cos(B),C.y*sin(B));int E=int(floor((A-1.)/2.));vec4 F=vec4(0.),G=vec4(0.);vec2 H=vTextureCoord,I=-D;for(int J=0;J<int(A);J++){F+=texture2D(uSampler,clamp(H+I*strength,vec2(0.,0.),vec2(clampX,clampY)));I+=D/float(E);}G=F/A;gl_FragColor=G;}";var Ep=class extends PIXI.Filter{constructor(){super(O,Cp);this.padding=0,this.angleDegree=90,this.strength=1}apply(e,t,r,a){let s=BFN.FilterHelper.calculateFilterClamp(t,r);this.uniforms.clampX=1/s.x,this.uniforms.clampY=1/s.y,e.applyFilter(this,t,r,a)}get angleDegree(){return this.uniforms.angleDegree}set angleDegree(e){this.uniforms.angleDegree=e}get strength(){return this.uniforms.strength}set strength(e){this.uniforms.strength=e}},Pp=Ep;var Np="varying vec2 vTextureCoord;uniform sampler2D uSampler;uniform float brightness;uniform float sharpness;uniform float mode;void main(void){vec4 A=texture2D(uSampler,vTextureCoord);vec3 B=(mode==1.)?A.rgb:vec3(dot(A.rgb,vec3(0.299,0.587,0.114)));vec3(dot(A.rgb,vec3(0.299,0.587,0.114)));float C=(2.+(sharpness*20.));A.rgb=vec3(brightness/(1.+exp(C*(0.5-B))));gl_FragColor=A;}";var Mp=class extends PIXI.Filter{constructor(){super(O,Np);this.padding=0,this.mode=0}get brightness(){return this.uniforms.brightness}set brightness(e){this.uniforms.brightness=e}get sharpness(){return this.uniforms.sharpness}set sharpness(e){this.uniforms.sharpness=e}get mode(){return this.uniforms.mode}set mode(e){this.uniforms.mode=e}},Dp=Mp;var wp="varying vec2 vTextureCoord;uniform sampler2D uSampler;uniform int mode;void main(void){vec4 A=texture2D(uSampler,vTextureCoord);A.rgb=(mode==1)?A.bgr:(mode==2)?A.gbr:(mode==3)?A.gbb:(mode==4)?A.gbb:(mode==5)?A.brr:(mode==6)?A.rbb:(mode==7)?A.bgb:(mode==8)?A.bgg:A.bgr;gl_FragColor=A;}";var kp=class extends PIXI.Filter{constructor(){super(O,wp);this.padding=0}get mode(){return this.uniforms.mode}set mode(e){this.uniforms.mode=e}},Ap=kp;var Op="vec2 A(vec2 B,vec4 C){B*=C.xy;B+=C.zw;return B;}vec2 D(vec2 B,vec4 C){B-=C.zw;B/=C.xy;return B;}vec4 E(sampler2D F,vec2 G,vec4 H,vec2 I,vec2 J,float K){float L=3.14159265258979;vec2 B=A(G,H);vec2 M=vec2(J.x*I.x,J.y*I.y);float N=J.x;vec2 O;vec2 P=B-M;float distance=length(P);if(distance<N){vec2 Q=M+(P/K);float R=distance/N;float S=(cos(R*L)+1.)/2.;O=Q*(S)+B*(1.-S);}else{O=B;}B=D(O,H);return texture2D(F,B);}uniform sampler2D uSampler;varying vec2 vTextureCoord;uniform float radius;uniform float resolutionX;uniform float resolutionY;uniform vec4 filterArea;uniform vec2 centerPoint;void main(void){gl_FragColor=E(uSampler,vTextureCoord,filterArea,centerPoint,vec2(resolutionX,resolutionY),radius);}";var Rp=class extends PIXI.Filter{constructor(){super(O,Op);this.padding=0,this.radius=1.5,this.centerPoint=[.5,.5]}apply(e,t,r,a){this.uniforms.resolutionX=r.destinationFrame.width,this.uniforms.resolutionY=r.destinationFrame.height,e.applyFilter(this,t,r,a)}get centerPoint(){return this.uniforms.centerPoint}set centerPoint(e){this.uniforms.centerPoint=e}get radius(){return this.uniforms.radius}set radius(e){this.uniforms.radius=e}},Lp=Rp;var Vp="vec3 A(vec3 B,vec3 C,vec3 D){float E=max(max(B.r,B.g),B.b);return C*E+D*(1.-E);}vec3 F(vec2 G,vec3 H,vec3 I){float J;float K=12.9898;float L=151.7182;float M=43758.5453;float N=dot(G,vec2(K,L));float O=mod(N,3.14);float P=fract(sin(O)*M);return A(vec3(P),H,I);}uniform sampler2D uSampler;varying vec2 vTextureCoord;uniform vec3 duocolor1;uniform vec3 duocolor2;void main(void){gl_FragColor=vec4(F(vTextureCoord,duocolor1,duocolor2),1.);}";var Up=class extends PIXI.Filter{constructor(){super(O,Vp);this.padding=0}get duocolor1(){return this.uniforms.duocolor1}set duocolor1(e){e=BFN.FilterHelper.hex2rgb(e),this.uniforms.duocolor1=e}get duocolor2(){return this.uniforms.duocolor2}set duocolor2(e){e=BFN.FilterHelper.hex2rgb(e),this.uniforms.duocolor2=e}},Gp=Up;var Hp="float A(vec3 B){return dot(B,vec3(0.299,0.587,0.114));}vec3 C(vec3 D,vec3 E,vec3 F){float G=max(max(D.r,D.g),D.b);return E*G+F*(1.-G);}vec3 H(vec3 I,vec3 J){vec3 K;K.r=(I.r>0.5)?(1.-(1.-J.r)*(1.-(I.r-0.5))):(J.r*(I.r+0.5));K.g=(I.g>0.5)?(1.-(1.-J.g)*(1.-(I.g-0.5))):(J.g*(I.g+0.5));K.b=(I.b>0.5)?(1.-(1.-J.b)*(1.-(I.b-0.5))):(J.b*(I.b+0.5));return K;}float L(vec3 M,float N,float O){vec3 P=vec3(0.2125,0.7154,0.0721);float Q=dot(M,P);float R=smoothstep(max(N-O,0.),min(N+O,1.),Q);return R;}vec3 S(vec3 M,vec2 T,vec2 U,float V){vec2 W=T*U;W=W*2.-1.;float X=sqrt(pow(abs(W.x),10.)+pow(abs(W.y),10.));X=smoothstep(0.,1.-V,X);return mix(M,vec3(1.),X);}varying vec2 vTextureCoord;uniform sampler2D uSampler;uniform sampler2D textureSampler;uniform float detail_level;uniform float clampX;uniform float clampY;void main(void){vec4 Y=texture2D(uSampler,vTextureCoord);if(Y.a==0.){gl_FragColor=vec4(0,0,0,0);return;}Y.rgb/=Y.a;vec4 Z=texture2D(textureSampler,vTextureCoord*vec2(clampX,clampY));float a=A(Y.rgb);vec3 b=vec3(L(Y.rgb,detail_level,0.1));b=C(b,vec3(1.),vec3(0.));b=S(b,vTextureCoord,vec2(clampX,clampY),0.35);b=H(b,Z.rgb);gl_FragColor=vec4(vec3(b)*Y.a,Y.a);}";var Xp="float A(vec3 B){return dot(B,vec3(0.299,0.587,0.114));}vec3 C(vec3 D,vec3 E,vec3 F){float G=max(max(D.r,D.g),D.b);return E*G+F*(1.-G);}float H(float I,float J){return(I<0.5)?2.*I*J:1.-2.*(1.-I)*(1.-J);}vec3 K(vec3 I,vec3 J){vec3 L;L.r=H(I.r,J.r);L.g=H(I.g,J.g);L.b=H(I.b,J.b);return L;}float M(vec3 N,float O,float P){vec3 Q=vec3(0.2125,0.7154,0.0721);float R=dot(N,Q);float S=smoothstep(max(O-P,0.),min(O+P,1.),R);return S;}vec3 T(vec3 N,vec2 U,vec2 V,float W){vec2 X=U*V;X=X*2.-1.;float Y=sqrt(pow(abs(X.x),10.)+pow(abs(X.y),10.));Y=smoothstep(0.,1.-W,Y);return mix(N,vec3(1.),Y);}varying vec2 vTextureCoord;uniform sampler2D uSampler;uniform sampler2D textureSampler;uniform float detail_level;uniform float clampX;uniform float clampY;void main(void){vec4 Z=texture2D(uSampler,vTextureCoord);if(Z.a==0.){gl_FragColor=vec4(0,0,0,0);return;}Z.rgb/=Z.a;vec4 a=texture2D(textureSampler,vTextureCoord*vec2(clampX,clampY));float b=A(Z.rgb);vec3 c=vec3(M(Z.rgb,detail_level,0.1));c=1.-T(c,vTextureCoord,vec2(clampX,clampY),0.35);c=C(c,vec3(1.),vec3(0.28));c=K(c,a.rgb);gl_FragColor=vec4(vec3(c)*Z.a,Z.a);}";var zp="float A(vec3 B){return dot(B,vec3(0.299,0.587,0.114));}vec3 C(vec3 D,vec3 E,vec3 F){float G=max(max(D.r,D.g),D.b);return E*G+F*(1.-G);}vec3 H(vec3 I,vec3 J){vec3 K;K.r=(I.r>0.5)?(1.-(1.-J.r)*(1.-(I.r-0.5))):(J.r*(I.r+0.5));K.g=(I.g>0.5)?(1.-(1.-J.g)*(1.-(I.g-0.5))):(J.g*(I.g+0.5));K.b=(I.b>0.5)?(1.-(1.-J.b)*(1.-(I.b-0.5))):(J.b*(I.b+0.5));return K;}float L(vec3 M,float N,float O){vec3 P=vec3(0.2125,0.7154,0.0721);float Q=dot(M,P);float R=smoothstep(max(N-O,0.),min(N+O,1.),Q);return R;}vec3 S(vec3 M,vec2 T,vec2 U,float V){vec2 W=T*U;W=W*2.-1.;float X=sqrt(pow(abs(W.x),10.)+pow(abs(W.y),10.));X=smoothstep(0.,1.-V,X);return mix(M,vec3(1.),X);}varying vec2 vTextureCoord;uniform sampler2D uSampler;uniform sampler2D textureSampler;uniform float detail_level;uniform float clampX;uniform float clampY;void main(void){vec4 Y=texture2D(uSampler,vTextureCoord);if(Y.a==0.){gl_FragColor=vec4(0,0,0,0);return;}Y.rgb/=Y.a;vec4 Z=texture2D(textureSampler,vTextureCoord*vec2(clampX,clampY));float a=A(Y.rgb);vec3 b=vec3(L(Y.rgb,detail_level,0.1));b=C(b,vec3(1.),vec3(0.));b=1.-S(b,vTextureCoord,vec2(clampX,clampY),0.35);b=H(b,Z.rgb);gl_FragColor=vec4(vec3(b)*Y.a,Y.a);}";var Wp="float A(vec3 B){return dot(B,vec3(0.299,0.587,0.114));}vec3 C(vec3 D,vec3 E,vec3 F){float G=max(max(D.r,D.g),D.b);return E*G+F*(1.-G);}vec3 H(vec3 I,vec3 J){vec3 K;K.r=(I.r>0.5)?(1.-(1.-J.r)*(1.-(I.r-0.5))):(J.r*(I.r+0.5));K.g=(I.g>0.5)?(1.-(1.-J.g)*(1.-(I.g-0.5))):(J.g*(I.g+0.5));K.b=(I.b>0.5)?(1.-(1.-J.b)*(1.-(I.b-0.5))):(J.b*(I.b+0.5));return K;}float L(vec3 M,float N,float O){vec3 P=vec3(0.2125,0.7154,0.0721);float Q=dot(M,P);float R=smoothstep(max(N-O,0.),min(N+O,1.),Q);return R;}vec3 S(vec3 M,vec2 T,vec2 U,float V){vec2 W=T*U;W=W*2.-1.;float X=sqrt(pow(abs(W.x),10.)+pow(abs(W.y),10.));X=smoothstep(0.,1.-V,X);return mix(M,vec3(1.),X);}varying vec2 vTextureCoord;uniform sampler2D uSampler;uniform sampler2D textureSampler;uniform float detail_level;uniform float clampX;uniform float clampY;void main(void){vec4 Y=texture2D(uSampler,vTextureCoord);if(Y.a==0.){gl_FragColor=vec4(0,0,0,0);return;}Y.rgb/=Y.a;vec4 Z=texture2D(textureSampler,vTextureCoord*vec2(clampX,clampY));float a=A(Y.rgb);vec3 b=vec3(L(Y.rgb,detail_level,0.1));b=C(b,vec3(1.),vec3(0.));b=S(b,vTextureCoord,vec2(clampX,clampY),0.35);b=H(b,Z.rgb);gl_FragColor=vec4(vec3(b)*Y.a,Y.a);}";var $p="float A(vec3 B){return dot(B,vec3(0.299,0.587,0.114));}vec3 C(vec3 D,vec3 E,vec3 F){float G=max(max(D.r,D.g),D.b);return E*G+F*(1.-G);}vec3 H(vec3 I,vec3 J){vec3 K;K.r=(I.r>0.5)?(1.-(1.-J.r)*(1.-(I.r-0.5))):(J.r*(I.r+0.5));K.g=(I.g>0.5)?(1.-(1.-J.g)*(1.-(I.g-0.5))):(J.g*(I.g+0.5));K.b=(I.b>0.5)?(1.-(1.-J.b)*(1.-(I.b-0.5))):(J.b*(I.b+0.5));return K;}float L(vec3 M,float N,float O){vec3 P=vec3(0.2125,0.7154,0.0721);float Q=dot(M,P);float R=smoothstep(max(N-O,0.),min(N+O,1.),Q);return R;}vec3 S(vec3 M,vec2 T,vec2 U,float V){vec2 W=T*U;W=W*2.-1.;float X=sqrt(pow(abs(W.x),10.)+pow(abs(W.y),10.));X=smoothstep(0.,1.-V,X);return mix(M,vec3(1.),X);}varying vec2 vTextureCoord;uniform sampler2D uSampler;uniform sampler2D textureSampler;uniform float detail_level;uniform float clampX;uniform float clampY;void main(void){vec4 Y=texture2D(uSampler,vTextureCoord);if(Y.a==0.){gl_FragColor=vec4(0,0,0,0);return;}Y.rgb/=Y.a;vec4 Z=texture2D(textureSampler,vTextureCoord*vec2(clampX,clampY));float a=A(Y.rgb);vec3 b=vec3(L(Y.rgb,detail_level,0.1));b=C(b,vec3(1.),vec3(0.));b=S(b,vTextureCoord,vec2(clampX,clampY),0.35);b=H(b,Z.rgb);gl_FragColor=vec4(vec3(b)*Y.a,Y.a);}";var jp="float A(vec3 B){return dot(B,vec3(0.299,0.587,0.114));}float C(float D,float E){return(D<0.5)?2.*D*E:1.-2.*(1.-D)*(1.-E);}vec3 F(vec3 D,vec3 E){vec3 G;G.r=C(D.r,E.r);G.g=C(D.g,E.g);G.b=C(D.b,E.b);return G;}vec3 H(vec3 I,vec2 J,vec2 K,float L){vec2 M=J*K;M=M*2.-1.;float N=sqrt(pow(abs(M.x),10.)+pow(abs(M.y),10.));N=smoothstep(0.,1.-L,N);return mix(I,vec3(1.),N);}vec3 O(vec3 I,float P,float Q){I=I*Q;return floor(I*floor(float(P)))/floor(float(P));}varying vec2 vTextureCoord;uniform sampler2D uSampler;uniform sampler2D textureSampler;uniform sampler2D blurSampler;uniform float color_detail;uniform float clampX;uniform float clampY;void main(void){vec4 R=texture2D(uSampler,vTextureCoord);if(R.a==0.){gl_FragColor=vec4(0,0,0,0);return;}R.rgb/=R.a;vec4 S=texture2D(textureSampler,vTextureCoord*vec2(clampX,clampY));vec4 T=texture2D(blurSampler,vTextureCoord*vec2(clampX,clampY));vec3 U=O(T.rgb,color_detail,1.);U=F(R.rgb,vec3(A(U)));U=H(U,vTextureCoord,vec2(clampX,clampY),0.35);U=F(U,S.rgb);gl_FragColor=vec4(U*R.a,R.a);}";var Yp="float A(vec3 B){return dot(B,vec3(0.299,0.587,0.114));}vec3 C(vec3 D,vec3 E,vec3 F){float G=max(max(D.r,D.g),D.b);return E*G+F*(1.-G);}vec3 H(vec3 I,vec3 J){vec3 K;K.r=(I.r>0.5)?(1.-(1.-J.r)*(1.-(I.r-0.5))):(J.r*(I.r+0.5));K.g=(I.g>0.5)?(1.-(1.-J.g)*(1.-(I.g-0.5))):(J.g*(I.g+0.5));K.b=(I.b>0.5)?(1.-(1.-J.b)*(1.-(I.b-0.5))):(J.b*(I.b+0.5));return K;}float L(vec3 M,float N,float O){vec3 P=vec3(0.2125,0.7154,0.0721);float Q=dot(M,P);float R=smoothstep(max(N-O,0.),min(N+O,1.),Q);return R;}vec3 S(vec3 M,vec2 T,vec2 U,float V){vec2 W=T*U;W=W*2.-1.;float X=sqrt(pow(abs(W.x),10.)+pow(abs(W.y),10.));X=smoothstep(0.,1.-V,X);return mix(M,vec3(1.),X);}varying vec2 vTextureCoord;uniform sampler2D uSampler;uniform sampler2D textureSampler;uniform float detail_level;uniform float clampX;uniform float clampY;void main(void){vec4 Y=texture2D(uSampler,vTextureCoord);if(Y.a==0.){gl_FragColor=vec4(0,0,0,0);return;}Y.rgb/=Y.a;vec4 Z=texture2D(textureSampler,vTextureCoord*vec2(clampX,clampY));float a=A(Y.rgb);vec3 b=vec3(L(Y.rgb,detail_level,0.1));b=C(b,vec3(1.),vec3(0.));b=S(b,vTextureCoord,vec2(clampX,clampY),0.35);b=H(b,Z.rgb);gl_FragColor=vec4(vec3(b)*Y.a,Y.a);}";var qp="float A(vec3 B){return dot(B,vec3(0.299,0.587,0.114));}vec3 C(vec3 D,vec3 E,vec3 F){float G=max(max(D.r,D.g),D.b);return E*G+F*(1.-G);}float H(vec3 I,float J,float K){vec3 L=vec3(0.2125,0.7154,0.0721);float M=dot(I,L);float N=smoothstep(max(J-K,0.),min(J+K,1.),M);return N;}vec3 O(vec3 I,vec2 P,vec2 Q,float R){vec2 S=P*Q;S=S*2.-1.;float T=sqrt(pow(abs(S.x),10.)+pow(abs(S.y),10.));T=smoothstep(0.,1.-R,T);return mix(I,vec3(1.),T);}varying vec2 vTextureCoord;uniform sampler2D uSampler;uniform sampler2D textureSampler;uniform float detail_level;uniform vec3 color;uniform float clampX;uniform float clampY;void main(void){vec4 U=texture2D(uSampler,vTextureCoord);if(U.a==0.){gl_FragColor=vec4(0,0,0,0);return;}U.rgb/=U.a;vec4 V=texture2D(textureSampler,vTextureCoord*vec2(clampX,clampY));float W=A(U.rgb);vec3 X=vec3(H(U.rgb,detail_level,0.1));X=C(X,vec3(1.),color);X=O(X,vTextureCoord,vec2(clampX,clampY),0.35);X=clamp(X*V.rgb,0.,1.);gl_FragColor=vec4(vec3(X)*U.a,U.a);}";var Kp="float A(vec3 B){return dot(B,vec3(0.299,0.587,0.114));}float C(float D,float E){return E/(1.-D);}vec3 F(vec3 G,vec3 H,vec3 I){float J=max(max(G.r,G.g),G.b);return H*J+I*(1.-J);}vec3 K(vec3 L,float M,float N){float O=L.r*0.309+L.g*0.609+L.b*0.082;float P=clamp(O-M,0.,1.)/clamp(abs(N-M),0.,1.);return vec3(clamp(vec3(P),0.,1.));}vec3 Q(vec3 R,vec2 S,vec2 T,float U){vec2 V=S*T;V=V*2.-1.;float W=sqrt(pow(abs(V.x),10.)+pow(abs(V.y),10.));W=smoothstep(0.,1.-U,W);return mix(R,vec3(1.),W);}varying vec2 vTextureCoord;uniform sampler2D uSampler;uniform sampler2D blurSampler;uniform sampler2D textureSampler;uniform float detail_level;uniform vec3 color;uniform float clampX;uniform float clampY;void main(void){vec4 X=texture2D(uSampler,vTextureCoord);if(X.a==0.){gl_FragColor=vec4(0,0,0,0);return;}X.rgb/=X.a;vec4 Y=texture2D(blurSampler,vTextureCoord*vec2(clampX,clampY));vec4 Z=texture2D(textureSampler,vTextureCoord*vec2(clampX,clampY));float a=A(X.rgb);float b=clamp(1.-A(Y.rgb),0.,1.);float c=C(b,a);vec3 d=K(vec3(c),detail_level,1.);d=Q(d,vTextureCoord,vec2(clampX,clampY),0.35);vec3 e=clamp(F(d,vec3(1.),color)*Z.rgb,0.,1.);gl_FragColor=vec4(vec3(e)*X.a,X.a);}";var Jp="float A(vec3 B){return dot(B,vec3(0.299,0.587,0.114));}float C(float D,float E){return E/(1.-D);}vec3 F(vec3 G,vec3 H,vec3 I){float J=max(max(G.r,G.g),G.b);return H*J+I*(1.-J);}vec3 K(vec3 L,float M,float N){float O=L.r*0.309+L.g*0.609+L.b*0.082;float P=clamp(O-M,0.,1.)/clamp(abs(N-M),0.,1.);return vec3(clamp(vec3(P),0.,1.));}vec3 Q(vec3 R,vec2 S,vec2 T,float U){vec2 V=S*T;V=V*2.-1.;float W=sqrt(pow(abs(V.x),10.)+pow(abs(V.y),10.));W=smoothstep(0.,1.-U,W);return mix(R,vec3(1.),W);}varying vec2 vTextureCoord;uniform sampler2D uSampler;uniform sampler2D blurSampler;uniform sampler2D textureSampler;uniform float detail_level;uniform vec3 color;uniform float clampX;uniform float clampY;void main(void){vec4 X=texture2D(uSampler,vTextureCoord);if(X.a==0.){gl_FragColor=vec4(0,0,0,0);return;}X.rgb/=X.a;vec4 Y=texture2D(blurSampler,vTextureCoord*vec2(clampX,clampY));vec4 Z=texture2D(textureSampler,vTextureCoord*vec2(clampX,clampY));float a=A(X.rgb);float b=clamp(1.-A(Y.rgb),0.,1.);float c=C(b,a);vec3 d=K(vec3(c),detail_level,1.);d=Q(d,vTextureCoord,vec2(clampX,clampY),0.35);vec3 e=clamp(F(d,vec3(1.),color)*Z.rgb,0.,1.);gl_FragColor=vec4(vec3(e)*X.a,X.a);}";var Qp=class extends PIXI.Filter{constructor(e){let t=O,r=Jp;switch(e){case BFN.CONST.STENCILER_PRESETS.PRESET_2:r=Kp;break;case BFN.CONST.STENCILER_PRESETS.PRESET_3:r=qp;break;case BFN.CONST.STENCILER_PRESETS.PRESET_4:r=Yp;break;case BFN.CONST.STENCILER_PRESETS.PRESET_6:r=jp;break;case BFN.CONST.STENCILER_PRESETS.PRESET_7:r=$p;break;case BFN.CONST.STENCILER_PRESETS.PRESET_8:r=Wp;break;case BFN.CONST.STENCILER_PRESETS.PRESET_9:r=zp;break;case BFN.CONST.STENCILER_PRESETS.PRESET_10:r=Xp;break;case BFN.CONST.STENCILER_PRESETS.PRESET_11:r=Hp;break}super(t,r);this.padding=0,this.currentPreset=e}apply(e,t,r,a){let s=BFN.FilterHelper.calculateFilterClamp(t,r,this.blurSampler||null);this.uniforms.clampX=s.x,this.uniforms.clampY=s.y,e.applyFilter(this,t,r,a)}get blurSampler(){return this.uniforms.blurSampler}set blurSampler(e){e.baseTexture.isPowerOfTwo=!0,this.uniforms.blurSampler=e}get textureSampler(){return this.uniforms.textureSampler}set textureSampler(e){this.uniforms.textureSampler=e}get color(){return this.uniforms.color}set color(e){e=BFN.FilterHelper.hex2rgb(e),this.uniforms.color=e}get detail_level(){return this.uniforms.detail_level}set detail_level(e){this.uniforms.detail_level=e}get color_detail(){return this.uniforms.color_detail}set color_detail(e){this.uniforms.color_detail=e}get smooth_amount(){return this.uniforms.hasOwnProperty("smooth_amount")?this.uniforms.smooth_amount:null}set smooth_amount(e){this.uniforms.hasOwnProperty("smooth_amount")&&(this.uniforms.smooth_amount=e)}},Zp=Qp;var ef="vec3 A(vec3 B,float C,float D){float E=B.r*0.309+B.g*0.609+B.b*0.082;float F=clamp(E-C,0.,1.)/clamp(abs(D-C),0.,1.);return vec3(clamp(vec3(F),0.,1.));}vec3 G(vec3 H,vec3 I){float J=min(H.r,I.r);float K=min(H.g,I.g);float L=min(H.b,I.b);return vec3(J,K,L);}vec3 M(vec3 N,vec3 O,vec3 P){float Q=max(max(N.r,N.g),N.b);return O*Q+P*(1.-Q);}varying vec2 vTextureCoord;uniform sampler2D uSampler;uniform sampler2D iChannel1;uniform float silhouette_amount;uniform float clampX;uniform float clampY;void main(void){vec4 R=texture2D(uSampler,vTextureCoord);if(R.a==0.){gl_FragColor=vec4(0,0,0,0);return;}R.rgb/=R.a;vec4 S=texture2D(iChannel1,vTextureCoord*vec2(clampX,clampY));vec3 T=vec3(A(R.rgb,silhouette_amount/255.,0.62));vec3 U=M(T,vec3(1.),vec3(0.14));vec3 V=vec3(R.g,U.g,U.b);gl_FragColor=vec4(G(V,S.rgb)*R.a,R.a);}";var tf="vec3 A(vec3 B,float C){float D=3.14159265;float E=(C/180.)*D;float F=sin(E),G=cos(E);vec3 H=(vec3(2.*G,-sqrt(3.)*F-G,sqrt(3.)*F-G)+1.)/3.;return vec3(dot(B,H.xyz),dot(B,H.zxy),dot(B,H.yzx));}varying vec2 vTextureCoord;uniform sampler2D uSampler;uniform sampler2D iChannel1;uniform float clampX;uniform float clampY;void main(void){vec4 I=texture2D(uSampler,vTextureCoord);if(I.a==0.){gl_FragColor=vec4(0,0,0,0);return;}I.rgb/=I.a;vec4 J=texture2D(iChannel1,vTextureCoord*vec2(clampX,clampY));vec3 K=I.bgb;vec3 L=vec3(K*J.rgb);gl_FragColor=vec4(A(L,180.)*I.a,I.a);}";var rf="vec3 A(vec3 B,float C,float D){float E=B.r*0.309+B.g*0.609+B.b*0.082;float F=clamp(E-C,0.,1.)/clamp(abs(D-C),0.,1.);return vec3(clamp(vec3(F),0.,1.));}float G(float H,float I){return(H<0.5)?2.*H*I:1.-2.*(1.-H)*(1.-I);}vec3 J(vec3 H,vec3 I){vec3 K;K.r=G(H.r,I.r);K.g=G(H.g,I.g);K.b=G(H.b,I.b);return K;}vec3 L(vec3 M,vec3 N,vec3 O){float P=max(max(M.r,M.g),M.b);return N*P+O*(1.-P);}varying vec2 vTextureCoord;uniform sampler2D uSampler;uniform sampler2D iChannel1;uniform float silhouette_amount;uniform float clampX;uniform float clampY;void main(void){vec4 Q=texture2D(uSampler,vTextureCoord);if(Q.a==0.){gl_FragColor=vec4(0,0,0,0);return;}Q.rgb/=Q.a;vec4 R=texture2D(iChannel1,vTextureCoord*vec2(clampX,clampY));vec3 S=vec3(A(Q.rgb,silhouette_amount/255.,0.62));vec3 T=L(S,vec3(1.),vec3(0.46));gl_FragColor=vec4(J(T,R.rgb)*Q.a,Q.a);}";var af="vec3 A(vec3 B,float C,float D){float E=B.r*0.309+B.g*0.609+B.b*0.082;float F=clamp(E-C,0.,1.)/clamp(abs(D-C),0.,1.);return vec3(clamp(vec3(F),0.,1.));}vec3 G(vec3 H,vec3 I){return mix(2.*H*I,1.-2.*(1.-H)*(1.-I),step(0.5,I));}varying vec2 vTextureCoord;uniform sampler2D uSampler;uniform sampler2D iChannel1;uniform float silhouette_amount;uniform float clampX;uniform float clampY;void main(void){vec4 J=texture2D(uSampler,vTextureCoord);if(J.a==0.){gl_FragColor=vec4(0,0,0,0);return;}J.rgb/=J.a;vec4 K=texture2D(iChannel1,vTextureCoord*vec2(clampX,clampY));vec3 L=vec3(A(J.rgb,silhouette_amount/255.,0.62));gl_FragColor=vec4(G(L,K.rgb)*J.a,J.a);}";var sf="vec3 A(vec3 B,float C,float D){float E=B.r*0.309+B.g*0.609+B.b*0.082;float F=clamp(E-C,0.,1.)/clamp(abs(D-C),0.,1.);return vec3(clamp(vec3(F),0.,1.));}varying vec2 vTextureCoord;uniform sampler2D uSampler;uniform sampler2D iChannel1;uniform float silhouette_amount;uniform float clampX;uniform float clampY;void main(void){vec4 G=texture2D(uSampler,vTextureCoord);if(G.a==0.){gl_FragColor=vec4(0,0,0,0);return;}G.rgb/=G.a;vec4 H=texture2D(iChannel1,vTextureCoord*vec2(clampX,clampY));vec3 I=vec3(A(G.rgb,silhouette_amount/255.,0.62));gl_FragColor=vec4(vec3(H.rgb*I)*G.a,G.a);}";var of="vec3 A(vec3 B,float C,float D){float E=B.r*0.309+B.g*0.609+B.b*0.082;float F=clamp(E-C,0.,1.)/clamp(abs(D-C),0.,1.);return vec3(clamp(vec3(F),0.,1.));}float G(float H,float I){return(H<0.5)?2.*H*I:1.-2.*(1.-H)*(1.-I);}vec3 J(vec3 H,vec3 I){vec3 K;K.r=G(H.r,I.r);K.g=G(H.g,I.g);K.b=G(H.b,I.b);return K;}varying vec2 vTextureCoord;uniform sampler2D uSampler;uniform sampler2D iChannel1;uniform float silhouette_amount;uniform float clampX;uniform float clampY;void main(void){vec4 L=texture2D(uSampler,vTextureCoord);if(L.a==0.){gl_FragColor=vec4(0,0,0,0);return;}L.rgb/=L.a;vec4 M=texture2D(iChannel1,vTextureCoord*vec2(clampX,clampY));vec3 N=vec3(A(L.rgb,silhouette_amount/255.,0.62));gl_FragColor=vec4(J(M.rgb,N)*L.a,L.a);}";var nf="float A(float B,float C){return(B<0.5)?2.*B*C:1.-2.*(1.-B)*(1.-C);}vec3 D(vec3 B,vec3 C){vec3 E;E.r=A(B.r,C.r);E.g=A(B.g,C.g);E.b=A(B.b,C.b);return E;}vec3 F(vec3 G,vec3 H,vec3 I){float J=max(max(G.r,G.g),G.b);return H*J+I*(1.-J);}vec3 K(vec2 L,vec3 M,vec3 N){float O;float P=12.9898;float Q=151.7182;float R=43758.5453;float S=dot(L,vec2(P,Q));float T=mod(S,3.14);float E=fract(sin(T)*R);return F(vec3(E),M,N);}vec3 U(vec3 G,vec3 H,vec3 I){float J=max(max(G.r,G.g),G.b);return H*J+I*(1.-J);}vec3 V(vec3 G,vec3 H,vec3 I){float J=max(max(G.r,G.g),G.b);return H*J+I*(1.-J);}float W(vec2 X){return fract(cos(dot(X,vec2(36.26,73.12)))*354.63);}float Y(vec2 X){vec2 Z=floor(X);vec2 T=smoothstep(vec2(0),vec2(1),fract(X));float a=mix(W(Z),W(Z+vec2(1,0)),T.x);float b=mix(W(Z+vec2(0,1)),W(Z+vec2(1)),T.x);return mix(a,b,T.y);}vec3 c(vec2 X,float d,vec3 e,vec3 f){X/=d;float g;g=Y(X/32.)*0.5875+Y(X/16.)*0.2+Y(X/8.)*0.1+Y(X/4.)*0.05+Y(X/2.)*0.025+Y(X)*0.0125;return V(vec3(g),e,f);}vec2 h(vec2 L,vec4 i){L*=i.xy;L+=i.zw;return L;}vec3 j(vec3 k,float l,float m){float n=k.r*0.309+k.g*0.609+k.b*0.082;float o=clamp(n-l,0.,1.)/clamp(abs(m-l),0.,1.);return vec3(clamp(vec3(o),0.,1.));}float p(float B,float C){return(((2.*B)==0.)?(2.*B):max((1.-((1.-C)/(2.*B))),0.));}vec3 q(vec3 B,vec3 C){vec3 E;E.r=p(B.r,C.r);E.g=p(B.g,C.g);E.b=p(B.b,C.b);return E;}varying vec2 vTextureCoord;uniform sampler2D uSampler;uniform sampler2D iChannel1;uniform sampler2D blurImage;uniform float detail_level;uniform float clampX;uniform float clampY;uniform vec4 filterArea;void main(void){vec4 r=texture2D(uSampler,vTextureCoord);if(r.a==0.){gl_FragColor=vec4(0,0,0,0);return;}r.rgb/=r.a;vec4 s=texture2D(iChannel1,vTextureCoord*vec2(clampX,clampY));vec4 t=texture2D(blurImage,vTextureCoord*vec2(clampX,clampY));vec2 u=h(vTextureCoord,filterArea);vec3 v=c(u,4.,vec3(0.8),vec3(0.2));vec3 w=K(vTextureCoord,vec3(0.75),vec3(0.46));vec3 x=D(t.rgb,v);vec3 y=D(w,x);vec3 z=D(y,s.rgb);vec3 AA=vec3(j(r.rgb,detail_level/255.,0.55));AA=U(AA,vec3(1.),vec3(0.35));z=q(AA,z);gl_FragColor=vec4(z*r.a,r.a);}";var lf="float A(vec3 B,float C,float D){vec3 E=vec3(0.2125,0.7154,0.0721);float F=dot(B,E);float G=smoothstep(max(C-D,0.),min(C+D,1.),F);return G;}vec3 H(vec3 I,vec3 J){return mix(2.*I*J,1.-2.*(1.-I)*(1.-J),step(0.5,J));}varying vec2 vTextureCoord;uniform sampler2D uSampler;uniform sampler2D iChannel1;uniform float silhouette_amount;uniform float clampX;uniform float clampY;void main(void){vec4 K=texture2D(uSampler,vTextureCoord);if(K.a==0.){gl_FragColor=vec4(0,0,0,0);return;}K.rgb/=K.a;vec4 L=texture2D(iChannel1,vTextureCoord*vec2(clampX,clampY));vec3 M=vec3(A(K.rgb,silhouette_amount/255.,0.1));gl_FragColor=vec4(H(L.rgb,M)*K.a,K.a);}";var cf="vec3 A(vec3 B,float C,float D){float E=B.r*0.309+B.g*0.609+B.b*0.082;float F=clamp(E-C,0.,1.)/clamp(abs(D-C),0.,1.);return vec3(clamp(vec3(F),0.,1.));}vec3 G(vec3 H,vec3 I){vec3 J;J.r=(H.r>0.5)?(1.-(1.-I.r)*(1.-(H.r-0.5))):(I.r*(H.r+0.5));J.g=(H.g>0.5)?(1.-(1.-I.g)*(1.-(H.g-0.5))):(I.g*(H.g+0.5));J.b=(H.b>0.5)?(1.-(1.-I.b)*(1.-(H.b-0.5))):(I.b*(H.b+0.5));return J;}varying vec2 vTextureCoord;uniform sampler2D uSampler;uniform sampler2D iChannel1;uniform float silhouette_amount;uniform float clampX;uniform float clampY;void main(void){vec4 K=texture2D(uSampler,vTextureCoord);if(K.a==0.){gl_FragColor=vec4(0,0,0,0);return;}K.rgb/=K.a;vec4 L=texture2D(iChannel1,vTextureCoord*vec2(clampX,clampY));vec3 M=vec3(A(K.rgb,silhouette_amount/255.,0.74));vec3 N=G(K.rgb,L.rgb);gl_FragColor=vec4(vec3(N*M)*K.a,K.a);}";var hf="vec3 A(vec3 B,vec3 C){return mix(2.*B*C,1.-2.*(1.-B)*(1.-C),step(0.5,C));}varying vec2 vTextureCoord;uniform sampler2D uSampler;uniform sampler2D iChannel1;uniform float clampX;uniform float clampY;void main(void){vec4 D=texture2D(uSampler,vTextureCoord);if(D.a==0.){gl_FragColor=vec4(0,0,0,0);return;}D.rgb/=D.a;vec4 E=texture2D(iChannel1,vTextureCoord*vec2(clampX,clampY));vec3 F=D.bbb;gl_FragColor=vec4(A(E.rgb,F)*D.a,D.a);}";var uf="vec3 A(vec3 B,float C,float D){float E=B.r*0.309+B.g*0.609+B.b*0.082;float F=clamp(E-C,0.,1.)/clamp(abs(D-C),0.,1.);return vec3(clamp(vec3(F),0.,1.));}float G(float H,float I){return(H<0.5)?2.*H*I:1.-2.*(1.-H)*(1.-I);}vec3 J(vec3 H,vec3 I){vec3 K;K.r=G(H.r,I.r);K.g=G(H.g,I.g);K.b=G(H.b,I.b);return K;}vec3 L(vec3 H,vec3 I){return 1.-(1.-H)*(1.-I);}varying vec2 vTextureCoord;uniform sampler2D uSampler;uniform sampler2D iChannel1;uniform float shadow_amount;uniform float clampX;uniform float clampY;void main(void){vec4 M=texture2D(uSampler,vTextureCoord);if(M.a==0.){gl_FragColor=vec4(0,0,0,0);return;}M.rgb/=M.a;vec4 N=texture2D(iChannel1,vTextureCoord*vec2(clampX,clampY));vec3 O=M.bbb;vec3 P=J(N.rgb,O);vec3 Q=vec3(A(M.rgb,shadow_amount/255.,0.6));gl_FragColor=vec4(L(Q,P)*M.a,M.a);}";var df="float A(float B,float C){return(B<0.5)?2.*B*C:1.-2.*(1.-B)*(1.-C);}vec3 D(vec3 B,vec3 C){vec3 E;E.r=A(B.r,C.r);E.g=A(B.g,C.g);E.b=A(B.b,C.b);return E;}vec3 F(vec3 G,vec3 H,vec3 I){float J=max(max(G.r,G.g),G.b);return H*J+I*(1.-J);}vec3 K(vec2 L,vec3 M,vec3 N){float O;float P=12.9898;float Q=151.7182;float R=43758.5453;float S=dot(L,vec2(P,Q));float T=mod(S,3.14);float E=fract(sin(T)*R);return F(vec3(E),M,N);}vec3 U(vec3 G,vec3 H,vec3 I){float J=max(max(G.r,G.g),G.b);return H*J+I*(1.-J);}float V(vec2 W){return fract(cos(dot(W,vec2(36.26,73.12)))*354.63);}float X(vec2 W){vec2 Y=floor(W);vec2 T=smoothstep(vec2(0),vec2(1),fract(W));float Z=mix(V(Y),V(Y+vec2(1,0)),T.x);float a=mix(V(Y+vec2(0,1)),V(Y+vec2(1)),T.x);return mix(Z,a,T.y);}vec3 b(vec2 W,float c,vec3 d,vec3 e){W/=c;float f;f=X(W/32.)*0.5875+X(W/16.)*0.2+X(W/8.)*0.1+X(W/4.)*0.05+X(W/2.)*0.025+X(W)*0.0125;return U(vec3(f),d,e);}vec2 g(vec2 L,vec4 h){L*=h.xy;L+=h.zw;return L;}varying vec2 vTextureCoord;uniform sampler2D uSampler;uniform sampler2D iChannel1;uniform sampler2D blurImage;uniform float clampX;uniform float clampY;uniform vec4 filterArea;void main(void){vec4 i=texture2D(uSampler,vTextureCoord);if(i.a==0.){gl_FragColor=vec4(0,0,0,0);return;}i.rgb/=i.a;vec4 j=texture2D(iChannel1,vTextureCoord*vec2(clampX,clampY));vec4 k=texture2D(blurImage,vTextureCoord*vec2(clampX,clampY));vec2 l=g(vTextureCoord,filterArea);vec3 m=b(l,4.,vec3(0.8),vec3(0.2));vec3 n=K(vTextureCoord,vec3(0.75),vec3(0.46));vec3 o=D(k.rgb,m);vec3 p=D(n,o);vec3 q=D(p,j.rgb);q=D(i.rgb,q);gl_FragColor=vec4(q*i.a,i.a);}";var Oo="vec3 A(vec3 B,float C,float D){float E=B.r*0.309+B.g*0.609+B.b*0.082;float F=clamp(E-C,0.,1.)/clamp(abs(D-C),0.,1.);return vec3(clamp(vec3(F),0.,1.));}float G(float H,float I){return(H<0.5)?2.*H*I:1.-2.*(1.-H)*(1.-I);}vec3 J(vec3 H,vec3 I){vec3 K;K.r=G(H.r,I.r);K.g=G(H.g,I.g);K.b=G(H.b,I.b);return K;}varying vec2 vTextureCoord;uniform sampler2D uSampler;uniform sampler2D iChannel1;uniform float silhouette_amount;uniform float clampX;uniform float clampY;void main(void){vec4 L=texture2D(uSampler,vTextureCoord);if(L.a==0.){gl_FragColor=vec4(0,0,0,0);return;}L.rgb/=L.a;vec4 M=texture2D(iChannel1,vTextureCoord*vec2(clampX,clampY));vec3 N=J(L.rgb,M.rgb);vec3 O=vec3(A(L.rgb,silhouette_amount/255.,0.5));gl_FragColor=vec4(vec3(N*O)*L.a,L.a);}";var mf=class extends PIXI.Filter{constructor(e){let t=Oo;switch(e){case BFN.CONST.GRUNGE_PRESETS.PRESET_1:t=Oo;break;case BFN.CONST.GRUNGE_PRESETS.PRESET_2:t=df;break;case BFN.CONST.GRUNGE_PRESETS.PRESET_3:t=uf;break;case BFN.CONST.GRUNGE_PRESETS.PRESET_4:t=hf;break;case BFN.CONST.GRUNGE_PRESETS.PRESET_5:t=cf;break;case BFN.CONST.GRUNGE_PRESETS.PRESET_6:t=lf;break;case BFN.CONST.GRUNGE_PRESETS.PRESET_9:t=nf;break;case BFN.CONST.GRUNGE_PRESETS.PRESET_10:t=of;break;case BFN.CONST.GRUNGE_PRESETS.PRESET_11:t=sf;break;case BFN.CONST.GRUNGE_PRESETS.PRESET_13:t=af;break;case BFN.CONST.GRUNGE_PRESETS.PRESET_15:t=rf;break;case BFN.CONST.GRUNGE_PRESETS.PRESET_16:t=tf;break;case BFN.CONST.GRUNGE_PRESETS.PRESET_17:t=ef;break}super(O,t);this.currentPreset=e,this.padding=0}apply(e,t,r,a){let s=BFN.FilterHelper.calculateFilterClamp(t,r,this.blurImage||null);this.uniforms.clampX=s.x,this.uniforms.clampY=s.y,e.applyFilter(this,t,r,a)}get iChannel1(){return this.uniforms.iChannel1}set iChannel1(e){this.uniforms.iChannel1=e}get blurImage(){return this.uniforms.blurImage}set blurImage(e){e.baseTexture.isPowerOfTwo=!0,this.uniforms.blurImage=e}get silhouette_amount(){return this.uniforms.silhouette_amount}set silhouette_amount(e){this.uniforms.silhouette_amount=e}get shadow_amount(){return this.uniforms.shadow_amount}set shadow_amount(e){this.uniforms.shadow_amount=e}get detail_level(){return this.uniforms.detail_level}set detail_level(e){this.uniforms.detail_level=e}},pf=mf;var ff="vec3 A(vec3 B,vec3 C,vec3 D){float E=max(max(B.r,B.g),B.b);return C*E+D*(1.-E);}float F(vec2 G){return fract(cos(dot(G,vec2(36.26,73.12)))*354.63);}float H(vec2 G){vec2 I=floor(G);vec2 J=smoothstep(vec2(0),vec2(1),fract(G));float K=mix(F(I),F(I+vec2(1,0)),J.x);float L=mix(F(I+vec2(0,1)),F(I+vec2(1)),J.x);return mix(K,L,J.y);}vec3 M(vec2 G,float N,vec3 O,vec3 P){G/=N;float Q;Q=H(G/32.)*0.5875+H(G/16.)*0.2+H(G/8.)*0.1+H(G/4.)*0.05+H(G/2.)*0.025+H(G)*0.0125;return A(vec3(Q),O,P);}vec2 R(vec2 S,vec4 T){S*=T.xy;S+=T.zw;return S;}vec3 U(vec3 B,vec3 C,vec3 D){float E=max(max(B.r,B.g),B.b);return C*E+D*(1.-E);}float V(float W,float X){return(W<0.5)?2.*W*X:1.-2.*(1.-W)*(1.-X);}vec3 Y(vec3 W,vec3 X){vec3 Z;Z.r=V(W.r,X.r);Z.g=V(W.g,X.g);Z.b=V(W.b,X.b);return Z;}vec3 a(vec3 W,vec3 X){return mix(2.*W*X,1.-2.*(1.-W)*(1.-X),step(0.5,X));}vec3 b(vec3 c,vec2 d,float e,float f,float N,float g){vec2 h=d-vec2(0.5*e,0.5*f);h.x*=f/e;float i=length(h);float j=f*(0.5+(1.-N)*0.5);float k=clamp(smoothstep(j,j-0.2,i),0.,1.);c*=mix(k,1.,g);return c;}varying vec2 vTextureCoord;uniform sampler2D uSampler;uniform float grain_amount;uniform float realWidth;uniform float realHeight;uniform vec4 filterArea;void main(void){grain_amount;vec4 l=texture2D(uSampler,vTextureCoord);if(l.a==0.){gl_FragColor=vec4(0,0,0,0);return;}l.rgb/=l.a;vec3 m=l.gbb;vec2 n=R(vTextureCoord,filterArea);vec3 o=M(n,grain_amount,vec3(0.3),vec3(0.5));vec3 p=b(vec3(1.),vTextureCoord,realWidth,realHeight,0.70,0.45);vec3 q=(1.-p)+o;vec3 r=Y(q,m);vec3 s=U(q,vec3(0.99,1.00,0.44),vec3(1.00,0.42,0.00));r=a(s,r);p=U(p,vec3(1.),vec3(0.76,0.43,0.06));r=clamp(r*p,0.,1.);l.rgb=r*l.a;gl_FragColor=l;}";var gf="vec3 A(vec3 B,vec3 C,vec3 D){float E=max(max(B.r,B.g),B.b);return C*E+D*(1.-E);}float F(vec2 G){return fract(cos(dot(G,vec2(36.26,73.12)))*354.63);}float H(vec2 G){vec2 I=floor(G);vec2 J=smoothstep(vec2(0),vec2(1),fract(G));float K=mix(F(I),F(I+vec2(1,0)),J.x);float L=mix(F(I+vec2(0,1)),F(I+vec2(1)),J.x);return mix(K,L,J.y);}vec3 M(vec2 G,float N,vec3 O,vec3 P){G/=N;float Q;Q=H(G/32.)*0.5875+H(G/16.)*0.2+H(G/8.)*0.1+H(G/4.)*0.05+H(G/2.)*0.025+H(G)*0.0125;return A(vec3(Q),O,P);}vec2 R(vec2 S,vec4 T){S*=T.xy;S+=T.zw;return S;}vec3 U(vec3 B,vec3 C,vec3 D){float E=max(max(B.r,B.g),B.b);return C*E+D*(1.-E);}float V(float W,float X){return(W<0.5)?2.*W*X:1.-2.*(1.-W)*(1.-X);}vec3 Y(vec3 W,vec3 X){vec3 Z;Z.r=V(W.r,X.r);Z.g=V(W.g,X.g);Z.b=V(W.b,X.b);return Z;}vec3 a(vec3 W,vec3 X){return mix(2.*W*X,1.-2.*(1.-W)*(1.-X),step(0.5,X));}float b(float W,float X){return(((2.*W)==0.)?(2.*W):max((1.-((1.-X)/(2.*W))),0.));}vec3 c(vec3 W,vec3 X){vec3 Z;Z.r=b(W.r,X.r);Z.g=b(W.g,X.g);Z.b=b(W.b,X.b);return Z;}float d(vec3 e,float f,float g){vec3 h=vec3(0.2125,0.7154,0.0721);float i=dot(e,h);float j=smoothstep(max(f-g,0.),min(f+g,1.),i);return j;}vec3 k(vec3 l,vec2 m,float n,float o,float N,float p){vec2 q=m-vec2(0.5*n,0.5*o);q.x*=o/n;float r=length(q);float s=o*(0.5+(1.-N)*0.5);float t=clamp(smoothstep(s,s-0.2,r),0.,1.);l*=mix(t,1.,p);return l;}varying vec2 vTextureCoord;uniform sampler2D uSampler;uniform sampler2D textureSampler;uniform float grain_amount;uniform float clampX;uniform float clampY;uniform vec4 filterArea;uniform float realWidth;uniform float realHeight;void main(void){vec4 u=texture2D(uSampler,vTextureCoord);if(u.a==0.){gl_FragColor=vec4(0,0,0,0);return;}u.rgb/=u.a;vec4 v=texture2D(textureSampler,vTextureCoord*vec2(clampX,clampY));vec2 w=R(vTextureCoord,filterArea);vec3 x=M(w,grain_amount,vec3(0.3),vec3(0.5));vec3 y=Y(x,vec3(u.g));vec3 z=k(vec3(1.),vTextureCoord,realWidth,realHeight,0.70,0.45);vec3 AA=U(z,vec3(1.00,0.99,0.77),vec3(0.94,0.44,0.00));vec3 AB=c(AA,y);AB=a(AB,v.rgb);u.rgb=AB*u.a;gl_FragColor=u;}";var vf="vec3 A(vec3 B,vec3 C,vec3 D){float E=max(max(B.r,B.g),B.b);return C*E+D*(1.-E);}float F(vec2 G){return fract(cos(dot(G,vec2(36.26,73.12)))*354.63);}float H(vec2 G){vec2 I=floor(G);vec2 J=smoothstep(vec2(0),vec2(1),fract(G));float K=mix(F(I),F(I+vec2(1,0)),J.x);float L=mix(F(I+vec2(0,1)),F(I+vec2(1)),J.x);return mix(K,L,J.y);}vec3 M(vec2 G,float N,vec3 O,vec3 P){G/=N;float Q;Q=H(G/32.)*0.5875+H(G/16.)*0.2+H(G/8.)*0.1+H(G/4.)*0.05+H(G/2.)*0.025+H(G)*0.0125;return A(vec3(Q),O,P);}vec2 R(vec2 S,vec4 T){S*=T.xy;S+=T.zw;return S;}vec3 U(vec3 B,vec3 C,vec3 D){float E=max(max(B.r,B.g),B.b);return C*E+D*(1.-E);}float V(float W,float X){return(W<0.5)?2.*W*X:1.-2.*(1.-W)*(1.-X);}vec3 Y(vec3 W,vec3 X){vec3 Z;Z.r=V(W.r,X.r);Z.g=V(W.g,X.g);Z.b=V(W.b,X.b);return Z;}vec3 a(vec3 W,vec3 X){return mix(2.*W*X,1.-2.*(1.-W)*(1.-X),step(0.5,X));}float b(vec3 c,float d,float e){vec3 f=vec3(0.2125,0.7154,0.0721);float g=dot(c,f);float h=smoothstep(max(d-e,0.),min(d+e,1.),g);return h;}vec3 i(vec3 j,vec2 k,float l,float m,float N,float n){vec2 o=k-vec2(0.5*l,0.5*m);o.x*=m/l;float p=length(o);float q=m*(0.5+(1.-N)*0.5);float r=clamp(smoothstep(q,q-0.2,p),0.,1.);j*=mix(r,1.,n);return j;}varying vec2 vTextureCoord;uniform sampler2D uSampler;uniform float grain_amount;uniform float realWidth;uniform float realHeight;uniform vec4 filterArea;void main(void){grain_amount;vec4 s=texture2D(uSampler,vTextureCoord);if(s.a==0.){gl_FragColor=vec4(0,0,0,0);return;}s.rgb/=s.a;vec3 t=vec3(b(s.rgb,0.5,0.5));vec2 u=R(vTextureCoord,filterArea);vec3 v=M(u,grain_amount,vec3(0.3),vec3(0.5));vec3 w=i(vec3(1.),vTextureCoord,realWidth,realHeight,0.70,0.45);w=(1.-w)+v;vec3 x=Y(w,t);vec3 y=U(w,vec3(0.99,1.00,0.44),vec3(1.00,0.42,0.00));x=a(y,x);s.rgb=x*s.a;gl_FragColor=s;}";var yf="float A(float B,float C){return(B<0.5)?2.*B*C:1.-2.*(1.-B)*(1.-C);}vec3 D(vec3 B,vec3 C){vec3 E;E.r=A(B.r,C.r);E.g=A(B.g,C.g);E.b=A(B.b,C.b);return E;}vec3 F(vec3 G,float H){return pow(G,vec3(H));}vec3 I(vec3 G,float J,float K){vec3 L=F(G,J);vec3 M=((L-0.5)*K)+0.5;return M;}float N(vec3 O){return dot(O,vec3(0.299,0.587,0.114));}vec3 P(vec3 G,vec3 Q,vec3 R){float S=max(max(G.r,G.g),G.b);return Q*S+R*(1.-S);}float T(vec2 U){return fract(cos(dot(U,vec2(36.26,73.12)))*354.63);}float V(vec2 U){vec2 W=floor(U);vec2 X=smoothstep(vec2(0),vec2(1),fract(U));float Y=mix(T(W),T(W+vec2(1,0)),X.x);float Z=mix(T(W+vec2(0,1)),T(W+vec2(1)),X.x);return mix(Y,Z,X.y);}vec3 a(vec2 U,float H,vec3 b,vec3 c){U/=H;float d;d=V(U/32.)*0.5875+V(U/16.)*0.2+V(U/8.)*0.1+V(U/4.)*0.05+V(U/2.)*0.025+V(U)*0.0125;return P(vec3(d),b,c);}vec2 e(vec2 f,vec4 g){f*=g.xy;f+=g.zw;return f;}varying vec2 vTextureCoord;uniform sampler2D uSampler;uniform sampler2D textureSampler;uniform float grain_amount;uniform float sunburst_amount;uniform float clampX;uniform float clampY;uniform vec4 filterArea;void main(void){vec4 h=texture2D(uSampler,vTextureCoord);if(h.a==0.){gl_FragColor=vec4(0,0,0,0);return;}h.rgb/=h.a;vec4 i=texture2D(textureSampler,vTextureCoord*vec2(clampX,clampY));vec2 j=e(vTextureCoord,filterArea);vec3 k=a(j,grain_amount,vec3(0.8),vec3(0.2));vec3 l=D(h.rgb,k);h.rgb=D(h.rgb,l);h.rgb=D(h.rgb,I(i.rgb,1.-sunburst_amount/100.,1.))*h.a;gl_FragColor=h;}";var xf="vec3 A(vec3 B,vec3 C,vec3 D){float E=max(max(B.r,B.g),B.b);return C*E+D*(1.-E);}vec2 F(vec2 G,vec4 H){G*=H.xy;G+=H.zw;return G;}vec2 I(vec2 G,vec4 H){G-=H.zw;G/=H.xy;return G;}float J(vec3 K){return dot(K,vec3(0.299,0.587,0.114));}vec2 L(vec2 M,float N){return floor(M/N)*N;}vec3 O(sampler2D P,vec2 G,vec4 Q,vec2 R,float S,vec3 T,vec3 U){vec2 V=F(G,Q);vec2 W=vec2(1./Q.xy);vec2 X=vec2(1./R.x-W.x,1./R.y-W.y);vec2 Y=L(V,S)+0.5*S;float Z=min(length(V-Y)/((S)*0.5),1.);Y=I(Y,Q);vec3 a=texture2D(P,clamp(Y,vec2(0.),X)).rgb;float b=1.-J(a);Z=smoothstep(min(max(b,0.2),0.8),max(min(b+0.1,1.),0.25),Z);vec3 c=A(vec3(Z),U,T);return c;}vec3 d(vec3 B,float e){return pow(B,vec3(e));}vec3 f(vec3 B,float g,float h){vec3 i=d(B,g);vec3 j=((i-0.5)*h)+0.5;return j;}vec3 k(vec3 B,vec3 C,vec3 D){float E=max(max(B.r,B.g),B.b);return C*E+D*(1.-E);}vec2 l(vec2 G,vec4 H){G*=H.xy;G+=H.zw;return G;}vec3 m(vec2 G,vec4 Q,float n,vec3 o,vec3 p,vec2 R){G*=R;vec2 q=vec2(0.5);vec2 V=(G-q);float r=length(V);float s=cos(n*atan(V.y,V.x));float t=s>0.?smoothstep(0.,0.4,s):smoothstep(0.,1.,s);float u=t*r*4.;return k(vec3(u),p,o);}varying vec2 vTextureCoord;uniform sampler2D uSampler;uniform float halftone_size;uniform float sunburst_amount;uniform vec3 color;uniform float clampX;uniform float clampY;uniform vec4 filterArea;void main(void){vec4 v=texture2D(uSampler,vTextureCoord);if(v.a==0.){gl_FragColor=vec4(0,0,0,0);return;}v.rgb/=v.a;vec3 w=f(v.rgb,1.,1.);vec3 x=O(uSampler,vTextureCoord,filterArea,vec2(clampX,clampY),halftone_size,vec3(0.6),vec3(1.));w=clamp(w*x,0.,1.);vec3 y=m(vTextureCoord,filterArea,sunburst_amount,vec3(1.,1.,1.),color,vec2(clampX,clampY));w=clamp(w*y,0.,1.);v.rgb=w*v.a;gl_FragColor=v;}";var Tf="float A(vec3 B,float C,float D){vec3 E=vec3(0.2125,0.7154,0.0721);float F=dot(B,E);float G=smoothstep(max(C-D,0.),min(C+D,1.),F);return G;}vec3 H(vec3 I,vec3 J,vec3 K){float L=max(max(I.r,I.g),I.b);return J*L+K*(1.-L);}vec2 M(vec2 N,vec4 O){N*=O.xy;N+=O.zw;return N;}vec2 P(vec2 N,vec4 O){N-=O.zw;N/=O.xy;return N;}float Q(vec3 R){return dot(R,vec3(0.299,0.587,0.114));}vec2 S(vec2 T,float U){return floor(T/U)*U;}vec3 V(sampler2D W,vec2 N,vec4 X,vec2 Y,float Z,vec3 a,vec3 b){vec2 c=M(N,X);vec2 d=vec2(1./X.xy);vec2 e=vec2(1./Y.x-d.x,1./Y.y-d.y);vec2 f=S(c,Z)+0.5*Z;float g=min(length(c-f)/((Z)*0.5),1.);f=P(f,X);vec3 h=texture2D(W,clamp(f,vec2(0.),e)).rgb;float i=1.-Q(h);g=smoothstep(min(max(i,0.2),0.8),max(min(i+0.1,1.),0.25),g);vec3 j=H(vec3(g),b,a);return j;}vec3 k(vec3 l,vec3 m){return mix(2.*l*m,1.-2.*(1.-l)*(1.-m),step(0.5,m));}vec3 n(vec3 l,vec3 m){float o=min(l.r,m.r);float p=min(l.g,m.g);float q=min(l.b,m.b);return vec3(o,p,q);}varying vec2 vTextureCoord;uniform sampler2D uSampler;uniform sampler2D textureSampler;uniform float halftone_size;uniform float silhouette_amount;uniform float clampX;uniform float clampY;uniform vec4 filterArea;void main(void){vec4 r=texture2D(uSampler,vTextureCoord);if(r.a==0.){gl_FragColor=vec4(0,0,0,0);return;}r.rgb/=r.a;vec4 s=texture2D(textureSampler,vTextureCoord*vec2(clampX,clampY));vec3 t=vec3(A(r.rgb,(silhouette_amount/2.)/255.,0.3));vec3 u=V(uSampler,vTextureCoord,filterArea,vec2(clampX,clampY),halftone_size,vec3(0.39),vec3(1.));u=k(u,t);u=n(s.rgb,u);r.rgb=u*r.a;gl_FragColor=r;}";var Ff=class extends PIXI.Filter{constructor(e){let t=O,r=Tf,a=!0,s=!1;switch(e){case BFN.CONST.SUNBURST_PRESETS.PRESET_2:r=xf;break;case BFN.CONST.SUNBURST_PRESETS.PRESET_3:r=yf;break;case BFN.CONST.SUNBURST_PRESETS.PRESET_4:a=!1,s=!0,r=vf;break;case BFN.CONST.SUNBURST_PRESETS.PRESET_5:s=!0,r=gf;break;case BFN.CONST.SUNBURST_PRESETS.PRESET_6:a=!1,s=!0,r=ff;break}super(t,r);this.padding=0,this.currentPreset=e,this.isClamp=a,this.isWidth=s}apply(e,t,r,a){if(this.isClamp==!0){let s=BFN.FilterHelper.calculateFilterClamp(t,r);this.uniforms.clampX=s.x,this.uniforms.clampY=s.y}this.isWidth==!0&&(this.uniforms.realWidth=r.destinationFrame.width/t.size.width,this.uniforms.realHeight=r.destinationFrame.height/t.size.height),e.applyFilter(this,t,r,a)}get textureSampler(){return this.uniforms.textureSampler}set textureSampler(e){this.uniforms.textureSampler=e}get color(){return this.uniforms.color}set color(e){e=BFN.FilterHelper.hex2rgb(e),this.uniforms.color=e}get halftone_size(){return this.uniforms.halftone_size}set halftone_size(e){this.uniforms.halftone_size=e}get silhouette_amount(){return this.uniforms.silhouette_amount}set silhouette_amount(e){this.uniforms.silhouette_amount=e}get sunburst_amount(){return this.uniforms.sunburst_amount}set sunburst_amount(e){this.uniforms.sunburst_amount=e}get grain_amount(){return this.uniforms.grain_amount}set grain_amount(e){this.uniforms.grain_amount=e}},bf=Ff;var Bf="vec3 A(vec3 B,float C){return pow(B,vec3(C));}vec3 D(vec3 B,float E,float F){vec3 G=A(B,E);vec3 H=((G-0.5)*F)+0.5;return H;}varying vec2 vTextureCoord;uniform sampler2D uSampler;void main(void){vec4 I=texture2D(uSampler,vTextureCoord);gl_FragColor=vec4(vec3(D(I.rgb,1.,1.8)),I.a);}";var Sf=class extends PIXI.Filter{constructor(){super(O,Bf);this.padding=0}},If=Sf;var _f="vec3 A(vec3 B,float C,float D){float E=(2.+(D*20.));return C/(1.+exp(E*(0.5-B)));}float F(vec3 G){return dot(G,vec3(0.299,0.587,0.114));}vec3 H(vec3 I,vec3 J){return mix(2.*I*J,1.-2.*(1.-I)*(1.-J),step(0.5,J));}varying vec2 vTextureCoord;uniform sampler2D uSampler;uniform float contrast;void main(void){vec4 K=texture2D(uSampler,vTextureCoord);if(K.a==0.){gl_FragColor=vec4(0,0,0,0);return;}K.rgb/=K.a;vec3 L=A(K.rgb,0.75,contrast);vec3 M=vec3(F(L));vec3 N=vec3(0.81,0.78,0.69);vec3 O=H(N,M)*0.85+M*(1.-0.85);gl_FragColor=vec4(O*K.a,K.a);}";var Cf="float A(vec3 B,float C,float D){vec3 E=vec3(0.2125,0.7154,0.0721);float F=dot(B,E);float G=smoothstep(max(C-D,0.),min(C+D,1.),F);return G;}vec3 H(vec3 I,vec3 J,vec3 K){float L=max(max(I.r,I.g),I.b);return J*L+K*(1.-L);}varying vec2 vTextureCoord;uniform sampler2D uSampler;uniform float silhouette_amount;void main(void){vec4 M=texture2D(uSampler,vTextureCoord);if(M.a==0.){gl_FragColor=vec4(0,0,0,0);return;}M.rgb/=M.a;vec3 N=vec3(A(M.rgb,silhouette_amount/255.,0.3));gl_FragColor=vec4(H(N,vec3(1.),vec3(0.21,0.18,0.16))*M.a,M.a);}";var Ef="vec3 A(vec3 B,vec3 C){return max(B,C);}float D(float B,float C){return(B<0.5)?2.*B*C:1.-2.*(1.-B)*(1.-C);}vec3 E(vec3 B,vec3 C){vec3 F;F.r=D(B.r,C.r);F.g=D(B.g,C.g);F.b=D(B.b,C.b);return F;}vec3 G(vec3 B,vec3 C){return mix(2.*B*C,1.-2.*(1.-B)*(1.-C),step(0.5,C));}vec3 H(vec3 I,vec3 J,vec3 K){float L=max(max(I.r,I.g),I.b);return J*L+K*(1.-L);}vec3 M(vec2 N,vec3 O,vec3 P){float Q;float R=12.9898;float S=151.7182;float T=43758.5453;float U=dot(N,vec2(R,S));float V=mod(U,3.14);float F=fract(sin(V)*T);return H(vec3(F),O,P);}varying vec2 vTextureCoord;uniform sampler2D uSampler;uniform sampler2D textureSampler;uniform sampler2D blurSampler;uniform float clampX;uniform float clampY;void main(void){vec4 W=texture2D(uSampler,vTextureCoord);if(W.a==0.){gl_FragColor=vec4(0,0,0,0);return;}W.rgb/=W.a;vec4 X=texture2D(textureSampler,vTextureCoord*vec2(clampX,clampY));vec4 Y=texture2D(blurSampler,vTextureCoord*vec2(clampX,clampY));vec3 Z=M(vTextureCoord,vec3(0.8),vec3(1.));vec3 a=vec3(0.24,0.18,0.13);vec3 b=E(Y.rgb,a);vec3 c=G(Z,b);gl_FragColor=vec4(A(c,X.rgb)*W.a,W.a);}";var Pf="float A(vec3 B,float C,float D){vec3 E=vec3(0.2125,0.7154,0.0721);float F=dot(B,E);float G=smoothstep(max(C-D,0.),min(C+D,1.),F);return G;}vec3 H(vec3 I,vec3 J){float K=min(I.r,J.r);float L=min(I.g,J.g);float M=min(I.b,J.b);return vec3(K,L,M);}varying vec2 vTextureCoord;uniform sampler2D uSampler;uniform sampler2D textureSampler;uniform float silhouette_amount;uniform float clampX;uniform float clampY;void main(void){vec4 N=texture2D(uSampler,vTextureCoord);if(N.a==0.){gl_FragColor=vec4(0,0,0,0);return;}N.rgb/=N.a;vec4 O=texture2D(textureSampler,vTextureCoord*vec2(clampX,clampY));vec3 P=vec3(A(N.rgb,silhouette_amount/255.,0.3));P.r=N.r;gl_FragColor=vec4(H(P,O.rgb)*N.a,N.a);}";var Nf="float A(vec3 B,float C,float D){vec3 E=vec3(0.2125,0.7154,0.0721);float F=dot(B,E);float G=smoothstep(max(C-D,0.),min(C+D,1.),F);return G;}vec3 H(vec3 I,vec3 J,vec3 K){float L=max(max(I.r,I.g),I.b);return J*L+K*(1.-L);}float M(float N,float O){return(N<0.5)?2.*N*O:1.-2.*(1.-N)*(1.-O);}vec3 P(vec3 N,vec3 O){vec3 Q;Q.r=M(N.r,O.r);Q.g=M(N.g,O.g);Q.b=M(N.b,O.b);return Q;}varying vec2 vTextureCoord;uniform sampler2D uSampler;uniform sampler2D textureSampler;uniform float silhouette_amount;uniform float clampX;uniform float clampY;void main(void){vec4 R=texture2D(uSampler,vTextureCoord);if(R.a==0.){gl_FragColor=vec4(0,0,0,0);return;}R.rgb/=R.a;vec4 S=texture2D(textureSampler,vTextureCoord*vec2(clampX,clampY));vec3 T=vec3(A(R.rgb,silhouette_amount/255.,0.3));vec3 U=H(T,vec3(1.),vec3(0.55,0.44,0.24));gl_FragColor=vec4(P(U,S.rgb)*R.a,R.a);}";var Mf="float A(vec3 B,float C,float D){vec3 E=vec3(0.2125,0.7154,0.0721);float F=dot(B,E);float G=smoothstep(max(C-D,0.),min(C+D,1.),F);return G;}vec3 H(vec3 I,vec3 J){vec3 K;K.r=(I.r>0.5)?(1.-(1.-J.r)*(1.-(I.r-0.5))):(J.r*(I.r+0.5));K.g=(I.g>0.5)?(1.-(1.-J.g)*(1.-(I.g-0.5))):(J.g*(I.g+0.5));K.b=(I.b>0.5)?(1.-(1.-J.b)*(1.-(I.b-0.5))):(J.b*(I.b+0.5));return K;}varying vec2 vTextureCoord;uniform sampler2D uSampler;uniform sampler2D textureSampler;uniform float silhouette_amount;uniform float clampX;uniform float clampY;void main(void){vec4 L=texture2D(uSampler,vTextureCoord);if(L.a==0.){gl_FragColor=vec4(0,0,0,0);return;}L.rgb/=L.a;vec4 M=texture2D(textureSampler,vTextureCoord*vec2(clampX,clampY));vec3 N=vec3(A(L.rgb,silhouette_amount/255.,0.3));gl_FragColor=vec4(vec3(M.rgb*N)*L.a,L.a);}";var Df="float A(vec3 B,float C,float D){vec3 E=vec3(0.2125,0.7154,0.0721);float F=dot(B,E);float G=smoothstep(max(C-D,0.),min(C+D,1.),F);return G;}vec3 H(vec3 I,vec3 J,vec3 K){float L=max(max(I.r,I.g),I.b);return J*L+K*(1.-L);}vec3 M(vec3 N,vec3 O){return mix(2.*N*O,1.-2.*(1.-N)*(1.-O),step(0.5,O));}vec3 P(vec3 I,vec3 J,vec3 K){float L=max(max(I.r,I.g),I.b);return J*L+K*(1.-L);}float Q(vec2 R){return fract(cos(dot(R,vec2(36.26,73.12)))*354.63);}float S(vec2 R){vec2 T=floor(R);vec2 U=smoothstep(vec2(0),vec2(1),fract(R));float V=mix(Q(T),Q(T+vec2(1,0)),U.x);float W=mix(Q(T+vec2(0,1)),Q(T+vec2(1)),U.x);return mix(V,W,U.y);}vec3 X(vec2 R,float Y,vec3 Z,vec3 a){R/=Y;float b;b=S(R/32.)*0.5875+S(R/16.)*0.2+S(R/8.)*0.1+S(R/4.)*0.05+S(R/2.)*0.025+S(R)*0.0125;return P(vec3(b),Z,a);}vec2 c(vec2 d,vec4 e){d*=e.xy;d+=e.zw;return d;}varying vec2 vTextureCoord;uniform sampler2D uSampler;uniform float silhouette_amount;uniform vec4 filterArea;void main(void){vec4 f=texture2D(uSampler,vTextureCoord);if(f.a==0.){gl_FragColor=vec4(0,0,0,0);return;}f.rgb/=f.a;vec3 g=f.bbb;vec3 h=vec3(A(g,silhouette_amount/255.,0.1));vec3 i=H(h,vec3(0.85,0.65,0.41),vec3(0.));vec2 j=c(vTextureCoord,filterArea);vec3 k=X(j,0.6,vec3(0.8),vec3(0.2));vec3 l=H(k,vec3(0.),vec3(0.62,0.33,0.19));gl_FragColor=vec4(M(l,i)*f.a,f.a);}";var wf="float A(vec3 B,float C,float D){vec3 E=vec3(0.2125,0.7154,0.0721);float F=dot(B,E);float G=smoothstep(max(C-D,0.),min(C+D,1.),F);return G;}varying vec2 vTextureCoord;uniform sampler2D uSampler;uniform sampler2D textureSampler;uniform float silhouette_amount;uniform float clampX;uniform float clampY;void main(void){vec4 H=texture2D(uSampler,vTextureCoord);if(H.a==0.){gl_FragColor=vec4(0,0,0,0);return;}H.rgb/=H.a;vec4 I=texture2D(textureSampler,vTextureCoord*vec2(clampX,clampY));vec3 J=H.bbb;vec3 K=vec3(A(J,silhouette_amount/255.,0.3));gl_FragColor=vec4(vec3(I.rgb*K)*H.a,H.a);}";var kf="float A(vec3 B,float C,float D){vec3 E=vec3(0.2125,0.7154,0.0721);float F=dot(B,E);float G=smoothstep(max(C-D,0.),min(C+D,1.),F);return G;}vec3 H(vec3 I,vec3 J,vec3 K){float L=max(max(I.r,I.g),I.b);return J*L+K*(1.-L);}float M(float N,float O){return O/(1.-N);}vec3 P(vec3 N,vec3 O){vec3 Q;Q.r=M(N.r,O.r);Q.g=M(N.g,O.g);Q.b=M(N.b,O.b);return Q;}varying vec2 vTextureCoord;uniform sampler2D uSampler;uniform sampler2D textureSampler;uniform float silhouette_amount;uniform float clampX;uniform float clampY;void main(void){vec4 R=texture2D(uSampler,vTextureCoord);if(R.a==0.){gl_FragColor=vec4(0,0,0,0);return;}R.rgb/=R.a;vec4 S=texture2D(textureSampler,vTextureCoord*vec2(clampX,clampY));vec3 T=R.bbb;vec3 U=vec3(A(T,silhouette_amount/255.,0.3));vec3 V=H(U,vec3(1.),vec3(0.55,0.44,0.24));gl_FragColor=vec4(P(S.rgb,V)*R.a,R.a);}";var Af="float A(vec3 B,float C,float D){vec3 E=vec3(0.2125,0.7154,0.0721);float F=dot(B,E);float G=smoothstep(max(C-D,0.),min(C+D,1.),F);return G;}vec3 H(vec3 I,vec3 J){vec3 K;K.r=(I.r>0.5)?(1.-(1.-J.r)*(1.-(I.r-0.5))):(J.r*(I.r+0.5));K.g=(I.g>0.5)?(1.-(1.-J.g)*(1.-(I.g-0.5))):(J.g*(I.g+0.5));K.b=(I.b>0.5)?(1.-(1.-J.b)*(1.-(I.b-0.5))):(J.b*(I.b+0.5));return K;}varying vec2 vTextureCoord;uniform sampler2D uSampler;uniform sampler2D textureSampler;uniform float clampX;uniform float clampY;void main(void){vec4 L=texture2D(uSampler,vTextureCoord);if(L.a==0.){gl_FragColor=vec4(0,0,0,0);return;}L.rgb/=L.a;vec4 M=texture2D(textureSampler,vTextureCoord*vec2(clampX,clampY));vec3 N=L.bbb;gl_FragColor=vec4(H(M.rgb,N)*L.a,L.a);}";var Of="vec3 A(vec3 B,vec3 C,vec3 D){float E=max(max(B.r,B.g),B.b);return C*E+D*(1.-E);}vec3 F(vec2 G,vec3 H,vec3 I){float J;float K=12.9898;float L=151.7182;float M=43758.5453;float N=dot(G,vec2(K,L));float O=mod(N,3.14);float P=fract(sin(O)*M);return A(vec3(P),H,I);}vec3 Q(vec3 B,vec3 C,vec3 D){float E=max(max(B.r,B.g),B.b);return C*E+D*(1.-E);}vec3 R(vec3 S,vec3 T){return mix(2.*S*T,1.-2.*(1.-S)*(1.-T),step(0.5,T));}vec3 U(vec3 S,vec3 T){vec3 P;P.r=(S.r>0.5)?(1.-(1.-T.r)*(1.-(S.r-0.5))):(T.r*(S.r+0.5));P.g=(S.g>0.5)?(1.-(1.-T.g)*(1.-(S.g-0.5))):(T.g*(S.g+0.5));P.b=(S.b>0.5)?(1.-(1.-T.b)*(1.-(S.b-0.5))):(T.b*(S.b+0.5));return P;}varying vec2 vTextureCoord;uniform sampler2D uSampler;void main(void){vec4 V=texture2D(uSampler,vTextureCoord);if(V.a==0.){gl_FragColor=vec4(0,0,0,0);return;}V.rgb/=V.a;vec3 W=F(vTextureCoord,vec3(0.3),vec3(0.6));vec3 X=V.bbb;vec3 Y=Q(X,vec3(0.93,0.68,0.41),vec3(0.));vec3 Z=R(V.rgb,Y);gl_FragColor=vec4(U(W,Z)*V.a,V.a);}";var Rf="float A(vec3 B,float C,float D){vec3 E=vec3(0.2125,0.7154,0.0721);float F=dot(B,E);float G=smoothstep(max(C-D,0.),min(C+D,1.),F);return G;}vec3 H(vec3 I,vec3 J,vec3 K){float L=max(max(I.r,I.g),I.b);return J*L+K*(1.-L);}float M(float N,float O){return(N<0.5)?2.*N*O:1.-2.*(1.-N)*(1.-O);}vec3 P(vec3 N,vec3 O){vec3 Q;Q.r=M(N.r,O.r);Q.g=M(N.g,O.g);Q.b=M(N.b,O.b);return Q;}varying vec2 vTextureCoord;uniform sampler2D uSampler;uniform sampler2D textureSampler;uniform float silhouette_amount;uniform float clampX;uniform float clampY;void main(void){vec4 R=texture2D(uSampler,vTextureCoord);if(R.a==0.){gl_FragColor=vec4(0,0,0,0);return;}R.rgb/=R.a;vec4 S=texture2D(textureSampler,vTextureCoord*vec2(clampX,clampY));vec3 T=vec3(A(R.rgb,silhouette_amount/255.,0.3));vec3 U=H(T,vec3(0.93,0.68,0.41),vec3(0.));gl_FragColor=vec4(P(U,S.rgb)*R.a,R.a);}";var Lf="float A(float B,float C){return(B<0.5)?2.*B*C:1.-2.*(1.-B)*(1.-C);}vec3 D(vec3 B,vec3 C){vec3 E;E.r=A(B.r,C.r);E.g=A(B.g,C.g);E.b=A(B.b,C.b);return E;}vec3 F(vec3 G,float H){return pow(G,vec3(H));}vec3 I(vec3 G,float J,float K){vec3 L=F(G,J);vec3 M=((L-0.5)*K)+0.5;return M;}varying vec2 vTextureCoord;uniform sampler2D uSampler;uniform sampler2D textureSampler;uniform float clampX;uniform float clampY;void main(void){vec4 N=texture2D(uSampler,vTextureCoord);if(N.a==0.){gl_FragColor=vec4(0,0,0,0);return;}N.rgb/=N.a;vec4 O=texture2D(textureSampler,vTextureCoord*vec2(clampX,clampY));vec3 P=N.ggg;vec3 Q=I(P,1.,1.4);gl_FragColor=vec4(D(Q,O.rgb)*N.a,N.a);}";var Vf="float A(vec3 B,float C,float D){vec3 E=vec3(0.2125,0.7154,0.0721);float F=dot(B,E);float G=smoothstep(max(C-D,0.),min(C+D,1.),F);return G;}vec3 H(vec3 I,vec3 J){return max(I,J);}float K(float I,float J){return(I<0.5)?2.*I*J:1.-2.*(1.-I)*(1.-J);}vec3 L(vec3 I,vec3 J){vec3 M;M.r=K(I.r,J.r);M.g=K(I.g,J.g);M.b=K(I.b,J.b);return M;}float N(vec3 O){return dot(O,vec3(0.299,0.587,0.114));}varying vec2 vTextureCoord;uniform sampler2D uSampler;uniform sampler2D textureSampler;uniform sampler2D blurSampler;uniform float color_amount;uniform float clampX;uniform float clampY;void main(void){vec4 P=texture2D(uSampler,vTextureCoord);if(P.a==0.){gl_FragColor=vec4(0,0,0,0);return;}P.rgb/=P.a;vec4 Q=texture2D(textureSampler,vTextureCoord*vec2(clampX,clampY));vec4 R=texture2D(blurSampler,vTextureCoord*vec2(clampX,clampY));vec3 S=vec3(N(P.rgb));vec3 T=L(Q.rgb,S);vec3 U=vec3(A(P.rgb,color_amount/255.,0.4));gl_FragColor=vec4(H(R.rgb,H(U,T))*P.a,P.a);}";var Uf="float A(vec3 B,float C,float D){vec3 E=vec3(0.2125,0.7154,0.0721);float F=dot(B,E);float G=smoothstep(max(C-D,0.),min(C+D,1.),F);return G;}vec3 H(vec3 I,vec3 J,vec3 K){float L=max(max(I.r,I.g),I.b);return J*L+K*(1.-L);}vec3 M(vec3 N,vec3 O){return 1.-(1.-N)*(1.-O);}varying vec2 vTextureCoord;uniform sampler2D uSampler;uniform sampler2D textureSampler;uniform float silhouette_amount;uniform float clampX;uniform float clampY;void main(void){vec4 P=texture2D(uSampler,vTextureCoord);if(P.a==0.){gl_FragColor=vec4(0,0,0,0);return;}P.rgb/=P.a;vec4 Q=texture2D(textureSampler,vTextureCoord*vec2(clampX,clampY));vec3 R=vec3(A(P.rgb,silhouette_amount/255.,0.3));vec3 S=H(R,vec3(0.85,0.65,0.41),vec3(0.));gl_FragColor=vec4(M(S,Q.rgb)*P.a,P.a);}";var Gf="vec3 A(vec3 B,vec3 C,vec3 D){float E=max(max(B.r,B.g),B.b);return C*E+D*(1.-E);}vec3 F(vec2 G,vec3 H,vec3 I){float J;float K=12.9898;float L=151.7182;float M=43758.5453;float N=dot(G,vec2(K,L));float O=mod(N,3.14);float P=fract(sin(O)*M);return A(vec3(P),H,I);}vec3 Q(vec3 B,vec3 C,vec3 D){float E=max(max(B.r,B.g),B.b);return C*E+D*(1.-E);}float R(float S,float T){return(((2.*S)==0.)?(2.*S):max((1.-((1.-T)/(2.*S))),0.));}vec3 U(vec3 S,vec3 T){vec3 P;P.r=R(S.r,T.r);P.g=R(S.g,T.g);P.b=R(S.b,T.b);return P;}float V(float S,float T){return(S<0.5)?2.*S*T:1.-2.*(1.-S)*(1.-T);}vec3 W(vec3 S,vec3 T){vec3 P;P.r=V(S.r,T.r);P.g=V(S.g,T.g);P.b=V(S.b,T.b);return P;}vec3 X(vec3 B,vec3 C,vec3 D){float E=max(max(B.r,B.g),B.b);return C*E+D*(1.-E);}float Y(vec2 Z){return fract(cos(dot(Z,vec2(36.26,73.12)))*354.63);}float a(vec2 Z){vec2 b=floor(Z);vec2 O=smoothstep(vec2(0),vec2(1),fract(Z));float c=mix(Y(b),Y(b+vec2(1,0)),O.x);float d=mix(Y(b+vec2(0,1)),Y(b+vec2(1)),O.x);return mix(c,d,O.y);}vec3 e(vec2 Z,float f,vec3 g,vec3 h){Z/=f;float i;i=a(Z/32.)*0.5875+a(Z/16.)*0.2+a(Z/8.)*0.1+a(Z/4.)*0.05+a(Z/2.)*0.025+a(Z)*0.0125;return X(vec3(i),g,h);}vec2 j(vec2 G,vec4 k){G*=k.xy;G+=k.zw;return G;}varying vec2 vTextureCoord;uniform sampler2D uSampler;uniform vec4 filterArea;void main(void){vec4 l=texture2D(uSampler,vTextureCoord);if(l.a==0.){gl_FragColor=vec4(0,0,0,0);return;}l.rgb/=l.a;vec3 m=l.ggg;vec2 n=j(vTextureCoord,filterArea);vec3 o=e(n,4.,vec3(1.),vec3(0.7));vec3 p=U(l.rgb,o);vec3 q=F(vTextureCoord,vec3(0.73),vec3(0.15));vec3 r=W(m,q);r=W(p,r);gl_FragColor=vec4(vec3(r.b)*l.a,l.a);}";var Hf="float A(vec3 B,float C,float D){vec3 E=vec3(0.2125,0.7154,0.0721);float F=dot(B,E);float G=smoothstep(max(C-D,0.),min(C+D,1.),F);return G;}vec3 H(vec3 I,vec3 J,vec3 K){float L=max(max(I.r,I.g),I.b);return J*L+K*(1.-L);}vec3 M(vec2 N,vec3 O,vec3 P){float Q;float R=12.9898;float S=151.7182;float T=43758.5453;float U=dot(N,vec2(R,S));float V=mod(U,3.14);float W=fract(sin(V)*T);return H(vec3(W),O,P);}vec3 X(vec3 I,vec3 J,vec3 K){float L=max(max(I.r,I.g),I.b);return J*L+K*(1.-L);}vec3 Y(vec3 I,vec3 J,vec3 K){float L=max(max(I.r,I.g),I.b);return J*L+K*(1.-L);}float Z(vec2 a){return fract(cos(dot(a,vec2(36.26,73.12)))*354.63);}float b(vec2 a){vec2 c=floor(a);vec2 V=smoothstep(vec2(0),vec2(1),fract(a));float d=mix(Z(c),Z(c+vec2(1,0)),V.x);float e=mix(Z(c+vec2(0,1)),Z(c+vec2(1)),V.x);return mix(d,e,V.y);}vec3 f(vec2 a,float g,vec3 h,vec3 i){a/=g;float j;j=b(a/32.)*0.5875+b(a/16.)*0.2+b(a/8.)*0.1+b(a/4.)*0.05+b(a/2.)*0.025+b(a)*0.0125;return Y(vec3(j),h,i);}vec2 k(vec2 N,vec4 l){N*=l.xy;N+=l.zw;return N;}varying vec2 vTextureCoord;uniform sampler2D uSampler;uniform float grain_amount;uniform float silhouette_amount;uniform vec4 filterArea;void main(void){vec4 m=texture2D(uSampler,vTextureCoord);if(m.a==0.){gl_FragColor=vec4(0,0,0,0);return;}m.rgb/=m.a;vec2 n=k(vTextureCoord,filterArea);vec3 o=f(n,grain_amount,vec3(0.8),vec3(0.2));vec3 p=X(o,vec3(0.42,0.34,0.24),vec3(0.84,0.71,0.50));vec3 q=vec3(A(m.rgb,silhouette_amount/255.,0.3));gl_FragColor=vec4(vec3(p*q)*m.a,m.a);}";var Xf=class extends PIXI.Filter{constructor(e){let t=Hf,r=!1;switch(e){case BFN.CONST.OLD_PHOTO_PRESETS.PRESET_2:r=!1,t=Gf;break;case BFN.CONST.OLD_PHOTO_PRESETS.PRESET_4:r=!0,t=Uf;break;case BFN.CONST.OLD_PHOTO_PRESETS.PRESET_5:r=!0,t=Vf;break;case BFN.CONST.OLD_PHOTO_PRESETS.PRESET_6:r=!0,t=Lf;break;case BFN.CONST.OLD_PHOTO_PRESETS.PRESET_7:r=!0,t=Rf;break;case BFN.CONST.OLD_PHOTO_PRESETS.PRESET_8:r=!1,t=Of;break;case BFN.CONST.OLD_PHOTO_PRESETS.PRESET_9:r=!0,t=Af;break;case BFN.CONST.OLD_PHOTO_PRESETS.PRESET_10:r=!0,t=kf;break;case BFN.CONST.OLD_PHOTO_PRESETS.PRESET_11:r=!0,t=wf;break;case BFN.CONST.OLD_PHOTO_PRESETS.PRESET_12:r=!1,t=Df;break;case BFN.CONST.OLD_PHOTO_PRESETS.PRESET_13:r=!0,t=Mf;break;case BFN.CONST.OLD_PHOTO_PRESETS.PRESET_14:r=!0,t=Nf;break;case BFN.CONST.OLD_PHOTO_PRESETS.PRESET_15:r=!0,t=Pf;break;case BFN.CONST.OLD_PHOTO_PRESETS.PRESET_16:r=!0,t=Ef;break;case BFN.CONST.OLD_PHOTO_PRESETS.PRESET_17:r=!1,t=Cf;break;case BFN.CONST.OLD_PHOTO_PRESETS.PRESET_18:r=!1,t=_f;break}super(O,t);this.isUseClamp=r,this.currentPreset=e,this.padding=0}apply(e,t,r,a){if(this.isUseClamp!==!1){let s=BFN.FilterHelper.calculateFilterClamp(t,r,this.blurSampler||null);this.uniforms.clampX=s.x,this.uniforms.clampY=s.y}e.applyFilter(this,t,r,a)}get textureSampler(){return this.uniforms.textureSampler}set textureSampler(e){this.uniforms.textureSampler=e}get blurSampler(){return this.uniforms.blurSampler}set blurSampler(e){e.baseTexture.isPowerOfTwo=!0,this.uniforms.blurSampler=e}get color(){return this.uniforms.color}set color(e){e=BFN.FilterHelper.hex2rgb(e),this.uniforms.color=e}get grain_amount(){return this.uniforms.grain_amount}set grain_amount(e){this.uniforms.grain_amount=e}get silhouette_amount(){return this.uniforms.silhouette_amount}set silhouette_amount(e){this.uniforms.silhouette_amount=e}get blur_amount(){return this.uniforms.blur_amount}set blur_amount(e){this.uniforms.blur_amount=e}get color_amount(){return this.uniforms.color_amount}set color_amount(e){this.uniforms.color_amount=e}get contrast(){return this.uniforms.contrast}set contrast(e){this.uniforms.contrast=e}},zf=Xf;var Wf="vec3 A(vec3 B,vec3 C,vec3 D){float E=max(max(B.r,B.g),B.b);return C*E+D*(1.-E);}varying vec2 vTextureCoord;uniform sampler2D uSampler;uniform vec3 color1;uniform vec3 color2;void main(void){vec4 F=texture2D(uSampler,vTextureCoord);F.rgb=F.rgb/F.a;vec3 G=A(F.rgb,color1,color2);F.rgb=F.rgb*F.a;gl_FragColor=vec4(G,F.a);}";var $f=class extends PIXI.Filter{constructor(){super(O,Wf);this.padding=0}get color1(){return this.uniforms.color1}set color1(e){e=BFN.FilterHelper.hex2rgb(e),this.uniforms.color1=e}get color2(){return this.uniforms.color2}set color2(e){e=BFN.FilterHelper.hex2rgb(e),this.uniforms.color2=e}},jf=$f;var Yf="vec3 A(vec3 B,vec3 C){return mix(2.*B*C,1.-2.*(1.-B)*(1.-C),step(0.5,C));}vec3 D(vec3 B,vec3 C){return 1.-(1.-B)*(1.-C);}float E(vec3 F){return dot(F,vec3(0.299,0.587,0.114));}varying vec2 vTextureCoord;uniform sampler2D uSampler;uniform sampler2D textureSampler;uniform float amount;uniform float clampX;uniform float clampY;void main(void){vec4 G=texture2D(uSampler,vTextureCoord);if(G.a==0.){gl_FragColor=vec4(0,0,0,0);return;}G.rgb/=G.a;vec4 H=texture2D(textureSampler,vTextureCoord*vec2(clampX,clampY));vec3 I=G.rrr;vec3 J=vec3(0.43,0.54,0.57);vec3 K=D(I,G.rgb)*0.4+G.rgb*(1.-0.4);vec3 L=vec3(E(K));vec3 M=A(J,L);gl_FragColor=vec4((D(H.rgb,M)*amount+M*(1.-amount))*G.a,G.a);}";var qf="float A(float B,float C){return(B<0.5)?2.*B*C:1.-2.*(1.-B)*(1.-C);}vec3 D(vec3 B,vec3 C){vec3 E;E.r=A(B.r,C.r);E.g=A(B.g,C.g);E.b=A(B.b,C.b);return E;}vec3 F(vec3 B,vec3 C){return mix(2.*B*C,1.-2.*(1.-B)*(1.-C),step(0.5,C));}varying vec2 vTextureCoord;uniform sampler2D uSampler;uniform sampler2D textureSampler;uniform float frost_amount;uniform float clampX;uniform float clampY;void main(void){vec4 G=texture2D(uSampler,vTextureCoord);if(G.a==0.){gl_FragColor=vec4(0,0,0,0);return;}G.rgb/=G.a;vec4 H=texture2D(textureSampler,vTextureCoord*vec2(clampX,clampY));float I=1.+10./200.;vec3 J=G.rrr*I;vec4 K=mix(G,H,frost_amount);vec3 L=D(J,K.rgb);vec3 M=vec3(0.43,0.54,0.57);gl_FragColor=vec4(F(M,L)*G.a,G.a);}";var Kf=class extends PIXI.Filter{constructor(e){let t=O,r=qf;switch(e){case BFN.CONST.WINTER_PRESETS.PRESET_2:r=Yf;break}super(t,r);this.padding=0,this.currentPreset=e}apply(e,t,r,a){let s=BFN.FilterHelper.calculateFilterClamp(t,r);this.uniforms.clampX=s.x,this.uniforms.clampY=s.y,e.applyFilter(this,t,r,a)}get textureSampler(){return this.uniforms.textureSampler}set textureSampler(e){this.uniforms.textureSampler=e}get frost_amount(){return this.uniforms.frost_amount}set frost_amount(e){this.uniforms.frost_amount=e}get amount(){return this.uniforms.amount}set amount(e){this.uniforms.amount=e}},Jf=Kf;var Qf="vec3 A(vec2 B,float C,vec2 D,vec2 E){vec2 F=1./E;B=B+vec2(E.x*D.x,E.y*D.y);float G=F.x*C;float H=distance(E*0.5,B)*G;H=smoothstep(0.7,1.,H);return mix(vec3(0.,0.,0.),vec3(1.,1.,1.),vec3(H));}vec2 I(vec2 B,vec4 J){B*=J.xy;B+=J.zw;return B;}varying vec2 vTextureCoord;uniform sampler2D uSampler;uniform sampler2D blurSampler;uniform float size;uniform float slide_vertical;uniform float slide_horizontal;uniform float clampX;uniform float clampY;uniform vec4 filterArea;uniform vec2 resolutionXY;void main(void){vec4 K=texture2D(uSampler,vTextureCoord);if(K.a==0.){gl_FragColor=vec4(0,0,0,0);return;}K.rgb/=K.a;vec4 L=texture2D(blurSampler,vTextureCoord*vec2(clampX,clampY));if(L.a>0.){L.rgb/=L.a;}vec2 M=I(vTextureCoord,filterArea);vec2 N=vec2(-slide_horizontal,-slide_vertical);vec3 O=A(M,size,N,resolutionXY);K.rgb=mix(K.rgb,L.rgb,O)*K.a;gl_FragColor=K;}";var Zf="vec3 A(vec2 B,float C,vec2 D,float E){float F=radians(E);B=B-vec2(0.5);B*=mat2(cos(F),-sin(F),sin(F),cos(F));B+=vec2(0.5);B=B+vec2(D);float G=C;vec2 H=vec2(B.x,0.5);float I=distance(H,B)*C;float J=15.425*exp(-0.277*C);I=smoothstep(0.7+J/50.,1.,I);return vec3(I);}varying vec2 vTextureCoord;uniform sampler2D uSampler;uniform sampler2D blurSampler;uniform float size;uniform float angle;uniform float slide_vertical;uniform float clampX;uniform float clampY;void main(void){vec4 K=texture2D(uSampler,vTextureCoord);if(K.a==0.){gl_FragColor=vec4(0,0,0,0);return;}K.rgb/=K.a;vec4 L=texture2D(blurSampler,vTextureCoord*vec2(clampX,clampY));if(L.a>0.){L.rgb/=L.a;}vec2 M=vec2(0.,-slide_vertical);vec3 N=A(vTextureCoord*vec2(clampX,clampY),size,M,angle);K.rgb=mix(K.rgb,L.rgb,N)*K.a;gl_FragColor=K;}";var eg=class extends PIXI.Filter{constructor(e){let t=O,r=Zf;switch(e){case BFN.CONST.TILT_SHIFT_PRESETS.PRESET_2:r=Qf;break}super(t,r);this.padding=0,this.currentPreset=e}apply(e,t,r,a){let s=BFN.FilterHelper.calculateFilterClamp(t,r,this.blurSampler||null);this.uniforms.clampX=s.x,this.uniforms.clampY=s.y,this.uniforms.resolutionXY=[r.destinationFrame.width,r.destinationFrame.height],e.applyFilter(this,t,r,a)}get blurSampler(){return this.uniforms.blurSampler}set blurSampler(e){e.baseTexture.isPowerOfTwo=!0,this.uniforms.blurSampler=e}get size(){return this.uniforms.size}set size(e){this.uniforms.size=e}get blur_amount(){return this.uniforms.blur_amount}set blur_amount(e){this.uniforms.blur_amount=e}get angle(){return this.uniforms.angle}set angle(e){this.uniforms.angle=e}get slide_vertical(){return this.uniforms.slide_vertical}set slide_vertical(e){this.uniforms.hasOwnProperty("slide_vertical")&&(this.uniforms.slide_vertical=e)}get slide_horizontal(){return this.uniforms.slide_horizontal}set slide_horizontal(e){this.uniforms.hasOwnProperty("slide_horizontal")&&(this.uniforms.slide_horizontal=e)}},tg=eg;var ig="varying vec2 vTextureCoord;uniform sampler2D uSampler;uniform sampler2D blurSampler;uniform float red;uniform float navy;uniform float clampX;uniform float clampY;void main(void){vec4 A=texture2D(uSampler,vTextureCoord);if(A.a==0.){gl_FragColor=vec4(0,0,0,0);return;}A.rgb/=A.a;vec4 B=texture2D(blurSampler,vTextureCoord*vec2(clampX,clampY));if(B.a>0.){B.rgb/=B.a;}red;navy;vec3 C=vec3(0.984,0.886,0.647);vec3 D=vec3(0.85,0.101,0.129);vec3 E=vec3(0.,0.2,0.298);float F=0.;float G=0.;float H=(B.r+B.g+B.b)/3.;vec3 I=vec3(0.);vec3 J=vec3(0.);float K=red;float L=navy;if(H<K){J.r=D.r;J.g=D.g;J.b=D.b;I=J;}else if(H>F){J.r=C.r;J.g=C.g;J.b=C.b;I=J;}else{J.rgb=vec3((H-K)/(F-K));I=J;}vec3 M=vec3(0.);if(H<L){M.r=E.r;M.g=E.g;M.b=E.b;I=M;}else if(H>G){M.r=J.r;M.g=J.g;M.b=J.b;I=M;}else{M.rgb=vec3((H-L)/(G-L));I=M;}gl_FragColor=vec4(I.rgb*B.a,B.a);}";var rg="vec2 A(vec2 B,vec4 C){B*=C.xy;B+=C.zw;return B;}vec2 D(vec2 B,vec4 C){B-=C.zw;B/=C.xy;return B;}vec2 E(vec2 F,vec2 G){return floor(mod(F,G));}vec4 H(sampler2D I,vec2 J,vec4 C,float K,vec2 L,float M){vec2 N=A(J,C);N=floor(E(N,vec2(K*M))/M);N=D(N,C);return texture2D(I,N*vec2(L.x,L.y));}vec3 O(vec3 P,vec3 Q,vec3 R){float S=max(max(P.r,P.g),P.b);return Q*S+R*(1.-S);}vec3 T(vec3 U,float V,float W){float X=U.r*0.309+U.g*0.609+U.b*0.082;float Y=clamp(X-V,0.,1.)/clamp(abs(W-V),0.,1.);return vec3(clamp(vec3(Y),0.,1.));}vec3 Z(vec3 a,float b){float c=3.14159265;float d=(b/180.)*c;float e=sin(d),f=cos(d);vec3 g=(vec3(2.*f,-sqrt(3.)*e-f,sqrt(3.)*e-f)+1.)/3.;return vec3(dot(a,g.xyz),dot(a,g.zxy),dot(a,g.yzx));}varying vec2 vTextureCoord;uniform sampler2D uSampler;uniform sampler2D textureSampler;uniform sampler2D starSampler;uniform float silhouette_amount;uniform float color_space;uniform float star_size;uniform float clampX;uniform float clampY;uniform vec4 filterArea;void main(void){vec4 h=texture2D(uSampler,vTextureCoord);if(h.a==0.){gl_FragColor=vec4(0,0,0,0);return;}h.rgb/=h.a;vec4 i=texture2D(textureSampler,vTextureCoord*vec2(clampX,clampY));vec3 j=T(h.rgb,silhouette_amount/255.,150./255.);vec4 k=H(starSampler,vTextureCoord,filterArea,256.,vec2(clampX,clampY),star_size);k.rgb=O(k.rgb,vec3(1.),vec3(0.98,0.94,0.51));j=clamp(j*i.rgb,0.,1.);j=clamp(j*k.rgb,0.,1.);h.rgb=j;h.rgb=Z(h.rgb,color_space)*h.a;gl_FragColor=h;}";var ag="float A(vec3 B){return dot(B,vec3(0.299,0.587,0.114));}vec3 C(vec3 D,float E){return pow(D,vec3(E));}vec3 F(vec3 D,float G,float H){vec3 I=C(D,G);vec3 J=((I-0.5)*H)+0.5;return J;}varying vec2 vTextureCoord;uniform sampler2D uSampler;uniform sampler2D textureSampler;uniform sampler2D adaptiveSharpenSampler;uniform float clampX;uniform float clampY;void main(void){vec4 K=texture2D(uSampler,vTextureCoord);if(K.a==0.){gl_FragColor=vec4(0,0,0,0);return;}K.rgb/=K.a;vec4 L=texture2D(textureSampler,vTextureCoord*vec2(clampX,clampY));vec4 M=texture2D(adaptiveSharpenSampler,vTextureCoord*vec2(clampX,clampY));vec3 N=vec3(A(M.rgb));gl_FragColor=vec4(vec3(L.rgb*N)*K.a,K.a);}";var sg="vec3 A(vec3 B,float C){return pow(B,vec3(C));}vec3 D(vec3 B,float E,float F){vec3 G=A(B,E);vec3 H=((G-0.5)*F)+0.5;return H;}varying vec2 vTextureCoord;uniform sampler2D uSampler;uniform sampler2D textureSampler;uniform sampler2D adaptiveSharpenSampler;uniform float clampX;uniform float clampY;void main(void){vec4 I=texture2D(uSampler,vTextureCoord);if(I.a==0.){gl_FragColor=vec4(0,0,0,0);return;}I.rgb/=I.a;vec4 J=texture2D(textureSampler,vTextureCoord*vec2(clampX,clampY));vec4 K=texture2D(adaptiveSharpenSampler,vTextureCoord*vec2(clampX,clampY));gl_FragColor=vec4(vec3(J.rgb*K.rgb)*I.a,I.a);}";var og="float A(vec3 B){return dot(B,vec3(0.299,0.587,0.114));}vec3 C(vec3 D,float E){return pow(D,vec3(E));}vec3 F(vec3 D,float G,float H){vec3 I=C(D,G);vec3 J=((I-0.5)*H)+0.5;return J;}vec3 K(vec3 D,vec3 L,vec3 M){float N=max(max(D.r,D.g),D.b);return L*N+M*(1.-N);}vec2 O(vec2 P,vec4 Q){P*=Q.xy;P+=Q.zw;return P;}vec3 R(vec2 P,vec4 S,float T,float U,vec3 V,vec3 W){P=O(P,S);float X=radians(U);P*=mat2(cos(X),-sin(X),sin(X),cos(X));P.x=P.x/T;float Y=mod(P.x,1.);Y=(Y<0.5)?Y=pow(Y,2.5)*2.:Y=pow(1.-Y,2.5)*1.;Y=smoothstep(0.00+min(T/1250.,0.04),0.05,Y);return K(vec3(Y),W,V);}vec3 Z(vec3 a,vec3 b){return mix(2.*a*b,1.-2.*(1.-a)*(1.-b),step(0.5,b));}vec3 c(vec3 D,vec3 L,vec3 M){float N=max(max(D.r,D.g),D.b);return L*N+M*(1.-N);}vec2 d(vec2 P,vec4 Q){P*=Q.xy;P+=Q.zw;return P;}vec2 e(vec2 P,vec4 Q){P-=Q.zw;P/=Q.xy;return P;}float f(vec3 B){return dot(B,vec3(0.299,0.587,0.114));}vec2 g(vec2 h,float i){return floor(h/i)*i;}vec3 j(sampler2D k,vec2 P,vec4 S,vec2 l,float m,vec3 n,vec3 o){vec2 p=d(P,S);vec2 q=vec2(1./S.xy);vec2 r=vec2(1./l.x-q.x,1./l.y-q.y);vec2 s=g(p,m)+0.5*m;float t=min(length(p-s)/((m)*0.5),1.);s=e(s,S);vec3 u=texture2D(k,clamp(s,vec2(0.),r)).rgb;float v=1.-f(u);t=smoothstep(min(max(v,0.2),0.8),max(min(v+0.1,1.),0.25),t);vec3 w=c(vec3(t),o,n);return w;}varying vec2 vTextureCoord;uniform sampler2D uSampler;uniform float halftone_size;uniform float line_width;uniform float line_angle;uniform vec3 line_color;uniform vec3 background_color;uniform vec4 filterArea;uniform float clampX;uniform float clampY;void main(void){vec4 x=texture2D(uSampler,vTextureCoord);if(x.a==0.){gl_FragColor=vec4(0,0,0,0);return;}x.rgb/=x.a;vec3 y=vec3(A(x.rgb));vec3 z=F(y,1.,3.);vec3 AA=R(vTextureCoord,filterArea,line_width,line_angle,background_color,line_color);vec3 AB=Z(AA,z);vec3 AC=j(uSampler,vTextureCoord,filterArea,vec2(clampX,clampY),halftone_size,vec3(0.6),vec3(1.));gl_FragColor=vec4(Z(AC,AB)*x.a,x.a);}";var ng="float A(vec3 B,float C,float D){vec3 E=vec3(0.2125,0.7154,0.0721);float F=dot(B,E);float G=smoothstep(max(C-D,0.),min(C+D,1.),F);return G;}vec3 H(vec3 I,float J,float K){float L=I.r*0.309+I.g*0.609+I.b*0.082;float M=clamp(L-J,0.,1.)/clamp(abs(K-J),0.,1.);return vec3(clamp(vec3(M),0.,1.));}vec3 N(vec3 O,vec3 P,vec3 Q){float R=max(max(O.r,O.g),O.b);return P*R+Q*(1.-R);}vec3 S(vec3 B,float T){float U=3.14159265;float V=(T/180.)*U;float W=sin(V),X=cos(V);vec3 Y=(vec3(2.*X,-sqrt(3.)*W-X,sqrt(3.)*W-X)+1.)/3.;return vec3(dot(B,Y.xyz),dot(B,Y.zxy),dot(B,Y.yzx));}varying vec2 vTextureCoord;uniform sampler2D uSampler;uniform float silhouette_amount;uniform float color_space;void main(void){vec4 Z=texture2D(uSampler,vTextureCoord);if(Z.a==0.){gl_FragColor=vec4(0,0,0,0);return;}Z.rgb/=Z.a;vec3 a=H(Z.rgb,silhouette_amount/255.,150./255.);vec3 b=H(Z.rgb,165./255.,186./255.);a=N(a,vec3(1.),vec3(0.19,0.67,1.00));b=N(b,vec3(1.),vec3(0.90,0.47,0.49));Z.rgb=clamp(a*b,0.,1.);Z.rgb=S(Z.rgb,color_space)*Z.a;gl_FragColor=Z;}";var lg="vec4 A(sampler2D B,vec2 C,vec2 D,vec2 E,vec2 F,int G,int H,vec4 I){if(H==1){E=E/F;D=D/F;F=vec2(1.,1.);}float J=(((C.x*F.x)-D.x)/E.x);float K=(((C.y*F.y)-D.y)/E.y);if(G==0&&(J<0.||J>1.||K<0.||K>1.)){return I;}else{J=mod((mod(J,1.)+1.),1.);K=mod((mod(K,1.)+1.),1.);vec2 L=vec2((J/F.x),(K/F.y));return texture2D(B,L);}}float M(vec3 N,float O,float P){vec3 Q=vec3(0.2125,0.7154,0.0721);float R=dot(N,Q);float S=smoothstep(max(O-P,0.),min(O+P,1.),R);return S;}vec3 T(vec3 U,float V,float W){float X=U.r*0.309+U.g*0.609+U.b*0.082;float Y=clamp(X-V,0.,1.)/clamp(abs(W-V),0.,1.);return vec3(clamp(vec3(Y),0.,1.));}vec3 Z(vec3 a,vec3 b,vec3 c){float d=max(max(a.r,a.g),a.b);return b*d+c*(1.-d);}vec3 e(vec3 N,float f){float g=3.14159265;float h=(f/180.)*g;float i=sin(h),j=cos(h);vec3 k=(vec3(2.*j,-sqrt(3.)*i-j,sqrt(3.)*i-j)+1.)/3.;return vec3(dot(N,k.xyz),dot(N,k.zxy),dot(N,k.yzx));}varying vec2 vTextureCoord;uniform sampler2D uSampler;uniform sampler2D textureSampler;uniform float silhouette_amount;uniform float color_space;uniform float clampX;uniform float clampY;uniform vec4 filterArea;void main(void){vec4 l=texture2D(uSampler,vTextureCoord);if(l.a==0.){gl_FragColor=vec4(0,0,0,0);return;}l.rgb/=l.a;vec4 m=texture2D(textureSampler,vTextureCoord*vec2(clampX,clampY));silhouette_amount;color_space;vec4 I=vec4(1);vec2 n=vec2(clampX,clampY);vec2 o=1./filterArea.xy;vec3 p=vec3(M(l.rgb,silhouette_amount/255.,0.2));vec4 q=A(uSampler,vTextureCoord,vec2(0.035,0.0400),vec2(1.,1.),n,1,0,I);vec4 r=A(uSampler,vTextureCoord,vec2(-0.030,-0.022),vec2(1.,1.),n,1,0,I);vec3 s=vec3(T(q.rgb,102./255.,0.5));vec3 t=vec3(T(r.rgb,102./255.,0.5));s=Z(s,vec3(1.),vec3(0.84,0.92,1.00));t=Z(t,vec3(1.),vec3(1.00,0.62,0.70));vec3 u=s*t*p;l.rgb=clamp(s*t,0.,1.);l.rgb=clamp(l.rgb*p,0.,1.);l.rgb=clamp(l.rgb*m.rgb,0.,1.);l.rgb=e(l.rgb,color_space)*l.a;gl_FragColor=l;}";var cg=class extends PIXI.Filter{constructor(e){let t=!0,r=O,a=lg;switch(e){case BFN.CONST.PATRIOTIC_PRESETS.PRESET_2:t=!1,a=ng;break;case BFN.CONST.PATRIOTIC_PRESETS.PRESET_3:a=og;break;case BFN.CONST.PATRIOTIC_PRESETS.PRESET_4:a=sg;break;case BFN.CONST.PATRIOTIC_PRESETS.PRESET_5:a=ag;break;case BFN.CONST.PATRIOTIC_PRESETS.PRESET_6:a=rg;break;case BFN.CONST.PATRIOTIC_PRESETS.PRESET_7:a=ig;break}super(r,a);this.isClamp=t,this.padding=0,this.currentPreset=e}apply(e,t,r,a){if(this.isClamp==!0){var s=BFN.FilterHelper.calculateFilterClamp(t,r,this.blurImage||null);this.uniforms.clampX=s.x,this.uniforms.clampY=s.y}e.applyFilter(this,t,r,a)}get textureSampler(){return this.uniforms.textureSampler}set textureSampler(e){this.uniforms.textureSampler=e}get blurImage(){return this.uniforms.blurSampler}set blurImage(e){e.baseTexture.isPowerOfTwo=!0,this.uniforms.blurSampler=e}get adaptiveSharpenSampler(){return this.uniforms.adaptiveSharpenSampler}set adaptiveSharpenSampler(e){this.uniforms.adaptiveSharpenSampler=e}get starSampler(){return this.uniforms.starSampler}set starSampler(e){this.uniforms.starSampler=e}get silhouette_amount(){return this.uniforms.silhouette_amount}set silhouette_amount(e){this.uniforms.silhouette_amount=e}get color_space(){return this.uniforms.color_space}set color_space(e){this.uniforms.color_space=e}get halftone_size(){return this.uniforms.halftone_size}set halftone_size(e){this.uniforms.halftone_size=e}get line_width(){return this.uniforms.line_width}set line_width(e){this.uniforms.line_width=e}get line_angle(){return this.uniforms.line_angle}set line_angle(e){this.uniforms.line_angle=e}get line_color(){return this.uniforms.line_color}set line_color(e){e=BFN.FilterHelper.hex2rgb(e),this.uniforms.line_color=e}get background_color(){return this.uniforms.background_color}set background_color(e){e=BFN.FilterHelper.hex2rgb(e),this.uniforms.background_color=e}get star_size(){return this.uniforms.star_size}set star_size(e){this.uniforms.star_size=e}get red(){return this.uniforms.red}set red(e){this.uniforms.red=e}get navy(){return this.uniforms.navy}set navy(e){this.uniforms.navy=e}},hg=cg;var ug="vec3 A(vec3 B,float C,float D){float E=B.r*0.309+B.g*0.609+B.b*0.082;float F=clamp(E-C,0.,1.)/clamp(abs(D-C),0.,1.);return vec3(clamp(vec3(F),0.,1.));}vec3 G(vec3 H,vec3 I){return mix(2.*H*I,1.-2.*(1.-H)*(1.-I),step(0.5,I));}float J(float K,float L,float M,float N){if(N==1.){return clamp((M-K)/(L-K),0.,1.);}else{return smoothstep(K,L,M);}}vec3 O(vec2 P,vec2 Q,float R,float S,vec3 T,vec3 U,vec3 V,float W,float X,float Y){P=P*Q;float Z=radians(R);P=P-0.5;P*=mat2(cos(Z),-sin(Z),sin(Z),cos(Z));P=P+0.5;vec3 a=mix(T,U,J(W,X,P.y,S));a=mix(a,V,J(X,Y,P.y,S));return a;}varying vec2 vTextureCoord;uniform sampler2D uSampler;uniform float silhouette_amount;uniform float clampX;uniform float clampY;void main(void){vec4 b=texture2D(uSampler,vTextureCoord);vec3 c=O(vTextureCoord,vec2(clampX,clampY),180.,1.,vec3(0.039,0.,0.69),vec3(1.,0.,0.),vec3(1.,0.98,0.),0.,0.5,1.);float d=silhouette_amount/255.;vec3 e=A(b.rgb,d,1.);gl_FragColor=vec4(G(c,e),b.a);}";var dg="vec3 A(vec3 B,float C,float D){float E=B.r*0.309+B.g*0.609+B.b*0.082;float F=clamp(E-C,0.,1.)/clamp(abs(D-C),0.,1.);return vec3(clamp(vec3(F),0.,1.));}vec3 G(vec3 H,vec3 I){return mix(2.*H*I,1.-2.*(1.-H)*(1.-I),step(0.5,I));}vec3 J(vec3 H,vec3 I){float K=min(H.r,I.r);float L=min(H.g,I.g);float M=min(H.b,I.b);return vec3(K,L,M);}float N(float O,float P,float Q,float R){if(R==1.){return clamp((Q-O)/(P-O),0.,1.);}else{return smoothstep(O,P,Q);}}vec3 S(vec2 T,vec2 U,float V,float W,vec3 X,vec3 Y,vec3 Z,vec3 a,float b,float c,float d,float e){T=T*U;float f=radians(V);T=T-0.5;T*=mat2(cos(f),-sin(f),sin(f),cos(f));T=T+0.5;vec3 g=mix(X,Y,N(b,c,T.y,W));g=mix(g,Z,N(c,d,T.y,W));g=mix(g,a,N(d,e,T.y,W));return g;}varying vec2 vTextureCoord;uniform sampler2D uSampler;uniform sampler2D halftoneSampler;uniform float silhouette_amount;uniform float clampX;uniform float clampY;void main(void){vec4 h=texture2D(uSampler,vTextureCoord);vec4 i=texture2D(halftoneSampler,vTextureCoord*vec2(clampX,clampY));vec3 X=vec3(0.,1.,1.);vec3 Y=vec3(0.,1.,0.);vec3 Z=vec3(1.,1.,0.);vec3 a=vec3(1.,0.,0.);vec3 j=S(vTextureCoord,vec2(clampX,clampY),90.,1.,X,Y,Z,a,0.,0.5,0.75,1.);float k=silhouette_amount/255.;vec3 l=A(h.rgb,k,1.);i=clamp(i,0.,1.);vec3 m=J(j,l);gl_FragColor=vec4(G(i.rgb,m)*0.40+m*(1.-0.40),h.a);}";var mg="vec3 A(vec3 B,float C,float D){float E=B.r*0.309+B.g*0.609+B.b*0.082;float F=clamp(E-C,0.,1.)/clamp(abs(D-C),0.,1.);return vec3(clamp(vec3(F),0.,1.));}vec3 G(vec3 H,vec3 I){return mix(2.*H*I,1.-2.*(1.-H)*(1.-I),step(0.5,I));}float J(float K,float L,float M,float N){if(N==1.){return clamp((M-K)/(L-K),0.,1.);}else{return smoothstep(K,L,M);}}vec3 O(vec2 P,vec2 Q,float R,float S,vec3 T,vec3 U,vec3 V,vec3 W,vec3 X,vec3 Y,vec3 Z,float a,float b,float c,float d,float e,float f,float g){P=P*Q;float h=radians(R);P=P-0.5;P*=mat2(cos(h),-sin(h),sin(h),cos(h));P=P+0.5;vec3 i=mix(T,U,J(a,b,P.y,S));i=mix(i,V,J(b,c,P.y,S));i=mix(i,W,J(c,d,P.y,S));i=mix(i,X,J(d,e,P.y,S));i=mix(i,Y,J(e,f,P.y,S));i=mix(i,Z,J(f,g,P.y,S));return i;}varying vec2 vTextureCoord;uniform sampler2D uSampler;uniform float silhouette_amount;uniform float clampX;uniform float clampY;void main(void){vec4 j=texture2D(uSampler,vTextureCoord);vec3 T=vec3(1.,0.,0.);vec3 U=vec3(1.,0.,0.41);vec3 V=vec3(1.,0.,1.);vec3 W=vec3(0.51,0.,1.);vec3 X=vec3(0.,0.,1.);vec3 Y=vec3(0.,1.,0.);vec3 Z=vec3(1.,0.54,0.);vec3 k=O(vTextureCoord,vec2(clampX,clampY),135.,0.,T,U,V,W,X,Y,Z,0.,0.15,0.33,0.5,0.66,0.84,1.);float l=silhouette_amount/255.;vec3 m=A(j.rgb,l,1.);gl_FragColor=vec4(G(k.rgb,m),j.a);}";var pg="vec3 A(vec3 B,float C,float D){float E=B.r*0.309+B.g*0.609+B.b*0.082;float F=clamp(E-C,0.,1.)/clamp(abs(D-C),0.,1.);return vec3(clamp(vec3(F),0.,1.));}vec3 G(vec3 H,vec3 I){float J=min(H.r,I.r);float K=min(H.g,I.g);float L=min(H.b,I.b);return vec3(J,K,L);}float M(float N,float O,float P,float Q){if(Q==1.){return clamp((P-N)/(O-N),0.,1.);}else{return smoothstep(N,O,P);}}vec3 R(vec2 S,vec2 T,float U,float V,vec3 W,vec3 X,vec3 Y,vec3 Z,vec3 a,vec3 b,vec3 c,float d,float e,float f,float g,float h,float i,float j){S=S*T;float k=radians(U);S=S-0.5;S*=mat2(cos(k),-sin(k),sin(k),cos(k));S=S+0.5;vec3 l=mix(W,X,M(d,e,S.y,V));l=mix(l,Y,M(e,f,S.y,V));l=mix(l,Z,M(f,g,S.y,V));l=mix(l,a,M(g,h,S.y,V));l=mix(l,b,M(h,i,S.y,V));l=mix(l,c,M(i,j,S.y,V));return l;}varying vec2 vTextureCoord;uniform sampler2D uSampler;uniform float silhouette_amount;uniform float clampX;uniform float clampY;void main(void){vec4 m=texture2D(uSampler,vTextureCoord);vec3 W=vec3(1.,0.,0.);vec3 X=vec3(1.,0.,1.);vec3 Y=vec3(0.,0.,1.);vec3 Z=vec3(0.,1.,1.);vec3 a=vec3(0.,1.,0.);vec3 b=vec3(1.,1.,0.);vec3 c=vec3(1.,0.,0.);vec3 n=R(vTextureCoord,vec2(clampX,clampY),135.,0.,W,X,Y,Z,a,b,c,0.,0.15,0.33,0.5,0.66,0.84,1.);float o=silhouette_amount/255.;vec3 p=A(m.rgb,o,1.);gl_FragColor=vec4(G(n,p),m.a);}";var fg="vec3 A(vec3 B,float C,float D){float E=B.r*0.309+B.g*0.609+B.b*0.082;float F=clamp(E-C,0.,1.)/clamp(abs(D-C),0.,1.);return vec3(clamp(vec3(F),0.,1.));}vec3 G(vec3 H,vec3 I){return 1.-(1.-H)*(1.-I);}float J(float K,float L,float M,float N){if(N==1.){return clamp((M-K)/(L-K),0.,1.);}else{return smoothstep(K,L,M);}}vec3 O(vec2 P,vec2 Q,float R,float S,vec3 T,vec3 U,vec3 V,float W,float X,float Y){P=P*Q;float Z=radians(R);P=P-0.5;P*=mat2(cos(Z),-sin(Z),sin(Z),cos(Z));P=P+0.5;vec3 a=mix(T,U,J(W,X,P.y,S));a=mix(a,V,J(X,Y,P.y,S));return a;}varying vec2 vTextureCoord;uniform sampler2D uSampler;uniform float silhouette_amount;uniform float clampX;uniform float clampY;void main(void){vec4 b=texture2D(uSampler,vTextureCoord);if(b.a==0.){gl_FragColor=vec4(0,0,0,0);return;}b.rgb/=b.a;vec3 c=O(vTextureCoord,vec2(clampX,clampY),180.,1.,vec3(0.039,0.,0.69),vec3(1.,0.,0.),vec3(1.,0.98,0.),0.,0.5,1.);float d=silhouette_amount/255.;vec3 e=A(b.rgb,d,1.);gl_FragColor=vec4(G(c,e)*b.a,b.a);}";var gg="vec4 A(sampler2D B,vec2 C,vec2 D,vec2 E,vec2 F,int G,int H,vec4 I){if(H==1){E=E/F;D=D/F;F=vec2(1.,1.);}float J=(((C.x*F.x)-D.x)/E.x);float K=(((C.y*F.y)-D.y)/E.y);if(G==0&&(J<0.||J>1.||K<0.||K>1.)){return I;}else{J=mod((mod(J,1.)+1.),1.);K=mod((mod(K,1.)+1.),1.);vec2 L=vec2((J/F.x),(K/F.y));return texture2D(B,L);}}vec3 M(vec3 N,float O,float P){float Q=N.r*0.309+N.g*0.609+N.b*0.082;float R=clamp(Q-O,0.,1.)/clamp(abs(P-O),0.,1.);return vec3(clamp(vec3(R),0.,1.));}vec3 S(vec3 T,vec3 U,vec3 V){float W=max(max(T.r,T.g),T.b);return U*W+V*(1.-W);}float X(float Y,float Z){return(((2.*Y)==0.)?(2.*Y):max((1.-((1.-Z)/(2.*Y))),0.));}vec3 a(vec3 Y,vec3 Z){vec3 b;b.r=X(Y.r,Z.r);b.g=X(Y.g,Z.g);b.b=X(Y.b,Z.b);return b;}vec3 c(vec3 Y,vec3 Z){return mix(2.*Y*Z,1.-2.*(1.-Y)*(1.-Z),step(0.5,Z));}varying vec2 vTextureCoord;uniform sampler2D uSampler;uniform sampler2D halftoneSampler;uniform float silhouette_amount;uniform vec4 filterArea;uniform float clampX;uniform float clampY;void main(void){vec4 d=texture2D(uSampler,vTextureCoord);vec4 I=vec4(0.,0.,0.,0.);vec2 e=vec2(0.5,0.5);vec2 f=vec2(clampX,clampY);vec4 g=A(halftoneSampler,vTextureCoord,vec2(0.,0.),e,f,0,1,I);vec4 h=A(halftoneSampler,vTextureCoord,vec2(0.5,0.),e,f,0,1,I);vec4 i=A(halftoneSampler,vTextureCoord,vec2(0.,0.5),e,f,0,1,I);vec4 j=A(halftoneSampler,vTextureCoord,vec2(0.5,0.5),e,f,0,1,I);vec4 k=A(uSampler,vTextureCoord,vec2(0.,0.),e,f,0,0,I);vec4 l=A(uSampler,vTextureCoord,vec2(0.5,0.),e,f,0,0,I);vec4 m=A(uSampler,vTextureCoord,vec2(0.,0.5),e,f,0,0,I);vec4 n=A(uSampler,vTextureCoord,vec2(0.5,0.5),e,f,0,0,I);if(k.a>0.){k.rgb/=k.a;l.rgb/=l.a;m.rgb/=m.a;n.rgb/=n.a;}float o=silhouette_amount/255.;k.rgb=M(k.rgb,o,0.5);l.rgb=M(l.rgb,o,0.5);m.rgb=M(m.rgb,o,0.5);n.rgb=M(n.rgb,o,0.5);k.rgb=S(k.rgb,vec3(0.71,1.,0.64),vec3(0.68,0.20,0.20));l.rgb=S(l.rgb,vec3(0.,0.90,1.),vec3(0.49,0.11,0.36));m.rgb=S(m.rgb,vec3(1.,0.97,0.),vec3(0.,0.47,0.83));n.rgb=S(n.rgb,vec3(1.,0.48,0.93),vec3(0.,0.47,0.07));k.rgb=a(g.rgb,k.rgb)*k.a;l.rgb=a(h.rgb,l.rgb)*l.a;m.rgb=a(i.rgb,m.rgb)*m.a;n.rgb=a(j.rgb,n.rgb)*n.a;gl_FragColor=k+l+m+n;}";var vg="vec4 A(sampler2D B,vec2 C,vec2 D,vec2 E,vec2 F,int G,int H,vec4 I){if(H==1){E=E/F;D=D/F;F=vec2(1.,1.);}float J=(((C.x*F.x)-D.x)/E.x);float K=(((C.y*F.y)-D.y)/E.y);if(G==0&&(J<0.||J>1.||K<0.||K>1.)){return I;}else{J=mod((mod(J,1.)+1.),1.);K=mod((mod(K,1.)+1.),1.);vec2 L=vec2((J/F.x),(K/F.y));return texture2D(B,L);}}vec3 M(vec3 N,vec3 O,vec3 P){float Q=max(max(N.r,N.g),N.b);return O*Q+P*(1.-Q);}varying vec2 vTextureCoord;uniform sampler2D uSampler;uniform sampler2D adaptiveSharpenSampler;uniform vec4 filterArea;uniform float clampX;uniform float clampY;void main(void){vec4 R=texture2D(uSampler,vTextureCoord);vec4 I=vec4(0.,0.,0.,0.);vec2 S=vec2(0.5,0.5);vec2 T=vec2(clampX,clampY);vec4 U=A(adaptiveSharpenSampler,vTextureCoord,vec2(0.,0.),S,T,0,1,I);vec4 V=A(adaptiveSharpenSampler,vTextureCoord,vec2(0.5,0.),S,T,0,1,I);vec4 W=A(adaptiveSharpenSampler,vTextureCoord,vec2(0.,0.5),S,T,0,1,I);vec4 X=A(adaptiveSharpenSampler,vTextureCoord,vec2(0.5,0.5),S,T,0,1,I);U.rgb=mix(U.rgb,M(U.bbb,vec3(0.71,1.,0.64),vec3(0.68,0.20,0.20)),1.)*U.a;V.rgb=mix(V.rgb,M(V.bbb,vec3(0.61,1.,0.96),vec3(0.80,0.21,1.)),1.)*V.a;W.rgb=mix(W.rgb,M(W.bbb,vec3(1.,0.97,0.49),vec3(0.,0.53,1.)),1.)*W.a;X.rgb=mix(X.rgb,M(X.bbb,vec3(1.,0.73,0.96),vec3(0.18,0.48,0.)),1.)*X.a;R.rgb=U.rgb+V.rgb+W.rgb+X.rgb;gl_FragColor=vec4(R.rgb,(U.a+V.a+W.a+X.a));}";var yg="vec4 A(sampler2D B,vec2 C,vec2 D,vec2 E,vec2 F,int G,int H,vec4 I){if(H==1){E=E/F;D=D/F;F=vec2(1.,1.);}float J=(((C.x*F.x)-D.x)/E.x);float K=(((C.y*F.y)-D.y)/E.y);if(G==0&&(J<0.||J>1.||K<0.||K>1.)){return I;}else{J=mod((mod(J,1.)+1.),1.);K=mod((mod(K,1.)+1.),1.);vec2 L=vec2((J/F.x),(K/F.y));return texture2D(B,L);}}vec3 M(vec3 N,float O,float P){float Q=N.r*0.309+N.g*0.609+N.b*0.082;float R=clamp(Q-O,0.,1.)/clamp(abs(P-O),0.,1.);return vec3(clamp(vec3(R),0.,1.));}vec3 S(vec3 T,vec3 U,vec3 V){float W=max(max(T.r,T.g),T.b);return U*W+V*(1.-W);}varying vec2 vTextureCoord;uniform sampler2D uSampler;uniform sampler2D blurSampler;uniform float silhouette_amount;uniform vec3 color_value_1;uniform vec3 color_value_2;uniform vec3 color_value_3;uniform vec3 color_value_4;uniform float clampX;uniform float clampY;void main(void){vec4 X=texture2D(uSampler,vTextureCoord);vec4 I=vec4(0.,0.,0.,0.);vec2 Y=vec2(0.5,0.5);vec2 Z=vec2(clampX,clampY);vec4 a=A(uSampler,vTextureCoord,vec2(0.,0.),Y,Z,0,0,I);vec4 b=A(uSampler,vTextureCoord,vec2(0.5,0.),Y,Z,0,0,I);vec4 c=A(uSampler,vTextureCoord,vec2(0.,0.5),Y,Z,0,0,I);vec4 d=A(uSampler,vTextureCoord,vec2(0.5,0.5),Y,Z,0,0,I);vec4 e=A(blurSampler,vTextureCoord,vec2(0.,0.),Y,Z,0,1,I);vec4 f=A(blurSampler,vTextureCoord,vec2(0.5,0.),Y,Z,0,1,I);vec4 g=A(blurSampler,vTextureCoord,vec2(0.,0.5),Y,Z,0,1,I);vec4 h=A(blurSampler,vTextureCoord,vec2(0.5,0.5),Y,Z,0,1,I);float i=silhouette_amount/255.;vec3 j=M(e.rgb,i,0.5);vec3 k=M(f.rgb,i,0.5);vec3 l=M(g.rgb,i,0.5);vec3 m=M(h.rgb,i,0.5);a.rgb=mix(a.rgb,S(j,color_value_1,vec3(0.)),1.)*a.a;b.rgb=mix(b.rgb,S(k,color_value_2,vec3(0.)),1.)*b.a;c.rgb=mix(c.rgb,S(l,color_value_3,vec3(0.)),1.)*c.a;d.rgb=mix(d.rgb,S(m,color_value_4,vec3(0.)),1.)*d.a;gl_FragColor=a+b+c+d;}";var xg="vec3 A(vec3 B,float C){return pow(B,vec3(C));}vec3 D(vec3 B,float E,float F){vec3 G=A(B,E);vec3 H=((G-0.5)*F)+0.5;return H;}vec3 I(vec3 B,vec3 J,vec3 K){float L=max(max(B.r,B.g),B.b);return J*L+K*(1.-L);}vec2 M(vec2 N,vec4 O){N*=O.xy;N+=O.zw;return N;}vec2 P(vec2 N,vec4 O){N-=O.zw;N/=O.xy;return N;}float Q(vec3 R){return dot(R,vec3(0.299,0.587,0.114));}vec2 S(vec2 T,float U){return floor(T/U)*U;}vec3 V(sampler2D W,vec2 N,vec4 X,vec2 Y,float Z,vec3 a,vec3 b){vec2 c=M(N,X);vec2 d=vec2(1./X.xy);vec2 e=vec2(1./Y.x-d.x,1./Y.y-d.y);vec2 f=S(c,Z)+0.5*Z;float g=min(length(c-f)/((Z)*0.5),1.);f=P(f,X);vec3 h=texture2D(W,clamp(f,vec2(0.),e)).rgb;float i=1.-Q(h);g=smoothstep(min(max(i,0.2),0.8),max(min(i+0.1,1.),0.25),g);vec3 j=I(vec3(g),b,a);return j;}float k(vec3 R){return dot(R,vec3(0.299,0.587,0.114));}vec3 l(vec3 B,sampler2D m,vec4 X,float n,float o){float i=clamp(k(B),0.,1.);float p=255./X.x;return texture2D(m,vec2(i*p*n,o)).rgb;}vec4 q(sampler2D r,vec2 s,vec2 t,vec2 u,vec2 v,int w,int x,vec4 y){if(x==1){u=u/v;t=t/v;v=vec2(1.,1.);}float z=(((s.x*v.x)-t.x)/u.x);float AA=(((s.y*v.y)-t.y)/u.y);if(w==0&&(z<0.||z>1.||AA<0.||AA>1.)){return y;}else{z=mod((mod(z,1.)+1.),1.);AA=mod((mod(AA,1.)+1.),1.);vec2 AB=vec2((z/v.x),(AA/v.y));return texture2D(r,AB);}}vec3 AC(vec3 AD,float AE,float AF){float E=AD.r*0.309+AD.g*0.609+AD.b*0.082;float AG=clamp(E-AE,0.,1.)/clamp(abs(AF-AE),0.,1.);return vec3(clamp(vec3(AG),0.,1.));}vec3 AH(vec3 B,vec3 J,vec3 K){float L=max(max(B.r,B.g),B.b);return J*L+K*(1.-L);}vec3 AI(vec3 AJ,vec3 AK){float AL=min(AJ.r,AK.r);float AM=min(AJ.g,AK.g);float AN=min(AJ.b,AK.b);return vec3(AL,AM,AN);}varying vec2 vTextureCoord;uniform sampler2D uSampler;uniform sampler2D gradientSampler;uniform sampler2D halftoneSampler;uniform float silhouette_amount;uniform vec4 filterArea;uniform float clampX;uniform float clampY;void main(void){vec4 AO=texture2D(uSampler,vTextureCoord);vec4 AP=texture2D(gradientSampler,vTextureCoord*vec2(clampX,clampY));vec4 y=vec4(0.,0.,0.,0.);vec2 AQ=vec2(0.5,0.5);vec2 AR=vec2(clampX,clampY);vec4 AS=q(halftoneSampler,vTextureCoord,vec2(0.,0.),AQ,AR,0,1,y);vec4 AT=q(halftoneSampler,vTextureCoord,vec2(0.5,0.),AQ,AR,0,1,y);vec4 AU=q(halftoneSampler,vTextureCoord,vec2(0.,0.5),AQ,AR,0,1,y);vec4 AV=q(halftoneSampler,vTextureCoord,vec2(0.5,0.5),AQ,AR,0,1,y);vec4 AW=q(uSampler,vTextureCoord,vec2(0.,0.),AQ,AR,0,0,y);vec4 AX=q(uSampler,vTextureCoord,vec2(0.5,0.),AQ,AR,0,0,y);vec4 AY=q(uSampler,vTextureCoord,vec2(0.,0.5),AQ,AR,0,0,y);vec4 AZ=q(uSampler,vTextureCoord,vec2(0.5,0.5),AQ,AR,0,0,y);float Aa=silhouette_amount/255.;AW.rgb=AC(AW.rgb,Aa,0.5);AX.rgb=AC(AX.rgb,Aa,0.5);AY.rgb=AC(AY.rgb,Aa,0.5);AZ.rgb=AC(AZ.rgb,Aa,0.5);AW.rgb=clamp(AW.rgb*AS.rgb,0.,1.);AX.rgb=clamp(AX.rgb*AT.rgb,0.,1.);AY.rgb=clamp(AY.rgb*AU.rgb,0.,1.);AZ.rgb=clamp(AZ.rgb*AV.rgb,0.,1.);float Ab=1./filterArea.y;AW.rgb=l(AW.rgb,gradientSampler,filterArea,clampX,Ab*2.*clampY)*AW.a;AX.rgb=l(AX.rgb,gradientSampler,filterArea,clampX,Ab*7.*clampY)*AX.a;AY.rgb=l(AY.rgb,gradientSampler,filterArea,clampX,Ab*12.*clampY)*AY.a;AZ.rgb=l(AZ.rgb,gradientSampler,filterArea,clampX,Ab*17.*clampY)*AZ.a;gl_FragColor=AW+AX+AY+AZ;}";var Tg="vec3 A(vec3 B,float C){return pow(B,vec3(C));}vec3 D(vec3 B,float E,float F){vec3 G=A(B,E);vec3 H=((G-0.5)*F)+0.5;return H;}vec3 I(vec3 B,vec3 J,vec3 K){float L=max(max(B.r,B.g),B.b);return J*L+K*(1.-L);}vec2 M(vec2 N,vec4 O){N*=O.xy;N+=O.zw;return N;}vec2 P(vec2 N,vec4 O){N-=O.zw;N/=O.xy;return N;}float Q(vec3 R){return dot(R,vec3(0.299,0.587,0.114));}vec2 S(vec2 T,float U){return floor(T/U)*U;}vec3 V(sampler2D W,vec2 N,vec4 X,vec2 Y,float Z,vec3 a,vec3 b){vec2 c=M(N,X);vec2 d=vec2(1./X.xy);vec2 e=vec2(1./Y.x-d.x,1./Y.y-d.y);vec2 f=S(c,Z)+0.5*Z;float g=min(length(c-f)/((Z)*0.5),1.);f=P(f,X);vec3 h=texture2D(W,clamp(f,vec2(0.),e)).rgb;float i=1.-Q(h);g=smoothstep(min(max(i,0.2),0.8),max(min(i+0.1,1.),0.25),g);vec3 j=I(vec3(g),b,a);return j;}vec3 k(vec3 l,float m,float n){l=l*n;return floor(l*floor(float(m)))/floor(float(m));}vec4 o(sampler2D p,vec2 q,vec2 r,vec2 s,vec2 t,int u,int v,vec4 w){if(v==1){s=s/t;r=r/t;t=vec2(1.,1.);}float x=(((q.x*t.x)-r.x)/s.x);float y=(((q.y*t.y)-r.y)/s.y);if(u==0&&(x<0.||x>1.||y<0.||y>1.)){return w;}else{x=mod((mod(x,1.)+1.),1.);y=mod((mod(y,1.)+1.),1.);vec2 z=vec2((x/t.x),(y/t.y));return texture2D(p,z);}}float AA(vec3 R){return dot(R,vec3(0.299,0.587,0.114));}vec3 AB(vec3 R){float AC=AA(R);float AD=min(min(R.r,R.g),R.b);float AE=max(max(R.r,R.g),R.b);if(AD<0.){max((R-AC)*AC/(AC-AD)+AC,0.);}if(AE>1.){min((R-AC)*(1.-AC)/(AE-AC)+AC,1.);}return R;}float AF(vec3 R){return dot(R,vec3(0.299,0.587,0.114));}vec3 AG(vec3 R,float AC){float AH=AC-AF(R);R=R+vec3(AH);return AB(R);}float AI(vec3 R){return dot(R,vec3(0.299,0.587,0.114));}vec3 AJ(vec3 AK,vec3 AL){return vec3(AG(AK.rgb,AI(AL.rgb)));}float AM(float AL,float AK){return(AL<0.5)?2.*AL*AK:1.-2.*(1.-AL)*(1.-AK);}vec3 AN(vec3 AL,vec3 AK){vec3 j;j.r=AM(AL.r,AK.r);j.g=AM(AL.g,AK.g);j.b=AM(AL.b,AK.b);return j;}vec3 AO(vec3 l,float AP){float AQ=3.14159265;float AR=(AP/180.)*AQ;float g=sin(AR),R=cos(AR);vec3 AS=(vec3(2.*R,-sqrt(3.)*g-R,sqrt(3.)*g-R)+1.)/3.;return vec3(dot(l,AS.xyz),dot(l,AS.zxy),dot(l,AS.yzx));}varying vec2 vTextureCoord;uniform sampler2D uSampler;uniform sampler2D blurSampler;uniform sampler2D halftoneSampler;uniform float color_detail;uniform vec4 filterArea;uniform float clampX;uniform float clampY;void main(void){vec4 AT=texture2D(uSampler,vTextureCoord);vec4 AU=texture2D(blurSampler,vTextureCoord*vec2(clampX,clampY));vec4 AV=texture2D(halftoneSampler,vTextureCoord*vec2(clampX,clampY));vec4 w=vec4(0.,0.,0.,0.);vec2 AW=vec2(0.5,0.5);vec2 AX=vec2(clampX,clampY);vec4 AY=o(halftoneSampler,vTextureCoord,vec2(0.,0.),AW,AX,0,1,w);vec4 AZ=o(halftoneSampler,vTextureCoord,vec2(0.5,0.),AW,AX,0,1,w);vec4 Aa=o(halftoneSampler,vTextureCoord,vec2(0.,0.5),AW,AX,0,1,w);vec4 Ab=o(halftoneSampler,vTextureCoord,vec2(0.5,0.5),AW,AX,0,1,w);vec4 Ac=o(uSampler,vTextureCoord,vec2(0.,0.),AW,AX,0,0,w);vec4 Ad=o(uSampler,vTextureCoord,vec2(0.5,0.),AW,AX,0,0,w);vec4 Ae=o(uSampler,vTextureCoord,vec2(0.,0.5),AW,AX,0,0,w);vec4 Af=o(uSampler,vTextureCoord,vec2(0.5,0.5),AW,AX,0,0,w);vec4 Ag=o(blurSampler,vTextureCoord,vec2(0.,0.),AW,AX,0,1,w);vec4 Ah=o(blurSampler,vTextureCoord,vec2(0.5,0.),AW,AX,0,1,w);vec4 Ai=o(blurSampler,vTextureCoord,vec2(0.,0.5),AW,AX,0,1,w);vec4 Aj=o(blurSampler,vTextureCoord,vec2(0.5,0.5),AW,AX,0,1,w);Ag.rgb=k(Ag.rgb,color_detail,1.);Ah.rgb=k(Ah.rgb,color_detail,1.);Ai.rgb=k(Ai.rgb,color_detail,1.);Aj.rgb=k(Aj.rgb,color_detail,1.);Ag.rgb=AJ(Ac.rgb,Ag.rgb);Ah.rgb=AJ(Ad.rgb,Ah.rgb);Ai.rgb=AJ(Ae.rgb,Ai.rgb);Aj.rgb=AJ(Af.rgb,Aj.rgb);Ag.rgb=AN(Ag.rgb,AY.rgb);Ah.rgb=AN(Ah.rgb,AZ.rgb);Ai.rgb=AN(Ai.rgb,Aa.rgb);Aj.rgb=AN(Aj.rgb,Ab.rgb);Ag.rgb=AO(Ag.rgb,15.);Ah.rgb=AO(Ah.rgb,65.);Ai.rgb=AO(Ai.rgb,-15.);Aj.rgb=AO(Aj.rgb,160.);AT.rgb=Ag.rgb+Ah.rgb+Ai.rgb+Aj.rgb;gl_FragColor=vec4(AT.rgb,(Ac.a+Ad.a+Ae.a+Af.a));}";var Fg="vec4 A(sampler2D B,vec2 C,vec2 D,vec2 E,vec2 F,int G,int H,vec4 I){if(H==1){E=E/F;D=D/F;F=vec2(1.,1.);}float J=(((C.x*F.x)-D.x)/E.x);float K=(((C.y*F.y)-D.y)/E.y);if(G==0&&(J<0.||J>1.||K<0.||K>1.)){return I;}else{J=mod((mod(J,1.)+1.),1.);K=mod((mod(K,1.)+1.),1.);vec2 L=vec2((J/F.x),(K/F.y));return texture2D(B,L);}}vec3 M(vec3 N,float O,float P){float Q=N.r*0.309+N.g*0.609+N.b*0.082;float R=clamp(Q-O,0.,1.)/clamp(abs(P-O),0.,1.);return vec3(clamp(vec3(R),0.,1.));}vec3 S(vec3 T,vec3 U,vec3 V){float W=max(max(T.r,T.g),T.b);return U*W+V*(1.-W);}varying vec2 vTextureCoord;uniform sampler2D uSampler;uniform sampler2D halftoneSampler;uniform float silhouette_amount;uniform vec4 filterArea;uniform float clampX;uniform float clampY;void main(void){vec4 X=texture2D(uSampler,vTextureCoord);vec4 Y=texture2D(halftoneSampler,vTextureCoord*vec2(clampX,clampY));vec4 I=vec4(0.,0.,0.,0.);vec2 Z=vec2(0.5,0.5);vec2 a=vec2(clampX,clampY);vec4 b=A(halftoneSampler,vTextureCoord,vec2(0.,0.),Z,a,0,1,I);vec4 c=A(halftoneSampler,vTextureCoord,vec2(0.5,0.),Z,a,0,1,I);vec4 d=A(halftoneSampler,vTextureCoord,vec2(0.,0.5),Z,a,0,1,I);vec4 e=A(halftoneSampler,vTextureCoord,vec2(0.5,0.5),Z,a,0,1,I);vec4 f=A(uSampler,vTextureCoord,vec2(0.,0.),Z,a,0,0,I);vec4 g=A(uSampler,vTextureCoord,vec2(0.5,0.),Z,a,0,0,I);vec4 h=A(uSampler,vTextureCoord,vec2(0.,0.5),Z,a,0,0,I);vec4 i=A(uSampler,vTextureCoord,vec2(0.5,0.5),Z,a,0,0,I);float j=silhouette_amount/255.;f.rgb=M(f.rgb,j,0.5);g.rgb=M(g.rgb,j,0.5);h.rgb=M(h.rgb,j,0.5);i.rgb=M(i.rgb,j,0.5);vec4 k=b*f;vec4 l=c*g;vec4 m=d*h;vec4 n=e*i;k.rgb=S(k.rgb,vec3(0.00,0.81,0.00),vec3(0.));l.rgb=S(l.rgb,vec3(0.00,0.90,1.00),vec3(0.));m.rgb=S(m.rgb,vec3(1.00,0.97,0.00),vec3(0.));n.rgb=S(n.rgb,vec3(1.00,0.35,0.56),vec3(0.));X=k+l+m+n;gl_FragColor=X;}";var bg="vec3 A(vec3 B,vec3 C){return mix(2.*B*C,1.-2.*(1.-B)*(1.-C),step(0.5,C));}float D(float B,float C){return(B<0.5)?2.*B*C:1.-2.*(1.-B)*(1.-C);}vec3 E(vec3 B,vec3 C){vec3 F;F.r=D(B.r,C.r);F.g=D(B.g,C.g);F.b=D(B.b,C.b);return F;}vec3 G(vec3 H,vec3 I,vec3 J){float K=max(max(H.r,H.g),H.b);return I*K+J*(1.-K);}vec2 L(vec2 M,vec4 N){M*=N.xy;M+=N.zw;return M;}vec2 O(vec2 M,vec4 N){M-=N.zw;M/=N.xy;return M;}float P(vec3 Q){return dot(Q,vec3(0.299,0.587,0.114));}vec2 R(vec2 S,float T){return floor(S/T)*T;}vec3 U(sampler2D V,vec2 M,vec4 W,vec2 X,float Y,vec3 Z,vec3 a){vec2 b=L(M,W);vec2 c=vec2(1./W.xy);vec2 d=vec2(1./X.x-c.x,1./X.y-c.y);vec2 e=R(b,Y)+0.5*Y;float f=min(length(b-e)/((Y)*0.5),1.);e=O(e,W);vec3 g=texture2D(V,clamp(e,vec2(0.),d)).rgb;float h=1.-P(g);f=smoothstep(min(max(h,0.2),0.8),max(min(h+0.1,1.),0.25),f);vec3 F=G(vec3(f),a,Z);return F;}float i(vec3 Q){return dot(Q,vec3(0.299,0.587,0.114));}vec3 j(vec3 H,vec3 I,vec3 J){float K=max(max(H.r,H.g),H.b);return I*K+J*(1.-K);}vec3 k(vec3 l,float m,float n){float o=l.r*0.309+l.g*0.609+l.b*0.082;float p=clamp(o-m,0.,1.)/clamp(abs(n-m),0.,1.);return vec3(clamp(vec3(p),0.,1.));}vec4 q(sampler2D r,vec2 s,vec2 t,vec2 u,vec2 v,int w,int x,vec4 y){if(x==1){u=u/v;t=t/v;v=vec2(1.,1.);}float z=(((s.x*v.x)-t.x)/u.x);float AA=(((s.y*v.y)-t.y)/u.y);if(w==0&&(z<0.||z>1.||AA<0.||AA>1.)){return y;}else{z=mod((mod(z,1.)+1.),1.);AA=mod((mod(AA,1.)+1.),1.);vec2 AB=vec2((z/v.x),(AA/v.y));return texture2D(r,AB);}}float AC(vec3 Q){return dot(Q,vec3(0.299,0.587,0.114));}vec3 AD(vec3 H,sampler2D AE,vec4 W,float AF,float AG){float h=clamp(AC(H),0.,1.);float AH=255./W.x;return texture2D(AE,vec2(h*AH*AF,AG)).rgb;}varying vec2 vTextureCoord;uniform sampler2D uSampler;uniform sampler2D adaptiveSharpenSampler;uniform sampler2D gradientSampler;uniform float halftone_size;uniform vec4 filterArea;uniform float clampX;uniform float clampY;void main(void){vec4 AI=texture2D(uSampler,vTextureCoord);if(AI.a==0.){gl_FragColor=vec4(0,0,0,0);return;}AI.rgb/=AI.a;vec4 AJ=texture2D(adaptiveSharpenSampler,vTextureCoord*vec2(clampX,clampY));vec3 AK=U(uSampler,vTextureCoord,filterArea,vec2(clampX,clampY),halftone_size,vec3(0.5),vec3(1.));vec3 AL=A(AK,vec3(i(AJ.rgb)));AL=AD(AL,gradientSampler,filterArea,clampX,0.);vec2 AM=vec2(clampX,clampY);vec3 AN=q(uSampler,vTextureCoord,vec2(-0.15*clampX,-0.08*clampY),vec2(1.),AM,0,0,vec4(1.)).rgb;AN=k(AN,0.4,0.5);AN=j(AN,vec3(1.),vec3(0.73,1.00,1.00));vec3 AO=q(uSampler,vTextureCoord,vec2(0.15*clampX,0.08*clampY),vec2(1.),AM,0,0,vec4(1.)).rgb;AO=k(AO,0.4,0.5);AO=j(AO,vec3(1.),vec3(1.00,0.61,0.61));AL=E(AL,AO);AL=clamp(AN*AL,0.,1.);AI.rgb=AL*AI.a;gl_FragColor=AI;}";var Bg="vec3 A(vec3 B,vec3 C,vec3 D){float E=max(max(B.r,B.g),B.b);return C*E+D*(1.-E);}vec2 F(vec2 G,vec4 H){G*=H.xy;G+=H.zw;return G;}vec2 I(vec2 G,vec4 H){G-=H.zw;G/=H.xy;return G;}float J(vec3 K){return dot(K,vec3(0.299,0.587,0.114));}vec2 L(vec2 M,float N){return floor(M/N)*N;}vec3 O(sampler2D P,vec2 G,vec4 Q,vec2 R,float S,vec3 T,vec3 U){vec2 V=F(G,Q);vec2 W=vec2(1./Q.xy);vec2 X=vec2(1./R.x-W.x,1./R.y-W.y);vec2 Y=L(V,S)+0.5*S;float Z=min(length(V-Y)/((S)*0.5),1.);Y=I(Y,Q);vec3 a=texture2D(P,clamp(Y,vec2(0.),X)).rgb;float b=1.-J(a);Z=smoothstep(min(max(b,0.2),0.8),max(min(b+0.1,1.),0.25),Z);vec3 c=A(vec3(Z),U,T);return c;}vec3 d(vec3 e,vec3 f){return mix(2.*e*f,1.-2.*(1.-e)*(1.-f),step(0.5,f));}float g(float e,float f){return(e<0.5)?2.*e*f:1.-2.*(1.-e)*(1.-f);}vec3 h(vec3 e,vec3 f){vec3 c;c.r=g(e.r,f.r);c.g=g(e.g,f.g);c.b=g(e.b,f.b);return c;}float i(vec3 K){return dot(K,vec3(0.299,0.587,0.114));}float j(vec3 K){return dot(K,vec3(0.299,0.587,0.114));}vec3 k(vec3 B,sampler2D l,vec4 Q,float m,float n){float b=clamp(j(B),0.,1.);float o=255./Q.x;return texture2D(l,vec2(b*o*m,n)).rgb;}varying vec2 vTextureCoord;uniform sampler2D uSampler;uniform sampler2D textureSampler;uniform sampler2D gradientSampler;uniform sampler2D adaptiveSharpenSampler;uniform float halftone_size;uniform vec4 filterArea;uniform float clampX;uniform float clampY;void main(void){vec4 p=texture2D(uSampler,vTextureCoord);if(p.a==0.){gl_FragColor=vec4(0,0,0,0);return;}p.rgb/=p.a;vec4 q=texture2D(textureSampler,vTextureCoord*vec2(clampX,clampY));vec4 r=texture2D(adaptiveSharpenSampler,vTextureCoord*vec2(clampX,clampY));vec3 s=O(uSampler,vTextureCoord,filterArea,vec2(clampX,clampY),halftone_size,vec3(0.16),vec3(0.87));vec3 t=d(s,vec3(i(r.rgb)));vec3 u=k(t,gradientSampler,filterArea,clampX,0.);u=h(u,q.rgb);p.rgb=u*p.a;gl_FragColor=p;}";var Sg="vec3 A(vec3 B,vec3 C){return mix(2.*B*C,1.-2.*(1.-B)*(1.-C),step(0.5,C));}vec3 D(vec3 E,vec3 F,vec3 G){float H=max(max(E.r,E.g),E.b);return F*H+G*(1.-H);}vec2 I(vec2 J,vec4 K){J*=K.xy;J+=K.zw;return J;}vec2 L(vec2 J,vec4 K){J-=K.zw;J/=K.xy;return J;}float M(vec3 N){return dot(N,vec3(0.299,0.587,0.114));}vec2 O(vec2 P,float Q){return floor(P/Q)*Q;}vec3 R(sampler2D S,vec2 J,vec4 T,vec2 U,float V,vec3 W,vec3 X){vec2 Y=I(J,T);vec2 Z=vec2(1./T.xy);vec2 a=vec2(1./U.x-Z.x,1./U.y-Z.y);vec2 b=O(Y,V)+0.5*V;float c=min(length(Y-b)/((V)*0.5),1.);b=L(b,T);vec3 d=texture2D(S,clamp(b,vec2(0.),a)).rgb;float e=1.-M(d);c=smoothstep(min(max(e,0.2),0.8),max(min(e+0.1,1.),0.25),c);vec3 f=D(vec3(c),X,W);return f;}float g(vec3 N){return dot(N,vec3(0.299,0.587,0.114));}vec3 h(vec3 E,vec3 F,vec3 G){float H=max(max(E.r,E.g),E.b);return F*H+G*(1.-H);}vec3 i(vec3 j,float k,float l){float m=j.r*0.309+j.g*0.609+j.b*0.082;float n=clamp(m-k,0.,1.)/clamp(abs(l-k),0.,1.);return vec3(clamp(vec3(n),0.,1.));}vec4 o(sampler2D p,vec2 q,vec2 r,vec2 s,vec2 t,int u,int v,vec4 w){if(v==1){s=s/t;r=r/t;t=vec2(1.,1.);}float x=(((q.x*t.x)-r.x)/s.x);float y=(((q.y*t.y)-r.y)/s.y);if(u==0&&(x<0.||x>1.||y<0.||y>1.)){return w;}else{x=mod((mod(x,1.)+1.),1.);y=mod((mod(y,1.)+1.),1.);vec2 z=vec2((x/t.x),(y/t.y));return texture2D(p,z);}}varying vec2 vTextureCoord;uniform sampler2D uSampler;uniform sampler2D adaptiveSharpenSampler;uniform float halftone_size;uniform vec4 filterArea;uniform float clampX;uniform float clampY;void main(void){vec4 AA=texture2D(uSampler,vTextureCoord);if(AA.a==0.){gl_FragColor=vec4(0,0,0,0);return;}AA.rgb/=AA.a;vec4 AB=texture2D(adaptiveSharpenSampler,vTextureCoord*vec2(clampX,clampY));vec3 AC=R(uSampler,vTextureCoord,filterArea,vec2(clampX,clampY),halftone_size,vec3(0.5),vec3(1.));vec3 AD=A(AC,vec3(g(AB.rgb)));AD=h(AD,vec3(1.),vec3(0.18,0.38,0.93));vec2 AE=vec2(clampX,clampY);vec3 AF=o(uSampler,vTextureCoord,vec2(-0.08*clampX,0.),vec2(1.),AE,0,0,vec4(1.)).rgb;AF=i(AF,0.4,0.5);AF=h(AF,vec3(1.),vec3(0.67,1.00,0.87));vec3 AG=o(uSampler,vTextureCoord,vec2(0.08*clampX,0.08*clampY),vec2(1.),AE,0,0,vec4(1.)).rgb;AG=i(AG,0.4,0.5);AG=h(AG,vec3(1.),vec3(0.87,1.00,0.64));AD=clamp(AG*AD,0.,1.);AD=clamp(AF*AD,0.,1.);AA.rgb=AD*AA.a;gl_FragColor=AA;}";var Ig="vec3 A(vec3 B,vec3 C,vec3 D){float E=max(max(B.r,B.g),B.b);return C*E+D*(1.-E);}vec2 F(vec2 G,vec4 H){G*=H.xy;G+=H.zw;return G;}vec2 I(vec2 G,vec4 H){G-=H.zw;G/=H.xy;return G;}float J(vec3 K){return dot(K,vec3(0.299,0.587,0.114));}vec2 L(vec2 M,float N){return floor(M/N)*N;}vec3 O(sampler2D P,vec2 G,vec4 Q,vec2 R,float S,vec3 T,vec3 U){vec2 V=F(G,Q);vec2 W=vec2(1./Q.xy);vec2 X=vec2(1./R.x-W.x,1./R.y-W.y);vec2 Y=L(V,S)+0.5*S;float Z=min(length(V-Y)/((S)*0.5),1.);Y=I(Y,Q);vec3 a=texture2D(P,clamp(Y,vec2(0.),X)).rgb;float b=1.-J(a);Z=smoothstep(min(max(b,0.2),0.8),max(min(b+0.1,1.),0.25),Z);vec3 c=A(vec3(Z),U,T);return c;}float d(float e,float f){return(e<0.5)?2.*e*f:1.-2.*(1.-e)*(1.-f);}vec3 g(vec3 e,vec3 f){vec3 c;c.r=d(e.r,f.r);c.g=d(e.g,f.g);c.b=d(e.b,f.b);return c;}vec3 h(vec3 i,float j){float k=(i.r+i.g+i.b)/3.;if(j>0.){i.rgb+=(k-i.rgb)*(1.-1./(1.001-j/2.));}else{i.rgb+=(k-i.rgb)*(-j);}return i;}varying vec2 vTextureCoord;uniform sampler2D uSampler;uniform sampler2D adaptiveSharpenSampler;uniform float halftone_size;uniform vec4 filterArea;uniform float clampX;uniform float clampY;void main(void){vec4 l=texture2D(uSampler,vTextureCoord);if(l.a==0.){gl_FragColor=vec4(0,0,0,0);return;}l.rgb/=l.a;vec4 m=texture2D(adaptiveSharpenSampler,vTextureCoord*vec2(clampX,clampY));vec3 n=O(uSampler,vTextureCoord,filterArea,vec2(clampX,clampY),halftone_size,vec3(0.5),vec3(1.));m.rgb=h(m.rgb,0.8);m.rgb=g(m.rgb,n);l.rgb=m.rgb*l.a;gl_FragColor=l;}";var _g="vec3 A(vec3 B,float C,float D){float E=B.r*0.309+B.g*0.609+B.b*0.082;float F=clamp(E-C,0.,1.)/clamp(abs(D-C),0.,1.);return vec3(clamp(vec3(F),0.,1.));}vec3 G(vec3 H,vec3 I,vec3 J){float K=max(max(H.r,H.g),H.b);return I*K+J*(1.-K);}vec2 L(vec2 M,vec4 N){M*=N.xy;M+=N.zw;return M;}vec2 O(vec2 M,vec4 N){M-=N.zw;M/=N.xy;return M;}float P(vec3 Q){return dot(Q,vec3(0.299,0.587,0.114));}vec2 R(vec2 S,float T){return floor(S/T)*T;}vec3 U(sampler2D V,vec2 M,vec4 W,vec2 X,float Y,vec3 Z,vec3 a){vec2 b=L(M,W);vec2 c=vec2(1./W.xy);vec2 d=vec2(1./X.x-c.x,1./X.y-c.y);vec2 e=R(b,Y)+0.5*Y;float f=min(length(b-e)/((Y)*0.5),1.);e=O(e,W);vec3 g=texture2D(V,clamp(e,vec2(0.),d)).rgb;float h=1.-P(g);f=smoothstep(min(max(h,0.2),0.8),max(min(h+0.1,1.),0.25),f);vec3 i=G(vec3(f),a,Z);return i;}vec3 j(vec3 k,vec3 l){return mix(2.*k*l,1.-2.*(1.-k)*(1.-l),step(0.5,l));}float m(vec3 Q){return dot(Q,vec3(0.299,0.587,0.114));}float n(float k,float l){return l/(1.-k);}vec3 o(vec3 H,vec3 I,vec3 J){float K=max(max(H.r,H.g),H.b);return I*K+J*(1.-K);}vec3 p(vec3 k,vec3 l){float q=min(k.r,l.r);float r=min(k.g,l.g);float s=min(k.b,l.b);return vec3(q,r,s);}varying vec2 vTextureCoord;uniform sampler2D uSampler;uniform sampler2D textureSampler;uniform sampler2D blurSampler;uniform float clampX;uniform float clampY;uniform float halftone_size;uniform float detail_level;uniform vec4 filterArea;void main(void){vec4 t=texture2D(uSampler,vTextureCoord);if(t.a==0.){gl_FragColor=vec4(0,0,0,0);return;}t.rgb/=t.a;vec4 u=texture2D(textureSampler,vTextureCoord*vec2(clampX,clampY));vec4 v=texture2D(blurSampler,vTextureCoord*vec2(clampX,clampY));vec3 w=U(uSampler,vTextureCoord,filterArea,vec2(clampX,clampY),halftone_size,vec3(0.16),vec3(0.87));w=A(w,117./255.,1.);w=j(w,t.rgb);float x=m(t.rgb);float y=clamp(1.-m(v.rgb),0.,1.);float z=n(y,x);vec3 AA=A(vec3(z),detail_level/255.,1.);AA=o(AA,vec3(1.),vec3(0.42,0.00,0.00));AA=clamp(AA*u.rgb,0.,1.);AA=p(w,AA);halftone_size;detail_level;t.rgb=AA*t.a;gl_FragColor=t;}";var Cg="vec3 A(vec3 B,vec3 C,vec3 D){float E=max(max(B.r,B.g),B.b);return C*E+D*(1.-E);}vec2 F(vec2 G,vec4 H){G*=H.xy;G+=H.zw;return G;}vec2 I(vec2 G,vec4 H){G-=H.zw;G/=H.xy;return G;}float J(vec3 K){return dot(K,vec3(0.299,0.587,0.114));}vec2 L(vec2 M,float N){return floor(M/N)*N;}vec3 O(sampler2D P,vec2 G,vec4 Q,vec2 R,float S,vec3 T,vec3 U){vec2 V=F(G,Q);vec2 W=vec2(1./Q.xy);vec2 X=vec2(1./R.x-W.x,1./R.y-W.y);vec2 Y=L(V,S)+0.5*S;float Z=min(length(V-Y)/((S)*0.5),1.);Y=I(Y,Q);vec3 a=texture2D(P,clamp(Y,vec2(0.),X)).rgb;float b=1.-J(a);Z=smoothstep(min(max(b,0.2),0.8),max(min(b+0.1,1.),0.25),Z);vec3 c=A(vec3(Z),U,T);return c;}vec3 d(vec3 e,vec3 f){return mix(2.*e*f,1.-2.*(1.-e)*(1.-f),step(0.5,f));}float g(vec3 K){return dot(K,vec3(0.299,0.587,0.114));}float h(vec3 K){return dot(K,vec3(0.299,0.587,0.114));}vec3 i(vec3 B,sampler2D j,vec4 Q,float k,float l){float b=clamp(h(B),0.,1.);float m=255./Q.x;return texture2D(j,vec2(b*m*k,l)).rgb;}vec3 n(vec3 o,float p,float q){float r=o.r*0.309+o.g*0.609+o.b*0.082;float s=clamp(r-p,0.,1.)/clamp(abs(q-p),0.,1.);return vec3(clamp(vec3(s),0.,1.));}float t(float e,float f){return f/(1.-e);}vec3 u(vec3 B,vec3 C,vec3 D){float E=max(max(B.r,B.g),B.b);return C*E+D*(1.-E);}varying vec2 vTextureCoord;uniform sampler2D uSampler;uniform sampler2D textureSampler;uniform sampler2D gradientSampler;uniform sampler2D adaptiveSharpenSampler;uniform sampler2D blurSampler;uniform float clampX;uniform float clampY;uniform float halftone_size;uniform float detail_level;uniform vec4 filterArea;void main(void){vec4 v=texture2D(uSampler,vTextureCoord);if(v.a==0.){gl_FragColor=vec4(0,0,0,0);return;}v.rgb/=v.a;vec4 w=texture2D(textureSampler,vTextureCoord*vec2(clampX,clampY));vec4 x=texture2D(adaptiveSharpenSampler,vTextureCoord*vec2(clampX,clampY));vec4 y=texture2D(blurSampler,vTextureCoord*vec2(clampX,clampY));vec3 z=O(uSampler,vTextureCoord,filterArea,vec2(clampX,clampY),halftone_size,vec3(0.16),vec3(0.87));vec3 AA=d(z,vec3(g(x.rgb)));vec3 AB=i(AA,gradientSampler,filterArea,clampX,0.);float AC=g(v.rgb);float AD=clamp(1.-g(y.rgb),0.,1.);float AE=t(AD,AC);vec3 AF=n(vec3(AE),detail_level/255.,1.);AF=u(AF,vec3(1.),vec3(0.42,0.00,0.00));AF=clamp(AF*w.rgb,0.,1.);AF=d(AB,AF);halftone_size;detail_level;gl_FragColor=vec4(AF*v.a,v.a);}";var Ro="vec3 A(vec3 B,vec3 C,vec3 D){float E=max(max(B.r,B.g),B.b);return C*E+D*(1.-E);}vec2 F(vec2 G,vec4 H){G*=H.xy;G+=H.zw;return G;}vec2 I(vec2 G,vec4 H){G-=H.zw;G/=H.xy;return G;}float J(vec3 K){return dot(K,vec3(0.299,0.587,0.114));}vec2 L(vec2 M,float N){return floor(M/N)*N;}vec3 O(sampler2D P,vec2 G,vec4 Q,vec2 R,float S,vec3 T,vec3 U){vec2 V=F(G,Q);vec2 W=vec2(1./Q.xy);vec2 X=vec2(1./R.x-W.x,1./R.y-W.y);vec2 Y=L(V,S)+0.5*S;float Z=min(length(V-Y)/((S)*0.5),1.);Y=I(Y,Q);vec3 a=texture2D(P,clamp(Y,vec2(0.),X)).rgb;float b=1.-J(a);Z=smoothstep(min(max(b,0.2),0.8),max(min(b+0.1,1.),0.25),Z);vec3 c=A(vec3(Z),U,T);return c;}vec3 d(vec3 e,vec3 f){return mix(2.*e*f,1.-2.*(1.-e)*(1.-f),step(0.5,f));}float g(vec3 K){return dot(K,vec3(0.299,0.587,0.114));}float h(vec3 K){return dot(K,vec3(0.299,0.587,0.114));}vec3 i(vec3 B,sampler2D j,vec4 Q,float k,float l){float b=clamp(h(B),0.,1.);float m=255./Q.x;return texture2D(j,vec2(b*m*k,l)).rgb;}varying vec2 vTextureCoord;uniform sampler2D uSampler;uniform sampler2D gradientSampler;uniform sampler2D adaptiveSharpenSampler;uniform float halftone_size;uniform vec4 filterArea;uniform float clampX;uniform float clampY;void main(void){vec4 n=texture2D(uSampler,vTextureCoord);if(n.a==0.){gl_FragColor=vec4(0,0,0,0);return;}n.rgb/=n.a;vec4 o=texture2D(gradientSampler,vTextureCoord*vec2(clampX,clampY));vec4 p=texture2D(adaptiveSharpenSampler,vTextureCoord*vec2(clampX,clampY));vec3 q=O(uSampler,vTextureCoord,filterArea,vec2(clampX,clampY),halftone_size,vec3(0.16),vec3(0.87));vec3 r=d(q,vec3(g(p.rgb)));vec3 s=i(r,gradientSampler,filterArea,clampX,0.);gl_FragColor=vec4(s*n.a,n.a);}";var Eg=class extends PIXI.Filter{constructor(e){let t=O,r=Ro,a=!1;switch(e){case BFN.CONST.POPART_PRESETS.PRESET_1:a=!0,r=Ro;break;case BFN.CONST.POPART_PRESETS.PRESET_2:a=!0,r=Cg;break;case BFN.CONST.POPART_PRESETS.PRESET_3:a=!0,r=_g;break;case BFN.CONST.POPART_PRESETS.PRESET_4:a=!0,r=Ig;break;case BFN.CONST.POPART_PRESETS.PRESET_5:a=!0,r=Sg;break;case BFN.CONST.POPART_PRESETS.PRESET_6:a=!0,r=Bg;break;case BFN.CONST.POPART_PRESETS.PRESET_7:a=!0,r=bg;break;case BFN.CONST.POPART_PRESETS.PRESET_9:a=!0,r=Fg;break;case BFN.CONST.POPART_PRESETS.PRESET_10:a=!0,r=Tg;break;case BFN.CONST.POPART_PRESETS.PRESET_11:a=!0,r=xg;break;case BFN.CONST.POPART_PRESETS.PRESET_13:a=!0,r=yg;break;case BFN.CONST.POPART_PRESETS.PRESET_14:a=!0,r=vg;break;case BFN.CONST.POPART_PRESETS.PRESET_15:a=!0,r=gg;break;case BFN.CONST.POPART_PRESETS.PRESET_16:a=!0,r=fg;break;case BFN.CONST.POPART_PRESETS.PRESET_17:a=!0,r=pg;break;case BFN.CONST.POPART_PRESETS.PRESET_18:a=!0,r=mg;break;case BFN.CONST.POPART_PRESETS.PRESET_19:a=!0,r=dg;break;case BFN.CONST.POPART_PRESETS.PRESET_20:a=!0,r=ug;break}super(t,r);this.padding=0,this.currentPreset=e,this.isClamp=a}apply(e,t,r,a){if(this.isClamp==!0){var s=BFN.FilterHelper.calculateFilterClamp(t,r,this.blurSampler||null);this.uniforms.clampX=s.x,this.uniforms.clampY=s.y}e.applyFilter(this,t,r,a)}get blurSampler(){return this.uniforms.blurSampler}set blurSampler(e){e.baseTexture.isPowerOfTwo=!0,this.uniforms.blurSampler=e}get textureSampler(){return this.uniforms.textureSampler}set textureSampler(e){this.uniforms.textureSampler=e}get adaptiveSharpenSampler(){return this.uniforms.adaptiveSharpenSampler}set adaptiveSharpenSampler(e){this.uniforms.adaptiveSharpenSampler=e}get gradientSampler(){return this.uniforms.gradientSampler}set gradientSampler(e){this.uniforms.gradientSampler=e}get halftoneSampler(){return this.uniforms.halftoneSampler}set halftoneSampler(e){this.uniforms.halftoneSampler=e}get silhouette_amount(){return this.uniforms.hasOwnProperty("silhouette_amount")?this.uniforms.silhouette_amount:null}set silhouette_amount(e){this.uniforms.hasOwnProperty("silhouette_amount")&&(this.uniforms.silhouette_amount=e)}get detail_level(){return this.uniforms.detail_level}set detail_level(e){this.uniforms.detail_level=e}get halftone_size(){return this.uniforms.hasOwnProperty("halftone_size")?this.uniforms.halftone_size:null}set halftone_size(e){this.uniforms.hasOwnProperty("halftone_size")&&(this.uniforms.halftone_size=e)}get color_detail(){return this.uniforms.color_detail}set color_detail(e){this.uniforms.color_detail=e}get color_value_1(){return this.uniforms.color_value_1}set color_value_1(e){e=BFN.FilterHelper.hex2rgb(e),this.uniforms.color_value_1=e}get color_value_2(){return this.uniforms.color_value_2}set color_value_2(e){e=BFN.FilterHelper.hex2rgb(e),this.uniforms.color_value_2=e}get color_value_3(){return this.uniforms.color_value_3}set color_value_3(e){e=BFN.FilterHelper.hex2rgb(e),this.uniforms.color_value_3=e}get color_value_4(){return this.uniforms.color_value_4}set color_value_4(e){e=BFN.FilterHelper.hex2rgb(e),this.uniforms.color_value_4=e}},Pg=Eg;var Ng="vec4 A(sampler2D B,vec2 C,vec2 D,vec2 E,vec2 F,int G,int H,vec4 I){if(H==1){E=E/F;D=D/F;F=vec2(1.,1.);}float J=(((C.x*F.x)-D.x)/E.x);float K=(((C.y*F.y)-D.y)/E.y);if(G==0&&(J<0.||J>1.||K<0.||K>1.)){return I;}else{J=mod((mod(J,1.)+1.),1.);K=mod((mod(K,1.)+1.),1.);vec2 L=vec2((J/F.x),(K/F.y));return texture2D(B,L);}}varying vec2 vTextureCoord;uniform sampler2D uSampler;uniform float offsetX;uniform float offsetY;uniform float scaleX;uniform float scaleY;uniform float clampX;uniform float clampY;uniform int wrap;void main(void){gl_FragColor=A(uSampler,vTextureCoord,vec2(offsetX,offsetY),vec2(scaleX,scaleY),vec2(clampX,clampY),wrap,0,vec4(0.));}";var Mg=class extends PIXI.Filter{constructor(){super(O,Ng);this.padding=0,this.resolution=1,this._offsetX=0,this._offsetY=0,this._scaleX=1,this._scaleY=1,this._wrap=!1}apply(e,t,r,a){this.uniforms.offsetX=this._offsetX/r.destinationFrame.width,this.uniforms.offsetY=this._offsetY/r.destinationFrame.height,this.uniforms.scaleX=this._scaleX,this.uniforms.scaleY=this._scaleY;let s=BFN.FilterHelper.calculateFilterClamp(t,r);this.uniforms.clampX=s.x,this.uniforms.clampY=s.y,this.uniforms.wrap=this._wrap?1:0,e.applyFilter(this,t,r,a)}get offsetX(){return this._offsetX}set offsetX(e){this._offsetX=e}get offsetY(){return this._offsetY}set offsetY(e){this._offsetY=e}get scaleX(){return this._scaleX}set scaleX(e){this._scaleX=e}get scaleY(){return this._scaleY}set scaleY(e){this._scaleY=e}get wrap(){return this._wrap}set wrap(e){this._wrap=e}},Dg=Mg;var wg="float A(vec3 B){return dot(B,vec3(0.299,0.587,0.114));}vec3 C(vec3 B){float D=A(B);float E=min(min(B.r,B.g),B.b);float F=max(max(B.r,B.g),B.b);if(E<0.){max((B-D)*D/(D-E)+D,0.);}if(F>1.){min((B-D)*(1.-D)/(F-D)+D,1.);}return B;}float G(vec3 B){return dot(B,vec3(0.299,0.587,0.114));}vec3 H(vec3 B,float D){float I=D-G(B);B=B+vec3(I);return C(B);}float J(vec3 B){return dot(B,vec3(0.299,0.587,0.114));}vec3 K(vec3 L,vec3 M){return H(M,J(L));}vec3 N(vec3 L,vec3 O,vec3 P){float Q=max(max(L.r,L.g),L.b);return O*Q+P*(1.-Q);}varying vec2 vTextureCoord;uniform sampler2D uSampler;uniform vec3 color1;uniform vec4 color2;uniform float amount;void main(void){vec4 R=texture2D(uSampler,vTextureCoord);if(R.a==0.){gl_FragColor=vec4(0,0,0,0);return;}R.rgb/=R.a;vec4 S=vec4(vec3(0.),R.a);if(color2.a==0.){S.rgb=K(R.rgb,color1);}else{S.rgb=N(R.rgb,color1,color2.rgb);}R.rgb*=R.a;S.rgb*=R.a;gl_FragColor=mix(R,S,amount);}";var kg=class extends PIXI.Filter{constructor(){let e=O,t=wg;super(e,t);this.padding=0}get amount(){return this.uniforms.amount}set amount(e){this.uniforms.amount=e}get color1(){return this.uniforms.color1}set color1(e){e=BFN.FilterHelper.hex2rgb(e),this.uniforms.color1=e}get color2(){return this.uniforms.color2}set color2(e){e!=-1&&e!="0x-1"?e=BFN.FilterHelper.hex2rgb(e,!0):e=[0,0,0,0],this.uniforms.color2=e}},Ag=kg;var Og="float A(float B,float C){return mix(2.*B*C,1.-2.*(1.-B)*(1.-C),step(0.5,C));}vec3 D(vec3 E,float F){float G=(E.r+E.g+E.b)/3.;if(F>0.){E.rgb+=(G-E.rgb)*(1.-1./(1.001-F/2.));}else{E.rgb+=(G-E.rgb)*(-F);}return E;}vec3 H(vec3 I){vec3 J=I/vec3(95.047,100,108.883);vec3 K;K.x=(J.x>0.008856)?pow(J.x,1./3.):(7.787*J.x)+(16./116.);K.y=(J.y>0.008856)?pow(J.y,1./3.):(7.787*J.y)+(16./116.);K.z=(J.z>0.008856)?pow(J.z,1./3.):(7.787*J.z)+(16./116.);return vec3((116.*K.y)-16.,500.*(K.x-K.y),200.*(K.y-K.z));}vec3 L(vec3 I){vec3 M;M.x=(I.r>0.04045)?pow((I.r+0.055)/1.055,2.4):I.r/12.92;M.y=(I.g>0.04045)?pow((I.g+0.055)/1.055,2.4):I.g/12.92,M.z=(I.b>0.04045)?pow((I.b+0.055)/1.055,2.4):I.b/12.92;return 100.*M*mat3(0.4124,0.3576,0.1805,0.2126,0.7152,0.0722,0.0193,0.1192,0.9505);}vec3 N(vec3 I){vec3 O=H(L(I));return vec3(O.x/100.,0.5+0.5*(O.y/127.),0.5+0.5*(O.z/127.));}vec3 P(vec3 I){float Q=(I.x+16.)/116.;float R=I.y/500.+Q;float S=Q-I.z/200.;return vec3(95.047*((R>0.206897)?R*R*R:(R-16./116.)/7.787),100.000*((Q>0.206897)?Q*Q*Q:(Q-16./116.)/7.787),108.883*((S>0.206897)?S*S*S:(S-16./116.)/7.787));}vec3 T(vec3 I){vec3 K=I/100.*mat3(3.2406,-1.5372,-0.4986,-0.9689,1.8758,0.0415,0.0557,-0.2040,1.0570);vec3 U;U.x=(K.r>0.0031308)?((1.055*pow(K.r,(1./2.4)))-0.055):12.92*K.r;U.y=(K.g>0.0031308)?((1.055*pow(K.g,(1./2.4)))-0.055):12.92*K.g;U.z=(K.b>0.0031308)?((1.055*pow(K.b,(1./2.4)))-0.055):12.92*K.b;return U;}vec3 V(vec3 I){return T(P(vec3(100.*I.x,2.*127.*(I.y-0.5),2.*127.*(I.z-0.5))));}varying vec2 vTextureCoord;uniform sampler2D uSampler[2];uniform float amount;void main(void){vec4 W=texture2D(uSampler[0],vTextureCoord);vec4 X=texture2D(uSampler[1],vTextureCoord);W.rgb=W.rgb/W.a;X.rgb=X.rgb/X.a;vec3 Y=N(W.rgb);vec3 Z=N(X.rgb);float a=A(1.-Z.r,Y.r);vec3 b=V(vec3(a,Y.g,Y.b));b=b*W.a;W.rgb=W.rgb*W.a;vec4 c=vec4(vec3(D(b,0.2)),W.a);gl_FragColor=mix(W,c,amount);}";var Rg=class extends PIXI.Shader{constructor(e){super(e,O,Og);this.channelTextures={0:"def",1:"blurImage"}}get amount(){return this._amount}set amount(e){this._amount=e}get blurImage(){return this._blurSampler}set blurImage(e){this._blurSampler=e}applyParams(e){this.uniforms.amount=this.amount}},Lg=Rg;var Vg="varying vec2 vTextureCoord;uniform sampler2D uSampler;uniform float strength;uniform float clampCoord;uniform vec4 filterArea;void main(void){lowp vec4 A=vec4(0.);vec2 B=vec2(1.)*vec2(strength,0.);vec2 C=vec2(2.)*vec2(strength,0.);vec2 D=vec2(3.)*vec2(strength,0.);A+=texture2D(uSampler,vTextureCoord);A+=texture2D(uSampler,clamp(vTextureCoord+B,vec2(0.),vec2(clampCoord,1.)));A+=texture2D(uSampler,clamp(vTextureCoord-B,vec2(0.),vec2(clampCoord,1.)));A+=texture2D(uSampler,clamp(vTextureCoord+C,vec2(0.),vec2(clampCoord,1.)));A+=texture2D(uSampler,clamp(vTextureCoord-C,vec2(0.),vec2(clampCoord,1.)));A+=texture2D(uSampler,clamp(vTextureCoord+D,vec2(0.),vec2(clampCoord,1.)));A+=texture2D(uSampler,clamp(vTextureCoord-D,vec2(0.),vec2(clampCoord,1.)));A/=7.;gl_FragColor=A;}";var Is="attribute vec2 aVertexPosition;attribute vec2 aTextureCoord;uniform mat3 projectionMatrix;varying vec2 vTextureCoord;void main(void){gl_Position=vec4((projectionMatrix*vec3(aVertexPosition,1.)).xy,0.,1.);vTextureCoord=aTextureCoord;}";var Ug=class extends PIXI.Filter{constructor(e,t){super(Is,Vg);this.resolution=t||1,this.strength=e||8,this.padding=0,this.offsetNextPowerW=null,this.clampX=null,this.adjustedStrength=null}apply(e,t,r,a){this.offsetNextPowerW=t.size.width-r.destinationFrame.width,this.offsetNextPowerW==0?this.clampX=1:this.clampX=1-(this.offsetNextPowerW+2+1/this.resolution)/t.size.width,this.adjustedStrength=this.strength*10/this.resolution*.65,this.uniforms.strength=this.adjustedStrength/t.size.width,this.uniforms.clampCoord=this.clampX,e.applyFilter(this,t,r,a)}get blur(){return this.strength}set blur(e){this.strength=e}},Gg=Ug;var Hg="varying vec2 vTextureCoord;uniform sampler2D uSampler;uniform float strength;uniform float clampCoord;uniform vec4 filterArea;void main(void){lowp vec4 A=vec4(0.);vec2 B=vec2(1.)*vec2(0.,strength);vec2 C=vec2(2.)*vec2(0.,strength);vec2 D=vec2(3.)*vec2(0.,strength);A+=texture2D(uSampler,vTextureCoord);A+=texture2D(uSampler,clamp(vTextureCoord+B,vec2(0.,0.),vec2(1.,clampCoord)));A+=texture2D(uSampler,clamp(vTextureCoord-B,vec2(0.,0.),vec2(1.,clampCoord)));A+=texture2D(uSampler,clamp(vTextureCoord+C,vec2(0.,0.),vec2(1.,clampCoord)));A+=texture2D(uSampler,clamp(vTextureCoord-C,vec2(0.,0.),vec2(1.,clampCoord)));A+=texture2D(uSampler,clamp(vTextureCoord+D,vec2(0.,0.),vec2(1.,clampCoord)));A+=texture2D(uSampler,clamp(vTextureCoord-D,vec2(0.,0.),vec2(1.,clampCoord)));A/=7.;gl_FragColor=A;}";var Xg=class extends PIXI.Filter{constructor(e,t){super(Is,Hg);this.resolution=t||1,this.strength=e||8,this.padding=0,this.offsetNextPowerH=null,this.clampY=null,this.adjustedStrength=null}apply(e,t,r,a){this.offsetNextPowerH=t.size.height-r.destinationFrame.height,this.offsetNextPowerH==0?this.clampY=1:this.clampY=1-(this.offsetNextPowerH+2+1/this.resolution)/t.size.height,this.adjustedStrength=this.strength*10/this.resolution*.65,this.uniforms.strength=this.adjustedStrength/t.size.height,this.uniforms.clampCoord=this.clampY,e.applyFilter(this,t,r,a)}get blur(){return this.strength}set blur(e){this.strength=e}},zg=Xg;var Wg=class extends PIXI.Filter{constructor(e,t,r,a,s,o){super();this.blurXFilter=new Gg(e,r),this.blurYFilter=new zg(e,r),this.padding=0,this.resolution=r||(s?BFN.renderTextureResolutionLarge:BFN.renderTextureResolution),this.quality=t||1,this.oneDirection=o,o||(this.blur=e||5),this.manageResolution=a!=!1,this.largeKernel=s==!0}apply(e,t,r){if(this.oneDirection)this.oneDirection=="x"?(this.blurXFilter.resolution=this.resolution,this.blurXFilter.apply(e,t,r)):(this.blurYFilter.resolution=this.resolution,this.blurYFilter.apply(e,t,r));else{let a=e.getRenderTarget(!0);this.blurXFilter.resolution=this.resolution,this.blurYFilter.resolution=this.resolution,this.blurXFilter.apply(e,t,a,!0),this.blurYFilter.apply(e,a,r,!1),e.returnRenderTarget(a)}}get blur(){return this.blurXFilter.blur}set blur(e){this.blurXFilter.blur=this.blurYFilter.blur=e}get blurx(){return this.blurXFilter.blur}set blurx(e){this.blurXFilter.blur=e}get blury(){return this.blurYFilter.blur}set blury(e){this.blurYFilter.blur=e}get quality(){}set quality(e){}get blurX(){return this.blurXFilter.blur}set blurX(e){this.blurXFilter.blur=e}get blurY(){return this.blurYFilter.blur}set blurY(e){this.blurYFilter.blur=e}},$g=Wg;var jg=class{constructor(e,t,r,a){this.blur1=new BFN.filters.GaussianBlurFilter(null,null,e,r==!0?"large":"small",a),this.outputTexture=null,this.isCreateNewOutput=!1}apply(e){return e==0?[]:(this.blur1.blur=e,[this.blur1])}render(e,t,r,a){this.isCreateNewOutput=a,this.blur1.setInputDimensions(t.width,t.height);let s=null;if(r!=null)s=r.concat(this.apply(e));else{if(e==0)return t;s=this.apply(e)}return this.outputTexture||(this.isCreateNewOutput?this.outputTexture=PIXI.RenderTexture.create(t.width,t.height):this.outputTexture=BFN.Util.getNonUsedRenderTexturePool(t.width,t.height)),BFN.renderTextureHolder.texture=t,BFN.renderTextureHolder.filters=s,BFN.Stage.render(BFN.renderTextureHolder,this.outputTexture),BFN.renderTextureHolder.filters=[],BFN.renderTextureHolder.texture=null,this.outputTexture}dispose(){this.outputTexture&&(this.isCreateNewOutput?(this.outputTexture.destroyGC(!0),this.isCreateNewOutput=!1):BFN.Util.destroyRenderTexturePool(),this.outputTexture=null)}},Yg=jg;var qg="vec3 A(vec3 B,vec3 C){return 1.-(1.-B)*(1.-C);}varying vec2 vTextureCoord;uniform sampler2D uSampler;uniform sampler2D blurSampler;uniform float clampX;uniform float clampY;void main(void){lowp vec4 D=texture2D(uSampler,vTextureCoord);lowp vec4 E=texture2D(blurSampler,vTextureCoord*vec2(clampX,clampY));if(D.a==0.){gl_FragColor=vec4(0,0,0,0);return;}D.rgb/=D.a;if(E.a>0.){E.rgb/=E.a;}lowp vec3 F=A(D.rgb,D.rgb);lowp vec3 G=A(E.rgb,E.rgb);D.rgb=F*G*D.a;gl_FragColor=D;}";var Kg=class extends PIXI.Filter{constructor(){super(O,qg);this.padding=0}apply(e,t,r,a){let s=BFN.FilterHelper.calculateFilterClamp(t,r,this.blurSampler||null);this.uniforms.clampX=s.x,this.uniforms.clampY=s.y,this.uniforms.resolutionXY=[r.destinationFrame.width,r.destinationFrame.height],e.applyFilter(this,t,r,a)}get blurSampler(){return this.uniforms.blurSampler}set blurSampler(e){e.baseTexture.isPowerOfTwo=!0,this.uniforms.blurSampler=e}},Jg=Kg;var Qg="vec3 A(vec3 B,vec3 C){return 1.-(1.-B)*(1.-C);}float D(float B,float C){return(B<0.5)?2.*B*C:1.-2.*(1.-B)*(1.-C);}vec3 E(vec3 B,vec3 C){vec3 F;F.r=D(B.r,C.r);F.g=D(B.g,C.g);F.b=D(B.b,C.b);return F;}vec3 G(vec3 H,vec2 I,float J,float K,float L,float M){vec2 N=I-vec2(0.5*J,0.5*K);N.x*=K/J;float O=length(N);float P=K*(0.5+(1.-L)*0.5);float Q=clamp(smoothstep(P,P-0.2,O),0.,1.);H*=mix(Q,1.,M);return H;}float R(vec3 S){return dot(S,vec3(0.299,0.587,0.114));}vec3 T(vec3 U,float V,float W){float X=(2.+(W*20.));return V/(1.+exp(X*(0.5-U)));}varying vec2 vTextureCoord;uniform sampler2D uSampler;uniform sampler2D blurSampler;uniform sampler2D textureSampler;uniform float vignette_amount;uniform float clampX;uniform float clampY;uniform float realWidth;uniform float realHeight;void main(void){vec4 Y=texture2D(uSampler,vTextureCoord);if(Y.a==0.){gl_FragColor=vec4(0,0,0,0);return;}Y.rgb/=Y.a;vec4 Z=texture2D(blurSampler,vTextureCoord*vec2(clampX,clampY));vec4 a=texture2D(textureSampler,vTextureCoord*vec2(clampX,clampY));vec3 b=vec3(R(Y.rgb));b=T(b,0.75,0.85);vec3 c=A(b.rgb,Y.rgb);c=E(c,a.rgb);vec3 d=G(Z.rgb,vTextureCoord,realWidth,realHeight,vignette_amount,0.15);d=E(d,c);Y.rgb=d*Y.a;gl_FragColor=Y;}";var Zg="vec3 A(vec3 B,vec3 C){return 1.-(1.-B)*(1.-C);}vec3 D(vec3 E,vec2 F,float G,float H,float I,float J){vec2 K=F-vec2(0.5*G,0.5*H);K.x*=H/G;float L=length(K);float M=H*(0.5+(1.-I)*0.5);float N=clamp(smoothstep(M,M-0.2,L),0.,1.);E*=mix(N,1.,J);return E;}float O(vec3 P){return dot(P,vec3(0.299,0.587,0.114));}vec3 Q(vec3 R,float S,float T){float U=(2.+(T*20.));return S/(1.+exp(U*(0.5-R)));}varying vec2 vTextureCoord;uniform sampler2D uSampler;uniform sampler2D blurSampler;uniform sampler2D textureSampler;uniform float vignette_amount;uniform float clampX;uniform float clampY;uniform float realWidth;uniform float realHeight;void main(void){vec4 V=texture2D(uSampler,vTextureCoord);if(V.a==0.){gl_FragColor=vec4(0,0,0,0);return;}V.rgb/=V.a;vec4 W=texture2D(blurSampler,vTextureCoord*vec2(clampX,clampY));vec4 X=texture2D(textureSampler,vTextureCoord*vec2(clampX,clampY));vec3 Y=vec3(O(W.rgb));Y=Q(Y,0.75,0.85);vec3 Z=A(Y.rgb,V.rgb);vec3 a=A(Y.rgb,W.rgb);Z=X.rgb*Z;a=X.rgb*Z;vec3 b=D(Z,vTextureCoord,realWidth,realHeight,vignette_amount,0.15);vec3 c=D(a,vTextureCoord,realWidth,realHeight,vignette_amount,0.15);V.rgb=vec3(b.b,b.r,c.g)*V.a;gl_FragColor=V;}";var ev="vec3 A(vec3 B,vec3 C){return 1.-(1.-B)*(1.-C);}vec3 D(vec3 E,vec2 F,float G,float H,float I,float J){vec2 K=F-vec2(0.5*G,0.5*H);K.x*=H/G;float L=length(K);float M=H*(0.5+(1.-I)*0.5);float N=clamp(smoothstep(M,M-0.2,L),0.,1.);E*=mix(N,1.,J);return E;}float O(vec3 P){return dot(P,vec3(0.299,0.587,0.114));}vec3 Q(vec3 R,float S,float T){float U=(2.+(T*20.));return S/(1.+exp(U*(0.5-R)));}varying vec2 vTextureCoord;uniform sampler2D uSampler;uniform sampler2D blurSampler;uniform sampler2D textureSampler;uniform float vignette_amount;uniform float clampX;uniform float clampY;uniform float realWidth;uniform float realHeight;void main(void){vec4 V=texture2D(uSampler,vTextureCoord);if(V.a==0.){gl_FragColor=vec4(0,0,0,0);return;}V.rgb/=V.a;vec4 W=texture2D(blurSampler,vTextureCoord*vec2(clampX,clampY));vec4 X=texture2D(textureSampler,vTextureCoord*vec2(clampX,clampY));vec3 Y=vec3(O(W.rgb));Y=Q(Y,0.75,0.85);vec3 Z=A(Y.rgb,V.rgb);vec3 a=A(Y.rgb,W.rgb);Z=X.rgb*Z;a=X.rgb*Z;vec3 b=D(Z,vTextureCoord,realWidth,realHeight,vignette_amount,0.15);vec3 c=D(a,vTextureCoord,realWidth,realHeight,vignette_amount,0.15);V.rgb=vec3(b.r,b.b,c.g)*V.a;gl_FragColor=V;}";var tv="vec3 A(vec3 B,vec3 C){return 1.-(1.-B)*(1.-C);}vec3 D(vec3 E,vec2 F,float G,float H,float I,float J){vec2 K=F-vec2(0.5*G,0.5*H);K.x*=H/G;float L=length(K);float M=H*(0.5+(1.-I)*0.5);float N=clamp(smoothstep(M,M-0.2,L),0.,1.);E*=mix(N,1.,J);return E;}float O(vec3 P){return dot(P,vec3(0.299,0.587,0.114));}vec3 Q(vec3 R,float S,float T){float U=(2.+(T*20.));return S/(1.+exp(U*(0.5-R)));}varying vec2 vTextureCoord;uniform sampler2D uSampler;uniform sampler2D blurSampler;uniform float vignette_amount;uniform float clampX;uniform float clampY;uniform float realWidth;uniform float realHeight;void main(void){vec4 V=texture2D(uSampler,vTextureCoord);if(V.a==0.){gl_FragColor=vec4(0,0,0,0);return;}V.rgb/=V.a;vec4 W=texture2D(blurSampler,vTextureCoord*vec2(clampX,clampY));vec3 X=vec3(O(W.rgb));X=Q(X,0.75,0.85);vec3 Y=A(X.rgb,V.rgb);vec3 Z=A(X.rgb,W.rgb);vec3 a=D(Y,vTextureCoord,realWidth,realHeight,vignette_amount,0.15);vec3 b=D(Z,vTextureCoord,realWidth,realHeight,vignette_amount,0.15);V.rgb=vec3(a.r,a.r,b.g)*V.a;gl_FragColor=V;}";var iv="vec3 A(vec3 B,vec3 C){return 1.-(1.-B)*(1.-C);}vec3 D(vec3 E,vec2 F,float G,float H,float I,float J){vec2 K=F-vec2(0.5*G,0.5*H);K.x*=H/G;float L=length(K);float M=H*(0.5+(1.-I)*0.5);float N=clamp(smoothstep(M,M-0.2,L),0.,1.);E*=mix(N,1.,J);return E;}float O(vec3 P){return dot(P,vec3(0.299,0.587,0.114));}vec3 Q(vec3 R,float I){return pow(R,vec3(I));}vec3 S(vec3 R,float T,float U){vec3 V=Q(R,T);vec3 W=((V-0.5)*U)+0.5;return W;}varying vec2 vTextureCoord;uniform sampler2D uSampler;uniform sampler2D blurSampler;uniform float vignette_amount;uniform float clampX;uniform float clampY;uniform float realWidth;uniform float realHeight;void main(void){vec4 X=texture2D(uSampler,vTextureCoord);if(X.a==0.){gl_FragColor=vec4(0,0,0,0);return;}X.rgb/=X.a;vec4 Y=texture2D(blurSampler,vTextureCoord*vec2(clampX,clampY));vec3 Z=vec3(O(X.rgb));vec3 a=vec3(O(Y.rgb));Z=S(Z,1.,1.5);a=S(a,1.,1.5);vec3 b=D(Z,vTextureCoord,realWidth,realHeight,vignette_amount,0.3);vec3 c=D(a,vTextureCoord,realWidth,realHeight,vignette_amount,0.3);vec3 d=vec3(c.r,b.r,c.r);X.rgb=d*X.a;gl_FragColor=X;}";var rv=class extends PIXI.Filter{constructor(e){let t=iv;switch(e){case BFN.CONST.MOTION_COLOR_PRESETS.PRESET_2:t=tv;break;case BFN.CONST.MOTION_COLOR_PRESETS.PRESET_3:t=ev;break;case BFN.CONST.MOTION_COLOR_PRESETS.PRESET_4:t=Zg;break;case BFN.CONST.MOTION_COLOR_PRESETS.PRESET_5:t=Qg;break}super(O,t);this.currentPreset=e,this.padding=0}apply(e,t,r,a){let s=BFN.FilterHelper.calculateFilterClamp(t,r,this.blurSampler||null);this.uniforms.clampX=s.x,this.uniforms.clampY=s.y,this.uniforms.realWidth=r.destinationFrame.width/t.size.width,this.uniforms.realHeight=r.destinationFrame.height/t.size.height,e.applyFilter(this,t,r,a)}get textureSampler(){return this.uniforms.textureSampler}set textureSampler(e){this.uniforms.textureSampler=e}get blurSampler(){return this.uniforms.blurSampler}set blurSampler(e){e.baseTexture.isPowerOfTwo=!0,this.uniforms.blurSampler=e}get vignette_amount(){return this.uniforms.vignette_amount}set vignette_amount(e){this.uniforms.vignette_amount=e}},av=rv;var sv="vec2 A(vec2 B,vec4 C){B*=C.xy;B+=C.zw;return B;}vec2 D(vec2 B,vec4 C){B-=C.zw;B/=C.xy;return B;}vec4 E(sampler2D F,vec2 G,vec4 H,vec2 I,vec2 J,float K){float L=3.14159265258979;vec2 B=A(G,H);vec2 M=vec2(J.x*I.x,J.y*I.y);float N=J.x;vec2 O;vec2 P=B-M;float distance=length(P);if(distance<N){vec2 Q=M+(P/K);float R=distance/N;float S=(cos(R*L)+1.)/2.;O=Q*(S)+B*(1.-S);}else{O=B;}B=D(O,H);return texture2D(F,B);}vec3 T(vec3 U,vec2 V,float W,float X,float Y,float Z){vec2 a=V-vec2(0.5*W,0.5*X);a.x*=X/W;float b=length(a);float c=X*(0.5+(1.-Y)*0.5);float d=clamp(Z,0.001,1.00);float e=smoothstep(c,c-d,b);U*=e;return U;}float f(float g,float h){return(g<0.5)?2.*g*h:1.-2.*(1.-g)*(1.-h);}vec3 i(vec3 g,vec3 h){vec3 j;j.r=f(g.r,h.r);j.g=f(g.g,h.g);j.b=f(g.b,h.b);return j;}uniform sampler2D uSampler;uniform sampler2D iChanel1;uniform float vignette_amount;uniform float fisheye_amount;varying vec2 vTextureCoord;uniform float resolutionX;uniform float resolutionY;uniform vec4 filterArea;uniform vec2 centerPoint;uniform float realWidth;uniform float realHeight;uniform float clampX;uniform float clampY;void main(void){vec4 k=texture2D(iChanel1,vTextureCoord*vec2(clampX,clampY));vec4 l=E(uSampler,vTextureCoord,filterArea,centerPoint,vec2(resolutionX,resolutionY),fisheye_amount);vec3 m=T(l.rgb,vTextureCoord,realWidth,realHeight,vignette_amount,0.60);l.rgb=i(m,k.rgb);gl_FragColor=l;}";var ov="";var nv="";var lv="vec2 A(vec2 B,vec4 C){B*=C.xy;B+=C.zw;return B;}vec2 D(vec2 B,vec4 C){B-=C.zw;B/=C.xy;return B;}vec4 E(sampler2D F,vec2 G,vec4 H,vec2 I,vec2 J,float K){float L=3.14159265258979;vec2 B=A(G,H);vec2 M=vec2(J.x*I.x,J.y*I.y);float N=J.x;vec2 O;vec2 P=B-M;float distance=length(P);if(distance<N){vec2 Q=M+(P/K);float R=distance/N;float S=(cos(R*L)+1.)/2.;O=Q*(S)+B*(1.-S);}else{O=B;}B=D(O,H);return texture2D(F,B);}vec3 T(vec3 U,vec2 V,float W,float X,float Y,float Z){vec2 a=V-vec2(0.5*W,0.5*X);a.x*=X/W;float b=length(a);float c=X*(0.5+(1.-Y)*0.5);float d=clamp(Z,0.001,1.00);float e=smoothstep(c,c-d,b);U*=e;return U;}uniform sampler2D uSampler;uniform float vignette_amount;uniform float fisheye_amount;varying vec2 vTextureCoord;uniform float resolutionX;uniform float resolutionY;uniform vec4 filterArea;uniform vec2 centerPoint;uniform float realWidth;uniform float realHeight;void main(void){vec4 f=E(uSampler,vTextureCoord,filterArea,centerPoint,vec2(resolutionX,resolutionY),fisheye_amount);f.rgb=T(f.rgb,vTextureCoord,realWidth,realHeight,vignette_amount,0.60);gl_FragColor=f;}";var cv="";var hv=class extends PIXI.Filter{constructor(e){let t=O,r=cv,a=!0;switch(e){case BFN.CONST.PATRIOTIC_PRESETS.PRESET_2:a=!1,r=lv;break;case BFN.CONST.PATRIOTIC_PRESETS.PRESET_3:r=nv;break;case BFN.CONST.PATRIOTIC_PRESETS.PRESET_4:r=ov;break;case BFN.CONST.PATRIOTIC_PRESETS.PRESET_5:r=sv;break}super(t,r);this.padding=0,this.currentPreset=e,this.isUseClamp=a,this.centerPoint=[.5,.5]}apply(e,t,r,a){if(this.uniforms.resolutionX=r.destinationFrame.width,this.uniforms.resolutionY=r.destinationFrame.height,this.uniforms.realWidth=r.destinationFrame.width/t.size.width,this.uniforms.realHeight=r.destinationFrame.height/t.size.height,this.isUseClamp!==!1){var s=BFN.FilterHelper.calculateFilterClamp(t,r);this.uniforms.clampX=s.x,this.uniforms.clampY=s.y}e.applyFilter(this,t,r,a)}get centerPoint(){return this.uniforms.centerPoint}set centerPoint(e){this.uniforms.centerPoint=e}get iChanel1(){return this.uniforms.iChanel1}set iChanel1(e){this.uniforms.iChanel1=e}get iChanel2(){return this.uniforms.iChanel2}set iChanel2(e){this.uniforms.iChanel2=e}get vignette_amount(){return this.uniforms.vignette_amount}set vignette_amount(e){this.uniforms.vignette_amount=e}get fisheye_amount(){return this.uniforms.fisheye_amount}set fisheye_amount(e){this.uniforms.fisheye_amount=e}},uv=hv;var dv="vec4 A(sampler2D B,vec2 C,vec2 D,vec2 E,vec2 F,int G,int H,vec4 I){if(H==1){E=E/F;D=D/F;F=vec2(1.,1.);}float J=(((C.x*F.x)-D.x)/E.x);float K=(((C.y*F.y)-D.y)/E.y);if(G==0&&(J<0.||J>1.||K<0.||K>1.)){return I;}else{J=mod((mod(J,1.)+1.),1.);K=mod((mod(K,1.)+1.),1.);vec2 L=vec2((J/F.x),(K/F.y));return texture2D(B,L);}}vec3 M(vec3 N,vec2 O,float P,float Q,float R,float S){vec2 T=O-vec2(0.5*P,0.5*Q);T.x*=Q/P;float U=length(T);float V=Q*(0.5+(1.-R)*0.5);float W=clamp(S,0.001,1.00);float X=smoothstep(V,V-W,U);N*=X;return N;}vec3 Y(vec2 C,vec2 D,vec2 E,vec2 F){float J=(((C.x*F.x)-D.x)/E.x);float K=(((C.y*F.y)-D.y)/E.y);vec3 Z;if(J<0.||J>1.||K<0.||K>1.){Z=vec3(0.);}else{Z=vec3(1.);}return Z;}float a(vec3 b){return dot(b,vec3(0.299,0.587,0.114));}vec3 c(vec3 b){float d=a(b);float e=min(min(b.r,b.g),b.b);float f=max(max(b.r,b.g),b.b);if(e<0.){max((b-d)*d/(d-e)+d,0.);}if(f>1.){min((b-d)*(1.-d)/(f-d)+d,1.);}return b;}float g(vec3 b){return dot(b,vec3(0.299,0.587,0.114));}vec3 h(vec3 b,float d){float i=d-g(b);b=b+vec3(i);return c(b);}float j(vec3 b){return dot(b,vec3(0.299,0.587,0.114));}vec3 k(vec3 l,vec3 m){return h(m,j(l));}vec3 n(vec3 o,vec3 p){return mix(2.*o*p,1.-2.*(1.-o)*(1.-p),step(0.5,p));}vec3 q(vec3 l,sampler2D r,vec4 s,float t){float u=255./s.x;l.r=texture2D(r,vec2(l.r*u*t,0.)).r;l.g=texture2D(r,vec2(l.g*u*t,0.)).g;l.b=texture2D(r,vec2(l.b*u*t,0.)).b;return l;}vec3 v(vec3 l,float w){return pow(l,vec3(w));}vec3 x(vec3 o,vec3 p){return mix(2.*o*p,1.-2.*(1.-o)*(1.-p),step(0.5,p));}vec3 y(vec3 l,float z,float AA){vec3 AB=v(l,z);vec3 AC=mix(vec3(0.5),AB,AA);return x(AC,AB);}varying vec2 vTextureCoord;uniform sampler2D uSampler;uniform sampler2D gradientSampler;uniform float vignette_amount;uniform vec3 border_color;uniform float border_thickness;uniform float clampX;uniform float clampY;uniform float realWidth;uniform float realHeight;uniform vec4 filterArea;uniform vec2 dimensions;void main(void){float AD=border_thickness;float AE=(dimensions.x-(AD*2.))/dimensions.x;float AF=AD/dimensions.x;float AG=((dimensions.y-dimensions.y*AE)/2.)/dimensions.y;vec4 I=vec4(1.);vec2 AH=vec2(AE,AE);vec2 AI=vec2(clampX,clampY);vec4 AJ=A(uSampler,vTextureCoord,vec2(AF,AG),AH,AI,0,0,I);vec3 AK=q(y(AJ.rgb,0.9,0.),gradientSampler,filterArea,clampX);vec3 AL=k(AJ.rgb,vec3(0.99,1.,0.));vec3 AM=AK*AL;AJ.rgb=mix(AK,AM,0.2);vec3 AN=n(vec3(0.,0.55,0.38),AJ.rgb);AJ.rgb=mix(AJ.rgb,AN,0.7);vec2 AO=(dimensions/filterArea.xy*AH);vec3 AP=M(AJ.rgb,vTextureCoord-vec2(AF,AG)/AI,realWidth,realHeight,vignette_amount,0.45);vec3 AQ=Y(vTextureCoord,vec2(AF,AG),AH,AI);AP=mix(border_color,AP,AQ);gl_FragColor=vec4(AP.rgb,1.);}";var mv="vec4 A(sampler2D B,vec2 C,vec2 D,vec2 E,vec2 F,int G,int H,vec4 I){if(H==1){E=E/F;D=D/F;F=vec2(1.,1.);}float J=(((C.x*F.x)-D.x)/E.x);float K=(((C.y*F.y)-D.y)/E.y);if(G==0&&(J<0.||J>1.||K<0.||K>1.)){return I;}else{J=mod((mod(J,1.)+1.),1.);K=mod((mod(K,1.)+1.),1.);vec2 L=vec2((J/F.x),(K/F.y));return texture2D(B,L);}}vec3 M(vec3 N,vec2 O,float P,float Q,float R,float S){vec2 T=O-vec2(0.5*P,0.5*Q);T.x*=Q/P;float U=length(T);float V=Q*(0.5+(1.-R)*0.5);float W=clamp(S,0.001,1.00);float X=smoothstep(V,V-W,U);N*=X;return N;}vec3 Y(vec2 C,vec2 D,vec2 E,vec2 F){float J=(((C.x*F.x)-D.x)/E.x);float K=(((C.y*F.y)-D.y)/E.y);vec3 Z;if(J<0.||J>1.||K<0.||K>1.){Z=vec3(0.);}else{Z=vec3(1.);}return Z;}vec3 a(vec3 b,vec3 c){return 1.-(1.-b)*(1.-c);}vec3 d(vec3 e,float f,float g){float h=(2.+(g*20.));return f/(1.+exp(h*(0.5-e)));}float i(vec3 j){return dot(j,vec3(0.299,0.587,0.114));}float k(vec3 j){return dot(j,vec3(0.299,0.587,0.114));}vec3 l(vec3 j){float m=k(j);float n=min(min(j.r,j.g),j.b);float o=max(max(j.r,j.g),j.b);if(n<0.){max((j-m)*m/(m-n)+m,0.);}if(o>1.){min((j-m)*(1.-m)/(o-m)+m,1.);}return j;}float p(vec3 j){return dot(j,vec3(0.299,0.587,0.114));}vec3 q(vec3 j,float m){float r=m-p(j);j=j+vec3(r);return l(j);}float s(vec3 j){return dot(j,vec3(0.299,0.587,0.114));}vec3 t(vec3 e,vec3 u){return q(u,s(e));}vec3 v(vec3 e,float w){return pow(e,vec3(w));}vec3 x(vec3 b,vec3 c){return mix(2.*b*c,1.-2.*(1.-b)*(1.-c),step(0.5,c));}vec3 y(vec3 e,float z,float AA){vec3 AB=v(e,z);vec3 AC=mix(vec3(0.5),AB,AA);return x(AC,AB);}varying vec2 vTextureCoord;uniform sampler2D uSampler;uniform sampler2D blurSampler;uniform float vignette_amount;uniform vec3 border_color;uniform float border_thickness;uniform float clampX;uniform float clampY;uniform float realWidth;uniform float realHeight;uniform vec4 filterArea;uniform vec2 dimensions;void main(void){float AD=border_thickness;float AE=(dimensions.x-(AD*2.))/dimensions.x;float AF=AD/dimensions.x;float AG=((dimensions.y-dimensions.y*AE)/2.)/dimensions.y;vec4 I=vec4(1.);vec2 AH=vec2(AE,AE);vec2 AI=vec2(clampX,clampY);vec4 AJ=A(uSampler,vTextureCoord,vec2(AF,AG),AH,AI,0,0,I);vec4 AK=A(blurSampler,vTextureCoord,vec2(AF,AG),AH,AI,0,1,I);AK.rgb=d(vec3(i(AK.rgb)),0.75,0.3);AJ.rgb=a(AK.rgb,AJ.rgb);AJ.rgb=y(AJ.rgb,1.,1.3);vec3 AL=AJ.rgb*vec3(1.,0.96,0.38);AJ.rgb=mix(AJ.rgb,AL,0.8);vec2 AM=(dimensions/filterArea.xy*AH);vec3 AN=M(AJ.rgb,vTextureCoord-vec2(AF,AG)/AI,realWidth,realHeight,vignette_amount,0.45);vec3 AO=Y(vTextureCoord,vec2(AF,AG),AH,AI);AN=mix(border_color,AN,AO);gl_FragColor=vec4(AN.rgb,1.);}";var pv="vec4 A(sampler2D B,vec2 C,vec2 D,vec2 E,vec2 F,int G,int H,vec4 I){if(H==1){E=E/F;D=D/F;F=vec2(1.,1.);}float J=(((C.x*F.x)-D.x)/E.x);float K=(((C.y*F.y)-D.y)/E.y);if(G==0&&(J<0.||J>1.||K<0.||K>1.)){return I;}else{J=mod((mod(J,1.)+1.),1.);K=mod((mod(K,1.)+1.),1.);vec2 L=vec2((J/F.x),(K/F.y));return texture2D(B,L);}}vec3 M(vec3 N,vec2 O,float P,float Q,float R,float S){vec2 T=O-vec2(0.5*P,0.5*Q);T.x*=Q/P;float U=length(T);float V=Q*(0.5+(1.-R)*0.5);float W=clamp(S,0.001,1.00);float X=smoothstep(V,V-W,U);N*=X;return N;}vec3 Y(vec2 C,vec2 D,vec2 E,vec2 F){float J=(((C.x*F.x)-D.x)/E.x);float K=(((C.y*F.y)-D.y)/E.y);vec3 Z;if(J<0.||J>1.||K<0.||K>1.){Z=vec3(0.);}else{Z=vec3(1.);}return Z;}vec3 a(vec3 b,vec3 c){return 1.-(1.-b)*(1.-c);}vec3 d(vec3 e,float f,float g){float h=(2.+(g*20.));return f/(1.+exp(h*(0.5-e)));}float i(vec3 j){return dot(j,vec3(0.299,0.587,0.114));}varying vec2 vTextureCoord;uniform sampler2D uSampler;uniform sampler2D blurSampler;uniform sampler2D textureSampler;uniform float vignette_amount;uniform vec3 border_color;uniform float border_thickness;uniform float clampX;uniform float clampY;uniform float realWidth;uniform float realHeight;uniform vec4 filterArea;uniform vec2 dimensions;void main(void){float k=border_thickness;float l=(dimensions.x-(k*2.))/dimensions.x;float m=k/dimensions.x;float n=((dimensions.y-dimensions.y*l)/2.)/dimensions.y;vec4 I=vec4(1.);vec2 o=vec2(l,l);vec2 p=vec2(clampX,clampY);vec4 q=A(uSampler,vTextureCoord,vec2(m,n),o,p,0,0,I);vec4 r=A(blurSampler,vTextureCoord,vec2(m,n),o,p,0,1,I);vec4 s=A(textureSampler,vTextureCoord,vec2(m,n),o,p,0,1,I);r.rgb=d(vec3(i(r.rgb)),0.75,0.3);q.rgb=a(r.rgb,q.rgb);q.rgb=s.rgb*q.rgb;vec2 t=(dimensions/filterArea.xy*o);vec3 u=M(q.rgb,vTextureCoord-vec2(m,n)/p,realWidth,realHeight,vignette_amount,0.45);vec3 v=Y(vTextureCoord,vec2(m,n),o,p);u=mix(border_color,u,v);gl_FragColor=vec4(u.rgb,1.);}";var fv="vec4 A(sampler2D B,vec2 C,vec2 D,vec2 E,vec2 F,int G,int H,vec4 I){if(H==1){E=E/F;D=D/F;F=vec2(1.,1.);}float J=(((C.x*F.x)-D.x)/E.x);float K=(((C.y*F.y)-D.y)/E.y);if(G==0&&(J<0.||J>1.||K<0.||K>1.)){return I;}else{J=mod((mod(J,1.)+1.),1.);K=mod((mod(K,1.)+1.),1.);vec2 L=vec2((J/F.x),(K/F.y));return texture2D(B,L);}}vec3 M(vec3 N,vec2 O,float P,float Q,float R,float S){vec2 T=O-vec2(0.5*P,0.5*Q);T.x*=Q/P;float U=length(T);float V=Q*(0.5+(1.-R)*0.5);float W=clamp(S,0.001,1.00);float X=smoothstep(V,V-W,U);N*=X;return N;}vec3 Y(vec2 C,vec2 D,vec2 E,vec2 F){float J=(((C.x*F.x)-D.x)/E.x);float K=(((C.y*F.y)-D.y)/E.y);vec3 Z;if(J<0.||J>1.||K<0.||K>1.){Z=vec3(0.);}else{Z=vec3(1.);}return Z;}vec3 a(vec3 b,vec3 c){return 1.-(1.-b)*(1.-c);}vec3 d(vec3 e,float f,float g){float h=(2.+(g*20.));return f/(1.+exp(h*(0.5-e)));}float i(vec3 j){return dot(j,vec3(0.299,0.587,0.114));}varying vec2 vTextureCoord;uniform sampler2D uSampler;uniform sampler2D blurSampler;uniform sampler2D textureSampler;uniform float vignette_amount;uniform vec3 border_color;uniform float border_thickness;uniform float clampX;uniform float clampY;uniform float realWidth;uniform float realHeight;uniform vec4 filterArea;uniform vec2 dimensions;void main(void){float k=border_thickness;float l=(dimensions.x-(k*2.))/dimensions.x;float m=k/dimensions.x;float n=((dimensions.y-dimensions.y*l)/2.)/dimensions.y;vec4 I=vec4(1.);vec2 o=vec2(l,l);vec2 p=vec2(clampX,clampY);vec4 q=A(uSampler,vTextureCoord,vec2(m,n),o,p,0,0,I);vec4 r=A(blurSampler,vTextureCoord,vec2(m,n),o,p,0,1,I);vec4 s=A(textureSampler,vTextureCoord,vec2(m,n),o,p,0,1,I);r.rgb=d(vec3(i(r.rgb)),0.75,0.3);q.rgb=a(r.rgb,q.rgb);q.rgb=s.rgb*q.rgb;vec2 t=(dimensions/filterArea.xy*o);vec3 u=M(q.rgb,vTextureCoord-vec2(m,n)/p,realWidth,realHeight,vignette_amount,0.45);vec3 v=Y(vTextureCoord,vec2(m,n),o,p);u=mix(border_color,u,v);gl_FragColor=vec4(u.rgb,1.);}";var gv="vec4 A(sampler2D B,vec2 C,vec2 D,vec2 E,vec2 F,int G,int H,vec4 I){if(H==1){E=E/F;D=D/F;F=vec2(1.,1.);}float J=(((C.x*F.x)-D.x)/E.x);float K=(((C.y*F.y)-D.y)/E.y);if(G==0&&(J<0.||J>1.||K<0.||K>1.)){return I;}else{J=mod((mod(J,1.)+1.),1.);K=mod((mod(K,1.)+1.),1.);vec2 L=vec2((J/F.x),(K/F.y));return texture2D(B,L);}}vec3 M(vec3 N,vec2 O,float P,float Q,float R,float S){vec2 T=O-vec2(0.5*P,0.5*Q);T.x*=Q/P;float U=length(T);float V=Q*(0.5+(1.-R)*0.5);float W=clamp(S,0.001,1.00);float X=smoothstep(V,V-W,U);N*=X;return N;}vec3 Y(vec2 C,vec2 D,vec2 E,vec2 F){float J=(((C.x*F.x)-D.x)/E.x);float K=(((C.y*F.y)-D.y)/E.y);vec3 Z;if(J<0.||J>1.||K<0.||K>1.){Z=vec3(0.);}else{Z=vec3(1.);}return Z;}vec3 a(vec3 b,vec3 c){return 1.-(1.-b)*(1.-c);}vec3 d(vec3 e,float f,float g){float h=(2.+(g*20.));return f/(1.+exp(h*(0.5-e)));}float i(vec3 j){return dot(j,vec3(0.299,0.587,0.114));}varying vec2 vTextureCoord;uniform sampler2D uSampler;uniform sampler2D blurSampler;uniform sampler2D textureSampler;uniform float vignette_amount;uniform vec3 border_color;uniform float border_thickness;uniform float clampX;uniform float clampY;uniform float realWidth;uniform float realHeight;uniform vec4 filterArea;uniform vec2 dimensions;void main(void){float k=border_thickness;float l=(dimensions.x-(k*2.))/dimensions.x;float m=k/dimensions.x;float n=((dimensions.y-dimensions.y*l)/2.)/dimensions.y;vec4 I=vec4(1.);vec2 o=vec2(l,l);vec2 p=vec2(clampX,clampY);vec4 q=A(uSampler,vTextureCoord,vec2(m,n),o,p,0,0,I);vec4 r=A(blurSampler,vTextureCoord,vec2(m,n),o,p,0,1,I);vec4 s=A(textureSampler,vTextureCoord,vec2(m,n),o,p,0,1,I);r.rgb=d(vec3(i(r.rgb)),0.75,0.3);q.rgb=a(r.rgb,q.rgb);q.rgb=s.rgb*q.rgb;vec2 t=(dimensions/filterArea.xy*o);vec3 u=M(q.rgb,vTextureCoord-vec2(m,n)/p,realWidth,realHeight,vignette_amount,0.45);vec3 v=Y(vTextureCoord,vec2(m,n),o,p);u=mix(border_color,u,v);gl_FragColor=vec4(u.rgb,1.);}";var vv="vec4 A(sampler2D B,vec2 C,vec2 D,vec2 E,vec2 F,int G,int H,vec4 I){if(H==1){E=E/F;D=D/F;F=vec2(1.,1.);}float J=(((C.x*F.x)-D.x)/E.x);float K=(((C.y*F.y)-D.y)/E.y);if(G==0&&(J<0.||J>1.||K<0.||K>1.)){return I;}else{J=mod((mod(J,1.)+1.),1.);K=mod((mod(K,1.)+1.),1.);vec2 L=vec2((J/F.x),(K/F.y));return texture2D(B,L);}}vec3 M(vec3 N,vec2 O,float P,float Q,float R,float S){vec2 T=O-vec2(0.5*P,0.5*Q);T.x*=Q/P;float U=length(T);float V=Q*(0.5+(1.-R)*0.5);float W=clamp(S,0.001,1.00);float X=smoothstep(V,V-W,U);N*=X;return N;}vec3 Y(vec2 C,vec2 D,vec2 E,vec2 F){float J=(((C.x*F.x)-D.x)/E.x);float K=(((C.y*F.y)-D.y)/E.y);vec3 Z;if(J<0.||J>1.||K<0.||K>1.){Z=vec3(0.);}else{Z=vec3(1.);}return Z;}vec3 a(vec3 b,vec3 c){return 1.-(1.-b)*(1.-c);}vec3 d(vec3 e,float f,float g){float h=(2.+(g*20.));return f/(1.+exp(h*(0.5-e)));}float i(vec3 j){return dot(j,vec3(0.299,0.587,0.114));}varying vec2 vTextureCoord;uniform sampler2D uSampler;uniform sampler2D blurSampler;uniform sampler2D textureSampler;uniform float vignette_amount;uniform vec3 border_color;uniform float border_thickness;uniform float clampX;uniform float clampY;uniform float realWidth;uniform float realHeight;uniform vec4 filterArea;uniform vec2 dimensions;void main(void){float k=border_thickness;float l=(dimensions.x-(k*2.))/dimensions.x;float m=k/dimensions.x;float n=((dimensions.y-dimensions.y*l)/2.)/dimensions.y;vec4 I=vec4(1.);vec2 o=vec2(l,l);vec2 p=vec2(clampX,clampY);vec4 q=A(uSampler,vTextureCoord,vec2(m,n),o,p,0,0,I);vec4 r=A(blurSampler,vTextureCoord,vec2(m,n),o,p,0,1,I);vec4 s=A(textureSampler,vTextureCoord,vec2(m,n),o,p,0,1,I);r.rgb=d(vec3(i(r.rgb)),0.75,0.3);q.rgb=a(r.rgb,q.rgb);q.rgb=s.rgb*q.rgb;vec2 t=(dimensions/filterArea.xy*o);vec3 u=M(q.rgb,vTextureCoord-vec2(m,n)/p,realWidth,realHeight,vignette_amount,0.45);vec3 v=Y(vTextureCoord,vec2(m,n),o,p);u=mix(border_color,u,v);gl_FragColor=vec4(u.rgb,1.);}";var yv=class extends PIXI.Filter{constructor(e){let t=vv;switch(e){case BFN.CONST.LOMO_ART_PRESETS.PRESET_2:t=gv;break;case BFN.CONST.LOMO_ART_PRESETS.PRESET_3:t=fv;break;case BFN.CONST.LOMO_ART_PRESETS.PRESET_4:t=pv;break;case BFN.CONST.LOMO_ART_PRESETS.PRESET_6:t=mv;break;case BFN.CONST.LOMO_ART_PRESETS.PRESET_7:t=dv;break}super(O,t);this.currentPreset=e,this.padding=0}apply(e,t,r,a){let s=BFN.FilterHelper.calculateFilterClamp(t,r,this.blurSampler||null);this.uniforms.clampX=s.x,this.uniforms.clampY=s.y,this.uniforms.realWidth=r.destinationFrame.width/t.size.width,this.uniforms.realHeight=r.destinationFrame.height/t.size.height,this.uniforms.dimensions[0]=t.sourceFrame.width,this.uniforms.dimensions[1]=t.sourceFrame.height,e.applyFilter(this,t,r,a)}get textureSampler(){return this.uniforms.textureSampler}set textureSampler(e){this.uniforms.textureSampler=e}get blurSampler(){return this.uniforms.blurSampler}set blurSampler(e){e.baseTexture.isPowerOfTwo=!0,this.uniforms.blurSampler=e}get gradientSampler(){return this.uniforms.gradientSampler}set gradientSampler(e){this.uniforms.gradientSampler=e}get vignette_amount(){return this.uniforms.vignette_amount}set vignette_amount(e){this.uniforms.vignette_amount=e}get border_color(){return this.uniforms.border_color}set border_color(e){e=BFN.FilterHelper.hex2rgb(e),this.uniforms.border_color=e}get border_thickness(){return this.uniforms.border_thickness}set border_thickness(e){this.uniforms.border_thickness=e}},xv=yv;var Tv="vec3 A(vec3 B,sampler2D C,vec4 D,float E){float F=255./D.x;B.r=texture2D(C,vec2(B.r*F*E,0.)).r;B.g=texture2D(C,vec2(B.g*F*E,0.)).g;B.b=texture2D(C,vec2(B.b*F*E,0.)).b;return B;}vec3 G(vec3 B,float H){return pow(B,vec3(H));}vec3 I(vec3 J,vec3 K){return mix(2.*J*K,1.-2.*(1.-J)*(1.-K),step(0.5,K));}vec3 L(vec3 B,float M,float N){vec3 O=G(B,M);vec3 P=mix(vec3(0.5),O,N);return I(P,O);}float Q(vec3 R){return dot(R,vec3(0.299,0.587,0.114));}vec3 S(vec3 R){float T=Q(R);float U=min(min(R.r,R.g),R.b);float V=max(max(R.r,R.g),R.b);if(U<0.){max((R-T)*T/(T-U)+T,0.);}if(V>1.){min((R-T)*(1.-T)/(V-T)+T,1.);}return R;}float W(vec3 R){return dot(R,vec3(0.299,0.587,0.114));}vec3 X(vec3 R,float T){float Y=T-W(R);R=R+vec3(Y);return S(R);}float Z(vec3 R){return dot(R,vec3(0.299,0.587,0.114));}vec3 a(vec3 B,vec3 b){return X(b,Z(B));}varying vec2 vTextureCoord;uniform sampler2D uSampler;uniform sampler2D curvesSampler;uniform vec3 color;uniform float contrast;uniform float intensity;uniform float clampX;uniform vec4 filterArea;void main(void){vec4 c=texture2D(uSampler,vTextureCoord);if(c.a==0.){gl_FragColor=vec4(0,0,0,0);return;}c.rgb/=c.a;vec4 d=texture2D(curvesSampler,vTextureCoord);vec3 e=A(L(c.rgb,1.,contrast/100.),curvesSampler,filterArea,clampX);vec3 f=a(c.rgb,color);vec3 g=e*f;c.rgb=mix(e,g,intensity)*c.a;gl_FragColor=c;}";var Fv=class extends PIXI.Filter{constructor(){super(O,Tv);this.padding=0}apply(e,t,r,a){let s=BFN.FilterHelper.calculateFilterClamp(t,r);this.uniforms.clampX=s.x,e.applyFilter(this,t,r,a)}get curvesSampler(){return this.uniforms.curvesSampler}set curvesSampler(e){this.uniforms.curvesSampler=e}get color(){return this.uniforms.color}set color(e){e=BFN.FilterHelper.hex2rgb(e),this.uniforms.color=e}get contrast(){return this.uniforms.contrast}set contrast(e){this.uniforms.contrast=e}get intensity(){return this.uniforms.intensity}set intensity(e){this.uniforms.intensity=e}},bv=Fv;var Bv="varying vec2 vTextureCoord;uniform sampler2D uSampler;void main(void){vec4 A=texture2D(uSampler,vTextureCoord);vec3 B=A.rgb*mat3(0.299,0.587,0.114,-0.168736,-0.331264,0.5,0.5,-0.418688,-0.081312)+vec3(0.,0.5,0.5);if((B.r>=80./255.)&&(B.g>=0.33)&&(B.g<=0.529)&&(B.b>=0.529)&&(B.b<=0.705)){A.rgb=A.rgb;}else{A.a=0.;}gl_FragColor=A;}";var Sv=class extends PIXI.Filter{constructor(){super(O,Bv);this.padding=0}},Iv=Sv;var _v="float A(vec3 B){return dot(B,vec3(0.299,0.587,0.114));}vec3 C(vec3 D,vec3 E){return(D.rgb/2.-E.rgb/2.)+0.5;}varying vec2 vTextureCoord;uniform sampler2D uSampler;uniform sampler2D blurSampler;uniform sampler2D blurSampler2;uniform float clampX;uniform float clampY;uniform float strength;vec3 F(vec3 G,vec3 H,float I){return clamp((2.*G+H-1.)*I+H*(1.-I),0.,1.);}void main(void){vec4 J=texture2D(uSampler,vTextureCoord);vec4 K=texture2D(blurSampler,vTextureCoord*vec2(clampX,clampY));vec4 L=texture2D(blurSampler2,vTextureCoord*vec2(clampX,clampY));vec3 M=C(J.rgb,L.rgb);vec3 N=vec3(A(M));M=F(N,K.rgb,0.75);M=mix(J.rgb,M,strength);gl_FragColor=vec4(M,J.a);}";var Cv="float A(vec3 B){return dot(B,vec3(0.299,0.587,0.114));}vec3 C(vec3 D,vec3 E){vec3 F=clamp(D-E,0.,1.);return clamp(D+F,0.,1.);}vec3 G(vec3 H,vec3 I){return max(H,I);}varying vec2 vTextureCoord;uniform sampler2D uSampler;uniform sampler2D blurSampler;uniform float clampX;uniform float clampY;vec3 J(vec3 K){vec3 L=1.-K;float M=min(min(L.r,L.g),L.b);float N=1./(1.-M);float O;O=(L.g-M)*N;O=float(1.-O);O=smoothstep(0.5,1.,O);return vec3(O);}void main(void){vec4 P=texture2D(uSampler,vTextureCoord);vec4 Q=texture2D(blurSampler,vTextureCoord*vec2(clampX,clampY));vec3 R=J(P.rgb);vec3 S=vec3(A(P.rgb));S=G(P.rgb,S);vec3 T=C(S,Q.rgb);P.rgb=mix(P.rgb,T,R);gl_FragColor=P;}";var Ev="varying vec2 vTextureCoord;uniform sampler2D uSampler;uniform sampler2D blurSampler;void main(void){vec4 A=texture2D(uSampler,vTextureCoord);float B=2.;float C=A.r-((A.g+A.b)/B);float D=0.25*A.r+0.6*A.g+0.15*A.b;float E=max(0.,((2.*C)-D));if(E<=0.05){E=0.;}A.r=A.r-E*(A.r-min(A.g,A.b));gl_FragColor=A;}";var Pv="vec3 A(vec3 B,sampler2D C,vec4 D,float E){float F=255./D.x;B.r=texture2D(C,vec2(B.r*F*E,0.)).r;B.g=texture2D(C,vec2(B.g*F*E,0.)).g;B.b=texture2D(C,vec2(B.b*F*E,0.)).b;return B;}float G(vec3 H){return dot(H,vec3(0.299,0.587,0.114));}vec3 I(vec3 J,vec3 K){return 1.-(1.-J)*(1.-K);}varying vec2 vTextureCoord;uniform sampler2D uSampler;uniform sampler2D blurSampler;uniform sampler2D curvesSampler;uniform float clampX;uniform vec4 filterArea;uniform vec3 color_palette;uniform float strength;void main(void){vec4 L=texture2D(uSampler,vTextureCoord);vec3 M=vec3(G(L.rgb));vec3 N=mix(M,color_palette,0.5);vec3 O=A(M,curvesSampler,filterArea,clampX);N=I(O,N);L.rgb=mix(L.rgb,N,strength);gl_FragColor=L;}";var Nv="float A(vec3 B){return dot(B,vec3(0.299,0.587,0.114));}vec3 C(vec3 D,vec3 E){vec3 F=clamp(D-E,0.,1.);return clamp(D+F,0.,1.);}vec3 G(vec3 H,vec3 I){return max(H,I);}varying vec2 vTextureCoord;uniform sampler2D uSampler;uniform sampler2D blurSampler;uniform float clampX;uniform float clampY;vec3 J(vec3 K){vec3 L=1.-K;float M=min(min(L.r,L.g),L.b);float N=1./(1.-M);float O;O=(L.g-M)*N;O=float(1.-O);O=smoothstep(0.5,1.,O);return vec3(O);}void main(void){vec4 P=texture2D(uSampler,vTextureCoord);vec4 Q=texture2D(blurSampler,vTextureCoord*vec2(clampX,clampY));vec3 R=J(P.rgb);vec3 S=vec3(A(P.rgb));S=G(P.rgb,S);vec3 T=C(S,Q.rgb);P.rgb=mix(P.rgb,T,R);gl_FragColor=P;}";var Mv="float A(vec3 B){return dot(B,vec3(0.299,0.587,0.114));}vec3 C(vec3 B){float D=A(B);float E=min(min(B.r,B.g),B.b);float F=max(max(B.r,B.g),B.b);if(E<0.){max((B-D)*D/(D-E)+D,0.);}if(F>1.){min((B-D)*(1.-D)/(F-D)+D,1.);}return B;}float G(vec3 B){return dot(B,vec3(0.299,0.587,0.114));}vec3 H(vec3 B,float D){float I=D-G(B);B=B+vec3(I);return C(B);}float J(vec3 B){return dot(B,vec3(0.299,0.587,0.114));}vec3 K(vec3 L,vec3 M){return H(M,J(L));}varying vec2 vTextureCoord;uniform sampler2D uSampler;uniform vec3 color_palette;uniform float strength;void main(void){vec4 N=texture2D(uSampler,vTextureCoord);vec3 O=K(N.rgb,color_palette);N.rgb=mix(N.rgb,O,strength);gl_FragColor=N;}";var Dv="vec3 A(vec3 B,vec3 C){return mix(2.*B*C,1.-2.*(1.-B)*(1.-C),step(0.5,C));}varying vec2 vTextureCoord;uniform sampler2D uSampler;uniform vec3 color_palette;uniform float strength;void main(void){vec4 D=texture2D(uSampler,vTextureCoord);vec3 E=A(color_palette,D.rgb);E=mix(D.rgb,E,0.5);D.rgb=mix(D.rgb,E,strength);gl_FragColor=D;}";var wv="vec3 A(vec3 B,vec3 C){return mix(2.*B*C,1.-2.*(1.-B)*(1.-C),step(0.5,C));}float D(vec3 E){return dot(E,vec3(0.299,0.587,0.114));}varying vec2 vTextureCoord;uniform sampler2D uSampler;uniform vec3 color_palette;uniform float strength;void main(void){vec4 F=texture2D(uSampler,vTextureCoord);vec3 G=vec3(D(F.rgb));G=A(color_palette,G);F.rgb=mix(F.rgb,G,strength);gl_FragColor=F;}";var kv="varying vec2 vTextureCoord;uniform sampler2D uSampler;uniform sampler2D blurSampler;uniform float clampX;uniform float clampY;uniform float strength;void main(void){vec4 A=texture2D(uSampler,vTextureCoord);vec4 B=texture2D(blurSampler,vTextureCoord*vec2(clampX,clampY));vec3 C=clamp(B.rgb-A.rgb,0.,1.);C=clamp(A.rgb-C,0.,1.);A.rgb=mix(A.rgb,C,strength);gl_FragColor=A;}";var Av="vec3 A(vec3 B,vec3 C,float D){mat3 E=mat3(0.299,0.587,0.114,-0.168736,-0.331264,0.5,0.5,-0.418688,-0.081312);vec3 F=B*E+vec3(0.,0.5,0.5);vec3 G=C*E+vec3(0.,0.5,0.5);vec3 H=F-G;float I=1.-sqrt(H.r*H.r/20.+H.g*H.g+H.b*H.b);vec3 J;J=vec3(smoothstep(D,1.,I));return vec3(J);}varying vec2 vTextureCoord;uniform sampler2D uSampler;uniform vec3 averageColor;uniform float strength;void main(void){vec4 K=texture2D(uSampler,vTextureCoord);vec4 L=K;float M=A(K.rgb,averageColor,0.40).r;vec3 N=K.rgb*(1.-M)+M*averageColor.rgb;K.rgb=min(N.rgb,K.rgb);K=mix(L,K,strength);gl_FragColor=K;}";var Ov="vec3 A(vec3 B,vec3 C,float D){mat3 E=mat3(0.299,0.587,0.114,-0.168736,-0.331264,0.5,0.5,-0.418688,-0.081312);vec3 F=B*E+vec3(0.,0.5,0.5);vec3 G=C*E+vec3(0.,0.5,0.5);vec3 H=F-G;float I=1.-sqrt(H.r*H.r/20.+H.g*H.g+H.b*H.b);vec3 J;J=vec3(smoothstep(D,1.,I));return vec3(J);}varying vec2 vTextureCoord;uniform sampler2D uSampler;uniform vec3 averageColor;uniform vec3 color_palette;uniform float strength;void main(void){vec4 K=texture2D(uSampler,vTextureCoord);vec3 L=mix(K.rgb,color_palette,strength*0.72);vec3 M=A(K.rgb,averageColor,0.85);K.rgb=mix(K.rgb,L,M);gl_FragColor=K;}";var Rv="vec3 A(vec3 B,vec3 C,float D){mat3 E=mat3(0.299,0.587,0.114,-0.168736,-0.331264,0.5,0.5,-0.418688,-0.081312);vec3 F=B*E+vec3(0.,0.5,0.5);vec3 G=C*E+vec3(0.,0.5,0.5);vec3 H=F-G;float I=1.-sqrt(H.r*H.r/20.+H.g*H.g+H.b*H.b);vec3 J;J=vec3(smoothstep(D,1.,I));return vec3(J);}vec3 K(vec3 L,vec3 M){return mix(2.*L*M,1.-2.*(1.-L)*(1.-M),step(0.5,M));}varying vec2 vTextureCoord;uniform sampler2D uSampler;uniform vec3 averageColor;uniform vec3 color_palette;uniform float strength;void main(void){vec4 N=texture2D(uSampler,vTextureCoord);vec3 O=K(N.rgb,color_palette);O=mix(N.rgb,O,strength*0.72);vec3 P=A(N.rgb,averageColor,0.85);N.rgb=mix(N.rgb,O,P);gl_FragColor=N;}";var Lv="float A(vec3 B){return dot(B,vec3(0.299,0.587,0.114));}float C(float D,float E){return E/(1.-D);}vec3 F(vec3 G,float H,float I){float J=G.r*0.309+G.g*0.609+G.b*0.082;float K=clamp(J-H,0.,1.)/clamp(abs(I-H),0.,1.);return vec3(clamp(vec3(K),0.,1.));}varying vec2 vTextureCoord;uniform sampler2D uSampler;uniform sampler2D blurSampler;uniform float clampX;uniform float clampY;uniform float strength;void main(void){vec4 L=texture2D(uSampler,vTextureCoord);vec4 M=texture2D(blurSampler,vTextureCoord*vec2(clampX,clampY));vec3 N=abs(L.rgb-M.rgb);float O=clamp(dot(N,vec3(0.3086,0.6094,0.0820)),0.,1.);O=smoothstep(0.,strength,O);N=mix(M.rgb,L.rgb,O);L.rgb=N;gl_FragColor=L;}";var Vv=class extends PIXI.Filter{constructor(e){let t=O,r=Lv;switch(e){case BFN.CONST.TOUCH_UP_PRESETS.bronzer:r=Rv;break;case BFN.CONST.TOUCH_UP_PRESETS.blush:r=Ov;break;case BFN.CONST.TOUCH_UP_PRESETS.flashspot:r=Av;break;case BFN.CONST.TOUCH_UP_PRESETS.mascara:r=kv;break;case BFN.CONST.TOUCH_UP_PRESETS.eye_color:r=Mv;break;case BFN.CONST.TOUCH_UP_PRESETS.eye_brighten:r=Nv;break;case BFN.CONST.TOUCH_UP_PRESETS.eyebrow_pencil:r=Pv;break;case BFN.CONST.TOUCH_UP_PRESETS.fix_redeye:r=Ev;break;case BFN.CONST.TOUCH_UP_PRESETS.lipstick:r=wv;break;case BFN.CONST.TOUCH_UP_PRESETS.teeth_whiten:r=Cv;break;case BFN.CONST.TOUCH_UP_PRESETS.haircolor:r=Dv;break;case BFN.CONST.TOUCH_UP_PRESETS.perfectskin:r=_v;break}super(t,r);this.padding=0,this.currentPreset=e}apply(e,t,r,a){var s=BFN.FilterHelper.calculateFilterClamp(t,r,this.blurSampler||null);this.uniforms.clampX=s.x,this.uniforms.clampY=s.y,e.applyFilter(this,t,r,a)}get averageColor(){return this.uniforms.averageColor}set averageColor(e){this.uniforms.averageColor=e}get color_palette(){return this.uniforms.color_palette}set color_palette(e){e=BFN.FilterHelper.hex2rgb(e),this.uniforms.color_palette=e}get strength(){return this.uniforms.strength}set strength(e){this.uniforms.strength=e}get blurSampler(){return this.uniforms.blurSampler}set blurSampler(e){e.baseTexture.isPowerOfTwo=!0,this.uniforms.blurSampler=e}get blurSampler2(){return this.uniforms.blurSampler2}set blurSampler2(e){e.baseTexture.isPowerOfTwo=!0,this.uniforms.blurSampler2=e}get curvesSampler(){return this.uniforms.curvesSampler}set curvesSampler(e){this.uniforms.curvesSampler=e}},Uv=Vv;var Gv="uniform sampler2D uSampler;varying vec2 vTextureCoord;void main(){vec4 A=texture2D(uSampler,vTextureCoord);A.rgb/=A.a;gl_FragColor=A;}";var Hv=class extends PIXI.Filter{constructor(){let e=O,t=Gv;super(e,t);this.padding=0}apply(e,t,r,a){e.applyFilter(this,t,r,a)}},Xv=Hv;var zv=`#define GLSLIFY 1 
vec3 A(vec3 B,vec3 C,float D){B.r=clamp(B.r+C.r,0.,1.);B.g=clamp(B.g+C.g,0.,1.);B.b=clamp(B.b+C.b,0.,1.);if(D==1.){B=vec3(dot(B,vec3(0.299,0.587,0.114)));}return B;}varying vec2 vTextureCoord;uniform sampler2D uSampler;uniform float red;uniform float green;uniform float blue;uniform float bw;void main(void){vec4 E=texture2D(uSampler,vTextureCoord);if(E.a==0.){gl_FragColor=vec4(0,0,0,0);return;}E.rgb/=E.a;E.rgb=A(E.rgb,vec3(red,green,blue),bw);E.rgb*=E.a;gl_FragColor=E;}`;var Wv=class extends PIXI.Shader{constructor(e){super(e,O,zv)}get red(){return this._red}set red(e){e=e/255,this._red=e}get green(){return this._green}set green(e){e=e/255,this._green=e}get blue(){return this._blue}set blue(e){e=e/255,this._blue=e}get bw(){return this._bw}set bw(e){this._bw=e}applyParams(e){this.uniforms.red=this.red,this.uniforms.green=this.green,this.uniforms.blue=this.blue,this.uniforms.bw=this.bw}},$v=Wv;var jv="vec3 A(vec3 B,vec3 C){float D=min(B.r,C.r);float E=min(B.g,C.g);float F=min(B.b,C.b);return vec3(D,E,F);}vec3 G(vec3 B,vec3 C){return 1.-(1.-B)*(1.-C);}varying vec2 vTextureCoord;uniform sampler2D uSampler;uniform sampler2D blurImage;uniform float lightness;uniform float clampX;uniform float clampY;void main(void){vec4 H=texture2D(uSampler,vTextureCoord);vec4 I=texture2D(blurImage,vTextureCoord*vec2(clampX,clampY));H.rgb=H.rgb/H.a;I.rgb=I.rgb/I.a;vec3 J=G(I.rgb,I.rgb);vec3 K=G(H.rgb,H.rgb);J=clamp(J*K,0.,1.);vec3 L=A(H.rgb,J);H.rgb=mix(J,L,1.-lightness);H.rgb=H.rgb*H.a;gl_FragColor=H;}";var Yv=class extends PIXI.Filter{constructor(){super(O,jv);this.padding=0,this.softness=1,this.lightness=1}apply(e,t,r){let a=BFN.FilterHelper.calculateFilterClamp(t,r,this.blurImage||null);this.uniforms.clampX=a.x,this.uniforms.clampY=a.y,e.applyFilter(this,t,r)}get softness(){return this.uniforms.softness}set softness(e){this.uniforms.hasOwnProperty("softness")&&(this.uniforms.softness=e)}get lightness(){return this.uniforms.lightness}set lightness(e){e=e/100,this.uniforms.hasOwnProperty("lightness")&&(this.uniforms.lightness=e)}get blurImage(){return this.uniforms.blurImage}set blurImage(e){e.baseTexture.isPowerOfTwo=!0,this.uniforms.blurImage=e}},qv=Yv;var Kv="vec3 A(vec3 B,vec3 C){float D=min(B.r,C.r);float E=min(B.g,C.g);float F=min(B.b,C.b);return vec3(D,E,F);}vec3 G(vec3 B,vec3 C){return mix(2.*B*C,1.-2.*(1.-B)*(1.-C),step(0.5,C));}vec3 H(vec3 B,vec3 C){return 1.-(1.-B)*(1.-C);}varying vec2 vTextureCoord;uniform sampler2D uSampler;uniform sampler2D blurImage;uniform float amount;uniform float clampX;uniform float clampY;void main(void){vec4 I=texture2D(uSampler,vTextureCoord);vec4 J=texture2D(blurImage,vTextureCoord*vec2(clampX,clampY));I.rgb=I.rgb/I.a;J.rgb=J.rgb/J.a;vec3 K=(I.rgb+0.5)-J.rgb;K=G(1.-K,I.rgb);I.rgb=mix(I.rgb,K,amount);I.rgb=I.rgb*I.a;gl_FragColor=I;}";var Jv=class extends PIXI.Filter{constructor(){super(O,Kv);this.padding=0,this.amount=1}apply(e,t,r){let a=BFN.FilterHelper.calculateFilterClamp(t,r,this.blurImage||null);this.uniforms.clampX=a.x,this.uniforms.clampY=a.y,e.applyFilter(this,t,r)}get amount(){return this.uniforms.amount}set amount(e){this.uniforms.amount=e}get blurImage(){return this.uniforms.blurImage}set blurImage(e){e.baseTexture.isPowerOfTwo=!0,this.uniforms.blurImage=e}},Qv=Jv;var Zv="varying vec2 vTextureCoord;uniform sampler2D uSampler;uniform sampler2D blurImage;uniform float size;uniform float shift_horizontal;uniform float shift_vertical;uniform float clampX;uniform float clampY;vec3 A(vec3 B,vec2 C,vec2 D,float E,vec2 F){vec2 G=(C*D)-vec2(F);;G=G*2.-1.;float H=sqrt(pow(abs(G.x),10.)+pow(abs(G.y),10.));H=smoothstep(0.,1.-E,H);return mix(B,vec3(1.),H);}void main(void){size;shift_horizontal;shift_vertical;vec4 I=texture2D(uSampler,vTextureCoord);vec4 J=texture2D(blurImage,vTextureCoord*vec2(clampX,clampY));I.rgb=I.rgb/I.a;J.rgb=J.rgb/J.a;vec3 K=A(vec3(0.),vTextureCoord,vec2(clampX,clampY),size,vec2(shift_horizontal,shift_vertical));I.rgb=mix(I.rgb,J.rgb,K);I.rgb=I.rgb*I.a;gl_FragColor=I;}";var ey=class extends PIXI.Filter{constructor(){super(O,Zv);this.padding=0}apply(e,t,r,a){let s=BFN.FilterHelper.calculateFilterClamp(t,r,this.blurImage||null);this.uniforms.clampX=s.x,this.uniforms.clampY=s.y,e.applyFilter(this,t,r,a)}get blurImage(){return this.uniforms.blurImage}set blurImage(e){e.baseTexture.isPowerOfTwo=!0,this.uniforms.blurImage=e}get size(){return this.uniforms.size}set size(e){e=e/101,this.uniforms.size=e}get shift_vertical(){return this.uniforms.shift_vertical}set shift_vertical(e){e=e/100,this.uniforms.shift_vertical=e}get shift_horizontal(){return this.uniforms.shift_horizontal}set shift_horizontal(e){e=e/100,this.uniforms.shift_horizontal=e}},ty=ey;var iy="vec3 A(vec3 B,float C,float D){float E=B.r*0.309+B.g*0.609+B.b*0.082;float F=clamp(E-C,0.,1.)/clamp(abs(D-C),0.,1.);return vec3(clamp(vec3(F),0.,1.));}vec3 G(vec3 H){vec4 I=vec4(0.,-1./3.,2./3.,-1.);vec4 J=mix(vec4(H.bg,I.wz),vec4(H.gb,I.xy),step(H.b,H.g));vec4 K=mix(vec4(J.xyw,H.r),vec4(H.r,J.yzx),step(J.x,H.r));float L=K.x-min(K.w,K.y);float M=1.0e-10;return vec3(abs(K.z+(K.w-K.y)/(6.*L+M)),L/(K.x+M),K.x);}vec3 N(vec3 H){vec4 I=vec4(1.,2./3.,1./3.,3.);vec3 J=abs(fract(H.xxx+I.xyz)*6.-I.www);return H.z*mix(I.xxx,clamp(J-I.xxx,0.,1.),H.y);}varying vec2 vTextureCoord;uniform sampler2D uSampler;uniform sampler2D blurSampler;uniform vec3 averageColor;uniform float clampX;uniform float clampY;vec3 O(vec3 P,vec3 Q,float R){vec3 S=G(P);float T=(S.z*2.)/(S.z+0.4);S.z=S.z+R*pow(abs(1.-(Q.z*1.4)),1.5)*(T-S.z);return N(S);}vec3 U(vec3 P,vec3 Q,float R){vec3 S=G(P);S.z=pow(S.z,R);return N(S);}void main(void){vec4 V=texture2D(uSampler,vTextureCoord);vec4 W=texture2D(blurSampler,vTextureCoord*vec2(clampX,clampY));vec3 X=A(vec3(V.rgb),averageColor.r,1.);vec3 Y;if(averageColor.r<0.5){float Z=min(1.,((0.5-averageColor.r)*2.5));Y=O(V.rgb,W.rgb,Z);}else{float Z=(log(0.5)/log(averageColor.r));Y=U(V.rgb,W.rgb,Z);}V.rgb=mix(Y,V.rgb,X.r);gl_FragColor=V;}";var ry=class extends PIXI.Filter{constructor(){super(O,iy);this.padding=0}apply(e,t,r,a){let s=BFN.FilterHelper.calculateFilterClamp(t,r,this.blurSampler||null);this.uniforms.clampX=s.x,this.uniforms.clampY=s.y,e.applyFilter(this,t,r,a)}get blurSampler(){return this.uniforms.blurSampler}set blurSampler(e){e.baseTexture.isPowerOfTwo=!0,this.uniforms.blurSampler=e}get averageColor(){return this.uniforms.averageColor}set averageColor(e){this.uniforms.averageColor=e}get amount(){return this.uniforms.amount}set amount(e){e=BFN.FilterHelper.normalize(e,0,100),this.uniforms.amount=e}},ay=ry;var sy="varying vec2 vTextureCoord;uniform sampler2D uSampler;uniform vec3 color;uniform float intensity;uniform float alpha;uniform vec4 filterClamp;uniform float ignoreTransparency;uniform float binaryTransparency;void main(){vec4 A=texture2D(uSampler,clamp(vTextureCoord,filterClamp.xy,filterClamp.zw));if(ignoreTransparency==1.){if(A.a==0.){gl_FragColor=vec4((color*intensity*alpha),(intensity*alpha));return;}A.rgb/=A.a;float B=A.a;A.rgb=mix(A.rgb,color.rgb,(1.-A.a));A.a=1.;A.rgb=mix(A.rgb,color.rgb,intensity);A.a=mix(B,1.,intensity);A.rgb*=A.a;}else{if(A.a==0.){gl_FragColor=vec4(0,0,0,0);return;}A.rgb/=A.a;if(binaryTransparency==1.){A.a=1.;}float C=(1.-intensity);A.r=clamp(((A.r*C)+(color.r*intensity)),0.,1.);A.g=clamp(((A.g*C)+(color.g*intensity)),0.,1.);A.b=clamp(((A.b*C)+(color.b*intensity)),0.,1.);A.rgb*=A.a;}A.rgba*=alpha;gl_FragColor=A;}";var oy=class extends PIXI.Filter{constructor(){super(O,sy);this.padding=0,this.color=16777215,this.intensity=1,this.alpha=1,this.ignoreTransparency=!1,this.binaryTransparency=!1}apply(e,t,r,a){e.applyFilter(this,t,r,a)}get color(){return this._color}set color(e){this._color=Math.max(0,Math.min(16777215,e)),this.uniforms.color=BFN.FilterHelper.hex2rgbFactor(this.color)}get intensity(){return this._intensity}set intensity(e){this._intensity=e,this.uniforms.intensity=Math.max(0,Math.min(1,this.intensity))}get alpha(){return this._alpha}set alpha(e){this._alpha=e,this.uniforms.alpha=Math.max(0,Math.min(1,this.alpha))}get ignoreTransparency(){return this._ignoreTransparency}set ignoreTransparency(e){this._ignoreTransparency=e,this.uniforms.ignoreTransparency=this.ignoreTransparency?1:0}get binaryTransparency(){return this._binaryTransparency}set binaryTransparency(e){this._binaryTransparency=e,this.uniforms.binaryTransparency=this.binaryTransparency?1:0}},ny=oy;var ly="varying vec2 vTextureCoord;uniform sampler2D uSampler;uniform float redOffset;uniform float greenOffset;uniform float blueOffset;void main(){lowp vec4 A=texture2D(uSampler,vTextureCoord);if(A.a==0.){gl_FragColor=vec4(0,0,0,0);return;}A.rgb/=A.a;A.r=clamp((A.r+redOffset),0.,1.);A.g=clamp((A.g+greenOffset),0.,1.);A.b=clamp((A.b+blueOffset),0.,1.);A.rgb*=A.a;gl_FragColor=A;}";var cy=class extends PIXI.Filter{constructor(){super(O,ly);this.padding=0,this.resolution=1,this.redOffset=0,this.greenOffset=0,this.blueOffset=0}apply(e,t,r,a){e.applyFilter(this,t,r,a)}get redOffset(){return this._redOffset}set redOffset(e){this._redOffset=Math.max(-1,Math.min(1,e)),this.uniforms.redOffset=this.redOffset}get greenOffset(){return this._greenOffset}set greenOffset(e){this._greenOffset=Math.max(-1,Math.min(1,e)),this.uniforms.greenOffset=this.greenOffset}get blueOffset(){return this._blueOffset}set blueOffset(e){this._blueOffset=Math.max(-1,Math.min(1,e)),this.uniforms.blueOffset=this.blueOffset}},hy=cy;var uy="float A(vec3 B,vec3 C){const float D=0.045;const float E=0.015;const float F=1.;const float G=0.5;const float H=0.5;float I=sqrt(B.y*B.y+B.z*B.z);float J=sqrt(C.y*C.y+C.z*C.z);float K=B.y-C.y;float L=B.z-C.z;float M=I-J;float N=K*K+L*L-M*M;float O=(N>0.)?sqrt(N):0.;float P=B.x-C.x;float Q=1.;float R=1.+D*I;float S=1.+E*I;float T=P/(F*Q);float U=M/(G*R);float V=O/(H*S);return sqrt(T*T+U*U+V*V);}vec3 W(vec3 X){vec3 Y=X/vec3(95.047,100,108.883);vec3 Z;Z.x=(Y.x>0.008856)?pow(Y.x,1./3.):(7.787*Y.x)+(16./116.);Z.y=(Y.y>0.008856)?pow(Y.y,1./3.):(7.787*Y.y)+(16./116.);Z.z=(Y.z>0.008856)?pow(Y.z,1./3.):(7.787*Y.z)+(16./116.);return vec3((116.*Z.y)-16.,500.*(Z.x-Z.y),200.*(Z.y-Z.z));}vec3 a(vec3 X){vec3 b;b.x=(X.r>0.04045)?pow((X.r+0.055)/1.055,2.4):X.r/12.92;b.y=(X.g>0.04045)?pow((X.g+0.055)/1.055,2.4):X.g/12.92,b.z=(X.b>0.04045)?pow((X.b+0.055)/1.055,2.4):X.b/12.92;return 100.*b*mat3(0.4124,0.3576,0.1805,0.2126,0.7152,0.0722,0.0193,0.1192,0.9505);}vec3 c(vec3 X){vec3 d=W(a(X));return vec3(d.x/100.,0.5+0.5*(d.y/127.),0.5+0.5*(d.z/127.));}float e(vec3 X){return dot(X,vec3(0.299,0.587,0.114));}vec3 f(vec3 X){float g=e(X);float Y=min(min(X.r,X.g),X.b);float h=max(max(X.r,X.g),X.b);if(Y<0.){max((X-g)*g/(g-Y)+g,0.);}if(h>1.){min((X-g)*(1.-g)/(h-g)+g,1.);}return X;}float i(vec3 X){return dot(X,vec3(0.299,0.587,0.114));}vec3 j(vec3 X,float g){float k=g-i(X);X=X+vec3(k);return f(X);}float l(vec3 X){return dot(X,vec3(0.299,0.587,0.114));}vec3 m(vec3 n,vec3 o){return vec3(j(n.rgb,l(o.rgb)));}varying vec2 vTextureCoord;uniform sampler2D uSampler;uniform vec3 sourceColor;uniform vec3 targetColor;uniform float targetAlpha;uniform float preserveLuminosity;uniform float tolerance;void main(void){vec4 p=texture2D(uSampler,vTextureCoord);vec4 q=vec4(vec3(targetColor*targetAlpha),targetAlpha);vec4 r=(p.a==0.)?q:p;if(sourceColor.r!=-1.){vec3 s=c(sourceColor);vec3 t=c(targetColor);vec3 u=c(p.rgb);float v=A(u,s);v=smoothstep(0.,tolerance,v);if(preserveLuminosity==1.){q.rgb=m(q.rgb,p.rgb);q=vec4(vec3(q*targetAlpha),targetAlpha);}r=(p.a==0.)?vec4(0.):mix(q,p,v);}gl_FragColor=r;}";var dy=class extends PIXI.Shader{constructor(e){super(e,O,uy)}get sourceColor(){return this._sourceColor}set sourceColor(e){e==-1?e=[-1,-1,-1]:e=BFN.FilterHelper.hex2rgb(e),this._sourceColor=e}get targetColor(){return this._targetColor}set targetColor(e){e=BFN.FilterHelper.hex2rgb(e),this._targetColor=e}get targetAlpha(){return this._targetAlpha}set targetAlpha(e){e=Math.max(0,Math.min(1,e)),this._targetAlpha=e}get tolerance(){return this._tolerance}set tolerance(e){this._tolerance=e}get preserveLuminosity(){return this._preserveLuminosity}set preserveLuminosity(e){this._preserveLuminosity=e}applyParams(e){this.uniforms.sourceColor=this.sourceColor,this.uniforms.targetColor=this.targetColor,this.uniforms.targetAlpha=this.targetAlpha,this.uniforms.tolerance=this.tolerance,this.uniforms.preserveLuminosity=this.preserveLuminosity}},my=dy;var py="varying vec2 vTextureCoord;uniform sampler2D uSampler;uniform float mode;uniform float beta;uniform float pressure;uniform float vTextureCoordMax;void main(){vec4 A=texture2D(uSampler,vTextureCoord);float B=(vTextureCoordMax/2.);float C=(B-vTextureCoord.x);float D=(B-vTextureCoord.y);float E=sqrt((C*C)+(D*D));float F=max(0.,(1.-(E/B)));pressure;float G=(pressure*F);float H=0.;float I=0.;if(mode==0.){G*=.1;H=-(cos(beta));I=-(sin(beta));}else if(mode==1.){G*=0.25;H=(((1.-(vTextureCoord.x/vTextureCoordMax))*2.)-1.);I=(((1.-(vTextureCoord.y/vTextureCoordMax))*2.)-1.);}else if(mode==2.){G*=0.25;H=(((vTextureCoord.x/vTextureCoordMax)*2.)-1.);I=(((vTextureCoord.y/vTextureCoordMax)*2.)-1.);}else if(mode==3.){G*=0.25;H=(0.5-A.g);I=(0.5-A.b);}if(mode!=3.){float J=clamp((A.g+H),0.,1.);float K=clamp((A.b+I),0.,1.);float L=abs(J-A.g);float M=abs(K-A.b);H*=L;I*=M;}H*=G;I*=G;A.g=clamp((A.g+H),0.,1.);A.b=clamp((A.b+I),0.,1.);gl_FragColor=A;}";var fy=class extends PIXI.Filter{constructor(){super(O,py);this.padding=0,this.resolution=1,this.modes=["smudge","grow","shrink","erase"],this.mode="smudge",this.beta=0,this.pressure=1,this.vTextureCoordMax=1}apply(e,t,r,a){e.applyFilter(this,t,r,a)}get mode(){return this._mode}set mode(e){this.modes.indexOf(e)!=-1&&(this._mode=e,this.uniforms.mode=this.modes.indexOf(e))}get beta(){return this._beta}set beta(e){this._beta=e,this.uniforms.beta=this.beta}get pressure(){return this._pressure}set pressure(e){this._pressure=Math.max(0,Math.min(1,e)),this.uniforms.pressure=this.pressure}get vTextureCoordMax(){return this._vTextureCoordMax}set vTextureCoordMax(e){this._vTextureCoordMax=Math.max(0,Math.min(1,e)),this.uniforms.vTextureCoordMax=this.vTextureCoordMax}},gy=fy;var vy="varying vec2 vTextureCoord;uniform sampler2D uSampler;uniform sampler2D iChannel1;uniform float strength;uniform float maxDisplacementX;uniform float maxDisplacementY;uniform float vTextureCoordMinX;uniform float vTextureCoordMinY;uniform float vTextureCoordMaxX;uniform float vTextureCoordMaxY;uniform vec4 filterArea;void main(void){vec2 A=vec2(((vTextureCoord.x/vTextureCoordMaxX)+vTextureCoordMinX),((vTextureCoord.y/vTextureCoordMaxY)+vTextureCoordMinY));vec4 B=texture2D(iChannel1,A);float C=(((B.g-0.5)*2.)*strength);float D=(((B.b-0.5)*2.)*strength);float E=(maxDisplacementX*C);float F=(maxDisplacementY*D);vec2 G=2./filterArea.xy;vec2 H=clamp(vec2(vTextureCoord.x+E,vTextureCoord.y+F),G,vec2(vTextureCoordMaxX,vTextureCoordMaxY)*(1.-G));vec4 I=texture2D(uSampler,H);gl_FragColor=I;}";var yy=class extends PIXI.Filter{constructor(){super(O,vy);this.padding=0,this.resolution=1,this.isDisplay=!1,this.inputScale=1,this.inputSprite=null,this.strength=1}apply(e,t,r,a){if(e.applyFilter(this,t,r,a),this.inputSprite&&this.iChannel1)try{let o=this._inputSprite.texture.width*(this._isDisplay?this._inputScale:1),n=this._inputSprite.texture.height*(this._isDisplay?this._inputScale:1);this._mapW=this._isDisplay?t.size.width:BFN.FilterHelper.getNextPowerOfTwo(o),this._mapH=this._isDisplay?t.size.height:BFN.FilterHelper.getNextPowerOfTwo(n);let l=this._inputSprite.getGlobalPosition();this.uniforms.vTextureCoordMinX=this._isDisplay?Math.abs(Math.min(0,l.x))/o:0,this.uniforms.vTextureCoordMinY=this._isDisplay?Math.abs(Math.min(0,l.y))/n:0,this.uniforms.vTextureCoordMaxX=o/this._mapW,this.uniforms.vTextureCoordMaxY=n/this._mapH;var s=Math.round(Math.min(o,n)/16);this.uniforms.maxDisplacementX=s/this._mapW,this.uniforms.maxDisplacementY=s/this._mapH,e.applyFilter(this,t,r,a)}catch(o){}}get isDisplay(){return this._isDisplay}set isDisplay(e){this._isDisplay=e}get inputScale(){return this._inputScale}set inputScale(e){this._inputScale=e}get inputSprite(){return this._inputSprite}set inputSprite(e){this._inputSprite=e}get strength(){return this.uniforms.strength}set strength(e){this.uniforms.strength=Math.max(0,Math.min(1,e))}get iChannel1(){return this.uniforms.iChannel1}set iChannel1(e){this.uniforms.iChannel1=e}},xy=yy;var Ty="varying vec2 vTextureCoord;uniform sampler2D uSampler;uniform float mode;uniform vec3 color;float A(vec3 B){return sqrt((B.r*B.r*0.241)+(B.g*B.g*0.691)+(B.b*B.b*0.068));}void main(){vec4 C=texture2D(uSampler,vTextureCoord);if(C.a==0.){gl_FragColor=vec4(0,0,0,0);return;}float D=A(vec3(color.r,color.g,color.b));float E=A(vec3(C.r,C.g,C.b));if((mode==0.&&E<D)||(mode==1.&&E>D)){C.r=color.r;C.g=color.g;C.b=color.b;}gl_FragColor=C;}";var Fy=class extends PIXI.Filter{constructor(){super(O,Ty);this.padding=0,this.resolution=1,this.modes=["darks","lights"],this.mode="darks",this.color=0}apply(e,t,r,a){e.applyFilter(this,t,r,a)}get color(){return this._color}set color(e){this._color=e,this.uniforms.color=BFN.Util.hex2rgbVec3(this._color)}get mode(){return this._mode}set mode(e){this.modes.indexOf(e)!=-1&&(this._mode=e,this.uniforms.mode=this.modes.indexOf(e))}},by=Fy;var By="varying vec2 vTextureCoord;uniform sampler2D uSampler;uniform sampler2D iChannel1;uniform float vTextureCoordMinX;uniform float vTextureCoordMinY;uniform float vTextureCoordMaxX;uniform float vTextureCoordMaxY;uniform float inverse;void main(void){vec2 A=vec2(((vTextureCoord.x/vTextureCoordMaxX)+vTextureCoordMinX),((vTextureCoord.y/vTextureCoordMaxY)+vTextureCoordMinY));vec4 B=texture2D(iChannel1,A);vec4 C=texture2D(uSampler,vTextureCoord);C.rgb/=C.a;C.a=(inverse==1.)?((1.-B.a)*C.a):(B.a*C.a);C.rgb*=C.a;gl_FragColor=C;}";var Sy=class extends PIXI.Filter{constructor(){super(O,By);this.padding=0,this.resolution=1,this.inverse=!1,this.isDisplay=!1,this.inputScale=1,this.inputSprite=null,this.inputTexture=null}apply(e,t,r,a){if(this._inputSprite&&this._iChannel1)try{let s=this._inputSprite.texture.width*(this._isDisplay?this._inputScale:1),o=this._inputSprite.texture.height*(this._isDisplay?this._inputScale:1);this._mapW=this._isDisplay?t.size.width:BFN.FilterHelper.getNextPowerOfTwo(s),this._mapH=this._isDisplay?t.size.height:BFN.FilterHelper.getNextPowerOfTwo(o);let n=this._inputSprite.getGlobalPosition();this.uniforms.vTextureCoordMinX=this._isDisplay?Math.abs(Math.min(0,n.x))/s:0,this.uniforms.vTextureCoordMinY=this._isDisplay?Math.abs(Math.min(0,n.y))/o:0,this.uniforms.vTextureCoordMaxX=s/this._mapW,this.uniforms.vTextureCoordMaxY=o/this._mapH,e.applyFilter(this,t,r,a)}catch(s){}}get inverse(){return this._inverse}set inverse(e){this._inverse=e,this.uniforms.inverse=e?1:0}get isDisplay(){return this._isDisplay}set isDisplay(e){this._isDisplay=e}get inputScale(){return this._inputScale}set inputScale(e){this._inputScale=e}get inputSprite(){return this._inputSprite}set inputSprite(e){this._inputSprite=e}get iChannel1(){return this._iChannel1}set iChannel1(e){this._iChannel1=e,this.uniforms.iChannel1=e}},Iy=Sy;var _y="varying vec2 vTextureCoord;uniform sampler2D uSampler;uniform sampler2D blendTexture;uniform sampler2D maskTexture;uniform float vTextureCoordMaxX;uniform float vTextureCoordMaxY;uniform float inverse;uniform float unmaskedAlpha;uniform vec4 blendColor;uniform float blendIntensity;uniform float useBlendColor;uniform float useBlendTexture;uniform float useMaskTexture;uniform float useInputAlpha;vec4 A(vec4 B,vec4 C){return vec4((B.rgb+(C.rgb*(1.-B.a))),(B.a+(C.a*(1.-B.a))));}void main(void){vec4 D=texture2D(uSampler,vTextureCoord);vec4 E=D;if(useBlendColor==1.||useBlendTexture==1.){vec2 F=vec2((vTextureCoord.x/vTextureCoordMaxX),(vTextureCoord.y/vTextureCoordMaxY));vec4 G=(mix(D,((useBlendColor==1.)?blendColor:texture2D(blendTexture,F)),blendIntensity)*unmaskedAlpha);if(useMaskTexture==1.){vec4 H=texture2D(maskTexture,F);E=mix(((useInputAlpha==1.)?A(D,G):D),G,((inverse==1.)?H.a:(1.-H.a)));}else{E=((inverse==1.)?((useInputAlpha==1.)?A(D,G):D):G);}}gl_FragColor=E;}";var Cy=class extends PIXI.Filter{constructor(){super(O,_y);this.padding=0,this.resolution=1,this.inverse=!1,this.unmaskedAlpha=1,this.blendColor=null,this.blendIntensity=1,this.blendTexture=null,this.maskTexture=null,this.useInputAlpha=!1}apply(e,t,r,a){let s=t.sourceFrame.width,o=t.sourceFrame.height,n=BFN.FilterHelper.getNextPowerOfTwo(s),l=BFN.FilterHelper.getNextPowerOfTwo(o);this.uniforms.vTextureCoordMaxX=s/n,this.uniforms.vTextureCoordMaxY=o/l,e.applyFilter(this,t,r,a)}get inverse(){return this._inverse}set inverse(e){this._inverse=e,this.uniforms.inverse=e?1:0}get unmaskedAlpha(){return this._unmaskedAlpha}set unmaskedAlpha(e){this._unmaskedAlpha=Math.max(0,Math.min(1,e)),this.uniforms.unmaskedAlpha=e}get blendColor(){return this._blendColor}set blendColor(e){this._blendColor=e,this.uniforms.blendColor=e===null?[0,0,0,0]:[...typeof e=="string"&&e.length===6?BFN.FilterHelper.hex2rgb(e):[0,0,0],1],this.uniforms.useBlendColor=e===null?0:1}get blendIntensity(){return this._blendIntensity}set blendIntensity(e){this._blendIntensity=Math.max(0,Math.min(1,e)),this.uniforms.blendIntensity=e}get blendTexture(){return this._blendTexture}set blendTexture(e){this._blendTexture=e||PIXI.Texture.EMPTY,this.uniforms.blendTexture=this._blendTexture,this.uniforms.useBlendTexture=e?1:0}get maskTexture(){return this._maskTexture}set maskTexture(e){this._maskTexture=e||PIXI.Texture.EMPTY,this.uniforms.maskTexture=this._maskTexture,this.uniforms.useMaskTexture=e?1:0}get useInputAlpha(){return!!this.uniforms.useInputAlpha}set useInputAlpha(e){this.uniforms.useInputAlpha=e?1:0}},Ey=Cy;var Py="varying vec2 vTextureCoord;uniform sampler2D uSampler;uniform vec4 filterArea;uniform int quality;uniform float intensity;uniform float size;uniform vec3 color;vec2 A(vec2 B,vec4 C){B*=C.xy;B+=C.zw;return B;}vec2 D(vec2 B,vec4 C){B-=C.zw;B/=C.xy;return B;}const float E=3.141592653589793;const float F=1.618033988749895;const float G=(E*2.);const float H=(G/F);const int I=16;const int J=32;const int K=48;const int L=64;const int M=80;const int N=96;const int O=112;const int P=128;float Q(vec2 R,int S,int T,int U){float V=(float(S)/float(T-1));float W=(H*float(S));float distance=(size*V);vec2 X=vec2((R.x+(cos(W)*distance)),(R.y+(sin(W)*distance)));vec4 Y=texture2D(uSampler,clamp(D(X,filterArea),0.,1.));float Z=(float(T-S)/float(U));float a=(Z*Y.a);return a;}float b(vec2 R){int U=0;for(int S=1;S<=I;S++){U+=S;}float a=0.;for(int S=0;S<I;S++){a+=Q(R,S,I,U);}return a;}float c(vec2 R){int U=0;for(int S=1;S<=J;S++){U+=S;}float a=0.;for(int S=0;S<J;S++){a+=Q(R,S,J,U);}return a;}float d(vec2 R){int U=0;for(int S=1;S<=K;S++){U+=S;}float a=0.;for(int S=0;S<K;S++){a+=Q(R,S,K,U);}return a;}float e(vec2 R){int U=0;for(int S=1;S<=L;S++){U+=S;}float a=0.;for(int S=0;S<L;S++){a+=Q(R,S,L,U);}return a;}float f(vec2 R){int U=0;for(int S=1;S<=M;S++){U+=S;}float a=0.;for(int S=0;S<M;S++){a+=Q(R,S,M,U);}return a;}float g(vec2 R){int U=0;for(int S=1;S<=N;S++){U+=S;}float a=0.;for(int S=0;S<N;S++){a+=Q(R,S,N,U);}return a;}float h(vec2 R){int U=0;for(int S=1;S<=O;S++){U+=S;}float a=0.;for(int S=0;S<O;S++){a+=Q(R,S,O,U);}return a;}float i(vec2 R){int U=0;for(int S=1;S<=P;S++){U+=S;}float a=0.;for(int S=0;S<P;S++){a+=Q(R,S,P,U);}return a;}void main(void){vec2 R=A(vTextureCoord,filterArea);vec4 j=texture2D(uSampler,clamp(D(R,filterArea),0.,1.));float a=0.;if(quality==1){a=b(R);}else if(quality==2){a=c(R);}else if(quality==3){a=d(R);}else if(quality==4){a=e(R);}else if(quality==5){a=f(R);}else if(quality==6){a=g(R);}else if(quality==7){a=h(R);}else if(quality==8){a=i(R);}a=(clamp((a*(0.5+(intensity*2.))),0.,1.)*(1.-j.a));gl_FragColor=vec4(mix(j.rgb,color,a),max(a,j.a));}";var Ny=class extends PIXI.Filter{constructor(){super(O,Py);this.padding=0,this.quality=4,this.intensity=.5,this.size=20,this.color="FFFFFF"}apply(e,t,r,a){let s=e.getRenderTarget(!0);this.plainFilter||(this.plainFilter=new BFN.filters.PlainFilter),e.applyFilter(this.plainFilter,t,s,!0),e.applyFilter(this,s,r,a),e.returnRenderTarget(s)}get quality(){return this.uniforms.quality}set quality(e){this.uniforms.quality=Math.floor(Math.max(1,Math.min(8,e)))}get intensity(){return this.uniforms.intensity}set intensity(e){this.uniforms.intensity=Math.max(0,Math.min(1,e))}get size(){return this.uniforms.size}set size(e){this.uniforms.size=Math.max(0,e)}get color(){return this.uniforms.color}set color(e){this.uniforms.color=BFN.FilterHelper.hex2rgbFactor(e)}},My=Ny;var Dy="varying vec2 vTextureCoord;uniform sampler2D uSampler;uniform float minInput;uniform float maxInput;uniform float saturation;uniform vec3 tint;vec3 A(vec3 B,float C){return pow(B,1./vec3(C));}vec3 D(vec3 B,float minInput,float maxInput){return min(max(B-minInput,0.)/(maxInput-minInput+0.0001),1.);}vec3 E(vec3 B,float minInput,float C,float maxInput){return A(D(B,minInput,maxInput),C);}vec3 F(vec3 B,float G,float H){return mix(vec3(G),vec3(H),B);}vec3 I(vec3 B,float minInput,float C,float maxInput,float G,float H){return F(E(B,minInput,C,maxInput),G,H);}vec3 J(vec3 K,float L){float M=(K.r+K.g+K.b)/3.;if(L>0.){K.rgb+=(M-K.rgb)*(1.-1./(1.001-L/2.));}else{K.rgb+=(M-K.rgb)*(-L);}return K;}void main(void){vec4 N=texture2D(uSampler,vTextureCoord);vec3 O=I(N.rgb,minInput,1.,maxInput,0.,1.);float P=((tint.r==-1.)?saturation:-1.);O=J(O,P);vec3 Q=((tint.r==-1.)?vec3(1.):J(tint,saturation));O*=Q;gl_FragColor=vec4(O,N.a);}";var wy=class extends PIXI.Filter{constructor(){super(O,Dy);this.padding=0,this.minInput=.8,this.maxInput=.85,this.saturation=-.5,this.tint=-1}get minInput(){return this.uniforms.minInput}set minInput(e){this.uniforms.minInput=Math.max(0,Math.min(1,e))}get maxInput(){return this.uniforms.maxInput}set maxInput(e){this.uniforms.maxInput=Math.max(0,Math.min(1,e))}get saturation(){return this.uniforms.saturation}set saturation(e){this.uniforms.saturation=Math.max(-1,Math.min(1,e))}get tint(){return this.uniforms.tint}set tint(e){e==-1?e=[-1,-1,-1]:e=BFN.FilterHelper.hex2rgb(e),this.uniforms.tint=e}},ky=wy;var Ay="varying vec2 vTextureCoord;uniform sampler2D uSampler;void main(void){vec4 A=texture2D(uSampler,vTextureCoord);float B=max(A.r,max(A.g,A.b));vec4 C=mix(vec4(0.),A,B);gl_FragColor=C;}";var Oy=class extends PIXI.Filter{constructor(){super(O,Ay);this.padding=0}},Ry=Oy;var Ly=`precision highp float;
#define GLSLIFY 1
uniform sampler2D uSampler;varying vec2 vTextureCoord;uniform bool monochromatic;uniform int distribution;uniform float intensity;uniform float seed;const float A=0.546372819564738291;float B(vec2 C){return fract(sin(dot(C.xy,vec2(12.9898,78.233)))*43758.5453);}float D(vec2 C){float E=fract((seed/100.)+A);float F=B(C+0.07*E);return F;}float G(vec2 C){float E=fract((seed/100.)+A);float F=B(C+0.07*E);float H=B(C+0.11*E);return(F+H)/2.;}float I(vec2 C){float E=fract((seed/100.)+A);float F=B(C+0.07*E);float H=B(C+0.11*E);float J=B(C+0.13*E);return(F+H+J)/3.;}float K(vec2 C){float E=fract((seed/100.)+A);float F=B(C+0.07*E);float H=B(C+0.11*E);float J=B(C+0.13*E);float L=B(C+0.17*E);return(F+H+J+L)/4.;}float M(vec2 C){float E=fract((seed/100.)+A);float F=B(C+0.07*E);float H=B(C+0.11*E);float J=B(C+0.13*E);float L=B(C+0.17*E);float N=B(C+0.19*E);float O=B(C+0.23*E);float P=B(C+0.29*E);float Q=B(C+0.31*E);return(F+H+J+L+N+O+P+Q)/8.;}float R(vec2 C){float F=B(C+0.07*fract((seed/100.)+A));float H=B(C+0.11*fract((seed/100.)+A+0.573953));return 0.23*sqrt(-log(F+0.00001))*cos(2.*3.141592*H)+0.5;}vec4 S(vec2 T){float U;if(distribution==1){U=D(T);}else if(distribution==2){U=G(T);}else if(distribution==3){U=K(T);}else if(distribution==4){U=M(T);}else if(distribution==5){U=R(T);}float V=B(T);float W=fract((seed*0.166)+V);float X=0.8;vec3 Y;if(monochromatic){Y=vec3(W);}else if(W<0.166){Y=vec3(X,0.,0.);}else if(W<0.332){Y=vec3(X,X,0.);}else if(W<0.498){Y=vec3(0.,X,0.);}else if(W<0.664){Y=vec3(0.,X,X);}else if(W<0.830){Y=vec3(0.,0.,X);}else{Y=vec3(X,0.,X);}Y=clamp((Y*U*(1.+(((intensity*0.25)+0.75)*2.))),0.,1.);return vec4(Y,1.);}void main(void){vec4 Z=texture2D(uSampler,vTextureCoord);if(Z.a==0.){gl_FragColor=vec4(0,0,0,0);return;}Z.rgb/=Z.a;vec2 a=vec2(mod((vTextureCoord.x+Z.r+Z.g),1.),mod((vTextureCoord.y+Z.g+Z.b),1.));vec4 Y=S(a);Z.rgb=clamp(mix(Z.rgb,Y.rgb,intensity),0.,1.)*Z.a;gl_FragColor=Z;}`;var Vy=class extends PIXI.Filter{constructor(){super(O,Ly);this.padding=0,this.intensity=.1,this.distribution=4,this.monochromatic=!1,this.seed=1}get intensity(){return this.uniforms.intensity}set intensity(e){this.uniforms.intensity=Math.max(0,Math.min(1,e))}get distribution(){return this.uniforms.distribution}set distribution(e){this.uniforms.distribution=Math.round(Math.max(0,Math.min(5,e)))}get seed(){return this.uniforms.seed}set seed(e){this.uniforms.seed=Math.round(Math.max(0,e))}get monochromatic(){return this.uniforms.monochromatic}set monochromatic(e){this.uniforms.monochromatic=!!e}},Uy=Vy;var Gy="uniform sampler2D uSampler;varying vec2 vTextureCoord;uniform vec4 filterArea;uniform vec3 lineColor;uniform float opacity;uniform float spacing;uniform bool invert;void main(void){vec4 A=texture2D(uSampler,vTextureCoord);if(A.a==0.){gl_FragColor=vec4(0,0,0,0);return;}A.rgb/=A.a;float B=floor(vTextureCoord.y*filterArea.y);bool C=(mod((floor(B/spacing)+(invert?1.:0.)),2.)==0.);if(C){vec4 D=vec4(lineColor,1.);A=mix(A,D,opacity);}gl_FragColor=vec4(A.rgb*A.a,A.a);}";var Hy=class extends PIXI.Filter{constructor(){super(O,Gy);this.padding=0,this.lineColor="000000",this.opacity=.5,this.spacing=2}get lineColor(){return this.uniforms.lineColor}set lineColor(e){e=BFN.FilterHelper.hex2rgb(e),this.uniforms.lineColor=e}get opacity(){return this.uniforms.opacity}set opacity(e){this.uniforms.opacity=Math.max(0,Math.min(1,e))}get spacing(){return this.uniforms.spacing}set spacing(e){this.uniforms.spacing=Math.max(0,e)}get invert(){return this.uniforms.invert}set invert(e){this.uniforms.invert=!!e}},Xy=Hy;var zy="float A(vec3 B){return dot(B,vec3(0.299,0.587,0.114));}uniform sampler2D uSampler;varying vec2 vTextureCoord;uniform vec2 pixelDimensions;uniform vec2 scaleDimensions;uniform vec3 averageColor;uniform float pass;const float C=3.14159265358979323846264;const float D=(C*2.);vec2 E(vec2 F){return clamp(((F/scaleDimensions)*pixelDimensions),vec2(0.),(pixelDimensions-1.));}vec2 G(vec2 H){return((clamp(H,vec2(0.),(pixelDimensions-1.))/pixelDimensions)*scaleDimensions);}void main(void){float I=A(averageColor);vec2 J=vec2(0.,1.);vec2 H=E(vTextureCoord);vec4 K=texture2D(uSampler,G(H));float L=A(K.rgb);if(pass==0.){if(L>I){K=vec4(1.);}else{K=vec4(vec3(I),1.);}}else if(pass==2.){vec2 M=(H-J);vec4 N=texture2D(uSampler,G(M));float O=A(N.rgb);vec2 P=(H+J);vec4 Q=texture2D(uSampler,G(P));float R=A(Q.rgb);if(O==1.&&R==1.){K.rgb=vec3(I);}}else{vec2 P=(H+J);vec4 Q=texture2D(uSampler,G(P));float R=A(Q.rgb);if(R>L){float S=(0.01+(sin((H.x/(pixelDimensions.x-1.))*D*(pixelDimensions.x*C))*0.005));L=clamp((R-S),I,1.);K.rgb=vec3(L);}}gl_FragColor=K;}";var Wy=class extends PIXI.Filter{constructor(){super(O,zy);this.padding=0,this.sourceW=0,this.sourceH=0,this.averageColor=[0,0,0],this.plainFilter=new BFN.filters.PlainFilter}setDimensions(e=0,t=0){e>0&&t>0&&(this.sourceW!==e||this.sourceH!==t)&&(this.sourceW=e,this.sourceH=t,this.uniforms.pixelDimensions=[this.sourceW,this.sourceH],this.uniforms.scaleDimensions=[this.sourceW/BFN.FilterHelper.getNextPowerOfTwo(this.sourceW),this.sourceH/BFN.FilterHelper.getNextPowerOfTwo(this.sourceH)])}apply(e,t,r,a){let s=e.getRenderTarget(!0),o=e.getRenderTarget(!0);this.plainFilter.apply(e,t,s,!0);let n=Math.min(200,this.sourceH)+2;for(let l=0;l<n;l++){this.uniforms.pass=l,e.applyFilter(this,s,o,!0);let c=o;o=s,s=c}this.plainFilter.apply(e,s,r,!0),e.returnRenderTarget(s),e.returnRenderTarget(o)}get averageColor(){return this.uniforms.averageColor}set averageColor(e){this.uniforms.averageColor=e}},$y=Wy;var jy="uniform sampler2D uSampler;varying vec2 vTextureCoord;void main(void){gl_FragColor=(vec4(1.)-clamp(texture2D(uSampler,vTextureCoord),vec4(0.),vec4(1.)));}";var Yy=class extends PIXI.Filter{constructor(){super(O,jy);this.padding=0}apply(e,t,r,a){e.applyFilter(this,t,r,a)}},qy=Yy;var Ky="uniform sampler2D uSampler;varying vec2 vTextureCoord;uniform vec2 pixelDimensions;uniform vec2 scaleDimensions;uniform float spread;uniform float direction;uniform float blendAlpha;uniform float alphaChoke;const float A=0.22;const float B=0.18;const float C=0.13;const float D=0.08;vec2 E(vec2 F){return((F/scaleDimensions)*pixelDimensions);}vec2 G(vec2 H){return((H/pixelDimensions)*scaleDimensions);}vec2 I(vec2 H,float J){float distance=(spread*J);vec2 K=vec2((cos(direction)*distance),(sin(direction)*distance));vec2 L=(H+K);vec2 M=vec2(0.);vec2 N=(pixelDimensions-vec2(1.));float O=1.;O=min(O,(abs(H.x-M.x)/abs(K.x)));O=min(O,(abs(H.x-N.x)/abs(K.x)));O=min(O,(abs(H.y-M.y)/abs(K.y)));O=min(O,(abs(H.y-N.y)/abs(K.y)));distance=((abs(distance*O)-(abs(distance)-abs(distance*O)))*(abs(distance)/distance));K=vec2((cos(direction)*distance),(sin(direction)*distance));L=clamp((H+K),M,N);return L;}void main(void){vec2 P=E(vTextureCoord);vec4 Q=(texture2D(uSampler,G(P))*A);if(blendAlpha==0.&&Q.a==0.){gl_FragColor=vec4(0.);return;}vec2 R=I(P,-(1./3.));vec2 S=I(P,-(2./3.));vec2 T=I(P,-(3./3.));vec2 U=I(P,(1./3.));vec2 V=I(P,(2./3.));vec2 W=I(P,(3./3.));vec4 X=(texture2D(uSampler,G(R))*B);vec4 Y=(texture2D(uSampler,G(S))*C);vec4 Z=(texture2D(uSampler,G(T))*D);vec4 a=(texture2D(uSampler,G(U))*B);vec4 b=(texture2D(uSampler,G(V))*C);vec4 c=(texture2D(uSampler,G(W))*D);vec4 d=(Q+X+Y+Z+a+b+c);if(d.a>0.&&blendAlpha==1.&&alphaChoke>0.){d.a=clamp((d.a+(alphaChoke*d.a)),0.,1.);}gl_FragColor=d;}";var Jy=class extends PIXI.Filter{constructor(){super(O,Ky);this.padding=0,this.sourceW=0,this.sourceH=0,this._maxSpread=0,this._maxSpreadCalc=0,this.amount=1,this.direction=0,this.blendAlpha=!1,this.alphaChoke=0,this.iterations=5,this.biDirectional=!1,this.plainFilter=new BFN.filters.PlainFilter}setDimensions(e=0,t=0,r=void 0){e>0&&t>0&&(this.sourceW!==e||this.sourceH!==t||this._maxSpread!==r)&&(this.sourceW=e,this.sourceH=t,this.setMaxSpread(r),this.uniforms.pixelDimensions=[this.sourceW,this.sourceH],this.uniforms.scaleDimensions=[this.sourceW/BFN.FilterHelper.getNextPowerOfTwo(this.sourceW),this.sourceH/BFN.FilterHelper.getNextPowerOfTwo(this.sourceH)])}setMaxSpread(e){isNaN(parseInt(e))?this._maxSpread=Math.max(this.sourceW,this.sourceH)/32:this._maxSpread=e,this._maxSpreadCalc=this._maxSpread/this._bleedFactor}apply(e,t,r,a){let s=e.getRenderTarget(!0),o=e.getRenderTarget(!0);this.plainFilter.apply(e,t,s,!0);let n=(l,c)=>{this.uniforms.spread=l,this.uniforms.direction=c,e.applyFilter(this,s,o,!0);let h=o;o=s,s=h};for(let l=0;l<this._iterations;l++){let c=this._amount*this._maxSpreadCalc/Math.pow(2,l);n(c,this._direction),this.biDirectional&&n(c,this._direction+Math.PI/2)}this.plainFilter.apply(e,s,r,!0),e.returnRenderTarget(s),e.returnRenderTarget(o)}get amount(){return this._amount}set amount(e){this._amount=Math.max(0,Math.min(1,e))}get direction(){return this._direction}set direction(e){this._direction=e}get blendAlpha(){return this._blendAlpha}set blendAlpha(e){this._blendAlpha=e,this.uniforms.blendAlpha=e?1:0}get alphaChoke(){return this._alphaChoke}set alphaChoke(e){this._alphaChoke=Math.max(0,Math.min(1,e)),this.uniforms.alphaChoke=this._alphaChoke}get iterations(){return this._iterations}set iterations(e){this._iterations=e,this._bleedFactor=0;for(let t=0;t<this._iterations;t++)this._bleedFactor+=1/Math.pow(2,t);this.setMaxSpread(this._maxSpread)}get biDirectional(){return this._biDirectional}set biDirectional(e){this._biDirectional=e}},Qy=Jy;var Zy="uniform sampler2D uSampler;varying vec2 vTextureCoord;uniform sampler2D glitchSrc;uniform vec2 pixelDimensions;uniform vec2 scaleDimensions;uniform float seed;uniform float noise;uniform float strength;uniform float chromatic;uniform float vShift;const float A=3.14159265358979323846264;const float B=(A*2.);const float C=(128./255.);float D(float seed){return mod((seed*9301.+49297.),233280.);}float E(float seed,float min,float max){return(min+((seed/233280.)*(max-min)));}void main(void){vec4 F=texture2D(glitchSrc,(vTextureCoord/scaleDimensions));vec2 G=((vTextureCoord/scaleDimensions)*pixelDimensions);float H=min(pixelDimensions.x,pixelDimensions.y);float I=((F.r-C)*2.);float J=((F.g-C)*vShift);if(noise>0.){float K=((D(D(seed+D(G.y)))+D(seed+G.y))/2.);if(E(K,0.,1.)<(noise/2.)){K=D(K);float L=(E(K,0.,1.)*B);float M=((G.y/pixelDimensions.y)*B);float N=((sin(L)+sin(M*4.)+sin(M*10.)+sin(M*22.))/4.);I+=(N*noise*I*2.);}}vec2 O=floor(vec2(I,J)*strength*(H/2.));G=mod((G+O+pixelDimensions),pixelDimensions);vec2 P=vTextureCoord;P=((G/pixelDimensions)*scaleDimensions);vec4 Q=texture2D(uSampler,P);if(chromatic>0.||vShift>0.){float R=floor(H/5.);float S=floor(chromatic*R*I*strength);float T=floor(chromatic*R*J*strength);vec2 U=G;U.x=mod((U.x-S+pixelDimensions.x),pixelDimensions.x);U.y=mod((U.y-T+pixelDimensions.y),pixelDimensions.y);vec2 V=((U/pixelDimensions)*scaleDimensions);V.y=(((vTextureCoord.y-V.y)*chromatic)+V.y);vec4 W=texture2D(uSampler,V);Q.r=W.r;vec2 X=G;X.x=mod((X.x+S+pixelDimensions.x),pixelDimensions.x);X.y=mod((X.y+T+pixelDimensions.y),pixelDimensions.y);vec2 Y=((X/pixelDimensions)*scaleDimensions);Y.y=(((vTextureCoord.y-Y.y)*chromatic)+Y.y);vec4 Z=texture2D(uSampler,Y);Q.b=Z.b;}gl_FragColor=Q;}";var ex=class extends PIXI.Filter{constructor(){super(O,Zy);this.padding=0,this.sourceW=0,this.sourceH=0,this.seed=1,this.strength=.5,this.chromatic=.5,this.noise=.5}setDimensions(e=0,t=0){e>0&&t>0&&(this.sourceW!==e||this.sourceH!==t)&&(this.sourceW=e,this.sourceH=t,this.uniforms.pixelDimensions=[this.sourceW,this.sourceH],this.uniforms.scaleDimensions=[this.sourceW/BFN.FilterHelper.getNextPowerOfTwo(this.sourceW),this.sourceH/BFN.FilterHelper.getNextPowerOfTwo(this.sourceH)],this.drawGlitchSource())}drawGlitchSource(){if(this.glitchSourceTexture||(this.glitchSourceTexture=PIXI.RenderTexture.create(32,32),this.uniforms.glitchSrc=this.glitchSourceTexture),this.sourceW>0&&this.sourceH>0)this.glitchSourceTexture.width!==this.sourceW&&this.glitchSourceTexture.height!==this.sourceH&&this.glitchSourceTexture.resize(this.sourceW,this.sourceH);else{this.glitchSourceTexture.fillColor(8947848);return}this.glitchSourceGraphic||(this.glitchSourceGraphic=new PIXI.Graphics);let e=Math.min(this.sourceW,this.sourceH),t=this.seed,r=(v=0,T=10)=>(t=(t*9301+49297)%233280,Math.round(v+t/233280*(T-v))),a=()=>r()/10*2-1,s=(v=0,T=0,x=0)=>{let B={r:Math.max(0,Math.min(255,128+Math.round(v*16))),g:Math.max(0,Math.min(255,128+Math.round(T*16))),b:Math.max(0,Math.min(255,128+Math.round(x*16)))};return parseInt("0x"+BFN.ColorUtil.rgbaObjectToHexStringObject(B).hex)},o=(v=0,T=0,x=0,B=0,y=8421504,F=1,b=!1)=>{b&&this.glitchSourceGraphic.clear(),!(x<=0||B<=0)&&(this.glitchSourceGraphic.beginFill(y,F),this.glitchSourceGraphic.drawRect(v,T,x,B),this.glitchSourceGraphic.endFill())},n=(v,T=1)=>{if(!v)return;v=Math.max(1,Math.round(v));let x=Math.floor(v/2),B=0;for(;B<this.sourceH;){let y=v+Math.round(a()*x),F=r();if(F<2||F>8){let b=Math.abs(F-5)/(F-5),S=Math.round((r(0,6)-3)/3);o(0,B,this.sourceW,y,s(b,S),T)}B=Math.round(B+y)}},l=Math.max(2,Math.round(e/40)),c=Math.round(l/2),h=!1,u=!1,d=null,m=0,p=0,g=0,f=()=>{let v=0;for(;v<this.sourceH;){if(h){if(u){let T=Math.round(p===-1?m:this.sourceW-m),x=Math.floor(T/c/8*(c/l)),B=r(0,x),y=p===-1?0:m,F=T;if(B){let b=Math.round(B*c*2);F-=b,p===1&&(y+=b)}if(o(y,v,F,c,d),B){y=p===1?y:F-c;for(let b=0;b<B&&!(r(0,9)<5);b++)y=Math.round(y-p*c*2),o(y,v,c,c,d)}}u=!u,g+=c,(r()<=3||g>=l*1)&&(h=!1,u=!1)}else if(c=Math.max(1,Math.round((c+r())%l)),r()<=1){let T=r(),x=Math.abs(T-5)/(T-5)*1;x&&(m=Math.round(r(0,50)/50*this.sourceW),p=r(0,9)<5?-1:1,m+p>0&&m+p<this.sourceW&&(h=!0,u=!0,d=s(x,Math.round((r(0,6)-3)/3)),g=0))}v=Math.round(v+c)}};o(0,0,this.sourceW,this.sourceH,s(0),1,!0),n(e/10,1),n(e/5,.25),f(),BFN.Stage.render(this.glitchSourceGraphic,this.glitchSourceTexture)}clearGlitchSource(){this.glitchSourceGraphic&&(this.glitchSourceGraphic.clear(),this.glitchSourceGraphic=null),this.glitchSourceTexture&&(this.glitchSourceTexture.destroyGC(!0),this.glitchSourceTexture=null),this.sourceW=0,this.sourceH=0}get seed(){return this.uniforms.seed}set seed(e){this.uniforms.seed=Math.round(Math.max(0,e))}get strength(){return this.uniforms.strength}set strength(e){this.uniforms.strength=Math.max(0,Math.min(1,e))}get noise(){return this.uniforms.noise}set noise(e){this.uniforms.noise=Math.max(0,Math.min(1,e))}get chromatic(){return this.uniforms.chromatic}set chromatic(e){this.uniforms.chromatic=Math.max(0,Math.min(1,e))}get vShift(){return this.uniforms.vShift}set vShift(e){this.uniforms.vShift=Math.max(0,Math.min(1,e))}},tx=ex;var ix="float A(vec3 B){return dot(B,vec3(0.299,0.587,0.114));}uniform sampler2D uSampler;varying vec2 vTextureCoord;uniform vec2 pixelDimensions;uniform vec2 scaleDimensions;uniform sampler2D blurTexture;uniform sampler2D artifactTexture;uniform vec2 artifactDimensions;uniform float grayscale;uniform float phase;uniform float length;uniform float horizontal;const float C=3.14159265358979323846264;const float D=(C*2.);const vec3 E=vec3(0.2,0.2,0.1);const vec3 F=vec3(16.,8.,32.);void main(void){float G=min(pixelDimensions.x,pixelDimensions.y);vec3 H=floor(G*E);vec2 I=((vTextureCoord/scaleDimensions)*pixelDimensions);vec2 J=((I/pixelDimensions)*scaleDimensions);vec4 K=texture2D(uSampler,J);if(K.a==0.){gl_FragColor=vec4(0.);return;}K.rgb/=K.a;if(grayscale==1.){float L=A(K.rgb);K.rgb=vec3(L);}float M=(I.y/pixelDimensions.y);float N=max(1.,(pixelDimensions.y/12.));float O=mod(floor((I.y+(N*3.*phase))/N),2.);float P=(((sin((((M*(F.r/2.))*D)+(phase*C*1.5)))>0.)?-1.:0.)+O);vec2 Q=vec2((floor((H.r*horizontal)+(G*0.015))*P),0.);vec2 R=clamp((I+Q),vec2(0.),(pixelDimensions-vec2(1.)));vec2 S=((R/pixelDimensions)*scaleDimensions);vec4 T=texture2D(uSampler,S);T.rgb/=T.a;if(grayscale==1.){float U=A(T.rgb);T.rgb=vec3(U);}K.r=T.r;vec2 V=mod((I+vec2(0.,(artifactDimensions.y*phase*20.))),artifactDimensions);vec2 W=(V/artifactDimensions);vec4 X=texture2D(artifactTexture,W);X.rgb/=X.a;float Y=A(X.rgb);float Z=max(1.,(((length*0.99)+0.01)*pixelDimensions.y));float a=mod(floor((I.y+(Z*3.*phase))/Z),2.);float b=(((sin((((M*(F.g/2.))*D)+(phase*C*6.)))>0.)?-1.:0.)+a);vec2 c=vec2((floor((H.g*horizontal)+(G*0.005))*b),0.);vec2 d=clamp((I+c),vec2(0.),(pixelDimensions-vec2(1.)));vec2 e=((d/pixelDimensions)*scaleDimensions);vec4 f=texture2D(uSampler,e);f.rgb/=f.a;if(grayscale==1.){float g=A(f.rgb);f.rgb=vec3(g);}K.g=mix(f.g,K.g,Y);float h=((sin((((M*(F.b/2.))*D)+(phase*C*3.)))>0.)?1.:-1.);vec2 i=vec2((floor(H.b*horizontal)*h),0.);vec2 j=clamp((I+i),vec2(0.),(pixelDimensions-vec2(1.)));vec2 k=((j/pixelDimensions)*scaleDimensions);vec4 l=texture2D(blurTexture,(k/scaleDimensions));l.rgb/=l.a;if(grayscale==1.){float m=A(l.rgb);l.rgb=vec3(m);}K.b=l.b;K.rgb*=K.a;gl_FragColor=K;}";var rx=class extends PIXI.Filter{constructor(){super(O,ix);this.padding=0,this.sourceTexture=null,this.sourceW=0,this.sourceH=0,this.phase=0,this.length=.2,this.horizontal=.2,this.directionalBlurFilter=null,this.directionalBlurTexture=null,this.directionalBlurSprite=new PIXI.Sprite}setSourceTexture(e){if(e&&e.baseTexture&&e!==this.sourceTexture){this.resetSourceTexture(),this.sourceTexture=e,this.sourceW=e.width,this.sourceH=e.height,this.uniforms.pixelDimensions=[this.sourceW,this.sourceH],this.uniforms.scaleDimensions=[this.sourceW/BFN.FilterHelper.getNextPowerOfTwo(this.sourceW),this.sourceH/BFN.FilterHelper.getNextPowerOfTwo(this.sourceH)],this.directionalBlurFilter||(this.directionalBlurFilter=new BFN.filters.DirectionalBlurFilter,this.directionalBlurFilter.amount=.25,this.directionalBlurFilter.direction=0),this.directionalBlurFilter.setDimensions(this.sourceW,this.sourceH),this.directionalBlurSprite.texture=this.sourceTexture,this.directionalBlurSprite.filters=[this.directionalBlurFilter],this.directionalBlurTexture=PIXI.RenderTexture.create(this.sourceW,this.sourceH),BFN.Stage.render(this.directionalBlurSprite,this.directionalBlurTexture),this.uniforms.blurTexture=this.directionalBlurTexture,this.drawArtifactGraphic();let t=this.sourceW*this.sourceH,r=Math.sqrt(t)/20,a=Math.sqrt(100*330),s=r/a,o=Math.round(100*s),n=Math.round(330*s);this.artifactGraphic.scale.x=o/100,this.artifactGraphic.scale.y=n/330,this.artifactTexture=PIXI.RenderTexture.create(o,n),BFN.Stage.render(this.artifactGraphic,this.artifactTexture),this.uniforms.artifactTexture=this.artifactTexture,this.uniforms.artifactDimensions=[o,n]}}resetSourceTexture(){this.sourceW=0,this.sourceH=0,this.sourceTexture=null;try{this.directionalBlurTexture.destroyGC(!0)}catch(e){}this.directionalBlurTexture=null,this.directionalBlurSprite.texture=PIXI.Texture.EMPTY,this.directionalBlurSprite.filters=[];try{this.artifactTexture.destroyGC(!0)}catch(e){}this.artifactTexture=null}drawArtifactGraphic(){if(this.artifactGraphic)return;let e=new PIXI.Graphics;e.beginFill(0),e.drawRect(0,0,100,330),e.endFill(),e.beginFill(16777215),e.drawRect(0,0,37,6),e.drawRect(0,7,37,1),e.drawRect(0,9,37,1),e.drawRect(0,10,5,5),e.drawRect(13,10,24,5),e.drawRect(39,10,8,5),e.drawRect(54,0,11,8),e.drawRect(54,8,6,1),e.drawRect(54,9,11,1),e.drawRect(52,10,13,5),e.drawRect(72,4,7,4),e.drawRect(72,9,7,3),e.drawRect(81,4,11,4),e.drawRect(81,9,11,3),e.drawRect(94,5,1,5),e.drawRect(0,19,14,2),e.drawRect(18,19,19,2),e.drawRect(38,19,27,2),e.drawRect(72,19,7,2),e.drawRect(79,19,2,1),e.drawRect(81,19,19,2),e.drawRect(56,32,5,1),e.drawRect(56,34,5,2),e.drawRect(69,32,1,1),e.drawRect(70,33,4,1),e.drawRect(74,32,23,1),e.drawRect(69,34,28,2),e.drawRect(14,86,10,1),e.drawRect(27,86,10,1),e.drawRect(38,86,17,1),e.drawRect(6,91,5,3),e.drawRect(0,94,14,3),e.drawRect(14,95,23,2),e.drawRect(24,97,3,1),e.drawRect(38,95,17,2),e.drawRect(36,130,1,2),e.drawRect(39,130,26,2),e.drawRect(72,130,12,2),e.drawRect(50,133,44,1),e.drawRect(42,134,58,1),e.drawRect(40,135,54,1),e.drawRect(0,136,21,2),e.drawRect(28,136,6,2),e.drawRect(34,136,3,1),e.drawRect(37,136,28,2),e.drawRect(66,136,24,2),e.drawRect(26,164,12,2),e.drawRect(38,164,12,3),e.drawRect(38,167,14,3),e.drawRect(38,170,12,2),e.drawRect(56,164,23,8),e.drawRect(80,164,7,8),e.drawRect(0,173,22,6),e.drawRect(24,173,26,6),e.drawRect(56,173,20,6),e.drawRect(70,179,6,5),e.drawRect(0,184,22,1),e.drawRect(0,186,22,1),e.drawRect(0,187,8,1),e.drawRect(11,187,11,1),e.drawRect(24,184,26,1),e.drawRect(24,185,14,1),e.drawRect(24,186,26,2),e.drawRect(56,184,7,1),e.drawRect(62,185,1,1),e.drawRect(56,186,7,2),e.drawRect(66,184,10,4),e.drawRect(18,243,30,1),e.drawRect(50,238,9,1),e.drawRect(50,240,9,4),e.drawRect(59,238,3,2),e.drawRect(59,241,3,3),e.drawRect(62,238,9,1),e.drawRect(62,240,9,4),e.drawRect(72,238,16,1),e.drawRect(72,240,16,4),e.drawRect(72,245,13,1),e.drawRect(92,245,8,1),e.drawRect(23,273,66,2),e.drawRect(36,277,36,1),e.drawRect(16,292,22,3),e.drawRect(39,292,26,3),e.drawRect(72,292,7,3),e.drawRect(81,292,11,3),e.endFill(),this.artifactGraphic=e}get grayscale(){return this.uniforms.grayscale}set grayscale(e){this.uniforms.grayscale=Math.round(Math.max(0,Math.min(1,e)))}get phase(){return this.uniforms.phase}set phase(e){this.uniforms.phase=Math.max(0,Math.min(1,e))}get length(){return this.uniforms.length}set length(e){this.uniforms.length=Math.max(0,Math.min(1,e))}get horizontal(){return this.uniforms.horizontal}set horizontal(e){this.uniforms.horizontal=Math.max(0,Math.min(1,e))}},ax=rx;var sx="float A(vec3 B){return dot(B,vec3(0.299,0.587,0.114));}uniform sampler2D uSampler;varying vec2 vTextureCoord;uniform vec2 pixelDimensions;uniform vec2 scaleDimensions;uniform float grayscale;uniform float horizontal;uniform float vertical;uniform float colorCycle;void main(void){float C=min(pixelDimensions.x,pixelDimensions.y);float D=(C/4.);vec2 E=vec2(floor(horizontal*D),floor(vertical*D));vec2 F=((vTextureCoord/scaleDimensions)*pixelDimensions);vec2 G=clamp((F+E),vec2(0.),(pixelDimensions-vec2(1.)));vec2 H=clamp((F-E),vec2(0.),(pixelDimensions-vec2(1.)));vec2 I=((F/pixelDimensions)*scaleDimensions);vec2 J=((G/pixelDimensions)*scaleDimensions);vec2 K=((H/pixelDimensions)*scaleDimensions);vec4 L=texture2D(uSampler,I);if(L.a==0.){gl_FragColor=vec4(0.);return;}L.rgb/=L.a;vec4 M=texture2D(uSampler,J);M.rgb/=M.a;vec4 N=texture2D(uSampler,K);N.rgb/=N.a;if(grayscale==1.){float O=A(L.rgb);float P=A(M.rgb);float Q=A(N.rgb);L.rgb=vec3(O);M.rgb=vec3(P);N.rgb=vec3(Q);}if(colorCycle==0.){L.r=M.r;L.b=N.b;}else if(colorCycle==1.){L.r=M.r;L.g=N.g;}else if(colorCycle==2.){L.g=M.g;L.b=N.b;}else if(colorCycle==3.){L.r=N.r;L.g=M.g;L.b=N.b;}else if(colorCycle==4.){L.r=M.r;L.g=M.g;L.b=N.b;}else if(colorCycle==5.){L.r=N.r;L.g=M.g;L.b=M.b;}L.rgb*=L.a;gl_FragColor=L;}";var ox=class extends PIXI.Filter{constructor(){super(O,sx);this.padding=0,this.sourceW=0,this.sourceH=0,this.horizontal=.1,this.vertical=0,this.colorCycle=0}setDimensions(e=0,t=0){e>0&&t>0&&(this.sourceW!==e||this.sourceH!==t)&&(this.sourceW=e,this.sourceH=t,this.uniforms.pixelDimensions=[this.sourceW,this.sourceH],this.uniforms.scaleDimensions=[this.sourceW/BFN.FilterHelper.getNextPowerOfTwo(this.sourceW),this.sourceH/BFN.FilterHelper.getNextPowerOfTwo(this.sourceH)])}get grayscale(){return this.uniforms.grayscale}set grayscale(e){this.uniforms.grayscale=Math.round(Math.max(0,Math.min(1,e)))}get horizontal(){return this.uniforms.horizontal}set horizontal(e){this.uniforms.horizontal=Math.max(-1,Math.min(1,e))}get vertical(){return this.uniforms.vertical}set vertical(e){this.uniforms.vertical=Math.max(-1,Math.min(1,e))}get colorCycle(){return this.uniforms.colorCycle}set colorCycle(e){this.uniforms.colorCycle=Math.max(0,Math.min(5,e))}},nx=ox;var lx="float A(vec3 B){return dot(B,vec3(0.299,0.587,0.114));}uniform sampler2D uSampler;varying vec2 vTextureCoord;uniform vec2 pixelDimensions;uniform vec2 scaleDimensions;uniform sampler2D loresTexture1;uniform vec2 loresDimensions1;uniform sampler2D loresTexture2;uniform vec2 loresDimensions2;uniform sampler2D loresTexture3;uniform vec2 loresDimensions3;uniform sampler2D loresTexture4;uniform vec2 loresDimensions4;uniform float grayscale;uniform float highlights;uniform float offset;const float C=3.14159265358979323846264;const float D=(C*2.);const float E=100.;float F(vec2 G,sampler2D H,vec2 I){vec2 J=(1./I);vec2 K=((floor((G/pixelDimensions)*I)/I)+(J/2.));vec4 L=texture2D(H,K);float M=A(L.rgb);return M;}void main(void){vec2 G=((vTextureCoord/scaleDimensions)*pixelDimensions);float N=min(pixelDimensions.x,pixelDimensions.y);float O=(N/128.);float P=(offset*O);float Q=F(G,loresTexture4,loresDimensions4);float R=F(G,loresTexture3,loresDimensions3);float S=(Q*R*D*E);vec2 T=floor(vec2((cos(S)*P),(sin(S)*P)));G=mod((G+T+pixelDimensions),pixelDimensions);vec4 U=texture2D(uSampler,((G/pixelDimensions)*scaleDimensions));if(U.a==0.){gl_FragColor=vec4(0.);return;}float V=A(U.rgb);float W=F(G,loresTexture1,loresDimensions1);float X=F(G,loresTexture2,loresDimensions2);float Y=F(G,loresTexture3,loresDimensions3);float Z=F(G,loresTexture4,loresDimensions4);float a=min(Z,min(Y,min(X,min(W,V))));vec4 b=vec4(vec3(a),U.a);if(grayscale==0.){float c=(1.-max(U.r,max(U.g,U.b)));float B=((1.-U.r-c)/(1.-c));float d=((1.-U.g-c)/(1.-c));float e=((1.-U.b-c)/(1.-c));c=(1.-a);b.r=((1.-B)*(1.-c));b.g=((1.-d)*(1.-c));b.b=((1.-e)*(1.-c));a=A(b.rgb);}else{U.rgb=vec3(V);}float f=(1.-highlights);if(V>a&&V>f){float g=((V-f)/(1.-f))*highlights;b=mix(b,U,g);}gl_FragColor=b;}";var cx=class extends PIXI.Filter{constructor(){super(O,lx);this.padding=0,this.sourceTexture=null,this.sourceW=0,this.sourceH=0}setSourceTexture(e){e&&e.baseTexture&&e!==this.sourceTexture&&(this.resetSourceTexture(),this.sourceTexture=e,this.sourceW=e.width,this.sourceH=e.height,this.uniforms.pixelDimensions=[this.sourceW,this.sourceH],this.uniforms.scaleDimensions=[this.sourceW/BFN.FilterHelper.getNextPowerOfTwo(this.sourceW),this.sourceH/BFN.FilterHelper.getNextPowerOfTwo(this.sourceH)],this.generateLoresTextures())}resetSourceTexture(){this.sourceW=0,this.sourceH=0,this.sourceTexture=null,this.destroyLoresTextures()}generateLoresTextures(){if(!this.sourceTexture||!this.sourceW||!this.sourceH)return;let e=(t,r,a)=>{r=r||512,a=a||r;let s={x:a/t.width,y:r/t.width},o=PIXI.RenderTexture.create(Math.max(1,Math.min(BFN.maxImageSize,Math.round(t.width*s.x))),Math.max(1,Math.min(BFN.maxImageSize,Math.round(t.height*s.y))));return s.x=o.width/t.width,s.y=o.height/t.height,o.copyPixels(t,void 0,void 0,void 0,s),o};this.loresTexture1||(this.loresTexture1=e(this.sourceTexture,512),this.uniforms.loresTexture1=this.loresTexture1,this.uniforms.loresDimensions1=[this.loresTexture1.width,this.loresTexture1.height]),this.loresTexture2||(this.loresTexture2=e(this.loresTexture1,144),this.uniforms.loresTexture2=this.loresTexture2,this.uniforms.loresDimensions2=[this.loresTexture2.width,this.loresTexture2.height]),this.loresTexture3||(this.loresTexture3=e(this.loresTexture1,64),this.uniforms.loresTexture3=this.loresTexture3,this.uniforms.loresDimensions3=[this.loresTexture3.width,this.loresTexture3.height]),this.loresTexture4||(this.loresTexture4=e(this.loresTexture1,24),this.uniforms.loresTexture4=this.loresTexture4,this.uniforms.loresDimensions4=[this.loresTexture4.width,this.loresTexture4.height])}destroyLoresTextures(){try{this.loresTexture1.destroyGC(!0)}catch(e){}this.loresTexture1=null;try{this.loresTexture2.destroyGC(!0)}catch(e){}this.loresTexture2=null;try{this.loresTexture3.destroyGC(!0)}catch(e){}this.loresTexture3=null;try{this.loresTexture4.destroyGC(!0)}catch(e){}this.loresTexture4=null}get grayscale(){return this.uniforms.grayscale}set grayscale(e){this.uniforms.grayscale=Math.round(Math.max(0,Math.min(1,e)))}get highlights(){return this.uniforms.highlights}set highlights(e){this.uniforms.highlights=Math.max(0,Math.min(1,e))}get offset(){return this.uniforms.offset}set offset(e){this.uniforms.offset=Math.max(0,Math.min(1,e))}},hx=cx;var ux="float A(vec3 B){return dot(B,vec3(0.299,0.587,0.114));}uniform sampler2D uSampler;varying vec2 vTextureCoord;uniform vec2 pixelDimensions;uniform vec2 scaleDimensions;uniform sampler2D sweepTexture;uniform sampler2D loresTexture;uniform vec2 loresDimensions;uniform vec3 colorValue;uniform float highlights;uniform float weight;uniform float horizontal;const float C=3.14159265358979323846264;const float D=(C*2.);vec4 E(vec2 F){vec2 G=(1./loresDimensions);vec2 H=((floor((F/pixelDimensions)*loresDimensions)/loresDimensions)+(G/2.));vec4 I=texture2D(sweepTexture,H);return I;}vec4 J(vec2 F){vec2 G=(1./loresDimensions);vec2 H=((floor((F/pixelDimensions)*loresDimensions)/loresDimensions)+(G/2.));vec4 I=texture2D(loresTexture,H);return I;}void main(void){vec2 F=((vTextureCoord/scaleDimensions)*pixelDimensions);vec4 K=texture2D(uSampler,((F/pixelDimensions)*scaleDimensions));vec2 L=(pixelDimensions/loresDimensions);vec2 M=(L*2.);float N=floor(F.x/M.x);float O=(mod(N,2.)==0.)?0.:L.y;float P=floor((F.y+O)/M.y);vec2 Q=vec2(((M.x*N)),((M.y*P)));vec2 R=vec2(0.,O);vec2 S=(Q+R);vec2 T=mod(((F+R)/M),1.);vec4 U=J(Q);vec4 V=J(Q+vec2(L.x,0.));vec4 W=J(Q+vec2(0.,L.y));vec4 X=J(Q+L);vec4 Y=mix(U,V,T.x);vec4 Z=mix(W,X,T.x);vec4 a=mix(Y,Z,T.y);if(mod(N,2.)==1.){float b=floor(F.y/L.y);if(b==0.||b==(loresDimensions.y-1.)){a=Y;}}vec4 c=((U+V+W+X)/4.);float d=A(c.rgb);vec4 e=E(Q);vec4 f=E(Q+vec2(L.x,0.));vec4 g=E(Q+vec2(0.,L.y));vec4 h=E(Q+L);vec4 i=((e+f)/2.);vec4 j=((g+h)/2.);vec4 k=((i+j)/2.);if(mod(N,2.)==1.){float b=floor(F.y/L.y);if(b==0.||b==(loresDimensions.y-1.)){k=i;}}float l=A(k.rgb);float m=(mix((M.x*d),M.x,(weight/2.))*l);float n=(M.x-m);float o=horizontal;float p=(o*n);vec2 q=mod((F+vec2(0.,O)),M);float r=1.;if(q.x<p||q.x>(m+p)){r=0.;}float s=(M.y*((l*0.4)+0.6));float t=((M.y/2.)-(s/2.));float u=1.;if(q.y<t||q.y>(s+t)){u=0.;}float v=1.;float w=A(colorValue);a.rgb*=(r*u*v);float x=A(a.rgb);if(colorValue.r>=0.&&colorValue.g>=0.&&colorValue.b>=0.){a.rgb=vec3(x)*colorValue;}float y=(1.-highlights);if(x>y){float T=(((x-y)/(1.-y))*1.);a=mix(a,vec4(1.),T);}K=vec4(a.rgb,1.);if(mod(F.x,Q.x)<1.||mod((F.y+O),Q.y)<1.){K.rgb=vec3(0.);}gl_FragColor=K;}";var dx=class extends PIXI.Filter{constructor(){super(O,ux);this.padding=0,this.colorValue="55CC55",this.highlights=.5,this.weight=.5,this.horizontal=.5,this.sourceTexture=null,this.sourceW=0,this.sourceH=0,this.sweepFilter=null}setSourceTexture(e){e&&e.baseTexture&&e!==this.sourceTexture&&(this.resetSourceTexture(),this.sourceTexture=e,this.sourceW=e.width,this.sourceH=e.height,this.uniforms.pixelDimensions=[this.sourceW,this.sourceH],this.uniforms.scaleDimensions=[this.sourceW/BFN.FilterHelper.getNextPowerOfTwo(this.sourceW),this.sourceH/BFN.FilterHelper.getNextPowerOfTwo(this.sourceH)],this.generateHelperTextures())}resetSourceTexture(){this.sourceW=0,this.sourceH=0,this.sourceTexture=null,this.destroyHelperTextures()}generateHelperTextures(){if(!this.sourceTexture||!this.sourceW||!this.sourceH||this.loresTexture)return;let e=this.sourceW*this.sourceH,t=Math.min(.5,256/Math.sqrt(e)),r={x:t,y:t};this.loresTexture=PIXI.RenderTexture.create(Math.max(1,Math.min(BFN.maxImageSize,Math.round(this.sourceTexture.width*r.x))),Math.max(1,Math.min(BFN.maxImageSize,Math.round(this.sourceTexture.height*r.y)))),r.x=this.loresTexture.width/this.sourceTexture.width,r.y=this.loresTexture.height/this.sourceTexture.height,this.loresTexture.copyPixels(this.sourceTexture,void 0,void 0,void 0,r),this.uniforms.loresTexture=this.loresTexture,this.uniforms.loresDimensions=[this.loresTexture.width,this.loresTexture.height],this.sweepFilter||(this.sweepFilter=new BFN.filters.SweepFilter),this.sweepFilter.setDimensions(this.loresTexture.width,this.loresTexture.height),this.sweepFilter.averageColor=BFN.Util.getTextureAverageColor(this.loresTexture,!1,!0);let a=new PIXI.Sprite(this.loresTexture);a.filters=[this.sweepFilter],this.sweepTexture=PIXI.RenderTexture.create(this.loresTexture.width,this.loresTexture.height),BFN.Stage.render(a,this.sweepTexture),a.filters=[],a.destroy(!1),this.uniforms.sweepTexture=this.sweepTexture}destroyHelperTextures(){try{this.loresTexture.destroyGC(!0)}catch(e){}this.loresTexture=null;try{this.sweepTexture.destroyGC(!0)}catch(e){}this.sweepTexture=null;try{this.artifactTexture.destroyGC(!0)}catch(e){}this.artifactTexture=null}get colorValue(){return this.uniforms.colorValue}set colorValue(e){e==-1?e=[-1,-1,-1]:e=BFN.FilterHelper.hex2rgb(e),this.uniforms.colorValue=e}get highlights(){return this.uniforms.highlights}set highlights(e){this.uniforms.highlights=Math.max(0,Math.min(1,e))}get weight(){return this.uniforms.weight}set weight(e){this.uniforms.weight=Math.max(0,Math.min(1,e))}get horizontal(){return this.uniforms.horizontal}set horizontal(e){this.uniforms.horizontal=Math.max(0,Math.min(1,e))}},mx=dx;var px="vec2 A(vec2 B,vec4 C){B*=C.xy;B+=C.zw;return B;}vec2 D(vec2 B,vec4 C){B-=C.zw;B/=C.xy;return B;}uniform sampler2D uSampler;varying vec2 vTextureCoord;uniform vec4 filterArea;uniform float pixelSize;uniform vec2 dimensions;void main(void){vec2 E=A(vTextureCoord,filterArea);E.x=floor(E.x);E.y=floor(E.y);float F=((pixelSize*3.)+1.);float G=floor(E.x/F);float H=(mod(G,2.)==0.)?0.:floor((F-1.)/2.);float I=floor((E.y+H)/F);float J=((F-1.)/2.);vec2 K=vec2(((F*G)+J),((F*I)+J));vec2 L=D(vec2(clamp((K.x-J),0.,(dimensions.x-1.)),clamp((K.y-J),0.,(dimensions.y-1.))),filterArea);vec2 M=D(vec2(clamp(K.x,0.,(dimensions.x-1.)),clamp((K.y-J),0.,(dimensions.y-1.))),filterArea);vec2 N=D(vec2(clamp((K.x+J),0.,(dimensions.x-1.)),clamp((K.y-J),0.,(dimensions.y-1.))),filterArea);vec2 O=D(vec2(clamp((K.x-J),0.,(dimensions.x-1.)),clamp(K.y,0.,(dimensions.y-1.))),filterArea);vec2 P=D(vec2(clamp(K.x,0.,(dimensions.x-1.)),clamp(K.y,0.,(dimensions.y-1.))),filterArea);vec2 Q=D(vec2(clamp((K.x+J),0.,(dimensions.x-1.)),clamp(K.y,0.,(dimensions.y-1.))),filterArea);vec2 R=D(vec2(clamp((K.x-J),0.,(dimensions.x-1.)),clamp((K.y+J),0.,(dimensions.y-1.))),filterArea);vec2 S=D(vec2(clamp(K.x,0.,(dimensions.x-1.)),clamp((K.y+J),0.,(dimensions.y-1.))),filterArea);vec2 T=D(vec2(clamp((K.x+J),0.,(dimensions.x-1.)),clamp((K.y+J),0.,(dimensions.y-1.))),filterArea);vec4 U=texture2D(uSampler,L);vec4 V=texture2D(uSampler,M);vec4 W=texture2D(uSampler,N);vec4 X=texture2D(uSampler,O);vec4 Y=texture2D(uSampler,P);vec4 Z=texture2D(uSampler,Q);vec4 a=texture2D(uSampler,R);vec4 b=texture2D(uSampler,S);vec4 c=texture2D(uSampler,T);vec4 d=((U+V+W+X+Y+Z+a+b+c)/9.);d.a=1.;vec4 e=d;float f=mod(E.x,F);float g=mod((E.y+H),F);float h=1.25;float i=2.5;if((f==(F-1.))||(g==(F-1.))){e.rgb=vec3(0.);}else{if(f<(pixelSize*1.)){e.r=clamp((e.r*h),0.,1.);e.gb/=i;}else if(f<(pixelSize*2.)){e.g=clamp((e.g*h),0.,1.);e.rb/=i;}else if(f<(pixelSize*3.)){e.b=clamp((e.b*h),0.,1.);e.rg/=i;}}gl_FragColor=e;}";var fx=class extends PIXI.Filter{constructor(){super(O,px);this.padding=0}get pixelSize(){return this.uniforms.pixelSize}set pixelSize(e){this.uniforms.pixelSize=Math.max(1,e)}get dimensions(){return this.uniforms.dimensions}set dimensions(e){this.uniforms.dimensions=e}},gx=fx;var vx=`vec2 A(vec2 B,vec4 C){B*=C.xy;B+=C.zw;return B;}vec2 D(vec2 B,vec4 C){B-=C.zw;B/=C.xy;return B;}precision highp float;
#define GLSLIFY 1
uniform sampler2D uSampler;varying vec2 vTextureCoord;uniform vec4 filterArea;uniform float distortion;uniform float focalPointX;uniform float focalPointY;uniform vec2 dimensions;void main(void){vec2 E=A(vTextureCoord,filterArea);E.x=floor(E.x);E.y=floor(E.y);float F=((E.x-(dimensions.x*focalPointX))/(dimensions.x*1.));float G=((E.y-(dimensions.y*focalPointY))/(dimensions.y*1.));float H=(dimensions.x/128.);float I=(dimensions.y/128.);float J=(distortion*F*H);float K=(distortion*G*I);vec2 L=D(vec2(clamp((E.x-(J*1.)),0.,(dimensions.x-1.)),clamp((E.y-(K*1.)),0.,(dimensions.y-1.))),filterArea);vec2 M=D(vec2(clamp((E.x-(J*2.)),0.,(dimensions.x-1.)),clamp((E.y-(K*2.)),0.,(dimensions.y-1.))),filterArea);vec4 N=texture2D(uSampler,vTextureCoord);if(N.a==0.){gl_FragColor=vec4(0,0,0,0);return;}N.rgb/=N.a;vec4 O=texture2D(uSampler,L);vec4 P=texture2D(uSampler,M);if(O.a>0.){O.rgb/=O.a;}if(P.a>0.){P.rgb/=P.a;}N.g=O.g;N.r=P.r;N.rgb*=N.a;gl_FragColor=N;}`;var yx=class extends PIXI.Filter{constructor(){super(O,vx);this.padding=0,this.distortion=1}get distortion(){return this.uniforms.distortion}set distortion(e){this.uniforms.distortion=Math.max(0,e)}get focalPointX(){return this.uniforms.focalPointX}set focalPointX(e){this.uniforms.focalPointX=Math.max(0,Math.min(1,e))}get focalPointY(){return this.uniforms.focalPointY}set focalPointY(e){this.uniforms.focalPointY=Math.max(0,Math.min(1,e))}get dimensions(){return this.uniforms.dimensions}set dimensions(e){this.uniforms.dimensions=e}},xx=yx;var Tx=`vec2 A(vec2 B,vec4 C){B*=C.xy;B+=C.zw;return B;}vec2 D(vec2 B,vec4 C){B-=C.zw;B/=C.xy;return B;}precision highp float;
#define GLSLIFY 1
uniform sampler2D uSampler;varying vec2 vTextureCoord;uniform vec4 filterArea;uniform float stretch;uniform float distortion;uniform float vignetteOpacity;uniform float edgeBlur;uniform vec2 dimensions;const float E=3.141592653589793238462;const float F=(E*2.);const float G=(E/2.);const float H=(E/4.);const float I=(E/8.);const float J=1.618033988749895;const float K=(F/J);void main(void){vec2 L=A(vTextureCoord,filterArea);L.x=floor(L.x);L.y=floor(L.y);float M=cos((1.-(L.x/(dimensions.x-1.)))*E);float N=(dimensions.x/2.)+((dimensions.x/2.)*M);float O=(((L.x-N)/4.)*stretch);float P=(L.x/dimensions.x);float Q=(E*P);float R=sin(Q);float S=clamp(((dimensions.y/2.)-L.y)/(dimensions.y/2.),-1.,1.);float T=(min(dimensions.x,dimensions.y)/24.);float U=(distortion*R*S*T);vec2 V=vec2((L.x+O),(L.y+U));vec2 W=D(vec2(clamp(V.x,0.,(dimensions.x-1.)),clamp(V.y,0.,(dimensions.y-1.))),filterArea);vec4 X=texture2D(uSampler,W);bool Y=(dimensions.x>dimensions.y);vec2 Z=(dimensions/2.);vec2 a=(dimensions/2.);if(Y){Z.x=(dimensions.x*0.1);a.x=(dimensions.x*0.9);}else{Z.y=(dimensions.y*0.1);a.y=(dimensions.y*0.9);}float b=((Y?dimensions.x:dimensions.y)*1.1);float c=((Y?dimensions.x:dimensions.y)*0.8);float d=(L.x-Z.x);float e=(L.y-Z.y);float f=sqrt(pow(d,2.)+pow(e,2.));float g=(L.x-a.x);float h=(L.y-a.y);float i=sqrt(pow(g,2.)+pow(h,2.));float j=(f+i);float k=1.;if(edgeBlur>0.&&j>c){if(j<=b){k=((j-c)/(b-c));}float l=(b/150.);float m=(l*k*edgeBlur);float n=(m/20.);vec2 o=D(vec2(clamp((V.x+(cos(K*2.)*(n*2.))),0.,(dimensions.x-1.)),clamp((V.y+(sin(K*2.)*(n*2.))),0.,(dimensions.y-1.))),filterArea);vec2 p=D(vec2(clamp((V.x+(cos(K*3.)*(n*3.))),0.,(dimensions.x-1.)),clamp((V.y+(sin(K*3.)*(n*3.))),0.,(dimensions.y-1.))),filterArea);vec2 q=D(vec2(clamp((V.x+(cos(K*4.)*(n*4.))),0.,(dimensions.x-1.)),clamp((V.y+(sin(K*4.)*(n*4.))),0.,(dimensions.y-1.))),filterArea);vec2 r=D(vec2(clamp((V.x+(cos(K*5.)*(n*5.))),0.,(dimensions.x-1.)),clamp((V.y+(sin(K*5.)*(n*5.))),0.,(dimensions.y-1.))),filterArea);vec2 s=D(vec2(clamp((V.x+(cos(K*6.)*(n*6.))),0.,(dimensions.x-1.)),clamp((V.y+(sin(K*6.)*(n*6.))),0.,(dimensions.y-1.))),filterArea);vec2 t=D(vec2(clamp((V.x+(cos(K*7.)*(n*7.))),0.,(dimensions.x-1.)),clamp((V.y+(sin(K*7.)*(n*7.))),0.,(dimensions.y-1.))),filterArea);vec2 u=D(vec2(clamp((V.x+(cos(K*8.)*(n*8.))),0.,(dimensions.x-1.)),clamp((V.y+(sin(K*8.)*(n*8.))),0.,(dimensions.y-1.))),filterArea);vec2 v=D(vec2(clamp((V.x+(cos(K*9.)*(n*9.))),0.,(dimensions.x-1.)),clamp((V.y+(sin(K*9.)*(n*9.))),0.,(dimensions.y-1.))),filterArea);vec2 w=D(vec2(clamp((V.x+(cos(K*10.)*(n*10.))),0.,(dimensions.x-1.)),clamp((V.y+(sin(K*10.)*(n*10.))),0.,(dimensions.y-1.))),filterArea);vec2 x=D(vec2(clamp((V.x+(cos(K*11.)*(n*11.))),0.,(dimensions.x-1.)),clamp((V.y+(sin(K*11.)*(n*11.))),0.,(dimensions.y-1.))),filterArea);vec2 y=D(vec2(clamp((V.x+(cos(K*12.)*(n*12.))),0.,(dimensions.x-1.)),clamp((V.y+(sin(K*12.)*(n*12.))),0.,(dimensions.y-1.))),filterArea);vec2 z=D(vec2(clamp((V.x+(cos(K*13.)*(n*13.))),0.,(dimensions.x-1.)),clamp((V.y+(sin(K*13.)*(n*13.))),0.,(dimensions.y-1.))),filterArea);vec2 AA=D(vec2(clamp((V.x+(cos(K*14.)*(n*14.))),0.,(dimensions.x-1.)),clamp((V.y+(sin(K*14.)*(n*14.))),0.,(dimensions.y-1.))),filterArea);vec2 AB=D(vec2(clamp((V.x+(cos(K*15.)*(n*15.))),0.,(dimensions.x-1.)),clamp((V.y+(sin(K*15.)*(n*15.))),0.,(dimensions.y-1.))),filterArea);vec2 AC=D(vec2(clamp((V.x+(cos(K*16.)*(n*16.))),0.,(dimensions.x-1.)),clamp((V.y+(sin(K*16.)*(n*16.))),0.,(dimensions.y-1.))),filterArea);vec2 AD=D(vec2(clamp((V.x+(cos(K*17.)*(n*17.))),0.,(dimensions.x-1.)),clamp((V.y+(sin(K*17.)*(n*17.))),0.,(dimensions.y-1.))),filterArea);vec2 AE=D(vec2(clamp((V.x+(cos(K*18.)*(n*18.))),0.,(dimensions.x-1.)),clamp((V.y+(sin(K*18.)*(n*18.))),0.,(dimensions.y-1.))),filterArea);vec2 AF=D(vec2(clamp((V.x+(cos(K*19.)*(n*19.))),0.,(dimensions.x-1.)),clamp((V.y+(sin(K*19.)*(n*19.))),0.,(dimensions.y-1.))),filterArea);X+=texture2D(uSampler,o);X+=texture2D(uSampler,p);X+=texture2D(uSampler,q);X+=texture2D(uSampler,r);X+=texture2D(uSampler,s);X+=texture2D(uSampler,t);X+=texture2D(uSampler,u);X+=texture2D(uSampler,v);X+=texture2D(uSampler,w);X+=texture2D(uSampler,x);X+=texture2D(uSampler,y);X+=texture2D(uSampler,z);X+=texture2D(uSampler,AA);X+=texture2D(uSampler,AB);X+=texture2D(uSampler,AC);X+=texture2D(uSampler,AD);X+=texture2D(uSampler,AE);X+=texture2D(uSampler,AF);X/=19.;}float AG=1.;if(vignetteOpacity>0.&&j>c){if(j<=b){AG=((j-c)/(b-c));}X=mix(X,vec4(vec3(0.),1.),(vignetteOpacity*AG));}gl_FragColor=X;}`;var Fx=class extends PIXI.Filter{constructor(){super(O,Tx);this.padding=0,this.distortion=1}get stretch(){return this.uniforms.stretch}set stretch(e){this.uniforms.stretch=Math.max(0,Math.min(1,e))}get distortion(){return this.uniforms.distortion}set distortion(e){this.uniforms.distortion=Math.max(0,e)}get vignetteOpacity(){return this.uniforms.vignetteOpacity}set vignetteOpacity(e){this.uniforms.vignetteOpacity=Math.max(0,Math.min(1,e))}get edgeBlur(){return this.uniforms.edgeBlur}set edgeBlur(e){this.uniforms.edgeBlur=Math.max(0,Math.min(1,e))}get dimensions(){return this.uniforms.dimensions}set dimensions(e){this.uniforms.dimensions=e}get bloomSrc(){return this.uniforms.bloomSrc}set bloomSrc(e){this.uniforms.bloomSrc=e}get bloomSrcDimensions(){return this.uniforms.bloomSrcDimensions}set bloomSrcDimensions(e){this.uniforms.bloomSrcDimensions=e}},bx=Fx;var Bx=`vec2 A(vec2 B,vec4 C){B*=C.xy;B+=C.zw;return B;}vec2 D(vec2 B,vec4 C){B-=C.zw;B/=C.xy;return B;}precision highp float;
#define GLSLIFY 1
uniform sampler2D uSampler;varying vec2 vTextureCoord;uniform vec4 filterArea;uniform float distortion;uniform vec2 dimensions;const float E=3.141592653589793238462;const float F=(E*2.);void main(void){vec2 G=A(vTextureCoord,filterArea);vec2 H=G;vec2 I=vec2((dimensions.x/2.),(dimensions.y/2.));vec2 J=(G-I);float distance;vec2 K;if(distortion>0.){distance=sqrt(pow(J.x,2.)+pow(J.y,2.));float L=(F/(2.*sqrt(dot(I,I))))*(distortion/3.);float M=sqrt(dot(I,I));H=(I+(normalize(J)*tan(distance*L)*(M/tan(M*L))));}else if(distortion<0.){float L=pow(distortion,2.);float N=sqrt(pow(dimensions.x,2.)+pow(dimensions.y,2.));float O=(N/2.);float P=(G.x/dimensions.x);float Q=(G.y/dimensions.y);float R=max(dimensions.x,dimensions.y);float S=((dimensions.y/8.)*L);float T=((dimensions.x/8.)*L);float U=sin(P*E);float V=sin(Q*E);float W=(J.x/(dimensions.x/2.));float X=(J.y/(dimensions.y/2.));float Y=(S*V*W);float Z=(T*U*X);H.x+=Y;H.y+=Z;float a=(dimensions.x-(S*2.));float b=(dimensions.y-(T*2.));float c=max(max(1.,(dimensions.x/a)),max(1.,(dimensions.y/b)));vec2 d=(H-I);distance=sqrt(pow(d.x,2.)+pow(d.y,2.));float e=atan(d.y,d.x);float f=(distance/O);H=vec2((I.x+(cos(e)*((f*O)/c))),(I.y+(sin(e)*((f*O)/c))));}K=D(H,filterArea);vec4 g=texture2D(uSampler,K);gl_FragColor=g;}`;var Sx=class extends PIXI.Filter{constructor(){super(O,Bx);this.padding=0,this.distortion=1}get distortion(){return this.uniforms.distortion}set distortion(e){this.uniforms.distortion=Math.max(-1,Math.min(1,e))}get dimensions(){return this.uniforms.dimensions}set dimensions(e){this.uniforms.dimensions=e}},Ix=Sx;var _x="vec2 A(vec2 B,vec4 C){B*=C.xy;B+=C.zw;return B;}vec2 D(vec2 B,vec4 C){B-=C.zw;B/=C.xy;return B;}float E(vec3 F){return dot(F,vec3(0.299,0.587,0.114));}uniform sampler2D uSampler;varying vec2 vTextureCoord;uniform vec4 filterArea;uniform sampler2D src;uniform vec2 srcDimensions;uniform vec2 dimensions;uniform float tolerance;uniform vec3 shadowColor;uniform vec3 highlightColor;uniform bool invertColors;vec2 G(vec2 H){return vec2(floor(H.x*srcDimensions.x),floor(H.y*srcDimensions.y));}vec2 I(vec2 H){return vec2((H.x/srcDimensions.x),(H.y/srcDimensions.y));}vec4 J(vec2 H){vec2 K=I(vec2((H.x+0.),(H.y+0.)));vec2 L=I(vec2((H.x-1.),(H.y+0.)));vec2 M=I(vec2((H.x+1.),(H.y+0.)));vec2 N=I(vec2((H.x+0.),(H.y-1.)));vec2 O=I(vec2((H.x+0.),(H.y+1.)));vec4 P=texture2D(src,K);vec4 Q=texture2D(src,L);vec4 R=texture2D(src,M);vec4 S=texture2D(src,N);vec4 T=texture2D(src,O);vec4 U=((P+Q+R+S+T)/5.);return U;}float V(vec2 H){vec4 U=J(H);return E(U.rgb);}float W(vec2 X,vec2 Y,vec2 Z,float a){float b=(invertColors?0.:1.);vec2 c=(X-Y);float d=sqrt(pow(c.x,2.)+pow(c.y,2.));if(d<=a){float e=V(Z);e=invertColors?(e/2.):((1.-e)/1.5);float f=pow((a*e),1.);if(d<=f){b=(invertColors?1.:0.);}else if(d<=f+2.){float g=sqrt((d-f)/2.);b=(invertColors?(1.-g):g);}}return b;}void main(void){vec2 X=A(vTextureCoord,filterArea);X.x=floor(X.x);X.y=floor(X.y);vec2 h=(X/dimensions);vec2 Z=G(h);bool i=((mod(Z.x,2.)==0.&&mod(Z.y,2.)==0.)||(mod(Z.x,2.)!=0.&&mod(Z.y,2.)!=0.));vec2 j=vec2((dimensions.x/srcDimensions.x),(dimensions.y/srcDimensions.y));float a=(max(j.x,j.y)*(1.+tolerance));vec2 k=vec2((Z.x+0.),(Z.y+0.));vec2 l=vec2((Z.x-1.),(Z.y+0.));vec2 m=vec2((Z.x+1.),(Z.y+0.));vec2 n=vec2((Z.x+0.),(Z.y-1.));vec2 o=vec2((Z.x+0.),(Z.y+1.));if(i){l.y-=1.;m.y+=1.;n.x+=1.;o.x-=1.;}vec2 p=((I(k)*dimensions)+(j/2.));vec2 q=((I(l)*dimensions)+(j/2.));vec2 r=((I(m)*dimensions)+(j/2.));vec2 s=((I(n)*dimensions)+(j/2.));vec2 t=((I(o)*dimensions)+(j/2.));float b=(invertColors?0.:1.);if(invertColors){if(i){b=max(b,W(X,p,k,a));}b=max(b,min(1.,W(X,q,l,a)+b));b=max(b,min(1.,W(X,r,m,a)+b));b=max(b,min(1.,W(X,s,n,a)+b));b=max(b,min(1.,W(X,t,o,a)+b));}else{if(i){b=min(b,W(X,p,k,a));}b=min(b,W(X,q,l,a)*b);b=min(b,W(X,r,m,a)*b);b=min(b,W(X,s,n,a)*b);b=min(b,W(X,t,o,a)*b);}vec4 u=texture2D(uSampler,vTextureCoord);u.rgb/=u.a;vec4 v=vec4(((shadowColor.r==-1.)?(u.rgb*0.5):shadowColor),1.);vec4 w=vec4(((highlightColor.r==-1.)?(u.rgb*1.):highlightColor),1.);vec4 x=mix(v,w,b);x.rgb*=u.a;x.a=u.a;gl_FragColor=x;}";var Cx=class extends PIXI.Filter{constructor(){super(O,_x);this.padding=0}get src(){return this.uniforms.src}set src(e){this.uniforms.src=e}get srcDimensions(){return this.uniforms.srcDimensions}set srcDimensions(e){this.uniforms.srcDimensions=e}get dimensions(){return this.uniforms.dimensions}set dimensions(e){this.uniforms.dimensions=e}get tolerance(){return this.uniforms.tolerance}set tolerance(e){this.uniforms.tolerance=Math.max(0,Math.min(1,e))}get invertColors(){return this.uniforms.invertColors}set invertColors(e){this.uniforms.invertColors=!!e}get shadowColor(){return this.uniforms.shadowColor}set shadowColor(e){e==-1?e=[-1,-1,-1]:e=BFN.FilterHelper.hex2rgb(e),this.uniforms.shadowColor=e}get highlightColor(){return this.uniforms.highlightColor}set highlightColor(e){e==-1?e=[-1,-1,-1]:e=BFN.FilterHelper.hex2rgb(e),this.uniforms.highlightColor=e}},Ex=Cx;var Px=`vec2 A(vec2 B,vec4 C){B*=C.xy;B+=C.zw;return B;}vec2 D(vec2 B,vec4 C){B-=C.zw;B/=C.xy;return B;}float E(vec3 F){return dot(F,vec3(0.299,0.587,0.114));}precision highp float;
#define GLSLIFY 1
uniform sampler2D uSampler;varying vec2 vTextureCoord;uniform vec3 shadowColor;uniform vec3 midtoneColor;uniform vec3 highlightColor;uniform float shadowIntensity;uniform float midtoneIntensity;uniform float highlightIntensity;vec3 G(vec3 H,vec3 I){return vec3((H.x<=0.5)?(I.x-(1.-2.*H.x)*I.x*(1.-I.x)):(((H.x>0.5)&&(I.x<=0.25))?(I.x+(2.*H.x-1.)*(4.*I.x*(4.*I.x+1.)*(I.x-1.)+7.*I.x)):(I.x+(2.*H.x-1.)*(sqrt(I.x)-I.x))),(H.y<=0.5)?(I.y-(1.-2.*H.y)*I.y*(1.-I.y)):(((H.y>0.5)&&(I.y<=0.25))?(I.y+(2.*H.y-1.)*(4.*I.y*(4.*I.y+1.)*(I.y-1.)+7.*I.y)):(I.y+(2.*H.y-1.)*(sqrt(I.y)-I.y))),(H.z<=0.5)?(I.z-(1.-2.*H.z)*I.z*(1.-I.z)):(((H.z>0.5)&&(I.z<=0.25))?(I.z+(2.*H.z-1.)*(4.*I.z*(4.*I.z+1.)*(I.z-1.)+7.*I.z)):(I.z+(2.*H.z-1.)*(sqrt(I.z)-I.z))));}void main(void){vec4 J=texture2D(uSampler,vTextureCoord);if(J.a==0.){gl_FragColor=vec4(0,0,0,0);return;}J.rgb/=J.a;float K=E(J.rgb);vec3 L=vec3(0.5);vec3 M=mix(L,shadowColor,shadowIntensity);vec3 N=mix(L,midtoneColor,midtoneIntensity);vec3 O=mix(L,highlightColor,highlightIntensity);float P;vec3 Q;if(K<=0.5){P=(K*2.);Q=mix(M,N,P);}else{P=((K-0.5)*2.);Q=mix(N,O,P);}vec3 R=G(Q,J.rgb);vec4 S=vec4(R*J.a,J.a);gl_FragColor=S;}`;var Nx=class extends PIXI.Filter{constructor(){super(O,Px);this.padding=0}get shadowColor(){return this.uniforms.shadowColor}set shadowColor(e){e=BFN.FilterHelper.hex2rgb(e),this.uniforms.shadowColor=e}get midtoneColor(){return this.uniforms.midtoneColor}set midtoneColor(e){e=BFN.FilterHelper.hex2rgb(e),this.uniforms.midtoneColor=e}get highlightColor(){return this.uniforms.highlightColor}set highlightColor(e){e=BFN.FilterHelper.hex2rgb(e),this.uniforms.highlightColor=e}get shadowIntensity(){return this.uniforms.shadowIntensity}set shadowIntensity(e){this.uniforms.shadowIntensity=Math.max(0,Math.min(1,e))}get midtoneIntensity(){return this.uniforms.midtoneIntensity}set midtoneIntensity(e){this.uniforms.midtoneIntensity=Math.max(0,Math.min(1,e))}get highlightIntensity(){return this.uniforms.highlightIntensity}set highlightIntensity(e){this.uniforms.highlightIntensity=Math.max(0,Math.min(1,e))}},Mx=Nx;var Dx=`vec2 A(vec2 B,vec4 C){B*=C.xy;B+=C.zw;return B;}vec2 D(vec2 B,vec4 C){B-=C.zw;B/=C.xy;return B;}precision highp float;
#define GLSLIFY 1
uniform sampler2D uSampler;varying vec2 vTextureCoord;uniform vec4 filterArea;uniform float strength;uniform float phase;uniform float scale;uniform float lightness;uniform vec2 dimensions;uniform vec2 mapDimensions;const int E=63;const float F=0.01;const float G=3.141592653589793238462;const float H=(G*2.);const float I=(G/2.);const float J=(G/4.);const float K=(G/8.);const float L=1.618033988749895;const float M=(H/L);vec3 N(vec3 O,vec3 P){return(O+P)-(O*P);}vec3 Q(vec3 O,vec3 P){return O*P;}vec3 R(vec3 S){float T=4096.*sin(dot(S,vec3(17.,59.4,15.)));vec3 U;U.z=fract(512.*T);T*=.125;U.x=fract(512.*T);T*=.125;U.y=fract(512.*T);return U-0.5;}const float V=0.3333333;const float W=0.1666667;float X(vec3 Y){vec3 Z=floor(Y+dot(Y,vec3(V)));vec3 a=Y-Z+dot(Z,vec3(W));vec3 b=step(vec3(0.),a-a.yzx);vec3 c=b*(1.-b.zxy);vec3 d=1.-b.zxy*(1.-b);vec3 e=a-c+W;vec3 f=a-d+2.*W;vec3 g=a-1.+3.*W;vec4 h,i;h.x=dot(a,a);h.y=dot(e,e);h.z=dot(f,f);h.w=dot(g,g);h=max(0.6-h,0.);i.x=dot(R(Z),a);i.y=dot(R(Z+c),e);i.z=dot(R(Z+d),f);i.w=dot(R(Z+1.),g);h*=h;h*=h;i*=h;return dot(i,vec4(52.));}void main(void){float j=(((scale*2.)+1.)*5.);vec2 k=vTextureCoord;k.x*=(mapDimensions.x/mapDimensions.y);k.xy/=j;k.x+=((1.-(1./j))/2.)*(dimensions.x/mapDimensions.x);k.y+=((1.-(1./j))/2.)*(dimensions.y/mapDimensions.y);vec3 l=vec3(k,(phase*0.025));float m=X(l*32.);float n=clamp(((0.3+(m*0.7))*strength),0.,1.);vec4 o=texture2D(uSampler,vTextureCoord);vec2 p=A(vTextureCoord,filterArea);if(n>0.){float q=(sqrt(pow(dimensions.x,2.)+pow(dimensions.y,2.))*F);float r=(q*n);float s=(r/(float(E)+1.));float t=M*n*((p.y*dimensions.x)+p.x);for(int u=10;u<(E+10);u++){vec2 v=D(vec2(clamp((p.x+(cos(M*float(u)+t)*(s*float(u)))),0.,(dimensions.x-1.)),clamp((p.y+(sin(M*float(u)+t)*(s*float(u)))),0.,(dimensions.y-1.))),filterArea);o+=texture2D(uSampler,v);}o/=(float(E)+1.);if(lightness>0.){vec3 w=N(o.rgb,o.rgb);o.rgb=mix(o.rgb,w,(n*lightness));}else if(lightness<0.){vec3 x=Q(o.rgb,o.rgb);o.rgb=mix(o.rgb,x,(n*abs(lightness)));}}gl_FragColor=o;}`;var wx=class extends PIXI.Filter{constructor(){super(O,Dx);this.padding=0}get strength(){return this.uniforms.strength}set strength(e){this.uniforms.strength=e}get phase(){return this.uniforms.phase}set phase(e){this.uniforms.phase=e}get scale(){return this.uniforms.scale}set scale(e){this.uniforms.scale=Math.max(0,Math.min(1,e))}get lightness(){return this.uniforms.lightness}set lightness(e){this.uniforms.lightness=Math.max(-1,Math.min(1,e))}get dimensions(){return this.uniforms.dimensions}set dimensions(e){this.uniforms.dimensions=e}get mapDimensions(){return this.uniforms.mapDimensions}set mapDimensions(e){this.uniforms.mapDimensions=e}},kx=wx;var Ax="const float A=9.;const int B=9;const int C=18;const int D=27;const int E=27;const int F=(B+C+D+E);const float G=3.141592653589793238462;const float H=(G*2.);const float I=(G/2.);const float J=(G/3.);const float K=1.;const float L=1.;const float M=50.;const float N=4.;const float O=20.;const float P=3.;const float Q=8.5;const float R=2.;uniform sampler2D uSampler;varying vec2 vTextureCoord;uniform vec4 filterArea;uniform float currentPass;uniform float radius;uniform float aperture;uniform vec2 dimensions;uniform sampler2D maskTexture;uniform int maskTextureInverted;vec2 S(vec2 T,vec4 U){T*=U.xy;T+=U.zw;return T;}vec2 V(vec2 T,vec4 U){T-=U.zw;T/=U.xy;return T;}vec2 W(vec2 X,float Y,float Z,float a){float b=(Z/A);float c=floor(Y/b);float d=(((H/A)*aperture)+I);float e=((H*(c/A))+d);float f=((H*((c+1.)/A))+d);vec2 g=vec2((X.x+(cos(e)*a)),(X.y+(sin(e)*a)));vec2 h=vec2((X.x+(cos(f)*a)),(X.y+(sin(f)*a)));float i=(((Y/Z)*H)+d);vec2 j=mix(g,h,(mod(Y,b)/b));vec2 k=vec2((X.x+(cos(i)*a)),(X.y+(sin(i)*a)));vec2 l=mix(j,k,aperture);return l;}vec3 m(int Y,int B,int C,int D,int E,float radius){if(Y<B){return vec3(float(Y),float(B),(radius*1.));}else if(Y<(B+C)){return vec3(float(Y-B),float(C),(radius*2.));}else if(Y<(B+C+D)){return vec3(float(Y-B-C),float(D),(radius*3.));}else if(Y<(B+C+D+E)){return vec3(float(Y-B-C-D),float(E),(radius*4.));}return vec3(0.);}int n(float o){int p=F;if(o<4.)p-=E;if(o<3.)p-=D;if(o<2.)p-=C;return p;}vec3 q(vec2 X,float o,float r){vec3 s=texture2D(uSampler,V(X,filterArea)).rgb;float t=cos(G/A)*r;r-=(((r-t)/2.)*aperture);vec3 u=vec3(0.);vec3 v=vec3(0.);vec3 w=pow(s,vec3(4.));u+=(s*w);v+=w;float x=((radius*r)/o);int y=0;vec3 z;int p=n(o);for(int AA=0;AA<F;AA++){if(y<p){z=m(AA,B,C,D,E,x);y++;vec2 l=W(X,z.x,z.y,z.z);if(l.x>=1.&&l.x<dimensions.x&&l.y>=1.&&l.y<dimensions.y){vec3 s=texture2D(uSampler,V(l,filterArea)).rgb;vec3 w=pow(s,vec3(4.));u+=(s*w);v+=w;}}}return(u/v);}void main(void){vec2 X=S(vTextureCoord,filterArea);vec4 AB=texture2D(uSampler,vTextureCoord);vec2 AC=clamp((X/dimensions),0.,1.);vec4 AD=texture2D(maskTexture,AC);float AE=pow(((maskTextureInverted==1)?AD.a:(1.-AD.a)),3.);if(currentPass==0.){AB.rgb=q(X,L,(K*AE));}else if(currentPass==1.){AB.rgb=q(X,N,(M*AE));}else if(currentPass==2.){AB.rgb=q(X,P,(O*AE));}else if(currentPass==3.){AB.rgb=q(X,R,(Q*AE));}gl_FragColor=AB;}";var Ox="const float A=8.;const int B=8;const int C=16;const int D=24;const int E=24;const int F=(B+C+D+E);const float G=3.141592653589793238462;const float H=(G*2.);const float I=(G/2.);const float J=(G/3.);const float K=1.;const float L=1.;const float M=50.;const float N=4.;const float O=20.;const float P=3.;const float Q=8.5;const float R=2.;uniform sampler2D uSampler;varying vec2 vTextureCoord;uniform vec4 filterArea;uniform float currentPass;uniform float radius;uniform float aperture;uniform vec2 dimensions;uniform sampler2D maskTexture;uniform int maskTextureInverted;vec2 S(vec2 T,vec4 U){T*=U.xy;T+=U.zw;return T;}vec2 V(vec2 T,vec4 U){T-=U.zw;T/=U.xy;return T;}vec2 W(vec2 X,float Y,float Z,float a){float b=(Z/A);float c=floor(Y/b);float d=(((H/A)*aperture)+I);float e=((H*(c/A))+d);float f=((H*((c+1.)/A))+d);vec2 g=vec2((X.x+(cos(e)*a)),(X.y+(sin(e)*a)));vec2 h=vec2((X.x+(cos(f)*a)),(X.y+(sin(f)*a)));float i=(((Y/Z)*H)+d);vec2 j=mix(g,h,(mod(Y,b)/b));vec2 k=vec2((X.x+(cos(i)*a)),(X.y+(sin(i)*a)));vec2 l=mix(j,k,aperture);return l;}vec3 m(int Y,int B,int C,int D,int E,float radius){if(Y<B){return vec3(float(Y),float(B),(radius*1.));}else if(Y<(B+C)){return vec3(float(Y-B),float(C),(radius*2.));}else if(Y<(B+C+D)){return vec3(float(Y-B-C),float(D),(radius*3.));}else if(Y<(B+C+D+E)){return vec3(float(Y-B-C-D),float(E),(radius*4.));}return vec3(0.);}int n(float o){int p=F;if(o<4.)p-=E;if(o<3.)p-=D;if(o<2.)p-=C;return p;}vec3 q(vec2 X,float o,float r){vec3 s=texture2D(uSampler,V(X,filterArea)).rgb;float t=cos(G/A)*r;r-=(((r-t)/2.)*aperture);vec3 u=vec3(0.);vec3 v=vec3(0.);vec3 w=pow(s,vec3(4.));u+=(s*w);v+=w;float x=((radius*r)/o);int y=0;vec3 z;int p=n(o);for(int AA=0;AA<F;AA++){if(y<p){z=m(AA,B,C,D,E,x);y++;vec2 l=W(X,z.x,z.y,z.z);if(l.x>=1.&&l.x<dimensions.x&&l.y>=1.&&l.y<dimensions.y){vec3 s=texture2D(uSampler,V(l,filterArea)).rgb;vec3 w=pow(s,vec3(4.));u+=(s*w);v+=w;}}}return(u/v);}void main(void){vec2 X=S(vTextureCoord,filterArea);vec4 AB=texture2D(uSampler,vTextureCoord);vec2 AC=clamp((X/dimensions),0.,1.);vec4 AD=texture2D(maskTexture,AC);float AE=pow(((maskTextureInverted==1)?AD.a:(1.-AD.a)),3.);if(currentPass==0.){AB.rgb=q(X,L,(K*AE));}else if(currentPass==1.){AB.rgb=q(X,N,(M*AE));}else if(currentPass==2.){AB.rgb=q(X,P,(O*AE));}else if(currentPass==3.){AB.rgb=q(X,R,(Q*AE));}gl_FragColor=AB;}";var Rx="const float A=7.;const int B=7;const int C=14;const int D=21;const int E=21;const int F=(B+C+D+E);const float G=3.141592653589793238462;const float H=(G*2.);const float I=(G/2.);const float J=(G/3.);const float K=1.;const float L=1.;const float M=50.;const float N=4.;const float O=20.;const float P=3.;const float Q=8.5;const float R=2.;uniform sampler2D uSampler;varying vec2 vTextureCoord;uniform vec4 filterArea;uniform float currentPass;uniform float radius;uniform float aperture;uniform vec2 dimensions;uniform sampler2D maskTexture;uniform int maskTextureInverted;vec2 S(vec2 T,vec4 U){T*=U.xy;T+=U.zw;return T;}vec2 V(vec2 T,vec4 U){T-=U.zw;T/=U.xy;return T;}vec2 W(vec2 X,float Y,float Z,float a){float b=(Z/A);float c=floor(Y/b);float d=(((H/A)*aperture)+I);float e=((H*(c/A))+d);float f=((H*((c+1.)/A))+d);vec2 g=vec2((X.x+(cos(e)*a)),(X.y+(sin(e)*a)));vec2 h=vec2((X.x+(cos(f)*a)),(X.y+(sin(f)*a)));float i=(((Y/Z)*H)+d);vec2 j=mix(g,h,(mod(Y,b)/b));vec2 k=vec2((X.x+(cos(i)*a)),(X.y+(sin(i)*a)));vec2 l=mix(j,k,aperture);return l;}vec3 m(int Y,int B,int C,int D,int E,float radius){if(Y<B){return vec3(float(Y),float(B),(radius*1.));}else if(Y<(B+C)){return vec3(float(Y-B),float(C),(radius*2.));}else if(Y<(B+C+D)){return vec3(float(Y-B-C),float(D),(radius*3.));}else if(Y<(B+C+D+E)){return vec3(float(Y-B-C-D),float(E),(radius*4.));}return vec3(0.);}int n(float o){int p=F;if(o<4.)p-=E;if(o<3.)p-=D;if(o<2.)p-=C;return p;}vec3 q(vec2 X,float o,float r){vec3 s=texture2D(uSampler,V(X,filterArea)).rgb;float t=cos(G/A)*r;r-=(((r-t)/2.)*aperture);vec3 u=vec3(0.);vec3 v=vec3(0.);vec3 w=pow(s,vec3(4.));u+=(s*w);v+=w;float x=((radius*r)/o);int y=0;vec3 z;int p=n(o);for(int AA=0;AA<F;AA++){if(y<p){z=m(AA,B,C,D,E,x);y++;vec2 l=W(X,z.x,z.y,z.z);if(l.x>=1.&&l.x<dimensions.x&&l.y>=1.&&l.y<dimensions.y){vec3 s=texture2D(uSampler,V(l,filterArea)).rgb;vec3 w=pow(s,vec3(4.));u+=(s*w);v+=w;}}}return(u/v);}void main(void){vec2 X=S(vTextureCoord,filterArea);vec4 AB=texture2D(uSampler,vTextureCoord);vec2 AC=clamp((X/dimensions),0.,1.);vec4 AD=texture2D(maskTexture,AC);float AE=pow(((maskTextureInverted==1)?AD.a:(1.-AD.a)),3.);if(currentPass==0.){AB.rgb=q(X,L,(K*AE));}else if(currentPass==1.){AB.rgb=q(X,N,(M*AE));}else if(currentPass==2.){AB.rgb=q(X,P,(O*AE));}else if(currentPass==3.){AB.rgb=q(X,R,(Q*AE));}gl_FragColor=AB;}";var Lx="const float A=6.;const int B=6;const int C=12;const int D=18;const int E=24;const int F=(B+C+D+E);const float G=3.141592653589793238462;const float H=(G*2.);const float I=(G/2.);const float J=(G/3.);const float K=1.;const float L=1.;const float M=50.;const float N=4.;const float O=20.;const float P=3.;const float Q=8.5;const float R=2.;uniform sampler2D uSampler;varying vec2 vTextureCoord;uniform vec4 filterArea;uniform float currentPass;uniform float radius;uniform float aperture;uniform vec2 dimensions;uniform sampler2D maskTexture;uniform int maskTextureInverted;vec2 S(vec2 T,vec4 U){T*=U.xy;T+=U.zw;return T;}vec2 V(vec2 T,vec4 U){T-=U.zw;T/=U.xy;return T;}vec2 W(vec2 X,float Y,float Z,float a){float b=(Z/A);float c=floor(Y/b);float d=(((H/A)*aperture)+I);float e=((H*(c/A))+d);float f=((H*((c+1.)/A))+d);vec2 g=vec2((X.x+(cos(e)*a)),(X.y+(sin(e)*a)));vec2 h=vec2((X.x+(cos(f)*a)),(X.y+(sin(f)*a)));float i=(((Y/Z)*H)+d);vec2 j=mix(g,h,(mod(Y,b)/b));vec2 k=vec2((X.x+(cos(i)*a)),(X.y+(sin(i)*a)));vec2 l=mix(j,k,aperture);return l;}vec3 m(int Y,int B,int C,int D,int E,float radius){if(Y<B){return vec3(float(Y),float(B),(radius*1.));}else if(Y<(B+C)){return vec3(float(Y-B),float(C),(radius*2.));}else if(Y<(B+C+D)){return vec3(float(Y-B-C),float(D),(radius*3.));}else if(Y<(B+C+D+E)){return vec3(float(Y-B-C-D),float(E),(radius*4.));}return vec3(0.);}int n(float o){int p=F;if(o<4.)p-=E;if(o<3.)p-=D;if(o<2.)p-=C;return p;}vec3 q(vec2 X,float o,float r){vec3 s=texture2D(uSampler,V(X,filterArea)).rgb;float t=cos(G/A)*r;r-=(((r-t)/2.)*aperture);vec3 u=vec3(0.);vec3 v=vec3(0.);vec3 w=pow(s,vec3(4.));u+=(s*w);v+=w;float x=((radius*r)/o);int y=0;vec3 z;int p=n(o);for(int AA=0;AA<F;AA++){if(y<p){z=m(AA,B,C,D,E,x);y++;vec2 l=W(X,z.x,z.y,z.z);if(l.x>=1.&&l.x<dimensions.x&&l.y>=1.&&l.y<dimensions.y){vec3 s=texture2D(uSampler,V(l,filterArea)).rgb;vec3 w=pow(s,vec3(4.));u+=(s*w);v+=w;}}}return(u/v);}void main(void){vec2 X=S(vTextureCoord,filterArea);vec4 AB=texture2D(uSampler,vTextureCoord);vec2 AC=clamp((X/dimensions),0.,1.);vec4 AD=texture2D(maskTexture,AC);float AE=pow(((maskTextureInverted==1)?AD.a:(1.-AD.a)),3.);if(currentPass==0.){AB.rgb=q(X,L,(K*AE));}else if(currentPass==1.){AB.rgb=q(X,N,(M*AE));}else if(currentPass==2.){AB.rgb=q(X,P,(O*AE));}else if(currentPass==3.){AB.rgb=q(X,R,(Q*AE));}gl_FragColor=AB;}";var Vx="const float A=5.;const int B=5;const int C=10;const int D=15;const int E=25;const int F=(B+C+D+E);const float G=3.141592653589793238462;const float H=(G*2.);const float I=(G/2.);const float J=(G/3.);const float K=1.;const float L=1.;const float M=50.;const float N=4.;const float O=20.;const float P=3.;const float Q=8.5;const float R=2.;uniform sampler2D uSampler;varying vec2 vTextureCoord;uniform vec4 filterArea;uniform float currentPass;uniform float radius;uniform float aperture;uniform vec2 dimensions;uniform sampler2D maskTexture;uniform int maskTextureInverted;vec2 S(vec2 T,vec4 U){T*=U.xy;T+=U.zw;return T;}vec2 V(vec2 T,vec4 U){T-=U.zw;T/=U.xy;return T;}vec2 W(vec2 X,float Y,float Z,float a){float b=(Z/A);float c=floor(Y/b);float d=(((H/A)*aperture)+I);float e=((H*(c/A))+d);float f=((H*((c+1.)/A))+d);vec2 g=vec2((X.x+(cos(e)*a)),(X.y+(sin(e)*a)));vec2 h=vec2((X.x+(cos(f)*a)),(X.y+(sin(f)*a)));float i=(((Y/Z)*H)+d);vec2 j=mix(g,h,(mod(Y,b)/b));vec2 k=vec2((X.x+(cos(i)*a)),(X.y+(sin(i)*a)));vec2 l=mix(j,k,aperture);return l;}vec3 m(int Y,int B,int C,int D,int E,float radius){if(Y<B){return vec3(float(Y),float(B),(radius*1.));}else if(Y<(B+C)){return vec3(float(Y-B),float(C),(radius*2.));}else if(Y<(B+C+D)){return vec3(float(Y-B-C),float(D),(radius*3.));}else if(Y<(B+C+D+E)){return vec3(float(Y-B-C-D),float(E),(radius*4.));}return vec3(0.);}int n(float o){int p=F;if(o<4.)p-=E;if(o<3.)p-=D;if(o<2.)p-=C;return p;}vec3 q(vec2 X,float o,float r){vec3 s=texture2D(uSampler,V(X,filterArea)).rgb;float t=cos(G/A)*r;r-=(((r-t)/2.)*aperture);vec3 u=vec3(0.);vec3 v=vec3(0.);vec3 w=pow(s,vec3(4.));u+=(s*w);v+=w;float x=((radius*r)/o);int y=0;vec3 z;int p=n(o);for(int AA=0;AA<F;AA++){if(y<p){z=m(AA,B,C,D,E,x);y++;vec2 l=W(X,z.x,z.y,z.z);if(l.x>=1.&&l.x<dimensions.x&&l.y>=1.&&l.y<dimensions.y){vec3 s=texture2D(uSampler,V(l,filterArea)).rgb;vec3 w=pow(s,vec3(4.));u+=(s*w);v+=w;}}}return(u/v);}void main(void){vec2 X=S(vTextureCoord,filterArea);vec4 AB=texture2D(uSampler,vTextureCoord);vec2 AC=clamp((X/dimensions),0.,1.);vec4 AD=texture2D(maskTexture,AC);float AE=pow(((maskTextureInverted==1)?AD.a:(1.-AD.a)),3.);if(currentPass==0.){AB.rgb=q(X,L,(K*AE));}else if(currentPass==1.){AB.rgb=q(X,N,(M*AE));}else if(currentPass==2.){AB.rgb=q(X,P,(O*AE));}else if(currentPass==3.){AB.rgb=q(X,R,(Q*AE));}gl_FragColor=AB;}";var Ux="const float A=4.;const int B=8;const int C=16;const int D=16;const int E=24;const int F=(B+C+D+E);const float G=3.141592653589793238462;const float H=(G*2.);const float I=(G/2.);const float J=(G/3.);const float K=1.;const float L=1.;const float M=50.;const float N=4.;const float O=20.;const float P=3.;const float Q=8.5;const float R=2.;uniform sampler2D uSampler;varying vec2 vTextureCoord;uniform vec4 filterArea;uniform float currentPass;uniform float radius;uniform float aperture;uniform vec2 dimensions;uniform sampler2D maskTexture;uniform int maskTextureInverted;vec2 S(vec2 T,vec4 U){T*=U.xy;T+=U.zw;return T;}vec2 V(vec2 T,vec4 U){T-=U.zw;T/=U.xy;return T;}vec2 W(vec2 X,float Y,float Z,float a){float b=(Z/A);float c=floor(Y/b);float d=(((H/A)*aperture)+I);float e=((H*(c/A))+d);float f=((H*((c+1.)/A))+d);vec2 g=vec2((X.x+(cos(e)*a)),(X.y+(sin(e)*a)));vec2 h=vec2((X.x+(cos(f)*a)),(X.y+(sin(f)*a)));float i=(((Y/Z)*H)+d);vec2 j=mix(g,h,(mod(Y,b)/b));vec2 k=vec2((X.x+(cos(i)*a)),(X.y+(sin(i)*a)));vec2 l=mix(j,k,aperture);return l;}vec3 m(int Y,int B,int C,int D,int E,float radius){if(Y<B){return vec3(float(Y),float(B),(radius*1.));}else if(Y<(B+C)){return vec3(float(Y-B),float(C),(radius*2.));}else if(Y<(B+C+D)){return vec3(float(Y-B-C),float(D),(radius*3.));}else if(Y<(B+C+D+E)){return vec3(float(Y-B-C-D),float(E),(radius*4.));}return vec3(0.);}int n(float o){int p=F;if(o<4.)p-=E;if(o<3.)p-=D;if(o<2.)p-=C;return p;}vec3 q(vec2 X,float o,float r){vec3 s=texture2D(uSampler,V(X,filterArea)).rgb;float t=cos(G/A)*r;r-=(((r-t)/2.)*aperture);vec3 u=vec3(0.);vec3 v=vec3(0.);vec3 w=pow(s,vec3(4.));u+=(s*w);v+=w;float x=((radius*r)/o);int y=0;vec3 z;int p=n(o);for(int AA=0;AA<F;AA++){if(y<p){z=m(AA,B,C,D,E,x);y++;vec2 l=W(X,z.x,z.y,z.z);if(l.x>=1.&&l.x<dimensions.x&&l.y>=1.&&l.y<dimensions.y){vec3 s=texture2D(uSampler,V(l,filterArea)).rgb;vec3 w=pow(s,vec3(4.));u+=(s*w);v+=w;}}}return(u/v);}void main(void){vec2 X=S(vTextureCoord,filterArea);vec4 AB=texture2D(uSampler,vTextureCoord);vec2 AC=clamp((X/dimensions),0.,1.);vec4 AD=texture2D(maskTexture,AC);float AE=pow(((maskTextureInverted==1)?AD.a:(1.-AD.a)),3.);if(currentPass==0.){AB.rgb=q(X,L,(K*AE));}else if(currentPass==1.){AB.rgb=q(X,N,(M*AE));}else if(currentPass==2.){AB.rgb=q(X,P,(O*AE));}else if(currentPass==3.){AB.rgb=q(X,R,(Q*AE));}gl_FragColor=AB;}";var Gx="const float A=3.;const int B=6;const int C=9;const int D=15;const int E=24;const int F=(B+C+D+E);const float G=3.141592653589793238462;const float H=(G*2.);const float I=(G/2.);const float J=(G/3.);const float K=1.;const float L=1.;const float M=50.;const float N=4.;const float O=20.;const float P=3.;const float Q=8.5;const float R=2.;uniform sampler2D uSampler;varying vec2 vTextureCoord;uniform vec4 filterArea;uniform float currentPass;uniform float radius;uniform float aperture;uniform vec2 dimensions;uniform sampler2D maskTexture;uniform int maskTextureInverted;vec2 S(vec2 T,vec4 U){T*=U.xy;T+=U.zw;return T;}vec2 V(vec2 T,vec4 U){T-=U.zw;T/=U.xy;return T;}vec2 W(vec2 X,float Y,float Z,float a){float b=(Z/A);float c=floor(Y/b);float d=(((H/A)*aperture)+I);float e=((H*(c/A))+d);float f=((H*((c+1.)/A))+d);vec2 g=vec2((X.x+(cos(e)*a)),(X.y+(sin(e)*a)));vec2 h=vec2((X.x+(cos(f)*a)),(X.y+(sin(f)*a)));float i=(((Y/Z)*H)+d);vec2 j=mix(g,h,(mod(Y,b)/b));vec2 k=vec2((X.x+(cos(i)*a)),(X.y+(sin(i)*a)));vec2 l=mix(j,k,aperture);return l;}vec3 m(int Y,int B,int C,int D,int E,float radius){if(Y<B){return vec3(float(Y),float(B),(radius*1.));}else if(Y<(B+C)){return vec3(float(Y-B),float(C),(radius*2.));}else if(Y<(B+C+D)){return vec3(float(Y-B-C),float(D),(radius*3.));}else if(Y<(B+C+D+E)){return vec3(float(Y-B-C-D),float(E),(radius*4.));}return vec3(0.);}int n(float o){int p=F;if(o<4.)p-=E;if(o<3.)p-=D;if(o<2.)p-=C;return p;}vec3 q(vec2 X,float o,float r){vec3 s=texture2D(uSampler,V(X,filterArea)).rgb;float t=cos(G/A)*r;r-=(((r-t)/2.)*aperture);vec3 u=vec3(0.);vec3 v=vec3(0.);vec3 w=pow(s,vec3(4.));u+=(s*w);v+=w;float x=((radius*r)/o);int y=0;vec3 z;int p=n(o);for(int AA=0;AA<F;AA++){if(y<p){z=m(AA,B,C,D,E,x);y++;vec2 l=W(X,z.x,z.y,z.z);if(l.x>=1.&&l.x<dimensions.x&&l.y>=1.&&l.y<dimensions.y){vec3 s=texture2D(uSampler,V(l,filterArea)).rgb;vec3 w=pow(s,vec3(4.));u+=(s*w);v+=w;}}}return(u/v);}void main(void){vec2 X=S(vTextureCoord,filterArea);vec4 AB=texture2D(uSampler,vTextureCoord);vec2 AC=clamp((X/dimensions),0.,1.);vec4 AD=texture2D(maskTexture,AC);float AE=pow(((maskTextureInverted==1)?AD.a:(1.-AD.a)),3.);if(currentPass==0.){AB.rgb=q(X,L,(K*AE));}else if(currentPass==1.){AB.rgb=q(X,N,(M*AE));}else if(currentPass==2.){AB.rgb=q(X,P,(O*AE));}else if(currentPass==3.){AB.rgb=q(X,R,(Q*AE));}gl_FragColor=AB;}";var Hx="vec2 A(vec2 B,vec4 C){B*=C.xy;B+=C.zw;return B;}vec2 D(vec2 B,vec4 C){B-=C.zw;B/=C.xy;return B;}uniform sampler2D uSampler;varying vec2 vTextureCoord;uniform vec4 filterArea;uniform float radius;uniform float aperture;uniform float bladeCount;uniform vec2 dimensions;uniform sampler2D maskTexture;uniform int maskTextureInverted;uniform float currentPass;const float E=3.141592653589793238462;const float F=(E*2.);const float G=(E/2.);const float H=(E/3.);uniform float pass1Radius;uniform float pass1Layers;uniform float pass2Radius;uniform float pass2Layers;uniform float pass3Radius;uniform float pass3Layers;uniform float pass4Radius;uniform float pass4Layers;const int I=6;const int J=9;const int K=15;const int L=24;const int M=(I+J+K+L);const int N=8;const int O=16;const int P=16;const int Q=24;const int R=(N+O+P+Q);const int S=5;const int T=10;const int U=15;const int V=25;const int W=(S+T+U+V);const int X=6;const int Y=12;const int Z=18;const int a=24;const int b=(X+Y+Z+a);const int c=7;const int d=14;const int e=21;const int f=21;const int g=(c+d+e+f);const int h=8;const int i=16;const int j=24;const int k=24;const int l=(h+i+j+k);const int m=9;const int n=18;const int o=27;const int p=27;const int q=(m+n+o+p);vec2 r(vec2 s,float t,float u,float v){float w=(u/bladeCount);float x=floor(t/w);float y=(((F/bladeCount)*aperture)+G);float z=((F*(x/bladeCount))+y);float AA=((F*((x+1.)/bladeCount))+y);vec2 AB=vec2((s.x+(cos(z)*v)),(s.y+(sin(z)*v)));vec2 AC=vec2((s.x+(cos(AA)*v)),(s.y+(sin(AA)*v)));float AD=(((t/u)*F)+y);vec2 AE=mix(AB,AC,(mod(t,w)/w));vec2 AF=vec2((s.x+(cos(AD)*v)),(s.y+(sin(AD)*v)));vec2 AG=mix(AE,AF,aperture);return AG;}vec3 AH(int t,int AI,int AJ,int AK,int AL,float radius){vec3 AM=vec3(0.);if(t<AI){AM.x=float(t);AM.y=float(AI);AM.z=(radius*1.);}else if(t<(AI+AJ)){AM.x=float(t-AI);AM.y=float(AJ);AM.z=(radius*2.);}else if(t<(AI+AJ+AK)){AM.x=float(t-AI-AJ);AM.y=float(AK);AM.z=(radius*3.);}else if(t<(AI+AJ+AK+AL)){AM.x=float(t-AI-AJ-AK);AM.y=float(AL);AM.z=(radius*4.);}return AM;}int AN(float AO){int AP=0;if(bladeCount==3.){AP=M;if(AO<4.)AP-=L;if(AO<3.)AP-=K;if(AO<2.)AP-=J;}if(bladeCount==4.){AP=R;if(AO<4.)AP-=Q;if(AO<3.)AP-=P;if(AO<2.)AP-=O;}if(bladeCount==5.){AP=W;if(AO<4.)AP-=V;if(AO<3.)AP-=U;if(AO<2.)AP-=T;}if(bladeCount==6.){AP=b;if(AO<4.)AP-=a;if(AO<3.)AP-=Z;if(AO<2.)AP-=Y;}if(bladeCount==7.){AP=g;if(AO<4.)AP-=f;if(AO<3.)AP-=e;if(AO<2.)AP-=d;}if(bladeCount==8.){AP=l;if(AO<4.)AP-=k;if(AO<3.)AP-=j;if(AO<2.)AP-=i;}if(bladeCount==9.){AP=q;if(AO<4.)AP-=p;if(AO<3.)AP-=o;if(AO<2.)AP-=n;}return AP;}vec3 AQ(vec2 s,float AO,float AR){vec3 AS=texture2D(uSampler,D(s,filterArea)).rgb;float AT=cos(E/bladeCount)*AR;AR-=(((AR-AT)/2.)*aperture);vec3 AU=vec3(0.);vec3 AV=vec3(0.);vec3 AW=pow(AS,vec3(4.));AU+=(AS*AW);AV+=AW;float AX=((radius*AR)/AO);const int AY=q;int AZ=0;vec3 AM;int AP=AN(AO);for(int Aa=0;Aa<AY;Aa++){int Ab=0;if(bladeCount==3.&&AZ<AP){AM=AH(Aa,I,J,K,L,AX);Ab=1;AZ++;}if(bladeCount==4.&&AZ<AP){AM=AH(Aa,N,O,P,Q,AX);Ab=1;AZ++;}if(bladeCount==5.&&AZ<AP){AM=AH(Aa,S,T,U,V,AX);Ab=1;AZ++;}if(bladeCount==6.&&AZ<AP){AM=AH(Aa,X,Y,Z,a,AX);Ab=1;AZ++;}if(bladeCount==7.&&AZ<AP){AM=AH(Aa,c,d,e,f,AX);Ab=1;AZ++;}if(bladeCount==8.&&AZ<AP){AM=AH(Aa,h,i,j,k,AX);Ab=1;AZ++;}if(bladeCount==9.&&AZ<AP){AM=AH(Aa,m,n,o,p,AX);Ab=1;AZ++;}if(Ab==1){vec2 AG=r(s,AM.x,AM.y,AM.z);if(AG.x>=1.&&AG.x<dimensions.x&&AG.y>=1.&&AG.y<dimensions.y){vec3 AS=texture2D(uSampler,D(AG,filterArea)).rgb;vec3 AW=pow(AS,vec3(4.));AU+=(AS*AW);AV+=AW;}}}return(AU/AV);}void main(void){vec2 s=A(vTextureCoord,filterArea);vec4 Ac=texture2D(uSampler,vTextureCoord);vec2 Ad=clamp((s/dimensions),0.,1.);vec4 Ae=texture2D(maskTexture,Ad);float Af=pow(((maskTextureInverted==1)?Ae.a:(1.-Ae.a)),3.);if(currentPass==0.){Ac.rgb=AQ(s,pass1Layers,(pass1Radius*Af));}else if(currentPass==1.){Ac.rgb=AQ(s,pass2Layers,(pass2Radius*Af));}else if(currentPass==2.){Ac.rgb=AQ(s,pass3Layers,(pass3Radius*Af));}else if(currentPass==3.){Ac.rgb=AQ(s,pass4Layers,(pass4Radius*Af));}gl_FragColor=Ac;}";var Xx=class extends PIXI.Filter{constructor(e=""){if(["","X3","X4","X5","X6","X7","X8","X9"].includes(e)){switch(e){case"":super(O,Hx);break;case"X3":super(O,Gx);break;case"X4":super(O,Ux);break;case"X5":super(O,Vx);break;case"X6":super(O,Lx);break;case"X7":super(O,Rx);break;case"X8":super(O,Ox);break;case"X9":super(O,Ax);break}let r;BFN.Stage.filterManager.shaderCache[this.glShaderKey]||(r=new PIXI.Shader(BFN.Stage.gl,this.vertexSrc,this.fragmentSrc),this.glShaders[BFN.Stage.CONTEXT_UID]=BFN.Stage.filterManager.shaderCache[this.glShaderKey]=r),this.variation=e,this.padding=0,this.resolution=1,this.radius=1,this.aperture=0,this.bladeCount=6,this.dimensions=[0,0]}else throw new Error("Bokeh Blur Filter Variation Does Not Exist: "+e)}get amount(){return this.uniforms.radius}set amount(e){this.uniforms.radius=Math.max(0,Math.min(1,e))}get aperture(){return this.uniforms.aperture}set aperture(e){this.uniforms.aperture=Math.max(0,Math.min(1,e))}get bladeCount(){return this.variation===""?this.uniforms.bladeCount:parseInt(this.variation.replace("X",""))}set bladeCount(e){this.variation===""&&(this.uniforms.bladeCount=Math.max(3,Math.min(9,Math.round(e))))}get dimensions(){return this.uniforms.dimensions}set dimensions(e){this.uniforms.dimensions=e}get maskTexture(){return this.uniforms.maskTexture}set maskTexture(e){this.uniforms.maskTexture=e}get maskTextureInverted(){return!!this.uniforms.maskTextureInverted}set maskTextureInverted(e){this.uniforms.maskTextureInverted=e?1:0}get currentPass(){return this.uniforms.currentPass}set currentPass(e){this.uniforms.currentPass=Math.round(Math.max(0,Math.min(3,e)))}},zx=Xx;var Wx="vec2 A(vec2 B,vec4 C){B*=C.xy;B+=C.zw;return B;}vec2 D(vec2 B,vec4 C){B-=C.zw;B/=C.xy;return B;}uniform sampler2D uSampler;varying vec2 vTextureCoord;uniform vec4 filterArea;uniform vec2 dimensions;uniform sampler2D maskTexture;uniform int maskTextureInverted;uniform float padding;uniform float spreadAmount;uniform int horizontal;const float E=0.22;const float F=0.18;const float G=0.13;const float H=0.08;vec2 I(vec2 J){return clamp(J,vec2(padding),(dimensions-vec2(padding)));}void main(void){vec2 J=I(A(vTextureCoord,filterArea));vec4 K=texture2D(uSampler,D(J,filterArea));if(K.a==0.){gl_FragColor=vec4(0.);return;}vec4 L=texture2D(maskTexture,(J/dimensions));if((L.a==1.&&(maskTextureInverted==0))||(L.a==0.&&(maskTextureInverted==1))){gl_FragColor=K;return;}float M=(spreadAmount*((maskTextureInverted==1)?L.a:(1.-L.a)));vec2 N=(J-vec2(((horizontal==1)?(M*(1./3.)):0.),((horizontal==1)?0.:(M*(1./3.)))));vec2 O=(J-vec2(((horizontal==1)?(M*(2./3.)):0.),((horizontal==1)?0.:(M*(2./3.)))));vec2 P=(J-vec2(((horizontal==1)?(M*(3./3.)):0.),((horizontal==1)?0.:(M*(3./3.)))));vec2 Q=(J+vec2(((horizontal==1)?(M*(1./3.)):0.),((horizontal==1)?0.:(M*(1./3.)))));vec2 R=(J+vec2(((horizontal==1)?(M*(2./3.)):0.),((horizontal==1)?0.:(M*(2./3.)))));vec2 S=(J+vec2(((horizontal==1)?(M*(3./3.)):0.),((horizontal==1)?0.:(M*(3./3.)))));vec4 T=texture2D(maskTexture,(N/dimensions));vec4 U=texture2D(maskTexture,(O/dimensions));vec4 V=texture2D(maskTexture,(P/dimensions));vec4 W=texture2D(maskTexture,(Q/dimensions));vec4 X=texture2D(maskTexture,(R/dimensions));vec4 Y=texture2D(maskTexture,(S/dimensions));vec4 Z=texture2D(uSampler,D(I(N),filterArea));vec4 a=texture2D(uSampler,D(I(O),filterArea));vec4 b=texture2D(uSampler,D(I(P),filterArea));vec4 c=texture2D(uSampler,D(I(Q),filterArea));vec4 d=texture2D(uSampler,D(I(R),filterArea));vec4 e=texture2D(uSampler,D(I(S),filterArea));Z=mix(Z,K,((maskTextureInverted==1)?(1.-T.a):T.a));a=mix(a,Z,((maskTextureInverted==1)?(1.-U.a):U.a));b=mix(b,a,((maskTextureInverted==1)?(1.-V.a):V.a));c=mix(c,K,((maskTextureInverted==1)?(1.-W.a):W.a));d=mix(d,c,((maskTextureInverted==1)?(1.-X.a):X.a));e=mix(e,d,((maskTextureInverted==1)?(1.-Y.a):Y.a));K*=E;Z*=F;a*=G;b*=H;c*=F;d*=G;e*=H;vec4 f=(K+Z+a+b+c+d+e);gl_FragColor=f;}";var $x=class extends PIXI.Filter{constructor(){super(O,Wx);let e;BFN.Stage.filterManager.shaderCache[this.glShaderKey]||(e=new PIXI.Shader(BFN.Stage.gl,this.vertexSrc,this.fragmentSrc),this.glShaders[BFN.Stage.CONTEXT_UID]=BFN.Stage.filterManager.shaderCache[this.glShaderKey]=e),this.amount=1,this._maxSpread=1,this.plainFilter=new BFN.filters.PlainFilter}apply(e,t,r,a){this.resolution=this._amount>.5?.25:.5,this.padding=1/this.resolution,this.uniforms.padding=this.padding;let s=e.getRenderTarget(!0),o=e.getRenderTarget(!0);this.plainFilter.apply(e,t,s,!0);for(let n=0;n<6;n++){let l=1/Math.pow(2,Math.floor(n/2));this.uniforms.spreadAmount=this._amount*this._maxSpread*l,this.uniforms.horizontal=n%2?1:0,e.applyFilter(this,s,o,!0);let c=o;o=s,s=c}this.plainFilter.apply(e,s,r,!0),e.returnRenderTarget(s),e.returnRenderTarget(o)}get amount(){return this._amount}set amount(e){this._amount=Math.max(0,Math.min(1,e))}get dimensions(){return this.uniforms.dimensions}set dimensions(e){this.uniforms.dimensions=e,this._maxSpread=Math.max(e[0],e[1])/32}get maskTexture(){return this.uniforms.maskTexture}set maskTexture(e){this.uniforms.maskTexture=e}get maskTextureInverted(){return!!this.uniforms.maskTextureInverted}set maskTextureInverted(e){this.uniforms.maskTextureInverted=e?1:0}},jx=$x;var Yx="vec2 A(vec2 B,vec4 C){B*=C.xy;B+=C.zw;return B;}vec2 D(vec2 B,vec4 C){B-=C.zw;B/=C.xy;return B;}vec3 E(vec3 F,float G){return pow(F,1./vec3(G));}vec3 H(vec3 F,float I,float J){return min(max(F-I,0.)/(J-I+0.0001),1.);}vec3 K(vec3 F,float I,float G,float J){return E(H(F,I,J),G);}vec3 L(vec3 F,float M,float N){return mix(vec3(M),vec3(N),F);}vec3 O(vec3 F,float I,float G,float J,float M,float N){return L(K(F,I,G,J),M,N);}uniform sampler2D uSampler;varying vec2 vTextureCoord;uniform vec4 filterArea;uniform float amount;uniform int large;uniform vec2 dimensions;uniform sampler2D maskTexture;uniform int maskTextureInverted;uniform sampler2D bgTexture;uniform int mode;uniform float threshold;uniform float intensity;vec3 P(vec3 Q,vec3 R,float S){return max(Q,R)*S+R*(1.-S);}vec3 T(vec3 U,vec3 V){return(U+V)-(U*V);}vec3 W(vec3 X,vec2 Y){vec2 Z=vec2(0.);vec2 a=dimensions;X.rgb+=texture2D(uSampler,D(vec2(clamp((Y.x-1.),Z.x,a.x),clamp((Y.y+0.),Z.y,a.y)),filterArea)).rgb;X.rgb+=texture2D(uSampler,D(vec2(clamp((Y.x+1.),Z.x,a.x),clamp((Y.y+0.),Z.y,a.y)),filterArea)).rgb;X.rgb+=texture2D(uSampler,D(vec2(clamp((Y.x+0.),Z.x,a.x),clamp((Y.y-1.),Z.y,a.y)),filterArea)).rgb;X.rgb+=texture2D(uSampler,D(vec2(clamp((Y.x+0.),Z.x,a.x),clamp((Y.y+1.),Z.y,a.y)),filterArea)).rgb;if(large==1){X.rgb+=texture2D(uSampler,D(vec2(clamp((Y.x-1.),Z.x,a.x),clamp((Y.y-1.),Z.y,a.y)),filterArea)).rgb;X.rgb+=texture2D(uSampler,D(vec2(clamp((Y.x+0.),Z.x,a.x),clamp((Y.y-2.),Z.y,a.y)),filterArea)).rgb;X.rgb+=texture2D(uSampler,D(vec2(clamp((Y.x+1.),Z.x,a.x),clamp((Y.y-1.),Z.y,a.y)),filterArea)).rgb;X.rgb+=texture2D(uSampler,D(vec2(clamp((Y.x-2.),Z.x,a.x),clamp((Y.y+0.),Z.y,a.y)),filterArea)).rgb;X.rgb+=texture2D(uSampler,D(vec2(clamp((Y.x+2.),Z.x,a.x),clamp((Y.y+0.),Z.y,a.y)),filterArea)).rgb;X.rgb+=texture2D(uSampler,D(vec2(clamp((Y.x-1.),Z.x,a.x),clamp((Y.y+1.),Z.y,a.y)),filterArea)).rgb;X.rgb+=texture2D(uSampler,D(vec2(clamp((Y.x+0.),Z.x,a.x),clamp((Y.y+2.),Z.y,a.y)),filterArea)).rgb;X.rgb+=texture2D(uSampler,D(vec2(clamp((Y.x+1.),Z.x,a.x),clamp((Y.y+1.),Z.y,a.y)),filterArea)).rgb;X.rgb/=13.;}else{X.rgb/=5.;}return X.rgb;}void main(void){vec4 X=texture2D(uSampler,vTextureCoord);vec2 Y=A(vTextureCoord,filterArea);X.rgb=W(X.rgb,Y);if(mode==1){X.rgb=pow(X.rgb,vec3(threshold));float G=(1.1-(0.5*intensity));float b=(1.-(0.18*intensity));X.rgb=O(X.rgb,0.,G,b,0.,1.);vec2 c=clamp((Y/dimensions),0.,1.);vec4 d=texture2D(maskTexture,c);d.a=(maskTextureInverted==1)?(1.-d.a):d.a;X.rgb=clamp((X.rgb-vec3(d.a)),vec3(0.),vec3(1.));}else if(mode==2){vec3 e=(X.rgb*X.rgb*(1.+(amount*0.8)));X.rgb=P(e,X.rgb,amount);vec2 f=clamp((Y/dimensions),0.,1.);vec4 g=texture2D(bgTexture,f);X.rgb=T(X.rgb,g.rgb);}gl_FragColor=X;}";var qx=class extends PIXI.Filter{constructor(){super(O,Yx);let e;BFN.Stage.filterManager.shaderCache[this.glShaderKey]||(e=new PIXI.Shader(BFN.Stage.gl,this.vertexSrc,this.fragmentSrc),this.glShaders[BFN.Stage.CONTEXT_UID]=BFN.Stage.filterManager.shaderCache[this.glShaderKey]=e),this.padding=0,this.large=!1,this.dimensions=[0,0],this.mode=0}get large(){return!!this.uniforms.large}set large(e){this.uniforms.large=e?1:0}get amount(){return this.uniforms.amount}set amount(e){this.uniforms.amount=Math.max(0,Math.min(1,e))}get dimensions(){return this.uniforms.dimensions}set dimensions(e){this.uniforms.dimensions=e}get mode(){return this.uniforms.mode}set mode(e){this.uniforms.mode=Math.max(0,Math.min(2,e))}get threshold(){return this.uniforms.threshold}set threshold(e){this.uniforms.threshold=Math.max(1,e)}get intensity(){return this.uniforms.intensity}set intensity(e){this.uniforms.intensity=Math.max(0,Math.min(1,e))}get maskTexture(){return this.uniforms.maskTexture}set maskTexture(e){this.uniforms.maskTexture=e}get maskTextureInverted(){return!!this.uniforms.maskTextureInverted}set maskTextureInverted(e){this.uniforms.maskTextureInverted=e?1:0}get bgTexture(){return this.uniforms.bgTexture}set bgTexture(e){this.uniforms.bgTexture=e}},Kx=qx;var Jx="uniform sampler2D uSampler;varying vec2 vTextureCoord;uniform float tolerance;uniform vec2 onePixel;uniform vec2 dimensions;uniform sampler2D unionTexture;uniform vec3 selectionColor;void main(void){vec4 A=texture2D(unionTexture,clamp((vTextureCoord/dimensions),0.,1.));if(A.a<1.){vec2 B=(dimensions*0.5);vec2 C=(vTextureCoord-B);float D=sqrt(pow(C.x,2.)+pow(C.y,2.));float E=min(B.x,B.y);if(D<E){vec4 F=texture2D(uSampler,vTextureCoord);vec4 G=texture2D(uSampler,B);float H=distance(F,G);H=step(tolerance,H);float I=(E-(onePixel.x*2.));float J=smoothstep(E,I,D);float K=max(A.a,J);A=mix(vec4((selectionColor*K),K),max(vec4(0.),A),H);}}gl_FragColor=A;}";var Qx=class extends PIXI.Filter{constructor(){super(O,Jx);this.padding=0,this.tolerance=.5,this.selectionColor=16711680}apply(e,t,r,a){this.uniforms.onePixel=[1/t.size.width,1/t.size.height],this.uniforms.dimensions=[t.sourceFrame.width/t.size.width,t.sourceFrame.height/t.size.height],e.applyFilter(this,t,r,!0)}get tolerance(){return this.uniforms.tolerance}set tolerance(e){this.uniforms.tolerance=Math.max(0,Math.min(1,e))}get selectionColor(){return this.uniforms.selectionColor}set selectionColor(e){this.uniforms.selectionColor=BFN.FilterHelper.hex2rgbFactor(e)}get unionTexture(){return this.uniforms.unionTexture}set unionTexture(e){this.uniforms.unionTexture=e}},Zx=Qx;var eT="varying vec2 vTextureCoord;uniform sampler2D uSampler;uniform vec4 filterClamp;void main(void){gl_FragColor=texture2D(uSampler,clamp(vTextureCoord,filterClamp.xy,filterClamp.zw));}";var tT=class extends PIXI.Filter{constructor(){super(O,eT);let e;BFN.Stage.filterManager.shaderCache[this.glShaderKey]||(e=new PIXI.Shader(BFN.Stage.gl,this.vertexSrc,this.fragmentSrc),this.glShaders[BFN.Stage.CONTEXT_UID]=BFN.Stage.filterManager.shaderCache[this.glShaderKey]=e)}},iT=tT;var rT="attribute vec2 aVertexPosition;attribute vec2 aTextureCoord;uniform mat3 projectionMatrix;varying vec2 vTextureCoord;void main(void){gl_Position=vec4((projectionMatrix*vec3(aVertexPosition,1.)).xy,0.,1.);vTextureCoord=aTextureCoord;}";var aT="varying vec2 vTextureCoord;uniform sampler2D uSampler;uniform vec2 onePixel;uniform float threshold;const float A=11.;uniform float clampX;uniform float clampY;void main(void){float B=0.;vec2 C=vTextureCoord;vec4 D=texture2D(uSampler,vTextureCoord);vec4 E;vec4 F=vec4(0.);for(float G=-A;G<=A;G++){for(float H=-A;H<=A;H++){E=texture2D(uSampler,clamp(vTextureCoord+vec2(G,H)*onePixel,vec2(0.,0.),vec2(clampX,clampY)));float I=step(length(vec2(G,H)),A);float J=step(distance(E,D),threshold);F+=E*I*J;B+=I*J;}}gl_FragColor=vec4(F/B);}";var sT=class extends PIXI.Filter{constructor(e){super(rT,aT);this.padding=0,this.threshold=e||.1}apply(e,t,r,a){let s=BFN.FilterHelper.calculateFilterClamp(t,r);this.uniforms.clampX=1/s.x,this.uniforms.clampY=1/s.y,this.uniforms.onePixel[0]=1/t.size.width,this.uniforms.onePixel[1]=1/t.size.height,e.applyFilter(this,t,r,a)}get threshold(){return this.uniforms.threshold}set threshold(e){this.uniforms.threshold=e}},oT=sT;var nT="varying vec2 vTextureCoord;uniform sampler2D uSampler;uniform vec4 filterClamp;void main(void){vec4 A=texture2D(uSampler,clamp(vTextureCoord,filterClamp.xy,filterClamp.zw));vec3 B=mix(vec3(1.,1.,1.),vec3(1.,0.,1.),1.-A.a);gl_FragColor=vec4(B,1.);}";var lT=class extends PIXI.Filter{constructor(){super(O,nT);let e;BFN.Stage.filterManager.shaderCache[this.glShaderKey]||(e=new PIXI.Shader(BFN.Stage.gl,this.vertexSrc,this.fragmentSrc),this.glShaders[BFN.Stage.CONTEXT_UID]=BFN.Stage.filterManager.shaderCache[this.glShaderKey]=e),this.padding=0}},cT=lT;var hT="float A(vec3 B){return dot(B,vec3(0.299,0.587,0.114));}vec3 C(vec3 B){float D=A(B);float E=min(min(B.r,B.g),B.b);float F=max(max(B.r,B.g),B.b);if(E<0.){max((B-D)*D/(D-E)+D,0.);}if(F>1.){min((B-D)*(1.-D)/(F-D)+D,1.);}return B;}float G(vec3 B){return dot(B,vec3(0.299,0.587,0.114));}vec3 H(vec3 B,float D){float I=D-G(B);B=B+vec3(I);return C(B);}float J(vec3 B){return dot(B,vec3(0.299,0.587,0.114));}vec3 K(vec3 L,vec3 M){return H(M,J(L));}varying vec2 vTextureCoord;uniform sampler2D uSampler;uniform vec3 color;void main(void){vec4 N=texture2D(uSampler,vTextureCoord);if(N.r>0.66&&N.g>0.66&&N.b>0.66){N=vec4(0.,1.,0.,.25);}else if(N.r<0.33&&N.g<0.33&&N.b<0.33){N=vec4(1.,0.,0.,.5);}else{N=vec4(1.,0.,1.,.25);}N.rgb*=N.a;gl_FragColor=N;}";var uT=class extends PIXI.Filter{constructor(){let e=O,t=hT;super(e,t);this.padding=0}},dT=uT;var mT="vec4 A(vec4 B,vec4 C){if(B.a==0.){return C;}else if(C.a==0.){return B;}else{float D=clamp((B.a+((1.-B.a)*C.a)),0.,1.);if(D==0.){return vec4(0.);}else{float E=clamp((C.a/(D+0.000001)),0.,1.);vec3 F=(B.a>0.)?(B.rgb/(B.a+0.000001)):vec3(0.);vec3 G=(C.a>0.)?(C.rgb/(C.a+0.000001)):vec3(0.);vec3 H=clamp(((F*(1.-E))+(G*E)),0.,1.);vec4 I=clamp(vec4((H*D),D),0.,1.);return I;}}}uniform sampler2D uSampler;varying vec2 vTextureCoord;uniform vec4 filterClamp;uniform sampler2D lumaTexture;uniform bool maskVisible;uniform float maskFactor;uniform float maskInverse;uniform vec3 backgroundColor;const vec4 J=vec4(0.5,0.,0.,0.5);void main(void){vec4 K=(backgroundColor.r==-1.)?vec4(0.):vec4(backgroundColor,1.);vec4 L=A(K,texture2D(uSampler,vTextureCoord));vec2 M=(vTextureCoord.xy/(filterClamp.zw+0.000001));vec4 N=texture2D(lumaTexture,M);float O=(1.-(abs((1.-maskInverse)-N.r)*maskFactor));if(maskVisible){L=mix(L,A(L,J),O);}else{L=mix(K,L,O);}gl_FragColor=L;}";var pT=class extends PIXI.Filter{constructor(){super(O,mT);this.padding=0,this.showMask=!1,this.useMask=!0,this.inverse=!1,this.lumaTexture=PIXI.Texture.EMPTY,this.backgroundColor=-1}get showMask(){return!!this.uniforms.maskVisible}set showMask(e){this.uniforms.maskVisible=!!e}get useMask(){return this.uniforms.maskFactor===1}set useMask(e){this.uniforms.maskFactor=Number(!!e)}get inverse(){return this.uniforms.maskInverse===1}set inverse(e){this.uniforms.maskInverse=Number(!!e)}get lumaTexture(){return this.uniforms.lumaTexture}set lumaTexture(e){this.uniforms.lumaTexture=e}get backgroundColor(){return this.uniforms.backgroundColor}set backgroundColor(e){this.uniforms.backgroundColor=e===-1?[-1,-1,-1]:BFN.FilterHelper.hex2rgb(e)}},fT=pT;var gT="uniform sampler2D uSampler;varying vec2 vTextureCoord;uniform vec4 filterClamp;uniform vec2 dimensions;uniform float minmax;uniform float preserveRoundness;uniform float intensity;const float A=3.141592653589793238462;const float B=(A/4.);vec4 C(vec2 D,vec4 E,float F){vec2 G=vec2(cos(F*B),sin(F*B));if(preserveRoundness==0.){G.x=((abs(G.x)<0.1)?0.:(G.x/abs(G.x)));G.y=((abs(G.y)<0.1)?0.:(G.y/abs(G.y)));}vec2 H=(clamp(((D+G)/dimensions),vec2(0.),vec2(1.))*filterClamp.zw);vec4 I=texture2D(uSampler,H);vec3 J=(E.rgb/E.a);vec3 K=(I.rgb/I.a);if(minmax==0.){E=(vec4(min(J,K),1.)*max(E.a,I.a));}if(minmax==1.){E=(vec4(max(J,K),1.)*min(E.a,I.a));}E=(floor((E*255.)+vec4(0.5))/255.);return E;}void main(){vec4 L=texture2D(uSampler,vTextureCoord);if(intensity==0.){gl_FragColor=L;return;}vec2 D=((vTextureCoord.xy/filterClamp.zw)*dimensions);vec4 E=L;E=C(D,E,0.);E=C(D,E,1.);E=C(D,E,2.);E=C(D,E,3.);E=C(D,E,4.);E=C(D,E,5.);E=C(D,E,6.);E=C(D,E,7.);gl_FragColor=mix(L,E,intensity);}";var vT=class extends PIXI.Filter{constructor(){super(O,gT);this.padding=0,this.minmax=0,this.preserveRoundness=!0,this.intensity=1}get minmax(){return this.uniforms.minmax}set minmax(e){this.uniforms.minmax=Number(!!e)}get preserveRoundness(){return this.uniforms.preserveRoundness}set preserveRoundness(e){this.uniforms.preserveRoundness=Number(!!e)}get intensity(){return this.uniforms.intensity}set intensity(e){this.uniforms.intensity=Math.max(0,Math.min(1,e))}get dimensions(){return this.uniforms.dimensions}set dimensions(e){this.uniforms.dimensions=e}},yT=vT;var xT=`vec3 A(vec3 B,float C){return pow(B,1./vec3(C));}vec3 D(vec3 B,float E,float F){return min(max(B-E,0.)/(F-E+0.0001),1.);}vec3 G(vec3 B,float E,float C,float F){return A(D(B,E,F),C);}vec3 H(vec3 B,float I,float J){return mix(vec3(I),vec3(J),B);}vec3 K(vec3 B,float E,float C,float F,float I,float J){return H(G(B,E,C,F),I,J);}precision highp float;
#define GLSLIFY 1
varying vec2 vTextureCoord;uniform vec4 filterClamp;uniform float size;uniform float phase;uniform float noiseFactor;uniform float occlusionOnly;const float L=3.141592653589793238462;const float M=(L*2.);const float N=5.;const float O=1.;const float P=(N-O);const float Q=(O/2.);const float R=(N/2.);const float S=(P/2.);const float T=0.;const float U=0.14;const float V=(1./U);const float W=(2./(L*U));const float X=(128./255.);vec2 Y(vec2 Z,float a){Z=(Z*mat2(127.1,311.7,269.5,183.3));Z=((2.*fract(sin(Z)*43758.5453123))-1.);return sin((Z*M)+(a*M));}vec2 b(vec2 Z,vec2 c,float a,float d){float e=pow(2.,d);float f=(1./e);Z*=e;vec2 g=floor(Z);vec2 h=(Z-g);vec2 i=(h*h*(3.-(2.*h)));float j=dot(Y((g+vec2(0.,0.)),a),(h-vec2(0.,0.)));float k=dot(Y((g+vec2(0.,1.)),a),(h-vec2(0.,1.)));float l=dot(Y((g+vec2(1.,0.)),a),(h-vec2(1.,0.)));float m=dot(Y((g+vec2(1.,1.)),a),(h-vec2(1.,1.)));float n=mix(j,l,i.x);float o=mix(k,m,i.x);float p=mix(n,o,i.y);c.x+=(f*p);c.y+=f;return c;}float q(float r,float s){vec2 Z=(vTextureCoord.xy/filterClamp.zw);Z*=((s*P)+O);Z-=(((s*S)+Q)-R);Z*=vec2((filterClamp.z/filterClamp.w),1.);Z*=4.;vec2 c=vec2(0.,0.);c=b(Z,c,r,0.);c=b(Z,c,r,1.);c=b(Z,c,r,2.);c=b(Z,c,r,3.);c=b(Z,c,r,4.);float t=(((c.x/c.y)*0.5)+0.5);return t;}float u(vec2 v){return fract(sin(dot(v.xy,vec2(12.9898,78.233)))*43758.5453);}float w(float x){float y=log(1.-(x*x));float z=(W+(0.5*y));return(sqrt(sqrt((z*z)-(y*V))-z)*sign(x));}float AA(vec2 v){float AB=fract(phase);float x=u(v+(0.07*AB));return((w((x*2.)-1.)*0.15)+0.5);}float AC(vec2 v){float AB=fract(phase);float AD=u(v+0.07*AB);float AE=u(v+0.11*AB);float AF=u(v+0.13*AB);float AG=u(v+0.17*AB);float AH=u(v+0.19*AB);float AI=u(v+0.23*AB);float AJ=u(v+0.29*AB);float AK=u(v+0.31*AB);return(AD+AE+AF+AG+AH+AI+AJ+AK)/8.;}float AL(){vec2 Z=(vTextureCoord.xy/filterClamp.zw);float t=mix(clamp(AA(Z),0.,1.),clamp(AA(mod((Z+0.5),1.)),0.,1.),0.5);t=clamp((((t-0.5)*2.)+0.5),0.,1.);return t;}void main(){float AM=clamp(K(vec3(q(fract(phase+0.25),size)),0.15,1.,0.6,0.,1.),vec3(0.),vec3(1.)).r;if(occlusionOnly==1.){gl_FragColor=vec4(vec3(AM),1.);return;}float AN=q(phase,size);float AO=AL();float AP=mix(AN,AO,noiseFactor);float AQ=mix(AP,X,AM);gl_FragColor=vec4(vec3(AQ),1.);}`;var TT=class extends PIXI.Filter{constructor(){super(O,xT);this.padding=0,this.size=0,this.phase=0,this.noise=.5,this.occlusionOnly=!1}get size(){return this.uniforms.size}set size(e){this.uniforms.size=e}get phase(){return this.uniforms.phase}set phase(e){this.uniforms.phase=e}get noise(){return this.uniforms.noiseFactor}set noise(e){this.uniforms.noiseFactor=e}get occlusionOnly(){return!!this.uniforms.occlusionOnly}set occlusionOnly(e){this.uniforms.occlusionOnly=Number(!!e)}},FT=TT;var bT="vec4 A(vec4 B,vec4 C){if(B.a==1.&&C.a==1.){return min(B,C);}float D=0.05;if(C.a<=D)return(B.a<D)?vec4(0.):B;if(B.a<=D)return(C.a<D)?vec4(0.):C;vec3 E=(B.rgb/B.a);vec3 F=(C.rgb/C.a);vec3 G=min(E,F);vec3 H=G;if(B.a<C.a){H=mix(F,G,(B.a/C.a));}if(C.a<B.a){H=mix(E,G,(C.a/B.a));}float I=max(B.a,C.a);vec4 J=vec4((H*I),I);J=(ceil(J*255.)/255.);return J;}uniform sampler2D uSampler;varying vec2 vTextureCoord;uniform vec4 filterClamp;uniform vec2 dimensions;uniform vec2 displaceMax;uniform float softness;uniform float maskInverse;uniform sampler2D maskTexture;uniform sampler2D displacementMap;const float K=(128./255.);void main(){highp vec2 L=(vTextureCoord.xy/filterClamp.zw);vec4 M=texture2D(uSampler,vTextureCoord);float N=(1.-abs(maskInverse-texture2D(maskTexture,L).a));if(N==0.){gl_FragColor=M;return;}vec4 O=texture2D(displacementMap,L);float P=((O.r-K)*2.);vec2 Q=(L*dimensions);vec2 sign=(vec2((displaceMax.x<0.?-1.:1.),((displaceMax.y<0.?-1.:1.)))*(P<0.?-1.:1.));vec2 R=(floor(abs(displaceMax*P)+vec2(0.5))*sign);vec2 S=(abs(displaceMax*P)*sign);vec2 T=mix(R,S,softness);Q+=T;Q=clamp((Q/dimensions),vec2(0.),vec2(1.));vec2 U=(Q*filterClamp.zw);vec4 V=texture2D(uSampler,U);vec4 W=A(M,V);gl_FragColor=(N<1.)?mix(M,W,N):W;}";var BT=class extends PIXI.Filter{constructor(){super(O,bT);this.padding=0,this.softness=.5,this.displaceMax=[0,0],this.maskInverse=!1}get softness(){return this.uniforms.softness}set softness(e){this.uniforms.softness=e}get displaceMax(){return this.uniforms.displaceMax}set displaceMax(e){this.uniforms.displaceMax=e}get maskInverse(){return!!this.uniforms.maskInverse}set maskInverse(e){this.uniforms.maskInverse=Number(!!e)}get maskTexture(){return this.uniforms.maskTexture}set maskTexture(e){this.uniforms.maskTexture=e}get displacementMap(){return this.uniforms.displacementMap}set displacementMap(e){this.uniforms.displacementMap=e}get dimensions(){return this.uniforms.dimensions}set dimensions(e){this.uniforms.dimensions=e}},ST=BT;var IT="float A(vec3 B){return dot(B,vec3(0.299,0.587,0.114));}uniform sampler2D uSampler;varying vec2 vTextureCoord;uniform vec4 filterClamp;uniform vec2 dimensions;uniform float intensity;uniform float currentPass;uniform sampler2D unblurredTexture;const float C=0.22;const float D=0.18;const float E=0.13;const float F=0.08;vec4 G(vec4 H,float I){float J=((1.-I)/2.);mat4 K=mat4(I,0,0,0,0,I,0,0,0,0,I,0,J,J,J,1);return(H*K);}vec3 L(float M){vec2 N=clamp((vTextureCoord+((filterClamp.zw/dimensions)*vec2((1.-currentPass),currentPass)*M)),vec2(0.),filterClamp.zw);vec4 O=texture2D(uSampler,N);return clamp((O.rgb/O.a),vec3(0.),vec3(1.));}void main(){vec4 P;if(currentPass==0.||currentPass==1.){vec3 Q=(L(0.)*C);vec3 R=(L(-1.)*D);vec3 S=(L(-2.)*E);vec3 T=(L(-3.)*F);vec3 U=(L(1.)*D);vec3 V=(L(2.)*E);vec3 W=(L(3.)*F);vec3 O=(Q+R+S+T+U+V+W);P=vec4(O,1.);}else if(currentPass==2.){vec2 X=clamp((((vTextureCoord.xy/filterClamp.zw)*(dimensions-vec2(1.)))/dimensions),vec2(0.),vec2(1.));vec4 Y=texture2D(unblurredTexture,X);vec4 Z=texture2D(uSampler,vTextureCoord);vec3 a=clamp((Y.rgb/Y.a),vec3(0.),vec3(1.));vec3 b=clamp((Z.rgb/Z.a),vec3(0.),vec3(1.));vec3 c=abs(a-b);float d=A(c.rgb);vec3 e=clamp(G(vec4(a,1.),(1.+intensity)).rgb,vec3(0.),vec3(1.));vec3 f=mix(a,e,d);P=vec4(f,1.);P*=Y.a;}else{P=texture2D(uSampler,vTextureCoord);}gl_FragColor=P;}";var _T=class extends PIXI.Filter{constructor(){super(O,IT);this.padding=0,this.intensity=.25}get intensity(){return this.uniforms.intensity}set intensity(e){this.uniforms.intensity=e}get currentPass(){return this.uniforms.currentPass}set currentPass(e){this.uniforms.currentPass=e}get unblurredTexture(){return this.uniforms.unblurredTexture}set unblurredTexture(e){this.uniforms.unblurredTexture=e}get dimensions(){return this.uniforms.dimensions}set dimensions(e){this.uniforms.dimensions=e}},CT=_T;var ET="vec4 A(vec4 B,vec4 C){if(B.a==1.&&C.a==1.){return min(B,C);}float D=0.05;if(C.a<=D)return(B.a<D)?vec4(0.):B;if(B.a<=D)return(C.a<D)?vec4(0.):C;vec3 E=(B.rgb/B.a);vec3 F=(C.rgb/C.a);vec3 G=min(E,F);vec3 H=G;if(B.a<C.a){H=mix(F,G,(B.a/C.a));}if(C.a<B.a){H=mix(E,G,(C.a/B.a));}float I=max(B.a,C.a);vec4 J=vec4((H*I),I);J=(ceil(J*255.)/255.);return J;}vec3 K(vec3 L,float M){return pow(L,1./vec3(M));}vec3 N(vec3 L,float O,float P){return min(max(L-O,0.)/(P-O+0.0001),1.);}vec3 Q(vec3 L,float O,float M,float P){return K(N(L,O,P),M);}vec3 R(vec3 L,float S,float T){return mix(vec3(S),vec3(T),L);}vec3 U(vec3 L,float O,float M,float P,float S,float T){return R(Q(L,O,M,P),S,T);}uniform sampler2D uSampler;varying highp vec2 vTextureCoord;uniform vec4 filterClamp;uniform vec2 dimensions;uniform bool invert;uniform float fade;uniform sampler2D prevIteration;void main(){vec2 V=clamp((((vTextureCoord.xy/filterClamp.zw)*(dimensions-vec2(1.)))/dimensions),vec2(0.),vec2(1.));vec4 B=texture2D(prevIteration,V);vec4 C=texture2D(uSampler,vTextureCoord);vec3 F=clamp(((C.a>0.)?(C.rgb/C.a):vec3(0.)),0.,1.);F=U(F,0.,1.,1.,fade*C.a,1.);C.a*=(1.-fade);C.rgb=(F*C.a);vec4 J=A(B,C);if(invert&&J.a>0.){J.rgb=((1.-(J.rgb/J.a))*J.a);}gl_FragColor=J;}";var PT=class extends PIXI.Filter{constructor(){super(O,ET);this.padding=0,this.fade=.05}get invert(){return!!this.uniforms.invert}set invert(e){this.uniforms.invert=!!e}get fade(){return this.uniforms.fade}set fade(e){this.uniforms.fade=e}get prevIteration(){return this.uniforms.prevIteration}set prevIteration(e){this.uniforms.prevIteration=e}get dimensions(){return this.uniforms.dimensions}set dimensions(e){this.uniforms.dimensions=e}},NT=PT;var MT="uniform sampler2D uSampler;varying vec2 vTextureCoord;uniform vec4 filterClamp;uniform vec2 dimensions;uniform sampler2D originalTexture;uniform sampler2D occlusionTexture;void main(){vec2 A=clamp((((vTextureCoord.xy/filterClamp.zw)*(dimensions-vec2(1.)))/dimensions),vec2(0.),vec2(1.));vec4 B=texture2D(originalTexture,A);vec4 C=texture2D(uSampler,vTextureCoord);vec3 D=clamp((B.rgb/B.a),0.,1.);vec3 E=clamp((C.rgb/C.a),0.,1.);vec3 F=min(D,E);vec3 G=max(D,E);float H=1.;float I=0.;float J=0.;if(F.r<G.r){I+=F.r;J+=G.r;}if(F.g<G.g){I+=F.g;J+=G.g;}if(F.b<G.b){I+=F.b;J+=G.b;}if(J>0.){H=I/J;}vec4 K=texture2D(occlusionTexture,A);float L=smoothstep(0.8,1.,K.r);L*=0.9;H=min(L,H);gl_FragColor=vec4(vec3(H),1.);}";var DT=class extends PIXI.Filter{constructor(){super(O,MT);this.padding=0}get originalTexture(){return this.uniforms.originalTexture}set originalTexture(e){this.uniforms.originalTexture=e}get occlusionTexture(){return this.uniforms.occlusionTexture}set occlusionTexture(e){this.uniforms.occlusionTexture=e}get dimensions(){return this.uniforms.dimensions}set dimensions(e){this.uniforms.dimensions=e}},wT=DT;var kT="uniform sampler2D uSampler;varying vec2 vTextureCoord;uniform vec4 filterClamp;uniform vec2 dimensions;uniform sampler2D differenceMap;uniform sampler2D outputTexture;void main(){vec2 A=clamp((((vTextureCoord.xy/filterClamp.zw)*(dimensions-vec2(1.)))/dimensions),vec2(0.),vec2(1.));float B=texture2D(differenceMap,A).r;vec4 C=texture2D(outputTexture,A);vec4 D=texture2D(uSampler,vTextureCoord);gl_FragColor=mix(C,D,B);}";var AT=class extends PIXI.Filter{constructor(){super(O,kT);this.padding=0}get differenceMap(){return this.uniforms.differenceMap}set differenceMap(e){this.uniforms.differenceMap=e}get outputTexture(){return this.uniforms.outputTexture}set outputTexture(e){this.uniforms.outputTexture=e}get dimensions(){return this.uniforms.dimensions}set dimensions(e){this.uniforms.dimensions=e}},OT=AT;var RT="uniform sampler2D uSampler;varying vec2 vTextureCoord;void main(){gl_FragColor=texture2D(uSampler,vTextureCoord);}";var LT=class extends PIXI.Filter{constructor(){super(O,RT);this.padding=0,this.colorMode="darken",this.size=.25,this.phase=0,this.noise=.5,this.iterations=20,this.bleed=50,this.softness=.5,this.fade=.05,this.unsharp=.25,this.handleImagePainterPaintUpdatedBind=this.handleImagePainterPaintUpdated.bind(this)}handleImagePainterPaintUpdated(e){if(this.maskTexture&&BFN.ImageEffect.painter.isSetup){let t=BFN.ImageEffect.painter.texture;this.maskTexture.copyPixels(t,void 0,void 0,void 0,{x:this.maskTexture.width/t.width,y:this.maskTexture.height/t.height}),BFN.EffectManager.processEffect()}}apply(e,t,r,a){this.flipTexture?(this.outputFilter.outputTexture=this.flipTexture,this.outputFilter.apply(e,t,r,!0)):e.applyFilter(this,t,r,a)}setSourceTexture(e){if(e&&e.baseTexture&&e!==this.sourceTexture){this.reset(),this.sourceTexture=e,this.sourceW=e.width,this.sourceH=e.height;let t=Math.max(this.sourceW,this.sourceH),r=1024/t;this.scaledSourceW=Math.min(1024,Math.round(this.sourceW*r)),this.scaledSourceH=Math.min(1024,Math.round(this.sourceH*r)),this.scaledSourceTexture=PIXI.RenderTexture.create(this.scaledSourceW,this.scaledSourceH),this.scaledSourceTexture.copyPixels(this.sourceTexture,void 0,void 0,void 0,{x:this.scaledSourceW/this.sourceW,y:this.scaledSourceH/this.sourceH}),BFN.ImagePainterUndoManager.addEventListener(BFN.ImagePainterUndoManagerEvents.PAINT_UPDATED.type,this.handleImagePainterPaintUpdatedBind),BFN.ImagePainterUndoManager.addEventListener(BFN.ImagePainterUndoManagerEvents.ALT_TEXTURE_UPDATED.type,this.handleImagePainterPaintUpdatedBind),BFN.ImageEffect.addEventListener(BFN.ImageEffectEvents.INVERSE_PAINT.type,this.handleImagePainterPaintUpdatedBind),BFN.ImageEffect.addEventListener(BFN.ImageEffectEvents.CLEAR_PAINT.type,this.handleImagePainterPaintUpdatedBind)}}reset(){this.filterProcessed=!1;let e=t=>{try{this[t].destroyGC(!0)}catch(r){}delete this[t]};this.sourceTexture=null,this.sourceW=0,this.sourceH=0,e("scaledSourceTexture"),delete this.scaledSourceW,delete this.scaledSourceH,e("flipTexture"),e("flopTexture"),e("prevTexture"),e("snapTexture"),e("dmapTexture"),e("omapTexture"),e("diffTexture"),e("maskTexture"),this.texturesGenerated=!1,this.filtersGenerated&&(this.displaceFilter.maskTexture=PIXI.Texture.EMPTY,this.displaceFilter.displacementMap=PIXI.Texture.EMPTY,this.unsharpMaskFilter.unblurredTexture=PIXI.Texture.EMPTY,this.layerFilter.prevIteration=PIXI.Texture.EMPTY,this.differenceFilter.originalTexture=PIXI.Texture.EMPTY,this.differenceFilter.occlusionTexture=PIXI.Texture.EMPTY,this.outputFilter.differenceMap=PIXI.Texture.EMPTY,this.outputFilter.outputTexture=PIXI.Texture.EMPTY),BFN.ImagePainterUndoManager.removeEventListener(BFN.ImagePainterUndoManagerEvents.PAINT_UPDATED.type,this.handleImagePainterPaintUpdatedBind),BFN.ImagePainterUndoManager.removeEventListener(BFN.ImagePainterUndoManagerEvents.ALT_TEXTURE_UPDATED.type,this.handleImagePainterPaintUpdatedBind),BFN.ImageEffect.removeEventListener(BFN.ImageEffectEvents.INVERSE_PAINT.type,this.handleImagePainterPaintUpdatedBind),BFN.ImageEffect.removeEventListener(BFN.ImageEffectEvents.CLEAR_PAINT.type,this.handleImagePainterPaintUpdatedBind)}updateTextures(){!this.scaledSourceTexture||this.texturesGenerated||(this.texturesGenerated=!0,this.flipTexture=PIXI.RenderTexture.create(this.scaledSourceW,this.scaledSourceH),this.flopTexture=PIXI.RenderTexture.create(this.scaledSourceW,this.scaledSourceH),this.prevTexture=PIXI.RenderTexture.create(this.scaledSourceW,this.scaledSourceH),this.snapTexture=PIXI.RenderTexture.create(this.scaledSourceW,this.scaledSourceH),this.dmapTexture=PIXI.RenderTexture.create(this.scaledSourceW,this.scaledSourceH),this.omapTexture=PIXI.RenderTexture.create(this.scaledSourceW,this.scaledSourceH),this.diffTexture=PIXI.RenderTexture.create(this.scaledSourceW,this.scaledSourceH),this.maskTexture=PIXI.RenderTexture.create(this.scaledSourceW,this.scaledSourceH),this.maskTexture.clear())}updateFilters(){if(!this.scaledSourceTexture)return;this.filtersGenerated||(this.filtersGenerated=!0,this.minmaxFilter=new BFN.filters.MinMaxFilter,this.displacementMapFilter=new BFN.filters.ColorBleedDisplacementMapFilter,this.displaceFilter=new BFN.filters.ColorBleedDisplaceFilter,this.unsharpMaskFilter=new BFN.filters.ColorBleedUnsharpMaskFilter,this.layerFilter=new BFN.filters.ColorBleedLayerFilter,this.differenceFilter=new BFN.filters.ColorBleedDifferenceMapFilter,this.outputFilter=new BFN.filters.ColorBleedOutputFilter),this.minmaxFilter.dimensions=[this.scaledSourceW,this.scaledSourceH];let{size:e,phase:t,noise:r}=this.displacementMapFilter;this.displacementChanged=!(e===this._size&&t===this._phase&&r===this._noise)||!this.filterProcessed,this.occlusionChanged=!(e===this._size&&t===this._phase)||!this.filterProcessed,this.displacementMapFilter.size=this._size,this.displacementMapFilter.phase=this._phase,this.displacementMapFilter.noise=this._noise,this.displaceFilter.dimensions=[this.scaledSourceW,this.scaledSourceH],this.displaceFilter.softness=this._softness,this.displaceFilter.maskInverse=BFN.ImageEffect.inverse,this.displaceFilter.maskTexture=this.maskTexture,this.displaceFilter.displacementMap=this.dmapTexture,this.unsharpMaskFilter.dimensions=[this.scaledSourceW,this.scaledSourceH],this.unsharpMaskFilter.intensity=this._unsharp,this.unsharpMaskFilter.unblurredTexture=this.snapTexture,this.layerFilter.dimensions=[this.scaledSourceW,this.scaledSourceH],this.layerFilter.fade=this._fade,this.layerFilter.prevIteration=this.prevTexture,this.differenceFilter.dimensions=[this.scaledSourceW,this.scaledSourceH],this.differenceFilter.originalTexture=this.scaledSourceTexture,this.differenceFilter.occlusionTexture=this.omapTexture,this.outputFilter.dimensions=[this.scaledSourceW,this.scaledSourceH],this.outputFilter.differenceMap=this.diffTexture}renderFilter(e,t){if(this.filterSprite||(this.filterSprite=new PIXI.Sprite),this.filterSprite.texture=this.flipTexture,this.filterSprite.filters=[e],BFN.Stage.render(this.filterSprite,t||this.flopTexture),this.filterSprite.texture=PIXI.Texture.EMPTY,this.filterSprite.filters=[],!t){let r=this.flopTexture;this.flopTexture=this.flipTexture,this.flipTexture=r}}processFilters(){if(!!this.scaledSourceTexture){this.updateTextures(),this.updateFilters(),this.colorMode==="lighten"?this.scaledSourceTexture.invert(this.flipTexture):this.flipTexture.copyPixels(this.scaledSourceTexture),this.displacementChanged&&(this.displacementMapFilter.occlusionOnly=!1,this.renderFilter(this.displacementMapFilter,this.dmapTexture)),this.occlusionChanged&&(this.displacementMapFilter.occlusionOnly=!0,this.renderFilter(this.displacementMapFilter,this.omapTexture));for(let e=0;e<this.iterations;e++){let t=!(e%5)||e===this.iterations-1;if(this.prevTexture.copyPixels(this.flipTexture),t)for(let r=0;r<=1;r++)this.minmaxFilter.minmax=r,this.renderFilter(this.minmaxFilter);for(let r=0;r<=3;r++){let a=Math.PI*(r/2),s=Math.round(Math.cos(a))*this._bleed,o=Math.round(Math.sin(a))*this._bleed;this.displaceFilter.displaceMax=[s,o],this.renderFilter(this.displaceFilter)}if(t){this.snapTexture.copyPixels(this.flipTexture);for(let r=0;r<=2;r++)this.unsharpMaskFilter.currentPass=r,this.renderFilter(this.unsharpMaskFilter)}this.layerFilter.invert=this.colorMode==="lighten"&&e===this.iterations-1,this.renderFilter(this.layerFilter)}this.renderFilter(this.differenceFilter,this.diffTexture),this.filterProcessed=!0}}get colorMode(){return this._colorMode}set colorMode(e){this._colorMode=["darken","lighten"].includes(e)?e:"darken"}get size(){return this._size}set size(e){this._size=e}get phase(){return this._phase}set phase(e){this._phase=e}get noise(){return this._noise}set noise(e){this._noise=e}get iterations(){return this._iterations}set iterations(e){this._iterations=e}get bleed(){return this._bleed}set bleed(e){this._bleed=e}get softness(){return this._softness}set softness(e){this._softness=e}get fade(){return this._fade}set fade(e){this._fade=e}get unsharp(){return this._unsharp}set unsharp(e){this._unsharp=e}},VT=LT;var UT="vec3 A(vec3 B,float C){return pow(B,1./vec3(C));}vec3 D(vec3 B,float E,float F){return min(max(B-E,0.)/(F-E+0.0001),1.);}vec3 G(vec3 B,float E,float C,float F){return A(D(B,E,F),C);}vec3 H(vec3 B,float I,float J){return mix(vec3(I),vec3(J),B);}vec3 K(vec3 B,float E,float C,float F,float I,float J){return H(G(B,E,C,F),I,J);}uniform sampler2D uSampler;varying vec2 vTextureCoord;uniform vec4 filterClamp;uniform float PASS;uniform float threshold;uniform float spread;uniform bool maskActive;uniform float maskInverse;uniform sampler2D maskTexture;uniform vec2 dimensions;const float L=3.141592653589793238462;const float M=(L/2.);const float N=0.22;const float O=0.18;const float P=0.13;const float Q=0.08;vec4 C(vec4 B){return pow(B,vec4(1./2.2));}vec4 R(vec4 B){return pow(B,vec4(2.2));}vec2 S(){return(vTextureCoord.xy*((dimensions-vec2(1.))/filterClamp.zw));}vec4 T(sampler2D U,vec2 V,bool W,bool X){vec2 Y=(clamp(V,vec2(0.5),(dimensions-vec2(0.5)))/(dimensions-vec2(1.)));if(W)Y*=filterClamp.zw;vec4 Z=texture2D(U,Y);return X?Z:vec4(Z.rgb,1.);}vec4 a(){vec2 V=S();vec4 Z=T(uSampler,V,true,false);if(maskActive){float b=abs(maskInverse-T(maskTexture,V,false,true).a);Z=vec4(mix(Z.rgb,vec3(0.),b),1.);}Z.rgb=K(Z.rgb,threshold,1.,1.,0.,1.);return Z;}vec4 c(float d,float e){vec2 f=vec2(cos(d),sin(d));vec2 g=S();vec2 h=(g-(f*e*spread*(1./3.)));vec2 i=(g-(f*e*spread*(2./3.)));vec2 j=(g-(f*e*spread*(3./3.)));vec2 k=(g+(f*e*spread*(1./3.)));vec2 l=(g+(f*e*spread*(2./3.)));vec2 m=(g+(f*e*spread*(3./3.)));vec4 n=R(T(uSampler,g,true,true))*N;vec4 o=R(T(uSampler,h,true,true))*O;vec4 p=R(T(uSampler,i,true,true))*P;vec4 q=R(T(uSampler,j,true,true))*Q;vec4 r=R(T(uSampler,k,true,true))*O;vec4 s=R(T(uSampler,l,true,true))*P;vec4 t=R(T(uSampler,m,true,true))*Q;return C(n+o+p+q+r+s+t);}void main(){if(PASS==0.){gl_FragColor=a();return;}gl_FragColor=c((float(mod((PASS-1.),2.))*M),pow(3.,floor((PASS+1.)/2.)));}";var GT=class extends PIXI.Filter{constructor(){super(O,UT);this.padding=0,this.PASS=0,this.threshold=.5,this.spread=.5,this.maskActive=!1,this.maskInverse=!1}get PASS(){return this.uniforms.PASS}set PASS(e){this.uniforms.PASS=e}get threshold(){return this.uniforms.threshold}set threshold(e){this.uniforms.threshold=Math.max(0,Math.min(1,e))}get spread(){return this.uniforms.spread}set spread(e){this.uniforms.spread=Math.max(0,Math.min(1,e))}get maskActive(){return this.uniforms.maskActive}set maskActive(e){this.uniforms.maskActive=!!e}get maskInverse(){return!!this.uniforms.maskInverse}set maskInverse(e){this.uniforms.maskInverse=Number(!!e)}get maskTexture(){return this.uniforms.maskTexture}set maskTexture(e){this.uniforms.maskTexture=e}get dimensions(){return this.uniforms.dimensions}set dimensions(e){this.uniforms.dimensions=e}},HT=GT;var XT=`precision highp float;
#define GLSLIFY 1
uniform sampler2D uSampler;varying vec2 vTextureCoord;uniform vec4 filterClamp;uniform sampler2D emitTexture;uniform vec3 colorRGB;uniform float colorA;uniform float intensity;uniform float attenuation;uniform float tolerance;uniform vec2 dimensions;uniform vec3 lightPos3D;uniform vec2 lightPos2D;uniform float cameraViewportDistanceZ;uniform float lightViewportDistanceZ;uniform int sampleStep;uniform bool draft;uniform bool jitter;uniform int PASS;uniform bool LAST_PASS;const float A=3.141592653589793238462;const float B=(A/2.);const int C=25;const vec3 D=vec3(0.);vec4 E(vec4 F){return pow(F,vec4(1./2.2));}vec4 G(vec4 F){return pow(F,vec4(2.2));}float H(vec3 I){return dot(I,vec3(0.299,0.587,0.114));}float J(vec2 K){return fract(sin(dot(K,vec2(41,289)))*45758.5453);}const float L=2.71828;float M(float N,float distance){return pow(pow((1./L),N),distance);}float O(vec3 P,vec3 Q,vec3 R){float S=(((Q.x-P.x)*(R.x-P.x))+((Q.y-P.y)*(R.y-P.y))+((Q.z-P.z)*(R.z-P.z)));float T=(sqrt(pow((Q.x-P.x),2.)+pow((Q.y-P.y),2.)+pow((Q.z-P.z),2.))*sqrt(pow((R.x-P.x),2.)+pow((R.y-P.y),2.)+pow((R.z-P.z),2.)));if(T==0.)return A;float U=max(0.,min(1.,(S/T)));return acos(U);}const float V=0.2;const float W=1.;const float X=(W-V);float Y(float Z){float a=abs(B-Z);float b=sin(a);float N=5.;float distance=(1.-b);float c=M(N,distance);return((c*X)+V);}const float d=(B-(A/1800.));float e(vec2 f,vec3 g,float h,float i,float j,float k,float N){vec3 l=vec3((f-(dimensions/2.)),cameraViewportDistanceZ);float m=O(lightPos3D,g,l);float n=(h-m);float o=(A-i-n);float p=Y(o);float q=sqrt(pow(j,2.)+pow(lightViewportDistanceZ,2.));float r=min(d,asin(lightViewportDistanceZ/q));float s=((k-j)/cos(r));float t=100.;float u=M(N,(s/t));float v=(u*p);v=clamp((v*(intensity*2.)),0.,1.);return v;}bool w(vec2 x){bool y=true;if(draft){y=y&&(mod(floor(x.x),2.)!=mod(floor(x.y),2.));y=y&&x.x>0.&&x.x<dimensions.x;y=y&&x.y>0.&&x.y<dimensions.y;}return y;}vec4 z(vec2 x){return texture2D(uSampler,(x*(filterClamp.zw/(dimensions-vec2(1.)))));}const vec4 AA=vec4(0.25,0.,0.25,1.);vec4 AB(vec2 x){vec4 AC=AA;if(w(x)){AC=z(x);}else{vec4 AD=vec4(1.);vec4 AE=vec4(0.);vec4 AF=vec4(0.);float AG=0.;for(int AH=0;AH<4;AH++){float AI=(float(AH)*B);float AJ=floor(cos(AI)+0.5);float AK=floor(sin(AI)+0.5);vec2 AL=(x+vec2(AJ,AK));if(w(AL)){vec4 AM=G(z(AL));AD=min(AD,AM);AE=max(AE,AM);AF+=AM;AG+=1.;}}AC=(AG>0.)?E(((AF/AG)+AD+AE)/3.):AA;}return AC;}vec4 AN(vec2 x){vec4 AC=vec4(vec3(0.),1.);if(!LAST_PASS){if(w(x)){AC=z(x);}}else{AC=AB(x);}return AC;}vec4 AO(vec4 AP,vec4 AQ){if(AP.a==0.)return AQ;if(AQ.a==0.)return AP;vec3 AR=(AP.rgb/AP.a);vec3 AS=(AQ.rgb/AQ.a);vec3 AT=mix(AR,AS,(AQ.a*0.5));vec3 AU=AT;if(AP.a<AQ.a){AU=mix(AS,AT,(AP.a/AQ.a));}if(AQ.a<AP.a){AU=mix(AR,AT,(AQ.a/AP.a));}float AV=(AP.a+((1.-AP.a)*AQ.a));vec4 AC=(vec4(AU,1.)*AV);return AC;}const float AW=(2./255.);vec4 AX(vec4 AP,vec4 AQ,float v){if(AQ.a<AW)return AP;vec3 AS=(AQ.rgb/AQ.a);vec3 AR=(AP.a>0.)?(AP.rgb/AP.a):vec3(0.);if(colorRGB.r>=0.){AS=mix(AS,colorRGB,((1.-v)*colorA*H(AS)));}vec3 AY=max(AR,AS);vec4 AZ=(vec4(AY,1.)*AQ.a*v);return AO(AP,AZ);}void main(){vec2 Aa=(((vTextureCoord.xy/filterClamp.zw)*(dimensions-vec2(1.)))/dimensions);if(Aa.x>=1.||Aa.y>=1.){gl_FragColor=vec4(0.);return;}Aa=clamp(Aa,vec2(0.),vec2(1.));vec2 x=(Aa*dimensions);vec3 g=vec3((x-(dimensions/2.)),cameraViewportDistanceZ);vec2 Ab=vec2((lightPos2D.x-x.x),(lightPos2D.y-x.y));float k=sqrt(pow(Ab.x,2.)+pow(Ab.y,2.));float Ac=atan(Ab.y,Ab.x);vec4 Ad=AN(x);if(LAST_PASS){gl_FragColor=Ad;return;}float Ae=float(sampleStep);float j=k;if(jitter)j+=(Ae*J(Aa));j-=Ae;j-=float(PASS*C*sampleStep);if(j<0.){gl_FragColor=Ad;return;}vec4 Af=Ad;float N=M(1.,((1.-attenuation)*10.));float i=O(D,lightPos3D,g);float h=O(lightPos3D,g,D);for(int Ag=0;Ag<C;Ag++){if(j<0.)break;vec2 f=(lightPos2D-(vec2(cos(Ac),sin(Ac))*j));vec4 Ah=texture2D(emitTexture,(f/dimensions));if(Ah.a>0.){float Ai=H(Ah.rgb/Ah.a);Ai=((Ai*(1.-tolerance))+tolerance);Ah*=Ai;if(sampleStep>1){for(int AH=0;AH<10;AH++){if(AH>=sampleStep)break;float Aj=(j+Ae-1.-float(AH));float v=e(f,g,h,i,j,k,N);Af=AX(Af,Ah,v);if(v<0.05)break;}}else{float v=e(f,g,h,i,j,k,N);Af=AX(Af,Ah,v);if(v<0.05)break;}}j-=Ae;}gl_FragColor=Af;}`;var zT=class extends PIXI.Filter{constructor(){super(O,XT);this.padding=0,this.draft=!1,this.PASS=0,this.LAST_PASS=!1,this.color=-1,this.colorIntensity=1,this.intensity=.5,this.attenuation=.5,this.focalPointX=.5,this.focalPointY=.5,this.sampleStep=1,this.dimensions=[0,0]}apply(e,t,r,a){let s=Math.PI/180,n=90*s,l=this.dimensions[0],c=this.dimensions[1],h=Math.max(l,c),u=h/2/Math.tan(n/2),d=h*10,m=u+d,g=Math.tan(n/2)*m*2/h,f=l*g,v=c*g,T=[(this.focalPointX-.5)*f,(this.focalPointY-.5)*v,m],x=[l/2+T[0]*(l/f),c/2+T[1]*(c/v)];this.uniforms.lightPos3D=T,this.uniforms.lightPos2D=x,this.uniforms.cameraViewportDistanceZ=u,this.uniforms.lightViewportDistanceZ=d,this.uniforms.jitter=!0,e.applyFilter(this,t,r,a)}get draft(){return!!this.uniforms.draft}set draft(e){this.uniforms.draft=!!e}get PASS(){return this.uniforms.PASS}set PASS(e){this.uniforms.PASS=e}get LAST_PASS(){return!!this.uniforms.LAST_PASS}set LAST_PASS(e){this.uniforms.LAST_PASS=!!e}get color(){return this.uniforms.colorRGB}set color(e){this.uniforms.colorRGB=e===-1?[-1,-1,-1]:BFN.FilterHelper.hex2rgb(e)}get colorIntensity(){return this.uniforms.colorA}set colorIntensity(e){this.uniforms.colorA=Math.max(0,Math.min(1,e))}get intensity(){return this.uniforms.intensity}set intensity(e){this.uniforms.intensity=e}get attenuation(){return this.uniforms.attenuation}set attenuation(e){this.uniforms.attenuation=e}get tolerance(){return this.uniforms.tolerance}set tolerance(e){this.uniforms.tolerance=e}get focalPointX(){return this._focalPointX}set focalPointX(e){this._focalPointX=e}get focalPointY(){return this._focalPointY}set focalPointY(e){this._focalPointY=e}get sampleStep(){return this.uniforms.sampleStep}set sampleStep(e){this.uniforms.sampleStep=Math.max(1,Math.round(e))}get dimensions(){return this.uniforms.dimensions}set dimensions(e){this.uniforms.dimensions=e}get emitTexture(){return this.uniforms.emitTexture}set emitTexture(e){this.uniforms.emitTexture=e}},WT=zT;var $T="vec4 A(vec4 B,vec4 C){if(B.a==0.){return C;}else if(C.a==0.){return B;}else{float D=clamp((B.a+((1.-B.a)*C.a)),0.,1.);if(D==0.){return vec4(0.);}else{float E=clamp((C.a/(D+0.000001)),0.,1.);vec3 F=(B.a>0.)?(B.rgb/(B.a+0.000001)):vec3(0.);vec3 G=(C.a>0.)?(C.rgb/(C.a+0.000001)):vec3(0.);vec3 H=clamp(((F*(1.-E))+(G*E)),0.,1.);vec4 I=clamp(vec4((H*D),D),0.,1.);return I;}}}vec4 J(vec4 B,vec4 C){if(B.a==0.)return C;if(C.a==0.)return B;float D=clamp((B.a+((1.-B.a)*C.a)),0.,1.);float E=clamp((C.a/D),0.,1.);float K=clamp((B.a/D),0.,1.);vec3 F=((B.a>0.)?(B.rgb/B.a):vec3(0.));vec3 G=((C.a>0.)?(C.rgb/C.a):vec3(0.));vec3 L=((G+F)-(G*F));vec3 H=clamp(((F*(1.-E))+(L*E)),0.,1.);vec4 I=vec4((H*D),D);vec4 M=mix(C,I,K);if(M.a>0.)M*=(D/M.a);M=clamp(M,0.,1.);return M;}vec3 N(vec3 O,float P){return pow(O,1./vec3(P));}vec3 Q(vec3 O,float R,float S){return min(max(O-R,0.)/(S-R+0.0001),1.);}vec3 T(vec3 O,float R,float P,float S){return N(Q(O,R,S),P);}vec3 U(vec3 O,float V,float W){return mix(vec3(V),vec3(W),O);}vec3 X(vec3 O,float R,float P,float S,float V,float W){return U(T(O,R,P,S),V,W);}uniform sampler2D uSampler;varying vec2 vTextureCoord;uniform vec4 filterClamp;uniform vec2 dimensions;uniform sampler2D outputTexture;void main(){vec2 Y=clamp((((vTextureCoord.xy/filterClamp.zw)*(dimensions-vec2(1.)))/dimensions),vec2(0.),vec2(1.));vec4 Z=texture2D(uSampler,vTextureCoord);vec4 a=texture2D(outputTexture,Y);float b=((a.r+a.g+a.b)/3.);a.rgb=X(a.rgb,0.,0.5,1.,0.,1.);float c=max(a.r,max(a.g,a.b));a=clamp((vec4((a.rgb/c),1.)*b),0.,1.);Z=mix(Z,A(Z,a),0.5);vec4 d=J(Z,a);gl_FragColor=d;}";var jT=class extends PIXI.Filter{constructor(){super(O,$T);this.padding=0}get outputTexture(){return this.uniforms.outputTexture}set outputTexture(e){this.uniforms.outputTexture=e}get dimensions(){return this.uniforms.dimensions}set dimensions(e){this.uniforms.dimensions=e}},YT=jT;var qT="uniform sampler2D uSampler;varying vec2 vTextureCoord;void main(){gl_FragColor=texture2D(uSampler,vTextureCoord);}";var KT=class extends PIXI.Filter{constructor(){super(O,qT);this.padding=0,this.color=-1,this.colorIntensity=1,this.intensity=.5,this.attenuation=.5,this.spread=.5,this.threshold=.5,this.tolerance=.5,this.focalPointX=.5,this.focalPointY=.5,this.quality=1,this.handleImagePainterPaintingStartedBind=this.handleImagePainterPaintingStarted.bind(this),this.handleImagePainterBrushDragProcessedBind=this.handleImagePainterBrushDragProcessed.bind(this),this.handleImagePainterPaintUpdatedBind=this.handleImagePainterPaintUpdated.bind(this)}updateMaskDisplay(){if(this.maskTexture&&BFN.ImageEffect.painter.isSetup){let e=BFN.ImageEffect.painter.texture;this.maskTexture.copyPixels(e,void 0,void 0,void 0,{x:this.maskTexture.width/e.width,y:this.maskTexture.height/e.height}),BFN.EffectManager.processEffect()}}handleImagePainterPaintingStarted(e){this.updateMaskDisplay()}handleImagePainterBrushDragProcessed(e){this.awaitingPaint||(this.awaitingPaint=!0,setTimeout(()=>{requestAnimationFrame(()=>{this.awaitingPaint&&(this.updateMaskDisplay(),this.awaitingPaint=!1)})},BFN.frameInterval*5))}handleImagePainterPaintUpdated(e){this.awaitingPaint||this.updateMaskDisplay()}apply(e,t,r,a){this.flipTexture?(this.outputFilter.outputTexture=this.flipTexture,this.outputFilter.apply(e,t,r,!0)):e.applyFilter(this,t,r,a)}setSourceTexture(e){if(e&&e.baseTexture&&e!==this.sourceTexture){this.reset(),this.sourceTexture=e,this.sourceW=e.width,this.sourceH=e.height;let t=Math.max(this.sourceW,this.sourceH),r=1024/t;this.scaledSourceW=Math.min(1024,Math.round(this.sourceW*r)),this.scaledSourceH=Math.min(1024,Math.round(this.sourceH*r)),this.scaledSourceTexture=PIXI.RenderTexture.create(this.scaledSourceW,this.scaledSourceH),this.scaledSourceTexture.copyPixels(this.sourceTexture,void 0,void 0,void 0,{x:this.scaledSourceW/this.sourceW,y:this.scaledSourceH/this.sourceH}),this.scaledSourceTexture.determineTransparency(),BFN.ImageEffect.hidePaint=!0,this.currentImagePainter=BFN.ImagePainterUndoManager.currentImagePainter,this.currentImagePainter&&(this.currentImagePainter.addEventListener(BFN.ImagePainterEvents.PAINTING_STARTED.type,this.handleImagePainterPaintingStartedBind),this.currentImagePainter.addEventListener(BFN.ImagePainterEvents.BRUSH_DRAG_PROCESSED.type,this.handleImagePainterBrushDragProcessedBind)),BFN.ImagePainterUndoManager.addEventListener(BFN.ImagePainterUndoManagerEvents.PAINT_UPDATED.type,this.handleImagePainterPaintUpdatedBind),BFN.ImagePainterUndoManager.addEventListener(BFN.ImagePainterUndoManagerEvents.ALT_TEXTURE_UPDATED.type,this.handleImagePainterPaintUpdatedBind),BFN.ImageEffect.addEventListener(BFN.ImageEffectEvents.INVERSE_PAINT.type,this.handleImagePainterPaintUpdatedBind),BFN.ImageEffect.addEventListener(BFN.ImageEffectEvents.CLEAR_PAINT.type,this.handleImagePainterPaintUpdatedBind)}}reset(){this.filterProcessed=!1;let e=t=>{try{this[t].destroyGC(!0)}catch(r){}delete this[t]};this.sourceTexture=null,this.sourceW=0,this.sourceH=0,e("scaledSourceTexture"),delete this.scaledSourceW,delete this.scaledSourceH,e("flipTexture"),e("flopTexture"),e("emitTexture"),e("maskTexture"),this.texturesGenerated=!1,this.filtersGenerated&&(this.displaceFilter.emitTexture=PIXI.Texture.EMPTY,this.outputFilter.outputTexture=PIXI.Texture.EMPTY),BFN.ImageEffect.hidePaint=!1,this.currentImagePainter&&(this.currentImagePainter.removeEventListener(BFN.ImagePainterEvents.PAINTING_STARTED.type,this.handleImagePainterPaintingStartedBind),this.currentImagePainter.removeEventListener(BFN.ImagePainterEvents.BRUSH_DRAG_PROCESSED.type,this.handleImagePainterBrushDragProcessedBind),delete this.currentImagePainter),BFN.ImagePainterUndoManager.removeEventListener(BFN.ImagePainterUndoManagerEvents.PAINT_UPDATED.type,this.handleImagePainterPaintUpdatedBind),BFN.ImagePainterUndoManager.removeEventListener(BFN.ImagePainterUndoManagerEvents.ALT_TEXTURE_UPDATED.type,this.handleImagePainterPaintUpdatedBind),BFN.ImageEffect.removeEventListener(BFN.ImageEffectEvents.INVERSE_PAINT.type,this.handleImagePainterPaintUpdatedBind),BFN.ImageEffect.removeEventListener(BFN.ImageEffectEvents.CLEAR_PAINT.type,this.handleImagePainterPaintUpdatedBind)}updateTextures(){!this.scaledSourceTexture||this.texturesGenerated||(this.texturesGenerated=!0,this.flipTexture=PIXI.RenderTexture.create(this.scaledSourceW,this.scaledSourceH),this.flopTexture=PIXI.RenderTexture.create(this.scaledSourceW,this.scaledSourceH),this.emitTexture=PIXI.RenderTexture.create(this.scaledSourceW,this.scaledSourceH),this.maskTexture=PIXI.RenderTexture.create(this.scaledSourceW,this.scaledSourceH),this.maskTexture.clear())}updateFilters(){!this.scaledSourceTexture||(this.filtersGenerated||(this.filtersGenerated=!0,this.emitFilter=new BFN.filters.VolumeLightEmitFilter,this.displaceFilter=new BFN.filters.VolumeLightDisplaceFilter,this.outputFilter=new BFN.filters.VolumeLightOutputFilter),this.emitFilter.dimensions=[this.scaledSourceW,this.scaledSourceH],this.emitFilter.maskActive=!!(this.currentImagePainter&&this.currentImagePainter.paintApplied),this.emitFilter.maskInverse=BFN.ImageEffect.inverse,this.emitFilter.maskTexture=this.maskTexture,this.emitFilter.threshold=this._threshold,this.emitFilter.spread=this._spread,this.displaceFilter.dimensions=[this.scaledSourceW,this.scaledSourceH],this.displaceFilter.color=this._color,this.displaceFilter.colorIntensity=this._colorIntensity,this.displaceFilter.intensity=this._intensity,this.displaceFilter.attenuation=this._attenuation,this.displaceFilter.tolerance=this._tolerance,this.displaceFilter.focalPointX=this._focalPointX,this.displaceFilter.focalPointY=this._focalPointY,this.displaceFilter.emitTexture=this.emitTexture,this.outputFilter.dimensions=[this.scaledSourceW,this.scaledSourceH])}renderFilter(e,t,r){if(this.filterSprite||(this.filterSprite=new PIXI.Sprite),this.filterSprite.texture=t||this.flipTexture,this.filterSprite.filters=[e],BFN.Stage.render(this.filterSprite,r||this.flopTexture),this.filterSprite.texture=PIXI.Texture.EMPTY,this.filterSprite.filters=[],!t&&!r){let a=this.flopTexture;this.flopTexture=this.flipTexture,this.flipTexture=a}}processFilters(){if(!this.scaledSourceTexture)return;this.updateTextures(),this.updateFilters();for(let d=0;d<3;d++)this.emitFilter.PASS=d,d?this.renderFilter(this.emitFilter):this.renderFilter(this.emitFilter,this.scaledSourceTexture,this.flipTexture);this.emitTexture.copyPixels(this.flipTexture);let e=this.currentImagePainter&&this.currentImagePainter.mouseDown?0:Math.max(0,Math.min(1,this._quality)),t=1+(9-Math.round(e*9));this.displaceFilter.sampleStep=t,this.displaceFilter.draft=e<1;let r=25,a=this._focalPointX*this.scaledSourceW,s=this._focalPointY*this.scaledSourceH,o=Math.sqrt(a**2+s**2),n=Math.sqrt((this.scaledSourceW-a)**2+s**2),l=Math.sqrt(a**2+(this.scaledSourceH-s)**2),c=Math.sqrt((this.scaledSourceW-a)**2+(this.scaledSourceH-s)**2),h=Math.max(o,n,l,c),u=Math.ceil(h/(r*t));for(let d=0;d<=u;d++)this.displaceFilter.PASS=d,this.displaceFilter.LAST_PASS=d===u,(d<u||this.displaceFilter.draft)&&this.renderFilter(this.displaceFilter);this.filterProcessed=!0}get color(){return this._color}set color(e){this._color=e}get colorIntensity(){return this._colorIntensity}set colorIntensity(e){this._colorIntensity=e}get intensity(){return this._intensity}set intensity(e){this._intensity=e}get attenuation(){return this._attenuation}set attenuation(e){this._attenuation=e}get spread(){return this._spread}set spread(e){this._spread=e}get threshold(){return this._threshold}set threshold(e){this._threshold=e}get tolerance(){return this._tolerance}set tolerance(e){this._tolerance=e}get focalPointX(){return this._focalPointX}set focalPointX(e){this._focalPointX=e}get focalPointY(){return this._focalPointY}set focalPointY(e){this._focalPointY=e}get quality(){return this._quality}set quality(e){this._quality=e}},JT=KT;var QT=`vec2 A(vec2 B,vec4 C){B*=C.xy;B+=C.zw;return B;}vec2 D(vec2 B,vec4 C){B-=C.zw;B/=C.xy;return B;}vec4 E(vec4 F,vec4 G){if(F.a==0.){return G;}else if(G.a==0.){return F;}else{float H=clamp((F.a+((1.-F.a)*G.a)),0.,1.);if(H==0.){return vec4(0.);}else{float I=clamp((G.a/(H+0.000001)),0.,1.);vec3 J=(F.a>0.)?(F.rgb/(F.a+0.000001)):vec3(0.);vec3 K=(G.a>0.)?(G.rgb/(G.a+0.000001)):vec3(0.);vec3 L=clamp(((J*(1.-I))+(K*I)),0.,1.);vec4 M=clamp(vec4((L*H),H),0.,1.);return M;}}}precision highp float;
#define GLSLIFY 1
varying vec2 vTextureCoord;uniform vec4 filterArea;uniform sampler2D imageTexture;uniform vec2 imageDimensions;uniform vec2 filterDimensions;uniform float borderW;uniform float borderH;uniform float cornerRadiusFactor;uniform vec3 outerColor;uniform vec3 innerColor;uniform vec3 matteColor;uniform float outerColorAlpha;uniform float innerColorAlpha;uniform float matteColorAlpha;vec4 N(vec4 outerColor,vec4 innerColor,vec4 O,vec2 P,float Q){vec4 R=innerColor;O.z+=O.x;O.w+=O.y;bool S=(P.x<O.x);bool T=(P.x>O.z);bool U=(P.y<O.y);bool V=(P.y>O.w);bool W=(U&&S);bool X=(U&&T);bool Y=(V&&T);bool Z=(V&&S);if(W||X||Y||Z){R=outerColor;if(W)P=abs(P-O.xy);if(X)P=abs(P-O.zy);if(Y)P=abs(P-O.zw);if(Z)P=abs(P-O.xw);float a=sqrt(pow(P.x,2.)+pow(P.y,2.));if(a<Q){float b=(smoothstep((Q-1.),Q,a)*(1.-pow((1.-clamp((min(P.x,P.y)/Q),0.,1.)),30.)));R=mix(innerColor,outerColor,b);}}return R;}void main(){vec4 c=vec4(((filterDimensions-imageDimensions)/2.),imageDimensions);float d=(min(imageDimensions.x,imageDimensions.y)/2.);float e=(d*cornerRadiusFactor);vec4 f=vec4((c.xy+e),(c.zw-(e*2.)));vec4 g=vec4((c.xy-vec2(borderW,borderH)),vec2((imageDimensions.x+(borderW*2.)),(imageDimensions.y+(borderH*2.))));float h=(d+min(borderW,borderH));float i=(h*cornerRadiusFactor);vec4 j=vec4((g.xy+i),(g.zw-(i*2.)));vec2 k=A(vTextureCoord,filterArea);vec4 R=((outerColor.r==-1.)?vec4(0.):(vec4(outerColor,1.)*outerColorAlpha));bool l=(k.x>=g.x&&k.x<=(g.x+g.z)&&k.y>=g.y&&k.y<=(g.y+g.w));if(l){R=N(R,((innerColor.r==-1.)?vec4(0.):(vec4(innerColor,1.)*innerColorAlpha)),j,k,i);bool m=(k.x>=c.x&&k.x<=(c.x+c.z)&&k.y>=c.y&&k.y<=(c.y+c.w));if(m){vec2 n=((k-c.xy)/c.zw);vec4 o=texture2D(imageTexture,n);o=(o.a==1.||matteColor.r==-1.||matteColorAlpha==0.)?o:E((vec4(matteColor,1.)*matteColorAlpha),o);R=N(R,o,f,k,e);}}gl_FragColor=R;}`;var ZT=class extends PIXI.Filter{constructor(){super(O,QT);this.padding=0,this.imageDimensions=[0,0],this.filterDimensions=[0,0],this.borderW=0,this.borderH=0,this.cornerRadiusFactor=0,this.outerColor="000000",this.innerColor="FFFFFF",this.matteColor=-1,this.outerColorAlpha=1,this.innerColorAlpha=1,this.matteColorAlpha=1}get imageTexture(){return this.uniforms.imageTexture}set imageTexture(e){this.uniforms.imageTexture=e}get imageDimensions(){return this.uniforms.imageDimensions}set imageDimensions(e){this.uniforms.imageDimensions=e}get filterDimensions(){return this.uniforms.filterDimensions}set filterDimensions(e){this.uniforms.filterDimensions=e}get borderW(){return this.uniforms.borderW}set borderW(e){this.uniforms.borderW=e}get borderH(){return this.uniforms.borderH}set borderH(e){this.uniforms.borderH=e}get cornerRadiusFactor(){return this.uniforms.cornerRadiusFactor}set cornerRadiusFactor(e){typeof e=="number"&&(this.uniforms.cornerRadiusFactor=Math.max(0,Math.min(1,e)))}get outerColor(){return this.uniforms.outerColor}set outerColor(e){this.uniforms.outerColor=e===-1?[-1,-1,-1]:BFN.FilterHelper.hex2rgb(e)}get innerColor(){return this.uniforms.innerColor}set innerColor(e){this.uniforms.innerColor=e===-1?[-1,-1,-1]:BFN.FilterHelper.hex2rgb(e)}get matteColor(){return this.uniforms.matteColor}set matteColor(e){this.uniforms.matteColor=e===-1?[-1,-1,-1]:BFN.FilterHelper.hex2rgb(e)}get outerColorAlpha(){return this.uniforms.outerColorAlpha}set outerColorAlpha(e){typeof e=="number"&&(this.uniforms.outerColorAlpha=Math.max(0,Math.min(1,e)))}get innerColorAlpha(){return this.uniforms.innerColorAlpha}set innerColorAlpha(e){typeof e=="number"&&(this.uniforms.innerColorAlpha=Math.max(0,Math.min(1,e)))}get matteColorAlpha(){return this.uniforms.matteColorAlpha}set matteColorAlpha(e){typeof e=="number"&&(this.uniforms.matteColorAlpha=Math.max(0,Math.min(1,e)))}},eF=ZT;var tF="varying vec2 vTextureCoord;varying vec2 vMapCoord;uniform sampler2D uSampler;uniform sampler2D iChannel1;uniform float clampX;uniform float clampY;void main(void){vec4 A=texture2D(uSampler,vTextureCoord);vec4 B=texture2D(iChannel1,vTextureCoord*vec2(clampX,clampY));gl_FragColor=(A*B.a);}";var iF=class extends PIXI.Filter{constructor(){let e=O,t=tF;super(e,t);this.padding=0}apply(e,t,r,a){let s=BFN.FilterHelper.calculateFilterClamp(t,r);this.uniforms.clampX=s.x,this.uniforms.clampY=s.y,e.applyFilter(this,t,r,a)}get iChannel1(){return this.uniforms.iChannel1}set iChannel1(e){this.uniforms.iChannel1=e}},rF=iF;var aF="varying vec2 vTextureCoord;uniform sampler2D uSampler;uniform float thickness;uniform vec4 outlineColor;uniform vec4 filterArea;uniform vec4 filterClamp;vec2 A=vec2(1./filterArea.x,1./filterArea.y);void main(void){const float B=3.14159265358979323846264;vec4 C=texture2D(uSampler,vTextureCoord);vec4 D;float E=0.;vec2 F;for(float G=0.;G<B*2.;G+=%_THICKNESS_%){F.x=vTextureCoord.x+thickness*A.x*cos(G);F.y=vTextureCoord.y+thickness*A.y*sin(G);D=texture2D(uSampler,clamp(F,filterClamp.xy,filterClamp.zw));E=max(E,D.a);}float H=max(E,C.a);gl_FragColor=vec4((C.rgb+outlineColor.rgb*(1.-C.a))*H,H);}";var sF=class extends PIXI.Filter{constructor(e,t){e=e||1;super(O,aF.replace(/%_THICKNESS_%/gi,(1/e).toFixed(7)));this.padding=4,this.uniforms.thickness=e,this.uniforms.outlineColor=new Float32Array([0,0,0,1]),t&&(this.color=t)}get color(){return PIXI.utils.rgb2hex(this.uniforms.outlineColor)}set color(e){PIXI.utils.hex2rgb(e,this.uniforms.outlineColor)}},oF=sF;var nF=`#ifdef GL_OES_standard_derivatives
#extension GL_OES_standard_derivatives:enable
#endif
precision mediump float;
#define GLSLIFY 1
uniform vec4 filterArea;uniform sampler2D uSampler;varying vec2 vTextureCoord;uniform vec2 dimensions;uniform vec2 spriteSize;uniform float useTexture;uniform float getCornerRadiusFromShortestSide;uniform float strokeWidth;uniform float cornerRadius;uniform vec4 strokeColor;uniform vec4 fillColor;uniform float quality;uniform float edgePaddingX;uniform float edgePaddingY;uniform float isHighPerfCanvas;float A(vec2 B,vec2 C,float D){float E=length(max(abs(B)-(C-D),vec2(0.)))-D;float F=0.;
#ifdef GL_OES_standard_derivatives
F=fwidth(E)*quality;
#else
F=0.5*quality;
#endif
if(isHighPerfCanvas<1.){F=0.5*quality;}float G=1.;if(D==0.){G=step(min(C.x,C.y)/min(dimensions.x,dimensions.y),E);}else{G=smoothstep(-F,+F,E);}return G;}void main(){vec2 H=vTextureCoord*filterArea.xy;H-=vec2(edgePaddingX,edgePaddingY);vec2 I=vec2(dimensions.x,dimensions.y)-vec2((edgePaddingX*2.),(edgePaddingY*2.));vec2 C=I/2.;vec2 J=I/2.;float K=cornerRadius;if(spriteSize.x>0.&&spriteSize.y>0.){K=K*min((dimensions.x/spriteSize.x),(dimensions.y/spriteSize.y));}if(getCornerRadiusFromShortestSide==1.){K=min(dimensions.x,dimensions.y)/2.;}float D=max(min(min(I.x,I.y)/2.,K),0.);float L=A(H-J,C,D);vec2 M=vec2(I.x-strokeWidth*2.,I.y-strokeWidth*2.);vec2 N=M/2.;vec2 O=vec2(I/2.);float P=max(D-strokeWidth,0.);float Q=A(H-O,N,P);vec4 R=strokeColor;if(strokeWidth==0.){R=vec4(0.);}vec4 S=fillColor;S.rgb*=S.a;R.rgb*=R.a;vec4 G=mix(R,vec4(0.),L);if(useTexture==0.){G=mix(S,G,Q);}else{vec4 T=texture2D(uSampler,vTextureCoord);G=mix(T,G,Q);}gl_FragColor=G;}`;var lF=class extends PIXI.Filter{constructor(){let e=O,t=nF;super(e,t);this.padding=0,this.cornerRadius=1,this.strokeWidth=4,this.quality=.75,this.edgePadding=1,this.strokeColor=4278190080,this.fillColor=4294967295,this.spriteSize=[0,0],this.useTexture=0,this.getCornerRadiusFromShortestSide=0}apply(e,t,r,a){this.cornerRadius!=0?this.padding=0:this.padding=1,this.uniforms.dimensions[0]=t.sourceFrame.width,this.uniforms.dimensions[1]=t.sourceFrame.height,this.uniforms.isHighPerfCanvas=window.webGLPerformanceIssue=="Yes"?0:1,e.applyFilter(this,t,r,a)}get useTexture(){return this.uniforms.useTexture}set useTexture(e){this.uniforms.useTexture=e}get spriteSize(){return this.uniforms.spriteSize}set spriteSize(e){this.uniforms.spriteSize=e}get cornerRadius(){return this.uniforms.cornerRadius}set cornerRadius(e){this.uniforms.cornerRadius=e}get getCornerRadiusFromShortestSide(){return this.uniforms.getCornerRadiusFromShortestSide}set getCornerRadiusFromShortestSide(e){this.uniforms.getCornerRadiusFromShortestSide=e}get strokeWidth(){return this.uniforms.strokeWidth}set strokeWidth(e){this.uniforms.strokeWidth=e}get quality(){return this.uniforms.quality}set quality(e){this.uniforms.quality=e}get edgePadding(){return this.uniforms.edgePaddingX}set edgePadding(e){this.edgePaddingX=e,this.edgePaddingY=e}get edgePaddingX(){return this.uniforms.edgePaddingX}set edgePaddingX(e){this.uniforms.edgePaddingX=e}get edgePaddingY(){return this.uniforms.edgePaddingY}set edgePaddingY(e){this.uniforms.edgePaddingY=e}get strokeColor(){return this.uniforms.strokeColor}set strokeColor(e){e=BFN.FilterHelper.hex32torgba(e),this.uniforms.strokeColor=e}get fillColor(){return this.uniforms.fillColor}set fillColor(e){e=BFN.FilterHelper.hex32torgba(e),this.uniforms.fillColor=e}},cF=lF;var hF=`#ifdef GL_OES_standard_derivatives
#extension GL_OES_standard_derivatives:enable
#endif
precision mediump float;
#define GLSLIFY 1
uniform vec4 filterArea;uniform sampler2D uSampler;varying vec2 vTextureCoord;uniform vec2 dimensions;uniform float strokeWidth;uniform float quality;uniform vec4 fillColor;uniform vec4 strokeColor;uniform float edgePadding;uniform float isHighPerfCanvas;float A(vec2 B,vec2 C,float D){float E=length(abs(B));float F=0.;
#ifdef GL_OES_standard_derivatives
F=fwidth(E)*quality;
#else
F=0.5*quality;
#endif
if(isHighPerfCanvas<1.){F=0.5*quality;}return smoothstep(D-F,D+F,E);}void main(){vec2 G=vTextureCoord*filterArea.xy;G-=vec2(edgePadding,edgePadding);vec2 H=vec2(dimensions.x,dimensions.y)-vec2(edgePadding*2.);vec2 C=H/2.;vec2 I=H/2.;vec2 J=G-I;vec2 K=G-I;float L=min(H.y/2.-1.,strokeWidth);J.x*=H.y/H.x;K.x*=(H.y-L*2.)/(H.x-L*2.);float M=(H.y/2.);float N=max(M-L,0.);float O=A(J,C,M);float P=A(K,C,N);vec4 Q=strokeColor;if(L==0.){Q=vec4(0.);}vec4 R=fillColor;R.rgb*=R.a;Q.rgb*=Q.a;vec4 S=mix(Q,vec4(0.),O);S=mix(R,S,P);gl_FragColor=S;}`;var uF=class extends PIXI.Filter{constructor(){let e=O,t=hF;super(e,t);this.padding=0,this.strokeWidth=4,this.quality=.75,this.edgePadding=1,this.strokeColor=4278190080,this.fillColor=4294967295}apply(e,t,r,a){this.uniforms.dimensions[0]=t.sourceFrame.width,this.uniforms.dimensions[1]=t.sourceFrame.height,this.uniforms.isHighPerfCanvas=window.webGLPerformanceIssue=="Yes"?0:1,e.applyFilter(this,t,r,a)}get strokeWidth(){return this.uniforms.strokeWidth}set strokeWidth(e){this.uniforms.strokeWidth=e}get quality(){return this.uniforms.quality}set quality(e){this.uniforms.quality=e}get edgePadding(){return this.uniforms.edgePadding}set edgePadding(e){this.uniforms.edgePadding=e}get strokeColor(){return this.uniforms.strokeColor}set strokeColor(e){e=BFN.FilterHelper.hex32torgba(e),this.uniforms.strokeColor=e}get fillColor(){return this.uniforms.fillColor}set fillColor(e){e=BFN.FilterHelper.hex32torgba(e),this.uniforms.fillColor=e}},dF=uF;var mF="uniform vec4 filterArea;uniform sampler2D uSampler;varying vec2 vTextureCoord;uniform vec2 dimensions;uniform float dashSize;uniform float direction;uniform vec4 fillColor;uniform vec4 alternateColor;float A(float B,float C){float D=fract((B)*C);return step(0.5,D);}void main(){vec2 B=vTextureCoord*(filterArea.xy/dimensions);float E;if(direction==-1.){E=dimensions.x>dimensions.y?0.:1.;}else{E=direction;}float F;float G;if(E==0.){F=B.x;G=dimensions.x/dashSize;}else{F=B.y;G=dimensions.y/dashSize;}float H=A(F,G);vec4 I=fillColor;vec4 J=alternateColor;gl_FragColor=mix(I,J,H);}";var pF=class extends PIXI.Filter{constructor(){let e=O,t=mF;super(e,t);this.padding=0,this.dashSize=12,this.fillColor=2516582400,this.alternateColor=2164260863,this.direction=-1}apply(e,t,r,a){this.uniforms.dimensions[0]=t.sourceFrame.width,this.uniforms.dimensions[1]=t.sourceFrame.height,e.applyFilter(this,t,r,a)}get direction(){return this.uniforms.direction}set direction(e){this.uniforms.direction=e}get dashSize(){return this.uniforms.dashSize}set dashSize(e){this.uniforms.dashSize=e}get fillColor(){return this.uniforms.fillColor}set fillColor(e){e=BFN.FilterHelper.hex32torgba(e),this.uniforms.fillColor=e}get alternateColor(){return this.uniforms.alternateColor}set alternateColor(e){e=BFN.FilterHelper.hex32torgba(e),this.uniforms.alternateColor=e}},fF=pF;Object.assign(BFN.filters,{RoundedRectFilter:cF,EllipseFilter:dF,DashedLineFilter:fF});Object.assign(BFN.filters,{NoneFilters:Hh,ColorFilter:Wh,ExposureFilter:Yh,LensTintFilter:Jh,HSFilter:eu,FillLightFilter:au,GaussianBlurFilter:du,GrayFilter:gu,InvertFilter:yu,InvertShader:Tu,FillAlphaFilter:bu,FillAlphaShader:Su,AlphaToLumaFilter:_u,AlphaToLumaShader:Eu,LumaToAlphaFilter:Nu,LumaToAlphaShader:Du,LevelsFilter:Au,LutFilter:Vu,SurfaceBlurFilter:Ju,UnsharpMaskFilter:td,AdaptiveSharpnessFilter:sd,VibranceFilter:cd,RgbToLabFilter:qu,ClarityFilter:md,VignetteFilter:gd,BrushFilter:Td,PixelateFilter:Sd,AlphaBlendFilter:Cd,HalftoneFilter:Nd,BlendModeFilter:rm,BlackWhiteFilter:dm,CurvesFilter:fm,ChannelMixerFilter:ym,CyanotypeFilter:_m,MaskVignetteFilter:Pm,CharcoalFilter:Dm,SepiaFilter:Am,UnitedColorsFilter:Lm,InstantFilter:qm,TintFilter:Qm,TinyTypeFilter:tp,BrightnessContrastFilter:ap,VintageColorsFilter:dp,HolgaArtFilter:yp,LineArtopiaFilter:Bp,HDRFilter:_p,MotionBlurFilter:Pp,SigmoidFilter:Dp,ShiftChannelFilter:Ap,FisheyeFilter:Lp,NoiseFilter:Gp,StencilerFilter:Zp,GrungeFilter:pf,SunburstFilter:bf,AdaptiveContrastLegFilter:If,OldPhotoFilter:zf,DuoToneFilter:jf,WinterFilter:Jf,TiltShiftFilter:tg,PatrioticFilter:hg,PopArtFilter:Pg,OffsetFilter:Dg,TintDuoFilter:Ag,BeautifyFilter:Lg,FastBlurFilter:$g,FastBlurWrapper:Yg,OrtonStyleFilter:Jg,MotionColorFilter:av,PinholeFilter:uv,LomoArtFilter:xv,CrossProcessFilter:bv,SkinCandidateFilter:Iv,TouchUpFilter:Uv,UnPremultiplyFilter:Xv,ColorMixerFilter:$v,SoftenFilter:qv,SmoothingFilter:Qv,BlurEdgesFilter:ty,AutoEnhanceFilter:ay,ColorOverlayFilter:ny,ColorOffsetFilter:hy,ColorReplaceFilter:my,LiquifyBrushFilter:gy,DisplacementFilter:xy,ReplaceFilter:by,AlphaMaskFilter:Iy,MaskBlendFilter:Ey,OuterGlowFilter:My,GlowPrepFilter:ky,GlowPostFilter:Ry,GrainFilter:Uy,ScanLinesFilter:Xy,SweepFilter:$y,InvertChannelFilter:qy,DirectionalBlurFilter:Qy,GlitchCorruptedFilter:tx,GlitchDistortedFilter:ax,GlitchSegmentedFilter:nx,GlitchFragmentedFilter:hx,GlitchDigitizedFilter:mx,TelevisionFilter:gx,ChromaticAberrationFilter:xx,AnamorphicFilter:bx,LensDistortionFilter:Ix,HalftoneDuoFilter:Ex,ColorGradingFilter:Mx,WarpedBlurFilter:kx,BokehBlurFilter:zx,BokehBGBlurFilter:jx,BokehGentleBlurFilter:Kx,MagicBrushFilter:Zx,PlainFilter:iT,OutlineFilter:oF,BilateralBlurFilter:oT,BackgroundFillFilter:cT,TriMapColorFilter:dT,TransparentBackgroundFixFilter:rF,CutoutMaskFilter:fT,MinMaxFilter:yT,ColorBleedDisplacementMapFilter:FT,ColorBleedDisplaceFilter:ST,ColorBleedUnsharpMaskFilter:CT,ColorBleedLayerFilter:NT,ColorBleedDifferenceMapFilter:wT,ColorBleedOutputFilter:OT,ColorBleedFilter:VT,VolumeLightEmitFilter:HT,VolumeLightDisplaceFilter:WT,VolumeLightOutputFilter:YT,VolumeLightFilter:JT,BorderFilter:eF});var gF=class extends PIXI.Sprite{constructor(){super();this.initialized=!1}initEffect(){this.sourceTexture=null,this.isSetup=!1,this.uiControls=new Array,this.blurFilter=new BFN.filters.FastBlurWrapper(null,null,!0),this.clarityFilter=new BFN.filters.ClarityFilter,this.blurTexture=null}setupEffect(e){this.initialized||(this.initialized=!0,this.initEffect()),this.disposeEffect(),this.sourceTexture=e,this.isSetup=!0,this.texture=this.sourceTexture,this.blurTexture=this.blurFilter.render(.4,this.sourceTexture),this.clarityFilter.blurImage=this.blurTexture}applyEffect(e,t){this.clarityFilter.intensity=t.clarity_amount,this.clarityFilter.resolution=1,this.filters=[this.clarityFilter]}disposeEffect(){this.sourceTexture=null,this.isSetup=!1,this.blurTexture&&(this.blurTexture=null),this.blurFilter.dispose()}};BFN.effects.ClarityEffect=new gF;var vF=class extends PIXI.Sprite{constructor(){super();this.initialized=!1}initEffect(){this.sourceTexture=null,this.isSetup=!1,this.uiControls=new Array,this.colorFilter=BFN.ShaderPool.ColorFilter,this.pluginName="filter_renderer"}setupEffect(e){this.initialized||(this.initialized=!0,this.initEffect()),this.disposeEffect(),this.sourceTexture=e,this.isSetup=!0,this.texture=this.sourceTexture}applyEffect(e,t){this.colorFilter.hue=t.hue,this.colorFilter.saturation=t.saturation,this.colorFilter.temperature=t.temperature,this.bfn_shaders=[this.colorFilter]}disposeEffect(){this.sourceTexture=null,this.isSetup=!1,this.texture=PIXI.Texture.EMPTY,this.filters=null}};BFN.effects.ColorEffect=new vF;var yF=class extends PIXI.Sprite{constructor(){super();this.initialized=!1}initEffect(){this.sourceTexture=null,this.isSetup=!1,this.uiControls=new Array,this.pluginName="filter_renderer",this.replaceColorFilter=BFN.ShaderPool.ColorReplaceFilter}setupEffect(e){this.initialized||(this.initialized=!0,this.initEffect()),this.disposeEffect(),this.sourceTexture=e,this.isSetup=!0,this.texture=this.sourceTexture}applyEffect(e,t){this.replaceColorFilter.sourceColor=t.source_color,this.replaceColorFilter.tolerance=t.tolerance/100,this.replaceColorFilter.preserveLuminosity=t.preserve_luminosity?1:0,t.target_color==-1?(this.replaceColorFilter.targetColor="FFFFFF",this.replaceColorFilter.targetAlpha=0,this.outputTransparent=!0):(this.replaceColorFilter.targetColor=t.target_color,this.replaceColorFilter.targetAlpha=t.target_color_intensity,this.outputTransparent=!1),this.bfn_shaders=[this.replaceColorFilter]}disposeEffect(){this.sourceTexture=null,this.isSetup=!1,this.texture=PIXI.Texture.EMPTY,this.filters=null}};BFN.effects.ReplaceColorEffect=new yF;var xF=class extends PIXI.Sprite{constructor(){super();this.initialized=!1}initEffect(){this.sourceTexture=null,this.isSetup=!1,this.uiControls=new Array,this.currentPresetID=null,this.effectTexture=null,this.__filters={};for(let e in BFN.CONST.ANALOG_PRESETS)this.__filters[BFN.CONST.ANALOG_PRESETS[e]]=new BFN.filters.LutFilter;for(let e in BFN.CONST.BWFX_PRESETS)this.__filters[BFN.CONST.BWFX_PRESETS[e]]=new BFN.filters.LutFilter;for(let e in BFN.CONST.WARMFX_PRESETS)this.__filters[BFN.CONST.WARMFX_PRESETS[e]]=new BFN.filters.LutFilter;this.exposureFilter=new BFN.filters.HSFilter,this.isBlurSetup=!1,this.blurFilter=new BFN.filters.FastBlurWrapper(null,null,!0),this.blurTexture=null}setupEffect(e){this.initialized||(this.initialized=!0,this.initEffect()),this.disposeEffect(),this.sourceTexture=e,this.isSetup=!0,this.texture=this.sourceTexture}applyEffect(e,t,r){if(this.resolution=e,this.parameters=t,t.hasOwnProperty("presetID")&&this.__filters.hasOwnProperty(t.presetID)){this.currentPresetID=t.presetID;let a=this.__filters[this.currentPresetID];t.hasOwnProperty("imageURL")&&(this.effectTexture||(this.effectTexture=BFN.XMLGraphicLoader.getGraphicByName(t.imageURL,512,512))),a.iChannel1=this.effectTexture,a.intensity=1,t.hasOwnProperty("highlights")&&t.hasOwnProperty("shadows")&&(t.highlights!=0||t.shadows!=0)?(this.exposureFilter.highlights=t.highlights,this.exposureFilter.shadows=t.shadows,this.filters=[this.exposureFilter,a]):this.filters=[a]}}handleEffectTextureLoaderTextureLoaded(e){BFN.EffectManager.currentEffect==this?BFN.EffectManager.processEffect():this.applyEffect(this.resolution,this.parameters)}setupBlur(){this.blurTexture=this.blurFilter.render(.8,this.sourceTexture),this.isBlurSetup=!0}disposeEffect(){this.sourceTexture=null,this.isSetup=!1,this.isBlurSetup=!1,this.currentPresetID=null,this.effectTexture!=null&&(this.effectTexture.destroyGC(!0),this.effectTexture=null),this.blurTexture!=null&&(this.blurTexture=null),this.blurFilter.dispose()}};BFN.effects.AnalogEffect=new xF;var TF=class extends PIXI.Sprite{constructor(){super();this.initialized=!1}initEffect(){this.sourceTexture=null,this.isSetup=!1,this.uiControls=new Array,this.exposureFilter=BFN.ShaderPool.ExposureFilter,this.blurFilter=new BFN.filters.FastBlurWrapper(null,null,!0),this.blurTexture=null,this.pluginName="filter_renderer"}setupEffect(e){this.initialized||(this.initialized=!0,this.initEffect()),this.disposeEffect(),this.sourceTexture=e,this.isSetup=!0,this.texture=this.sourceTexture,this.blurTexture=this.blurFilter.render(.05,this.sourceTexture),this.exposureFilter.blurImage=this.blurTexture}applyEffect(e,t){this.exposureFilter.brightness=t.brightness,this.exposureFilter.contrast=t.contrast,this.exposureFilter.highlights=t.highlights,this.exposureFilter.shadows=t.shadows,this.bfn_shaders=[this.exposureFilter]}disposeEffect(){this.sourceTexture=null,this.isSetup=!1,this.blurFilter.dispose(),this.blurTexture=null,this.texture=PIXI.Texture.EMPTY,this.filters=null}};BFN.effects.ExposureEffect=new TF;var FF=class extends PIXI.Sprite{constructor(){super();this.initialized=!1}initEffect(){this.sourceTexture=null,this.isSetup=!1,this.uiControls=new Array,this.blurFilter=new BFN.filters.FastBlurWrapper(null,null,!0),this.fillLightFilter=BFN.ShaderPool.FillLightFilter,this.pluginName="filter_renderer",this.blurTexture=null}setupEffect(e){this.initialized||(this.initialized=!0,this.initEffect()),this.disposeEffect(),this.sourceTexture=e,this.isSetup=!0,this.texture=this.sourceTexture,this.blurTexture=this.blurFilter.render(.4,this.sourceTexture),this.fillLightFilter.blurImage=this.blurTexture}applyEffect(e,t){this.fillLightFilter.intensity=t.light_amount,this.bfn_shaders=[this.fillLightFilter]}disposeEffect(){this.sourceTexture=null,this.isSetup=!1,this.blurTexture&&(this.blurTexture=null),this.blurFilter.dispose()}};BFN.effects.FillLightEffect=new FF;var bF=class extends PIXI.Sprite{constructor(){super();this.initialized=!1}initEffect(){this.sourceTexture=null,this.isSetup=!1,this.gaussianBlurFilter=new BFN.filters.FastBlurWrapper}setupEffect(e){this.initialized||(this.initialized=!0,this.initEffect()),this.disposeEffect(),this.sourceTexture=e,this.isSetup=!0,this.texture=this.sourceTexture}applyEffect(e,t){let r=t.blur_amount*1+0;BeFunky.log(t.blur_amount);let a=[];a=a.concat(this.gaussianBlurFilter.apply(t.blur_amount)),this.filters=a}disposeEffect(){this.sourceTexture=null,this.isSetup=!1,this.texture=PIXI.Texture.EMPTY,this.filters=null}};BFN.effects.GaussianBlurEffect=new bF;var BF=class extends PIXI.Sprite{constructor(){super();this.initialized=!1}initEffect(){this.sourceTexture=null,this.isSetup=!1,this.uiControls=new Array,this.grayFilter=new BFN.filters.GrayFilter}setupEffect(e){this.initialized||(this.initialized=!0,this.initEffect()),this.disposeEffect(),this.sourceTexture=e,this.isSetup=!0,this.texture=this.sourceTexture}applyEffect(e,t){this.grayFilter.resolution=1,this.grayFilter.amount=t.gray_amount,this.filters=[this.grayFilter]}disposeEffect(){this.sourceTexture=null,this.isSetup=!1,this.texture=PIXI.Texture.EMPTY,this.filters=null}};BFN.effects.GrayEffect=new BF;var SF=class extends PIXI.Sprite{constructor(){super();this.initialized=!1}initEffect(){this.sourceTexture=null,this.isSetup=!1,this.uiControls=new Array,this.invertFilter=new BFN.filters.InvertFilter}setupEffect(e){this.initialized||(this.initialized=!0,this.initEffect()),this.disposeEffect(),this.sourceTexture=e,this.isSetup=!0,this.texture=this.sourceTexture}applyEffect(e,t){this.invertFilter.resolution=e,this.invertFilter.amount=t.invert_amount,this.filters=[this.invertFilter]}disposeEffect(){this.sourceTexture=null,this.isSetup=!1,this.texture=PIXI.Texture.EMPTY,this.filters=null}};BFN.effects.InvertEffect=new SF;var IF=class extends PIXI.Sprite{constructor(){super();this.initialized=!1}initEffect(){this.sourceTexture=null,this.isSetup=!1,this.uiControls=new Array,this.levelsFilter=new BFN.filters.LevelsFilter}setupEffect(e){this.initialized||(this.initialized=!0,this.initEffect()),this.disposeEffect(),this.sourceTexture=e,this.isSetup=!0,this.texture=this.sourceTexture}applyEffect(e,t){this.levelsFilter.minInputValue=t.min_input,this.levelsFilter.gamma=t.gamma,this.levelsFilter.maxInputValue=t.max_input,this.levelsFilter.minOutputValue=t.min_output,this.levelsFilter.maxOutputValue=t.max_output,this.filters=[this.levelsFilter]}disposeEffect(){this.sourceTexture=null,this.isSetup=!1,this.texture=PIXI.Texture.EMPTY,this.filters=null}};BFN.effects.LevelsEffect=new IF;var _F=class extends PIXI.Sprite{constructor(){super();this.initialized=!1}initEffect(){this.sourceTexture=null,this.isSetup=!1,this.uiControls=new Array,this.blurFilterNormal=new BFN.filters.FastBlurWrapper(null,null,!1),this.blurFilterSmart=new BFN.filters.FastBlurWrapper(null,null,!0),this.unsharpMaskFilter=new BFN.filters.UnsharpMaskFilter,this.sharpenMode=null,this.blurTextureSmart=null,this.blurTextureNormal=null}setupEffect(e){this.initialized||(this.initialized=!0,this.initEffect()),this.disposeEffect(),this.sourceTexture=e,this.isSetup=!0,this.texture=this.sourceTexture,this.sharpenMode=null,this.blurTextureSmart=null,this.blurTextureNormal=null}applyEffect(e,t){if(this.sharpenMode!=t.mode)switch(this.sharpenMode=t.mode,this.sharpenMode){case"smart":this.blurTextureSmart||(this.blurTextureSmart=this.blurFilterSmart.render(.3,this.sourceTexture,null,!0)),this.unsharpMaskFilter.intensityMultiplier=1.5,this.unsharpMaskFilter.blurImage=this.blurTextureSmart;break;case"normal":this.blurTextureNormal||(this.blurTextureNormal=this.blurFilterNormal.render(.025,this.sourceTexture,null,!0)),this.unsharpMaskFilter.intensityMultiplier=5,this.unsharpMaskFilter.blurImage=this.blurTextureNormal;break}this.unsharpMaskFilter.intensity=t.unsharp_amount,this.unsharpMaskFilter.resolution=1,this.filters=[this.unsharpMaskFilter]}disposeEffect(){this.sourceTexture=null,this.isSetup=!1,this.sharpenMode=null,this.blurTextureSmart&&(this.blurTextureSmart=null),this.blurFilterSmart.dispose(),this.blurTextureNormal&&(this.blurTextureNormal=null),this.blurFilterNormal.dispose()}};BFN.effects.UnsharpMaskEffect=new _F;var CF=class extends PIXI.Sprite{constructor(){super();this.initialized=!1}initEffect(){this.sourceTexture=null,this.isSetup=!1,this.uiControls=new Array,this.vibranceFilter=BFN.ShaderPool.VibranceFilter,this.pluginName="filter_renderer"}setupEffect(e){this.initialized||(this.initialized=!0,this.initEffect()),this.disposeEffect(),this.sourceTexture=e,this.isSetup=!0,this.texture=this.sourceTexture}applyEffect(e,t){this.vibranceFilter.resolution=1,this.vibranceFilter.amount=t.vibrance_amount,this.bfn_shaders=[this.vibranceFilter]}disposeEffect(){this.sourceTexture=null,this.isSetup=!1,this.texture=PIXI.Texture.EMPTY,this.filters=null}};BFN.effects.VibranceEffect=new CF;var EF=class extends PIXI.Sprite{constructor(){super();this.initialized=!1}initEffect(){this.sourceTexture=null,this.isSetup=!1,this.uiControls=new Array,this.vignetteFilter=new BFN.filters.VignetteFilter}setupEffect(e){this.initialized||(this.initialized=!0,this.initEffect()),this.disposeEffect(),this.sourceTexture=e,this.isSetup=!0,this.texture=this.sourceTexture}applyEffect(e,t){this.vignetteFilter.resolution=1,this.vignetteFilter.amount=t.vignette_amount,this.vignetteFilter.softness=t.vignette_softness,this.filters=[this.vignetteFilter]}disposeEffect(){this.sourceTexture=null,this.isSetup=!1,this.texture=PIXI.Texture.EMPTY,this.filters=null}};BFN.effects.VignetteEffect=new EF;var PF=class extends PIXI.Sprite{constructor(){super();this.initialized=!1}initEffect(){this.sourceTexture=null,this.isSetup=!1,this.uiControls=new Array,this.uiControls.push({id:"dotsize",name:"Dot Size",type:"slider",min:3,max:50,step:1,default:10}),this.halftoneFilter=new BFN.filters.HalftoneFilter}setupEffect(e){this.initialized||(this.initialized=!0,this.initEffect()),this.disposeEffect(),this.sourceTexture=e,this.isSetup=!0,this.texture=this.sourceTexture}applyEffect(e,t){this.halftoneFilter.circleSize=t.dotsize,this.filters=[this.halftoneFilter]}disposeEffect(){this.sourceTexture=null,this.isSetup=!1,this.texture=PIXI.Texture.EMPTY,this.filters=null}};BFN.effects.HalftoneEffect=new PF;var NF=class extends PIXI.Sprite{constructor(){super();this.initialized=!1}initEffect(){this.sourceTexture=null,this.isSetup=!1,this.handleEffectTextureLoaderTextureLoadedBind=this.handleEffectTextureLoaderTextureLoaded.bind(this),this.effectTextureLoader=null,this.effectTexture=null,this.currentPresetID=null,this.bw9Setup=!1,this.bwFilters={};for(let e in BFN.CONST.BLACK_WHITE_PRESETS)BFN.CONST.BLACK_WHITE_PRESETS[e]==BFN.CONST.BLACK_WHITE_PRESETS.PRESET_9?this.bwFilters[BFN.CONST.BLACK_WHITE_PRESETS[e]]=new BFN.filters.BlendModeFilter(BFN.CONST.BLEND_MODES.OVERLAY):this.bwFilters[BFN.CONST.BLACK_WHITE_PRESETS[e]]=new BFN.filters.BlackWhiteFilter(BFN.CONST.BLACK_WHITE_PRESETS[e]);this.exposureFilter=new BFN.filters.HSFilter}setupEffect(e){this.initialized||(this.initialized=!0,this.initEffect()),this.disposeEffect(),this.sourceTexture=e,this.isSetup=!0,this.texture=this.sourceTexture}applyEffect(e,t,r){if(this.resolution=e,this.parameters=t,t.hasOwnProperty("presetID")&&this.bwFilters.hasOwnProperty(t.presetID)){this.currentPresetID=t.presetID;let a=this.bwFilters[this.currentPresetID];if(t.hasOwnProperty("imageURL")&&(this.effectTextureLoader||(this.effectTextureLoader=new BFN.EffectTextureLoader,this.effectTextureLoader.addEventListener(BFN.EffectTextureLoaderEvents.TEXTURE_LOADED.type,this.handleEffectTextureLoaderTextureLoadedBind)),!this.effectTexture&&!this.effectTextureLoader.loading&&(r==!0?this.effectTexture=BFN.XMLGraphicLoader.getGraphicByName(t.imageURL,this.sourceTexture.width,this.sourceTexture.height):this.effectTexture=this.effectTextureLoader.getTexture(BFN.originalTextureURl+t.imageURL,this.sourceTexture.width,this.sourceTexture.height))),this.effectTextureLoader!=null&&this.effectTextureLoader.loading){this.filters=[];return}if(this.effectTextureLoader!=null&&(this.effectTextureLoader.removeEventListener(BFN.EffectTextureLoaderEvents.TEXTURE_LOADED.type,this.handleEffectTextureLoaderTextureLoadedBind),this.effectTextureLoader.destroy(),this.effectTextureLoader=null),t.hasOwnProperty("modeBW")&&t.hasOwnProperty("modeColor")&&(a.mode=t.modeBW,a.color=t.modeColor),t.hasOwnProperty("highlights")&&t.hasOwnProperty("shadows")){if(t.highlights!=0||t.shadows!=0){this.exposureFilter.highlights=t.highlights,this.exposureFilter.shadows=t.shadows,this.filters=[this.exposureFilter,a];return}}else this.currentPresetID==BFN.CONST.BLACK_WHITE_PRESETS.PRESET_9&&(this.bw9Setup||(this.setupBw9(),a.iChannel1=this.effectTexture));this.filters=[a]}}handleEffectTextureLoaderTextureLoaded(e){BFN.EffectManager.currentEffect==this?BFN.EffectManager.processEffect():this.applyEffect(this.resolution,this.parameters)}setupBw9(){let e=new BFN.filters.ChannelMixerFilter,t=PIXI.RenderTexture.create(this.sourceTexture.width,this.sourceTexture.height),r=new PIXI.Sprite;r.texture=this.sourceTexture,e.redAmount=.5,e.greenAmount=.25,e.blueAmount=.25,r.filters=[e],BFN.Stage.render(r,t);let a=new BFN.filters.CurvesFilter([[0,28],[23,48],[68,105],[96,146],[118,180],[145,205],[177,214],[212,225],[255,242]],[[0,29],[21,46],[54,85],[89,137],[107,162],[120,180],[133,189],[197,212],[252,230]],[[0,31],[41,70],[113,168],[148,197],[186,207],[255,229]]),s=PIXI.RenderTexture.create(this.sourceTexture.width,this.sourceTexture.height),o=new PIXI.Sprite;o.texture=t,o.filters=[a],BFN.Stage.render(o,s),this.texture=s,o.filters=[],o=null,r.filters=[],r=null,t.destroyGC(!0),t=null,this.bw9Setup=!0}disposeEffect(){this.sourceTexture=null,this.isSetup=!1,this.currentPresetID=null,this.effectTexture!=null&&(this.effectTexture.destroyGC(!0),this.effectTexture=null),this.bw9Setup&&this.texture!=null&&this.texture!=this.sourceTexture&&(this.texture.destroyGC(!0),this.texture=null),this.bw9Setup=!1,this.effectTextureLoader!=null&&(this.effectTextureLoader.removeEventListener(BFN.EffectTextureLoaderEvents.TEXTURE_LOADED.type,this.handleEffectTextureLoaderTextureLoadedBind),this.effectTextureLoader.destroy(),this.effectTextureLoader=null)}};BFN.effects.BlackWhiteEffect=new NF;var MF=class extends PIXI.Sprite{constructor(){super();this.initialized=!1}initEffect(){this.sourceTexture=null,this.isSetup=!1,this.curvesSetup=!1,this.handleEffectTextureLoaderTextureLoadedBind=this.handleEffectTextureLoaderTextureLoaded.bind(this),this.effectTextureLoader=null,this.currentPresetID=null,this.effectTexture=null,this.__filters={};for(let e in BFN.CONST.CHROMATIC_PRESETS)switch(BFN.CONST.CHROMATIC_PRESETS[e]){case BFN.CONST.CHROMATIC_PRESETS.PRESET_1:case BFN.CONST.CHROMATIC_PRESETS.PRESET_2:case BFN.CONST.CHROMATIC_PRESETS.PRESET_4:case BFN.CONST.CHROMATIC_PRESETS.PRESET_5:case BFN.CONST.CHROMATIC_PRESETS.PRESET_6:case BFN.CONST.CHROMATIC_PRESETS.PRESET_9:case BFN.CONST.CHROMATIC_PRESETS.PRESET_10:this.__filters[BFN.CONST.CHROMATIC_PRESETS[e]]=new BFN.filters.BlendModeFilter(BFN.CONST.BLEND_MODES.OVERLAY);break;case BFN.CONST.CHROMATIC_PRESETS.PRESET_3:case BFN.CONST.CHROMATIC_PRESETS.PRESET_8:this.__filters[BFN.CONST.CHROMATIC_PRESETS[e]]=new BFN.filters.CurvesFilter;break;case BFN.CONST.CHROMATIC_PRESETS.PRESET_7:this.__filters[BFN.CONST.CHROMATIC_PRESETS[e]]=new BFN.filters.MaskVignetteFilter;break}}setupEffect(e){this.initialized||(this.initialized=!0,this.initEffect()),this.disposeEffect(),this.sourceTexture=e,this.isSetup=!0,this.texture=this.sourceTexture}applyEffect(e,t,r){if(this.resolution=e,this.parameters=t,t.hasOwnProperty("presetID")&&this.__filters.hasOwnProperty(t.presetID)){this.currentPresetID=t.presetID;let a=this.__filters[this.currentPresetID];if(t.hasOwnProperty("imageURL")&&(this.effectTextureLoader||(this.effectTextureLoader=new BFN.EffectTextureLoader,this.effectTextureLoader.addEventListener(BFN.EffectTextureLoaderEvents.TEXTURE_LOADED.type,this.handleEffectTextureLoaderTextureLoadedBind)),!this.effectTexture&&!this.effectTextureLoader.loading&&(r==!0?this.effectTexture=BFN.XMLGraphicLoader.getGraphicByName(t.imageURL,this.sourceTexture.width,this.sourceTexture.height):this.effectTexture=this.effectTextureLoader.getTexture(BFN.originalTextureURl+t.imageURL,this.sourceTexture.width,this.sourceTexture.height))),this.effectTextureLoader!=null&&this.effectTextureLoader.loading){this.filters=[];return}switch(this.effectTextureLoader!=null&&(this.effectTextureLoader.removeEventListener(BFN.EffectTextureLoaderEvents.TEXTURE_LOADED.type,this.handleEffectTextureLoaderTextureLoadedBind),this.effectTextureLoader.destroy(),this.effectTextureLoader=null),this.currentPresetID){case BFN.CONST.CHROMATIC_PRESETS.PRESET_1:case BFN.CONST.CHROMATIC_PRESETS.PRESET_6:this.curvesSetup||(this.setupCurves(BFN.CONST.PALETTE_MAPS.retroCol1),a.iChannel1=this.effectTexture);break;case BFN.CONST.CHROMATIC_PRESETS.PRESET_2:this.curvesSetup||(this.setupCurves(BFN.CONST.PALETTE_MAPS.retroCol2),a.iChannel1=this.effectTexture);break;case BFN.CONST.CHROMATIC_PRESETS.PRESET_3:a.doFilter(BFN.CONST.PALETTE_MAPS.retroCol3[0],BFN.CONST.PALETTE_MAPS.retroCol3[1],BFN.CONST.PALETTE_MAPS.retroCol3[2]);break;case BFN.CONST.CHROMATIC_PRESETS.PRESET_4:this.curvesSetup||(this.setupCurves(BFN.CONST.PALETTE_MAPS.retroCol4),a.iChannel1=this.effectTexture);break;case BFN.CONST.CHROMATIC_PRESETS.PRESET_5:this.curvesSetup||(this.setupCurves(BFN.CONST.PALETTE_MAPS.retroCol5),a.iChannel1=this.effectTexture);break;case BFN.CONST.CHROMATIC_PRESETS.PRESET_7:this.curvesSetup||(a.iChannel1=this.PRESET_7());break;case BFN.CONST.CHROMATIC_PRESETS.PRESET_8:a.doFilter(BFN.CONST.PALETTE_MAPS.retroCol7[0],BFN.CONST.PALETTE_MAPS.retroCol7[1],BFN.CONST.PALETTE_MAPS.retroCol7[2]);break;case BFN.CONST.CHROMATIC_PRESETS.PRESET_9:this.curvesSetup||(this.setupCurves(BFN.CONST.PALETTE_MAPS.MegaContrast1,BFN.CONST.PALETTE_MAPS.MegaContrast2),a.iChannel1=this.effectTexture);break;case BFN.CONST.CHROMATIC_PRESETS.PRESET_10:this.curvesSetup||(this.setupCurves(BFN.CONST.PALETTE_MAPS.retroCol8),a.iChannel1=this.effectTexture);break}this.filters=[a]}}handleEffectTextureLoaderTextureLoaded(e){BFN.EffectManager.currentEffect==this?BFN.EffectManager.processEffect():this.applyEffect(this.resolution,this.parameters)}setupCurves(e,t){this.curvesSetup=!0;let r=e.length==3?new BFN.filters.CurvesFilter(e[0],e[1],e[2]):e.length==2?new BFN.filters.CurvesFilter(e[0],e[1]):new BFN.filters.CurvesFilter(e);this.curvesTexture=PIXI.RenderTexture.create(this.sourceTexture.width,this.sourceTexture.height);let a=new PIXI.Sprite;a.texture=this.sourceTexture,a.filters=[r],BFN.Stage.render(a,this.curvesTexture);try{r.dispose()}catch(s){}if(a=null,r=null,t!=null){let s=t.length==3?new BFN.filters.CurvesFilter(t[0],t[1],t[2]):t.length==2?new BFN.filters.CurvesFilter(t[0],t[1]):new BFN.filters.CurvesFilter(t);this.curvesTexture2=PIXI.RenderTexture.create(this.sourceTexture.width,this.sourceTexture.height);let o=new PIXI.Sprite;o.texture=this.curvesTexture,o.filters=[s],BFN.Stage.render(o,this.curvesTexture2);try{s.dispose()}catch(n){}try{o.texture.destroyGC(!0)}catch(n){}o=null,s=null,this.texture=this.curvesTexture2;return}this.texture=this.curvesTexture}PRESET_7(){let e=new BFN.filters.CurvesFilter(BFN.CONST.PALETTE_MAPS.retroCol6[0],BFN.CONST.PALETTE_MAPS.retroCol6[1],BFN.CONST.PALETTE_MAPS.retroCol6[2]),t=new PIXI.Sprite;t.texture=this.sourceTexture,t.filters=[e],this.curvesTextureBottomP7=PIXI.RenderTexture.create(this.sourceTexture.width,this.sourceTexture.height),BFN.Stage.render(t,this.curvesTextureBottomP7);try{e.dispose()}catch(s){}t=null,e=null,this.texture=this.curvesTextureBottomP7;let r=new BFN.filters.CurvesFilter(BFN.CONST.PALETTE_MAPS.retro6mask[0],BFN.CONST.PALETTE_MAPS.retro6mask[1],BFN.CONST.PALETTE_MAPS.retro6mask[2]),a=new PIXI.Sprite;a.texture=this.sourceTexture,a.filters=[r],this.curvesTextureTopP7=PIXI.RenderTexture.create(this.sourceTexture.width,this.sourceTexture.height),BFN.Stage.render(a,this.curvesTextureTopP7);try{r.dispose()}catch(s){}return a=null,r=null,this.curvesSetup=!0,this.curvesTextureTopP7}disposeEffect(){try{this.__filters[this.currentPresetID].dispose()}catch(e){}if(this.sourceTexture=null,this.isSetup=!1,this.curvesSetup=!1,this.currentPresetID=null,this.curvesTextureTopP7!=null&&(this.curvesTextureTopP7.destroyGC(!0),this.curvesTextureTopP7=null),this.curvesTextureBottomP7!=null&&(this.curvesTextureBottomP7.destroyGC(!0),this.curvesTextureBottomP7=null),this.curvesTexture!=null){try{this.curvesTexture.destroyGC(!0)}catch(e){}this.curvesTexture=null}if(this.curvesTexture2!=null){try{this.curvesTexture2.destroyGC(!0)}catch(e){}this.curvesTexture2=null}this.effectTexture!=null&&(this.effectTexture.destroyGC(!0),this.effectTexture=null),this.effectTextureLoader!=null&&(this.effectTextureLoader.removeEventListener(BFN.EffectTextureLoaderEvents.TEXTURE_LOADED.type,this.handleEffectTextureLoaderTextureLoadedBind),this.effectTextureLoader.destroy(),this.effectTextureLoader=null)}};BFN.effects.ChromaticEffect=new MF;var DF=class extends PIXI.Sprite{constructor(){super();this.initialized=!1}initEffect(){this.sourceTexture=null,this.isSetup=!1,this.handleEffectTextureLoaderTextureLoadedBind=this.handleEffectTextureLoaderTextureLoaded.bind(this),this.effectTextureLoader=null,this.currentPresetID=null,this.effectTexture=null,this.blurFilter=new BFN.filters.FastBlurWrapper(null,null,!0),this.blurTexture=null,this.blurSetup=!1,this.__filters={};for(let e in BFN.CONST.CHARCOAL_PRESETS)this.__filters[BFN.CONST.CHARCOAL_PRESETS[e]]=new BFN.filters.CharcoalFilter}setupEffect(e){this.initialized||(this.initialized=!0,this.initEffect()),this.disposeEffect(),this.sourceTexture=e,this.isSetup=!0,this.texture=this.sourceTexture}applyEffect(e,t,r){if(this.resolution=e,this.parameters=t,t.hasOwnProperty("presetID")&&this.__filters.hasOwnProperty(t.presetID)){this.currentPresetID=t.presetID;let a=this.__filters[this.currentPresetID];if(t.hasOwnProperty("imageURL")&&(this.effectTextureLoader||(this.effectTextureLoader=new BFN.EffectTextureLoader,this.effectTextureLoader.addEventListener(BFN.EffectTextureLoaderEvents.TEXTURE_LOADED.type,this.handleEffectTextureLoaderTextureLoadedBind)),!this.effectTexture&&!this.effectTextureLoader.loading&&(r==!0?this.effectTexture=BFN.XMLGraphicLoader.getGraphicByName(t.imageURL,this.sourceTexture.width,this.sourceTexture.height):this.effectTexture=this.effectTextureLoader.getTexture(BFN.originalTextureURl+t.imageURL,this.sourceTexture.width,this.sourceTexture.height))),this.effectTextureLoader!=null&&this.effectTextureLoader.loading){this.filters=[];return}this.effectTextureLoader!=null&&(this.effectTextureLoader.removeEventListener(BFN.EffectTextureLoaderEvents.TEXTURE_LOADED.type,this.handleEffectTextureLoaderTextureLoadedBind),this.effectTextureLoader.destroy(),this.effectTextureLoader=null),this.blurSetup||this.setupBlur(),a.blurImage=this.blurTexture,a.textureSampler=this.effectTexture,a.color1=t.color_value_1,a.color2=t.color_value_2,a.detail_level=t.detail_level,this.filters=[a]}}handleEffectTextureLoaderTextureLoaded(e){BFN.EffectManager.currentEffect==this?BFN.EffectManager.processEffect():this.applyEffect(this.resolution,this.parameters)}setupBlur(){this.blurSetup=!0,this.blurTexture=this.blurFilter.render(.5,this.sourceTexture)}disposeEffect(){this.sourceTexture=null,this.isSetup=!1,this.blurSetup=!1,this.currentPresetID=null,this.blurTexture!=null&&(this.blurTexture=null),this.blurFilter.dispose(),this.effectTexture!=null&&(this.effectTexture.destroyGC(!0),this.effectTexture=null),this.effectTextureLoader!=null&&(this.effectTextureLoader.removeEventListener(BFN.EffectTextureLoaderEvents.TEXTURE_LOADED.type,this.handleEffectTextureLoaderTextureLoadedBind),this.effectTextureLoader.destroy(),this.effectTextureLoader=null)}};BFN.effects.CharcoalEffect=new DF;var wF=class extends PIXI.Sprite{constructor(){super();this.initialized=!1}initEffect(){this.sourceTexture=null,this.isSetup=!1,this.handleEffectTextureLoaderTextureLoadedBind=this.handleEffectTextureLoaderTextureLoaded.bind(this),this.effectTextureLoader=null,this.currentPresetID=null,this.effectTexture=null,this.__filters={};for(let e in BFN.CONST.CYANOTYPE_PRESETS)this.__filters[BFN.CONST.CYANOTYPE_PRESETS[e]]=new BFN.filters.CyanotypeFilter(BFN.CONST.CYANOTYPE_PRESETS[e]);this.exposureFilter=new BFN.filters.HSFilter,this.isBlurSetup=!1,this.blurFilter=new BFN.filters.FastBlurWrapper(null,null,!0),this.blurTexture=null}setupEffect(e){this.initialized||(this.initialized=!0,this.initEffect()),this.disposeEffect(),this.sourceTexture=e,this.isSetup=!0,this.texture=this.sourceTexture}applyEffect(e,t,r){if(this.resolution=e,this.parameters=t,t.hasOwnProperty("presetID")&&this.__filters.hasOwnProperty(t.presetID)){this.currentPresetID=t.presetID;let a=this.__filters[this.currentPresetID];if(t.hasOwnProperty("imageURL")&&(this.effectTextureLoader||(this.effectTextureLoader=new BFN.EffectTextureLoader,this.effectTextureLoader.addEventListener(BFN.EffectTextureLoaderEvents.TEXTURE_LOADED.type,this.handleEffectTextureLoaderTextureLoadedBind)),!this.effectTexture&&!this.effectTextureLoader.loading&&(r==!0?this.effectTexture=BFN.XMLGraphicLoader.getGraphicByName(t.imageURL,this.sourceTexture.width,this.sourceTexture.height):this.effectTexture=this.effectTextureLoader.getTexture(BFN.originalTextureURl+t.imageURL,this.sourceTexture.width,this.sourceTexture.height))),this.effectTextureLoader!=null&&this.effectTextureLoader.loading){this.filters=[];return}this.effectTextureLoader!=null&&(this.effectTextureLoader.removeEventListener(BFN.EffectTextureLoaderEvents.TEXTURE_LOADED.type,this.handleEffectTextureLoaderTextureLoadedBind),this.effectTextureLoader.destroy(),this.effectTextureLoader=null),t.hasOwnProperty("highlights")&&t.hasOwnProperty("shadows")&&(this.currentPresetID==BFN.CONST.CYANOTYPE_PRESETS.PRESET_6&&(this.isBlurSetup||this.setupBlur(),a.blurImage=this.blurTexture),a.iChannel1=this.effectTexture,t.highlights!=0||t.shadows!=0?(this.exposureFilter.highlights=t.highlights,this.exposureFilter.shadows=t.shadows,this.filters=[this.exposureFilter,a]):this.filters=[a])}}handleEffectTextureLoaderTextureLoaded(e){BFN.EffectManager.currentEffect==this?BFN.EffectManager.processEffect():this.applyEffect(this.resolution,this.parameters)}setupBlur(){this.blurTexture=this.blurFilter.render(.8,this.sourceTexture),this.isBlurSetup=!0}disposeEffect(){this.sourceTexture=null,this.isSetup=!1,this.isBlurSetup=!1,this.currentPresetID=null,this.effectTexture!=null&&(this.effectTexture.destroyGC(!0),this.effectTexture=null),this.blurTexture!=null&&(this.blurTexture=null),this.blurFilter.dispose(),this.effectTextureLoader!=null&&(this.effectTextureLoader.removeEventListener(BFN.EffectTextureLoaderEvents.TEXTURE_LOADED.type,this.handleEffectTextureLoaderTextureLoadedBind),this.effectTextureLoader.destroy(),this.effectTextureLoader=null)}};BFN.effects.CyanotypeEffect=new wF;var kF=class extends PIXI.Sprite{constructor(){super();this.initialized=!1}initEffect(){this.sourceTexture=null,this.isSetup=!1,this.blurFilter=new BFN.filters.FastBlurWrapper(null,null,!0),this.blurTexture=null,this.blurAmount=null,this._filter=new BFN.filters.OrtonStyleFilter}setupEffect(e){this.initialized||(this.initialized=!0,this.initEffect()),this.disposeEffect(),this.sourceTexture=e,this.isSetup=!0,this.texture=this.sourceTexture}applyEffect(e,t){this.resolution=e,this.parameters=t,this.texture!=this.sourceTexture&&(this.texture=this.sourceTexture),t.hasOwnProperty("blur_amount")&&(this.blurAmount!=t.blur_amount&&(this.blurTexture=this.blurFilter.render(t.blur_amount,this.sourceTexture)),this._filter.blurSampler=this.blurTexture,this.filters=[this._filter])}disposeEffect(){this.sourceTexture=null,this.isSetup=!1,this.blurTexture!=null&&(this.blurTexture=null),this.blurFilter.dispose(),this.blurAmount=null}};BFN.effects.OrtonStyleEffect=new kF;var AF=class extends PIXI.Sprite{constructor(){super();this.initialized=!1}initEffect(){this.sourceTexture=null,this.isSetup=!1,this.exposureFilter=new BFN.filters.HSFilter,this._filter=new BFN.filters.SepiaFilter}setupEffect(e){this.initialized||(this.initialized=!0,this.initEffect()),this.disposeEffect(),this.sourceTexture=e,this.isSetup=!0,this.texture=this.sourceTexture}applyEffect(e,t){if(this.resolution=e,this.parameters=t,this.texture!=this.sourceTexture,t.hasOwnProperty("highlights")&&t.hasOwnProperty("shadows"))if(this._filter.amount=.85,this._filter.color="0xac7933",t.highlights!=0||t.shadows!=0){this.exposureFilter.highlights=t.highlights,this.exposureFilter.shadows=t.shadows,this.filters=[this.exposureFilter,this._filter];return}else this.filters=[this._filter]}disposeEffect(){this.sourceTexture=null,this.isSetup=!1,this.blurTexture!=null&&(this.blurTexture.destroyGC(!0),this.blurTexture=null)}};BFN.effects.SepiaEffect=new AF;var OF=class extends PIXI.Sprite{constructor(){super();this.initialized=!1}initEffect(){this.sourceTexture=null,this.isSetup=!1,this.handleEffectTextureLoaderTextureLoadedBind=this.handleEffectTextureLoaderTextureLoaded.bind(this),this.effectTextureLoader=null,this.currentPresetID=null,this.effectTexture=null,this.__filters={};for(let e in BFN.CONST.VIEWFINDER_PRESETS)switch(BFN.CONST.VIEWFINDER_PRESETS[e]){case BFN.CONST.VIEWFINDER_PRESETS.PRESET_1:case BFN.CONST.VIEWFINDER_PRESETS.PRESET_11:this.__filters[BFN.CONST.VIEWFINDER_PRESETS[e]]=new BFN.filters.BlendModeFilter(BFN.CONST.BLEND_MODES.HARD_LIGHT);break;case BFN.CONST.VIEWFINDER_PRESETS.PRESET_2:case BFN.CONST.VIEWFINDER_PRESETS.PRESET_3:case BFN.CONST.VIEWFINDER_PRESETS.PRESET_4:case BFN.CONST.VIEWFINDER_PRESETS.PRESET_6:case BFN.CONST.VIEWFINDER_PRESETS.PRESET_8:case BFN.CONST.VIEWFINDER_PRESETS.PRESET_10:case BFN.CONST.VIEWFINDER_PRESETS.PRESET_12:this.__filters[BFN.CONST.VIEWFINDER_PRESETS[e]]=new BFN.filters.BlendModeFilter(BFN.CONST.BLEND_MODES.OVERLAY);break;case BFN.CONST.VIEWFINDER_PRESETS.PRESET_5:this.__filters[BFN.CONST.VIEWFINDER_PRESETS[e]]=new BFN.filters.BlendModeFilter(BFN.CONST.BLEND_MODES.LIGHTEN);break;case BFN.CONST.VIEWFINDER_PRESETS.PRESET_7:this.__filters[BFN.CONST.VIEWFINDER_PRESETS[e]]=new BFN.filters.BlendModeFilter(BFN.CONST.BLEND_MODES.MULTIPLY);break;case BFN.CONST.VIEWFINDER_PRESETS.PRESET_9:this.__filters[BFN.CONST.VIEWFINDER_PRESETS[e]]=new BFN.filters.BlendModeFilter(BFN.CONST.BLEND_MODES.DARKEN);break}this.exposureFilter=new BFN.filters.HSFilter,this.isBlurSetup=!1,this.blurFilter=new BFN.filters.FastBlurWrapper(null,null,!0),this.blurTexture=null}setupEffect(e){this.initialized||(this.initialized=!0,this.initEffect()),this.disposeEffect(),this.sourceTexture=e,this.isSetup=!0,this.texture=this.sourceTexture}applyEffect(e,t,r){if(this.resolution=e,this.parameters=t,t.hasOwnProperty("presetID")&&this.__filters.hasOwnProperty(t.presetID)){this.currentPresetID=t.presetID;let a=this.__filters[this.currentPresetID];if(t.hasOwnProperty("imageURL")&&(this.effectTextureLoader||(this.effectTextureLoader=new BFN.EffectTextureLoader,this.effectTextureLoader.addEventListener(BFN.EffectTextureLoaderEvents.TEXTURE_LOADED.type,this.handleEffectTextureLoaderTextureLoadedBind)),!this.effectTexture&&!this.effectTextureLoader.loading&&(r==!0?this.effectTexture=BFN.XMLGraphicLoader.getGraphicByName(t.imageURL,this.sourceTexture.width,this.sourceTexture.height):this.effectTexture=this.effectTextureLoader.getTexture(BFN.originalTextureURl+t.imageURL,this.sourceTexture.width,this.sourceTexture.height))),this.effectTextureLoader!=null&&this.effectTextureLoader.loading){this.filters=[];return}this.effectTextureLoader!=null&&(this.effectTextureLoader.removeEventListener(BFN.EffectTextureLoaderEvents.TEXTURE_LOADED.type,this.handleEffectTextureLoaderTextureLoadedBind),this.effectTextureLoader.destroy(),this.effectTextureLoader=null),t.hasOwnProperty("highlights")&&t.hasOwnProperty("shadows")&&(a.iChannel1=this.effectTexture,this.currentPresetID==BFN.CONST.VIEWFINDER_PRESETS.PRESET_1||this.currentPresetID==BFN.CONST.VIEWFINDER_PRESETS.PRESET_2||this.currentPresetID==BFN.CONST.VIEWFINDER_PRESETS.PRESET_8?(this.isBlurSetup||this.setupBlur(),this.texture=this.blurTexture):this.currentPresetID==BFN.CONST.VIEWFINDER_PRESETS.PRESET_5&&(a.intensity=.5),t.highlights!=0||t.shadows!=0?(this.exposureFilter.highlights=t.highlights,this.exposureFilter.shadows=t.shadows,this.filters=[this.exposureFilter,a]):this.filters=[a])}}handleEffectTextureLoaderTextureLoaded(e){BFN.EffectManager.currentEffect==this?BFN.EffectManager.processEffect():this.applyEffect(this.resolution,this.parameters)}setupBlur(){let e=1;Math.max(this.sourceTexture.width,this.sourceTexture.height)<512&&(e=Math.max(this.sourceTexture.width,this.sourceTexture.height)/1024),this.blurTexture=this.blurFilter.render(.06*e,this.sourceTexture),this.isBlurSetup=!0}disposeEffect(){this.sourceTexture=null,this.isSetup=!1,this.currentPresetID=null,this.effectTexture!=null&&(this.effectTexture.destroyGC(!0),this.effectTexture=null),this.blurTexture!=null&&(this.blurTexture=null),this.blurFilter.dispose(),this.isBlurSetup=!1,this.effectTextureLoader!=null&&(this.effectTextureLoader.destroy(),this.effectTextureLoader.removeEventListener(BFN.EffectTextureLoaderEvents.TEXTURE_LOADED.type,this.handleEffectTextureLoaderTextureLoadedBind),this.effectTextureLoader=null)}};BFN.effects.ViewFinderEffect=new OF;var RF=class extends PIXI.Sprite{constructor(){super();this.initialized=!1}initEffect(){this.sourceTexture=null,this.isSetup=!1,this.handleEffectTextureLoaderTextureLoadedBind=this.handleEffectTextureLoaderTextureLoaded.bind(this),this.effectTextureLoader=null,this.currentPresetID=null,this.effectTexture=null,this.__filters={};for(let e in BFN.CONST.SUMMER_PRESETS)switch(BFN.CONST.SUMMER_PRESETS[e]){case BFN.CONST.SUMMER_PRESETS.PRESET_1:this.__filters[BFN.CONST.SUMMER_PRESETS[e]]=new BFN.filters.BlendModeFilter(BFN.CONST.BLEND_MODES.OVERLAY);break;case BFN.CONST.SUMMER_PRESETS.PRESET_2:this.__filters[BFN.CONST.SUMMER_PRESETS[e]]=new BFN.filters.BlendModeFilter(BFN.CONST.BLEND_MODES.SCREEN);break}this.exposureFilter=new BFN.filters.HSFilter}setupEffect(e){this.initialized||(this.initialized=!0,this.initEffect()),this.disposeEffect(),this.sourceTexture=e,this.isSetup=!0,this.texture=this.sourceTexture}applyEffect(e,t,r){if(this.resolution=e,this.parameters=t,t.hasOwnProperty("presetID")&&this.__filters.hasOwnProperty(t.presetID)){this.currentPresetID=t.presetID;let a=this.__filters[this.currentPresetID];if(t.hasOwnProperty("imageURL")&&(this.effectTextureLoader||(this.effectTextureLoader=new BFN.EffectTextureLoader,this.effectTextureLoader.addEventListener(BFN.EffectTextureLoaderEvents.TEXTURE_LOADED.type,this.handleEffectTextureLoaderTextureLoadedBind)),!this.effectTexture&&!this.effectTextureLoader.loading&&(r==!0?this.effectTexture=BFN.XMLGraphicLoader.getGraphicByName(t.imageURL,this.sourceTexture.width,this.sourceTexture.height):this.effectTexture=this.effectTextureLoader.getTexture(BFN.originalTextureURl+t.imageURL,this.sourceTexture.width,this.sourceTexture.height))),this.effectTextureLoader!=null&&this.effectTextureLoader.loading){this.filters=[];return}this.effectTextureLoader!=null&&(this.effectTextureLoader.removeEventListener(BFN.EffectTextureLoaderEvents.TEXTURE_LOADED.type,this.handleEffectTextureLoaderTextureLoadedBind),this.effectTextureLoader.destroy(),this.effectTextureLoader=null),t.hasOwnProperty("highlights")&&t.hasOwnProperty("shadows")&&(a.iChannel1=this.effectTexture,t.highlights!=0||t.shadows!=0?(this.exposureFilter.highlights=t.highlights,this.exposureFilter.shadows=t.shadows,this.filters=[this.exposureFilter,a]):this.filters=[a])}}handleEffectTextureLoaderTextureLoaded(e){BFN.EffectManager.currentEffect==this?BFN.EffectManager.processEffect():this.applyEffect(this.resolution,this.parameters)}disposeEffect(){this.sourceTexture=null,this.isSetup=!1,this.currentPresetID=null,this.effectTexture!=null&&(this.effectTexture.destroyGC(!0),this.effectTexture=null),this.effectTextureLoader!=null&&(this.effectTextureLoader.removeEventListener(BFN.EffectTextureLoaderEvents.TEXTURE_LOADED.type,this.handleEffectTextureLoaderTextureLoadedBind),this.effectTextureLoader.destroy(),this.effectTextureLoader=null)}};BFN.effects.SummerEffect=new RF;var LF=class extends PIXI.Sprite{constructor(){super();this.initialized=!1}initEffect(){this.sourceTexture=null,this.isSetup=!1,this.currentPresetID=null,this.blurFilter=new BFN.filters.FastBlurWrapper(null,null,!0),this.blurTexture=null,this.blurSetup=!1,this.__filters={};for(let e in BFN.CONST.UNITED_COLORS_PRESETS)this.__filters[BFN.CONST.UNITED_COLORS_PRESETS[e]]=new BFN.filters.UnitedColorsFilter}setupEffect(e){this.initialized||(this.initialized=!0,this.initEffect()),this.disposeEffect(),this.sourceTexture=e,this.isSetup=!0,this.texture=this.sourceTexture}applyEffect(e,t){if(this.resolution=e,this.parameters=t,t.hasOwnProperty("presetID")&&this.__filters.hasOwnProperty(t.presetID)){this.currentPresetID=t.presetID;let r=this.__filters[this.currentPresetID];switch(this.blurSetup||this.setupBlur(),this.currentPresetID){case BFN.CONST.UNITED_COLORS_PRESETS.PRESET_1:r.bwmode=0;break;case BFN.CONST.UNITED_COLORS_PRESETS.PRESET_2:case BFN.CONST.UNITED_COLORS_PRESETS.PRESET_4:r.bwmode=3;break;case BFN.CONST.UNITED_COLORS_PRESETS.PRESET_3:r.bwmode=2}r.blurImage=this.blurTexture,r.color1=t.color_value_1,r.color2=t.color_value_2,this.filters=[r]}}setupBlur(){this.blurSetup=!0,this.idealBlur=Math.max(this.sourceTexture.width,this.sourceTexture.height)/4e3,this.blurTexture=this.blurFilter.render(.5,this.sourceTexture)}disposeEffect(){this.sourceTexture=null,this.isSetup=!1,this.blurSetup=!1,this.currentPresetID=null,this.blurTexture!=null&&(this.blurTexture=null),this.blurFilter.dispose()}};BFN.effects.UnitedColorsEffect=new LF;var VF=class extends PIXI.Sprite{constructor(){super();this.initialized=!1}initEffect(){this.sourceTexture=null,this.isSetup=!1,this.handleEffectTextureLoaderTextureLoadedBind=this.handleEffectTextureLoaderTextureLoaded.bind(this),this.effectTextureLoader=null,this.currentPresetID=null,this.currentPaletteID=null,this.effectTexture=null,this.__filters={};for(let e in BFN.CONST.INSTANT_PRESETS)switch(BFN.CONST.INSTANT_PRESETS[e]){case BFN.CONST.INSTANT_PRESETS.PRESET_1:case BFN.CONST.INSTANT_PRESETS.PRESET_2:case BFN.CONST.INSTANT_PRESETS.PRESET_3:case BFN.CONST.INSTANT_PRESETS.PRESET_4:case BFN.CONST.INSTANT_PRESETS.PRESET_5:case BFN.CONST.INSTANT_PRESETS.PRESET_6:case BFN.CONST.INSTANT_PRESETS.PRESET_10:case BFN.CONST.INSTANT_PRESETS.PRESET_11:case BFN.CONST.INSTANT_PRESETS.PRESET_13:this.__filters[BFN.CONST.INSTANT_PRESETS[e]]=new BFN.filters.InstantFilter(BFN.CONST.INSTANT_PRESETS[e]);break}this.exposureFilter=new BFN.filters.HSFilter}setupEffect(e){this.initialized||(this.initialized=!0,this.initEffect()),this.disposeEffect(),this.sourceTexture=e,this.isSetup=!0,this.texture=this.sourceTexture}applyEffect(e,t,r){if(this.resolution=e,this.parameters=t,t.hasOwnProperty("presetID")&&this.__filters.hasOwnProperty(t.presetID)){if(this.currentPresetID=t.presetID,t.hasOwnProperty("imageURL")&&(this.effectTextureLoader||(this.effectTextureLoader=new BFN.EffectTextureLoader,this.effectTextureLoader.addEventListener(BFN.EffectTextureLoaderEvents.TEXTURE_LOADED.type,this.handleEffectTextureLoaderTextureLoadedBind)),!this.effectTexture&&!this.effectTextureLoader.loading&&(r==!0?this.effectTexture=BFN.XMLGraphicLoader.getGraphicByName(t.imageURL,this.sourceTexture.width,this.sourceTexture.height):this.effectTexture=this.effectTextureLoader.getTexture(BFN.originalTextureURl+t.imageURL,this.sourceTexture.width,this.sourceTexture.height))),this.effectTextureLoader!=null&&this.effectTextureLoader.loading){this.filters=[];return}this.effectTextureLoader!=null&&(this.effectTextureLoader.removeEventListener(BFN.EffectTextureLoaderEvents.TEXTURE_LOADED.type,this.handleEffectTextureLoaderTextureLoadedBind),this.effectTextureLoader.destroy(),this.effectTextureLoader=null);let a=this.__filters[this.currentPresetID],s=!1;switch(t.hasOwnProperty("highlights")&&t.hasOwnProperty("shadows")&&(t.highlights!=0||t.shadows!=0)&&(this.exposureFilter.highlights=t.highlights,this.exposureFilter.shadows=t.shadows,s=!0),this.currentPresetID){case BFN.CONST.INSTANT_PRESETS.PRESET_1:case BFN.CONST.INSTANT_PRESETS.PRESET_2:case BFN.CONST.INSTANT_PRESETS.PRESET_3:case BFN.CONST.INSTANT_PRESETS.PRESET_4:break;case BFN.CONST.INSTANT_PRESETS.PRESET_5:case BFN.CONST.INSTANT_PRESETS.PRESET_6:case BFN.CONST.INSTANT_PRESETS.PRESET_10:case BFN.CONST.INSTANT_PRESETS.PRESET_11:case BFN.CONST.INSTANT_PRESETS.PRESET_13:a.iChannel1=this.effectTexture;break}s==!0?this.filters=[this.exposureFilter,a]:this.filters=[a]}}handleEffectTextureLoaderTextureLoaded(e){BFN.EffectManager.currentEffect==this?BFN.EffectManager.processEffect():this.applyEffect(this.resolution,this.parameters)}disposeEffect(){this.sourceTexture=null,this.isSetup=!1,this.currentPresetID=null,this.currentPaletteID=null,this.effectTexture!=null&&(this.effectTexture.destroyGC(!0),this.effectTexture=null),this.effectTextureLoader!=null&&(this.effectTextureLoader.removeEventListener(BFN.EffectTextureLoaderEvents.TEXTURE_LOADED.type,this.handleEffectTextureLoaderTextureLoadedBind),this.effectTextureLoader.destroy(),this.effectTextureLoader=null)}};BFN.effects.InstantEffect=new VF;var UF=class extends PIXI.Sprite{constructor(){super();this.initialized=!1}initEffect(){this.sourceTexture=null,this.isSetup=!1,this.uiControls=new Array,this.__filter=new BFN.filters.TintFilter,this.exposureFilter=new BFN.filters.HSFilter}setupEffect(e){this.initialized||(this.initialized=!0,this.initEffect()),this.disposeEffect(),this.sourceTexture=e,this.isSetup=!0,this.texture=this.sourceTexture}applyEffect(e,t){this.__filter.color=t.color,t.hasOwnProperty("highlights")&&t.hasOwnProperty("shadows")&&(t.highlights!=0||t.shadows!=0)?(this.exposureFilter.highlights=t.highlights,this.exposureFilter.shadows=t.shadows,this.filters=[this.exposureFilter,this.__filter]):this.filters=[this.__filter]}disposeEffect(){this.sourceTexture=null,this.isSetup=!1,this.texture=PIXI.Texture.EMPTY,this.filters=null}};BFN.effects.CoolingEffect=new UF;var GF=class extends PIXI.Sprite{constructor(){super();this.initialized=!1}initEffect(){this.sourceTexture=null,this.isSetup=!1,this.uiControls=new Array,this.__filter=new BFN.filters.TintFilter,this.exposureFilter=new BFN.filters.HSFilter}setupEffect(e){this.initialized||(this.initialized=!0,this.initEffect()),this.disposeEffect(),this.sourceTexture=e,this.isSetup=!0,this.texture=this.sourceTexture}applyEffect(e,t){this.__filter.color=t.color,t.hasOwnProperty("highlights")&&t.hasOwnProperty("shadows")&&(t.highlights!=0||t.shadows!=0)?(this.exposureFilter.highlights=t.highlights,this.exposureFilter.shadows=t.shadows,this.filters=[this.exposureFilter,this.__filter]):this.filters=[this.__filter]}disposeEffect(){this.sourceTexture=null,this.isSetup=!1,this.texture=PIXI.Texture.EMPTY,this.filters=null}};BFN.effects.WarmingEffect=new GF;var HF=class extends PIXI.Sprite{constructor(){super();this.initialized=!1}initEffect(){this.sourceTexture=null,this.isSetup=!1,this.handleEffectTextureLoaderTextureLoadedBind=this.handleEffectTextureLoaderTextureLoaded.bind(this),this.effectTextureLoader=null,this.effectTexture=null,this.__filter=new BFN.filters.TinyTypeFilter}setupEffect(e){this.initialized||(this.initialized=!0,this.initEffect()),this.disposeEffect(),this.sourceTexture=e,this.isSetup=!0,this.texture=this.sourceTexture}applyEffect(e,t,r){if(this.resolution=e,this.parameters=t,t.hasOwnProperty("imageURL")&&(this.effectTextureLoader||(this.effectTextureLoader=new BFN.EffectTextureLoader,this.effectTextureLoader.addEventListener(BFN.EffectTextureLoaderEvents.TEXTURE_LOADED.type,this.handleEffectTextureLoaderTextureLoadedBind)),!this.effectTexture&&!this.effectTextureLoader.loading&&(r==!0?this.effectTexture=BFN.XMLGraphicLoader.getGraphicByName(t.imageURL,this.sourceTexture.width,this.sourceTexture.height):this.effectTexture=this.effectTextureLoader.getTexture(BFN.originalTextureURl+t.imageURL,this.sourceTexture.width,this.sourceTexture.height))),this.effectTextureLoader!=null&&this.effectTextureLoader.loading){this.filters=[];return}this.effectTextureLoader!=null&&(this.effectTextureLoader.removeEventListener(BFN.EffectTextureLoaderEvents.TEXTURE_LOADED.type,this.handleEffectTextureLoaderTextureLoadedBind),this.effectTextureLoader.destroy(),this.effectTextureLoader=null),this.__filter.iChannel1=this.effectTexture,t.hasOwnProperty("modeBW")&&t.hasOwnProperty("modeColor")&&(this.__filter.mode=t.modeBW,this.__filter.color=t.modeColor),this.filters=[this.__filter]}handleEffectTextureLoaderTextureLoaded(e){BFN.EffectManager.currentEffect==this?BFN.EffectManager.processEffect():this.applyEffect(this.resolution,this.parameters)}disposeEffect(){this.sourceTexture=null,this.isSetup=!1,this.effectTexture!=null&&(this.effectTexture.destroyGC(!0),this.effectTexture=null),this.effectTextureLoader!=null&&(this.effectTextureLoader.removeEventListener(BFN.EffectTextureLoaderEvents.TEXTURE_LOADED.type,this.handleEffectTextureLoaderTextureLoadedBind),this.effectTextureLoader.destroy(),this.effectTextureLoader=null)}};BFN.effects.TinyTypeEffect=new HF;var XF=class extends PIXI.Sprite{constructor(){super();this.initialized=!1}initEffect(){this.sourceTexture=null,this.isSetup=!1,this.curvesTexture=null,this.isSetupCurves=!1,this.exposureFilter=new BFN.filters.HSFilter,this._filter=new BFN.filters.CrossProcessFilter}setupEffect(e){this.initialized||(this.initialized=!0,this.initEffect()),this.disposeEffect(),this.sourceTexture=e,this.isSetup=!0,this.texture=this.sourceTexture}applyEffect(e,t){this.resolution=e,this.parameters=t,this.texture!=this.sourceTexture,t.hasOwnProperty("highlights")&&t.hasOwnProperty("shadows")&&(this.isSetupCurves||this.setupCurves(BFN.CONST.PALETTE_MAPS[t.curves],t),this._filter.intensity=.2,this._filter.contrast=t.contrast,this._filter.color=t.color,this._filter.curvesSampler=this.curvesTexture,t.highlights!=0||t.shadows!=0?(this.exposureFilter.highlights=t.highlights,this.exposureFilter.shadows=t.shadows,this.filters=[this.exposureFilter,this._filter]):this.filters=[this._filter])}setupCurves(e,t){let r=e.length==3?BFN.FilterHelper.GetCurvesTexture(e[0],e[1],e[2]):e.length==2?BFN.FilterHelper.GetCurvesTexture(e[0],e[1]):BFN.FilterHelper.GetCurvesTexture(e);this.curvesTexture||(this.curvesTexture=PIXI.RenderTexture.create(this.sourceTexture.width,this.sourceTexture.height));let a=new PIXI.Sprite;a.texture=r,BFN.Stage.render(a,this.curvesTexture),r.destroyGC(!0),r=null;try{a.texture.destroyGC(!0)}catch(s){}a=null,this.isSetupCurves=!0}cleanValue(e,t){return Math.min(t,Math.max(-t,e))}disposeEffect(){this.sourceTexture=null,this.isSetup=!1,this.isSetupCurves=!1,this.curvesTexture!=null&&(this.curvesTexture.destroyGC(!0),this.curvesTexture=null)}};BFN.effects.CrossProcessEffect=new XF;var zF=class extends PIXI.Sprite{constructor(){super();this.initialized=!1}initEffect(){this.sourceTexture=null,this.isSetup=!1,this.currentPresetID=null,this.exposureFilter=new BFN.filters.HSFilter,this.blurFilter=new BFN.filters.SurfaceBlurFilter,this.adaptiveSharpness=new BFN.filters.AdaptiveSharpnessFilter,this.blurTexture=null,this.blurTextureHolder=new PIXI.Sprite,this.blurSetup=!1,this.handleEffectTextureLoaderTextureLoadedBind=this.handleEffectTextureLoaderTextureLoaded.bind(this),this.effectTextureLoader=null,this.effectTexture=null,this.__filters={};for(let e in BFN.CONST.VINTAGE_COLORS_PRESETS)switch(BFN.CONST.VINTAGE_COLORS_PRESETS[e]){case BFN.CONST.VINTAGE_COLORS_PRESETS.PRESET_7:case BFN.CONST.VINTAGE_COLORS_PRESETS.PRESET_8:case BFN.CONST.VINTAGE_COLORS_PRESETS.PRESET_9:this.__filters[BFN.CONST.VINTAGE_COLORS_PRESETS[e]]=new BFN.filters.LutFilter;break;default:this.__filters[BFN.CONST.VINTAGE_COLORS_PRESETS[e]]=new BFN.filters.VintageColorsFilter(BFN.CONST.VINTAGE_COLORS_PRESETS[e]);break}}setupEffect(e){this.initialized||(this.initialized=!0,this.initEffect()),this.disposeEffect(),this.sourceTexture=e,this.isSetup=!0,this.texture=this.sourceTexture}applyEffect(e,t,r){if(this.resolution=e,this.parameters=t,t.hasOwnProperty("presetID")&&this.__filters.hasOwnProperty(t.presetID)){this.currentPresetID=t.presetID;let a=this.__filters[this.currentPresetID];if(t.hasOwnProperty("imageURL")&&(this.effectTextureLoader||(this.effectTextureLoader=new BFN.EffectTextureLoader,this.effectTextureLoader.addEventListener(BFN.EffectTextureLoaderEvents.TEXTURE_LOADED.type,this.handleEffectTextureLoaderTextureLoadedBind)),!this.effectTexture&&!this.effectTextureLoader.loading&&(r==!0||t.imageURL.includes("lut_")?t.imageURL.includes("lut_")?this.effectTexture=BFN.XMLGraphicLoader.getGraphicByName(t.imageURL,512,512):this.effectTexture=BFN.XMLGraphicLoader.getGraphicByName(t.imageURL,this.sourceTexture.width,this.sourceTexture.height):this.effectTexture=this.effectTextureLoader.getTexture(BFN.originalTextureURl+t.imageURL,this.sourceTexture.width,this.sourceTexture.height))),this.effectTextureLoader!=null&&this.effectTextureLoader.loading){this.filters=[];return}this.effectTextureLoader!=null&&(this.effectTextureLoader.removeEventListener(BFN.EffectTextureLoaderEvents.TEXTURE_LOADED.type,this.handleEffectTextureLoaderTextureLoadedBind),this.effectTextureLoader.destroy(),this.effectTextureLoader=null);let s=!0;switch(this.currentPresetID){case BFN.CONST.VINTAGE_COLORS_PRESETS.PRESET_1:case BFN.CONST.VINTAGE_COLORS_PRESETS.PRESET_2:case BFN.CONST.VINTAGE_COLORS_PRESETS.PRESET_3:case BFN.CONST.VINTAGE_COLORS_PRESETS.PRESET_4:a.color1=t.color1,a.color2=t.color2;break;case BFN.CONST.VINTAGE_COLORS_PRESETS.PRESET_5:for(let o=0;o<4;o++)a[`color${o+1}_1`]=t.color1[o],a[`color${o+1}_2`]=t.color2[o];break;case BFN.CONST.VINTAGE_COLORS_PRESETS.PRESET_7:case BFN.CONST.VINTAGE_COLORS_PRESETS.PRESET_8:case BFN.CONST.VINTAGE_COLORS_PRESETS.PRESET_9:s=!1,a.intensity=1,a.iChannel1=this.effectTexture;break}if(s&&(this.blurSetup||this.setupBlur(),a.blurImage=this.blurTexture),t.hasOwnProperty("highlights")&&t.hasOwnProperty("shadows")&&(t.highlights!=0||t.shadows!=0)){this.exposureFilter.highlights=t.highlights,this.exposureFilter.shadows=t.shadows,this.filters=[this.exposureFilter,a];return}this.filters=[a]}}setupBlur(){this.blurSetup=!0;let e=PIXI.RenderTexture.create(this.sourceTexture.width,this.sourceTexture.height);this.blurTextureHolder.texture=this.sourceTexture,this.idealBlur=Math.round(Math.max(this.sourceTexture.width,this.sourceTexture.height))/1024*1,this.blurFilter.resolution=.5,this.blurFilter.blur=this.idealBlur,this.blurFilter.threshold=.3,this.blurTextureHolder.filters=[this.blurFilter],BFN.Stage.render(this.blurTextureHolder,e),this.blurTextureHolder.filters=[],this.blurTextureHolder=null,this.blurTextureHolder=new PIXI.Sprite,this.blurTexture=PIXI.RenderTexture.create(this.sourceTexture.width,this.sourceTexture.height),this.blurTextureHolder.texture=this.sourceTexture,this.adaptiveSharpness.blurImage=e,this.blurTextureHolder.filters=[this.adaptiveSharpness],BFN.Stage.render(this.blurTextureHolder,this.blurTexture),e.destroyGC(!0),e=null,this.blurTextureHolder.filters=[]}handleEffectTextureLoaderTextureLoaded(e){BFN.EffectManager.currentEffect==this?BFN.EffectManager.processEffect():this.applyEffect(this.resolution,this.parameters)}disposeEffect(){this.sourceTexture=null,this.isSetup=!1,this.blurSetup=!1,this.currentPresetID=null,this.blurTexture!=null&&(this.blurTexture.destroyGC(!0),this.blurTexture=null),this.effectTexture!=null&&(this.effectTexture.destroyGC(!0),this.effectTexture=null),this.effectTextureLoader!=null&&(this.effectTextureLoader.removeEventListener(BFN.EffectTextureLoaderEvents.TEXTURE_LOADED.type,this.handleEffectTextureLoaderTextureLoadedBind),this.effectTextureLoader.destroy(),this.effectTextureLoader=null)}};BFN.effects.VintageColorsEffect=new zF;var WF=class extends PIXI.Sprite{constructor(){super();this.initialized=!1}initEffect(){this.sourceTexture=null,this.isSetup=!1,this.currentPresetID=null,this.handleEffectTextureLoaderTextureLoadedBind=this.handleEffectTextureLoaderTextureLoaded.bind(this),this.effectTextureLoader=null,this.effectTexture=null,this.__filters={};for(let e in BFN.CONST.HOLGA_ART_PRESETS)this.__filters[BFN.CONST.HOLGA_ART_PRESETS[e]]=new BFN.filters.HolgaArtFilter(BFN.CONST.HOLGA_ART_PRESETS[e])}setupEffect(e){this.initialized||(this.initialized=!0,this.initEffect()),this.disposeEffect(),this.sourceTexture=e,this.isSetup=!0,this.texture=this.sourceTexture}applyEffect(e,t,r){if(this.resolution=e,this.parameters=t,this.texture!=this.sourceTexture&&(this.texture=this.sourceTexture),t.hasOwnProperty("presetID")&&this.__filters.hasOwnProperty(t.presetID)){this.currentPresetID=t.presetID;let a=this.__filters[this.currentPresetID];if(t.hasOwnProperty("imageURL")&&(this.effectTextureLoader||(this.effectTextureLoader=new BFN.EffectTextureLoader,this.effectTextureLoader.addEventListener(BFN.EffectTextureLoaderEvents.TEXTURE_LOADED.type,this.handleEffectTextureLoaderTextureLoadedBind)),!this.effectTexture&&!this.effectTextureLoader.loading&&(r==!0?this.effectTexture=BFN.XMLGraphicLoader.getGraphicByName(t.imageURL,this.sourceTexture.width,this.sourceTexture.height):this.effectTexture=this.effectTextureLoader.getTexture(BFN.originalTextureURl+t.imageURL,this.sourceTexture.width,this.sourceTexture.height))),this.effectTextureLoader!=null&&this.effectTextureLoader.loading){this.filters=[];return}switch(this.effectTextureLoader!=null&&(this.effectTextureLoader.removeEventListener(BFN.EffectTextureLoaderEvents.TEXTURE_LOADED.type,this.handleEffectTextureLoaderTextureLoadedBind),this.effectTextureLoader.destroy(),this.effectTextureLoader=null),this.currentPresetID){case BFN.CONST.HOLGA_ART_PRESETS.PRESET_1:case BFN.CONST.HOLGA_ART_PRESETS.PRESET_5:a.slide_right=t.slide_right,a.slide_left=t.slide_left;break;case BFN.CONST.HOLGA_ART_PRESETS.PRESET_2:case BFN.CONST.HOLGA_ART_PRESETS.PRESET_3:a.slide_vertical=t.slide_vertical,a.slide_horizontal=t.slide_horizontal;break;case BFN.CONST.HOLGA_ART_PRESETS.PRESET_4:a.slide_right=t.slide_right,a.slide_left=t.slide_left,a.vignette_amount=t.vignette_amount;break}this.effectTexture!=null&&(a.iChannel1=this.effectTexture),this.filters=[a]}else this.filters=[]}handleEffectTextureLoaderTextureLoaded(e){BFN.EffectManager.currentEffect==this?BFN.EffectManager.processEffect():this.applyEffect(this.resolution,this.parameters)}disposeEffect(){this.sourceTexture=null,this.isSetup=!1,this.currentPresetID=null,this.effectTexture!=null&&(this.effectTexture.destroyGC(!0),this.effectTexture=null),this.effectTextureLoader!=null&&(this.effectTextureLoader.removeEventListener(BFN.EffectTextureLoaderEvents.TEXTURE_LOADED.type,this.handleEffectTextureLoaderTextureLoadedBind),this.effectTextureLoader.destroy(),this.effectTextureLoader=null)}};BFN.effects.HolgaArtEffect=new WF;var $F=class extends PIXI.Sprite{constructor(){super();this.initialized=!1}initEffect(){this.sourceTexture=null,this.isSetup=!1,this.currentPresetID=null,this.handleEffectTextureLoaderTextureLoadedBind=this.handleEffectTextureLoaderTextureLoaded.bind(this),this.effectTextureLoader=null,this.effectTexture=null,this.__filters={};for(let e in BFN.CONST.LINE_ARTOPIA_PRESETS)this.__filters[BFN.CONST.LINE_ARTOPIA_PRESETS[e]]=new BFN.filters.LineArtopiaFilter(BFN.CONST.LINE_ARTOPIA_PRESETS[e])}setupEffect(e){this.initialized||(this.initialized=!0,this.initEffect()),this.disposeEffect(),this.sourceTexture=e,this.isSetup=!0,this.texture=this.sourceTexture}applyEffect(e,t,r){if(this.resolution=e,this.parameters=t,this.texture!=this.sourceTexture&&(this.texture=this.sourceTexture),t.hasOwnProperty("presetID")&&this.__filters.hasOwnProperty(t.presetID)){this.currentPresetID=t.presetID;let a=this.__filters[this.currentPresetID];if(t.hasOwnProperty("imageURL")&&(this.effectTextureLoader||(this.effectTextureLoader=new BFN.EffectTextureLoader,this.effectTextureLoader.addEventListener(BFN.EffectTextureLoaderEvents.TEXTURE_LOADED.type,this.handleEffectTextureLoaderTextureLoadedBind)),!this.effectTexture&&!this.effectTextureLoader.loading&&(r==!0?this.effectTexture=BFN.XMLGraphicLoader.getGraphicByName(t.imageURL,this.sourceTexture.width,this.sourceTexture.height):this.effectTexture=this.effectTextureLoader.getTexture(BFN.originalTextureURl+t.imageURL,this.sourceTexture.width,this.sourceTexture.height))),this.effectTextureLoader!=null&&this.effectTextureLoader.loading){this.filters=[];return}switch(this.effectTextureLoader!=null&&(this.effectTextureLoader.removeEventListener(BFN.EffectTextureLoaderEvents.TEXTURE_LOADED.type,this.handleEffectTextureLoaderTextureLoadedBind),this.effectTextureLoader.destroy(),this.effectTextureLoader=null),a.line_width=Math.max(Math.floor(t.line_width*Math.max(this.sourceTexture.width,this.sourceTexture.height)/1024),3),a.sketch_detail=t.sketch_detail,a.color=t.color,this.currentPresetID){case BFN.CONST.HOLGA_ART_PRESETS.PRESET_1:case BFN.CONST.HOLGA_ART_PRESETS.PRESET_2:a.line_angle=t.line_angle;break}this.effectTexture!=null&&(a.iChannel1=this.effectTexture),this.filters=[a]}else this.filters=[]}handleEffectTextureLoaderTextureLoaded(e){BFN.EffectManager.currentEffect==this?BFN.EffectManager.processEffect():this.applyEffect(this.resolution,this.parameters)}disposeEffect(){this.sourceTexture=null,this.isSetup=!1,this.currentPresetID=null,this.effectTexture!=null&&(this.effectTexture.destroyGC(!0),this.effectTexture=null),this.effectTextureLoader!=null&&(this.effectTextureLoader.removeEventListener(BFN.EffectTextureLoaderEvents.TEXTURE_LOADED.type,this.handleEffectTextureLoaderTextureLoadedBind),this.effectTextureLoader.destroy(),this.effectTextureLoader=null)}};BFN.effects.LineArtopiaEffect=new $F;var jF=class extends PIXI.Sprite{constructor(){super();this.initialized=!1}initEffect(){this.sourceTexture=null,this.isSetup=!1,this.currentPresetID=null,this.blurFilter=new BFN.filters.FastBlurWrapper(null,null,!0),this.adaptiveSharpness=new BFN.filters.AdaptiveSharpnessFilter,this.blurTexture=null,this.blurSetup=!1,this.adaptiveTexture=null,this.adaptiveTextureHolder=new PIXI.Sprite,this.adaptiveSetup=!1,this.bwFilter=new BFN.filters.BlackWhiteFilter(BFN.CONST.BLACK_WHITE_PRESETS.PRESET_4),this.bwTexture=null,this.bwTextureHolder=new PIXI.Sprite,this.bwSetup=!1,this.belndFilter=new BFN.filters.BlendModeFilter(BFN.CONST.BLEND_MODES.OVERLAY)}setupEffect(e){this.initialized||(this.initialized=!0,this.initEffect()),this.disposeEffect(),this.sourceTexture=e,this.isSetup=!0,this.texture=this.sourceTexture}applyEffect(e,t){if(this.resolution=e,this.parameters=t,t.hasOwnProperty("useFragment")){this.bwSetup||this.setupBw(),this.blurSetup||this.setupBlur(this.bwTexture),this.adaptiveSetup||this.setupAdaptive(this.bwTexture),this.belndFilter.iChannel1=this.adaptiveTexture,this.belndFilter.intensity=.7,this.belndFilter.alphadir=1,this.filters=[this.belndFilter];return}this.blurSetup||this.setupBlur(),this.adaptiveSharpness.blurImage=this.blurTexture,this.filters=[this.adaptiveSharpness]}setupBlur(e){this.blurSetup=!0,this.blurTexture=this.blurFilter.render(.8,e||this.sourceTexture)}setupAdaptive(e){this.adaptiveSetup=!0,this.adaptiveTexture=PIXI.RenderTexture.create(this.sourceTexture.width,this.sourceTexture.height),this.adaptiveTextureHolder.texture=e||this.sourceTexture,this.adaptiveSharpness.blurImage=this.blurTexture,this.adaptiveTextureHolder.filters=[this.adaptiveSharpness],BFN.Stage.render(this.adaptiveTextureHolder,this.adaptiveTexture),this.adaptiveTextureHolder.filters=[],this.adaptiveTextureHolder=null,this.adaptiveTextureHolder=new PIXI.Sprite}setupBw(){this.bwSetup=!0,this.bwTexture=PIXI.RenderTexture.create(this.sourceTexture.width,this.sourceTexture.height),this.bwTextureHolder.texture=this.sourceTexture,this.bwTextureHolder.filters=[this.bwFilter],BFN.Stage.render(this.bwTextureHolder,this.bwTexture),this.bwTextureHolder.filters=[],this.bwTextureHolder=null,this.bwTextureHolder=new PIXI.Sprite}disposeEffect(){this.sourceTexture=null,this.isSetup=!1,this.blurSetup=!1,this.adaptiveSetup=!1,this.bwSetup=!1,this.currentPresetID=null,this.blurTexture!=null&&(this.blurTexture=null),this.blurFilter.dispose(),this.adaptiveTexture!=null&&(this.adaptiveTexture.destroyGC(!0),this.adaptiveTexture=null),this.bwTexture!=null&&(this.bwTexture.destroyGC(!0),this.bwTexture=null)}};BFN.effects.HDREffect=new jF;var YF=class extends PIXI.Sprite{constructor(){super();this.initialized=!1}initEffect(){this.sourceTexture=null,this.isSetup=!1,this.currentPresetID=null,this.handleEffectTextureLoaderTextureLoadedBind=this.handleEffectTextureLoaderTextureLoaded.bind(this),this.effectTextureLoader=null,this.effectTexture=null,this.vignetteFilter=new BFN.filters.VignetteFilter,this.bwFilterM1=new BFN.filters.BlackWhiteFilter(BFN.CONST.BLACK_WHITE_PRESETS.PRESET_1),this.bwFilterM4=new BFN.filters.BlackWhiteFilter(BFN.CONST.BLACK_WHITE_PRESETS.PRESET_4),this.overlayBlend=new BFN.filters.BlendModeFilter(BFN.CONST.BLEND_MODES.OVERLAY),this.hardlightBlend=new BFN.filters.BlendModeFilter(BFN.CONST.BLEND_MODES.HARD_LIGHT),this.screenBlend=new BFN.filters.BlendModeFilter(BFN.CONST.BLEND_MODES.SCREEN),this.multiplyBlend=new BFN.filters.BlendModeFilter(BFN.CONST.BLEND_MODES.MULTIPLY),this.multiplyBlend2=new BFN.filters.BlendModeFilter(BFN.CONST.BLEND_MODES.MULTIPLY),this.motionBlurFilter=new BFN.filters.MotionBlurFilter,this.shiftChannel=new BFN.filters.ShiftChannelFilter,this.sigmoidFilter=new BFN.filters.SigmoidFilter,this.blurFilter=new BFN.filters.FastBlurWrapper,this.fisheyeFilter=new BFN.filters.FisheyeFilter,this.noiseFilter=new BFN.filters.NoiseFilter,this.isBWSetup=!1,this.isSigmoidSetup=!1,this.overlayBlendSetup=!1,this.hardlightBlendSetup=!1,this.screenBlendSetup=!1,this.multiplyBlendSetup=!1,this.multiplyBlendSetup2=!1,this.isNoiseSetup=!1,this.textureHolder=new PIXI.Sprite,this.textureMap={bwTexture:null,overlayBlendTexture:null,hardlightBlendTexture:null,screenBlendTexture:null,multiplyBlendTexture:null,multiplyBlendTexture2:null,vignetteTexture:null,motionBlurTexture:null,sigmoidTexture:null,fisheyeTexture:null,noiseTexture:null},this.__filters={};for(let e in BFN.CONST.PINHOLE_PRESETS)(BFN.CONST.PINHOLE_PRESETS[e]==BFN.CONST.PINHOLE_PRESETS.PRESET_2||BFN.CONST.PINHOLE_PRESETS[e]==BFN.CONST.PINHOLE_PRESETS.PRESET_5)&&(this.__filters[BFN.CONST.PINHOLE_PRESETS[e]]=new BFN.filters.PinholeFilter(BFN.CONST.PINHOLE_PRESETS[e]))}setupEffect(e){this.initialized||(this.initialized=!0,this.initEffect()),this.disposeEffect(),this.sourceTexture=e,this.isSetup=!0,this.texture=this.sourceTexture}applyEffect(e,t,r){let a=1;if(r&&(a=.1),this.resolution=e,this.parameters=t,this.texture!=this.sourceTexture&&(this.texture=this.sourceTexture),t.hasOwnProperty("presetID")){if(this.currentPresetID=t.presetID,t.hasOwnProperty("imageURL")&&(this.effectTextureLoader||(this.effectTextureLoader=new BFN.EffectTextureLoader,this.effectTextureLoader.addEventListener(BFN.EffectTextureLoaderEvents.TEXTURE_LOADED.type,this.handleEffectTextureLoaderTextureLoadedBind)),!this.effectTexture&&!this.effectTextureLoader.loading&&(r==!0?this.effectTexture=BFN.XMLGraphicLoader.getGraphicByName(t.imageURL,this.sourceTexture.width,this.sourceTexture.height):this.effectTexture=this.effectTextureLoader.getTexture(BFN.originalTextureURl+t.imageURL,this.sourceTexture.width,this.sourceTexture.height))),this.effectTextureLoader!=null&&this.effectTextureLoader.loading){this.filters=[];return}this.effectTextureLoader!=null&&(this.effectTextureLoader.removeEventListener(BFN.EffectTextureLoaderEvents.TEXTURE_LOADED.type,this.handleEffectTextureLoaderTextureLoadedBind),this.effectTextureLoader.destroy(),this.effectTextureLoader=null);let s,o;switch(this.currentPresetID){case BFN.CONST.PINHOLE_PRESETS.PRESET_1:this.isBWSetup||(this.isBWSetup=!0,this.renderCustomFilter(null,"bwTexture",this.bwFilterM1)),this.overlayBlendSetup||(this.overlayBlendSetup=!0,this.overlayBlend.iChannel1=this.textureMap.bwTexture,this.renderCustomFilter(this.textureMap.bwTexture,"overlayBlendTexture",this.overlayBlend)),s=!1,this.vignette_amount!=t.vignette_amount&&(this.vignetteFilter.amount=t.vignette_amount,this.renderCustomFilter(this.textureMap.overlayBlendTexture,"vignetteTexture",this.vignetteFilter),this.vignette_amount=t.vignette_amount,s=!0),(s==!0||this.motion_angle!=t.motion_angle||this.motion_amount!=t.motion_amount)&&(this.motion_angle=this.motionBlurFilter.angleDegree=t.motion_angle,this.motion_amount=t.motion_amount,this.motionBlurFilter.strength=this.motion_amount*Math.min(Math.max(this.sourceTexture.width,this.sourceTexture.height)/4e3,100),this.renderCustomFilter(this.textureMap.vignetteTexture,"motionBlurTexture",this.motionBlurFilter)),this.texture=this.textureMap.vignetteTexture,this.hardlightBlend.iChannel1=this.textureMap.motionBlurTexture,this.filters=[this.hardlightBlend];break;case BFN.CONST.PINHOLE_PRESETS.PRESET_2:this.isSigmoidSetup||(this.isSigmoidSetup=!0,this.sigmoidFilter.sharpness=.3,this.sigmoidFilter.brightness=.75,this.renderCustomFilter(null,"sigmoidTexture",this.sigmoidFilter)),this.hardlightBlendSetup||(this.hardlightBlendSetup=!0,this.hardlightBlend.iChannel1=this.textureMap.sigmoidTexture,this.shiftChannel.mode=5,this.renderCustomFilter(this.effectTexture,"hardlightBlendTexture",[this.hardlightBlend,this.shiftChannel].concat(this.blurFilter.apply(.05*a)))),this.texture=this.textureMap.hardlightBlendTexture,o=this.__filters[this.currentPresetID],o.vignette_amount=t.vignette_amount,o.fisheye_amount=t.fisheye_amount,this.filters=[o];break;case BFN.CONST.PINHOLE_PRESETS.PRESET_3:this.isSigmoidSetup||(this.isSigmoidSetup=!0,this.sigmoidFilter.sharpness=.3,this.sigmoidFilter.brightness=.75,this.renderCustomFilter(null,"sigmoidTexture",this.sigmoidFilter)),this.screenBlendSetup||(this.screenBlendSetup=!0,this.screenBlend.iChannel1=this.textureMap.sigmoidTexture,this.renderCustomFilter(null,"screenBlendTexture",this.screenBlend)),this.multiplyBlendSetup||(this.multiplyBlendSetup=!0,this.multiplyBlend.iChannel1=this.textureMap.screenBlendTexture,this.shiftChannel.mode=4,this.renderCustomFilter(this.effectTexture,"multiplyBlendTexture",[this.multiplyBlend,this.shiftChannel].concat(this.blurFilter.apply(.1*a)))),this.texture=this.textureMap.multiplyBlendTexture,this.fisheyeFilter.radius=t.fisheye_amount,this.filters=[this.fisheyeFilter];break;case BFN.CONST.PINHOLE_PRESETS.PRESET_4:this.isSigmoidSetup||(this.isSigmoidSetup=!0,this.sigmoidFilter.sharpness=.3,this.sigmoidFilter.brightness=.75,this.renderCustomFilter(null,"sigmoidTexture",[this.sigmoidFilter].concat(this.blurFilter.apply(.1*a)))),this.screenBlendSetup||(this.screenBlendSetup=!0,this.screenBlend.iChannel1=this.textureMap.sigmoidTexture,this.renderCustomFilter(null,"screenBlendTexture",this.screenBlend)),this.multiplyBlendSetup||(this.multiplyBlendSetup=!0,this.multiplyBlend.iChannel1=this.textureMap.screenBlendTexture,this.renderCustomFilter(this.effectTexture,"multiplyBlendTexture",this.multiplyBlend)),s=!1,this.vignette_amount!=t.vignette_amount&&(this.vignetteFilter.amount=t.vignette_amount,this.renderCustomFilter(this.textureMap.multiplyBlendTexture,"vignetteTexture",this.vignetteFilter),this.vignette_amount=t.vignette_amount,this.multiplyBlendSetup2=!1,s=!0),(s==!0||this.motion_angle!=t.motion_angle||this.motion_amount!=t.motion_amount)&&(this.motion_angle=this.motionBlurFilter.angleDegree=t.motion_angle,this.motion_amount=t.motion_amount,this.motionBlurFilter.strength=this.motion_amount*Math.min(Math.max(this.sourceTexture.width,this.sourceTexture.height)/4e3,100),this.renderCustomFilter(this.textureMap.vignetteTexture,"motionBlurTexture",this.motionBlurFilter),this.multiplyBlendSetup2=!1),this.multiplyBlendSetup2||(this.multiplyBlendSetup2=!0,this.multiplyBlend2.iChannel1=this.textureMap.vignetteTexture,this.renderCustomFilter(this.textureMap.motionBlurTexture,"multiplyBlendTexture2",this.multiplyBlend2),this.overlayBlendSetup=!1),this.isNoiseSetup||(this.isNoiseSetup=!0,this.noiseFilter.duocolor1="0xffffff",this.noiseFilter.duocolor2="0xb8b8b8",this.renderCustomFilter(null,"noiseTexture",this.noiseFilter)),this.overlayBlendSetup||(this.overlayBlendSetup=!0,this.overlayBlend.iChannel1=this.textureMap.noiseTexture,this.renderCustomFilter(this.textureMap.multiplyBlendTexture2,"overlayBlendTexture",this.overlayBlend)),this.texture=this.textureMap.overlayBlendTexture,this.fisheyeFilter.radius=t.fisheye_amount,this.filters=[this.fisheyeFilter];break;case BFN.CONST.PINHOLE_PRESETS.PRESET_5:this.isBWSetup||(this.isBWSetup=!0,this.renderCustomFilter(null,"bwTexture",this.bwFilterM4)),this.isSigmoidSetup||(this.isSigmoidSetup=!0,this.sigmoidFilter.sharpness=.3,this.sigmoidFilter.brightness=.75,this.renderCustomFilter(null,"sigmoidTexture",this.sigmoidFilter)),this.screenBlendSetup||(this.screenBlendSetup=!0,this.screenBlend.iChannel1=this.textureMap.sigmoidTexture,this.renderCustomFilter(this.textureMap.bwTexture,"screenBlendTexture",this.screenBlend)),this.texture=this.textureMap.screenBlendTexture,o=this.__filters[this.currentPresetID],o.iChanel1=this.effectTexture,o.vignette_amount=t.vignette_amount,o.fisheye_amount=t.fisheye_amount,this.filters=[o];break}}else this.filters=[]}handleEffectTextureLoaderTextureLoaded(e){BFN.EffectManager.currentEffect==this?BFN.EffectManager.processEffect():this.applyEffect(this.resolution,this.parameters)}renderCustomFilter(e,t,r){this.textureMap[t]==null&&(this.textureMap[t]=PIXI.RenderTexture.create(this.sourceTexture.width,this.sourceTexture.height)),this.textureHolder.texture=e||this.sourceTexture,this.textureHolder.filters=r.constructor===Array?r:[r],BFN.Stage.render(this.textureHolder,this.textureMap[t]),this.textureHolder.filters=[],this.textureHolder.texture=null}disposeEffect(){this.sourceTexture=null,this.isSetup=!1,this.currentPresetID=null,this.effectTextureLoader!=null&&(this.effectTextureLoader.removeEventListener(BFN.EffectTextureLoaderEvents.TEXTURE_LOADED.type,this.handleEffectTextureLoaderTextureLoadedBind),this.effectTextureLoader.destroy(),this.effectTextureLoader=null),this.isBWSetup=!1,this.overlayBlendSetup=!1,this.isSigmoidSetup=!1,this.hardlightBlendSetup=!1,this.screenBlendSetup=!1,this.multiplyBlendSetup=!1,this.multiplyBlendSetup2=!1,this.isNoiseSetup=!1;let e=this.textureMap;Object.keys(e).forEach(t=>{e.hasOwnProperty(t)&&e[t]!=null&&(e[t].destroyGC(!0),e[t]=null)}),this.blurFilter.dispose(),this.disposeTexture("effectTexture"),this.vignette_amount=null,this.motion_angle=null,this.motion_amount=null,this.fisheye_amount=null}disposeTexture(e){this[e]&&this[e]!=null&&(this[e].destroyGC(!0),this[e]=null)}};BFN.effects.PinholeEffect=new YF;var qF=class extends PIXI.Sprite{constructor(){super();this.initialized=!1}initEffect(){this.sourceTexture=null,this.isSetup=!1,this.currentPresetID=null,this.handleEffectTextureLoaderTextureLoadedBind=this.handleEffectTextureLoaderTextureLoaded.bind(this),this.effectTextureLoader=null,this.effectTexture=null,this.colorMatrix=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],this.brightnessContrastFilter=new PIXI.filters.ColorMatrixFilter,this.brightnessContrastFilter.matrix=this.colorMatrix,this.vignetteFilter=new BFN.filters.VignetteFilter,this.bwFilterM1=new BFN.filters.BlackWhiteFilter(BFN.CONST.BLACK_WHITE_PRESETS.PRESET_1),this.bwFilterM4=new BFN.filters.BlackWhiteFilter(BFN.CONST.BLACK_WHITE_PRESETS.PRESET_4),this.overlayBlend=new BFN.filters.BlendModeFilter(BFN.CONST.BLEND_MODES.OVERLAY),this.hardlightBlend=new BFN.filters.BlendModeFilter(BFN.CONST.BLEND_MODES.HARD_LIGHT),this.screenBlend=new BFN.filters.BlendModeFilter(BFN.CONST.BLEND_MODES.SCREEN),this.multiplyBlend=new BFN.filters.BlendModeFilter(BFN.CONST.BLEND_MODES.MULTIPLY),this.multiplyBlend2=new BFN.filters.BlendModeFilter(BFN.CONST.BLEND_MODES.MULTIPLY),this.motionBlurFilter=new BFN.filters.MotionBlurFilter,this.shiftChannel=new BFN.filters.ShiftChannelFilter,this.sigmoidFilter=new BFN.filters.SigmoidFilter,this.blurFilter=new BFN.filters.FastBlurWrapper(null,null,!0),this.fisheyeFilter=new BFN.filters.FisheyeFilter,this.noiseFilter=new BFN.filters.NoiseFilter,this.isBWSetup=!1,this.isBlurSetup=!1,this.isSigmoidSetup=!1,this.overlayBlendSetup=!1,this.hardlightBlendSetup=!1,this.screenBlendSetup=!1,this.multiplyBlendSetup=!1,this.multiplyBlendSetup2=!1,this.isNoiseSetup=!1,this.isFisheyeSetup=!1,this.isColoredTextureSetup=!1,this.isSCTextureSetup=!1,this.textureHolder=new PIXI.Sprite,this.textureMap={bwTexture:null,blurTexture:null,overlayBlendTexture:null,hardlightBlendTexture:null,screenBlendTexture:null,multiplyBlendTexture:null,multiplyBlendTexture2:null,vignetteTexture:null,motionBlurTexture:null,sigmoidTexture:null,fisheyeTexture:null,noiseTexture:null,coloredTexture:null,scTexture:null}}setupEffect(e){this.initialized||(this.initialized=!0,this.initEffect()),this.disposeEffect(),this.sourceTexture=e,this.isSetup=!0,this.texture=this.sourceTexture}applyEffect(e,t,r){let a=1;if(r&&(a=.1),this.resolution=e,this.parameters=t,this.texture!=this.sourceTexture&&(this.texture=this.sourceTexture),t.hasOwnProperty("presetID")){if(this.currentPresetID=t.presetID,t.hasOwnProperty("imageURL")&&(this.effectTextureLoader||(this.effectTextureLoader=new BFN.EffectTextureLoader,this.effectTextureLoader.addEventListener(BFN.EffectTextureLoaderEvents.TEXTURE_LOADED.type,this.handleEffectTextureLoaderTextureLoadedBind)),!this.effectTexture&&!this.effectTextureLoader.loading&&(r==!0?this.effectTexture=BFN.XMLGraphicLoader.getGraphicByName(t.imageURL,this.sourceTexture.width,this.sourceTexture.height):this.effectTexture=this.effectTextureLoader.getTexture(BFN.originalTextureURl+t.imageURL,this.sourceTexture.width,this.sourceTexture.height))),this.effectTextureLoader!=null&&this.effectTextureLoader.loading){this.filters=[];return}switch(this.effectTextureLoader!=null&&(this.effectTextureLoader.removeEventListener(BFN.EffectTextureLoaderEvents.TEXTURE_LOADED.type,this.handleEffectTextureLoaderTextureLoadedBind),this.effectTextureLoader.destroy(),this.effectTextureLoader=null),this.currentPresetID){case BFN.CONST.PINHOLE_PRESETS.PRESET_1:this.isSigmoidSetup||(this.isSigmoidSetup=!0,this.sigmoidFilter.sharpness=.3,this.sigmoidFilter.brightness=.75,this.renderCustomFilter(null,"sigmoidTexture",this.sigmoidFilter)),this.screenBlendSetup||(this.screenBlendSetup=!0,this.screenBlend.iChannel1=this.textureMap.sigmoidTexture,this.renderCustomFilter(null,"screenBlendTexture",this.screenBlend)),this.multiplyBlendSetup||(this.multiplyBlendSetup=!0,this.multiplyBlend.iChannel1=this.textureMap.screenBlendTexture,this.shiftChannel.mode=2,this.renderCustomFilter(this.effectTexture,"multiplyBlendTexture",[this.multiplyBlend,this.shiftChannel].concat(this.blurFilter.apply(.1*a)))),this.texture=this.textureMap.multiplyBlendTexture,this.fisheyeFilter.radius=t.fisheye_amount,this.filters=[this.fisheyeFilter];break;case BFN.CONST.PINHOLE_PRESETS.PRESET_2:this.multiplyBlendSetup||(this.multiplyBlendSetup=!0,this.shiftChannel.mode=3,this.renderCustomFilter(null,"coloredTexture",[this.shiftChannel]),this.multiplyBlend.iChannel1=this.textureMap.coloredTexture,this.renderCustomFilter(this.effectTexture,"multiplyBlendTexture",[this.multiplyBlend].concat(this.blurFilter.apply(.1*a)))),this.texture=this.textureMap.multiplyBlendTexture,this.vignetteFilter.amount=t.vignette_amount,this.fisheyeFilter.radius=t.fisheye_amount,this.filters=[this.fisheyeFilter,this.vignetteFilter];break;case BFN.CONST.PINHOLE_PRESETS.PRESET_3:this.isSCTextureSetup||(this.isSCTextureSetup=!0,this.shiftChannel.mode=3,this.renderCustomFilter(null,"scTexture",this.shiftChannel)),this.hardlightBlendSetup||(this.hardlightBlendSetup=!0,this.hardlightBlend.iChannel1=this.textureMap.scTexture,this.brightnessContrastFilter.brightness(1,!1),this.brightnessContrastFilter.contrast(.4,!0),this.renderCustomFilter(null,"hardlightBlendTexture",[this.hardlightBlend,this.brightnessContrastFilter])),this.multiplyBlendSetup||(this.multiplyBlendSetup=!0,this.multiplyBlend.iChannel1=this.effectTexture,this.renderCustomFilter(this.textureMap.hardlightBlendTexture,"multiplyBlendTexture",this.multiplyBlend)),this.texture=this.textureMap.multiplyBlendTexture,this.fisheyeFilter.radius=t.fisheye_amount,this.filters=[this.fisheyeFilter];break;case BFN.CONST.PINHOLE_PRESETS.PRESET_4:(!this.isFisheyeSetup||this.fisheye_amount!=t.fisheye_amount)&&(this.isFisheyeSetup=!0,this.fisheye_amount=t.fisheye_amount,this.fisheyeFilter.radius=t.fisheye_amount,this.renderCustomFilter(null,"fisheyeTexture",[this.fisheyeFilter].concat(this.blurFilter.apply(.1*a))),this.multiplyBlendSetup=!1,this.hardlightBlendSetup=!1),this.isColoredTextureSetup||this.createColoredTexture(16777215),this.vignette_amount!=t.vignette_amount&&(this.vignette_amount=t.vignette_amount,this.vignetteFilter.amount=t.vignette_amount,this.renderCustomFilter(this.textureMap.coloredTexture,"vignetteTexture",this.vignetteFilter),this.multiplyBlendSetup=!1,this.hardlightBlendSetup=!1),this.hardlightBlendSetup||(this.hardlightBlendSetup=!0,this.hardlightBlend.iChannel1=this.textureMap.fisheyeTexture,this.renderCustomFilter(this.textureMap.vignetteTexture,"hardlightBlendTexture",[this.hardlightBlend]),this.isBWSetup=!1,this.multiplyBlendSetup=!1,this.isBlurSetup=!1),this.isBWSetup||(this.isBWSetup=!0,this.renderCustomFilter(this.textureMap.hardlightBlendTexture,"bwTexture",this.bwFilterM4)),this.isBlurSetup||(this.isBlurSetup=!0,this.textureMap.blurTexture=this.blurFilter.render(.04,this.textureMap.hardlightBlendTexture)),this.multiplyBlendSetup||(this.multiplyBlendSetup=!0,this.multiplyBlend.iChannel1=this.textureMap.blurTexture,this.renderCustomFilter(this.textureMap.bwTexture,"multiplyBlendTexture",this.multiplyBlend)),this.texture=this.effectTexture,this.overlayBlend.iChannel1=this.textureMap.multiplyBlendTexture,this.filters=[this.overlayBlend];break;case BFN.CONST.PINHOLE_PRESETS.PRESET_5:this.hardlightBlendSetup||(this.hardlightBlendSetup=!0,this.hardlightBlend.iChannel1=this.sourceTexture,this.renderCustomFilter(null,"hardlightBlendTexture",[this.hardlightBlend])),this.isBWSetup||(this.isBWSetup=!0,this.renderCustomFilter(this.textureMap.hardlightBlendTexture,"bwTexture",this.bwFilterM4)),this.isBlurSetup||(this.isBlurSetup=!0,this.textureMap.blurTexture=this.blurFilter.render(.04,this.textureMap.hardlightBlendTexture)),this.multiplyBlendSetup||(this.multiplyBlendSetup=!0,this.multiplyBlend.iChannel1=this.textureMap.blurTexture,this.renderCustomFilter(this.textureMap.bwTexture,"multiplyBlendTexture",this.multiplyBlend)),this.texture=this.textureMap.multiplyBlendTexture,this.vignetteFilter.amount=t.vignette_amount,this.fisheyeFilter.radius=t.fisheye_amount,this.filters=[this.fisheyeFilter,this.vignetteFilter];break}}else this.filters=[]}handleEffectTextureLoaderTextureLoaded(e){BFN.EffectManager.currentEffect==this?BFN.EffectManager.processEffect():this.applyEffect(this.resolution,this.parameters)}renderCustomFilter(e,t,r){this.textureMap[t]==null&&(this.textureMap[t]=PIXI.RenderTexture.create(this.sourceTexture.width,this.sourceTexture.height)),this.textureHolder.texture=e||this.sourceTexture,this.textureHolder.filters=r.constructor===Array?r:[r],BFN.Stage.render(this.textureHolder,this.textureMap[t]),this.textureHolder.filters=[],this.textureHolder.texture=null}createColoredTexture(e,t){this.isColoredTextureSetup=!0;let r=new PIXI.Graphics;r.beginFill(e),r.drawRect(0,0,this.sourceTexture.width,this.sourceTexture.height),r.endFill(),t!=null&&(r.filters=t.constructor===Array?t:[t]),this.textureMap.coloredTexture=PIXI.RenderTexture.create(this.sourceTexture.width,this.sourceTexture.height),BFN.Stage.render(r,this.textureMap.coloredTexture),r.filters=[],r.clear(),r=null}disposeEffect(){this.sourceTexture=null,this.isSetup=!1,this.currentPresetID=null,this.effectTextureLoader!=null&&(this.effectTextureLoader.removeEventListener(BFN.EffectTextureLoaderEvents.TEXTURE_LOADED.type,this.handleEffectTextureLoaderTextureLoadedBind),this.effectTextureLoader.destroy(),this.effectTextureLoader=null),this.isBWSetup=!1,this.isBlurSetup=!1,this.overlayBlendSetup=!1,this.isSigmoidSetup=!1,this.hardlightBlendSetup=!1,this.screenBlendSetup=!1,this.multiplyBlendSetup=!1,this.multiplyBlendSetup2=!1,this.isNoiseSetup=!1,this.isFisheyeSetup=!1,this.isColoredTextureSetup=!1,this.isSCTextureSetup=!1,this.disposeTexture("effectTexture");let e=this.textureMap;Object.keys(e).forEach(t=>{e.hasOwnProperty(t)&&e[t]!=null&&(t!="blurTexture"&&e[t].destroyGC(!0),e[t]=null)}),this.blurFilter.dispose(),this.vignette_amount=null,this.motion_angle=null,this.motion_amount=null,this.fisheye_amount=null}disposeTexture(e){this[e]&&this[e]!=null&&(this[e].destroyGC(!0),this[e]=null)}};BFN.effects.ColorPinholeEffect=new qF;var KF=class extends PIXI.Sprite{constructor(){super();this.initialized=!1}initEffect(){this.sourceTexture=null,this.isSetup=!1,this.handleEffectTextureLoaderTextureLoadedBind=this.handleEffectTextureLoaderTextureLoaded.bind(this),this.effectTextureLoader=null,this.currentPresetID=null,this.effectTexture=null,this.blurFilter=new BFN.filters.FastBlurWrapper(null,null,!0),this.blurTexture=null,this.blurSetup=!1,this.__filters={};for(let e in BFN.CONST.STENCILER_PRESETS)this.__filters[BFN.CONST.STENCILER_PRESETS[e]]=new BFN.filters.StencilerFilter(BFN.CONST.STENCILER_PRESETS[e])}setupEffect(e){this.initialized||(this.initialized=!0,this.initEffect()),this.disposeEffect(),this.sourceTexture=e,this.isSetup=!0,this.texture=this.sourceTexture}applyEffect(e,t,r){if(this.resolution=e,this.parameters=t,t.hasOwnProperty("presetID")&&this.__filters.hasOwnProperty(t.presetID)){this.currentPresetID=t.presetID;let a=this.__filters[this.currentPresetID];if(t.hasOwnProperty("imageURL")&&(this.effectTextureLoader||(this.effectTextureLoader=new BFN.EffectTextureLoader,this.effectTextureLoader.addEventListener(BFN.EffectTextureLoaderEvents.TEXTURE_LOADED.type,this.handleEffectTextureLoaderTextureLoadedBind)),!this.effectTexture&&!this.effectTextureLoader.loading&&(r==!0?this.effectTexture=BFN.XMLGraphicLoader.getGraphicByName(t.imageURL,this.sourceTexture.width,this.sourceTexture.height):this.effectTexture=this.effectTextureLoader.getTexture(BFN.originalTextureURl+t.imageURL,this.sourceTexture.width,this.sourceTexture.height))),this.effectTextureLoader!=null&&this.effectTextureLoader.loading){this.filters=[];return}this.effectTextureLoader!=null&&(this.effectTextureLoader.removeEventListener(BFN.EffectTextureLoaderEvents.TEXTURE_LOADED.type,this.handleEffectTextureLoaderTextureLoadedBind),this.effectTextureLoader.destroy(),this.effectTextureLoader=null),!this.blurSetup&&t.hasOwnProperty("useBlur")&&(this.setupBlur(),a.blurSampler=this.blurTexture),a.textureSampler=this.effectTexture,t.hasOwnProperty("color")&&(a.color=t.color),t.hasOwnProperty("detail_level")&&(a.detail_level=t.detail_level),t.hasOwnProperty("color_detail")&&(a.color_detail=t.color_detail),t.hasOwnProperty("smooth_amount")&&(a.smooth_amount=t.smooth_amount),this.filters=[a]}}handleEffectTextureLoaderTextureLoaded(e){BFN.EffectManager.currentEffect==this?BFN.EffectManager.processEffect():this.applyEffect(this.resolution,this.parameters)}setupBlur(){this.blurSetup=!0,this.idealBlur=Math.max(this.sourceTexture.width,this.sourceTexture.height)/4e3,this.blurTexture=this.blurFilter.render(.5,this.sourceTexture)}disposeEffect(){this.sourceTexture=null,this.isSetup=!1,this.blurSetup=!1,this.currentPresetID=null,this.blurTexture!=null&&(this.blurTexture=null),this.blurFilter.dispose(),this.effectTexture!=null&&(this.effectTexture.destroyGC(!0),this.effectTexture=null),this.effectTextureLoader!=null&&(this.effectTextureLoader.removeEventListener(BFN.EffectTextureLoaderEvents.TEXTURE_LOADED.type,this.handleEffectTextureLoaderTextureLoadedBind),this.effectTextureLoader.destroy(),this.effectTextureLoader=null)}};BFN.effects.StencilerEffect=new KF;var JF=class extends PIXI.Sprite{constructor(){super();this.initialized=!1}initEffect(){this.sourceTexture=null,this.isSetup=!1,this.handleEffectTextureLoaderTextureLoadedBind=this.handleEffectTextureLoaderTextureLoaded.bind(this),this.effectTextureLoader=null,this.currentPresetID=null,this.effectTexture=null,this.blurFilter=new BFN.filters.FastBlurWrapper(null,null,!0),this.blurTexture=null,this.blurSetup=!1,this.__filters={};for(let e in BFN.CONST.GRUNGE_PRESETS)this.__filters[BFN.CONST.GRUNGE_PRESETS[e]]=new BFN.filters.GrungeFilter(BFN.CONST.GRUNGE_PRESETS[e])}setupEffect(e){this.initialized||(this.initialized=!0,this.initEffect()),this.disposeEffect(),this.sourceTexture=e,this.isSetup=!0,this.texture=this.sourceTexture}applyEffect(e,t,r){if(this.resolution=e,this.parameters=t,t.hasOwnProperty("presetID")&&this.__filters.hasOwnProperty(t.presetID)){this.currentPresetID=t.presetID;let a=this.__filters[this.currentPresetID];if(t.hasOwnProperty("imageURL")&&(this.effectTextureLoader||(this.effectTextureLoader=new BFN.EffectTextureLoader,this.effectTextureLoader.addEventListener(BFN.EffectTextureLoaderEvents.TEXTURE_LOADED.type,this.handleEffectTextureLoaderTextureLoadedBind)),!this.effectTexture&&!this.effectTextureLoader.loading&&(r==!0?this.effectTexture=BFN.XMLGraphicLoader.getGraphicByName(t.imageURL,this.sourceTexture.width,this.sourceTexture.height):this.effectTexture=this.effectTextureLoader.getTexture(BFN.originalTextureURl+t.imageURL,this.sourceTexture.width,this.sourceTexture.height))),this.effectTextureLoader!=null&&this.effectTextureLoader.loading){this.filters=[];return}this.effectTextureLoader!=null&&(this.effectTextureLoader.removeEventListener(BFN.EffectTextureLoaderEvents.TEXTURE_LOADED.type,this.handleEffectTextureLoaderTextureLoadedBind),this.effectTextureLoader.destroy(),this.effectTextureLoader=null),t.hasOwnProperty("useBlur")&&(this.blurSetup||this.setupBlur(),a.blurImage=this.blurTexture),a.iChannel1=this.effectTexture,t.hasOwnProperty("silhouette_amount")&&(a.silhouette_amount=t.silhouette_amount),t.hasOwnProperty("detail_level")&&(a.detail_level=t.detail_level),t.hasOwnProperty("shadow_amount")&&(a.shadow_amount=t.shadow_amount),this.filters=[a]}}handleEffectTextureLoaderTextureLoaded(e){BFN.EffectManager.currentEffect==this?BFN.EffectManager.processEffect():this.applyEffect(this.resolution,this.parameters)}setupBlur(){this.blurSetup=!0,this.blurTexture=this.blurFilter.render(.85,this.sourceTexture)}disposeEffect(){this.sourceTexture=null,this.isSetup=!1,this.blurSetup=!1,this.currentPresetID=null,this.blurTexture!=null&&(this.blurTexture=null),this.blurFilter.dispose(),this.effectTexture!=null&&(this.effectTexture.destroyGC(!0),this.effectTexture=null),this.effectTextureLoader!=null&&(this.effectTextureLoader.removeEventListener(BFN.EffectTextureLoaderEvents.TEXTURE_LOADED.type,this.handleEffectTextureLoaderTextureLoadedBind),this.effectTextureLoader.destroy(),this.effectTextureLoader=null)}};BFN.effects.GrungeEffect=new JF;var QF=class extends PIXI.Sprite{constructor(){super();this.initialized=!1}initEffect(){this.sourceTexture=null,this.isSetup=!1,this.handleEffectTextureLoaderTextureLoadedBind=this.handleEffectTextureLoaderTextureLoaded.bind(this),this.effectTextureLoader=null,this.currentPresetID=null,this.effectTexture=null,this.blurFilter=new BFN.filters.FastBlurWrapper(null,null,!0),this.blurTexture=null,this.blurSetup=!1,this.__filters={};for(let e in BFN.CONST.SUNBURST_PRESETS)this.__filters[BFN.CONST.SUNBURST_PRESETS[e]]=new BFN.filters.SunburstFilter(BFN.CONST.SUNBURST_PRESETS[e])}setupEffect(e){this.initialized||(this.initialized=!0,this.initEffect()),this.disposeEffect(),this.sourceTexture=e,this.isSetup=!0,this.texture=this.sourceTexture}applyEffect(e,t,r){if(this.resolution=e,this.parameters=t,t.hasOwnProperty("presetID")&&this.__filters.hasOwnProperty(t.presetID)){this.currentPresetID=t.presetID;let a=this.__filters[this.currentPresetID];if(t.hasOwnProperty("imageURL")&&(this.effectTextureLoader||(this.effectTextureLoader=new BFN.EffectTextureLoader,this.effectTextureLoader.addEventListener(BFN.EffectTextureLoaderEvents.TEXTURE_LOADED.type,this.handleEffectTextureLoaderTextureLoadedBind)),!this.effectTexture&&!this.effectTextureLoader.loading&&(r==!0?this.effectTexture=BFN.XMLGraphicLoader.getGraphicByName(t.imageURL,this.sourceTexture.width,this.sourceTexture.height):this.effectTexture=this.effectTextureLoader.getTexture(BFN.originalTextureURl+t.imageURL,this.sourceTexture.width,this.sourceTexture.height))),this.effectTextureLoader!=null&&this.effectTextureLoader.loading){this.filters=[];return}this.effectTextureLoader!=null&&(this.effectTextureLoader.removeEventListener(BFN.EffectTextureLoaderEvents.TEXTURE_LOADED.type,this.handleEffectTextureLoaderTextureLoadedBind),this.effectTextureLoader.destroy(),this.effectTextureLoader=null),t.hasOwnProperty("useBlur")&&(this.blurSetup||this.setupBlur(),a.blurSampler=this.blurTexture),a.textureSampler=this.effectTexture,t.hasOwnProperty("color")&&(a.color=t.color),t.hasOwnProperty("halftone_size")&&(a.halftone_size=Math.max(Math.floor(t.halftone_size*Math.max(this.sourceTexture.width,this.sourceTexture.height)/512),3)),t.hasOwnProperty("silhouette_amount")&&(a.silhouette_amount=t.silhouette_amount),t.hasOwnProperty("sunburst_amount")&&(a.sunburst_amount=t.sunburst_amount),t.hasOwnProperty("grain_amount")&&(a.grain_amount=t.grain_amount),this.filters=[a]}}handleEffectTextureLoaderTextureLoaded(e){BFN.EffectManager.currentEffect==this?BFN.EffectManager.processEffect():this.applyEffect(this.resolution,this.parameters)}setupBlur(){this.blurSetup=!0,this.idealBlur=Math.max(this.sourceTexture.width,this.sourceTexture.height)/4e3,this.blurTexture=this.blurFilter.render(.5,this.sourceTexture)}disposeEffect(){this.sourceTexture=null,this.isSetup=!1,this.blurSetup=!1,this.currentPresetID=null,this.blurTexture!=null&&(this.blurTexture=null),this.blurFilter.dispose(),this.effectTexture!=null&&(this.effectTexture.destroyGC(!0),this.effectTexture=null),this.effectTextureLoader!=null&&(this.effectTextureLoader.removeEventListener(BFN.EffectTextureLoaderEvents.TEXTURE_LOADED.type,this.handleEffectTextureLoaderTextureLoadedBind),this.effectTextureLoader.destroy(),this.effectTextureLoader=null)}};BFN.effects.SunburstEffect=new QF;var ZF=class extends PIXI.Sprite{constructor(){super();this.initialized=!1}initEffect(){this.sourceTexture=null,this.isSetup=!1,this.currentPresetID=null,this.handleEffectTextureLoaderTextureLoadedBind=this.handleEffectTextureLoaderTextureLoaded.bind(this),this.effectTextureLoader=null,this.effectTexture=null,this.blurFilter=new BFN.filters.FastBlurWrapper,this.exposureFilter=new BFN.filters.HSFilter,this.duotoneFilter=new BFN.filters.DuoToneFilter,this.brightnessContrastFilter=new PIXI.filters.ColorMatrixFilter,this.brightnessContrastFilter.matrix=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],this.__filters={};for(let e in BFN.CONST.OLD_PHOTO_PRESETS)BFN.CONST.OLD_PHOTO_PRESETS[e]==BFN.CONST.OLD_PHOTO_PRESETS.PRESET_19||BFN.CONST.OLD_PHOTO_PRESETS[e]==BFN.CONST.OLD_PHOTO_PRESETS.PRESET_20?this.__filters[BFN.CONST.OLD_PHOTO_PRESETS[e]]=new BFN.filters.BlendModeFilter(BFN.CONST.BLEND_MODES.OVERLAY):this.__filters[BFN.CONST.OLD_PHOTO_PRESETS[e]]=new BFN.filters.OldPhotoFilter(BFN.CONST.OLD_PHOTO_PRESETS[e]);this.blurTexture=null,this.curvesTexture=null,this.isBlurSetup=!1,this.isCurvesSetup=!1,this.blurAmount=null,this.highlights=0,this.shadows=0}setupEffect(e){this.initialized||(this.initialized=!0,this.initEffect()),this.disposeEffect(),this.sourceTexture=e,this.isSetup=!0,this.texture=this.sourceTexture}applyEffect(e,t,r){let a=1;if(r&&(a=.1),this.resolution=e,this.parameters=t,this.texture!=this.sourceTexture&&(this.texture=this.sourceTexture),t.hasOwnProperty("presetID")){this.currentPresetID=t.presetID;let s=this.__filters[this.currentPresetID];if(t.hasOwnProperty("imageURL")&&(this.effectTextureLoader||(this.effectTextureLoader=new BFN.EffectTextureLoader,this.effectTextureLoader.addEventListener(BFN.EffectTextureLoaderEvents.TEXTURE_LOADED.type,this.handleEffectTextureLoaderTextureLoadedBind)),!this.effectTexture&&!this.effectTextureLoader.loading&&(r==!0?this.effectTexture=BFN.XMLGraphicLoader.getGraphicByName(t.imageURL,this.sourceTexture.width,this.sourceTexture.height):this.effectTexture=this.effectTextureLoader.getTexture(BFN.originalTextureURl+t.imageURL,this.sourceTexture.width,this.sourceTexture.height))),this.effectTextureLoader!=null&&this.effectTextureLoader.loading){this.filters=[];return}if(this.effectTextureLoader!=null&&(this.effectTextureLoader.removeEventListener(BFN.EffectTextureLoaderEvents.TEXTURE_LOADED.type,this.handleEffectTextureLoaderTextureLoadedBind),this.effectTextureLoader.destroy(),this.effectTextureLoader=null),this.currentPresetID==BFN.CONST.OLD_PHOTO_PRESETS.PRESET_19||this.currentPresetID==BFN.CONST.OLD_PHOTO_PRESETS.PRESET_20){s.iChannel1=this.effectTexture;let l=!1;if(t.hasOwnProperty("highlights")&&((t.highlights!=0||t.shadows!=0)&&(t.highlights!=this.highlights||t.shadows!=this.shadows)&&(this.exposureFilter.highlights=t.highlights,this.exposureFilter.shadows=t.shadows,l=!0,this.isCurvesSetup=!1),this.highlights=t.highlights,this.shadows=t.shadows),!this.isCurvesSetup){this.disposeTexture("curvesTexture"),this.isCurvesSetup=!0,this.duotoneFilter.color1="0xFFFFFF",this.duotoneFilter.color2=this.currentPresetID==BFN.CONST.OLD_PHOTO_PRESETS.PRESET_19?"0x281c02":"0x0b0802";let c=l?this.renderCustomFilter(null,[this.exposureFilter,this.duotoneFilter]):this.renderCustomFilter(null,[this.duotoneFilter]);this.curvesTexture=this.renderCurves(c,BFN.CONST.PALETTE_MAPS.darkerMap,this.currentPresetID==BFN.CONST.OLD_PHOTO_PRESETS.PRESET_19?BFN.CONST.PALETTE_MAPS.contrast:BFN.CONST.PALETTE_MAPS.contrastHigh),c.destroyGC(!0),c=null}s.intensity=.65,this.texture=this.curvesTexture,this.filters=[s];return}let o=null;t.hasOwnProperty("focal_blur")?o=t.focal_blur:t.hasOwnProperty("blur_amount")&&(o=t.blur_amount),o!=this.blurAmount&&(this.blurAmount=o,this.isBlurSetup==!0&&(this.isBlurSetup=!1)),t.hasOwnProperty("useBlur")?(this.isBlurSetup||(this.isBlurSetup=!0,this.blurTexture=this.blurFilter.render(this.blurAmount!=null?this.blurAmount*a:.1*a,this.sourceTexture)),s.blurSampler=this.blurTexture):t.hasOwnProperty("focal_blur")?s.focal_blur=t.focal_blur:t.hasOwnProperty("blur_amount")&&(s.blur_amount=t.blur_amount),this.effectTexture!=null&&(s.textureSampler=this.effectTexture);let n=[];t.hasOwnProperty("grain_amount")&&(s.grain_amount=t.grain_amount),t.hasOwnProperty("silhouette_amount")&&(s.silhouette_amount=t.silhouette_amount),t.hasOwnProperty("color_amount")&&(s.color_amount=t.color_amount),(t.highlights!=0||t.shadows!=0)&&(this.exposureFilter.highlights=t.highlights,this.exposureFilter.shadows=t.shadows,n[n.length]=this.exposureFilter),t.hasOwnProperty("brightness")&&(this.brightnessContrastFilter.brightness(t.brightness,!1),n[n.length]=this.brightnessContrastFilter),t.hasOwnProperty("contrast")&&(s.contrast=t.contrast),n[n.length]=s,this.filters=n}else this.filters=[]}handleEffectTextureLoaderTextureLoaded(e){BFN.EffectManager.currentEffect==this?BFN.EffectManager.processEffect():this.applyEffect(this.resolution,this.parameters)}renderCustomFilter(e,t){let r=PIXI.RenderTexture.create(this.sourceTexture.width,this.sourceTexture.height),a=new PIXI.Sprite(e||this.sourceTexture);return a.filters=t.constructor===Array?t:[t],BFN.Stage.render(a,r),a.filters=[],a=null,r}renderCurves(e,t,r){let a=t.length==3?new BFN.filters.CurvesFilter(t[0],t[1],t[2]):t.length==2?new BFN.filters.CurvesFilter(t[0],t[1]):new BFN.filters.CurvesFilter(t),s=PIXI.RenderTexture.create(this.sourceTexture.width,this.sourceTexture.height),o=new PIXI.Sprite;if(o.texture=e,o.filters=[a],BFN.Stage.render(o,s),r!=null){let n=r.length==3?new BFN.filters.CurvesFilter(r[0],r[1],r[2]):r.length==2?new BFN.filters.CurvesFilter(r[0],r[1]):new BFN.filters.CurvesFilter(r),l=PIXI.RenderTexture.create(this.sourceTexture.width,this.sourceTexture.height),c=new PIXI.Sprite;return c.texture=s,c.filters=[n],BFN.Stage.render(c,l),s.destroyGC(!0),s=null,l}return s}disposeEffect(){this.sourceTexture=null,this.isSetup=!1,this.currentPresetID=null,this.effectTextureLoader!=null&&(this.effectTextureLoader.removeEventListener(BFN.EffectTextureLoaderEvents.TEXTURE_LOADED.type,this.handleEffectTextureLoaderTextureLoadedBind),this.effectTextureLoader.destroy(),this.effectTextureLoader=null),this.isBlurSetup=!1,this.isCurvesSetup=!1,this.disposeTexture("effectTexture"),this.disposeTexture("curvesTexture"),this.blurFilter.dispose(),this.blurTexture=null,this.blurAmount=null,this.highlights=0,this.shadows=0}disposeTexture(e){this[e]&&this[e]!=null&&(this[e].destroyGC(!0),this[e]=null)}};BFN.effects.OldPhotoEffect=new ZF;var eb=class extends PIXI.Sprite{constructor(){super();this.initialized=!1}initEffect(){this.sourceTexture=null,this.isSetup=!1,this.handleEffectTextureLoaderTextureLoadedBind=this.handleEffectTextureLoaderTextureLoaded.bind(this),this.effectTextureLoader=null,this.currentPresetID=null,this.effectTexture=null,this.isTileSetup=!1,this.__filters={};for(let e in BFN.CONST.WINTER_PRESETS)this.__filters[BFN.CONST.WINTER_PRESETS[e]]=new BFN.filters.WinterFilter(BFN.CONST.WINTER_PRESETS[e])}setupEffect(e){this.initialized||(this.initialized=!0,this.initEffect()),this.disposeEffect(),this.sourceTexture=e,this.isSetup=!0,this.texture=this.sourceTexture}applyEffect(e,t){if(this.resolution=e,this.parameters=t,t.hasOwnProperty("presetID")&&this.__filters.hasOwnProperty(t.presetID)){this.currentPresetID=t.presetID;let r=this.__filters[this.currentPresetID];t.hasOwnProperty("imageURL")&&(this.effectTexture||(this.effectTexture=BFN.XMLGraphicLoader.getGraphicByName(t.imageURL,512,512))),this.isTileSetup||this.setupTile(),r.textureSampler=this.effectTexture,t.hasOwnProperty("frost_amount")&&(r.frost_amount=t.frost_amount),t.hasOwnProperty("opacity")&&(r.amount=t.opacity),this.filters=[r]}}handleEffectTextureLoaderTextureLoaded(e){BFN.EffectManager.currentEffect==this?BFN.EffectManager.processEffect():this.applyEffect(this.resolution,this.parameters)}setupTile(){let e=PIXI.RenderTexture.create(this.sourceTexture.width,this.sourceTexture.height),t=new PIXI.extras.TilingSprite(this.effectTexture,this.sourceTexture.width,this.sourceTexture.height);BFN.Stage.render(t,e),this.effectTexture!=null&&(this.effectTexture.destroyGC(!0),this.effectTexture=null),this.effectTexture=e,this.isTileSetup=!0}disposeEffect(){this.sourceTexture=null,this.isSetup=!1,this.currentPresetID=null,this.effectTexture!=null&&(this.effectTexture.destroyGC(!0),this.effectTexture=null),this.isTileSetup=!1,this.effectTextureLoader!=null&&(this.effectTextureLoader.removeEventListener(BFN.EffectTextureLoaderEvents.TEXTURE_LOADED.type,this.handleEffectTextureLoaderTextureLoadedBind),this.effectTextureLoader.destroy(),this.effectTextureLoader=null)}};BFN.effects.WinterEffect=new eb;var tb=class extends PIXI.Sprite{constructor(){super();this.initialized=!1}initEffect(){this.sourceTexture=null,this.isSetup=!1,this.currentPresetID=null,this.__filters={};for(let e in BFN.CONST.TILT_SHIFT_PRESETS)this.__filters[BFN.CONST.TILT_SHIFT_PRESETS[e]]=new BFN.filters.TiltShiftFilter(BFN.CONST.TILT_SHIFT_PRESETS[e]);this.blurFilter=new BFN.filters.FastBlurWrapper,this.blurTexture=null,this.blurAmount=null}setupEffect(e){this.initialized||(this.initialized=!0,this.initEffect()),this.disposeEffect(),this.sourceTexture=e,this.isSetup=!0,this.texture=this.sourceTexture}applyEffect(e,t){if(this.resolution=e,this.parameters=t,t.hasOwnProperty("presetID")&&this.__filters.hasOwnProperty(t.presetID)){this.currentPresetID=t.presetID;let r=this.__filters[this.currentPresetID];t.blur_amount!=this.blurAmount&&(this.blurAmount=t.blur_amount,this.blurTexture=this.blurFilter.render(this.blurAmount,this.sourceTexture)),r.blurSampler=this.blurTexture,t.hasOwnProperty("size")&&(r.size=t.size),t.hasOwnProperty("angle")&&(r.angle=t.angle),t.hasOwnProperty("slide_vertical")&&(r.slide_vertical=t.slide_vertical),t.hasOwnProperty("slide_horizontal")&&(r.slide_horizontal=t.slide_horizontal),this.filters=[r]}}disposeTexture(e){this[e]&&this[e]!=null&&(this[e].destroyGC(!0),this[e]=null)}disposeEffect(){this.sourceTexture=null,this.isSetup=!1,this.currentPresetID=null,this.blurFilter.dispose(),this.blurTexture=null,this.blurAmount=null}};BFN.effects.TiltShiftEffect=new tb;var ib=class extends PIXI.Sprite{constructor(){super();this.initialized=!1}initEffect(){this.sourceTexture=null,this.isSetup=!1,this.currentPresetID=null,this.handleEffectTextureLoaderTextureLoadedBind=this.handleEffectTextureLoaderTextureLoaded.bind(this),this.effectTextureLoader=null,this.effectTexture=null,this.tiledDownloadedTexture=null,this.tiledTexture=null,this.__filters={};for(let e in BFN.CONST.PATRIOTIC_PRESETS)this.__filters[BFN.CONST.PATRIOTIC_PRESETS[e]]=new BFN.filters.PatrioticFilter(BFN.CONST.PATRIOTIC_PRESETS[e]);this.blurFilter=new BFN.filters.FastBlurWrapper(null,null,!0),this.sBlurFilter=new BFN.filters.SurfaceBlurFilter,this.adaptiveSharpness=new BFN.filters.AdaptiveSharpnessFilter,this.blurTexture=null,this.blurAmount=null,this.isAdaptiveSetup=!1,this.isTileSetup=!1}setupEffect(e){this.initialized||(this.initialized=!0,this.initEffect()),this.disposeEffect(),this.sourceTexture=e,this.isSetup=!0,this.texture=this.sourceTexture}applyEffect(e,t,r){if(this.resolution=e,this.parameters=t,t.hasOwnProperty("presetID")&&this.__filters.hasOwnProperty(t.presetID)){this.currentPresetID=t.presetID;let a=this.__filters[this.currentPresetID];if(t.hasOwnProperty("imageURL")&&(this.effectTextureLoader||(this.effectTextureLoader=new BFN.EffectTextureLoader,this.effectTextureLoader.addEventListener(BFN.EffectTextureLoaderEvents.TEXTURE_LOADED.type,this.handleEffectTextureLoaderTextureLoadedBind)),!this.effectTexture&&!this.effectTextureLoader.loading&&(r==!0?this.effectTexture=BFN.XMLGraphicLoader.getGraphicByName(t.imageURL,this.sourceTexture.width,this.sourceTexture.height):this.effectTexture=this.effectTextureLoader.getTexture(BFN.originalTextureURl+t.imageURL,this.sourceTexture.width,this.sourceTexture.height))),this.effectTextureLoader!=null&&this.effectTextureLoader.loading){this.filters=[];return}this.effectTextureLoader!=null&&(this.effectTextureLoader.removeEventListener(BFN.EffectTextureLoaderEvents.TEXTURE_LOADED.type,this.handleEffectTextureLoaderTextureLoadedBind),this.effectTextureLoader.destroy(),this.effectTextureLoader=null),t.hasOwnProperty("tileURL")&&(this.tiledDownloadedTexture||(this.tiledDownloadedTexture=BFN.XMLGraphicLoader.getGraphicByName(t.tileURL,256,256))),t.hasOwnProperty("smoothness")&&(t.smoothness!=this.blurAmount&&(this.blurAmount=t.smoothness,this.blurTexture=this.blurFilter.render(this.blurAmount,this.sourceTexture)),a.blurImage=this.blurTexture),this.currentPresetID==BFN.CONST.PATRIOTIC_PRESETS.PRESET_4||this.currentPresetID==BFN.CONST.PATRIOTIC_PRESETS.PRESET_5?(this.isAdaptiveSetup||this.setupAdaptiveSharpnes(),a.adaptiveSharpenSampler=this.blurTexture):this.currentPresetID==BFN.CONST.PATRIOTIC_PRESETS.PRESET_6&&(this.isTileSetup||this.setupTile(),a.starSampler=this.tiledTexture),this.effectTexture!=null&&(a.textureSampler=this.effectTexture),t.hasOwnProperty("silhouette_amount")&&(a.silhouette_amount=t.silhouette_amount),t.hasOwnProperty("color_space")&&(a.color_space=t.color_space),t.hasOwnProperty("halftone_size")&&(a.halftone_size=Math.max(Math.floor(t.halftone_size*Math.max(this.sourceTexture.width,this.sourceTexture.height)/512),3)),t.hasOwnProperty("star_size")&&(a.star_size=t.star_size*Math.max(this.sourceTexture.width,this.sourceTexture.height)/2e3),t.hasOwnProperty("red")&&(a.red=t.red),t.hasOwnProperty("navy")&&(a.navy=t.navy),t.hasOwnProperty("line_color")&&(a.line_width=this.sourceTexture.width/3,a.line_angle=this.sourceTexture.width>this.sourceTexture.height?90:0,a.background_color=t.background_color,a.line_color=t.line_color),this.filters=[a]}}handleEffectTextureLoaderTextureLoaded(e){BFN.EffectManager.currentEffect==this?BFN.EffectManager.processEffect():this.applyEffect(this.resolution,this.parameters)}renderCustomFilter(e,t){let r=PIXI.RenderTexture.create(this.sourceTexture.width,this.sourceTexture.height),a=new PIXI.Sprite(e||this.sourceTexture);return a.filters=t.constructor===Array?t:[t],BFN.Stage.render(a,r),a.filters=[],a=null,r}setupAdaptiveSharpnes(){this.isAdaptiveSetup=!0,this.idealBlur=Math.round(Math.max(this.sourceTexture.width,this.sourceTexture.height))/1024*1,this.sBlurFilter.resolution=.5,this.sBlurFilter.blur=this.idealBlur,this.sBlurFilter.threshold=.3;let e=this.renderCustomFilter(null,this.sBlurFilter);this.adaptiveSharpness.blurImage=e,this.blurTexture=this.renderCustomFilter(null,this.adaptiveSharpness),e.destroyGC(!0),e=null}setupTile(){let e=PIXI.RenderTexture.create(this.sourceTexture.width,this.sourceTexture.height),t=new PIXI.extras.TilingSprite(this.tiledDownloadedTexture,256,256);BFN.Stage.render(t,e),this.disposeTexture("tiledDownloadedTexture"),this.disposeTexture("tiledTexture"),this.tiledTexture=e,this.isTileSetup=!0}disposeTexture(e){this[e]&&this[e]!=null&&(this[e].destroyGC(!0),this[e]=null)}disposeEffect(){(this.currentPresetID==BFN.CONST.PATRIOTIC_PRESETS.PRESET_4||this.currentPresetID==BFN.CONST.PATRIOTIC_PRESETS.PRESET_5)&&this.blurTexture!=null&&this.blurTexture.destroyGC(!0),this.sourceTexture=null,this.isSetup=!1,this.effectTextureLoader!=null&&(this.effectTextureLoader.removeEventListener(BFN.EffectTextureLoaderEvents.TEXTURE_LOADED.type,this.handleEffectTextureLoaderTextureLoadedBind),this.effectTextureLoader.destroy(),this.effectTextureLoader=null),this.currentPresetID=null,this.disposeTexture("effectTexture"),this.disposeTexture("tiledDownloadedTexture"),this.disposeTexture("tiledTexture"),this.blurFilter.dispose(),this.blurTexture=null,this.blurAmount=null,this.isAdaptiveSetup=!1,this.isTileSetup=!1}};BFN.effects.PatrioticEffect=new ib;var rb=class extends PIXI.Sprite{constructor(){super();this.initialized=!1}initEffect(){this.sourceTexture=null,this.isSetup=!1,this.currentPresetID=null,this.handleEffectTextureLoaderTextureLoadedBind=this.handleEffectTextureLoaderTextureLoaded.bind(this),this.effectTextureLoader=null,this.effectTexture=null,this.isTileSetup=!1,this.isHalftoneTileSetup=!1,this.downloadedGradientTexture=null,this.gradientTexture=null,this.__filters={};for(let e in BFN.CONST.POPART_PRESETS)this.__filters[BFN.CONST.POPART_PRESETS[e]]=new BFN.filters.PopArtFilter(BFN.CONST.POPART_PRESETS[e]);this.sBlurFilter=new BFN.filters.FastBlurWrapper(null,null,!0),this.adaptiveSharpness=new BFN.filters.AdaptiveSharpnessFilter,this.adaptiveTexture=null,this.isAdaptiveSetup=!1,this.blurFilter=new BFN.filters.FastBlurWrapper(null,null,!0),this.blurTexture=null,this.blurAmount=null,this.halftoneFilter=new BFN.filters.HalftoneFilter,this.downloadedHalftoneTexture=null,this.halftoneTexture=null,this.halftone_size=null,this.textureHolder=new PIXI.Sprite}setupEffect(e){this.initialized||(this.initialized=!0,this.initEffect()),this.disposeEffect(),this.sourceTexture=e,this.isSetup=!0,this.texture=this.sourceTexture}applyEffect(e,t,r){let a=1;if(r&&(a=.1),this.resolution=e,this.parameters=t,t.hasOwnProperty("presetID")&&this.__filters.hasOwnProperty(t.presetID)){this.currentPresetID=t.presetID;let s=this.__filters[this.currentPresetID];if(t.hasOwnProperty("imageURL")&&(this.effectTextureLoader||(this.effectTextureLoader=new BFN.EffectTextureLoader,this.effectTextureLoader.addEventListener(BFN.EffectTextureLoaderEvents.TEXTURE_LOADED.type,this.handleEffectTextureLoaderTextureLoadedBind)),!this.effectTexture&&!this.effectTextureLoader.loading&&(r==!0?this.effectTexture=BFN.XMLGraphicLoader.getGraphicByName(t.imageURL,this.sourceTexture.width,this.sourceTexture.height):this.effectTexture=this.effectTextureLoader.getTexture(BFN.originalTextureURl+t.imageURL,this.sourceTexture.width,this.sourceTexture.height))),this.effectTextureLoader!=null&&this.effectTextureLoader.loading){this.filters=[];return}if(this.effectTextureLoader!=null&&(this.effectTextureLoader.removeEventListener(BFN.EffectTextureLoaderEvents.TEXTURE_LOADED.type,this.handleEffectTextureLoaderTextureLoadedBind),this.effectTextureLoader.destroy(),this.effectTextureLoader=null),t.hasOwnProperty("gradURL")&&(this.isTileSetup||(this.currentPresetID==BFN.CONST.POPART_PRESETS.PRESET_11?this.downloadedGradientTexture=BFN.XMLGraphicLoader.getGraphicByName(t.gradURL,256,20):this.downloadedGradientTexture=BFN.XMLGraphicLoader.getGraphicByName(t.gradURL,256,3),this.setupTile()),this.gradientTexture!=null&&(s.gradientSampler=this.gradientTexture)),t.hasOwnProperty("halftoneURL")){if(!this.isHalftoneTileSetup){let n=BFN.FilterHelper.getNextPowerOfTwo(100*(1/(100/(Math.min(this.sourceTexture.width,this.sourceTexture.height)/8))));this.downloadedHalftoneTexture=BFN.XMLGraphicLoader.getGraphicByName(t.halftoneURL,n,n),this.setupHalftoneTile()}this.halftoneTexture!=null&&(s.halftoneSampler=this.halftoneTexture)}let o=t.hasOwnProperty("smooth_amount")?t.smooth_amount*a:.3*a;t.hasOwnProperty("isBlur")&&(o!=this.blurAmount&&(this.blurAmount=o,this.blurTexture=this.blurFilter.render(this.blurAmount,this.sourceTexture)),s.blurSampler=this.blurTexture),t.hasOwnProperty("isAdaptive")&&(this.isAdaptiveSetup||this.setupAdaptiveSharpnes(),s.adaptiveSharpenSampler=this.adaptiveTexture),this.effectTexture!=null&&(s.textureSampler=this.effectTexture),t.hasOwnProperty("isGradient")&&(this.gradientTexture||(this.gradientTexture=BFN.FilterHelper.createLinearGradient(t.colors,t.ratios,0,0,this.sourceTexture.width,this.sourceTexture.height,this.sourceTexture.width,this.sourceTexture.height,t.rotation,!0,!0)),s.gradientSampler=this.gradientTexture),t.hasOwnProperty("isHalftone")?(this.halftone_size!=t.halftone_size&&(this.halftone_size=t.halftone_size,this.idealDotSize=Math.max(Math.floor(this.halftone_size*Math.max(this.sourceTexture.width,this.sourceTexture.height)/512),3),this.halftoneFilter.dotSize=this.idealDotSize,this.halftoneFilter.dot_color="0x808080",this.renderCustomFilter(null,"halftoneTexture",this.halftoneFilter)),s.halftoneSampler=this.halftoneTexture):t.hasOwnProperty("halftone_size")&&(s.halftone_size=Math.max(Math.floor(t.halftone_size*Math.max(this.sourceTexture.width,this.sourceTexture.height)/512),3)),t.hasOwnProperty("silhouette_amount")&&(s.silhouette_amount=t.silhouette_amount),t.hasOwnProperty("color_detail")&&(s.color_detail=t.color_detail),t.hasOwnProperty("detail_level")&&(s.detail_level=t.detail_level),t.hasOwnProperty("color_value_1")&&(s.color_value_1=t.color_value_1),t.hasOwnProperty("color_value_2")&&(s.color_value_2=t.color_value_2),t.hasOwnProperty("color_value_3")&&(s.color_value_3=t.color_value_3),t.hasOwnProperty("color_value_4")&&(s.color_value_4=t.color_value_4),this.filters=[s]}}handleEffectTextureLoaderTextureLoaded(e){BFN.EffectManager.currentEffect==this?BFN.EffectManager.processEffect():this.applyEffect(this.resolution,this.parameters)}renderCustomFilter(e,t,r){this[t]==null&&(this[t]=PIXI.RenderTexture.create(this.sourceTexture.width,this.sourceTexture.height)),this.textureHolder.texture=e||this.sourceTexture,this.textureHolder.filters=r.constructor===Array?r:[r],BFN.Stage.render(this.textureHolder,this[t]),this.textureHolder.filters=[],this.textureHolder.texture=null}setupTile(){let e=PIXI.RenderTexture.create(this.sourceTexture.width,this.sourceTexture.height),t=new PIXI.Sprite(this.downloadedGradientTexture);BFN.Stage.render(t,e),this.disposeTexture("downloadedGradientTexture"),this.disposeTexture("gradientTexture"),this.gradientTexture=e,this.isTileSetup=!0}setupHalftoneTile(){this.halftoneTexture==null&&(this.halftoneTexture=PIXI.RenderTexture.create(this.sourceTexture.width,this.sourceTexture.height));let e=new PIXI.extras.TilingSprite(this.downloadedHalftoneTexture,this.sourceTexture.width,this.sourceTexture.height);BFN.Stage.render(e,this.halftoneTexture),this.disposeTexture("downloadedHalftoneTexture"),this.isHalftoneTileSetup=!0}setupAdaptiveSharpnes(){this.isAdaptiveSetup=!0,this.idealBlur=Math.round(Math.max(this.sourceTexture.width,this.sourceTexture.height))/1024*1;let e=this.sBlurFilter.render(.5,this.sourceTexture);this.adaptiveSharpness.intensity=1.5,this.adaptiveSharpness.blurImage=e,this.renderCustomFilter(null,"adaptiveTexture",this.adaptiveSharpness),e=null}disposeTexture(e){this[e]&&this[e]!=null&&(this[e].destroyGC(!0),this[e]=null)}disposeEffect(){this.sourceTexture=null,this.isSetup=!1,this.effectTextureLoader!=null&&(this.effectTextureLoader.removeEventListener(BFN.EffectTextureLoaderEvents.TEXTURE_LOADED.type,this.handleEffectTextureLoaderTextureLoadedBind),this.effectTextureLoader.destroy(),this.effectTextureLoader=null),this.currentPresetID=null,this.disposeTexture("effectTexture"),this.disposeTexture("downloadedGradientTexture"),this.disposeTexture("gradientTexture"),this.disposeTexture("adaptiveTexture"),this.disposeTexture("halftoneTexture"),this.disposeTexture("downloadedHalftoneTexture"),this.blurTexture=null,this.blurFilter.dispose(),this.sBlurFilter.dispose(),this.halftone_size=null,this.isTileSetup=!1,this.isHalftoneTileSetup=!1,this.isAdaptiveSetup=!1,this.blurAmount=null}};BFN.effects.PopArtEffect=new rb;var ab=class extends PIXI.Sprite{constructor(){super();this.initialized=!1}initEffect(){this.sourceTexture=null,this.isSetup=!1,this.tintFilter=new BFN.filters.TintDuoFilter}setupEffect(e){this.initialized||(this.initialized=!0,this.initEffect()),this.disposeEffect(),this.sourceTexture=e,this.isSetup=!0,this.texture=this.sourceTexture}applyEffect(e,t){if(this.resolution=e,this.parameters=t,t.hasOwnProperty("color_1")&&t.hasOwnProperty("color_2")){this.tintFilter.color1=t.color_1,this.tintFilter.color2=t.color_2,this.tintFilter.amount=t.opacity,this.filters=[this.tintFilter];return}this.filters=[]}disposeEffect(){this.sourceTexture=null,this.isSetup=!1}};BFN.effects.TintEffect=new ab;var sb=class extends PIXI.Sprite{constructor(){super();this.initialized=!1}initEffect(){this.sourceTexture=null,this.isSetup=!1,this.blurFilter=new BFN.filters.FastBlurWrapper,this.beautifyFilter=BFN.ShaderPool.BeautifyFilter,this.pluginName="filter_renderer",this.blurTexture=null}setupEffect(e){this.initialized||(this.initialized=!0,this.initEffect()),this.disposeEffect(),this.sourceTexture=e,this.isSetup=!0,this.texture=this.sourceTexture,this.blurTexture=this.blurFilter.render(.5,this.sourceTexture),this.beautifyFilter.blurImage=this.blurTexture}applyEffect(e,t){if(this.resolution=e,this.parameters=t,t.hasOwnProperty("beautify_amount")){this.beautifyFilter.amount=t.beautify_amount,this.bfn_shaders=[this.beautifyFilter];return}this.bfn_shaders=[],this.filters=[]}disposeEffect(){this.sourceTexture=null,this.isSetup=!1,this.blurTexture&&(this.blurTexture=null),this.blurFilter.dispose()}};BFN.effects.BeautifyEffect=new sb;var ob=class extends PIXI.Sprite{constructor(){super();this.initialized=!1}initEffect(){this.sourceTexture=null,this.isSetup=!1,this.currentPresetID=null,this.handleEffectTextureLoaderTextureLoadedBind=this.handleEffectTextureLoaderTextureLoaded.bind(this),this.effectTextureLoader=null,this.effectTexture=null,this.__filters={};for(let e in BFN.CONST.MOTION_COLOR_PRESETS)this.__filters[BFN.CONST.MOTION_COLOR_PRESETS[e]]=new BFN.filters.MotionColorFilter(BFN.CONST.MOTION_COLOR_PRESETS[e]);this.bwMode3=new BFN.filters.BlackWhiteFilter(BFN.CONST.BLACK_WHITE_PRESETS.PRESET_4),this.exposureFilter=new PIXI.filters.ColorMatrixFilter,this.blurFilter=new BFN.filters.FastBlurWrapper(null,null,!0,"x"),this.blurTexture=null,this.blurAmount=null,this.textureHolder=new PIXI.Sprite}setupEffect(e){this.initialized||(this.initialized=!0,this.initEffect()),this.disposeEffect(),this.sourceTexture=e,this.isSetup=!0,this.texture=this.sourceTexture}applyEffect(e,t,r){if(this.resolution=e,this.parameters=t,t.hasOwnProperty("presetID")&&this.__filters.hasOwnProperty(t.presetID)){this.currentPresetID=t.presetID;let a=this.__filters[this.currentPresetID];if(t.hasOwnProperty("imageURL")&&(this.effectTextureLoader||(this.effectTextureLoader=new BFN.EffectTextureLoader,this.effectTextureLoader.addEventListener(BFN.EffectTextureLoaderEvents.TEXTURE_LOADED.type,this.handleEffectTextureLoaderTextureLoadedBind)),!this.effectTexture&&!this.effectTextureLoader.loading&&(r==!0?this.effectTexture=BFN.XMLGraphicLoader.getGraphicByName(t.imageURL,this.sourceTexture.width,this.sourceTexture.height):this.effectTexture=this.effectTextureLoader.getTexture(BFN.originalTextureURl+t.imageURL,this.sourceTexture.width,this.sourceTexture.height))),this.effectTextureLoader!=null&&this.effectTextureLoader.loading){this.filters=[];return}this.effectTextureLoader!=null&&(this.effectTextureLoader.removeEventListener(BFN.EffectTextureLoaderEvents.TEXTURE_LOADED.type,this.handleEffectTextureLoaderTextureLoadedBind),this.effectTextureLoader.destroy(),this.effectTextureLoader=null),this.blurTexture==null&&(this.blurAmount=1,this.exposureFilter.brightness(1,!1),this.exposureFilter.contrast(1.4,!0),this.blurTexture=this.blurFilter.render(this.blurAmount,this.sourceTexture)),a.blurSampler=this.blurTexture,this.effectTexture!=null&&(a.textureSampler=this.effectTexture),t.hasOwnProperty("vignette_amount")&&(a.vignette_amount=t.vignette_amount),this.filters=[a]}}handleEffectTextureLoaderTextureLoaded(e){BFN.EffectManager.currentEffect==this?BFN.EffectManager.processEffect():this.applyEffect(this.resolution,this.parameters)}renderCustomFilter(e,t,r){this[t]==null&&(this[t]=PIXI.RenderTexture.create(this.sourceTexture.width,this.sourceTexture.height)),this.textureHolder.texture=e||this.sourceTexture,this.textureHolder.filters=r.constructor===Array?r:[r],BFN.Stage.render(this.textureHolder,this[t]),this.textureHolder.filters=[],this.textureHolder.texture=null}disposeTexture(e){this[e]&&this[e]!=null&&(this[e].destroyGC(!0),this[e]=null)}disposeEffect(){this.sourceTexture=null,this.isSetup=!1,this.effectTextureLoader!=null&&(this.effectTextureLoader.removeEventListener(BFN.EffectTextureLoaderEvents.TEXTURE_LOADED.type,this.handleEffectTextureLoaderTextureLoadedBind),this.effectTextureLoader.destroy(),this.effectTextureLoader=null),this.currentPresetID=null,this.disposeTexture("effectTexture"),this.blurTexture=null,this.blurFilter.dispose()}};BFN.effects.MotionColorEffect=new ob;var nb=class extends PIXI.Sprite{constructor(){super();this.initialized=!1}initEffect(){this.sourceTexture=null,this.isSetup=!1,this.currentPresetID=null,this.handleEffectTextureLoaderTextureLoadedBind=this.handleEffectTextureLoaderTextureLoaded.bind(this),this.effectTextureLoader=null,this.effectTexture=null,this.downloadedGradientTexture=null,this.gradientTexture=null,this.isTileSetup=!1,this.__filters={};for(let e in BFN.CONST.LOMO_ART_PRESETS)this.__filters[BFN.CONST.LOMO_ART_PRESETS[e]]=new BFN.filters.LomoArtFilter(BFN.CONST.LOMO_ART_PRESETS[e]);this.exposureFilter=new BFN.filters.HSFilter,this.blurFilter=new BFN.filters.FastBlurWrapper(null,null,!0),this.blurTexture=null,this.blurAmount=null,this.textureHolder=new PIXI.Sprite}setupEffect(e){this.initialized||(this.initialized=!0,this.initEffect()),this.disposeEffect(),this.sourceTexture=e,this.isSetup=!0,this.texture=this.sourceTexture}applyEffect(e,t,r){if(this.resolution=e,this.parameters=t,t.hasOwnProperty("presetID")&&this.__filters.hasOwnProperty(t.presetID)){this.currentPresetID=t.presetID;let a=this.__filters[this.currentPresetID];if(t.hasOwnProperty("imageURL")&&(this.effectTextureLoader||(this.effectTextureLoader=new BFN.EffectTextureLoader,this.effectTextureLoader.addEventListener(BFN.EffectTextureLoaderEvents.TEXTURE_LOADED.type,this.handleEffectTextureLoaderTextureLoadedBind)),!this.effectTexture&&!this.effectTextureLoader.loading&&(r==!0?this.effectTexture=BFN.XMLGraphicLoader.getGraphicByName(t.imageURL,this.sourceTexture.width,this.sourceTexture.height):this.effectTexture=this.effectTextureLoader.getTexture(BFN.originalTextureURl+t.imageURL,this.sourceTexture.width,this.sourceTexture.height))),this.effectTextureLoader!=null&&this.effectTextureLoader.loading){this.filters=[];return}this.effectTextureLoader!=null&&(this.effectTextureLoader.removeEventListener(BFN.EffectTextureLoaderEvents.TEXTURE_LOADED.type,this.handleEffectTextureLoaderTextureLoadedBind),this.effectTextureLoader.destroy(),this.effectTextureLoader=null),t.hasOwnProperty("gradURL")&&(this.isTileSetup||(this.downloadedGradientTexture=BFN.XMLGraphicLoader.getGraphicByName(t.gradURL,256,5),this.setupTile()),this.gradientTexture!=null&&(a.gradientSampler=this.gradientTexture)),this.blurTexture==null&&(this.blurAmount=1,this.blurTexture=this.blurFilter.render(this.blurAmount,this.sourceTexture)),a.blurSampler=this.blurTexture,this.effectTexture!=null&&(a.textureSampler=this.effectTexture),t.hasOwnProperty("vignette_amount")&&(a.vignette_amount=t.vignette_amount),t.hasOwnProperty("border_color")&&(a.border_color=t.border_color),t.hasOwnProperty("border_thickness")&&(a.border_thickness=Math.floor(t.border_thickness*Math.max(this.sourceTexture.width,this.sourceTexture.height)/1024)),t.highlights!=0||t.shadows!=0?(this.exposureFilter.highlights=t.highlights,this.exposureFilter.shadows=t.shadows,this.filters=[this.exposureFilter,a]):this.filters=[a]}}handleEffectTextureLoaderTextureLoaded(e){BFN.EffectManager.currentEffect==this?BFN.EffectManager.processEffect():this.applyEffect(this.resolution,this.parameters)}renderCustomFilter(e,t,r){this[t]==null&&(this[t]=PIXI.RenderTexture.create(this.sourceTexture.width,this.sourceTexture.height)),this.textureHolder.texture=e||this.sourceTexture,this.textureHolder.filters=r.constructor===Array?r:[r],BFN.Stage.render(this.textureHolder,this[t]),this.textureHolder.filters=[],this.textureHolder.texture=null}setupTile(){let e=PIXI.RenderTexture.create(this.sourceTexture.width,this.sourceTexture.height),t=new PIXI.Sprite(this.downloadedGradientTexture);BFN.Stage.render(t,e),this.disposeTexture("downloadedGradientTexture"),this.disposeTexture("gradientTexture"),this.gradientTexture=e,this.isTileSetup=!0}disposeTexture(e){this[e]&&this[e]!=null&&(this[e].destroyGC(!0),this[e]=null)}disposeEffect(){this.sourceTexture=null,this.isSetup=!1,this.effectTextureLoader!=null&&(this.effectTextureLoader.removeEventListener(BFN.EffectTextureLoaderEvents.TEXTURE_LOADED.type,this.handleEffectTextureLoaderTextureLoadedBind),this.effectTextureLoader.destroy(),this.effectTextureLoader=null),this.currentPresetID=null,this.disposeTexture("effectTexture"),this.disposeTexture("downloadedGradientTexture"),this.disposeTexture("gradientTexture"),this.isTileSetup=!1,this.blurTexture=null,this.blurFilter.dispose()}};BFN.effects.LomoArtEffect=new nb;var lb=class extends PIXI.Sprite{constructor(){super();this.initialized=!1}initEffect(){this.sourceTexture=null,this.isSetup=!1,this.currentPresetID=null,this.__filters={};for(let e in BFN.CONST.TOUCH_UP_PRESETS)this.__filters[BFN.CONST.TOUCH_UP_PRESETS[e]]=new BFN.filters.TouchUpFilter(BFN.CONST.TOUCH_UP_PRESETS[e]);this.blurFilter=new BFN.filters.FastBlurWrapper(null,null,!0),this.blurFilter2=new BFN.filters.FastBlurWrapper(null,null,!0),this.blurTexture=null,this.blurTexture2=null,this.blurAmount=null,this.curvesTexture=null,this.scFilter=new BFN.filters.SkinCandidateFilter,this.averageColor=null}setupEffect(e){this.initialized||(this.initialized=!0,this.initEffect()),this.disposeEffect(),this.sourceTexture=e,this.isSetup=!0,this.texture=this.sourceTexture}applyEffect(e,t,r){if(this.resolution=e,this.parameters=t,t.hasOwnProperty("presetID")&&this.__filters.hasOwnProperty(t.presetID)){this.currentPresetID=t.presetID;let a=this.__filters[this.currentPresetID];t.hasOwnProperty("isBlur")&&t.isBlur==!0&&(this.blurTexture==null&&(this.blurAmount=this.currentPresetID==BFN.CONST.TOUCH_UP_PRESETS.wrinkles?.25:.4,this.blurTexture=this.blurFilter.render(this.blurAmount,this.sourceTexture)),a.blurSampler=this.blurTexture),t.hasOwnProperty("isBlur2")&&t.isBlur2==!0&&(this.blurTexture2==null&&(this.blurTexture2=this.blurFilter2.render(.07,this.sourceTexture,null,!0)),a.blurSampler2=this.blurTexture2),t.hasOwnProperty("curves")&&(this.curvesTexture==null&&this.setupCurves(BFN.CONST.PALETTE_MAPS[t.curves],t),a.curvesSampler=this.curvesTexture),this.averageColor==null&&this.setupSkinCandidate(),t.hasOwnProperty("strength")&&(a.strength=t.strength),t.hasOwnProperty("color_palette")&&(a.color_palette=t.color_palette),a.averageColor=this.averageColor,this.filters=[a]}}setupCurves(e,t){let r=e.length==3?BFN.FilterHelper.GetCurvesTexture(e[0],e[1],e[2]):e.length==2?BFN.FilterHelper.GetCurvesTexture(e[0],e[1]):BFN.FilterHelper.GetCurvesTexture(e);this.curvesTexture||(this.curvesTexture=PIXI.RenderTexture.create(this.sourceTexture.width,this.sourceTexture.height));let a=new PIXI.Sprite;a.texture=r,BFN.Stage.render(a,this.curvesTexture),r.destroyGC(!0),r=null;try{a.texture.destroyGC(!0)}catch(s){}a=null,this.isSetupCurves=!0}setupSkinCandidate(){let e=Math.min(1,600/this.sourceTexture.width,600/this.sourceTexture.height),t=PIXI.RenderTexture.create(Math.floor(this.sourceTexture.width*e),Math.floor(this.sourceTexture.height*e)),r=new PIXI.Sprite;r.scale.x=e,r.scale.y=e,r.texture=this.sourceTexture,r.filters=[this.scFilter],BFN.Stage.render(r,t),this.averageColor=BFN.Util.getTextureAverageColor(t,!1,!0),t.destroyGC(!0),t=null,r.texture=null,r=null}disposeTexture(e){this[e]&&this[e]!=null&&(this[e].destroyGC(!0),this[e]=null)}disposeEffect(){this.sourceTexture=null,this.isSetup=!1,this.effectTextureLoader!=null&&(this.effectTextureLoader.removeEventListener(BFN.EffectTextureLoaderEvents.TEXTURE_LOADED.type,this.handleEffectTextureLoaderTextureLoadedBind),this.effectTextureLoader.destroy(),this.effectTextureLoader=null),this.currentPresetID=null,this.disposeTexture("curvesTexture"),this.averageColor=null,this.blurTexture=null,this.blurFilter.dispose(),this.blurTexture2=null,this.blurFilter2.dispose()}};BFN.effects.TouchUpEffect=new lb;var cb=class extends PIXI.Sprite{constructor(){super();this.initialized=!1}initEffect(){this.sourceTexture=null,this.isSetup=!1,this.uiControls=new Array,this.colorMixerFilter=BFN.ShaderPool.ColorMixerFilter,this.pluginName="filter_renderer"}setupEffect(e){this.initialized||(this.initialized=!0,this.initEffect()),this.disposeEffect(),this.sourceTexture=e,this.isSetup=!0,this.texture=this.sourceTexture}applyEffect(e,t){this.colorMixerFilter.red=t.red,this.colorMixerFilter.green=t.green,this.colorMixerFilter.blue=t.blue,this.colorMixerFilter.bw=t.bw?1:0,this.bfn_shaders=[this.colorMixerFilter]}disposeEffect(){this.sourceTexture=null,this.isSetup=!1,this.texture=PIXI.Texture.EMPTY,this.filters=null}};BFN.effects.ColorMixerEffect=new cb;var hb=class extends PIXI.Sprite{constructor(){super();this.initialized=!1}initEffect(){this.sourceTexture=null,this.isSetup=!1,this.uiControls=new Array,this.blurFilter=new BFN.filters.FastBlurWrapper(null,null,!0),this.softenFilter=new BFN.filters.SoftenFilter,this.blurTexture=null}setupEffect(e){this.initialized||(this.initialized=!0,this.initEffect()),this.disposeEffect(),this.sourceTexture=e,this.isSetup=!0,this.texture=this.sourceTexture,this.blurTexture=null,this.currentSoftness=null}applyEffect(e,t){this.softenFilter.lightness=t.lightness,this.currentSoftness!=t.softness&&(this.blurTexture=this.blurFilter.render(t.softness/200,this.sourceTexture),this.currentSoftness=t.softness),this.softenFilter.blurImage=this.blurTexture,this.filters=[this.softenFilter]}disposeEffect(){this.sourceTexture=null,this.isSetup=!1,this.blurTexture&&(this.blurTexture=null),this.currentSoftness=null,this.blurFilter.dispose()}};BFN.effects.SoftenEffect=new hb;var ub=class extends PIXI.Sprite{constructor(){super();this.initialized=!1}initEffect(){this.sourceTexture=null,this.isSetup=!1,this.uiControls=new Array,this.blurFilter=new BFN.filters.FastBlurWrapper(null,null,!0),this.smoothingFilter=new BFN.filters.SmoothingFilter,this.blurTexture=null}setupEffect(e){this.initialized||(this.initialized=!0,this.initEffect()),this.disposeEffect(),this.sourceTexture=e,this.isSetup=!0,this.texture=this.sourceTexture,this.blurTexture=this.blurFilter.render(.9,this.sourceTexture),this.smoothingFilter.blurImage=this.blurTexture}applyEffect(e,t){this.smoothingFilter.amount=t.smoothing_amount/100,this.filters=[this.smoothingFilter]}disposeEffect(){this.sourceTexture=null,this.isSetup=!1,this.blurTexture&&(this.blurTexture=null),this.blurFilter.dispose()}};BFN.effects.SmoothingEffect=new ub;var db=class extends PIXI.Sprite{constructor(){super();this.initialized=!1}initEffect(){this.sourceTexture=null,this.isSetup=!1,this.uiControls=new Array,this.blurFilter=new BFN.filters.FastBlurWrapper(null,null,!0),this.blurEdgesFilter=new BFN.filters.BlurEdgesFilter,this.blurTexture=null}setupEffect(e){this.initialized||(this.initialized=!0,this.initEffect()),this.disposeEffect(),this.sourceTexture=e,this.isSetup=!0,this.texture=this.sourceTexture,this.blurTexture=null,this.currentBlurAmount=null}applyEffect(e,t){this.blurEdgesFilter.size=t.edge_size,this.blurEdgesFilter.shift_vertical=t.shift_vertical,this.blurEdgesFilter.shift_horizontal=t.shift_horizontal,this.currentBlurAmount!=t.blur_amount&&(this.blurTexture=this.blurFilter.render(t.blur_amount/100,this.sourceTexture),this.currentBlurAmount=t.blur_amount),this.blurEdgesFilter.blurImage=this.blurTexture,this.filters=[this.blurEdgesFilter]}disposeEffect(){this.sourceTexture=null,this.isSetup=!1,this.blurTexture&&(this.blurTexture=null),this.currentBlurAmount=null,this.blurFilter.dispose()}};BFN.effects.BlurEdgesEffect=new db;var mb=class extends PIXI.Sprite{constructor(){super();this.initialized=!1}initEffect(){this.sourceTexture=null,this.isSetup=!1,this.blurFilter=new BFN.filters.FastBlurWrapper(null,null,!0),this.blurTexture=null,this.bwFilter=new BFN.filters.BlackWhiteFilter(BFN.CONST.BLACK_WHITE_PRESETS.PRESET_4),this.averageColor=null,this.aeFilter=new BFN.filters.AutoEnhanceFilter,this.aeTexture=null,this._filter=new BFN.filters.AlphaBlendFilter}setupEffect(e){this.initialized||(this.initialized=!0,this.initEffect()),this.disposeEffect(),this.sourceTexture=e,this.isSetup=!0,this.texture=this.sourceTexture}applyEffect(e,t,r){if(this.resolution=e,this.parameters=t,this.blurTexture==null&&(this.blurAmount=.25,this.blurTexture=this.blurFilter.render(this.blurAmount,this.sourceTexture)),this.averageColor==null){this.setupAverageColor(),this.aeFilter.blurSampler=this.blurTexture,this.aeFilter.averageColor=this.averageColor,this.aeTexture=PIXI.RenderTexture.create(this.sourceTexture.width,this.sourceTexture.height);let a=new PIXI.Sprite;a.texture=this.sourceTexture,a.filters=[this.aeFilter],BFN.Stage.render(a,this.aeTexture),a.texture=null,a=null}this._filter.intensity=t.intensity/100,this._filter.topImage=this.aeTexture,this.filters=[this._filter]}setupAverageColor(){let e=Math.min(1,512/this.sourceTexture.width,512/this.sourceTexture.height),t=PIXI.RenderTexture.create(Math.floor(this.sourceTexture.width*e),Math.floor(this.sourceTexture.height*e)),r=new PIXI.Sprite;r.scale.x=e,r.scale.y=e,r.texture=this.sourceTexture,r.filters=[this.bwFilter],BFN.Stage.render(r,t),this.averageColor=BFN.Util.getTextureAverageColor(t,!1,!0,!0,!0),t.destroyGC(!0),t=null,r.texture=null,r=null}disposeTexture(e){this[e]&&this[e]!=null&&(this[e].destroyGC(!0),this[e]=null)}disposeEffect(){this.sourceTexture=null,this.isSetup=!1,this.disposeTexture("aeTexture"),this.averageColor=null,this.blurTexture=null,this.blurFilter.dispose()}};BFN.effects.AutoEnhanceEffect=new mb;var pb=class extends PIXI.Sprite{constructor(){super();this.initialized=!1}initEffect(){this.sourceTexture=null,this.isSetup=!1,this.uiControls=new Array,this.helperSize=1024,this.helperSprite=new PIXI.Sprite,this.glowSize=0,this.glintSize=0,this.tolerance=0,this.saturation=0,this.tintColor=-1,this.intensityMode="normal",this.applied=!1,this.overlayContainer=new PIXI.Container,this.addChild(this.overlayContainer),this.overlaySprite=new PIXI.Sprite,this.overlayContainer.addChild(this.overlaySprite),this.overlaySpriteX=new PIXI.Sprite,this.overlayContainer.addChild(this.overlaySpriteX),this.overlaySpriteY=new PIXI.Sprite,this.overlayContainer.addChild(this.overlaySpriteY),this.glowPrepFilter=new BFN.filters.GlowPrepFilter,this.glowPostFilter=new BFN.filters.GlowPostFilter,this.glowBlurFilter=new BFN.filters.GaussianBlurFilter,this.glintBlurFilter=new BFN.filters.GaussianBlurFilter}setupEffect(e){this.initialized||(this.initialized=!0,this.initEffect()),this.disposeEffect(),this.sourceTexture=e,this.isSetup=!0,this.helperTexture||(this.helperTexture=PIXI.RenderTexture.create(this.helperSize,this.helperSize),this.helperTexture.fillColor(0)),this.overlayTexture||(this.overlayTexture=this.helperTexture.renderClone(),this.overlaySprite.texture=this.overlayTexture),this.overlayTextureX||(this.overlayTextureX=this.helperTexture.renderClone(),this.overlaySpriteX.texture=this.overlayTextureX),this.overlayTextureY||(this.overlayTextureY=this.helperTexture.renderClone(),this.overlaySpriteY.texture=this.overlayTextureY);let t=Math.atan2(this.sourceTexture.height,this.sourceTexture.width)-Math.PI/4,r=Math.sqrt(Math.pow(this.sourceTexture.width,2)+Math.pow(this.sourceTexture.height,2)),a=Math.max(Math.cos(t)*r,Math.sin(t)*r),s=this.helperSize/a;this.helperSprite=new PIXI.Sprite(this.sourceTexture),this.helperSprite.rotation=-(Math.PI/4),this.helperSprite.scale.x=this.helperSprite.scale.y=s,this.helperSprite.y=this.helperSize+Math.sin(this.helperSprite.rotation)*this.sourceTexture.height*s,this.helperSprite.filters=[],BFN.Stage.render(this.helperSprite,this.helperTexture,!1),this.helperSprite.texture=this.helperTexture,this.helperSprite.filters=[this.glowPrepFilter,this.glowBlurFilter],this.overlaySprite.anchor.y=this.helperSprite.y/this.helperSize,this.overlaySprite.rotation=Math.PI/4,this.overlaySprite.scale.x=this.overlaySprite.scale.y=1/s,this.overlaySpriteX.anchor.y=this.helperSprite.y/this.helperSize,this.overlaySpriteX.rotation=Math.PI/4,this.overlaySpriteX.scale.x=this.overlaySpriteX.scale.y=1/s,this.overlaySpriteY.anchor.y=this.helperSprite.y/this.helperSize,this.overlaySpriteY.rotation=Math.PI/4,this.overlaySpriteY.scale.x=this.overlaySpriteY.scale.y=1/s,this.helperSprite.rotation=0,this.helperSprite.scale.x=this.helperSprite.scale.y=1,this.helperSprite.y=0,this.texture=this.sourceTexture}applyEffect(e,t){let r=t.intensity_mode;(this.intensityMode!=r||!this.applied)&&(this.intensityMode=r,this.overlaySprite.blendMode=r=="intense"?PIXI.BLEND_MODES.ADD:PIXI.BLEND_MODES.SCREEN,this.overlaySpriteX.blendMode=r=="intense"?PIXI.BLEND_MODES.ADD:PIXI.BLEND_MODES.SCREEN,this.overlaySpriteY.blendMode=r=="intense"?PIXI.BLEND_MODES.ADD:PIXI.BLEND_MODES.SCREEN);let a=100-t.tolerance,s=t.saturation,o=t.tint_color;(this.tolerance!=a||this.saturation!=s||this.tintColor!=o||!this.applied)&&(this.tolerance=a,this.saturation=s,this.tintColor=o,this.glowPrepFilter.minInput=(a-50)/50*.15+.8,this.glowPrepFilter.maxInput=this.glowPrepFilter.minInput+.05,this.glowPrepFilter.saturation=0,this.glowPrepFilter.tint=o,this.applied=!1);let n=t.glow_size/100;this.overlaySprite.visible=t.glow_size>0,this.overlaySprite.alpha=(n+Math.sin(n*(Math.PI/2)))/2,n>0&&(this.glowSize!=n||!this.applied)&&(this.glowSize=n,this.helperSprite.filters=[this.glowPrepFilter,this.glowPostFilter,this.glowBlurFilter],this.glowBlurFilter.setInputDimensions(this.helperTexture.width,this.helperTexture.height),this.glowBlurFilter.blur=n,this.glowBlurFilter.oneDirection=null,BFN.Stage.render(this.helperSprite,this.overlayTexture));let l=t.glint_size/100;this.overlaySpriteX.visible=this.overlaySpriteY.visible=t.glint_size>0,this.overlaySpriteX.alpha=this.overlaySpriteY.alpha=(l+Math.sin(l*(Math.PI/2)))/2,l>0&&(this.glintSize!=l||!this.applied)&&(this.glintSize=l,this.helperSprite.filters=[this.glowPrepFilter,this.glowPostFilter,this.glintBlurFilter],this.glintBlurFilter.setInputDimensions(this.helperTexture.width,this.helperTexture.height),this.glintBlurFilter.blur=l,this.glintBlurFilter.oneDirection="x",BFN.Stage.render(this.helperSprite,this.overlayTextureX),this.glintBlurFilter.oneDirection="y",BFN.Stage.render(this.helperSprite,this.overlayTextureY)),this.overlayContainer.alpha=t.intensity/100,this.applied=!0}disposeEffect(){this.sourceTexture=null,this.isSetup=!1,this.glowSize=0,this.glintSize=0,this.tolerance=0,this.saturation=0,this.tintColor=-1,this.intensityMode="normal",this.applied=!1,this.helperSprite.filters=[],this.helperTexture&&(this.helperTexture.destroyGC(!0),delete this.helperTexture),this.overlayTextureX&&(this.overlayTextureX.destroyGC(!0),delete this.overlayTextureX),this.overlaySpriteX.texture=PIXI.Texture.EMPTY,this.overlayTextureY&&(this.overlayTextureY.destroyGC(!0),delete this.overlayTextureY),this.overlaySpriteY.texture=PIXI.Texture.EMPTY,this.texture=PIXI.Texture.EMPTY,this.filters=null}};BFN.effects.GlowEffect=new pb;function zr(){PIXI.Sprite.call(this),this.initialized=!1}zr.prototype=Object.create(PIXI.Sprite.prototype);zr.prototype.initEffect=function(){this.sourceTexture=null,this.isSetup=!1,this.uiControls=[],this.useVariations=!0,this.bokehBlurFilter=null,this.bokehBlurFilterFull=null,this.bokehPass=0,this.bokehPasses=0,this.delaying=!1,this.validBokehBladeCounts=[3,4,5,6,7,8,9],this.primeBokehBlurFilters={},this.filterSprite=new PIXI.Sprite,this.plainFilter=null,this.bokehBGBlurFilter=null,this.bokehGentleBlurFilter=null,this.bgBlurApplied=!1,this.gentleBlurApplied=!1,this.bokehBlurApplied=!1,this.emptyTexture=PIXI.RenderTexture.create(2,2),this.emptyTexture.clear(),this.handleImagePainterPaintUpdatedBind=this.handleImagePainterPaintUpdated.bind(this)};zr.prototype.setupEffect=function(i){this.initialized||(this.initialized=!0,this.initEffect()),this.disposeEffect(),this.sourceTexture=i,this.isSetup=!0,this.texture=this.sourceTexture,this.countdown=0};zr.prototype.applyEffect=function(i,e){this.resolution=i,this.parameters=e;let t=parseInt(e.hasOwnProperty("blade_count")?e.blade_count:6);if(!this.validBokehBladeCounts.includes(t)&&!this.sourceTexture||this.delaying)return;let r=(l=!0,c=5)=>{l&&(this.countdown=c),this.delaying=!0,BFN.EffectManager.manageLoadScreen=!1,BeFunky.showLoadScreen(),requestAnimationFrame(()=>{--this.countdown>0?r(!1):(this.delaying=!1,BeFunky.hideLoadScreen(),BFN.EffectManager.manageLoadScreen=!0,BFN.EffectManager.currentEffect==this&&BFN.EffectManager.processEffect())})};if(!this.texturesBuilt){this.texturesBuilt=!0;let l=Math.max(this.sourceTexture.width,this.sourceTexture.height);this.bokehScaleFactor=1024/l,this.bokehSourceW=Math.round(this.sourceTexture.width*this.bokehScaleFactor),this.bokehSourceH=Math.round(this.sourceTexture.height*this.bokehScaleFactor),this.bokehSourceTexture=PIXI.RenderTexture.create(this.bokehSourceW,this.bokehSourceH),this.bokehSourceTexture.copyPixels(this.sourceTexture,null,null,null,{x:this.bokehSourceW/this.sourceTexture.width,y:this.bokehSourceH/this.sourceTexture.height}),this.bokehSourceSprite=new PIXI.Sprite(this.bokehSourceTexture),this.bgBlurRenderTexture=PIXI.RenderTexture.create(this.bokehSourceW,this.bokehSourceH),this.bgBlurRenderTexture.clear(),this.gentleBlurRenderTexture=PIXI.RenderTexture.create(this.bokehSourceW,this.bokehSourceH),this.gentleBlurRenderTexture.clear(),this.bokehRenderTexture=PIXI.RenderTexture.create(this.bokehSourceW,this.bokehSourceH),this.bokehRenderTexture.clear(),this.bokehEraserTexture=PIXI.RenderTexture.create(this.bokehSourceW,this.bokehSourceH),this.bokehEraserTexture.clear(),this.effectRenderTexture=this.sourceTexture.renderClone(),this.texture=this.effectRenderTexture,r(!0,1);return}let a=!1;if(this.plainFilter?this.bokehBGBlurFilter?this.bokehGentleBlurFilter?!this.useVariations&&!this.bokehBlurFilterFull?(this.bokehBlurFilterFull=new BFN.filters.BokehBlurFilter,a=!0):this.useVariations&&!this.primeBokehBlurFilters.hasOwnProperty(t)&&(this.primeBokehBlurFilters[t]=new BFN.filters.BokehBlurFilter("X"+t),a=!0):(this.bokehGentleBlurFilter=new BFN.filters.BokehGentleBlurFilter,a=!0):(this.bokehBGBlurFilter=new BFN.filters.BokehBGBlurFilter,a=!0):(this.plainFilter=new BFN.filters.PlainFilter,a=!0),a){r();return}let s=()=>{this.bokehBlurFilter.variation===""?(this.bokehPasses=e.hasOwnProperty("passes")?e.passes:1,this.bokehBlurFilter.uniforms.pass1Radius=e.hasOwnProperty("pass1Radius")?e.pass1Radius:1,this.bokehBlurFilter.uniforms.pass1Layers=e.hasOwnProperty("pass1Layers")?e.pass1Layers:1,this.bokehBlurFilter.uniforms.pass2Radius=e.hasOwnProperty("pass2Radius")?e.pass2Radius:50,this.bokehBlurFilter.uniforms.pass2Layers=e.hasOwnProperty("pass2Layers")?e.pass2Layers:4,this.bokehBlurFilter.uniforms.pass3Radius=e.hasOwnProperty("pass3Radius")?e.pass3Radius:20,this.bokehBlurFilter.uniforms.pass3Layers=e.hasOwnProperty("pass3Layers")?e.pass3Layers:3,this.bokehBlurFilter.uniforms.pass4Radius=e.hasOwnProperty("pass4Radius")?e.pass4Radius:8.5,this.bokehBlurFilter.uniforms.pass4Layers=e.hasOwnProperty("pass4Layers")?e.pass4Layers:2):this.bokehPasses=4},o=this.useVariations?this.primeBokehBlurFilters[t]:this.bokehBlurFilterFull;o&&this.bokehBlurFilter!==o?(this.bokehBlurFilter&&this.bokehBlurFilter.maskTexture!==o.emptyTexture&&(this.bokehBlurFilter.maskTexture=this.emptyTexture,this.bokehBGBlurFilter.maskTexture=this.emptyTexture,this.bokehGentleBlurFilter.maskTexture=this.emptyTexture),this.bokehBlurFilter=o,this.bokehEraserTexture&&(this.bokehBlurFilter.maskTexture=this.bokehEraserTexture,this.bokehBGBlurFilter.maskTexture=this.bokehEraserTexture,this.bokehGentleBlurFilter.maskTexture=this.bokehEraserTexture),this.bokehSourceW&&this.bokehSourceH&&(this.bokehBlurFilter.dimensions=[this.bokehSourceW,this.bokehSourceH],this.bokehBGBlurFilter.dimensions=[this.bokehSourceW,this.bokehSourceH],this.bokehGentleBlurFilter.dimensions=[this.bokehSourceW,this.bokehSourceH]),s()):!o&&!this.bokehBlurFilter&&(this.bokehBlurFilter=new BFN.filters.BokehBlurFilter,s()),this.listening||(this.listening=!0,BFN.ImagePainterUndoManager.addEventListener(BFN.ImagePainterUndoManagerEvents.PAINT_UPDATED.type,this.handleImagePainterPaintUpdatedBind),BFN.ImagePainterUndoManager.addEventListener(BFN.ImagePainterUndoManagerEvents.ALT_TEXTURE_UPDATED.type,this.handleImagePainterPaintUpdatedBind),BFN.ImageEffect.addEventListener(BFN.ImageEffectEvents.INVERSE_PAINT.type,this.handleImagePainterPaintUpdatedBind),BFN.ImageEffect.addEventListener(BFN.ImageEffectEvents.CLEAR_PAINT.type,this.handleImagePainterPaintUpdatedBind)),(()=>{let l=e.hasOwnProperty("blur_amount")?e.blur_amount/100:1;if(l>0){if(!this.bgBlurApplied){this.bgBlurApplied=!0,this.filterSprite.texture=this.bokehSourceTexture,this.bokehBGBlurFilter.amount=l,this.bokehBGBlurFilter.maskTextureInverted=BFN.ImageEffect.inverse,this.filterSprite.filters=[this.bokehBGBlurFilter],BFN.Stage.render(this.filterSprite,this.bgBlurRenderTexture),r(!0,1);return}if(!this.gentleBlurApplied){this.gentleBlurApplied=!0,this.filterSprite.texture=this.bokehSourceTexture,this.bokehGentleBlurFilter.mode=1,this.bokehGentleBlurFilter.amount=l,this.bokehGentleBlurFilter.large=!1,this.bokehGentleBlurFilter.bgTexture=this.emptyTexture,this.bokehGentleBlurFilter.threshold=e.hasOwnProperty("bokeh_intensity")?(1-e.bokeh_intensity/100)*18+2:11,this.bokehGentleBlurFilter.intensity=e.hasOwnProperty("bokeh_intensity")?e.bokeh_intensity/100:.5,this.bokehGentleBlurFilter.maskTextureInverted=BFN.ImageEffect.inverse,this.filterSprite.filters=[this.bokehGentleBlurFilter],BFN.Stage.render(this.filterSprite,this.gentleBlurRenderTexture),r(!0,1);return}if(this.bokehBlurApplied||(this.bokehBlurApplied=!0,this.flip=this.gentleBlurRenderTexture,this.flop=this.bokehRenderTexture,this.bokehPass=0,this.bokehBlurFilter.amount=l,this.bokehBlurFilter.aperture=e.hasOwnProperty("blade_curvature")?e.blade_curvature/100:1,this.bokehBlurFilter.bladeCount=e.hasOwnProperty("blade_count")?e.blade_count:6,this.bokehBlurFilter.maskTextureInverted=BFN.ImageEffect.inverse),this.bokehPass<this.bokehPasses){this.filterSprite.texture=this.flip,this.bokehBlurFilter.currentPass=this.bokehPass++,this.filterSprite.filters=[this.bokehBlurFilter],BFN.Stage.render(this.filterSprite,this.flop);let u=this.flop;this.flop=this.flip,this.flip=u,r(!0,1);return}this.bokehGentleBlurFilter.mode=2,this.bokehGentleBlurFilter.large=!0,this.bokehGentleBlurFilter.bgTexture=this.bgBlurRenderTexture,this.filterSprite.texture=this.flip,this.filterSprite.filters=[this.bokehGentleBlurFilter],BFN.Stage.render(this.filterSprite,this.flop);let c=this.flop;this.flop=this.flip,this.flip=c,this.bokehGentleBlurFilter.mode=0,this.bokehGentleBlurFilter.large=!0,this.bokehGentleBlurFilter.bgTexture=this.emptyTexture;let h=2;for(let u=0;u<h;u++){this.filterSprite.texture=this.flip,BFN.Stage.render(this.filterSprite,this.flop);let d=this.flop;this.flop=this.flip,this.flip=d}this.effectRenderTexture.copyPixels(this.flip,null,null,null,{x:this.effectRenderTexture.width/this.bokehSourceW,y:this.effectRenderTexture.height/this.bokehSourceH}),this.bgBlurApplied=!1,this.gentleBlurApplied=!1,this.bokehBlurApplied=!1}else this.effectRenderTexture.copyPixels(this.sourceTexture)})()};zr.prototype.handleImagePainterPaintUpdated=function(i){if(BFN.ImagePainterUndoManager.imagePainter&&BFN.ImagePainterUndoManager.imagePainter.texture&&this.bokehEraserTexture){let e=BFN.ImagePainterUndoManager.imagePainter.texture;this.bokehEraserTexture.copyPixels(e,null,null,null,{x:this.bokehEraserTexture.width/e.width,y:this.bokehEraserTexture.height/e.height}),UITools.applyTool("lens_blur")}};zr.prototype.disposeEffect=function(){this.sourceTexture=null,this.isSetup=!1,this.bokehBlurFilter&&(this.bokehBlurFilter.maskTexture=this.emptyTexture),this.bokehBlurFilter=null;try{this.bokehSourceTexture.destroyGC(!0)}catch(i){}this.bokehSourceTexture=null;try{this.bgBlurRenderTexture.destroyGC(!0)}catch(i){}this.bgBlurRenderTexture=null;try{this.gentleBlurRenderTexture.destroyGC(!0)}catch(i){}this.gentleBlurRenderTexture=null;try{this.bokehRenderTexture.destroyGC(!0)}catch(i){}this.bokehRenderTexture=null,this.flip=null,this.flop=null;try{this.bokehEraserTexture.destroyGC(!0)}catch(i){}this.bokehEraserTexture=null;try{this.effectRenderTexture.destroyGC(!0)}catch(i){}this.effectRenderTexture=null,this.texture=PIXI.Texture.EMPTY;try{this.bokehSourceSprite.filters=[],this.bokehSourceSprite.destroy(!1)}catch(i){}this.bokehSourceSprite=null,this.texturesBuilt=!1,BFN.ImagePainterUndoManager.removeEventListener(BFN.ImagePainterUndoManagerEvents.PAINT_UPDATED.type,this.handleImagePainterPaintUpdatedBind),BFN.ImagePainterUndoManager.removeEventListener(BFN.ImagePainterUndoManagerEvents.ALT_TEXTURE_UPDATED.type,this.handleImagePainterPaintUpdatedBind),BFN.ImageEffect.removeEventListener(BFN.ImageEffectEvents.INVERSE_PAINT.type,this.handleImagePainterPaintUpdatedBind),BFN.ImageEffect.removeEventListener(BFN.ImageEffectEvents.CLEAR_PAINT.type,this.handleImagePainterPaintUpdatedBind),this.listening=!1};BFN.effects.BokehBlurEffect=new zr;function ma(){PIXI.Sprite.call(this),this.initialized=!1}ma.prototype=Object.create(PIXI.Sprite.prototype);ma.prototype.initEffect=function(){this.sourceTexture=null,this.isSetup=!1,this.uiControls=[],this.__filters={};for(let i in BFN.CONST.CINEMATIC_PRESETS)switch(BFN.CONST.CINEMATIC_PRESETS[i]){case BFN.CONST.CINEMATIC_PRESETS.FILM_GRAIN:this.__filters[BFN.CONST.CINEMATIC_PRESETS[i]]=new BFN.filters.GrainFilter;break;case BFN.CONST.CINEMATIC_PRESETS.COLOR_GRADING:this.__filters[BFN.CONST.CINEMATIC_PRESETS[i]]=new BFN.filters.ColorGradingFilter;break;case BFN.CONST.CINEMATIC_PRESETS.ANAMORPHIC:this.__filters[BFN.CONST.CINEMATIC_PRESETS[i]]=new BFN.filters.AnamorphicFilter;break;case BFN.CONST.CINEMATIC_PRESETS.LENS_DISTORTION:this.__filters[BFN.CONST.CINEMATIC_PRESETS[i]]=new BFN.filters.LensDistortionFilter;break;case BFN.CONST.CINEMATIC_PRESETS.WARPED_BLUR:this.__filters[BFN.CONST.CINEMATIC_PRESETS[i]]=new BFN.filters.WarpedBlurFilter;break;case BFN.CONST.CINEMATIC_PRESETS.CHROMATIC_ABERRATION:this.__filters[BFN.CONST.CINEMATIC_PRESETS[i]]=new BFN.filters.ChromaticAberrationFilter;break;case BFN.CONST.CINEMATIC_PRESETS.VOLUME_LIGHT:this.__filters[BFN.CONST.CINEMATIC_PRESETS[i]]=new BFN.filters.VolumeLightFilter;break}this.filmGrainSeed=1,this.effectDelayed=!1};ma.prototype.setupEffect=function(i){this.initialized||(this.initialized=!0,this.initEffect()),this.disposeEffect(),this.sourceTexture=i,this.isSetup=!0,this.texture=this.sourceTexture,this.filmGrainSeed++};ma.prototype.applyEffect=function(i,e,t){if(this.resolution=i,this.parameters=e,e.hasOwnProperty("presetID")&&this.__filters.hasOwnProperty(e.presetID)){this.currentPresetID=e.presetID;let r=this.__filters[this.currentPresetID],a=[r];switch(this.currentPresetID){case BFN.CONST.CINEMATIC_PRESETS.FILM_GRAIN:{r.intensity=e.hasOwnProperty("intensity")?e.intensity/800:.1,r.distribution=4,e.updating_id==="generate"&&this.filmGrainSeed++,r.seed=this.filmGrainSeed,r.monochromatic=e.hasOwnProperty("monochromatic")?e.monochromatic:!1;break}case BFN.CONST.CINEMATIC_PRESETS.COLOR_GRADING:{r.shadowColor=e.hasOwnProperty("shadows")?e.shadows:"000000",r.midtoneColor=e.hasOwnProperty("midtones")?e.midtones:"808080",r.highlightColor=e.hasOwnProperty("highlights")?e.highlights:"FFFFFF",r.shadowIntensity=e.hasOwnProperty("shadows_intensity")?e.shadows_intensity:1,r.midtoneIntensity=e.hasOwnProperty("midtones_intensity")?e.midtones_intensity:1,r.highlightIntensity=e.hasOwnProperty("highlights_intensity")?e.highlights_intensity:1;break}case BFN.CONST.CINEMATIC_PRESETS.ANAMORPHIC:{r.stretch=e.hasOwnProperty("stretch")?e.stretch/100:1,r.distortion=e.hasOwnProperty("distortion")?e.distortion/100:1,r.vignetteOpacity=e.hasOwnProperty("vignette_opacity")?e.vignette_opacity/200:.5,r.edgeBlur=e.hasOwnProperty("edge_blur")?e.edge_blur/100:.5,r.dimensions=[this.sourceTexture.width,this.sourceTexture.height];break}case BFN.CONST.CINEMATIC_PRESETS.LENS_DISTORTION:{r.distortion=e.hasOwnProperty("distortion")?e.distortion/100:.5,r.dimensions=[this.sourceTexture.width,this.sourceTexture.height];break}case BFN.CONST.CINEMATIC_PRESETS.WARPED_BLUR:{r.strength=e.hasOwnProperty("blur_amount")?e.blur_amount/100:1,r.phase=e.hasOwnProperty("phase")?e.phase/10:0,r.scale=e.hasOwnProperty("scale")?e.scale/100:1,r.lightness=e.hasOwnProperty("lightness")?e.lightness/100:0,r.dimensions=[this.sourceTexture.width,this.sourceTexture.height],r.mapDimensions=[BFN.FilterHelper.getNextPowerOfTwo(this.sourceTexture.width),BFN.FilterHelper.getNextPowerOfTwo(this.sourceTexture.height)];break}case BFN.CONST.CINEMATIC_PRESETS.CHROMATIC_ABERRATION:{r.distortion=e.hasOwnProperty("distortion")?e.distortion/100:.5,r.focalPointX=e.hasOwnProperty("focal_point_x")?e.focal_point_x/100:.5,r.focalPointY=e.hasOwnProperty("focal_point_y")?e.focal_point_y/100:.5,r.dimensions=[this.sourceTexture.width,this.sourceTexture.height];break}case BFN.CONST.CINEMATIC_PRESETS.VOLUME_LIGHT:{let s=()=>{r.color=e.hasOwnProperty("color")?e.color:-1,r.colorIntensity=e.hasOwnProperty("color_intensity")?e.color_intensity:1,r.intensity=.5,r.attenuation=1-(Math.pow(e.hasOwnProperty("strength")?e.strength/100:.5,2)*.7+.3),r.spread=.1,r.threshold=1-((e.hasOwnProperty("tolerance")?e.tolerance/100*.8:.4)+.1),r.tolerance=1-Math.pow(1-(e.hasOwnProperty("tolerance")?e.tolerance/100:.5),2),r.focalPointX=e.hasOwnProperty("focal_point_x")?e.focal_point_x/100:.5,r.focalPointY=e.hasOwnProperty("focal_point_y")?e.focal_point_y/100:.5,r.quality=!e.hasOwnProperty("updating")||e.updating?0:1,r.setSourceTexture(this.sourceTexture),r.processFilters()};BFN.EffectManager.useThumbs||e.updating||!BFN.lowPerformanceCanvas||this.effectDelayed?(this.effectDelayed=!1,BFN.EffectManager.manageLoadScreen=!0,s()):(this.effectDelayed=!0,BFN.EffectManager.manageLoadScreen=!1,BeFunky.showLoadScreen(),setTimeout(()=>{requestAnimationFrame(()=>{BFN.EffectManager.currentEffect===this?BFN.EffectManager.processEffect():(this.effectDelayed=!1,BFN.EffectManager.manageLoadScreen=!0,BeFunky.hideLoadScreen())})},250));break}}this.filters=a}};ma.prototype.disposeEffect=function(){switch(this.sourceTexture=null,this.isSetup=!1,this.currentPresetID){case BFN.CONST.CINEMATIC_PRESETS.VOLUME_LIGHT:try{this.__filters[this.currentPresetID].reset()}catch(i){}break}try{this.__filters[this.currentPresetID].dispose()}catch(i){}this.currentPresetID=null};BFN.effects.CinematicEffect=new ma;function pa(){PIXI.Sprite.call(this),this.initialized=!1}pa.prototype=Object.create(PIXI.Sprite.prototype);pa.prototype.initEffect=function(){this.sourceTexture=null,this.isSetup=!1,this.uiControls=[],this.__filters={};for(let i in BFN.CONST.MULTIMEDIA_PRESETS)switch(BFN.CONST.MULTIMEDIA_PRESETS[i]){case BFN.CONST.MULTIMEDIA_PRESETS.SCAN_LINES:this.__filters[BFN.CONST.MULTIMEDIA_PRESETS[i]]=new BFN.filters.ScanLinesFilter;break;case BFN.CONST.MULTIMEDIA_PRESETS.TELEVISION:this.__filters[BFN.CONST.MULTIMEDIA_PRESETS[i]]=new BFN.filters.TelevisionFilter;break;case BFN.CONST.MULTIMEDIA_PRESETS.HALFTONE_DUO:this.__filters[BFN.CONST.MULTIMEDIA_PRESETS[i]]=new BFN.filters.HalftoneDuoFilter;break;case BFN.CONST.MULTIMEDIA_PRESETS.COLOR_BLEED:this.__filters[BFN.CONST.MULTIMEDIA_PRESETS[i]]=new BFN.filters.ColorBleedFilter;break}this.halftoneDuoSrc=null};pa.prototype.setupEffect=function(i){this.initialized||(this.initialized=!0,this.initEffect()),this.disposeEffect(),this.sourceTexture=i,this.isSetup=!0,this.texture=this.sourceTexture;let e=Math.max(1,Math.min(Math.floor(BFN.minImageSize/2),Math.round(this.sourceTexture.height/240)));UITools.setToolValue("cinematic_scan_lines","spacing",e),UITools.updateToolControls("cinematic_scan_lines"),this.halftoneDensity=-1};pa.prototype.applyEffect=function(i,e,t){if(this.resolution=i,this.parameters=e,e.hasOwnProperty("presetID")&&this.__filters.hasOwnProperty(e.presetID)){this.currentPresetID=e.presetID;let r=this.__filters[this.currentPresetID],a=[r];switch(this.currentPresetID){case BFN.CONST.MULTIMEDIA_PRESETS.SCAN_LINES:{r.lineColor=e.hasOwnProperty("line_color")?e.line_color:"000000",r.opacity=e.hasOwnProperty("opacity")?e.opacity/100:.5,r.spacing=e.hasOwnProperty("spacing")?e.spacing:.2,r.invert=e.hasOwnProperty("invert")?e.invert:!1;break}case BFN.CONST.MULTIMEDIA_PRESETS.TELEVISION:{let s=Math.max(2,Math.floor(this.sourceTexture.width/800));r.pixelSize=s,r.dimensions=[this.sourceTexture.width,this.sourceTexture.height];break}case BFN.CONST.MULTIMEDIA_PRESETS.HALFTONE_DUO:{if(this.halftoneDuoSrc||(this.halftoneDuoSrc=PIXI.RenderTexture.create(128,128)),e.hasOwnProperty("density")&&e.density!=this.halftoneDensity){this.halftoneDensity=e.density;let s=(this.halftoneDensity-1)/99,n=(t?75:s*450+50)/Math.max(this.sourceTexture.width,this.sourceTexture.height);this.halftoneDuoSrc.resize(Math.round(this.sourceTexture.width*n),Math.round(this.sourceTexture.height*n)),this.halftoneDuoSrc.copyPixels(this.sourceTexture,null,!0,1,{x:this.halftoneDuoSrc.width/this.sourceTexture.width,y:this.halftoneDuoSrc.height/this.sourceTexture.height}),r.src=this.halftoneDuoSrc,r.srcDimensions=[this.halftoneDuoSrc.width,this.halftoneDuoSrc.height]}r.tolerance=e.hasOwnProperty("tolerance")?e.tolerance/100:.5,r.shadowColor=e.hasOwnProperty("shadow_color")?e.shadow_color:"000000",r.highlightColor=e.hasOwnProperty("highlight_color")?e.highlight_color:"FFFFFF",r.invertColors=e.hasOwnProperty("invert")?e.invert:!1,r.dimensions=[this.sourceTexture.width,this.sourceTexture.height];break}case BFN.CONST.MULTIMEDIA_PRESETS.COLOR_BLEED:{let s=()=>{let o=e.hasOwnProperty("distance")?e.distance/100:.5,n=e.hasOwnProperty("density")?e.density/100:.5,l=e.hasOwnProperty("scatter")?e.scatter/100:.5,c=e.hasOwnProperty("scale")?e.scale/100:.5,h=e.hasOwnProperty("phase")?e.phase/100:.5;r.colorMode=e.hasOwnProperty("color_mode")?e.color_mode:"darken",r.bleed=Math.round(o*50)+25,r.iterations=Math.round(o*20)+10,r.fade=(1-n)*.16,r.noise=.4+l*.6,r.softness=l,r.unsharp=.1+l*.4,r.size=.25+(1-c)*.5,r.phase=(h+.5)%1,r.setSourceTexture(this.sourceTexture),r.processFilters()};BFN.EffectManager.useThumbs||e.updating||!BFN.lowPerformanceCanvas||this.effectDelayed?(this.effectDelayed=!1,BFN.EffectManager.manageLoadScreen=!0,s()):(this.effectDelayed=!0,BFN.EffectManager.manageLoadScreen=!1,BeFunky.showLoadScreen(),setTimeout(()=>{requestAnimationFrame(()=>{BFN.EffectManager.currentEffect===this?BFN.EffectManager.processEffect():(this.effectDelayed=!1,BFN.EffectManager.manageLoadScreen=!0,BeFunky.hideLoadScreen())})},250));break}}this.filters=a}};pa.prototype.disposeEffect=function(){switch(this.sourceTexture=null,this.isSetup=!1,this.currentPresetID){case BFN.CONST.MULTIMEDIA_PRESETS.HALFTONE_DUO:try{this.halftoneDuoSrc.destroyGC(!0)}catch(i){}this.halftoneDuoSrc=null;break;case BFN.CONST.MULTIMEDIA_PRESETS.COLOR_BLEED:try{this.__filters[this.currentPresetID].reset()}catch(i){}break}try{this.__filters[this.currentPresetID].dispose()}catch(i){}this.currentPresetID=null};BFN.effects.MultimediaEffect=new pa;function fa(){PIXI.Sprite.call(this),this.initialized=!1}fa.prototype=Object.create(PIXI.Sprite.prototype);fa.prototype.initEffect=function(){this.sourceTexture=null,this.isSetup=!1,this.uiControls=new Array,this.__filters={};for(let i in BFN.CONST.GLITCH_ART_PRESETS)switch(BFN.CONST.GLITCH_ART_PRESETS[i]){case BFN.CONST.GLITCH_ART_PRESETS.CORRUPTED:this.__filters[BFN.CONST.GLITCH_ART_PRESETS[i]]=new BFN.filters.GlitchCorruptedFilter;break;case BFN.CONST.GLITCH_ART_PRESETS.DISTORTED:this.__filters[BFN.CONST.GLITCH_ART_PRESETS[i]]=new BFN.filters.GlitchDistortedFilter;break;case BFN.CONST.GLITCH_ART_PRESETS.SEGMENTED:this.__filters[BFN.CONST.GLITCH_ART_PRESETS[i]]=new BFN.filters.GlitchSegmentedFilter;break;case BFN.CONST.GLITCH_ART_PRESETS.FRAGMENTED:this.__filters[BFN.CONST.GLITCH_ART_PRESETS[i]]=new BFN.filters.GlitchFragmentedFilter;break;case BFN.CONST.GLITCH_ART_PRESETS.DIGITIZED:this.__filters[BFN.CONST.GLITCH_ART_PRESETS[i]]=new BFN.filters.GlitchDigitizedFilter;break}};fa.prototype.setupEffect=function(i){this.initialized||(this.initialized=!0,this.initEffect()),this.disposeEffect(),this.sourceTexture=i,this.isSetup=!0,this.texture=this.sourceTexture};fa.prototype.applyEffect=function(i,e,t){if(this.resolution=i,this.parameters=e,e.hasOwnProperty("presetID")&&this.__filters.hasOwnProperty(e.presetID)){this.currentPresetID=e.presetID;let r=this.__filters[this.currentPresetID],a=[r];switch(this.currentPresetID){case BFN.CONST.GLITCH_ART_PRESETS.CORRUPTED:r.setDimensions(this.sourceTexture.width,this.sourceTexture.height),r.seed!==e.phase&&(r.seed=parseInt(e.phase),r.drawGlitchSource()),r.strength=e.hasOwnProperty("strength")?e.strength/100:.5;let s="000"+(e.hasOwnProperty("complexity")?(parseInt(e.complexity)-1).toString(2):"");s=s.substring(s.length-3,s.length),r.vShift=parseInt(s[2]),r.noise=parseInt(s[1]),r.chromatic=parseInt(s[0]);break;case BFN.CONST.GLITCH_ART_PRESETS.DISTORTED:r.setSourceTexture(this.sourceTexture),r.grayscale=e.hasOwnProperty("grayscale")?parseInt(e.grayscale):1,r.phase=e.hasOwnProperty("phase")?e.phase/100:0,r.length=e.hasOwnProperty("length")?e.length/100:.2,r.horizontal=e.hasOwnProperty("slide_horizontal")?e.slide_horizontal/100:.2;break;case BFN.CONST.GLITCH_ART_PRESETS.SEGMENTED:r.setDimensions(this.sourceTexture.width,this.sourceTexture.height),r.grayscale=e.hasOwnProperty("grayscale")?parseInt(e.grayscale):0,r.horizontal=e.hasOwnProperty("slide_horizontal")?e.slide_horizontal/100:.1,r.vertical=e.hasOwnProperty("slide_vertical")?e.slide_vertical/100:.1,r.colorCycle=e.hasOwnProperty("colors")?parseInt(e.colors):0;break;case BFN.CONST.GLITCH_ART_PRESETS.FRAGMENTED:r.setSourceTexture(this.sourceTexture),r.grayscale=e.hasOwnProperty("grayscale")?parseInt(e.grayscale):0,r.highlights=e.hasOwnProperty("highlights")?e.highlights/100:.5,r.offset=e.hasOwnProperty("offset")?e.offset/100:.5;break;case BFN.CONST.GLITCH_ART_PRESETS.DIGITIZED:r.setSourceTexture(this.sourceTexture),r.colorValue=e.hasOwnProperty("color_picker")?e.color_picker:-1,r.highlights=e.hasOwnProperty("highlights")?e.highlights/100:.5,r.weight=e.hasOwnProperty("weight")?e.weight/100:.5,r.horizontal=e.hasOwnProperty("slide_horizontal")?e.slide_horizontal/100:.5;break}this.filters=a}};fa.prototype.disposeEffect=function(){switch(this.sourceTexture=null,this.isSetup=!1,this.currentPresetID){case BFN.CONST.GLITCH_ART_PRESETS.GLITCH:try{this.__filters[this.currentPresetID].clearGlitchSource()}catch(i){}break;case BFN.CONST.GLITCH_ART_PRESETS.GLITCH_BW:try{this.__filters[this.currentPresetID].resetSourceTexture()}catch(i){}break;case BFN.CONST.GLITCH_ART_PRESETS.CYBER_SPACE:try{this.__filters[this.currentPresetID].resetSourceTexture()}catch(i){}break}try{this.__filters[this.currentPresetID].dispose()}catch(i){}this.currentPresetID=null};BFN.effects.GlitchArtEffect=new fa;BFN.effectMap={};BFN.effectMap.analog="AnalogEffect";BFN.effectMap.bwfx="AnalogEffect";BFN.effectMap.warmfx="AnalogEffect";BFN.effectMap.clarity="ClarityEffect";BFN.effectMap.color="ColorEffect";BFN.effectMap.replace_color="ReplaceColorEffect";BFN.effectMap.exposure="ExposureEffect";BFN.effectMap.fill_light="FillLightEffect";BFN.effectMap.gauss_blur="GaussianBlurEffect";BFN.effectMap.blur="GaussianBlurEffect";BFN.effectMap.gray="GrayEffect";BFN.effectMap.desaturate="GrayEffect";BFN.effectMap.invert="InvertEffect";BFN.effectMap.levels="LevelsEffect";BFN.effectMap.sharpen="UnsharpMaskEffect";BFN.effectMap.vibrance="VibranceEffect";BFN.effectMap.vignette="VignetteEffect";BFN.effectMap.bw="BlackWhiteEffect";BFN.effectMap.chromatic="ChromaticEffect";BFN.effectMap.charcoal="CharcoalEffect";BFN.effectMap.cyanotype="CyanotypeEffect";BFN.effectMap.orton_style="OrtonStyleEffect";BFN.effectMap.sepia="SepiaEffect";BFN.effectMap.viewfinder="ViewFinderEffect";BFN.effectMap.summer="SummerEffect";BFN.effectMap.unitedcolors="UnitedColorsEffect";BFN.effectMap.instant="InstantEffect";BFN.effectMap.cooler="CoolingEffect";BFN.effectMap.warmer="WarmingEffect";BFN.effectMap.tinytype="TinyTypeEffect";BFN.effectMap.crossprocess="CrossProcessEffect";BFN.effectMap.vintagecolors="VintageColorsEffect";BFN.effectMap.holgaart="HolgaArtEffect";BFN.effectMap.lineartopia="LineArtopiaEffect";BFN.effectMap.hdr="HDREffect";BFN.effectMap.pinhole="PinholeEffect";BFN.effectMap.colorpinhole="ColorPinholeEffect";BFN.effectMap.stenciler="StencilerEffect";BFN.effectMap.grungefx="GrungeEffect";BFN.effectMap.sunburst="SunburstEffect";BFN.effectMap.oldphotofx="OldPhotoEffect";BFN.effectMap.winterfx="WinterEffect";BFN.effectMap.tiltshiftfx="TiltShiftEffect";BFN.effectMap.patrioticfx="PatrioticEffect";BFN.effectMap.popartfx="PopArtEffect";BFN.effectMap.tint="TintEffect";BFN.effectMap.beautify="BeautifyEffect";BFN.effectMap.motioncolor="MotionColorEffect";BFN.effectMap.lomoart="LomoArtEffect";BFN.effectMap.color_mixer="ColorMixerEffect";BFN.effectMap.soften="SoftenEffect";BFN.effectMap.smoothing="SmoothingEffect";BFN.effectMap.blur_edges="BlurEdgesEffect";BFN.effectMap.auto_enhance="AutoEnhanceEffect";BFN.effectMap.glow="GlowEffect";BFN.effectMap.lens_blur="BokehBlurEffect";BFN.effectMap.cinematic="CinematicEffect";BFN.effectMap.multimedia="MultimediaEffect";BFN.effectMap.glitch_art="GlitchArtEffect";BFN.effectMap.touchup="TouchUpEffect";BFN.effectPresetMap={};BFN.effectIDMap={};BFN.EffectData.forEach(({presets:i,id:e})=>{i.forEach(({id:t})=>{BFN.effectPresetMap[`${e}_${t}`]=e,BFN.effectIDMap[t]=e})});var fb=class{constructor(){this.init()}init(){BeFunky.log("SentryManager Init"),this.initDefaultValues()}initDefaultValues(){this.reportBreadcrumbs=!0,this.displayObjectRegistry={},this.unregisteredDisplayObjects=[],this.invalidSearchTypes=["RenderTexture","Texture","Graphics","Sprite","Container","DisplayObject"],this.validDisplayObjectTypes=["object","function"],this.customDisplayObjectRegistry={},this.topLevelDisplayObjectInstances=[],this.defaultDisplayObjectPropertyNames=null,this.purgeUnregisteredDisplayObjects=BeFunky.debounce(this.purgeUnregisteredDisplayObjects,2e3),this.handleDisplayObjectPointerDownBind=this.handleDisplayObjectPointerDown.bind(this)}reportBreadcrumb(e,t="",r="canvas_interaction"){if(!BFN.reportAppBreadcrumbs||typeof e!="string"||typeof t!="string"||typeof r!="string")return;let a=BFN.AppModel.sectionValue("editor","collage","designer"),{canvasModel:s,canvasW:o,canvasH:n}=BFN.ZoomManager.getCanvasData(),c=[`${a}:${o}x${n}px@${Math.round(s.canvasScale*100)}%`];t&&c.push(t),e&&c.push(e);let h=c.join(" : ");BeFunky.logFeature(r,h),this.reportBreadcrumbs&&Sentry.addBreadcrumb({category:r,message:h})}registerDisplayObject(e,t=!1){if(!BFN.reportAppBreadcrumbs||!e||!(e instanceof PIXI.DisplayObject))return;let r=this.topLevelDisplayObjectInstances.includes(e);if(r&&(t=!1),t&&!e.interactive)return;let a=this.unregisteredDisplayObjects.indexOf(e);if(a>=0&&this.unregisteredDisplayObjects.splice(a,1),e.breadcrumbKey&&this.displayObjectRegistry.hasOwnProperty(e.breadcrumbKey)){if(e===this.displayObjectRegistry[e.breadcrumbKey].object)return;delete e.breadcrumbKey}if(!e.breadcrumbKey)for(;e.breadcrumbKey=BeFunky.randomString(10),!!this.displayObjectRegistry.hasOwnProperty(e.breadcrumbKey););this.displayObjectRegistry[e.breadcrumbKey]={object:e},this.assignDisplayObjectClassName(e),(e.interactive||r)&&e.on("pointerdown",this.handleDisplayObjectPointerDownBind)}unregisterDisplayObject(e){if(!BFN.reportAppBreadcrumbs||!e||!(e instanceof PIXI.DisplayObject)||!e.breadcrumbKey||e.breadcrumbKey&&!this.displayObjectRegistry.hasOwnProperty(e.breadcrumbKey))return;let t=this.getDisplayObjectData(e);t.className&&this.customDisplayObjectRegistry[t.className]===e||this.unregisteredDisplayObjects.includes(e)||(this.unregisteredDisplayObjects.push(e),this.purgeUnregisteredDisplayObjects())}purgeUnregisteredDisplayObjects(){if(this.unregisteredDisplayObjects.length)for(;this.unregisteredDisplayObjects.length;){let e=this.unregisteredDisplayObjects.shift();e.off("pointerdown",this.handleDisplayObjectPointerDownBind),this.displayObjectRegistry.hasOwnProperty(e.breadcrumbKey)&&delete this.displayObjectRegistry[e.breadcrumbKey]}}updateDisplayObjectPath(e){if(!e||typeof e!="object"||!(e instanceof PIXI.DisplayObject))return;(!e.breadcrumbKey||e.breadcrumbKey&&!this.displayObjectRegistry.hasOwnProperty(e.breadcrumbKey))&&this.registerDisplayObject(e);let t=this.getDisplayObjectData(e);if(!t||this.validateDisplayObjectPath(t))return;let r=[],a=e;for(;a;){this.registerDisplayObject(a);let s=this.assignDisplayObjectClassName(a);if(s&&(r.splice(0,0,{className:s,object:a}),this.customDisplayObjectRegistry[s]===a))break;a=a.parent||null}if(!!r.length){for(let s=0;s<r.length;s++){let o=r[s];o.displayPath=r.slice(0,s+1),s||(o.objectPath=[{key:"BFN",value:BFN},{key:o.className,value:o.object}])}for(let s=0;s<r.length-1;s++){let o=r[s].object;if(!this.invalidSearchTypes.includes(o.className))for(let n=s+1;n<r.length;n++){if(r[n].objectPath)continue;let l=r[n].object,c=this.findObjectPath(l,o,this.getDefaultDisplayObjectPropertyNames(),!0,1);c&&(r[n].objectPath=r[s].objectPath?r[s].objectPath.concat(c):c)}}for(let s=0;s<r.length;s++){let o=r[s];if(!o.objectPath&&o.object&&o.object.parent&&s>0){let l=r[s-1];if(l.objectPath){let{children:c}=l.object;o.objectPath=l.objectPath.concat([{key:"children",value:c},{key:c.indexOf(o.object),value:o.object}])}}let n=this.getDisplayObjectData(o.object);n.pathObjects=n&&o.objectPath?o.objectPath:null}this.validateDisplayObjectPath(t)}}getDisplayObjectInfo(e,t=!1){let r=null;t&&this.updateDisplayObjectPath(e);let a=this.getDisplayObjectData(e);if(!t&&(!a||a&&!a.path)&&(this.updateDisplayObjectPath(e),a=this.getDisplayObjectData(e)),a){let s=null;if(e instanceof BFN.TransformItem)s=`${e.itemInfo} ( BaseSize:${e.textureDimensions} | LayerSize:${e.itemDimensions} )`;else if(e===BFN.TransformItemGroup)s=`${e.groupInfoLite} ( ${e.groupDimensions} )`;else if(e instanceof BFN.PhotoGridChild){let n="empty";if(e.content&&!e.content.isEmpty&&e.content.image){let{texture:l}=e.content.image;l&&l.baseTexture&&(n=`${l.baseTexture.width}x${l.baseTexture.height}px`)}s=`( ${n} )`}let{path:o}=a;r=`${o||"*noparent*"} ( ${a.className} )${s?` : ${s}`:""}`,o?e.displayObjectInfo=r:e.displayObjectInfo&&(r=`*noparent* ${e.displayObjectInfo}`)}else e.displayObjectInfo&&(r=`*noparent* ${e.displayObjectInfo}`);return r}getDisplayObjectData(e){return e&&e.breadcrumbKey&&this.displayObjectRegistry[e.breadcrumbKey]?this.displayObjectRegistry[e.breadcrumbKey]:null}validateDisplayObjectPath(e){if(!e)return!1;if(e.hasOwnProperty("pathObjects")){let{pathObjects:t}=e;if(!t)return!0;if(!t.length)return delete e.pathObjects,!1;let r=t[0].key;for(let a=1;a<t.length;a++){let s=t[a-1],o=t[a],n=s.value instanceof Array&&!isNaN(parseInt(o.key));if(s.value[o.key]!==o.value)if(n){let l=s.value.indexOf(o.value);l!==-1&&(o.key=l)}else return delete e.pathObjects,!1;r+=n?`[${o.key}]`:`.${o.key}`}return e.path!==r&&(e.path=r),!0}return!1}assignDisplayObjectClassName(e){let t=this.getDisplayObjectData(e);if(!t)return null;if(t.className)return t.className;let r=()=>{for(let o in this.customDisplayObjectRegistry){let n=this.customDisplayObjectRegistry[o];if(typeof n=="object"&&e===n||typeof n=="function"&&e instanceof n)return o}return null},a=()=>{for(let o in BFN){let n=BFN[o];!this.customDisplayObjectRegistry.hasOwnProperty(o)&&n&&this.validDisplayObjectTypes.includes(typeof n)&&(n instanceof PIXI.DisplayObject||n.prototype&&n.prototype instanceof PIXI.DisplayObject)&&(this.customDisplayObjectRegistry[o]=n,n instanceof PIXI.DisplayObject&&!this.topLevelDisplayObjectInstances.includes(n)&&this.topLevelDisplayObjectInstances.push(n))}},s=r();return s||(a(),s=r(),s||(e instanceof PIXI.Sprite?s="Sprite":e instanceof PIXI.Container?s="Container":s="DisplayObject")),t.className=s,s}getDefaultDisplayObjectPropertyNames(){if(!this.defaultDisplayObjectPropertyNames){this.defaultDisplayObjectPropertyNames=[];let e=[PIXI.DisplayObject,PIXI.Container,PIXI.Sprite,PIXI.Graphics];for(let t=0;t<e.length;t++){let r=e[t],a=new r;for(let s in a)this.defaultDisplayObjectPropertyNames.hasOwnProperty(s)||this.defaultDisplayObjectPropertyNames.push(s)}}return this.defaultDisplayObjectPropertyNames}findObjectPath(e,t,r=[],a=!1,s=-1,o=0){try{if(typeof e!="object"||typeof t!="object"||s>0&&o>s)return null;r=r||[];let n=[Object,Array],l=null,c=null;for(let h in t){if(r.includes(h))continue;let u=t[h];if(!(!u||typeof u!="object")&&!(t.constructor&&t.constructor instanceof Array&&e.constructor&&!(u instanceof e.constructor))){if(u===e&&!l&&(l=[{key:h,value:u}]),l&&!a)return l;a&&typeof u=="object"&&n.includes(u.constructor)&&(c||(c={}),c[h]=u)}}if(a)for(let h in c){let u=c[h],d=this.findObjectPath(e,u,r,a,s,o+1);if(d)return[{key:h,value:u},...d]}return l}catch(n){return null}}getSpecialKeyString(e={}){if(!e||!(e instanceof Object))return"";let t=[];return e.ctrlKey&&t.push("Ctrl"),e.metaKey&&t.push("Cmd"),e.altKey&&t.push("Alt"),e.shiftKey&&t.push("Shift"),t.length?` + ${t.join(" + ")}`:""}formatString(e,t=""){if(typeof e!="string")return"";let r=e.split("_").join(" ").split(" "),a=[];return r.forEach(s=>{a.push(s.charAt(0).toUpperCase()+s.slice(1).toLowerCase())}),a.join(t)}handleDisplayObjectPointerDown(e){if(e.target!==e.currentTarget)return;let t="pointer_down",r="";if(e.data&&e.data.originalEvent){let a=e.data.originalEvent;a.button===2&&(t+="_right"),r=this.getSpecialKeyString(a)}t+=r,BFN.SentryManager.reportBreadcrumb(BFN.SentryManager.getDisplayObjectInfo(e.target,!0),t)}};BFN.SingletonQueue.add(()=>{BFN.SentryManager=new fb});var gb=class{constructor(){this.init()}init(){BeFunky.log("ImageEditManager Init"),this.initDefaultValues()}initDefaultValues(){this.editingImage=!1,this.targetViewstate=null,this.targetImageItem=null,this.targetMaskImageItem=null,this.targetGridCell=null,this.flattenedImage=null,this.handleAppModelViewStateChangedBind=this.handleAppModelViewStateChanged.bind(this),BFN.PhotoEditorModel.addEventListener(BFN.PhotoEditorModelEvents.SOURCE_IMAGE_UPDATED.type,this.handleSourceImageUpdated.bind(this)),this.disregardSourceImageUpdate=!1,this.imageChangedWhileEditing=!1,this.animatingBackground=document.querySelector(".image-edit__bg"),this.animatingImage=document.querySelector(".image-edit__image"),this.animatingImage.addEventListener("click",()=>{this.targetViewstate&&(BFN.AppModel.viewState=this.targetViewstate)}),this.maxThumbSize=160,this.animatingImageRect={},this.animatingImageAppRect={},this.animatingImageObjectURL=null}openImageInEditor(e){if(e&&e.type==="texture"&&e.projectItemVO&&e.projectItemVO.imageID){let{imageID:t}=e.projectItemVO;if(!BFN.AppModel.sectionValue(null,"collage","designer"))return;BeFunky.showLoadScreen({isCancellable:!1,message:"opening_image_in_editor"});let a=s=>{if(!(s instanceof Blob)){BeFunky.hideLoadScreen();return}this.targetImageItem=e,this.goToEditor(s)};if(e.isShape){BFN.TextureUtils.textureToBlob(e.itemContent,{isTransparent:!0}).catch(s=>BeFunky.logError("Unable to convert SVG -> Blob for Open Image in Editor",s)).then(a);return}BFN.ProjectService.getLocalAsset("image",t).catch(s=>BeFunky.logError("Unable to get asset from IndexedDB for Open Image in Editor",s)).then(a)}}openMaskImageInEditor(e){if(e&&e.type==="frame_texture"&&e.projectItemVO&&e.projectItemVO.maskImageID){let{maskImageID:t}=e.projectItemVO;if(!BFN.AppModel.sectionValue(null,"collage","designer"))return;BeFunky.showLoadScreen({isCancellable:!1,message:"opening_image_in_editor"}),BFN.ProjectService.getLocalAsset("image",t).catch(BeFunky.logError).then(a=>{if(!a){BeFunky.hideLoadScreen();return}this.targetMaskImageItem=e,this.goToEditor(a)})}}openGridCellInEditor(e){if(e&&e.menuImageVO){let t=e.menuImageVO.id;BeFunky.showLoadScreen({isCancellable:!1,message:"opening_image_in_editor"});let r=a=>{if(!a){BeFunky.hideLoadScreen();return}this.targetGridCell=e,this.goToEditor(a)};if(e.menuImageVO.isSVG){BFN.TextureUtils.textureToBlob(e.menuImageVO.imageTexture,{isTransparent:!0}).catch(a=>BeFunky.logError("Unable to convert SVG -> Blob for Open Image in Editor",a)).then(r);return}BFN.ProjectService.getLocalAsset("image",t).catch(a=>BeFunky.logError("Unable to get asset from IndexedDB for Open Image in Editor",a)).then(r)}}goToEditor(e){BFN.ProjectManager.autoSave.editor.allowAutoSave=!1,this.editingImage=!0,this.targetViewstate=BFN.AppModel.viewState,BFN.AppModel.viewingCollage&&BFN.BfnService.track("CREATE","COLLAGE","OPEN_IMAGE_EDITOR");let t=!!(BFN.openedSections.includes("editor")&&BFN.PhotoEditorModel.currentTexture)||BFN.editorProjectShelved;BFN.editorProjectShelved=!1,this.transitionToEditor(r=>{BFN.AppModel.viewState=BFN.AppModelViewStates.VIEWING_PHOTO_EDITOR,BFN.editorProjectShelved=t,UITools.setToolValue("editor_main","edit",!1),UITools.applyTool("editor_main"),this.disregardSourceImageUpdate=!0,this.imageChangedWhileEditing=!1,BFN.PhotoEditorModel.loadNewImage(e,{filename:"BeFunky-layer",showLoadScreen:!1,callback:r,clearLocalAssets:!1})})}transitionToEditor(e){let t=this.animatingBackground,r=this.animatingImage,a=this.getProjectBoundingClientRect(),s=a.width/a.height;r.setStyles({width:`${a.width}px`,height:`${a.height}px`,transform:`translateX(${a.left}px) translateY(${-a.bottom}px)`,transition:"none",pointerEvents:"none"}),this.animatingImageRect=a,this.animatingImageAppRect=BFN.appRect;let o=Math.round(Math.min(Math.max(a.width,a.height),BFN.maxImageSizeLayer));n(o,c=>{this.animatingImageObjectURL=c,r.setStyles({backgroundImage:`url(${c})`,visibility:"visible",outlineWidth:"0"});let h=Math.max(50,Math.min(500,Math.round(Math.pow(o,2)/4e4)));l(h,()=>{t.setStyles({opacity:1})}),l(h+30,()=>{e(({success:u})=>{if(!u){BeFunky.hideLoadScreen(),t.removeAttribute("style"),r.removeAttribute("style"),this.completeEditing(),BFN.AppModel.viewState=this.targetViewstate;return}l(0,()=>{BeFunky.hideLoadScreen();let{maxThumbSize:d}=this,m=s>1?a.width/d:a.height/d,p=s>1?d:d*s,g=s>1?d/s:d,f=600,v=100,T=16,x=BeFunky.isWiderThanMobile()?BFN.CSS.leftPrimaryMenuWidth+BFN.CSS.sideMenuWidth:0,B=BeFunky.isWiderThanMobile()?BFN.CSS.footerHeight:BFN.CSS.bottomPrimaryMenuHeight+BFN.CSS.bottomSecondaryMenuDefaultHeight+Lr().bottom,y=`translateX(${T+x}px) translateY(-${T+B}px)`;r.setStyles({transform:`${y} scale(${1/m})`,transition:`transform ${f}ms ease-in-out`}),t.setStyles({transition:`opacity ${f-v}ms ease-in-out ${v}ms`,opacity:0}),l(f+100,()=>{t.removeAttribute("style"),r.setStyles({width:`${p}px`,height:`${g}px`,transform:"",transition:"none"}),l(0,()=>{r.setStyles({transition:"",outlineWidth:"",pointerEvents:""}),r.setAttribute("data-tooltip","back_to_collage")})})})})})});function n(c,h){let u=BFN.AppModel.viewingCollage?BFN.CollageMakerCanvas.getFlattenedImage(c,!0):BFN.DesignerCanvas.getFlattenedImage(c);BFN.TextureUtils.textureToBlob(u,{isTransparent:!0}).catch(d=>{u.destroyGC(!0),BeFunky.logError("Unable to generate Blob for Open Image in Editor transition",d)}).then(d=>{u.destroyGC(!0);let m=URL.createObjectURL(d||new Blob),p=new Image;p.onload=p.onerror=()=>{h(m),p.onerror=void 0},p.src=m})}function l(c,h){setTimeout(()=>requestAnimationFrame(h),c)}}getProjectBoundingClientRect(){if(BFN.AppModel.viewingCollage){let o=BFN.CollageMakerCanvas.scale.x,n=BFN.CollageMakerCanvas.canvasPhotoGrid.gridWidth*o,l=BFN.CollageMakerCanvas.canvasPhotoGrid.gridHeight*o,c=BFN.CollageMakerCanvas.canvasContainer.x*o,h=-BFN.CollageMakerCanvas.canvasContainer.y*o;return{width:n,height:l,left:BFN.CollageMakerCanvas.x+c-n/2+BFN.appViewportRect.left,bottom:BFN.CollageMakerCanvas.y+h-l/2+BFN.getAppViewportBottomOffset()+(BeFunky.isWiderThanMobile()?0:Lr().bottom)}}if(!BFN.AppModel.viewingDesigner)throw"Wrong app section";let e=BFN.DesignerCanvas.scale.x,t=BFN.DesignerCanvas.canvasWidth*e,r=BFN.DesignerCanvas.canvasHeight*e,a=BFN.DesignerCanvas.canvasContainer.x*e,s=-BFN.DesignerCanvas.canvasContainer.y*e;return{width:t,height:r,left:BFN.DesignerCanvas.x+a-t/2+BFN.appViewportRect.left,bottom:BFN.DesignerCanvas.y+s-r/2+BFN.getAppViewportBottomOffset()}}transitionFromEditor(){let e=this.animatingBackground,t=this.animatingImage,r=this.animatingImageRect,a=this.animatingImageAppRect;t.setStyles({outlineWidth:"0",pointerEvents:"none",transform:getComputedStyle(t).transform,transition:"none"}),e.setStyles({opacity:1}),requestAnimationFrame(()=>{let o=500,{maxThumbSize:n}=this,l=r.width/r.height,c=l>1?r.width/n:r.height/n,h=r.left+(BFN.appRect.width-a.width)/2,u=r.bottom+(BFN.appRect.height-a.height)/2;t.setStyles({transform:`translateX(${h}px) translateY(${-u}px) scale(${c})`,transition:`transform ${o}ms ease-in-out`}),s(o,()=>{let d=300;t.setStyles({opacity:0,transition:`opacity ${d}ms ease-in-out`}),e.setStyles({opacity:0,transition:`opacity ${d}ms ease-in-out`}),s(d,()=>{e.removeAttribute("style"),t.removeAttribute("style"),this.animatingImageObjectURL&&URL.revokeObjectURL(this.animatingImageObjectURL)})})});function s(o,n){setTimeout(()=>requestAnimationFrame(n),o)}}completeEditing(e){BFN.PhotoEditorCanvasModel.exitCurrentEditorTool(),this.flattenedImage=e?BFN.PhotoEditorCanvas.getFlattenedImage():null,this.editingImage=!1,this.resetEditor(),BFN.AppModel.addEventListener(BFN.AppModelEvents.VIEWSTATE_UPDATED.type,this.handleAppModelViewStateChangedBind)}applyEdit(){if(this.flattenedImage){let e=this.processTexture(this.flattenedImage),t=new PIXI.Point(this.flattenedImage.baseTexture.width,this.flattenedImage.baseTexture.height);if(this.targetImageItem){let r=new PIXI.Point(this.targetImageItem.itemContent.texture.baseTexture.width,this.targetImageItem.itemContent.texture.baseTexture.height),a=r.x!==t.x||r.y!==t.y,s=this.targetImageItem,o,n,l,c;if(a){let h=s.bounds,u=h.width,d=h.height;o=u*s.scale.x,n=d*s.scale.y;let m=Math.sqrt(Math.pow(o,2)+Math.pow(n,2))/2,p=Math.atan2(n/2,o/2);l=s.x+Math.cos(p+s.rotation)*m,c=s.y+Math.sin(p+s.rotation)*m}if(this.targetImageItem.createTransition("edit_image"),this.targetImageItem.projectItemVO.imageID=e.id,this.targetImageItem.itemObject.texture=this.flattenedImage,this.targetImageItem.itemContent.texture=this.flattenedImage,this.targetImageItem.updateContentDimensions(),a){let h=s.bounds,u=h.width,d=h.height,m=u*s.scale.x,p=d*s.scale.y,g=Math.sqrt(Math.pow(m,2)+Math.pow(p,2))/2,f=Math.atan2(p/2,m/2),v=Math.min(o/m,n/p);s.scale.x*=v,s.scale.y*=v,s.x=l+Math.cos(f+Math.PI+s.rotation)*g*v,s.y=c+Math.sin(f+Math.PI+s.rotation)*g*v}this.targetImageItem.registerTransition()}else if(this.targetMaskImageItem){let r=new PIXI.Point(this.targetMaskImageItem.itemContent.texture.baseTexture.width,this.targetMaskImageItem.itemContent.texture.baseTexture.height),a=r.x!==t.x||r.y!==t.y;this.targetMaskImageItem.createTransition("edit_image"),this.targetMaskImageItem.projectItemVO.maskImageID=e.id,this.targetMaskImageItem.itemObject.texture=this.flattenedImage,this.targetMaskImageItem.itemContent.setTexture(this.flattenedImage),a&&(this.targetMaskImageItem.itemContent.textureScale=1,this.targetMaskImageItem.itemContent.offsetFactorX=.5,this.targetMaskImageItem.itemContent.offsetFactorY=.5),this.targetMaskImageItem.itemContent.updateDisplay(),this.targetMaskImageItem.registerTransition()}else if(this.targetGridCell){let r=new PIXI.Point(this.targetGridCell.content.image.frameSprite.texture.baseTexture.width,this.targetGridCell.content.image.frameSprite.texture.baseTexture.height),a=r.x!==t.x||r.y!==t.y;this.targetGridCell.menuImageVO=e,this.targetGridCell.content.setImage(e.imageTexture,a,!1,this.targetGridCell.content.image.frameSprite.rotate)}}this.flattenedImage=null}processTexture(e){switch(BFN.AppModel.viewState){case BFN.AppModelViewStates.VIEWING_COLLAGE_MAKER:UITools.setToolValue("collage_main","image_manager",!1),UITools.applyTool("collage_main");break;case BFN.AppModelViewStates.VIEWING_DESIGNER:UITools.setToolValue("designer_main","image_manager",!1),UITools.applyTool("designer_main");break}return BFN.ImageLibraryManager.createMenuImageVOFromTexture(e)}resetEditor(){BFN.PhotoEditorModel.currentTexture&&BFN.PhotoEditorModel.currentTexture!==BFN.PhotoEditorModel.sourceTexture&&BFN.PhotoEditorModel.currentTexture.destroyGC(!0),BFN.PhotoEditorModel.currentTexture=null,BFN.PhotoEditorModel.dispatchEvent(BFN.PhotoEditorModelEvents.SOURCE_IMAGE_UPDATED),BFN.PhotoEditorModel.dispatchEvent(BFN.PhotoEditorModelEvents.CURRENT_IMAGE_UPDATED),BFN.ArtsyService.reset(),BFN.BackgroundRemovalManager.reset(),BFN.TransformStateModel.clearTransitions(BFN.AppModelViewStates.VIEWING_PHOTO_EDITOR),BFN.PhotoEditorCanvasModel.dispatchEvent(BFN.PhotoEditorCanvasModelEvents.CLEAR_ITEMS),BFN.PhotoEditorHistoryModel.resetHistory(),BFN.PhotoEditorModel.sourceTexture.clear(),BFN.PhotoEditorModel.sourceTexture.resize(32,32),showMenuPanel("primary")}overrideSetAppViewState(e){this.targetViewstate=this.targetViewstate||e;let t=()=>{let s=BFN.UserActionManager.getSaveData(),o=new BFN.UserActionVO;o.eventID="collage_or_designer_image_edited",o.eventObject={targetSection:BFN.AppModel.getSectionValue(this.targetViewstate,"Photo Editor","Collage Maker","Designer"),imageEditMainFunnel:s.actions,imageEditFontsUsed:s.fonts,imageEditLayerSourcesUsed:s.assets},o.register()},r=()=>{BFN.PhotoEditorCanvasTools.applyCurrentTool(),t(),this.completeEditing(!0),this.transitionFromEditor(),BFN.AppModel.viewState=this.targetViewstate},a=()=>{t(),this.completeEditing(this.imageChangedWhileEditing||BFN.UndoManager.undoExists),this.transitionFromEditor(),BFN.AppModel.viewState=this.targetViewstate};BFN.PhotoEditorCanvasModel.viewState!==BFN.PhotoEditorCanvasModelViewStates.VIEWING_CANVAS?BeFunky.confirm("apply_changes_leave_editor",{onConfirm:r,confirmText:"yes",cancelText:"no_keep_editing"}):a()}handleAppModelViewStateChanged(){BFN.AppModel.removeEventListener(BFN.AppModelEvents.VIEWSTATE_UPDATED.type,this.handleAppModelViewStateChangedBind),BFN.AppModel.viewState===this.targetViewstate&&(this.flattenedImage&&this.applyEdit(),this.targetImageItem&&this.targetImageItem.selectItem(),this.targetMaskImageItem?this.targetMaskImageItem.selectItem():this.targetGridCell&&(BFN.PhotoGrid.selectedChild=this.targetGridCell,BFN.PhotoGrid.isolateGridChild(this.targetGridCell))),setTimeout(()=>{BFN.ProjectManager.autoSave.editor.allowAutoSave=!0},2e3),this.targetViewstate=null,this.targetImageItem=null,this.targetMaskImageItem=null,this.targetGridCell=null,this.flattenedImage=null}handleSourceImageUpdated(e){if(this.editingImage){if(this.disregardSourceImageUpdate){this.disregardSourceImageUpdate=!1;return}this.imageChangedWhileEditing=!0}}};BFN.SingletonQueue.add(()=>{BFN.ImageEditManager=new gb});var{html:Oi,setupState:sM,render:oM,elem:vb,icon:nM,modalLang:yb}=BeFunky.lit;function Lo({imageSelectionHandler:i,transformImageObject:e=a=>a,extendItemTemplate:t,onClose:r}){let a=vb`<div id="image_library" class="modal modal--button-sm image-library"></div>`,s=1600,o=s-17*16-24*2,n={befunky:{heading:"BeFunky",imageTypes:["befunky_photo","befunky_layer"],hasAlbums:!1,desktopRowHeight:173,emptyState:{text:"login_load_images",imageUrl:`${BFN.imagesURL}illustrations/log-in-befunky-photos.svg`,buttonText:"sign_in",buttonAction:ne},gallery:null},facebook:{heading:"Facebook",imageTypes:["facebook"],hasAlbums:!0,desktopRowHeight:200,emptyState:{text:"connect_facebook_load_albums",imageUrl:`${BFN.imagesURL}illustrations/connect-facebook-photos.svg`,buttonText:"connect_facebook",buttonAction:le},gallery:null},google:{heading:"Google Photos",imageTypes:["google_photos"],hasAlbums:!0,desktopRowHeight:200,emptyState:{text:"connect_google_load_albums",imageUrl:`${BFN.imagesURL}illustrations/connect-google-photos.svg`,buttonText:"connect_google_photos",buttonAction:Be},gallery:null}};Object.values(n).forEach(k=>{k.gallery=_(k)});let l={currentSection:"befunky",albums:{befunky:[],facebook:[],google:[]},galleryWidth:o},c=BeFunky.debounce(()=>{oM(T(),a)},"raf"),[h,u]=sM(l,k=>{if(k.currentSection&&re(k.currentSection[0]),k.albums){let G=Boolean(k.currentSection);if(!G&&k.albums){let[L,R]=k.albums.map(A=>A[h.currentSection].find(X=>X.isSelected));R&&(!L||L.id!==R.id)&&(G=!0)}E(G)}c()});BeFunky.LanguageManager.addLanguageUpdateListener(c);let{recalculateScrollPosition:d,handleScroll:m,setOnScrollCallback:p,scrollTo:g,getScrollTop:f}=BeFunky.handleLitGalleryScroll(),v;return BeFunky.onMatchMedia(`(min-width: ${BFN.CSS.desktopAppMinWidth}px)`,({isMatched:k})=>{v=k,c()},!0),Object.assign(a,{open:w,close:N,updateSelectedItems:M,getGallery:W,setState:u}),a;function T(){return v?x():S()}function x(){return Oi`
        <panel-header .langId=${"image_library"} .modifier=${"modal"} .buttons=${"close"}></panel-header>
        <div class="modal__body image-library__body">
            ${B()}
            ${b()}
        </div>
        `}function B(){return Oi`<div class="image-library__left-panel">${Object.keys(n).map(y)}</div>`}function y(k){let G=n[k].hasAlbums?h.albums[k]:null,L=()=>{u({currentSection:k})},R=h.currentSection===k&&G&&G.length>0;return Oi`
        <button @click=${L} class=${`image-library__tab button button--grey-200 button--fullwidth button--has-icon ${k===h.currentSection?"button--selected":""}`}>
            ${R?Oi`${nM("chevron-icon","icon icon--chevron-down")}`:""}
            <string>${n[k].heading}</string>
        </button>
        ${R&&k==="google"?Oi`<button @click=${ke} class="image-library__disconnect button button--white-outline button--xs button--ellipsis">${yb("disconnect")}</button>`:""}
        ${R?F(k,G):""}
        `}function F(k,G){return Oi`
        <div class="image-library__albums">
            ${G.map(L=>{let R=`image-library__album button button--grey-200 button--fullwidth ${L.isSelected?"button--selected":""}`;return Oi`
            <button @click=${()=>_e(k,L)} class="${R}">
                <string>${L.name}</string>
                ${L.isLoading?Oi`<span class="loading-spinner"></span>`:""}
            </button>`})}
        </div>`}function b(){return Oi`
        <div class="image-library__right-panel">
            <div class="scrollable-content scrollable-content--modal-right-panel" @scroll=${m} style=${`--scrollable-content-width: ${h.galleryWidth}px`}>
                ${W(h.currentSection)}
            </div>
        </div>
        `}function S(){let k=h.currentSection,{heading:G,hasAlbums:L}=n[k],R=L?h.albums[k]:null,A=R&&R.length>0;return Oi`
        <panel-header .langId=${G} .modifier=${"modal"} .buttons=${"close"}></panel-header>
        <div class="modal__body image-library__body">
            ${A&&k==="google"?Oi`<button @click=${ke} class="image-library__disconnect button button--white-outline button--xs button--ellipsis">${yb("disconnect")}</button>`:""}
            ${A?I(k,R):""}
            <div class="vertical-scroller" @scroll=${m} style="flex-grow: 1; display: flex; flex-direction: column">
                ${W(h.currentSection)}
            </div>
        </div>
        `}function I(k,G){let L=G.map(X=>({name:X.name,value:X.id})),R=G.find(X=>X.isSelected),A=X=>{let Y=G.find(ae=>ae.id===X);_e(k,Y)};return Oi`
        <dropdown-select
            .value=${R?R.id:void 0}
            .label=${"select_album"}
            .useLabel=${!1}
            .options=${L}
            .onChange=${A}
            style="margin: 1rem 2rem 0"
        ></dropdown-select>`}function _({desktopRowHeight:k,emptyState:G}){return vb`<image-gallery
                class="image-library__gallery"
                .rowHeight=${Ie(o,8,k)}
                .currentWidth=${o}
                .onClickItem=${i}
                .extendItemTemplate=${t}
                .emptyState=${G}
                .gutterWidth=${8}
                .borderWidth=${1}
            ></image-gallery>`}function E(k){let G=h.currentSection,L=(h.albums[G]||[]).find(ze=>ze.isSelected);if(!L)return;let{page:R,images:A,staggerImageLoading:X,scrollPosition:Y,viewport:ae,isLoading:H,message:V,emptyState:K,loadNextPageOfImages:ee}=L,se=W(G),ge=G==="google"?30:50;if(A.length||(se.emptyState=K),se.message=V,se.isLoading=H,se.staggerLoading=X,z(G),H&&!k)return;se.images=A.slice(0,R*ge),d(),k&&(g(Y),se.viewport=ae),R*ge<A.length?L.staggerImageLoading=!0:ee&&!H&&!V&&!K&&setTimeout(()=>ee(L),0);let Ce=0;k?requestAnimationFrame(Ne):p(Ge);function Ne(){Ce++,!(!L.isSelected||R!==L.page)&&(Y!==f()&&Ce<=3?se.getBoundingClientRect().height?(g(Y),d(),p(Ge)):requestAnimationFrame(Ne):(d(),p(Ge)))}function Ge({scrollHeight:ze,offsetHeight:C,scrollTop:P}){if(!L.isSelected||R!==L.page||(se.viewport=[P,P+C],!(R*ge<A.length)))return;let q=400;ze-C-P<=q&&(L.page++,E(!1))}}function D(k){let{imageTypes:G}=n[k];return BFN.ImageLibraryManager.selectedMenuImageVOs.filter(L=>G.includes(BFN.getImageType(L.id))).map(L=>L.id)}function w(k){BeFunky.openModal(a,{onOpen:()=>{k&&k!==h.currentSection?u({currentSection:k}):re()},onClose:()=>{typeof r=="function"&&r()},onWindowResize:pe,size:"xxl",isFullWidthOnMobile:!0})}function N(){BeFunky.closeModal(a)}function M(){Object.keys(n).forEach(k=>{z(k)})}function z(k){let G=W(k),L=BFN.ImageLibraryManager.mode==="IMAGE_MANAGER";G.selectedImageIDs=L?D(k):void 0}function W(k){return n[k].gallery}function j(){Z("befunky",[{id:"DEFAULT",name:"",page:1,images:[],staggerImageLoading:!0,scrollPosition:0,isSelected:!0,isLoading:!1,message:"",emptyState:"",nextAPIPage:1,loadNextPageOfImages:k}]);function k(G){let{nextAPIPage:L,id:R}=G;U("befunky",R,{isLoading:!0,message:"",images:L===1?[]:G.images}),BeFunky.ImagesService.getPhotosAndLayers(L,({data:A,totalPages:X,error:Y})=>{if(Y)return L===1&&Y==="no_results"?U("befunky",R,{isLoading:!1,emptyState:{text:"no_befunky_photos",imageUrl:`${BFN.imagesURL}illustrations/no-search-results-canvas.svg`}}):(BeFunky.logError("Unable to fetch BeFunky images",Y),U("befunky",R,{isLoading:!1,message:{isError:!0,text:BeFunky.failureReason(Y),buttonText:"try_again",buttonAction:()=>k(G)}}));let ae=L<X;return U("befunky",R,{isLoading:!1,staggerImageLoading:!0,images:[...G.images,...A.map(e)],nextAPIPage:ae?L+1:void 0,loadNextPageOfImages:ae?k:void 0})})}}function J(){let k=W("facebook");k.images=[],k.isLoading=!0,k.message="",BeFunky.FacebookAuth.getPhotoAlbums().then(G=>{k.isLoading=!1;let L=G.map(({id:R,name:A,images:X},Y)=>({id:R,name:A,page:1,images:X.map(e),staggerImageLoading:!0,scrollPosition:0,isSelected:Y===0,isLoading:!1,message:"",emptyState:""}));Z("facebook",L)},G=>{k.isLoading=!1,BeFunky.logError("Unable to fetch Facebook albums",G),k.message={isError:!0,text:BeFunky.failureReason(G),buttonText:"try_again",buttonAction:()=>J()}})}function ie(){let k=W("google");k.images=[],k.message="",k.isLoading=!0,BeFunky.GooglePhotosManager.getAlbums().then(L=>{k.isLoading=!1;let R=(Y,ae,H)=>({id:Y,name:ae,page:1,images:[],staggerImageLoading:!0,scrollPosition:0,isSelected:H,isLoading:!1,message:"",emptyState:"",nextPageToken:void 0,loadNextPageOfImages:G}),A=L.filter(Y=>Y.title),X=[R("all_photos","All Photos",!1),...A.map((Y,ae)=>R(Y.album_id,Y.title,ae===0))];Z("google",X)},L=>{k.isLoading=!1,L!=="cancelled_by_user"&&(BeFunky.logError("Unable to fetch Google albums",L),k.message={isError:!0,text:BeFunky.failureReason(L),buttonText:"try_again",buttonAction:()=>ie()})});function G(L){return U("google",L.id,{isLoading:!0,message:""}),(L.id==="all_photos"?BeFunky.GooglePhotosManager.getAllMedia(L.nextPageToken):BeFunky.GooglePhotosManager.getAlbumMedia(L.id,L.nextPageToken)).then(({mediaItems:A,nextPageToken:X})=>{let Y=BeFunky.GooglePhotosManager.mediaItemsToImageObjects(A).map(e);if(!Y.length)throw"no_results";U("google",L.id,{isLoading:!1,staggerImageLoading:!0,images:[...L.images,...Y],nextPageToken:X,loadNextPageOfImages:X?G:void 0})}).catch(A=>{U("google",L.id,{isLoading:!1,message:{isError:!0,text:BeFunky.failureReason(A),buttonText:"try_again",buttonAction:()=>G(L)}})})}}function re(k){let G=W(h.currentSection);k&&he(k),p(void 0),{befunky:()=>{if(!BeFunky.isLoggedIn()){h.albums.befunky.length&&de("befunky");return}if(h.albums.befunky.length)return BeFunky.ImagesService.imageData.totalImages===null?j():E(!0);j()},facebook:()=>{if(!!BeFunky.FacebookAuth.hasBeenAuthorized){if(h.albums.facebook.length)return E(!0);G.isLoading||J()}},google:()=>{if(h.albums.google.length)return E(!0)}}[h.currentSection]()}function he(k){let G=h.albums[k].find(R=>R.isSelected);if(!G)return;let L=W(k);return G.scrollPosition=f(),G.viewport=L.viewport,G.staggerImageLoading=!1,G}function ne(){BeFunky.isLoggedIn()?j():BeFunky.openLoginPanel("SIGNIN",ne)}function le(){J()}function Be(){BeFunky.GooglePhotosManager.mightBeAuthorized?ie():BeFunky.GooglePhotosManager.login(!1).then(ie,k=>{k!=="cancelled_by_user"&&BeFunky.throwError("Unable to authorize with Google Photos",k)})}function _e(k,G){if(G.isSelected)return;let L=he(k);Z(k,h.albums[k].map(R=>R===G?Object.assign({},R,{isSelected:!0}):R===L?Object.assign({},R,{isSelected:!1}):R))}function pe({availableWidth:k}){let G=BeFunky.isWiderThanMobile()?o+(k-s):k-64;Object.values(n).forEach(({gallery:L,desktopRowHeight:R})=>{L.currentWidth=G,L.rowHeight=Ie(G,L.gutterWidth,R),u({galleryWidth:G}),d()})}function Ie(k,G,L){let R=L<190?3:2.2,A=k-G*(R-1);return Math.min(L,Math.round(A/R))}function ke(){BeFunky.GooglePhotosManager.disconnect().then(()=>{de("google")})}function de(k){Z(k,[]);let G=W(k);G.images=[],G.emptyState=n[k].emptyState}function Z(k,G){let L=Object.assign({},h.albums,{[k]:G});u({albums:L})}function U(k,G,L){Z(k,h.albums[k].map(R=>R.id!==G?R:Object.assign({},R,L)))}}var{html:er,defineCustomElement:lM,appLang:Vo,icon:Uo,useLanguageUpdate:cM,useMediaQuery:hM,useEffect:xb,useLayoutEffect:Go,useRef:Tb,useState:vr}=BeFunky.lit;function Ho(){lM("stock-search-modal",uM)}function uM({isOpen:i=!1,selectedImageIds:e}){let t=this,r="featured",[a,s]=vr(r),[o,n]=vr(1),[l,c]=vr(1),[h,u]=vr(),[d,m]=vr([]),[p,g]=vr(!1),f=Tb(0),v=3,[T,x]=vr(!1),B=1600,[y,F]=vr(Math.min(B,window.innerWidth-32)),[b,S]=vr([0,BFN.appRect.height]);Go(_e,[i]),Go(pe,[a,o,h]),cM("app");let I=hM(`(min-width: ${BFN.CSS.desktopAppMinWidth}px)`),{recalculateScrollPosition:_,scrollTo:E,handleScroll:D}=ke(Tb());return Go(()=>{_()},[y]),xb(()=>{t.querySelector(".search-box__input").value=a===r?"":a,E(0)},[a]),xb(()=>{T&&(t.querySelector(".search-box__input").focus(),x(!1))},[T]),I?w():N();function w(){return er`
        <panel-header .langId=${"stock_image_library"} .modifier=${"modal"} buttons=${"close"}></panel-header>
        <div class="modal__body stock-search__body">
            <div class="stock-search__left-panel">
                ${z()}
                <div class="stock-search__tags-container scrollable-content">
                    <panel-header .langId=${"popular_searches"} .modifier=${"modal-section"}></panel-header>
                    ${M()}
                </div>
                ${W()}
            </div>
            <div class="stock-search__right-panel">
                ${h==="no_results"?"":er`
                <div class="stock-search__results-header">
                    <h3 class="stock-search__results-heading">
                        ${Vo(a===r?"featured_images":["search_results_for",{query:`<strong>${BeFunky.escapeHTML(a)}</strong>`}])}
                    </h3>
                    ${a===r?"":er`
                    <button
                        @click=${he}
                        aria-label="Clear Results"
                        class="button button--circle button--white-outline button--icon button--xs stock-search__clear-results"
                        data-tooltip="cancel"
                    >
                        ${Uo("cancel-icon","icon icon--10")}
                    </button>
                    `}
                </div>
                `}
                <div class="scrollable-content scrollable-content--modal-right-panel" @scroll=${D} style=${`--scrollable-content-width: ${J()}px`}>
                    ${j()}
                </div>
            </div>
        </div>
        `}function N(){return er`
        <panel-header .langId=${"stock_image_library"} .modifier=${"modal"} buttons=${"close"}></panel-header>
        <div class="modal__body stock-search__body">
            <div style="padding: 1rem 1.5rem 0">
                ${z()}
            </div>
            <div class="stock-search__tags-container horizontal-scroller">
                ${M()}
            </div>
            <div class="vertical-scroller" @scroll=${D} style="padding: 0 1.5rem; flex-grow: 1">
                ${j()}
            </div>
            ${W()}
        </div>
        `}function M(){return er`
            <div @click=${re} class="stock-search__tags">
                ${["Wedding","Food","Portrait","Landscapes","Travel","Fine Art","Nature","Sky","Water","People","Sunset","Dogs","Cats"].map(Z=>er`<button class=${`stock-search__tag chip ${Z.toLowerCase()===a.toLowerCase()?"chip--selected":""}`}>${Z}</button>`)}
            </div>
            `}function z(){return er`
            <form role="search" class="search-box" @submit=${Be}>
                <input type="search" class="input search-box__input" .placeholder=${Vo("search_stock_images_placeholder",!0)} name="query" required>
                <button @click=${ne} aria-label="Clear Search" type="reset" class="button button--icon button--md button--white-outline search-box__clear">
                    ${Uo("cancel-icon","icon icon--12")}
                </button>
                <button aria-label="Search" type="submit" class="button button--icon button--white-outline button--md search-box__submit">
                    ${Uo("search-icon")}
                </button>
            </form>
            `}function W(){return er`<p class="stock-search__attribution">${Vo(["stock_image_services",{pexels:'<a href="https://pexels.com/?utm_source=befunky&utm_medium=referral" target="_blank" rel="noopener">Pexels</a>',pixabay:'<a href="https://pixabay.com/?utm_source=befunky&utm_medium=referral" target="_blank" rel="noopener">Pixabay</a>'}])}</p>`}function j(){let de=8;return er`
            <image-gallery
                class="gallery stock-search__results-gallery"
                .currentWidth=${J()}
                .isLoading=${p}
                .images=${d}
                .selectedImageIDs=${e}
                .onClickItem=${ie}
                .message=${U()}
                .emptyState=${{imageUrl:`${BFN.imagesURL}illustrations/no-search-results-canvas.svg`,text:BeFunky.LanguageManager.getStringReplacements("no_results_for",{query:`"<strong>${a}</strong>"`})}}
                .rowHeight=${Z()}
                .preserveOrder=${!1}
                .gutterWidth=${de}
                .borderWidth=${1}
                .extendItemTemplate=${k}
                .addItemClass=${({author:G,authorURL:L})=>G&&L?"gallery__item--has-content":""}
                .viewport=${b}
            ></image-gallery>`;function Z(){let G=J()-de;return Math.min(215,Math.round(G/2))}function U(){return p||h==="no_results"?"":h?{isError:!0,text:BeFunky.failureReason(h),buttonText:"try_again",buttonAction:()=>u()}:o<l&&o>=v?{buttonText:"load_more",buttonAction:()=>n(o+1)}:""}function k({id:G,author:L,authorURL:R}){if(!L||!R)return"";let A={pixabay:{name:"Pixabay",url:"https://pixabay.com/?utm_source=befunky&utm_medium=referral"},pexels:{name:"Pexels",url:"https://pexels.com/?utm_source=befunky&utm_medium=referral"}},{name:X,url:Y}=A[BFN.getImageType(G)];return er`
            <div class="stock-search__author gallery__item-content">
                <a href="${R}" @click=${le} target="_blank" rel="noopener">${L}</a> |
                <a href="${Y}" @click=${le} target="_blank" rel="noopener">${X}</a>
            </div>`}}function J(){let de=I?17*16:0,Z=24*2;return B-de-Z+(y-B)}function ie(de,{isSelected:Z}){if(BFN.ImageLibraryManager.mode==="UPLOAD_MENU"){t.isOpen=!1,BFN.PhotoEditorModel.confirmEditorLoadImage(()=>{BFN.ImageLibraryManager.addImageToPhotoEditorCanvas(de)},()=>{BFN.ImageLibraryManager.mode="UPLOAD_MENU",t.isOpen=!0});return}return BFN.ImageLibraryManager.handleImageSelection(de,Z)}function re(de){let Z=de.target;!Z||!Z.hasClass("stock-search__tag")||Ie(Z.textContent)}function he(){Ie(r),x(!0)}function ne(){I?x(!0):he()}function le(de){(parseFloat(getComputedStyle(de.target.parentElement).opacity)||0)<1?de.preventDefault():de.stopPropagation()}function Be(de){de&&de.preventDefault(),Ie(new FormData(de.target).get("query"))}function _e(){i?BeFunky.openModal(t,{onOpen:()=>{BeFunky.isAndroid||x(!0)},onClose:()=>{t.isOpen=!1,BFN.ImageLibraryManager.mode="IMAGE_MANAGER"},onWindowResize:de=>F(de.availableWidth),size:"xxl",isFullWidthOnMobile:!0}):BeFunky.closeModal(t.id,!1)}async function pe(){f.current++;let de=f.current;console.log("Load search results",{searchPage:o,searchQuery:a}),g(!0);try{let{data:Z,totalPages:U}=await BFN.ImageLibraryService.getStockImages(o,a);if(de!==f.current)return;m([...d,...Z]),c(U),_()}catch(Z){if(de!==f.current)return;u(Z)}g(!1)}function Ie(de){de=de.replace(/[`~!@#$%^&*()_|+=?;:'",.<>{}[\]\\/]/gi," ").replace(/ {2,}/g," ").trim(),de!==a&&(s(de),n(1),u(),m([]),c(0))}function ke(de){return de.current||(de.current=BeFunky.handleLitGalleryScroll()),de.current.setOnScrollCallback(Z),de.current;function Z({scrollHeight:U,offsetHeight:k,scrollTop:G}){let L=[G,G+k];if((!b||!b.isIdenticalTo(L))&&S(L),!(!p&&d.length&&o<l&&o<v))return;let A=800;U-k-G<=A&&n(o+1)}}}var{html:dM,icon:Xo,elem:Fb}=BeFunky.lit,bb=class{constructor(){this.init()}init(){this.initDefaultValues(),this.initSampleImages()}initDefaultValues(){this.selectedMenuImageVOs=[],this.sampleMenuImageVOs=[],BFN.IndexedDB.get("options__selectedMenuImageVOs").then(e=>{Array.isArray(e)&&e.reverse().forEach(t=>this.addImage(t,{useTracking:!1}))}).catch(e=>{BeFunky.logError("Unable to fetch previous session's selectedMenuImageVOs from IndexedDB",e)}),this.imageLibraryModal=null,this.stockSearchModal=null,this.updateImagesInSidebar=BeFunky.debounce(this.updateImagesInSidebar.bind(this),"raf"),this.initImageManagerButtons(),this._mode="IMAGE_MANAGER",this.updateImageStore=BeFunky.debounce(this.updateImageStore,0),this.trackAddImage=BeFunky.debounce(this.trackAddImage,1e3),this.trackRemoveImage=BeFunky.debounce(this.trackRemoveImage,1e3)}initSampleImages(){let e=[{name:"woman-yellow-bg",thumb:"woman-yellow-bg-thumb.jpg",image:"woman-yellow-bg-large.jpg"},{name:"pink-blue-doors-architecture",thumb:"pink-blue-doors-architecture-thumb.jpg",image:"pink-blue-doors-architecture-large.jpg"},{name:"bicycle-mural-wall",thumb:"bicycle-mural-wall-thumb.jpg",image:"bicycle-mural-wall-large.jpg"},{name:"man-sitting-desert",thumb:"man-sitting-desert-thumb.jpg",image:"man-sitting-desert-large.jpg"},{name:"wedding-couple-pink-wall",thumb:"wedding-couple-pink-wall-thumb.jpg",image:"wedding-couple-pink-wall-large.jpg"},{name:"dog-purple-bg",thumb:"dog-purple-bg-thumb.jpg",image:"dog-purple-bg-large.jpg"}];this.sampleMenuImageVOs=e.map(t=>{let r=new BFN.MenuImageVO;return r.name=t.name,r.createId("sample",t.name),r.thumbURL=`${BFN.imagesURL}app/image-manager/${t.thumb}?width=216`,r.thumbWidth=216,r.thumbHeight=216,r.imageURL=`${BFN.imagesURL}app/image-manager/${t.image}`,r.isSaved=!0,r.isRemovable=!1,r})}initImageManagerButtons(){this.removeUnusedButton=Fb`
        <button @click=${()=>this.removeUnused()} class="button button--icon button--grey-200" data-tooltip="remove_unused_tooltip" disabled>
            ${Xo("delete-icon","icon icon--18")}
        </button>`,this.updateRemoveUnusedButton=BeFunky.debounce(this.updateRemoveUnusedButton,100);let e=()=>{!BFN.AppModel.viewingCollage||this.updateRemoveUnusedButton()};BFN.GlobalHistoryModel.addEventListener(BFN.GlobalHistoryModelEvents.HISTORY_UPDATED.type,e),BFN.GlobalHistoryModel.addEventListener(BFN.GlobalHistoryModelEvents.HISTORY_ID_UPDATED.type,e),this.clearButton=Fb`
        <button @click=${()=>this.clearCanvas()} class="button button--icon button--grey-200" data-tooltip="clear_cells_tooltip">
            ${Xo("clear-collage-icon","icon icon--18")}
        </button>
        `,BFN.CollageMakerCanvasPhotoGridModel.addEventListener(BFN.CollageMakerCanvasPhotoGridModelEvents.FREEFORM_UPDATED.type,()=>{this.clearButton.disabled=!!BFN.CollageMakerCanvasPhotoGridModel.freeform})}setupImageLibraryModal(){this.imageLibraryModal||(this.imageLibraryModal=Lo({imageSelectionHandler:(e,{isSelected:t})=>(t&&BFN.getImageType(e.id)==="google_photos"&&this.mode==="IMAGE_MANAGER"&&(e.indexedDBKey=`image__${e.id}`,BeFunky.GooglePhotosManager.downloadGooglePhoto(e).then(([r,a])=>{this.selectedMenuImageVOs.find(({id:s})=>s===e.id)&&(this.updateImage(e.id,{thumbURL:r}),BFN.ProjectService.setLocalAsset("imagemanager","image",e.id,a))}).catch(r=>{BeFunky.throwError("Unable to download Google Photo",r)})),t&&BFN.getImageType(e.id)==="befunky_photo"&&this.mode==="IMAGE_MANAGER"&&BFN.RequestUtils.getBase64(e.thumbURL,({error:r,base64:a})=>{if(r)return BeFunky.throwError("Unable to download BeFunky Photo thumbnail",r);this.selectedMenuImageVOs.find(({id:s})=>s===e.id)&&this.updateImage(e.id,{thumbURL:a})}),this.mode==="UPLOAD_MENU"?(this.imageLibraryModal.close(),BFN.PhotoEditorModel.confirmEditorLoadImage(()=>{this.addImageToPhotoEditorCanvas(e)},()=>{this.mode="UPLOAD_MENU",this.imageLibraryModal.open()}),!1):this.handleImageSelection(e,t)),isSelected:e=>this.getIndex(e)!==-1,transformImageObject:e=>{let t=new BFN.MenuImageVO;t.setObject(e),e.getImageURL&&(t.getImageURL=e.getImageURL);let r=BFN.getImageType(t.id);return(r==="befunky_layer"||r==="befunky_photo")&&(t.isSaved=!0,!t.name&&e.title&&(t.name=e.title)),t},extendItemTemplate:e=>{let t=BFN.getImageType(e.id);if(t!=="befunky_layer"&&t!=="befunky_photo")return"";let r=s=>{s.stopPropagation(),this.deleteImage(e.id)},a=["gallery__item-content gallery__item-content--show-if-no-hover","button button--icon button--xs button--white-outline button--increase-area","image-library__button image-library__button--delete"].join(" ");return dM`<button @click=${r} class=${a} data-tooltip="delete">
                    ${Xo("delete-icon","icon icon--14")}
                </button>`},onClose:()=>{this.mode="IMAGE_MANAGER"}}))}openModal(e,t="IMAGE_MANAGER"){if(BeFunky.isInDemoMode()&&e!=="stock_images")return BeFunky.acknowledgeDemoMode();e==="stock_images"?(this.stockSearchModal||(Ho(),this.stockSearchModal=document.getElementById("stock_search_modal"),this.updateSelectedImagesInModals()),this.stockSearchModal.isOpen=!0):this.imageLibraryModal?this.imageLibraryModal.open(e):(this.setupImageLibraryModal(),this.imageLibraryModal.open(e||"befunky")),this.mode=t}uploadImages(e=null,t={}){let r=a=>{this.handleImageLoaded(a),e&&e(a)};BFN.MultipleFileUploader.upload(r,t)}addImage(e,{cloneObject:t=!0,index:r=0,updateImageGalleryItem:a=!0,useTracking:s=!0}={}){if(!e.id)throw"MenuImageVO missing id";if(this.getIndex(e.id)!==-1)return;!t&&!(e instanceof BFN.MenuImageVO)&&(t=!0,BeFunky.throwError("MenuImageVO cloning forced on plain object",e));let o;if(t?(o=new BFN.MenuImageVO,o.setObject(e)):o=e,this.selectedMenuImageVOs.splice(r,0,o),e.indexedDBKey){let n=e.isSVG?"svg":"image";BFN.ProjectService.setLocalAsset("imagemanager",n,e.id,void 0,!0)}this.updateImagesInSidebar(),a&&this.updateSelectedImagesInModals(),this.updateImageStore(),this.updateRemoveUnusedButton(),s&&this.trackAddImage()}updateImage(e,t,r=!1){let a=this.getIndex(e);if(a===-1)return;let s=this.selectedMenuImageVOs[a];Object.assign(s,t),r&&a!==0&&(this.selectedMenuImageVOs.splice(a,1),this.selectedMenuImageVOs.unshift(s),this.updateImagesInSidebar()),this.updateImageStore()}removeImage(e,{updateImageGalleryItem:t=!0,usedBaseTextures:r}={}){let a=this.getIndex(e);if(a===-1)return;r||(r=BFN.GlobalHistoryModel.getUsedBaseTextures());let s=this.selectedMenuImageVOs[a];s.imageTexture&&s.imageTexture.valid&&s.imageTexture.baseTexture&&!r.includes(s.imageTexture.baseTexture)&&(s.imageTexture.destroyGC(!0),s.imageTexture=null),this.selectedMenuImageVOs.splice(a,1);let o=s.isSVG?"svg":"image";BFN.ProjectService.removeLocalAsset("imagemanager",o,e),this.updateImagesInSidebar(),t&&this.updateSelectedImagesInModals(),this.updateImageStore(),this.updateRemoveUnusedButton(),this.trackRemoveImage()}updateSelectedImagesInModals(){this.stockSearchModal&&(this.stockSearchModal.selectedImageIds=this.mode==="UPLOAD_MENU"?void 0:BFN.ImageLibraryManager.selectedMenuImageVOs.filter(e=>["pixabay","pexels"].includes(BFN.getImageType(e.id))).map(e=>e.id)),this.imageLibraryModal&&this.imageLibraryModal.updateSelectedItems()}trackAddImage(){let e=BFN.AppModel.sectionValue("PHOTOEDITOR","COLLAGE","DESIGNER");BFN.BfnService.track("CREATE",e,"ADD_PHOTOS")}trackRemoveImage(){let e=BFN.AppModel.sectionValue("PHOTOEDITOR","COLLAGE","DESIGNER");BFN.BfnService.track("CREATE",e,"DELETEITEM_BASKET")}getIndex(e){return this.selectedMenuImageVOs.findIndex(t=>t.id===e)}getSampleIndex(e){return this.sampleMenuImageVOs.findIndex(t=>t.id===e)}getMenuImageVO(e){return(BFN.getImageType(e)==="sample"?this.sampleMenuImageVOs:this.selectedMenuImageVOs).find(r=>r.id===e)}updateImagesInSidebar(){BFN.secondaryMenu?BFN.secondaryMenu.selectedImages=this.selectedMenuImageVOs.slice():window.addEventListener("INIT_COMPLETE",this.updateImagesInSidebar.bind(this))}updateImageStore(){let e=this.selectedMenuImageVOs.map(t=>t.getObject());e.length||BFN.ProjectService.clearLocalAssets("imagemanager"),BFN.IndexedDB.set("options__selectedMenuImageVOs",e).catch(t=>BeFunky.logError("Unable to update selectedMenuImageVOs in IndexedDB",t))}autofill(){let e=this.selectedMenuImageVOs.length?this.selectedMenuImageVOs:this.sampleMenuImageVOs;BFN.CollageMakerCanvasPhotoGrid.autoFill(e);try{BFN.BfnService.track("CREATE","COLLAGE","AUTOFILL")}catch(t){}}clearCanvas(){BFN.CollageMakerHistoryModel.ignoreSnapshot=!0,BFN.PhotoGrid.clearAllGridChildren(),BFN.CollageMakerHistoryModel.ignoreSnapshot=!1,BFN.CollageMakerHistoryModel.historyAction="cells_cleared",BFN.PhotoGrid.getPhotoGridSnapShot();try{BFN.BfnService.track("CREATE","COLLAGE","CLEARALL")}catch(e){}}removeUnused(){let e=BFN.PhotoGrid.getGridMenuImageVOs().map(({id:a})=>a),t=this.selectedMenuImageVOs.map(({id:a})=>a).filter(a=>!e.includes(a)),r=()=>{let a=BFN.GlobalHistoryModel.getUsedBaseTextures();t.map(s=>this.removeImage(s,{usedBaseTextures:a}))};BeFunky.confirm("confirm_remove_unused_images",{onConfirm:r,confirmText:"yes",cancelText:"no"});try{BFN.BfnService.track("CREATE","COLLAGE","CLEAR_BASKET")}catch(a){}}updateRemoveUnusedButton(){if(!BFN.PhotoGrid)return;let e=BFN.PhotoGrid.getGridMenuImageVOs().map(t=>t.id);this.removeUnusedButton.disabled=!this.selectedMenuImageVOs.find(({id:t})=>!e.includes(t))}addImageToPhotoEditorCanvas(e){let t=BFN.getImageType(e.id);BFN.BfnService.ToJsUrlUploader(e.imageURL,"",t),BFN.ImageLibraryService.trackImageDownload(t,e.imageURL),[this.imageLibraryModal,this.stockSearchModal].filter(Boolean).map(a=>a.id).forEach(a=>BeFunky.closeModal(a,!1))}createMenuImageVOFromTexture(e,t=null,r=!0){let a=new BFN.MenuImageVO;a.createId("computer"),a.imageTexture=e;let{thumbSize:s}=BFN.MultipleFileUploader,o=e.width/e.height,n=s*(o>1?o:1/o),l=BFN.Util.getThumbTexture(e,n,!1,!0),c=l.renderClone();c.destroyGC(!0),c=null;let h=BFN.Util.isTransparent(l);a.isTransparent=h,a.thumbURL=BFN.TextureUtils.textureToBase64(l,{isTransparent:h}),a.thumbWidth=l.width,a.thumbHeight=l.height,l.destroyGC(!0),l=null;let u;h?(u=!0,a.imageTexture.isTransparent=!0):u=a.imageTexture.determineTransparency(),a.indexedDBKey=`image__${a.id}`;let d=e.renderClone();return requestAnimationFrame(()=>{BFN.TextureUtils.textureToBlob(d,{isTransparent:u}).then(m=>(d.destroyGC(!0),d=null,BFN.IndexedDB.set(a.indexedDBKey,m))).catch(m=>{d!==null&&(d.destroyGC(!0),d=null),BeFunky.logError("Failed to create Blob or store it in IDB",m),a.indexedDBKey=null}).then(()=>{t&&t()})}),r&&BFN.ImageLibraryManager.addImage(a,{cloneObject:!1}),a}async addImageToCanvas(e,{hasTexture:t=!1,initialCenterPosition:r,isGoodie:a=!1,forceLayer:s=!1}={}){let o=BFN.AppModel.sectionValue(BFN.PhotoEditorCanvasModel,BFN.CollageMakerCanvasModel,BFN.DesignerCanvasModel),{sectionID:n}=BFN.AppModel;if(e.isSVG&&(a=!0),BFN.TransformModel.awaitingDrop=!1,BFN.TransformModel.focusedTransformItem&&!s&&(BFN.TransformModel.targetTransformItem=BFN.TransformModel.focusedTransformItem,BFN.TransformModel.focusedTransformItem=null),BFN.AppModel.viewingCollage&&!s&&!BFN.CollageMakerCanvasPhotoGridModel.freeform){if(BFN.PhotoGrid.awaitingDrop)if(BFN.PhotoGrid.awaitingDrop=!1,BFN.PhotoGrid.focusedChild)BFN.PhotoGrid.focusedChild.handleDrop(),BFN.PhotoGrid.targetChild=BFN.PhotoGrid.selectedChild,BFN.PhotoGrid.selectedChild=null;else{if(!r)return;let c=BFN.PhotoGrid.getChildUnderPosition(r.x,r.y);if(!c)return;BFN.PhotoGrid.targetChild=c}else if(BFN.PhotoGrid.targetChild||(BFN.PhotoGrid.targetChild=BFN.PhotoGrid.randomEmptyChild),!BFN.PhotoGrid.targetChild)return}if(!t){let c={saveAssetsSectionID:n};if(await BFN.BfnService.getTexturesForMenuImageVOs([e],c),!e.imageTexture)return}try{await BeFunky.withLoadScreen(BFN.ProjectService.saveLocalAssetForMenuImageVO(e,n))}catch(c){BeFunky.logError("Failed to store Blob for MenuImageVO",c,e);return}let{targetTransformItem:l}=BFN.TransformModel;if(l&&!e.isSVG&&(!l.hasDropOptions||l.hasDropOptions))this.replaceTransformItemOnCanvas(l,e);else if(BFN.AppModel.viewingCollage&&!s&&BFN.PhotoGrid.targetChild){let c=new BFN.UserActionVO;c.eventID="collage_grid_image_added",c.eventObject={cellImageTypes:[e.isSVG?"Vector":"Rasterized"],cellImageSources:[BFN.UserActionManager.getAssetOrigin(e.id)]},c.actionSection="collage",c.actionTimestamp=Date.now(),c.register(),BFN.CollageMakerCanvasPhotoGrid.assignImageToTargetGridChild(e)}else{let h={type:!a&&!e.isSVG?"frame_texture":"texture",texture:e.imageTexture,projectItemAssetID:e.id};a&&(h.isGoodie=!0,h.graphicStyle=e.style),r&&(h.initialCenterPosition=r),o.addedItem=h}}async replaceTransformItemOnCanvas(e,t){let r=BFN.AppModel.sectionValue(BFN.PhotoEditorCanvas,BFN.CollageMakerCanvas,BFN.DesignerCanvas),a=BFN.AppModel.sectionValue(BFN.PhotoEditorCanvasModel,BFN.CollageMakerCanvasModel,BFN.DesignerCanvasModel),s="convert_to_image",o=s+BeFunky.randomString(10),n=["layerName","transformZIndex","transformX","transformY","transformRotation"],l=null,c=null,h=()=>{BFN.TransformStateModel.startBulkTransition(o),l=new BFN.ProjectItemVO,n.forEach(m=>{l.hasOwnProperty(m)&&e.projectItemVO.hasOwnProperty(m)&&(l[m]=e.projectItemVO[m])}),e.projectItemVO.dropShadowValues&&(l.dropShadowValues=Object.assign({},e.projectItemVO.dropShadowValues))},u=(m=[])=>{m.forEach(p=>{try{p.destroyGC(!0)}catch(g){}}),BFN.TransformStateModel.stopBulkTransition(),BFN.TransformStateModel.safeThumbImages.splice(0),BFN.TransformModel.targetTransformItem=null,BFN.MainUI.rendering=!0,BeFunky.hideLoadScreen(),BFN.MainUI.requestRender()},d=()=>{if(l&&c&&BFN.TransformStateModel.batchTransitionID===o){let m=T=>{BFN.TransformStateModel.safeThumbImages.splice(0),BFN.MainUI.rendering=!0,r.transformLayer.selectItem(T),BeFunky.hideLoadScreen(),BFN.MainUI.requestRender();let x=new BFN.UserActionVO;x.eventID="image_layer_added",x.eventObject={imageLayerTypes:["Rasterized"],imageLayerSources:[T.assetOrigin]},x.actionSection=BFN.AppModel.sectionID,x.actionTimestamp=Date.now(),x.transformItem=T,x.register();let B=e.type==="text"?"Text":e.isShape?e.basicShapeVO?"Basic Shape":"Vector":"Rasterized",y=new BFN.UserActionVO;y.eventID="image_layer_masked",y.eventObject={imageLayerMaskedTypes:[B],imageLayerMaskedSources:[e.type==="text"?"Text":e.assetOrigin]},y.actionSection=BFN.AppModel.sectionID,y.actionTimestamp=Date.now(),y.transformItem=e,y.register()};e.type==="texture"&&e.isShape&&(e.basicShapeVO&&e.basicShapeVO.isSolidRectangle||(c.readyCallback=()=>{BFN.MainUI.addIdleRenderFunction(m)})),BeFunky.showLoadScreen({isCancellable:!1}),BFN.MainUI.rendering=!1,BFN.TransformStateModel.safeBaseTextures.includes(t.imageTexture.baseTexture)||BFN.TransformStateModel.safeBaseTextures.push(t.imageTexture.baseTexture),BFN.SentryManager.reportBreadcrumb(BFN.SentryManager.getDisplayObjectInfo(e,!0),"swap_layer_old","app_action"),e.removeItem(),l.type="mask_image",e.projectItemVO.graphicStyle&&(c.graphicStyle=e.projectItemVO.graphicStyle,l.graphicStyle=e.projectItemVO.graphicStyle),l.maskImageOffsetFactorX=.5,l.maskImageOffsetFactorY=.5,l.maskImageTextureScale={x:1,y:1},l.transformScaleX=1,l.transformScaleY=1,l.maskImageMaskFlippedHorizontal=e.projectItemVO.transformFlippedHorizontal||e.projectItemVO.maskImageMaskFlippedHorizontal,l.maskImageMaskFlippedVertical=e.projectItemVO.transformFlippedVertical||e.projectItemVO.maskImageMaskFlippedVertical,c.projectItemVO=l,BFN.TransformModel.selectItemOnAdd=!1,a.addedItem=c,BFN.TransformModel.selectItemOnAdd=!0;let{addedTransformItem:p}=BFN.TransformModel;e.projectItemVO.layerName&&(p.layerName=e.projectItemVO.layerName),BFN.GroupManager.getGroupVOsFromItemIDs([e.itemID]).forEach(T=>{BFN.GroupManager.addItemsToGroup(T.id,[p.itemID])}),p.updateThumb();let f=new BFN.TransformItemStateVO;f.imageTexture=p.itemContent.texture,f.parent=r.transformLayer,BFN.ProjectManager.transferProperties(l,f),p.applyTransformItemState(f),p.createTransition("apply_transform_item_state"),p.registerTransition(!0,!1),p.ignoreAccurateBounds=!1,p.updateAccurateBounds(),BFN.TransformStateModel.stopBulkTransition(),BFN.SentryManager.reportBreadcrumb(BFN.SentryManager.getDisplayObjectInfo(p,!0),"swap_layer_new","app_action");let v=new BFN.TransformItemTransitionVO;v.id=s,v.batchIDPlaceholder=o,v.transformItem=e.type==="text"?null:e,v.useTextIcon=e.type==="text",BFN.TransformStateModel.addTransition(v),BFN.TransformStateModel.safeBaseTextures.splice(0),p.readyCallback||m(p)}};if(e.thumbImage&&e.thumbImage.src&&!BFN.TransformStateModel.safeThumbImages.includes(e.thumbImage)&&BFN.TransformStateModel.safeThumbImages.push(e.thumbImage),e.type==="frame_texture"){let m=()=>{e.itemContentMask?e.replaceImage({_imageID:t.id,_imageTexture:t.imageTexture,_maintainFlipState:!0}):e.replaceImage({_imageID:t.id,_imageTexture:t.imageTexture})};if(e.isShape||e.itemContentMask)m();else{if(e.isTransparent){let p=async()=>{BeFunky.showLoadScreen({isCancellable:!1}),h(),l.maskImageID=t.id,l.maskImageFrameWidth=e.itemContentW*e.scale.x,l.maskImageFrameHeight=e.itemContentH*e.scale.y,c={type:"frame_texture",texture:t.imageTexture};let g=new PIXI.Texture(e.itemContent.texture.baseTexture);g.frame=e.itemContent.texture.frame;let f=PIXI.RenderTexture.create(Math.round(g.frame.width),Math.round(g.frame.height));f.fillColor(0);let v=new PIXI.Sprite(g);v.pluginName="blend_picture",v.fillColor=16777215,v.intensity=1,v.width=f.width,v.height=f.height,BFN.Stage.render(v,f,!1),v.destroy(!1);try{let T=await BFN.TextureUtils.textureToBlob(f,{isTransparent:!1}),x=new BFN.MenuImageVO().createId("alpha_mask");await BFN.ProjectService.setLocalAsset("editor","image",x,T),l.maskImageMaskID=x,c.maskTexture=f,d()}catch(T){BeFunky.reportWarning(`Failed to convert mask texture to Blob and store it: ${T}`,T),u([f])}};return BeFunky.openDialog({body:"replace_or_mask",buttons:[{text:"replace_image",type:"blue",onClick:m},{text:"use_as_mask",type:"blue",onClick:p}],modalOptions:{closeOnClickOutside:!0,onClose:()=>{BFN.TransformModel.targetTransformItem=null,BFN.TransformModel.focusedTransformItem=null}}})}m()}}else if(e.type==="texture")if(e.isShape){if(h(),l.maskImageID=t.id,l.maskImageMaskID=e.projectItemVO.graphicID,l.maskImageFrameWidth=e.itemContentW*e.scale.x,l.maskImageFrameHeight=e.itemContentH*e.scale.y,c={type:"frame_texture",texture:t.imageTexture},e.basicShapeVO&&e.basicShapeVO.isSolidRectangle||(c.maskTexture=new PIXI.Texture(e.itemContent.texture.baseTexture),c.newShape=!0),e.basicShapeVO&&!e.basicShapeVO.isSolidRectangle){let m=e.basicShapeVO.clone();m.convertToMaskValues(),delete c.newShape,c.maskTexture=PIXI.RenderTexture.create(32,32),c.basicShapeVO=m}d()}else if(h(),l.maskImageID=t.id,l.maskImageFrameWidth=e.itemContentW*e.scale.x,l.maskImageFrameHeight=e.itemContentH*e.scale.y,c={type:"frame_texture",texture:t.imageTexture},e.isTransparent){BeFunky.showLoadScreen({isCancellable:!1});let m=PIXI.RenderTexture.create(e.itemContent.texture.baseTexture.width,e.itemContent.texture.baseTexture.height);m.fillColor(0);let p=new PIXI.Sprite(e.itemContent.texture);p.pluginName="blend_picture",p.fillColor=16777215,p.intensity=1,BFN.Stage.render(p,m,!1),p.destroy(!1);try{let g=await BFN.TextureUtils.textureToBlob(m,{isTransparent:!1}),f=new BFN.MenuImageVO().createId("alpha_mask");await BFN.ProjectService.setLocalAsset("editor","image",f,g),l.maskImageMaskID=f,c.maskTexture=m,d()}catch(g){BeFunky.reportWarning(`Failed to convert alpha mask texture to Blob and store it: ${g}`,g),u([m])}}else d();else if(e.type==="text"){if(BFN.FabricManager.isDefaultText(e.iText.text))return;BeFunky.showLoadScreen({isCancellable:!1}),e.getITextMask(async m=>{let p=m.boundsRect,g=m.maskTexture;try{let f=await BFN.TextureUtils.textureToBlob(g,{isTransparent:!1,mimeType:"image/jpeg",quality:.5}),v=new BFN.MenuImageVO().createId("text_mask");await BFN.ProjectService.setLocalAsset("editor","image",v,f),h(),l.maskImageID=t.id,l.maskImageMaskID=v,l.maskImageFrameWidth=p.width,l.maskImageFrameHeight=p.height;let T=[0,1,3,2][(e.flippedHorizontal?1:0)+(e.flippedVertical?2:0)],x=r.transformLayer.toLocal(e.textPolygon[T],e),B=new PIXI.Point(x.x,x.y);e.flippedHorizontal&&(B.x-=Math.cos(l.transformRotation)*p.width,B.y-=Math.sin(l.transformRotation)*p.width),e.flippedVertical&&(B.x-=Math.cos(l.transformRotation+Math.PI/2)*p.height,B.y-=Math.sin(l.transformRotation+Math.PI/2)*p.height);let y=p.x*(e.flippedHorizontal?-1:1),F=p.y*(e.flippedVertical?-1:1),b=Math.sqrt(y**2+F**2),S=Math.atan2(F,y);B.x+=Math.cos(l.transformRotation+S)*b,B.y+=Math.sin(l.transformRotation+S)*b,l.transformX=B.x,l.transformY=B.y,c={type:"frame_texture",texture:t.imageTexture,maskTexture:g},d(!0)}catch(f){BeFunky.reportWarning(`Failed to convert iText texture to Blob and store it: ${f}`,f),u([g])}})}l||BFN.TransformStateModel.safeThumbImages.splice(0),BFN.TransformModel.targetTransformItem=null}saveImageAsLayer(e){if(e.isSaved){BeFunky.logError("Sorry, this image is already saved");return}if(!BFN.BfnService.userLoggedIn){let t=()=>{BFN.BfnService.removeEventListener(BFN.BfnServiceEvents.USER_DATA_CHANGED.type,t),BFN.BfnService.userLoggedIn&&this.saveImageAsLayer(e)};BeFunky.confirm("confirm_layer_save_login",{onConfirm:()=>{BFN.BfnService.addEventListener(BFN.BfnServiceEvents.USER_DATA_CHANGED.type,t),BFN.BfnService.login(),setTimeout(()=>BFN.BfnService.removeEventListener(BFN.BfnServiceEvents.USER_DATA_CHANGED.type,t),1e4)},confirmText:"yes",cancelText:"no"});return}BFN.BfnService.getTexturesForMenuImageVOs([e]).then(()=>{if(!e.imageTexture)return;BFN.UploadSaveShareManager.altSaveTexture=e.imageTexture;let t=e.name||"";BFN.UploadSaveShareManager.setFileName(void 0,"layer",t),BFN.UploadSaveShareManager.openSaveOrShareImageModal("befunky",{onSave:()=>{e.isSaved=!0,this.updateImageStore(),this.updateImagesInSidebar(),BeFunky.ImagesService.resetImageData()}})})}deleteImage(e){let t=BFN.getImageType(e);if(!["befunky_photo","befunky_layer"].includes(t)){BeFunky.logError("Only BeFunky Photos & Layers can be deleted");return}let r=e.replace(`${t}_`,""),a=t==="befunky_photo";BeFunky.confirm(a?"confirm_delete_befunky_photo":"confirm_delete_befunky_layer",{onConfirm:()=>{BFN.ImageLibraryService.deleteBeFunkyPhoto.bind(BFN.ImageLibraryService)(r,{showLoadScreen:{isCancellable:!1}}).then(()=>{this.removeImage(e);let o=this.imageLibraryModal.getGallery("befunky");o.images=o.images.filter(({id:n})=>n!==e),UIMessages.display("deleted"),BeFunky.ImagesService.resetImageData()}).catch(o=>{BeFunky.logError(`Unable to delete ${a?"photo":"layer"}`,o)})},confirmText:"yes",cancelText:"no",imageUrl:`${BeFunky.Params.globalImagesPath}illustrations/photo-project-shredder.svg`})}modifier(e){return e.replace(/[^0-9a-z-]/gi,"-").replace(/-{2,}/g,"-").replace(/^-|-$/g,"").toLowerCase()}handleImageSelection(e,t){return t?this.addImage(e):this.removeImage(e.id),!0}handleImageLoaded({menuImageVO:e,file:t,isComplete:r}){let a=null,s=null;switch(BFN.AppModel.viewState){case BFN.AppModelViewStates.VIEWING_PHOTO_EDITOR:a=BFN.PhotoEditorCanvasModel,s="editor_main";break;case BFN.AppModelViewStates.VIEWING_COLLAGE_MAKER:a=BFN.CollageMakerCanvasModel,s="collage_main";break;case BFN.AppModelViewStates.VIEWING_DESIGNER:a=BFN.DesignerCanvasModel,s="designer_main";break}if(!!a){if(r){UITools.getToolValue(s,"updating_id")!=="image_manager"&&(UITools.setToolValue(s,"image_manager",!0),UITools.applyTool(s),UITools.setToolValue(s,"image_manager",!1));return}!e||this.addImage(e,{updateImageGalleryItem:!1,scrollToBottom:!1})}}set mode(e){if(!e||!["IMAGE_MANAGER","UPLOAD_MENU"].includes(e)){BeFunky.logError("Invalid Image Library Manager mode specified");return}e!==this._mode&&(this._mode=e,this.updateSelectedImagesInModals())}get mode(){return this._mode}get bucketBaseTextures(){let e=this.sampleMenuImageVOs.concat(this.selectedMenuImageVOs),t=[];for(let r=0;r<e.length;r++){let a=e[r];a.imageTexture&&a.imageTexture.valid&&a.imageTexture.baseTexture&&(a.imageTexture.baseTexture._destroyed?(a.imageTexture.destroyGC(!0),a.imageTexture=null):t.push(a.imageTexture.baseTexture))}return e.splice(0),e=null,t}};BFN.SingletonQueue.add(()=>{BFN.ImageLibraryManager=new bb});var{html:mM,lang:Bb,elem:Sb}=BeFunky.lit;function zo(i,e,t,r,a){let s=BeFunky.isWiderThanMobile()?1300:a,o=r,n=i.map(({tagID:d,graphicData:m})=>h(d,m));u(a,r);let l=Sb`<div class="graphics-editors-choice">${c()}</div>`;return l.updateGalleries=u,l;function c(){return i.map(({title:d,tagID:m},p)=>mM`
            <div class="graphics-editors-choice__row">
                <div class="graphics-editors-choice__row-header">
                    <p class="graphics-editors-choice__row-heading">${Bb(d,"modal")}</p>
                    <button class="button button--link button--sm graphics-editors-choice__see-all" @click=${()=>e({tagID:m,style:o})}>${Bb("view_all","modal")}</button>
                </div>
                ${n[p]}
            </div>
        `)}function h(){let d=BFN.GraphicLibraryManager.selectedGraphics.map(p=>p.id),m=8;return Sb`<image-gallery
            class="graphic-library__results-gallery"
            .rowHeight=${BeFunky.isWiderThanMobile()?120:72}
            .currentWidth=${s}
            .onClickItem=${BFN.GraphicLibraryManager.handleGraphicSelection.bind(BFN.GraphicLibraryManager)}
            .extendItemTemplate=${t}
            .selectedImageIDs=${d}
            .imagePadding=${16}
            .gutterWidth=${m}
            .singleRow=${!0}
        ></image-gallery>`}function u(d,m){s=BeFunky.isWiderThanMobile()?1300:d,o=m;let p=BFN.GraphicLibraryManager.selectedGraphics.map(g=>g.id);n.forEach((g,f)=>{let v=i[f].graphicData;g.images=v[m].slice(0,Math.round(10*(d/s))),g.rowHeight=BeFunky.isWiderThanMobile()?120:72,g.currentWidth=d,g.selectedImageIDs=p})}}var{html:ri,setupState:pM,render:fM,lang:xi,elem:_s,icon:Cs}=BeFunky.lit;function Wo(i){let e=_s`<div id="graphic_library" class="modal modal--button-sm graphic-library"></div>`,t=1600,r=G(),a={mode:"EDITORS_CHOICE",placeholderTags:[],editorsChoiceGraphics:{},searchTerm:"",tagName:"",tagID:"editors_choice",lastSearchTerm:"",lastSearchStyle:"",lastSearchPage:"",searchStyle:"all",currentWidth:t,displayMobileFilters:!1},s=BeFunky.debounce(()=>{let R=BeFunky.isWiderThanMobile()?T():x();fM(R,e)},"raf"),[o,n]=pM(a,s),{recalculateScrollPosition:l,handleScroll:c,setOnScrollCallback:h,scrollTo:u}=BeFunky.handleLitGalleryScroll(),d=()=>{};h(_e);let m,p=z(),[g,f]=I();BeFunky.onMatchMedia(`(min-width: ${BFN.CSS.desktopAppMinWidth}px)`,()=>{s()});let v=null;return p.images=[],BeFunky.LanguageManager.addLanguageUpdateListener(()=>{m=!1,s()}),Object.assign(e,{open:pe,updateSelectedGraphics:U}),e;function T(){return ri`
        <div class="graphic-preview"></div>
        ${b()}
        <div class="modal__body graphic-library__body">
            <div class="graphic-library__left-panel">
                ${S()}
                <div class="graphic-library__left-panel-options scrollable-content">
                    ${E()}
                    ${_()}
                     <div class="panel-header panel-header--modal-section graphic-library__tags-header">
                        <h3 class="panel-header__text panel-header__text--modal-section panel-header__text--wide">${xi("popular_tags")}</h3>
                    </div>
                    <div class="graphic-library__tags-container scrollable-content">
                        ${D()}
                    </div>
                </div>
            </div>
            <div class="graphic-library__right-panel">
                ${w()}
                <div class="scrollable-content scrollable-content--modal-right-panel" @scroll=${c} style=${`--scrollable-content-width: ${L()}px`}>
                    ${o.mode==="EDITORS_CHOICE"?M():p}
                </div>
            </div>
        </div>
        `}function x(){return ri`
        ${o.displayMobileFilters?y():b()}
        <div class="modal__body graphic-library__body">
           ${o.displayMobileFilters?F():B()}
        </div>
        `}function B(){let R=o.searchStyle!=="all"?"graphic-library__filter-button button button--grey-200 button--selected button--grey-outline button--md button--icon":"graphic-library__filter-button button button--grey-200 button--md button--icon";return ri`
            <div class="graphic-library__mobile-search-options" style="padding: 1rem 2rem 0">
                ${S()}
                <button class=${R} @click=${le}>
                    ${Cs("edit-icon","icon icon--18")}
                    ${o.searchStyle!=="all"?ri`<span class="count-indicator">1</span>`:""}
                </button>
            </div>
            <div class="graphic-library__tags-container horizontal-scroller">
                ${D()}
            </div>
            <div class="vertical-scroller" @scroll=${c} style="padding: 0 2rem; flex-grow: 1">
                ${o.mode==="EDITORS_CHOICE"?M():p}
            </div>
        `}function y(){return ri`<panel-header .langId=${"filters"} .modifier=${"modal"} .buttons=${"close"} @CLOSE=${le}></panel-header>`}function F(){let R="button button--grey-200 button--left-align button--fullwidth graphic-library__style button--selected";return ri`
        <div class="graphic-library__styles-container">
            <div class="graphic-library__styles">
            <button class="${o.searchStyle==="all"?R:"button button--grey-200 button--left-align button--fullwidth graphic-library__style"}" @click=${ne("all")}>${xi("all_graphic_styles")}</button>
            <button class="${o.searchStyle==="line"?R:"button button--grey-200 button--left-align button--fullwidth graphic-library__style"}" @click=${ne("line")}>${xi("outline")}</button>
            <button class="${o.searchStyle==="solid"?R:"button button--grey-200 button--left-align button--fullwidth graphic-library__style"}" @click=${ne("solid")}>${xi("solid")}</button>
            <button class="${o.searchStyle==="color"?R:"button button--grey-200 button--left-align button--fullwidth graphic-library__style"}" @click=${ne("color")}>${xi("multicolor")}</button>
        </div>
        `}function b(){return ri`<panel-header .langId=${"graphic_library"} .modifier=${"modal"} .buttons=${"close"}></panel-header>`}function S(){return ri`
            <form role="search" class="search-box graphic-library__search-box">
                ${g}
                ${f}
                <button type="reset" class="button button--icon button--md button--white-outline search-box__clear" @click=${Be}>
                    ${Cs("cancel-icon","icon icon--12")}
                </button>
                <button type="submit" class="button button--icon button--md button--white-outline search-box__submit" @click="${j}">
                    ${Cs("search-icon","icon")}
                </button>
            </form>
        `}function I(){let R=_s`<input type="search" class="input search-box__input graphics-library__search-input" required>`,A=_s`<div class="graphics-library__search-autocomplete"></div>`;return R.setLang("search_graphics","modal"),BeFunky.autocomplete(A,{inputElement:R,minValueLength:3,allowEmpty:!0,generateItem:X=>({html:X.length&&X!=="all_items"?BeFunky.LanguageManager.getStringReplacements("search_for",{query:BeFunky.escapeHTML(X)}):BeFunky.LanguageManager.getString("display_all_graphics"),index:0}),options:i.map(X=>({id:X,label:de(X)})),onSelect:({id:X,label:Y})=>Ie({tagID:X,tagName:Y})}),[R,A]}function _(){let R="button button--grey-200 button--left-align button--fullwidth graphic-library__style button--selected";return ri`
        <div class="graphic-library__styles-container">
            <div class="panel-header">
                <h3 class="panel-header__text panel-header__text--modal-section panel-header__text--wide">${xi("style")}</h3>
            </div>
            <div class="graphic-library__styles">
                <button class="${o.searchStyle==="all"?R:"button button--grey-200 button--left-align button--fullwidth graphic-library__style"}" @click=${ne("all")}>${xi("all_graphic_styles")}</button>
                <button class="${o.searchStyle==="line"?R:"button button--grey-200 button--left-align button--fullwidth graphic-library__style"}" @click=${ne("line")}>${xi("outline")}</button>
                <button class="${o.searchStyle==="solid"?R:"button button--grey-200 button--left-align button--fullwidth graphic-library__style"}" @click=${ne("solid")}>${xi("solid")}</button>
                <button class="${o.searchStyle==="color"?R:"button button--grey-200 button--left-align button--fullwidth graphic-library__style"}" @click=${ne("color")}>${xi("multicolor")}</button>
            </div
        </div>
        `}function E(){return ri`
        <div class="graphic-library__editors-choice-buttons-container">
            <button
            class="${`button button--grey-200 button--left-align button--fullwidth graphic-library__button ${o.mode==="EDITORS_CHOICE"?"button--selected":""}`}" @click=${re}
            >${xi("editors_choice","modal")}
            </button>
            <button
            class="${`button button--grey-200 button--left-align button--fullwidth graphic-library__button ${o.mode==="ALL_GRAPHICS"?"button--selected":""}`}" @click=${ie}
            >${xi("browse_all_graphics","modal")}
            </button>
        </div>
        `}function D(){let R="chip chip--selected graphic-library__tag";return ri`
            <div class="graphic-library__tags">
                ${r.map(A=>ri`<button class=${o.searchTerm===A?R:"chip graphic-library__tag"} @click="${he(A)}">${de(A)}</button>`)}
            </div>
        `}function w(){let R={EDITORS_CHOICE:"editors_choice",SEARCH:["search_results_for",{query:`<strong>${BeFunky.escapeHTML(o.tagName)}</strong>`}],TAG:o.tagName,ALL_GRAPHICS:"all_graphics"},A=o.mode==="SEARCH";return R[o.mode]||BeFunky.throwError("Mode not handled!!!",o.mode),ri`
            <div class="graphic-library__results-header">
                <h3 class="graphic-library__results-heading">${xi(R[o.mode],"modal")}</h3>
                ${A?N():""}
            </div>
        `}function N(){return ri`
            <button class="button button--circle button--white-outline button--icon button--xs graphic-library__clear-results" @click=${J} data-tooltip="cancel">
                ${Cs("cancel-icon","icon icon--10")}
            </button>
        `}function M(){return o.editorsChoiceGraphics.length?(m?m.updateGalleries(L(),o.searchStyle):m=zo(o.editorsChoiceGraphics,Ie,ke,o.searchStyle,L()),m):ri`
            <div class="editors-choice editors-choice--loading">
                <div><span class="loading-spinner"></span> <string>${xi("loading","modal")}</string></div>
            </div>
            `}function z(){let R=BFN.GraphicLibraryManager.selectedGraphics.map(X=>X.id),A=8;return _s`<image-gallery
            class="graphic-library__results-gallery"
            .rowHeight=${W(L(),A,120)}
            .currentWidth=${L()}
            .onClickItem=${BFN.GraphicLibraryManager.handleGraphicSelection.bind(BFN.GraphicLibraryManager)}
            .extendItemTemplate=${ke}
            .selectedImageIDs=${R}
            .imagePadding=${16}
            .gutterWidth=${A}
        ></image-gallery>`}function W(R,A,X){let Y=3,ae=R-A*(Y-1);return Math.min(X,Math.round(ae/Y))}function j(R){R&&R.preventDefault();let X=document.querySelector(".graphics-library__search-input").value.replace(/[`~!@#$%^&*()_|+=?;:'",.<>{}[\]\\/]/gi," ").replace(/ {2,}/g," ").trim();Ie({tagName:X})}function J(){Ie({tagID:"all_items"})}function ie(){Ie({tagID:"all_items"})}function re(){k(),n({mode:"EDITORS_CHOICE",tagID:"editors_choice",lastSearchTerm:"",searchTerm:""}),g.value=""}function he(R){return function(){Ie({tagID:R,style:o.searchStyle})}}function ne(R){return function(){if(o.mode==="EDITORS_CHOICE"){n({searchStyle:R}),m&&m.updateGalleries(L(),R);return}Ie({style:R,tagName:o.searchTerm,tagID:o.searchTerm})}}function le(R){R.stopImmediatePropagation(),n({displayMobileFilters:!o.displayMobileFilters})}function Be(){BeFunky.isWiderThanMobile()||n({mode:"EDITORS_CHOICE"})}function _e({scrollHeight:R,offsetHeight:A,scrollTop:X}){if(!p.images||(p.viewport=[X,X+A],p.isLoading))return;let Y=800;R-A-X<=Y&&d()}function pe(R){BeFunky.openModal(e,{onOpen:()=>{R?Ie({tagID:R}):o.tagID==="editors_choice"&&re()},onWindowResize:({availableWidth:A})=>{n({currentWidth:A}),p.currentWidth=L(),p.rowHeight=W(p.currentWidth,p.gutterWidth,120),l()},size:"xxl",isFullWidthOnMobile:!0})}function Ie({tagID:R="",tagName:A="",style:X="all",page:Y=1}){if(R||(R=Z(A)),R=i.includes(R)?R:"",A=de(R)||A,!R&&!A)throw new Error("Invalid tag name or ID");let ae=R||A,H=X;if(ae||(ae="all_items"),ae===o.lastSearchTerm&&H===o.lastSearchStyle&&Y===o.lastSearchPage||ae.length<=2)return;v&&v.abort();let V="SEARCH";R&&R!=="all_items"&&(V="TAG"),R&&R==="all_items"&&(V="ALL_GRAPHICS"),n({lastSearchTerm:ae,lastSearchStyle:H,lastSearchPage:Y,searchTerm:ae,searchStyle:H,tagName:A,tagID:R,mode:V}),g.value=o.mode==="ALL_GRAPHICS"?"":A,Y===1&&(p.images=[],u(0));let K=100,ee=BFN.GraphicLibraryService.getGraphics(ae,X,Y,K);v=ee.request,p.message="",p.isLoading=!0;let se=Y===1&&o.mode!=="ALL_GRAPHICS";ee.then(ge=>{console.log(`Got ${ge.length} results for page ${Y}`);let Ce=Y;p.isLoading=!1,p.images=[...p.images,...ge],requestAnimationFrame(()=>l()),se&&BFN.BfnService.track("GRAPHICS","SEARCH",`${X} : ${ae}`),d=()=>{ge.length<K||ae!==o.lastSearchTerm||X!==o.lastSearchStyle||Y!==o.lastSearchPage||Ie({tagID:R,tagName:A,style:X,page:++Ce})}}).catch(ge=>{if(p.isLoading=!1,ge==="no_results")p.emptyState={imageUrl:`${BFN.imagesURL}illustrations/no-search-results-canvas.svg`,text:BeFunky.LanguageManager.getStringReplacements("no_results_for",{query:`<strong>"${BeFunky.escapeHTML(o.searchTerm)}"</strong>`})},se&&BFN.BfnService.track("GRAPHICS","EMPTY_SEARCH",`${X} : ${o.searchTerm}`);else{if(ge==="request_failed"&&ee.request.wasAborted)return;p.message={isError:!0,text:BeFunky.failureReason(ge),buttonText:"try_again",buttonAction:()=>Ie({tagID:R,tagName:A})},n({lastSearchTerm:null})}})}function ke(R){return!R.isPlus||BFN.BfnService.userIsPlus?"":ri`
            <div class="badge badge--plus gallery__badge"></div>
        `}function de(R){return R.split("_").map(A).join(" ").replace("s Day","'s Day").replace("St ","St. ").replace("Youtube","YouTube");function A(X,Y){return Y===0||X.length>2&&X!=="the"||X==="my"?X.charAt(0).toUpperCase()+X.slice(1):X}}function Z(R){return R===""?"all_items":R.trim().replace(/[^a-z0-9\s]/gi,"").split(/\s+/).map(A=>A.toLowerCase()).join("_").replace(/_+/g,"_")}function U(){p.selectedImageIDs=BFN.GraphicLibraryManager.selectedGraphics.map(R=>R.id),m&&m.updateGalleries(L(),o.searchStyle)}function k(){if(o.editorsChoiceGraphics.length)return;BFN.GraphicLibraryService.getEditorsChoiceGraphics().then(A=>{let X=[];Object.keys(A).forEach((Y,ae)=>{A[Y].data.tags.forEach(({tag:H,title:V,items:K})=>{let ee={all:[]};ae===0?X.push({tagID:H,title:V,graphicData:ee}):ee=X.find(({tagID:ge})=>ge===H).graphicData;let se=BFN.GraphicLibraryService.graphicDataToMenuImageVO(K);ee[Y]=se.shuffle().sort(R),ee.all=[...ee.all,...se.slice(0,4)].shuffle().sort(R)})}),n({editorsChoiceGraphics:X})});function R(A,X){return A.isPlus&&!X.isPlus?1:-1}}function G(){return["abstract_shapes","geometric_shapes","lines","arrows","social_media","badges","wedding","birthday","ribbons","ornaments","floral","travel","music","food","accessories","weddings","birthdays","animals","speech_bubbles","hearts","emojis","businesses","technology","fashion","sports","nature","real_estate","lifestyle","people","education","infographics"].filter(R=>i.includes(R))}function L(){return BeFunky.isWiderThanMobile()?o.currentWidth-17*16-24*2:o.currentWidth-32*2}}var Ib=class{constructor(){this.init()}init(){this.initDefaultValues()}initDefaultValues(){this.selectedGraphics=[],this.modal=null,this.updateGraphicsInSidebar=BeFunky.debounce(this.updateGraphicsInSidebar.bind(this),"raf"),this.updateGraphicStore=BeFunky.debounce(this.updateGraphicStore,0),this.fetchGraphicsFromPriorSession=BeFunky.once(()=>{BFN.IndexedDB.get("options__selectedGraphics").then(e=>{Array.isArray(e)&&e.reverse().forEach(t=>this.addGraphic(t,{useTracking:!1}))}).catch(e=>{BeFunky.logError("Unable to fetch previous session's selectedGraphics from IndexedDB",e)})}),this.preloadData=BeFunky.once(()=>{BFN.GraphicLibraryService.getTags().catch(e=>BeFunky.logError("Unable to pre-emptively load tags when entering Graphics menu",e)),BFN.GraphicLibraryService.getEditorsChoiceGraphics().catch(e=>BeFunky.logError("Unable to pre-emptively load editors choice graphics when entering Graphics menu",e)),this.fetchGraphicsFromPriorSession()}),BeFunky.wait([2e3,"ric"],()=>this.fetchGraphicsFromPriorSession())}handleGraphicCategory(){let e=UITools.getToolValue("editor_graphic","updating_id");if(e!=="add_layer"){BFN.GraphicLibraryManager.openModal(e);return}BFN.ImageLibraryManager.uploadImages(({menuImageVO:t})=>{!t||BFN.ImageLibraryManager.addImageToCanvas(t,{forceLayer:!0})},{allowMultiple:!1}),BFN.BfnService.track("CREATE","GOODIES","ADD_YOUR_OWN")}openModal(e){if(this.modal)return this.modal.open(e);BFN.GraphicLibraryService.getTags().then(t=>{this.modal||(this.modal=Wo(t)),this.modal.open(e)},t=>BeFunky.logError("Unable to fetch tags before opening Graphic Search modal",t))}addGraphic(e,{cloneObject:t=!0,index:r=0,updateImageGalleryItem:a=!0,useTracking:s=!0}={}){if(!e.id)throw"MenuImageVO missing id";if(this.getIndex(e.id)!==-1)return;!t&&!(e instanceof BFN.MenuImageVO)&&(t=!0,BeFunky.throwError("MenuImageVO cloning forced on plain object",e));let o;t?(o=new BFN.MenuImageVO,o.setObject(e),o.style=e.style):o=e,this.selectedGraphics.splice(r,0,o),e.indexedDBKey&&BFN.ProjectService.setLocalAsset("graphicmanager","image",e.id,void 0,!0),this.updateGraphicsInSidebar(),a&&this.modal&&this.modal.updateSelectedGraphics(this.selectedGraphics),this.updateGraphicStore()}removeGraphic(e,{updateImageGalleryItem:t=!0,usedBaseTextures:r=null}={}){let a=this.getIndex(e);if(a===-1)return;r||(r=BFN.GlobalHistoryModel.getUsedBaseTextures());let s=this.selectedGraphics[a];s.imageTexture&&s.imageTexture.valid&&s.imageTexture.baseTexture&&!r.includes(s.imageTexture.baseTexture)&&(s.imageTexture.destroyGC(!0),s.imageTexture=null),this.selectedGraphics.splice(a,1),BFN.ProjectService.removeLocalAsset("graphicmanager","image",e),this.updateGraphicsInSidebar(),t&&this.modal&&this.modal.updateSelectedGraphics(this.selectedGraphics),this.updateGraphicStore()}updateGraphicsInSidebar(){BFN.secondaryMenu?BFN.secondaryMenu.selectedGraphics=this.selectedGraphics.slice():window.addEventListener("INIT_COMPLETE",this.updateGraphicsInSidebar.bind(this))}getIndex(e){if(!e.startsWith("graphic_")){BeFunky.throwError(`Invalid Graphic MenuImageVO ID: ${e}`);return}return this.selectedGraphics.findIndex(t=>t.id===e)}getMenuImageVO(e){if(!e.startsWith("graphic_")){BeFunky.throwError(`Invalid Graphic MenuImageVO ID: ${e}`);return}return this.selectedGraphics.find(t=>t.id===e)}updateGraphicStore(){let e=this.selectedGraphics.map(t=>t.getObject());BFN.IndexedDB.set("options__selectedGraphics",e).catch(t=>BeFunky.logError("Unable to update selectedGraphics in IndexedDB",t))}handleGraphicSelection(e,{isSelected:t}){return t&&e.isPlus&&!BFN.BfnService.userIsPlus?(BFN.BfnService.upgrade("GOODIES",`${e.trackingID}_UPGRADE`),BFN.UserActionManager.addUpgradeAction(["Add Plus Graphic"],!1),!1):(t?this.addGraphic(e):this.removeGraphic(e.id),!0)}};BFN.SingletonQueue.add(()=>{BFN.GraphicLibraryManager=new Ib});var{Hook:gM,hook:ga}=BeFunky.lit,Wr=class extends gM{constructor(e,t,r){super(e,t);this.isTornDown=!1,this.controlId=r,this.isRendered=!1,this.onControlDataChange=this.onControlDataChange.bind(this),this.startListening()}_getControlValue(){return this.isRendered=!0,UITools.getControlValue(this.controlId)}startListening(){UITools.controlCallbacks[this.controlId]=this.onControlDataChange}stopListening(){delete UITools.controlCallbacks[this.controlId]}onControlDataChange(e){e&&delete this.controlDataObject,this.isRendered&&this.state.update()}update(e){return this.isTornDown&&(this.isTornDown=!1,this.startListening()),this.isRendered=!1,this.controlDataObject||(this.controlDataObject=this.getControlData(this.controlId,this._getControlValue.bind(this),UITools.getParamObject(this.controlId))),this.controlDataObject}teardown(){this.isTornDown=!0,this.stopListening()}},_b=class extends Wr{getControlData(e,t,r){return{get value(){return t()},buttons:r.buttons,onChange:a=>{UITools.setControlValue(e,a.currentTarget.value),UITools.applyToolControl(e),UITools.updateToolControl(e)}}}},va=ga(_b),Cb=class extends Wr{getControlData(e,t,r){return{get value(){return t()},description:r.description,onChange:a=>{UITools.setControlValue(e,a.currentTarget.checked),UITools.applyToolControl(e),UITools.updateToolControl(e)}}}},Ut=ga(Cb),Eb=class extends Wr{getControlData(e,t,r){return Si(It({get value(){return t()},start:r.defaultValue},r),{onUpdate:(a,s)=>{let o=a!=="end";UITools.setControlValue(e,s,o),UITools.applyToolControl(e),o||UITools.updateToolControl(e)}})}},$r=ga(Eb),Pb=class extends Wr{getControlData(e,t,r){return{get value(){return t()},options:r.data,useLabel:Boolean(r.useLabel),label:r.name||"",hideModalVeil:Boolean(r.hideModalVeil),onChange:a=>{UITools.setControlValue(e,a),UITools.applyToolControl(e),UITools.updateToolControl(e)}}}},Ha=ga(Pb),Nb=class extends Wr{getControlData(e,t,r){return{get value(){return t()},unit:r.unit,minValue:r.min,maxValue:r.max,maxLength:r.maxLength,onChange:a=>{UITools.setControlValue(e,a.target.value,a.detail.isUpdating),UITools.applyToolControl(e),UITools.updateToolControl(e)}}}},$o=ga(Nb),Mb=class extends Wr{getControlData(e,t,r){return{get value(){return t()},defaultValue:r.defaultValue,buttons:r.buttons,onChange:a=>{UITools.setControlValue(e,a.target.value),UITools.applyToolControl(e),UITools.updateToolControl(e)}}}},jo=ga(Mb);var{defineCustomElement:vM,html:Db,appLang:jr,useLayoutEffect:yM}=BeFunky.lit,wb=!1;function Ri(){wb||(wb=!0,vM("settings-modal",xM));let i=document.getElementById("settings_menu");i.isOpen=!0,i.alignmentEnabled=BFN.canvasFooter.alignmentEnabled}function xM({isOpen:i=!1,alignmentEnabled:e=!1}){let t=this,r=jo("user_settings_theme_color"),a=jo("user_settings_canvas_bg_color"),s=Ha("user_settings_autosave"),o=Ha("language_select"),n=Ut("alignment_snapping"),l=Ut("alignment_display_distances"),c=Ut("alignment_guides");return yM(d,[i]),h();function h(){return Db`
        <panel-header .langId=${"settings"} .modifier=${"modal"} .buttons=${"close"}></panel-header>
        <div class="modal__body modal__form-body" style="overflow: hidden;">
            <div class="control-item">
                <label class="control-item-label">${jr("autosave")}</label>
                <p class="control-item-label" style="white-space: normal; margin: 4px 0 8px 0; --text-font-size: 12px;">${jr("autosave_description")}</p>
                <dropdown-select
                    .value=${s.value}
                    .options=${s.options}
                    .useLabel=${s.useLabel}
                    .label=${s.label}
                    .hideModalVeil=${s.hideModalVeil}
                    .onChange=${s.onChange}
                ></dropdown-select>
            </div>
            <div class="control-item">
                <label class="control-item-label">${jr("language")}</label>
                <dropdown-select
                    .value=${o.value}
                    .options=${o.options}
                    .useLabel=${o.useLabel}
                    .label=${o.label}
                    .hideModalVeil=${o.hideModalVeil}
                    .onChange=${o.onChange}
                ></dropdown-select>
            </div>
            <div class="control-item">
                <label class="control-item-label">${jr("theme_color")}</label>
                <radio-buttons
                    class="text-sm"
                    .value=${r.value}
                    .defaultValue=${r.defaultValue}
                    .buttons=${r.buttons}
                    @change=${r.onChange}
                ></radio-buttons>
            </div>
            <div class="control-item">
                <label class="control-item-label">${jr("canvas_bg_color")}</label>
                <radio-buttons
                    class="text-sm"
                    .value=${a.value}
                    .defaultValue=${a.defaultValue}
                    .buttons=${a.buttons}
                    @change=${a.onChange}
                ></radio-buttons>
            </div>
            <div class="control-item">
                <label class="control-item-label">${jr("alignment")}</label>
            </div>
            ${u(n,"snapping")}
            ${u(l,"display_distances")}
            ${u(c,"guides")}
        </div>
        `}function u(m,p){let g=`toggle-switch ${e?"":"toggle-switch--disabled"}`;return Db`
            <div class="control-item" style="margin-top: 0.5rem;">
                <label class=${g}>
                        <span class="toggle-switch__label-badge">
                            <string class="toggle-switch__label">${jr(p)}</string>
                        </span>
                    <input
                        class="toggle-switch__checkbox"
                        type="checkbox"
                        .checked=${m.value}
                        @change=${m.onChange}>
                    <span class="toggle-switch__slider"></span>
                </label>
            </div>`}function d(){if(i){let m=BeFunky.LanguageManager.language.app,p=Ii(),g=ht().name;BeFunky.openModal(t,{size:"extra-small",onClose:()=>{t.isOpen=!1,!!window.bfn_mp&&(BeFunky.LanguageManager.language.app!==m&&window.bfn_mp.track("app_language_changed"),p!==Ii()&&window.bfn_mp.track("app_theme_changed"),g!==ht().name&&window.bfn_mp.track("canvas_color_changed"))}})}else BeFunky.closeModal(t,!1)}}var kb=class extends BFN.EventDispatcher{constructor(){super();this.init()}init(){BeFunky.log("AccountManager Init"),this.initDefaultValues()}initDefaultValues(){this.welcomed=!1,BFN.BfnService.addEventListener(BFN.BfnServiceEvents.USER_DATA_CHANGED.type,this.handleUserDataChanged.bind(this))}handleAccountAction(){let e=UITools.getToolVO("user_account");if(!e)return;switch(e.updating_id){case"upgrade":BFN.BfnService.upgrade("GLOBALMENU",void 0,"top_nav_bar"),BFN.UserActionManager.addUpgradeAction(["Top Nav Bar"]);break;case"sign_in":BFN.BfnService.login();break;case"sign_up":BFN.BfnService.register();break;case"logout":BFN.BfnService.signOut();break;case"settings":Ri();break;case"feedback":this.showFeedbackForm();break}}handleUserDataChanged(e){BFN.BfnService.userLoggedIn?(BeFunky.isPlus()?BFN.applyCancelMenu.upgradeMode=!1:BFN.applyCancelMenu.upgradeMode=!0,this.welcomed||(this.welcomed=!0,setTimeout(()=>{BeFunky.waitUntil({condition:()=>BeFunky.LanguageManager.isTranslated("welcome_user"),onSuccess:()=>{requestAnimationFrame(()=>{let t=BeFunky.LanguageManager.getStringReplacements("welcome_user",{user:BeFunky.User.username||""});UIMessages.display(t)})},onTimeout:()=>{}})},333))):BFN.applyCancelMenu.upgradeMode=!0}showFeedbackForm(){let e=document.getElementById("feedback_form_modal"),t=e.querySelector("textarea"),r=()=>BeFunky.closeModal(e);this.feedbackFormSetup||(this.feedbackFormSetup=!0,e.querySelector(".feedback__cancel").addEventListener("click",r),e.querySelector(".feedback__submit").addEventListener("click",a)),BeFunky.openModal(e,{size:"small",onOpen:()=>{t.focus()}});function a(s){let o=t.value.trim();if(!o)return;let n=s.currentTarget;n.disabled=!0,BeFunky.requestAPI("auth/send-feedback",{message:o},{showLoadScreen:!0}).then(l=>{if(l.data!=="success")throw"invalid_response";t.value="",r(),UIMessages.display("thank_you_befunky")}).catch(l=>{console.log("Feedback:",o),l==="invalid_response"?BeFunky.throwError("Unable to send feedback",l):BeFunky.logError("Unable to send feedback",l),UIMessages.display(BeFunky.failureReason(l))}).then(()=>{n.disabled=!1})}}};BFN.SingletonQueue.add(()=>{BFN.AccountManager=new kb});var Lb=ca(Ab());var Ob=ca(qo());function Gt(i,e,t){let r,a,s;return t||(t=c=>i?c==="down":c==="up"),function(h){r=h.currentTarget;let u=r.getBoundingClientRect().top;Math.abs(h.clientY-u)>24||(a=h.clientY,s=0,r.addClass("drag-up-to-expand--pressed"),document.addEventListener(BeFunky.pointermove,o),document.addEventListener(BeFunky.pointerup,n),document.addEventListener(BeFunky.pointercancel,n),document.addEventListener("contextmenu",n),setTimeout(()=>n(),3e3))};function o(c){let h=c.clientY-a,u=Math.abs(h);if(s=Math.max(u,0),Math.abs(u)<12)return;let d=h>0?"down":"up";!t(d)||(n(),e(d==="up",r),i=!i)}function n(c){if(r.removeClass("drag-up-to-expand--pressed"),document.removeEventListener(BeFunky.pointermove,o),document.removeEventListener(BeFunky.pointerup,n),document.removeEventListener(BeFunky.pointercancel,n),document.removeEventListener("contextmenu",n),c&&c.type==="pointerup"&&s<5){let h=r.getBoundingClientRect(),u={x:h.left+h.width/2,y:h.top-10};Math.abs(c.clientX-u.x)<=24&&l(-5,c.clientY-u.y,12)&&(e(!i,r),i=!i)}}function l(c,h,u){return h>=c&&h<=u}}var{html:Ot,setupState:TM,render:Rb,appLang:ya,icon:Yr,elem:Ko}=BeFunky.lit;function Jo(i,{onFontSelection:e,onRecentFontsChange:t,onFavoriteFontsChange:r,isFontLoaded:a,loadFont:s,openFontManager:o,testNewSystemFont:n}){let l=Ko`<div class="font-menu focus-trap"></div>`,c,h=null,u={activeFontName:"",activeFontWeight:400,fonts:[],favorites:[],recent:[],loading:[],failedToLoad:[],mode:"ALL",searchInput:"",isExpanded:BFN.alternateMenu.isExpanded},d=BeFunky.debounce(()=>{c!==!1&&Rb(y(),l)},"raf"),[m,p]=TM(Object.assign({},u,i),U=>{U.activeFontName&&le(),U.fonts&&(h=null),U.isExpanded&&(Z(),BFN.alternateMenu.isExpanded=m.isExpanded),d()});BeFunky.LanguageManager.addLanguageUpdateListener(d);let g={name:"",isRecent:!1},f=ie();l.addEventListener(BeFunky.pointerdown,U=>{if(U.stopImmediatePropagation(),!BeFunky.isWiderThanMobile()){let k=L=>{!L&&!m.isExpanded?w():p({isExpanded:L})},G=L=>m.isExpanded?L==="down":!0;Gt(m.isExpanded,k,G)(U)}});let{menu:v,showMenu:T,openMobilePopup:x,closeMobilePopup:B}=he();return ne(),BeFunky.onMatchMedia(`(min-width: ${BFN.CSS.desktopAppMinWidth}px)`,({isMatched:U})=>{l.toggleClass("drag-up-to-expand",!U),B(),d(),l.setStyles({transition:"none"}),BeFunky.wait([100,"raf"],()=>{l.setStyles({transition:""})})}),l.toggleClass("drag-up-to-expand",!BeFunky.isWiderThanMobile()),Z(),Object.assign(l,{setState:p,show:D,hide:w,isVisible:()=>c}),l;function y(){requestAnimationFrame(_e);let U=m.mode==="FAVORITES",k=BeFunky.isWiderThanMobile()?"back,help":"back";return Ot`
        <div class="font-menu__inner">
            <panel-header lang-id="choose_font" modifier="secondary" buttons=${k} clue-id="choose_font" @BACK=${()=>l.hide()}></panel-header>
            <div class="font-menu__header">
                <div class=${`font-menu__search filter-box text-xs ${m.searchInput?"":"filter-box--empty"}`}>
                    ${Yr("search-icon","icon filter-box__icon")}
                    ${f}
                    ${m.searchInput?Ot`
                    <button class="button button--icon button--transparent button--sm filter-box__clear" @click=${re}>
                        ${Yr("cancel-icon","icon icon--12")}
                    </button>`:""}
                </div>
                <button @click=${J}
                    class="${`font-menu__tab button button--icon button--sm button--white-outline ${U?"button--selected":""}`}"
                    data-tooltip=${m.mode==="FAVORITES"?"show_all_fonts":"show_favorites"}
                >
                ${Yr(U?"favorite-star-fill-icon":"favorite-star-empty-icon","icon icon--18")}
                </button>
                ${BeFunky.isWiderThanMobile()?Ot`
                <button
                    @click=${o} class="font-menu__tab button button--icon button--white-outline button--sm"
                    data-tooltip="add_fonts"
                >
                    ${Yr("plus-icon","icon")}
                </button>`:""}
            </div>
            <div class="font-menu__lists-container">
            ${m.mode==="ALL"?F():""}
            ${m.mode==="FAVORITES"?b():""}
            ${m.mode==="SEARCH"?S():""}
            ${v}
            </div>
        </div>
        `}function F(){let U=m.recent.map(k=>m.fonts.find(({name:G})=>G===k)).filter(Boolean);return Ot`
        ${U.length?Ot`
        <span class="font-menu__heading">${ya("recent_fonts")}</span>
        <ul class="font-menu__list font-menu__list--recent" @click=${M} @mouseover=${N}>
            ${U.map(k=>I(k,!0))}
        </ul>`:""}
        <span class="font-menu__heading">${ya("all_fonts")}</span>
        <ul class=${`font-menu__list font-menu__list--all ${BeFunky.isWiderThanMobile()?"scrollable-content":""}`} @click=${M} @mouseover=${N}>
            ${m.fonts.map(k=>I(k,!1))}
        </ul>
        `}function b(){let U=m.fonts.filter(({name:k})=>m.favorites.includes(k));return Ot`
        <span class="font-menu__heading">${ya("favorites")}</span>
        <ul class=${`font-menu__list font-menu__list--favorites ${BeFunky.isWiderThanMobile()?"scrollable-content":""}`} @click=${M} @mouseover=${N}>
            ${U.length?U.map(k=>I(k,!1)):E("no_favorites_message")}
        </ul>`}function S(){let U=m.searchInput?pe(m.searchInput):m.fonts;return Ot`
        <ul class=${`font-menu__list font-menu__list--search ${BeFunky.isWiderThanMobile()?"scrollable-content":""}`} @click=${M} @mouseover=${N}>
            ${U.length?U.map(k=>I(k,!1)):E("font_not_available")}
        </ul>`}function I({name:U,type:k,bgYOffset:G,weights:L},R){let A=U===m.activeFontName,X=Ie(L),Y=["font-menu__item",`font-menu__item--${k}`,R?"font-menu__item--recent":"",A?"font-menu__item--active":"","button","button--grey-200",X?"button--has-icon":"","button--fullwidth"].filter(Boolean).join(" "),ae,H="";if(typeof G=="number"){let ge=k==="google"?`google-fonts-sprite.${BeFunky.Params.googleFontsSpriteVersion}.png`:`befunky-fonts-sprite.${BeFunky.Params.befunkyFontsSpriteVersion}.png`;H=Ot`<div class="font-menu__font-image" style=${`background-position-y: -${G}px; background-image: url(${BFN.imagesURL}app/fonts/${ge})`}></div>`}else if(k==="google"){let ge=`${BFN.imagesURL}app/fonts/google_v2/${U.replace(/[^a-z0-9-]/gi,"")}-${ua(L)}.png`;H=Ot`<div class="font-menu__font-image" style=${`background-image: url(${ge})`}></div>`}else ae=`font-family: "${U}", sans-serif`;let V=m.favorites.includes(U),K=m.loading.includes(U)?Ot`<span class="loading-spinner"></span>`:"",ee=m.failedToLoad.includes(U)?Ot`<button class="button button--link button--grey-200 font-menu__right-button" style=${m.failedToLoad.includes(U)?"":"display: none"}><string style="font-size: 13px">${ya("font_load_retry")}</string></button>`:"",se=["button button--icon font-menu__favorite-button",V?"font-menu__favorite-button--selected":"",X?"font-menu__favorite-button--weights":""].filter(Boolean).join(" ");return Ot`
        <li class="${Y}" style="${ae}" data-font="${U}" .isRecent=${R} tabindex="0">
            ${H}
            <string>${U}</string>
            ${K}
            ${ee}
            ${!K&&!ee?Ot`<button class=${se} data-tooltip=${V?"favorites_remove":"favorites_add"}>
                ${Yr(V?"favorite-star-fill-icon":"favorite-star-empty-icon","icon font-menu__favorite-icon")}
            </button>
            ${X?Yr("chevron-icon","icon icon--chevron-right font-menu__show-weights-icon"):""}`:""}
        </li>`}function _(U,k,G){let L=as[G],R=["font-menu__item","font-menu__weights-item",U===m.activeFontName&&G===m.activeFontWeight?"font-menu__item--active":"","button","button--transparent","button--fullwidth","button--sm"].filter(Boolean).join(" "),A="",X="";if((k==="system"||k==="uploaded")&&(A=`font-family: "${U}", sans-serif; font-weight: ${G}`),k==="google"){let Y=`${BFN.imagesURL}app/fonts/google_v2/${U.replace(/[^a-z0-9-]/gi,"")}-${G}w.png`;A="color: transparent",X=Ot`<div class="font-menu__font-image" style=${`background-image: url(${Y})`}></div>`}return Ot`<div class="${R}" style="${A}" @click=${()=>j(U,G)} tabindex="0">
            ${X}
            ${L}
        </div>`}function E(U){let G=ya([U,{learn_more:Ot`<a href="https://support.befunky.com/hc/en-us/articles/360001571631" target="_blank" rel="noopener">${(L=>L.charAt(0).toUpperCase()+L.substr(1).toLowerCase())(ya("learn_more",!0))}</a>`}]);return Ot`<div class="font-menu__not-found">
            <img src="${BFN.imagesURL}illustrations/no-search-results-sidebar.svg" alt="">
            <p>${G}</p>
        </div>`}function D(){c||(c=!0,d(),l.setStyles({display:""}).toggleClass("font-menu--over-fabric-canvas",BFN.alternateMenu.isOverFabricCanvas),requestAnimationFrame(()=>{c&&(l.setStyles({opacity:1}),BFN.alternateMenu.isDisabled=!0,BFN.HelpClueManager.handleMainMenuTransition(),BFN.HelpClueManager.show("choose_font"))}))}function w(U=!1){if(!!c){if(c=!1,BFN.alternateMenu.isDisabled=!1,BFN.HelpClueManager.handleMainMenuTransition(),m.mode==="SEARCH"&&(f.value="",p({mode:"ALL",searchInput:""})),l.contains(document.activeElement)&&document.activeElement.blur(),U){l.setStyles({opacity:0,display:"none"});return}l.setStyles({opacity:0}),setTimeout(()=>{c||l.setStyles({display:"none"})},200)}}function N(U){if(U.target.nodeName!=="LI"||!BeFunky.isWiderThanMobile())return;let k=U.target,G=k.getAttribute("data-font"),L=m.fonts.find(R=>R.name===G);if(!L)return BeFunky.throwError("No font object in menu for rendered font",G);if(!L.weights.length)return BeFunky.throwError("No font weights in menu for rendered font",G);if(Ie(L.weights)){let R=U.clientY-U.offsetY;T({name:L.name,type:L.type,weights:L.weights,itemYOffset:R,item:k})}}function M(U){if(U.stopPropagation(),U.target.nodeName==="LI"){let k=U.target,G=k.getAttribute("data-font");return BeFunky.isWiderThanMobile()?z(k,G):U.target.getBoundingClientRect().width-U.offsetX<=36?x(m.fonts.find(A=>A.name===G)):z(k,G)}if(U.target.nodeName==="BUTTON"){let k=U.target.parentElement.getAttribute("data-font");if(U.target.hasClass("font-menu__favorite-button"))W(k);else{let G=U.target.parentElement;return z(G,k)}}}function z(U,k){let G=m.fonts.find(A=>A.name===k),L=U.isRecent?m.recent.indexOf(k):-1,R=ke(G.weights,m.activeFontWeight);if(p({activeFontName:k,activeFontWeight:R}),Be(),g={fontName:k,isRecent:U.isRecent},e(k,R),BeFunky.isWiderThanMobile()&&Ie(G.weights)){let A=U.getBoundingClientRect().top;L!==-1&&(A-=L*36),T({name:G.name,type:G.type,weights:G.weights,itemYOffset:A,item:U})}}function W(U){m.favorites.includes(U)?p({favorites:m.favorites.filter(k=>k!==U)}):p({favorites:[...m.favorites,U]}),r(m.favorites)}function j(U,k){p({activeFontName:U,activeFontWeight:k}),Be(),e(U,k);let G=m.fonts.find(L=>L.name===U);T({name:G.name,type:G.type,weights:G.weights})}function J(){f.value="",p({mode:m.mode==="FAVORITES"?"ALL":"FAVORITES",searchInput:""})}function ie(){let U=!1,k=BeFunky.debounce(A=>{if(!U)return;let X=A.target.value.trim();p({mode:"SEARCH",searchInput:X}),X&&n(X)},100),R=Ko`<input @focus=${A=>{U=!0,A.target.value.trim()&&k(A)}} @blur=${A=>{U=!1,A.target.value.trim()||p({mode:"ALL"})}} @keyup=${k} @change=${k} class="filter-box__input input" type="search">`;return R.setLang("search_fonts"),R}function re(){f.value="",p({mode:"ALL",searchInput:""})}function he(){let U=Ko`<div class="font-menu__weights"></div>`,k=BFN.topNavBarHeight+24,G,L=()=>{};return{menu:U,showMenu:R,openMobilePopup:ae,closeMobilePopup:()=>L()};function R({name:H,type:V,weights:K,itemYOffset:ee,item:se}={}){if(U.setStyles({display:""}),typeof ee=="number"){let ge=36*K.length;ee-=K.indexOf(ua(K))*36,ee=Math.min(ee,BFN.appRect.height-ge-2),U.setStyles({top:`${ee-k}px`})}Rb(Y(H,V,K),U),G=se,G&&G.addClass("font-menu__item--showing-weights"),BFN.appContainer.addEventListener(BeFunky.pointerover,X)}function A(){U.setStyles({display:"none"}),G&&(G.removeClass("font-menu__item--showing-weights"),G=void 0),BFN.appContainer.removeEventListener(BeFunky.pointerover,X)}function X(H){U.contains(H.target)||G&&G.contains(H.target)||H.target.nodeName!=="UL"&&(BeFunky.isLoadScreenActive()||H.target.hasClass("upper-canvas")&&BFN.FabricManager.styleChangeRequested||A())}function Y(H,V,K){return Ot`<div class="font-menu__weights-list">${K.map(ee=>_(H,V,ee))}</div>`}function ae({name:H,type:V,weights:K}){let ee=document.getElementById("modal_root");ee.setStyles({background:"transparent"}),L=BeFunky.openDialog({heading:H,body:Y(H,V,K),className:"dialog--mobile",modalOptions:{addAnchorBottomClass:!0,addCloseButton:!0,closeOnClickOutside:!0,onClose:()=>{ee.setStyles({background:""})}}})}}function ne(){let U=k=>k.hasClass("font-menu__item")&&!k.hasClass("font-menu__item--recent");BeFunky.addArrowKeyHandler({condition:U,callback:(k,G,L)=>{if(L.type==="keydown"||G==="left"||G==="right")return;let R=G==="up"?k.previousElementSibling:k.nextElementSibling;R&&U(R)&&R.click()}})}function le(){if(!m.activeFontName)return;let U=[...m.recent],k=U.indexOf(m.activeFontName);k!==0&&(k!==-1&&U.splice(k,1),U.length>=5&&U.pop(),U.unshift(m.activeFontName),p({recent:U}),t(U))}function Be(){let U=m.activeFontName;a(U)||m.loading.includes(U)||(p({loading:[...m.loading,U],failedToLoad:m.failedToLoad.filter(k=>k!==U)}),s(U).catch(()=>p({failedToLoad:[...m.failedToLoad,U]})).then(()=>p({loading:m.loading.filter(k=>k!==U)})))}function _e(){if(m.activeFontName!==g.fontName){g={fontName:"",isRecent:!1};return}let U;m.mode==="SEARCH"?U=".font-menu__list--search":m.mode==="FAVORITES"?U=".font-menu__list--favorites":g.isRecent?U=".font-menu__list--recent":U=".font-menu__list--all";let k=l.querySelector(`${U} [data-font="${m.activeFontName}"]`);k&&k.focus(),g={fontName:"",isRecent:!1}}function pe(){if(h)return h(m.searchInput);let U={shouldSort:!0,includeScore:!0,threshold:.25,location:0,distance:100,maxPatternLength:32,minMatchCharLength:1,keys:["name"]},k=new Ob.default(m.fonts,U);return h=G=>k.search(G).map(L=>L.item),h(m.searchInput)}function Ie(U){return!(U.length<2||U.length===2&&U[0]<=500&&U[1]>500)}function ke(U,k){if(U.includes(k))return k;let G=k>=600,L=U.filter(R=>G?R>=600:R<600);return L.length?de(L,k):G?700:ua(U)}function de(U,k){return U.reduce((G,L)=>Math.abs(L-k)<Math.abs(G-k)?L:G)}function Z(){l.style.setProperty("--mobile-font-menu-height",`${m.isExpanded?BFN.alternateMenuExpandedHeightOnMobile:BFN.alternateMenuBaseHeightOnMobile}px`)}}var{html:bt,setupState:FM,render:bM,modalLang:Ht,icon:Li,elem:Qo}=BeFunky.lit;function Zo(i,{addGoogleFont:e,removeAddedFont:t,onFontFilesDropped:r,browseForFonts:a,uploadFonts:s,cancelUpload:o,trackFonts:n,onGoogleFontListLoaded:l}){let c=Qo`<div id="font_manager" class="font-manager modal"></div>`,h,u={fonts:[],mode:"ALL",searchInput:"",googleFontWeights:[],selectedCategories:[],selectedWeights:[],selectedSubsets:["latin"],maxFontsToRender:50,fontsToUpload:[],availableHeight:632,availableWidth:646},d=BeFunky.debounce(()=>{h!==!1&&bM(y(),c)},"raf"),[m,p]=FM(Object.assign({},u,i),d);BeFunky.LanguageManager.addLanguageUpdateListener(d);let g=BeFunky.debounce(Be,50),f,v=!1,T={handleEvent:BeFunky.throttle(de,50),passive:!0},x=z(),B=W();return Object.assign(c,{state:m,setState:p,show:j,hide:J}),c;function y(){let Z=m.mode==="UPLOAD"?"overflow-y: hidden; display: flex; flex-direction: column;":"";return bt`
            ${x}
            ${B}
            <div class="font-manager__body">
                <div class="font-manager__left-panel">
                    ${F("ALL","view_added_fonts")}
                    <p class="font-manager__sub-heading text-sm bold" style="margin-top: 1.5rem">${Ht("add_fonts")}</p>
                    ${F("UPLOAD","add_fonts_computer")}
                    ${F("GOOGLE","add_fonts_google")}
                    ${m.mode==="GOOGLE"?w():""}
                </div>
                <div class="font-manager__right-panel">
                    <div class="scrollable-content" style=${`--scrollable-content-width: ${m.availableWidth-272-48}px; ${Z}`} @scroll=${T}>
                        ${m.mode==="ALL"?b():""}
                        ${m.mode==="UPLOAD"?S():""}
                        ${m.mode==="GOOGLE"?I():""}
                    </div>
                </div>
            </div>
        `}function F(Z,U){return bt`
        <button @click=${()=>p({mode:Z})} class=${`button button--grey-200 button--fullwidth button--has-icon font-manager__tab ${m.mode===Z?"button--selected":""}`}>
            <string>${Ht(U)}</string>
            ${Li("chevron-icon","icon icon--chevron-right")}
        </button>`}function b(){if(!m.fonts.length){let U=Ht(["no_user_defined_fonts_message",{learn_more:bt`<a href="https://support.befunky.com/hc/en-us/articles/360001571631" target="_blank" rel="noopener">${(k=>k.charAt(0).toUpperCase()+k.substr(1).toLowerCase())(Ht("learn_more",!0))}</a>`}]);return bt`
            <div class="font-manager__center-contents font-manager__no-added-fonts">
                <img class="font-manager__illustration" src="${BFN.imagesURL}illustrations/no-fonts-added.svg" alt="" />
                <p>${U}</p>
            </div>`}return bt`<ul class="font-manager__list">${m.fonts.map(_)}</ul>`}function S(){setTimeout(M,0);let{fontsToUpload:Z}=m,U=!1;(Z.find(L=>typeof L.uploadProgress=="number")||Z.every(L=>L.error))&&(U=!0);let k=Ht("drag_drop_fonts"),G=`font-manager__center-contents font-manager__drag-message ${m.fontsToUpload.length===0?"":"font-manager__drag-message--has-items"}`;return bt`
        <div class=${G} @click=${he}>
            <img class="font-manager__illustration" src="${BFN.imagesURL}illustrations/drop-fonts.svg" alt="" />
            <span>${k}</span>
        </div>
        ${m.fontsToUpload.length?bt`
        <div class="font-manager__upload-scroll scrollable-content">
            <div class="font-manager__list font-manager__list--uploaded">
                ${m.fontsToUpload.map(E)}
            </div>
            <div class="font-manager__upload-button-container">
                <button @click=${le} class="button button--blue button--fullwidth" .disabled=${U}>${Ht("upload_fonts")}</button>
            </div>
        </div>
        `:""}`}function I(){if(!m.googleFontWeights.length)return re(),bt`
            <div class="font-manager__center-contents">
                <div><span class="loading-spinner"></span><string>${Ht("loading")}</string></div>
            </div>`;let Z=ie();return Z.length?bt`<ul class="font-manager__list">${Z.map(D)}</ul>`:bt`
            <div class="font-manager__center-contents">
                <img class="font-manager__illustration" src="${BFN.imagesURL}illustrations/no-search-results-canvas.svg" alt="">
                ${Ht(["no_font_results",{input:m.searchInput}])}
            </div>`}function _(Z){let{name:U,type:k,weights:G}=Z,L=["font-manager__item","font-manager__item--added",`font-manager__item--${k}`].filter(Boolean).join(" "),R=k==="google"?"":`font-family: "${U}", sans-serif; padding-right: 0px;`,A=k==="google"?bt`<div class="font-manager__font-image" style=${`background-image: url(${BFN.imagesURL}app/fonts/google_v2/${U.replace(/[^a-z0-9-]/gi,"")}-${ua(G)}.png)`}></div>`:"",X=k==="google"?Li("google-font-icon","icon font-manager__icon-google","",{tooltip:"added_from_google"}):Li("file-icon","icon icon font-manager__icon-file","",{tooltip:"added_from_computer"});return bt`
        <li class="${L}" style="${R}">
            ${A}
            <string>${U}</string>
            ${X}
            <button @click=${()=>t(U)} class="button button--icon button--transparent font-manager__button button--sm" data-tooltip="remove_font">
                ${Li("delete-icon")}
            </button>
        </li>`}function E(Z){let{fontFamily:U,fontWeight:k,fileName:G,uploadProgress:L,error:R}=Z,A=["font-manager__item","font-manager__item--uploaded",R?"font-manager__item--error":""].filter(Boolean).join(" "),X="",Y=R?bt`<span class="font-manager__error"><string>File: ${G}</string>${se()}</span>`:bt`<string>${U} <span class="font-manager__style">${`- ${Ht(Aa[k],!0)}`}</span></string>`,ae=L===100,H=!R&&!ae&&typeof L=="number",V="";H&&(V=bt`<span class="font-manager__upload-progress">${L}%</span>`);let K=ae?Li("checkmark-icon","icon font-manager__icon-selected",{style:"margin-right: 6px"}):bt`
            <button @click=${ee} class="button button--icon button--transparent button--xs font-manager__button">
                ${Li("cancel-icon","icon icon--12")}
            </button>`;return bt`
        <li class="${A}" style="${X}">
            ${Y}
            ${V}
            ${K}
        </li>`;function ee(){if(H)o(Z);else return p({fontsToUpload:m.fontsToUpload.filter(ge=>ge!==Z)})}function se(){let Ce={no_style:"font_not_readable",no_family_name:"font_not_readable",no_weight:"font_not_readable",parse_failed:"font_not_readable",font_type_not_supported:["font_not_supported",{fileType:BFN.getExtension(G).toUpperCase()}],italic_style:"font_italic_not_supported",google_font_conflict:["font_duplicate_google",{fontFamily:U}],already_uploaded:["font_file_already_uploaded",{font:()=>`${U} ${Ht(Aa[k],!0)}`}]}[R];return Ce?Ht(Ce):(BeFunky.logError("Unhandled font error:",R),BeFunky.failureReason(R))}}function D(Z){let{name:U,weights:k,weight:G,isDefault:L}=Z,R=["font-manager__item","font-manager__item--google"].filter(Boolean).join(" "),X=`background-image: url(${`${BFN.imagesURL}app/fonts/google_v2/${U.replace(/[^a-z0-9-]/gi,"")}-${G}.png`})`,Y;return L?Y=Li("checkmark-icon","icon font-manager__icon-selected font-manager__icon-selected--default",{tooltip:"font_already_included"}):m.fonts.find(ae=>ae.name===U&&ae.type==="google")?Y=Li("checkmark-icon","icon font-manager__icon-selected",{tooltip:"added_to_my_fonts"}):Y=bt`<button @click=${()=>e(U,k)} class="button button--icon button--circle button--transparent button--sm font-manager__add-google-font" data-tooltip="add_to_my_fonts">
                ${Li("plus-circle-icon","icon icon--14")}
            </button>`,bt`
        <li class="${R}">
            <div class="font-manager__font-image" style="${X}"></div>
            <string>${U}</string>
            <span class="font-manager__style font-manager__style--google text-xs">${Ht(Aa[G])}</span>
            ${Y}
        </li>`}function w(){let Z=[["serif","font_category_serif"],["sans-serif","font_category_sans_serif"],["display","font_category_display"],["handwriting","font_category_handwriting"],["monospace","font_category_monospace"]],U=Object.entries(Aa).map(),k=[["latin","latin"],["arabic","arabic"],["cyrillic","cyrillic"],["cyrillic-ext","cyrillic_extended"],["devanagari","devanagari"],["greek","greek"],["greek-ext","greek_extended"],["hebrew","hebrew"],["japanese","japanese"],["khmer","khmer"],["korean","korean"],["latin-ext","latin_extended"],["vietnamese","vietnamese"]];return bt`
        <div class="font-manager__google-menu">
            <div class="font-manager__search filter-box">
                ${Li("search-icon","icon filter-box__icon")}
                <input @keyup=${g} @change=${g} class="filter-box__input input input--sm" type="search" placeholder=${Ht("search",!0)}>
                ${m.searchInput?bt`
                <button class="button button--icon button--transparent filter-box__clear" @click=${_e}>
                    ${Li("cancel-icon","icon icon--10")}
                </button>`:""}
            </div>
            <div class="font-manager__google-scroll scrollable-content">
                <p class="font-manager__sub-heading text-sm bold" style="margin-top: 0.5rem">${Ht("font_category")}</p>
                ${Z.map(G=>N("category",G))}
                <p class="font-manager__sub-heading text-sm bold">${Ht("font_thickness")}</p>
                ${U.map(G=>N("style",G))}
                <h3 class="font-manager__sub-heading text-sm bold">${Ht("language")}</h3>
                ${k.map(G=>N("language",G))}
            </div>
        </div>`}function N(Z,[U,k]){let G=`font_manager_google_${Z}_${U}`,L={category:pe,style:Ie,language:ke};return bt`
        <div class="checkbox">
            <input type="checkbox" id="${G}" @change=${A=>L[Z](A,U)} .checked=${{category:()=>m.selectedCategories.includes(U),style:()=>m.selectedWeights.includes(U),language:()=>m.selectedSubsets.includes(U)}[Z]()}>
            <label class="checkbox__label" for="${G}">
                <span class="checkbox__box checkbox__box--sm">
                    ${Li("checkmark-icon","icon icon--12 checkbox__icon")}
                </span>
                <string>${Ht(k)}</string>
            </label>
        </div>`}function M(){BFN.DragAndDropManager.dragDropAreas=BFN.DragAndDropManager.dragDropAreas.filter(U=>!U._usedByFontManager);let Z=c.querySelector(".font-manager__drag-message");BFN.DragAndDropManager.dragDropAreas.push({_usedByFontManager:!0,visibleElem:Z,listeningElem:Z,isActive:!1,handler:ne,activeClass:"font-manager__drag-message--drop-target"})}function z(){let Z=Qo`<panel-header lang-id="manage_fonts" modifier="modal" buttons="close,help" clue-id="manage_font"></panel-header>`;return Z.addEventListener("CLOSE",()=>c.hide()),Z}function W(){let Z=Qo`<div></div>`;return BFN.HelpClueManager.setup("manage_font",{side:"top",positionFactor:.935,left:"calc(100% - 3.75rem)",top:"0.25rem",zIndex:1,container:Z}),Z}function j(){h||(h=!0,d(),n(!1),BeFunky.openModal(c,{size:[646,632],onOpen:()=>{BFN.HelpClueManager.show("manage_font")},onClose:()=>{h=!1,n(!0)},onWindowResize:({availableHeight:Z,availableWidth:U})=>{p({availableHeight:Z,availableWidth:U})}}))}function J(){!h||(h=!1,BeFunky.closeModal(c))}function ie(){let{googleFontWeights:Z,selectedCategories:U,selectedWeights:k,selectedSubsets:G,maxFontsToRender:L}=m,R=ee=>ee.toLowerCase().replace(/[^a-z0-9 ]/g,""),A=m.searchInput.split(/\s+/).map(R).filter(Boolean),X=!A.length||A.length===1&&A[0].length===1,Y=U.length?ee=>U.includes(ee.category):()=>!0,ae=k.length?ee=>k.some(se=>se===ee.weight):()=>!0,H=G.length?ee=>G.some(se=>ee.subsets.includes(se)):()=>!0,V=X?()=>!0:ee=>{let se=R(ee.name);return A.every(ge=>se.includes(ge))},K=[];v=!1;for(let ee=0;ee<Z.length;ee++){let se=Z[ee];if(Y(se)&&ae(se)&&H(se)&&V(se)&&(K.push(se),K.length===L&&ee+1!==Z.length)){v=!0;break}}return K}function re(){BeFunky.request(`${BFN.assetsURL}datas/google-fonts.77a7f106cf.json`,{},({error:Z,response:U})=>{if(Z)return BeFunky.logError("Unable to request Google Fonts");let k=U;l(k);let G=rs.map(R=>R.split(":")[0]),L=[];k.forEach(({name:R,weights:A,category:X,subsets:Y})=>{A.forEach(ae=>{L.push({name:R,weight:ae,weights:A,category:X,subsets:Y,isDefault:G.includes(R)})})}),p({googleFontWeights:L})})}function he(Z){Z.preventDefault(),a()}function ne(Z){p({mode:"UPLOAD"}),r(Z)}function le(){p({fontsToUpload:m.fontsToUpload.filter(Z=>!Z.error)}),s(m.fontsToUpload)}function Be(Z){let U=Z.target.value.trim();p({searchInput:U,maxFontsToRender:50}),f&&(f.scrollTop=0)}function _e(Z){Z.target.previousElementSibling.value="",p({searchInput:"",maxFontsToRender:50}),f&&(f.scrollTop=0)}function pe(Z,U){Z.target.checked?p({selectedCategories:[...m.selectedCategories,U].unique(),maxFontsToRender:50}):p({selectedCategories:m.selectedCategories.filter(k=>k!==U),maxFontsToRender:50}),f&&(f.scrollTop=0)}function Ie(Z,U){Z.target.checked?p({selectedWeights:[...m.selectedWeights,U].unique(),maxFontsToRender:50}):p({selectedWeights:m.selectedWeights.filter(k=>k!==U),maxFontsToRender:50}),f&&(f.scrollTop=0)}function ke(Z,U){Z.target.checked?p({selectedSubsets:[...m.selectedSubsets,U].unique(),maxFontsToRender:50}):p({selectedSubsets:m.selectedSubsets.filter(k=>k!==U),maxFontsToRender:50}),f&&(f.scrollTop=0)}function de(Z){if(m.mode!=="GOOGLE"||(f=f||Z.target,!v))return;let U=32+2,k=24,G=m.maxFontsToRender*U+k*2,L=m.availableHeight-56;G-L-Z.target.scrollTop<500&&p({maxFontsToRender:m.maxFontsToRender+50})}}var Vb=class extends BFN.EventDispatcher{constructor(){super();this.init()}init(){this.initDefaultValues(),this.initFontsList(),this.initFontMenu()}initDefaultValues(){this.defaultFontFamily="Open Sans",this.defaultFontWeight=400,this._activeFont=this.defaultFontFamily,this._activeFontWeight=this.defaultFontWeight,this.loadedFonts=[],this.fontLoadingPromises=[],this.userDefinedSystemFontsKey="options__userDefinedSystemFonts",this.customFontStylesheet=document.createElement("style"),this.customFontStylesheet.id="bfn_custom_fonts",document.head.appendChild(this.customFontStylesheet),this.fontTestingContext=null,this.monospaceTextWidth=null,this.serifTextWidth=null,this.monospaceFontList=["Andale Mono","Courier","Courier New","GB18030 Bitmap","Lantinghei TC","Monaco","Apple Braille","Cousine"].map(e=>e.toLowerCase()),this.fontTestingText="abcdefghijklmnopqrstuvwxyz0123456789",this.fontTestingSize="72",this.fontMenuComponent=null,this.favorites=[],this.uploadingFonts={},this.limitFontsForDesigners=null,this.saveUserDefinedSystemFonts=BeFunky.debounce(this.saveUserDefinedSystemFonts.bind(this),200),this.fontWeightDetectionFailures=null}initFontsList(){this.getUserDefinedSystemFontNames().then(e=>{let t=!1;e.forEach(a=>{let s=this.getFontObject(a);if(s)s.type==="system"?s.isUserDefined=!0:BeFunky.logError(`Unable to add user-defined system font "${a}" b/c of conflict`,s);else{t=!0;let o=new $i(a,"system",[],{isUserDefined:!0});BFN.CONST.FONT_LIST.push(o)}}),t&&BFN.CONST.FONT_LIST.sort((a,s)=>a.name.toLowerCase()>s.name.toLowerCase()?1:-1),(BFN.MainUI?BFN.MainUI.addIdleRenderFunction:requestIdleCallback)(()=>{this.testSystemFonts(!0,()=>{BFN.CONST.FONT_LIST.filter(({isUserDefined:a,isAvailable:s,type:o})=>a&&o==="system"&&!s).forEach(({name:a})=>this.removeUserDefinedFont(a))})})})}initFontMenu(){window.addEventListener("INIT_COMPLETE",()=>{let e=document.getElementById("text_edit_font_button");e.addEventListener("click",()=>{this.openFontMenu()}),this.popoverButtonText=e.querySelector("string"),this.popoverButtonText.textContent=this.activeFont,this.getRecentFonts().then(t=>{this.recentFontsFromPriorSession=t;let r=t[0];if(!r)return;(this.isLoaded(r)?Promise.resolve():this.load(r)).then(()=>{let{charStyles:s}=BFN.FabricManager.userStyle;s.fontFamily||(s.fontFamily=r)}).catch(s=>{BeFunky.logError("Failed to preload last-used font from prior session",s)})})}),this.preloadFontBGImageSprites=BeFunky.once(()=>{[`google-fonts-sprite.${BeFunky.Params.googleFontsSpriteVersion}.png`,`befunky-fonts-sprite.${BeFunky.Params.befunkyFontsSpriteVersion}.png`].forEach(t=>{let r=new Image;r.src=`${BFN.imagesURL}app/fonts/${t}`})})}setupFontMenuComponent(){if(this.fontMenuComponent)return;BFN.FontManager.testSystemFonts();let e=BeFunky.debounce(o=>{BFN.IndexedDB.set("options__recentFontFamilies",o).catch(n=>BeFunky.logError("Unable to update recentFontFamilies in IndexedDB",n))},1e3),t=o=>{BFN.SettingsManager.updateSetting("fonts_fav",o)},r=(o,n)=>{UITools.setToolValue("text_edit","weight",n),UITools.setToolValue("text_edit","font",o),UITools.applyTool("text_edit"),this.activeFont=o,this.activeFontWeight=n,BFN.BfnService.track("CREATE","FONTS",o.replace(" ","_").toUpperCase())},a=o=>{if(o.length<3||BFN.FontManager.findSimilarFont(o))return;let n=o===o.toLowerCase()?BFN.toTitleCase(o):o,l=new $i(n,"system",[]);BFN.FontManager.testFonts([l]),l.isAvailable&&this.addUserDefinedSystemFont(n,!0)},s={fonts:this.getFontObjectsForFontMenu(),activeFontName:this.activeFont,activeFontWeight:this.activeFontWeight,recent:this.recentFontsFromPriorSession||[],favorites:this.favorites};this.fontMenuComponent=Jo(s,{onFontSelection:r,onRecentFontsChange:e,onFavoriteFontsChange:t,isFontLoaded:o=>this.isLoaded(o),loadFont:o=>this.load(o),openFontManager:()=>this.openFontManagerModal(),testNewSystemFont:a}),BFN.appContainer.appendChild(this.fontMenuComponent),this.preloadUploadedFonts()}setupFontManagerComponent(){if(this.fontManagerComponent)return!0;if(!BFN.BfnService.userIsPlus)return BeFunky.openTeaserModal("font_management"),!1;let e={fonts:BFN.CONST.FONT_LIST.filter(n=>n.isUserDefined&&n.type!=="system")},t=(n,l)=>{BFN.SettingsManager.getSetting("fonts_added").then(c=>{let h=c.find(u=>u.name===n);if(h)throw h;BFN.SettingsManager.updateSetting("fonts_added",[...c,{name:n,type:"google",weights:l}])})},r=n=>{BFN.SettingsManager.getSetting("fonts_added").then(l=>{BFN.SettingsManager.updateSetting("fonts_added",l.filter(c=>c.name!==n))})},a=n=>{let l=[];BFN.CONST.FONT_LIST.filter(({type:c,isUserDefined:h})=>c==="google"&&h).forEach(c=>{let h=n.find(({name:u})=>u===c.name);h&&!h.weights.isIdenticalTo(c.weights)&&(console.log("Updating weights for user-saved Google font",c.name,c.weights," -> ",h.weights),c.weights=[...h.weights],this.load(c.name),l.push({name:c.name,weights:c.weights}))}),l.length&&(this.updateFontUI(),BFN.SettingsManager.getSetting("fonts_added").then(c=>{let h=c.map(u=>{let d=l.find(({name:m})=>m===u.name);return d?Object.assign({},u,{weights:d.weights}):u});BFN.SettingsManager.updateSetting("fonts_added",h,{updateUI:!1})}))},s,o=n=>{let l=BFN.CONST.FONT_LIST.filter(p=>p.isUserDefined&&p.type!=="system").reduce((p,g)=>Object.assign(p,{[g.name]:g.type}),{});if(!n){s=l;return}let c=Object.keys(l).filter(p=>!s[p]),h=Object.keys(s).filter(p=>!l[p]),d=[...c.map(p=>l[p]),...h.map(p=>s[p])].unique().map(p=>p==="google"?"Google":"User"),m=new BFN.UserActionVO;m.eventID="font_manager_opened",m.eventObject={},c.length&&(m.eventObject.fontManagerFontsAdded=c),h.length&&(m.eventObject.fontManagerFontsRemoved=h),d.length&&(m.eventObject.fontManagerFontSources=d),console.log(m),m.track()};return this.fontManagerComponent=Zo(e,{addGoogleFont:t,removeAddedFont:r,onFontFilesDropped:this.handleUserFontFiles.bind(this),browseForFonts:this.browseForFonts.bind(this),uploadFonts:this.uploadUserFonts.bind(this),cancelUpload:this.cancelUserFontUpload.bind(this),onGoogleFontListLoaded:a,trackFonts:o}),this.preloadUploadedFonts(),!0}isLoaded(e){return this.loadedFonts.includes(e)}getFontObject(e){return BFN.CONST.FONT_LIST.find(t=>t.name===e)}isInList(e){return BFN.CONST.FONT_LIST.some(t=>t.name===e)}findSimilarFont(e){if(this.isInList(e))return e;let t=Tl[e];if(t)return t;let r=o=>o.toLowerCase().replace(/[^a-z \u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]/g,"").trim().replace(/ (ot|tt|ofl)$/,"").replace(/ /g,""),a=r(e),s=BFN.CONST.FONT_LIST.find(o=>r(o.name)===a);return s?s.name:!1}load(e){if(this.fontLoadingPromises[e])return this.fontLoadingPromises[e];let t=BFN.FontManager.getFontObject(e);if(!t){let h=`Font "${e}" not found in FONT_LIST`;return BeFunky.throwError(h),Promise.reject(h)}let{type:r,weights:a,isAvailable:s,fileName:o,files:n}=t,l=new Promise((h,u)=>{if(r==="system")return s?h(e):(this.testFonts([t]),t.isAvailable?(this.testFontWeights([t]),h(e)):u("System font is unavailable"));let d=()=>{let p=a.length||1,g=[],f=[],v=(B,y)=>{let F=parseInt(y.replace(/[^\d]/g,""))*100;if(B?g.push(F):f.push(F),g.length+f.length-p==0)return g.length?f.length?(BeFunky.logError(`Loaded ${g.length} / ${p} font weights for font "${e}"`,{weightsLoaded:g,weightsNotLoaded:f}),g.length>=f.length?h(e):u(`Failed to load ${f.length} font weight(s) for "${e}"`)):(console.log(`Loaded ${p===1?"one weight":`all ${p} weights`} for font "${e}"`),this.loadedFonts.push(t.name),h(e)):u(`Failed to load font "${e}"`)},T={classes:!1,fontactive:(B,y)=>{v(!0,y)},fontinactive:(B,y)=>{v(!1,y)}},x=m();Lb.default.load(Object.assign(T,x))};function m(){if(r==="google")return{google:{families:[`${e}:${a.join(",")}`]}};let p=a.length?`:${a.map(g=>`n${g/100}`).join(",")}`:"";return{custom:{families:[`${e}${p}`]}}}if(this.unloadFont(e,r),r==="google")return d();if(r==="befunky"){let p=`${BFN.assetsURL}fonts/${o}`;return this.injectFontFace(e,[`url('${p}.woff2') format('woff2')`,`url('${p}.woff') format('woff')`]),d()}if(r==="uploaded")return n.forEach(({weight:p,fileName:g})=>{let f=BFN.getExtension(g),{cssFormat:v}=ha.find(x=>x.extension===f)||{};if(!v)return BeFunky.throwError(`Unsupported font type: "${f}"`,g);let T=`url('${BeFunky.Params.userFontsPath}${g}') format('${v}')`;this.injectFontFace(e,[T],p)}),d()});this.fontLoadingPromises[e]=l;let c=()=>{let{needsReloadedCallback:h}=this.fontLoadingPromises[e];if(delete this.fontLoadingPromises[e],h){let u=this.getFontObject(e);if(!u||u.type!=="uploaded")return;this.loadUploadedFont(e,h)}};return l.then(c).catch(c),l}loadUploadedFont(e,t){if(this.fontLoadingPromises[e]){this.fontLoadingPromises[e].needsReloadedCallback=t;return}this.load(e).then(t)}unloadFont(e,t){if(!["google","befunky","uploaded"].includes(t)){BeFunky.throwError("Invalid unloadFont type",t);return}let r=this.isLoaded(e);if(r&&(this.loadedFonts=this.loadedFonts.filter(a=>a!==e)),t==="uploaded"||t==="befunky"){let a=0;[...this.customFontStylesheet.sheet.cssRules].forEach((s,o)=>{Ai(s.cssText.match(/font-family:([^;]+);/)[1].trim())===e&&(this.customFontStylesheet.sheet.deleteRule(o-a),a++)}),a===0&&r&&BeFunky.throwError(`Unable to find @font-face rule for ${t} font ${e}`)}else{let s=`link[rel="stylesheet"][href^="${`https://fonts.googleapis.com/css?family=${e.split(" ").join("+")}:`}"]`,o=[];try{o=[...document.head.querySelectorAll(s)]}catch(n){BeFunky.throwError("Invalid Google Font stylesheet selector",s)}o.forEach(n=>n.parentElement.removeChild(n))}}testSystemFonts(e=!1,t=()=>{}){let r=BFN.CONST.FONT_LIST.filter(l=>l.type==="system"),a=()=>r.filter(l=>l.isAvailable===null),s=()=>r.filter(l=>l.isAvailable&&!l.weights.length);if(!e){this.testFonts(a()),this.testFontWeights(s()),this.fontWeightDetectionFailures&&(BeFunky.reportWarning("Font weight detection failures",this.fontWeightDetectionFailures),this.fontWeightDetectionFailures=null),t();return}let o=l=>{let c=a();if(!c.length)return n(l);this.testFonts(c,l),requestIdleCallback(o)},n=l=>{let c=s();if(!c.length){this.fontWeightDetectionFailures&&(BeFunky.reportWarning("Font weight detection failures",this.fontWeightDetectionFailures),this.fontWeightDetectionFailures=null),t();return}this.testFontWeights(c,l),requestIdleCallback(n)};requestIdleCallback(o)}setupFontTestingCanvasContext(){let e=document.createElement("canvas");this.fontTestingContext=e.getContext("2d"),BeFunky.isSafariMojave&&(e.id="system_font_detection_canvas",e.setStyles({display:"none"}),BFN.appContainer.appendChild(e)),this.fontTestingContext.font=`${this.fontTestingSize}px monospace`,this.monospaceTextWidth=this.fontTestingContext.measureText(this.fontTestingText).width,this.fontTestingContext.font=`${this.fontTestingSize}px serif`,this.serifTextWidth=this.fontTestingContext.measureText(this.fontTestingText).width}testFonts(e,t){this.fontTestingContext||this.setupFontTestingCanvasContext();for(let r of e){let a=r.name;if(t&&t.timeRemaining()<=1)break;let s=this.monospaceFontList.includes(a.toLowerCase()),o=s?"serif":"monospace",n=s?this.serifTextWidth:this.monospaceTextWidth;this.fontTestingContext.font=`${this.fontTestingSize}px ${ei(a)}, ${o}`;let l=this.fontTestingContext.measureText(this.fontTestingText).width;r.isAvailable=l!==n,r.isAvailable&&(r.originalMeasuredTextSize=l,BeFunky.isChromeOS&&(l===1548||l===1555.453125)&&(n===1548||n===1555.453125)&&(BeFunky.logWarning(`Marking font ${a} as unavailable in ChromeOS`,r),r.isAvailable=!1))}}testFontWeights(e,t){this.fontTestingContext||this.setupFontTestingCanvasContext();for(let r of e){let a=r.name;if(t&&t.timeRemaining()<=1)break;if(!r.isAvailable){BeFunky.throwError(`Font ${ei(a)} is not available or has not been tested`,r);continue}let s=this.monospaceFontList.includes(a.toLowerCase()),o=s?"serif":"monospace",n=s?this.serifTextWidth:this.monospaceTextWidth,l={},c=u=>{if(l[u])return l[u];this.fontTestingContext.font=`${u} ${this.fontTestingSize}px ${ei(a)}, ${o}`;let d=this.fontTestingContext.measureText(this.fontTestingText).width;return n===d&&(this.fontWeightDetectionFailures=this.fontWeightDetectionFailures||{},this.fontWeightDetectionFailures[a]=this.fontWeightDetectionFailures[a]||[],this.fontWeightDetectionFailures[a].push(u),this.debugFontWeightDetection({message:`Font weight detection failed for ${ei(a)}`,shouldReport:!1,fontObject:r,weight:u,measuredTextSize:d,baselineFont:o,baselineTextSize:n})),l[u]=d,d},h=()=>{if(c(100)===c(900))return[400];if(c(100)===c(500)&&c(600)===c(900))return[400,700];let u={};for(let m=100;m<=900;m+=100){let p=c(m);u[p]?u[p].push(m):u[p]=[m]}let d=[400,700];return Object.values(u).map(m=>{if(m.length===1)return m[0];let p=d.find(T=>m.includes(T));if(p)return p;m.every((T,x)=>x===0||T-m[x-1]==100)||BeFunky.reportWarning("Weights for font are not consecutive",a,m,u);let f=Math.max(...m),v=Math.min(...m);return f<400?v:f}).filter(Boolean).sort()};r.weights=h()}}debugFontWeightDetection({message:e,shouldReport:t=!0,fontObject:r,weight:a,measuredTextSize:s,baselineFont:o,baselineTextSize:n}){let l={};for(let f=100;f<=900;f+=100)this.fontTestingContext.font=`${f} ${this.fontTestingSize}px ${o}`,l[f]=this.fontTestingContext.measureText(this.fontTestingText).width;let c={};for(let f=100;f<=900;f+=100)this.fontTestingContext.font=`${f} ${this.fontTestingSize}px ${ei(r.name)}, ${o}`,c[f]=this.fontTestingContext.measureText(this.fontTestingText).width;let h=o==="monospace"?"serif":"monospace",u=o==="monospace"?this.serifTextWidth:this.monospaceTextWidth;this.fontTestingContext.font=`${this.fontTestingSize}px ${ei(r.name)}, ${o}`;let d=this.fontTestingContext.measureText(this.fontTestingText).width;this.fontTestingContext.font=`${this.fontTestingSize}px monospace`;let m=this.fontTestingContext.measureText(this.fontTestingText).width;this.fontTestingContext.font=`${this.fontTestingSize}px serif`;let p=this.fontTestingContext.measureText(this.fontTestingText).width,g={name:r.name,weight:a,measuredTextSize:s,baselineFont:o,baselineTextSize:n,baselineSizes:JSON.stringify(l),fontSizes:JSON.stringify(c),altBaseLineFont:h,altBaseLineFontSize:u,originalMeasuredTextSize:r.originalMeasuredTextSize,textSizeAtDefaultSize:d,monospaceWidthChanged:m!==this.monospaceTextWidth?`Yes, from ${this.monospaceTextWidth} to ${m}`:"No",serifWidthChanged:p!==this.serifTextWidth?`Yes, from ${this.serifTextWidth} to ${p}`:"No"};t?BeFunky.reportWarning(e,g):BeFunky.logWarning(e,g)}addUserDefinedSystemFont(e,t=!1){e=Ai(e);let r=this.getFontObject(e);if(r)return BeFunky.throwError("Attempted to add user-defined system font when one already existed",r),!1;let a=new $i(e,"system",[],{isUserDefined:!0});if(t)a.isAvailable=!0;else if(this.testFonts([a]),!a.isAvailable)return!1;return this.testFontWeights([a]),console.log("Adding user-defined system font:",a),BFN.CONST.FONT_LIST=BFN.CONST.FONT_LIST.concat([a]).sort((s,o)=>s.name.toLowerCase()>o.name.toLowerCase()?1:-1),this.updateFontUI(),this.saveUserDefinedSystemFonts(),!0}addUserDefinedFontFromSettings(e,t,{weights:r,files:a}={}){let s=new $i(e,t,r,{isUserDefined:!0,files:a}),o=this.getFontObject(e);if(o)if(!o.isUserDefined)s.replacedDefaultFont=o;else if(o.type==="system")s.replacedDefaultFont=o;else if(o.type===t){let n=o.weights.isIdenticalTo(r),l=JSON.stringify(o.files)===JSON.stringify(a);if(t==="google"){if(n)return;o.weights=r}if(t==="uploaded"){if(n&&l)return;o.weights=r,o.files=a}}else return BeFunky.throwError(`Can't replace ${o.type} font with ${t} font`),!1;return s.replacedDefaultFont?(BFN.CONST.FONT_LIST.splice(BFN.CONST.FONT_LIST.indexOf(o),1,s),console.log(`Replacing ${o.type} font with user-defined font:`,s)):o||(BFN.CONST.FONT_LIST=BFN.CONST.FONT_LIST.concat([s]).sort((n,l)=>n.name.toLowerCase()>l.name.toLowerCase()?1:-1)),(this.fontMenuComponent||this.fontManagerComponent)&&(t==="google"?this.updateFontUI():this.loadUploadedFont(e,()=>this.updateFontUI())),!0}removeUserDefinedFont(e){console.log("Removing user-defined font:",e);let t=this.getFontObject(e);if(!t||!t.isUserDefined)return BeFunky.throwError(`User-defined font "${e}" is not in list.`,t),!1;BFN.CONST.FONT_LIST=BFN.CONST.FONT_LIST.filter(a=>a!==t);let{replacedDefaultFont:r}=t;return r&&(BFN.CONST.FONT_LIST=BFN.CONST.FONT_LIST.concat([r]).sort((a,s)=>a.name.toLowerCase()>s.name.toLowerCase()?1:-1),r.type==="system"&&(this.testFonts([r]),r.isAvailable&&this.testFontWeights([r]))),this.updateFontUI(),t.type==="system"?this.saveUserDefinedSystemFonts():this.unloadFont(e,t.type),!0}getUserDefinedSystemFontNames(){return BFN.IndexedDB.get(this.userDefinedSystemFontsKey).catch(e=>{BeFunky.logError("Unable to get user-defined system font names",e)}).then(e=>Array.isArray(e)?e.filter(t=>t&&typeof t=="string"):[])}saveUserDefinedSystemFonts(){BFN.IndexedDB.set(this.userDefinedSystemFontsKey,BFN.CONST.FONT_LIST.filter(e=>e.isUserDefined&&e.type==="system").map(e=>e.name)).catch(e=>{BeFunky.logError("Unable to save user-defined system font names",e)})}getRecentFonts(){return BFN.IndexedDB.get("options__recentFontFamilies").catch(e=>(BeFunky.logError("Unable to get recent font families from IndexedDB",e),[])).then(e=>Array.isArray(e)?e.map(t=>this.findSimilarFont(t)).filter(Boolean):[])}injectFontFace(e,t,r="normal"){this.customFontStylesheet.sheet.insertRule(`
            @font-face {
                font-family: ${ei(e)};
                src: ${t.join(`,
`)};
                font-weight: ${r};
                font-style: normal;
            }
        `,0)}preloadUploadedFonts(){let e=BFN.CONST.FONT_LIST.filter(({type:t,name:r})=>t==="uploaded"&&!this.isLoaded(r)).map(({name:t})=>BFN.FontManager.load(t).catch(r=>{BeFunky.logError(`Unable to preload user-uploaded font "${t}"`,r)}));!e.length||Promise.all(e).then(()=>{this.updateFontUI()})}getFontObjectsForFontMenu(){return this.limitFontsForDesigners===null&&(this.limitFontsForDesigners=Boolean(BeFunky.getLocal("exclude_system_fonts"))),this.limitFontsForDesigners?BFN.CONST.FONT_LIST.filter(e=>!e.isUserDefined&&(e.type==="google"||e.type==="befunky")):BFN.CONST.FONT_LIST.filter(e=>e.isAvailable!==!1)}openFontMenu(){this.setupFontMenuComponent(),this.fontMenuComponent.show()}closeFontMenu(){this.fontMenuComponent&&this.fontMenuComponent.hide()}updateFontUI(){this.fontMenuComponent&&this.fontMenuComponent.setState({fonts:this.getFontObjectsForFontMenu()}),this.fontManagerComponent&&this.fontManagerComponent.setState({fonts:BFN.CONST.FONT_LIST.filter(e=>e.isUserDefined&&e.type!=="system")})}openFontManagerModal(){BFN.FabricManager.currentTextTransformItem&&BFN.FabricManager.currentTextTransformItem.exitTextEditing(),this.setupFontManagerComponent()&&(this.fontManagerComponent.show(),BeFunky.showAnnouncementOnce("font_management"))}browseForFonts(){let e={fileType:"fonts",createMenuImageVO:!1},t=[];BFN.MultipleFileUploader.upload(({file:r,isComplete:a})=>{if(a)return this.handleUserFontFiles(t);t.push(r)},e)}handleUserFontFiles(e){if(!this.setupFontManagerComponent())return;let t=this.fontManagerComponent.state.fontsToUpload;t.find(a=>a.uploadProgress===100)&&this.fontManagerComponent.setState({fontsToUpload:t.filter(a=>a.uploadProgress!==100)});let r=this.fontManagerComponent.state.fontsToUpload.map(a=>a.fileName);BeFunky.showLoadScreen(),this.processFontFiles(e,r).then(a=>{let s=this.fontManagerComponent.state.fontsToUpload,n=50-s.length,l=[];if(n>0){let c=({fontFamily:h,fontWeight:u,fileName:d,error:m},p)=>h?p.fontFamily===h&&p.fontWeight===u&&p.error===m:p.fileName===d&&p.error===m;a.forEach(h=>{n-l.length<=0||s.find(u=>c(h,u))||l.find(u=>c(h,u))||l.push(h)}),this.fontManagerComponent.setState({fontsToUpload:[...l,...this.fontManagerComponent.state.fontsToUpload]})}this.fontManagerComponent.setState({mode:"UPLOAD"}),this.openFontManagerModal(),BeFunky.hideLoadScreen()})}processFontFiles(e,t){let r=50;if(e=e.filter(h=>!t.includes(h.name)).filter(h=>BFN.DragAndDropManager.fontExtensions.includes(BFN.getExtension(h.name))).slice(0,r),!e.length)return Promise.resolve([]);return l().then(()=>Promise.all(e.map(a))).catch(h=>(h==="request_failed"?BeFunky.logError("Unable to load OpenType.js"):BeFunky.throwError("Font processing failed",h),[]));function a(h){return s(h).then(u=>{let{fontFamily:d,fontStyle:m,fontWeight:p,isItalic:g}=u,f;g&&(f="italic_style");let v=BFN.CONST.FONT_LIST.find(({name:x})=>x===d);v&&v.type==="google"&&(f="google_font_conflict"),v&&v.type==="uploaded"&&v.files.find(({weight:x})=>x===p)&&(f="already_uploaded");let T=h.name;return{fontFamily:d,fontStyle:m,fontWeight:p,file:h,fileName:T,fileNameToUpload:c(Object.assign({fileName:T},u)),uploadProgress:null,error:f}}).catch(u=>({fileName:h.name,error:u}))}function s(h){let u=BFN.getExtension(h.name);return ha.map(m=>m.extension).includes(u)?n(h).then(o):Promise.reject("font_type_not_supported")}function o(h){let u;try{u=window.opentype.parse(h)}catch(b){throw BeFunky.logError("Unable to parse font file:",b),"parse_failed"}let d=[],m=v();if(!m)throw"no_style";let p=F(T());if(!p)throw BeFunky.logWarning("Failed to get font family name:",u.names,{fontStyle:m}),"no_family_name";let g=x();if(!g)throw"no_weight";let f=/italic/i.test(m);return console.log({fontFamily:p,fontStyle:m,fontWeight:g,isItalic:f}),{fontFamily:p,fontStyle:m,fontWeight:g,isItalic:f};function v(){let b=u.getEnglishName("preferredSubfamily")||u.getEnglishName("fontSubfamily")||"Regular";d.push(b);let I=(u.getEnglishName("postScriptName")||"").split("-"),_=I.length===2?I[1]:"";if(_&&b&&y(b)!=="italic"&&y(_)!==y(b)){if(d.push(_),{Reg:"Regular",Lt:"Light",Med:"Medium",SmBd:"Semibold"}[_]===b)return b;let D=u.getEnglishName("fullName")||"",w=D.includes(b),N=D.includes(_);return w&&!N?(BeFunky.logError(`Font style (${b}) does not match postScriptName (${_}). Choosing the former: ${b}.`,u.names),b):(BeFunky.logError(`Font style (${b}) does not match postScriptName (${_}). Choosing the later: ${_}.`,u.names),_)}return b===u.getEnglishName("fullName")&&b===u.getEnglishName("fontFamily")?(d.splice(0),"Regular"):b}function T(){let b=u.getEnglishName("preferredFamily");if(b)return b;let S=w=>w.trim().replace(/[-/\\^$*+?.()|[\]{}]/g,"\\$&"),I=new RegExp(d.map(S).join("|"),"ig"),E=["fullName","fontFamily"].map(w=>u.getEnglishName(w)).filter(Boolean).map(w=>w.replace(I,"").replace(/italic( |$)/i,"").replace(/\s+/g," ").replace(/(^-+)|(-+$)/g,"").trim()).filter(Boolean);return E.length?E.length===1?E[0]:(((w,N)=>(w=y(w).replace(/italic|condensed|extended|oblique/g,""),N=y(N).replace(/italic|condensed|extended|oblique/g,""),w===N))(...E)||BeFunky.throwError("Font family detection should be improved",{fontStyle:m,options:E},u.names),E[0].length>=E[1].length?E[0]:E[1]):""}function x(){let b=["italic","condensed","extended","oblique","no\\.? \\d+","caps"],S=m.toLowerCase().trim();S.includes(" ")?S=S.replace(new RegExp(`(^| )${b.join("|")}( |$)`,"g"),""):S=S.replace(new RegExp(b.join("|"),"g"),"");let I=B(S),_=Object.entries(as).map(([w,N])=>[w,B(N)]),E={demibold:"semibold",hairline:"thin"};E[I]&&(I=E[I]);let D=_.find(([,w])=>w===I);if(D)return parseInt(D[0]);if(/bold/i.test(m)||/light/i.test(m)||/thin/i.test(m))BeFunky.throwError("Font weight matching should be improved",u.names);else return y(m)!=="italic"&&BeFunky.logError("Unable to get weight for font. Defaulting to 400.",{fontStyle:m,fontFamily:p}),400}function B(b){return b.toLowerCase().replace(/[^a-z]/g,"")}function y(b){return b.toLowerCase().replace(/[^a-z0-9]/g,"")}function F(b){return b.replace(/'s( |$)/g,"\u2019s$1")}}function n(h){return new Promise((u,d)=>{BFN.BlobUtils.blobToArrayBuffer(h,({error:m,arrayBuffer:p})=>{if(m)return d(m);u(p)})})}function l(){return BeFunky.loadScript(`${BFN.jsURL}opentype.0.8.0.min.js`,()=>window.opentype)}function c({fileName:h,fontFamily:u,fontStyle:d,fontWeight:m}){let p=BFN.getExtension(h),g=u.replace(/[^a-z0-9-]/gi,""),f=d.replace(/[^a-z0-9-]/gi,""),v=BFN.getDateParts().slice(0,3).join(""),T=BeFunky.randomString(10);return`${g}-${f}-${m}-${v}-${T}.${p}`}}uploadUserFonts(e,t=!0){e.forEach(s=>{let{fileNameToUpload:o,file:n,fontFamily:l,fontWeight:c}=s;if(this.uploadingFonts[o]){BeFunky.throwError("Duplicate font file upload attempt");return}this.updateFontUploadProgress(s,0,t),this.uploadingFonts[o]=BeFunky.uploadFileToS3(n,{bucket:"user-fonts",contentType:r(n),fileName:o,progressHandler:(h,u)=>{let d=Math.round(100*h/u);this.updateFontUploadProgress(s,d,t)}}),this.uploadingFonts[o].then(()=>{this.updateFontUploadProgress(s,100,t),a(l,c,o)}).catch(h=>{this.uploadingFonts[o].wasCancelled?BeFunky.logError("Font upload cancelled:",o):(BeFunky.logError("Font upload failed:",h),s.error=h),this.updateFontUploadProgress(s,null)}).then(()=>{delete this.uploadingFonts[o]})});function r(s){let o=BFN.getExtension(s.name),{mimeType:n}=ha.find(l=>l.extension===o)||{};return n||BeFunky.throwError(`Unsupported font type "${o}"`,s.name),n}function a(s,o,n){BFN.SettingsManager.getSetting("fonts_added").then(l=>{let c={name:s,type:"uploaded",weight:o,fileName:n};BFN.SettingsManager.updateSetting("fonts_added",[...l,c])})}}cancelUserFontUpload(e){let{fileNameToUpload:t}=e;this.uploadingFonts[t].cancelUpload(),this.uploadingFonts[t].wasCancelled=!0}updateFontUploadProgress(e,t,r=!0){e.uploadProgress=t,!!r&&(this.fontManagerComponent.state.fontsToUpload.includes(e)||BeFunky.throwError("Font not in fontsToUpload"),this.fontManagerComponent.setState({fontsToUpload:[...this.fontManagerComponent.state.fontsToUpload]}))}get activeFont(){return this._activeFont}set activeFont(e){e=Ai(e),e!==this._activeFont&&(this._activeFont=e,this.fontMenuComponent&&this.fontMenuComponent.setState({activeFontName:e}),this.popoverButtonText&&(this.popoverButtonText.textContent=this.activeFont))}get activeFontWeight(){return this._activeFontWeight}set activeFontWeight(e){if(!Br(e)){BeFunky.throwError("Invalid font weight:",e);return}e!==this._activeFontWeight&&(this._activeFontWeight=e,this.fontMenuComponent&&this.fontMenuComponent.setState({activeFontWeight:e}))}};BFN.SingletonQueue.add(()=>{BFN.FontManager=new Vb});var Ub=class{constructor(){this.init()}init(){BeFunky.log("FabricManager Init"),this.initDefaultValues(),this.initFabricCanvas(),this.initDefaultFont()}initDefaultValues(){this.$fabricCanvas=document.getElementById("fabricCanvas"),fabric.Object.prototype.transparentCorners=!1,this.textChanged=!1,this.styleChanged=!1,this.styleUpdating=!1,this.globalStylesUpdating=!1,this.styleChangeRequested=!1,this.desiredStyle=null,this.lastSelectionStart=-1,this.lastSelectionEnd=-1,this.mixedCharacter="\u2014",this.userStyle={globalStyles:{},charStyles:{},itemStyles:{}},this.defaultBackgroundColor="FF0000",this.defaultOutlineColor="6666FF",this.defaultHighlightColor="FFFF66",this.startValues={},this.globalStyles=["textAlign","charSpacing","lineHeight"],this.itemStyles=["backgroundEnabled","backgroundColor","backgroundIntensity","backgroundPadding","outlineEnabled","highlightEnabled"],this.handleTextChangedBind=this.handleTextChanged.bind(this),this.handleTextSelectionChangedBind=this.handleTextSelectionChanged.bind(this),this.handleTextEditingExitedBind=this.handleTextEditingExited.bind(this),this.handleTextRightClickBind=this.handleTextRightClick.bind(this),this.handleTextDisplayUpdatedBind=this.handleTextDisplayUpdated.bind(this),this.handleBGMouseDownBind=this.handleBGMouseDown.bind(this),this.handleStageDimensionsUpdatedBind=this.handleStageDimensionsUpdated.bind(this),this.handleMainUIRenderedBind=this.handleMainUIRendered.bind(this),this.handleTextDeselectedBind=this.handleTextDeselected.bind(this),this.addStyleChangesToHistoryDebounced=BeFunky.debounce(this.addStyleChangesToHistoryDebounced.bind(this),200),document.addEventListener("keydown",this.handleDocumentKeyPress.bind(this),!0),BFN.BfnService.addEventListener(BFN.BfnServiceEvents.USER_DATA_CHANGED.type,()=>setTimeout(BFN.FabricManager.updateStageDimensions.bind(this),0)),BFN.BfnService.addEventListener(BFN.BfnServiceEvents.CUSTOM_RESIZE_EVENT.type,()=>setTimeout(BFN.FabricManager.updateStageDimensions.bind(this),0))}initFabricCanvas(){this.updateStageDimensions(),this.fabricCanvas=new fabric.Canvas("fabricCanvas",{enableRetinaScaling:window.bfn_resolution===2,fireRightClick:!0,stopContextMenu:!0}),this.fabricCanvas.selection=!1,this.fabricCanvasContext=this.fabricCanvas.getContext(),this.fabricCanvas.renderOnAddRemove=!1,this.fabricCanvas.skipOffscreen=!1,this.$fabricCanvas.setStyles({display:"none"})}updateStageDimensions(){let e={width:BFN.appRect.width-BFN.leftMenuMinimumWidth,height:BFN.appRect.height-(BeFunky.isWiderThanMobile()?BFN.bottomMenuMinimumHeight:BFN.alternateMenuBaseHeightOnMobile)};e.width<1&&e.height<1||(this.fabricCanvas?(this.fabricCanvas.width!==e.width||this.fabricCanvas.height!==e.height)&&(this.fabricCanvas.setWidth(e.width),this.fabricCanvas.setHeight(e.height)):(this.$fabricCanvas.setAttribute("width",e.width),this.$fabricCanvas.setAttribute("height",e.height)))}initDefaultFont(){this.activeFontFamily=null,this.activeFontWeight=null,setTimeout(()=>{this.loadFont(this.defaultFontFamily,this.defaultFontWeight)},100)}handleTextEditSelection(){if(BFN.TransformModel.selectedGroupType==="text"){let e=UITools.getToolVO("text_edit"),t=(s,o=null)=>e.updating?(this.styleUpdating||(this.styleUpdating=!0,BFN.TransformItemGroup.clearDropShadow(),BFN.TransformItemGroup.createTransition(s),o&&o()),!1):(this.styleUpdating||(BFN.TransformItemGroup.clearDropShadow(),BFN.TransformItemGroup.createTransition(s),o&&o()),this.styleUpdating=!1,!0),r=()=>{BFN.TransformItemGroup.transformLayer.transformTool.updateDisplay(),BFN.TransformItemGroup.transformLayer.transformTool.fadeAnimator.increase()},a=(s={},o=null,n=void 0)=>{for(let l in s){let c=s[l];this.setUserStyle(l,c)}BFN.TransformItemGroup.selectedItems.forEach(l=>{l.setITextStyle(o?o(l):s)}),BFN.TransformItemGroup.transformLayer.transformTool.fadeAnimator.decrease(),BFN.TransformItemGroup.strokeRectanglePool.clear(),BFN.TransformItemGroup.registerTransition(n,!0,!0,r,!0)};switch(e.updating_id){case"spacing_menu_popover_button":e.updating||(BFN.alternateMenu.popupMenuId=BFN.alternateMenu.popupMenuId==="text_spacing"?"":"text_spacing");return;case"font":{let s=this.activeFontFamily===e.font?"history_font_weight":"history_font_family";if(t(s)){let o=Ai(e.font);this.setUserStyle("fontFamily",o),this.loadFont(o,e.weight)}break}case"size":{t("history_font_size")&&(BFN.TransformItemGroup.selectedItems.forEach(s=>{let o=s.iText,n={charSpacing:o.charSpacing,textBackgroundPadding:s.textBackgroundPadding},l=e.size/(s.scale.x*s.textScale);this.setStyle(o,"fontSize",l),s.conformITextToSmallestFontSize(),s.textScale/=s.fontSizeNormalizeFactor;for(let u in o.styles){let d=o.styles[u];for(let m in d){let p=d[m];p.hasOwnProperty("strokePercent")&&p.hasOwnProperty("fontSize")&&(p.strokeWidth=p.strokePercent*p.fontSize)}}let c=null;for(let u in o.styles){let d=o.styles[u];for(let m in d){let p=d[m];p.hasOwnProperty("fontSize")&&(c===null||p.fontSize<c)&&(c=p.fontSize)}}let h=1;c!==null&&(h=c/BFN.TransformItemTextBaseFontSize),o.charSpacing=Math.round(n.charSpacing*h),s.textBackgroundPadding=n.textBackgroundPadding*h,s.updateITextBackgroundDisplay(),o.__skipDimension=!1,o.initDimensions(),s.setTextWidth(s.iText.width*s.textScale*s.scale.x)}),BFN.TransformItemGroup.transformLayer.transformTool.fadeAnimator.decrease(),BFN.TransformItemGroup.strokeRectanglePool.clear(),BFN.TransformItemGroup.registerTransition(void 0,!0,!0,r,!0));break}case"spacing":{t("history_letter_spacing")&&a({charSpacing:e.spacing*100});break}case"line_height":{t("history_text_line_height")&&a({lineHeight:e.line_height/100});break}case"bold":{if(t("history_text_bold")){let s=e.bold?this.getBoldWeight(e.font):this.getNormalWeight(e.font);a({fontWeight:s},null,!0)}break}case"italic":{if(t("history_text_italic")){let s=e.italic?"italic":"";a({fontStyle:s},null,!0)}break}case"underline":{if(t("history_text_underline")){let s=e.underline;a({underline:s},null,!0)}break}case"align":{t("history_text_align")&&a({textAlign:e.align},null,!0);break}case"text_color":{if(t("history_text_color",()=>{let o=BFN.TransformItemGroup.getTextGroupStyleData();((o.fill==="mixed"||o.fill==="#00000000")&&e.text_color!=-1||e.text_color==-1)&&(UITools.setToolValue("text_edit","text_color_intensity",1,!1),UITools.updateToolControl("text_edit_text_color"),BFN.ColorPickerPanel.refreshIntensitySlider())})){let o=e.text_color==-1?"#00000000":BFN.ColorUtil.hexStringObjectToRGBAString({hex:e.text_color,alpha:e.text_color_intensity});a({fill:o})}break}case"background_enabled":if(t(e.background_enabled?"history_text_background_on":"history_text_background_off")&&(a({backgroundEnabled:e.background_enabled}),e.background_enabled&&!this.userStyle.itemStyles.hasOwnProperty("backgroundColor")&&this.setUserStyle("backgroundColor",this.defaultBackgroundColor),document.getElementById("text_edit_background_enabled").isOpen)){let s=BFN.TransformItemGroup.getTextGroupStyleData(),o=s.backgroundColor&&s.backgroundColor!=="mixed"?s.backgroundColor:-1;o!=-1&&s.backgroundIntensity!=="mixed"?(UITools.setToolValue("text_edit","background_color",o),UITools.setToolValue("text_edit","background_color_intensity",s.backgroundIntensity)):(UITools.setToolValue("text_edit","background_color",-1),UITools.setToolValue("text_edit","background_color_intensity",1)),UITools.setToolValue("text_edit","background_padding",s.hasOwnProperty("backgroundPadding")&&s.backgroundPadding!=="mixed"?s.backgroundPadding:0),UITools.updateToolControl("text_edit_background_color"),UITools.updateToolControl("text_edit_background_padding"),document.getElementById("text_edit_background_padding").isMixed=s.backgroundPadding==="mixed"}break;case"background_color":{t("history_text_background_color",()=>{let o=BFN.TransformItemGroup.getTextGroupStyleData();((o.backgroundColor==="mixed"||o.backgroundColor===-1||o.backgroundIntensity==="mixed")&&e.background_color!=-1||e.background_color==-1)&&(UITools.setToolValue("text_edit","background_color_intensity",1,!1),UITools.updateToolControl("text_edit_background_color"),BFN.ColorPickerPanel.refreshIntensitySlider())})&&a({backgroundColor:e.background_color,backgroundIntensity:e.background_color_intensity});break}case"background_padding":{t("history_text_background_padding")&&a({backgroundPadding:e.background_padding});break}case"stroke_enabled":if(t(e.stroke_enabled?"history_text_outline_on":"history_text_outline_off")){if(a({outlineEnabled:e.stroke_enabled}),e.stroke_enabled&&!this.userStyle.itemStyles.hasOwnProperty("stroke")){let s=this.userStyle.charStyles,o=s.stroke?s.stroke:BFN.ColorUtil.hexStringObjectToRGBAString({hex:this.defaultOutlineColor,alpha:1});this.setUserStyle("stroke",o)}if(document.getElementById("text_edit_stroke_enabled").isOpen){let s=BFN.TransformItemGroup.getTextGroupStyleData(),o=s.stroke&&s.stroke!=="mixed"?s.stroke:"";if(o!==""){let l=BFN.ColorUtil.rgbaStringToHexStringObject(o);UITools.setToolValue("text_edit","stroke_color",l.hex),UITools.setToolValue("text_edit","stroke_color_intensity",l.alpha)}else UITools.setToolValue("text_edit","stroke_color",-1),UITools.setToolValue("text_edit","stroke_color_intensity",0);let n=s.strokePercent&&s.strokePercent!=="mixed"?s.strokePercent:BFN.TransformItemTextStrokePercentDefault;UITools.setToolValue("text_edit","stroke_width",Math.round(this.textStrokePercentToFactor(n)*99)+1),UITools.updateToolControl("text_edit_stroke_color"),UITools.updateToolControl("text_edit_stroke_width"),document.getElementById("text_edit_stroke_width").isMixed=s.strokePercent==="mixed"}}break;case"stroke_color":{if(t("history_text_outline_color",()=>{let o=BFN.TransformItemGroup.getTextGroupStyleData();((o.stroke==="mixed"||o.stroke==="")&&e.stroke_color!=-1||e.stroke_color==-1)&&(UITools.setToolValue("text_edit","stroke_color_intensity",1,!1),UITools.updateToolControl("text_edit_stroke_color"),BFN.ColorPickerPanel.refreshIntensitySlider())})){let o=e.stroke_color==-1?"":BFN.ColorUtil.hexStringObjectToRGBAString({hex:e.stroke_color,alpha:e.stroke_color_intensity});a({stroke:o})}break}case"stroke_width":{if(t("history_text_outline_width")){let s=this.factorToTextStrokePercent((e.stroke_width-1)/99);a({strokePercent:s})}break}case"highlight_enabled":if(t(e.highlight_enabled?"history_text_highlight_on":"history_text_highlight_off")){if(a({highlightEnabled:e.highlight_enabled}),e.highlight_enabled&&!this.userStyle.itemStyles.hasOwnProperty("textBackgroundColor")){let s=this.userStyle.charStyles,o=s.textBackgroundColor?s.textBackgroundColor:BFN.ColorUtil.hexStringObjectToRGBAString({hex:this.defaultHighlightColor,alpha:1});this.setUserStyle("textBackgroundColor",o)}if(document.getElementById("text_edit_highlight_enabled").isOpen){let s=BFN.TransformItemGroup.getTextGroupStyleData(),o=s.textBackgroundColor&&s.textBackgroundColor!=="mixed"?s.textBackgroundColor:"";if(o!==""){let n=BFN.ColorUtil.rgbaStringToHexStringObject(o);UITools.setToolValue("text_edit","highlight_color",n.hex),UITools.setToolValue("text_edit","highlight_color_intensity",n.alpha)}else UITools.setToolValue("text_edit","highlight_color",-1),UITools.setToolValue("text_edit","highlight_color_intensity",s.textBackgroundColor==="mixed"?1:0);UITools.updateToolControl("text_edit_highlight_color")}}break;case"highlight_color":{if(t("history_text_highlight_color",()=>{let o=BFN.TransformItemGroup.getTextGroupStyleData();((o.textBackgroundColor==="mixed"||o.textBackgroundColor==="")&&e.stroke_color!=-1||e.stroke_color==-1)&&(UITools.setToolValue("text_edit","highlight_color_intensity",1,!1),UITools.updateToolControl("text_edit_highlight_color"),BFN.ColorPickerPanel.refreshIntensitySlider())})){let o=e.highlight_color==-1?"":BFN.ColorUtil.hexStringObjectToRGBAString({hex:e.highlight_color,alpha:e.highlight_color_intensity});a({textBackgroundColor:o})}break}}}}handleTextEdit(){if(BFN.TransformModel.selectedGroupType==="text"){this.handleTextEditSelection();return}let e=UITools.getToolVO("text_edit"),{textTransformItem:t}=this;if(this.updateLastTransitionIfGlobal=!1,t){this.textChanged&&(this.textChanged=!1,t.setTextWidth(t.iText.width*t.textScale*t.scale.x),t.registerTransition(!1,!1)),this.styleChanged=!1;let{iText:a}=t;switch(e.updating_id){case"spacing_menu_popover_button":e.updating||(BFN.alternateMenu.popupMenuId=BFN.alternateMenu.popupMenuId==="text_spacing"?"":"text_spacing");return;case"font":{let c=this.activeFontFamily!==e.font,h=this.activeFontWeight!==e.weight;if(!c&&!h)return;c?this.createTransformItemTransition(t,"history_font_family"):this.createTransformItemTransition(t,"history_font_weight");let u=Ai(e.font);this.loadFont(u,e.weight),this.setUserStyle("fontFamily",u),this.setUserStyle("fontWeight",e.weight);return}case"size":let s=()=>{this.startValues.charSpacing=a.charSpacing,this.startValues.textBackgroundPadding=t.textBackgroundPadding,this.createTransformItemTransition(t,"history_font_size")};e.updating?this.styleUpdating||(this.styleUpdating=!0,s()):(this.styleUpdating||s(),this.styleUpdating=!1,this.styleChanged=!0);let o=e.size/(t.scale.x*t.textScale);if(this.setStyle(a,"fontSize",o),this.setUserStyle("fontSize",o),this.textModifyMode==="global"){this.styleUpdating||(t.conformITextToSmallestFontSize(),t.textScale/=t.fontSizeNormalizeFactor);for(let c in a.styles){let h=a.styles[c];for(let u in h){let d=h[u];d.hasOwnProperty("strokePercent")&&d.hasOwnProperty("fontSize")&&(d.strokeWidth=d.strokePercent*d.fontSize)}}}else if(this.textModifyMode==="selection"){let c=this.factorToTextStrokePercent((e.stroke_width-1)/99),h=o*c;this.setStyle(a,"strokeWidth",h)}let n=null;for(let c in a.styles){let h=a.styles[c];for(let u in h){let d=h[u];d.hasOwnProperty("fontSize")&&(n===null||d.fontSize<n)&&(n=d.fontSize)}}let l=1;n!==null&&(l=n/BFN.TransformItemTextBaseFontSize),a.charSpacing=Math.round(this.startValues.charSpacing*l),t.textBackgroundPadding=this.startValues.textBackgroundPadding*l,t.updateITextBackgroundDisplay(),this.textModifyMode==="selection"&&this.styleUpdating&&(this.conformCTextToIText(t,!0),this.styleChanged=!1,this.fabricCanvasContext.lineJoin="round",this.fabricCanvas.renderAll());break;case"spacing":e.updating?this.styleUpdating||(this.styleUpdating=!0,this.createTransformItemTransition(t,"history_letter_spacing")):(this.styleUpdating||this.createTransformItemTransition(t,"history_letter_spacing"),this.styleUpdating=!1),this.setStyle(a,"charSpacing",e.spacing*100,!0),this.setUserStyle("charSpacing",e.spacing*100);break;case"line_height":e.updating?this.styleUpdating||(this.styleUpdating=!0,this.createTransformItemTransition(t,"history_text_line_height")):(this.styleUpdating||this.createTransformItemTransition(t,"history_text_line_height"),this.styleUpdating=!1),this.setStyle(a,"lineHeight",e.line_height/100,!0),this.setUserStyle("lineHeight",e.line_height/100);break;case"bold":{this.createTransformItemTransition(t,"history_text_bold");let h=this.isBoldWeight(this.getStyle(a,"fontWeight"))?this.getNormalWeight(e.font):this.getBoldWeight(e.font);this.setStyle(a,"fontWeight",h),this.setUserStyle("fontWeight",h),BFN.FontManager.activeFontWeight=this.getWeightNumber(h),this.updateLastTransitionIfGlobal=!0,e.weight!==h&&UITools.setControlValue("text_edit_weight",h);break}case"italic":{this.createTransformItemTransition(t,"history_text_italic");let c=this.getStyle(a,"fontStyle")==="italic";this.setStyle(a,"fontStyle",c?"":"italic"),this.setUserStyle("fontStyle",c?"":"italic"),this.updateLastTransitionIfGlobal=!0;break}case"underline":{this.createTransformItemTransition(t,"history_text_underline");let c=this.getStyle(a,"underline")||!1;this.setStyle(a,"underline",!c),this.setUserStyle("underline",!c),this.updateLastTransitionIfGlobal=!0;break}case"align":e.align!=a.textAlign&&(this.createTransformItemTransition(t,"history_text_align"),this.setStyle(a,"textAlign",e.align,!0),this.setUserStyle("textAlign",e.align)),this.updateLastTransitionIfGlobal=!0;break;case"text_color":{if(e.updating?this.styleUpdating||(this.styleUpdating=!0,this.createTransformItemTransition(t,this.textModifyMode==="global"?"history_text_color":"history_text_color_selection")):(this.styleUpdating||this.createTransformItemTransition(t,this.textModifyMode==="global"?"history_text_color":"history_text_color_selection"),this.styleUpdating=!1),e.updating_id==="text_color"){let h=this.getStyle(a,"fill");e.text_color==-1&&h!=="#00000000"?(UITools.setToolValue("text_edit","text_color_intensity",0),UITools.updateToolControl("text_edit_text_color"),BFN.ColorPickerPanel.refreshIntensitySlider()):e.text_color!=-1&&h==="#00000000"&&(UITools.setToolValue("text_edit","text_color_intensity",1),UITools.updateToolControl("text_edit_text_color"),BFN.ColorPickerPanel.refreshIntensitySlider())}let c=e.text_color==-1?"#00000000":BFN.ColorUtil.hexStringObjectToRGBAString({hex:e.text_color,alpha:e.text_color_intensity});this.setStyle(a,"fill",c),this.setUserStyle("fill",c);break}case"background_enabled":!e.updating&&t.textBackgroundEnabled!==e.background_enabled&&(this.createTransformItemTransition(t,e.background_enabled?"history_text_background_on":"history_text_background_off"),t.textBackgroundEnabled=e.background_enabled,t.textBackgroundColor===-1&&(t.textBackgroundColor=this.defaultBackgroundColor,t.textBackgroundIntensity=1,UITools.setToolValue("text_edit","background_color",t.textBackgroundColor),UITools.setToolValue("text_edit","background_intensity",t.textBackgroundIntensity),UITools.updateToolControl("text_edit_background_color")),t.updateITextBackgroundDisplay(),this.setUserStyle("backgroundEnabled",e.background_enabled),e.background_enabled&&!this.userStyle.itemStyles.hasOwnProperty("backgroundColor")&&this.setUserStyle("backgroundColor",this.defaultBackgroundColor),this.styleChanged=!0);break;case"background_color":if(e.updating?this.styleUpdating||(this.styleUpdating=!0,this.createTransformItemTransition(t,"history_text_background_color")):(this.styleUpdating||this.createTransformItemTransition(t,"history_text_background_color"),this.styleUpdating=!1),e.updating_id==="background_color"){let c=t.textBackgroundColor;e.background_color==-1&&c!=-1?(UITools.setToolValue("text_edit","background_color_intensity",0),UITools.updateToolControl("text_edit_background_color"),BFN.ColorPickerPanel.refreshIntensitySlider()):e.background_color!=-1&&c==-1&&(UITools.setToolValue("text_edit","background_color_intensity",1),UITools.updateToolControl("text_edit_background_color"),BFN.ColorPickerPanel.refreshIntensitySlider())}t.textBackgroundColor=e.background_color,t.textBackgroundIntensity=e.background_color_intensity,t.updateITextBackgroundDisplay(),this.setUserStyle("backgroundColor",e.background_color),this.setUserStyle("backgroundIntensity",e.background_color_intensity),this.styleChanged=!0;break;case"background_padding":e.updating?this.styleUpdating||(this.styleUpdating=!0,this.createTransformItemTransition(t,"history_text_background_padding")):(this.styleUpdating||this.createTransformItemTransition(t,"history_text_background_padding"),this.styleUpdating=!1),t.textBackgroundPadding=e.background_padding,t.updateITextBackgroundDisplay(),this.setUserStyle("backgroundPadding",e.background_padding),this.styleChanged=!0;break;case"stroke_enabled":if(!e.updating&&t.textOutlineEnabled!==e.stroke_enabled){if(this.setUserStyle("outlineEnabled",e.stroke_enabled),this.createTransformItemTransition(t,e.stroke_enabled?"history_text_outline_on":"history_text_outline_off"),t.textOutlineEnabled=e.stroke_enabled,t.textOutlineEnabled&&a.styleIsEmpty("stroke")){let c=this.userStyle.charStyles,h=c.stroke?c.stroke:BFN.ColorUtil.hexStringObjectToRGBAString({hex:this.defaultOutlineColor,alpha:1});this.setStyle(a,"stroke",h,(a.selectionStart||0)===(a.selectionEnd||0)),this.userStyle.itemStyles.hasOwnProperty("stroke")||this.setUserStyle("stroke",h);let u=BFN.ColorUtil.rgbaStringToHexStringObject(h);UITools.setToolValue("text_edit","stroke_color",u.hex),UITools.setToolValue("text_edit","stroke_color_intensity",u.alpha),UITools.updateToolControl("text_edit_stroke_color")}this.styleChanged=!0}break;case"stroke_color":{if(e.updating?this.styleUpdating||(this.styleUpdating=!0,this.createTransformItemTransition(t,"history_text_outline_color")):(this.styleUpdating||this.createTransformItemTransition(t,"history_text_outline_color"),this.styleUpdating=!1),e.updating_id==="stroke_color"){let h=this.getStyle(a,"stroke");e.stroke_color===-1&&!!h?(UITools.setToolValue("text_edit","stroke_color_intensity",0),UITools.updateToolControl("text_edit_stroke_color"),BFN.ColorPickerPanel.refreshIntensitySlider()):e.stroke_color!==-1&&!h&&(UITools.setToolValue("text_edit","stroke_color_intensity",1),UITools.updateToolControl("text_edit_stroke_color"),BFN.ColorPickerPanel.refreshIntensitySlider())}let c=e.stroke_color===-1?"":BFN.ColorUtil.hexStringObjectToRGBAString({hex:e.stroke_color,alpha:e.stroke_color_intensity});this.setStyle(a,"stroke",c),e.stroke_color!==-1&&this.setUserStyle("stroke",c);break}case"stroke_width":{e.updating?this.styleUpdating||(this.styleUpdating=!0,this.createTransformItemTransition(t,"history_text_outline_width")):(this.styleUpdating||this.createTransformItemTransition(t,"history_text_outline_width"),this.styleUpdating=!1);let c=this.factorToTextStrokePercent((e.stroke_width-1)/99);if(this.setStyle(a,"strokePercent",c),this.setUserStyle("strokePercent",c),this.textModifyMode==="global")for(let h in a.styles){let u=a.styles[h];for(let d in u){let m=u[d];m.hasOwnProperty("strokePercent")&&m.hasOwnProperty("fontSize")&&(m.strokeWidth=Math.max(m.strokePercent*m.fontSize,1/(t.textScale*t.scale.x)))}}else if(this.textModifyMode==="selection"){let h=Math.max(this.getStyle(a,"fontSize")*c,1/(t.textScale*t.scale.x));this.setStyle(a,"strokeWidth",h),this.setUserStyle("strokeWidth",h)}break}case"highlight_enabled":if(!e.updating&&t.textHighlightEnabled!==e.highlight_enabled){if(this.setUserStyle("highlightEnabled",e.highlight_enabled),this.createTransformItemTransition(t,e.highlight_enabled?"history_text_highlight_on":"history_text_highlight_off"),t.textHighlightEnabled=e.highlight_enabled,t.textHighlightEnabled&&a.styleIsEmpty("textBackgroundColor")){let c=this.userStyle.charStyles,h=c.textBackgroundColor?c.textBackgroundColor:BFN.ColorUtil.hexStringObjectToRGBAString({hex:this.defaultHighlightColor,alpha:1});this.setStyle(a,"textBackgroundColor",h,(a.selectionStart||0)===(a.selectionEnd||0)),this.userStyle.itemStyles.hasOwnProperty("textBackgroundColor")||this.setUserStyle("textBackgroundColor",h);let u=BFN.ColorUtil.rgbaStringToHexStringObject(h);UITools.setToolValue("text_edit","highlight_color",u.hex),UITools.setToolValue("text_edit","highlight_color_intensity",u.alpha),UITools.updateToolControl("text_edit_highlight_color")}this.styleChanged=!0}break;case"highlight_color":{if(e.updating?this.styleUpdating||(this.styleUpdating=!0,this.createTransformItemTransition(t,"history_text_highlight_color")):(this.styleUpdating||this.createTransformItemTransition(t,"history_text_highlight_color"),this.styleUpdating=!1),e.updating_id==="highlight_color"){let h=this.getStyle(a,"textBackgroundColor");e.highlight_color===-1&&!!h?(UITools.setToolValue("text_edit","highlight_color_intensity",0),UITools.updateToolControl("text_edit_highlight_color"),BFN.ColorPickerPanel.refreshIntensitySlider()):e.highlight_color!==-1&&!h&&(UITools.setToolValue("text_edit","highlight_color_intensity",1),UITools.updateToolControl("text_edit_highlight_color"),BFN.ColorPickerPanel.refreshIntensitySlider())}let c=e.highlight_color===-1?"":BFN.ColorUtil.hexStringObjectToRGBAString({hex:e.highlight_color,alpha:e.highlight_color_intensity});this.setStyle(a,"textBackgroundColor",c),e.highlight_color!==-1&&this.setUserStyle("textBackgroundColor",c);break}}}let r=!1;if(!e.updating)switch(e.updating_id){case"highlight_color":case"text_color":case"stroke_color":r=!0;break}this.applyStyleChange(e.updating_id,r)}createTransformItemTransition(e,t){!this.styleChangeRequested&&e&&t&&(e.clearDropShadow(),e.createTransition(t))}createNewText(){let e=BFN.AppModel.sectionValue(BFN.PhotoEditorCanvasModel,BFN.CollageMakerCanvasModel,BFN.DesignerCanvasModel);e.addedItem={type:"text"}}editText(e,t,r){this.currentTextTransformItem=e,this.currentTextTransformItem.visible=!1,BFN.updateFloatingElementDisplayImmediately(),BFN.MainUI.requestRender(),BFN.FontManager.fontMenuComponent&&BeFunky.isAndroid&&!BeFunky.isWiderThanMobile()&&BFN.FontManager.fontMenuComponent.hide(!0),this.textChanged=!1,this.currentTextTransformItem.clearDropShadow(),this.currentTextTransformItem.createTransition("history_text_content"),e.preEditItemDisplayW=e.itemContentW*e.scale.x;let{iText:a}=e;a.backupStyle={};try{let u=a.getSelectionStyles(0,0,!0);u.length&&Object.assign(a.backupStyle,u[0])}catch(u){}if(this.isDefaultText(this.currentTextTransformItem.iText.text)){a.text="";for(let u in a.styles)delete a.styles[u]}a.onDeselect!=this.handleTextDeselectedBind&&(a.onDeselectBak=a.onDeselect,a.onDeselect=this.handleTextDeselectedBind),a.backgroundColor="rgba(170,170,221,.5)",this.$fabricCanvas.setStyles({display:"block"}),this.conformITextToTransformItem(e);let o=this.conformCTextToIText(e,!0);o&&this.fabricCanvas.add(o),this.fabricCanvas.add(a),document.getElementById("appViewportBG").addClass("active"),document.getElementById("appViewport").addClass("active"),BFN.alternateMenu.isOverFabricCanvas=!0,BFN.FontManager.fontMenuComponent&&BFN.FontManager.fontMenuComponent.addClass("font-menu--over-fabric-canvas"),UIToggler.toggleMainMenu(!1),this.fabricCanvas.setActiveObject(a);let n=new PIXI.Point(a.left,a.top),l=new PIXI.Point(a.left+a.width,a.top+a.height);if(a.angle!==0){let u=a.angle*(Math.PI/180);l=BFN.Util.rotatePoint(n,l,u)}t=(n.x+l.x)/2,r=(n.y+l.y)/2;let c=new MouseEvent("mousedown",{bubbles:!0,cancelable:!0,screenX:t,screenY:r,clientX:t,clientY:r}),h=new MouseEvent("mousedown",{bubbles:!0,cancelable:!0,screenX:t,screenY:r,clientX:t,clientY:r});this.fabricCanvas.ignoreMouseDown=!0,a.fire("mousedown",{e:c}),a.fire("mouseup",{e:h}),a.fire("mousedown",{e:c}),a.fire("mouseup",{e:h}),setTimeout(()=>{delete this.fabricCanvas.ignoreMouseDown},0),document.getElementById("appViewportBG").addEventListener(BeFunky.pointerdown,this.handleBGMouseDownBind),requestAnimationFrame(()=>{this.currentTextTransformItem&&(this.currentTextTransformItem.iText.onClick(),this.currentTextTransformItem.iText.selectAll(),this.currentTextTransformItem.iText.hiddenTextarea&&this.currentTextTransformItem.iText.hiddenTextarea.setStyles({lineHeight:"10px",opacity:1}),a.on("changed",this.handleTextChangedBind),a.on("selection:changed",this.handleTextSelectionChangedBind),a.on("editing:exited",this.handleTextEditingExitedBind),a.on("mousedown",this.handleTextRightClickBind),this.handleTextSelectionChangedBind(),this.fabricCanvasContext.lineJoin="round",this.fabricCanvas.renderAll(),BFN.StageModel.addEventListener(BFN.StageModelEvents.STAGE_DIMENSIONS_UPDATED.type,this.handleStageDimensionsUpdatedBind),BFN.PhotoEditorCanvas.handleCanvasMouseOut(),BFN.SentryManager.reportBreadcrumb(BFN.SentryManager.getDisplayObjectInfo(this.currentTextTransformItem),"enter_edit_text"))})}conformITextToTransformItem(e){if(e&&e.type==="text"){let{iText:t}=e,r=e.canvasScale*e.textScale*e.scale.x;t.scaleX=t.scaleY=r,t.flipX=e.flippedHorizontal,t.flipY=e.flippedVertical,t.rotate(e.rotation*(180/Math.PI));let a=e.transform.worldTransform.tx-BFN.MainUI.x,s=e.transform.worldTransform.ty-BFN.MainUI.y,o=0,n=0;if(e.textCurveActive){let l=(e.itemContentW-e.textItemContentW)/2*e.canvasScale*e.scale.x;o=Math.cos(e.rotation)*l,n=Math.sin(e.rotation)*l}t.left=a+o,t.top=s+n}}conformCTextToIText(e,t=!1,r=!1){if(!(e&&e.textCurveActive))return null;let{iText:a}=e,{cText:s,curveAmount:o}=e.curvedText;s._applyIText(a,o);let{bounds:n}=s._getCurveCharData(),l=a.angle*(Math.PI/180),c=(a.width-n.width)*a.scaleX/2,h=a.left+Math.cos(l)*c,u=a.top+Math.sin(l)*c;if(a.flipX||a.flipY){let d=a.angle*(Math.PI/180),m=a.flipX?n.width*a.scaleX:0,p=a.flipY?n.height*a.scaleY:0,g=Math.sqrt(m**2+p**2),f=Math.atan2(p,m);h+=Math.cos(d+f)*g,u+=Math.sin(d+f)*g}return s.opacity=t?.5:1,s.angle=a.angle*Math.pow(-1,a.flipX+a.flipY),s.left=h,s.top=u,s.scaleX=a.scaleX*Math.pow(-1,a.flipX),s.scaleY=a.scaleY*Math.pow(-1,a.flipY),r&&this.fabricCanvas.renderAll(),s}applyStyleChange(e=null,t=!1){let{textTransformItem:r}=this;if(r&&this.styleChanged){this.styleChanged=!1;let{iText:a}=r;if(t)a.__skipDimension=!1,a.initDimensions();else switch(e){case"font":case"size":case"spacing":case"line_height":case"bold":case"italic":case"underline":case"align":case"stroke_width":a.__skipDimension=!1,a.initDimensions();break}r.ignoreAccurateBounds=this.styleUpdating,r.setTextWidth(r.iText.width*r.textScale*r.scale.x,!1,!1),(this.textModifyMode==="selection"||this.textModifyMode==="global"&&this.globalStylesUpdating)&&this.conformCTextToIText(r,this.textModifyMode==="selection"),this.textModifyMode==="global"&&(this.globalStylesUpdating||(this.globalStylesUpdating=!0,this.showTransformItemIText(r))),this.styleUpdating||(this.styleChangeRequested=!0,r.preventEditText=!0,this.addStyleChangesToHistoryDebounced(r)),this.textModifyMode==="global"?r.transformTool.updateDisplay():!this.styleUpdating&&a.hiddenTextarea&&a.hiddenTextarea.focus(),this.fabricCanvasContext.lineJoin="round",this.fabricCanvas.requestRenderAll()}}addStyleChangesToHistoryDebounced(e){this.styleChangeRequested=!1,e.preventEditText=!1,e.setTextWidth(e.iText.width*e.textScale*e.scale.x,!1,!0),e.iText.isEditing?e.preEditItemDisplayW=e.itemContentW*e.scale.x:e.preEditItemDisplayW&&delete e.preEditItemDisplayW,this.globalStylesUpdating&&(this.globalStylesUpdating=!1,requestAnimationFrame(()=>{this.globalStylesUpdating||this.hideTransformItemIText(e)}));let t=this.updateLastTransitionIfGlobal&&this.textModifyMode==="global";e.registerTransition(t,!1),t||e.createTransition("history_text_content")}showTransformItemIText(e){this.showingTransformItemIText=!0,this.$fabricCanvas.setStyles({display:"block"}),document.getElementById("appViewport").addClass("active"),e.toggleHiResText(!0),BFN.MainUI.renderCanvas(),this.conformITextToTransformItem(e);let t=this.conformCTextToIText(e);this.fabricCanvas.add(t||e.iText),this.fabricCanvasContext.lineJoin="round",this.fabricCanvas.renderAll()}hideTransformItemIText(e){this.showingTransformItemIText=!1;let t=()=>{this.showingTransformItemIText||(BFN.HiResTextManager.useHiResText||BFN.MainUI.renderCanvas(),this.removeAllFabricCanvasObjects(),this.$fabricCanvas.setStyles({display:"none"}),document.getElementById("appViewport").removeClass("active"))};e?e.updateHiResTextBounds(!0,t):t()}removeAllFabricCanvasObjects(){let e=this.fabricCanvas.getObjects();for(let t=0;t<e.length;t++)this.fabricCanvas.remove(e[t]);this.fabricCanvas.clear()}updateTextMenu(e){if(!e||!e.hasOwnProperty("fontSizeStart"))return;for(let v in e)if(e[v]===void 0)return;let t=!BFN.TransformModel.selectedTransformItem&&this.currentTextTransformItem&&this.currentTextTransformItem.iText.isEditing,r=!0;if(t){let v=this.currentTextTransformItem.iText;v._updateTextarea(),r=v.hiddenTextarea.selectionStart===0&&v.hiddenTextarea.selectionEnd===v.hiddenTextarea.value.length}let a={},s=(v,T)=>{a[v]=T};s("font",e.fontFamily==="mixed"?this.mixedCharacter:Ai(e.fontFamily)),s("size",e.fontSize==="mixed"?e.fontSizeStart==="mixed"?e.fontSizeMin:e.fontSizeStart:e.fontSize),s("size_mixed",e.fontSize==="mixed"),s("weight",this.getWeightNumber(e.fontWeight)),s("bold",this.isBoldWeight(e.fontWeight)),s("italic",e.fontStyle==="italic"),s("underline",!!e.underline&&e.underline!=="mixed"),s("spacing",e.charSpacing==="mixed"?0:e.charSpacing/100),s("line_height",(e.lineHeight==="mixed"?BFN.TransformItemTextBaseLineHeight:e.lineHeight)*100),s("align",e.textAlign);let o=e.fill&&e.fill!=="mixed"?e.fill:"#00000000";if(o!=="#00000000"){let v=BFN.ColorUtil.rgbaStringToHexStringObject(o);s("text_color",v.hex),s("text_color_intensity",v.alpha)}else s("text_color",-1),s("text_color_intensity",e.fill==="mixed"?1:0);let n=e.backgroundColor&&e.backgroundColor!=="mixed"?e.backgroundColor:-1;n!=-1&&e.backgroundIntensity!=="mixed"?(s("background_color",n),s("background_color_intensity",e.backgroundIntensity)):(s("background_color",-1),s("background_color_intensity",1)),s("background_padding",e.hasOwnProperty("backgroundPadding")&&e.backgroundPadding!=="mixed"?e.backgroundPadding:0);let l=e.stroke&&e.stroke!=="mixed"?e.stroke:"";if(l!==""){let v=BFN.ColorUtil.rgbaStringToHexStringObject(l);s("stroke_color",v.hex),s("stroke_color_intensity",v.alpha)}else s("stroke_color",-1),s("stroke_color_intensity",0);let c=e.strokePercent&&e.strokePercent!=="mixed"?e.strokePercent:BFN.TransformItemTextStrokePercentDefault;s("stroke_width",Math.round(this.textStrokePercentToFactor(c)*99)+1);let h=e.textBackgroundColor&&e.textBackgroundColor!=="mixed"?e.textBackgroundColor:"";if(h!==""){let v=BFN.ColorUtil.rgbaStringToHexStringObject(h);s("highlight_color",v.hex),s("highlight_color_intensity",v.alpha)}else s("highlight_color",-1),s("highlight_color_intensity",e.textBackgroundColor==="mixed"?1:0);["font","weight","size","bold","italic","underline","spacing","line_height","align","text_color","text_color_intensity","background_color","background_color_intensity","background_padding","stroke_color","stroke_color_intensity","stroke_width","highlight_color","highlight_color_intensity"].forEach(v=>{a.hasOwnProperty(v)||BeFunky.throwError("Style Data Object Parameter Missing",v),v==="font"?(this.activeFontFamily=a.font===this.mixedCharacter?null:a.font,BFN.FontManager.activeFont=Ai(a.font)):v==="weight"&&(this.activeFontWeight=BFN.FontManager.activeFontWeight=a.weight),UITools.setToolValue("text_edit",v,a[v])}),UITools.updateToolControls("text_edit"),document.getElementById("text_edit_size").isMixed=!!a.size_mixed,document.getElementById("text_edit_background_padding").isMixed=e.backgroundPadding==="mixed",document.getElementById("text_edit_stroke_width").isMixed=e.strokePercent==="mixed",document.getElementById("text_edit_text_color").isMixed=e.fill==="mixed",document.getElementById("text_edit_background_color").isMixed=e.backgroundColor==="mixed",document.getElementById("text_edit_stroke_color").isMixed=e.stroke==="mixed",document.getElementById("text_edit_highlight_color").isMixed=e.textBackgroundColor==="mixed";let d=document.getElementById("text_edit_background_enabled");d.checked=e.backgroundEnabled?e.backgroundEnabled==="mixed"?"mixed":"on":"off",d.openWhenChecked=e.backgroundColorEmpty;let m=document.getElementById("text_edit_stroke_enabled");m.checked=e.outlineEnabled?e.outlineEnabled==="mixed"?"mixed":"on":"off",m.openWhenChecked=e.strokeEmpty;let p=document.getElementById("text_edit_highlight_enabled");p.checked=e.highlightEnabled?e.highlightEnabled==="mixed"?"mixed":"on":"off",p.openWhenChecked=e.textBackgroundColorEmpty;let g=document.getElementById("text_edit_stroke_color");g.emptyEnabled=t&&!r;let f=document.getElementById("text_edit_highlight_color");f.emptyEnabled=t&&!r}loadFont(e,t){Br(t)||(BeFunky.logError(`Invalid font weight for ${e}:`,t),t=this.defaultFontWeight),this.activeFontFamily=e,this.activeFontWeight=t;let r=this.isBoldWeight(this.activeFontWeight);if(UITools.getControlValue("text_edit_bold")!==r&&(UITools.setControlValue("text_edit_bold",r),UITools.updateToolControl("text_edit_bold")),BFN.FontManager.isLoaded(e))return this.handleWebFontLoaded(e,t);let a=()=>{this.activeFontFamily=null,BFN.TransformModel.removeEventListener(BFN.TransformModelEvents.TRANSFORM_ITEM_UPDATED.type,a)};BFN.TransformModel.addEventListener(BFN.TransformModelEvents.TRANSFORM_ITEM_UPDATED.type,a),BFN.FontManager.load(e).then(()=>this.handleWebFontLoaded(e,t)).catch(this.handleWebFontLoadError.bind(this))}setUserStyle(e,t){e==="fontFamily"&&(t=ei(t)),this.itemStyles.includes(e)?this.userStyle.itemStyles[e]=t:this.globalStyles.includes(e)?this.userStyle.globalStyles[e]=t:this.userStyle.charStyles[e]=t,this.currentTextTransformItem&&this.currentTextTransformItem.iText&&this.currentTextTransformItem.iText.backupStyle&&(this.currentTextTransformItem.iText.backupStyle[e]=t)}setStyle(e,t,r,a=!1){t==="fontFamily"&&(r=ei(r));let s={};if(s[t]=r,e.setSelectionStyles&&e.isEditing&&!a){let n=e.selectionStart||0,l=e.selectionEnd||0;n===l?(this.desiredStyle||(this.desiredStyle={}),this.desiredStyle[t]=r):e.setSelectionStyles(s,n,l)}else if(this.globalStyles.includes(t))e[t]=r;else{e.__skipDimension=["textBackgroundColor","fill","stroke"].indexOf(t)!=-1;for(let n=0;n<e.text.length;n++)e._extendStyles(n,s)}this.styleChanged||(this.styleChanged=!0);let{transformItem:o}=e;o&&o.textCurveActive&&(o.textCurveSizeChanged=!0)}getStyle(e,t){let r="";if(e.getSelectionStyles&&e.isEditing){let a=e.selectionStart||0,s=a+1;e.text.length&&e.selectionStart>0&&(a===e.text.length||e.selectionStart===e.selectionEnd)&&(a--,s--);let o=e.getSelectionStyles(a,s,!0);r=o.length&&o[0].hasOwnProperty(t)?o[0][t]:""}else e.styles.hasOwnProperty("0")&&e.styles[0].hasOwnProperty("0")?r=e.styles[0][0][t]:r=e[t];return r}factorToTextStrokePercent(e=0){return e*(BFN.TransformItemTextStrokePercentMax-BFN.TransformItemTextStrokePercentMin)+BFN.TransformItemTextStrokePercentMin}textStrokePercentToFactor(e=BFN.TransformItemTextStrokePercentMin){return e=Math.max(BFN.TransformItemTextStrokePercentMin,Math.min(BFN.TransformItemTextStrokePercentMax,e)),(e-BFN.TransformItemTextStrokePercentMin)/(BFN.TransformItemTextStrokePercentMax-BFN.TransformItemTextStrokePercentMin)}handleWebFontLoaded(e,t){if(!(this.activeFontFamily!==e||this.activeFontWeight!==t))if(BFN.TransformModel.selectedGroupType==="text")BFN.TransformItemGroup.selectedItems.forEach(r=>{r.setITextStyle({fontFamily:e,fontWeight:t})}),BFN.TransformItemGroup.transformLayer.transformTool.fadeAnimator.decrease(),BFN.TransformItemGroup.strokeRectanglePool.clear(),BFN.TransformItemGroup.registerTransition(void 0,!0,!0,()=>{BFN.TransformItemGroup.transformLayer.transformTool.updateDisplay(),BFN.TransformItemGroup.transformLayer.transformTool.fadeAnimator.increase()},!0);else{let{textTransformItem:r}=this;r&&(this.setStyle(r.iText,"fontFamily",e,this.textModifyMode==="global"),this.setStyle(r.iText,"fontWeight",t,this.textModifyMode==="global"),this.applyStyleChange("font"))}}handleWebFontLoadError(e){BeFunky.logError(e)}handleTextChanged(){let e=!this.textChanged;if(this.textChanged||(this.textChanged=!0,e=!0),this.lastSelectionStart=-1,this.lastSelectionEnd=-1,this.currentTextTransformItem){let{iText:t}=this.currentTextTransformItem;t.__skipDimension=!1,t.text.length||(this.lastSelectionStart=0,this.lastSelectionEnd=0,t.inputErase||Object.assign(t.backupStyle,this.userStyle.charStyles));let r=t.getSelectionStyles(0,t.textLength||t.text.length,!0),a=Object.assign({},t.backupStyle);for(let s=0;s<r.length;s++){let o=r[s],n=!!o.fromExternalPaste;delete o.fromExternalPaste;let l=t.get2DCursorLocation(s,!0);o.hasOwnProperty("strokePercent")&&o.strokePercent!==void 0?a=Object.assign({},o):a&&(this.desiredStyle&&Object.assign(a,this.desiredStyle),n?fabric.util.object.extend(t.styles[l.lineIndex][l.charIndex],a):t.setSelectionStyles(a,s,s+1)),delete t.styles[l.lineIndex][l.charIndex].fromExternalPaste}e=e||t.text.length===1,this.desiredStyle&&t.selectionStart>0&&t.selectionStart===t.selectionEnd?t.setSelectionStyles(this.desiredStyle,t.selectionStart-1,t.selectionStart):e&&t.backupStyle&&t.selectionStart===1&&t.selectionStart===t.selectionEnd&&t.setSelectionStyles(t.backupStyle,t.selectionStart-1,t.selectionStart),t.text.length&&t.selectionStart===t.selectionEnd&&(t.selectionStart>0?r=t.getSelectionStyles(t.selectionStart-1,t.selectionStart,!0):r=t.getSelectionStyles(t.selectionStart,t.selectionStart+1,!0),r.length&&Object.assign(t.backupStyle,r[0])),this.conformCTextToIText(this.currentTextTransformItem,!0),this.updateTextMenu(this.currentTextTransformItem.getTextStyleData())}this.desiredStyle=null}handleTextSelectionChanged(){if(this.currentTextTransformItem){let{iText:e}=this.currentTextTransformItem;if(e.getSelectionStyles&&e.isEditing){if(e.selectionStart===this.lastSelectionStart&&e.selectionEnd===this.lastSelectionEnd&&e.selectionStart===e.selectionEnd)return;this.lastSelectionStart=e.selectionStart,this.lastSelectionEnd=e.selectionEnd}}if(this.desiredStyle=null,this.currentTextTransformItem){let{iText:e}=this.currentTextTransformItem;if(e.getSelectionStyles&&e.isEditing&&e.text.length){let t=e.selectionStart||0,r=t+1,a=e.getSelectionStyles(t,r,!0);a&&a.length&&Object.assign(e.backupStyle,a[0])}this.updateTextMenu(this.currentTextTransformItem.getTextStyleData()),e.cursorColor="#FF0000"}}handleTextEditingExited(e){if(document.getElementById("appViewportBG").removeEventListener(BeFunky.pointerdown,this.handleBGMouseDownBind),BFN.StageModel.removeEventListener(BFN.StageModelEvents.STAGE_DIMENSIONS_UPDATED.type,this.handleStageDimensionsUpdatedBind),document.getElementById("appViewportBG").removeClass("active"),document.getElementById("appViewport").removeClass("active"),this.currentTextTransformItem){BFN.SentryManager.reportBreadcrumb(BFN.SentryManager.getDisplayObjectInfo(this.currentTextTransformItem),"exit_edit_text");let t=this.currentTextTransformItem.iText;t.backgroundColor="",t.off("changed",this.handleTextChangedBind),t.off("selection:changed",this.handleTextSelectionChangedBind),t.off("editing:exited",this.handleTextEditingExitedBind),t.off("mousedown",this.handleTextRightClickBind),t.onDeselectBak&&t.onDeselect!==t.onDeselectBak&&(t.onDeselect=t.onDeselectBak),this.currentTextTransformItem.refreshItemName(),this.currentTextTransformItem.textCurveActive&&(this.currentTextTransformItem.textCurveSizeChanged=!0),this.currentTextTransformItem.addEventListener(BFN.TransformItemEvents.TEXT_DISPLAY_UPDATED.type,this.handleTextDisplayUpdatedBind),this.currentTextTransformItem.setTextWidth(this.currentTextTransformItem.iText.width*this.currentTextTransformItem.textScale*this.currentTextTransformItem.scale.x/this.currentTextTransformItem.fontSizeNormalizeFactor)}}handleTextRightClick(e){let t=e.target;if(t&&t.isEditing&&e.button===3){BFN.TooltipScreen.setPosition(e.e.clientX,e.e.clientY,{onCanvas:!0});let r=BeFunky.LanguageManager.getStringReplacements("guide_copy_paste",{copyShortcut:BFN.shortcutText("C"),pasteShortcut:BFN.shortcutText("V")}),a=`<div style="line-height: 1.5; margin: 0 .25rem">${r}</div>`;BFN.TooltipScreen.show(a,!0,!1,!0),setTimeout(()=>{BFN.TooltipScreen.reserved=!1,t.hiddenTextarea&&t.hiddenTextarea.focus()},500)}}handleTextDisplayUpdated(){this.currentTextTransformItem.removeEventListener(BFN.TransformItemEvents.TEXT_DISPLAY_UPDATED.type,this.handleTextDisplayUpdatedBind),this.currentTextTransformItem.selectItem(),this.currentTextTransformItem.transformTool.conformItemToBounds(),this.currentTextTransformItem.transformTool.updateDisplayForTextResize(),this.textChanged&&(this.textChanged=!1,this.currentTextTransformItem.registerTransition(!1,!1)),this.currentTextTransformItem.visible=!0,this.currentTextTransformItem.updateHiResTextBounds(!0,null,!0),BFN.MainUI.addEventListener(BFN.MainUIEvents.RENDERED.type,this.handleMainUIRenderedBind),BFN.MainUI.requestRender()}handleMainUIRendered(){BFN.MainUI.removeEventListener(BFN.MainUIEvents.RENDERED.type,this.handleMainUIRenderedBind),this.$fabricCanvas.setStyles({display:"none"}),this.removeAllFabricCanvasObjects(),this.currentTextTransformItem&&(delete this.currentTextTransformItem.preEditItemDisplayW,delete this.currentTextTransformItem.iText.backupStyle,this.currentTextTransformItem=null),BFN.TransformModel.selectedTransformItemText=null,BFN.alternateMenu.isOverFabricCanvas=!1,BFN.FontManager.fontMenuComponent&&BFN.FontManager.fontMenuComponent.removeClass("font-menu--over-fabric-canvas"),UIToggler.toggleMainMenu(!0)}handleBGMouseDown(){BFN.SentryManager.reportBreadcrumb("appViewportBG","pointer_down"),setTimeout(()=>{this.currentTextTransformItem&&this.currentTextTransformItem.exitTextEditing()},0)}handleStageDimensionsUpdated(){BFN.SentryManager.reportBreadcrumb("","stage_dimensions_updated"),this.currentTextTransformItem&&this.currentTextTransformItem.exitTextEditing()}handleTextDeselected(){BFN.SentryManager.reportBreadcrumb("","text_deselected"),setTimeout(()=>{this.currentTextTransformItem&&this.currentTextTransformItem.exitTextEditing()},0)}handleDocumentKeyPress(e){this.iTextEditing&&this.currentTextTransformItem&&this.currentTextTransformItem.iText&&this.currentTextTransformItem.iText.hiddenTextarea&&!BeFunky.isTextBoxFocused()&&this.currentTextTransformItem.iText.hiddenTextarea.focus(),e.keyCode===90&&this.iTextEditing&&(e.ctrlKey||e.metaKey)&&(e.stopImmediatePropagation(),e.preventDefault())}isBoldWeight(e){return e==="bold"||parseInt(e)>=600}getWeightNumber(e){let t=parseInt(e);return Br(t)?t:e==="bold"?700:400}getFontWeights(e){if(e===this.mixedCharacter)return[];let t=BFN.FontManager.getFontObject(e);return t?(t.weights.length||BFN.FontManager.testFontWeights([t]),t.weights):(BeFunky.throwError("Unable to get font object for font",e),[])}getNormalWeight(e){let t=this.getFontWeights(e);return[400,500,300,200,100].find(s=>t.includes(s))||""}getBoldWeight(e){let t=this.getFontWeights(e);return[700,800,900,600].find(s=>t.includes(s))||"bold"}isDefaultText(e){return e.trim()===BeFunky.LanguageManager.getString("click_when_selected")}get textTransformItem(){return!this.currentTextTransformItem&&BFN.TransformModel.selectedTransformItem&&BFN.TransformModel.selectedTransformItem.type==="text"?BFN.TransformModel.selectedTransformItem:this.currentTextTransformItem&&!BFN.TransformModel.selectedTransformItem?this.currentTextTransformItem:null}get textModifyMode(){return!this.currentTextTransformItem&&BFN.TransformModel.selectedTransformItem&&BFN.TransformModel.selectedTransformItem.type==="text"?"global":this.currentTextTransformItem&&!BFN.TransformModel.selectedTransformItem?"selection":null}get iTextEditing(){return this.$fabricCanvas.style.display==="block"}get defaultFontFamily(){return BFN.FontManager.defaultFontFamily}get defaultFontWeight(){return BFN.FontManager.defaultFontWeight}};BFN.SingletonQueue.add(()=>{BFN.FabricManager=new Ub});function qr(){BFN.EventDispatcher.call(this),this.init()}qr.prototype=Object.create(BFN.EventDispatcher.prototype);qr.prototype.init=function(){BeFunky.log("OverlaysManager Init"),this.initDefaultValues()};qr.prototype.initDefaultValues=function(){this.isDataLoaded=!1,this.loadedItemCategories=[],this.overlayMenuDataHash={}};qr.prototype.loadCategories=function(){this.isDataLoaded||BFN.OverlaysDataLoader.load().then(()=>{if(!this.isDataLoaded&&!Object.keys(BFN.OverlaysData).length)return BeFunky.logError("Unable to get overlays data");this.isDataLoaded=!0,this.setupCategoryMenu()})};qr.prototype.setupCategoryMenu=function(){BFN.UIMenuData.categoryMenus.editor_overlay.forEach(({id:i,name:e})=>{let t=i.replace("editor_overlay_","");BFN.OverlaysData.hasOwnProperty(t)&&(BFN.OverlaysData[t].translationId=e,BFN.OverlaysData[t].englishName=BeFunky.LanguageManager.getString(e,"en"))}),BFN.secondaryMenu.editorOverlaysDisabled=!1,this.overlayMenuData=[],this.overlayCategoryIDMap={},this.overlayPresetMap={},this.overlayIDMap={},Object.entries(BFN.OverlaysData).forEach(([i,e])=>{let t="overlay_generic_menu",r="overlay_generic_opacity",a={id:e.id,name:e.name,englishName:e.englishName,translationId:e.translationId,presets:[]},s={genericMenuId:t,presetAmountSliderId:r},o=(n,l)=>{n.forEach(c=>{let h=a.id+(l?"_plus_":"_free_")+c,u=`${BeFunky.LanguageManager.getString(a.englishName)} ${a.presets.length+1}`,d=[a.translationId,{suffix:(a.presets.length+1).toString()}],m={id:h,effectID:a.id,name:u,isPlus:l,categoryID:a.id,categoryName:a.name,usePaint:!1,translation:d,params:[{type:"static",name:"overlayID",defaultValue:h},{type:"static",name:"overlayName",defaultValue:u},{type:"static",name:"overlayTranslation",defaultValue:d},{type:"static",name:"categoryID",defaultValue:a.id},{type:"static",name:"categoryName",defaultValue:a.name}]};BFN.toolViewstates[`${a.id}_${m.id}`]=BFN.PhotoEditorCanvasModelViewStates.VIEWING_OVERLAY,a.presets.push(m),this.overlayCategoryIDMap[`${a.id}_${m.id}`]=m.id,this.overlayIDMap[m.id]=a.id,this.overlayPresetMap[m.id]=m})};o(e.freeOverlays,!1),o(e.plusOverlays,!0),this.overlayMenuData.push(a),this.overlayMenuDataHash[`overlay_${i}_menu`]={params:s,toolObject:a}}),UITools.initToolVOs(this.overlayMenuData)};qr.prototype.setupCategoryItems=function(i){};BFN.SingletonQueue.add(()=>{BFN.OverlaysManager=new qr});var Gb=class{constructor(){this.init()}init(){}handleOpenImage(){let e=UITools.getToolValue("editor_load_image","updating_id");if(["befunky","google_drive","google_photos","facebook","dropbox"].includes(e)&&BeFunky.isInDemoMode())return BeFunky.acknowledgeDemoMode();switch(e){case"computer":BeFunky.isAppleAppStoreApp?this.handleLoadImageFromNative():this.handleEditorLoadImageOrProject();break;case"befunky":BFN.ImageLibraryManager.openModal("befunky","UPLOAD_MENU");break;case"google_drive":BFN.BfnService.importGoogleDriveImage();break;case"google_photos":BFN.ImageLibraryManager.openModal("google","UPLOAD_MENU");break;case"stock_images":BFN.ImageLibraryManager.openModal("stock_images","UPLOAD_MENU");break;case"facebook":BFN.ImageLibraryManager.openModal("facebook","UPLOAD_MENU");break;case"dropbox":BFN.BfnService.importDropBoxImage();break;case"camera":this.handleEditorLoadImageFromCamera();break;case"webcam":BFN.PhotoEditorModel.openWebcamModal();break}}handleOpenProject(){if(UITools.getToolValue("open_project","updating_id")==="computer"){if(BFN.AppModel.viewingEditor)return this.handleEditorLoadImageOrProject();let t={fileType:"bfd",allowMultiple:!1,createMenuImageVO:!1};return BFN.MultipleFileUploader.upload(({file:r})=>{if(!r)return;let a=BFN.getExtension(r.name);console.log("User opened file:",{name:r.name,size:BeFunky.formatBytes(r.size),section:BFN.AppModel.sectionID}),BFN.MultipleFileUploader.supportedImages.includes(a)?setTimeout(()=>{BFN.ImageLibraryManager.uploadImages(null,{files:[r]})},0):BFN.ProjectManager.loadFile(r)},t)}BeFunky.SavedProjectManager.openProjectModal()}handleLoadImageFromNative(e){!BeFunky.isAppleAppStoreApp||window.openCameraRoll(e,t=>{if(t.error){console.log(t.error),t.error!=="cancelled";return}if(!t.assets.length){console.log("No assets selected or returned");return}let r=new Date().getTime();console.log("asset id received calling get base64 from swift start ms:",r,t.assets),BeFunky.showLoadScreen(),window.getBase64FromPHAsset(t.assets[0],a=>{let s=new Date().getTime()-r;if(console.log("Base64 received from swift:",s),a==="error"){BeFunky.hideLoadScreen();return}try{a.includes("base64,")||(a=`base64,${a}`)}catch(n){}let o=a;BFN.PhotoEditorModel.confirmEditorLoadImage(()=>BFN.PhotoEditorModel.onEditorImageUpload({file:o}))})})}handleEditorLoadImageFromCamera(){let e={fileType:"images",allowMultiple:!1,createMenuImageVO:!1,openNativeCamera:!0};BFN.MultipleFileUploader.upload(({file:t})=>{if(!t)return;let r=BFN.getExtension(t.name);console.log("User opened file:",{name:t.name,size:BeFunky.formatBytes(t.size),section:BFN.AppModel.sectionID}),BFN.MultipleFileUploader.supportedImages.includes(r)?BFN.PhotoEditorModel.confirmEditorLoadImage(()=>BFN.PhotoEditorModel.onEditorImageUpload({file:t})):BeFunky.logError("User uploaded unsupported file type")},e)}handleEditorLoadImageOrProject(){let e="imagesAndBFD";BeFunky.isIOS&&(e="images"),BeFunky.isAndroid&&(e="images");let t={fileType:e,allowMultiple:!1,createMenuImageVO:!1};BFN.MultipleFileUploader.upload(({file:r})=>{if(!r)return;let a=BFN.getExtension(r.name);console.log("User opened file:",{name:r.name,size:BeFunky.formatBytes(r.size),section:BFN.AppModel.sectionID}),a==="bfd"?BFN.ProjectManager.loadFile(r):BFN.MultipleFileUploader.supportedImages.includes(a)?BFN.PhotoEditorModel.confirmEditorLoadImage(()=>BFN.PhotoEditorModel.onEditorImageUpload({file:r})):BeFunky.logError("User uploaded unsupported file type")},t)}};BFN.SingletonQueue.add(()=>{BFN.OpenManager=new Gb});var{html:Ps,setupState:BM,render:SM,elem:Hb,appLang:en,icon:tn}=BeFunky.lit;function rn({fetchAlbums:i,createAlbum:e,onToggle:t}){let r=Hb`<div class="google-photos-albums control-item"></div>`,a={isEnabled:!1,isLoading:!1,writeableAlbums:[]},s=BeFunky.debounce(()=>SM(h(),r),"raf"),[o,n]=BM(a,x=>{x.isEnabled&&g(),x.writeableAlbums&&f(),s()});BeFunky.LanguageManager.addLanguageUpdateListener(s);let l,c=!1;return T(),Object.assign(r,{getSelectedAlbum:d}),r;function h(){return Ps`
        <div class="checkbox">
            <input type="checkbox" id="toggle_google_photos_album" @change=${m} .checked=${o.isEnabled}>
            <label class="checkbox__label" for="toggle_google_photos_album">
                <span class="checkbox__box checkbox__box--sm">
                    ${tn("checkmark-icon","icon checkbox__icon icon--12")}
                </span>
                <string>${en("save_to_album")}</string>
            </label>
        </div>
        ${o.isEnabled?u():""}
        `}function u(){return o.isLoading?Ps`
            <div class="google-photos-albums__loading">
                <div class="loading-spinner"></div> <string>${en("loading")}</string>
            </div>`:o.writeableAlbums.length?(l=Hb`<dropdown-select
            .options=${o.writeableAlbums.map(({album_id:x,title:B})=>({name:B,value:x}))}
            .translateOptionNames=${!1}
            .useLabel=${!1}
            .label=${"select_album"}
        ></dropdown-select>`,Ps`
        <div class="google-photos-albums__dropdown button-group">
            ${l}
            <button @click=${p} class="button button--icon button--white-outline" style="margin-left: .25rem;" data-tooltip="create_album">${tn("plus-icon","icon icon--16")}</button>
        </div>`):Ps`
            <div class="google-photos-albums__dropdown">
                <button @click=${p} class="button button--has-icon button--grey-outline">${tn("plus-icon","icon")} <string>${en("create_album")}</string></button>
            </div>`}function d(){return o.isEnabled&&!o.isLoading&&l&&l.value?l.value:void 0}function m(x){n({isEnabled:x.target.checked})}function p(){let x=BeFunky.createFormModalContainer("album"),{teardown:B}=BeFunky.formModal(x,{title:"create_album",fields:[{name:"albumname",label:"album_name",maxLength:500,sanitize:y=>y.replace(/[^a-zA-Z0-9 !@#$%^&*(){}[\]:;,'"./?\-_+=]/g,"")}],button:"create",onSubmit:({albumname:y})=>{y=y.trim(),v(y).then(()=>{BeFunky.closeModal(x)})}});BeFunky.openFormModal(x,B)}function g(){o.isEnabled&&c&&T(),t(o.isEnabled)}function f(){if(!l)return;let x=o.writeableAlbums.map(({album_id:B,title:y})=>({name:y,value:B}));!x.length||(l.options=x,l.value=x[0].value)}function v(x){return n({isLoading:!0}),e(x).then(B=>{n({isLoading:!1,writeableAlbums:[B,...o.writeableAlbums]})}).catch(B=>{B!=="cancelled_by_user"&&BeFunky.throwError("Unable to create Google Photos album",x,B),n({isLoading:!1,isEnabled:!1})})}function T(){c=!1,n({isLoading:!0}),i().then(x=>{let B=x.filter(({title:y,isWritable:F})=>y&&F);n({isLoading:!1,writeableAlbums:B})}).catch(x=>{x!=="cancelled_by_user"&&BeFunky.reportWarning(`Unable to load Google Photos albums: ${x}`,x),n({isLoading:!1,isEnabled:!1}),c=!0})}}var{html:Ns,setupState:IM,render:_M,elem:Xb,appLang:an,icon:sn}=BeFunky.lit;function on({fetchItems:i,createItem:e,onToggle:t,initialOptions:r=()=>{}}){let a=Xb`<div class="save-to-folder control-item"></div>`,s={isEnabled:!1,isLoading:!1,folders:[],isLoggedIn:BeFunky.isLoggedIn()},o=BeFunky.debounce(()=>_M(u(),a),"raf"),[n,l]=IM(s,y=>{y.isEnabled&&f(),y.folders&&v(),o()});window.onUserStatusChange(T,!1),BeFunky.LanguageManager.addLanguageUpdateListener(o);let c,h=!1;return n.isLoggedIn&&B(),Object.assign(a,{getSelectedFolder:m,loadFolders:B}),a;function u(){if(!!n.isLoggedIn)return Ns`
        <div class="checkbox">
            <input type="checkbox" id="toggle_save_to_folder" @change=${p} .checked=${n.isEnabled}>
            <label class="checkbox__label" for="toggle_save_to_folder">
                <span class="checkbox__box checkbox__box--sm">
                    ${sn("checkmark-icon","icon checkbox__icon icon--12")}
                </span>
                <string>${an("save_to_folder")}</string>
            </label>
        </div>
        ${n.isEnabled?d():""}
        `}function d(){return n.isLoading?Ns`
            <div class="save-to-folder__loading">
                <div class="loading-spinner"></div> <string>${an("loading")}</string>
            </div>`:n.folders.length?(c=Xb`<dropdown-select
            .options=${r(n.folders)}
            .translateOptionNames=${!1}
            .label=${"select_folder"}
            .useLabel=${!1}
        ></dropdown-select>`,Ns`
        <div class="save-to-folder__dropdown button-group">
            ${c}
            <button @click=${g} class="button button--icon button--white-outline" style="margin-left: .25rem;" data-tooltip="create_folder">${sn("plus-icon","icon icon--16")}</button>
        </div>`):Ns`
            <div class="save-to-folder__dropdown">
                <button @click=${g} class="button button--has-icon button--grey-outline">${sn("plus-icon","icon")} <string>${an("create_folder")}</string></button>
            </div>`}function m(){return n.isEnabled&&!n.isLoading&&c&&c.value?c.value:void 0}function p(y){l({isEnabled:y.target.checked})}function g(){let y=BeFunky.createFormModalContainer("folder"),{teardown:F}=BeFunky.formModal(y,{title:"create_folder",fields:[{name:"foldername",label:"folder_name",maxLength:500,sanitize:b=>b.replace(/[^a-zA-Z0-9_ -]/g,"")}],button:"create",onSubmit:({foldername:b})=>{b=b.trim(),x(b).then(()=>{BeFunky.closeModal(y)})}});BeFunky.openFormModal(y,F)}function f(){n.isEnabled&&h&&B(),t(n.isEnabled)}function v(){if(!c)return;let y=r(n.folders);!y.length||(c.options=y,c.value=y[0].value)}function T(){l({isLoggedIn:BeFunky.isLoggedIn()}),n.isLoggedIn&&B()}function x(y){return l({isLoading:!0}),e(y).then(F=>{l({isLoading:!1,folders:[F,...n.folders]})}).catch(F=>{F!=="cancelled_by_user"&&BeFunky.throwError("Unable to create Project Folder",y,F),l({isLoading:!1,isEnabled:!1})})}function B(){h=!1,l({isLoading:!0}),i().then(y=>{l({isLoading:!1,folders:y})}).catch(y=>{y!=="cancelled_by_user"&&BeFunky.throwError("Unable to load folders in save to folder component",y),l({isLoading:!1,isEnabled:!1}),h=!0})}}var{defineCustomElement:CM,html:nt,lang:rt,icon:Kr,useLayoutEffect:nn,useState:EM,styleMap:ln,useReducer:PM,useMediaQuery:NM,render:cn}=BeFunky.lit;function hn(){CM("save-and-share",MM)}function MM({view:i="",onFilenameChange:e,filename:t="",dimensions:r="0 \xD7 0",previewImage:a,isSizeUpdating:s=!1,imageSize:o="...",onSaveOrShare:n,updatePreviewImage:l,onClose:c,onDownloadAgain:h,getSaveToFolderComponent:u,getGooglePhotosAlbumsComponent:d,getWatermarkComponent:m,mobileSaveDropdownItems:p,_previewMaxRenderedSize:g=[576,526]}){let f=this,[v,T]=EM(""),[x,B]=PM(DM,{wrapper:{},bg:{},image:{}}),y=["facebook","pinterest","tumblr","twitter"].includes(i),F=i==="complete",b=!y&&i!=="complete",S=y&&i!=="complete",I=va("sas_image_type"),_=va("sas_pdf_quality"),E=va("sas_project_location"),D=$r("sas_image_quality"),w=Ut("sas_disable_save_complete_modal");nn(()=>{f.id="sas"},[]);let N=NM(`(min-width: ${BFN.CSS.desktopAppMinWidth}px)`);return nn(_e,[i,N]),nn(Ie,[a]),N?M():j();function M(){let L=de(),R=i&&i!=="project"&&i!=="complete"&&!y,A=i&&i!=="project"&&i!=="complete";return nt`
        <div class="modal__body">
            <div class="save-image__left-column" style=${v}>
                <div class="save-image__preview-outer">
                    <div class="save-image__preview-inner" style=${ln(x.wrapper)}>
                        <div class="save-image__preview-bg" style=${ln(x.bg)}></div>
                        <div class="save-image__preview-image" style=${ln(x.image)}></div>
                    </div>
                </div>
                <div class="control-item">
                    <label class="control-item-label" style="margin: 0">${rt("dimensions")}</label>
                    <div class="save-image__dimensions bold">${r}</div>
                </div>
            </div>
            <div class="save-image__content">
                ${L?nt`
                <h2 class="save-image__header">${rt(L)}</h2>
                `:""}
                ${i==="project"?nt`
                <div class="note">
                    <p>${rt("message_designer_project_save")}</p>
                </div>
                `:""}
                ${S?nt`
                <div class="control-item">
                    <label class="control-item-label">${rt("caption")}</label>
                    <textarea-counter maxlength="120"></textarea-counter>
                </div>
                `:""}
                ${b?nt`
                <div class="control-item">
                    <label class="control-item-label">${rt("file_name")}</label>
                    <input @change=${e} @keyup=${Be} .value=${t} class="input input--sm focus-initially" type="text" maxlength="100">
                </div>
                `:""}
                ${R?z():""}
                ${A?m():""}
                ${i==="project"?nt`
                <div class="control-item">
                    <label class="control-item-label">${rt("save_location")}</label>
                    <toggle-group
                        .value=${E.value}
                        .buttons=${E.buttons}
                        @change=${E.onChange}
                    ></toggle-group>
                    ${E.value==="befunky"?u():""}
                </div>
                `:""}
                ${i==="google_photos"?d():""}
                ${i==="complete"?nt`
                <div class="save-image__complete">
                    <p style="margin-bottom: 4px">${rt("image_ready")}</p>
                    <p><a href="#" @click=${le}>${rt("download_again")}</a></p>
                    <p style="margin-bottom: 4px">${rt("change_download_folder")}</p>
                    <p><a href="https://support.befunky.com/hc/en-us/articles/360003109972-How-To-Change-The-Download-Location-Of-Your-Images" data-bfntrack="CREATE|HELP|DOWNLOAD_FOLDER" class="tutorial-link" target="_blank" rel="noopener">${rt("tutorial_link_change_setting")}</a></p>
                    <div class="checkbox" style="margin-top: auto">
                        <input type="checkbox" id="sas_disable_save_complete_modal" .checked=${w.value} @change=${w.onChange}>
                        <label class="checkbox__label" for="sas_disable_save_complete_modal">
                            <span class="checkbox__box checkbox__box--sm">
                                ${Kr("checkmark-icon","icon checkbox__icon icon--12")}
                            </span>
                            <string>${rt("disable_modal")}</string>
                        </label>
                    </div>
                </div>
                `:""}
                ${F?"":nt`
                <div class="save-image__footer button-group">
                    <button @click=${he} class="modal__button button button--grey-300">${rt("cancel")}</button>
                    <button @click=${ne} class="modal__button button button--blue">${rt(Z())}</button>
                </div>`}
            </div>
        </div>
        `}function z(){let L=X=>i==="computer"||i==="navigator_share"?X:X.filter(({value:Y})=>Y!=="pdf"),{text:R,color:A}=U();return nt`
        <div class="control-item save-image__image-type">
            <label class="control-item-label">${rt("format")}</label>
            <toggle-group
                .value=${I.value}
                .buttons=${L(I.buttons)}
                @change=${I.onChange}
            ></toggle-group>
        </div>
        <div class="save-image__quality-and-size" style=${`margin: ${N?"2px":"8px"} 0 0`}>
            <div class="control-item-columns">
                ${I.value!=="pdf"?nt`
                <div class=${`control-item control-item--slider save-image__image-quality ${I.value!=="jpg"?"control-item-disabled":""}`}>
                    <slider-item
                        .value=${D.value}
                        .name=${D.name}
                        .multiplier=${D.multiplier}
                        .unit=${D.unit}
                        .step=${D.step}
                        .min=${D.min}
                        .max=${D.max}
                        .pips=${D.pips}
                        .enableStartEvent=${D.enableStartEvent}
                        .onUpdate=${D.onUpdate}
                    ></slider-item>
                </div>
                `:""}
                ${I.value==="pdf"?nt`
                <div class="control-item save-image__pdf-quality">
                    <label class="control-item-label">${rt("quality")}</label>
                    <toggle-group
                        .value=${_.value}
                        .buttons=${_.buttons}
                        @change=${_.onChange}
                    ></toggle-group>
                </div>
                `:""}
                <div class="control-item save-image__size">
                    <label class="control-item-label save-image__size-label">${rt("size")}</label>
                    <div class=${`save-image__size-text ${s?"save-image__size-text--updating":""}`}>${o}</div>
                    <div class="loading-spinner save-image__size-spinner"></div>
                </div>
            </div>
            <p class="save-image__quality-guide" style=${`color: ${A}`}>${rt(R)}</p>
        </div>`}function W(L,R){return typeof L=="function"&&(L=L()),L===R}function j(){let L;return i==="mobile_open"?L=J():i==="mobile_format"?L=ie():L=re(),nt`<div class="dialog__body">${L}</div>`}function J(){let L=document.createElement("div");return cn(R(),L),L;function R(){let X=I.value.toUpperCase(),Y=X==="JPG"?`${Math.round(k()*100)}%`:"100%";return nt`${p.map(({heading:ae,text:H,onClick:V,icon:K,children:ee,isDivider:se,isVisible:ge},Ce)=>W(ge,!1)?"":se?nt`<hr>`:ae?nt`
                        <h2 class="dialog__heading h4">${rt(ae)}</h2>
                        ${Ce===0?nt`
                        <button @click=${()=>{f.view="mobile_format"}} class="save-image__image-metadata text-sm button button--link button--fullwidth button--left-align button--lg button--mobile" >
                            <span style="display: block; color: var(--secondary-700)">${r}</span>
                            <span style="color: var(--secondary-600)">${X} <span style="color: var(--secondary-500); margin: 0 4px">|</span> ${o} <span style="color: var(--secondary-500); margin: 0 4px">|</span> ${Y}</span>
                            ${Kr("gear-icon","icon",{style:"position: absolute; margin: 3px 0 0 10px;"})}
                        </button>
                        `:""}
                        `:nt`
                    <button
                        class="button button--has-icon button--transparent button--fullwidth button--lg button--mobile"
                        @click=${Ge=>{ee?cn(A(ee),L):V(Ge)}}
                    >
                        ${Kr(K)}
                        <string>${rt(H)}</string>
                        ${ee?Kr("chevron-icon","icon icon--chevron-right"):""}
                    </button>
                    `)}`}function A(X){let Y=X.filter(ae=>!W(ae.isVisible,!1));return nt`
            <div class="dialog__back-button-header">
                <button
                    class="button button--has-icon button--transparent button--lg button--mobile"
                    @click=${()=>cn(R(),L)}
                >
                    ${Kr("arrow-icon","icon icon--18",{style:"transform: rotate(180deg);"})}
                    <string>${rt("back")}</string>
                </button>
            </div>
            ${Y.map(({text:ae,onClick:H,icon:V})=>nt`
                <button
                    class="button button--has-icon button--transparent button--fullwidth button--lg button--mobile"
                    @click=${K=>{H(K)}}
                >
                    ${Kr(V)}
                    <string>${rt(ae)}</string>
                </button>
            `)}
        `}}function ie(){return nt`
        <div class="dialog__back-button-header">
            <button
                class="button button--has-icon button--transparent button--lg button--mobile"
                @click=${()=>{f.view="mobile_open"}}
            >
                ${Kr("arrow-icon","icon icon--18",{style:"transform: rotate(180deg);"})}
                <string>${rt("back")}</string>
            </button>
        </div>
        <div style="padding: 0 1.5rem">
            ${z()}
        </div>
        `}function re(){let L=de();return nt`
        ${L?nt`
        <h2 class="dialog__heading h4">${rt(L)}</h2>
        `:""}
        <div style="padding: 0 1.5rem">
            ${i==="project"?nt`
            <div class="note">
                <p>${rt("message_designer_project_save")}</p>
            </div>
            `:""}
            ${S?nt`
            <div class="control-item">
                <label class="control-item-label">${rt("caption")}</label>
                <textarea-counter maxlength="120"></textarea-counter>
            </div>
            `:""}
            ${b?nt`
            <div class="control-item">
                <label class="control-item-label">${rt("file_name")}</label>
                <input @change=${e} @keyup=${Be} .value=${t} class="input focus-initially" type="text" maxlength="100" style="width: 100%">
            </div>
            `:""}
            ${i==="project"?nt`<div class="control-item">${u()}</div>`:""}
            ${i==="google_photos"?d():""}
            <div class="save-image__footer">
                <button @click=${ne} class="button button--blue button--fullwidth">${rt(Z())}</button>
            </div>
        </div>
        `}function he(){BeFunky.closeModal(f)}function ne(){n(y?"share":"save",G())}function le(L){L.preventDefault(),h()}function Be(L){L.key==="Enter"&&n(y?"share":"save",G())}function _e(){N&&i&&!i.startsWith("mobile_")?(f.setClass("save-image modal modal--button-sm"),BeFunky.openModal(f,{onClose:pe,size:"large",closeOnClickOutside:F,addCloseButton:F,onWindowResize:ke})):!N&&i&&i!=="complete"?(f.setClass("save-image save-image--mobile dialog dialog--mobile"),BeFunky.openModal(f,{onClose:pe,size:"small",closeOnClickOutside:!0,addCloseButton:!0,addAnchorBottomClass:!0,isFullWidthOnMobile:!0})):BeFunky.closeModal(f,!1)}function pe(){c(),f.view="",BeFunky.wait([250,"ric"],()=>{f.view||B({image:{visibility:"hidden"}})})}function Ie(){if(!a)return;let{base64:L,width:R,height:A,isTransparent:X}=a,Y=Math.min(R,g[0]),ae=Math.min(A,g[1]),H;if(R<Y&&A<ae)H=R;else{let V=R/Y,K=A/ae;V>K?H=Y:H=Math.floor(Y*V/K)}B({wrapper:{width:`${H}px`},bg:{paddingBottom:`${100/(R/A)}%`,backgroundImage:X?`url('${BFN.imagesURL}app/checker_pattern.jpg')`:""},image:{backgroundImage:`url("${L}")`,backgroundSize:`${H}px`,visibility:""}})}function ke({availableHeight:L,availableWidth:R}){L=Math.min(632,L),f.setStyles({maxHeight:`${L}px`});let A=320,X=447,Y=R-A,ae=58,H=Math.min(Math.max(X,L),Math.max(477,Y+ae));T(`width: ${Y}px; height: ${H}px`);let V=24*2,K=Y-V,ee=H-ae-V;f._previewMaxRenderedSize=[K,ee],l(K,ee)}function de(){return{computer:BeFunky.isMobile?"save_to_device":"save_to_computer",navigator_share:BeFunky.isIOS?"save_to_device":"share_image",befunky:"save_to_befunky",google_drive:"save_to_google_drive",google_photos:"save_to_google_photos",dropbox:"save_to_drop_box",project:"save_as_project",facebook:"share_on_facebook",pinterest:"share_on_pinterest",tumblr:"share_on_tumblr",twitter:"share_on_twitter"}[i]}function Z(){return y?"share":i==="computer"?BeFunky.isMobile?"download":"save":i==="navigator_share"?BeFunky.isIOS?"download_or_share_to":"share":i==="project"&&!N?"save_to_befunky":"save"}function U(){let L=I.value;if(L==="png")return{text:"image_quality_best",color:"var(--success-500)"};if(L==="pdf")return{text:_.value==="print"?"pdf_print_quality":"pdf_web_quality",color:"var(--success-500)"};let R=k();if(R>=.8){let A;return BeFunky.isFirefox?A=R>=.95?"image_quality_high":"image_quality_good":A=R===1?"image_quality_high":"image_quality_good",{text:A,color:"var(--success-500)"}}return R>=.5?{text:"image_quality_low",color:"var(--warning-500)"}:{text:"image_quality_worst",color:"var(--error-500)"}}function k(){let L;return I.value==="pdf"?L=UITools.getToolValue("sas","pdf_quality")==="print"?100:98:L=parseInt(UITools.getToolValue("sas","image_quality")),Number.isNaN(L)&&(L=100),Math.max(1,Math.min(100,L))/100}function G(){if(!b&&!S)return BeFunky.logError("All text inputs are hidden in save/share modal"),"";let L="";return b&&(L=f.querySelector("input").value),S&&(L=f.querySelector("textarea-counter").value),L=L.replace(/[\t\f\s\r\n]+/gim," ").replace(/\s{2,}/g,""),b&&(L=L.replace(/^[.\s]+/,"")),L.trim()}}function DM(i,e){return Object.assign({},i,e)}var zb=class{constructor(){this.init()}init(){this.initDefaultValues()}initDefaultValues(){this.watermarkControl=document.createElement("div"),this.handleWatermarkUpdatedBind=this.handleWatermarkUpdated.bind(this),this.saveShareModal=null,this.saveTexture=null,this.flattenedImage=null,this.altSaveTexture=null,this.saveCanvas=null,this.saveCanvasMimeType=null,this.previewCanvas=null,this.previewCanvasMimeType=null,this.previewRAF=null,this.watermarkTimestamp=null,this.destroyAltSaveTextureOnDispose=!1,this.imageQualityKey="options__saveImageQuality",window.addEventListener("INIT_COMPLETE",()=>{BeFunky.wait([1e3,"ric"],()=>this.getImageQualityFromLastSession())}),this.checkOnceIfSaveCompleteModalDisabled=BeFunky.once(()=>{let e=BeFunky.getLocal("disable_save_complete_modal")==="true";e&&UITools.setControlValue("sas_disable_save_complete_modal",e)}),this.fileNames={editor:{image:"",project:"",layer:""},collage:{image:"",project:"",layer:""},designer:{image:"",project:"",layer:""}},this.fileNamesKey="options__saveFileNames",this.hasFetchedFilenames=!1,window.addEventListener("INIT_COMPLETE",()=>{BeFunky.wait([1e3,"ric"],()=>this.getFileNamesFromIndexedDB())}),this.lastImageBlob=null,this.imageBlobError=null,this.isGeneratingImageBlob=!1,this.imageBlobDebug=0,this.imageSizeCache={},this.lastPDFBlob=null,this.lastFileName="",this.updateImageSize=BeFunky.debounce(this.updateImageSize.bind(this),0),this.updatePreviewImage=BeFunky.debounce(this.updatePreviewImage.bind(this),0),this.persistFileNames=BeFunky.debounce(this.persistFileNames.bind(this),200),this.persistImageQuality=BeFunky.debounce(this.persistImageQuality.bind(this),200),this.saveToComputerCount=0,this.pdfWorker=null,this.pdfPromise=null,this.googlePhotosAlbumsComponent=null,this.saveToFolderComponent=null,this.isSaveToFolderEnabled=!1,this.nativeSharePromiseStatus="",this.priorImageSettings=null,this.showMobileAppInstallationToastOnce=BeFunky.once(()=>{BeFunky.showToast({message:"install_app",acceptButton:BeFunky.isIOS?"open_app_store":"open_play_store",dismissDelay:1e4,position:"bottom-left",classes:["toast--install-app"],onAccept:()=>{let e=BeFunky.isIOS?"https://itunes.apple.com/us/app/befunky-photo-editor/id442716817?mt=8":"https://play.google.com/store/apps/details?id=air.com.befunky.BeFunkyPhotoEditor";window.open(e,"_blank")}})})}setupSaveShareModal(){hn(),this.saveShareModal=document.createElement("save-and-share"),this.saveShareModal.onFilenameChange=this.saveLastTypedFileName.bind(this),this.saveShareModal.updatePreviewImage=()=>{BFN.UploadSaveShareManager.previewCanvas=null,BFN.UploadSaveShareManager.updatePreviewImage()},this.saveShareModal.onClose=()=>{this.saveAndShareModalDispose(),this.modalView==="complete"&&BFN.UploadSaveShareManager.showUpgradePromptAfterSaving()},this.saveShareModal.onSaveOrShare=async(e,t)=>{if(BeFunky.isInDemoMode())return BeFunky.acknowledgeDemoMode();let r=this.createSaveShareCallback(e,this.modalView);if(!t)return r("please_enter_text");if(this.trackSaveOrShare(),this.modalView==="project")return this.handleSaveProject(t,r);this.getImageType()==="jpg"&&!this.isSocialSharingView()&&this.persistImageQuality();let a;try{a=await BeFunky.withLoadScreen(this.getImageBlobForSaving(()=>!BeFunky.isLoadScreenActive()))}catch(n){return r(n)}BeFunky.showLoadScreen();let s={computer:()=>(BFN.BfnService.track("CREATE",BFN.AppModel.sectionValue("SAVE","SAVE_COLLAGE","SAVE_DESIGNER"),"SAVE_DESKTOP"),this.saveToComputer(a,t)),navigator_share:()=>(BFN.BfnService.track("CREATE",BFN.AppModel.sectionValue("SAVE","SAVE_COLLAGE","SAVE_DESIGNER"),"SAVE_DESKTOP"),this.saveToComputer(a,t,!0)),befunky:()=>this.handleSaveToBeFunky(a,t),google_drive:()=>BFN.BfnService.saveToGoogleDrive(a,t),google_photos:()=>{let n=this.googlePhotosAlbumsComponent.getSelectedAlbum();return BeFunky.GooglePhotosManager.uploadMedia(a,t,n)},dropbox:()=>BFN.BfnService.saveToDropBox(a,t),facebook:()=>this.shareToSocialNetwork("facebook",a,t),twitter:()=>this.shareToSocialNetwork("twitter",a,t),pinterest:()=>this.shareToSocialNetwork("pinterest",a,t)},o=!1;try{await s[this.modalView](),o=!0}catch(n){r(n)}o&&r()},this.saveShareModal.onDownloadAgain=()=>{BeFunky.showLoadScreen(),this.saveToComputer(this.lastPDFBlob||this.lastImageBlob,this.lastFileName).then(()=>{BeFunky.hideLoadScreen(),this.openSaveOrShareImageModal("complete")});let e=BFN.AppModel.sectionValue("SAVE","SAVE_COLLAGE","SAVE_DESIGNER");BFN.BfnService.track("CREATE",e,"SAVE_DESKTOP_AGAIN")},this.saveShareModal.getSaveToFolderComponent=()=>this.saveToFolderComponent,this.saveShareModal.getGooglePhotosAlbumsComponent=()=>this.googlePhotosAlbumsComponent,this.saveShareModal.getWatermarkComponent=()=>this.watermarkControl}handleOpenSave(){if(BeFunky.isPaywallEnabled()&&!BeFunky.isPlus()){BeFunky.openTeaserModal("paywall");return}let e=UITools.getToolValue("editor_save_image","updating_id");switch(e){case"befunky":if(BeFunky.isLoggedIn())BFN.UploadSaveShareManager.openSaveOrShareImageModal("befunky");else{let t=BFN.AppModel.sectionValue("SAVE","SAVE_COLLAGE","SAVE_DESIGNER");BFN.BfnService.track("CREATE",t,"SavePanelEmailRegister"),BFN.BfnService.login(()=>BFN.UploadSaveShareManager.handleOpenSave())}break;case"computer":case"navigator_share":case"google_drive":case"dropbox":BFN.UploadSaveShareManager.openSaveOrShareImageModal(e);break;case"project":BFN.UploadSaveShareManager.openSaveOrShareImageModal(e),BFN.UploadSaveShareManager.setupSaveToFolder();break;case"google_photos":if(BeFunky.isInDemoMode())return BeFunky.acknowledgeDemoMode();BeFunky.GooglePhotosManager.mightBeAuthorized?(BFN.UploadSaveShareManager.setupGooglePhotosAlbums(),BFN.UploadSaveShareManager.openSaveOrShareImageModal(e)):BeFunky.GooglePhotosManager.login(!1).then(()=>{BFN.UploadSaveShareManager.setupGooglePhotosAlbums(),BFN.UploadSaveShareManager.openSaveOrShareImageModal(e)},t=>{t!=="cancelled_by_user"&&BeFunky.throwError("Unable to open Save to Google Photos",t)});break;case"facebook":case"pinterest":case"twitter":if(BeFunky.isInDemoMode())return BeFunky.acknowledgeDemoMode();if(!BeFunky.isLoggedIn()){BeFunky.confirm("confirm_sharing_login",{onConfirm:()=>BFN.BfnService.login(()=>BFN.UploadSaveShareManager.openSaveOrShareImageModal(e))});return}BFN.UploadSaveShareManager.openSaveOrShareImageModal(e);break;case"more_for_mobile":this.openShareMenuInNativeApp();break}}openShareMenuInNativeApp(){if(!BeFunky.isAppleAppStoreApp)return;if(!(this.altSaveTexture&&this.altSaveTexture.valid)){try{this.flattenedImage.destroyGC(!0)}catch(a){}if(this.flattenedImage=null,BFN.AppModel.viewingEditor){if(!BFN.PhotoEditorModel.currentTexture)return;if(BFN.PhotoEditorCanvasModel.viewState!==BFN.PhotoEditorCanvasModelViewStates.VIEWING_CANVAS&&BFN.PhotoEditorCanvasTools.currentTool){if(BFN.PhotoEditorCanvasTools.premiumWatermark.showing){BFN.PhotoEditorCanvasTools.applyCurrentTool("EDITOR_SAVE");return}BFN.PhotoEditorCanvasTools.applyCurrentTool(),BFN.PhotoEditorCanvasModel.exitCurrentEditorTool()}}let r=BFN.AppModel.sectionValue(BFN.PhotoEditorCanvas,BFN.CollageMakerCanvas,BFN.DesignerCanvas);if(this.flattenedImage=r.getFlattenedImage(),!this.flattenedImage){BeFunky.logError("Unable to create flattened image");return}}this.updateSaveTexture(!0,!0),BeFunky.showLoadScreen();let e=document.getElementById("sample_image_popover"),t=e?{top:e.offsetTop,left:e.offsetLeft,width:e.offsetWidth,height:e.offsetHeight}:{top:0,left:0,width:100,height:50};BFN.ExtractImage.currentTexture=this.saveTexture,BFN.ExtractImage.compress(.9,"image/jpeg",!1,r=>{window.saveToNativeMore(r,t,()=>{BeFunky.hideLoadScreen()})})}handleSaveAndShareModal(){switch(UITools.getToolValue("sas","updating_id")){case"image_type":{this.updateImageSize(),this.updatePreviewImage();return}case"image_quality":case"pdf_quality":UITools.getToolVO("sas").updating?this.isGeneratingImageBlob||(this.saveShareModal.isSizeUpdating=!0):(this.updateImageSize(),this.updatePreviewImage());return;case"disable_save_complete_modal":{let t=UITools.getToolValue("sas","disable_save_complete_modal");BeFunky.setLocal("disable_save_complete_modal",t)}}}openSaveOrShareImageModal(e,{onSave:t,mobileSaveDropdownItems:r}={}){if(BeFunky.isPaywallEnabled()&&!BeFunky.isPlus()){BeFunky.openTeaserModal("paywall");return}let a=e==="complete";if(!(this.altSaveTexture&&this.altSaveTexture.valid)&&!a){try{this.flattenedImage.destroyGC(!0)}catch(n){}if(this.flattenedImage=null,BFN.AppModel.viewingEditor){if(!BFN.PhotoEditorModel.currentTexture)return;if(BFN.PhotoEditorCanvasModel.viewState!==BFN.PhotoEditorCanvasModelViewStates.VIEWING_CANVAS&&BFN.PhotoEditorCanvasTools.currentTool){if(BFN.PhotoEditorCanvasTools.premiumWatermark.showing){BFN.PhotoEditorCanvasTools.applyCurrentTool("EDITOR_SAVE");return}BFN.PhotoEditorCanvasTools.applyCurrentTool(),BFN.PhotoEditorCanvasModel.exitCurrentEditorTool()}}let o=BFN.AppModel.sectionValue(BFN.PhotoEditorCanvas,BFN.CollageMakerCanvas,BFN.DesignerCanvas);if(this.flattenedImage=o.getFlattenedImage(),!this.flattenedImage){BeFunky.logError("Unable to create flattened image");return}}if(this.modalView=e,this.saveShareModal||this.setupSaveShareModal(),r&&(this.saveShareModal.mobileSaveDropdownItems=r),BeFunky.isSmartphone&&(e==="computer"||e==="navigator_share")){let o=new Date;this.saveShareModal.onSaveOrShare("save",`befunky_${o.getFullYear()}-${o.getMonth()}-${o.getDay()}_${o.getHours()}-${o.getMinutes()}-${o.getSeconds()}`);return}if(this.saveShareModal.view=e,a)return;this.onSaveCallback=t;let{sectionID:s}=BFN.AppModel;if(e==="project"?this.saveShareModal.filename=this.fileNames[s].project||"BeFunky-project":this.altSaveTexture?this.saveShareModal.filename=this.fileNames[s].layer||"BeFunky-layer":this.saveShareModal.filename=this.fileNames[s].image||`BeFunky-${BFN.AppModel.sectionValue("photo","collage","design")}`,(e==="computer"||e==="navigator_share")&&this.preloadPDFWorker(),this.updateSaveTexture(!0),this.saveTexture)this.saveShareModal.dimensions=`${this.saveTexture.width} \xD7 ${this.saveTexture.height}`;else if(BFN.AppModel.viewingEditor){let{width:o,height:n}=BFN.PhotoEditorModel.currentTextureDimensions;this.saveShareModal.dimensions=`${o} \xD7 ${n}`}else{let{projectVO:o}=BFN.AppModel.sectionValue(BFN.PhotoEditorModel,BFN.CollageMakerModel,BFN.DesignerModel);this.saveShareModal.dimensions=`${o.projectWidth} \xD7 ${o.projectHeight}`}this.isWatermarkEnabled()&&(BFN.WatermarkManager.removeEventListener(BFN.WatermarkManagerEvents.WATERMARK_UPDATED.type,this.handleWatermarkUpdatedBind),BFN.WatermarkManager.addEventListener(BFN.WatermarkManagerEvents.WATERMARK_UPDATED.type,this.handleWatermarkUpdatedBind),this.watermarkControl.firstElementChild||BFN.UI.watermarkControl(this.watermarkControl),this.watermarkControl.sourceTexture=this.altSaveTexture||this.flattenedImage,BFN.WatermarkManager.activate())}trackSaveOrShare(){let e={computer:"Computer",navigator_share:"Computer",befunky:"BeFunky",facebook:"Facebook",pinterest:"Pinterest",google_drive:"Google Drive",google_photos:"Google Photos",dropbox:"Drop Box",twitter:"Twitter",tumblr:"Tumblr"},t=null,r=null,a=!1;if(this.modalView==="project"?(t="Project",r=e[this.getProjectLocation()]):(this.isImageFormatEnabled()?(t=this.getImageType().toUpperCase(),a=BFN.WatermarkManager.watermarkActive):t="JPG",r=e[this.modalView]),t&&r){let s=BFN.UserActionManager.getSaveData(),o=new BFN.UserActionVO;o.eventID="media_saved",o.eventObject={mediaSaveType:t,mediaSaveLocation:r,mediaSaveWatermark:a,mediaSaveMainFunnel:s.actions,mediaSaveFontsUsed:s.fonts,mediaSaveLayerSourcesUsed:s.assets,mediaSaveGraphicsUsed:s.graphicFileNames,mediaSaveGraphicsStyleUsed:s.graphicStyles},BFN.AppModel.viewingDesigner&&BFN.DesignerModel.projectVO.sourceTemplateID&&(o.eventObject.templateID=BFN.DesignerModel.projectVO.sourceTemplateID),o.peopleObject={lastMediaSaveDate:window.bfn_mp?window.bfn_mp.getISODate():"n/a",lifetimeMediaSaveCount:1,lifetimeImagesSaveCount:1},o.track()}else BeFunky.throwError("Save/share not tracked",{mediaSaveType:t,mediaSaveLocation:r,modalView:this.modalView})}createSaveShareCallback(e,t){return r=>{if(BeFunky.hideLoadScreen(),r){if(r==="cancel"||r==="cancelled_by_user")return;typeof r=="string"?BeFunky.logError("Save/share error:",r):(BeFunky.logError("Save/share failed:"),BeFunky.throwError(r)),(r==="not_login"||r==="not_logged_in")&&(BeFunky.closeModal(this.saveShareModal),UIMessages.display("error_not_logged_in",1e3));let a="error_invalid_response";return BeFunky.LanguageManager.isTranslated(`error_${r}`)?a=`error_${r}`:BeFunky.LanguageManager.isTranslated(r)&&(a=r),UIMessages.display(a,1e3)}BeFunky.closeModal(this.saveShareModal),(t==="project"||e==="save"&&BFN.AppModel.viewingEditor)&&BFN.UnsavedOpenProjectManager.setSaved(BFN.AppModel.sectionID,!0,"saved"),t==="computer"&&!BeFunky.isMobile&&(this.checkOnceIfSaveCompleteModalDisabled(),UITools.getControlValue("sas_disable_save_complete_modal")?this.showUpgradePromptAfterSaving():this.openSaveOrShareImageModal("complete")),e==="save"&&UIMessages.display(t==="project"?"project_saved":BFN.canShareNatively()?"success":"image_saved"),(t==="twitter"||t==="tumblr")&&(console.log("showing twitter message..."),UIMessages.display("image_shared")),BeFunky.shouldInstallMobileApp&&this.showMobileAppInstallationToastOnce(),this.onSaveCallback&&this.onSaveCallback()}}handleSaveToBeFunky(e,t){return new Promise((r,a)=>{if(!BeFunky.isLoggedIn())return a("not_logged_in");let s=t.slice(0,100),o="";try{let d={},m=[];for(;d=this.hashtagRegExp.exec(s);){let p=d[0].replace("#","").toLowerCase();m.push(p)}o=m.join(",")}catch(d){}let n,l=!1;BeFunky.showLoadScreen({onCancel:()=>{l=!0,n&&n.abort(),a("cancelled_by_user")}});let c={};BFN.AppModel.viewingCollage&&(c.apptype="collage"),c.Title=s,c.bftags="",c.preset_id="0",c.isPublic=0,c.tags=o,c.image=e,c.image_type=e.type,c.CSRFtoken=getCsToken();let h=`${BeFunky.Params.uplUri}/restupload/savegallery.bfn`,u={method:"POST",body:BeFunky.createFormData(c),uploadProgressHandler:(d,m)=>{BeFunky.updateLoadScreenProgress("uploading",100*d/m)}};n=BeFunky.request(h,u,({response:d,error:m})=>{if(l)return;if(m=m||d.err,m)return m==="not_login"&&BeFunky.UserManager.checkUserToken("not_logged_in","API"),a(m);r();let p=BFN.AppModel.sectionValue("SAVE","SAVE_COLLAGE","SAVE_DESIGNER");BFN.BfnService.track("CREATE",p,"BEFUNKY"),BeFunky.ImagesService.resetImageData()})})}shareToSocialNetwork(e,t,r){return new Promise((o,n)=>{let l,c=!1;BeFunky.showLoadScreen({message:"uploading",onCancel:()=>{c=!0,l&&l.abort(),n("cancelled_by_user")}});let h=`${BeFunky.Params.uplUri}/restupload/savetoanonymous.bfn`,u={method:"POST",body:BeFunky.createFormData({title:r,image_type:t.type,image:t,CSRFtoken:getCsToken()}),uploadProgressHandler:(d,m)=>{BeFunky.updateLoadScreenProgress("uploading",100*d/m)}};l=BeFunky.request(h,u,({response:d,error:m})=>{if(c)return;if(m||!d||!d.link||!d.fileurl)return n(m||"invalid_response");let p=BFN.AppModel.sectionValue("SHARE","SHARE_COLLAGE","SHARE_DESIGNER");BFN.BfnService.track("CREATE",p,e.toUpperCase()),console.log("Share response:",d),o();let g=a(e,d.link,d.fileurl,r),f="ok";BeFunky.confirm(["open_share_popup",{ok:BeFunky.LanguageManager.getString(f),service:s(e)}],{onConfirm:()=>{window.openCustomPopup(g)},confirmText:f})})});function a(o,n,l,c){return n=encodeURIComponent(n),l=encodeURIComponent(l),c=encodeURIComponent(c),{pinterest:`https://pinterest.com/pin/create/button/?url=${n}&description=${c}&media=${l}`,twitter:`${BeFunky.Params.siteUrl}tweetSend.php?url=${n}&imgtitle=${c}`,facebook:`https://www.facebook.com/dialog/share?app_id=120991377944644&display=popup&href=${n}`}[o]}function s(o){return o.charAt(0).toUpperCase()+o.slice(1).toLowerCase()}}handleSaveProject(e,t){let r=this.getProjectLocation();if(r==="befunky"&&!BeFunky.isLoggedIn())return BFN.BfnService.login();let a=!1;BeFunky.showLoadScreen({onCancel:()=>{a=!0}});let s=e.replace(/\.bfd$/i,"")||"Befunky-project",o=BFN.AppModel.sectionValue(BFN.PhotoEditorModel,BFN.CollageMakerModel,BFN.DesignerModel);o.projectVO.filename=s;let{sectionID:n}=BFN.AppModel;(()=>BFN.AppModel.viewingEditor&&BFN.ImageEditManager.editingImage?BFN.ProjectManager.getOpenImageInEditorProject():BFN.ProjectManager.requestLocalSave({isLazy:!1,createThumbnail:!0}).then(()=>BFN.ProjectService.getLocalProject(n,{logLevel:"throw"})))().then(c=>{if(a)throw"cancelled_by_user";if(r==="befunky")return this.isSaveToFolderEnabled&&(c.folder=this.saveToFolderComponent.getSelectedFolder()),BFN.ProjectManager.createThumbnail(n,"blob",!0).then(h=>{this.saveProjectToBeFunky(c,h,t),BFN.BfnService.track("CREATE",BFN.AppModel.sectionValue("SAVE","SAVE_COLLAGE","SAVE_DESIGNER"),"SAVE_PROJECT_BEFUNKY")});this.saveProjectToComputer(c,t),BFN.BfnService.track("CREATE",BFN.AppModel.sectionValue("SAVE","SAVE_COLLAGE","SAVE_DESIGNER"),"SAVE_PROJECT_COMPUTER")}).catch(c=>{if(c!=="cancelled_by_user"){let h=c&&c.name?c.name:c;BeFunky.throwError(`Failed to save project: ${h}`,c)}(c==="invalid_editor_image_blob"||c==="missing_editor_image_blob")&&BFN.PhotoEditorModel.saveCurrentTextureBlob(0),t(c)})}getImageBlobForSaving(e){return new Promise((t,r)=>{let{projectVO:a}=BFN.AppModel.sectionValue(BFN.PhotoEditorModel,BFN.CollageMakerModel,BFN.DesignerModel),{printDPI:s}=a;this.updateImageSize();let o=200,n=50;BeFunky.wait([10],()=>BeFunky.waitUntil({condition:()=>e()||!this.isGeneratingImageBlob,onSuccess:()=>{if(e())return r();if(this.imageBlobError)return r(this.imageBlobError);let c=this.getImageType(),h;if(BFN.AppModel.viewingEditor&&!this.altSaveTexture&&BFN.PhotoEditorModel.currentEXIF&&(h=BFN.PhotoEditorModel.currentEXIF),c==="png"){BFN.ExifTool.changeDPIForPNG(this.lastImageBlob,s,h).then(t);return}if(c==="pdf"){let{width:u,height:d}=this.saveTexture,m=UITools.getControlValue("sas_pdf_quality")==="print"?s||300:72,p=Math.round(u*72/m),g=Math.round(d*72/m);this.createPDF(this.lastImageBlob,p,g).then(f=>{this.lastPDFBlob=f,t(f)},f=>{BeFunky.throwError("Unable to create PDF",f),r(f)});return}BFN.ExifTool.insert(this.lastImageBlob,h,s).then(u=>{t(u)},u=>{BeFunky.logError("Unable to add EXIF data to image blob. Falling back to original blob.",u),t(this.lastImageBlob),l()})},onTimeout:()=>{l(),BeFunky.throwError(`Unable to generate blob for saving image in ${o*n/1e3} seconds. Stalled at ${this.imageBlobDebug}`),r("image_blob_timeout")},interval:o,maxAttempts:n}));function l(){BeFunky.logError("webglTextureSize:",window.webglTextureSize),BeFunky.logError(`Texture Memory: ${BFN.Util.getTotalTextureMemory()} MB`),navigator.deviceMemory&&BeFunky.logError(`Device Memory: ${navigator.deviceMemory} GB`),BeFunky.logError("appRect:",`${BFN.appRect.width} x ${BFN.appRect.height}`)}})}updateSaveTexture(e,t=!1){if(!this.altSaveTexture&&!this.flattenedImage)return;try{this.saveTexture&&this.saveTexture.destroyGC(!0),this.saveTexture=(this.altSaveTexture||this.flattenedImage).renderClone()}catch(a){this.saveTexture=null;return}if(this.isWatermarkEnabled()&&this.isPreviewVisible()&&BFN.WatermarkManager.drawWatermark(this.saveTexture),t)return;let r;this.isImageFormatEnabled()?(r=this.saveTexture.determineTransparency(),r&&e&&this.setImageType("png"),this.modalView!=="computer"&&this.modalView!=="navigator_share"&&this.getImageType()==="pdf"&&this.setImageType(r?"png":"jpg"),this.imageSizeCache={},this.lastImageBlob=null,this.lastPDFBlob=null,this.updateImageSize(!0)):this.isSocialSharingView()&&(this.priorImageSettings={type:this.getImageType(),quality:this.getImageQuality(!1)},this.setImageType("jpg"),this.setImageQuality(98)),this.updatePreviewImage(r)}updatePreviewImage(e){let t=this.saveTexture;if(!t||!t.valid||(cancelAnimationFrame(this.previewRAF),!this.isPreviewVisible()))return;let r=.92,a=!1;this.isImageFormatEnabled()&&(a=this.getImageType()==="png",r=this.getImageQuality()),this.modalView==="project"&&(typeof e!="boolean"&&(e=t.determineTransparency()),a=e);let s=a?"image/png":"image/jpeg";if(!this.previewCanvas||this.previewCanvasMimeType!==s){let[n,l]=this.saveShareModal._previewMaxRenderedSize,c=window.previewRatio||2,h=n*c,u=l*c,d=Math.min(1,h/t.width,u/t.height),m=Math.round(t.width*d),p=Math.round(t.height*d),g=BFN.Util.resizeTexture(t,m,p);if(!g){BeFunky.throwError("Unable to create preview",{previewW:m,previewH:p,scale:d,maxRenderedWidth:n,maxRenderedHeight:l});return}this.previewCanvas=BFN.TextureUtils.textureToCanvas(g,{isTransparent:a}),g.destroyGC(!0)}let o=this.previewCanvas.toDataURL(s,r);this.previewCanvasMimeType=s,this.previewRAF=requestAnimationFrame(()=>{!this.previewCanvas||(this.saveShareModal.previewImage={base64:o,width:this.previewCanvas.width,height:this.previewCanvas.height,isTransparent:a})})}saveAndShareModalDispose(){if(BFN.WatermarkManager.removeEventListener(BFN.WatermarkManagerEvents.WATERMARK_UPDATED.type,this.handleWatermarkUpdatedBind),this.watermarkControl.sourceTexture=null,this.destroyAltSaveTextureOnDispose){this.destroyAltSaveTextureOnDispose=!1;try{this.altSaveTexture.destroyGC(!0)}catch(e){}}this.altSaveTexture=null,this.flattenedImage&&(this.flattenedImage.destroyGC(!0),this.flattenedImage=null),this.saveTexture&&(this.saveTexture.destroyGC(!0),this.saveTexture=null),this.saveCanvas=null,this.saveCanvasMimeType=null,this.previewCanvas=null,this.previewCanvasMimeType=null,this.priorImageSettings&&(this.setImageType(this.priorImageSettings.type),this.setImageQuality(this.priorImageSettings.quality),this.priorImageSettings=null)}showUpgradePromptAfterSaving(){if(BFN.BfnService.userIsPlus||(this.saveToComputerCount++,this.saveToComputerCount%3!=0))return;let e=BFN.AppModel.sectionID;BeFunky.openTeaserModal(`save_${e}`)}async getBlob({quality:e,mimeType:t}={}){let r=t==="image/png";return this.imageBlobDebug=2,(!this.saveCanvas||this.saveCanvasMimeType!==t)&&(this.saveCanvas=BFN.TextureUtils.textureToCanvas(this.saveTexture,{isTransparent:r}),this.saveCanvasMimeType=t),this.imageBlobDebug=3,BFN.BlobUtils.canvasToBlob(this.saveCanvas,t,e)}updateImageSize(e=!1){let t=()=>{if(!this.saveTexture)return!1;let s=this.getImageQuality(),o=this.getMimeType();return!this.lastImageBlob||s!==this.lastImageBlob.quality||o!==this.lastImageBlob.mimeType||this.watermarkTimestamp!==this.lastImageBlob.watermarkTimestamp},r=(s=!0)=>{this.saveShareModal.isSizeUpdating=!0;let o=this.getImageQuality(),n=this.getMimeType(),l=n==="image/png"?"image/png":n+o,{watermarkTimestamp:c}=this;this.imageSizeCache[l]&&(this.saveShareModal.imageSize=this.imageSizeCache[l]),!this.isGeneratingImageBlob&&(this.isGeneratingImageBlob=!0,this.imageBlobDebug=1,this.getBlob({quality:o,mimeType:n}).then(h=>{this.imageBlobDebug=5,h.quality=o,h.mimeType=n,h.watermarkTimestamp=c,this.imageBlobError=null,this.lastImageBlob=h,this.isGeneratingImageBlob=!1;let u=a(h.size);this.imageSizeCache[l]=u,t()?r():(this.saveShareModal.isSizeUpdating=!1,this.saveShareModal.imageSize=u)},h=>{s?(BeFunky.logError("Unable to generate Blob from saving. Trying again...",h),requestIdleCallback(()=>{this.isGeneratingImageBlob=!1,r(!1)})):(BeFunky.reportWarning("Failed to generate image blob for saving",h),this.imageBlobError=h,this.lastImageBlob=null,this.isGeneratingImageBlob=!1,this.saveShareModal.isSizeUpdating=!1,this.saveShareModal.imageSize="?")}))};e&&this.saveTexture||t()?r():this.saveShareModal&&(this.saveShareModal.isSizeUpdating=this.isGeneratingImageBlob);function a(s){let o=s<1024**2?0:1;return BeFunky.formatBytes(s,o)}}saveToComputer(e,t,r=!1){let{fn:a,extension:s}=this.getValidFilename(t,e,!0);return t=a,this.lastFileName=t,this.flattenedImage&&(this.flattenedImage.destroyGC(!0),this.flattenedImage=null),this.saveTexture&&(this.saveTexture.destroyGC(!0),this.saveTexture=null),new Promise((n,l)=>{let c=!0;window.addEventListener("blur",u),window.addEventListener("focus",d);let h=Date.now();o().then(m=>{if(m)return window.removeEventListener("blur",u),window.removeEventListener("focus",d),n();setTimeout(()=>{c&&(window.removeEventListener("blur",u),window.removeEventListener("focus",d),n())},Math.max(0,1e3-(Date.now()-h)))},m=>{l(m)});function u(){window.removeEventListener("blur",u),c=!1}function d(){window.removeEventListener("focus",d),n()}});async function o(){if(BeFunky.isAppleAppStoreApp){if(s===".pdf"){let n=document.getElementById("sample_image_popover"),l=n?{top:n.offsetTop,left:n.offsetLeft,width:n.offsetWidth,height:n.offsetHeight}:{top:0,left:0,width:100,height:50};window.saveToNativeDirectory(e,t,l,c=>{})}else window.saveToCameraRoll(e,n=>{});return!0}if(r&&BFN.canShareNatively()){BFN.UploadSaveShareManager.log("Attempt to share natively");let n={title:t,files:[new File([e],t,{type:e.type})]};try{return await BFN.UploadSaveShareManager.navigatorShare(n),!0}catch(l){if(l==="cancelled_by_user")throw"cancelled_by_user";BeFunky.logWarning("Failed to save/share using native overlay",l)}}else BFN.UploadSaveShareManager.log("Not attempting to share natively");return saveAs(e,t),!1}}navigatorShare(e){return new Promise((t,r)=>{if(!navigator.canShare(e))return this.log("canShare failed"),r("not_supported");if(this.nativeSharePromiseStatus==="pending")return this.log("iOS share never resolved"),r("ios_bug");let a=()=>{};if(BeFunky.isIOS){let s=this.nativeSharePromiseStatus===""?4:10;a=BeFunky.wait([s*1e3],()=>{this.log("iOS share timed out",s),t()})}this.nativeSharePromiseStatus="pending",navigator.share(e).then(()=>{this.nativeSharePromiseStatus="resolved",this.log("Native share succeeded"),t()},s=>{this.nativeSharePromiseStatus="rejected",s.name==="AbortError"?(this.log("Native share cancelled"),r("cancelled_by_user")):(this.log("Native share failed",s),r(s))}).then(()=>a())})}saveProjectToComputer(e,t){BFN.ProjectManager.getCompressedBlob(e).then(r=>{if(BeFunky.isAppleAppStoreApp){let a=document.getElementById("sample_image_popover"),s=a?{top:a.offsetTop,left:a.offsetLeft,width:a.offsetWidth,height:a.offsetHeight}:{top:0,left:0,width:100,height:50};window.saveToNativeDirectory(r,`${e.filename}.bfd`,s,t)}else saveAs(r,`${e.filename}.bfd`),t()}).catch(t)}saveProjectToBeFunky(e,t,r,a=!1){BFN.SavedProjectService.getAllProjects().catch(s=>{if(s==="no_results")return[];throw s}).then(s=>{let o=(l,c)=>{BeFunky.showLoadScreen({message:"uploading"});let h={bfdBlob:l,thumbnailBlob:t,uploadProgressHandler:u,projectObject:e,date:c};BFN.SavedProjectService.saveBfdFileToBeFunky(h,({error:d,data:m})=>{if(d)return r(d);BFN.SavedProjectService.resetProjectData(),BFN.DesignerTemplateManager.recentProjectsComponent&&BFN.DesignerTemplateManager.recentProjectsComponent.fetchProjects();let p=document.querySelector("dashboard-projects");p&&p.fetchProjects(),r()});function u(d,m){BeFunky.updateLoadScreenProgress("uploading",100*d/m)}},n=s.find(l=>l.filename===e.filename);if(n&&a){let l=/\(\d+\)$/,c=(d,m)=>l.test(d)?d.replace(l,`(${m})`):`${d} (${m})`,h=1,u=e.filename;for(e.filename=c(u,h);s.some(d=>d.filename===e.filename);)h++,e.filename=c(u,h);BeFunky.logWarning("Added number to project filename to avoid conflict:",e.filename),n=void 0}n?BeFunky.confirm("confirm_project_overwrite",{onConfirm:async()=>{try{e.folder||(e.folder=n.folderId);let l=await BFN.ProjectManager.getCompressedBlob(e);await BeFunky.SavedProjectFetcher.deleteProject(n.templateid),o(l,n.date)}catch(l){r(l)}},onCancel:()=>r("cancel"),confirmText:"yes",cancelText:"no",focusConfirmButton:!1}):BFN.ProjectManager.getCompressedBlob(e).then(o).catch(r)}).catch(s=>(typeof s!="string"&&BeFunky.throwError(s),r(s)))}getFileNamesFromIndexedDB(){BFN.IndexedDB.get(this.fileNamesKey).then(e=>{!e||Object.entries(this.fileNames).forEach(([t,r])=>{!e[t]||Object.entries(r).forEach(([a,s])=>{if(s)return;let o=e[t][a];r[a]=typeof o=="string"?o:""})})}).catch(BeFunky.logWarning).then(()=>{this.hasFetchedFilenames=!0})}getValidFilename(e,t,r){let a="BeFunky-artwork";typeof e!="string"&&(e=a),e=e.trim().replace(/(\.(jpe?g|png|pdf))+$/,"").replace(/^\.+|\.+$/,""),e||(e=a);let s="";return t.type==="image/jpeg"&&(s=".jpg"),t.type==="image/png"&&(s=".png"),t.type==="application/pdf"&&(s=".pdf"),e+=s,r?{fn:e,extension:s}:e}setFileName(e,t,r){if(e=e||BFN.AppModel.sectionID,!["editor","collage","designer"].includes(e))return BeFunky.logError("Invalid sectionID",e);if(!["image","project","layer"].includes(t))return BeFunky.logError("Invalid file type",t);if(typeof r!="string")return BeFunky.logError("Invalid file name",r);this.fileNames[e][t]!==r&&(this.fileNames[e][t]=r,this.persistFileNames())}persistFileNames(){if(!this.hasFetchedFilenames)return this.persistFileNames();BFN.IndexedDB.set(this.fileNamesKey,this.fileNames).catch(BeFunky.logWarning)}getImageQualityFromLastSession(){BFN.IndexedDB.get(this.imageQualityKey).then(e=>{e=parseInt(e),!(Number.isNaN(e)||e<0||e>100)&&this.setImageQuality(e)}).catch(BeFunky.logWarning)}persistImageQuality(){BFN.IndexedDB.set(this.imageQualityKey,this.getImageQuality(!1)).catch(e=>BeFunky.logError("Unable to image quality to IndexedDB",e))}setupGooglePhotosAlbums(){if(this.googlePhotosAlbumsComponent)return;this.googlePhotosAlbumsComponent=rn({fetchAlbums:()=>BeFunky.GooglePhotosManager.getAlbums(),createAlbum:t=>BeFunky.GooglePhotosManager.createAlbum(t),onToggle:e});function e(t){BFN.IndexedDB.set("options__saveToGooglePhotosAlbum",t)}}setupSaveToFolder(){if(this.saveToFolderComponent){BeFunky.isLoggedIn()&&this.saveToFolderComponent.loadFolders();return}this.saveToFolderComponent=on({fetchItems:()=>BeFunky.ProjectFolderService.getFolders(),createItem:t=>BeFunky.ProjectFolderService.createFolder(t).then(({folderId:r})=>({name:t,folderId:r})),onToggle:e,initialOptions:t=>t.map(({folderId:r,name:a})=>({name:a,value:r}))});function e(t){BFN.UploadSaveShareManager.isSaveToFolderEnabled=t}}preloadPDFWorker(){this.pdfWorker||(this.pdfWorker=new Worker(`${BFN.jsURL}pdf-worker-v3.min.js`),this.pdfWorker.addEventListener("message",({data:e})=>{e.type==="success"&&e.content instanceof Blob&&this.pdfPromise.resolve(e.content),this.pdfPromise.reject(e.type==="error"?e.content:"invalid_pdf_blob")}),this.pdfWorker.addEventListener("error",e=>{BeFunky.reportWarning("PDF Worker error",e),this.pdfPromise&&setTimeout(()=>this.pdfPromise.reject("worker_error"),100)}))}createPDF(e,t,r){return this.pdfPromise=deferredPromise(),this.pdfWorker.postMessage({image:e,width:t,height:r}),this.pdfPromise}log(...e){BeFunky.logFeature("save",...e)}isPreviewVisible(){return BeFunky.isWiderThanMobile()}getProjectLocation(){return BeFunky.isWiderThanMobile()?UITools.getToolValue("sas","project_location"):"befunky"}isWatermarkEnabled(){return this.modalView&&this.modalView!=="complete"&&this.modalView!=="project"}isSocialSharingView(){return["facebook","pinterest","tumblr","twitter"].includes(this.modalView)}isImageFormatEnabled(){return this.modalView&&this.modalView!=="complete"&&this.modalView!=="project"&&!this.isSocialSharingView()}getImageType(){return UITools.getToolValue("sas","image_type")}setImageType(e){if(!["jpg","png","pdf"].includes(e))throw new Error(`Invalid image type "${e}"`);UITools.setControlValue("sas_image_type",e),UITools.updateToolControl("sas_image_type"),UITools.applyToolControl("sas_image_type")}getImageQuality(e=!0){let t;this.getImageType()==="pdf"?t=UITools.getToolValue("sas","pdf_quality")==="print"?100:98:t=parseInt(UITools.getToolValue("sas","image_quality")),Number.isNaN(t)&&(t=100);let r=Math.max(1,Math.min(100,t));return e?r/100:r}setImageQuality(e){e=Math.max(1,Math.min(100,e))||98,UITools.setControlValue("sas_image_quality",e),UITools.updateToolControl("sas_image_quality"),UITools.applyToolControl("sas_image_quality")}getMimeType(){return["jpg","pdf"].includes(this.getImageType())?"image/jpeg":"image/png"}saveLastTypedFileName(e){let t=e.target.value;if(!t)return;let r=this.modalView==="project"?"project":this.altSaveTexture?"layer":"image";this.setFileName(void 0,r,t)}handleWatermarkUpdated(){this.previewCanvas=null,this.saveCanvas=null,this.watermarkTimestamp=BFN.WatermarkManager.useWatermark?Date.now():null,this.updateSaveTexture(!1)}};BFN.SingletonQueue.add(()=>{BFN.UploadSaveShareManager=new zb});var Wb=class extends BFN.EventDispatcher{constructor(){super();this.init()}init(){BeFunky.log("AppManager Init"),this.initDefaultValues()}initDefaultValues(){UITools.addEventListener(UIToolsEvents.UPDATE_TOOL.type,this.handleUpdateTool.bind(this))}handleUpdateTool(e){let t=e.data,r=UITools.getToolVO(t);if((BFN.PhotoEditorCanvasTools.currentTool||UITools.toolPlusHash[t])&&BFN.toolViewstates.hasOwnProperty(t)&&(BFN.PremiumWatermark.currentToolID=t,BFN.PremiumWatermark.updateDisplay()),r.updating&&!BFN.smoothPictureDisabled?BFN.smoothPictureDisabled=!0:!r.updating&&BFN.smoothPictureDisabled&&(BFN.smoothPictureDisabled=!1),r)switch(t){case"app_goto":BFN.AppModel.handleAppGoto();break;case"user_account":BFN.AccountManager.handleAccountAction();break;case"user_settings":BFN.SettingsManager.handleSettingUpdate();break;case"language":{let a=UITools.getToolValue("language","select");BeFunky.LanguageManager.handleUserUpdateLanguage(a);break}case"editor_history_action":BFN.UndoManager.handleEditorHistoryAction();break;case"editor_apply_cancel":BFN.PhotoEditorCanvasTools.handleEditorApplyCancel();break;case"editor_load_image":BFN.OpenManager.handleOpenImage();break;case"designer_open":BFN.DesignerTemplateManager.handleOpen();break;case"editor_save_image":BFN.UploadSaveShareManager.handleOpenSave();break;case"open_project":BFN.OpenManager.handleOpenProject();break;case"sas":BFN.UploadSaveShareManager.handleSaveAndShareModal();break;case"editor_flatten":BFN.PhotoEditorCanvasModel.handleEditorFlatten();break;case"editor_effect":BFN.FeaturedManager.handleEffectCategory(),BFN.FavoritesManager.handleEffectCategory();break;case"editor_artsy":BFN.FeaturedManager.handleArtsyCategory(),BFN.FavoritesManager.handleArtsyCategory();break;case"editor_frame":BFN.FeaturedManager.handleFrameCategory(),BFN.PhotoEditorCanvasModel.handleUpdateTool("editor_frame");break;case"editor_overlay":BFN.PhotoEditorCanvasModel.handleEditorOverlay();break;case"editor_texture":BFN.FeaturedManager.handleTextureCategory();break;case"text_edit":BFN.FabricManager.handleTextEdit();break;case"editor_graphic":BFN.GraphicLibraryManager.handleGraphicCategory();break;case"zoom":BFN.ZoomManager.handleZoom();break;case"transform":BFN.TransformModel.handleTransform();break;case"layer":BFN.TransformModel.handleLayer();break;case"layers":UILayers.handleLayers();break;case"alignment":BFN.AlignmentOptionsManager.handleAlignmentUpdate();break;case"history":UIHistory.handleHistory();break;case"paint_brush":BFN.ImagePaintBrush.handlePaintBrush();break;case"clone":BFN.ImageClone.handleClone();break;case"blemish_fix":BFN.ImageBlemish.handleBlemish();break;case"background":BFN.ImageBackground.handleBackground();break;case"background_brush":BFN.ImageBackground.handleBackgroundBrush();break;case"matting":BFN.PhotoEditorCanvasModelViewStates.VIEWING_MATTING&&BFN.ImageMatting.handleMatting();break;case"cutout":BFN.ImageCutout.handleCutout();break;case"touch_up_brush":BFN.ImageTouchUp.handleTouchUpBrush();break;case"effect_generic":BFN.ImageEffect.handleEffectGeneric();break;case"effect_brush":BFN.ImageEffect.handleEffectBrush();break;case"artsy_generic":BFN.ImageArtsy.handleArtsyGeneric();break;case"artsy_brush":BFN.ImageArtsy.handleArtsyBrush();break;case"frame_square":BFN.ImageSquare.handleSquare();break;case"frame_border":BFN.ImageBorder.handleBorder();break;case"frame_drop_shadow":BFN.ImageDropShadow.handleDropShadow();break;case"frame_crop_rotate_generic":BFN.ImageFrame.handleFrameCropRotateGeneric();break;case"frame_crop_generic":BFN.ImageFrame.handleFrameCropGeneric();break;case"frame_full_generic":BFN.ImageFrame.handleFrameFullGeneric();break;case"frame_smart_generic":BFN.ImageFrame.handleFrameSmartGeneric();break;case"texture_generic":BFN.ImageTexture.handleTextureGeneric();break;case"texture_brush":BFN.ImageTexture.handleTextureBrush();break;case"overlay_generic":BFN.ImageOverlay.handleOverlayGeneric();break;case"lens_flare_generic":BFN.ImageLensFlare.handleLensFlareGeneric();break;case"crop":BFN.ImageCrop.handleCrop();break;case"rotate":BFN.ImageRotator.handleRotate();break;case"resize":BFN.ImageResize.handleResize();break;case"slimming":BFN.ImageSlimming.handleSlimming();break;case"reshape":BFN.ImageReshape.handleReshape();break;case"tilt":BFN.ImageTilter.handleTilt();break;case"funky_focus":BFN.ImageFocus.handleFocus();break;case"funky_vignette":BFN.ImageVignette.handleVignette();break;case"color_picker_panel":BFN.ColorPickerPanel.handleIntensitySliderUpdate();break;case"watermark":BFN.WatermarkManager.handleWatermark();break;case"batch_processing":BFN.BatchProcessingManager.handleBatchProcessing();break;case"batch_resize":BFN.BatchProcessingManager.handleBatchResize();break;case"batch_crop":BFN.BatchProcessingManager.handleBatchCrop();break;case"batch_effect":BFN.BatchProcessingManager.handleBatchEffect();break;case"collage_customize":BFN.CustomizeManager.handleCustomize();break;case"collage_layouts_custom":BFN.CollageMakerCanvasModel.handleCollageLayoutsCustom();break;case"collage_layouts":BFN.CollageMakerTemplateManager.handleTemplateCategory();break;case"collage_patterns":BFN.CollageMakerPatternManager.handlePatternCategory();break;case"collage_image":BFN.CollageMakerCanvas.handleCollageImage();break;default:BFN.PhotoEditorCanvasModel.handleUpdateTool(t),BFN.ImageTouchUp.handleUpdateTool(t),BFN.ImageEffect.handleUpdateTool(t),BFN.ImageArtsy.handleUpdateTool(t),BFN.ImageFrame.handleUpdateTool(t),BFN.ImageTexture.handleUpdateTool(t),BFN.ImageOverlay.handleUpdateTool(t),BFN.ImageLensFlare.handleUpdateTool(t)}}};BFN.SingletonQueue.add(()=>{BFN.AppManager=new Wb});BFN.ImagePainterUndoManagerEvents={IMAGE_PAINTER_UPDATED:new Event("IMAGE_PAINTER_UPDATED"),PAINT_UPDATED:new Event("PAINT_UPDATED"),ALT_TEXTURE_UPDATED:new Event("ALT_TEXTURE_UPDATED")};var $b=class extends BFN.EventDispatcher{constructor(){super();this.init()}init(){BeFunky.log("ImagePainterUndoManager Init"),this.initDefaultValues()}initDefaultValues(){this.baseMemoryUnitMB=BFN.Util.bytesToMB(Math.pow(BFN.maxImageSize,2)),this.minMemoryMultiplier={desktop:2,mobile:1},this.maxMemoryMultiplier={desktop:4,mobile:2},this.minMemoryMB=this.baseMemoryUnitMB*this.minMemoryMultiplier[BeFunky.isMobile?"mobile":"desktop"],this.maxMemoryMB=this.baseMemoryUnitMB*this.maxMemoryMultiplier[BeFunky.isMobile?"mobile":"desktop"],this.maxStoredPixels=Math.round(this.maxMemoryMB*(Math.pow(1024,2)/4)),this.originPoint=new PIXI.Point,this.imagePainter=null,this.regionVOs=[],this.regionIndex=-1,this.direction="redo",this.memoryFreed=!1,this.regionSprite=new PIXI.Sprite,this.handlePaintUpdatedBind=this.handlePaintUpdated.bind(this)}setImagePainter(e){this.reset(!1),this.imagePainter=e,this.imagePainter&&(this.imagePainter.addEventListener(BFN.ImagePainterEvents.PAINT_UPDATED.type,this.handlePaintUpdatedBind),this.dispatchEvent(BFN.ImagePainterUndoManagerEvents.IMAGE_PAINTER_UPDATED)),BFN.GlobalHistoryModel.updateGlobalHistoryButtons(),this.updateAvailableMemory()}updateAvailableMemory(){let e=BFN.textureHistoryMemoryLimitMB,t=BFN.AppModel.getAppTextureMemoryMB(),r=e-t,a=Math.max(this.minMemoryMB,Math.min(this.maxMemoryMB,r));this.maxStoredPixels=Math.round(a*(Math.pow(1024,2)/4))}reset(e=!0){this.imagePainter&&(this.imagePainter.removeEventListener(BFN.ImagePainterEvents.PAINT_UPDATED.type,this.handlePaintUpdatedBind),this.imagePainter=null,this.clearRegionVOs(),this.direction="redo",e&&this.dispatchEvent(BFN.ImagePainterUndoManagerEvents.IMAGE_PAINTER_UPDATED)),this.memoryFreed=!1,BFN.GlobalHistoryModel.updateGlobalHistoryButtons()}addRegionVO(){let e=null;if(this.imagePainter&&this.imagePainter.texture&&this.imagePainter.paintBounds.width&&this.imagePainter.paintBounds.height){if(this.redoExists)switch(this.direction){case"undo":this.clearRegionVOs(this.regionIndex);break;case"redo":this.clearRegionVOs(this.regionIndex+1);break}let r=this.imagePainter.paintBounds.width*this.imagePainter.paintBounds.height,a=Math.max(this.imagePainter.minHistoryResolution,Math.pow(.5,Math.min(2,Math.floor(r/Math.pow(1024,2))))),s=this.regionVOs.length?this.regionVOs[this.regionVOs.length-1]:null;e=new BFN.ImagePainterRegionVO,e.originPoint.x=this.imagePainter.paintBounds.left,e.originPoint.y=this.imagePainter.paintBounds.top,e.undoRegionTexture=PIXI.RenderTexture.create(this.imagePainter.paintBounds.width,this.imagePainter.paintBounds.height,void 0,a),e.undoRegionTexture.copyPixels(this.imagePainter.prevTexture,{x:-e.originPoint.x,y:-e.originPoint.y}),e.undoRegionTexture.subjectIsolated=s?!!s.redoRegionTexture.subjectIsolated:!1,e.redoRegionTexture=PIXI.RenderTexture.create(this.imagePainter.paintBounds.width,this.imagePainter.paintBounds.height,void 0,a),e.redoRegionTexture.subjectIsolated=this.currentImagePainter.subjectIsolated;try{this.imagePainter.altTexture.width,e.redoRegionTexture.copyPixels(this.imagePainter.altTexture,{x:-e.originPoint.x,y:-e.originPoint.y})}catch(o){e.redoRegionTexture.copyPixels(this.imagePainter.texture,{x:-e.originPoint.x,y:-e.originPoint.y})}e.totalPixels=Math.round(this.imagePainter.paintBounds.width*this.imagePainter.paintBounds.height*2*a),this.regionVOs.push(e),this.regionIndex=this.regionVOs.length-1,this.direction="redo",this.dispatchEvent(BFN.ImagePainterUndoManagerEvents.PAINT_UPDATED),this.logPosition()}let t=this.freeMemory();if(e){let r=`${this.imagePainter.paintBounds.width}x${this.imagePainter.paintBounds.height}px [Count:${this.regionVOs.length}, Memory:${t}%]`;BFN.SentryManager.reportBreadcrumb(r,"paint_applied","paint_history")}BFN.GlobalHistoryModel.updateGlobalHistoryButtons()}clearRegionVOs(e){if(e==null&&(e=0),e>=0&&e<this.regionVOs.length){for(let t=e;t<this.regionVOs.length;t++){let r=this.regionVOs[t];r.undoRegionTexture&&r.undoRegionTexture.destroyGC(!0),r.redoRegionTexture&&r.redoRegionTexture.destroyGC(!0),r.undoRegionTexture=null,r.redoRegionTexture=null}this.regionVOs.splice(e),this.regionIndex=this.regionVOs.length-1}}freeMemory(){let e=0,t;for(let a=0;a<this.regionVOs.length;a++)t=this.regionVOs[a],e+=t.totalPixels;for(BeFunky.log("~~~"),BeFunky.log("FREE MEMORY:");e>this.maxStoredPixels&&this.regionVOs.length;)t=this.regionVOs[0],t.undoRegionTexture&&t.undoRegionTexture.destroyGC(!0),t.redoRegionTexture&&t.redoRegionTexture.destroyGC(!0),t.undoRegionTexture=null,t.redoRegionTexture=null,BeFunky.log("Removing",t.totalPixels,"Pixels"),e-=t.totalPixels,this.regionIndex=Math.max(0,this.regionIndex-1),this.regionVOs.splice(0,1),this.memoryFreed=!0;let r=Math.round(e/this.maxStoredPixels*1e5)/1e3;return BeFunky.log("Using:",r,"%"),r}undo(){if(this.imagePainter&&this.imagePainter.texture&&this.undoExists){this.imagePainter.preUndoCallback&&this.imagePainter.preUndoCallback(),this.direction==="undo"?this.regionIndex--:this.direction="undo";let e=this.regionVOs[this.regionIndex];switch(this.regionSprite.x=e.originPoint.x,this.regionSprite.y=e.originPoint.y,this.direction){case"undo":this.regionSprite.texture=e.undoRegionTexture;break;case"redo":this.regionSprite.texture=e.redoRegionTexture;break}try{this.imagePainter.altTexture.width,this.imagePainter.altTexture.clearRect(this.regionSprite.x,this.regionSprite.y,this.regionSprite.texture.width,this.regionSprite.texture.height),BFN.Stage.render(this.regionSprite,this.imagePainter.altTexture,!1),this.dispatchEvent(BFN.ImagePainterUndoManagerEvents.ALT_TEXTURE_UPDATED)}catch(t){this.imagePainter.texture.clearRect(this.regionSprite.x,this.regionSprite.y,this.regionSprite.texture.width,this.regionSprite.texture.height),BFN.Stage.render(this.regionSprite,this.imagePainter.texture,!1),this.dispatchEvent(BFN.ImagePainterUndoManagerEvents.ALT_TEXTURE_UPDATED)}this.regionSprite.texture=null,this.imagePainter.updateComplete(),BFN.MainUI.requestRender(),this.logPosition(),BFN.GlobalHistoryModel.updateGlobalHistoryButtons()}this.imagePainter&&this.imagePainter.texture&&!this.undoExists&&(this.imagePainter.paintApplied=!1)}redo(){if(this.imagePainter&&this.imagePainter.texture&&this.redoExists){this.imagePainter.preRedoCallback&&this.imagePainter.preRedoCallback(),this.direction==="redo"?this.regionIndex++:this.direction="redo";let e=this.regionVOs[this.regionIndex];switch(this.regionSprite.x=e.originPoint.x,this.regionSprite.y=e.originPoint.y,this.direction){case"undo":this.regionSprite.texture=e.undoRegionTexture;break;case"redo":this.regionSprite.texture=e.redoRegionTexture;break}try{this.imagePainter.altTexture.width,this.imagePainter.altTexture.clearRect(this.regionSprite.x,this.regionSprite.y,this.regionSprite.texture.width,this.regionSprite.texture.height),BFN.Stage.render(this.regionSprite,this.imagePainter.altTexture,!1),this.dispatchEvent(BFN.ImagePainterUndoManagerEvents.ALT_TEXTURE_UPDATED)}catch(t){this.imagePainter.texture.clearRect(this.regionSprite.x,this.regionSprite.y,this.regionSprite.texture.width,this.regionSprite.texture.height),BFN.Stage.render(this.regionSprite,this.imagePainter.texture,!1),this.dispatchEvent(BFN.ImagePainterUndoManagerEvents.ALT_TEXTURE_UPDATED)}this.regionSprite.texture=null,this.imagePainter.updateComplete(),BFN.MainUI.requestRender(),this.logPosition(),BFN.GlobalHistoryModel.updateGlobalHistoryButtons()}this.imagePainter&&this.imagePainter.texture&&(this.imagePainter.paintApplied=!0)}logPosition(){BeFunky.log("TRACE");let e="";for(let t=0;t<this.regionVOs.length;t++){let r=this.regionVOs[t];e+="[",e+=this.regionIndex==t?this.direction==="undo"?"<":">":" ",e+="]"}e+=` ${this.regionIndex}`,BeFunky.log(e)}handlePaintUpdated(e){this.addRegionVO()}get undoExists(){return this.direction==="undo"&&this.regionIndex>0||this.direction==="redo"&&this.regionIndex>=0}get redoExists(){return this.direction==="redo"&&this.regionIndex<this.regionVOs.length-1||this.direction==="undo"&&this.regionIndex<=this.regionVOs.length-1}get imagePainterOpen(){return!!this.imagePainter}get currentImagePainter(){return this.imagePainter}};BFN.SingletonQueue.add(()=>{BFN.ImagePainterUndoManager=new $b});BFN.UndoManagerEvents={TIMESTAMP_UPDATED:new Event("TIMESTAMP_UPDATED")};var jb=class extends BFN.EventDispatcher{constructor(){super();this.init()}init(){BeFunky.log("UndoManager Init"),this.initDefaultValues()}initDefaultValues(){this.batchHistoryActions=["layers_flattened","crop","rotate","resize","cutout","convert_to_image","resize_item_layer"],this.updating=!1,this.collageSnapshotRequired=!1}handleEditorHistoryAction(){let e=UITools.getToolVO("editor_history_action");if(!BFN.GlobalHistoryModel.historyUpdateQueued)switch(e.updating_id){case"undo":this.undo();break;case"redo":this.redo();break;case"reset":this.reset();break}}undo(){if(BFN.ZoomRegion.hide(),this.updating=!0,!this.alternateHistoryAction("undo")){let e=BFN.TransformStateModel.getTimestamp(),t=BFN.TransformStateModel.getLastTimestamp(),r=BFN.PhotoEditorHistoryModel.getTimestamp(),a=BFN.PhotoEditorHistoryModel.getLastTimestamp(),s=BFN.CollageMakerHistoryModel.getTimestamp(),o=BFN.CollageMakerHistoryModel.getLastTimestamp(),n=BFN.PhotoEditorHistoryModel.currentHistoryAction==="layers_flattened",l=this.batchHistoryActions.includes(BFN.PhotoEditorHistoryModel.currentHistoryAction),c=BFN.TransformStateModel.undoIsBatch&&(n&&BFN.TransformStateModel.undoIsBatch==="removeall"||!n&&BFN.TransformStateModel.undoIsBatch.includes("offset_items"));BFN.AppModel.viewingEditor&&l&&c?(BFN.PhotoEditorHistoryModel.undo(),BFN.TransformStateModel.undo()):BFN.AppModel.viewingEditor&&!isNaN(r)&&(isNaN(t)||isNaN(e)||t<r)?BFN.PhotoEditorHistoryModel.undo():BFN.AppModel.viewingCollage?(BFN.CollageMakerCanvasPhotoGridModel.collageSettings=null,!BFN.CollageMakerCanvasPhotoGridModel.freeform&&!isNaN(o)&&(isNaN(t)||!isNaN(t)&&t<s)?(BFN.CollageMakerHistoryModel.undo(!1),this.collageSnapshotRequired=!0,BFN.TransformStateModel.undoIsAlternate&&t>o&&BFN.TransformStateModel.applyAlternate(t,!1,BFN.CollageMakerHistoryModel.getLastTimestamp())&&(BFN.TransformStateModel.direction="redo")):BFN.TransformStateModel.undo(),BFN.CollageMakerHistoryModel.ignoreSnapshotApply||this.updateCollage()):(BFN.TransformStateModel.undo(),this.updateDesigner())}this.dispatchEvent(BFN.UndoManagerEvents.TIMESTAMP_UPDATED),this.updating=!1}redo(){if(BFN.ZoomRegion.hide(),this.updating=!0,!this.alternateHistoryAction("redo")){let e=BFN.TransformStateModel.getTimestamp(),t=BFN.TransformStateModel.getNextTimestamp(),r=BFN.PhotoEditorHistoryModel.getTimestamp(),a=BFN.PhotoEditorHistoryModel.getNextTimestamp(),s=BFN.CollageMakerHistoryModel.getTimestamp(),o=BFN.CollageMakerHistoryModel.getNextTimestamp(),n=BFN.PhotoEditorHistoryModel.nextHistoryAction==="layers_flattened",l=this.batchHistoryActions.includes(BFN.PhotoEditorHistoryModel.nextHistoryAction),c=BFN.TransformStateModel.redoIsBatch&&(n&&BFN.TransformStateModel.redoIsBatch=="removeall"||!n&&BFN.TransformStateModel.redoIsBatch.includes("offset_items"));BFN.AppModel.viewingEditor&&l&&c?(BFN.PhotoEditorHistoryModel.redo(),BFN.TransformStateModel.redo()):BFN.AppModel.viewingEditor&&!isNaN(a)&&(isNaN(t)||isNaN(e)||a<t)?BFN.PhotoEditorHistoryModel.redo():BFN.AppModel.viewingCollage?(BFN.CollageMakerCanvasPhotoGridModel.collageSettings=null,!BFN.CollageMakerCanvasPhotoGridModel.freeform&&!isNaN(o)&&(isNaN(t)||!isNaN(t)&&o<t)?(BFN.CollageMakerHistoryModel.redo(!1),this.collageSnapshotRequired=!0):BFN.TransformStateModel.redo(),BFN.CollageMakerHistoryModel.ignoreSnapshotApply||this.updateCollage()):(BFN.TransformStateModel.redo(),this.updateDesigner())}this.dispatchEvent(BFN.UndoManagerEvents.TIMESTAMP_UPDATED),this.updating=!1}gotoTimestamp(e){if(BFN.AppModel.viewingCollage&&BFN.alternateMenu.isOpen&&(BFN.alternateMenu.menuIds.includes("collage_image_menu")||BFN.alternateMenu.menuIds.includes("collage_pattern_menu"))&&BFN.PhotoGrid.gridIsolator.gridChild){BFN.PhotoGrid.gridIsolator.revertChanges(),BFN.PhotoGrid.isolateGridChild(null);return}for(this.collageSnapshotRequired=!1,BFN.CollageMakerHistoryModel.ignoreSnapshotApply=!0;;)if(e==0)if(!isNaN(BFN.TransformStateModel.getLastTimestamp())&&!(BFN.TransformStateModel.getLastTimestamp()==0&&BFN.TransformStateModel.direction=="undo"))this.undo();else{BeFunky.log("done");break}else{let t=this.getTimestamp();if(!isNaN(t)||t!=e)if(t>e)this.undo(),BeFunky.log("undo ~");else if(t<e)this.redo(),BeFunky.log("redo ~");else{if(BFN.TransformStateModel.direction=="undo"&&BFN.TransformStateModel.getTimestamp()==t||isNaN(t)){this.redo();continue}BeFunky.log("break");break}else{BeFunky.log("breakNaN",t!=e);break}}BFN.CollageMakerHistoryModel.ignoreSnapshotApply=!1,this.updateCollage(),this.updateDesigner(),this.dispatchEvent(BFN.UndoManagerEvents.TIMESTAMP_UPDATED)}alternateHistoryAction(e){if(BFN.ImageCutout.alternateHistoryAction())return!0;if(BFN.ImagePainterUndoManager.imagePainterOpen)switch(e){case"undo":if(BFN.ImagePainterUndoManager.undoExists)return BFN.ImagePainterUndoManager.undo(),!0;break;case"redo":if(BFN.ImagePainterUndoManager.redoExists)return BFN.ImagePainterUndoManager.redo(),!0;if(BFN.ImagePainterUndoManager.undoExists)return!0;break}if((BFN.AppModel.viewingEditor||BFN.TransformItemIsolator.active)&&BFN.PhotoEditorCanvasModel.viewState!==BFN.PhotoEditorCanvasModelViewStates.VIEWING_CANVAS)return BFN.PhotoEditorCanvasModel.exitCurrentEditorTool(),!0;if(BFN.AppModel.viewingEditor&&e==="undo"){let t=isNaN(BFN.PhotoEditorHistoryModel.getLastTimestamp()),r=isNaN(BFN.TransformStateModel.getLastTimestamp())||BFN.TransformStateModel.getLastTimestamp()==0&&BFN.TransformStateModel.direction=="undo";if(!!(t&&r)&&BFN.PhotoEditorHistoryModel.memoryFreed)return BeFunky.confirm("confirm_apply_source_texture",{onConfirm:()=>{BFN.PhotoEditorModel.applySourceTexture()}}),!0}if(BFN.AppModel.viewingCollage&&BFN.alternateMenu.isOpen&&(BFN.alternateMenu.menuIds.includes("collage_image_menu")||BFN.alternateMenu.menuIds.includes("collage_pattern_menu")))return BFN.PhotoGrid.gridIsolator.gridChild?(BFN.PhotoGrid.gridIsolator.revertChanges(),BFN.PhotoGrid.isolateGridChild(null)):BFN.CollageMakerHistoryModel.applySnapshot(),!0;if(BFN.TransformItemIsolator.animating)return!0;if(BFN.TransformItemIsolator.active){let t=(B=null)=>(B&&console.log(B),BFN.TransformItemIsolator.releaseTransformItem(),!0),r=e==="undo",a=!r;if(r&&!this.undoExists)return t();if(a&&!this.redoExists)return!0;if(r&&BFN.TransformStateModel.undoIsBatch||a&&BFN.TransformStateModel.redoIsBatch)return t();BFN.GlobalHistoryModel.updateSelectedHistoryID();let s=BFN.GlobalHistoryModel.globalHistoryVOHash[BFN.GlobalHistoryModel.selectedHistoryID[BFN.AppModel.viewState]],n=BFN.GlobalHistoryModel.globalHistoryVOs.indexOf(s)+(a?1:0);if(r&&n<0)return t();if(a&&n>=BFN.GlobalHistoryModel.globalHistoryVOs.length)return!0;let l=BFN.GlobalHistoryModel.globalHistoryVOs[n].timestamp,c=r?BFN.TransformStateModel.getLastTimestamp():BFN.TransformStateModel.getNextTimestamp(),h=[void 0,null,NaN];if(r&&(h.includes(l)||h.includes(c)||c===0))return t();if(a&&(h.includes(l)||h.includes(c)))return!0;if(l!==c)return t();let u=BFN.TransformStateModel.getTransitions(),d=BFN.TransformStateModel.getTransitionIndex(),m=u[d],p=m;r&&BFN.TransformStateModel.direction==="undo"?p=u[d-1]:a&&BFN.TransformStateModel.direction==="redo"&&(p=u[d+1]);let g=BFN.TransformItemIsolator.isolatedTransformItem;if(p.transformItem!==g||["edit_image","replace_image"].includes(p.id))return t();let v=r?BFN.TransformStateModel.direction==="redo"?m.startState:p.startState:BFN.TransformStateModel.direction==="undo"?m.endState:p.endState,T=g.itemContent.texture?g.itemContent.texture.baseTexture:null,x=v.imageTexture?v.imageTexture.baseTexture:null;if(!T||!x||!x.backgroundSpritePosition||T===x)return t()}return!1}updateCollage(){BFN.AppModel.viewingCollage&&(this.collageSnapshotRequired&&(this.collageSnapshotRequired=!1,BFN.CollageMakerHistoryModel.applySnapshot()),BFN.CollageMakerCanvasPhotoGridModel.collageSettings&&(BFN.CollageMakerCanvasPhotoGridModel.dispatchEvent(BFN.CollageMakerCanvasPhotoGridModelEvents.COLLAGE_SETTINGS_UPDATED),BFN.CollageMakerCanvasPhotoGridModel.collageSettings=null))}updateDesigner(){BFN.AppModel.viewingDesigner&&BFN.DesignerCanvasModel.designerSettings&&(BFN.DesignerCanvasModel.dispatchEvent(BFN.DesignerCanvasModelEvents.DESIGNER_SETTINGS_UPDATED),BFN.DesignerCanvasModel.designerSettings=null)}reset(){if(BFN.ImageCutout.alternateHistoryAction())return;BeFunky.confirm("confirm_reset",{onConfirm:e,confirmText:"yes",cancelText:"no"});function e(){BFN.TransformGuides.setTransformGuideData(),BFN.TransformGuides.saveGuides(!1),BFN.UnsavedOpenProjectManager.setSaved(BFN.AppModel.sectionID,!0,"reset");let t=BFN.AppModel.viewState;if(BFN.TextureHistoryManager.clearTextureHistory(t),BFN.AppModel.viewingEditor){delete BFN.ProjectManager.savedCanvasThumbs.editor,UIToggler.cancelActiveEditorTool(),UIToggler.toggleMainMenu(!1),UIToggler.toggleZoomMenu(!1),BFN.ImageEditManager.resetEditor(),BFN.ProjectService.clearLocalAssets("editor"),BFN.ProjectService.removeLocalProject("editor"),BFN.ProjectManager.autoSave.editor.cancelLazySave(),BFN.GroupManager.clearGroups("editor"),BFN.PhotoEditorModel.updateProjectVO(!0,!1);return}if(BFN.AppModel.viewingCollage){delete BFN.ProjectManager.savedCanvasThumbs.collage,BFN.CollageMakerCanvasModel.dispatchEvent(BFN.CollageMakerCanvasModelEvents.CLEAR_ITEMS),BFN.CollageMakerCanvasPhotoGridModel.dispatchEvent(BFN.CollageMakerCanvasPhotoGridModelEvents.CLEAR_ALL),BFN.ProjectService.clearLocalAssets("collage"),BFN.GroupManager.clearGroups("collage"),BFN.CollageMakerModel.projectVO._wasReset=!0;return}BFN.AppModel.viewingDesigner&&(delete BFN.ProjectManager.savedCanvasThumbs.designer,BFN.GroupManager.clearGroups("designer"),BFN.DesignerModel.loadBlankProject())}}getTimestamp(){let e=BFN.TransformStateModel.direction=="redo"?BFN.TransformStateModel.getTimestamp():BFN.TransformStateModel.getLastTimestamp();if(BFN.AppModel.viewingEditor)if(!isNaN(e)&&!BFN.TransformStateModel.undoIsBatch){let t=BFN.PhotoEditorHistoryModel.getTimestamp();isNaN(t)||(e=Math.max(e,t))}else e=BFN.PhotoEditorHistoryModel.getTimestamp();else if(BFN.AppModel.viewingCollage&&!BFN.CollageMakerCanvasPhotoGridModel.freeform)if(!isNaN(e)&&!BFN.TransformStateModel.undoIsBatch){let t=BFN.CollageMakerHistoryModel.getTimestamp();isNaN(t)||(e=Math.max(e,t))}else e=BFN.CollageMakerHistoryModel.getTimestamp();else BFN.AppModel.viewingDesigner&&isNaN(e)&&(e=0);return e}get undoExists(){if(BFN.ImagePainterUndoManager.imagePainterOpen||BFN.TransformItemIsolator.active)return!0;if(BFN.AppModel.viewingEditor){let e=isNaN(BFN.PhotoEditorHistoryModel.getLastTimestamp()),t=isNaN(BFN.TransformStateModel.getLastTimestamp())||BFN.TransformStateModel.getLastTimestamp()==0&&BFN.TransformStateModel.direction=="undo";return!(e&&t)||BFN.PhotoEditorHistoryModel.memoryFreed}if(BFN.AppModel.viewingCollage){let e=isNaN(BFN.CollageMakerHistoryModel.getLastTimestamp()),t=isNaN(BFN.TransformStateModel.getLastTimestamp())||BFN.TransformStateModel.getLastTimestamp()==0&&BFN.TransformStateModel.direction=="undo";return!(e&&t)}return!isNaN(BFN.TransformStateModel.getLastTimestamp())&&!(BFN.TransformStateModel.getLastTimestamp()==0&&BFN.TransformStateModel.direction=="undo")}get redoExists(){return BFN.ImagePainterUndoManager.imagePainterOpen?BFN.ImagePainterUndoManager.redoExists:BFN.AppModel.viewingEditor?!(isNaN(BFN.TransformStateModel.getNextTimestamp())&&isNaN(BFN.PhotoEditorHistoryModel.getNextTimestamp())):BFN.AppModel.viewingCollage?!(isNaN(BFN.TransformStateModel.getNextTimestamp())&&isNaN(BFN.CollageMakerHistoryModel.getNextTimestamp())):!isNaN(BFN.TransformStateModel.getNextTimestamp())}get isBatchHistoryAction(){return this.batchHistoryActions.includes(BFN.PhotoEditorHistoryModel.currentHistoryAction)}};BFN.SingletonQueue.add(()=>{BFN.UndoManager=new jb});BFN.EffectManagerEvents={EFFECT_UPDATED:new Event("EFFECT_UPDATED"),EFFECT_COMPLETE:new Event("EFFECT_COMPLETE")};var Yb=class extends BFN.EventDispatcher{constructor(){super();this.init()}init(){BeFunky.log("EffectManager Init"),this.changingImageMaxSize=1e3,this.resolution=1,this.changingResolution=1,this.somethingChanged=!1,this.intervalRunning=!1,this.selectedEffectID=null,this.effectChanging=!1,this.sourceTexture=null,this.renderTexture=null,this.sourceSprite=new PIXI.Sprite,this.currentEffect=null,this.currentComponent=null,this.autoProcess=!0,this.useThumbs=!1,this.manageLoadScreen=!0,this.associatedPresetMenuItemId="",this.handleUserEffectCancelBind=this.handleUserEffectCancel.bind(this),this.transparentBackgroundFixer=new BFN.filters.TransparentBackgroundFixFilter,this.effectTexture=null,this.effectSprite=new PIXI.Sprite,this.effectSprite.filters=[this.transparentBackgroundFixer]}setSourceTexture(e){this.sourceTexture=e,this.sourceSprite.texture=this.sourceTexture,this.sourceTexture&&(this.transparentBackgroundFixer.iChannel1=this.sourceTexture);let t=Math.min(1,this.changingImageMaxSize/this.sourceTexture.width,this.changingImageMaxSize/this.sourceTexture.height);this.changingResolution=1,t<1&&(this.changingResolution=.5,t<.5&&(this.changingResolution=.25,t<.25&&(this.changingResolution=.125,t<.125&&(this.changingResolution=.0625)))),BeFunky.log("CHANGING RESOLUTION:",this.changingResolution,", ACTUAL:",t)}setRenderTexture(e){this.renderTexture=e,this.autoProcess&&this.processEffect()}setupEffect(){if(this.currentEffect){this.currentEffect.disposeEffect(),this.currentEffect=null;try{BFN.FilterHelper.emptyPoolForFilter()}catch(e){BeFunky.log("ERR FILTER MANAGER DESTROY: ",e)}}this.sourceTexture&&this.selectedEffectID&&BFN.effectMap.hasOwnProperty(this.selectedEffectID)&&BFN.effects.hasOwnProperty(BFN.effectMap[this.selectedEffectID])&&(this.currentEffect=BFN.effects[BFN.effectMap[this.selectedEffectID]],this.currentEffect.setupEffect(this.sourceTexture)),this.dispatchEvent(BFN.EffectManagerEvents.EFFECT_UPDATED),this.effectParameters=null,this.autoProcess&&this.processEffect()}processEffectTimeout(){if(this.hasOwnProperty("intervalEndTime")&&performance.now()<this.intervalEndTime){requestAnimationFrame(this.processEffectTimeout.bind(this));return}if(this.effectChanging){this.somethingChanged&&(this.somethingChanged=!1,this.processEffect()),this.intervalRunning=!0,this.intervalEndTime=performance.now()+BFN.frameInterval,requestAnimationFrame(this.processEffectTimeout.bind(this));return}this.intervalRunning=!1,delete this.intervalEndTime}processEffect(){this.somethingChanged=!1;let e=null;this.currentEffect&&this.currentEffect.isSetup?(this.resolution=this.effectChanging?this.changingResolution:1,this.effectParameters||this.effectID&&UITools.getToolVO(this.effectID)&&(this.effectParameters=UITools.getToolVO(this.effectID)),this.effectParameters&&this.currentEffect.applyEffect(this.resolution,this.effectParameters,this.useThumbs),e=this.currentEffect):e=this.sourceSprite;let t=this.useThumbs;this.currentEffect&&this.effectParameters&&this.effectParameters.hasOwnProperty("imageURL")?this.currentEffect.effectTexture&&(t=!0):t=!0,t?(this.sourceTexture&&this.renderTexture&&(this.sourceTexture.width!==this.renderTexture.width||this.sourceTexture.height!==this.renderTexture.height)&&this.renderTexture.resize(this.sourceTexture.width,this.sourceTexture.height),this.effectParameters&&this.effectParameters.fixTransparency?(this.effectTexture||(this.effectTexture=PIXI.RenderTexture.create(16,16),this.effectSprite.texture=this.effectTexture),this.renderTexture&&(this.effectTexture.width!==this.renderTexture.width||this.effectTexture.height!==this.renderTexture.height)&&this.effectTexture.resize(this.renderTexture.width,this.renderTexture.height),BFN.Stage.render(e,this.effectTexture),BFN.Stage.render(this.effectSprite,this.renderTexture)):BFN.Stage.render(e,this.renderTexture),this.dispatchEvent(BFN.EffectManagerEvents.EFFECT_COMPLETE),!this.useThumbs&&this.manageLoadScreen&&(this.associatedPresetMenuItemId?(BFN.tertiaryMenu.loadingPresetIds=BFN.tertiaryMenu.loadingPresetIds.filter(r=>r!==this.associatedPresetMenuItemId),this.associatedPresetMenuItemId=""):BeFunky.hideLoadScreen(),BeFunky.isLoadScreenActive()&&(BeFunky.reportWarning("Load screen still visible after effect complete"),BeFunky.hideLoadScreen()))):!this.useThumbs&&this.manageLoadScreen&&(this.associatedPresetMenuItemId&&(BeFunky.reportWarning("associatedPresetMenuItemId not cleaned up",this.associatedPresetMenuItemId),BFN.tertiaryMenu.loadingPresetIds=BFN.tertiaryMenu.loadingPresetIds.filter(r=>r!==this.associatedPresetMenuItemId),this.associatedPresetMenuItemId=""),BFN.tertiaryMenu.activePresetId?(this.associatedPresetMenuItemId=BFN.tertiaryMenu.activePresetId,BFN.tertiaryMenu.loadingPresetIds=[...BFN.tertiaryMenu.loadingPresetIds,this.associatedPresetMenuItemId]):BeFunky.showLoadScreen({onCancel:this.handleUserEffectCancelBind}))}reset(){if(this.resolution=1,this.changingResolution=1,this.effectParameters=null,this.somethingChanged=!1,this.intervalRunning=!1,this.selectedEffectID=null,this.effectChanging=!1,this.sourceTexture=null,this.renderTexture=null,this.sourceSprite.texture=PIXI.Texture.EMPTY,this.effectTexture&&this.effectTexture.resize(16,16),this.transparentBackgroundFixer.iChannel1=PIXI.Texture.EMPTY,this.currentEffect){this.currentEffect.disposeEffect(),this.currentEffect=null;try{BFN.FilterHelper.emptyPoolForFilter()}catch(e){BeFunky.log("ERR FILTER MANAGER DESTROY: ",e)}}this.dispatchEvent(BFN.EffectManagerEvents.EFFECT_UPDATED)}handleUserEffectCancel(){document.getElementById("editor_apply_cancel_cancel").click()}set effectID(e){this.selectedEffectID=e,this.setupEffect()}get effectID(){return this.selectedEffectID}set parameters(e){this.effectParameters=e,this.effectParameters&&(this.somethingChanged=!0,this.intervalRunning||this.processEffectTimeout())}get parameters(){return this.effectParameters}set changing(e){this.effectChanging=e,BFN.StageModel.setRefreshFactor(this.effectChanging?.25:1)}get changing(){return this.effectChanging}};BFN.SingletonQueue.add(()=>{BFN.EffectManager=new Yb});BFN.ArtsyManagerEvents={ARTSY_UPDATED:new Event("ARTSY_UPDATED"),ARTSY_COMPLETE:new Event("ARTSY_COMPLETE")};var qb=class extends BFN.EventDispatcher{constructor(){super();this.init()}init(){BeFunky.log("ArtsyManager Init"),this.processing=!1,this.selectedArtsyID=null,this.artsyAmount=1,this.sourceTexture=null,this.renderTexture=null,this.sourceSprite=new PIXI.Sprite,this.transparentBackgroundFixer=new BFN.filters.TransparentBackgroundFixFilter,this.artsySprite=new PIXI.Sprite,this.artsySprite.filters=[this.transparentBackgroundFixer],BFN.ArtsyService.addEventListener(BFN.ArtsyServiceEvents.FAILED.type,this.handleArtsyServiceFailed.bind(this)),BFN.ArtsyService.addEventListener(BFN.ArtsyServiceEvents.COMPLETED.type,this.handleArtsyServiceCompleted.bind(this))}setSourceTexture(e){this.sourceTexture=e,this.sourceSprite.texture=this.sourceTexture,this.sourceTexture&&(this.transparentBackgroundFixer.iChannel1=this.sourceTexture)}setRenderTexture(e){this.renderTexture=e}setupArtsy(){}processArtsy(){this.sourceTexture&&!this.processing&&(BFN.ArtsyService.currentTexture!==this.sourceTexture&&(BFN.ArtsyService.reset(),BFN.ArtsyService.currentTexture=this.sourceTexture),this.processing=!0,BeFunky.showLoadScreen({onCancel:this.cancel.bind(this)}),BeFunky.log("PROCESS IMAGE"),BFN.ArtsyService.processImage())}cancel(){this.processing=!1,BFN.ArtsyService.cancel(),this.reset()}reset(){this.selectedArtsyID=null,this.sourceTexture=null,this.renderTexture=null,this.sourceSprite.texture=PIXI.Texture.EMPTY,this.transparentBackgroundFixer.iChannel1=PIXI.Texture.EMPTY,this.dispatchEvent(BFN.ArtsyManagerEvents.ARTSY_UPDATED)}handleArtsyServiceFailed(){this.processing=!1,BFN.Stage.render(this.sourceSprite,this.renderTexture),BFN.PhotoEditorCanvasModel.exitCurrentEditorTool(),BeFunky.hideLoadScreen(),this.dispatchEvent(BFN.ArtsyManagerEvents.ARTSY_COMPLETE)}handleArtsyServiceCompleted(e){if(this.renderTexture!=null||this.processing){this.processing=!1;let t=BFN.Util.resizeTexture(e.data,this.renderTexture.width,this.renderTexture.height);t&&(this.artsySprite.texture=t,BFN.Stage.render(this.artsySprite,this.renderTexture),this.artsySprite.texture=PIXI.Texture.EMPTY,t.destroyGC(!0)),BeFunky.hideLoadScreen(),this.dispatchEvent(BFN.ArtsyManagerEvents.ARTSY_COMPLETE)}}set artsyID(e){this.selectedArtsyID=e,this.setupArtsy()}get artsyID(){return this.selectedArtsyID}set parameters(e){this.artsyParameters=e,this.artsyParameters&&(BFN.ArtsyService.currentArtsyParams=this.artsyParameters,this.processArtsy())}get parameters(){return this.artsyParameters}};BFN.SingletonQueue.add(()=>{BFN.ArtsyManager=new qb});BFN.LensFlareManagerEvents={ASSETS_LOADED:new Event("ASSETS_LOADED"),THUMBS_LOADED:new Event("THUMBS_LOADED")};var Kb=class extends BFN.EventDispatcher{constructor(e){super(e);this.init()}init(){BeFunky.log("LensFlareManager Init"),this.initDefaultValues()}initDefaultValues(){this.assetLoader=new BFN.GraphicLoader,this.assetLoader.addEventListener(BFN.GraphicLoaderEvents.LOADING_COMPLETE.type,this.handleAssetLoaderLoadingComplete.bind(this)),this.thumbLoader=new BFN.GraphicLoader,this.thumbLoader.addEventListener(BFN.GraphicLoaderEvents.LOADING_COMPLETE.type,this.handleThumbLoaderLoadingComplete.bind(this))}loadAssets(e){let t=!1;if(this.assetLoader.reset(),e)for(let r=0;r<e.length;r++){let a=e[r];if(BFN.LensFlareData.assets.hasOwnProperty(a)){let s=BFN.LensFlareData.assets[a];!s.imageTexture&&s.imageURL&&(t=!0,this.assetLoader.graphicsData[a]=s.imageURL)}}t?(BeFunky.showLoadScreen(),this.assetLoader.loadGraphics()):this.dispatchEvent(BFN.LensFlareManagerEvents.ASSETS_LOADED)}loadAssetThumbs(e){let t=!1;if(this.thumbLoader.reset(),e)for(let r=0;r<e.length;r++){let a=e[r];if(BFN.LensFlareData.assets.hasOwnProperty(a)){let s=BFN.LensFlareData.assets[a];!s.thumbTexture&&s.thumbURL&&(t=!0,this.thumbLoader.graphicsData[a]=s.thumbURL)}}t?this.thumbLoader.loadGraphics():this.dispatchEvent(BFN.LensFlareManagerEvents.THUMBS_LOADED)}handleAssetLoaderLoadingComplete(e){for(let t in this.assetLoader.graphics){let r=this.assetLoader.graphics[t];if(BFN.LensFlareData.assets.hasOwnProperty(t)){let a=BFN.LensFlareData.assets[t];!a.imageTexture&&r!==this.assetLoader.missingTexture&&(a.imageTexture=r.renderClone())}}this.assetLoader.reset(),BeFunky.hideLoadScreen(),this.dispatchEvent(BFN.LensFlareManagerEvents.ASSETS_LOADED)}handleThumbLoaderLoadingComplete(e){for(let t in this.thumbLoader.graphics){let r=this.thumbLoader.graphics[t];if(BFN.LensFlareData.assets.hasOwnProperty(t)){let a=BFN.LensFlareData.assets[t];!a.thumbTexture&&r!==this.thumbLoader.missingTexture&&(a.thumbTexture=r.renderClone())}}this.thumbLoader.reset(),this.dispatchEvent(BFN.LensFlareManagerEvents.THUMBS_LOADED)}};BFN.SingletonQueue.add(()=>{BFN.LensFlareManager=new Kb});BFN.PresetMenuItemThumbManagerEvents={PROCESSING_QUEUE_UPDATED:new Event("PROCESSING_QUEUE_UPDATED")};var Jb=class extends BFN.EventDispatcher{constructor(e){super(e);this.init()}init(){this.initDefaultValues()}initDefaultValues(){this.queuedPresetMenuItems=[],this.isProcessingQueue=!1,this.currentPresetMenuItem=null,this.thumbnailUrls={},this.sourceTexture=null,this.thumbSourceTexture=null,this.thumbRenderTexture=null,this.thumbGraphicLoader=new BFN.GraphicLoader,this.thumbTransformSprite=new PIXI.Sprite,this.lensFlareThumbTextures={},this.frameDisplay=new BFN.FrameDisplay;let e=BeFunky.isRetina()?2:1;this.frameThumbPadding=12*e,this.handleEffectCompletedBind=this.handleEffectCompleted.bind(this),this.handleThumbGraphicLoadedBind=this.handleThumbGraphicLoaded.bind(this),this.handleLensFlareElementsAddedBind=this.handleLensFlareElementsAdded.bind(this),this.handleOverlayThumbsLoadedBind=this.handleOverlayThumbsLoaded.bind(this),this.handleFrameDisplayFrameLoadedBind=this.handleFrameDisplayFrameLoaded.bind(this),BFN.PhotoEditorMenuModel.addEventListener(BFN.PhotoEditorMenuModelEvents.CURRENT_IMAGE_THUMB_UPDATED.type,this.handleCurrentImageThumbUpdated.bind(this))}processItems(e){!(this.thumbSourceTexture&&this.thumbSourceTexture.baseTexture)||!this.thumbRenderTexture||(this.queuedPresetMenuItems.splice(0),this.queuedPresetMenuItems.push(...e),!this.isProcessingQueue&&this.queuedPresetMenuItems.length&&(this.isProcessingQueue=!0,setTimeout(()=>{this.processQueue()},0)))}processQueue(){if(this.queuedPresetMenuItems.length&&this.thumbSourceTexture&&this.thumbRenderTexture){if(this.currentPresetMenuItem=this.queuedPresetMenuItems.shift(),!this.currentPresetMenuItem)return;if(this.currentPresetMenuItem.thumbProcessed||!this.currentPresetMenuItem.useProcessedThumb)this.processQueue();else{let{presetId:e}=this.currentPresetMenuItem;switch(BFN.toolViewstates[e]){case BFN.PhotoEditorCanvasModelViewStates.VIEWING_EFFECT:if(BFN.effectPresetMap.hasOwnProperty(e)&&BFN.effectMap.hasOwnProperty(BFN.effectPresetMap[e])){let r=BFN.effectPresetMap[e];if(r){let a=UITools.getToolVO(e);BFN.EffectManager.reset(),BFN.EffectManager.autoProcess=!1,BFN.EffectManager.useThumbs=!0,BFN.EffectManager.setSourceTexture(a.useHiResThumb&&this.sourceTexture?this.sourceTexture:this.thumbSourceTexture),BFN.EffectManager.setRenderTexture(this.thumbRenderTexture),BFN.EffectManager.addEventListener(BFN.EffectManagerEvents.EFFECT_COMPLETE.type,this.handleEffectCompletedBind),BFN.EffectManager.effectID=r,BFN.EffectManager.effectParameters=a.defaultValues;let s=()=>{BFN.EffectManager.processEffect(),BFN.EffectManager.autoProcess=!0,BFN.EffectManager.useThumbs=!1};BFN.XMLGraphicLoader.loadEffectsThumbnailsJson().catch(o=>{BeFunky.logWarning("Red effect thumbnail shown to user",r,o)}).then(()=>{s()})}}break;case BFN.PhotoEditorCanvasModelViewStates.VIEWING_TEXTURE:{let{defaultValues:r}=UITools.getToolVO(e);BFN.XMLGraphicLoader.loadTexturesThumbnailsXml().catch(a=>{BeFunky.logWarning("Red texture thumbnail shown to user",e,a)}).then(()=>{this.blendTexture(BFN.XMLGraphicLoader.getGraphicByName(r.texture),r.blendMode,r.alpha),this.assignProcessedThumb()});break}case BFN.PhotoEditorCanvasModelViewStates.VIEWING_OVERLAY:{let{categoryID:r}=this.currentPresetMenuItem.presetObject;BFN.OverlaysThumbLoader.addEventListener(BFN.OverlaysThumbLoaderEvents.LOADED.type,this.handleOverlayThumbsLoadedBind),BFN.OverlaysThumbLoader.load(r);break}case BFN.PhotoEditorCanvasModelViewStates.VIEWING_FRAME:{let r=UITools.getToolVO(e),a=BFN.PhotoEditorMenuModel.presetItemThumbW-this.frameThumbPadding*2,s=`${BFN.remoteImagesURL}app/frames/${r.texture_category}/png/images/${r.texture}.png?width=${a}`;if(r.frame_type==="smart"){let n=UITools.getToolVO("frame_smart_generic");s=`smart:${r.texture_category}:${r.texture}:${n.defaultValues.scale/100}:${n.defaultValues.padding/100}}}`}this.frameDisplay.addEventListener(BFN.FrameDisplayEvents.FRAME_LOADED.type,this.handleFrameDisplayFrameLoadedBind);let o=1e3;this.frameDisplay.setupFrame(this.thumbSourceTexture,s,r.texture_data,a,o,a,o,!0,a);break}case BFN.PhotoEditorCanvasModelViewStates.VIEWING_LENS_FLARE:if(this.lensFlareThumbTextures.hasOwnProperty(e))this.handleLensFlareElementsAdded();else{let r=UITools.getToolVO(e),a=r.presetID;if(BFN.LensFlareData.presets.hasOwnProperty(a)){let s=this,o=function(){let{elementVOs:n}=BFN.LensFlareData.presets[a],l=[];for(let h=0;h<n.length;h++){let u=n[h];l.push(u.clone())}s.lensFlareDisplay.addEventListener(BFN.LensFlareDisplayEvents.ELEMENTS_ADDED.type,s.handleLensFlareElementsAddedBind),s.lensFlareDisplay.addElements(l);let c=null;for(let h=1;h<=5;h++)r.hasOwnProperty(`color_value_${h}`)&&(c||(c={}),c[h]=r[`color_value_${h}`]);c&&s.lensFlareDisplay.setGlobalColors(c)};if(typeof this.lensFlareDisplay!="undefined"&&typeof this.lensFlareDisplay.addEventListener!="undefined")o();else{let n=setInterval(()=>{if(typeof this.lensFlareDisplay!="undefined"&&typeof this.lensFlareDisplay.addEventListener!="undefined"){try{clearInterval(n)}catch(l){}n=null,o()}},10)}}else this.processQueue()}break;default:this.processQueue()}}}else BFN.EffectManager.reset(),this.isProcessingQueue=!1,this.dispatchEvent(BFN.PresetMenuItemThumbManagerEvents.PROCESSING_QUEUE_UPDATED)}blendTexture(e,t,r){this.thumbTransformSprite.texture=e,this.thumbTransformSprite.scale.x=this.thumbTransformSprite.scale.y=Math.max(this.thumbRenderTexture.width/e.width,this.thumbRenderTexture.height/e.height),this.thumbTransformSprite.x=(this.thumbRenderTexture.width-this.thumbTransformSprite.texture.width*this.thumbTransformSprite.scale.x)/2,this.thumbTransformSprite.y=(this.thumbRenderTexture.height-this.thumbTransformSprite.texture.height*this.thumbTransformSprite.scale.y)/2,BFN.Stage.render(this.thumbTransformSprite,this.thumbRenderTexture);try{e.destroyGC(!0),e=null}catch(a){}this.blendModeSprite.setBlendMode(t),this.blendModeSprite.setBlendIntensity(r),this.blendModeSprite.renderDisplay(),BFN.Stage.render(this.blendModeSprite,this.thumbRenderTexture)}assignProcessedThumb(){if(this.thumbRenderTexture.width!==this.thumbSourceTexture.width||this.thumbRenderTexture.height!==this.thumbSourceTexture.height){let t=BFN.PhotoEditorMenuModel.getPresetItemThumbTexture(this.thumbRenderTexture);this.thumbRenderTexture.resize(this.thumbSourceTexture.width,this.thumbSourceTexture.height),this.thumbRenderTexture.copyPixels(t,void 0,void 0,void 0,{x:this.thumbRenderTexture.width/t.width,y:this.thumbRenderTexture.height/t.height}),t.destroyGC(!0)}let{presetId:e}=this.currentPresetMenuItem;BFN.TextureUtils.textureToBlob(this.thumbRenderTexture,{mimeType:"image/jpeg",quality:.9}).then(t=>URL.createObjectURL(t)).catch(t=>(BeFunky.reportWarning(`Failed to create thumbnail for preset-menu-item: ${t.name||t}`,e,t),"SKIPPED")).then(t=>{this.thumbnailUrls[e]&&URL.revokeObjectURL(this.thumbnailUrls[e]),this.thumbnailUrls[e]=t,this.currentPresetMenuItem.presetId===e&&(this.currentPresetMenuItem=null),this.dispatchEvent(BFN.PresetMenuItemThumbManagerEvents.PROCESSING_QUEUE_UPDATED),this.processQueue()})}handleCurrentImageThumbUpdated(){Object.values(this.thumbnailUrls).forEach(e=>URL.revokeObjectURL(e)),this.thumbnailUrls={},this.thumbSourceTexture=BFN.PhotoEditorMenuModel.currentImageThumbTexture;try{this.sourceTexture.destroyGC(!0)}catch(e){}if(this.sourceTexture=null,this.thumbSourceTexture&&this.thumbSourceTexture.originalBaseTexture){let e=new PIXI.Texture(this.thumbSourceTexture.originalBaseTexture);this.sourceTexture=BFN.Util.getThumbTextureGL(e,1024),e.destroy(!1)}else BFN.PhotoEditorModel.sourceTexture&&(this.sourceTexture=BFN.Util.getThumbTextureGL(BFN.PhotoEditorModel.sourceTexture,1024));if(!this.thumbRenderTexture||this.thumbRenderTexture&&(this.thumbRenderTexture.width!==this.thumbSourceTexture.width||this.thumbRenderTexture.height!==this.thumbSourceTexture.height)){try{this.thumbRenderTexture.destroyGC(!0)}catch(e){}this.thumbRenderTexture=PIXI.RenderTexture.create(this.thumbSourceTexture.width,this.thumbSourceTexture.height),this.thumbRenderTexture.clear()}if(this.hasOwnProperty("blendModeSprite")||(this.blendModeSprite=new BFN.BlendModeSprite(!1)),this.blendModeSprite.setBaseTexture(this.thumbSourceTexture),this.blendModeSprite.setBlendTexture(this.thumbRenderTexture),this.hasOwnProperty("lensFlareDisplay")||(this.lensFlareDisplay=new BFN.LensFlareDisplay(!0)),this.lensFlareDisplay.itemWidth!==this.thumbSourceTexture.width||this.lensFlareDisplay.itemHeight!==this.thumbSourceTexture.height){this.lensFlareDisplay.setDisplayDimensions(this.thumbSourceTexture.width,this.thumbSourceTexture.height);let e=Math.min(this.lensFlareDisplay.itemWidth,this.lensFlareDisplay.itemHeight)/4;this.lensFlareDisplay.setSourcePoint(e,-e),this.lensFlareDisplay.setCenterPoint(0,0),this.lensFlareDisplay.x=this.lensFlareDisplay.itemWidth/2,this.lensFlareDisplay.y=this.lensFlareDisplay.itemHeight/2}}handleEffectCompleted(){BFN.EffectManager.removeEventListener(BFN.EffectManagerEvents.EFFECT_COMPLETE.type,this.handleEffectCompletedBind),this.assignProcessedThumb()}handleThumbGraphicLoaded(){this.thumbGraphicLoader.removeEventListener(BFN.GraphicLoaderEvents.LOADING_COMPLETE.type,this.handleThumbGraphicLoadedBind);let{presetID:e}=this.currentPresetMenuItem,{defaultValues:t}=UITools.getToolVO(e);this.blendTexture(this.thumbGraphicLoader.graphics[e],t.blendMode,t.alpha),this.assignProcessedThumb()}handleOverlayThumbsLoaded(){BFN.OverlaysThumbLoader.removeEventListener(BFN.OverlaysThumbLoaderEvents.LOADED.type,this.handleOverlayThumbsLoadedBind);let{categoryID:e}=this.currentPresetMenuItem.presetObject,t=this.currentPresetMenuItem.presetObject.id;BFN.OverlaysThumbLoader.getImage(e,t,!0,this.handleOverlayThumbLoaded.bind(this))}handleOverlayThumbLoaded(e){let{categoryID:t}=this.currentPresetMenuItem.presetObject;this.thumbRenderTexture.copyPixels(this.thumbSourceTexture);let r=new PIXI.Graphics;r.beginFill(16777215,.9),r.drawRect(0,0,this.thumbSourceTexture.width,this.thumbSourceTexture.height),r.endFill(),BFN.Stage.render(r,this.thumbRenderTexture,!1);let a=new PIXI.Sprite(this.thumbSourceTexture),s=new PIXI.Sprite(e),o=new PIXI.Container;if(o.addChild(a),o.addChild(s),s.scale.x=s.scale.y=this.thumbSourceTexture.height/e.height*.9,s.anchor.x=s.anchor.y=.5,a.mask=s,t==="patterns")for(let n=-1;n<=1;n++)for(let l=-1;l<=1;l++)s.x=this.thumbSourceTexture.width/2+e.width*n*s.scale.x,s.y=this.thumbSourceTexture.height/2+e.height*l*s.scale.y,BFN.Stage.render(o,this.thumbRenderTexture,!1);else s.x=this.thumbSourceTexture.width/2,s.y=this.thumbSourceTexture.height/2,BFN.Stage.render(o,this.thumbRenderTexture,!1);o.removeChild(a),o.removeChild(s),a.texture=null,s.texture=null,e.destroyGC(!0),this.assignProcessedThumb()}handleFrameDisplayFrameLoaded(){this.frameDisplay.removeEventListener(BFN.FrameDisplayEvents.FRAME_LOADED.type,this.handleFrameDisplayFrameLoadedBind);let{presetId:e}=this.currentPresetMenuItem,{defaultValues:t}=UITools.getToolVO(e);this.frameDisplay.setBlendMode(t.hasOwnProperty("blendMode")?t.blendMode:BFN.CONST.BLEND_MODES.NORMAL),BFN.Stage.render(this.frameDisplay,this.thumbRenderTexture,!0),setTimeout(()=>{BFN.Stage.render(this.frameDisplay,this.thumbRenderTexture,!0),setTimeout(()=>{this.thumbRenderTexture.fillColor(16316667),this.frameDisplay.x=this.thumbRenderTexture.width/2-this.frameDisplay.itemWidth/2,this.frameDisplay.y=this.frameThumbPadding,BFN.Stage.render(this.frameDisplay,this.thumbRenderTexture,!1),this.frameDisplay.destroyFrameTextures(),this.assignProcessedThumb()},0)},0)}handleLensFlareElementsAdded(){this.lensFlareDisplay.removeEventListener(BFN.LensFlareDisplayEvents.ELEMENTS_ADDED.type,this.handleLensFlareElementsAddedBind);let{presetId:e}=this.currentPresetMenuItem;this.lensFlareThumbTextures.hasOwnProperty(e)||(this.lensFlareThumbTextures[e]=PIXI.RenderTexture.create(this.lensFlareDisplay.itemWidth,this.lensFlareDisplay.itemHeight),BFN.Stage.render(this.lensFlareDisplay,this.lensFlareThumbTextures[e])),this.thumbRenderTexture.copyPixels(this.lensFlareThumbTextures[e]),this.blendModeSprite.setBlendMode(BFN.CONST.BLEND_MODES.SCREEN),this.blendModeSprite.setBlendIntensity(1),this.blendModeSprite.renderDisplay(),BFN.Stage.render(this.blendModeSprite,this.thumbRenderTexture),this.assignProcessedThumb()}};BFN.SingletonQueue.add(()=>{BFN.PresetMenuItemThumbManager=new Jb});var Qb=class{constructor(){this.init()}init(){BeFunky.log("FeaturedManager Init"),this.initDefaultValues()}initDefaultValues(){this.featuredIDs=[],this.featuredEffectIDs=BFN.FeaturedData.effect,this.featuredArtsyIDs=BFN.FeaturedData.artsy,this.featuredFrameIDs=BFN.FeaturedData.frame,this.featuredTextureIDs=BFN.FeaturedData.texture,this.featuredIDs.concat(this.featuredEffectIDs,this.featuredArtsyIDs)}handleEffectCategory(){BFN.effectMenus.effect_featured_menu.toolObject.presets=[];let e=BFN.FeaturedManager.featuredEffectIDs,t=Object.values(BFN.effectMenus).map(({toolObject:a})=>a).filter(({id:a})=>a!=="effect_favorites"),r=BFN.FeaturedManager.getFeaturedPresetData(t,e);r.length&&(BFN.effectMenus.effect_featured_menu.toolObject.presets=r)}handleArtsyCategory(){}handleFrameCategory(){BFN.frameCropRotateMenus.frame_featured_menu.toolObject.presets=[];let e=BFN.FeaturedManager.featuredFrameIDs,t=It(It(It(It({},BFN.frameCropRotateMenus),BFN.frameSmartMenus),BFN.frameCropMenus),BFN.frameFullMenus),r=Object.values(t).map(({toolObject:s})=>s),a=BFN.FeaturedManager.getFeaturedPresetData(r,e);a.length&&(BFN.frameCropRotateMenus.frame_featured_menu.toolObject.presets=a)}handleTextureCategory(){BFN.textureMenus.texture_featured_menu.toolObject.presets=[];let e=BFN.FeaturedManager.featuredTextureIDs,t=Object.values(BFN.textureMenus).map(({toolObject:a})=>a),r=BFN.FeaturedManager.getFeaturedPresetData(t,e);r.length&&(BFN.textureMenus.texture_featured_menu.toolObject.presets=r)}getFeaturedPresetData(e,t){return e.map(({presets:r})=>r).flat().filter(r=>t.includes(r.id))}};BFN.SingletonQueue.add(()=>{BFN.FeaturedManager=new Qb});BFN.FavoritesManagerEvents={FAVORITES_LIST_UPDATED:new Event("FAVORITES_LIST_UPDATED")};var Zb=class extends BFN.EventDispatcher{constructor(e){super(e);this.init()}init(){BeFunky.log("FavoritesManager Init"),this.initDefaultValues()}initDefaultValues(){this.favoriteStars={},this.favoriteEffectIDs=[],this.favoriteArtsyIDs=[],this._effectMenu=null,this._artsyMenu=null,this.favoriteRemoved=!1,this.NOT_ALLOWED_FAVS=["ART_0020","ART_0022","ART_0021","ART_0023"]}handleEffectCategory(){BFN.effectMenus.effect_favorites_menu.toolObject.presets=[];let e=BFN.FavoritesManager.favoriteEffectIDs,t=Object.values(BFN.effectMenus).map(({toolObject:a})=>a).filter(({id:a})=>a!=="effect_featured"),r=BFN.FavoritesManager.getFavoritePresetData(t,e);r.length&&(BFN.effectMenus.effect_favorites_menu.toolObject.presets=r)}handleArtsyCategory(){BFN.artsyMenus.artsy_favorites_menu.toolObject.presets=[];let e=BFN.FavoritesManager.favoriteArtsyIDs,t=Object.values(BFN.artsyMenus).map(({toolObject:a})=>a).filter(({id:a})=>a!=="artsy_featured"),r=BFN.FavoritesManager.getFavoritePresetData(t,e);r.length&&(BFN.artsyMenus.artsy_favorites_menu.toolObject.presets=r)}updateFavoriteStars(){Object.entries(this.favoriteStars).forEach(([e,t])=>{t.selected=this.favoriteIDs.includes(e)})}isSelected(e){let t=BFN.effectPresetMap[e]||BFN.artsyPresetMap[e],r=e.replace(`${t}_`,"");return BFN.FavoritesManager.favoriteIDs.includes(r)}handleFavoritesLoaded(e,t){let r,a;switch(e){case"artsy":r=this.favoriteArtsyIDs,a=this.handleArtsyCategory.bind(this);break;case"effect":r=this.favoriteEffectIDs,a=this.handleEffectCategory.bind(this);break}if(!r)return BeFunky.logError("Invalid Favorites category",e);r.splice(0),t.filter(s=>!this.NOT_ALLOWED_FAVS.includes(s)).forEach(s=>{r.push(s)}),this.updateFavoriteStars(),this.favoriteRemoved&&BFN.PhotoEditorCanvasTools.currentTool&&(this.favoriteRemoved=!1),a()}handleIconClick(e,t,r,a=!1){let s=this.favoriteIDs.includes(r);if(!BFN.BfnService.userLoggedIn){UIMessages.display("error_not_logged_in",1500);return}if(!BFN.toolViewstates.hasOwnProperty(t)){BeFunky.throwError("BFN.toolViewstates missing favorite star presetID",t),UIMessages.display("Error");return}let o=null,n=null,l=null;switch(BFN.toolViewstates[t]){case BFN.PhotoEditorCanvasModelViewStates.VIEWING_EFFECT:o="effect",n="effects_fav",l=BFN.FavoritesManager.favoriteEffectIDs.slice(0);break;case BFN.PhotoEditorCanvasModelViewStates.VIEWING_ARTSY:o="artsy",n="artsy_fav",l=BFN.FavoritesManager.favoriteArtsyIDs.slice(0);break}n&&(s?(UITools.onButtonControlClick(e,"editor_apply_cancel_cancel"),l.splice(l.indexOf(r),1),UIMessages.display("favorite_removed")):(l.push(r),UIMessages.display("favorite_added")),BFN.SettingsManager.updateSetting(n,l),BFN.SettingsManager.getSetting(n).then(c=>{BFN.FavoritesManager.handleFavoritesLoaded(o,c)}))}handleFavoriteIconClick(e,t){let r=BFN.effectPresetMap[t]||BFN.artsyPresetMap[t],a=t.replace(`${r}_`,"");this.dispatchEvent(BFN.FavoritesManagerEvents.FAVORITES_LIST_UPDATED),this.handleIconClick(e,t,a)}getFavoritePresetData(e,t){return e.map(({presets:r})=>r).flat().filter(r=>t.includes(r.id))}get favoriteIDs(){return[...this.favoriteEffectIDs,...this.favoriteArtsyIDs]}get effectMenu(){return this._effectMenu||(this._effectMenu=document.querySelector("#effect_favorites_menu .menu-content")),this._effectMenu}get artsyMenu(){return this._artsyMenu||(this._artsyMenu=document.querySelector("#artsy_favorites_menu .menu-content")),this._artsyMenu}};BFN.SingletonQueue.add(()=>{BFN.FavoritesManager=new Zb});var eB=class{constructor(){this.init()}init(){this.initDefaultValues()}initDefaultValues(){this.buttons={},this.panelHeaders={}}updateButtonIcons(){Object.entries(this.buttons).forEach(([e,t])=>{t.selected=this.isSelected(e)})}registerPanelHeader(e,t){if(!e||!t){BeFunky.throwError("Invalid batch processing panel header registered",e,t);return}if(this.panelHeaders[t]){BeFunky.throwError("Batch processing Panel Header icon already registered for batchToolID",e,t);return}if(Object.values(this.panelHeaders).includes(e)){BeFunky.throwError("Batch processing Panel Header icon already registered for a different batchToolID",e,t);return}this.panelHeaders[t]=e;let r=this.isSelected(t);e.toggleButtons({batch_add:!r,batch_remove:r},!1),e.addEventListener("BATCH",()=>{let a=()=>{let s=e.getBoundingClientRect();return{left:`${s.right+12}px`,top:`${s.top+s.height/2+4}px`}};this.showHelpClue(a).then(s=>{this.handleIconClick(t,s)})})}updatePanelHeaders(){Object.entries(this.panelHeaders).forEach(([e,t])=>{let r=this.isSelected(e);r!==t.buttons.includes("batch_remove")&&t.toggleButtons({batch_add:!r,batch_remove:r},!1)})}showHelpClue(e){return BFN.HelpClueManager.wasClueDismissed("batch_icon").then(t=>{if(t)return!1;let{top:r,left:a}=e(),s=document.getElementById("batch_icon_walkthrough");return BFN.HelpClueManager.show("batch_icon",{force:!0,allowTracking:!1,renderOptions:{side:"left",positionFactor:0,strong:!1,top:r,left:a,zIndex:"10",container:s,button:{langID:"try_it_now",onClick:()=>BFN.BatchProcessingManager.openModal()}}}).then(()=>{requestAnimationFrame(()=>{let o=s.firstElementChild,n=o.container.getBoundingClientRect(),l=n.bottom-BFN.appRect.bottom;l<-16||(o.positionFactor+=(l+16)/(n.height-32-o.arrowBase))})}),!0})}isSelected(e){return BFN.BatchToolManager.selectedIDs.includes(e)}handleIconClick(e,t=!1){let r=BFN.BatchToolManager.selectedIDs.slice(0),a=this.isSelected(e);a&&t||(a?(r.splice(r.indexOf(e),1),UIMessages.display("batch_tool_removed")):(r.push(e),UIMessages.display("batch_tool_added")),BFN.BatchToolManager.selectedIDs=r)}handlePanelHeaderBatchIconClick(e,t,r){let a=()=>{let s=e.getBoundingClientRect();return{left:`${s.right+12}px`,top:`${s.top+s.height/2+4}px`}};this.showHelpClue(a).then(s=>{this.handleIconClick(t,s),r()})}};BFN.SingletonQueue.add(()=>{BFN.BatchIconManager=new eB});var tB=class{constructor(){this.init()}init(){BeFunky.log("ZoomManager Init"),this.initDefaultValues()}initDefaultValues(){this.zoomWheelActive=!1,this.zoomWheelTimer=0,BFN.AppModel.addEventListener(BFN.AppModelEvents.APP_READY.type,this.handleAppReady.bind(this)),BFN.AppModel.addEventListener(BFN.AppModelEvents.VIEWSTATE_UPDATED.type,this.handleAppViewstateUpdated.bind(this)),BFN.StageModel.addEventListener(BFN.StageModelEvents.STAGE_DIMENSIONS_UPDATED.type,this.handleStageDimensionsUpdated.bind(this))}handleZoom(){let e=BFN.AppModel.sectionValue(BFN.PhotoEditorCanvasModel,BFN.CollageMakerCanvasModel,BFN.DesignerCanvasModel),t=UITools.getToolVO("zoom");if(e.canvasScaling!==t.updating&&(e.canvasScaling=t.updating),e.canvasScaling){let r=t.stagger_factor;t.updating_id==="minus"?e.canvasScale*=1-.2*r:t.updating_id==="plus"?e.canvasScale*=1+.25*r:e.canvasScale!==t.amount/100&&(e.canvasScale=t.amount/100)}if(UITools.getToolValue("zoom","exact_fit"))switch(BFN.AppModel.viewState){case BFN.AppModelViewStates.VIEWING_PHOTO_EDITOR:e.dispatchEvent(BFN.PhotoEditorCanvasModelEvents.FIT_IMAGE_TO_FRAME);break;case BFN.AppModelViewStates.VIEWING_COLLAGE_MAKER:e.dispatchEvent(BFN.CollageMakerCanvasModelEvents.FIT_COLLAGE_TO_FRAME);break;case BFN.AppModelViewStates.VIEWING_DESIGNER:e.dispatchEvent(BFN.DesignerCanvasModelEvents.FIT_DESIGNER_TO_FRAME);break}UITools.getToolValue("zoom","full_screen")&&BFN.AppModel.toggleFullscreen(),BFN.ZoomRegion&&BFN.ZoomRegion.show()}updateZoomRange(e=!1){let{canvasModel:t,canvasW:r,canvasH:a}=this.getCanvasData();if(t&&r>0&&a>0){let{stageW:s}=BFN.StageModel,{stageH:o}=BFN.StageModel;t.minCanvasScale=Math.min(1,s/r,o/a)*.4;let n=Math.round(t.minCanvasScale*100),l=Math.round(t.maxCanvasScale*100);UITools.updateParamObject("zoom_amount",{min:n,max:l}),e?(UITools.setToolValue("zoom","amount",t.canvasScale*100),UITools.updateToolControl("zoom_amount")):UITools.getControlValue("zoom_amount")<n&&(UITools.setControlValue("zoom_amount",n),UITools.updateToolControl("zoom_amount"),t.canvasScaling=!0,t.canvasScale=n/100,t.canvasScaling=!1,BFN.MainUI.requestRender())}}centerItem(e,t=0,r=0,a=!1,s=!1,o=!1){if(!this.isZoomedIn||!(e instanceof BFN.TransformItem)||e.appViewState!==BFN.AppModel.viewState||BFN.ActiveDraggers.map(F=>F.dragging).includes(!0)||BFN.GestureManager.gestureActive||o&&BFN.TransformModel.selectedTransformItem!==e)return;let n=e.transformLayer;if(!n.children.includes(e))return;let l=n.canvas,c=l.canvasContainer,h=e.canvasModel.canvasScale;t/=h,r/=h;let u=e.bounds,d=u.width*e.scale.x,m=u.height*e.scale.y,p=Math.sqrt(Math.pow(d,2)+Math.pow(m,2))/2,g=Math.atan2(m/2,d/2),f=e.x+Math.cos(g+e.rotation)*p,v=e.y+Math.sin(g+e.rotation)*p,{stageW:T,stageH:x}=BFN.StageModel,B={x:T+BFN.getAppViewportLeftOffset(),y:x+BFN.getAppViewportBottomOffset()},y={x:Math.round(c.x),y:Math.round(c.y)};requestAnimationFrame(()=>{if(o&&BFN.TransformModel.selectedTransformItem!==e)return;B.x-=BFN.getAppViewportLeftOffset(!0),B.y-=BFN.getAppViewportBottomOffset(!0),BFN.MainUI.viewportOverrideW=B.x,BFN.MainUI.viewportOverrideH=B.y;let F=()=>{delete BFN.MainUI.viewportOverrideW,delete BFN.MainUI.viewportOverrideH};c.x=-f,c.y=-v,l.updateCanvasContainerPosition();let b={x:Math.round(c.x),y:Math.round(c.y)};(t||r)&&(c.x=t-f,c.y=r-v,l.updateCanvasContainerPosition());let S={x:Math.round(c.x),y:Math.round(c.y)};if(F(),c.x=y.x,c.y=y.y,l.updateCanvasContainerPosition(),BFN.MainUI.viewportOverrideW=B.x,BFN.MainUI.viewportOverrideH=B.y,a&&(t||r)&&(y.x!==b.x||y.y!==b.y)){F();return}if(y.x===S.x&&y.y===S.y){F();return}if(s&&c.endPos&&(y.x!==c.endPos.x||y.y!==c.endPos.y)){F();return}c.endPos=S;let I=()=>{if(!(BFN.ActiveDraggers.map(E=>E.dragging).includes(!0)||BFN.GestureManager.gestureActive)){if(o&&BFN.TransformModel.selectedTransformItem!==e){F();return}c.x=y.x+(S.x-y.x)*this.centerItemAnimator.animationSinFactor,c.y=y.y+(S.y-y.y)*this.centerItemAnimator.animationSinFactor,l.updateCanvasContainerDisplay(),BFN.ZoomRegion&&BFN.ZoomRegion.updateViewport&&BFN.ZoomRegion.updateViewport(),BFN.HiResTextManager.updateHiResTextViewport()}},_=()=>{this.centerItemAnimator.removeEventListener(BFN.AnimatorEvents.UPDATE.type,I),this.centerItemAnimator.removeEventListener(BFN.AnimatorEvents.UPDATE_COMPLETE.type,_),BFN.MainUI.viewportUpdating||F()};this.centerItemAnimator=this.centerItemAnimator||new BFN.Animator,this.centerItemAnimator.linearSteps=7,this.centerItemAnimator.addEventListener(BFN.AnimatorEvents.UPDATE.type,I),this.centerItemAnimator.addEventListener(BFN.AnimatorEvents.UPDATE_COMPLETE.type,_),this.centerItemAnimator.setAnimatorFactor(0),this.centerItemAnimator.increase()})}getCanvasData(){let e=null,t=0,r=0;switch(BFN.AppModel.viewState){case BFN.AppModelViewStates.VIEWING_PHOTO_EDITOR:e=BFN.PhotoEditorCanvasModel,BFN.PhotoEditorModel.currentTexture&&(t=BFN.PhotoEditorModel.currentTexture.width,r=BFN.PhotoEditorModel.currentTexture.height,BFN.PhotoEditorCanvasTools.currentTool&&BFN.PhotoEditorCanvasTools.currentTool.hasOwnProperty("itemWidth")&&BFN.PhotoEditorCanvasTools.currentTool.hasOwnProperty("itemHeight")&&(t=BFN.PhotoEditorCanvasTools.currentTool.itemWidth,r=BFN.PhotoEditorCanvasTools.currentTool.itemHeight));break;case BFN.AppModelViewStates.VIEWING_COLLAGE_MAKER:e=BFN.CollageMakerCanvasModel,t=BFN.CollageMakerCanvasPhotoGrid.gridWidth,r=BFN.CollageMakerCanvasPhotoGrid.gridHeight;break;case BFN.AppModelViewStates.VIEWING_DESIGNER:e=BFN.DesignerCanvasModel,t=BFN.DesignerCanvas.canvasWidth,r=BFN.DesignerCanvas.canvasHeight;break}return BFN.TransformItemIsolator.active&&(t=BFN.TransformItemIsolator.itemWidth,r=BFN.TransformItemIsolator.itemHeight),{canvasModel:e,canvasW:t,canvasH:r}}handleAppReady(){BFN.MainUI.addEventListener(BFN.MainUIEvents.MOUSE_WHEEL.type,this.handleMainUIMouseWheel.bind(this))}handleAppViewstateUpdated(){this.updateZoomRange(!0)}handleStageDimensionsUpdated(){this.updateZoomRange()}handleMainUIMouseWheel(e){BFN.AppModel.viewingEditor&&!BFN.PhotoEditorModel.currentTexture||BFN.ImageCutout.cutoutActive||BeFunky.isPointerDown||BFN.ImagePainterUndoManager&&BFN.ImagePainterUndoManager.currentImagePainter&&BFN.ImagePainterUndoManager.currentImagePainter.mouseDown||(this.zoomWheelTimer=20,this.zoomWheelActive||(this.zoomWheelActive=!0,this.tickZoomWheelTimer()),UITools.setToolValue("zoom","stagger_factor",Math.abs(e.deltaY/100)),e.deltaY<0?UITools.setToolValue("zoom","plus",!1,!0):e.deltaY>0&&UITools.setToolValue("zoom","minus",!1,!0),UITools.applyTool("zoom"))}tickZoomWheelTimer(){--this.zoomWheelTimer<=0?(this.zoomWheelActive=!1,UITools.setToolValue("zoom","stagger_factor",1),UITools.setToolValue("zoom","amount",UITools.getToolValue("zoom","amount"),!1),UITools.applyTool("zoom")):setTimeout(this.tickZoomWheelTimer.bind(this),0)}get isZoomedIn(){let{canvasModel:e,canvasW:t,canvasH:r}=this.getCanvasData(),a=t*e.canvasScale,s=r*e.canvasScale,o=BFN.StageModel.stageW,n=BFN.StageModel.stageH;return a>o||s>n}};BFN.SingletonQueue.add(()=>{BFN.ZoomManager=new tB});var iB=class{constructor(){this.init()}init(){this.initDefaultValues()}initDefaultValues(){BFN.AppModel.addEventListener(BFN.AppModelEvents.VIEWSTATE_UPDATED.type,this.handleAppViewstateUpdated.bind(this))}handleCustomize(){switch(BFN.AppModel.viewState){case BFN.AppModelViewStates.VIEWING_COLLAGE_MAKER:BFN.CollageMakerCanvas.handleCustomize();break;case BFN.AppModelViewStates.VIEWING_DESIGNER:BFN.DesignerCanvas.handleCustomize();break}}updateMenuDisplay(){switch(BFN.AppModel.viewState){case BFN.AppModelViewStates.VIEWING_COLLAGE_MAKER:UITools.setToolValue("collage_customize","background_color",BFN.CollageMakerCanvasBackground.color),UITools.updateToolControls("collage_customize");break;case BFN.AppModelViewStates.VIEWING_DESIGNER:UITools.setToolValue("collage_customize","background_color",BFN.DesignerCanvasBackground.color),UITools.updateToolControls("collage_customize");break}}handleAppViewstateUpdated(){this.updateMenuDisplay()}};BFN.SingletonQueue.add(()=>{BFN.CustomizeManager=new iB});var rB=class{constructor(){this.isNeedToOpenTouchUp=!1,this.category=null}openPhotoEditorSideMenu(e){if(!(!e||!BFN.PhotoEditorModel.currentTexture)){switch(this.category=null,e){case"edit-photo":this.category={main:"editor_main",sub:"edit"};break;case"touch-up":this.category={main:"editor_main",sub:"touch_up"};break;case"photo-effects":this.category={main:"editor_main",sub:"effect"};break;case"photo-to-art":this.category={main:"editor_main",sub:"artsy"};break;case"frames":this.category={main:"editor_main",sub:"frame"};break;case"graphics":this.category={main:"editor_main",sub:"graphic"};break;case"overlay":this.category={main:"editor_main",sub:"overlay"};break;case"text-editor":this.category={main:"editor_main",sub:"text"};break;case"textures":this.category={main:"editor_main",sub:"texture"};break;case"crop-photo":case"recortar-fotos":this.category={first_main:"editor_main",first_sub:"edit",main:"editor_edit",sub:"crop"};break;case"resize-image":this.category={first_main:"editor_main",first_sub:"edit",main:"editor_edit",sub:"resize"};break;case"background-remover":this.category={first_main:"editor_main",first_sub:"edit",main:"editor_edit",sub:"background"};break;case"cutout":this.category={first_main:"editor_main",first_sub:"edit",main:"editor_edit",sub:"cutout"};break;case"blur-image":case"difuminar-fotos":this.category={first_main:"editor_main",first_sub:"edit",main:"editor_edit",sub:"blur"};break;case"replace-color":this.category={first_main:"editor_main",first_sub:"edit",main:"editor_edit",sub:"replace_color"};break;case"hair-color":this.category={first_main:"editor_main",first_sub:"touch_up",main:"editor_touch_up",sub:"hair_color"};break;case"effect-pop-art":this.category={first_main:"editor_main",first_sub:"effect",main:"editor_effect",sub:"popartfx"};break;case"effect-glitch-art":this.category={first_main:"editor_main",first_sub:"effect",main:"editor_effect",sub:"glitch_art"};break;case"effect-featured":case"effect-chromatic":case"effect-black&white":case"effect-charcoal":case"effect-color-pinhole":case"effect-cooler":case"effect-cross-process":case"effect-cyanotype":case"effect-grunge":case"effect-hdr":case"effect-holga-art":case"effect-instant":case"effect-line-artopia":case"effect-lomo-art":case"effect-motion-color":case"effect-old-photo":case"effect-orton-style":case"effect-patriotic":case"effect-pinhole":case"effect-sepia":case"effect-stenciler":case"effect-summer":case"effect-sunburst":case"effect-tilt-shift":case"effect-tin-type":case"effect-united-colors":case"effect-warmer":case"effect-viewfinder":case"effect-vintage-colors":case"effect-winter":{let t=e.replace("effect-","").replace("-","").replace("fx","");t==="black&white"?t="bw":t==="tintype"&&(t="tinytype"),this.category={first_main:"editor_main",first_sub:"effect",main:"editor_effect",sub:t};break}case"lens-flare":this.category={first_main:"editor_main",first_sub:"effect",main:"editor_effect",sub:"lens_flares"};break;case"cartoonizer":case"digital-art":case"gouache":case"impressionist":case"inkify":case"mosaic":case"oil-painting":case"pastel":case"pen-art":case"pointillism":case"poly-art":case"sketcher":case"underpainting":case"watercolor":this.category={first_main:"editor_main",first_sub:"artsy",main:"editor_artsy",sub:e.replace("-","")};break;case"photo-enhancer":this.category={first_main:"editor_main",first_sub:"edit",main:"editor_edit",sub:"edit_dlx"};break;case"fathers-day":this.category={first_main:"editor_main",first_sub:"graphic",main:"editor_graphic",sub:"holiday_fathers_day"};break}if(!!this.category){if(this.category.hasOwnProperty("first_main")&&(UITools.setToolValue(this.category.first_main,this.category.first_sub,!1),UITools.applyTool(this.category.first_main)),this.category.hasOwnProperty("sub")){if(this.category.sub==="edit_dlx"){if(BeFunky.isWiderThanMobile()){let t;BeFunky.waitUntil({condition:()=>(t=BFN.secondaryMenu.querySelector("accordion-layout"),Boolean(t)),onSuccess:()=>{t.sections.enhance_dlx&&!t.activeSections.includes("enhance_dlx")&&(t.activeSections=["enhance_dlx",...t.activeSections])},onTimeout:()=>{}})}return}if(this.category.sub==="edit"&&this.isNeedToOpenTouchUp&&(this.category.sub="touch_up"),UITools.setToolValue(this.category.main,this.category.sub,!1),UITools.applyTool(this.category.main),this.category.main==="editor_effect"&&!BFN.PresetMenuItemThumbManager.thumbSourceTexture){let{sub:t}=this.category;BFN.PhotoEditorMenuModel.addEventListener(BFN.PhotoEditorMenuModelEvents.CURRENT_IMAGE_THUMB_UPDATED.type,BeFunky.once(()=>{let r=document.getElementById(`${t}_menu`);if(r&&r.hasClass("active")){let a=r.querySelectorAll(".pmi");BFN.PresetMenuItemThumbManager.processItems(a)}}))}}this.category=null,this.isNeedToOpenTouchUp=!1}}}handleEditorDeepLink(){let{type:e}=window.currentDeepLinkParameters;if(e==="batch"&&!BeFunky.ignoreDeepLinkAction)return BeFunky.ignoreDeepLinkAction=!0,BFN.BatchProcessingManager.openModal();if(e==="settings"&&!BeFunky.ignoreDeepLinkAction)return BeFunky.ignoreDeepLinkAction=!0,Ri();BFN.PhotoEditorModel.currentTexture&&this.handleEditorImageDeepLink()}handleEditorImageDeepLink(e=()=>{}){let{type:t}=window.currentDeepLinkParameters,{tag:r}=window.currentDeepLinkParameters;if(t==="batch"&&!BeFunky.ignoreDeepLinkAction&&(BeFunky.ignoreDeepLinkAction=!0,BFN.BatchProcessingManager.openModal()),t==="settings"&&!BeFunky.ignoreDeepLinkAction&&(BeFunky.ignoreDeepLinkAction=!0,Ri()),t==="graphics"&&r&&!BeFunky.ignoreDeepLinkAction&&BFN.GraphicLibraryManager.openModal(r),t==="photoeditor"||BeFunky.ignoreDeepLinkAction){if(BFN.mainMenuStates.editor.secondary)return a();t="edit-photo"}["collage","designer"].includes(t)&&(BeFunky.reportWarning(`Invalid editor deep link type: ${t}`),t="edit-photo"),BFN.DeepLinkManager.openPhotoEditorSideMenu(t),a(),BeFunky.ignoreDeepLinkAction=!0;function a(){setTimeout(()=>{BeFunky.waitUntil({condition:()=>!BFN.MainUI.viewportUpdating,onSuccess:e,onTimeout:()=>{BeFunky.reportWarning("viewportUpdating timed out"),e()},interval:100,maxAttempts:50})},0)}}getDesignerDeepLinkData(){let{tag:e,template:t}=window.currentDeepLinkParameters;return BeFunky.ignoreDeepLinkAction||!t&&!e?{deepLinkTagID:null,deepLinkTemplateID:null,deepLinkTemplateRoute:null}:{deepLinkTagID:e||null,deepLinkTemplateID:t||null,deepLinkTemplateRoute:BeFunky.getCurrentRoute()}}handleDesignerDeepLink(){if(BeFunky.ignoreDeepLinkAction)return;let{deepLinkTagID:e,deepLinkTemplateID:t,deepLinkTemplateRoute:r}=this.getDesignerDeepLinkData();e?BFN.DesignerTemplateManager.openModal(e):t?BFN.DesignerTemplateManager.openDeepLinkTemplatePreview(t,r):BFN.DesignerModel.projectVO._wasReset&&BFN.DesignerTemplateManager.openModal()}};BFN.SingletonQueue.add(()=>{BFN.DeepLinkManager=new rB});var aB=class{constructor(){this.init()}init(){this.initDefaultValues()}initDefaultValues(){this.isDataLoaded=!1,this.loadedPatternCategories=[],this.menuImageVOs=[],this.usedPatternBaseTextures=[],this.patternsMenuData={}}handlePatternCategory(){let e=UITools.getToolValue("collage_patterns","updating_id");if(!this.loadedPatternCategories.includes(e)){this.loadedPatternCategories.push(e);let t=[],r=s=>o=>{t.push({isPlus:s,id:`patterns_${e}_${s?"plus":"free"}_${o}`,num:o})},a=BFN.PatternsData[`patterns_${e}`];a.freePatterns.forEach(r(!1)),a.plusPatterns.forEach(r(!0)),this.patternsMenuData[`collage_patterns_${e}_menu`]={categoryId:e,name:a.name,patternsInCategory:t}}}loadCategories(){this.isDataLoaded||BFN.PatternsDataLoader.load(()=>{if(!this.isDataLoaded&&!Object.keys(BFN.PatternsData).length)return BeFunky.logError("Unable to get pattern category data");this.isDataLoaded=!0,BFN.secondaryMenu.collagePatternsDisabled=!1})}doubleBlobDimensions(e,t){return new Promise((r,a)=>{BFN.TextureUtils.blobOrBase64ToTexture(t,({error:s,texture:o})=>{if(s)return a(s);let n=BFN.Util.getTextureAverageColor(o,!0),l=PIXI.RenderTexture.create(o.width*2,o.height*2);l.copyPixels(o,new PIXI.Point(0,0)),l.copyPixels(o,new PIXI.Point(o.width,0),!1),l.copyPixels(o,new PIXI.Point(0,o.height),!1),l.copyPixels(o,new PIXI.Point(o.width,o.height),!1),o.destroyGC(!0),o=l,o.baseTexture.averageColor=n,o.baseTexture.isPattern=!0,e.imageTexture=o,BFN.TextureUtils.textureToBlob(o,{isTransparent:!1}).then(r,a)})})}destroyUnusedPatternBaseTextures(){return this.updateUsedPatternBaseTextures(),this.destroyPatternBaseTextures(this.usedPatternBaseTextures)}updateUsedPatternBaseTextures(){let e=r=>{r&&r.isPattern&&!this.usedPatternBaseTextures.includes(r)&&this.usedPatternBaseTextures.push(r)};this.usedPatternBaseTextures.splice(0),Object.values(BFN.AppModelViewStates).forEach(r=>{BFN.TransformStateModel.getTransitions(r).forEach(s=>{e(s.startState.collageSettings.backgroundPatternBaseTexture),e(s.endState.collageSettings.backgroundPatternBaseTexture),e(s.startState.imageTexture?s.startState.imageTexture.baseTexture:null),e(s.endState.imageTexture?s.endState.imageTexture.baseTexture:null)})}),BFN.CollageMakerCanvas.transformLayer.transformItems.forEach(r=>{e(r.itemContent.texture?r.itemContent.texture.baseTexture:null)}),BFN.CollageMakerHistoryModel.snapshotVOs.forEach(r=>{e(r.backgroundPatternBaseTexture),r.snapshotChildren.forEach(a=>{e(a.texture?a.texture.baseTexture:null)})})}destroyPatternBaseTextures(e=[]){let t=0;return this.menuImageVOs.forEach(r=>{if(r.imageTexture&&r.imageTexture.baseTexture&&!e.includes(r.imageTexture.baseTexture)){r.imageTexture.baseTexture._destroyed||(t+=BFN.Util.getBaseTextureMemoryMB(r.imageTexture.baseTexture));try{r.imageTexture.destroyGC(!0)}catch(a){}r.imageTexture=null}}),t}getMenuImageVO(e,t=!0){if(!e.startsWith("patterns_"))return BeFunky.logError(`Invalid Pattern MenuImageVO ID: ${e}`);let r=this.menuImageVOs.find(s=>s.id===e);if(r||!t)return r;let a=new BFN.MenuImageVO;return a.id=e,a.indexedDBKey=`image__${e}`,a.isPattern=!0,this.menuImageVOs.push(a),a}handleItemDoubleClick(e){let t=e.target;if(t.isPlus&&!BFN.BfnService.userIsPlus){BFN.BfnService.upgrade("COLLAGE","PATTERN_UPGRADE"),BFN.UserActionManager.addUpgradeAction(["Add Plus Pattern"]);return}let{menuImageVO:r}=t;BFN.BfnService.getTexturesForMenuImageVOs([r],{saveAssetsSectionID:"collage"}).then(()=>{!r.imageTexture||(BFN.CollageMakerCanvasPhotoGrid.createHistoryTransition("background_pattern"),BFN.CollageMakerCanvasPhotoGrid.setPatternBackgroundTexture(r.imageTexture),BFN.CollageMakerCanvasPhotoGrid.registerHistoryTransition())})}handleItemDragStarted(e){let t=e.target;BFN.DragScreen.show(t.menuImageVO.thumbURL),BFN.AppModel.viewState===BFN.AppModelViewStates.VIEWING_COLLAGE_MAKER&&!BFN.CollageMakerCanvasPhotoGridModel.freeform&&(BFN.PhotoGrid.awaitingDrop=!0),BFN.TransformModel.awaitingDrop=!0}handleItemDragStopped(e){let t=e.target,r=e.detail.canvasCoordinates;if(t.isPlus&&!BFN.BfnService.userIsPlus){BFN.PhotoGrid.awaitingDrop=!1,BFN.BfnService.upgrade("COLLAGE","PATTERN_UPGRADE"),BFN.UserActionManager.addUpgradeAction(["Add Plus Pattern"]);return}if(!r){BFN.PhotoGrid.awaitingDrop=!1;return}BFN.ImageLibraryManager.addImageToCanvas(t.menuImageVO,{initialCenterPosition:r})}};BFN.SingletonQueue.add(()=>{BFN.CollageMakerPatternManager=new aB});var sB=class{constructor(){this.init()}init(){this.loadedTemplateCategories=[],this.spriteHasLoaded=!1,this.spriteLoadAttempt=0,this.collageLayoutsMenu={},BFN.CollageMakerTemplateModel.addEventListener(BFN.CollageMakerTemplateModelEvents.CURRENT_TEMPLATE_UPDATED.type,()=>{let e="tertiary-grid__item--selected",t=document.querySelectorAll(`.tertiary-grid__item--layout.tertiary-grid__item--${BFN.CollageMakerTemplateModel.currentTemplate.name}`),r=document.querySelectorAll(`.tertiary-grid__item--layout.${e}`);requestAnimationFrame(()=>{r.removeClass(e),t.forEach(a=>a.addClass(e))})})}handleTemplateCategory(){let e=UITools.getToolValue("collage_layouts","updating_id"),t=`collage_layout_${e}_menu`;if(this.loadedTemplateCategories.includes(e))return;this.loadedTemplateCategories.push(e);let r=BFN.CollageMakerTemplateData.templateCategoryVOs.find(({id:s})=>s===e),{templateVOs:a}=r;this.collageLayoutsMenu=BFN.CollageMakerTemplateData.templateCategoryVOs.reduce((s,o)=>(s[`collage_layouts_${o.id}_menu`]={templateObject:o},s),{})}};BFN.SingletonQueue.add(()=>{BFN.CollageMakerTemplateManager=new sB});var{html:wM,setupState:kM,render:AM,lang:zQ,icon:WQ,elem:OM}=BeFunky.lit;function un(){let i=OM`<div class="recent-projects"></div>`,e={isLoggedIn:!1,isLoading:!1,fetchProjectsError:"",projects:[]},t=BeFunky.debounce(()=>AM(s(),i),"raf"),[r,a]=kM(e,t);return BeFunky.LanguageManager.addLanguageUpdateListener(t),BFN.BfnService.addEventListener(BFN.BfnServiceEvents.USER_DATA_CHANGED.type,d),d(),Object.assign(i,{fetchProjects:g}),i;function s(){let{isLoading:v=!1,images:T=[],message:x,emptyState:B,onClickItem:y}=o(),F=224,b=8,S=(F-b)/2;return wM`
        <panel-header class="recent-projects__header" lang-id="recent_projects" modifier="tertiary" buttons="view_all" @VIEW_ALL=${m}></panel-header>
        <div class="scrollable-content">
            <div class="recent-projects__content">
                <image-gallery
                    .images=${T}
                    .isLoading=${v}
                    .message=${x}
                    .onClickItem=${y}
                    .emptyState=${B}
                    .currentWidth=${F}
                    .gutterWidth=${b}
                    .borderWidth=${1}
                    .rowHeight=${S}
                />
            </div>
        </div>`}function o(){return r.isLoggedIn?r.isLoading?l():r.fetchProjectsError?c():r.projects.length?u():h():n()}function n(){return{emptyState:{imageUrl:`${BFN.imagesURL}illustrations/no-projects-sidebar.svg`,text:"login_load_projects",buttonText:"sign_in",buttonAction:p}}}function l(){return{isLoading:!0}}function c(){return{message:{isError:!0,text:BeFunky.failureReason(r.fetchProjectsError),buttonText:"try_again",buttonAction:()=>g()}}}function h(){return{emptyState:{imageUrl:`${BFN.imagesURL}illustrations/no-projects-sidebar.svg`,text:"no_saved_projects",linkText:"learn_more",linkHref:"https://support.befunky.com/hc/en-us/articles/360003279091-How-Do-I-Save-My-Project-So-I-Can-Edit-It-Later-"}}}function u(){return{images:f(r.projects),onClickItem:v=>{let T=v.id.replace(/^befunky_project_/,""),x=r.projects.find(B=>B.id===T);BeFunky.SavedProjectManager.openUserSavedProject(x).catch(B=>{BeFunky.logError("Failed to open recent project",B)})}}}function d(){let v=BeFunky.isLoggedIn(),T=r.isLoggedIn;a({isLoggedIn:v}),v&&!T&&g()}function m(){if(!r.isLoggedIn)return BFN.BfnService.login(()=>BeFunky.SavedProjectManager.openProjectModal());BeFunky.SavedProjectManager.openProjectModal()}function p(){return BFN.BfnService.login()}function g(){a({isLoading:!0}),BFN.SavedProjectService.getFirst100Projects().then(v=>{a({isLoading:!1,fetchProjectsError:"",projects:v.slice(0,10)})}).catch(v=>{a({isLoading:!1,fetchProjectsError:v==="no_results"?"":v,projects:[]})})}function f(){let v=BeFunky.isRetina()?202:101,T={width:v,height:v,fit:"crop",auto:"avif,webp"};return r.projects.map(x=>{x.id=x.templateid;let B=new BFN.MenuImageVO;return B.createId("befunky_project",x.id),B.name=x.filename,B.thumbURL=BeFunky.addParamsToURL(x.thumburl,T),B.thumbWidth=v,B.thumbHeight=v,B.isTransparent=/\.png($|\?)/.test(x.thumburl),B})}}var{html:Cr,setupState:RM,render:LM,lang:VM,elem:UM}=BeFunky.lit;function dn(){let i=UM`<div id="template_preview" class="modal template-preview"></div>`,e={templateID:"",thumbURL:"",imageURL:"",imageWidth:100,imageHeight:100,isTemplatePlus:!1,layout:"STACKED",name:"",dimensions:"",version:void 0,trackSearchTerm:"",prevImageURL:"",nextImageURL:"",onPrev:void 0,onNext:void 0},t={isLoggedIn:BeFunky.isLoggedIn(),isPlus:BFN.BfnService.userIsPlus,imageToRender:"",maxImageSize:[400,400],isFreeTrialEnabled:BeFunky.getFreeTrialEnabled()},r={},a=Object.assign({},e,t),s=BeFunky.debounce(()=>LM(l(),i),"raf"),[o,n]=RM(a,F=>{T(F),s()});return BeFunky.LanguageManager.addLanguageUpdateListener(s),BFN.BfnService.addEventListener(BFN.BfnServiceEvents.USER_DATA_CHANGED.type,u),BeFunky.onFreeTrialEnabledChange(F=>n({isFreeTrialEnabled:F}),!1),Object.assign(i,{open:f,close:v,setState:n}),i;function l(){return o.layout==="STACKED"?h():c()}function c(){let F=o.isTemplatePlus&&!BFN.BfnService.userIsPlus,b=[o.imageToRender?`background-image: url(${o.imageToRender})`:"",`padding-bottom: ${100/(o.imageWidth/o.imageHeight)}%`].filter(Boolean).join("; "),{printSize:S,pixelSize:I}=BFN.DesignerTemplateManager.parseDimensions(o.dimensions);return Cr`
            <div class="template-preview__left-column">
                <div class="template-preview__image-outer">
                    <div class="template-preview__image-inner" style=${`width: ${y()}%`}>
                        <div class="template-preview__image-placeholder" style=${b}></div>
                    </div>
                </div>
            </div>
            <div class="modal__body template-preview__content">
                <div class="template-preview__header">
                    <h3 class="template-preview__name">${o.name}</h3>
                    <p class="template-preview__dimensions">${S?`${I} (${S})`:I}</p>
                </div>
                ${F?Cr`
                <p class="template-preview__description">${B("designer_template_upgrade")}</p>
                <button class="template-preview__button button button--blue button--sm" @click=${m}>${B(o.isFreeTrialEnabled?"start_free_trial":"upgrade")}</button>
                `:Cr`
                <button class="template-preview__button button button--blue button--sm" @click=${p}>${B("use_template")}</button>
                `}
                ${o.isLoggedIn?"":Cr`
                <p class="template-preview__sign-in">
                    ${B("teaser_modal_have_an_account")}
                    <button class="button button--link" @click=${d}>${B("sign_in")}</button>
                </p>
                `}
            </div>
        `}function h(){let F=o.isTemplatePlus&&!BFN.BfnService.userIsPlus,b=[o.imageToRender?`background-image: url(${o.imageToRender})`:"",`padding-bottom: ${100/(o.imageWidth/o.imageHeight)}%`].filter(Boolean).join("; "),{printSize:S,pixelSize:I}=BFN.DesignerTemplateManager.parseDimensions(o.dimensions);return Cr`
        <div class="template-preview__stacked">
            <div class="template-preview__stacked-image">
                <div class="template-preview__image-outer">
                    <div class="template-preview__image-inner" style=${`width: ${y()}%`}>
                        <div class="template-preview__image-placeholder" style=${b}></div>
                    </div>
                </div>
            </div>
            <div class="modal__body template-preview__content">
                <div class="template-preview__header">
                    <h3 class="template-preview__name">${o.name}</h3>
                    <p class="template-preview__dimensions">${S?`${I} (${S})`:I}</p>
                </div>
                ${F?Cr`
                <p class="template-preview__description">${B("designer_template_upgrade")}</p>
                <button class="template-preview__button button button--blue button--sm" @click=${m}>${B(o.isFreeTrialEnabled?"start_free_trial":"upgrade")}</button>
                `:Cr`
                <button class="template-preview__button button button--blue button--sm" @click=${p}>${B("use_template")}</button>
                `}
                ${o.isLoggedIn?"":Cr`
                <p class="template-preview__sign-in">
                    ${B("teaser_modal_have_an_account")}
                    <button class="button button--link" @click=${d}>${B("sign_in")}</button>
                </p>
                `}
            </div>
        </div>
        `}function u(){n({isLoggedIn:BeFunky.isLoggedIn(),isPlus:BFN.BfnService.userIsPlus})}function d(){BeFunky.openLoginPanel("SIGNIN")}function m(){BFN.UserActionManager.addUpgradeAction(["Select Plus Template",BFN.UserActionManager.translateToReadable(o.templateID)]),BFN.BfnService.upgrade("DESIGNER_TEMPLATE",o.templateID.replace(/ /g,"_").toUpperCase(),"designer_templates")}function p(){BFN.BfnService.track("CREATE","DESIGNER_TEMPLATE",o.templateID.replace(" ","_").toUpperCase());let{imageURL:F}=o;return BFN.AppSectionManager.confirmBeforeLoadingNewProject({projectSectionId:"designer",getNewProjectThumbnail:()=>Promise.resolve({image:F})}).then(({answer:b})=>{if(b==="cancel")return;let S={id:o.templateID,name:o.name,version:o.version,isPlusTemplate:o.isTemplatePlus,trackingData:{id:o.templateID,name:o.name,searchTerm:o.trackSearchTerm}};v(),BeFunky.closeModal("template_library",!1),BeFunky.projectToOpenInSection.designer={behavior:b==="confirm"?"load_instead_of_autosave":"load_after_saving_autosave",projectName:o.name,loadProject:()=>BFN.DesignerTemplateManager.applyTemplate(S),getNewProjectThumbnail:()=>Promise.resolve({image:F})},BFN.AppSectionManager.openOrUpdateCurrentSection()})}function g(F){F==="left"?o.onPrev():o.onNext()}function f(){BeFunky.openModal(i,{addCloseButton:!0,onArrowClick:g,onOpen:()=>{let[F,b]=BeFunky.getModal(i.id).arrowButtons;F.disabled=!o.onPrev,b.disabled=!o.onNext},onClose:()=>{n(e)},onWindowResize:x,isFullWidthOnMobile:!0})}function v(){BeFunky.closeModal(i)}function T(F){if(!F.imageURL)return;if(!o.imageURL)return n({imageToRender:""});n({imageToRender:o.thumbURL||o.imageURL}),b(o.imageURL).then(()=>{requestIdleCallback(()=>{n({imageToRender:o.imageURL})})}).catch(()=>{BeFunky.logError("Failed to preload Template preview",o.imageURL)}).then(()=>{[o.nextImageURL,o.prevImageURL].filter(Boolean).map(b)});function b(S){return r[S]===!0?Promise.resolve():(r[S]instanceof Promise||(r[S]=new Promise((I,_)=>{let E=new Image;E.src=S,E.onload=()=>{I(),r[S]=!0},E.onerror=()=>{_(),delete r[S]}})),r[S])}}function x({availableWidth:F,availableHeight:b}){let S=BeFunky.isWiderThanMobile()?944:F,I=400,_=BeFunky.isWiderThanMobile()?688:b,E=Math.min(F,S),D=Math.min(_,Math.max(I,b));i.setStyles({width:`${BeFunky.isWiderThanMobile()?E:F}px`,height:`${BeFunky.isWiderThanMobile()?D:b}px`});let w=BeFunky.isWiderThanMobile()?320:192,N=48,M=t.isLoggedIn?191:300,z=32,W,j={width:o.imageWidth,height:o.imageHeight},J={width:E-N,height:D-N-M-z},ie={width:E-w-N,height:D-N},[re]=BFN.TextureUtils.getScaledDimensions(j,{maxWidth:J.width,maxHeight:J.height}),[he]=BFN.TextureUtils.getScaledDimensions(j,{maxWidth:ie.width,maxHeight:ie.height});BeFunky.isWiderThanMobile()?(W=[ie.width,ie.height],n({layout:"SIDE_BY_SIDE"})):(W=[J.width,J.height],n({layout:"STACKED"})),W.isIdenticalTo(o.maxImageSize)||n({maxImageSize:W})}function B(F){return VM(F,"app")}function y(){if(!o.imageURL)return 100;let F=o.imageWidth/o.imageHeight,b=o.maxImageSize[0]/o.maxImageSize[1];return F>=b?100:100*F/b}}var{html:oB,icon:YQ,lang:nB,elem:lB}=BeFunky.lit;function Ms(i,e,t,r,a,s){let n=s?(s?1600:a)-17*16-24*2:a-64,l={"Facebook & Instagram Stories":r*.9375,"Facebook & Instagram Posts":r*1.16,"Facebook Page Covers":r*1.6,"YouTube Channel Art":r*1.3,"YouTube Thumbnails":r*1.3,"Twitter Headers":r*1.6,Invitations:r*1.2,"Business Cards":r*1.2,Infographics:r*.6666},c=i.map(({title:f,tagID:v,templateData:T})=>m(f,v,T));g(a);let h=lB`<div class="template-editors-choice">${u()}</div>`;return h.updateGalleries=g,h;function u(){return i.map(({title:f,tagID:v,templateData:T},x)=>oB`
            <div class="template-editors-choice__row">
                <div class="template-editors-choice__row-header">
                    <p class="template-editors-choice__row-heading text-sm">${nB(f,"modal")}</p>
                    <button class="button button--link button--sm template-editors-choice__see-all" @click=${()=>e({tagID:v})}>${nB("view_all","modal")}</button>
                </div>
                ${c[x]}
            </div>
        `)}function d(f){return!f.isPlus||BFN.BfnService.userIsPlus?"":oB`
            <div class="badge badge--plus template-editors-choice__badge-plus"></div>
        `}function m(f){let v=l[f]||r,T=a/v;return lB`<image-gallery
            class="template-library__results-gallery"
            .currentWidth=${n}
            .rowHeight=${T}
            .extendItemTemplate=${d}
            .onClickItem=${p}
            .gutterWidth=${8}
            .borderWidth=${1}
            .singleRow=${!0}
        ></image-gallery>`}function p(f){let v,T;i.forEach(({templateData:M})=>{M.find(z=>z.id===f.id)&&(v=M.findIndex(z=>z.id===f.id),T=M)});let{isPlus:x,projectFileName:B,dimensions:y,displayName:F,imageWidth:b,imageHeight:S,imageURL:I,lastRenderedThumb:_,version:E}=f,D=B.replace(".bfd",""),w=v!==0,N=v!==T.length-1;BFN.DesignerTemplateManager.openPreviewModal({templateID:D,thumbURL:_?_.url:I,imageURL:I,imageWidth:b,imageHeight:S,name:F,dimensions:y,trackSearchTerm:"editors_choice",version:E,isTemplatePlus:x,prevImageURL:w&&T[v-1].imageURL,nextImageURL:N&&T[v+1].imageURL,onPrev:w?()=>{p(T[v-1])}:void 0,onNext:N?()=>{p(T[v+1])}:void 0})}function g(){c.forEach((f,v)=>{let T=i[v].templateData;f.images=T,f.currentWidth=s?a:a-64})}}var{html:Ds,render:GM,modalLang:yr,elem:ws,icon:cB}=BeFunky.lit;function ks(i,e){let t={social:[{dimensions:"1024px x 768px",title:"Presentation (4:3)",image:"social-presentation-4x3"},{dimensions:"1920px x 1080px",title:"Presentation (16:9)",image:"social-presentation-16x9"},{dimensions:"1080px x 1920px",title:"Social Media Story",image:"social-social-media-story"},{dimensions:"1080px x 1080px",title:"Instagram Post",image:"social-social-media-post"},{dimensions:"1200px x 1200px",title:"Facebook Post",image:"social-social-media-post"},{dimensions:"1702px x 630px",title:"Facebook Cover",image:"social-facebook-cover"},{dimensions:"1702px x 630px",title:"Facebook Page Cover",image:"social-facebook-cover"},{dimensions:"1920px x 1080px",title:"Facebook Event Cover",image:"social-facebook-event-cover"},{dimensions:"2560px x 1440px",title:"YouTube Channel Art",image:"social-youtube-channel-art"},{dimensions:"1280px x 720px",title:"YouTube Thumbnail",image:"social-youtube-thumbnail"},{dimensions:"1200px x 675px",title:"Twitter Post",image:"social-twittter-post"},{dimensions:"1500px x 500px",title:"Twitter Header",image:"social-twitter-header"},{dimensions:"1000px x 1500px",title:"Pinterest Pin ",image:"social-pinterest-pin"},{dimensions:"3360px x 840px",title:"Etsy Big Banner",image:"social-etsy-big-banner"},{dimensions:"3360px x 448px",title:"Etsy Mini Banner",image:"social-etsy-mini-banner"},{dimensions:"760px x 100px",title:"Etsy Order Receipt Banner",image:"social-etsy-receipt-banner"}],print:[{dimensions:"3300px x 3300px",title:"Square",image:"print-square"},{dimensions:"1050px x 600px",title:"Business Card",image:"print-business-card"},{dimensions:"1500px x 900px",title:"Thank You Card",image:"print-thank-you-card"},{dimensions:"1800px x 1200px",title:"Postcard",image:"print-postcard"},{dimensions:"2100px x 1500px",title:"Greeting Card",image:"print-greeting-card"},{dimensions:"1650px x 2550px",title:"Half Letter",image:"print-half-letter"},{dimensions:"1200px x 2700px",title:"Rack Card",image:"print-rack-card"},{dimensions:"2550px x 3300px",title:"Letter",image:"print-letter"},{dimensions:"2481px x 3507px",title:"A4",image:"print-a4"},{dimensions:"2640px x 4080px",title:"Poster",image:"print-poster"}],ad:[{dimensions:"1200px x 628px",title:"Facebook Ad",image:"ad-facebook"},{dimensions:"120px x 600px",title:"Skyscraper",image:"ad-skyscraper"},{dimensions:"160px x 600px",title:"Wide Skyscraper",image:"ad-wide-skyscraper"},{dimensions:"728px x 90px",title:"Leaderboard",image:"ad-leaderboard"},{dimensions:"728px x 210px",title:"Large Leaderboard",image:"ad-large-leaderboard"},{dimensions:"300px x 250px",title:"Medium Rectangle",image:"ad-medium-rectangle"},{dimensions:"336px x 280px",title:"Large Rectangle",image:"ad-large-rectangle"},{dimensions:"300px x 600px",title:"Half Page",image:"ad-half-page"},{dimensions:"320px x 100px",title:"Large Mobile",image:"ad-large-mobile"}]},r,a,s=ws`<div class="blank-canvas__section ${e?"":"vertical-scroller"}"></div>`,n=["social","print","ad"].map(x=>d(x));m();let l=()=>GM(e?c():h(),s);return l(),BeFunky.LanguageManager.addLanguageUpdateListener(l),s.updateScrubberDimensions=f,s.blankCanvasGalleries=n,s;function c(){return Ds`
            <div class="template-library__left-panel">
                <p class="blank-canvas__custom-heading">${yr("create_your_own_canvas")}</p>
                <div class="control-item-columns blank-canvas__dimensions-scrubber">
                    <div class="control-item">
                        <label class="control-item-label">${yr("width")}</label>
                            ${r}
                    </div>
                    <button class="button button--icon button--white-outline blank-canvas__swap-dimensions" @click="${g}">
                        ${cB("switch-icon","icon icon--18")}
                    </button>
                    <div class="control-item">
                        <label class="control-item-label">${yr("height")}</label>
                            ${a}
                    </div>
                </div>
                <button class="modal__button blank-canvas__button button button--blue" @click="${v}">${yr("create")}</button>
            </div>
            <div class="template-library__right-panel">
                <div class="scrollable-content scrollable-content--modal-right-panel" style=${`--scrollable-content-width: ${i}`}>
                    ${u()}
                </div>
            </div>
        `}function h(){return Ds`
            <div class="blank-canvas__mobile">
                <div class="blank-canvas__mobile-controls">
                    <p class="blank-canvas__custom-heading">${yr("create_your_own_canvas")}</p>
                    <div class="control-item-columns blank-canvas__dimensions-scrubber">
                        <div class="control-item">
                            <label class="control-item-label">${yr("width")}</label>
                            ${r}
                        </div>
                        <button class="button button--icon button--white-outline blank-canvas__swap-dimensions" @click="${g}">
                            ${cB("switch-icon","icon icon--18")}
                        </button>
                        <div class="control-item">
                            <label class="control-item-label">${yr("height")}</label>
                            ${a}
                        </div>
                    </div>
                    <button class="blank-canvas__button button button--blue button--fullwidth" @click="${v}" style="max-width: 336px; margin: 0 auto;">${yr("create")}</button>
                </div>
                <div class="blank-canvas__templates" style="width: ${i}">
                    ${u()}
                </div>
            </div>
        `}function u(){return["social_media","print","online_advertising"].map((B,y)=>Ds`
            <div class="blank-canvas__row-header">
                <p class="bold">${yr(B)}</p>
            </div>
            <div class="blank-canvas__gallery-row">
                ${n[y]}
            </div>
        `)}function d(x){let B=F=>{let{dimensions:b,title:S}=t[x][F.imageIndex],{width:I,height:_}=BFN.DesignerTemplateManager.parseDimensions(b);T(I,_,S)};return ws`<image-gallery
            class=${`image-gallery blank-canvas__gallery blank-canvas__gallery--${x}`}
            .rowHeight=${180}
            .currentWidth=${i}
            .onClickItem=${B}
            .extendItemTemplate=${y}
            .imagePadding=${8}
            .gutterWidth=${8}
            .images=${p(x)}
        ></image-gallery>`;function y(F){let{dimensions:b,title:S}=t[x][F.imageIndex],{pixelSize:I,printSize:_}=BFN.DesignerTemplateManager.parseDimensions(b);return Ds`
            <div class="blank-canvas__template-description">
                <p class="blank-canvas__template-title">${S}</p>
                <p class="blank-canvas__template-dimensions">${_||I}</p>
            </div>
            `}}function m(){r=ws`<scrubber-input id="template_library_custom_template_width"></scrubber-input>`,a=ws`<scrubber-input id="template_library_custom_template_height"></scrubber-input>`,r.unit=a.unit="px",r.minValue=a.minValue=BFN.minImageSize,r.maxValue=a.maxValue=BFN.maxImageSize,r.value=BFN.DesignerModel.projectVO.projectWidth||300,a.value=BFN.DesignerModel.projectVO.projectHeight||300}function p(x){return t[x].map((B,y)=>{let F=new BFN.MenuImageVO;return F.createId("designer_template",B.image),F.thumbURL=`${BFN.imagesURL}app/blank-templates-v2/${B.image}.svg`,F.isSVG=!0,F.isGraphic=!0,F.imageIndex=y,F})}function g(){let x=a.value,B=r.value;r.value=x,a.value=B}function f(x=300,B=300){r.value=x,a.value=B}function v(){T(r.value,a.value)}function T(x,B,y=""){let F=new BFN.ProjectVO;if(F.version=2,F.section="designer",F.projectWidth=x,F.projectHeight=B,F.designerBackgroundColor="FFFFFF",y){let b=S=>S.toLowerCase().replace(/[^a-z0-9]+/g,"_").replace(/(^_+)|(_+$)/g,"");F.sourceTemplateID=`blank_${b(y)}_${x}_${B}`}BFN.AppSectionManager.confirmBeforeLoadingNewProject({projectSectionId:"designer",getNewProjectThumbnail:()=>Promise.resolve({aspectRatio:x/B})}).then(({answer:b})=>{if(b==="cancel")return;let S=`${x} x ${B}`.toUpperCase().replace(/ /g,"_").replace("_X_","x");BFN.BfnService.track("CREATE","DESIGNER_TEMPLATE",`CUSTOM_${S}`),BeFunky.closeModal("template_library");let I=y?{type:"Preset",name:`Blank ${y}`,id:F.sourceTemplateID}:{type:"Custom",name:"Blank Custom"};BeFunky.projectToOpenInSection.designer={behavior:b==="confirm"?"load_instead_of_autosave":"load_after_saving_autosave",projectName:I.name,loadProject:()=>BFN.ProjectManager.loadProject(F,!0,I),getNewProjectThumbnail:()=>Promise.resolve({aspectRatio:x/B})},BFN.AppSectionManager.openOrUpdateCurrentSection()})}}var{html:Mt,setupState:HM,render:XM,modalLang:xa,elem:mn,icon:As}=BeFunky.lit;function pn(i){let e=mn`<div id="template_library" class="modal modal--button-sm template-library"></div>`,t=1600,r=t-17*16-24*2,a={viewBlankCanvas:!1,mode:"EDITORS_CHOICE",lastSearchTerm:"",lastSearchPage:-1,searchTerm:"",tagID:"editors_choice",tagName:"",editorsChoiceTemplates:[],targetAspectRatio:6,currentWidth:t,isWiderThanMobile:BeFunky.isWiderThanMobile(),activeTagSections:[],displayMobileFilters:!1,images:[],isLoading:!1,message:null,emptyState:null,viewport:void 0},s=!0,o=BeFunky.debounce(()=>{XM(BeFunky.isWiderThanMobile()?T():x(),e),he(s),s=!1},"raf"),[n,l]=HM(a,A=>{A.tagID&&Be(),o()}),{recalculateScrollPosition:c,handleScroll:h,setOnScrollCallback:u,scrollTo:d}=BeFunky.handleLitGalleryScroll(),m=()=>{};u(k),BeFunky.LanguageManager.addLanguageUpdateListener(o),BeFunky.onMatchMedia(`(min-width: ${BFN.CSS.desktopAppMinWidth}px)`,({isMatched:A})=>{l({isWiderThanMobile:A})}),le();let[p,g]=W(),f,v;return Object.assign(e,{open:ie}),e;function T(){return Mt`
        <panel-header lang-id="start_a_design" modifier="modal" buttons="close"></panel-header>
        ${b()}
        <div class="modal__body template-library__body">
            ${n.viewBlankCanvas?_():S()}
        </div>
        `}function x(){return Mt`
            ${n.displayMobileFilters?Mt`<panel-header .langId=${"categories"} .modifier=${"modal"} .buttons=${"close"} @CLOSE=${U}></panel-header>`:Mt`<panel-header .modifier=${"modal"} .buttons=${"close"}></panel-header>`}
            ${n.displayMobileFilters?F():B()}
        `}function B(){let A=n.currentWidth-64,X=["template-library__filter-button button button--grey-200 button--md button--icon",n.mode!=="EDITORS_CHOICE"?"button--selected button--grey-outline":""].filter(Boolean).join(" ");return Mt`
            ${b()}
            ${n.viewBlankCanvas?E():Mt`<div class="template-library__mobile-search-options" style="padding: 1rem 2rem">
                ${I()}
                <button class=${X} @click=${U}>
                    ${As("edit-icon","icon icon--18")}
                    ${n.mode!=="EDITORS_CHOICE"?Mt`
                    <span class="count-indicator">1</span>`:""}
                </button>
            </div>
            <div class="vertical-scroller" @scroll=${h} style="padding: 0 2rem; flex-grow: 1">
                ${n.mode==="EDITORS_CHOICE"?y():M(A)}
            </div>`}
        `}function y(){return Ms(n.editorsChoiceTemplates,re,G,n.targetAspectRatio,n.currentWidth,n.isWiderThanMobile)}function F(){return Mt`
        <div class="template-library__mobile-filters vertical-scroller">
            <button class="button button--grey-200 button--left-align button--fullwidth template-library__tag ${n.mode==="EDITORS_CHOICE"?"button--selected":""}" @click=${ne}>${xa("editors_choice")}</button>
            <button class="button button--grey-200 button--left-align button--fullwidth template-library__tag ${n.mode==="ALL_TEMPLATES"?"button--selected":""}" @click=${pe}>${xa("browse_all_templates")}</button>
            ${J().map(A=>Mt`
            <h3 class="text-sm bold">${xa(A.id)}</h3>
            ${A.items.map(X=>{let[Y,ae]=Array.isArray(X)?X:[X,X];return Mt`<button class="button button--grey-200 button--left-align button--fullwidth template-library__tag ${Y===n.tagID?"button--selected":""}" data-tag="${Y}" data-section="${A.id}" @click=${Z}>${G(ae)}</button>`})}
            `)}
        </div>
        `}function b(){return Mt`
        <div class="template-library__tabs">
            <toggle-group id="template-library-view" .buttons=${[{value:!1,langID:"templates"},{value:!0,langID:"blank_canvas"}]} .value="${n.viewBlankCanvas}" @change="${X=>l({viewBlankCanvas:X.target.value})}"></toggle-group>
            <div class="template-library__popover-placeholder"></div>
        </div>
        `}function S(){return Mt`
        <div class="template-library__left-panel">
            ${I()}
            <div class="template-library__buttons">
                <button
                    class="${`button button--grey-200 button--fullwidth template-library__button ${n.mode==="EDITORS_CHOICE"?"button--selected":""}`}"
                    @click="${ne}"
                    >${xa("editors_choice")}
                </button>
                <button
                    class="${`button button--grey-200 button--fullwidth template-library__button ${n.mode==="ALL_TEMPLATES"?"button--selected":""}`}"
                    id="designer_view_all_templates"
                    @click="${pe}"
                    >${xa("browse_all_templates")}
                </button>
            </div>
            ${j()}
        </div>
        ${N()}
        `}function I(){return Mt`
        <form role="search" class="search-box template-library__search-box" @submit=${Ie}>
            ${p}
            ${g}
            <button type="reset" class="button button--icon button--md button--white-outline search-box__clear" @click=${ke}>
                ${As("cancel-icon","icon icon--12")}
            </button>
            <button type="submit" class="button button--icon button--md button--white-outline search-box__submit">
                ${As("search-icon","icon")}
            </button>
        </form>
        `}function _(){return f=f||ks(t-80,n.isWiderThanMobile),f.blankCanvasGalleries.forEach(A=>{A.currentWidth=R()}),f}function E(){return v=v||ks(window.innerWidth,n.isWiderThanMobile),v.blankCanvasGalleries.forEach(A=>{A.currentWidth=window.innerWidth}),v}function D(){let A={EDITORS_CHOICE:"editors_choice",SEARCH:["search_results_for",{query:`<strong>${BeFunky.escapeHTML(n.tagName)}</strong>`}],ALL_TEMPLATES:"all_templates",TAG:BeFunky.escapeHTML(n.tagName)},X=n.mode==="SEARCH";return A[n.mode]||BeFunky.throwError("Mode not handled!!!",n.mode),Mt`
        <div class="template-library__results-header template-library__results-header--left">
            <h3 class="template-library__results-heading text-lg">${xa(A[n.mode])}</h3>
            ${X?w():""}
        </div>
        `}function w(){return Mt`
        <button class="button button--circle button--white-outline button--icon button--xs template-library__clear-results" @click="${ne}" data-tooltip="cancel">
            ${As("cancel-icon","icon icon--10")}
        </button>
        `}function N(){let A=n.currentWidth-17*16-24*2;return Mt`
        <div class="template-library__right-panel">
            ${D()}
            <div class="scrollable-content scrollable-content--modal-right-panel" @scroll=${h} style=${`--scrollable-content-width: ${A}px`}>
            ${n.mode==="EDITORS_CHOICE"?Ms(n.editorsChoiceTemplates,re,G,n.targetAspectRatio,A,n.isWiderThanMobile):M(A)}
            </div>
        </div>`}function M(A){return Mt`<image-gallery
            class="gallery template-library__results-gallery"
            .images=${n.images}
            .message=${n.message}
            .emptyState=${n.emptyState}
            .isLoading=${n.isLoading}
            .onClickItem=${de}
            .rowHeight=${215}
            .gutterWidth=${8}
            .currentWidth=${A}
            .viewport=${n.viewport}
            .debug=${!1}
            .extendItemTemplate=${z}
            .borderWidth=${1}
        ></image-gallery>`}function z(A){return!A.isPlus||BeFunky.isPlus()?"":Mt`<div class="badge badge--plus gallery__badge"></div>`}function W(){let A=i.map(V=>({id:V,label:G(V)})),X=/(^holiday|holiday$|cards?$)/;[].concat(...i.map(V=>{if(V.includes("_and_"))return!1;let K=V.match(X);return K?[V,K[0]]:!1}).filter(Boolean).map(([V,K])=>[K,V.replace(K,"").replace(/(^_|_$)/g,"")])).unique().filter(V=>!i.includes(V)).forEach(V=>{A.push({id:V,label:G(V)})}),A.sort((V,K)=>{let ee=V.id.length-K.id.length;return ee>0?1:ee<0||V.id.charAt(0)<K.id.charAt(0)?-1:1});let Y=/^id=([a-z0-9_.]+)$/,ae=mn`<input type="search" id="template_library_search" class="input template-library__search-input search-box__input" required>`;ae.setLang("search_templates","modal");let H=mn`<div class="template-library__search-autocomplete"></div>`;return BFN.UI.autocomplete(H,{inputElement:ae,minValueLength:3,options:A,generateItem:V=>{let K=V.trim().match(Y);return K?{html:`Template ID = ${K[1]}`,index:0}:{html:BeFunky.LanguageManager.getStringReplacements("search_for",{query:BeFunky.escapeHTML(V)},"modal"),index:0}},onSelect:({id:V,label:K})=>{re({tagID:V,tagName:K})}}),[ae,H]}function j(){let A=J().reduce((X,{id:Y,items:ae})=>Si(It({},X),{[Y]:()=>ae.map(H=>{let[V,K]=Array.isArray(H)?H:[H,H],ee=["button button--grey-200 button--fullwidth template-library__tag",V===n.tagID?"button--selected":""].filter(Boolean).join(" ");return Mt`
                <button class=${ee} data-tag="${V}" data-section="${Y}">
                    ${G(K)}
                </button>`})}),{});return Mt`
        <accordion-layout
            class="template-library__tags"
            .sections=${A}
            .activeSections=${n.activeTagSections}
            @click=${Z}
            @toggle=${X=>{l({activeTagSections:X.detail})}}
        ></accordion-layout>
        `}function J(){return[{id:"social_media",items:[["social_media","all_social_media"],"instagram_posts","instagram_stories","facebook_covers","facebook_page_covers","facebook_event_covers","facebook_stories","facebook_posts","twitter_headers","twitter_posts","youtube_thumbnails","youtube_channel_art","pinterest_graphics","etsy_big_banners","etsy_mini_banners","etsy_order_receipt_banners","blog_images"]},{id:"business_marketing",items:[["business_marketing","all_business_marketing"],"business_cards","posters","flyers","brochures","postcards","letterhead","menus"]},{id:"online_advertising",items:[["online_advertising","all_online_advertising"],"facebook_ads","skyscrapers","leaderboards","medium_rectangles","large_rectangles","half_pages","large_mobile"]},{id:"events_and_cards",items:[["events_and_cards","all_events_and_cards"],["invitations","all_invitations"],["greeting_cards","all_cards"],"birthdays","wedding_sets","valentines_day","mothers_day","winter_holiday"]}]}function ie(A){if(!window.isAppOpen){BeFunky.logError("Not opening template library on site");return}BeFunky.openModal(e,{onOpen:()=>{A||s&&(A="editors_choice");let X=A==="blank_canvas";l({viewBlankCanvas:X}),A&&!X&&re({tagID:A})},isFullWidthOnMobile:!0,onWindowResize:({availableWidth:X})=>{let Y=r+(X-t),ae=BFN.CSS.desktopAppMinWidth-64,H=n.isWiderThanMobile?6*Y/r:4*X/ae;l({currentWidth:X,targetAspectRatio:H}),c()},size:"xxl",closeOnEscape:()=>{let X=document.activeElement;return X.id==="template_library_search"?(X.value?X.value="":X.blur(),!1):p.contains(X)?(X.value="",X.focus(),!1):!0}})}function re({tagID:A="",tagName:X="",page:Y=1,fetchAllTags:ae=!1}){if(A||(A=L(X)),A=i.includes(A)?A:"",X=G(A)||X,!A&&!X)throw new Error("Invalid tag name or ID");if(A==="editors_choice")return ne();let H=A||X,V=100;if(H===n.lastSearchTerm&&Y===n.lastSearchPage||H.length<=2)return;let K=/^id=([a-z0-9_.]+)$/,ee=H.match(K),se=ee?ee[1]:void 0,ge="SEARCH";A&&(ge="TAG"),ae&&(ge="ALL_TEMPLATES"),l({mode:ge,tagName:X,tagID:A,searchTerm:H,lastSearchTerm:H,lastSearchPage:Y,images:Y===1?[]:n.images,message:null,isLoading:!0}),p.value=ae?"":X;let Ce=Y===1&&!se;Y===1&&d(0);let Ne=()=>H!==n.lastSearchTerm||Y!==n.lastSearchPage;(se?BFN.DesignerTemplateService.getTemplate(se).then(ze=>[ze]):BFN.DesignerTemplateService.getTemplates(H,Y,V,ae)).then(ze=>{if(Ne())return;let C=BFN.DesignerTemplateService.templateObjectsToMenuImageVOs(ze),P=Y;l({isLoading:!1,images:[...n.images,...C]}),requestAnimationFrame(()=>c()),Ce&&BFN.BfnService.track("TEMPLATES","SEARCH",H),m=()=>{C.length<V||(console.log("Load next page of results",A,P+1),re({tagID:A,tagName:X,page:++P,fetchAllTags:ae}))}},ze=>{Ne()||(BeFunky.logError("Unable to fetch templates",ze),ze==="no_results"?(l({isLoading:!1,emptyState:{imageUrl:`${BFN.imagesURL}illustrations/no-search-results-canvas.svg`,text:["no_results_for",{query:`"<strong>${BeFunky.escapeHTML(n.searchTerm)}</strong>"`}]}}),Ce&&BFN.BfnService.track("TEMPLATES","EMPTY_SEARCH",H)):l({isLoading:!1,message:{isError:!0,text:BeFunky.failureReason(ze),buttonText:"try_again",buttonAction:()=>re({tagID:A,tagName:X,fetchAllTags:ae})},lastSearchTerm:""}))})}function he(A){A&&(requestAnimationFrame(()=>{!BeFunky.isAndroid&&!n.viewBlankCanvas&&n.mode==="EDITORS_CHOICE"&&(p.focus(),g.hide())}),BFN.HelpClueManager.show("template_library",{renderOptions:{positionFactor:.155,side:"top",zIndex:"1",container:()=>document.querySelector(".template-library__popover-placeholder")}}))}function ne(){l({mode:"EDITORS_CHOICE",tagID:"editors_choice",lastSearchTerm:""}),p.value="",!n.editorsChoiceTemplates.length&&le()}function le(){BFN.DesignerTemplateService.getEditorsChoiceTemplates().then(A=>{let X=A.map(({tag:Y,items:ae,title:H})=>({tagID:Y,title:H,templateData:BFN.DesignerTemplateService.templateObjectsToMenuImageVOs(ae)}));l({editorsChoiceTemplates:X})})}function Be(){if(!n.tagID)return;let A=J().find(X=>X.items.find(Y=>Y===n.tagID||Y[0]===n.tagID));A&&!n.activeTagSections.includes(A.id)&&l({activeTagSections:[...n.activeTagSections,A.id]})}function _e(){let{deepLinkTagID:A,deepLinkTemplateRoute:X}=BFN.DeepLinkManager.getDesignerDeepLinkData();return n.mode==="TAG"&&n.tagID===A&&X?X:n.lastSearchTerm}function pe(){re({tagID:"",tagName:BeFunky.LanguageManager.getString("all_templates","modal"),fetchAllTags:!0})}function Ie(A){A&&A.preventDefault();let X=p.value.replace(/[`~!@#$%^&*()_|+=?;:'",.<>{}[\]\\/]/gi," ").replace(/ {2,}/g," ").trim();X.length<3||re({tagName:X})}function ke(){n.isWiderThanMobile||l({mode:"EDITORS_CHOICE",tagID:"editors_choice",lastSearchTerm:""})}function de(A,{renderedImageURL:X}={}){let Y=A.id.replace("designer_template_",""),{version:ae,dimensions:H,displayName:V,imageURL:K,imageWidth:ee,imageHeight:se,isPlus:ge,lastRenderedThumb:Ce}=A,Ne=n.images.findIndex(({id:P})=>P===A.id),Ge=C(n.images,Ne,-1),ze=C(n.images,Ne,1);return BFN.DesignerTemplateManager.openPreviewModal({templateID:Y,thumbURL:X||(Ce?Ce.url:K),imageURL:K,imageWidth:ee,imageHeight:se,isTemplatePlus:ge,name:V,dimensions:H,version:ae,trackSearchTerm:_e(),prevImageURL:Ge&&Ge.imageURL,nextImageURL:ze&&ze.imageURL,onPrev:Ge?()=>{de(Ge)}:void 0,onNext:ze?()=>{de(ze)}:void 0}),!1;function C(P,$,q){for(;P[$+q];){let oe=P[$+q];if(!oe.isBlank)return oe;$+=q}}}function Z(A){A.target.nodeName!=="BUTTON"||!A.target.hasAttribute("data-tag")||re({tagID:A.target.getAttribute("data-tag")})}function U(A){A.stopPropagation(),l({displayMobileFilters:!n.displayMobileFilters})}function k({scrollHeight:A,offsetHeight:X,scrollTop:Y}){if(n.mode==="EDITORS_CHOICE"||!n.images.length||(l({viewport:[Y,Y+X]}),n.isLoading))return;let ae=800;A-X-Y<=ae&&m()}function G(A){return A.split("_").map(X).join(" ").replace("s Day","'s Day").replace("St ","St. ").replace("Youtube","YouTube");function X(Y,ae){return ae===0||Y.length>2&&Y!=="the"||Y==="my"?Y.charAt(0).toUpperCase()+Y.slice(1):Y}}function L(A){return A.trim().replace(/[^a-z0-9\s]/gi,"").split(/\s+/).map(X=>X.toLowerCase()).join("_").replace(/_+/g,"_")}function R(){return n.currentWidth-17*16-24*2}}var hB=class{constructor(){this.init()}init(){this.initDefaultValues()}initDefaultValues(){this.isDataLoaded=!1,this.loadedTemplateCategories=[],this.selectedTemplateButton=null,document.addEventListener("keyup",this.handleKeyUp)}handleOpen(){let e=UITools.getToolValue("designer_open","updating_id");e==="blank_canvas"?this.openModal("blank_canvas"):e==="template"&&this.openModal()}preloadTags(){let{tags:e}=BFN.DesignerTemplateService;Array.isArray(e)&&e.length||BFN.DesignerTemplateService.getTags().catch(t=>{t!=="request_failed"&&BeFunky.throwError("Unable to preload tags")})}openPreviewModal(e){this.previewModalComponent||(this.previewModalComponent=dn()),this.previewModalComponent.setState(e),this.previewModalComponent.open()}getTemplateImages({id:e,dimensions:t,version:r,isRetina:a}){let s=this.parseDimensions(t);if(!s)return BeFunky.throwError(`Template ${e} has invalid dimensions string`),{};let{width:o,height:n}=s,l,c,h,u=a?1.75:1,d=300*u,m=Math.max(200,Math.min(d,n)),p=o*(m/n),g=B(e,{height:m,version:r}),f=Math.round(600*u),v=Math.round(600*u),T=o/f,x=n/v;if(T<=1&&x<=1){let b=480;o<b&&n<b?o>n?(l=b,c=Math.floor(n*(b/o))):(l=Math.floor(o*480/n),c=b):(l=o,c=n),h=B(e,{width:l,version:r})}else T>x?(l=f,c=Math.floor(n/T),h=B(e,{width:f,version:r})):(l=Math.floor(o/x),c=v,h=B(e,{height:v,version:r}));return{thumbWidth:p,thumbHeight:m,thumbURL:g,imageWidth:l,imageHeight:c,imageURL:h,getImageURL:b=>y(e,b*(BeFunky.isRetina()?1.75:1))};function B(b,S={}){let I=`${BFN.designerTemplatePreviewsUrl}${b}_preview.jpg`;S.auto="webp",typeof S.version=="number"&&(S.nocache=S.version,delete S.version);let _=Object.entries(S).map(([E,D])=>`${E}=${encodeURIComponent(D)}`).join("&");return`${I}?${_}`}function y(b,S){let I=`${BFN.designerTemplatePreviewsUrl}${b}_preview.jpg`,_={auto:"avif,webp",width:F(S)};return typeof r=="number"&&(_.nocache=r),BeFunky.addParamsToURL(I,_)}function F(b){return Math.ceil(b/20)*20}}openModal(e){if(this.modal)return this.modal.open(e);BFN.DesignerTemplateService.getTags().then(t=>{this.modal||(this.modal=pn(t)),this.modal.open(e)},t=>BeFunky.logError("Unable to fetch tags before opening Designer Template Search modal",t))}async applyTemplate({id:e,version:t,isPlusTemplate:r,name:a="BeFunky-project",trackingData:s=null}){let o=`${BFN.designerSourceTemplateURL}${e}.bfd`;typeof t=="number"&&(o+=`?nocache=${t}`);let n=await BFN.SavedProjectService.fetchBFD(o),l=await BFN.ParseBFD.objectToProjectVO(n);if(l.sourceTemplateID=e,l.filename=a,l.isPlusTemplate=r,!l.printDPI){let c=this.parseDimensions([l.projectWidth,l.projectHeight]);l.printDPI=c?c.dpi:300}return BFN.ProjectManager.loadProject(l,!0,s)}async loadTemplateForTesting(e){console.log("Testing > Designer template:",e);let{version:t}=await BFN.DesignerTemplateService.getTemplate(e);return this.applyTemplate({id:e,version:t})}openDeepLinkTemplatePreview(e,t){BFN.AppModel.viewingDesigner||BeFunky.throwError("Template preview requested while not in Designer"),BFN.DesignerTemplateService.getTemplate(e).then(r=>{let{displayName:a,dimensions:s,isPlus:o,version:n,imageURL:l,imageWidth:c,imageHeight:h}=BFN.DesignerTemplateService.templateObjectsToMenuImageVOs([r])[0];this.openPreviewModal({templateID:e,imageURL:l,imageWidth:c,imageHeight:h,isTemplatePlus:o,name:a,dimensions:s,version:n,trackSearchTerm:`Deep Link: ${t}`})},r=>BeFunky.throwError(`Unable to get template ${e} by ID`,r))}parseDimensions(e){let t,r;if(typeof e=="string"){let o=/(\d+)px x (\d+)px/,n=e.match(o);if(!n)return!1;[,t,r]=n.map(l=>parseInt(l))}else Array.isArray(e)&&([t,r]=e);if(![t,r].every(o=>o&&typeof o=="number"))return!1;let s={"3300,3300":{size:'11 \xD7 11"',name:"Square"},"1050,600":{size:'3.5 \xD7 2"',name:"Business Card"},"1500,900":{size:'5 \xD7 3"',name:"Thank You Card"},"1800,1200":{size:'6 \xD7 4"',name:"Postcard"},"1500,2100":{size:'5 \xD7 7"',name:"Greeting Card"},"2100,1500":{size:'7 \xD7 5"',name:"Greeting Card"},"1650,1260":{size:'5.5 \xD7 4.2"',name:"Postcard"},"1650,2550":{size:'5.5 \xD7 8.5"',name:"Half Letter"},"1200,2700":{size:'4 \xD7 9"',name:"Rack Card"},"2550,3300":{size:'8.5 \xD7 11"',name:"Letter"},"3300,2550":{size:'11 \xD7 8.5"',name:"Letter"},"2481,3507":{size:"21 \xD7 29.7cm",name:"A4"},"2640,4080":{size:'11 \xD7 17"',name:"Poster",dpi:240}}[`${t},${r}`]||{};return{width:t,height:r,pixelSize:`${t} \xD7 ${r}px`,printSize:s.size,printName:s.name,storedSize:`${t}px x ${r}px`,dpi:s.dpi||300}}handleKeyUp(e){if(!BFN.AppModel.viewingDesigner)return;function t(r){r&&BeFunky.logError(r)}e.which===69&&e.ctrlKey&&e.shiftKey&&BFN.ProjectManager.requestLocalSave({isLazy:!1}).then(()=>BFN.ProjectService.getLocalProject("designer")).then(r=>{r.filename=r.sourceTemplateID||"unknown_template",BFN.UploadSaveShareManager.saveProjectToComputer(r,t)}).catch(t)}};BFN.SingletonQueue.add(()=>{BFN.DesignerTemplateManager=new hB});var uB=class{constructor(){this.init()}init(){this.initDefaultValues(),!!function(){let t=document.createElement("div");return"draggable"in t||"ondragstart"in t&&"ondrop"in t}()&&window.addEventListener("INIT_COMPLETE",this.initDragDropAreas.bind(this))}initDefaultValues(){this.fontExtensions=["dfont","eot","otc","otf","svg","ttc","ttf","woff","woff2"]}initDragDropAreas(){["drag","dragstart","dragend","dragover","dragenter","dragleave","drop"].forEach(s=>BFN.appContainer.addEventListener(s,o=>{o.target.draggable||(o.preventDefault(),o.stopPropagation())})),this.dragDropAreas=[{visibleElem:document.getElementById("canvas_drag_drop_area"),listeningElem:BFN.Stage.view,isActive:!1,handler:this.handleCanvasDrop.bind(this)},{visibleElem:document.getElementById("batch_processing_drag_drop_area"),listeningElem:document.getElementById("batch_processing_images_scroll_container"),isActive:!1,handler:this.handleBatchProcessingDrop.bind(this)},{visibleElem:document.getElementById("watermark_upload_drop_area"),listeningElem:document.getElementById("watermark_upload"),isActive:!1,handler:this.handleWatermarkUploadDrop.bind(this)}];let t=s=>{if(BFN.isSortableListDragActive)return;let o=this.dragDropAreas.find(l=>!l.isActive&&l.listeningElem.contains(s.target));if(!o)return;o.isActive=!0;let n=o.activeClass||"drag-drop-area--active";o.listeningElem.addClass("drag-drop-listener"),o.visibleElem.id==="canvas_drag_drop_area"?(document.getElementById("appViewport").addClass("show-drag-drop-area--dragging"),BeFunky.wait(["raf","raf"],()=>{o.isActive&&(o.visibleElem.addClass(n),BFN.TransformGuides.visible&&o.visibleElem.addClass("drag-drop-area--canvas-guides"))})):o.visibleElem.addClass(n)},r=s=>{if(BFN.isSortableListDragActive)return;let o=this.dragDropAreas.find(l=>l.isActive&&s.target===l.listeningElem);if(!o)return;o.isActive=!1;let n=o.activeClass||"drag-drop-area--active";o.visibleElem.removeClass(n),o.listeningElem.removeClass("drag-drop-listener"),o.visibleElem.id==="canvas_drag_drop_area"&&setTimeout(()=>{o.isActive||(document.getElementById("appViewport").removeClass("show-drag-drop-area--dragging"),o.visibleElem.removeClass("drag-drop-area--canvas-guides"))},300)},a=s=>{let o;try{o=[...s.dataTransfer.files]}catch(l){BeFunky.throwError(l,{event:s})}if(!o||!o.length)return;o.forEach(l=>{l.extension=BFN.getExtension(l.name)});let n=this.dragDropAreas.find(({listeningElem:l})=>l===s.target);!n||n.handler(o,s)};BFN.appContainer.addEventListener("dragenter",t),BFN.appContainer.addEventListener("dragover",t),BFN.appContainer.addEventListener("dragleave",r),BFN.appContainer.addEventListener("dragend",r),BFN.appContainer.addEventListener("drop",r),BFN.appContainer.addEventListener("drop",a)}handleCanvasDrop(e,t){if(BFN.TransformModel.selectedTransformItem){let a=BFN.AppModel.sectionValue(BFN.PhotoEditorCanvas,BFN.CollageMakerCanvas,BFN.DesignerCanvas);a&&a.transformLayer&&a.transformLayer.deselectItem()}let r=e[0];if(r.extension==="bfd")return this.handleBFD(r);if(BFN.MultipleFileUploader.supportedImages.includes(r.extension)){BFN.AppModel.viewingEditor?this.handleEditorImage(r):BFN.AppModel.viewingCollage?this.handleCollageImage(r,t):this.handleDesignerImage(r,t);return}return e.some(a=>this.fontExtensions.includes(a.extension))?BFN.FontManager.handleUserFontFiles(e):BeFunky.logError("Unsupported file type:",r.name)}handleBatchProcessingDrop(e){let t=e.filter(r=>/^image\/+/.test(r.type)&&!r.type.includes("svg"));!t.length||this.handleBatchProcessingImages(t)}handleWatermarkUploadDrop(e){if(!e.filter(a=>/^image\/+/.test(a.type)&&!a.type.includes("svg")).length)return;let r=e[0];this.handleWatermarkImage(r)}handleBFD(e){let t={files:[e],createMenuImageVO:!1};BFN.MultipleFileUploader.upload(({file:r})=>{!r||BFN.ProjectManager.loadFile(r)},t)}handleBatchProcessingImages(e){BFN.BatchProcessingManager.loadImages(e)}handleWatermarkImage(e){BFN.WatermarkManager.uploadWatermark(e)}handleEditorImage(e){let t=BFN.PhotoEditorModel.onEditorImageUpload.bind(BFN.PhotoEditorModel),r={files:[e],createMenuImageVO:!1};BFN.PhotoEditorModel.confirmEditorLoadImage(()=>BFN.MultipleFileUploader.upload(t,r))}handleCollageImage(e,t){let r={files:[e],keepImageTexture:!0},a={initialCenterPosition:BFN.getCanvasCoordinates(t.clientX,t.clientY,BFN.CollageMakerCanvas),hasTexture:!0};BFN.ImageLibraryManager.uploadImages(({menuImageVO:s})=>{!s||(BFN.AppModel.viewingCollage&&!BFN.CollageMakerCanvasPhotoGridModel.freeform&&(BFN.PhotoGrid.awaitingDrop=!0),BFN.ImageLibraryManager.addImageToCanvas(s,a))},r)}handleDesignerImage(e,t){let r={files:[e],keepImageTexture:!0},a={initialCenterPosition:BFN.getCanvasCoordinates(t.clientX,t.clientY,BFN.DesignerCanvas),hasTexture:!0};BFN.ImageLibraryManager.uploadImages(({menuImageVO:s})=>{s&&BFN.ImageLibraryManager.addImageToCanvas(s,a)},r)}};BFN.SingletonQueue.add(()=>{BFN.DragAndDropManager=new uB});var dB=class{constructor(){this.loadDropboxAPIPromise=null}loadDropbox(){if(this.loadDropboxAPIPromise)return this.loadDropboxAPIPromise;let e="https://www.dropbox.com/static/api/2/dropins.js",t=r=>{r.id="dropboxjs",r.setAttribute("data-app-key","xcse408r9ipxqtk")};return this.loadDropboxAPIPromise=BeFunky.loadScript(e,()=>window.Dropbox,t).catch(r=>{this.loadDropboxAPIPromise=null;let a=document.getElementById("dropboxjs");throw a.parentElement.removeChild(a),r}),this.loadDropboxAPIPromise}async chooseImage(){return await BeFunky.withLoadScreen(this.loadDropbox()),new Promise((e,t)=>{BeFunky.openPopupWithBlockingWorkaround(["browser_block_social_login",{provider:"Dropbox"}],r=>{document.body.addClass("prevent-body-scroll");let a={success(s){if(document.body.removeClass("prevent-body-scroll"),r(),!s[0]||!s[0].link)return BeFunky.reportWarning("Unexpected response from Dropbox",s),t("unexpected_dropbox_response");let o=!1;BeFunky.showLoadScreen({message:"downloading",onCancel:()=>{o=!0,t("cancelled_by_user")}});let{link:n,name:l}=s[0];BFN.RequestUtils.getBlob(n,({blob:c,error:h})=>{o||(BeFunky.hideLoadScreen(),c?e({blob:c,filename:l}):t(h))})},cancel(){document.body.removeClass("prevent-body-scroll"),r(),t("cancelled_by_user")},linkType:"direct",multiselect:!1,extensions:BFN.MultipleFileUploader.supportedImages.map(s=>`.${s}`)};Dropbox.choose(a)})})}async saveImage(e,t){if(t=BFN.UploadSaveShareManager.getValidFilename(t,e),await BeFunky.withLoadScreen(this.loadDropbox()),!Dropbox.isBrowserSupported())throw"browser_not_supported";let r={message:"uploading"},{url:a}=await BeFunky.withLoadScreen(BeFunky.uploadFileToS3(e,{bucket:"artsyupload",contentType:e.type||"image/jpeg"}),!0,r);return new Promise((s,o)=>{let n=()=>{};BeFunky.showLoadScreen({message:"saving",onCancel:()=>{n(),o("cancelled_by_user")}}),BeFunky.openPopupWithBlockingWorkaround(["browser_block_social_login",{provider:"Dropbox"}],(l,c)=>{n=()=>{BeFunky.hideLoadScreen(),l()};try{Dropbox.save(a,t,{success(){n(),s()},cancel(){n(),o("cancelled_by_user",c)},error(h){n(),o(h)}})}catch(h){if(!c)return;n(),o(h)}})})}};BFN.SingletonQueue.add(()=>{BFN.DropboxManager=new dB});var mB=class{constructor(){this.init()}init(){BeFunky.log("SVGManager Init"),this.initDefaultValues(),this.initFabricStaticCanvas()}initDefaultValues(){this.processing=!1,this.shapeObjects=null,this.svgData=null,this.callback=null,this.queuedShapeObjects=null,this.combinedSVGKey=null,this.cachedCombinedSVGs={},this.cachedCombinedShapes={},this.updatingTexture=null,this.updatingShape=null,this.idleCanvasSize=16,this.svgContainer=document.createElement("div"),this.svgContainer.id="svg_measurement",BFN.appContainer.appendChild(this.svgContainer)}initFabricStaticCanvas(){setTimeout(()=>{this.fabricStaticCanvasElement=document.createElement("canvas"),this.fabricStaticCanvasElement.width=this.idleCanvasSize,this.fabricStaticCanvasElement.height=this.idleCanvasSize,this.debugFabricCanvas=!1,this.debugFabricCanvas&&(this.fabricStaticCanvasElement.setStyles({zIndex:1e11,pointerEvents:"none",background:"rgba(175,175,255,.4)",position:"absolute",left:"320px",top:"55px",display:"block"}),BFN.appContainer.appendChild(this.fabricStaticCanvasElement)),fabric.Object.NUM_FRACTION_DIGITS=10,this.fabricStaticCanvas=new fabric.StaticCanvas(this.fabricStaticCanvasElement,{enableRetinaScaling:!1}),this.fabricStaticCanvas.renderOnAddRemove=!1,this.fabricStaticCanvas.renderAll()},0)}sanitizeSVG(e){if(typeof e!="string")return"";this.svgContainer.innerHTML=e;let t=this.svgContainer.firstElementChild;if(typeof t.getBBox!="function")return"";let r=["x","y","width","height","viewBox"].reduce((d,m)=>(d[m]=t.getAttribute(m),d),{});t.removeAttribute("x"),t.removeAttribute("y"),t.removeAttribute("viewBox"),[...t.querySelectorAll("image")].forEach(d=>{d.hasAttribute("xlink:href")&&!d.getAttribute("xlink:href").startsWith("data:")&&(BeFunky.logError("Removed externally-linked image tag in SVG"),d.parentElement.removeChild(d))});let a=0,s=["altGlyph","circle","ellipse","path","polygon","polyline","rect","text","textPath","tref","tspan"];[...t.querySelectorAll(s.join(","))].forEach(d=>{if(d.hasAttribute("stroke-width")){a=Math.max(a,parseInt(d.getAttribute("stroke-width"))||0);return}let m=parseInt(getComputedStyle(d).strokeWidth)||0;if(!m)return;a=Math.max(a,m);let p=d.getAttribute("style");p&&p.includes("stroke-width")||d.setAttribute("stroke-width",m)});let o=d=>Math.round(d*100)/100,{x:n,y:l,width:c,height:h}=t.getBBox();return BeFunky.isFirefox&&n<-1e4&&(BeFunky.logError("Not trusting Firefox getBBox for SVG",{x:n,y:l,width:c,height:h}),n=parseFloat(r.x)||0,l=parseFloat(r.y)||0,c=parseFloat(r.width)||parseFloat(r.viewBox.split(" ")[2]),h=parseFloat(r.height)||parseFloat(r.viewBox.split(" ")[3]),console.log("Using these values instead:",{x:n,y:l,width:c,height:h})),t.setAttribute("viewBox",`${o(n-a/2)} ${o(l-a/2)} ${o(c+a)} ${o(h+a)}`),BeFunky.isFirefox&&(t.setAttribute("width",c),t.setAttribute("height",h)),[...t.querySelectorAll("style")].forEach(d=>{d.textContent||(BeFunky.logError("Removing empty style tag from SVG"),d.parentElement.removeChild(d))}),e=new XMLSerializer().serializeToString(t),this.svgContainer.innerHTML="",e=e.replace(/>\s+</g,"><"),e}createDataURI(e){if(typeof e!="string")return"";let t={whitespace:/\s+/g,urlHexPairs:/%[\dA-F]{2}/g};function r(n){return n.trim().replace(t.whitespace," ")}function a(n){return encodeURIComponent(n).replace(t.urlHexPairs,s)}function s(n){switch(n){case"%20":return" ";case"%3D":return"=";case"%3A":return":";case"%2F":return"/";default:return n.toLowerCase()}}e.charCodeAt(0)===65279&&(e=e.slice(1));let o=r(e);return`data:image/svg+xml,${a(o)}`}clearCache(){for(let e in this.cachedCombinedSVGs)this.cachedCombinedSVGs[e]=null,delete this.cachedCombinedSVGs[e];for(let e in this.cachedCombinedShapes)this.cachedCombinedShapes[e]=null,delete this.cachedCombinedShapes[e]}combineSVGs(e,t,r,a=!1,s=!1){if(this.processing)BeFunky.logError("Already Processing - BFN.SVGManager.combineSVGs()");else{if(this.combinedSVGKey=null,e.length){this.combinedSVGKey="";for(let o=0;o<e.length;o++){let n=e[o];this.combinedSVGKey+=`${o?"_":""}${n.svgID}_${n.scaleX.toString()}${n.scaleY.toString()}${n.x.toString()}${n.y.toString()}${n.rotation.toString()}${n.alpha.toString()}`}}if(this.combinedSVGKey=this.combinedSVGKey?`template_svg_${BeFunky.hash(this.combinedSVGKey).toString(36)}`:null,this.combinedSVGKey&&this.cachedCombinedSVGs.hasOwnProperty(this.combinedSVGKey))r(this.combinedSVGKey,this.cachedCombinedSVGs[this.combinedSVGKey]);else{this.processing=!0,this.shapeObjects=e,this.svgData=t,this.callback=r,this.makeWhite=a,this.resetCoords=s,this.queuedShapeObjects=[];for(let o=0;o<this.shapeObjects.length;o++)this.queuedShapeObjects.push(this.shapeObjects[o]);this.processShapeObjectQueue()}}}processShapeObjectQueue(){if(this.queuedShapeObjects&&this.queuedShapeObjects.length){let e=this.queuedShapeObjects.shift();this.svgData.hasOwnProperty(e.svgID)?(e.svgData=this.svgData[e.svgID],this.getSVGShape(e.svgData,t=>{e.svgShape=t,this.processShapeObjectQueue()})):this.processShapeObjectQueue()}else this.createCombinedSVG()}createCombinedSVG(){let e=[],t={};for(let s=0;s<this.shapeObjects.length;s++){let o=this.shapeObjects[s];if(o.svgID&&o.svgShape){let n=o.svgShape,l=`shape_${s+1}`;n.id=l,n.scaleX=o.scaleX,n.scaleY=o.scaleY,n.left=o.x,n.top=o.y,n.angle=o.rotation*(180/Math.PI),n.opacity=o.alpha,e.push(n),t[l]=n}}this.clearCanvas();let r=null;if(e.length){let s=new fabric.Group(e);this.resetCoords&&(s.left=0,s.top=0);let o=s.left,n=s.width,l=s.top,c=s.height;this.fabricStaticCanvasElement.width=Math.round(o+n),this.fabricStaticCanvasElement.height=Math.round(l+c),this.fabricStaticCanvasElement.setStyles({width:`${this.fabricStaticCanvasElement.width}px`,height:`${this.fabricStaticCanvasElement.height}px`}),this.fabricStaticCanvas.width=this.fabricStaticCanvasElement.width,this.fabricStaticCanvas.height=this.fabricStaticCanvasElement.height,this.fabricStaticCanvas.add(s),this.fabricStaticCanvas.renderAll();let h=new DOMParser,u=new XMLSerializer;r=this.fabricStaticCanvas.toSVG({suppressPreamble:!0,width:n,height:c,viewBox:{x:0,y:0,width:n,height:c}},d=>{let p=h.parseFromString(`<svg xmlns="http://www.w3.org/2000/svg">${d}</svg>`,"image/svg+xml").documentElement.firstElementChild,g=p.getAttribute("id");if(g&&g in t){let f=t[g];if(p.style.opacity=f.opacity,this.makeWhite){p.style.fill="rgb(255,255,255)";let v=p.getElementsByTagName("*");for(let T=0;T<v.length;T++)v[T].style.fill="rgb(255,255,255)"}return u.serializeToString(p).replace('xmlns="http://www.w3.org/2000/svg"',"")}return d}),r=r.replace(/\n?<desc>[^>]+>/,"").replace(/\n?<defs>[^>]+>/,""),this.resetCanvas(),e.splice(0),e=null}else this.combinedSVGKey=null;let{callback:a}=this;this.processing=!1,this.shapeObjects=null,this.svgData=null,this.callback=null,this.queuedShapeObjects=null,this.combinedSVGKey&&!this.cachedCombinedSVGs.hasOwnProperty(this.combinedSVGKey)&&(this.cachedCombinedSVGs[this.combinedSVGKey]=r),a(this.combinedSVGKey)}getSVGShape(e,t,r=null,a=!1){r&&this.cachedCombinedShapes.hasOwnProperty(r)?t(this.cachedCombinedShapes[r]):fabric.loadSVGFromString(e,(s,o)=>{let n=fabric.util.groupSVGElements(s,o);n.objectCaching=!0,a?n.set({left:0,top:0}).setCoords():n.set({left:Math.max(0,n.left),top:Math.max(0,n.top)}).setCoords(),n.baseScaleX=n.scaleX,n.baseScaleY=n.scaleY,r&&!this.cachedCombinedShapes.hasOwnProperty(r)&&(this.cachedCombinedShapes[r]=n),n.baseBoundingRect=n.getBoundingRect(),n.containsObjectFills=!1;let l=[],c=[],h={};for(let u=0;u<s.length;u++){let d=s[u];if(d.fill){if(typeof d.fill=="string"&&d.fill.length){let m=new fabric.Color(d.fill).toHex();d.fill="#"+m,l.includes(m)||(l.push(m),c.push(u));let p=c[l.indexOf(m)];h.hasOwnProperty(p)||(h[p]={colorHash:m,colorOpacity:0,objects:[],fillObject:null}),h[p].colorOpacity=Math.max(h[p].colorOpacity,d.opacity),h[p].objects.push(d),d.opacityOriginal=d.opacity}else if(typeof d.fill=="object"){n.containsObjectFills=!0;let m=d.fill;l.includes(m)||(l.push(m),c.push(u));let p=c[l.indexOf(m)];h.hasOwnProperty(p)||(h[p]={colorHash:-1,colorOpacity:0,objects:[],fillObject:m}),h[p].colorOpacity=Math.max(h[p].colorOpacity,d.opacity),h[p].objects.push(d),d.opacityOriginal=d.opacity}}}n.colorMap=h,t(n)})}getTexture(e,t=null,r=null,a=null){let s=e.colorMap;if(s)for(let l in s){let c=s[l];if(c.objects){let h=c.fillObject?c.fillObject:"#"+c.colorHash,u=c.colorOpacity;if(a&&a[l]){let d=a[l];h=d.colorHash===-1?d.fillObject?d.fillObject:"#000000":"#"+d.colorHash,u=d.colorOpacity}c.objects.forEach(d=>{d.fill!==h&&(d.fill=h,e.dirty=!0),d.opacity!==u&&(d.opacity=u,e.dirty=!0)})}}if(r&&r.x&&r.y){let l=e.baseBoundingRect.left+e.baseBoundingRect.width,c=e.baseBoundingRect.top+e.baseBoundingRect.height,h=Math.min(1,BFN.maxImageSize/r.x,BFN.maxImageSize/r.y),u=r.x/l*h,d=r.y/c*h,m=u*e.baseScaleX,p=d*e.baseScaleY,g=e.baseBoundingRect.left*u,f=e.baseBoundingRect.top*d;e.scaleX=m,e.scaleY=p,e.left=g,e.top=f}else e.scaleX=e.baseScaleX?e.baseScaleX:1,e.scaleY=e.baseScaleY?e.baseScaleY:1,e.left=e.baseBoundingRect?e.baseBoundingRect.left:0,e.top=e.baseBoundingRect?e.baseBoundingRect.top:0;e.dirty=!0,this.fabricStaticCanvas.add(e),this.fabricStaticCanvas.renderAll(),this.clearCanvas();let o=e.getBoundingRect();this.fabricStaticCanvasElement.width=Math.round(o.left+o.width),this.fabricStaticCanvasElement.height=Math.round(o.top+o.height),this.fabricStaticCanvasElement.setStyles({width:`${this.fabricStaticCanvasElement.width}px`,height:`${this.fabricStaticCanvasElement.height}px`}),this.fabricStaticCanvas.width=this.fabricStaticCanvasElement.width,this.fabricStaticCanvas.height=this.fabricStaticCanvasElement.height,this.fabricStaticCanvas.add(e),this.fabricStaticCanvas.renderAll();let n=new PIXI.Texture(new PIXI.BaseTexture(this.fabricStaticCanvasElement));if(n.baseTexture.mipmap=!1,n.baseTexture.fabricShape=e,s){n.baseTexture.fabricShapeColorMap={};for(let l in s){let c=s[l];n.baseTexture.fabricShapeColorMap[l]={colorHash:c.fillObject?-1:c.colorHash,colorHashOriginal:c.fillObject?-1:c.colorHash,colorOpacity:c.colorOpacity,colorOpacityOriginal:c.colorOpacity,objects:c.objects,fillObject:c.fillObject}}}return n.baseTexture.drawPeriod=0,BFN.Stage.uploadTextureData(n.baseTexture,()=>{this.resetCanvas(),t&&t()}),n}textureHasModifiedShapeColors(e){let t=!1;if(e&&e.baseTexture&&e.baseTexture.fabricShapeColorMap){let r=e.baseTexture.fabricShapeColorMap;if(r){for(let a in r)if(!t){let s=r[a];t=s.colorHash!==s.colorHashOriginal||s.colorOpacity!==s.colorOpacityOriginal}}}return t}updateTexture(e,t,r,a=null,s=null,o=!0,n=!1){if(this.updatingTexture&&this.updatingTexture==e||(this.clearCanvas(),e.baseTexture.hasOwnProperty("fabricShape")&&(this.updatingTexture=e,this.updatingShape=e.baseTexture.fabricShape,this.updatingShape.dirty=!0,this.fabricStaticCanvas.add(this.updatingShape))),this.updatingTexture&&this.updatingShape){let l=this.updatingTexture.baseTexture.fabricShapeColorMap;if(l)for(let x in l){let B=l[x];B.objects&&B.objects.forEach(y=>{let F;if(B.fillObject&&B.colorHashOriginal===-1&&(B.colorHash===-1||n)?F=B.fillObject:F="#"+(n?B.colorHashOriginal:B.colorHash),y.fill!==F&&(y.fill=F,this.updatingShape.dirty=!0),B.colorOpacityOriginal>0){let b=n?y.opacityOriginal:y.opacityOriginal*(B.colorOpacity/B.colorOpacityOriginal);y.opacity!==b&&(y.opacity=b,this.updatingShape.dirty=!0)}})}let c=this.updatingShape.baseBoundingRect.left+this.updatingShape.baseBoundingRect.width,h=this.updatingShape.baseBoundingRect.top+this.updatingShape.baseBoundingRect.height;t=a!=null?a/c:t,r=s!=null?s/h:r;let u=a!=null?a:c*t,d=s!=null?s:h*r,m=Math.min(1,BFN.maxImageSize/u,BFN.maxImageSize/d);t*=m,r*=m;let p=t*this.updatingShape.baseScaleX,g=r*this.updatingShape.baseScaleY,f=this.updatingShape.baseBoundingRect.left*t,v=this.updatingShape.baseBoundingRect.top*r,T=this.updatingShape.dirty;if(T=T||this.updatingShape.scaleX!==p,T=T||this.updatingShape.scaleY!==g,T=T||this.updatingShape.left!==f,T=T||this.updatingShape.top!==v,T||n){let x=performance.now();this.updatingShape.scaleX=p,this.updatingShape.scaleY=g,this.updatingShape.left=f,this.updatingShape.top=v,this.fabricStaticCanvasElement.width=Math.round(c*t),this.fabricStaticCanvasElement.height=Math.round(h*r),this.fabricStaticCanvasElement.setStyles({width:`${this.fabricStaticCanvasElement.width}px`,height:`${this.fabricStaticCanvasElement.height}px`}),this.fabricStaticCanvas.width=this.fabricStaticCanvasElement.width,this.fabricStaticCanvas.height=this.fabricStaticCanvasElement.height,this.fabricStaticCanvas.renderAll(),e.update(),o&&!this.debugFabricCanvas&&this.resetCanvas(),e.baseTexture.drawPeriod=Math.ceil(performance.now()-x)}return{x:t,y:r}}return{x:1,y:1}}clearCanvas(){let e=this.fabricStaticCanvas.getObjects();for(let t=0;t<e.length;t++)this.fabricStaticCanvas.remove(e[t]);this.fabricStaticCanvas.clear(),this.updatingTexture=null,this.updatingShape=null}resetCanvas(){this.clearCanvas(),this.fabricStaticCanvasElement.width=this.idleCanvasSize,this.fabricStaticCanvasElement.height=this.idleCanvasSize,this.fabricStaticCanvasElement.setStyles({width:`${this.idleCanvasSize}px`,height:`${this.idleCanvasSize}px`}),this.fabricStaticCanvas.width=this.idleCanvasSize,this.fabricStaticCanvas.height=this.idleCanvasSize}};BFN.SingletonQueue.add(()=>{BFN.SVGManager=new mB});var{elem:zM,html:pB,icon:lZ,appLang:fB}=BeFunky.lit,gB=class{constructor(){this.init()}init(){BeFunky.log("ProjectManager Init"),this.initDefaultValues()}initDefaultValues(){this.projectLoading=!1,this.resolveProjectLoading=()=>{},this.rejectProjectLoading=()=>{},this.transformItemsPending=!1,this.transformItemsPending=!1,this.queuedProjectVO=null,this.queuedProjectItemVOs=null,this.sourceTemplateLoading=!1,this.trackingData=null,this.savedCanvasThumbs={},this.projectImageBaseTextures={},this.handleEditorImageLoadCompleteBind=this.handleEditorImageLoadComplete.bind(this),this.handleEditorImageLoadErrorBind=this.handleEditorImageLoadError.bind(this),this.autoSave={editor:{lastSaveLocation:"",allowAutoSave:!0,cancelLazySave:()=>{},saveQueue:[]},collage:{lastSaveLocation:"",allowAutoSave:!0,cancelLazySave:()=>{},saveQueue:[]},designer:{lastSaveLocation:"",allowAutoSave:!0,cancelLazySave:()=>{},saveQueue:[]}},this.autoSaveInterval=1e3,window.onbeforeunload=()=>this.isFullyAutoSaved()?null:"You are about to leave BeFunky. If you do not save your changes, they will be lost."}loadProject(e,t=!1,r=null){return new Promise((a,s)=>{if(this.projectLoading)throw new Error("Attempting to open new project while an existing project is loading");this.projectLoading=!0,this.resolveProjectLoading=a,this.rejectProjectLoading=s,BFN.TransformGuides.setTransformGuideData(),this.queuedProjectVO=e,this.queuedProjectItemVOs=[...e.collageGridChildren,...e.transformGraphics,...e.transformImages,...e.transformMaskImages,...e.transformLabels],this.sourceTemplateLoading=t,this.trackingData=r,this.projectImageBaseTextures={},Object.keys(e.imageData).forEach(n=>{let l=BFN.getImageType(n),c;switch(l){case"graphic":c=BFN.GraphicLibraryManager.getMenuImageVO(n);break;case"patterns":c=BFN.CollageMakerPatternManager.getMenuImageVO(n);break;default:c=BFN.ImageLibraryManager.getMenuImageVO(n)}c&&c.hasUsableTexture()&&!this.projectImageBaseTextures.hasOwnProperty(n)&&(this.projectImageBaseTextures[n]=c.imageTexture.baseTexture)});let o=e._isLocalProject?!BFN.UnsavedOpenProjectManager.getSaved(e.section):!1;if(e.section==="editor"){BFN.AppModel.viewingEditor||(BFN.AppModel.viewState=BFN.AppModelViewStates.VIEWING_PHOTO_EDITOR);let n=typeof e.editorImageBase64=="string"&&e.editorImageBase64.startsWith("data:")?BFN.BlobUtils.base64ToBlob(e.editorImageBase64):e.editorImageBase64;if(!(n instanceof Blob)&&!BFN.ProjectService.isPixelObject(n))throw this.projectLoading=!1,new Error("Unable to get blob for main Photo Editor image");BFN.PhotoEditorCanvasModel.exitCurrentEditorTool(),BFN.ImageEditManager.resetEditor(),BeFunky.showLoadScreen({isCancellable:!1}),UITools.setToolValue("editor_main","edit",!0),UITools.applyTool("editor_main"),UITools.setToolValue("editor_main","edit",!1),BFN.PhotoEditorModel.addEventListener(BFN.PhotoEditorModelEvents.EDITOR_IMAGE_LOAD_COMPLETE.type,this.handleEditorImageLoadCompleteBind),BFN.PhotoEditorModel.addEventListener(BFN.PhotoEditorModelEvents.EDITOR_IMAGE_LOAD_ERROR.type,this.handleEditorImageLoadErrorBind);let l=!BeFunky.isSafari||!n.idbKeyName;BFN.PhotoEditorModel.loadNewImage(n,{filename:e._isLocalProject?null:e.filename||"",showLoadScreen:!1,clearLocalAssets:!1,saveBlobAsIs:l,hasUnsavedChanges:o})}else e.section==="collage"?(BFN.AppModel.viewingCollage||(BFN.AppModel.viewState=BFN.AppModelViewStates.VIEWING_COLLAGE_MAKER),BeFunky.showLoadScreen({isCancellable:!1}),e.collageBackgroundPatternBase64?BFN.TextureUtils.blobOrBase64ToTexture(e.collageBackgroundPatternBase64,({texture:n,error:l})=>{!l&&n&&(n.baseTexture.isPattern=!0,n.baseTexture.averageColor=BFN.Util.getTextureAverageColor(n,!0),e.collageBackgroundPatternTexture=n),this.processQueuedProjectItemVOs()}):this.processQueuedProjectItemVOs(),BFN.UnsavedOpenProjectManager.setSaved("collage",!o,"new project")):e.section==="designer"&&(BFN.AppModel.viewingDesigner||(BFN.AppModel.viewState=BFN.AppModelViewStates.VIEWING_DESIGNER),BFN.UnsavedOpenProjectManager.setSaved("designer",!o,"new project"),BeFunky.showLoadScreen({isCancellable:!1}),this.processQueuedProjectItemVOs());e._isLocalProject||(BFN.UploadSaveShareManager.setFileName(e.section,"image",e.filename||""),BFN.UploadSaveShareManager.setFileName(e.section,"project",e.filename||""))})}handleEditorImageLoadComplete(e){BFN.PhotoEditorModel.removeEventListener(BFN.PhotoEditorModelEvents.EDITOR_IMAGE_LOAD_COMPLETE.type,this.handleEditorImageLoadCompleteBind),BFN.PhotoEditorModel.removeEventListener(BFN.PhotoEditorModelEvents.EDITOR_IMAGE_LOAD_ERROR.type,this.handleEditorImageLoadErrorBind),this.processQueuedProjectItemVOs()}handleEditorImageLoadError(){throw this.projectLoading=!1,this.rejectProjectLoading("Unable to load Editor image"),BFN.PhotoEditorModel.removeEventListener(BFN.PhotoEditorModelEvents.EDITOR_IMAGE_LOAD_COMPLETE.type,this.handleEditorImageLoadCompleteBind),BFN.PhotoEditorModel.removeEventListener(BFN.PhotoEditorModelEvents.EDITOR_IMAGE_LOAD_ERROR.type,this.handleEditorImageLoadErrorBind),BeFunky.hideLoadScreen(),showMenuPanel("primary"),"invalid image data"}processQueuedProjectItemVOs(){if(this.queuedProjectVO&&this.queuedProjectItemVOs&&this.queuedProjectItemVOs.length){let e=this.queuedProjectItemVOs.shift();switch(e.type){case"grid_cell":return this.processGridCell(e,()=>this.processQueuedProjectItemVOs());case"graphic":return this.processGraphic(e,()=>this.processQueuedProjectItemVOs());case"image":return this.processImage(e,()=>this.processQueuedProjectItemVOs());case"mask_image":return this.processMaskImage(e,()=>this.processQueuedProjectItemVOs());default:return this.processQueuedProjectItemVOs()}}else{let e=this.queuedProjectVO;if(this.queuedProjectVO=null,this.queuedProjectItemVOs=null,BFN.SVGManager.clearCache(),this.fabricShapeBaseTextures){for(let t in this.fabricShapeBaseTextures)delete this.fabricShapeBaseTextures[t];delete this.fabricShapeBaseTextures}["editor","collage","designer"].includes(e.section)?this.addProject(e):(this.projectLoading=!1,this.rejectProjectLoading("Invalid project section"))}}processGridCell(e,t){let{gridCellImageID:r}=e,{imageData:a,svgData:s}=this.queuedProjectVO;if(!r)return t();if(this.projectImageBaseTextures.hasOwnProperty(r))return e.gridCellTexture=new PIXI.Texture(this.projectImageBaseTextures[r]),this.assignTextureToMenuImageVO(r,e.gridCellTexture),t();let o=({error:n,texture:l})=>(n?BeFunky.logError(`Unable to generate texture from grid cell "${r}" image or SVG data`):(BFN.getImageType(r)==="patterns"&&(l.baseTexture.isPattern=!0),this.projectImageBaseTextures[r]=l.baseTexture,e.gridCellTexture=l,this.assignTextureToMenuImageVO(r,e.gridCellTexture)),t());if(a.hasOwnProperty(r))return BFN.TextureUtils.blobOrBase64ToTexture(a[r],o);if(s.hasOwnProperty(r))return BFN.TextureUtils.svgStringToTexture(s[r],o);BeFunky.logError("Project grid cell missing image/SVG data"),t()}processGraphic(e,t){if(e.basicShapeValues)t();else{let{graphicID:r}=e,{svgData:a}=this.queuedProjectVO;if(!r)return BeFunky.logError("Project graphic missing ID"),t();if(!a.hasOwnProperty(r))return BeFunky.logError("Project graphic missing SVG data"),t();this.fabricShapeBaseTextures&&this.fabricShapeBaseTextures[r]?(e.graphicTexture=new PIXI.Texture(this.fabricShapeBaseTextures[r]),t()):BFN.TextureUtils.svgStringToTexture(a[r],({error:s,texture:o})=>{s?BeFunky.logError("Unable to convert graphic SVG string to texture"):(this.fabricShapeBaseTextures=this.fabricShapeBaseTextures||{},this.fabricShapeBaseTextures[r]=o.baseTexture,e.graphicTexture=o),t()},{textureSize:BFN.getImageType(r)==="graphic"?BFN.graphicPlaceholderTextureSize:BFN.maxImageSizeLayer})}}processImage(e,t){let{imageID:r}=e,{imageData:a}=this.queuedProjectVO,s=o=>{e.transformWidth>0&&e.transformHeight>0&&(e.transformScaleX=e.transformWidth/o.width,e.transformScaleY=e.transformHeight/o.height)};if(!r)return BeFunky.logError("Project image missing ID"),t();if(!a.hasOwnProperty(r))return BeFunky.logError("Project image missing image data"),t();if(this.projectImageBaseTextures.hasOwnProperty(r))return e.imageTexture=new PIXI.Texture(this.projectImageBaseTextures[r]),this.assignTextureToMenuImageVO(r,e.imageTexture),s(e.imageTexture.baseTexture),t();BFN.TextureUtils.blobOrBase64ToTexture(a[r],({texture:o,error:n})=>{n?BeFunky.logError("Unable to generate texture from project image data"):(BFN.getImageType(r)==="patterns"&&(o.baseTexture.isPattern=!0),this.projectImageBaseTextures[r]=o.baseTexture,e.imageTexture=o,this.assignTextureToMenuImageVO(r,e.imageTexture),s(e.imageTexture.baseTexture)),t()})}processMaskImage(e,t){let{maskImageID:r}=e,{svgData:a,imageData:s}=this.queuedProjectVO;if(!r)return BeFunky.logError("Project mask image missing ID"),t();if(!s.hasOwnProperty(r))return BeFunky.logError("Project mask image missing image data"),t();let o=()=>{if(!e.maskImageMaskID)return t();if(a.hasOwnProperty(e.maskImageMaskID))BFN.SVGManager.getSVGShape(a[e.maskImageMaskID],n=>{e.maskImageMaskTexture=BFN.SVGManager.getTexture(n,t)},e.maskImageMaskID,!0);else if(s.hasOwnProperty(e.maskImageMaskID))BFN.TextureUtils.blobOrBase64ToTexture(s[e.maskImageMaskID],({error:n,texture:l})=>n?(BeFunky.logError("Unable to generate texture from project image data"),t()):(e.maskImageMaskTexture=l,t()));else return t()};if(this.projectImageBaseTextures.hasOwnProperty(r))return e.maskImageTexture=new PIXI.Texture(this.projectImageBaseTextures[r]),this.assignTextureToMenuImageVO(r,e.maskImageTexture),o();BFN.TextureUtils.blobOrBase64ToTexture(s[r],({error:n,texture:l})=>n?(BeFunky.logError("Unable to generate texture from project image data"),t()):(BFN.getImageType(r)==="patterns"&&(l.baseTexture.isPattern=!0),this.projectImageBaseTextures[r]=l.baseTexture,e.maskImageTexture=l,this.assignTextureToMenuImageVO(r,e.maskImageTexture),o()))}addProject(e){let t=null,r=null,a=null,s=null;switch(e.section){case"editor":t=BFN.PhotoEditorModel,r=BFN.PhotoEditorCanvasModel,a=BFN.PhotoEditorCanvas,s=e.section;break;case"collage":t=BFN.CollageMakerModel,r=BFN.CollageMakerCanvasModel,a=BFN.CollageMakerCanvas,s=e.section,BFN.CollageMakerCanvasModel.dispatchEvent(BFN.CollageMakerCanvasModelEvents.CLEAR_ITEMS),BFN.CollageMakerHistoryModel.resetHistory(),BFN.CollageMakerCanvasPhotoGridModel.freeform=e.collageFreeform,BFN.CollageMakerCanvasPhotoGridModel.freeform?(BFN.CollageMakerCanvasPhotoGrid.updateToolVO(e.projectWidth,e.projectHeight,0,0,e.collageBackgroundColor,!1,!1,!1,!1),BFN.CollageMakerCanvasPhotoGrid.preparePhotoGrid(e.projectWidth,e.projectHeight,0,0)):(BFN.CollageMakerCanvasPhotoGrid.updateToolVO(e.projectWidth,e.projectHeight,e.collageGap,e.collageRounding,e.collageBackgroundColor,!1,!0,!0,!0),BFN.CollageMakerCanvasPhotoGrid.preparePhotoGrid(e.collageGridWidth,e.collageGridHeight,e.collageGap/100,e.collageRounding/100)),BFN.CollageMakerCanvasPhotoGrid._gridWidth=e.projectWidth,BFN.CollageMakerCanvasPhotoGrid._gridHeight=e.projectHeight,BFN.CollageMakerCanvasBackground.color!==e.collageBackgroundColor&&(BFN.CollageMakerCanvasBackground.color=e.collageBackgroundColor),e.hasOwnProperty("collageBackgroundPatternTexture")?(BFN.CollageMakerCanvasPhotoGrid.setPatternBackgroundTexture(e.collageBackgroundPatternTexture),delete e.collageBackgroundPatternTexture):(BFN.CollageMakerCanvasPhotoGrid.setPatternBackgroundTexture(null),BFN.PhotoGrid.backgroundColor=BFN.CollageMakerCanvasBackground.color),BFN.CollageMakerCanvasPhotoGridModel.freeform||(BFN.CollageMakerHistoryModel.ignoreSnapshot=!0,e.collageGridChildren.forEach(o=>{let n=BFN.PhotoGrid.addGridChild(o.gridCellRect.x,o.gridCellRect.y,o.gridCellRect.width,o.gridCellRect.height);if(o.gridCellImageID)if(o.gridCellTexture){let l=BFN.ImageLibraryManager.getSampleIndex(o.gridCellImageID),c=BFN.ImageLibraryManager.getIndex(o.gridCellImageID),h=null;if(l!==-1)h=BFN.ImageLibraryManager.sampleMenuImageVOs[l];else if(c!==-1)h=BFN.ImageLibraryManager.selectedMenuImageVOs[c];else{h=new BFN.MenuImageVO,h.id=o.gridCellImageID;let u=o.gridCellTexture,{thumbSize:d}=BFN.MultipleFileUploader,m=u.width/u.height,p=d*(m>1?m:1/m),g=BFN.Util.getThumbTexture(u,p,!1,!0);g.renderClone().destroyGC(!0),h.isTransparent=o.gridCellTexture.determineTransparency(),h.thumbURL=BFN.TextureUtils.textureToBase64(g,{isTransparent:h.isTransparent}),h.thumbWidth=g.width,h.thumbHeight=g.height,g.destroyGC(!0)}h.imageTexture=o.gridCellTexture,delete o.gridCellTexture,n.menuImageVO=h,h.imageTexture&&h.imageTexture.valid&&n.content.setImage(h.imageTexture),n.content.image.frameSprite.offsetFactorX=o.gridCellTextureOffsetFactorX,n.content.image.frameSprite.offsetFactorY=o.gridCellTextureOffsetFactorY,n.content.image.frameSprite.rotate=o.gridCellTextureRotate,n.content.image.frameSprite.textureScale=o.gridCellTextureScale,n.content.image.frameSprite.offsetFactorX=o.gridCellTextureOffsetFactorX,n.content.image.frameSprite.offsetFactorY=o.gridCellTextureOffsetFactorY,n.content.image.frameSprite.updateDisplay()}else o.gridCellImageID=null,o.gridCellTextureOffsetFactorX=.5,o.gridCellTextureOffsetFactorY=.5,o.gridCellTextureRotate=0,o.gridCellTextureScale=1;n.updateProjectItemVO()}),BFN.CollageMakerHistoryModel.ignoreSnapshot=!1),BFN.CollageMakerCanvasPhotoGrid.updateSettings(),BFN.CollageMakerCanvasPhotoGridModel.freeform||(BFN.CollageMakerHistoryModel.historyAction="new_grid_template",BFN.CollageMakerCanvasPhotoGrid.photoGrid.getPhotoGridSnapShot());break;case"designer":t=BFN.DesignerModel,r=BFN.DesignerCanvasModel,a=BFN.DesignerCanvas,s=e.section,BFN.DesignerCanvasModel.dispatchEvent(BFN.DesignerCanvasModelEvents.CLEAR_ITEMS),BFN.DesignerCanvas.setSize(e.projectWidth,e.projectHeight),BFN.DesignerCanvasBackground.color=e.designerBackgroundColor,UITools.setToolValue("collage_customize","background_color",e.designerBackgroundColor),UITools.updateToolControls("collage_customize"),BFN.ZoomManager.updateZoomRange(),BFN.DesignerCanvas.fitDesignerToFrame();break}if(t&&r&&a&&s){this.transformItemsPending=!0,t.projectVO=e,BeFunky.showLoadScreen({isCancellable:!1}),BFN.GroupManager.clearGroups(e.section),BFN.GroupManager.addGroups(e.section,e.transformGroups),BFN.TransformStateModel.blockAddedTransitions=!0,BFN.TransformModel.selectItemOnAdd=!1;let o=[];e.transformGraphics.filter(h=>h.graphicTexture||h.basicShapeValues).forEach(h=>{h.graphicTexture?r.addedItem={type:"texture",texture:h.graphicTexture,isGoodie:!0,projectItemVO:h,projectVO:e,graphicStyle:h.graphicStyle}:h.basicShapeValues&&(r.addedItem={type:"texture",texture:null,isGoodie:!0,projectItemVO:h,projectVO:e,basicShapeVO:new BFN.BasicShapeVO(h.basicShapeValues.type,h.basicShapeValues)});let u=BFN.TransformModel.addedTransformItem,d=new BFN.TransformItemStateVO;h.hasOwnProperty("graphicTexture")&&h.graphicTexture&&(d.imageTexture=h.graphicTexture,delete h.graphicTexture),d.parent=a.transformLayer,this.transferProperties(h,d),u.applyTransformItemState(d,!1),o.push({zIndex:d.zIndex,item:u,state:d})});let n=e.transformImages.length;for(;--n>-1;){let h=e.transformImages[n];if(!h.isGoodie&&h.hasOwnProperty("imageTexture")){e.transformImages.splice(n,1),h.maskImageTexture=h.imageTexture,delete h.imageTexture,h.type="mask_image",h.maskImageID=h.imageID,h.imageID=null;let{baseTexture:u}=h.maskImageTexture;h.maskImageFrameWidth=h.transformScaleX*u.width,h.maskImageFrameHeight=h.transformScaleY*u.height;let d=Math.max(h.maskImageFrameWidth/u.width,h.maskImageFrameHeight/u.height),m=u.width*d,p=u.height*d;h.maskImageTextureScale={x:h.maskImageFrameWidth/m,y:h.maskImageFrameHeight/p},h.transformScaleX=1,h.transformScaleY=1,e.transformMaskImages.push(h)}}if(e.transformImages.filter(h=>h.imageTexture).forEach(h=>{let u={type:"texture",texture:h.imageTexture,projectItemVO:h,projectVO:e,graphicStyle:h.graphicStyle};h.isGoodie&&(u.isGoodie=!0),r.addedItem=u;let d=BFN.TransformModel.addedTransformItem,m=new BFN.TransformItemStateVO;m.imageTexture=h.imageTexture,delete h.imageTexture,m.parent=a.transformLayer,this.transferProperties(h,m),d.applyTransformItemState(m,!1),o.push({zIndex:m.zIndex,item:d,state:m})}),e.transformMaskImages.filter(h=>h.maskImageTexture).forEach(h=>{if(h.hasOwnProperty("maskImageFlashVars")){let f=h.maskImageTexture,{baseTexture:v}=f;if(h.maskImageFrameWidth=h.maskImageFlashVars.maskImageWidth,h.maskImageFrameHeight=h.maskImageFlashVars.maskImageHeight,h.maskImageFlashVars.maskImageScaleX=Math.round(h.maskImageFlashVars.maskImageScaleX*100)/100,h.maskImageFlashVars.maskImageScaleY=Math.round(h.maskImageFlashVars.maskImageScaleY*100)/100,h.maskImageFlashVars.maskImageScaleX===h.maskImageFlashVars.maskImageScaleY){let T=Math.min(v.width*h.maskImageFlashVars.maskImageScaleX/h.maskImageFrameWidth,v.height*h.maskImageFlashVars.maskImageScaleY/h.maskImageFrameHeight),x=Math.max(0,v.width*h.maskImageFlashVars.maskImageScaleX-h.maskImageFlashVars.maskImageWidth),B=Math.max(0,v.height*h.maskImageFlashVars.maskImageScaleY-h.maskImageFlashVars.maskImageHeight);h.maskImageOffsetFactorX=x?Math.abs(h.maskImageFlashVars.maskImageX)/x:.5,h.maskImageOffsetFactorY=B?Math.abs(h.maskImageFlashVars.maskImageY)/B:.5,h.maskImageTextureScale=T}delete h.maskImageFlashVars}let u={x:1,y:1};typeof h.maskImageTextureScale=="object"&&h.maskImageTextureScale.hasOwnProperty("x")&&h.maskImageTextureScale.hasOwnProperty("y")?(u.x=h.maskImageTextureScale.x,u.y=h.maskImageTextureScale.y):typeof h.maskImageTextureScale=="number"&&(u.x=h.maskImageTextureScale,u.y=h.maskImageTextureScale),h.maskImageTextureScale=u;let d=null;h.hasOwnProperty("maskImageMaskTexture")&&h.maskImageMaskTexture?d=h.maskImageMaskTexture:h.basicShapeValues&&(d=PIXI.RenderTexture.create(32,32));let m={type:"frame_texture",texture:h.maskImageTexture,maskTexture:d,projectItemVO:h,projectVO:e};if(h.graphicStyle&&(m.graphicStyle=h.graphicStyle),h.basicShapeValues){let f=new BFN.BasicShapeVO(h.basicShapeValues.type,h.basicShapeValues);f.convertToMaskValues(),f.isSolidRectangle?(h.basicShapeValues=null,m.maskTexture&&m.maskTexture!==h.maskImageMaskTexture&&(m.maskTexture.destroyGC(!0),m.maskTexture=null)):(m.basicShapeVO=f,h.basicShapeValues=f.getValues())}r.addedItem=m;let p=BFN.TransformModel.addedTransformItem,g=new BFN.TransformItemStateVO;g.imageTexture=h.maskImageTexture,delete h.maskImageTexture,h.hasOwnProperty("maskImageMaskTexture")&&delete h.maskImageMaskTexture,g.parent=a.transformLayer,this.transferProperties(h,g),p.applyTransformItemState(g,!1),o.push({zIndex:g.zIndex,item:p,state:g})}),e.transformLabels.length&&(BFN.UndoManager.updating=!0,e.transformLabels.forEach(h=>{let{styles:u}=h.labelTextStyles;BFN.ParseBFD.forEachCharacterStyle(u,T=>{T.hasOwnProperty("desiredStrokeWidth")&&(!T.hasOwnProperty("strokePercent")&&T.hasOwnProperty("fontSize")&&(T.strokePercent=Math.max(BFN.TransformItemTextStrokePercentMin,Math.min(BFN.TransformItemTextStrokePercentMax,T.desiredStrokeWidth/Math.max(.001,T.fontSize)))),delete T.desiredStrokeWidth)});let d={fontFamily:BFN.FabricManager.defaultFontFamily,fontSize:BFN.TransformItemTextBaseFontSize,fill:"rgb(0,0,0,1)",textBackgroundColor:"",stroke:"",strokeWidth:1,strokePercent:BFN.TransformItemTextStrokePercentDefault},m={},p=h.labelTextStyles.styles,g=h.labelText.split(`
`);for(let T=0;T<g.length;T++){T<g.length-1&&(g[T]+=`
`),m[T]={};for(let x=0;x<g[T].length;x++)p&&p[T]&&p[T][x]&&(d=Object.assign({},p[T][x])),m[T][x]=Object.assign({},d)}h.labelTextStyles.styles=m,r.addedItem={type:"text",projectItemVO:h,projectVO:e};let f=BFN.TransformModel.addedTransformItem,v=new BFN.TransformItemStateVO;f.updateStateVO(v),v.parent=a.transformLayer,this.transferProperties(h,v),f.applyTransformItemState(v,!1),o.push({zIndex:v.zIndex,item:f,state:v})}),BFN.MainUI.rendering=!0,BFN.MainUI.renderCanvas(),BFN.MainUI.rendering=!1,BFN.UndoManager.updating=!1),this.trackingData&&e.section==="designer"){let h=this.trackingData.type;h||(h=this.trackingData.id?"Preset":"Custom");let u=new BFN.UserActionVO;u.eventID="design_layout_selected",u.eventObject={templateType:h,templateName:this.trackingData.name||"Custom",templateID:this.trackingData.id||"custom",templateSearchKeyword:this.trackingData.searchTerm||""},u.track()}this.sourceTemplateLoading=!1,this.trackingData=null,BFN.TransformModel.selectedTransformItem&&BFN.TransformModel.selectedTransformItem.transformLayer&&BFN.TransformModel.selectedTransformItem.transformLayer.deselectItem(),BFN.MainUI.renderCanvas(),o.forEach(({item:h})=>{h.ignoreAccurateBounds=!0,h.visible=!1}),BFN.MainUI.renderCanvas();let l=!1,c=()=>{if(!BFN.updatingShapeQueue.length&&!BFN.updatingTextQueue.length&&(l||(l=!0,o.length&&(o.sort((h,u)=>h.zIndex-u.zIndex),o.forEach(({item:h,state:u},d)=>{h.parent.setChildIndex(h,d),setTimeout(()=>{h.updateShapeTexture()},d),u.zIndex=d,h.ignoreAccurateBounds=!1,h.updateAccurateBounds(),h.setTransitionStartState(),h.setTransitionEndState()}))),!BFN.accurateBoundsQueue.length)){o.forEach(({item:u},d)=>{u.visible=!0,u.preloadThumbnail(d*5+50),u.refreshItemName(),u.type==="text"&&!u.iText.wordBreaksEnabled&&(u.iText.wordBreaksEnabled=!0)}),BFN.MainUI.requestRender(),BFN.TransformStateModel.blockAddedTransitions=!1,BFN.TransformModel.selectItemOnAdd=!0,BeFunky.hideLoadScreen();let h=0;s==="editor"&&BFN.PhotoEditorHistoryModel.historyVOs.length&&(h=BFN.PhotoEditorHistoryModel.historyVOs[0].timestamp),BFN.TextureHistoryManager.addTextureHistory(h),Object.keys(this.projectImageBaseTextures).forEach(u=>{delete this.projectImageBaseTextures[u]}),this.projectImageBaseTextures={},this.transformItemsPending=!1,BFN.TransformLayerManager.updateTransformItems(),BFN.TransformGuides.setTransformGuideData(e.transformGuides,e.transformGuidesLocked),this.projectLoading=!1,this.resolveProjectLoading(),this.saveProjectAssets(e),this.requestLocalSave();return}setTimeout(c,0)};setTimeout(c,0)}else BeFunky.throwError("Unable to add project",e.section),this.projectLoading=!1,this.rejectProjectLoading("Unable to add project")}saveProjectAssets(e){BeFunky.testingFlags.includes("add_screenshot_mask")&&requestIdleCallback(this.createScreenshotMask);let t=!!e._isLocalProject;delete e._isLocalProject;let r=e.section,a={image:e.imageData,svg:e.svgData};e.imageData={},e.svgData={};let s=Object.keys(a.image),o=Object.keys(a.svg);e.imageDataKeys.splice(0),e.svgDataKeys.splice(0),e.imageDataKeys.push(...s),e.svgDataKeys.push(...o);let n=[...s.map(c=>`image__${c}`),...o.map(c=>`svg__${c}`)];t&&n.push(`image__${r}_thumb`),r==="editor"&&n.push("image__editor_canvas_image"),(()=>BFN.AppModel.viewingEditor&&BFN.ImageEditManager.editingImage?Promise.resolve():BFN.ProjectService.clearLocalAssets(r,n))().then(()=>{if(t)return;let c=[...s.map(u=>h(u,"image")),...o.map(u=>h(u,"svg"))];function h(u,d){let m=a[d][u];if(d==="image"&&typeof m=="string")try{m=BFN.BlobUtils.base64ToBlob(m)}catch(p){BeFunky.logError(`Unable to convert project image ${u} from base64 -> blob before saving in IndexedDB`)}return BFN.ProjectService.setLocalAsset(r,d,u,m).catch(p=>{BeFunky.logError("Unable to save project asset",u,p)})}})}createScreenshotMask(){let e;BeFunky.waitUntil({condition:()=>(BFN.AppModel.viewingEditor?e=r():e=BFN.ImageEditManager.getProjectBoundingClientRect(),e.width>1),onTimeout:()=>{BeFunky.logError("Unable to get template dimensions")},onSuccess:()=>{t()},interval:500,maxAttempts:6});function t(){let a=document.getElementById("project_bounds");a||(a=BeFunky.lit.elem`<div id="project_bounds"></div>`,document.body.appendChild(a)),a.setStyles({position:"absolute",width:`${e.width}px`,height:`${e.height}px`,left:`${e.left}px`,bottom:`${e.bottom}px`}),console.log("Testing > Positioned project_bounds div over canvas",`${e.width} x ${e.height}`)}function r(){let a=BFN.PhotoEditorCanvas.scale.x,s=BFN.PhotoEditorCanvasImage.imageWidth*a,o=BFN.PhotoEditorCanvasImage.imageHeight*a,n=BFN.PhotoEditorCanvas.canvasContainer.x*a,l=-BFN.PhotoEditorCanvas.canvasContainer.y*a;return{width:s,height:o,left:BFN.PhotoEditorCanvas.x+n-s/2+BFN.appViewportRect.left,bottom:BFN.PhotoEditorCanvas.y+l-o/2+BFN.getAppViewportBottomOffset()}}}getProjectVO(e){let t=new BFN.ProjectVO;return Object.assign(t,e),t.collageGridChildren=[],t.transformGraphics=[],t.transformImages=[],t.transformMaskImages=[],t.transformLabels=[],t.transformGroups=[],e.collageGridChildren.forEach(r=>t.collageGridChildren.push(this.getProjectItemVO(r))),e.transformGraphics.forEach(r=>t.transformGraphics.push(this.getProjectItemVO(r))),e.transformImages.forEach(r=>t.transformImages.push(this.getProjectItemVO(r))),e.transformMaskImages.forEach(r=>t.transformMaskImages.push(this.getProjectItemVO(r))),e.transformLabels.forEach(r=>t.transformLabels.push(this.getProjectItemVO(r))),e.transformGroups&&e.transformGroups.forEach(r=>t.transformGroups.push(this.getTransformItemGroupVO(r))),t.svgData={},Object.entries(e.svgData).forEach(([r,a])=>{t.svgData[r]=a.startsWith("<")?a:atob(a)}),t}getProjectItemVO(e){if(e.hasOwnProperty("transformOverlayColorEnabled")||(e.transformOverlayColorEnabled=e.hasOwnProperty("transformOverlayColor")&&e.transformOverlayColor!=-1),e.hasOwnProperty("transformTintColorEnabled")||(e.transformTintColorEnabled=e.hasOwnProperty("transformTintColor")&&e.transformTintColor!=-1),e.hasOwnProperty("borderEnabled")||(e.borderEnabled=e.hasOwnProperty("borderColor")&&e.borderColor!=-1),e.hasOwnProperty("labelTextBackgroundEnabled")||(e.labelTextBackgroundEnabled=e.hasOwnProperty("labelTextBackgroundColor")&&e.labelTextBackgroundColor!=-1),e.type==="label"&&e.labelTextStyles&&(e.labelTextStyles.styles||e.labelTextStyles.compressedStyles)&&(!e.hasOwnProperty("labelTextOutlineEnabled")||!e.hasOwnProperty("labelTextHighlightEnabled"))){let r=!1,a=!1,s=e.labelTextStyles.styles||BFN.ParseBFD.decompressCharacterStyles(e.labelTextStyles.compressedStyles);for(let o in s){let n=s[o];for(let l in n){let c=n[l];!r&&!!c.stroke&&(r=!0),!a&&!!c.textBackgroundColor&&(a=!0)}}e.labelTextOutlineEnabled=r,e.labelTextHighlightEnabled=a}let t=new BFN.ProjectItemVO;return Object.assign(t,e),e.gridCellRect&&(t.gridCellRect=new BFN.Rectangle(e.gridCellRect.x,e.gridCellRect.y,e.gridCellRect.width,e.gridCellRect.height)),t}getTransformItemGroupVO(e){let t=new BFN.TransformItemGroupVO;return Object.assign(t,e),t}getProjectObject(e){let t={};return Object.assign(t,e),t.collageGridChildren=[],t.transformGraphics=[],t.transformImages=[],t.transformMaskImages=[],t.transformLabels=[],e.collageGridChildren.forEach(r=>t.collageGridChildren.push(this.getProjectItemObject(r))),e.transformGraphics.forEach(r=>t.transformGraphics.push(this.getProjectItemObject(r))),e.transformImages.forEach(r=>t.transformImages.push(this.getProjectItemObject(r))),e.transformMaskImages.forEach(r=>t.transformMaskImages.push(this.getProjectItemObject(r))),e.transformLabels.forEach(r=>t.transformLabels.push(this.getProjectItemObject(r))),t}getProjectItemObject(e){let t={};return Object.assign(t,e),t.gridCellRect&&(t.gridCellRect={x:t.gridCellRect.x,y:t.gridCellRect.y,width:t.gridCellRect.width,height:t.gridCellRect.height}),delete t.graphicTexture,delete t.imageTexture,delete t.maskImageTexture,delete t.maskImageMaskTexture,delete t.gridCellTexture,t}transferProperties(e,t){t.basicShapeValues=e.basicShapeValues,t.shapeColorMap=e.shapeColorMap,t.borderEnabled=e.borderEnabled,t.borderValues=e.borderValues,t.dropShadowValues=e.dropShadowValues,t.zIndex=e.transformZIndex,t.locked=e.transformLocked,t.hidden=e.transformHidden,t.x=e.transformX,t.y=e.transformY,t.scaleX=e.transformScaleX,t.scaleY=e.transformScaleY,t.rotation=e.transformRotation,t.opacity=e.transformOpacity,t.blendMode=e.transformBlendMode,t.flippedHorizontal=e.transformFlippedHorizontal,t.flippedVertical=e.transformFlippedVertical,t.overlayColorEnabled=e.transformOverlayColorEnabled,t.overlayColor=e.transformOverlayColor,t.overlayColorIntensity=e.transformOverlayColorIntensity,t.tintEnabled=e.transformTintColorEnabled,t.tint=e.transformTintColor,t.maskImageFrameWidth=e.maskImageFrameWidth,t.maskImageFrameHeight=e.maskImageFrameHeight,t.maskImageOffsetFactorX=e.maskImageOffsetFactorX,t.maskImageOffsetFactorY=e.maskImageOffsetFactorY,t.maskImageTextureScale=e.maskImageTextureScale,t.text=e.labelText,t.textStyle=e.labelTextStyles,t.textWidth=e.labelWidth,t.textScale=e.labelTextScale,t.textItemScale=e.labelTextItemScale,t.textBackgroundEnabled=e.labelTextBackgroundEnabled,t.textBackgroundColor=e.labelTextBackgroundColor,t.textBackgroundIntensity=e.labelTextBackgroundIntensity,t.textBackgroundPadding=e.labelTextBackgroundPadding,t.textOutlineEnabled=e.labelTextOutlineEnabled,t.textHighlightEnabled=e.labelTextHighlightEnabled,t.textCurveEnabled=e.labelTextCurveEnabled,t.textCurveAmount=e.labelTextCurveAmount}assignTextureToMenuImageVO(e,t){let r=BFN.getImageType(e),a;switch(r){case"graphic":a=BFN.GraphicLibraryManager.getMenuImageVO(e);break;case"patterns":t.baseTexture.isPattern=!0,a=BFN.CollageMakerPatternManager.getMenuImageVO(e);break;default:a=BFN.ImageLibraryManager.getMenuImageVO(e)}a&&(!a.imageTexture||a.imageTexture&&!a.imageTexture.baseTexture||a.imageTexture&&a.imageTexture.baseTexture&&a.imageTexture.baseTexture._destroyed)&&(a.imageTexture=new PIXI.Texture(t.baseTexture))}updateProjectVOItems(e,t){if(this.projectLoading)return;e.projectVO.imageDataKeys.splice(0),e.projectVO.svgDataKeys.splice(0),e.projectVO.transformGraphics.splice(0),e.projectVO.transformImages.splice(0),e.projectVO.transformMaskImages.splice(0),e.projectVO.transformLabels.splice(0);let r="editor";e===BFN.CollageMakerModel&&(r="collage"),e===BFN.DesignerModel&&(r="designer"),t.children.filter(a=>a.type!=="group"&&a.projectItemVO).forEach(a=>{let{projectItemVO:s}=a;switch(s.transformZIndex=t.children.indexOf(a),s.type){case"graphic":s.graphicID?(e.projectVO.svgDataKeys.includes(s.graphicID)||(e.projectVO.svgDataKeys.push(s.graphicID),BFN.ProjectService.setLocalAsset(r,"svg",s.graphicID,void 0,!0)),e.projectVO.transformGraphics.push(s)):s.basicShapeValues&&e.projectVO.transformGraphics.push(s);break;case"image":s.imageID&&(e.projectVO.imageDataKeys.includes(s.imageID)||(e.projectVO.imageDataKeys.push(s.imageID),BFN.ProjectService.setLocalAsset(r,"image",s.imageID,void 0,!0)),e.projectVO.transformImages.push(s));break;case"mask_image":s.maskImageID&&(e.projectVO.imageDataKeys.includes(s.maskImageID)||(e.projectVO.imageDataKeys.push(s.maskImageID),BFN.ProjectService.setLocalAsset(r,"image",s.maskImageID,void 0,!0)),e.projectVO.transformMaskImages.push(s)),s.maskImageMaskID&&(a.itemContentMask&&!a.isShape?e.projectVO.imageDataKeys.includes(s.maskImageMaskID)||(e.projectVO.imageDataKeys.push(s.maskImageMaskID),BFN.ProjectService.setLocalAsset(r,"image",s.maskImageMaskID,void 0,!0)):e.projectVO.svgDataKeys.includes(s.maskImageMaskID)||(e.projectVO.svgDataKeys.push(s.maskImageMaskID),BFN.ProjectService.setLocalAsset(r,"svg",s.maskImageMaskID,void 0,!0)));break;case"label":e.projectVO.transformLabels.push(s);break}})}validateProject(e,{allowReset:t=!1,logLevel:r="none",requireEditorMainImage:a=!0}={}){if(!e||typeof e!="object")return s("Not an object"),!1;if(!["editor","collage","designer"].includes(e.section))return s("Invalid section"),!1;if(typeof e.version!="number")return s("Invalid version: not a number"),!1;if(typeof e.projectWidth!="number"||typeof e.projectHeight!="number")return s("Invalid projectWidth/projectHeight: not a number"),!1;if(!t){if(e.projectWidth<=0||e.projectHeight<=0)return s("Invalid projectWidth/projectHeight: not greater than zero"),!1;if(e.section==="editor"&&a&&!e.editorImageBase64)return s("Missing editorImageBase64"),!1}return!0;function s(o){if(r==="none")return;let n=`projectVO failed validation: ${o}`;return r==="console"?BeFunky.logError(n,e):r==="throw"?BeFunky.throwError(n,e):BeFunky.logError("Invalid log level",r)}}requestLocalSave({sectionID:e=BFN.AppModel.sectionID,isLazy:t=!0,allowReset:r=!1,createThumbnail:a}={}){let s=this.autoSave[e],o=BFN.toTitleCase(e),n=(...f)=>BeFunky.logFeature("autosave",...f),l=Date.now();if(s.cancelLazySave(),!t){let f=m(e);return this.validateProject(f,{allowReset:r,logLevel:"throw",requireEditorMainImage:!1})?u(f,typeof a=="boolean"?a:!0):Promise.reject(`${o} projectVO failed validation`)}if(BFN.ZoomRegion&&BFN.ZoomRegion.updatePreview(),!s.allowAutoSave)return;let c=!1;p();let h=setTimeout(()=>BFN.MainUI.addIdleRenderFunction(()=>{if(!s.allowAutoSave||c){g();return}let f=m(e);if(!this.validateProject(f,{allowReset:r,logLevel:"console",requireEditorMainImage:!1})){BeFunky.logError(`${o} lazy save cancelled b/c projectVO failed validation`),g();return}let v=!f._wasReset&&this.checkThumbnailAvailability(e).isAvailable;u(f,v).catch(T=>{BeFunky.logError(`${o} lazy save failed:`,T)})}),this.autoSaveInterval);s.cancelLazySave=()=>{clearTimeout(h),c=!0,g()};function u(f,v){p(),n("Saving",e,{isLazy:t,needsThumbnail:v});let T=v?d():Promise.resolve(),x=Date.now();return BFN.ProjectService.saveLocalProject(e,BFN.ProjectManager.getProjectObject(f)).then(({store:B})=>{n("Project saved in ",Date.now()-x),s.lastSaveLocation=B}).then(()=>T).then(()=>g(),B=>{throw g(),B})}function d(){let f=Date.now();return BFN.ProjectManager.createThumbnail(e,"blob",!1).then(v=>(n("Thumbnail created",Date.now()-f),f=Date.now(),BFN.ProjectService.setLocalAsset(e,"image",`${e}_thumb`,v))).then(()=>{n("Thumbnail saved",Date.now()-f)})}function m(f){let v={editor:BFN.PhotoEditorModel,collage:BFN.CollageMakerModel,designer:BFN.DesignerModel},{projectVO:T}=v[f];return T.thumbBase64=null,T.editorImageBase64=null,T}function p(){s.saveQueue.push(l),s.saveQueue=s.saveQueue.unique()}function g(){s.saveQueue=s.saveQueue.filter(f=>f!==l)}}isFullyAutoSaved(){let e=Object.values(BFN.ProjectManager.autoSave),t=e.every(a=>a.lastSaveLocation!=="memory"),r=e.every(a=>a.saveQueue.length===0);return t&&r}checkThumbnailAvailability(e){return!BFN.openedSections.includes(e)&&!(e==="editor"&&BFN.ImageEditManager.editingImage)&&e!==BFN.AppModel.sectionID?{isAvailable:!1,reason:"section_has_not_been_opened"}:e==="editor"&&BFN.PhotoEditorCanvasModel.viewState!==BFN.PhotoEditorCanvasModelViewStates.VIEWING_CANVAS?{isAvailable:!1,reason:"not_viewing_canvas"}:BFN.FabricManager.showingTransformItemIText?{isAvailable:!1,reason:"fabric_canvas_showing"}:BFN.TransformItemIsolator.active||BFN.TransformItemIsolator.animating?{isAvailable:!1,reason:"transform_item_isolated"}:BFN.PhotoGrid.gridIsolator.gridChild?{isAvailable:!1,reason:"grid_item_isolated"}:{isAvailable:!0,reason:"all_is_well"}}createThumbnail(e,t="blob",r=!0){let{isAvailable:a,reason:s}=this.checkThumbnailAvailability(e);if(!a)return Promise.reject(s);let o=BFN.AppModel.getSectionValue(e,BFN.PhotoEditorCanvas,BFN.CollageMakerCanvas,BFN.DesignerCanvas),n=o.canvasDimensions,l=n.width/n.height,c,h;if(r){let x=l>=1?l:1/l,B=Math.round(720*x);[c,h]=BFN.TextureUtils.getScaledDimensions(n,{maxWidth:B,maxHeight:B})}else[c,h]=BFN.TextureUtils.getScaledDimensions(n,{maxWidth:450,maxHeight:300});let u=o.getFlattenedImage(Math.max(c,h));if(!u)return Promise.reject("no_flattened_image");let d=r?BFN.Util.isTransparent(u):!1,m=r?1:.85,p=t==="base64"?Promise.resolve(BFN.TextureUtils.textureToBase64(u,{isTransparent:d,quality:m})):BFN.TextureUtils.textureToBlob(u,{isTransparent:d,quality:m}),g=u.width,f=u.height,v=n.width,T=n.height;return p.then(x=>{let B=y=>{this.savedCanvasThumbs.hasOwnProperty(e)||(this.savedCanvasThumbs[e]={});let F=this.savedCanvasThumbs[e];F.thumbID=BeFunky.randomString(10),F.thumbSRC=y,F.thumbW=g,F.thumbH=f,F.canvasW=v,F.canvasH=T,BFN.ZoomRegion.updatePreview()};t==="base64"?B(x):BFN.BlobUtils.blobToBase64(x).then(B)}),u.destroyGC(!0),p}async thumbnailForDialogTemplate(e,{width:t,height:r}={}){let a=await o(),s="height: 200px; width: 300px;";if(t&&r){let[n,l]=BFN.TextureUtils.getScaledDimensions({width:t,height:r},{maxWidth:300,maxHeight:200});s=`height: ${l}px; width: ${n}px;`}return pB`<div style="background: var(--image-bg); margin-bottom: 1rem">
            <div style="background: url('${a}') no-repeat center; background-size: contain; ${s} max-width: 100%; margin: 0 auto;"></div>
        </div>`;function o(){return typeof e=="string"&&e.startsWith("data:image/")?Promise.resolve(e):e instanceof Blob?BFN.BlobUtils.blobToBase64(e):Promise.reject("no_blob")}}getOpenImageInEditorProject(){return BFN.PhotoEditorModel.getCurrentTextureBlob().then(e=>{let{projectVO:t}=BFN.PhotoEditorModel;if(t.editorImageBase64=e,!this.validateProject(t,{logLevel:"throw"}))throw"Invalid Open in Editor project";let r=this.getProjectObject(t),a=BFN.ProjectManager.createThumbnail("editor","base64",!1).then(o=>{r.thumbBase64=o}),s=BFN.ProjectService.addImagesToProject(r);return Promise.all([a,s]).then(()=>r)})}loadFile(e){if(BFN.getExtension(e.name)!=="bfd")return BeFunky.logError("User attempted to load non-BFD file as a project",e&&e.name);BeFunky.showLoadScreen({isCancellable:!1}),BFN.SavedProjectService.decodeProjectFile(e,({data:r,error:a})=>{if(a)return BeFunky.hideLoadScreen(),BeFunky.logError(`Unable to decode BFD file 
`,a);BFN.ObjectCompressor.decompress(r).catch(s=>{BeFunky.logError("Unable to decompress project file",s)}).then(s=>{BeFunky.hideLoadScreen(),typeof s=="object"&&this.confirmAndOpenProject(s,{filename:e.name.replace(/\.bfd$/i,""),source:"computer"}).catch(o=>{if(o==="user_not_plus"){BeFunky.openTeaserModal("plus_templates");return}BeFunky.logError("Unable to open project file",o)})})})}async confirmAndOpenProject(e,{filename:t,source:r,thumbnail:a,skipConfirmation:s=!1}={}){if(e.isPlusTemplate&&!BFN.BfnService.userIsPlus)throw"user_not_plus";e.thumbRect&&(e.version=e.version||"1.0",e.section=e.section||"designer");let o=e.section;if(!["editor","collage","designer"].includes(o))throw`Invalid project section: ${BeFunky.stringValue(o)}`;if(s)return h();let{answer:n,reason:l}=await BFN.AppSectionManager.confirmBeforeLoadingNewProject({projectSectionId:o,getNewProjectThumbnail:c});if(n==="cancel")throw l==="user_choice"?"cancelled_by_user":l;return new Promise((u,d)=>{if(BeFunky.projectToOpenInSection[o]={behavior:n==="confirm"?"load_instead_of_autosave":"load_after_saving_autosave",projectName:t||e.filename,loadProject:()=>h().then(()=>u(),m=>(d(m),Promise.reject(m))),getNewProjectThumbnail:c},BFN.AppModel.sectionID===o)BFN.AppSectionManager.openOrUpdateCurrentSection();else{let m={editor:BFN.AppModelViewStates.VIEWING_PHOTO_EDITOR,collage:BFN.AppModelViewStates.VIEWING_COLLAGE_MAKER,designer:BFN.AppModelViewStates.VIEWING_DESIGNER};BFN.AppModel.viewState=m[o]}});function c(){if(a)return Promise.resolve({image:a});let{version:u,thumbBase64:d,thumbRect:m}=e;return new Promise(p=>{u==="1.0"?BFN.ByteArrayUtil.AS3ByteArrayToPixel(d,m.width,m.height,({src:g})=>{p({image:g})}):p({image:d})})}async function h(){if(BFN.AppModel.sectionID!==o)throw"wrong_app_section";let u=await BFN.ParseBFD.objectToProjectVO(e);return await BFN.ProjectManager.confirmSwapFonts(),t&&(u.filename=t),BFN.BfnService.trackMediaOpened("project",r),BFN.ProjectManager.loadProject(u)}}handleOpenProjectError(e,t,r=""){return new Promise(a=>{BeFunky.logError(`Unable to open ${t} project`,e),BeFunky.hideLoadScreen();let s={editor:"photo_editor",collage:"collage_maker",designer:"designer"},o=BeFunky.LanguageManager.getStringReplacements("error_opening_project",{app_section:BeFunky.LanguageManager.getString(s[t]),project_name:r?`"${r}"`:""}).replace(/\s+/," ");BeFunky.acknowledge(o,{onAcknowledge:a})})}confirmSwapFonts(){return new Promise((e,t)=>{let r=Object.entries(BFN.ParseBFD.swappedFonts);if(!r.length)return e();let a=zM`
                <div>
                    <p>${fB("confirm_swap_fonts")}</p>
                    <ul >
                        ${r.map(([s,o])=>pB`<li>${s}  ${o}</li>`)}
                    </ul>
                    <a href="https://support.befunky.com/hc/en-us/articles/360033317211" target="_blank" rel="noopener">${fB("learn_more")}</a>
                </div>
            `;BeFunky.confirm(a,{onConfirm:()=>e(),onCancel:()=>t("cancelled_by_user"),confirmText:"continue",cancelText:"cancel_install_fonts"})})}getCompressedBlob(e,{layerImageQuality:t=.95,compressSmallLayers:r=!1,compressStyles:a=!0}={}){let s=Object.assign({},e);return new Promise((n,l)=>{let c=0,h=0;a&&(s.transformLabels=JSON.parse(JSON.stringify(s.transformLabels)),s.transformLabels.forEach(p=>{p.labelTextStyles.compressedStyles=BFN.ParseBFD.compressCharacterStyles(p.labelTextStyles.styles),delete p.labelTextStyles.styles})),s.editorImageBase64 instanceof Blob&&(c+=1,BFN.BlobUtils.blobToBase64(s.editorImageBase64).then(p=>{s.editorImageBase64=p,++h===c&&m()},p=>(BeFunky.logError("Unable to convert editorImageBase64 Blob (from IndexedDB) to base64. Trying again...",p),o().then(g=>{s.editorImageBase64=g,++h===c&&m()},g=>{BeFunky.throwError("Unable to get editorImageBase64 for saving",g),l(g)})))),s.thumbBase64 instanceof Blob&&(c+=1,BFN.BlobUtils.blobToBase64(s.thumbBase64).catch(p=>(BeFunky.logError("Unable to convert project thumbnail to base64",p),"")).then(p=>{s.thumbBase64=p,++h===c&&m()}));let u=Object.keys(s.imageData).filter(p=>s.imageData[p]instanceof Blob),d=Math.max(s.projectWidth,s.projectHeight,BFN.maxImageSizeLayer);if(c+=u.length,u.forEach(p=>{BFN.BlobUtils.downsizeImageBlob(s.imageData[p],{maxSize:d,quality:t,skipSmallImages:!r}).catch(g=>(g!=="skipped_small_image"&&BeFunky.logError("Unable to downsize project blob",g),s.imageData[p])).then(g=>BFN.BlobUtils.blobToBase64(g)).catch(g=>(BeFunky.logError("Unable to convert project blob to base64",g),"")).then(g=>{s.imageData[p]=g,++h===c&&m()})}),!c)return m();function m(){return BFN.ObjectCompressor.compress(s).then(p=>{n(new Blob([p],{type:"text/plain;charset=utf-8"}))})}});function o(){return BFN.PhotoEditorModel.getCurrentTextureBlob().then(n=>BFN.BlobUtils.blobToBase64(n))}}};BFN.SingletonQueue.add(()=>{BFN.ProjectManager=new gB});var vB=class{constructor(){this.allSectionIds=["editor","collage","designer"],BFN.GlobalHistoryModel.addEventListener(BFN.GlobalHistoryModelEvents.HISTORY_UPDATED.type,()=>{if(BFN.GlobalHistoryModel.globalHistoryVOs.length<=1)return;let e=BFN.AppModel.sectionValue(...this.allSectionIds);this.setSaved(e,!1,"history");let t=BFN.AppModel.sectionValue(BFN.PhotoEditorModel,BFN.CollageMakerModel,BFN.DesignerModel);delete t.projectVO._wasReset}),this._queueSave=BeFunky.debounce(this._saveToLocalStorage.bind(this),"ric")}lazyInit(){if(!this.savedSections){this.savedSections=new Set;try{JSON.parse(BeFunky.getLocal("saved_app_sections")).forEach(t=>this.setSaved(t,!0,"prior session"))}catch(e){this.allSectionIds.forEach(t=>this.setSaved(t,!1,"default"))}}}getSaved(e){return this.lazyInit(),this.savedSections.has(e)}setSaved(e,t,r){this.lazyInit(),!(e==="editor"&&BFN.ImageEditManager.editingImage)&&(t=Boolean(t),t!==this.savedSections.has(e)&&(t?this.savedSections.add(e):this.savedSections.delete(e),this._queueSave()))}_saveToLocalStorage(){BFN.IndexedDB.newBeFunkyTabOpened||BeFunky.setLocal("saved_app_sections",JSON.stringify(Array.from(this.savedSections)))}};BFN.SingletonQueue.add(()=>{BFN.UnsavedOpenProjectManager=new vB});var{html:yB,appLang:fn}=BeFunky.lit;function gn(){let i=[{value:"educator",text:"survey_educator"},{value:"student",text:"survey_student"},{value:"small_business",text:"survey_small_business"},{value:"large_company",text:"survey_large_company"},{value:"nonprofit",text:"survey_nonprofit"},{value:"personal",text:"survey_personal"}];function e(s){return yB`
            <label class="radio-button">
                <input type="radio" name="survey" value=${s.value}>
                    <span class="radio-button__circle"></span>
                    <span class="radio-button__text">${fn(s.text)}</span>
            </label>`}let t=()=>yB`
        <p class="dialog__sub-heading">${fn("survey_use_case_prompt")}</p>
        <div class="survey__body-text">
            <form id="survey_modal_form" class="survey__form" @submit=${a}>
                ${i.map(e)}
                <button class="button button--md button--blue survey__submit" style="margin-top: 20px;" type="submit">${fn("submit")}</button>
            </form>
        </div>`,r=BeFunky.openDialog({heading:"welcome_back",body:t,modalOptions:{size:"medium",isForm:!0}});function a(s){s.preventDefault();let o=this.querySelector('input[name="survey"]:checked');o&&o.value&&(BFN.SettingsManager.updateSetting("use_case",o.value),r(),UIMessages.display("thank_you_befunky"))}}var{html:za,icon:vn,appLang:Jr}=BeFunky.lit,Ta=(...i)=>BeFunky.logFeature("app_section",...i),xB=class{constructor(){BFN.AppModel.addEventListener(BFN.AppModelEvents.VIEWSTATE_UPDATED.type,this.handleSectionChange.bind(this)),this.isOpeningSection=!1}handleSectionChange(){let{sectionID:e}=BFN.AppModel;if(UIToggler.cancelActiveEditorTool(),this.updateUiOnSectionChange(),BeFunky.isAppleAppStoreApp&&BeFunky.isModalOpen("dashboard_modal"))return;BFN.BfnService.track("CREATE","APPMODE",BFN.AppModel.sectionValue("PHOTOEDITOR","COLLAGE","DESIGNER")),!BFN.openedSections.length&&BeFunky.hideLoadScreen(),e==="editor"&&!BFN.openedSections.includes("editor")&&(BeFunky.addToServiceWorkerCache("data-files",`${BFN.assetsURL}datas/textures_thumbs.xml`),BeFunky.addToServiceWorkerCache("data-files",`${BFN.assetsURL}datas/effect_thumbs${BFN.assetsDataVersions.effects_thumbs_data}.json`)),this.openOrUpdateCurrentSection().then(()=>{BFN.openedSections.length===1&&requestIdleCallback(()=>{this.onFirstSectionOpened()})})}updateUiOnSectionChange(){UIToggler.toggleSampleImagePopover(),BFN.updateAppMenuDisplay()}async openOrUpdateCurrentSection(){let{sectionID:e}=BFN.AppModel,t=BFN.openedSections.includes(e),r=!1;this.isOpeningSection=!0;try{BFN.AppModel.viewingEditor?(r=await this.openEditor(!t),r&&(BFN.editorProjectShelved=!1,BFN.hasFullyOpenedEditor=!0,BeFunky.editorExternalImage=null,BFN.DeepLinkManager.handleEditorDeepLink())):BFN.AppModel.viewingCollage?r=await this.openCollage(!t):BFN.AppModel.viewingDesigner&&(r=await this.openDesigner(!t))}catch(s){BeFunky.throwError(`Failed to open ${e}: ${s.name||s}`,s)}let{sectionID:a}=BFN.AppModel;e!==a&&BeFunky.throwError(`Section changed while in section opener from ${e} to ${a}`),r&&!BFN.openedSections.includes(e)&&(console.log(`${e} opened for the first time`),BFN.openedSections.push(e)),this.isOpeningSection=!1}async openEditor(e){if(BFN.ImageEditManager.editingImage)return!1;return await this.loadAppropriateProject(e,async()=>{if(BeFunky.editorExternalImage)return t();BFN.UnsavedOpenProjectManager.setSaved("editor",!0,"start_new"),Promise.all([BFN.ProjectService.clearLocalAssets("editor"),BFN.ProjectService.removeLocalProject("editor")]).catch(r=>{BeFunky.reportWarning(`Unable to clear Photo Editor project: ${r.message||r}`,r)})}),!0;function t(){BFN.hasFullyOpenedEditor=!0;let{loadImage:r}=BeFunky.editorExternalImage;return BeFunky.editorExternalImage=null,console.log("Loading external image in Photo Editor"),r()}}async openCollage(e){return e&&(UITools.setToolValue("collage_main","image_manager",!0),UITools.applyTool("collage_main"),UITools.setToolValue("collage_main","image_manager",!1),await BFN.CollageMakerTemplateData.loadTemplateData().then(t,r)),await this.loadAppropriateProject(e,async()=>{BFN.UnsavedOpenProjectManager.setSaved("collage",!0,"start_new"),BFN.ProjectService.clearLocalAssets("collage"),BFN.CollageMakerCanvasPhotoGrid.initInitialTemplate()}),!0;function t(){BFN.secondaryMenu.collageLayoutsDisabled=!1}function r(a){return BeFunky.throwError(`Failed to fetch collage layouts: ${a}`),new Promise((s,o)=>{BeFunky.confirm(BeFunky.failureReason(a),{confirmText:"try_again",onConfirm:()=>s(BFN.CollageMakerTemplateData.loadTemplateData().then(t,r)),onCancel:()=>o(a)})})}}async openDesigner(e){e&&(UITools.setToolValue("designer_main","templates",!0),UITools.applyTool("designer_main"),UITools.setToolValue("designer_main","templates",!1));let{isAutosaveLoaded:t,continueEditingClicked:r}=await this.loadAppropriateProject(e,async()=>{if(await a())return!0;let{tag:s,template:o}=window.currentDeepLinkParameters;s||!o?(await BFN.DesignerModel.loadBlankProject(),BFN.DeepLinkManager.handleDesignerDeepLink()):await BFN.DesignerTemplateManager.applyTemplate({id:o})});if((e||BeFunky.isAppleAppStoreApp)&&t){if(await a()||r)return!0;BFN.DeepLinkManager.handleDesignerDeepLink()}return!0;async function a(){if(BeFunky.testingFlags.includes("set_default_designer_template")){let s=window.location.search.match(/default_designer_template=([a-z0-9_]+)/);if(s)return await BFN.DesignerTemplateManager.loadTemplateForTesting(s[1]),!0;BeFunky.logError("Unable to get default designer template ID for testing")}return!1}}getQueuedProject(e=BFN.AppModel.sectionID){if(BeFunky.projectToOpenInSection[e]){let{projectName:t,behavior:r="load_instead_of_autosave",loadProject:a,getNewProjectThumbnail:s}=BeFunky.projectToOpenInSection[e];return BeFunky.projectToOpenInSection[e]=void 0,{behavior:r,getNewProjectThumbnail:s,loadProject:async()=>{try{await a()}catch(o){throw o!=="cancelled_by_user"&&(BeFunky.reportWarning(`Failed to open queued project: ${o.name||o}`,o),await BFN.ProjectManager.handleOpenProjectError(o,e,t)),o}}}}if(e==="editor"&&BeFunky.editorExternalImage){let{loadImage:t,getNewProjectThumbnail:r,behavior:a}=BeFunky.editorExternalImage;return BeFunky.editorExternalImage=null,{behavior:a,getNewProjectThumbnail:r,loadProject:async()=>{BFN.hasFullyOpenedEditor=!0,console.log("Loading external image in Photo Editor"),t()}}}}getAutosaveFlags(e,t){if(!t)return{priorSessionCrashed:!1,dontUseAutosave:!1};let r=BeFunky.getLocal(`force_use_autosave__${e}`)==="true";r&&BeFunky.removeLocal(`force_use_autosave__${e}`);let a=BeFunky.getLocal(`ignore_autosave__${e}`)==="true";return a&&BFN.IndexedDB.indexedDBReady.then(s=>{s&&BeFunky.removeLocal(`ignore_autosave__${e}`)}),{priorSessionCrashed:r,dontUseAutosave:a}}async loadAppropriateProject(e,t){let r=BFN.AppModel.sectionID;Ta("Find project for section:",r,e);let a=this.getQueuedProject();if(a){if(a.behavior==="ask_user"){let{answer:p,reason:g}=await this.confirmBeforeLoadingNewProject({projectSectionId:r,getNewProjectThumbnail:a.getNewProjectThumbnail});console.log("Side by side result",{answer:p,reason:g});let f={cancel:"load_autosave",confirm:"load_instead_of_autosave",save:"load_after_saving_autosave"};a.behavior=f[p]}if(a.behavior==="load_instead_of_autosave")try{await a.loadProject()}catch(p){a.behavior="load_autosave"}}let{priorSessionCrashed:s,dontUseAutosave:o}=this.getAutosaveFlags(r,e);if(a&&a.behavior==="load_instead_of_autosave")return{isAutosaveLoaded:!1,continueEditingClicked:!1};let n=!e,l=!1,{assumeContinueEditing:c=!1}=BeFunky;if(BeFunky.assumeContinueEditing=!1,e?o?(BeFunky.logWarning(`Ignoring ${r} autosave after IndexedDB was disabled halfway through prior session.`),await m()):s?(BeFunky.logWarning(`Attempting to restore ${r} autosave after prior session crashed.`),await h()):a&&["load_autosave","load_after_saving_autosave"].includes(a.behavior)?await h():await u(c):r==="editor"&&BFN.editorProjectShelved&&await h(),a&&a.behavior==="load_after_saving_autosave"&&n){let p=!1;try{await this.saveOpenedProjectToBeFunky(),UIMessages.display("project_saved"),p=!0}catch(g){let{answer:f,reason:v}=await this.confirmBeforeLoadingNewProject({projectSectionId:r,getNewProjectThumbnail:a.getNewProjectThumbnail});console.log("Side by side result #2",{answer:f,reason:v});let T={cancel:"load_autosave",confirm:"load_instead_of_autosave",save:"load_after_saving_autosave"};if(a.behavior=T[f],a.behavior!=="load_autosave"){if(a.behavior==="load_instead_of_autosave")p=!0;else if(a.behavior==="load_after_saving_autosave")try{await this.saveOpenedProjectToBeFunky(),UIMessages.display("project_saved"),p=!0}catch(x){BeFunky.throwError(`Failed to save to BeFunky before opening new project: ${x}`,{firstError:g,secondError:x})}}}if(p)try{await a.loadProject(),n=!1}catch(g){}}return{isAutosaveLoaded:n,continueEditingClicked:l};async function h(p){try{Ta(p?"get autosaved assets":"get autosaved project + assets");let g=p?await BFN.ProjectService.addImagesToProject(p,{showLoadScreen:!0,fallbackToCanvas:!1}):await BFN.ProjectService.getLocalProject(r,{showLoadScreen:!0,fallbackToCanvas:!1,convertPixelObjectToBlob:!1});Ta("prepare project (e.g. fonts)"),await BFN.ParseBFD.prepareV2(g);let f=BFN.ProjectManager.getProjectVO(g);f._isLocalProject=!0,Ta("load project"),await BFN.ProjectManager.loadProject(f),n=!0}catch(g){await d(g)}}async function u(p=!1){let g;try{Ta("get autosave setting"),g=await BeFunky.withLoadScreen(BFN.SettingsManager.getSetting("autosave"))}catch(v){if(v==="cancelled_by_user")return d(v);throw v}if(g==="yes")return h();if(g==="no")return m();if(p)return h();try{let v=await BFN.ProjectService.getLocalProject(r,{excludeAssets:!0,showLoadScreen:!0,convertPixelObjectToBlob:!1});if(v._wasReset===!0)return BeFunky.logError("Loading recently reset project without asking user"),h(v);let T=await f(v);return new Promise(x=>{let B=!1;BeFunky.confirm(T,{onConfirm:()=>{B&&BFN.SettingsManager.updateSetting("autosave","yes"),l=!0,x(h(v))},onCancel:()=>{B&&BFN.SettingsManager.updateSetting("autosave","no"),x(m())},confirmText:"continue_editing",cancelText:"start_new"});let y=document.getElementById("persist_autosave_choice")||BeFunky.getModal().modalElement.querySelector("#persist_autosave_choice");y.addEventListener("change",()=>{B=y.checked})})}catch(v){await d(v)}async function f(v){let T="";try{T=await BFN.ProjectManager.thumbnailForDialogTemplate(v.thumbBase64,{width:v.projectWidth,height:v.projectHeight})}catch(x){}return()=>za`
                ${T}
                <div>${Jr("confirm_load_autosave")}</div>
                <div class="checkbox" style="margin-top: 1rem;">
                    <input type="checkbox" id="persist_autosave_choice">
                    <label class="checkbox__label" for="persist_autosave_choice">
                        <span class="checkbox__box checkbox__box--sm">
                            ${vn("checkmark-icon","icon checkbox__icon icon--12")}
                        </span>
                        <string>${Jr("set_default_setting")}</string>
                    </label>
                </div>
                `}}async function d(p){return BeFunky.hideLoadScreen(),p==="invalid_editor_image_blob"?new Promise(g=>{BeFunky.confirm("error_load_autosave",{confirmText:"try_again",cancelText:"start_new",onConfirm:()=>{window.onbeforeunload=null,window.location.reload()},onCancel:()=>{g(m())}})}):(p!=="no_autosave_project"&&BeFunky.logError("Failed to load autosave",p),m())}async function m(){if(Ta("start new project"),a&&a.behavior==="load_as_start_new")try{await a.loadProject()}catch(p){t()}else t()}}async confirmBeforeLoadingNewProject({projectSectionId:e=BFN.AppModel.sectionID,getNewProjectThumbnail:t}){if(BFN.UnsavedOpenProjectManager.getSaved(e))return{answer:"confirm",reason:"already_saved"};if(!r()){if(BeFunky.getLocal(`ignore_autosave__${e}`)==="true")return{answer:"confirm",reason:"autosave_outdated"};if(await BFN.SettingsManager.getSetting("autosave")==="no")return{answer:"confirm",reason:"start_new_mode"}}try{let s=await BeFunky.withLoadScreen(Promise.all([BFN.ProjectService.getAutosavedProjectThumbnail(e),t()]));return await a(...s)}catch(s){return s==="no_autosave_project_found"||s==="no_autosave_thumbnail_found"?{answer:"confirm",reason:"no_autosave"}:(BeFunky.reportWarning(`Failed to open side by side dialog: ${s.message||s}`,s),{answer:"cancel",reason:s.message||s})}function r(){return BFN.openedSections.includes(e)}async function a(s,o){let n=await Promise.all([s,o].map(d)),l=!1,c=!1,h=[{text:"cancel",type:"grey-300"},{text:"dont_save",type:["grey-300"],style:"margin-left: auto",onClick:()=>{c=!0}},{text:"save",type:["blue","ellipsis"],onClick:()=>{l=!0}}];return new Promise(p=>{BeFunky.openDialog({body:u(),buttons:h,modalOptions:{size:"medium",onClose:()=>p(c?{answer:"confirm",reason:"user_choice"}:l?{answer:"save",reason:"user_choice"}:{answer:"cancel",reason:"user_choice"})}})});function u(){return za`
                <div>
                    <div class="side-by-side">
                        <div class="side-by-side__column">
                            <h3 class="side-by-side__heading">${Jr("current_project")}</h3>
                            ${n[0]}
                        </div>
                        ${vn("arrow-icon","icon icon--20 side-by-side__arrow")}
                        <div class="side-by-side__column">
                            <h3 class="side-by-side__heading">${Jr("new_project")}</h3>
                            ${n[1]}
                        </div>
                    </div>
                    <p>${Jr(["confirm_project_change",{app_section:Jr(m())}])}</p>
                </div>`}function d({image:p,aspectRatio:g}){if(!p&&g)return Promise.resolve(v());if(typeof p=="string"&&p.length>5)return Promise.resolve(f(p));if(p instanceof Blob)return BFN.BlobUtils.blobToBase64(p).then(x=>f(x)).catch(()=>T());return Promise.resolve(T());function f(x){return za`<div class="side-by-side__image-box" style=${`background-image: url('${x}');`}></div>`}function v(){let x=BFN.CSS.sideBySideImageWidth/BFN.CSS.sideBySideImageHeight,B=g>x?"100%":`${BFN.CSS.sideBySideImageHeight*g}px`;return za`<div class="side-by-side__image-box">
                    <div style=${`width: ${B};`}>
                        <div style=${`padding-bottom: ${100/g}%; background: var(--secondary-000);`}></div>
                    </div>
                </div>`}function T(){return za`<div class="side-by-side__image-box">
                    ${vn("blue-folder-icon","icon",{style:"width: 5rem; height: 4rem;"})}
                    <string style="margin-top: 0.5rem">${Jr("no_thumbnail")}</string>
                </div>`}}function m(){return{editor:"photo_editor",collage:"collage_maker",designer:"designer"}[e]}}}async saveOpenedProjectToBeFunky(){let{sectionID:e}=BFN.AppModel;BeFunky.isLoggedIn()||await new Promise((a,s)=>{BeFunky.openLoginPanel("SIGNIN",a,()=>s("did_not_sign_in"))}),BeFunky.showLoadScreen({message:"preparing_image",visibilityDelay:0});let t,r;try{t=await BFN.ProjectService.getLocalProject(e,{logLevel:"throw"}),r=await BFN.ProjectManager.createThumbnail(e,"blob",!0)}catch(a){throw BeFunky.hideLoadScreen(),a}await new Promise((a,s)=>{BFN.UploadSaveShareManager.saveProjectToBeFunky(t,r,o=>{if(BeFunky.hideLoadScreen(),o)return s(o);BFN.BfnService.track("CREATE",BFN.AppModel.sectionValue("SAVE","SAVE_COLLAGE","SAVE_DESIGNER"),"SAVE_PROJECT_BEFUNKY"),a()},!0)})}onFirstSectionOpened(){BFN.BfnService.onUserLogin(async()=>{BeFunky.User&&BeFunky.User.isNewUser||await e()||BeFunky.isPlus()&&t()});async function e(){if(!BeFunky.beforeInstallPromptEvent)return!1;let r=BeFunky.showAnnouncementOnce("pwa",{onConfirm:()=>{BeFunky.beforeInstallPromptEvent.prompt(),BeFunky.beforeInstallPromptEvent.userChoice.then(a=>{a.outcome==="accepted"?BFN.BfnService.track("PROMOTION","PWA","Accepted - Installed"):BFN.BfnService.track("PROMOTION","PWA","Accepted - Not Installed")})},onCancel:a=>{BFN.BfnService.track("PROMOTION","PWA",`Dismissed - ${a?"Ask me later":"Click outside / Escape"}`)}});return r&&BFN.BfnService.track("PROMOTION","PWA","Shown"),r}function t(){BFN.SettingsManager.getSetting("use_case").then(r=>{r||BeFunky.isModalOpen()||gn()})}}};BFN.SingletonQueue.add(()=>{BFN.AppSectionManager=new xB});var TB=class{constructor(){this.init()}init(){BeFunky.log("TextureHistoryManager Init"),this.initDefaultValues()}initDefaultValues(){this.validViewStates=[BFN.AppModelViewStates.VIEWING_PHOTO_EDITOR,BFN.AppModelViewStates.VIEWING_COLLAGE_MAKER,BFN.AppModelViewStates.VIEWING_DESIGNER],this.historyHash={},this.historyModifiedHash={},this.validViewStates.forEach(e=>{this.historyModifiedHash[e]=!1}),this.allowedTextureMegaBytes=BFN.textureHistoryMemoryLimitMB,this.minHistoryStates=2,BFN.PhotoEditorCanvasModel.addEventListener(BFN.PhotoEditorCanvasModelEvents.CLEAR_ITEMS.type,this.handlePhotoEditorCanvasModelClearItems.bind(this)),BFN.CollageMakerCanvasModel.addEventListener(BFN.CollageMakerCanvasModelEvents.CLEAR_ITEMS.type,this.handleCollageMakerCanvasModelClearItems.bind(this)),BFN.DesignerCanvasModel.addEventListener(BFN.DesignerCanvasModelEvents.CLEAR_ITEMS.type,this.handleDesignerCanvasModelClearItems.bind(this))}addTextureHistory(e,t=null,r=[]){if(t=t||BFN.AppModel.viewState,!this.validViewStates.includes(t))return;this.historyHash.hasOwnProperty(t)||(this.historyHash[t]={});let a=new BFN.TextureHistoryVO(e),s=this.historyHash[t];s.hasOwnProperty(e)&&(s[e].clear(),delete s[e]),s[e]=a,r.forEach(l=>{a.addUsedTexture(l)}),BFN.AppModel.sectionValue(BFN.PhotoEditorCanvas.transformLayer,BFN.CollageMakerCanvas.transformLayer,BFN.DesignerCanvas.transformLayer).children.filter(l=>l instanceof BFN.TransformItem).forEach(l=>a.addUsedTexture(l.itemContent.texture)),BFN.AppModel.viewState===BFN.AppModelViewStates.VIEWING_PHOTO_EDITOR&&BFN.PhotoEditorModel.currentTexture&&a.addUsedTexture(BFN.PhotoEditorModel.currentTexture),BFN.AppModel.viewState===BFN.AppModelViewStates.VIEWING_COLLAGE_MAKER&&(BFN.PhotoGrid.gridChildren.forEach(l=>{l.menuImageVO&&a.addUsedTexture(l.menuImageVO.imageTexture)}),a.addUsedTexture(BFN.CollageMakerCanvasPhotoGridModel.backgroundPatternTexture))}updateTextureHistory(e,t=null){if(t=t||BFN.AppModel.viewState,!this.validViewStates.includes(t))return;this.historyHash.hasOwnProperty(t)||(this.historyHash[t]={});let r=this.historyHash[t];for(let a in r)e.includes(parseInt(a))||(r[a].clear(),delete r[a])}getTextureHistory(e=null){return e=e||BFN.AppModel.viewState,this.validViewStates.includes(e)?(this.historyHash.hasOwnProperty(e)||(this.historyHash[e]={}),Object.assign({},this.historyHash[e])):{}}getBaseTextures(e=null,t=null){if(e=e||BFN.AppModel.viewState,!this.validViewStates.includes(e)||!this.historyHash.hasOwnProperty(e))return[];let r=[],a=this.historyHash[e];if(t instanceof Array)t.forEach(s=>{a.hasOwnProperty(s)&&a[s].baseTextures.forEach(n=>{!n._destroyed&&!r.includes(n)&&r.push(n)})});else for(let s in a)a[s].baseTextures.forEach(n=>{!n._destroyed&&!r.includes(n)&&r.push(n)});return r}getTextureHistoryStatus(e=null){if(e=e||BFN.AppModel.viewState,!this.validViewStates.includes(e))return;this.historyHash.hasOwnProperty(e)||(this.historyHash[e]={});let t=this.getTextureHistory(e),r=[];for(let o in t)r.push(parseInt(o));r.sort((o,n)=>o-n);let a=this.getBaseTextures(e),s=BFN.Util.getBaseTexturesMemoryMB(a);return{textureHistory:t,timestamps:r,baseTextures:a,megabytes:s}}getTextureHistoryStatusComplete(){return{editor:this.getTextureHistoryStatus(BFN.AppModelViewStates.VIEWING_PHOTO_EDITOR),collage:this.getTextureHistoryStatus(BFN.AppModelViewStates.VIEWING_COLLAGE_MAKER),designer:this.getTextureHistoryStatus(BFN.AppModelViewStates.VIEWING_DESIGNER)}}getTotalTextureHistoryMemoryMB(){let e=0,t=this.getTextureHistoryStatusComplete();for(let r in t)e+=t[r].megabytes;return e}printTextureHistory(e=null){}clearTextureHistory(e=null){if(e=e||BFN.AppModel.viewState,!this.validViewStates.includes(e)||!this.historyHash.hasOwnProperty(e))return;let t=[],r=[...this.validViewStates];r.splice(r.indexOf(e),1),r.forEach(s=>{this.getBaseTextures(s).forEach(n=>{t.includes(n)||t.push(n)})});let a=this.historyHash[e];for(let s in a){let o=a[s];o.baseTextures.forEach(n=>{!t.includes(n)&&!n._destroyed&&n.destroy()}),o.clear(),delete a[s]}}cleanupTextureHistory(e=null,t=null,r=null){e=e||BFN.AppModel.viewState,t=typeof t=="number"?t:Math.max(0,Math.min(this.allowedTextureMegaBytes,BFN.textureHistoryMemoryLimitMB-BFN.AppModel.getAppTextureMemoryMB())),r=typeof r=="number"?r:this.minHistoryStates;let a=!1;if(this.validViewStates.includes(e)){let s=this.getTextureHistoryStatus(e);if(s.megabytes>t&&s.timestamps.length>r){let o=[],n=s.timestamps.length;for(;--n>=s.timestamps.length-r;)o.push(s.timestamps[n]);let l=this.getBaseTextures(e,o);l.includes(BFN.PhotoEditorModel.sourceTexture.baseTexture)||l.push(BFN.PhotoEditorModel.sourceTexture.baseTexture);let c=BFN.Util.getBaseTexturesMemoryMB(l),h=[...this.validViewStates];h.splice(h.indexOf(e),1),h.forEach(d=>{this.getBaseTextures(d).forEach(p=>{l.includes(p)||l.push(p)})});let u=-1;for(n=s.timestamps.length-r;--n>-1;){let d=s.timestamps[n],m=this.getBaseTextures(e,[d]);if(m.length){let p=!0,g=[];m.forEach(v=>{l.includes(v)||(p=!1,g.includes(v)||g.push(v))});let f=BFN.Util.getBaseTexturesMemoryMB(g);if(!p){let v=c+f;if(v>t){u=d;break}else l.push(...g),c=v}}}if(e===BFN.AppModelViewStates.VIEWING_PHOTO_EDITOR&&s.timestamps.length>1){let d=BFN.PhotoEditorHistoryModel.getTimestamp(),m=BFN.PhotoEditorHistoryModel.getLastTimestamp(),p=s.timestamps[s.timestamps.length-1];!isNaN(p)&&!isNaN(d)&&isNaN(m)&&p==d&&(u=s.timestamps[s.timestamps.length-2])}if(u>=0){let d=this.purgeEarlierTextureHistory(e,u,l);a=!0,this.historyModifiedHash[e]=!0}}}return a}purgeEarlierTextureHistory(e,t,r){let a=0;return a+=BFN.TransformStateModel.purgeEarlierTransitions(e,t,r),e===BFN.AppModelViewStates.VIEWING_PHOTO_EDITOR&&(a+=BFN.PhotoEditorHistoryModel.purgeEarlierHistory(t,r)),e===BFN.AppModelViewStates.VIEWING_COLLAGE_MAKER&&(a+=BFN.CollageMakerHistoryModel.purgeEarlierHistory(t,r)),a}handlePhotoEditorCanvasModelClearItems(e){this.historyModifiedHash[BFN.AppModelViewStates.VIEWING_PHOTO_EDITOR]=!1}handleCollageMakerCanvasModelClearItems(e){this.historyModifiedHash[BFN.AppModelViewStates.VIEWING_COLLAGE_MAKER]=!1}handleDesignerCanvasModelClearItems(e){this.historyModifiedHash[BFN.AppModelViewStates.VIEWING_DESIGNER]=!1}};BFN.SingletonQueue.add(()=>{BFN.TextureHistoryManager=new TB});var FB=class{constructor(){this.init()}init(){BFN.ShaderPool={},this.cnt=0,this.setupFilters=[{key:"ColorFilter",cls:BFN.filters.ColorFilter},{key:"ExposureFilter",cls:BFN.filters.ExposureFilter},{key:"FillLightFilter",cls:BFN.filters.FillLightFilter},{key:"BeautifyFilter",cls:BFN.filters.BeautifyFilter},{key:"VibranceFilter",cls:BFN.filters.VibranceFilter},{key:"ColorMixerFilter",cls:BFN.filters.ColorMixerFilter},{key:"BrushFilter",cls:BFN.filters.BrushFilter},{key:"ColorReplaceFilter",cls:BFN.filters.ColorReplaceFilter},{key:"GaussianBlurFilter",cls:BFN.filters.GaussianBlurFilter,type:"filter"},{key:"LevelsFilter",cls:BFN.filters.LevelsFilter,type:"filter"},{key:"InvertShader",cls:BFN.filters.InvertShader},{key:"FillAlphaShader",cls:BFN.filters.FillAlphaShader},{key:"AlphaToLumaShader",cls:BFN.filters.AlphaToLumaShader},{key:"LumaToAlphaShader",cls:BFN.filters.LumaToAlphaShader}]}createShaderPool(e){if((BFN&&typeof BFN.ObjectRenderer!="undefined"&&typeof BFN.ObjectRenderer.gl!="undefined"?BFN.ObjectRenderer.gl:BFN&&typeof BFN.Stage!="undefined"&&typeof BFN.Stage.gl!="undefined"?BFN.Stage.gl:null)===null){e();return}if(this.cnt<this.setupFilters.length){let r=this.setupFilters[this.cnt];BFN.ShaderPool[r.key]=typeof r.type!="undefined"&&r.type=="filter"?new r.cls:new r.cls(BFN.ObjectRenderer.gl),this.cnt++,requestAnimationFrame(function(){this.createShaderPool(e)}.bind(this))}else e()}};BFN.ShaderManager=new FB;var bB=class{constructor(){this.init()}init(){this.initDefaultValues()}initDefaultValues(){this._settings={autosave:"ask",language:BeFunky.LanguageManager.language.app,artsy_fav:[],effects_fav:[],texture_fav:[],watermarks:[],batch_processing_fav:[],fonts_fav:[],fonts_added:[],colors_recent:[],color_library:[],use_case:"",snapping:"yes",display_distances:"no",guides:"no",dismissed_messages:[],trialing:"",theme_color:Ii(),canvas_bg_color:ht().name};let e=Object.keys(this._settings);this.nonLocalSettings=["language","artsy_fav","effects_fav","texture_fav","watermarks","fonts_added","trialing","color_library","theme_color","canvas_bg_color"],this.localSettings={},this.remoteSettings={},this.allowLocalSaving=!1,this.allowRemoteSaving=!1,this.getLocalSettings=Promise.all(e.filter(t=>!this.nonLocalSettings.includes(t)).map(t=>BFN.IndexedDB.get(`options__${t}`).then(r=>{this.localSettings[t]=r},()=>{}))),this.getRemoteSettings=new Promise(t=>{if(BFN.BfnService.userLoggedIn)return t(this.fetchRemoteSettings());t(),this.handleLoginBind=this.handleLogin.bind(this),BFN.BfnService.addEventListener(BFN.BfnServiceEvents.USER_DATA_CHANGED.type,this.handleLoginBind)}),this.settingsReady=Promise.all([this.getLocalSettings,this.getRemoteSettings]),this.settingsReady.then(()=>{this.allowLocalSaving=!0,e.forEach(t=>{if(this.isValid(t,this.remoteSettings[t])){if(t==="language")return;this.updateSetting(t,this.remoteSettings[t],{updateUI:!1,source:"API"})}else this.isValid(t,this.localSettings[t])&&this.updateSetting(t,this.localSettings[t],{updateUI:!1,source:"IndexedDB"});let r=JSON.parse(JSON.stringify(this._settings[t]));this.updateUI(t,r)})}),this.uiReady=!1,this.queuedUiUpdates={},window.addEventListener("INIT_COMPLETE",()=>{BFN.MainUI.addIdleRenderFunction(()=>{this.uiReady=!0,Object.values(this.queuedUiUpdates).forEach(t=>t())})}),this.persistSettings=BeFunky.debounce(this.persistSettings.bind(this),1e3),this.persistToAPILazyTimeout=null,Hr(t=>{this.updateSetting("theme_color",t,{updateUI:!1})},!1),ui(({name:t})=>{this.updateSetting("canvas_bg_color",t,{updateUI:!1})})}handleSettingUpdate(){let e=UITools.getToolValue("user_settings","updating_id"),t=UITools.getControlValue(`user_settings_${e}`);this.updateSetting(e,t,{source:"Settings Modal"})}handleLogin(){!BFN.BfnService.userLoggedIn||(BFN.BfnService.removeEventListener(BFN.BfnServiceEvents.USER_DATA_CHANGED.type,this.handleLoginBind),this.settingsReady=new Promise(e=>{this.fetchRemoteSettings().then(()=>{this.log("Fetched user settings from API"),Object.keys(this._settings).forEach(t=>{if(t!=="language"&&!!this.isValid(t,this.remoteSettings[t])){if(t==="batch_processing_fav"){let r=!this.remoteSettings[t].length,a=!this._settings[t].isIdenticalTo(BFN.BatchToolManager.defaultBatchToolIDs);if(r||a){this.updateSetting(t,[...this._settings[t],...this.remoteSettings[t]].unique(),{source:"Local + API"});return}}if(t==="dismissed_messages"){let r=o=>o.endsWith("_clue"),a=!this.remoteSettings[t].find(r),s=this._settings[t].filter(r);if(a&&s.length){this.updateSetting(t,[...this.remoteSettings[t],...s].unique(),{source:"Migrated help clues"});return}}this.updateSetting(t,this.remoteSettings[t],{source:"API"})}}),e()}).catch(t=>{BeFunky.throwError("Unable to fetch remote settings after user login",t),e()})}))}isValidID(e){return this._settings.hasOwnProperty(e)}isValid(e,t){return BeFunky.SettingsService.isValid(e,t)}getSetting(e){if(!this.isValidID(e))throw"Invalid setting ID";return this.settingsReady.then(()=>this._settings[e])}updateSetting(e,t,{updateUI:r=!0,source:a=""}={}){if(!this.isValidID(e))throw console.log({id:e}),"Invalid setting ID";if(!this.isValid(e,t))throw console.log({id:e,value:t}),"Invalid setting value";Array.isArray(t)&&(t=t.slice(),t.unique());let s=JSON.stringify(t);JSON.stringify(this._settings[e])!==s&&(this.log(`Update setting${a?` from ${a}`:""}:`,e,this._settings[e],"->",t),this._settings[e]=JSON.parse(s),r&&this.updateUI(e,JSON.parse(s)),this.persistSettings())}updateUI(e,t){let r={autosave:()=>{UITools.setControlValue(`user_settings_${e}`,t,!1),UITools.updateToolControl(`user_settings_${e}`)},language:()=>{BeFunky.LanguageManager.setLanguage(t,["app"]),UITools.setToolValue("language","select",t),UITools.updateToolControls("language")},artsy_fav:()=>{BFN.BfnService.userLoggedIn&&BFN.FavoritesManager.handleFavoritesLoaded("artsy",t)},effects_fav:()=>{BFN.BfnService.userLoggedIn&&BFN.FavoritesManager.handleFavoritesLoaded("effect",t)},watermarks:()=>{BFN.BfnService.userIsPlus&&BFN.WatermarkManager.loadWatermarkPresets(t)},texture_fav:()=>{},batch_processing_fav:()=>{BFN.BatchToolManager.selectedIDs=t},fonts_fav:()=>{BFN.FontManager.fontMenuComponent?BFN.FontManager.fontMenuComponent.setState({favorites:t}):BFN.FontManager.favorites=t},fonts_added:()=>{if(!BFN.BfnService.userIsPlus)return;let a=t.map(({name:n})=>n).unique(),s=t.filter(({type:n})=>n==="google"),o=t.filter(({type:n})=>n==="uploaded");s.forEach(({name:n,weights:l})=>{BFN.FontManager.addUserDefinedFontFromSettings(n,"google",{weights:l,updateIfDuplicate:!0})}),o.reduce((n,{name:l,weight:c,fileName:h})=>{let u=n.find(m=>m.name===l);if(u)return u.weights=[...u.weights,c],u.files=[...u.files,{weight:c,fileName:h}],n;let d=new $i(l,"uploaded",[c],{isUserDefined:!0,files:[{weight:c,fileName:h}]});return[...n,d]},[]).forEach(({name:n,weights:l,files:c})=>{BFN.FontManager.addUserDefinedFontFromSettings(n,"uploaded",{weights:l,files:c,updateIfDuplicate:!0})}),BFN.CONST.FONT_LIST.filter(({isUserDefined:n,type:l,name:c})=>n&&l!=="system"&&!a.includes(c)).forEach(({name:n})=>{BFN.FontManager.removeUserDefinedFont(n)})},colors_recent:()=>{BFN.ColorPickerPanel.recentColors=t},color_library:()=>{BFN.ColorPickerPanel.colorLibraries=t},use_case:()=>{},snapping:()=>{UITools.setControlValue(`alignment_${e}`,t==="yes",!1),UITools.updateToolControl(`alignment_${e}`),UITools.applyToolControl(`alignment_${e}`)},display_distances:()=>{UITools.setControlValue(`alignment_${e}`,t==="yes",!1),UITools.updateToolControl(`alignment_${e}`),UITools.applyToolControl(`alignment_${e}`)},guides:()=>{UITools.setControlValue(`alignment_${e}`,t==="yes",!1),UITools.updateToolControl(`alignment_${e}`),UITools.applyToolControl(`alignment_${e}`)},dismissed_messages:()=>{},trialing:()=>{},theme_color:()=>{fh(t),this.hideSettingsModalOverlay(),UITools.setControlValue("user_settings_theme_color",t,!1),UITools.updateToolControl("user_settings_theme_color"),UITools.applyToolControl("user_settings_theme_color")},canvas_bg_color:()=>{xh(t),this.hideSettingsModalOverlay(),UITools.setControlValue("user_settings_canvas_bg_color",t,!1),UITools.updateToolControl("user_settings_canvas_bg_color"),UITools.applyToolControl("user_settings_canvas_bg_color")}};if(this.uiReady||e==="fonts_added")return r[e]();this.queuedUiUpdates[e]=()=>r[e]()}persistSettings(){if(!this.allowLocalSaving)return this.persistSettings();this.persistToIndexedDB(),this.persistToAPI()}persistToIndexedDB(){let e=this.diffSettings(this.localSettings,this.nonLocalSettings),t=Object.keys(e);!t.length||(this.ifLoggingEnabled(()=>{this.log(`Writing ${t.length} setting(s) to IndexedDB`);let r=t.reduce((a,s)=>Si(It({},a),{[s]:{"Current IndexedDB Value":JSON.stringify(this.localSettings[s]),"New Value":JSON.stringify(e[s])}}),{});console.table(r)}),Object.entries(e).forEach(([r,a])=>{BFN.IndexedDB.set(`options__${r}`,a).then(()=>{this.localSettings[r]=a},s=>BeFunky.logError(`Unable to update local setting ${r}`,s))}))}persistToAPI(e=!0){let t=this.allowRemoteSaving?[]:Object.keys(this._settings).filter(s=>s!=="language"),r=this.diffSettings(this.remoteSettings,t),a=Object.keys(r);if(!!a.length){if(e&&a.isIdenticalTo(["colors_recent"])){this.persistToAPILazyTimeout||(this.persistToAPILazyTimeout=setTimeout(()=>{this.persistToAPILazyTimeout=null,this.persistToAPI(!1)},1e3*60*2));return}this.ifLoggingEnabled(()=>{this.log(`Sending ${a.length} setting(s) to API`);let s=a.reduce((o,n)=>Si(It({},o),{[n]:{"Current Remote Value":JSON.stringify(this.remoteSettings[n]),"New Value":JSON.stringify(r[n])}}),{});console.table(s)}),BeFunky.SettingsService.updateUserSettings(r,({error:s,success:o})=>{if(s)return BeFunky.logError("Unable to update remote settings",s);this.remoteSettings=Object.assign(this.remoteSettings,r)})}}diffSettings(e,t=[]){let r={};return Object.entries(this._settings).forEach(([a,s])=>{t.includes(a)||!e.hasOwnProperty(a)&&Array.isArray(s)&&!s.length||JSON.stringify(e[a])!==JSON.stringify(s)&&(r[a]=s)}),r}fetchRemoteSettings(){return new Promise(e=>{BeFunky.SettingsService.getUserSettings(({error:t,settings:r})=>{if(t)return BeFunky.logError("Unable to get settings from API",t),e();this.remoteSettings=Object.assign({},r),this.allowRemoteSaving=!0,e()})})}hideSettingsModalOverlay(){this.resetModalOverlay&&this.resetModalOverlay();let e=BeFunky.getModal();if(!e||e.modalID!=="settings_menu")return;let t=e.modalElement.closest("#modal_root");t.children.length>1||(t.setStyles({transition:"background 0.3s ease-in-out"}),this.resetModalOverlay=BeFunky.wait(["raf","raf"],()=>{t.setStyles({background:"transparent"}),this.resetModalOverlay=BeFunky.wait([5e3],()=>{t.setStyles({background:""}),this.resetModalOverlay=BeFunky.wait([300],()=>{t.setStyles({transition:""})})})}))}log(...e){BeFunky.logFeature("settings",...e)}ifLoggingEnabled(e){BeFunky.loggingFlags.includes("settings")&&e()}};BFN.SingletonQueue.add(()=>{BFN.SettingsManager=new bB});var Os={manage_font:[{type:"header",langID:"font_clue_title"},{type:"text",langID:"font_clue_manage_body"},{type:"link",langID:"learn_more",url:"https://support.befunky.com/hc/en-us/articles/360001571631-How-Do-I-Add-My-Fonts-To-BeFunky-"}],template_library:[{type:"text",langID:"guide_template_library"}],global_history:[{type:"text",langID:"guide_global_history"}],collage_wizard:[{type:"text",langID:"guide_collage_wizard_next"}],alignment_options:[{type:"text",langID:"guide_alignment_options"},{type:"link",langID:"learn_more",url:`${BeFunky.Params.blogUrl}snap-lines/`}],batch_processing:[{type:"text",langID:"guide_batch_upload_steps"},{type:"text",langID:["guide_batch_edit_steps",{icon:BeFunky.getSvgHtml("batch-processing-icon",{classes:"icon icon--14"})}]},{type:"link",langID:"learn_more",url:`${BeFunky.Params.blogUrl}batch-processing-photos/`}],batch_upload:[{type:"header",langID:"guide_batch_upload"},{type:"text",langID:"guide_batch_upload_steps"}],batch_edit:[{type:"header",langID:"guide_batch_edit"},{type:"text",langID:["guide_batch_edit_steps",{icon:BeFunky.getSvgHtml("batch-processing-icon",{classes:"icon icon--14"})}]}],batch_icon:[{type:"text",langID:["batch_icon_guide_1",{icon:BeFunky.getSvgHtml("batch-processing-icon",{classes:"icon icon--14"})}]},{type:"text",langID:"batch_icon_guide_2"}],project_manager:[{type:"text",langID:"project_manager_drag_to_folder"}],skin_heal:{},wrinkles:{},blemish_fix:{},clone:{},bronzer:{},blush:{},flashspot:{},mascara:{},eye_color:{},eye_brighten:{},eyebrow_pencil:{},fix_redeye:{},lipstick:{},teeth_whiten:{},hair_color:{},reshape:{},background:{},lens_blur:{},funky_focus:{},vignette:{},blur:{},levels:{},edits:{},touch_up:{},effects:{},lens_flare:{},frames:{},overlays:{},text:{},textures:{},image_properties:{},image_manager:{},graphic_properties:{},collage_customize:{},collage_layouts:{},text_properties:{},graphics:{},choose_font:{},layers_groups:{},resize_template:{},template_search:{},replace_color:{},erase_mode:{},cutout:{},artsy:{}},yn={};Object.keys(Os).forEach(i=>{Array.isArray(Os[i])?yn[i]={content:Os[i],visibility:"HIDDEN",popover:null,renderContent:()=>{BeFunky.throwError("Help clue popover not set up yet")}}:yn[i]={content:Os[i],visibility:"HIDDEN",isMultimediaClue:!0}});var vt=yn;var{elem:WM,html:Qr,appLang:Fa,render:$M,icon:jM}=BeFunky.lit,BB=class{constructor(){this.init()}init(){this.clueIDs=Object.keys(vt),this.hasFetchedClues=!1,this.cluesIDsDismissedThisSession=[],this.mainMenuContainer=document.getElementById("main_menu_panels"),BFN.AppModel.addEventListener(BFN.AppModelEvents.VIEWSTATE_UPDATED.type,()=>{let e=["VISIBLE","PENDING"];this.clueIDs.filter(t=>e.includes(vt[t].visibility)&&vt[t].isMultimediaClue).forEach(t=>{this.hide(t)})})}setup(e,t){return this._setRenderOptions(e,t)}async show(e,{force:t=!1,allowTracking:r=!0,renderOptions:a}={}){if(BFN.cluesToHideOnTablet.find(l=>e===l)&&BeFunky.isTablet||!BeFunky.isWiderThanMobile()||!this._setRenderOptions(e,a))return!1;let s=vt[e];if(!this.hasFetchedClues){let l;s.visibility="PENDING";try{l=await BFN.HelpClueService.fetchHelpClues(),this._addClueDataFromPrismic(l,vt),this.hasFetchedClues=!0}catch(c){}if(s.visibility!=="PENDING"||!s.content)return s.visibility==="VISIBLE";s.visibility="HIDDEN"}if(t)return this._renderAndFadeIn(e),s.wasForceShown=!0,r&&BFN.BfnService.track("Help Clue",BFN.AppModel.sectionID,e),!0;if(this.clueIDs.some(l=>vt[l].visibility==="VISIBLE"&&vt[l].isMultimediaClue)&&(s.isMultimediaClue||this.mainMenuContainer.contains(s.popover)))return!1;s.visibility="PENDING";let n=await this.wasClueDismissed(e);return s.visibility!=="PENDING"?s.visibility==="VISIBLE":n?(s.visibility="HIDDEN",!1):(this._renderAndFadeIn(e),s.wasForceShown=!1,!0)}hide(e){if(!this._validateID(e))return;let t=vt[e];t.visibility!=="HIDDEN"&&(t.popover&&t.popover.hide(),t.isMultimediaClue&&BFN.HelpCenterManager.hide(),t.visibility="HIDDEN")}afterHide(e){if(!this._validateID(e))return;let t=vt[e];t.visibility==="VISIBLE"&&this._dismissClue(e),t.visibility="HIDDEN"}toggle(e,t,{renderOptions:r,force:a=!0}={}){if(!this._setRenderOptions(e,r))return Promise.resolve(!1);typeof t!="boolean"&&(t=vt[e].visibility==="HIDDEN"),t?this.show(e,{force:a}):this.hide(e)}wasClueDismissed(e){return this._validateID(e)?this.cluesIDsDismissedThisSession.includes(e)?Promise.resolve(!0):this._getDismissedIDs().then(t=>Boolean(t.find(r=>r===`${e}_clue`))):Promise.resolve(!1)}showWalkthrough(e){if(e.some(t=>!this._validateID(t)))return Promise.resolve(!1);if(!e.every(t=>vt[t].renderOptions))return BeFunky.throwError("Walkthrough clues not setup"),Promise.resolve(!1);this._getDismissedIDs().then(t=>e.every(r=>t.includes(`${r}_clue`))?!1:(e.slice(0,e.length-1).forEach((r,a)=>{vt[r].renderOptions.button={langID:"next",onClick:()=>this.show(e[a+1],{force:!0,allowTracking:!1})}}),e.slice(1).forEach(r=>{this.hide(r)}),this.show(e[0],{force:!0,allowTracking:!1}),!0))}handleMainMenuTransition(){let e=["VISIBLE","PENDING"];return this.clueIDs.filter(t=>e.includes(vt[t].visibility)).forEach(t=>{let{popover:r,wasForceShown:a,isMultimediaClue:s}=vt[t];r&&this.mainMenuContainer.contains(r)?this.hide(t):s&&!a&&this.hide(t)})}_validateID(e){return this.clueIDs.includes(e)?!0:(BeFunky.throwError(`Invalid help clue ID "${e}"`),!1)}_setRenderOptions(e,t){return this._validateID(e)?(t?vt[e].renderOptions=t:t=vt[e].renderOptions,vt[e].isMultimediaClue?!0:t?typeof t.container!="function"&&!(t.container instanceof HTMLElement)?(BeFunky.throwError(`No container for help clue "${e}"`,t.container),!1):!0:(BeFunky.throwError(`No render options for help clue "${e}"`),!1)):!1}_addClueDataFromPrismic(e,t){Object.entries(e).forEach(([r,a])=>{t[r]&&(t[r]={},t[r].content=a,t[r].visibility="HIDDEN",t[r].isMultimediaClue=!0)})}_getDismissedIDs(){return BFN.SettingsManager.getSetting("dismissed_messages")}_dismissClue(e){if(!this._validateID(e))return;vt[e].popover&&this.hide(e),this.cluesIDsDismissedThisSession.push(e);let t=`${e}_clue`;this._getDismissedIDs().then(r=>{r.includes(t)||BFN.SettingsManager.updateSetting("dismissed_messages",[...r,t])})}_renderAndFadeIn(e){let t=vt[e],{renderOptions:r,content:a,isMultimediaClue:s}=t;if(s){let l=["VISIBLE","PENDING"];this.clueIDs.filter(u=>l.includes(vt[u].visibility)&&vt[u].isMultimediaClue&&u!==e).forEach(u=>{this.afterHide(u)}),t.visibility="VISIBLE";let c=r&&r.top?r.top:"64px",h=r&&r.left?r.left:"336px";BFN.HelpCenterManager.show({view:"clue",headerText:e,articleId:a.kb_article_id,caption:a.caption,video:a.video},{top:c,left:h});return}t.popover?t.renderContent():(t.popover=this._createPopover(e),t.popover.strong=!0);let o=["left","right","top","zIndex"],n=["side","positionFactor","strong"];Object.entries(r).forEach(([l,c])=>{if(o.includes(l))t.popover.setStyles({[l]:c});else if(n.includes(l))t.popover[l]!==c&&(t.popover[l]=c);else if(l==="container"){let h=t.popover.parentElement;typeof c=="function"&&(c=c()),c instanceof HTMLElement?h!==c&&c.appendChild(t.popover):BeFunky.throwError(`Invalid container for help clue "${e}"`,c)}else l!=="button"&&BeFunky.throwError(`Unknown help clue render option "${l}"`)}),t.visibility="VISIBLE",requestAnimationFrame(()=>{t.visibility==="VISIBLE"&&t.popover.show()})}_createPopover(e){let t=WM`<div class="popover"></div>`;return BFN.UI.popover(t),this._addContent(e,t.container),t}_addContent(e,t){let r=vt[e],{content:a,renderOptions:s}=r,o={header:({langID:m})=>Qr`<h5 class="help-clue__item help-clue__header">${Fa(m)}</h5>`,text:({langID:m})=>Qr`<p class="help-clue__item">${Fa(m)}</p>`,icon_text:({langID:m,iconID:p,isPlusBadge:g,iconSize:f=16})=>{if(g)return Qr`<p class="help-clue__item help-clue__icon-text">
                        <span class="badge badge--plus help-clue__icon"></span>
                        <string>${Fa(m)}</string>
                    </p>`;let v=(18-f)/2;return Qr`
                <p class="help-clue__item help-clue__icon-text">
                    ${jM(p,`icon icon--${f} help-clue__icon`,{style:`margin-top: ${v}px;`})}
                    <string>${Fa(m)}</string>
                </p>`}},n=({langID:m,url:p,linkTracking:g=""})=>Qr`
            <a class="help-clue__link" href=${p} target="_blank" rel="noopener" data-bfntrack=${g}>${Fa(m)}</a>
        `,l=a.find(({type:m})=>m==="link"),c=m=>m.hideIfPremium&&BeFunky.isPlus()||!o[m.type]?"":o[m.type](m),h=()=>{let m=()=>{s.button&&s.button.onClick&&s.button.onClick(),this._dismissClue(e)},p=s.button&&s.button.langID?s.button.langID:"ok_got_it";return Qr`<button @click=${m} class="help-clue__dismiss button button--blue button--xs">${Fa(p)}</button>`},u=()=>Qr`
        <div class="help-clue" style="width: 288px">
            ${a.map(c)}
            <div class="help-clue__footer">
                ${l?n(l):""}
                ${h()}
            </div>
        </div>
        `,d=()=>$M(u(),t);BeFunky.LanguageManager.addLanguageUpdateListener(d),a.find(m=>m.hideIfPremium)&&BFN.BfnService.addEventListener(BFN.BfnServiceEvents.USER_DATA_CHANGED.type,d),d(),r.renderContent=d}};BFN.SingletonQueue.add(()=>{BFN.HelpClueManager=new BB});var{html:et,lang:YM,icon:ba,defineCustomElement:qM,useState:Ci,useEffect:xn,useLayoutEffect:KM,elem:Tn,styleMap:SB}=BeFunky.lit;function Fn(){qM("multimedia-clue",JM)}function JM({data:i={}}){let{view:e,categoryId:t,sectionId:r,headerText:a,articleId:s,video:o="",caption:n="",query:l}=i,c=this,h="https://support.befunky.com/hc/en-us/",[u,d]=Ci(""),[m,p]=Ci(""),[g,f]=Ci(),[v,T]=Ci("right"),[x,B]=Ci(0),[y,F]=Ci(0),[b,S]=Ci(null),[I,_]=Ci([]),[E,D]=Ci([]),[w,N]=Ci([]),[M,z]=Ci({}),[W,j]=Ci({}),[J,ie]=Ci([]);c.zIndexOverFabric=!0,xn(()=>{Nt()},[]),xn(()=>{if(!g)return;let te=BeFunky.debounce(()=>{let fe=oe();v!==fe&&T(fe)},100);return window.addEventListener("resize",te),()=>window.removeEventListener("resize",te)},[g]),xn(()=>{b&&S(null),e==="article"&&Te(),e==="search"&&(F(0),j(!0),BFN.HelpClueService.fetchSearchResults(l).then(te=>{j(!1),ie(te)}).catch(te=>{te!=="request_failed"?BeFunky.reportWarning("Error searching Help Center articles",te,l):BeFunky.logWarning("Request failed searching Help Center articles",te,l),j(!1),S({error:te,action:()=>Ge(l)})})),e==="clue"&&(ue(s),F(32)),e==="category"&&((!I.length||!E.length||!w.length)&&Nt(),F(0)),e==="home"&&(!I.length||!E.length||!w.length)&&Nt()},[i]),c._isSetup||(c._isSetup=!0,$()),KM(()=>{if(!o)return;let te=c.querySelector("video");te&&te.load()},[o]);let re={handleEvent(te){let fe=240,ve=te.target.scrollTop;(ve<fe||x<fe)&&B(ve);let Ee=32,pt=te.target.scrollHeight-te.target.clientHeight-ve;(e==="clue"||e==="article")&&(pt<=Ee&&ve!==0?F(pt):y<32&&pt>=Ee&&F(32))},passive:!0};return he();function he(){return et`
            ${Ie()}
            <div class="multimedia-clue__content-container" @click=${H}>
                ${e==="clue"||e==="article"?ne():Z()}
                <div class="multimedia-clue__contact-us-wrapper">
                    ${Y()}
                </div>
            </div>
        `}function ne(){return et`
            ${ke()}
            ${Be()}
            <div class="multimedia-clue__content scrollable-content text-sm" @scroll="${re}" @click=${P}>
                ${o===""?"":et`<div class="multimedia-clue__video-placeholder"></div>`}
                ${_e()}
                ${le()}
                ${pe()}
                <div class="multimedia-clue__contact-us-placeholder"></div>
            </div>
        `}function le(){return m?et`
        <h4 class="multimedia-clue__title bold">
            ${m}
            <a href="${h}articles/${s}" target="_blank" rel="noopener" data-new-tab=true aria-label="Open Full Article" class="button button--icon button--link">
                ${ba("pop-out-icon","icon icon--close icon--12")}
            </a>
        </h4>
        `:""}function Be(){return o===""?"":et`
            <div class="multimedia-clue__video" style="${`transform: translateY(-${x}px)`}">
                 <video autoplay loop muted>
                    <source src="${o}" type="video/mp4">
                </video>
            </div>
        `}function _e(){return n===""?"":et`
            <div class="multimedia-clue__caption">
                <p>${YM(n)}</p>
            </div>
        `}function pe(){return b?A():et`
        <div class="multimedia-clue__kb-content" style="${u?"":"display: flex; justify-content: center; padding: 0 0 1rem;"}">
        ${u||et`<div class="loading-spinner"></div>`}
        </div>`}function Ie(){return et`
            <panel-header
                modifier="alternate"
                lang-id="${a}"
                buttons="${e==="home"?"close":"back,close"}"
                class="panel-header multimedia-clue__panel-header"
                @CLOSE=${K}
                @BACK=${ee}
                @drag=${q}
            >
            </panel-header>
        `}function ke(){if(!g)return"";let te=g.type==="image"?et`<img src="${g.src}" alt="${g.alt||""}">`:et`<iframe
                src="https://player.vimeo.com/video/${g.vimeoId}?title=1&portrait=0&byline=0&badge=0&autoplay=1${g.unlistedVimeoId?`&h=${g.unlistedVimeoId}`:""}"
                allow="autoplay; fullscreen"
                title="${g.videoTitle}"
            ></iframe>`,fe=ae(),ve=624,Ee=g.type==="image"?{}:{height:`${Math.ceil(ve/g.aspectRatio)}px`,background:"black"};return v==="center"?et`
                <div class="multimedia-clue__preview-overlay" @click="${V}">
                    ${de(fe,Ee,te)};
                </div>
            `:et`${de(fe,Ee,te)}`}function de(te,fe,ve){return et`
            <div class="multimedia-clue__preview-container" style=${SB(te)}>
                <div class="multimedia-clue__preview-content" style=${SB(fe)}>
                    ${ve}
                    <button aria-label="Close Preview" class="button button--icon button--white-outline-notheme" @click="${V}">
                        ${ba("cancel-icon","icon icon--close icon--12")}
                    </button>
                </div>
            </div>
        `}function Z(){let te=["multimedia-clue__help-center-content",e==="home"?"multimedia-clue__help-center-content--home":"","scrollable-content"].filter(Boolean).join(" ");return et`
            <div class="multimedia-clue__help-center-container">
                ${k()}
                <div class=${te}>
                    ${U()}
                    <div class="multimedia-clue__contact-us-placeholder"></div>
                </div>
            </div>
        `}function U(){if(b)return A();if(e==="home"&&M||e==="search"&&W||e==="category"&&M||e==="section"&&M)return et`<div style="margin: 0 auto; display: flex;" class="loading-spinner"></div>`;if(e==="home")return G();if(e==="search")return R();if(e==="category")return L();if(e==="section")return X()}function k(){return et`
            <form role="search" class="search-box multimedia-clue__search-box" @submit=${te=>ge(te)}>
                <input type="search" name="search-value" class="input search-box__input multimedia-clue__search-input" placeholder="Search Help Center" required>
                <button type="reset" class="button button--icon button--md button--white-outline search-box__clear">
                    ${ba("cancel-icon","icon icon--12")}
                </button>
                <button type="submit" class="button button--icon button--md button--white-outline search-box__submit">
                    ${ba("search-icon","icon")}
                </button>
            </form>
        `}function G(){return I.map(te=>{let{id:fe,name:ve,description:Ee}=te;return et`
                <div class="multimedia-clue__home">
                    <p class="text-md"><a class="multimedia-clue__category-link" href="${h}categories/${fe}">${ve}</a>
                    <span class="multimedia-clue__category-description text-sm">${Ee}</span></p>
                </div>
            `})}function L(){if(!(!w.length||!E.length))return w.filter(te=>te.categoryId.toString()===t).map(te=>{let{name:fe,id:ve}=te,Ee=E.filter(pt=>pt.sectionId===ve);return et`
                <div class="multimedia-clue__categories">
                    <h4 class="text-md bold">${fe}</h4>
                    ${Ee.slice(0,6).map(pt=>et`<p class="multimedia-clue__article-link text-sm"><a href="${h}articles/${pt.id}">${pt.title}</a></p>`)}
                    ${Ee.length>6?et`<button class="button button--sm button--blue" @click=${()=>C(ve,fe)}>See All ${Ee.length} Articles</button>`:""}
                </div>
            `})}function R(){return J.length?et`
            <h4 class="text-md bold">${`Search results for "${l}"`}</h4>
            ${J.map(te=>et`<p class="multimedia-clue__article-link text-sm"><a href="${h}articles/${te.id}">${te.title}</a></p>`)}
        `:et`
                <div class="multimedia-clue__no-results">
                    <img src="${BFN.imagesURL}illustrations/no-search-results-canvas.svg">
                    <p>Sorry we couldn't find any search results for <span class="bold">${l}</span></p>
                </div>
            `}function A(){return et`
            <div class="multimedia-clue__error-state">
                <p>${BeFunky.failureReason(b.error)}</p>
                <button class="button button--xs button--white-outline-notheme" @click=${()=>b.action()}>Try Again</button>
            </div>
        `}function X(){return et`
            ${E.filter(te=>te.sectionId===r).map(te=>et`<p class="multimedia-clue__article-link text-sm"><a href="${h}articles/${te.id}">${te.title}</a></p>`)}
        `}function Y(){if(e==="home")return"";let te=e==="clue"||e==="article"?"Need more Help?":"Can't find what you're looking for?";return et`
        <div class="multimedia-clue__contact-us" style="${`transform: translateY(${y}px)`}">
            <p class="text-xs">${te} <a href="${h}requests/new" target="_blank" rel="noopener">Contact Us</a></p>
        </div>
        `}function ae(){let te=c.panelSize.width,fe=c.panelSize.height,ve=624,Ee=10;return v==="right"?{top:0,alignItems:"center",left:`${te+Ee}px`}:v==="left"?{top:0,alignItems:"center",left:`${-ve-Ee}px`}:v==="center"?{position:"static","z-index":3}:v==="bottom-left"?{top:`${fe+Ee}px`,right:0}:v==="bottom-right"?{top:`${fe+Ee}px`,left:0}:v==="top-left"?{top:`${-fe-Ee}px`,right:0,alignItems:"flex-end"}:v==="top-right"?{top:`${-fe-Ee}px`,left:0,alignItems:"flex-end"}:{display:"none"}}function H(te){if(te.target.nodeName!=="A"||te.metaKey||te.ctrlKey)return;let fe=te.target.href.replace(/^.*\/\/[^/]+/,"");if(BeFunky.isCreateRoute(fe)){let yi=fe.split("?")[0].split("#")[0].replace(/\/$/,"").split("/").pop(),{type:ki="photoeditor"}=window.deepLinkRouteData[yi]||{};(ki==="collage"||ki==="designer"?ki:"editor")!==BFN.AppModel.sectionID&&BFN.AppModel.changeAppSection(ki),te.preventDefault();return}if(!te.target.href.includes(h))return;let ve=/(categories|articles)\/(\d+)/;if(te.target.href.includes(h)&&!te.target.href.match(ve)||te.target.dataset.newTab)return;te.preventDefault();let Ee=te.target.href,hi=Ee.replace(h,"").match(ve);if(!hi){BeFunky.logWarning("No id or category for Help Center link",Ee);return}let[,Bi,pr]=hi;if(Bi==="categories"){let yi=I.find(ki=>ki.id.toString()===pr);c.handleNavigate({view:"category",headerText:yi.name,categoryId:pr.toString()})}if(Bi==="articles"){let yi=E.find(wa=>wa.id.toString()===pr);if(yi===void 0){BeFunky.throwError("Invalid link for Help Center article",`ID: ${pr}`,te.target.href);return}let{id:ki,sectionId:Rr}=yi,{name:so}=w.find(wa=>wa.id===Rr);c.handleNavigate({view:"article",articleId:ki,headerText:so})}}function V(){f()}function K(){f(),BFN.HelpCenterManager.hide()}function ee(){c.handleBack()}function se(te){if(!te)return;let fe=te.trim();!fe||c.handleNavigate({view:"search",headerText:"Help Center",query:fe})}function ge(te){te.preventDefault();let ve=new FormData(te.target).get("search-value");se(ve)}function Ce(){S(null),Nt()}function Ne(){S(null),ue(s)}function Ge(te){S(null),se(te)}function ze(){S(null),Te()}function C(te,fe){c.handleNavigate({view:"section",headerText:fe,sectionId:te})}function P(te){let fe=te.target.hasClass("multimedia-clue__image-container"),ve=te.target.hasClass("multimedia-clue__vimeo-image");if(!fe&&!ve)return;let Ee;if(fe){let pt=te.target.querySelector("img");Ee={type:"image",src:pt.src,alt:pt.alt}}if(ve){let{vimeoId:pt,unlistedVimeoId:hi,aspectRatio:Bi,videoTitle:pr}=te.target;Ee={type:"video",vimeoId:pt,unlistedVimeoId:hi,aspectRatio:Bi,videoTitle:pr}}!Ee||(!g||JSON.stringify(Ee)!==JSON.stringify(g)?(f(Ee),T(oe())):f())}function $(){let te=new Promise(fe=>{let ve;BeFunky.waitUntil({condition:()=>(ve=c.querySelector(".multimedia-clue__panel-header"),ve),onTimeout:()=>{BeFunky.throwError("Failed to initialize draggable multimedia clue")},onSuccess:()=>{fe(ve)},interval:50,maxAttempts:20})});BFN.UI.draggablePanel(c,te,!0)}function q(){if(!g)return;let te=oe();v!==te&&T(te)}function oe(){let{appRect:te}=BFN,fe={top:parseInt(c.style.top),left:parseInt(c.style.left),width:c.panelSize.width,height:c.panelSize.height},ve={height:400,width:624},Ee=10;if(fe.left+fe.width+Ee+ve.width<te.width)return"right";if(ve.width+Ee<fe.left)return"left";if(fe.top+fe.height+Ee+ve.height<te.height){if(fe.left+Ee+ve.width<te.width)return"bottom-right";if(Ee+ve.width<te.width)return"bottom-left"}if(ve.height+Ee<fe.top){if(fe.left+Ee+ve.width<te.width)return"top-right";if(Ee+ve.width<te.width)return"top-left"}return"center"}function ue(te){f(),d(""),p("");let fe=c.querySelector(".multimedia-clue__content");fe&&(fe.scrollTop=0),BeFunky.requestAPI(`get/zendesk-article/${te}`).then(ve=>{let{zendesk_article:Ee,vimeo_images:pt}=ve.data,hi=Le(Ee.body,["em","span"]),Bi=we(hi,pt);d(Bi),p(Ee.title)}).catch(ve=>{ve!=="request_failed"?BeFunky.reportWarning("Unable to fetch Help Clue article",te,ve):BeFunky.logWarning("Request failed fetching Help Center article JSON",te,ve),S({error:ve,action:()=>Ne()})})}function Te(){F(32),f(),d(""),p(""),BFN.HelpClueService.fetchArticleContent(s).then(({article:te,vimeoImages:fe})=>{let ve=Le(te.body,["em","span"]),Ee=we(ve,fe);d(Ee),p(te.title)}).catch(te=>{te!=="request_failed"?BeFunky.reportWarning("Failed to fetch Help Center article",te,`Article Id: ${s}`):BeFunky.logWarning("Request failed fetching Help Center article",te,`Article Id: ${s}`),S({error:te,action:()=>ze()})})}function we(te,fe){let ve=document.createRange().createContextualFragment(te),Ee=ve.querySelectorAll(".callout--pro-tip");return We(Ee),Qe(ve.lastElementChild),Pt(ve),Zt(ve,fe),la(ve),gt(ve),ve}function Le(te,fe){return fe.forEach(ve=>{let Ee=new RegExp("<"+ve+">|</"+ve+">","g");te=te.replace(Ee,"")}),te}function We(te){te.forEach(fe=>{fe.addClass("pro-tip")})}function Qe(te){if(!te.innerText.includes("Looking for more inspiration"))return;let fe=te.querySelector("a");te.innerHTML="",te.append(Tn`<p><strong>Looking for more inspiration? Check out another tutorial:</strong><br> ${fe}</p>`)}function Pt(te){te.querySelectorAll(".image-with-lightbox").forEach(ve=>{let Ee=ve.firstElementChild;if(!Ee){BeFunky.reportWarning(`Check Zendesk article ${s}, img element not found within lightbox`);return}Ee.setAttribute("loading","lazy");let pt=Tn`
                <div class="multimedia-clue__image-container">
                    ${Ee}
                    <button aria-label="Expand Image" class="button button--icon button--white-outline-notheme">
                        ${ba("pop-out-icon","icon icon--12")}
                    </button>
                </div>
               `,hi=ve.parentNode;hi?hi.parentNode.insertBefore(pt,hi):te.insertBefore(pt,ve),ve.remove()})}function Zt(te,fe){let ve=Array.from(te.querySelectorAll("iframe"));return Object.entries(fe).forEach(([Ee,pt])=>{let{error:hi,images:Bi,title:pr}=pt,yi,ki;if(hi||!Bi)BeFunky.throwError("Unable to fetch multimedia clue Vimeo placeholder image",pt),yi={width:16,height:9,link:""},ki=16/9;else{let no=288*(BeFunky.isRetina()?1.5:1);yi=Bi.find(({width:rS})=>rS>no)||Bi[Bi.length-1],ki=yi.width/yi.height}let Rr=ve.find(no=>no.src.includes(Ee));if(!Rr){BeFunky.throwError(`Unable to find iFrame in article id ${s}, check markup in Zendesk`,hi);return}let so=Rr?ci(Rr.src):"",wa=Tn`
                <div class="multimedia-clue__vimeo-image" .vimeoId=${Ee} .unlistedVimeoId=${so} .aspectRatio=${ki} .videoTitle=${pr}>
                    <img src="${yi.link}" alt="${pr||"Play Video"}" width="${yi.width}" height="${yi.height}">
                    <button aria-label="Play Video" class="button button--icon button--white-outline-notheme">
                        ${ba("pop-out-icon","icon icon--12")}
                    </button>
                </div>
            `,oo=Rr.parentNode;if(!oo){BeFunky.throwError(`Unable to find iFrame Container in article id ${s}, check markup in Zendesk`);return}oo.parentNode.replaceChild(wa,oo)}),te}function ci(te){let fe=/\/[0-9]{8,}\/([0-9a-z]{8,})(\/|\?|$)/g.exec(te);if(fe)return fe[1];let ve=/[?&]h=([0-9a-z]{8,})(&|$)/g.exec(te);return ve?ve[1]:""}function la(te){Array.from(te.children).forEach(fe=>{fe.nodeName==="P"&&fe.innerHTML==="&nbsp;"&&fe.remove(),fe.nodeName==="DIV"&&fe.innerHTML==="&nbsp;"&&fe.remove()})}function gt(te){Array.from(te.querySelectorAll("a")).forEach(ve=>{ve.setAttribute("target","_blank"),ve.setAttribute("rel","noopener")})}function Nt(){let te=BFN.HelpClueService.fetchCategories(),fe=BFN.HelpClueService.fetchSections(),ve=BFN.HelpClueService.fetchArticles();z(!0),Promise.all([te,fe,ve]).then(Ee=>{let[pt,hi,Bi]=Ee;_(pt),N(hi),D(Bi),z(!1)}).catch(Ee=>{Ee!=="request_failed"?BeFunky.reportWarning("Error fetching Help Center data",Ee):BeFunky.logWarning("Request failed fetching Help Center data"),z(!1),S({error:Ee,action:()=>Ce()})})}}var IB=class{constructor(){this.init(),this.initClue()}init(){this.helpCenterClue=null,this.viewHistory=[]}initClue(){this.helpCenterClue||(Fn(),this.helpCenterClue=document.getElementById("multimedia_clue_haunted"),this.helpCenterClue.handleNavigate=this.handleNavigate.bind(this),this.helpCenterClue.handleBack=this.handleBack.bind(this))}show(e,t={top:"64px",right:"70px"}){switch(this.helpCenterClue.setStyles(It({top:"",left:"",right:"",bottom:""},t)),this.viewHistory=[{view:"home",headerText:"Help Center"}],BFN.AppModel.sectionID){case"editor":this.handleNavigate({view:"category",categoryId:"4404091282061",headerText:"Photo Editor"});break;case"collage":this.handleNavigate({view:"category",categoryId:"4404086264333",headerText:"Collage Maker"});break;case"designer":this.handleNavigate({view:"category",categoryId:"4404086268173",headerText:"Designer"});break}e&&this.handleNavigate(e),typeof this.helpCenterClue.show=="function"?this.helpCenterClue.show():BeFunky.wait([100,"raf"],()=>{this.helpCenterClue.show()})}hide(){this.helpCenterClue.hide(),this.dismissHelpClue()}toggleHelpCenter(){this.helpCenterClue.data&&this.helpCenterClue.data.view!=="clue"&&this.helpCenterClue.hasClass("active")?this.hide():(this.dismissHelpClue(),this.show())}dismissHelpClue(){let e=this.viewHistory[this.viewHistory.length-1];e&&e.view==="clue"&&BFN.HelpClueManager.afterHide(e.headerText)}handleNavigate(e){this.dismissHelpClue(),this.viewHistory.push(e),this.helpCenterClue.data=this.viewHistory[this.viewHistory.length-1]}handleBack(){this.dismissHelpClue(),this.viewHistory.pop(),this.helpCenterClue.data=this.viewHistory[this.viewHistory.length-1]}};BFN.SingletonQueue.add(()=>{BFN.HelpCenterManager=new IB});var _B=class extends BFN.EventDispatcher{constructor(){super();this.init()}init(){this.initDefaultValues()}initDefaultValues(){this.zoomKeyCodes=[70,48,BeFunky.isFirefox?61:187,BeFunky.isFirefox?173:189],this.editorOverrideKeyCodes=[66,73,79,86],this.keyActionPerformed=!1,this.handleDocumentKeyDownBind=this.handleDocumentKeyDown.bind(this),this.handleDocumentKeyUpBind=this.handleDocumentKeyUp.bind(this),document.addEventListener("keydown",this.handleDocumentKeyDownBind,!0),document.addEventListener("keyup",this.handleDocumentKeyUpBind,!0)}processZoomKey(e){if(!BFN.ImageCutout.cutoutActive&&!(BFN.ImagePainterUndoManager&&BFN.ImagePainterUndoManager.currentImagePainter&&BFN.ImagePainterUndoManager.currentImagePainter.mouseDown))switch(e){case 70:UITools.setToolValue("zoom","full_screen",!0,!1),UITools.applyTool("zoom"),UITools.setToolValue("zoom","full_screen",!1,!1);break;case 48:UITools.setToolValue("zoom","exact_fit",!0),UITools.applyTool("zoom"),UITools.setToolValue("zoom","exact_fit",!1),UITools.applyToolControl("zoom_minus");break;case 187:case 61:UITools.setControlValue("zoom_plus",!0,!0),UITools.applyToolControl("zoom_plus"),UITools.setControlValue("zoom_plus",!1,!1),UITools.applyToolControl("zoom_minus");break;case 189:case 173:UITools.setControlValue("zoom_minus",!0,!0),UITools.applyToolControl("zoom_minus"),UITools.setControlValue("zoom_minus",!1,!1),UITools.applyToolControl("zoom_minus");break}}processSaveKey(e=null){(e==="computer"||e==="project")&&(this.exitTransformToolFrameIfActive(),UITools.setToolValue("editor_save_image",e,!0,!1),UITools.applyTool("editor_save_image"),UITools.setToolValue("editor_save_image",e,!1,!1))}processOpenKey(){UITools.setToolValue("open_project","computer",!0,!1),UITools.applyTool("open_project"),UITools.setToolValue("open_project","computer",!1,!1)}processUndoRedo(e=null){(e==="undo"||e==="redo")&&(UITools.setToolValue("editor_history_action",e,!0),UITools.applyTool("editor_history_action"),UITools.setToolValue("editor_history_action",e,!1))}processSelectAll(){this.exitTransformToolFrameIfActive();let e=BFN.AppModel.sectionValue(BFN.PhotoEditorCanvas.transformLayer,BFN.CollageMakerCanvas.transformLayer,BFN.DesignerCanvas.transformLayer),t=[...e.children],r=t.length;for(;--r>-1;){let a=t[r];(a===BFN.TransformItemGroup||a.lockedOrHidden)&&t.splice(r,1)}if(t.length>1)e.children.includes(BFN.TransformItemGroup)||(BFN.TransformItemGroup.transformLayer=e,e.addChild(BFN.TransformItemGroup)),BFN.TransformItemGroup.canvasScale=e.canvasScale,BFN.TransformItemGroup.addGroupItems(t),e.updateTransformItemGroup();else if(t.length===1){let a=t[0];a.selectedByMouse=!1,a.selectItem()}}showBatchProcessor(){this.exitTransformToolFrameIfActive(),BFN.BatchProcessingManager.openModal()}showSettingsModal(){this.exitTransformToolFrameIfActive(),Ri()}processGroupItems(){if(this.exitTransformToolFrameIfActive(),BFN.TransformItemGroup.selectedItems.length){let e="transform_create_group";UITools.setControlValue(e,!0),UITools.applyToolControl(e),UITools.setControlValue(e,!1)}}processCopyCut(e){switch(e){case 67:BFN.PatchManager.copySelection();break;case 88:BFN.PatchManager.cutSelection();break}}exitTransformToolFrameIfActive(){return BFN.TransformModel.transformToolFrame&&BFN.TransformModel.transformToolFrame.active?(BFN.TransformModel.transformToolFrame.setup(null),!0):!1}getShortcutTooltip(e){let t=o=>BeFunky.LanguageManager.getString(o),r=o=>BeFunky.isMobile?"":BFN.shortcutString(BFN.shortcutText(o)).outerHTML,s={undo:`${t("undo")} ${r("Z")}`,redo:`${t("redo")} ${r("\u21E7Z")}`,batch:`${t("batch_processing")} ${r("B")}`,fullscreen:`${t("fullscreen")} ${r("F")}`}[e];return s||(BeFunky.throwError("Invalid shortcut tooltip",e),"")}handleDocumentKeyDown(e){if(!window.isAppOpen)return;let t=!0;t=t&&(BFN.AppModel.viewingEditor&&(BFN.PhotoEditorModel.currentTexture||this.editorOverrideKeyCodes.includes(e.keyCode))||BFN.AppModel.viewingCollage||BFN.AppModel.viewingDesigner),t=t&&!BeFunky.isModalOpen(),t=t&&!BeFunky.isLoadScreenActive(),t=t&&(!BFN.FabricManager.iTextEditing||[66,73,85].includes(e.keyCode)),t=t&&!this.keyActionPerformed,t=t&&!BFN.isSortableListDragActive,t=t&&!BeFunky.isPointerDown;let r=[13],a=[];BFN.TransformItemIsolator.active&&a.push(83,65,66,71,67,88,86,79,73,13),t=t&&!a.includes(e.keyCode);let s=o=>{BFN.SentryManager.reportBreadcrumb(`Key: "${e.key}" (${e.keyCode})${BFN.SentryManager.getSpecialKeyString(e)}${o?` -> ${o}`:""}`,"key_down","keyboard_manager")};if(e.ctrlKey||e.metaKey||r.includes(e.keyCode)){let o=!1;if(this.zoomKeyCodes.includes(e.keyCode)&&(o=!0,t&&(s("processZoomKey"),this.processZoomKey(e.keyCode))),e.keyCode===83&&(o=!0,t&&(s("processSaveKey"),this.processSaveKey(e.shiftKey?"project":"computer"))),e.keyCode===79&&(o=!0,t&&(s("processOpenKey"),this.processOpenKey())),e.keyCode===90&&(BFN.FabricManager.iTextEditing||(o=!0,t&&(s("processUndoRedo"),this.processUndoRedo(e.shiftKey?"redo":"undo")))),e.keyCode===65&&(BeFunky.isTextBoxFocused()||(o=!0,t&&(s("processSelectAll"),this.processSelectAll()))),e.keyCode===66&&(o=!0,t)){let n=BFN.TransformModel.selectedTransformItem&&(BFN.TransformModel.selectedTransformItem.type==="text"||BFN.TransformModel.selectedTransformItem.groupType==="text")||BFN.TransformModel.selectedTransformItemText?document.getElementById("text_edit_bold"):null;n?(s("toggleTextBold"),n.click()):(s("showBatchProcessor"),this.showBatchProcessor())}if(e.keyCode===73&&(o=!e.altKey&&!e.shiftKey,t&&o)){let n=BFN.TransformModel.selectedTransformItem&&(BFN.TransformModel.selectedTransformItem.type==="text"||BFN.TransformModel.selectedTransformItem.groupType==="text")||BFN.TransformModel.selectedTransformItemText?document.getElementById("text_edit_italic"):null;n?(s("toggleTextItalic"),n.click()):(s("showSettingsModal"),this.showSettingsModal())}if(e.keyCode===85){let n=BFN.TransformModel.selectedTransformItem&&(BFN.TransformModel.selectedTransformItem.type==="text"||BFN.TransformModel.selectedTransformItem.groupType==="text")||BFN.TransformModel.selectedTransformItemText?document.getElementById("text_edit_underline"):null;n&&(o=!0,t&&(s("toggleTextUnderline"),n.click()))}if(e.keyCode===71&&(o=!0,t&&(s("processGroupItems"),this.processGroupItems())),[67,88].includes(e.keyCode)&&!BeFunky.isTextBoxFocused()&&(o=!0,t&&(s("processCopyCut"),this.processCopyCut(e.keyCode))),e.keyCode===86&&!BeFunky.isTextBoxFocused()&&t){this.keyActionPerformed=!0;let n=c=>{s("handlePaste"),BFN.ClipboardManager.handlePaste(c),document.documentElement.removeEventListener("paste",n)},l=()=>{document.documentElement.removeEventListener("keyup",l),document.documentElement.removeEventListener("paste",n),this.keyActionPerformed=!1};document.documentElement.addEventListener("paste",n),document.documentElement.addEventListener("keyup",l);return}if(BFN.TransformModel.transformToolFrame&&!BeFunky.isTextBoxFocused())switch(e.keyCode){case 13:s("exitTransformToolFrameIfActive"),o=this.exitTransformToolFrameIfActive();break}o&&(e.preventDefault(),t&&(this.keyActionPerformed=!0,setTimeout(()=>{this.keyActionPerformed=!1},80)))}}handleDocumentKeyUp(e){e.keyCode===18&&e.preventDefault()}};BFN.SingletonQueue.add(()=>{BFN.KeyboardManager=new _B});var CB=class{constructor(){this.init()}init(){this.initDefaultValues(),this.initDebug()}initDefaultValues(){this.debug=!1,this.gestureActive=!1,this.activePointerIDs=[],this.activePointerData={},this.gestureTimeoutIDs={},this.selectedTransformItems=[],this.canvas=null,this.canvasModel=null,this.canvasStartScale=1,this.prevCenterPoint=null,this.eventListenersActive=!1,this.handlePointerDownBind=this.handlePointerDown.bind(this),this.handlePointerMoveBind=this.handlePointerMove.bind(this),this.handlePointerUpBind=this.handlePointerUp.bind(this),this.handleTouchEndBind=this.handleTouchEnd.bind(this),this.handleTouchCancelBind=this.handleTouchCancel.bind(this),this.handlePreRenderBind=this.handlePreRender.bind(this),document.addEventListener(BeFunky.pointerdown,this.handlePointerDownBind,!0)}initDebug(){if(!this.debug)return;this.debugDiv=document.createElement("div"),this.debugDiv.setStyles({position:"absolute",width:"200px",height:"200px",backgroundColor:"white",zIndex:5e3,border:"1px solid black",right:"10px",top:"10px",color:"black",fontSize:"10px",overflow:"scroll"}),document.body.appendChild(this.debugDiv),this.pointer1div=document.createElement("div"),this.pointer1div.setStyles({position:"absolute",left:0,top:0,width:0,height:0,zIndex:5e3,pointerEvents:"none"});let e=document.createElement("div");e.setStyles({position:"relative",left:"-35px",top:"-35px",width:"70px",height:"70px",backgroundColor:"red",borderRadius:"35px"}),this.pointer1div.appendChild(e),document.body.appendChild(this.pointer1div),this.pointer2div=document.createElement("div"),this.pointer2div.setStyles({position:"absolute",left:0,top:0,width:0,height:0,zIndex:5e3,pointerEvents:"none"});let t=document.createElement("div");t.setStyles({position:"relative",left:"-35px",top:"-35px",width:"70px",height:"70px",backgroundColor:"blue",borderRadius:"35px"}),this.pointer2div.appendChild(t),document.body.appendChild(this.pointer2div),this.centerdiv=document.createElement("div"),this.centerdiv.setStyles({position:"absolute",left:0,top:0,width:0,height:0,zIndex:5e3,pointerEvents:"none"});let r=document.createElement("div");r.setStyles({position:"relative",left:"-15px",top:"-15px",width:"30px",height:"30px",backgroundColor:"yellow",borderRadius:"15px"}),this.centerdiv.appendChild(r),document.body.appendChild(this.centerdiv)}startGesture(){this.gestureActive||this.activePointerIDs.length!==2||(this.gestureActive=!0,this.log("START GESTURE"),this.canvas=BFN.AppModel.sectionValue(BFN.PhotoEditorCanvas,BFN.CollageMakerCanvas,BFN.DesignerCanvas),this.canvasModel=BFN.AppModel.sectionValue(BFN.PhotoEditorCanvasModel,BFN.CollageMakerCanvasModel,BFN.DesignerCanvasModel),this.canvasStartScale=this.canvasModel.canvasScale,this.canvasModel.canvasScaling=!0,BFN.MainUI.addEventListener(BFN.MainUIEvents.PRE_RENDER.type,this.handlePreRenderBind),BFN.ZoomRegion.show())}stopGesture(){!this.gestureActive||(this.gestureActive=!1,this.log("STOP GESTURE"),this.canvasModel.canvasScaling=!1,BFN.MainUI.removeEventListener(BFN.MainUIEvents.PRE_RENDER.type,this.handlePreRenderBind),this.canvas=null,this.canvasModel=null,this.canvasStartScale=1,this.prevCenterPoint=null)}processGesture(){if(!this.gestureActive||this.activePointerIDs.length!==2)return;let e=this.activePointerData[this.activePointerIDs[0]],t=this.activePointerData[this.activePointerIDs[1]],r=Math.sqrt((t.sx-e.sx)**2+(t.sy-e.sy)**2),a=Math.sqrt((t.tx-e.tx)**2+(t.ty-e.ty)**2),s=(e.tx+t.tx)/2,o=(e.ty+t.ty)/2;this.prevCenterPoint||(this.prevCenterPoint=new PIXI.Point((e.sx+t.sx)/2,(e.sy+t.sy)/2));let n=s-this.prevCenterPoint.x,l=o-this.prevCenterPoint.y;this.prevCenterPoint.x=s,this.prevCenterPoint.y=o;let c=this.canvasStartScale*(a/r),h=Math.min(this.canvasModel.maxCanvasScale,Math.max(this.canvasModel.minCanvasScale,c));(c<h||c>h)&&(e.sx=e.tx,e.sy=e.ty,t.sx=t.tx,t.sy=t.ty,this.canvasStartScale=h),this.canvas.canvasContainer.x+=n/h,this.canvas.canvasContainer.y+=l/h,this.canvasModel.canvasScale=h,this.debug&&(this.pointer1div.setStyles({left:`${e.tx}px`,top:`${e.ty}px`}),this.pointer2div.setStyles({left:`${t.tx}px`,top:`${t.ty}px`}),this.centerdiv.setStyles({left:`${s}px`,top:`${o}px`}))}toggleEventListeners(e){if(this.eventListenersActive===e)return;this.eventListenersActive=e,window.preventPointerMoveThrottling=e;let t=document[`${this.eventListenersActive?"add":"remove"}EventListener`];t(BeFunky.pointermove,this.handlePointerMoveBind,!0),t(BeFunky.pointerup,this.handlePointerUpBind,!0),t(BeFunky.pointercancel,this.handlePointerUpBind,!0),t("touchend",this.handleTouchEndBind,!0),t("touchcancel",this.handleTouchCancelBind,!0)}clearGestureTimeouts(){this.gestureTimeoutIDs.init&&(clearTimeout(this.gestureTimeoutIDs.init),delete this.gestureTimeoutIDs.init),this.gestureTimeoutIDs.start&&(clearTimeout(this.gestureTimeoutIDs.start),delete this.gestureTimeoutIDs.start)}log(...e){!this.debug||(this.debugDiv.innerHTML+=e.join(" ")+"<br>",this.debugDiv.scrollTop=this.debugDiv.scrollHeight)}handlePointerDown(e){if(!(e.pointerType!=="touch"||!(e.target instanceof HTMLCanvasElement))){if(this.log(e.pointerType,"down",e.pointerId),this.activePointerIDs.length||(this.selectedTransformItems.length&&this.selectedTransformItems.splice(0),BFN.TransformModel.selectedTransformItem&&(BFN.TransformModel.selectedTransformItem===BFN.TransformItemGroup?this.selectedTransformItems.push(...BFN.TransformItemGroup.selectedItems):this.selectedTransformItems.push(BFN.TransformModel.selectedTransformItem))),this.toggleEventListeners(!0),this.activePointerIDs.length<2&&!this.activePointerIDs.includes(e.pointerId)&&(this.activePointerIDs.push(e.pointerId),this.activePointerData[e.pointerId]={tx:e.clientX,ty:e.clientY},this.activePointerIDs.length===2)){this.clearGestureTimeouts();for(let r in this.activePointerData)this.activePointerData[r].sx=this.activePointerData[r].tx,this.activePointerData[r].sy=this.activePointerData[r].ty;let t=!1;t=t||BFN.AppModel.viewingEditor&&!BFN.PhotoEditorModel.currentTexture,t=t||!!BFN.FabricManager.currentTextTransformItem,t||(BFN.ActiveDraggers.forEach(r=>{this.selectedTransformItems.length===1&&this.selectedTransformItems[0]!==r.item&&r.wasDragged&&this.selectedTransformItems.splice(0),r.stopDrag()}),this.gestureTimeoutIDs.init=setTimeout(()=>{if(delete this.gestureTimeoutIDs.init,this.activePointerIDs.length!==2)return;BFN.ImageCutout.cutoutActive||BFN.ImageCutout.painter.mouseDown?BFN.ImageCutout.handleKeyDownBind({keyCode:27}):BFN.ImagePainterUndoManager.currentImagePainter&&BFN.ImagePainterUndoManager.currentImagePainter.cancelPaintStroke();let r=BFN.AppModel.sectionValue(BFN.PhotoEditorCanvas,BFN.CollageMakerCanvas,BFN.DesignerCanvas).transformLayer;r.textTransformItem=null,BFN.GroupManager.selectItems(),BeFunky.dispatchPointerEvent("pointerup",document,e.pointerType,this.activePointerData[this.activePointerIDs[0]].tx,this.activePointerData[this.activePointerIDs[0]].ty,{ignorePointerID:!0}),BFN.MainUI.emit("pointerup",BFN.MainUI.pointerEvent),BFN.MainUI.emit("pointerupoutside",BFN.MainUI.pointerEvent),BFN.GroupManager.selectItems(BFN.TransformItemGroup.selectedItemsBackup),this.gestureTimeoutIDs.start=setTimeout(()=>{delete this.gestureTimeoutIDs.start,this.startGesture()},0)},0))}this.activePointerIDs.length===2&&(e.stopImmediatePropagation(),e.stopPropagation(),e.preventDefault())}}handlePointerMove(e){!this.activePointerData.hasOwnProperty(e.pointerId)||(this.activePointerData[e.pointerId].tx=e.clientX,this.activePointerData[e.pointerId].ty=e.clientY,this.pointerMoved=!0,!!this.gestureActive&&(e.stopImmediatePropagation(),e.stopPropagation(),e.preventDefault(),BFN.MainUI.requestRender()))}handlePointerUp(e){e.pointerType!=="touch"||!this.activePointerIDs.includes(e.pointerId)||(this.log(e.pointerType,"up",e.pointerId),this.activePointerIDs.splice(this.activePointerIDs.indexOf(e.pointerId),1),delete this.activePointerData[e.pointerId],this.clearGestureTimeouts(),this.stopGesture(),this.activePointerIDs.length||this.toggleEventListeners(!1))}handleTouchEnd(e){!e.touches.length&&this.activePointerIDs.length&&this.handleTouchCancel(e)}handleTouchCancel(e){this.activePointerIDs.forEach(t=>{this.activePointerIDs.splice(this.activePointerIDs.indexOf(t),1),delete this.activePointerData[t]}),this.stopGesture(),this.toggleEventListeners(!1)}handlePreRender(e){this.pointerMoved&&(this.pointerMoved=!1,this.processGesture())}get multiplePointersActive(){return this.activePointerIDs.length>1}};BFN.SingletonQueue.add(function(){BFN.GestureManager=new CB});var EB=class{constructor(){this.init()}init(){this.initDefaultValues()}initDefaultValues(){this.resetValues(),this.handlePointerMoveBind=this.handlePointerMove.bind(this),this.handlePointerUpBind=this.handlePointerUp.bind(this)}initiateLongPress(e=null,t=5,r=600,a=!0){!BeFunky.isPointerDown||this.longPressPending||!BeFunky.globalPointerEvent||a&&BeFunky.globalPointerEvent.pointerType!="touch"||(this.longPressPending=!0,this.longPressEvent=BeFunky.globalPointerEvent,this.longPressCallback=e,this.longPressPixelThreshold=t,this.longPressDuration=r,this.longPressEndTime=performance.now()+this.longPressDuration,document.addEventListener(BeFunky.pointermove,this.handlePointerMoveBind,!0),document.addEventListener(BeFunky.pointerup,this.handlePointerUpBind,!0),document.addEventListener(BeFunky.pointercancel,this.handlePointerUpBind,!0),this.longPressTimer())}longPressTimer(){this.longPressPending&&(performance.now()>this.longPressEndTime?(this.longPressCallback&&this.longPressCallback(this.longPressEvent),this.handlePointerUpBind()):requestAnimationFrame(this.longPressTimer.bind(this)))}resetValues(){this.longPressPending=!1,this.longPressEvent=null,this.longPressCallback=null,this.longPressPixelThreshold=null,this.longPressDuration=null,this.longPressEndTime=null}handlePointerMove(e){let t=this.longPressEvent.pageX-e.pageX,r=this.longPressEvent.pageY-e.pageY,a=Math.sqrt(t**2+r**2);this.longPressEndTime=performance.now()+this.longPressDuration,a>=this.longPressPixelThreshold&&this.handlePointerUpBind()}handlePointerUp(e){this.resetValues(),document.removeEventListener(BeFunky.pointermove,this.handlePointerMoveBind,!0),document.removeEventListener(BeFunky.pointerup,this.handlePointerUpBind,!0),document.removeEventListener(BeFunky.pointercancel,this.handlePointerUpBind,!0)}};BFN.SingletonQueue.add(function(){BFN.LongPressManager=new EB});BFN.GroupManagerEvents={GROUPS_UPDATED:new Event("GROUPS_UPDATED")};var PB=class extends BFN.EventDispatcher{constructor(){super();this.init()}init(){this.initDefaultValues()}initDefaultValues(){this.sections=["editor","collage","designer"],this.groupData={},this.sections.forEach(e=>{this.groupData[e]=[]}),this.dispatchGroupsUpdated=BeFunky.debounce(this.dispatchGroupsUpdated,50)}createGroup(e=null,t=[],r=null){if(e&&t.length>1){let a=this.sections.includes(r)?r:BFN.AppModel.sectionID,s=new BFN.TransformItemGroupVO;s.id=`item_group_${BeFunky.randomString(10)}`,s.name=e,t.forEach(o=>{o.projectItemVO&&o.projectItemVO.itemID&&s.itemIDs.push(o.projectItemVO.itemID)}),s.itemIDs.length>1&&this.addGroup(a,s,!0)}}addGroup(e=null,t=null,r=!1){let a=this.sections.includes(e)?e:BFN.AppModel.sectionID;t&&(this.groupData[a].push(t),this.setGroupVOName(t,t.name)),r&&(this.getSectionValue(a,BFN.PhotoEditorModel,BFN.CollageMakerModel,BFN.DesignerModel).updateProjectVO(),this.dispatchGroupsUpdated())}addGroups(e=null,t=[],r=!1){let a=this.sections.includes(e)?e:BFN.AppModel.sectionID;t.forEach(s=>{this.addGroup(a,s)}),r&&(this.getSectionValue(a,BFN.PhotoEditorModel,BFN.CollageMakerModel,BFN.DesignerModel).updateProjectVO(),this.dispatchGroupsUpdated())}clearGroups(e=null,t=!1){let r=this.sections.includes(e)?e:BFN.AppModel.sectionID;this.groupData[r].splice(0),t&&(this.getSectionValue(r,BFN.PhotoEditorModel,BFN.CollageMakerModel,BFN.DesignerModel).updateProjectVO(),this.dispatchGroupsUpdated())}deleteGroup(e){let t=null,r=this.sections.length;for(;--r>-1;){let a=this.sections[r],s=this.groupData[a].length;for(;--s>-1;){let o=this.groupData[a][s];if(o.id==e){o.itemIDs.splice(0),this.groupData[a].splice(s,1),t=a;break}}if(t)break}t&&(this.getSectionValue(t,BFN.PhotoEditorModel,BFN.CollageMakerModel,BFN.DesignerModel).updateProjectVO(),this.dispatchGroupsUpdated())}openCreateGroupModal(){let e=BeFunky.createFormModalContainer("group"),{teardown:t}=BeFunky.formModal(e,{title:"create_group",fields:[{name:"groupname",label:"group_name",maxLength:500}],button:"create",onSubmit:({groupname:r})=>{r=r.trim(),UILayers.switchToGroupsTab(),BFN.TransformItemGroup.createGroup(r),BeFunky.closeModal(e)}});BeFunky.openFormModal(e,t)}selectGroupsByName(e=[]){if(e.length){let t=BFN.AppModel.sectionID,r=this.groupData[t],a=[];r.forEach(s=>{e.includes(s.name)&&!a.includes(s.id)&&a.push(s.id)}),this.selectGroups(a)}}selectGroups(e=[],t=!1,r=!1){if(!e.length)return;let a=BFN.AppModel.sectionID,s=this.groupData[a];if(!s.length)return;let n=[...BFN.AppModel.sectionValue(BFN.PhotoEditorCanvas.transformLayer,BFN.CollageMakerCanvas.transformLayer,BFN.DesignerCanvas.transformLayer).children];n.includes(BFN.TransformItemGroup)&&n.splice(n.indexOf(BFN.TransformItemGroup),1);let l=[],c=[];if(n.forEach(h=>{h.projectItemVO&&h.projectItemVO.itemID&&(l.push(h),c.push(h.projectItemVO.itemID))}),l.length){let h=[];s.forEach(u=>{e.includes(u.id)&&u.itemIDs.forEach(d=>{if(c.includes(d)){let m=l[c.indexOf(d)];h.includes(m)||h.push(m)}})}),r&&BFN.TransformItemGroup.selectedItems.length&&BFN.TransformItemGroup.selectedItems.forEach(u=>{h.includes(u)||h.push(u)}),this.selectItems(h,t)}return[...BFN.TransformItemGroup.selectedItems]}selectItems(e=[],t=!1){let r=BFN.AppModel.sectionValue(BFN.PhotoEditorCanvas.transformLayer,BFN.CollageMakerCanvas.transformLayer,BFN.DesignerCanvas.transformLayer);if(e.length>1)r.children.includes(BFN.TransformItemGroup)||(BFN.TransformItemGroup.transformLayer=r,r.addChild(BFN.TransformItemGroup)),BFN.TransformItemGroup.canvasScale=r.canvasScale,BFN.TransformItemGroup.updateSelectedItems(e,t),r.updateTransformItemGroup();else if(r.resetTransformItemGroup(),e.length===1){let a=e[0];a.selectedByMouse=!1,a.selectItem(),a.transformLayer.lastPressedItem=a,a.transformLayer.lastSelectedItem=a}return[...BFN.TransformItemGroup.selectedItems]}renameGroup(e=null,t=null,r=null){if(e&&t){let a=this.getAllGroups(),s=null;if(a.forEach(o=>{o.id==e&&(s=o)}),s&&s.name!=t){this.setGroupVOName(s,t);let o=this.sections.includes(r)?r:BFN.AppModel.sectionID;return this.getSectionValue(o,BFN.PhotoEditorModel,BFN.CollageMakerModel,BFN.DesignerModel).updateProjectVO(),s.name}}return null}setGroupVOName(e,t){let r=null;if(this.sections.forEach(a=>{this.groupData[a].forEach(s=>{s==e&&(r=a)})}),r){let a=[];if(this.groupData[r].forEach(s=>{s!=e&&a.push(s.name)}),!a.includes(t))e.name=t;else{let s=0;for(;++s;){let o=`${t} (${s})`;if(!a.includes(o)){e.name=o;break}}}}else e.name=t}addItemsToGroup(e,t=[],r=null){let a=!1;if(this.getAllGroups().forEach(o=>{o.id==e&&t.forEach(n=>{o.itemIDs.includes(n)||(o.itemIDs.push(n),a=!0)})}),a){let o=this.sections.includes(r)?r:BFN.AppModel.sectionID;this.getSectionValue(o,BFN.PhotoEditorModel,BFN.CollageMakerModel,BFN.DesignerModel).updateProjectVO(),this.dispatchGroupsUpdated()}}removeItemsFromGroup(e,t=[],r=null){let a=!1;if(this.getAllGroups().forEach(o=>{if(o.id==e){let n=o.itemIDs.length;for(;--n>-1;){let l=o.itemIDs[n];t.includes(l)&&(o.itemIDs.splice(n,1),a=!0)}}}),a){let o=this.sections.includes(r)?r:BFN.AppModel.sectionID;this.getSectionValue(o,BFN.PhotoEditorModel,BFN.CollageMakerModel,BFN.DesignerModel).updateProjectVO(),this.dispatchGroupsUpdated()}}getSectionGroupVOs(e=null){let t=this.sections.includes(e)?e:BFN.AppModel.sectionID;return[...this.groupData[t]]}getSectionGroupObjects(e=null,t=!1){let r=this.sections.includes(e)?e:BFN.AppModel.sectionID,a,s;t&&(a=this.getSectionValue(r,BFN.PhotoEditorCanvas.transformLayer,BFN.CollageMakerCanvas.transformLayer,BFN.DesignerCanvas.transformLayer),s=[],a.children.forEach(n=>{n instanceof BFN.TransformItem&&s.push(n.itemID)}));let o=[];return this.groupData[r].forEach(n=>{let l={};Object.assign(l,n),t?(l.itemIDs=[],n.itemIDs.forEach(c=>{s.includes(c)&&l.itemIDs.push(c)})):l.itemIDs=[...n.itemIDs],o.push(l)}),o}getGroupIDs(e=null){let t=this.sections.includes(e)?e:BFN.AppModel.sectionID,r=[];return this.groupData[t].forEach(({id:s})=>{r.push(s)}),r}getAllGroups(){let e=[];for(let t in this.groupData)this.groupData[t].forEach(a=>{e.push(a)});return e}getGroupVOsFromItemIDs(e=[]){let t=[];return this.getAllGroups().forEach(a=>{a.itemIDs.forEach(s=>{e.includes(s)&&!t.includes(a)&&t.push(a)})}),t}getCommonGroupVOsFromItemIDs(e=[]){let t=this.getGroupVOsFromItemIDs(e),r=[];e.forEach(s=>{let o=this.getGroupVOsFromItemIDs([s]);t.forEach(n=>{!o.includes(n)&&!r.includes(n)&&r.push(n)})});let a=t.length;for(;--a>-1;){let s=t[a];r.includes(s)&&t.splice(a,1)}return t}getSectionValue(e=null,t=null,r=null,a=null){switch(e){case"editor":return t;case"collage":return r;case"designer":return a}return null}dispatchGroupsUpdated(){this.dispatchEvent(BFN.GroupManagerEvents.GROUPS_UPDATED)}};BFN.SingletonQueue.add(()=>{BFN.GroupManager=new PB});var NB=class{constructor(){this.init()}init(){this.initDefaultValues(),this.initContextMenu()}initDefaultValues(){this.batchMode=null,this.batchSection=null,this.resizeMode="none",this.effectAmount=100,this.effectFadeable=!1,this.backgroundUpdateAllowed=!1,this.cropRatio=1,this.cropOrientation="landscape",this.saveData=[],this.itemSize=320,this.cropMinSize=40,this.processedImageItems=[],this.newlyProcessedImageItems=[],this.visibleImageItems=[],this.hiddenImageItems=[],this.processingVisibleImageItems=!1,this.queuedBatchImageVOs=null,this.queuedImageItems=[],this.queuedImageItemsNum=0,this.effectTexture=null,this.effectID=null,this.effectParams=null,this.savePrefix="",this.saveSuffix="",this.defaultImageType="jpg",this.defaultImageQuality=98,this.maxImageQuality=99,this.imageType=this.defaultImageType,this.imageQuality=this.defaultImageQuality,this.handleImageItemPressedBind=this.handleImageItemPressed.bind(this),this.handleDocumentMouseDownCropBind=this.handleDocumentMouseDownCrop.bind(this),this.handleDocumentMouseMoveCropBind=this.handleDocumentMouseMoveCrop.bind(this),this.handleDocumentMouseUpCropBind=this.handleDocumentMouseUpCrop.bind(this),this.modal=document.getElementById("batch_processing"),this.zipLoader=null,BeFunky.onFreeTrialEnabledChange(e=>{let t=document.getElementById("batch_processing_upgrade");t&&t.setLang(e?"start_free_trial":"upgrade")}),this.modal.querySelector("panel-header").isPlus=!0}initContextMenu(){this.contextMenu=document.getElementById("context_menu_batch_processing_image_item"),BeFunky.contextMenu(this.contextMenu,{remove_image:{onClick:()=>{this.rightClickItemAction("remove"),this.contextMenu.hide()}},reset_frame:{onClick:()=>{this.rightClickItemAction("reset"),this.contextMenu.hide()}}}),this.contextMenu.enabled=!0,this.contextMenu.addEventListener("HIDE",()=>{this.rightClickItem=null})}handleBatchProcessing(){let e=UITools.getToolVO("batch_processing");if(e.updating_id==="open_modal"){this.openModal();return}if(this.batchSection!==e.section&&(this.batchSection=e.section,this.modal.getImageItems().forEach(r=>{this.effectAmount!==100&&r.setImageOverlayOpacity(100),r.setImageOverlaySRC(null),this.batchSection||r.toggleImageOverlayVeil(!1,!1)}),this.effectAmount=100,this.setBatchSection(this.batchSection)),this.backgroundUpdateAllowed&&this.backgroundColor!==e.background_color&&this.setBackgroundColor(e.background_color),e[e.updating_id]!==!1)switch(e.updating_id){case"manage_tools":this.showPopover("batch_processing_manage_tools_popover");break;case"cancel":UITools.setToolValue("batch_processing","section",null,!1),UITools.applyTool("batch_processing");break;case"apply":this.processImages(!0);break;case"load_images":this.loadImages();break;case"clear_images":this.clearImages();break;case"upgrade":BFN.BfnService.upgrade("BATCH","BATCH_UPGRADE","batch_processing"),BFN.UserActionManager.addUpgradeAction(["Batch Processing Upgrade"],!1);break;case"save_images":{if(BeFunky.isPaywallEnabled()&&!BeFunky.isPlus()){BeFunky.openTeaserModal("paywall");return}if(!BFN.BfnService.userIsPlus){BFN.BfnService.upgrade("BATCH","BATCH_UPGRADE","batch_processing"),BFN.UserActionManager.addUpgradeAction(["Batch Processing Save"],!1);return}let t=e.add_text,r=e.add_text_mode;UITools.setToolValue("batch_processing","image_quality",this.defaultImageQuality),UITools.setToolValue("batch_processing","add_text",t),UITools.setToolValue("batch_processing","add_text_mode",r),this.setImageType(e.image_type),this.setImageQuality(e.image_quality),this.modal.openSaveDialog(this.saveImages.bind(this)),UITools.disableControlItem("batch_processing_image_quality",this.imageType==="png"),UITools.updateToolControl("batch_processing_image_quality"),UITools.updateToolControl("batch_processing_add_text"),UITools.updateToolControl("batch_processing_add_text_mode"),this.refreshBatchExampleName();break}case"image_type":this.setImageType(e.image_type),UITools.disableControlItem("batch_processing_image_quality",this.imageType==="png"),this.refreshBatchExampleName();break;case"image_quality":this.setImageQuality(e.image_quality);break;case"add_text":this.refreshBatchExampleName();break;case"add_text_mode":this.refreshBatchExampleName();break}}refreshBatchExampleName(){let e=UITools.getToolVO("batch_processing"),t=document.getElementById("batch_processing_add_text"),r=document.getElementById("batch_processing_example_name");if(t&&r){let a=t.value.replace(/\s+/g," ").replace(/[^0-9a-zA-Z-_]/g,"");switch(this.savePrefix="",this.saveSuffix="",e.add_text_mode){case"before":this.savePrefix=a.replace(/^\s+/,"");break;case"after":this.saveSuffix=a.replace(/\s+$/,"");break}r.textContent=`${this.savePrefix+BeFunky.LanguageManager.getString("filename").toLowerCase()+this.saveSuffix}.${this.imageType}`}}handleBatchResize(){let e=UITools.getToolVO("batch_resize");e.updating_id==="mode"&&this.modal.setResizeMode(e.mode),this.resizeMode=e.mode,this.modal.getImageItems().forEach(r=>{r.resize(this.resizeMode)})}handleBatchCrop(){let e=UITools.getToolVO("batch_crop"),t=this.modal.getImageItems();switch(e.updating_id){case"aspect_ratio":case"orientation":this.cropRatio=e.aspect_ratio==="freeform"?-2:BFN.CropRatioMap[e.aspect_ratio],this.cropOrientation=e.orientation,t.forEach(r=>{r.setCropRatio(this.cropRatio,this.cropOrientation)}),e.updating_id==="aspect_ratio"&&UITools.disableControlItem("batch_crop_orientation",e.aspect_ratio==="freeform"||BFN.CropRatioMap[e.aspect_ratio]===1);break;case"focal_point_align":this.showPopover("batch_crop_focal_point_align_popover");break;case"reset":UITools.setToolValue("batch_crop","aspect_ratio",e.aspect_ratio,!1),UITools.updateToolControl("batch_crop_aspect_ratio"),UITools.applyTool("batch_crop");break}if(e.updating_id!=="focal_point_align"&&e.updating_id.includes("focal_point_")&&e[e.updating_id]){let r=e.updating_id.replace("focal_point_","");r==="auto"?this.smartCrop():this.setCropFocalPoint(r)}}handleBatchEffect(){let e=UITools.getToolVO("batch_effect");!e.updating&&e.updating_id==="reset"&&(Object.assign(e,e.defaultValues),UITools.updateToolControls("batch_effect"));let t=this.modal.getImageItems();this.effectFadeable=e.hasOwnProperty("amount"),this.effectFadeable&&this.effectAmount!==e.amount&&(this.effectAmount=e.amount,t.forEach(r=>{r.setImageOverlayOpacity(this.effectAmount)})),!e.updating&&e.updating_id!=="amount"&&this.processVisibleImageItems(!0)}openModal(){if(BeFunky.isMobile&&!BeFunky.isTablet){BeFunky.acknowledge("accessible_from_desktop");return}if(BeFunky.isChromeOnIOS){BeFunky.acknowledge("try_safari");return}this.modal.open||(BFN.UI.batchProcessingModal(this.modal),BFN.BatchToolManager.initManageToolsList()),this.modal.open(),this.loadZipLibrary()}setBatchSection(e){this.batchSection=e,this.batchMode=e,this.resizeMode="none",this.backgroundUpdateAllowed=this.batchSection==="resize",this.backgroundUpdateAllowed||this.setBackgroundColor(-1),document.removeEventListener(BeFunky.pointerdown,this.handleDocumentMouseDownCropBind,!0);let t=null;switch(this.batchMode){case"resize":{let r=UITools.getToolVO("batch_resize");UITools.setToolValue("batch_resize","mode",r.mode,!1),this.handleBatchResize();break}case"crop":{let r=UITools.getToolVO("batch_crop");UITools.setToolValue("batch_crop","aspect_ratio",r.aspect_ratio,!1),this.handleBatchCrop(),document.addEventListener(BeFunky.pointerdown,this.handleDocumentMouseDownCropBind,!0);break}default:{let r=this.batchMode,a=null;if(BFN.effectMap.hasOwnProperty(r)?a=r:BFN.effectPresetMap.hasOwnProperty(r)&&BFN.effectMap.hasOwnProperty(BFN.effectPresetMap[r])&&(a=BFN.effectPresetMap[r]),a){let s=null;if(a===r){if(BFN.UIToolData[a]&&BFN.UIToolData[a].controls){let{controls:o}=BFN.UIToolData[a];s=[];for(let n in o){let l=n.replace(`${a}_`,"");s.push({toolID:r,controlID:`batch_effect_${l}`,controlName:l,controlParamObject:Object.assign({},o[n])})}t=r}}else{let o=r.replace(`${a}_`,""),n=null,l=null,c=!1;if(BFN.EffectData.some(h=>h.id===a?(n=h.name,h.presets.some((u,d)=>u.id===o?(c=u.hasOwnProperty("useBasicAmount")?u.useBasicAmount:!0,u.hasOwnProperty("name")?n=u.name:n+=` ${d+1}`,l=u.params,!0):!1),!0):!1),l){s=[];let h=!1;if(l.forEach(u=>{s.push({toolID:r,controlID:`batch_effect_${u.name}`,controlName:u.name,controlParamObject:Object.assign({},u)}),u.name==="amount"&&(h=!0)}),!h&&c){let d={toolID:r,controlID:"batch_effect_amount",controlName:"amount",controlParamObject:{type:"slider_item",name:"amount",min:0,max:100,defaultValue:100}};s.splice(0,0,d)}t=n}}s?this.modal.setDynamicControls(s,r)?(this.batchMode="dynamic",this.handleBatchEffect()):this.batchMode=null:this.batchMode=null}else this.batchMode=null}}requestAnimationFrame(()=>{this.modal.getImageItems().forEach(a=>{a.setBatchMode(this.batchMode)}),this.modal.showControls(this.batchMode,t)})}setBackgroundColor(e=-1){this.backgroundColor=e,this.modal.getImageItems().forEach(r=>{r.setBackgroundColor(this.backgroundColor)})}setImageType(e="jpg"){["jpg","png"].includes(e)&&(this.imageType=e,this.modal.getImageItems().forEach(r=>{r.setImageType(this.imageType)}))}setImageQuality(e=99){this.imageQuality=Math.max(0,Math.min(100,e))}rightClickItemAction(e){if(this.rightClickItem)switch(e){case"remove":this.removeImageItem(this.rightClickItem,!0);break;case"reset":switch(this.batchMode){case"crop":this.rightClickItem.setCropRatio(this.cropRatio,this.cropOrientation);break}break}}smartCrop(){this.batchMode==="crop"&&(this.queuedSmartCropItems=this.modal.getImageItems(),BeFunky.showLoadScreen({isCancellable:!1}),this.processSmartCrop())}processSmartCrop(){if(this.queuedSmartCropItems)if(this.queuedSmartCropItems.length){let e=this.queuedSmartCropItems.shift(),t=new Image;t.addEventListener("load",r=>{let{batchImageVO:a}=e,{cropData:s}=a,o=Math.round(s.width/a.imageW*a.thumbW),n=Math.round(s.height/a.imageH*a.thumbH);window.smartcrop.crop(t,{width:o,height:n}).then(l=>{let c=l.topCrop,h=parseFloat(e.cropRegion.style.width.replace("%",""))/100*a.thumbW,u=parseFloat(e.cropRegion.style.height.replace("%",""))/100*a.thumbH,d=Math.max(0,Math.min(a.thumbW-h,c.x+c.width/2-h/2)),m=Math.max(0,Math.min(a.thumbH-u,c.y+c.height/2-u/2));e.cropRegion.setStyles({left:`${d/a.thumbW*100}%`,top:`${m/a.thumbH*100}%`}),e.updateCropVeil(),e.updateCropData(),this.processSmartCrop()})}),t.src=e.batchImageVO.thumbSRC}else BeFunky.hideLoadScreen()}setCropFocalPoint(e){this.modal.getImageItems().forEach(r=>{let{batchImageVO:a}=r,s=parseFloat(r.cropRegion.style.width.replace("%",""))/100*a.thumbW,o=parseFloat(r.cropRegion.style.height.replace("%",""))/100*a.thumbH,n=parseFloat(r.cropRegion.style.left.replace("%",""))/100*a.thumbW,l=parseFloat(r.cropRegion.style.top.replace("%",""))/100*a.thumbH;e.includes("l")?n=0:e.includes("c")?n=a.thumbW/2-s/2:e.includes("r")&&(n=a.thumbW-s),e.includes("t")?l=0:e.includes("m")?l=a.thumbH/2-o/2:e.includes("b")&&(l=a.thumbH-o),n=Math.max(0,Math.min(a.thumbW-s,n)),l=Math.max(0,Math.min(a.thumbH-o,l)),r.cropRegion.setStyles({left:`${n/a.thumbW*100}%`,top:`${l/a.thumbH*100}%`}),r.updateCropVeil(),r.updateCropData()})}loadImages(e=[]){let t=(s,o)=>{let n=this.getRecommendedUploadLimit(),l=n-this.modal.getTotalImageBytes(),c=s.reduce((m,p)=>m+p.size,0);if(l>=c)return o(s);let h=n/1024**2,u=h<1e3?`${Math.round(h)} MB`:`${Math.round(h/1024)} GB`,d=`
                <h3 style="font-size: inherit; font-weight: bold; margin-bottom: 1rem;">${BeFunky.LanguageManager.getStringReplacements("batch_file_size",{size:u})}</h3>
                <span>${BeFunky.LanguageManager.getString("batch_file_size_body")}</span>
            `;BeFunky.confirm(d,{onConfirm:()=>o(s),onCancel:()=>o([]),confirmText:"continue"})},r={fileType:"imagesExceptSVG",saveInIndexedDB:!1,thumbnailLongestSide:this.itemSize,keepThumbTexture:!0,files:e,onBeforeUpload:t},a=0;BFN.MultipleFileUploader.upload(({file:s,menuImageVO:o,isComplete:n})=>{if(o){let l=new BFN.BatchImageVO;l.originalName=o.name,l.originalTransparent=BFN.Util.isTransparent(o.thumbTexture),l.name=o.name,l.extension=o.extension,l.imageBlob=s,l.imageW=o.imageWidth,l.imageH=o.imageHeight,l.thumbSRC=o.thumbURL,l.thumbTexture=o.thumbTexture,l.thumbW=o.thumbWidth,l.thumbH=o.thumbHeight,l.resizeData.width=l.imageW,l.resizeData.height=l.imageH,l.cropData.x=0,l.cropData.y=0,l.cropData.width=l.imageW,l.cropData.height=l.imageH,a++,this.addImageItem(l);return}if(n){this.modal.updateImageItems();let l={};this.modal.getImageItems().forEach(({batchImageVO:u})=>{l.hasOwnProperty(u.originalName)||(l[u.originalName]=0);let d=l[u.originalName]++;u.name=u.originalName+(d?` (${d})`:"")}),this.batchMode==="dynamic"&&this.processVisibleImageItems(),this.modal.popoverWalkthrough&&this.modal.popoverWalkthrough.index===0&&(this.modal.popoverWalkthrough.index=1);let h=new BFN.UserActionVO;h.eventID="media_opened",h.eventObject={mediaType:"Image",mediaOpenLocation:"Computer",batchMediaOpen:a},h.peopleObject={lastMediaOpenDate:window.bfn_mp?window.bfn_mp.getISODate():"n/a",lifetimeMediaOpenCount:1,lifetimeImagesOpenCount:a},h.track()}},r)}addImageItem(e){let t=this.modal.addBatchImage(e);t.setBatchMode(this.batchMode),t.setImageOverlayOpacity(this.effectAmount),t.resize(this.resizeMode),t.setCropRatio(this.cropRatio,this.cropOrientation),t.setBackgroundColor(this.backgroundColor),t.setImageType(this.imageType),t.addEventListener(BeFunky.pointerdown,this.handleImageItemPressedBind,!0),t.oncontextmenu=()=>!1}removeImageItem(e,t=!1){e&&(e.removeEventListener(BeFunky.pointerdown,this.handleImageItemPressedBind,!0),e.destroy(),t&&this.modal.updateImageItems())}clearImages(){let e=this.modal.getImageItems();e.length?BeFunky.confirm("confirm_clear_all_images",{onConfirm:()=>{e.forEach(t=>{this.removeImageItem(t)}),this.modal.updateImageItems()}}):UIMessages.display("no_images_to_clear")}saveImages(){if(BeFunky.isInDemoMode())return BeFunky.acknowledgeDemoMode();this.modal.getImageItems().length?(this.savePending=!0,this.saveData.splice(0),this.processImages()):UIMessages.display("no_images_to_save")}processVisibleImageItems(e=!1){if(this.processingVisibleImageItems||this.batchMode!=="dynamic")return;let t=UITools.getToolVO("batch_effect"),{toolID:r}=t,a=null;if(BFN.effectMap.hasOwnProperty(r)?a=r:BFN.effectPresetMap.hasOwnProperty(r)&&BFN.effectMap.hasOwnProperty(BFN.effectPresetMap[r])&&(a=BFN.effectPresetMap[r]),!!a){if(e&&this.processedImageItems.splice(0),this.newlyProcessedImageItems.splice(0),this.queuedImageItems.splice(0),this.visibleImageItems=this.modal.getVisibleImageItems(),this.visibleImageItems.forEach(s=>{(!this.processedImageItems.length||!this.processedImageItems.includes(s))&&(s.toggleImageOverlayVeil(!0,!0),this.queuedImageItems.push(s))}),e){this.hiddenImageItems=this.modal.getImageItems();let s=this.hiddenImageItems.length;for(;--s>-1;){let o=this.hiddenImageItems[s];this.visibleImageItems.includes(o)&&this.hiddenImageItems.splice(s,1)}}else this.hiddenImageItems=[];BFN.EffectManager.reset(),BFN.EffectManager.autoProcess=!1,BFN.EffectManager.useThumbs=!0,this.effectID=a,this.effectParams=t,this.processQueuedImageItems()}}processQueuedImageItems(){if(this.queuedImageItems.length){let e=this.queuedImageItems.shift(),t=async()=>{BFN.EffectManager.removeEventListener(BFN.EffectManagerEvents.EFFECT_COMPLETE.type,t);let r=UITools.getToolVO("batch_effect"),{batchImageVO:a}=e,s=a.originalTransparent;s=s||r.toolID==="replace_color"&&r.target_color===-1;let o=this.defaultImageQuality/100;try{let n=await BFN.TextureUtils.textureToBlob(this.effectTexture,{isTransparent:s,quality:o}),l=await BFN.BlobUtils.blobToImageElement(n,{cleanUpMemory:!1});this.newlyProcessedImageItems.push(e),e.setImageOverlaySRC(l.src,this.effectFadeable,!0)}catch(n){BeFunky.reportWarning(`Failed to apply effect to Batch Item: ${n}`,n),e.setImageOverlaySRC(null,this.effectFadeable,!0),e.toggleImageOverlayVeil(!0,!1)}this.effectTexture.destroyGC(!0),delete this.effectTexture,this.processQueuedImageItems()};this.effectTexture&&this.effectTexture.destroyGC(!0),this.effectTexture=PIXI.RenderTexture.create(e.batchImageVO.thumbTexture.width,e.batchImageVO.thumbTexture.height),this.processingVisibleImageItems=!0,BFN.EffectManager.setSourceTexture(e.batchImageVO.thumbTexture),BFN.EffectManager.setRenderTexture(this.effectTexture),BFN.EffectManager.effectID=this.effectID,BFN.EffectManager.effectParameters=this.effectParams,BFN.EffectManager.addEventListener(BFN.EffectManagerEvents.EFFECT_COMPLETE.type,t),BFN.EffectManager.processEffect()}else this.effectID=null,this.effectParams=null,BFN.EffectManager.reset(),BFN.EffectManager.autoProcess=!0,BFN.EffectManager.useThumbs=!1,this.newlyProcessedImageItems.forEach(e=>{e.applyImageOverlaySRC(),e.toggleImageOverlayVeil(!1,!1)}),this.processedImageItems.push(...this.newlyProcessedImageItems),this.newlyProcessedImageItems.splice(0),this.hiddenImageItems.forEach(e=>{e.toggleImageOverlayVeil(!0,!1),e.setImageOverlaySRC(null,this.effectFadeable)}),this.processingVisibleImageItems=!1}processImages(e=!1){if(this.updateOriginals=e,this.queuedBatchImageVOs=this.modal.getImageItems().map(a=>a.batchImageVO),this.totalQueuedBatchImageVOs=this.queuedBatchImageVOs.length,!this.batchMode&&this.savePending){let a=this.queuedBatchImageVOs.length;for(;--a>-1;){let s=this.queuedBatchImageVOs[a],o=!1;switch(s.extension){case"jpg":case"jpeg":o=this.imageType==="jpg"&&this.imageQuality===this.defaultImageQuality;break;case"png":o=this.imageType==="png";break}o=o&&!BFN.WatermarkManager.watermarkActive,o&&(this.saveData.push({name:s.name,blob:s.imageBlob}),this.queuedBatchImageVOs.splice(a,1))}}this.updateOriginals&&this.modal.getImageItems().forEach(s=>{s.toggleImageOverlayVeil(!0,!1)});let t=null;switch(this.batchMode){case"resize":case"crop":t=this.batchMode;break;case"dynamic":t=UITools.getToolVO("batch_effect").toolID;break}this.batchApplyUserActionVO=null;let r=BFN.UserActionManager.getEditorToolObject(t);r&&(r.batchEditingApplied=this.totalQueuedBatchImageVOs,this.batchApplyUserActionVO=new BFN.UserActionVO,this.batchApplyUserActionVO.eventID="editing_applied",this.batchApplyUserActionVO.eventObject=r),BeFunky.showLoadScreen({isCancellable:!1,message:"processing",showIris:!1}),this.processQueuedBatchImageVOs()}processQueuedBatchImageVOs(){if(this.queuedBatchImageVOs&&this.queuedBatchImageVOs.length){let e=this.queuedBatchImageVOs.shift(),t=this.totalQueuedBatchImageVOs,r=t-this.queuedBatchImageVOs.length;BeFunky.showLoadScreen({isCancellable:!1,message:"processing",progress:`${r} / ${t}`,showIris:!1}),BFN.TextureUtils.blobOrBase64ToTexture(e.imageBlob,({texture:a})=>{let s=(o,n=!1)=>{requestAnimationFrame(()=>{this.savePending&&!this.updateOriginals&&BFN.WatermarkManager.watermarkActive&&BFN.WatermarkManager.drawWatermark(o);let l=BFN.Util.getThumbTexture(o,this.itemSize),c=n?BFN.Util.isTransparent(l):e.originalTransparent,h=this.savePending&&!this.updateOriginals?this.imageType==="png":c,u=Math.max(1,Math.min(this.maxImageQuality,this.updateOriginals&&!this.savePending?this.defaultImageQuality:this.imageQuality))/100;BFN.TextureUtils.textureToBlob(o,{isTransparent:h,quality:u}).catch(d=>BeFunky.logError(d)).then(d=>{if(this.savePending&&this.saveData.push({name:e.name,blob:d||e.imageBlob}),d&&this.updateOriginals){e.originalTransparent=c,e.extension=h?"png":"jpg",e.imageBlob=d,e.imageW=o.width,e.imageH=e.resizeData.height=o.height;try{e.thumbTexture.destroyGC(!0)}catch(m){}e.thumbTexture=l,e.thumbW=l.width,e.thumbH=l.height,e.resizeData.width=e.imageW,e.resizeData.height=e.imageH,e.cropData.x=0,e.cropData.y=0,e.cropData.width=e.imageW,e.cropData.height=e.imageH,o.destroyGC(!0),BFN.TextureUtils.textureToBlob(l,{isTransparent:h}).catch(m=>BeFunky.logError(m)).then(m=>{BFN.BlobUtils.blobToImageElement(m,{cleanUpMemory:!1}).catch(p=>BeFunky.logError(p)).then(p=>{if(e.thumbSRC&&(e.thumbSRC.startsWith("data:")||URL.revokeObjectURL(e.thumbSRC),e.thumbSRC=null),p){e.thumbSRC=p.src;let f=this.modal.getImageItems().find(v=>v.batchImageVO===e);if(f&&(f.setImageOverlaySRC(null),f.resize("scale"),f.setBatchMode(null),requestAnimationFrame(()=>{f.toggleImageOverlayVeil(!1,!1)}),this.batchApplyUserActionVO&&this.batchApplyUserActionVO.eventObject)){let{eventObject:v}=this.batchApplyUserActionVO;f.batchImageVO.addAction(BFN.UserActionManager.getFunnelString(v.toolType,v.toolName))}}this.processQueuedBatchImageVOs()})})}else o.destroyGC(!0),l.destroyGC(!0),this.processQueuedBatchImageVOs()})})};switch(this.batchMode){case"resize":{let{resizeData:o}=e,n=!1;if(o.width!==e.imageW||o.height!==e.imageH){let l=BFN.Util.fitTextureInRect(a,o.width,o.height,!o.padding,e.backgroundColor);a.destroyGC(!0),a=l;let c=UITools.getToolVO("batch_resize");n=c.mode==="exact_size"&&c.use_padding}s(a,n);break}case"crop":{let{cropData:o}=e;if(o.width!==e.imageW||o.height!==e.imageH){let n=Math.min(a.width/e.imageW,a.height/e.imageH);o.x=Math.round(o.x*n),o.y=Math.round(o.y*n),o.width=Math.min(a.width-o.x,Math.round(o.width*n)),o.height=Math.min(a.height-o.y,Math.round(o.height*n));let l=PIXI.RenderTexture.create(o.width,o.height);l.copyPixels(a,{x:-o.x,y:-o.y}),a.destroyGC(!0),a=l}s(a);break}case"dynamic":{let o=UITools.getToolVO("batch_effect"),{toolID:n}=o,l=null;if(BFN.effectMap.hasOwnProperty(n)?l=n:BFN.effectPresetMap.hasOwnProperty(n)&&BFN.effectMap.hasOwnProperty(BFN.effectPresetMap[n])&&(l=BFN.effectPresetMap[n]),l){let c=a.renderClone(),h=u=>{BFN.EffectManager.removeEventListener(BFN.EffectManagerEvents.EFFECT_COMPLETE.type,h);let d=o.hasOwnProperty("amount"),m=d?o.amount/100:1;a.copyPixels(c,null,!d,m),c.destroyGC(!0);let p=!1;o.toolID==="replace_color"&&o.target_color===-1&&(p=!0),s(a,p)};BFN.EffectManager.reset(),BFN.EffectManager.autoProcess=!1,BFN.EffectManager.manageLoadScreen=!1,BFN.EffectManager.setSourceTexture(a),BFN.EffectManager.setRenderTexture(c),BFN.EffectManager.addEventListener(BFN.EffectManagerEvents.EFFECT_COMPLETE.type,h),BFN.EffectManager.effectID=l,BFN.EffectManager.effectParameters=o,BFN.EffectManager.processEffect()}else s(a);break}default:s(a);break}},{textureSize:BFN.maxImageSize})}else{let e=this.modal.getImageItems();if(e.length){let t="";switch(this.batchMode){case"crop":t="CROP";break;case"resize":t="RESIZE";break}BFN.EffectManager.parameters&&(BFN.UIToolData.hasOwnProperty(BFN.EffectManager.parameters.toolID)?t=BFN.EffectManager.parameters.toolID.toUpperCase():t=BFN.EffectManager.parameters.toolID.split("_").slice(1).join("_").toUpperCase()),BFN.BfnService.track("CREATE","BATCH",t),this.updateOriginals&&(this.updateOriginals=!1,UITools.setToolValue("batch_resize","scale",100,!1),UITools.updateToolControl("batch_resize_scale"),e.forEach(r=>{r.updateImageDisplay(),r.resize(this.resizeMode)}),this.batchMode==="crop"&&(UITools.setToolValue("batch_crop","aspect_ratio","freeform",!1),UITools.updateToolControl("batch_crop_aspect_ratio"),UITools.applyTool("batch_crop"))),this.batchApplyUserActionVO&&this.batchApplyUserActionVO.track(),this.savePending?(this.savePending=!1,this.saveData.length&&(BFN.BfnService.track("CREATE","BATCH","SAVE"),BeFunky.showLoadScreen({isCancellable:!1,message:"zipping",showIris:!1}),this.loadZipLibrary().then(()=>{let{maxZipSizeMB:r}=BFN,a=[],s=this.saveData.length,o=0;if(r===-1)a.push([...this.saveData]);else{let c=null,h=0;this.saveData.forEach((u,d)=>{let m=u.blob.size/1024**2;h+m>r&&(c=null,h=0),c||(c=[],c.startIndex=d,a.push(c)),c.push(u),h+=m,c.sizeMB=h,c.firstImageNum=c.startIndex+1,c.lastImageNum=c.startIndex+c.length})}this.saveData.splice(0);let n=[],l=()=>{if(a.length){let c=a.shift(),h=null,u=new zip.BlobWriter,d=0,m=()=>{if(d===c.length)h.close(p=>{n.push({firstImageNum:c.firstImageNum,lastImageNum:c.lastImageNum,blob:p}),l()});else{let p=c[d];h.add(`${(this.savePrefix+p.name+this.saveSuffix).trim()}.${this.imageType}`,new zip.BlobReader(p.blob),()=>{BeFunky.showLoadScreen({isCancellable:!1,message:"zipping",progress:`${o} / ${s}`,showIris:!1}),d++,o++,m()})}};zip.createWriter(u,p=>{h=p,m()},()=>{},!0)}else{if(window.bfn_mp){let p=new BFN.UserActionVO;p.eventID="media_saved",p.eventObject={mediaSaveType:[],mediaSaveLocation:"Computer",batchMediaSave:s,mediaSaveWatermark:BFN.WatermarkManager.watermarkActive,mediaSaveMainFunnel:[],mediaSaveFontsUsed:[],mediaSaveLayerSourcesUsed:[]},p.peopleObject={lastMediaSaveDate:window.bfn_mp?window.bfn_mp.getISODate():"n/a",lifetimeMediaSaveCount:1,lifetimeImagesSaveCount:s};let{mediaSaveType:g}=p.eventObject,{mediaSaveMainFunnel:f}=p.eventObject;if(e.forEach(({batchImageVO:v})=>{let T=v.extension.toUpperCase();T=T==="PNG"?T:"JPG",g.includes(T)||g.push(T),v.actions&&v.actions.forEach(x=>{f.includes(x)||f.push(x)})}),this.batchApplyUserActionVO&&this.batchApplyUserActionVO.eventObject){let{eventObject:v}=this.batchApplyUserActionVO,T=BFN.UserActionManager.getFunnelString(v.toolType,v.toolName);f.includes(T)||f.push(T)}g.sort(),f.sort(),p.track()}BeFunky.hideLoadScreen();let c=()=>{n.splice(0)},h=n.length===1?"download_images_single":"download_images_multiple",u=n.map(p=>p.firstImageNum===p.lastImageNum?"":`${p.firstImageNum} - ${p.lastImageNum}`).map((p,g)=>`
                                        <div class="control-item" style="margin: 0 0 .5rem;">
                                            <button class="button button--grey-outline button--has-icon button--fullwidth batch-processing__download-button" id="batch_zip_${g}">
                                                ${BeFunky.getSvgHtml("download-icon")}
                                                ${BeFunky.LanguageManager.getStringReplacements("download_images_button",{range:p})}
                                                ${BeFunky.getSvgHtml("checkmark-icon")}
                                            </button>
                                        </div>`),d=`
                                        <panel-header lang-id="download_images" modifier="modal" buttons="close"></panel-header>
                                        <div class="modal__body">
                                            <p>${BeFunky.LanguageManager.getString(h)}</p>
                                            ${u.join("")}
                                        </div>
                                    `,m=document.createElement("div").setClass("modal modal--button-sm");m.id="batch_processing_download",m.innerHTML=d,n.forEach((p,g)=>{let f=m.querySelector(`#batch_zip_${g}`);f.addEventListener("click",()=>{let v=`batch_processed_images${n.length>1?`_part_${g+1}`:""}.zip`;BeFunky.isAppleAppStoreApp?window.azrOpenBlobToWindow(p.blob,v):saveAs(p.blob,v),f.addClass("button--selected")})}),requestAnimationFrame(()=>{BeFunky.openModal(m,{onClose:()=>{c()},size:"extra-small",destroyOnClose:!0})})}};l()}).catch(r=>{BeFunky.logError("Batch Processing save failed",r),BeFunky.hideLoadScreen()}))):(BeFunky.hideLoadScreen(),UITools.setToolValue("batch_processing","section",null,!1),UITools.applyTool("batch_processing"))}else BeFunky.hideLoadScreen(),UITools.setToolValue("batch_processing","section",null,!1),UITools.applyTool("batch_processing");BFN.EffectManager.reset(),BFN.EffectManager.autoProcess=!0,BFN.EffectManager.manageLoadScreen=!0}}showPopover(e,t=12){let r=document.getElementById(e),s=document.getElementById(`${e}_placeholder`).getBoundingClientRect(),o=this.modal.getBoundingClientRect();r.setStyles({left:`${s.x-o.x+t}px`,top:`${s.y-o.y}px`}),r.show()}loadZipLibrary(){return this.zipLoader?this.zipLoader:(this.zipLoader=BeFunky.loadScript(`${BFN.jsURL}zip.0.0.4.js`,()=>window.zip).then(()=>{let e=`${BFN.jsURL}z-worker.js`,t=`${BFN.jsURL}pako-1.0.10.min.js`,r=`${BFN.jsURL}pako-codecs.0.0.1.js`;zip.workerScripts={deflater:[e,t,r]}}).catch(e=>{throw BeFunky.logError("Unable to load zip.js library",e),this.zipLoader=null,e}),this.zipLoader)}getRecommendedUploadLimit(){return(parseInt(navigator.deviceMemory)||4)/4*Math.pow(1024,3)}showContextMenu(e){this.batchMode==="crop"?this.contextMenu.showButton("reset_frame"):this.contextMenu.hideButton("reset_frame"),this.rightClickItem=this.pressedTarget,this.contextMenu.show(e.clientX,e.clientY)}handleImageItemPressed(e){if(this.pressedTarget=e.currentTarget,e.button!==2){BFN.LongPressManager.initiateLongPress(this.showContextMenu.bind(this));return}this.showContextMenu(e),e.stopPropagation(),e.preventDefault()}handleDocumentMouseDownCrop(e){if(e.button!==2&&(this.cropControl=null,this.cropDragType=null,this.imageItem=null,this.cropContainer=null,this.cropRegion=null,this.cropAspectRatio=null,e.target&&e.target instanceof HTMLDivElement)){let t=e.target,r="batch-item__crop-region",a="batch-item__crop-region-handle";if(this.mouseStartPosition=null,t.hasClass(r)||t.hasClass(a)){this.cropControl=t,this.cropDragType=t.hasClass(a)?"handle":"region",this.imageItem=t.imageItem,this.cropContainer=t.container,this.cropRegion=t.region,this.cropAspectRatio=this.imageItem.batchImageVO.cropData.height/this.imageItem.batchImageVO.cropData.width;let s=this.cropControl.container.getBoundingClientRect(),o=this.cropControl.region.getBoundingClientRect();this.cropContainer.rect=new BFN.Rectangle(0,0,s.width,s.height),this.cropRegion.rect=new BFN.Rectangle(o.x-s.x,o.y-s.y,o.width,o.height),this.mouseStartPosition={globalX:e.clientX,globalY:e.clientY,localX:e.clientX-s.x,localY:e.clientY-s.y},document.addEventListener(BeFunky.pointermove,this.handleDocumentMouseMoveCropBind),document.addEventListener(BeFunky.pointerup,this.handleDocumentMouseUpCropBind,!0),e.stopImmediatePropagation(),e.preventDefault(),BFN.LongPressManager.initiateLongPress(n=>{this.handleDocumentMouseUpCropBind(),this.showContextMenu(n)})}}}handleDocumentMouseMoveCrop(e){let t=e.clientX-this.mouseStartPosition.globalX,r=e.clientY-this.mouseStartPosition.globalY,a={};switch(this.cropDragType){case"region":{let s=Math.max(0,Math.min(this.cropContainer.rect.width-this.cropRegion.rect.width,this.cropRegion.rect.x+t)),o=Math.max(0,Math.min(this.cropContainer.rect.height-this.cropRegion.rect.height,this.cropRegion.rect.y+r)),n=s/this.cropContainer.rect.width*100,l=o/this.cropContainer.rect.height*100;a.left=`${n}%`,a.top=`${l}%`;break}case"handle":{let{handleID:s}=this.cropControl,{handleType:o}=this.cropControl,n=this.cropRegion.width,l=this.cropRegion.height,c=this.cropContainer.rect.width,h=this.cropContainer.rect.height;if(s.includes("top")?(h=this.cropRegion.rect.bottom,l=Math.max(this.cropMinSize,Math.min(h,this.cropRegion.rect.height-r))):s.includes("bottom")&&(h=this.cropContainer.rect.height-this.cropRegion.rect.top,l=Math.max(this.cropMinSize,Math.min(h,this.cropRegion.rect.height+r))),s.includes("left")?(c=this.cropRegion.rect.right,n=Math.max(this.cropMinSize,Math.min(c,this.cropRegion.rect.width-t))):s.includes("right")&&(c=this.cropContainer.rect.width-this.cropRegion.rect.left,n=Math.max(this.cropMinSize,Math.min(c,this.cropRegion.rect.width+t))),o==="corner"&&(this.cropAspectRatio<1?(n=Math.max(this.cropMinSize,Math.min(c,l/this.cropAspectRatio)),l=n*this.cropAspectRatio):(l=Math.max(this.cropMinSize,Math.min(h,n*this.cropAspectRatio)),n=l/this.cropAspectRatio)),s.includes("top")){let d=(this.cropRegion.rect.bottom-l)/this.cropContainer.rect.height*100,m=l/this.cropContainer.rect.height*100;a.top=`${d}%`,a.height=`${m}%`}else if(s.includes("bottom")){let u=l/this.cropContainer.rect.height*100;a.height=`${u}%`}if(s.includes("left")){let d=(this.cropRegion.rect.right-n)/this.cropContainer.rect.width*100,m=n/this.cropContainer.rect.width*100;a.left=`${d}%`,a.width=`${m}%`}else if(s.includes("right")){let u=n/this.cropContainer.rect.width*100;a.width=`${u}%`}break}}this.imageItem.cropRegion.setStyles(a),this.imageItem.updateCropVeil(),this.imageItem.updateCropData()}handleDocumentMouseUpCrop(e){document.removeEventListener(BeFunky.pointermove,this.handleDocumentMouseMoveCropBind),document.removeEventListener(BeFunky.pointerup,this.handleDocumentMouseUpCropBind,!0)}};BFN.SingletonQueue.add(()=>{BFN.BatchProcessingManager=new NB});var MB=class{constructor(){this.init()}init(){this.initDefaultValues()}initDefaultValues(){this.batchEditToolIDs=["crop","resize","exposure","vignette","levels","vibrance","color","replace_color","fill_light","sharpen","clarity","tint","beautify","color_mixer","auto_enhance","glow","blur_edges","smoothing","soften","blur"],this.batchToolData=this.getBatchToolData(),this.defaultBatchToolIDs=["crop","resize","exposure","color","auto_enhance","sharpen"],BFN.FeaturedData.effect.forEach(e=>{BFN.effectIDMap[e]&&this.defaultBatchToolIDs.push(`${BFN.effectIDMap[e]}_${e}`)}),this._selectedIDs=[],this.selectedIDs=this.defaultBatchToolIDs}initManageToolsList(){this.manageToolsList=document.getElementById("batch_processing_manage_tools_popover_content"),BFN.UI.selectableList(this.manageToolsList,"manage_tools",this.batchToolData,e=>{this.selectedIDs=e}),this.updateModalToolLists()}updateModalToolLists(){if(!this.manageToolsList)return;let e=this.batchToolData.filter(({id:t})=>this.selectedIDs.includes(t)).sort((t,r)=>this.selectedIDs.indexOf(t.id)-this.selectedIDs.indexOf(r.id));BFN.BatchProcessingManager.modal.updateToolButtons(e),this.manageToolsList.selectedIDs=this.selectedIDs}getBatchToolData(){let e=[];return this.batchEditToolIDs.forEach(t=>{e.push({id:t,name:t})}),BFN.EffectData.forEach(t=>{t.id!=="effect_featured"&&t.id!=="effect_favorites"&&t.id!=="touchup"&&t.presets.forEach((r,a)=>{let s=`${t.id}_${r.id}`,o=r.name?r.name:`${t.name} ${a+1}`;e.push({id:s,name:o})})}),e}set selectedIDs(e){if(!Array.isArray(e)){BeFunky.throwError(`Invalid selectedIDs: ${BeFunky.getType(e)}}`,{_value:e});return}this._selectedIDs.isIdenticalTo(e)||(this._selectedIDs=e.slice(),this.updateModalToolLists(),BFN.BatchIconManager.updateButtonIcons(),BFN.BatchIconManager.updatePanelHeaders(),BFN.SettingsManager.updateSetting("batch_processing_fav",e.slice()))}get selectedIDs(){return this._selectedIDs}};BFN.SingletonQueue.add(()=>{BFN.BatchToolManager=new MB});BFN.TransformLayerManagerEvents={ITEMS_UPDATED:new Event("ITEMS_UPDATED"),SELECTION_UPDATED:new Event("SELECTION_UPDATED")};var DB=class extends BFN.EventDispatcher{constructor(){super();this.init()}init(){this.initDefaultValues()}initDefaultValues(){this._transformItemIDs=[],this._transformItems=[],this._selectedItemIDs=[],this._selectedItems=[],this.updateTransformItems=BeFunky.debounce(this.updateTransformItemsImmediately,50),this.updateSelectedItems=BeFunky.debounce(this.updateSelectedItemsImmediately,50),window.addEventListener("INIT_COMPLETE",()=>{BFN.PhotoEditorCanvas.transformLayer.addEventListener(BFN.TransformLayerEvents.ITEMS_UPDATED.type,this.handleTransformLayerItemsUpdated.bind(this)),BFN.CollageMakerCanvas.transformLayer.addEventListener(BFN.TransformLayerEvents.ITEMS_UPDATED.type,this.handleTransformLayerItemsUpdated.bind(this)),BFN.DesignerCanvas.transformLayer.addEventListener(BFN.TransformLayerEvents.ITEMS_UPDATED.type,this.handleTransformLayerItemsUpdated.bind(this)),BFN.AppModel.addEventListener(BFN.AppModelEvents.VIEWSTATE_UPDATED.type,this.handleAppViewstateUpdated.bind(this))})}updateTransformItemsImmediately(e=!0){let r=BFN.AppModel.sectionValue(BFN.PhotoEditorCanvas.transformLayer,BFN.CollageMakerCanvas.transformLayer,BFN.DesignerCanvas.transformLayer).children.filter(s=>s instanceof BFN.TransformItem),a=r.map(s=>s.itemID);this._transformItemIDs.isIdenticalTo(a)&&this._transformItems[0]===r[0]||(this._transformItemIDs.splice(0),this._transformItems.splice(0),r.forEach(s=>{this._transformItemIDs.push(s.itemID),this._transformItems.push(s)}),e&&this.dispatchEvent(BFN.TransformLayerManagerEvents.ITEMS_UPDATED))}updateSelectedItemsImmediately(){let e=[];e.push(...BFN.TransformItemGroup.selectedItems),BFN.TransformModel.selectedTransformItem&&BFN.TransformModel.selectedTransformItem.type!=="group"&&!e.includes(BFN.TransformModel.selectedTransformItem)&&e.push(BFN.TransformModel.selectedTransformItem),e.sort((r,a)=>r.itemID>a.itemID?1:-1);let t=e.map(({itemID:r})=>r);this._selectedItemIDs.isIdenticalTo(t)||(this._selectedItemIDs.splice(0),this._selectedItems.splice(0),this._selectedItemIDs.push(...t),this._selectedItems.push(...e),this.dispatchEvent(BFN.TransformLayerManagerEvents.SELECTION_UPDATED))}smartResizeLayers(e=0,t=0){if(!e||!t)return null;let r=BFN.AppModel.sectionValue(BFN.PhotoEditorCanvas,BFN.CollageMakerCanvas,BFN.DesignerCanvas),{transformLayer:a}=r,{transformTool:s}=r,o=a.frameWidth,n=a.frameHeight,l=Math.abs(e),c=Math.abs(t),h=Math.min(l/o,c/n),u=[...a.children];if(u.includes(BFN.TransformItemGroup)&&u.splice(u.indexOf(BFN.TransformItemGroup),1),u.length){let d="resize_item_layer",m=d+BeFunky.randomString(10);return BFN.TransformStateModel.startBulkTransition(m),u.forEach(p=>{p.clearDropShadow(),p.createTransition(d);let g=p.bounds,f=g.width,v=g.height,T=p.scale.x/p.scale.y,x=1,B;if(p.type==="text"&&p.textCurveActive){let Be=Math.sqrt(p.textItemContentW**2+p.textItemContentH**2)/2;x=Math.sqrt(p.itemContentW**2+p.itemContentH**2)/2/Be,B=p.textItemContentH/p.textItemContentW}else B=v/f/T;let{minSize:y}=s;switch(p.type){case"text":y=s.minSizeText;break;case"frame_texture":y=s.minSizeFrame;break;case"texture":p.isShape||(y=s.minSizeFrame);break}let F=y,b=F*B,S=Math.sqrt(F**2+b**2),I=y,_=I/B,E=Math.sqrt(_**2+I**2),D=Math.max(S,E)/2*x,w=p.itemContentW*p.scale.x,N=p.itemContentH*p.scale.y,M=Math.sqrt(Math.pow(w,2)+Math.pow(N,2))/2,z=Math.atan2(N/2,w/2),W=p.x+Math.cos(z+p.rotation)*M,j=p.y+Math.sin(z+p.rotation)*M,J=W*h,ie=j*h,re=w*h,he=N*h,ne=Math.max(D,Math.sqrt(Math.pow(re,2)+Math.pow(he,2))/2),le=ne/M;re=w*le,he=N*le,ne=Math.sqrt(Math.pow(re,2)+Math.pow(he,2))/2,p.scale.x*=le,p.scale.y*=le,p.updateFrameTextureDisplay(),p.x=J-Math.cos(p.rotation+z)*ne,p.y=ie-Math.sin(p.rotation+z)*ne,p.updateShapeTexture(!1),p.resetFrameTextureScale(),p.basicShapeVO&&p.basicShapeVO.strokeWidth&&(p.basicShapeVO.strokeWidth=Math.max(1,Math.min(100,Math.round(p.basicShapeVO.strokeWidth*le)))),p.updateShapeTexture(),p.type==="text"?p.setTextWidth(p.textItemContentW*p.scale.x,!0):(p.updateHitArea(),p.updateAccurateBounds()),p.updateSmoothingScale(),p.registerTransition(!1)}),BFN.TransformStateModel.stopBulkTransition(),BFN.MainUI.requestRender(),m}return null}handleTransformLayerItemsUpdated(){this.updateTransformItems()}handleAppViewstateUpdated(){this.updateTransformItems()}get transformItemIDs(){return this._transformItemIDs}get transformItems(){return this._transformItems}get selectedItemIDs(){return this._selectedItemIDs}get selectedItems(){return this._selectedItems}};BFN.SingletonQueue.add(()=>{BFN.TransformLayerManager=new DB});var wB=class extends BFN.EventDispatcher{constructor(){super();this.init()}init(){this.initDefaultValues()}initDefaultValues(){this.detectingTouchDragHovers=!1,this.hoveredItem=null,this.transformItems=null,this.hitPoint=new PIXI.Point,this.tmpPoint=new PIXI.Point,this.detectHoversManuallyBind=this.detectHoversManually.bind(this),this.stopTouchDragHoverDetectionBind=this.stopTouchDragHoverDetection.bind(this)}startTouchDragHoverDetection(){if(!this.detectingTouchDragHovers){if(this.hoveredItem=null,this.transformItems=BFN.TransformLayerManager.transformItems.filter(e=>!e.lockedOrHidden),!this.transformItems.length){this.transformItems=null;return}this.detectingTouchDragHovers=!0,document.addEventListener(BeFunky.pointermove,this.detectHoversManuallyBind,!0)}}stopTouchDragHoverDetection(){!this.detectingTouchDragHovers||(this.hoveredItem=null,this.transformItems=null,this.detectingTouchDragHovers=!1,document.removeEventListener(BeFunky.pointermove,this.detectHoversManuallyBind,!0))}detectHoversManually(e){if(!this.detectingTouchDragHovers||this.lastEventTimeStamp===e.timeStamp)return;this.lastEventTimeStamp=e.timeStamp;let t=BFN.Stage.plugins.interaction.befunkyCanvasRect;this.hitPoint.x=BeFunky.globalPointerCoords.x-t.left,this.hitPoint.y=BeFunky.globalPointerCoords.y-t.top;let r=null,a=BFN.TransformLayerManager.transformItems.length;for(;--a>-1;){let s=BFN.TransformLayerManager.transformItems[a];if(s.worldTransform.applyInverse(this.hitPoint,this.tmpPoint),s.hitArea.contains(this.tmpPoint.x,this.tmpPoint.y)){r=s;break}}this.hoveredItem!==r&&(this.hoveredItem&&this.hoveredItem.transformLayer.handleItemMouseOutBind(),this.hoveredItem=r,this.hoveredItem&&this.hoveredItem.transformLayer.handleItemMouseOverBind({currentTarget:this.hoveredItem}))}};BFN.SingletonQueue.add(()=>{BFN.TransformTouchDragManager=new wB});BFN.WatermarkManagerEvents={WATERMARK_UPDATED:new Event("WATERMARK_UPDATED")};var kB=class extends BFN.EventDispatcher{constructor(){super();this.init()}init(){this.initDefaultValues(),this.initGraphicLoader(),this.initWatermarkControls(),this.setInitialValues(),this.setUseWatermarkIndexedDB=BeFunky.debounce(this.setUseWatermarkIndexedDB.bind(this),500),this.saveWatermarkPresets=BeFunky.debounce(this.saveWatermarkPresets.bind(this),500)}initDefaultValues(){this.editModal=document.getElementById("watermark_edit_modal"),this.presetModal=document.getElementById("watermark_preset_modal"),window.addEventListener("INIT_COMPLETE",()=>{BFN.UI.watermarkEditModal(this.editModal),BFN.UI.watermarkPresetModal(this.presetModal)}),this.previewWatermarkURL=null,this.previewWatermarkObjectURL=null,this.previewWatermarkBlob=null,this.watermarkData=null,this.watermarkURL=null,this.watermarkTexture=null,this.watermarkPresets=[],this.activated=!1,this.editModal.querySelector("panel-header").isPlus=!0}initGraphicLoader(){this.graphicLoader=new BFN.GraphicLoader,this.graphicLoader.addEventListener(BFN.GraphicLoaderEvents.LOADING_COMPLETE.type,this.handleGraphicLoaderComplete.bind(this))}initWatermarkControls(){this.watermarkControls=[...document.querySelectorAll(".watermark-control")],this.watermarkControls.forEach(e=>{BFN.UI.watermarkControl(e)})}setInitialValues(){BFN.IndexedDB.get("options__useWatermark").then(e=>{this.useWatermarkDB=e}).catch(()=>{this.useWatermarkDB=!1}).then(()=>{this.useWatermark=this.useWatermarkDB})}setUseWatermarkIndexedDB(){this.useWatermarkDB!==this._useWatermark&&(this.useWatermarkDB=this._useWatermark,BFN.IndexedDB.set("options__useWatermark",this._useWatermark).catch(BeFunky.reportWarning))}handleWatermark(){let e=UITools.getToolVO("watermark");switch(e.updating_id){case"upload":this.uploadWatermark();break;case"placement_popover_button":this.showPopover("watermark_placement_popover",16);break;case"placement":this.editModal.setPreviewWatermarkParams({placement:e.placement});break;case"size":this.editModal.setPreviewWatermarkParams({size:e.size});break;case"padding":this.editModal.setPreviewWatermarkParams({padding:e.padding});break;case"opacity":this.editModal.setPreviewWatermarkParams({opacity:e.opacity});break;case"save":if(this.previewWatermarkURL){let t=this.editModal.nameInputValue;if(t.length){if(!BFN.BfnService.userIsPlus){BFN.BfnService.upgrade("WATERMARK","WATERMARK_UPGRADE"),BFN.UserActionManager.addUpgradeAction(["Watermark Preset Save"]);return}let r=()=>{BFN.WatermarkManager.saveWatermarkPreset(t,()=>{this.editModal.close()})};this.editModal.editingExistingPreset?r():BFN.WatermarkManager.watermarkPresets.map(s=>s.presetName).includes(t)?BeFunky.confirm(["confirm_overwrite_existing_watermark_preset",{name:t}],{onConfirm:()=>{r()}}):r()}else BeFunky.acknowledge("please_enter_watermark_preset_name")}else BeFunky.acknowledge("please_upload_your_watermark");break}}activate(){this.activated||(this.activated=!0,this.watermarkData&&this.setWatermarkData(this.watermarkData))}uploadWatermark(e=null){let t=[];e&&t.push(e);let r={allowMultiple:!1,fileType:"imagesExceptSVG",saveInIndexedDB:!1,thumbnailLongestSide:115,createMenuImageVO:!1,files:t};BFN.MultipleFileUploader.upload(({file:a})=>{if(a){let s=["image/jpeg","image/png","image/gif"],o=a.type;if(s.includes(o)){let n=()=>{this.clearPreviewWatermark(),this.previewWatermarkBlob=a,this.previewWatermarkObjectURL=URL.createObjectURL(this.previewWatermarkBlob),this.previewWatermarkURL=this.previewWatermarkObjectURL,this.editModal.setPreviewWatermarkSRC(this.previewWatermarkURL)};if(o==="image/gif"){let l=URL.createObjectURL(a),c=document.createElement("img");c.onload=()=>{let h=document.createElement("canvas"),u=h.width=c.width,d=h.height=c.height;h.getContext("2d").drawImage(c,0,0,u,d);let m=h.toDataURL("image/gif");a=BFN.BlobUtils.base64ToBlob(m),URL.revokeObjectURL(l),c.src="",c.onerror=null,n()},c.onerror=()=>{URL.revokeObjectURL(l),c.src="",UIMessages.display("Watermark upload error",1e3)},c.src=l}else n()}else BeFunky.acknowledge("acknowledge_watermark_invalid_filetype")}},r)}clearPreviewWatermark(){this.previewWatermarkBlob=null,this.previewWatermarkObjectURL&&URL.revokeObjectURL(this.previewWatermarkObjectURL),this.previewWatermarkObjectURL=null,this.previewWatermarkURL=null}clearWatermarkTexture(){this.watermarkTexture&&this.watermarkTexture.destroyGC(!0),this.watermarkTexture=null}updateWatermarkPresetOrder(e=[]){let t={};this.watermarkPresets.forEach(r=>{t[r.presetID]=r}),this.watermarkPresets.splice(0),e.forEach(r=>{this.watermarkPresets.push(t[r])}),this.saveWatermarkPresets()}deleteWatermarkPreset(e){let t=null,r=0,a=this.watermarkPresets.length;for(;--a>-1;){let s=this.watermarkPresets[a];if(s.presetID===e){t=s,this.watermarkPresets.splice(a,1),r=Math.max(0,Math.min(this.watermarkPresets.length-1,a));break}}if(t){let s=!0;if(this.watermarkPresets.forEach(o=>{o.watermarkURL===t.watermarkURL&&(s=!1)}),s&&this.deleteWatermarkFromServer(t.watermarkURL),t.presetID===this.selectedPresetID)if(r<this.watermarkPresets.length){let o=this.watermarkPresets[r];this.selectedPresetID=o.presetID}else this.selectedPresetID=null;return this.saveWatermarkPresets(),this.watermarkControls.forEach(o=>{o.updatePresetList(this.watermarkPresets)}),this.watermarkPresets.length||this.dispatchEvent(BFN.WatermarkManagerEvents.WATERMARK_UPDATED),!0}return!1}saveWatermarkPresets(){BFN.SettingsManager.updateSetting("watermarks",this.watermarkPresets,{updateUI:!1})}loadWatermarkPresets(e=[]){this.watermarkPresets.splice(0),this.watermarkPresets.push(...e),this.presetModal.updatePresetButtons(this.watermarkPresets),this.watermarkControls.forEach(t=>{t.updatePresetList(this.watermarkPresets)}),!this.editModal.isOpen&&this.updateSelectedPreset()}updateSelectedPreset(){let e=this.getSelectedPresetObject();e?this.selectedPresetID=e.presetID:this.watermarkPresets.length?(e=this.watermarkPresets[0],this.selectedPresetID=e.presetID):this.selectedPresetID=null}saveWatermarkToServer(e,t){if(!e){t&&t({error:"no_blob"});return}BFN.BfnWatermarkService.uploadImage(this.previewWatermarkBlob,t)}deleteWatermarkFromServer(e){if(!e)return;let t=r=>{r.success};BFN.BfnWatermarkService.deleteImage(e,t)}renameWatermarkPreset(e,t){if(!(e||t&&typeof t=="string"&&t.trim().length))return;let r=!1;if(this.watermarkPresets.forEach(s=>{!r&&s.presetID!==e&&s.presetName===t&&(r=!0)}),r){BeFunky.acknowledge("acknowledge_watermark_preset_name_taken");return}let a=null;this.watermarkPresets.forEach(s=>{!a&&s.presetID===e&&(a=s)}),!!a&&(a.presetName=t,this.presetModal.updatePresetButtons(this.watermarkPresets),this.watermarkControls.forEach(s=>{s.updatePresetList(this.watermarkPresets)}),this.saveWatermarkPresets())}saveWatermarkPreset(e="",t=null){if(!(e&&this.previewWatermarkURL))return;let r=null,a=()=>{let s=null;this.watermarkPresets.forEach(n=>{!s&&n.presetName===e&&(s=n)});let o=this.editModal.getWatermarkData();if(s){let n=s.watermarkURL||null;Object.assign(s,o),o=s,o.watermarkURL=r,n&&(this.watermarkPresets.forEach(l=>{n&&l.watermarkURL===n&&(n=null)}),n&&this.deleteWatermarkFromServer(n))}else o.presetID=`preset_${BeFunky.hash(e).toString(36)}`,o.presetName=e,o.watermarkURL=r,this.watermarkPresets.push(o);this.presetModal.updatePresetButtons(this.watermarkPresets),this.watermarkControls.forEach(n=>{n.updatePresetList(this.watermarkPresets)}),this.selectedPresetID=o.presetID,this.saveWatermarkPresets(),t&&t()};if(this.previewWatermarkBlob){let s=!1;BeFunky.showLoadScreen({message:"uploading_watermark",onCancel:()=>{s=!0}}),this.saveWatermarkToServer(this.previewWatermarkBlob,o=>{BeFunky.hideLoadScreen(),o.url?s?this.deleteWatermarkFromServer(o.url):(r=o.url,a()):(BeFunky.logError(`Watermark Upload Error${o.error?` : ${o.error}`:""}`),BeFunky.acknowledge("acknowledge_watermark_upload_error"))})}else r=this.previewWatermarkURL,a()}setWatermarkData(e={}){this.watermarkData=null,!["frameW","frameH","framePadding","watermarkPlacement","watermarkW","watermarkH","watermarkAlpha","watermarkURL"].some(r=>!e.hasOwnProperty(r))&&(this.watermarkData=e,this.activated&&this.loadWatermarkFromURL(this.watermarkData.watermarkURL))}loadWatermarkFromURL(e=null){this.clearWatermarkTexture(),!!e&&(BeFunky.showLoadScreen(),BeFunky.isSafari&&(e=`${e}?nocache=${Math.random().toString().split(".")[1]}`),this.watermarkURL=e,this.graphicLoader.graphicsData.watermarkTexture=this.watermarkURL,this.graphicLoader.loadGraphics())}drawWatermark(e){if(!(this.watermarkActive&&e&&e.baseTexture))return;let t=this.watermarkTexture,r=this.watermarkData,a=Math.sqrt(r.frameW**2+r.frameH**2),s=Math.sqrt(r.watermarkW**2+r.watermarkH**2),o=e.baseTexture.width,n=e.baseTexture.height,c=Math.sqrt(o**2+n**2)/a,h=t.baseTexture.width,u=t.baseTexture.height,d=Math.sqrt(h**2+u**2),m=s/d,p=r.framePadding*c,g=o-p*2,f=n-p*2,v=Math.min(c*m,g/h,f/u),T=0,x=0;r.watermarkPlacement.includes("l")&&(T=p),r.watermarkPlacement.includes("c")&&(T=o/2-h/2*v),r.watermarkPlacement.includes("r")&&(T=o-p-h*v),r.watermarkPlacement.includes("t")&&(x=p),r.watermarkPlacement.includes("m")&&(x=n/2-u/2*v),r.watermarkPlacement.includes("b")&&(x=n-p-u*v),e.copyPixels(t,{x:T,y:x},!1,r.watermarkAlpha,v)}showPopover(e,t=0,r=0){if(e){let a=document.getElementById(e),s=document.getElementById(`${e}_placeholder`);if(a&&s){let o=s.getBoundingClientRect(),n=this.editModal.getBoundingClientRect();a.setStyles({left:`${o.x-n.x+t}px`,top:`${o.y-n.y+r}px`}),a.show()}}}getPresetObjectById(e){let t=null;return this.watermarkPresets.forEach(r=>{r.presetID&&r.presetID===e&&(t=r)}),t}setSelectedPresetObject(e){let t=this.getSelectedPresetObject();this.watermarkPresets.forEach(a=>{a.selected=e===a});let r=this.getSelectedPresetObject();t!==r&&this.saveWatermarkPresets()}getSelectedPresetObject(){let e=null;return this.watermarkPresets.forEach(t=>{!e&&t.selected&&(e=t)}),e}handleGraphicLoaderComplete(e){this.clearWatermarkTexture(),this.graphicLoader.graphics.watermarkTexture&&(this.watermarkTexture=this.graphicLoader.graphics.watermarkTexture.renderClone()),this.graphicLoader.reset(),this.useWatermark&&this.dispatchEvent(BFN.WatermarkManagerEvents.WATERMARK_UPDATED),BeFunky.hideLoadScreen()}set useWatermark(e){e=!!e,e!==this._useWatermark&&(this._useWatermark=e,this.watermarkControls.forEach(t=>{t.selected=this._useWatermark}),this.setUseWatermarkIndexedDB(),this.dispatchEvent(BFN.WatermarkManagerEvents.WATERMARK_UPDATED))}get useWatermark(){return this._useWatermark}set selectedPresetID(e){this.clearWatermarkTexture();let t=this.getPresetObjectById(e);this._selectedPresetID=t?t.presetID:null,this.watermarkControls.forEach(r=>{r.selectedPresetID=this._selectedPresetID}),this.presetModal.selectedPresetID=this._selectedPresetID,this.setWatermarkData(t||{}),this.setSelectedPresetObject(t)}get selectedPresetID(){return this._selectedPresetID}get watermarkActive(){return!!(this._useWatermark&&this.watermarkTexture&&this.watermarkTexture.baseTexture&&this.watermarkData)}};BFN.SingletonQueue.add(()=>{BFN.WatermarkManager=new kB});var AB=class extends BFN.EventDispatcher{constructor(){super();this.init()}init(){this.initDefaultValues()}initDefaultValues(){this.funnelEvents=["editing_applied","text_added","image_layer_added","image_layer_masked","collage_layout_selected","collage_grid_image_added"],this.noParentActions=["image_layer_masked"],this.userActionVOs={editor:[],collage:[],designer:[]},this.pendingImageLayerAddedUserActionVOs={editor:[],collage:[],designer:[]},this.trackImageLayerAddedUserActionVOs=BeFunky.debounce(this.trackImageLayerAddedUserActionVOs.bind(this),3e4),this.pendingImageLayerMaskedUserActionVOs={editor:[],collage:[],designer:[]},this.trackImageLayerMaskedUserActionVOs=BeFunky.debounce(this.trackImageLayerMaskedUserActionVOs.bind(this),3e4),this.pendingCollageGridImageAddedUserActionVOs=[],this.trackCollageGridImageAddedUserActionVOs=BeFunky.debounce(this.trackCollageGridImageAddedUserActionVOs.bind(this),3e4),this.trackedCollageLayoutSelectedUserActionVO=null,this.pendingCollageLayoutSelectedUserActionVO=null,this.trackPendingCollageLayoutSelectedUserActionVO=BeFunky.debounce(this.trackPendingCollageLayoutSelectedUserActionVO.bind(this),3e4),this.lastEventID=null,this.lastAppViewState=null,window.addEventListener("INIT_COMPLETE",()=>{this.lastAppViewState=BFN.AppModel.viewState}),this.sessionStarted=!1,this.isTrackable=!1,this._upgradeActions=[],BFN.BfnService.addEventListener(BFN.BfnServiceEvents.USER_DATA_CHANGED.type,this.handleUserDataChanged.bind(this)),this.handleUserDataChanged(),BFN.AppModel.addEventListener(BFN.AppModelEvents.VIEWSTATE_UPDATED.type,this.handleAppViewStateUpdated.bind(this)),BFN.GlobalHistoryModel.addEventListener(BFN.GlobalHistoryModelEvents.HISTORY_ID_UPDATED.type,this.handleGlobalHistoryIDUpdated.bind(this)),BFN.GlobalHistoryModel.addEventListener(BFN.GlobalHistoryModelEvents.HISTORY_UPDATED.type,this.handleGlobalHistoryUpdated.bind(this)),BFN.PhotoEditorCanvasModel.addEventListener(BFN.PhotoEditorCanvasModelEvents.CLEAR_ITEMS.type,this.handlePhotoEditorClearItems.bind(this)),BFN.CollageMakerCanvasModel.addEventListener(BFN.CollageMakerCanvasModelEvents.CLEAR_ITEMS.type,this.handleCollageMakerClearItems.bind(this)),BFN.DesignerCanvasModel.addEventListener(BFN.DesignerCanvasModelEvents.CLEAR_ITEMS.type,this.handleDesignerClearItems.bind(this))}trackImageLayerAddedUserActionVOs(){this.trackImageLayerAddedUserActionVOsImmediately()}trackImageLayerAddedUserActionVOsImmediately(){for(let e in this.pendingImageLayerAddedUserActionVOs){let t=null,r=this.pendingImageLayerAddedUserActionVOs[e];if(r.length){let a=r.length;for(;--a>-1;){let s=r[a];if(s.transformItem.destroyed)r.splice(a,1);else if(s.active&&s.transformItem.parent){let o=s.eventObject;t||(t={imageLayerTypes:[],imageLayerSources:[]}),t.imageLayerTypes.push(...o.imageLayerTypes),t.imageLayerSources.push(...o.imageLayerSources),o.imageLayerGraphicsStyle&&(t.imageLayerGraphicsStyle=t.imageLayerGraphicsStyle||[],t.imageLayerGraphicsStyle.push(...o.imageLayerGraphicsStyle)),r.splice(a,1)}}t&&(t.imageLayerTypes=t.imageLayerTypes.unique().sort(),t.imageLayerSources=t.imageLayerSources.unique().sort(),t.imageLayerGraphicsStyle&&(t.imageLayerGraphicsStyle=t.imageLayerGraphicsStyle.unique().sort()),window.bfn_mp&&window.bfn_mp.track("image_layer_added",t))}}}trackImageLayerMaskedUserActionVOs(){this.trackImageLayerMaskedUserActionVOsImmediately()}trackImageLayerMaskedUserActionVOsImmediately(){for(let e in this.pendingImageLayerMaskedUserActionVOs){let t=null,r=this.pendingImageLayerMaskedUserActionVOs[e];if(r.length){let a=r.length;for(;--a>-1;){let s=r[a];if(s.transformItem.destroyed)r.splice(a,1);else if(s.active&&(s.transformItem.parent||this.noParentActions.includes(s.eventID))){let o=s.eventObject;t||(t={imageLayerMaskedTypes:[],imageLayerMaskedSources:[]}),t.imageLayerMaskedTypes.push(...o.imageLayerMaskedTypes),t.imageLayerMaskedSources.push(...o.imageLayerMaskedSources),r.splice(a,1)}}t&&(t.imageLayerMaskedTypes=t.imageLayerMaskedTypes.unique().sort(),t.imageLayerMaskedSources=t.imageLayerMaskedSources.unique().sort(),window.bfn_mp&&window.bfn_mp.track("image_layer_masked",t))}}}trackCollageGridImageAddedUserActionVOs(){this.trackCollageGridImageAddedUserActionVOsImmediately()}trackCollageGridImageAddedUserActionVOsImmediately(){let e=null,t=this.pendingCollageGridImageAddedUserActionVOs;if(t.length){let r=t.length;for(;--r>-1;){let a=t[r];if(a.active){let s=a.eventObject;e||(e={cellImageTypes:[],cellImageSources:[]}),e.cellImageTypes.push(...s.cellImageTypes),e.cellImageSources.push(...s.cellImageSources),t.splice(r,1)}}e&&(e.cellImageTypes=e.cellImageTypes.unique().sort(),e.cellImageSources=e.cellImageSources.unique().sort(),window.bfn_mp&&window.bfn_mp.track("collage_grid_image_added",e))}}updatePendingCollageLayoutSelectedUserActionVO(){if(BFN.AppModel.viewingCollage){let e=null,t=this.getActiveUserActionVOs("collage"),r=t.length;for(;--r>-1;){let a=t[r];if(a.eventID==="collage_layout_selected"){e=a;break}}e&&(e!==this.trackedCollageLayoutSelectedUserActionVO?this.pendingCollageLayoutSelectedUserActionVO=e:this.pendingCollageLayoutSelectedUserActionVO=null)}}trackPendingCollageLayoutSelectedUserActionVO(){this.trackPendingCollageLayoutSelectedUserActionVOImmediately()}trackPendingCollageLayoutSelectedUserActionVOImmediately(){this.pendingCollageLayoutSelectedUserActionVO&&(this.pendingCollageLayoutSelectedUserActionVO.track(),this.trackedCollageLayoutSelectedUserActionVO=this.pendingCollageLayoutSelectedUserActionVO,this.pendingCollageLayoutSelectedUserActionVO=null)}registerUserAction(e){if(!!(e&&e.isValid)){if(this.funnelEvents.includes(e.eventID))switch(e.actionSection){case"editor":case"collage":case"designer":this.purgeInactiveUserActionVOs(e.actionSection),this.userActionVOs[e.actionSection].push(e);break}switch(this.lastEventID==="image_layer_added"&&e.eventID!=="image_layer_added"&&this.trackImageLayerAddedUserActionVOsImmediately(),this.lastEventID==="image_layer_masked"&&e.eventID!=="image_layer_masked"&&this.trackImageLayerMaskedUserActionVOsImmediately(),this.lastEventID==="collage_grid_image_added"&&e.eventID!=="collage_grid_image_added"&&this.trackCollageGridImageAddedUserActionVOsImmediately(),e.eventID!=="collage_layout_selected"&&this.trackPendingCollageLayoutSelectedUserActionVOImmediately(),e.eventID){case"text_added":this.lastEventID!==e.eventID&&e.track();break;case"image_layer_added":switch(e.actionSection){case"editor":case"collage":case"designer":e.transformItem&&(this.pendingImageLayerAddedUserActionVOs[e.actionSection].push(e),this.trackImageLayerAddedUserActionVOs());break}break;case"image_layer_masked":switch(e.actionSection){case"editor":case"collage":case"designer":e.transformItem&&(this.pendingImageLayerMaskedUserActionVOs[e.actionSection].push(e),this.trackImageLayerMaskedUserActionVOs());break}break;case"collage_grid_image_added":switch(e.actionSection){case"editor":case"collage":case"designer":this.pendingCollageGridImageAddedUserActionVOs.push(e),this.trackCollageGridImageAddedUserActionVOs();break}break;case"collage_layout_selected":switch(e.actionSection){case"editor":case"collage":case"designer":this.updatePendingCollageLayoutSelectedUserActionVO(),this.trackPendingCollageLayoutSelectedUserActionVO();break}break;default:e.track()}this.lastEventID=e.eventID}}purgeInactiveUserActionVOs(e=null){switch(e=e||BFN.AppModel.sectionID,e){case"editor":case"collage":case"designer":let t=this.userActionVOs[e],r=t.length;for(;--r>-1;)t[r].active||t.splice(r,1);break}}purgeUserActionVOs(e=null){switch(e=e||BFN.AppModel.sectionID,e){case"editor":case"collage":case"designer":this.userActionVOs[e].splice(0),this.pendingImageLayerAddedUserActionVOs[e].splice(0),this.pendingImageLayerMaskedUserActionVOs[e].splice(0),e==="collage"&&this.pendingCollageGridImageAddedUserActionVOs.splice(0);break}}updateUserActionVOsActiveState(e=null){e=e||BFN.AppModel.sectionID;let t=BFN.AppModel.getSectionValue(e,BFN.AppModelViewStates.VIEWING_PHOTO_EDITOR,BFN.AppModelViewStates.VIEWING_COLLAGE_MAKER,BFN.AppModelViewStates.VIEWING_DESIGNER),r=BFN.GlobalHistoryModel.selectedHistoryID[t];if(r){let a=BFN.GlobalHistoryModel.globalHistoryVOHash[r];if(a){let s=BFN.AppModel.sectionID;this.userActionVOs[s].forEach(n=>{n.active=n.actionTimestamp<=a.timestamp})}}}addUpgradeAction(e=[],t=!0){let r=null,a=t?BFN.AppModel.sectionValue("Photo Editor","Collage Maker","Designer"):"";e.forEach(o=>{o&&typeof o=="string"&&(r||(r=a),r+=(r?" - ":"")+o)});let s=BeFunky.getLocal("upgradeActions");s&&(s=s.split(","),this._upgradeActions.splice(0),this._upgradeActions.push(...s)),r&&!this._upgradeActions.includes(r)&&(this._upgradeActions.push(r),BeFunky.setLocal("upgradeActions",this._upgradeActions))}translateToReadable(e=""){return typeof e!="string"?"":e.toLowerCase().split(" ").join("_").split("_").map(t=>t.charAt(0).toUpperCase()+t.slice(1)).join(" ")}getActiveUserActionVOs(e=null){switch(e=e||BFN.AppModel.sectionID,e){case"editor":case"collage":case"designer":return this.userActionVOs[e].filter(a=>a.active).sort((a,s)=>a.actionTimestamp-s.actionTimestamp)}return[]}getSaveData(){this.trackImageLayerAddedUserActionVOsImmediately(),this.trackCollageGridImageAddedUserActionVOsImmediately(),this.trackPendingCollageLayoutSelectedUserActionVOImmediately();let e=BFN.AppModel.sectionID,t={actions:[],fonts:[],assets:[],graphicFileNames:[],graphicStyles:[]},r=this.getActiveUserActionVOs(e),a=[];BFN.AppModel.getSectionValue(BFN.AppModel.viewState,BFN.PhotoEditorCanvas.transformLayer,BFN.CollageMakerCanvas.transformLayer,BFN.DesignerCanvas.transformLayer).children.forEach(n=>{n instanceof BFN.TransformItem&&a.push(n)});let o=r.length;for(;--o>-1;){let n=r[o];n.transformItems&&n.transformItems.length&&n.transformItems.forEach(c=>{a.includes(c)||a.push(c)});let l=null;if(this.funnelEvents.includes(n.eventID))switch(n.eventID){case"editing_applied":l=this.getFunnelString(n.eventObject.toolType,n.eventObject.toolName);break;case"text_added":l="Text Added";break;case"image_layer_added":l="Image Layer Added";break;case"image_layer_masked":l="Image Layer Masked";break;case"collage_grid_image_added":l="Collage Grid Image Added";break}l&&!t.actions.includes(l)&&t.actions.push(l)}if(e==="collage"){let n=null,l=this.getActiveUserActionVOs("collage"),c=l.length;for(;--c>-1;){let u=l[c];if(u.eventID==="collage_layout_selected"){n=u;break}}let h="Collage Layout : ";if(n){let{templateType:u}=n.eventObject,{templateCategory:d}=n.eventObject;u&&d?h+=this.getFunnelString(u,d):h+="Unknown"}else h+="User Project";t.actions.push(h)}if(e==="designer"&&BFN.DesignerModel.projectVO){let{sourceTemplateID:n}=BFN.DesignerModel.projectVO,l="Design Layout : ";n?l+=`Preset ${n}`:l+="Custom",t.actions.push(l)}return a.forEach(n=>{if(n.type==="text"){let{iText:l}=n;for(let c in l.styles)for(let h in l.styles[c]){let u=l.styles[c][h];u.hasOwnProperty("fontFamily")&&!t.fonts.includes(u.fontFamily)&&t.fonts.push(u.fontFamily)}}else{let{assetOrigin:l}=n;l&&!t.assets.includes(l)&&t.assets.push(l);let h={line:"Outline",solid:"Solid",color:"Multicolor"}[n.graphicStyle];h&&!t.graphicStyles.includes(h)&&t.graphicStyles.push(h);let{graphicID:u,maskImageMaskID:d,imageID:m}=n.projectItemVO,p=[u,d,m].find(g=>g&&g.startsWith("graphic_"));if(p){let g=n.isShape?"svg":"png",f=`${p.replace("graphic_","")}.${g}`;f&&!t.graphicFileNames.includes(f)&&t.graphicFileNames.push(f)}}}),e==="collage"&&!BFN.CollageMakerCanvasPhotoGridModel.freeform&&BFN.PhotoGrid.gridChildren.forEach(n=>{if(n.menuImageVO&&n.menuImageVO.id){let l=n.menuImageVO.id,c=this.getAssetOrigin(l);c&&!t.assets.includes(c)&&t.assets.push(c)}}),t.actions.sort(),t.fonts.sort(),t.assets.sort(),t}getAssetOrigin(e){let t="Unknown";switch(BFN.getImageType(e)){case"computer":t="Computer";break;case"sample":t="Sample";break;case"befunky_photo":t="BeFunky Photo";break;case"befunky_layer":t="BeFunky Layer";break;case"pixabay":t="Pixabay";break;case"unsplash":t="Unsplash";break;case"pexels":t="Pexels";break;case"facebook":t="Facebook";break;case"patterns":t="Patterns";break;case"graphic":t="Graphic Library";break;case"template_svg":t="Graphic Library";break;case"image":t="Template";break;case"mask_image":t="Template";break}return t}getFunnelString(...e){let t=null;return e.forEach(r=>{r&&typeof r=="string"&&(t||(t=""),t&&(t+=" - "),t+=r)}),t}getEditorToolObject(e){if(!e)return null;let t=s=>BeFunky.LanguageManager.languageData.en[s]||s,r={},a=!0;if(a&&BFN.ArtsyAdjustAndPaintToolObjects.hasOwnProperty(e)){let s=BFN.ArtsyAdjustAndPaintToolObjects[e];if(s.hasOwnProperty("controls")){let{controls:o}=s;if(o.hasOwnProperty(`${e}_id`)){switch(r.toolID=e,r.toolName=t(s.name||e),r.toolPresetID=o[`${e}_id`].defaultValue,r.toolSearchID=e,s.type){case"edit":r.toolType="Edit";break;case"touch_up":r.toolType="Touch Up";break;case"effect":r.toolType="Basic Effect";break;case"artsy":r.toolType="Artsy";break;case"frame":r.toolType="Frame";break;case"texture":r.toolType="Texture";break;case"overlay":r.toolType="Overlay";break;default:r.toolType="Edit"}a=!1}}}if(a)for(let s in BFN.UIMenuData.accordionMenus){if(!a)break;let o=BFN.UIMenuData.accordionMenus[s];for(let n=0;n<o.length&&a;n++){let c=o[n].items;for(let h=0;h<c.length&&a;h++){let u=c[h];if(u.name===e){switch(s){case"editor_edit":r.toolType="Edit";break;case"editor_touch_up":r.toolType="Touch Up";break}r.toolName=t(u.name),r.toolID=u.name,r.toolSearchID=e,a=!1}}}}if(a){let s=BFN.effectPresetMap[e];if(s)for(let o=0;o<BFN.EffectData.length&&a;o++){let n=BFN.EffectData[o];s===n.id&&(r.toolType="Basic Effect",r.toolName=n.name,r.toolID=n.id,r.toolPresetID=e.replace(`${s}_`,""),r.toolSearchID=e,a=!1)}}if(a&&BFN.LensFlareData.presets.hasOwnProperty(e)){let s=BFN.LensFlareData.presets[e];r.toolType="Basic Effect",r.toolName="Lens Flare",r.toolID="lens_flare",r.toolPresetID=s.presetID,r.toolSearchID=e,a=!1}if(a&&BFN.ArtsyPresetObjects.hasOwnProperty(e)&&BFN.artsyPresetMap.hasOwnProperty(e)){let s=BFN.ArtsyPresetObjects[e],o=BFN.artsyPresetMap[e];if(s.isArtsy){let n=["digitalart"];for(let l=0;l<BFN.ArtsyData.length&&a;l++){let c=BFN.ArtsyData[l];o===c.id&&(r.toolType="Artsy",r.toolName=n.includes(c.id)?s.name:c.name,r.toolID=c.id,r.toolPresetID=s.id,r.toolSearchID=e,a=!1)}}}if(a){let s=BFN.textureCategoryIDMap[e];if(s){let o=BFN.textureIDMap[s];if(o)for(let n=0;n<BFN.TextureData.length&&a;n++){let l=BFN.TextureData[n];o===l.id&&(r.toolType="Texture",r.toolName=l.name,r.toolID=l.id,r.toolPresetID=s,r.toolSearchID=e,a=!1)}}}if(a)switch(e){case"fit_to_square":r.toolType="Frame",r.toolName="Fit to Square",r.toolID="square",r.toolSearchID=e,a=!1;break;case"border":r.toolType="Frame",r.toolName="Border",r.toolID="border",r.toolSearchID=e,a=!1;break;case"drop_shadow":r.toolType="Frame",r.toolName="Drop Shadow",r.toolID="drop_shadow",r.toolSearchID=e,a=!1;break;default:let s=BFN.frameCategoryIDMap[e];if(s){let o=BFN.frameIDMap[s];if(o)for(let n in BFN.FrameData){if(!a)break;let l=BFN.FrameData[n];for(let c=0;c<l.length&&a;c++){let h=l[c];o===h.id&&(r.toolType="Frame",r.toolName=h.name,r.toolID=h.id,r.toolPresetID=s,r.toolSearchID=e,a=!1)}}}}if(a&&BFN.OverlaysManager.isDataLoaded){let s=BFN.OverlaysManager.overlayCategoryIDMap[e];if(s){let o=BFN.OverlaysManager.overlayIDMap[s];if(o)for(let n=0;n<BFN.OverlaysManager.overlayMenuData.length&&a;n++){let l=BFN.OverlaysManager.overlayMenuData[n];o===l.id&&(r.toolType="Overlay",r.toolName=l.englishName,r.toolID=l.id,r.toolPresetID=s,r.toolSearchID=e,a=!1)}}}return!a&&r.toolType&&r.toolName?(r.toolSearchID=e,r):(BeFunky.logError("Failed to find _searchID",e),null)}handleUserDataChanged(e){!this.sessionStarted&&window.bfn_mp&&(this.sessionStarted=!0,BeFunky.waitUntil({condition:()=>!!BFN.AppModel.viewState,onSuccess:()=>{this.isTrackable=!0,window.bfn_mp.track("app_session_started")},onTimeout:()=>BeFunky.throwError("Unable to track app_session_started")}))}handleAppViewStateUpdated(e){if(this.lastAppViewState!==BFN.AppModel.viewState){let t=this.lastAppViewState;if(this.lastAppViewState=BFN.AppModel.viewState,!t||!BFN.AppModel.viewStateChangeReason||!window.isAppOpen)return;let r=new BFN.UserActionVO;r.eventID="app_section_changed",BFN.AppModel.viewStateChangeReason&&typeof BFN.AppModel.viewStateChangeReason=="string"&&(r.eventObject={reason:BFN.AppModel.viewStateChangeReason},BFN.AppModel.viewStateChangeReason=null),r.superObject={appSection:BFN.AppModel.sectionValue("Photo Editor","Collage Maker","Designer")},r.register()}}handleGlobalHistoryIDUpdated(e){this.updateUserActionVOsActiveState(),this.trackImageLayerAddedUserActionVOsImmediately(),this.trackCollageGridImageAddedUserActionVOsImmediately(),this.updatePendingCollageLayoutSelectedUserActionVO()}handleGlobalHistoryUpdated(e){this.updateUserActionVOsActiveState()}handlePhotoEditorClearItems(e){this.purgeUserActionVOs("editor")}handleCollageMakerClearItems(e){this.purgeUserActionVOs("collage")}handleDesignerClearItems(e){this.purgeUserActionVOs("designer")}get upgradeActions(){let e=BeFunky.getLocal("upgradeActions");return e&&(e=e.split(","),e.forEach(t=>{this._upgradeActions.includes(t)||this._upgradeActions.splice(0,0,t)})),this._upgradeActions}};BFN.SingletonQueue.add(()=>{BFN.UserActionManager=new AB});var OB=class{constructor(){this.init()}init(){this.initDefaultValues()}initDefaultValues(){BFN.AppModel.addEventListener(BFN.AppModelEvents.VIEWSTATE_UPDATED.type,this.updateAlignmentAvailable.bind(this)),BFN.PhotoEditorCanvasModel.addEventListener(BFN.PhotoEditorCanvasModelEvents.VIEWSTATE_UPDATED.type,this.updateAlignmentAvailable.bind(this)),BFN.TransformLayerManager.addEventListener(BFN.TransformLayerManagerEvents.ITEMS_UPDATED.type,this.updateAlignmentAvailable.bind(this)),BFN.PhotoEditorModel.addEventListener(BFN.PhotoEditorModelEvents.SOURCE_IMAGE_UPDATED.type,this.updateAlignmentAvailable.bind(this))}updateAlignmentAvailable(){let e=BFN.PhotoEditorCanvasModel.viewState===BFN.PhotoEditorCanvasModelViewStates.VIEWING_CANVAS&&!BFN.TransformItemIsolator.active;BFN.AppModel.viewingEditor&&(e=e&&BFN.PhotoEditorModel.currentTexture),BFN.canvasFooter.alignmentEnabled=Boolean(e)}handleAlignmentUpdate(){let e=UITools.getToolVO("alignment");switch(e.updating_id){case"toggle_panel":Ri();break;case"snapping":{let t=e.snapping===!0;BFN.TransformModel.snappingEnabled=t,BFN.SettingsManager.updateSetting("snapping",t?"yes":"no");break}case"display_distances":{let t=e.display_distances===!0;BFN.TransformModel.showMeasurements=t,BFN.SettingsManager.updateSetting("display_distances",t?"yes":"no");break}case"guides":{let t=e.guides===!0;BFN.TransformGuides.updateVisibility(),BFN.SettingsManager.updateSetting("guides",t?"yes":"no");break}}}};BFN.SingletonQueue.add(()=>{BFN.AlignmentOptionsManager=new OB});var RB=class{constructor(){this.init()}init(){BeFunky.log("BasicShapeManager Init"),this.initDefaultValues()}initDefaultValues(){this.validShapeTypes=["group","line","rectangle","triangle","ellipse","polygon","star","arrow"],this.strokeShapeTypes=["rectangle","triangle","ellipse","polygon"],this.defaultFill="EEEEFF",this.defaultStroke="DDDDFF",this.defaultValuesSetByUser=[],this.defaultValues={fill:this.defaultFill,fillAlpha:1,stroke:-1,strokeAlpha:1,strokeWidth:10,lineStyle:"solid",lineSegmentWidth:3,lineGapSize:.5,rectangleCornerRounding:0,polygonSides:5,polygonShiftOrientation:!1,starPoints:5,starInsetWeight:.5,starShiftOrientation:!1,arrowWeight:.25,arrowStyle:"thick",arrowDoubleSided:!1},this.ghostColor=8421504,this.ghostAlpha=.5,this.minHitAreaStrokeWidth=20}createShape(e,t=null,r={}){if(!this.validShapeTypes.includes(e))return;switch(r.hasOwnProperty("fill")||(r.fill=this.defaultValues.fill),r.hasOwnProperty("fillAlpha")||(r.fillAlpha=this.defaultValues.fillAlpha),r.hasOwnProperty("stroke")||(r.stroke=this.defaultValues.stroke),r.hasOwnProperty("strokeAlpha")||(r.strokeAlpha=this.defaultValues.strokeAlpha),r.hasOwnProperty("strokeWidth")||(r.strokeWidth=this.defaultValues.strokeWidth),e){case"line":r.hasOwnProperty("lineStyle")||(r.lineStyle=this.defaultValues.lineStyle),r.hasOwnProperty("lineSegmentWidth")||(r.lineSegmentWidth=this.defaultValues.lineSegmentWidth),r.hasOwnProperty("lineGapSize")||(r.lineGapSize=this.defaultValues.lineGapSize),r.fill=-1,r.fillAlpha=1,r.stroke===-1&&!this.defaultValuesSetByUser.includes("stroke")&&(r.stroke=this.defaultStroke);break;case"rectangle":r.hasOwnProperty("rectangleCornerRounding")||(r.rectangleCornerRounding=Math.min(.5,this.defaultValues.rectangleCornerRounding));break;case"polygon":r.hasOwnProperty("polygonSides")||(r.polygonSides=this.defaultValues.polygonSides),r.hasOwnProperty("polygonShiftOrientation")||(r.polygonShiftOrientation=this.defaultValues.polygonShiftOrientation);break;case"star":r.hasOwnProperty("starPoints")||(r.starPoints=this.defaultValues.starPoints),r.hasOwnProperty("starInsetWeight")||(r.starInsetWeight=this.defaultValues.starInsetWeight),r.hasOwnProperty("starShiftOrientation")||(r.starShiftOrientation=this.defaultValues.starShiftOrientation),r.stroke=-1,r.strokeAlpha=1,r.strokeWidth=0;break;case"arrow":r.hasOwnProperty("arrowWeight")||(r.arrowWeight=this.defaultValues.arrowWeight),r.hasOwnProperty("arrowStyle")||(r.arrowStyle=this.defaultValues.arrowStyle),r.hasOwnProperty("arrowDoubleSided")||(r.arrowDoubleSided=this.defaultValues.arrowDoubleSided),r.stroke=-1,r.strokeAlpha=1,r.strokeWidth=0;break}let a=new BFN.BasicShapeVO(e,r),s=BFN.AppModel.sectionValue(BFN.PhotoEditorCanvasModel,BFN.CollageMakerCanvasModel,BFN.DesignerCanvasModel),o={type:"texture",texture:null,isGoodie:!0,basicShapeVO:a};t&&(o.initialCenterPosition=t),s.addedItem=o}updateDefaultValues(e={}){for(let t in e)this.defaultValues.hasOwnProperty(t)&&(this.defaultValuesSetByUser.includes(t)||this.defaultValuesSetByUser.push(t),this.defaultValues[t]=e[t])}drawShape(e){if(!e)return;let t=["line"].includes(e.type),r=e.fillColor,a=Math.max(.01,e.fillAlpha),s=e.strokeColor,o=Math.max(.01,e.strokeAlpha),n=e.stroke===-1&&!t?0:e.strokeWidth*e.fitScale,l=e.shapeW,c=e.shapeH;e.shape.clear();let h=null;switch(e.type){case"line":this.drawLine(e,l,c,n);break;case"triangle":h=this.getTrianglePoints(l,c,n);break;case"rectangle":h=this.getRectPoints(l,c,n,e.attributes.rectangleCornerRounding);break;case"ellipse":h=this.getPolygonPoints(l,c,n,128,!0);break;case"polygon":h=this.getPolygonPoints(l,c,n,e.attributes.polygonSides,e.attributes.polygonShiftOrientation);break;case"star":h=this.getStarPoints(l,c,e.attributes.starPoints,e.attributes.starInsetWeight,e.attributes.starShiftOrientation);break;case"arrow":h=this.getArrowPoints(l,c,e.attributes.arrowStyle,e.attributes.arrowWeight,e.attributes.arrowDoubleSided);break}if(e.hitAreaPolygonPoints&&(e.hitAreaPolygonPoints.splice(0),e.hitAreaPolygonPoints=null),h){this.drawInsetShape(e,h.outerPoints,h.innerPoints,r,a,s,o,n);let{outerPointsHitArea:u,innerPointsHitArea:d}=h;u&&(d&&d.length&&r===null&&(u.push(u[0]),d.reverse(),u.push(...d),u.push(d[0])),u.length&&(e.hitAreaPolygonPoints=u))}}drawInsetShape(e,t,r,a=null,s=1,o=null,n=1,l=0){if(!(!e||!t))if(r=r||null,window.testShapes)this.drawRect(e,e.shapeW,e.shapeH,16711680),this.drawFill(e,t,16777215,1),r&&(r.forEach((c,h)=>{h||e.shape.lineStyle(2,0),e.shape.moveTo(c.x,c.y);let u=r[(h+1)%r.length];e.shape.lineTo(u.x,u.y)}),e.shape.lineStyle(null),r.forEach(c=>{c.invalid?e.shape.beginFill(16711680,.6):c.intersection?e.shape.beginFill(16711935,.6):e.shape.beginFill(255,.6),e.shape.drawCircle(c.x,c.y,c.invalid?5:10),e.shape.endFill()}));else if(r&&!r.length)l?o!==null?this.drawFill(e,t,o,n):this.drawFill(e,t,this.ghostColor,this.ghostAlpha):a!==null?this.drawFill(e,t,a,s):this.drawFill(e,t,this.ghostColor,this.ghostAlpha);else{let c=!1,h=!1;r&&(r.length&&(t.push(t[0]),r.reverse(),t.push(...r),t.push(r[0])),this.drawFill(e,t,o,n),c=!0),a!==null&&(l&&r&&r.length?(c&&r.reverse(),this.drawFill(e,r,a,s)):this.drawFill(e,t,a,s),h=!0),!h&&!c&&this.drawFill(e,t,this.ghostColor,this.ghostAlpha)}}drawFill(e,t,r=null,a=1){if(!e||!t||t.length<3)return;let s=e.shape;s.lineStyle(null),r!==null&&s.beginFill(r,a),t.forEach((o,n)=>{n?s.lineTo(o.x,o.y):s.moveTo(o.x,o.y)}),r!==null?s.endFill():s.addHole()}drawRect(e,t=0,r=0,a=null,s=1){if(!e||t<=0||r<=0)return;let o=t,n=r,l=e.shapeW/2,c=e.shapeH/2;this.drawFill(e,[{x:l-o/2,y:c-n/2},{x:l+o/2,y:c-n/2},{x:l+o/2,y:c+n/2},{x:l-o/2,y:c+n/2}],a,s)}drawLine(e,t=0,r=0,a=0){if(!e||t<=0||r<=0||a<=0)return;e.shape.drawRect(0,(r-a)/2,t,a);let{stroke:s,strokeColor:o,strokeAlpha:n}=e;switch(s===-1&&(o=this.ghostColor,n=this.ghostAlpha),e.shape.beginFill(o,n),e.attributes.lineStyle){case"solid":{e.shape.drawRect(0,(r-a)/2,t,a);break}case"dashed":{let l=Math.min(t,a*e.attributes.lineSegmentWidth),c=l*(1+e.attributes.lineGapSize);for(let h=0;h<t;h+=c)e.shape.drawRect(h,(r-a)/2,Math.min(l,t-h),a);break}case"dotted":{let l=Math.min(t,a)/2,c=l*(2+e.attributes.lineGapSize*2);for(let h=l;h<t;h+=c)h+l<=t&&e.shape.drawCircle(h,r/2,l);break}}e.shape.endFill()}drawBezierEllipse(e,t=0,r=0,a=null,s=1,o=null){if(!e||t<=0||r<=0)return;let n=.551915024494,l=Math.abs(t),c=Math.abs(r),h=e.shapeW/2,u=e.shapeH/2,d=h-l*.5,m=h+l*.5,p=u-c*.5,g=u+c*.5,f=n*l*.5,v=c*n*.5;a!==null&&e.shape.beginFill(a,s),e.shape.lineStyle(null),e.shape.moveTo(h,p),e.shape.bezierCurveTo(h+f,p,m,u-v,m,u),e.shape.bezierCurveTo(m,u+v,h+f,g,h,g),e.shape.bezierCurveTo(h-f,g,d,u+v,d,u),e.shape.bezierCurveTo(d,u-v,h-f,p,h,p),o!==null&&o<=Math.min(l,c)/2&&(l-=o*2,c-=o*2,d=h-l*.5,m=h+l*.5,p=u-c*.5,g=u+c*.5,f=n*l*.5,v=c*n*.5,e.shape.lineTo(h,p),e.shape.bezierCurveTo(h-f,p,d,u-v,d,u),e.shape.bezierCurveTo(d,u+v,h-f,g,h,g),e.shape.bezierCurveTo(h+f,g,m,u+v,m,u),e.shape.bezierCurveTo(m,u-v,h+f,p,h,p)),a!==null?e.shape.endFill():e.shape.addHole()}getLinePoints(e=0,t=0,r=0){return e<=0||t<=0||r<=0?{outerPoints:[],innerPoints:[]}:{outerPoints:[new PIXI.Point(0,Math.round((t-r)/2)),new PIXI.Point(e,Math.round((t-r)/2)),new PIXI.Point(e,Math.round((t+r)/2)),new PIXI.Point(0,Math.round((t+r)/2))],innerPoints:[]}}getTrianglePoints(e=0,t=0,r=0){if(e<=0||t<=0||r<0)return{outerPoints:[],innerPoints:[]};let a=Math.atan(t/(e/2)),s=Math.atan(e/2/t),o=(u=0)=>{let d=u/Math.sin(a)+Math.tan(Math.PI/2-a)*u,m=u/Math.sin(s),p=Math.max(0,e-d*2),g=Math.max(0,t-m-u),f=[];return p>0&&g>0&&f.push(new PIXI.Point(e/2,m),new PIXI.Point(d,t-u),new PIXI.Point(e-d,t-u)),f},n=o(0),l=r>0?o(r):null,c=[...n],h=l?r>this.minHitAreaStrokeWidth?[...l]:o(this.minHitAreaStrokeWidth):null;return{outerPoints:n,innerPoints:l,outerPointsHitArea:c,innerPointsHitArea:h}}getRectPoints(e=0,t=0,r=0,a=0){let s=(h=0)=>{let u=e-h*2,d=t-h*2;if(u<=0||d<=0)return[];let m=[];if(a>0){let p=[],g=Math.min(u,d)/2*a,f=Math.max(8,Math.min(128,Math.round(g*(Math.PI*2)/4)));f-=f%4;let v=f/4,T=-(Math.PI/2);for(let x=0;x<f;x++){let B=new PIXI.Point(Math.cos(T)*g,Math.sin(T)*g);B.x+=e/2,B.y+=t/2,p.push(B),T+=Math.PI*2/f}for(let x=0;x<4;x++)for(let B=0;B<=v;B++){let y=p[(x*v+B)%p.length].clone();y.x+=(u/2-g)*([0,1].includes(x)?1:-1),y.y+=(d/2-g)*([1,2].includes(x)?1:-1);let F=!0;B===v&&(u===g*2&&[1,3].includes(x)&&(F=!1),d===g*2&&[0,2].includes(x)&&(F=!1)),F&&m.push(y)}}else{let p=(e-u)/2,g=(t-d)/2;m.push(new PIXI.Point(e-p,g),new PIXI.Point(e-p,t-g),new PIXI.Point(p,t-g),new PIXI.Point(p,g))}return m},o=s(0),n=r>0?s(r):null,l=[...o],c=n?r>this.minHitAreaStrokeWidth?[...n]:s(this.minHitAreaStrokeWidth):null;return{outerPoints:o,innerPoints:n,outerPointsHitArea:l,innerPointsHitArea:c}}getPolygonPoints(e=0,t=0,r=0,a=6,s=!1){if(e<=0||t<=0)return{outerPoints:[],innerPoints:null};let o=[],n=-(Math.PI/2);for(let m=0;m<a;m++){let p=new PIXI.Point(Math.cos(n)*(e/2),Math.sin(n)*(t/2));o.push(p),n+=Math.PI*2/a}if(s){let m=[];for(let p=0;p<o.length;p++){let g=o[p],f=o[(p+1)%o.length],v=new PIXI.Point((g.x+f.x)/2,(g.y+f.y)/2);m.push(v)}o.splice(0),o.push(...m)}let l=null;o.forEach(m=>{l?(l.left=Math.min(l.left,m.x),l.right=Math.max(l.right,m.x),l.top=Math.min(l.top,m.y),l.bottom=Math.max(l.bottom,m.y)):l=new BFN.Rectangle(m.x,m.y)});let c=Math.min(e/l.width,t/l.height);o.forEach(m=>{m.x*=c,m.y*=c,m.x+=e/2-l.center*c,m.y+=t/2-l.middle*c});let h=r>0?this.insetPolygon(o,r):null,u=[...o],d=h?r>this.minHitAreaStrokeWidth?[...h]:this.insetPolygon(o,this.minHitAreaStrokeWidth):null;return{outerPoints:o,innerPoints:h,outerPointsHitArea:u,innerPointsHitArea:d,centerPoint:new PIXI.Point(e/2-l.center*c,t/2-l.middle*c)}}insetPolygon(e,t=0){if(!e||e.length<3)return null;if(!t)return[...e];t=Math.abs(t);let r=[],a=null,s=null;for(let h=0;h<e.length;h++){let u=e[h],d=e[(h-1+e.length)%e.length],m=e[(h+1)%e.length],p=Math.atan2(d.y-u.y,d.x-u.x),g=Math.atan2(m.y-u.y,m.x-u.x),f=Math.abs(g-p),v=(p+g)/2;f>Math.PI&&(f=Math.PI*2-f,v+=Math.PI);let T=f/2,x=t/Math.sin(T),B=new PIXI.Point(u.x+Math.cos(v)*x,u.y+Math.sin(v)*x);(a===null||u.y>a)&&(a=u.y,s=B.y),r.push(B)}let o=r[0].y>s,n=[];if(!o){n.push(...this.getIntersectionPoints(r));let h=n.length;for(;--h>-1;){let u=n[h];r.splice(u.index+1,0,u)}}let l=!1,c=o;for(let h=0;h<r.length;h++){let u=r[h],d=r[(h+1)%r.length];!h&&!o&&e.length>3&&(c=Math.cos(Math.atan2(d.y-u.y,d.x-u.x))<-1e-10,c=c||u.x-r[r.length-1].x<0),o?u.invalid=!0:u.intersection?(u.invalid=!1,c=!c):u.invalid=c,l=l||c}if(!window.testShapes){if(l){let h=r.length;for(;--h>-1;)r[h].invalid&&r.splice(h,1)}if(n.length){let h=r.length;for(;--h>0;){let u=r[h],d=r[h-1];u.intersection&&d.intersection&&u.rootPoint===d.rootPoint&&r.splice(h,1)}}}return r}getIntersectionPoints(e){if(!e||e.length<3)return null;let t=[];e.forEach((n,l)=>{let c={ptA:n,ptB:e[(l+1)%e.length],bounds:new BFN.Rectangle(n.x,n.y)};c.bounds.left=Math.min(c.ptA.x,c.ptB.x),c.bounds.right=Math.max(c.ptA.x,c.ptB.x),c.bounds.top=Math.min(c.ptA.y,c.ptB.y),c.bounds.bottom=Math.max(c.ptA.y,c.ptB.y);let h=Math.atan2(c.ptB.y-c.ptA.y,c.ptB.x-c.ptA.x),u=Math.sin(h),d=Math.cos(h);c.slope=u?d?u/d:1/0:0,c.intercept=c.slope===1/0?NaN:c.slope===0?c.ptB.y:c.ptB.y-c.slope*c.ptB.x,t.push(c)});let r=(n,l,c,h)=>{let u=(l.x-n.x)*(h.y-c.y)-(h.x-c.x)*(l.y-n.y);if(u===0)return!1;{let d=((h.y-c.y)*(h.x-n.x)+(c.x-h.x)*(h.y-n.y))/u,m=((n.y-l.y)*(h.x-n.x)+(l.x-n.x)*(h.y-n.y))/u;return 0<d&&d<1&&0<m&&m<1}},a={};for(let n=0;n<t.length;n++){let l=t[n];for(let c=0;c<t.length;c++)if(![n-1,n,(n+1)%t.length].includes(c)){let h=t[c];if(l.slope!==h.slope&&r(l.ptA,l.ptB,h.ptA,h.ptB)){let u=Math.min(n,c)+"_"+Math.max(n,c),d=new PIXI.Point;d.startIndex=Math.min(n,c),d.endIndex=Math.max(n,c),l.slope===1/0&&h.slope===0?(d.x=l.ptA.x,d.y=h.ptA.y):h.slope===1/0&&l.slope===0?(d.x=h.ptA.x,d.y=l.ptA.y):(d.x=(h.intercept-l.intercept)/(l.slope-h.slope),d.y=h.slope*d.x+h.intercept),a.hasOwnProperty(u)?(a[u].x=(a[u].x+d.x)/2,a[u].y=(a[u].y+d.y)/2):a[u]=d}}}let s=(n,l)=>{let c=n.clone();return c.index=l,c.intersection=!0,c.rootPoint=n,c},o=[];for(let n in a){let l=a[n];o.push(s(l,l.startIndex),s(l,l.endIndex))}return o.sort((n,l)=>n.index-l.index),o}getStarPoints(e=0,t=0,r=5,a=.5,s=!1){if(e<=0||t<=0)return{outerPoints:[],innerPoints:null};let o=this.getPolygonPoints(e,t,0,r,s),n=[],l=[];for(let c=0;c<o.outerPoints.length;c++){let h=o.outerPoints[c],u=o.outerPoints[(c+1)%o.outerPoints.length],d=new PIXI.Point((h.x+u.x)/2,(h.y+u.y)/2),m=d.x-o.centerPoint.x,p=d.y-o.centerPoint.y,g=Math.sqrt(m**2+p**2),f=Math.atan2(p,m),v=Math.max(Math.min(2,e/2,t/2),g*(1-a)),T=new PIXI.Point(o.centerPoint.x+Math.cos(f)*v,o.centerPoint.y+Math.sin(f)*v);n.push(h,T);let x=Math.max(Math.min(2,e/2,t/2),g*(1-Math.min(.75,a))),B=new PIXI.Point(o.centerPoint.x+Math.cos(f)*x,o.centerPoint.y+Math.sin(f)*x);l.push(h,B)}return{outerPoints:n,innerPoints:null,outerPointsHitArea:l}}getArrowPoints(e=0,t=0,r="thick",a=.5,s=!1){if(e<=0||t<=0||!["thick","thin"].includes(r))return{outerPoints:[],innerPoints:null};let o=[],n=[];switch(r){case"thick":{let l=t/2/Math.tan(Math.PI/6),c=s?e/2:0,h=Math.max(c,e-l),u=e/2,d=Math.min(u,l);if(o.push(new PIXI.Point(h,0),new PIXI.Point(e,t/2),new PIXI.Point(h,t)),n.push(...o),h>c){let m=(1-a)*(t/2),p=Math.round(t-m*2),g=Math.round((t-p)/2),f=Math.round((t+p)/2),v=Math.min(g,Math.round((t-this.minHitAreaStrokeWidth)/2)),T=Math.max(f,Math.round((t+this.minHitAreaStrokeWidth)/2));if(a<1&&(o.push(new PIXI.Point(e-l,f)),n.push(new PIXI.Point(e-l,T))),o.push(new PIXI.Point(s?d:0,f)),n.push(new PIXI.Point(s?d:0,T)),s){let x=[new PIXI.Point(d,t),new PIXI.Point(0,t/2),new PIXI.Point(d,0)];o.push(...x),n.push(...x)}o.push(new PIXI.Point(s?d:0,g)),n.push(new PIXI.Point(s?d:0,v)),a<1&&(o.push(new PIXI.Point(e-l,g)),n.push(new PIXI.Point(e-l,v)))}else o.push(new PIXI.Point(0,t/2)),n.push(new PIXI.Point(0,t/2));break}case"thin":{let l=c=>{let h=[],u=2,d=t/(1+Math.sin(Math.PI/4)*2)/1,m=a*(d-u)+u;c&&(m=Math.max(m,this.minHitAreaStrokeWidth));let p=t/2,g=Math.sin(Math.PI/4)*m,f=p+g,v=s?e/2:0,T=e/2;if(s){let B=[new PIXI.Point(0,t/2),new PIXI.Point(p,0),new PIXI.Point(f,g)];a===1&&B.pop(),B.forEach(y=>{y.x=Math.min(T,y.x)}),h.push(...B)}h.push(new PIXI.Point(s?Math.min(T,g*2+m/2):0,t/2-m/2));let x=[new PIXI.Point(e-g*2-m/2,t/2-m/2),new PIXI.Point(e-f,g),new PIXI.Point(e-p,0),new PIXI.Point(e,t/2),new PIXI.Point(e-p,t),new PIXI.Point(e-f,t-g),new PIXI.Point(e-g*2-m/2,t/2+m/2)];if(a===1&&(x.pop(),x.shift()),x.forEach(B=>{B.x=Math.max(v,B.x)}),h.push(...x),h.push(new PIXI.Point(s?Math.min(T,g*2+m/2):0,t/2+m/2)),s){let B=[new PIXI.Point(f,t-g),new PIXI.Point(p,t)];a===1&&B.shift(),B.forEach(y=>{y.x=Math.min(T,y.x)}),h.push(...B)}return h.forEach(B=>{B.y=Math.floor(B.y)}),h};o.push(...l(!1)),n.push(...l(!0));break}}return{outerPoints:o,innerPoints:null,outerPointsHitArea:n}}};BFN.SingletonQueue.add(()=>{BFN.BasicShapeManager=new RB});var LB=class{constructor(){this.init()}init(){BeFunky.log("BackgroundRemovalManager Init"),this.artsyServiceURL="https://upload.befunky.com/artsy/",this.initDefaultValues(),this.initPreviewComponents()}initDefaultValues(){this.lastSourceTexture=null,this.lastUploadUrl=null}initPreviewComponents(){this.previewContainer=new PIXI.Container,this.backgroundSprite=new PIXI.Sprite,this.backgroundSprite.pluginName="blend_picture",this.backgroundSprite.fillColor=16711680,this.backgroundSprite.intensity=.5,this.previewContainer.addChild(this.backgroundSprite),this.sourceSprite=new PIXI.Sprite,this.sourceSprite.pluginName="smooth_picture",this.previewContainer.addChild(this.sourceSprite),this.maskSprite=new PIXI.Sprite,this.previewContainer.addChild(this.maskSprite)}getRandomFileName(e,t){function r(n){let l=n?new Date(n):new Date,c=`${l.getMonth()+1}`,h=`${l.getDate()}`,u=l.getFullYear();return c.length<2&&(c=`0${c}`),h.length<2&&(h=`0${h}`),[u,c,h]}function a(n){return(n?new Date(n):new Date).toTimeString().split(" ")[0].split(":")}let s=r(),o=a();return`${e}_${s.join("")}_${o.join("")}_${Math.random().toString(36).substr(2,5)}.${t}`}reset(){this.lastSourceTexture=null,this.lastUploadUrl=null}removeBackground(e,t=()=>{}){if(!e){t();return}if(e&&e.baseTexture&&e.baseTexture.maskTexture){t(e.baseTexture.maskTexture);return}let r=!1;BeFunky.showLoadScreen({onCancel:()=>{r=!0,t()}});let a=o=>{let n=this.artsyServiceURL,l={method:"api/remove-background/",image:o,masking:"0"};BeFunky.Params.isAdmin&&(l.is_beta="1");let c={method:"POST",body:BeFunky.createFormData(l),headers:{"X-CSRF-Token":getCsToken()}};UIMessages.display("isolating_subject",650);let h=BeFunky.trackUserTiming("Background Removal","remove_background","network");BeFunky.request(n,c,({error:u,response:d})=>{if(h(),r)return;if(u||!d||d&&!d.data)return s("Background removal request failed",u||"no_response");let{image:m,success:p}=d.data;if(!p)return s("Background removal failed",d);if(!m)return s("Got invalid response from background removal API",d);let g={textureSize:BFN.maxImageSize,readEXIF:!1};BFN.RequestUtils.getTexture(m,g,({error:f,texture:v})=>{if(!r){if(f)return s("Unable to download image and convert to texture",f);BeFunky.hideLoadScreen(),this.handleBackgroundRemovalImageTexture(e,v,t)}})})};if(this.lastUploadUrl!=null&&e===this.lastSourceTexture)a(this.lastUploadUrl);else if(typeof window.DirectUPL!="undefined"){let o=BFN.Stage.extract.canvasBufferBfn(e);o.canvas.toBlob(n=>{if(o.release(),o=null,r){n=null;return}if(!n)return s("Unable to generate blob background removal",n);UIMessages.display("preparing_image");let l=BeFunky.trackUserTiming("Background Removal","upload_image","network");this.lastSourceTexture=e,window.DirectUPL.upload(c=>{if(n=null,c&&c.url&&c.s3_name){if(l(),this.lastUploadUrl=c.url,r)return;a(c.url)}else s("Background removal image upload failed",c)},{bucket:"background-removal",content_type:"image/jpeg",blob:n,filename:`uploads/${this.getRandomFileName("BGR","jpg")}`})},"image/jpeg",.95)}function s(o,n){BeFunky.throwError(o,n),r||(t(),BeFunky.hideLoadScreen(),UIMessages.display(o,1500))}}isolateSubjectOnPainter(e,t,r=()=>{}){if(!e||!BFN.ImagePainterUndoManager.currentImagePainter)return;if(this.isolateSubjectOnPainterWithHistory()){r();return}let s=BFN.ImagePainterUndoManager.currentImagePainter;this.removeBackground(e,o=>{if(!o){r();return}let n=!!s.altTexture,l=n?s.altTexture:s.texture;s.subjectIsolated=!0,s.updatePrevTexture(),n?t?o.invert(l):l.copyPixels(o):o.convertLumaToAlpha(l,t),s.updateComplete(),s.paintBounds=new PIXI.Rectangle(0,0,l.width,l.height),s.paintApplied=!0,s.dispatchEvent(BFN.ImagePainterEvents.PAINT_UPDATED),s.subjectIsolated=!1,r(),BFN.MainUI.requestRender()})}isolateSubjectOnPainterWithHistory(){if(BFN.ImagePainterUndoManager.currentImagePainter&&BFN.ImagePainterUndoManager.regionVOs.length){let e=BFN.ImagePainterUndoManager.regionVOs[BFN.ImagePainterUndoManager.regionIndex];if(e.redoRegionTexture.subjectIsolated){switch(BFN.ImagePainterUndoManager.direction){case"undo":if(BFN.UndoManager.redoExists)return console.log("SIMPLE REDO, THEN CLEAR REMAINING REGION VOs (SUBJECT ALREADY ISOLATED IN REDO)"),BFN.ImagePainterUndoManager.clearRegionVOs(BFN.ImagePainterUndoManager.regionIndex+1),BFN.UndoManager.redo(),!0;break;case"redo":return console.log("DO NOTHING BUT CLEAR REMAINING REGION VOs (SUBJECT ALREADY ISOLATED)"),BFN.ImagePainterUndoManager.clearRegionVOs(BFN.ImagePainterUndoManager.regionIndex+1),!0}return!1}if(e.undoRegionTexture.subjectIsolated&&BFN.ImagePainterUndoManager.direction==="undo")return console.log("DO NOTHING (SUBJECT ALREADY ISOLATED IN UNDO STATE)"),!0}return!1}getCurrentEditorToolObject(){let e=BFN.PhotoEditorCanvasTools,t=null,r=null;switch(e.currentTool){case e.cutout:r="cutout";break;case e.background:r="background";break;case e.effect:if(t=BFN.EffectManager.effectID&&BFN.EffectManager.parameters&&BFN.EffectManager.parameters.hasOwnProperty("effectName")?BFN.EffectManager.parameters.effectName:BFN.EffectManager.effectID,BFN.EffectManager.parameters!=null&&BFN.EffectManager.parameters.hasOwnProperty("toolID"))try{BFN.UIToolData.hasOwnProperty(BFN.EffectManager.parameters.toolID),r=BFN.EffectManager.parameters.toolID}catch(a){}break;case e.artsy:t="artsy",r=BFN.ImageArtsy.currentToolID?BFN.ImageArtsy.currentToolID:null,BFN.ImageArtsy.currentToolID&&BFN.ArtsyPresetObjects.hasOwnProperty(BFN.ImageArtsy.currentToolID)&&BFN.ArtsyPresetObjects[BFN.ImageArtsy.currentToolID]&&BFN.ArtsyPresetObjects[BFN.ImageArtsy.currentToolID].name&&(t=BFN.ArtsyPresetObjects[BFN.ImageArtsy.currentToolID].name);break;case e.texture:t=BFN.ImageTexture.currentTextureName,r=BFN.ImageTexture.currentTextureID?BFN.ImageTexture.currentTextureID:null;break}return r||t?BFN.UserActionManager.getEditorToolObject(r||t):{}}handleBackgroundRemovalImageTexture(e,t,r){let a=(o,n)=>{let l=this.getCurrentEditorToolObject();l.imageLayer=!!BFN.TransformModel.layerItem,l.imageRejected=n;let c=new BFN.UserActionVO;c.eventID="background_remover_applied",c.eventObject=l,c.track()},s=()=>{let o={},l=480/Math.max(e.width,e.height),c=Math.round(l*e.width),h=Math.round(l*e.height),u=PIXI.RenderTexture.create(c,h);return u.clear(),o.width=c,o.height=h,o.aspectRatio=c/h,this.sourceSprite.texture=e,this.sourceSprite.width=c,this.sourceSprite.height=h,this.sourceSprite.currentScale=l,BFN.Stage.render(this.previewContainer,u),o.source=BFN.TextureUtils.textureToBase64(u),this.backgroundSprite.texture=e.altTexture?e.altTextureInverse?e:e.altTexture:PIXI.Texture.EMPTY,this.sourceSprite.texture=e.altTexture&&e.altTextureInverse?e.altTexture:e,this.maskSprite.texture=t,this.backgroundSprite.width=this.sourceSprite.width=this.maskSprite.width=c,this.backgroundSprite.height=this.sourceSprite.height=this.maskSprite.height=h,this.backgroundSprite.currentScale=this.sourceSprite.currentScale=l,this.sourceSprite.mask=this.maskSprite,BFN.Stage.render(this.previewContainer,u),o.result=BFN.TextureUtils.textureToBase64(u),this.backgroundSprite.texture=PIXI.Texture.EMPTY,this.sourceSprite.texture=PIXI.Texture.EMPTY,this.maskSprite.texture=PIXI.Texture.EMPTY,this.sourceSprite.mask=null,u.destroyGC(!0),u=null,o};if(BFN.BfnService.userIsPlus)r?(e.baseTexture.maskTexture=t,r(t)):(t.destroyGC(!0),t=null),a(!1,!1);else{let o=s(),n=!!e.altTexture;t.destroyGC(!0),r&&r(),n?BeFunky.createAndOpenTeaser("isolate_subject",{featureName:"this_feature",text:"teaser_isolate_subject_body",images:[o.source,o.result],imageAspectRatio:o.aspectRatio,learnMoreLink:`${BeFunky.Params.siteUrl}learn/automatic-background-remover/`}):BeFunky.createAndOpenTeaser("background_removal",{headingText:"teaser_background_remover_title",text:"teaser_background_remover_body",images:[o.source,o.result],imageAspectRatio:o.aspectRatio,learnMoreLink:`${BeFunky.Params.siteUrl}learn/automatic-background-remover/`});let l=this.getCurrentEditorToolObject(),c=["Background Remover"];l.toolType&&c.push(l.toolType),l.toolName&&c.push(l.toolName),l.toolSearchID&&c.push(l.toolSearchID),BFN.UserActionManager.addUpgradeAction(c)}}};BFN.SingletonQueue.add(()=>{BFN.BackgroundRemovalManager=new LB});BFN.EditLayerManagerEvents={};var VB=class extends BFN.EventDispatcher{constructor(){super();this.init()}init(){BeFunky.log("EditLayerManager Init"),this.initDefaultValues()}initDefaultValues(){}editTransformItem(e=null,t=null,r=null){let a=BFN.TransformModel.selectedTransformItem;!(a&&!a.isGoodie&&(a.type==="texture"||a.type==="frame_texture"))||(BFN.ImageEditManager.editingImage&&BFN.ImageEditManager.animatingImage&&BFN.ImageEditManager.animatingImage.setStyles({display:"none"}),BFN.TransformModel.layerItem=a,BFN.TransformItemIsolator.isolateTransformItem(BFN.TransformModel.selectedTransformItem,()=>{let s=()=>{switch(BFN.PhotoEditorMenuModel.removeEventListener(BFN.PhotoEditorMenuModelEvents.CURRENT_IMAGE_THUMB_UPDATED.type,s),BFN.TransformItemIsolator.itemSprite.visible=!0,UIToggler.toggleMainMenu(!0),BFN.updateAppMenuDisplay("edit_layer"),e){case"cutout":UITools.setToolValue("editor_edit","cutout",!0),UITools.applyTool("editor_edit"),UITools.setToolValue("editor_edit","cutout",!1);break}t&&t(),BFN.MainUI.requestRender(),requestAnimationFrame(()=>{BFN.MainUI.requestRender()})};BFN.PhotoEditorMenuModel.addEventListener(BFN.PhotoEditorMenuModelEvents.CURRENT_IMAGE_THUMB_UPDATED.type,s),BFN.PhotoEditorMenuModel.createCurrentImageThumb(a.getPresetItemThumbTexture(),!0)},()=>{let s=()=>{BFN.PhotoEditorMenuModel.removeEventListener(BFN.PhotoEditorMenuModelEvents.CURRENT_IMAGE_THUMB_UPDATED.type,s),BFN.TransformModel.layerItem=null,BFN.updateAppMenuDisplay(),this.updatePanelsAvailable(),r&&r(),BFN.MainUI.requestRender(),requestAnimationFrame(()=>{BFN.MainUI.requestRender()}),BFN.ImageEditManager.editingImage&&BFN.ImageEditManager.animatingImage&&BFN.ImageEditManager.animatingImage.setStyles({display:""})};BFN.PhotoEditorModel.sourceTexture?(BFN.PhotoEditorMenuModel.addEventListener(BFN.PhotoEditorMenuModelEvents.CURRENT_IMAGE_THUMB_UPDATED.type,s),BFN.PhotoEditorMenuModel.createCurrentImageThumb(BFN.PhotoEditorModel.sourceTexture)):s()}),this.updatePanelsAvailable())}editTransformItemAlternateMenu(e,t=null,r=null){if(BFN.TransformItemIsolator.isolatedTransformItem||!e||!BFN.toolViewstates.hasOwnProperty(e))return;let a=BFN.toolViewstates[e],s=`${e}_menu`,o=null;if(BFN.customToolMenus[s]){let c=BFN.customToolMenus[s];o=BeFunky.lit.elem`
            <custom-tool-menu
                .toolId=${c.toolId}
                .menuName=${c.menuName}
                .controlData=${c.controlData}
                .controls=${c.controls}
                .notes=${c.notes}
                .tutorialLink=${c.tutorialLink}
                .tutorialName=${c.tutorialName}
                .clueId=${c.clueId}
                .isWiderThanMobile=${BeFunky.isWiderThanMobile()}
            ></custom-tool-menu>`}if(!o)return;let n=BFN.TransformModel.selectedTransformItem;if(!(n&&!n.isGoodie&&(n.type==="texture"||n.type==="frame_texture")))return;BFN.TransformModel.layerItem=n;let l=document.getElementById("layer_isolator_tool_menu");l.innerHTML="",l.appendChild(o),UIToggler.topNavBar.isEditingLayerInAlternateMenu=!0,BFN.ImageEditManager.editingImage&&BFN.ImageEditManager.animatingImage&&BFN.ImageEditManager.animatingImage.setStyles({display:"none"}),BFN.TransformItemIsolator.isolateTransformItem(BFN.TransformModel.selectedTransformItem,()=>{BFN.PhotoEditorCanvas.canvasTools.altSourceTexture=BFN.TransformItemIsolator.altSourceTexture,BFN.PhotoEditorCanvasModel.viewState=a,BFN.PhotoEditorCanvas.canvasTools.altSourceTexture=null,UITools.applyTool(e),t?t():requestAnimationFrame(()=>{UIToggler.openAlternateMenu("",["layer_isolator_tool_menu"])})},()=>{UIToggler.topNavBar.isEditingLayerInAlternateMenu=!1,this.updatePanelsAvailable(),r&&r(),BFN.ImageEditManager.editingImage&&BFN.ImageEditManager.animatingImage&&BFN.ImageEditManager.animatingImage.setStyles({display:""})},!0),this.updatePanelsAvailable()}updatePanelsAvailable(){UILayers.updateLayersAvailable(),UIHistory.updateHistoryAvailable(),BFN.AlignmentOptionsManager.updateAlignmentAvailable()}};BFN.SingletonQueue.add(()=>{BFN.EditLayerManager=new VB});var UB=class{constructor(){this.init()}init(){BeFunky.log("HiResTextManager Init"),this.initDefaultValues()}initDefaultValues(){this.useHiResText=!0,this.showHiResTextHelpers=!1,this.showHiResTextCanvas=!1,this.multiRealtime=!1,this.enableRetinaScaling=window.bfn_resolution&&window.bfn_resolution>1,this.hiResTextViewportBounds=new BFN.Rectangle,this.hiResTextItemQueue=[],this.processingHiResTextItemQueue=!1,this.processingHiResTextItem=null,this.showHiResTextHelpers&&(this.hiResTextViewport=new PIXI.Graphics),this.updateHighResTextRAF=BeFunky.debounce(this.updateHiResTextImmediately.bind(this),"raf"),this.updateHighResText=BeFunky.debounce(this.updateHighResTextRAF.bind(this),Math.round(BFN.frameInterval*12)),this.processHiResTextItemQueue=BeFunky.debounce(this.processHiResTextItemQueueImmediately.bind(this),0),this.handleAppReadyBind=this.handleAppReady.bind(this),this.handleCanvasUpdatedBind=this.handleCanvasUpdated.bind(this),BFN.AppModel.addEventListener(BFN.AppModelEvents.APP_READY.type,this.handleAppReadyBind)}initEventListeners(){BFN.AppModel.addEventListener(BFN.AppModelEvents.VIEWSTATE_UPDATED.type,this.handleCanvasUpdatedBind),BFN.StageModel.addEventListener(BFN.StageModelEvents.STAGE_DIMENSIONS_UPDATED.type,this.handleCanvasUpdatedBind),BFN.PhotoEditorCanvasModel.addEventListener(BFN.PhotoEditorCanvasModelEvents.VIEWSTATE_UPDATED.type,this.handleCanvasUpdatedBind),BFN.CollageMakerCanvasPhotoGrid.addEventListener(BFN.CollageMakerCanvasPhotoGridEvents.RESIZING.type,this.handleCanvasUpdatedBind),BFN.PhotoEditorCanvasModel.addEventListener(BFN.PhotoEditorCanvasModelEvents.CANVAS_SCALE_UPDATED.type,this.handleCanvasUpdatedBind),BFN.CollageMakerCanvasModel.addEventListener(BFN.CollageMakerCanvasModelEvents.CANVAS_SCALE_UPDATED.type,this.handleCanvasUpdatedBind),BFN.DesignerCanvasModel.addEventListener(BFN.DesignerCanvasModelEvents.CANVAS_SCALE_UPDATED.type,this.handleCanvasUpdatedBind),BFN.PhotoEditorCanvasModel.addEventListener(BFN.PhotoEditorCanvasModelEvents.CANVAS_SCALING_UPDATED.type,this.handleCanvasUpdatedBind),BFN.CollageMakerCanvasModel.addEventListener(BFN.CollageMakerCanvasModelEvents.CANVAS_SCALING_UPDATED.type,this.handleCanvasUpdatedBind),BFN.DesignerCanvasModel.addEventListener(BFN.DesignerCanvasModelEvents.CANVAS_SCALING_UPDATED.type,this.handleCanvasUpdatedBind),BFN.PhotoEditorCanvas.canvasDragger.addEventListener(BFN.DraggerEvents.DRAGGING.type,this.handleCanvasUpdatedBind),BFN.CollageMakerCanvas.canvasDragger.addEventListener(BFN.DraggerEvents.DRAGGING.type,this.handleCanvasUpdatedBind),BFN.DesignerCanvas.canvasDragger.addEventListener(BFN.DraggerEvents.DRAGGING.type,this.handleCanvasUpdatedBind),BFN.PhotoEditorCanvas.canvasDragger.addEventListener(BFN.DraggerEvents.DRAGGING_COMPLETE.type,this.handleCanvasUpdatedBind),BFN.CollageMakerCanvas.canvasDragger.addEventListener(BFN.DraggerEvents.DRAGGING_COMPLETE.type,this.handleCanvasUpdatedBind),BFN.DesignerCanvas.canvasDragger.addEventListener(BFN.DraggerEvents.DRAGGING_COMPLETE.type,this.handleCanvasUpdatedBind),BFN.UndoManager.addEventListener(BFN.UndoManagerEvents.TIMESTAMP_UPDATED.type,this.handleCanvasUpdatedBind)}updateHiResTextViewport(){if(!this.useHiResText)return;let e=BFN.AppModel.sectionValue(BFN.PhotoEditorCanvas,BFN.CollageMakerCanvas,BFN.DesignerCanvas),t=0,r=0;switch(e){case BFN.PhotoEditorCanvas:t=e.canvasImage.imageWidth,r=e.canvasImage.imageHeight;break;case BFN.CollageMakerCanvas:t=e.canvasPhotoGrid.gridWidth,r=e.canvasPhotoGrid.gridHeight;break;case BFN.DesignerCanvas:t=e.canvasWidth,r=e.canvasHeight;break}if(!t||!r)return;let a=this.showHiResTextHelpers?20:0,s=BFN.MainUI.toLocal(new PIXI.Point(0,0),e.canvas),o=BFN.MainUI.toLocal(new PIXI.Point(t,r),e.canvas);this.hiResTextViewportBounds.left=Math.floor(Math.max(a,s.x)),this.hiResTextViewportBounds.top=Math.floor(Math.max(a,s.y)),this.hiResTextViewportBounds.right=Math.ceil(Math.min(BFN.StageModel.stageW-a,o.x)),this.hiResTextViewportBounds.bottom=Math.ceil(Math.min(BFN.StageModel.stageH-a,o.y)),e.transformLayer.children.forEach(n=>{n instanceof BFN.TransformItem&&n.type==="text"&&n.updateHiResTextBounds(this.multiRealtime)}),this.showHiResTextHelpers&&(this.hiResTextViewport.clear(),this.hiResTextViewport.lineStyle(1,16711935),this.hiResTextViewport.drawRect(this.hiResTextViewportBounds.x,this.hiResTextViewportBounds.y,this.hiResTextViewportBounds.width,this.hiResTextViewportBounds.height),this.hiResTextViewport.drawRect(this.hiResTextViewportBounds.x+5,this.hiResTextViewportBounds.y+5,this.hiResTextViewportBounds.width-10,this.hiResTextViewportBounds.height-10),this.hiResTextViewport.drawRect(this.hiResTextViewportBounds.x+10,this.hiResTextViewportBounds.y+10,this.hiResTextViewportBounds.width-20,this.hiResTextViewportBounds.height-20)),this.hiResTextItemQueue.splice(0),this.processingHiResTextItemQueue=!1,this.processingHiResTextItem=null,this.multiRealtime||this.updateHighResText()}updateHiResTextImmediately(){if(!this.useHiResText||BFN.PhotoEditorCanvasModel.viewState!==BFN.PhotoEditorCanvasModelViewStates.VIEWING_CANVAS||BFN.TransformItemIsolator.active||BFN.PhotoGrid.gridIsolator.gridChild)return;let e=BFN.AppModel.sectionValue(BFN.PhotoEditorCanvas,BFN.CollageMakerCanvas,BFN.DesignerCanvas);this.conformHiResTextCanvas(),e.transformLayer.children.forEach(t=>{this.processHiResTextItem(t)})}conformHiResTextCanvas(){if(!this.useHiResText)return;this.hasOwnProperty("hiResTextCanvas")||(this.hiResTextCanvasElement=document.createElement("canvas"),BFN.appContainer.appendChild(this.hiResTextCanvasElement),this.showHiResTextCanvas?this.hiResTextCanvasElement.setStyles({zIndex:9999,pointerEvents:"none",background:"rgba(175,175,255,.4)",position:"absolute",left:0,top:0,display:"block"}):this.hiResTextCanvasElement.setStyles({display:"none"}),this.hiResTextCanvas=new fabric.StaticCanvas(this.hiResTextCanvasElement,{enableRetinaScaling:this.enableRetinaScaling}),this.hiResTextCanvasContext=this.hiResTextCanvas.getContext(),this.hiResTextCanvas.renderOnAddRemove=!1,this.hiResTextCanvas.skipOffscreen=!1);let e=Math.ceil(this.hiResTextViewportBounds.width),t=Math.ceil(this.hiResTextViewportBounds.height),r=this.hiResTextViewportBounds.width*(this.enableRetinaScaling?fabric.devicePixelRatio:1)+"px",a=this.hiResTextViewportBounds.height*(this.enableRetinaScaling?fabric.devicePixelRatio:1)+"px";(this.hiResTextCanvasElement.width!==e||this.hiResTextCanvasElement.style.width!==r)&&(this.hiResTextCanvasElement.width=e,this.hiResTextCanvasElement.setStyles({width:r}),this.hiResTextCanvas.setWidth(this.hiResTextCanvasElement.width)),(this.hiResTextCanvasElement.height!==t||this.hiResTextCanvasElement.style.height!==a)&&(this.hiResTextCanvasElement.height=t,this.hiResTextCanvasElement.setStyles({height:a}),this.hiResTextCanvas.setHeight(this.hiResTextCanvasElement.height))}conformITextToTransformItem(e){if(!this.useHiResText||!e||!e.iText)return;let t=e.iText;t.scaleX=t.scaleY=e.canvasScale*e.textScale*e.scale.x,t.flipX=e.flippedHorizontal,t.flipY=e.flippedVertical,t.rotate(e.rotation*(180/Math.PI));let r=BFN.MainUI.toLocal(new PIXI.Point,e);t.left=r.x-this.hiResTextViewportBounds.x,t.top=r.y-this.hiResTextViewportBounds.y}conformCTextToIText(e){if(!(e&&e.textCurveActive))return null;let{iText:t}=e,{cText:r,curveAmount:a}=e.curvedText;r._applyIText(t,a);let{bounds:s}=r._getCurveCharData(),o=t.left,n=t.top;if(t.flipX||t.flipY){let l=t.angle*(Math.PI/180),c=t.flipX?s.width*t.scaleX:0,h=t.flipY?s.height*t.scaleY:0,u=Math.sqrt(c**2+h**2),d=Math.atan2(h,c);o+=Math.cos(l+d)*u,n+=Math.sin(l+d)*u}return r.opacity=1,r.angle=t.angle*Math.pow(-1,t.flipX+t.flipY),r.left=o,r.top=n,r.scaleX=t.scaleX*Math.pow(-1,t.flipX),r.scaleY=t.scaleY*Math.pow(-1,t.flipY),r}drawHiResTextToTransformItem(e){if(!this.hasOwnProperty("hiResTextCanvas")||!this.useHiResText||!e||!e.iText)return;let t=e.iText,r=this.conformCTextToIText(e);this.hiResTextCanvasContext.lineJoin="round",this.showHiResTextCanvas&&this.clearHiResTextCanvas(),this.hiResTextCanvas.add(r||t),this.hiResTextCanvas.renderAll(),this.hasOwnProperty("hiResCanvasTexture")?this.hiResCanvasTexture.update():(this.hiResCanvasTexture=new PIXI.Texture(new PIXI.BaseTexture.fromCanvas(this.hiResTextCanvasElement)),this.hiResCanvasTexture.baseTexture.mipmap=!1,this.hiResCanvasTexture.setScaleMode(PIXI.SCALE_MODES.LINEAR)),e.hiResTextTexture.copyPixels(this.hiResCanvasTexture,{x:this.hiResTextViewportBounds.x-e.hiResTextRect.globalX,y:this.hiResTextViewportBounds.y-e.hiResTextRect.globalY},!BFN.HiResTextManager.showHiResTextHelpers,void 0,{x:1/(this.enableRetinaScaling?fabric.devicePixelRatio:1),y:1/(this.enableRetinaScaling?fabric.devicePixelRatio:1)}),this.showHiResTextCanvas||this.clearHiResTextCanvas(),BFN.FabricManager.conformITextToTransformItem(e)}clearHiResTextCanvas(){let e=this.hiResTextCanvas.getObjects();for(let t=0;t<e.length;t++)this.hiResTextCanvas.remove(e[t]);this.hiResTextCanvas.clear()}processHiResTextItem(e){!(this.useHiResText&&e&&e instanceof BFN.TransformItem&&e.type==="text"&&e.hiResTextRect&&e.hiResTextRect.width&&e.hiResTextRect.height)||(!this.hiResTextItemQueue.includes(e)&&e!==this.processingHiResTextItem&&this.hiResTextItemQueue.push(e),this.hiResTextItemQueue.length&&!this.processingHiResTextItemQueue&&this.processHiResTextItemQueue())}processHiResTextItemQueueImmediately(){!this.useHiResText||(this.hiResTextItemQueue.length?(this.processingHiResTextItemQueue||(this.processingHiResTextItemQueue=!0,this.processQueueStartTime=performance.now()),this.processingHiResTextItem=this.hiResTextItemQueue.shift(),this.processingHiResTextItem.renderHiResText(()=>{performance.now()-this.processQueueStartTime<1e3/60?this.processHiResTextItemQueueImmediately():requestAnimationFrame(()=>{setTimeout(()=>{this.processQueueStartTime=performance.now(),this.processHiResTextItemQueueImmediately()},0)})})):(this.processingHiResTextItemQueue=!1,this.processingHiResTextItem=null))}handleAppReady(e){BFN.AppModel.removeEventListener(BFN.AppModelEvents.APP_READY.type,this.handleAppReadyBind),this.useHiResText&&(this.initEventListeners(),this.handleCanvasUpdated(e))}handleCanvasUpdated(e){this.updateHiResTextViewport()}};BFN.SingletonQueue.add(()=>{BFN.HiResTextManager=new UB});var GB=class{constructor(){this.init()}init(){BeFunky.log("CurvedTextManager Init"),this.initDefaultValues()}initDefaultValues(){this.defaultCurveAmount=UITools.getToolVO("transform").defaultValues.text_curve_amount||50}renderCurvedText(e,t=null){if(!(e&&e.valid))return null;let{sourceTransformItem:r}=e,{iText:a,textPadding:s,textScale:o}=r,{curveAmount:n}=e;this.generateCurveCanvas(),this.generateCurveText(),BFN.curveText._applyIText(a,n);let{bounds:l}=BFN.curveText._getCurveCharData(),c=l?l.width:BFN.curveText.width,h=l?l.height:BFN.curveText.height,u=1,d=(c+s*2)*o,m=(h+s*2)*o,p=BFN.maxImageSize;(d>p||m>p)&&(u=Math.min(p/d,p/m),d=Math.min(p,Math.round((c+s*2)*o*u)),m=Math.min(p,Math.round((h+s*2)*o*u)));let g=s*o*u,f=o*u;return BFN.curveText.left=a.flipX?d-g:g,BFN.curveText.top=a.flipY?m-g:g,BFN.curveText.scaleX=f*Math.pow(-1,a.flipX),BFN.curveText.scaleY=f*Math.pow(-1,a.flipY),BFN.curveCanvasElement.width=d,BFN.curveCanvasElement.height=m,BFN.curveCanvas.setWidth(d),BFN.curveCanvas.setHeight(m),BFN.curveCanvasElement.setStyles({width:`${d}px`,height:`${m}px`}),BFN.curveCanvasContext.lineJoin="round",BFN.curveCanvas.renderAll(),this.generateCurveCanvasTexture(),t=t||PIXI.RenderTexture.create(d,m),t.resize(d,m),t.copyPixels(BFN.curveCanvasTexture),t.adjustScale=u,t}generateCurvedTextMask(e,t,r=!1){if(!(e&&e.valid&&t))return null;let{sourceTransformItem:a,cText:s}=e,o=s._getCurveCharData().bounds,{iText:n,textPadding:l,textScale:c}=a,{curveAmount:h}=e;this.generateCurveCanvas(),this.generateCurveText(),BFN.curveText._applyIText(n,h,!0);let{bounds:u}=BFN.curveText._getCurveCharData(),d=u?u.width:BFN.curveText.width,m=u?u.height:BFN.curveText.height,p=d+l*2,g=m+l*2,f=a.textMaskMaxSize/Math.max(p,g),v=l*f;p*=f,g*=f,BFN.curveText.left=r&&n.flipX?p-v:v,BFN.curveText.top=r&&n.flipY?g-v:v,BFN.curveText.scaleX=r?f*Math.pow(-1,n.flipX):f,BFN.curveText.scaleY=r?f*Math.pow(-1,n.flipY):f,BFN.curveCanvasElement.width=p,BFN.curveCanvasElement.height=g,BFN.curveCanvas.setWidth(p),BFN.curveCanvas.setHeight(g),BFN.curveCanvasElement.setStyles({width:`${p}px`,height:`${g}px`}),BFN.curveCanvasContext.lineJoin="round",BFN.curveCanvas.renderAll(),this.generateCurveCanvasTexture();let T=(y=0)=>{let F=BFN.Util.getAlphaBounds(BFN.curveCanvasTexture),b=new BFN.Rectangle(F.left-y,F.top-y,F.width+y*2,F.height+y*2),S=a.textMaskMaxSize/Math.max(b.width,b.height);return BFN.curveText.left=BFN.curveText.left*S-b.left*S,BFN.curveText.top=BFN.curveText.top*S-b.top*S,BFN.curveText.scaleX=BFN.curveText.scaleX*S,BFN.curveText.scaleY=BFN.curveText.scaleY*S,p=Math.round(b.width*S),g=Math.round(b.height*S),BFN.curveCanvasElement.width=p,BFN.curveCanvasElement.height=g,BFN.curveCanvas.setWidth(p),BFN.curveCanvas.setHeight(g),BFN.curveCanvasElement.setStyles({width:`${p}px`,height:`${g}px`}),BFN.curveCanvasContext.lineJoin="round",BFN.curveCanvas.renderAll(),BFN.curveCanvasTexture.update(),F},x={x:Math.abs(s.scaleX)*o.width/(Math.abs(BFN.curveText.scaleX)*u.width)*(c/Math.abs(s.scaleX)),y:Math.abs(s.scaleY)*o.height/(Math.abs(BFN.curveText.scaleY)*u.height)*(c/Math.abs(s.scaleY))},B=T(10);requestAnimationFrame(()=>{T(),requestAnimationFrame(()=>{BFN.curveCanvasElement.width=16,BFN.curveCanvasElement.height=16,BFN.curveCanvas.setWidth(BFN.curveCanvasElement.width),BFN.curveCanvas.setHeight(BFN.curveCanvasElement.height),BFN.curveCanvasElement.setStyles({width:`${BFN.curveCanvasElement.width}px`,height:`${BFN.curveCanvasElement.height}px`});let y=PIXI.RenderTexture.create(BFN.curveCanvasTexture.width,BFN.curveCanvasTexture.height);y.fillColor(0),y.copyPixels(BFN.curveCanvasTexture,null,!1);let F={x:Math.abs(s.scaleX)*o.width/(Math.abs(BFN.curveText.scaleX)*u.width)*(c/Math.abs(s.scaleX))*a.scale.x,y:Math.abs(s.scaleY)*o.height/(Math.abs(BFN.curveText.scaleY)*u.height)*(c/Math.abs(s.scaleY))*a.scale.y},b=new BFN.Rectangle(B.left*x.x*a.scale.x,B.top*x.y*a.scale.y,y.width*F.x,y.height*F.y);t({boundsRect:b,maskTexture:y})})})}generateCurveCanvas(){if(!BFN.hasOwnProperty("curveCanvas")){let e=!1;BFN.curveCanvasElement=document.createElement("canvas"),BFN.appContainer.appendChild(BFN.curveCanvasElement),e?(BFN.curveCanvas=new fabric.Canvas(BFN.curveCanvasElement,{enableRetinaScaling:!1,backgroundColor:"white"}),BFN.curveCanvasElement.parentNode.remove(),BFN.curveCanvasContext=BFN.curveCanvas.getContext(),BFN.curveCanvasElement.setStyles({zIndex:1e11,pointerEvents:"none"}),document.body.appendChild(BFN.curveCanvasElement)):(BFN.curveCanvas=new fabric.StaticCanvas(BFN.curveCanvasElement,{enableRetinaScaling:!1}),BFN.curveCanvasContext=BFN.curveCanvas.getContext(),BFN.curveCanvasElement.setStyles({display:"none"}))}}generateCurveText(){if(!BFN.hasOwnProperty("curveText")){let e=!1;BFN.curveText=new fabric.CurvedText("",{left:0,top:0,textAlign:"left",fontFamily:BFN.FabricManager.defaultFontFamily,fontSize:BFN.TransformItemTextBaseFontSize,fill:"rgb(0,0,0)",padding:10}),BFN.curveText.objectCaching=!1,BFN.curveText.paintFirst="stroke",BFN.curveText.noScaleCache=!1,BFN.curveText.strokeWidth=0,BFN.curveText.objectCaching=!1,BFN.curveText.debugCurve=e,BFN.curveCanvas.add(BFN.curveText)}}generateCurveCanvasTexture(){BFN.hasOwnProperty("curveCanvasTexture")?BFN.curveCanvasTexture.update():(BFN.curveCanvasTexture=new PIXI.Texture(new PIXI.BaseTexture.fromCanvas(BFN.curveCanvasElement)),BFN.curveCanvasTexture.baseTexture.mipmap=!1)}};BFN.SingletonQueue.add(()=>{BFN.CurvedTextManager=new GB});var HB=class{constructor(){this.init()}init(){this.initDefaultValues()}initDefaultValues(){this.patchLoading=!1,this.queuedPatchVO=null,this.queuedProjectItemVOs=null,this.patchImageBaseTextures=null,this.textPatchesHaveLoaded=!1,this.addedPatchScaleFactor=BeFunky.isMobile?.8:.5,this.clipboardPatchVO=null,this.clipboardBaseTextures={},this.clipboardThumbSources={}}loadPatch(e,t){if(!e||e&&!(e instanceof BFN.PatchVO)||BFN.TransformItemIsolator.active||BFN.AppModel.viewingEditor&&BFN.PhotoEditorCanvasModel.viewState!==BFN.PhotoEditorCanvasModelViewStates.VIEWING_CANVAS)return;if(this.patchLoading)throw new Error("Attempting to load a patch while another patch is loading");let r=BFN.AppModel.sectionValue(BFN.PhotoEditorCanvas,BFN.CollageMakerCanvas,BFN.DesignerCanvas);if(r.transformTool.transformToolFrame.active)return;delete this.patchAddedCallback,t&&typeof t=="function"&&(this.patchAddedCallback=()=>{t()}),r.transformLayer.deselectItem(),e=this.getPatchVO(this.getPatchObject(e));let a=this.clipboardPatchVO&&this.clipboardPatchVO.id===e.id,{sectionID:s}=BFN.AppModel,o=()=>{let l=Object.keys(e.imageData),c=Object.keys(e.svgData),h=[...l,...c],u=[];if(h.forEach(d=>{l.includes(d)&&u.push(BFN.ProjectService.localAssetExists("image",d)),c.includes(d)&&u.push(BFN.ProjectService.localAssetExists("svg",d))}),Promise.all(u).then(d=>{h.forEach((m,p)=>{d[p]||(l.includes(m)&&BFN.ProjectService.setLocalAsset(s,"image",m,BFN.BlobUtils.base64ToBlob(e.imageData[m])).catch(g=>BeFunky.throwError(g,"PatchLocalImageAssetSaveFail")),c.includes(m)&&BFN.ProjectService.setLocalAsset(s,"svg",m,e.svgData[m]).catch(g=>BeFunky.throwError(g,"PatchLocalSvgAssetSaveFail")))})}),a||this.decompressLabelTextStyles(e),this.queuedPatchVO=e,this.queuedProjectItemVOs=[...e.transformGraphics,...e.transformImages,...e.transformMaskImages,...e.transformLabels],this.patchImageBaseTextures=Object.assign({},this.clipboardBaseTextures),e.showLoadScreen=!0,a){if(this.queuedProjectItemVOs.length<=1)e.showLoadScreen=!1;else if(this.queuedProjectItemVOs.length<=2){let d=[...e.transformImages,...e.transformMaskImages];if(d.length<=2){let m=!0;d.forEach(({imageID:p,maskImageID:g,maskImageMaskID:f})=>{p&&!this.patchImageBaseTextures[p]&&(m=!1),g&&!this.patchImageBaseTextures[g]&&(m=!1),f&&!this.patchImageBaseTextures[f]&&(m=!1)}),e.showLoadScreen=!m}}}e.showLoadScreen&&BeFunky.showLoadScreen({isCancellable:!1}),this.patchLoading=!0,Object.keys(e.imageData).forEach(d=>{let m=BFN.getImageType(d),p;switch(m){case"graphic":p=BFN.GraphicLibraryManager.getMenuImageVO(d);break;case"patterns":p=BFN.CollageMakerPatternManager.getMenuImageVO(d);break;default:p=BFN.ImageLibraryManager.getMenuImageVO(d)}p&&p.hasUsableTexture()&&!this.patchImageBaseTextures.hasOwnProperty(d)&&(this.patchImageBaseTextures[d]=p.imageTexture.baseTexture)}),this.processQueuedProjectItemVOs()},n=l=>{this.patchLoading=!1,BeFunky.hideLoadScreen(),BeFunky.throwError(l,"Unable to Prepare Patch")};if(a)try{o()}catch(l){n(l)}else BFN.ParseBFD.prepareV2(e).then(o).catch(l=>{l!=="cancelled_by_user"&&n(l)})}processQueuedProjectItemVOs(){if(this.queuedPatchVO&&this.queuedProjectItemVOs&&this.queuedProjectItemVOs.length){let e=this.queuedProjectItemVOs.shift();switch(e.type){case"graphic":return this.processGraphic(e,()=>this.processQueuedProjectItemVOs());case"image":return this.processImage(e,()=>this.processQueuedProjectItemVOs());case"mask_image":return this.processMaskImage(e,()=>this.processQueuedProjectItemVOs());default:return this.processQueuedProjectItemVOs()}}else{this.patchLoading=!1,BeFunky.hideLoadScreen(),Object.keys(this.patchImageBaseTextures).forEach(t=>{delete this.patchImageBaseTextures[t]}),this.projectImageBaseTextures=null;let e=this.queuedPatchVO;e.loaded=!0,this.queuedPatchVO=null,this.queuedProjectItemVOs=null,this.addPatch(e)}}processGraphic(e,t){if(e.basicShapeValues)t();else{let{graphicID:r}=e,{svgData:a}=this.queuedPatchVO;if(!r)return BeFunky.logError("Patch graphic missing ID"),t();if(!a.hasOwnProperty(r))return BeFunky.logError("Patch graphic missing SVG data"),t();BFN.TextureUtils.svgStringToTexture(a[r],({error:s,texture:o})=>{s?BeFunky.logError("Unable to convert Patch graphic SVG string to texture"):e.graphicTexture=o,t()},{textureSize:BFN.getImageType(r)==="graphic"?BFN.graphicPlaceholderTextureSize:BFN.maxImageSizeLayer})}}processImage(e,t){let{imageID:r}=e,{imageData:a}=this.queuedPatchVO,s=o=>{e.transformWidth>0&&e.transformHeight>0&&(e.transformScaleX=e.transformWidth/o.width,e.transformScaleY=e.transformHeight/o.height)};if(!r)return BeFunky.logError("Patch image missing ID"),t();if(!a.hasOwnProperty(r)&&!this.patchImageBaseTextures.hasOwnProperty(r))return BeFunky.logError("Patch image missing image data"),t();if(this.patchImageBaseTextures.hasOwnProperty(r))return e.imageTexture=new PIXI.Texture(this.patchImageBaseTextures[r]),BFN.ProjectManager.assignTextureToMenuImageVO(r,e.imageTexture),s(e.imageTexture.baseTexture),t();BFN.TextureUtils.blobOrBase64ToTexture(a[r],({texture:o,error:n})=>{n?BeFunky.logError("Unable to generate texture from patch image data"):(BFN.getImageType(r)==="patterns"&&(o.baseTexture.isPattern=!0),this.patchImageBaseTextures[r]=o.baseTexture,e.imageTexture=o,BFN.ProjectManager.assignTextureToMenuImageVO(r,e.imageTexture),s(e.imageTexture.baseTexture)),t()})}processMaskImage(e,t){let{maskImageID:r}=e,{svgData:a,imageData:s}=this.queuedPatchVO;if(!r)return BeFunky.logError("Patch mask image missing ID"),t();if(!s.hasOwnProperty(r)&&!this.patchImageBaseTextures.hasOwnProperty(r))return BeFunky.logError("Patch mask image missing image data"),t();let o=()=>{if(!e.maskImageMaskID)return t();if(a.hasOwnProperty(e.maskImageMaskID))BFN.SVGManager.getSVGShape(a[e.maskImageMaskID],n=>{e.maskImageMaskTexture=BFN.SVGManager.getTexture(n,t)},e.maskImageMaskID,!0);else{if(this.patchImageBaseTextures.hasOwnProperty(e.maskImageMaskID))return e.maskImageMaskTexture=new PIXI.Texture(this.patchImageBaseTextures[e.maskImageMaskID]),t();if(s.hasOwnProperty(e.maskImageMaskID))BFN.TextureUtils.blobOrBase64ToTexture(s[e.maskImageMaskID],({error:n,texture:l})=>n?(BeFunky.logError("Unable to generate texture from patch image data"),t()):(e.maskImageMaskTexture=l,t()));else return t()}};if(this.patchImageBaseTextures.hasOwnProperty(r))return e.maskImageTexture=new PIXI.Texture(this.patchImageBaseTextures[r]),BFN.ProjectManager.assignTextureToMenuImageVO(r,e.maskImageTexture),o();BFN.TextureUtils.blobOrBase64ToTexture(s[r],({error:n,texture:l})=>n?(BeFunky.logError("Unable to generate texture from patch image data"),t()):(BFN.getImageType(r)==="patterns"&&(l.baseTexture.isPattern=!0),this.patchImageBaseTextures[r]=l.baseTexture,e.maskImageTexture=l,BFN.ProjectManager.assignTextureToMenuImageVO(r,e.maskImageTexture),o()))}convertImagesToMaskImages(e){let t=e.transformImages.length;for(;--t>-1;){let r=e.transformImages[t];if(!r.isGoodie&&r.hasOwnProperty("imageTexture")){e.transformImages.splice(t,1),r.maskImageTexture=r.imageTexture,delete r.imageTexture,r.type="mask_image",r.maskImageID=r.imageID,r.imageID=null;let{baseTexture:a}=r.maskImageTexture;r.maskImageFrameWidth=r.transformScaleX*a.width,r.maskImageFrameHeight=r.transformScaleY*a.height;let s=Math.max(r.maskImageFrameWidth/a.width,r.maskImageFrameHeight/a.height),o=a.width*s,n=a.height*s;r.maskImageTextureScale={x:r.maskImageFrameWidth/o,y:r.maskImageFrameHeight/n},r.transformScaleX=1,r.transformScaleY=1,e.transformMaskImages.push(r)}}}addPatch(e){if(!(e&&e instanceof BFN.PatchVO&&e.loaded))return;if(this.patchLoading)throw new Error("Attempting to load a patch while another patch is loading");(!e.hasOwnProperty("showLoadScreen")||e.showLoadScreen)&&(BeFunky.showLoadScreen({isCancellable:!1}),delete e.showLoadScreen),this.patchLoading=!0;let t=BFN.AppModel.sectionValue(BFN.PhotoEditorModel,BFN.CollageMakerModel,BFN.DesignerModel),r=BFN.AppModel.sectionValue(BFN.PhotoEditorCanvasModel,BFN.CollageMakerCanvasModel,BFN.DesignerCanvasModel),a=BFN.AppModel.sectionValue(BFN.PhotoEditorCanvas,BFN.CollageMakerCanvas,BFN.DesignerCanvas);if(t&&r&&a){BFN.ProjectManager.transformItemsPending=!0,BFN.TransformModel.selectItemOnAdd=!1;let s=this.clipboardPatchVO&&this.clipboardPatchVO.id===e.id,o=BFN.TransformLayerManager.transformItems.length,n=[...e.transformGraphics,...e.transformImages,...e.transformMaskImages,...e.transformLabels].length,l=Math.min(a.transformLayer.frameWidth/e.width,a.transformLayer.frameHeight/e.height)*this.addedPatchScaleFactor,c=(f,v=[])=>{s&&this.clipboardThumbSources.hasOwnProperty(f.itemID)&&(f.thumbImageSRC=this.clipboardThumbSources[f.itemID]),f.itemID=`item_${BeFunky.randomString(10)}`,f.layerNum=-1,f.transformZIndex+=o;let T=f.transformX-e.width/2,x=f.transformY-e.height/2,B=Math.sqrt(T**2+x**2),y=Math.atan2(x,T);f.transformX=Math.cos(y)*(B*l),f.transformY=Math.sin(y)*(B*l),v.forEach(F=>{if(f.hasOwnProperty(F))switch(typeof f[F]){case"number":f[F]*=l;break;case"object":{let b=f[F];for(let S in b)typeof b[S]=="number"&&(b[S]*=l);break}}})},h=s?`paste_${n>1?"items":"item"}`:"add_patch",u=h+BeFunky.randomString(10);BFN.TransformStateModel.startBulkTransition(u);let d=[],m=(f,v)=>{BFN.ProjectManager.transferProperties(f,v),BFN.TransformModel.addedTransformItem.applyTransformItemState(v,!1),d.push({zIndex:v.zIndex,item:BFN.TransformModel.addedTransformItem,state:v})};e.transformGraphics.filter(f=>f.graphicTexture||f.basicShapeValues).forEach(f=>{c(f,["transformWidth","transformHeight","transformScaleX","transformScaleY"]),f.graphicTexture?r.addedItem={type:"texture",texture:f.graphicTexture,isGoodie:!0,projectItemVO:f,graphicStyle:f.graphicStyle}:f.basicShapeValues&&(r.addedItem={type:"texture",texture:null,isGoodie:!0,projectItemVO:f,basicShapeVO:new BFN.BasicShapeVO(f.basicShapeValues.type,f.basicShapeValues)});let v=new BFN.TransformItemStateVO;v.parent=a.transformLayer,f.graphicTexture&&(v.imageTexture=f.graphicTexture,delete f.graphicTexture),m(f,v)}),this.convertImagesToMaskImages(e),e.transformImages.filter(f=>f.imageTexture).forEach(f=>{c(f,["transformWidth","transformHeight","transformScaleX","transformScaleY"]);let v={type:"texture",texture:f.imageTexture,projectItemVO:f,graphicStyle:f.graphicStyle};f.isGoodie&&(v.isGoodie=!0),r.addedItem=v;let T=new BFN.TransformItemStateVO;T.parent=a.transformLayer,f.imageTexture&&(T.imageTexture=f.imageTexture,delete f.imageTexture),m(f,T)}),e.transformMaskImages.filter(f=>f.maskImageTexture).forEach(f=>{c(f,["transformWidth","transformHeight","maskImageFrameWidth","maskImageFrameHeight"]);let v=null;f.maskImageMaskTexture?v=f.maskImageMaskTexture:f.basicShapeValues&&(v=PIXI.RenderTexture.create(32,32));let T={type:"frame_texture",texture:f.maskImageTexture,maskTexture:v,projectItemVO:f};f.graphicStyle&&(T.graphicStyle=f.graphicStyle),f.basicShapeValues&&(T.basicShapeVO=new BFN.BasicShapeVO(f.basicShapeValues.type,f.basicShapeValues)),r.addedItem=T;let x=new BFN.TransformItemStateVO;x.parent=a.transformLayer,f.maskImageTexture&&(x.imageTexture=f.maskImageTexture,delete f.maskImageTexture),f.maskImageMaskTexture&&delete f.maskImageMaskTexture,m(f,x)}),e.transformLabels.length&&(BFN.UndoManager.updating=!0,e.transformLabels.forEach(f=>{c(f,["transformWidth","transformHeight","labelTextItemScale"]),r.addedItem={type:"text",projectItemVO:f};let v=new BFN.TransformItemStateVO;v.parent=a.transformLayer,m(f,v)}),BFN.MainUI.rendering=!0,BFN.MainUI.renderCanvas(),BFN.MainUI.rendering=!1,BFN.UndoManager.updating=!1),BFN.TransformModel.selectedTransformItem&&BFN.TransformModel.selectedTransformItem.transformLayer&&BFN.TransformModel.selectedTransformItem.transformLayer.deselectItem(),BFN.MainUI.renderCanvas(),d.forEach(({item:f})=>{f.ignoreAccurateBounds=!0,f.visible=!1}),BFN.MainUI.renderCanvas();let p=!1,g=()=>{if(!BFN.updatingShapeQueue.length&&!BFN.updatingTextQueue.length&&(p||(p=!0,d.length&&(d.sort((f,v)=>f.zIndex-v.zIndex),d.forEach(({item:f,state:v,zIndex:T},x)=>{let B=x+o;f.parent.setChildIndex(f,B),setTimeout(()=>{f.updateShapeTexture()},x),v.zIndex=B,f.ignoreAccurateBounds=!1,f.updateAccurateBounds(),f.setTransitionStartState(),f.setTransitionEndState(),f.transitionVO.startState.parent=null,f.transitionVO=null}))),!BFN.accurateBoundsQueue.length)){let f=new BFN.TransformItemGroupVO;f.id=`patch_${BeFunky.randomString(10)}`,f.name=e.name;let v=[];d.forEach(({item:x},B)=>{x.visible=!0,x.preloadThumbnail(B*5+50),x.refreshItemName(),x.type==="text"&&!x.iText.wordBreaksEnabled&&(x.iText.wordBreaksEnabled=!0),f.itemIDs.push(x.itemID),v.push(x)}),v.length>1?(s||BFN.GroupManager.addGroup(null,f,!0),BFN.GroupManager.selectItems(v)):v.length===1&&(s||(v[0].layerName=e.name),v[0].selectItem()),BFN.TransformLayerManager.updateTransformItems(),BFN.TransformStateModel.stopBulkTransition();let T=new BFN.TransformItemTransitionVO;T.id=h,T.batchIDPlaceholder=u,BFN.TransformStateModel.addTransition(T),BFN.ProjectManager.transformItemsPending=!1,BFN.TransformModel.selectItemOnAdd=!0,this.patchLoading=!1,BeFunky.hideLoadScreen(),this.patchAddedCallback&&(this.patchAddedCallback(),delete this.patchAddedCallback),BFN.MainUI.requestRender(),BFN.ProjectManager.requestLocalSave();return}setTimeout(g,0)};setTimeout(g,0)}else BeFunky.throwError("Unable to add patch"),this.patchLoading=!1}createPatchFromSelection(e="BeFunkyPatch",t="canvas",r=[],a=null){if(!BFN.TransformModel.selectedTransformItem||!["computer","befunky_admin","canvas","menu","clipboard"].includes(t))return;r=r instanceof Array?r:[];let s=BFN.TransformModel.selectedTransformItem,{transformLayer:o}=s,l=s===BFN.TransformItemGroup?[...BFN.TransformItemGroup._selectedItems].sort((y,F)=>o.children.indexOf(y)-o.children.indexOf(F)):[s];if(!l.length)return;(t!=="clipboard"||t==="clipboard"&&l.length>2)&&BeFunky.showLoadScreen({isCancellable:!1});let c=()=>{a&&a(),BeFunky.hideLoadScreen()};t==="clipboard"&&(this.clearClipboardBaseTextures(),this.clearClipboardThumbSources());let h=new BFN.PatchVO;h.name=e;let u=[],d=[],m=!1,p={left:null,right:null,top:null,bottom:null},g={left:null,right:null,top:null,bottom:null},f=[];for(let y=0;y<l.length;y++){let F=l[y],{projectItemVO:b}=F,S=F.localPatchPolygon,I=F.localTextPolygon||S;if(!b||!S||!I)continue;let _=null;switch(t==="clipboard"&&F.thumbImage&&F.thumbImage.src&&this.addClipboardThumbSource(b.itemID,F.thumbImage.src),b.type){case"graphic":b.graphicID?(d.includes(b.graphicID)||d.push(b.graphicID),_=h.transformGraphics):b.basicShapeValues&&(_=h.transformGraphics);break;case"image":b.imageID&&(u.includes(b.imageID)||u.push(b.imageID),this.addClipboardBaseTexture(b.imageID,F.itemContent.texture.baseTexture),_=h.transformImages);break;case"mask_image":if(b.maskImageID&&(u.includes(b.maskImageID)||u.push(b.maskImageID),this.addClipboardBaseTexture(b.maskImageID,F.itemContent.texture.baseTexture),_=h.transformMaskImages),b.maskImageMaskID){let E=F.itemContentMask&&!F.isShape,D=E?u:d;D.includes(b.maskImageMaskID)||D.push(b.maskImageMaskID),E&&this.addClipboardBaseTexture(b.maskImageMaskID,F.itemContentMask.texture.baseTexture)}break;case"label":_=h.transformLabels;break}if(_){let E=(w,N)=>{w.forEach(M=>{N.left=N.left===null?M.x:Math.min(N.left,M.x),N.right=N.right===null?M.x:Math.max(N.right,M.x),N.top=N.top===null?M.y:Math.min(N.top,M.y),N.bottom=N.bottom===null?M.y:Math.max(N.bottom,M.y)})};E(S,p),E(I,g),m||(m=!0);let D=b.clone();_.push(D),f.push(D)}}if(!m)return;h.width=p.right-p.left,h.height=p.bottom-p.top,f.forEach((y,F)=>{y.layerNum=-1,y.transformZIndex=F,y.transformX-=p.left,y.transformY-=p.top,y.transformX<.001&&(y.transformX=0),y.transformY<.001&&(y.transformY=0)}),t!=="clipboard"&&this.compressLabelTextStyles(h);let v=[...u,...d];if(v.length){let y=[...u.map(F=>T(F)),...d.map(F=>x(F))];Promise.all(y).then(F=>{F.forEach((b,S)=>{if(b instanceof PIXI.BaseTexture)return;let I=v[S];u.includes(I)&&(h.imageData[I]=b),d.includes(I)&&(h.svgData[I]=b)}),B()}).catch(F=>{BeFunky.logError("Patch Asset Retrieval Failed",F)})}else B();function T(y){return t==="clipboard"&&BFN.PatchManager.clipboardBaseTextures.hasOwnProperty(y)?BFN.PatchManager.clipboardBaseTextures[y]:BFN.ProjectService.getLocalAsset("image",y).then(F=>BFN.BlobUtils.downsizeImageBlob(F).catch(b=>(b!=="skipped_small_image"&&BeFunky.logError("Unable to Downsize Patch Image Blob",b),F))).then(F=>BFN.BlobUtils.blobToBase64(F))}function x(y){return BFN.ProjectService.getLocalAsset("svg",y)}function B(){let y,F=null,b=null;if(t!=="clipboard"){let I=o.x,_=o.y,E=o.parent;o.x=-g.left,o.y=-g.top,E.removeChild(o),o.children.forEach(J=>{J.hasOwnProperty("renderable")&&(J.wasRenderable=J.renderable,J.renderable=l.includes(J))}),o.toggleHiResTextDisplay(!1),o.toggleItemScaleSmoothing(!1),o.setItemScaleMode(PIXI.SCALE_MODES.NEAREST,["text"]);let D=Math.round(g.right-g.left),w=Math.round(g.bottom-g.top);y=PIXI.RenderTexture.create(D,w),BFN.Stage.render(o,y,!1),o.children.forEach(J=>{J.hasOwnProperty("renderable")&&(J.renderable=J.wasRenderable,delete J.wasRenderable)}),o.toggleHiResTextDisplay(!0),o.toggleItemScaleSmoothing(!0),o.setItemScaleMode(PIXI.SCALE_MODES.LINEAR,["text"]),o.x=I,o.y=_,E.addChild(o);let N=BFN.Util.getAlphaBounds(y),M=PIXI.RenderTexture.create(N.width,N.height);M.copyPixels(y,{x:-N.minX,y:-N.minY}),y.resize(M.width,M.height),y.copyPixels(M),M.destroyGC(!0);let[z,W]=BFN.TextureUtils.getScaledDimensions(y,{maxWidth:300,maxHeight:200}),j=BFN.Util.getThumbTexture(y,Math.max(z,W));if(h.thumbBase64=BFN.TextureUtils.textureToBase64(j,{isTransparent:!0,quality:.9}),j.destroy(!0),t==="befunky_admin"){let J=y.width/y.height,ie=J>=1?J:1/J,re=Math.round(720*ie),[he,ne]=BFN.TextureUtils.getScaledDimensions(y,{maxWidth:re,maxHeight:re});F=BFN.Util.getThumbTexture(y,Math.max(he,ne)),BFN.TextureUtils.textureToBlob(F,{isTransparent:!0,quality:1}).catch(le=>BeFunky.logError(le)).then(le=>{F.destroyGC(!0),b=le,S()})}else S()}else S();function S(){switch(y&&y.destroy(!0),t){case"clipboard":{BFN.PatchManager.clipboardPatchVO=h,c();break}case"menu":{BFN.PatchManager.addPatchToMenu(h.id,h.thumbBase64,h),c();break}case"canvas":{BFN.PatchManager.loadPatch(BFN.PatchManager.getPatchVO(BFN.PatchManager.getPatchObject(h)),c);break}case"computer":{if(!BeFunky.savePatchToComputer)return BeFunky.acknowledge("Please log in to a BeFunky account w/ admin permissions and refresh this page"),c();BeFunky.savePatchToComputer(h,c);break}case"befunky_admin":{if(!BeFunky.addPatchForAllUsers)return BeFunky.acknowledge("Please log in to a BeFunky account w/ admin permissions and refresh this page"),c();BeFunky.addPatchForAllUsers(h,{tagIds:r,previewBlob:b}).catch(I=>{BeFunky.logError(I),BeFunky.acknowledge(`Failed to save patch: ${BeFunky.failureReason(I)}`)}).then(c);break}}}}}loadTextPatches(){this.textPatchesHaveLoaded||BFN.PatchService.getTextPatches().then(e=>{this.textPatchesHaveLoaded=!0,BFN.secondaryMenu.textPatches=[],e.forEach(({tmp:t,version:r})=>{this.addPatchToMenu(t,`${BFN.patchPreviewImageUrl}${t}_preview.png`,r||0)})}).catch(e=>{e!=="request_failed"&&BeFunky.reportWarning(`Failed to fetch text patches: ${e}`),BFN.secondaryMenu.textPatches=[]})}addPatchToMenu(e,t,r=0,a=null){!e||typeof e!="string"||!t||(this.patchMenuItems||(this.patchMenuItems=[]),!this.patchMenuItems.some(s=>s.patchID===e)&&(this.patchMenuItems.push({patchID:e,patchThumb:t,patchVO:a,version:r}),BFN.secondaryMenu.textPatches=[...this.patchMenuItems]))}reportBreadcrumb(e){if(!BFN.TransformModel.selectedTransformItem)return;let t=BFN.SentryManager.getDisplayObjectInfo(BFN.TransformModel.selectedTransformItem);BFN.SentryManager.reportBreadcrumb(t,e,"clipboard_interaction")}copySelection(){!BFN.TransformModel.selectedTransformItem||BFN.PatchManager.createPatchFromSelection("clipboard_patch","clipboard",null,()=>{this.reportBreadcrumb("Selection Copied"),BFN.ClipboardManager.addPatchToClipboard(this.clipboardPatchVO)})}cutSelection(){!BFN.TransformModel.selectedTransformItem||BFN.PatchManager.createPatchFromSelection("clipboard_patch","clipboard",null,()=>{this.reportBreadcrumb("Selection Cut"),BFN.TransformModel.removeSelection(),BFN.ClipboardManager.addPatchToClipboard(this.clipboardPatchVO)})}pasteSelection(){this.clipboardPatchVO&&this.loadPatch(this.clipboardPatchVO,()=>{this.reportBreadcrumb("Selection Pasted")})}clearClipboardBaseTextures(){let e=BFN.GlobalHistoryModel.getUsedBaseTextures(null,!1);for(let t in this.clipboardBaseTextures){let r=this.clipboardBaseTextures[t];e.includes(r)||r.destroy(),delete this.clipboardBaseTextures[t]}}addClipboardBaseTexture(e,t){this.clipboardBaseTextures.hasOwnProperty(e)||(this.clipboardBaseTextures[e]=t)}clearClipboardThumbSources(){for(let e in this.clipboardThumbSources)delete this.clipboardThumbSources[e]}addClipboardThumbSource(e,t){this.clipboardThumbSources.hasOwnProperty(e)||(this.clipboardThumbSources[e]=t)}getPatchVO(e){let t=new BFN.PatchVO;return Object.assign(t,e),t.transformGraphics=[],t.transformImages=[],t.transformMaskImages=[],t.transformLabels=[],e.transformGraphics.forEach(r=>t.transformGraphics.push(BFN.ProjectManager.getProjectItemVO(r))),e.transformImages.forEach(r=>t.transformImages.push(BFN.ProjectManager.getProjectItemVO(r))),e.transformMaskImages.forEach(r=>t.transformMaskImages.push(BFN.ProjectManager.getProjectItemVO(r))),e.transformLabels.forEach(r=>t.transformLabels.push(BFN.ProjectManager.getProjectItemVO(r))),t.svgData={},Object.entries(e.svgData).forEach(([r,a])=>{t.svgData[r]=a.startsWith("<")?a:atob(a)}),t}getPatchObject(e){let t={};return Object.assign(t,e),t.transformGraphics=[],t.transformImages=[],t.transformMaskImages=[],t.transformLabels=[],e.transformGraphics.forEach(r=>t.transformGraphics.push(BFN.ProjectManager.getProjectItemObject(r))),e.transformImages.forEach(r=>t.transformImages.push(BFN.ProjectManager.getProjectItemObject(r))),e.transformMaskImages.forEach(r=>t.transformMaskImages.push(BFN.ProjectManager.getProjectItemObject(r))),e.transformLabels.forEach(r=>t.transformLabels.push(BFN.ProjectManager.getProjectItemObject(r))),t}compressLabelTextStyles(e){e.transformLabels&&!e.transformLabels.length||(e.transformLabels=JSON.parse(JSON.stringify(e.transformLabels)),e.transformLabels.forEach(t=>{t.labelTextStyles.compressedStyles=BFN.ParseBFD.compressCharacterStyles(t.labelTextStyles.styles),delete t.labelTextStyles.styles}))}decompressLabelTextStyles(e){e.transformLabels&&!e.transformLabels.length||e.transformLabels.forEach(t=>{t.labelTextStyles.compressedStyles&&(t.labelTextStyles.styles=BFN.ParseBFD.decompressCharacterStyles(t.labelTextStyles.compressedStyles),delete t.labelTextStyles.compressedStyles)})}trackPatch({name:e,id:t}){let r=new BFN.UserActionVO;r.eventID="patch_added",r.eventObject={patchOrigin:"Text Menu",patchName:e,patchID:t},r.actionSection=BFN.AppModel.sectionID,r.actionTimestamp=Date.now(),r.register()}};BFN.SingletonQueue.add(()=>{BFN.PatchManager=new HB});var XB=class{constructor(){this.init()}init(){BeFunky.log("DirectionalBlurManager Init"),this.initDefaultValues()}initDefaultValues(){}blurTexture(e,{maxSpread:t,amount:r=0,alphaChoke:a=0,blendAlpha:s=!0,biDirectional:o=!0,iterations:n=5}){this.directionalBlurFilter||(this.directionalBlurFilter=new BFN.filters.DirectionalBlurFilter,this.directionalBlurSprite=new PIXI.Sprite,this.directionalBlurSprite.filters=[this.directionalBlurFilter],this.directionalBlurTargetTexture=PIXI.RenderTexture.create(32,32)),this.directionalBlurFilter.setDimensions(e.width,e.height,t),this.directionalBlurFilter.amount=r,this.directionalBlurFilter.alphaChoke=a,this.directionalBlurFilter.blendAlpha=s,this.directionalBlurFilter.biDirectional=o,this.directionalBlurFilter.iterations=n,this.directionalBlurSprite.texture=e,this.directionalBlurTargetTexture.resize(e.width,e.height),BFN.Stage.render(this.directionalBlurSprite,this.directionalBlurTargetTexture),this.directionalBlurSprite.texture=PIXI.Texture.EMPTY,e.copyPixels(this.directionalBlurTargetTexture),this.directionalBlurTargetTexture.resize(32,32)}};BFN.SingletonQueue.add(()=>{BFN.DirectionalBlurManager=new XB});var zB=class{constructor(){this.init()}init(){this.initDefaultValues()}initDefaultValues(){this.copiedPatchExpiration=0,this.previouslyPastedFiles=[]}addPatchToClipboard(e){let t=Date.now()+1e3*60,r=`[BeFunky ${e.id}]`;e.transformLabels.length&&(r=e.transformLabels.reduce((a,s)=>`${a||r}
${s.labelText}`,"")),this.addToClipboard(r).catch(a=>{BeFunky.logError("Failed to add patch to clipboard:",a),this.copiedPatchExpiration=t})}addToClipboard(e){return this.copiedPatchExpiration=0,!navigator.clipboard||!navigator.clipboard.writeText?Promise.reject("not_available"):navigator.clipboard.writeText(e)}pasteImagesFromClipboard(e){if(e=Array.from(e).filter(t=>/^image\/+/.test(t.type)),!!e.length){if(BFN.AppModel.viewingEditor&&!BFN.PhotoEditorModel.currentTexture){let t={files:e.slice(0,1),createMenuImageVO:!1};BFN.MultipleFileUploader.upload(({file:r})=>BFN.PhotoEditorModel.onEditorImageUpload({file:r}),t);return}if(BFN.AppModel.viewingEditor&&e.length===1){BeFunky.confirm("paste_as_layer_or_background",{confirmText:"background_image",onConfirm:()=>{let t={files:e,createMenuImageVO:!1};BFN.PhotoEditorModel.confirmEditorLoadImage(()=>{BFN.MultipleFileUploader.upload(({file:r})=>BFN.PhotoEditorModel.onEditorImageUpload({file:r}),t)})},cancelText:"layer",onCancel:()=>{this.addImagesToCanvasAndImageManager(e,{hasTexture:!0,forceLayer:!0})}});return}if(BFN.AppModel.viewingCollage&&!BFN.CollageMakerCanvasPhotoGridModel.freeform){BeFunky.confirm("paste_as_layer_or_grid_cell",{confirmText:"grid_cells",onConfirm:()=>{this.addImagesToCanvasAndImageManager(e,{hasTexture:!0})},cancelText:"layers",onCancel:()=>{this.addImagesToCanvasAndImageManager(e,{hasTexture:!0,forceLayer:!0})}});return}this.addImagesToCanvasAndImageManager(e,{hasTexture:!0})}}addImagesToCanvasAndImageManager(e,t){let r=["name","size","lastModified","type"],a=[];if(e.forEach(n=>{let l=this.previouslyPastedFiles.find(c=>r.every(h=>c[h]===n[h]));if(l){let c=BFN.ImageLibraryManager.selectedMenuImageVOs.find(({id:h,imageTexture:u})=>h===l.menuImageVoId&&u&&u.valid);if(c){o(c),BFN.ImageLibraryManager.updateImage(c.id,{},!0);return}}a.push(n)}),!a.length)return;let s={files:Array.from(e),keepImageTexture:!0};BFN.ImageLibraryManager.uploadImages(({menuImageVO:n,file:l})=>{n&&(o(n),this.previouslyPastedFiles.push(It({menuImageVoId:n.id},r.reduce((c,h)=>Si(It({},c),{[h]:l[h]}),{}))))},s);function o(n){if(!BFN.AppModel.viewingCollage||t.forceLayer)return BFN.ImageLibraryManager.addImageToCanvas(n,t);BeFunky.waitUntil({condition:()=>!BFN.PhotoGrid.targetChild,onSuccess:()=>BFN.ImageLibraryManager.addImageToCanvas(n,t),onTimeout:()=>BFN.ImageLibraryManager.addImageToCanvas(n,t),interval:200,maxAttempts:15})}}pasteTextFromClipboard(e){if(BFN.AppModel.viewingEditor&&!BFN.PhotoEditorModel.currentTexture)return;let t=BFN.AppModel.sectionValue(BFN.PhotoEditorCanvasModel,BFN.CollageMakerCanvasModel,BFN.DesignerCanvasModel);t.addedItem={type:"text",text:e}}pastePatchFromClipboard(){BFN.AppModel.viewingEditor&&!BFN.PhotoEditorModel.currentTexture||BFN.PatchManager.pasteSelection()}handlePaste(e){if(e.clipboardData.files.length)return this.pasteImagesFromClipboard(e.clipboardData.files);let t=e.clipboardData.getData("text");if(!!t){if(BFN.PatchManager.clipboardPatchVO){let r=t.match(/^\[BeFunky (patch_[a-z0-9]+)/);if(r&&r[1]===BFN.PatchManager.clipboardPatchVO.id)return this.pastePatchFromClipboard()}this.pasteTextFromClipboard(t)}}};BFN.SingletonQueue.add(()=>{BFN.ClipboardManager=new zB});var WB=class extends BFN.EventDispatcher{constructor(){super();this.init()}init(){BeFunky.log("SmartFrameManager Init"),this.initDefaultValues()}initDefaultValues(){this.frameShapes={},this.frameTexture=null}getFrameTexture(e,t){let{category:r,name:a,dstW:s,dstH:o,dstScale:n,dstPadding:l,srcW:c,srcH:h,srcGrid:u,updating:d}=e;(p=>{if(this.frameShapes[r]||(this.frameShapes[r]={}),this.frameShapes[r][a])return p(this.frameShapes[r][a]);let g=`${BeFunky.Params.globalImagesPath}app/frames/_svg/${r}/${a}.svg`,f=v=>{BeFunky.throwError(v,g),p(null)};BFN.RequestUtils.getText(g,({text:v,error:T})=>{if(T)return f("Failed to Fetch Frame SVG");let x=v;fabric.loadSVGFromString(x,(B,y)=>{let F=fabric.util.groupSVGElements(B,y);F.objectCaching=!0,F.baseScaleX=F.scaleX=F.scaleX*(c/F.width),F.baseScaleY=F.scaleY=F.scaleY*(h/F.height),F.set({left:0,top:0}).setCoords(),F.baseBoundingRect=F.getBoundingRect(),F.frameSourceData={category:e.category,name:e.name,srcW:e.srcW,srcH:e.srcH,fixedW:0,fixedH:0};let b=u.split("_"),S=b[0].split("-"),I=0;for(let D=0;D<S.length;D++)S[D]={isFixed:S[D][0]==="f",size:parseInt(S[D].substr(1))},I+=S[D].size,F.frameSourceData.fixedW+=S[D].isFixed?S[D].size:0;F.frameSourceData.regionsX=S,I!==c&&BeFunky.throwError("Smart Frame Cell Widths Do Not Add Up To Source Width",c,u);let _=b[1].split("-"),E=0;for(let D=0;D<_.length;D++)_[D]={isFixed:_[D][0]==="f",size:parseInt(_[D].substr(1))},E+=_[D].size,F.frameSourceData.fixedH+=_[D].isFixed?_[D].size:0;F.frameSourceData.regionsY=_,E!==h&&BeFunky.throwError("Smart Frame Cell Heights Do Not Add Up To Source Height",h,u),this.frameShapes[r][a]=F,p(F)})})})(p=>{this.frameTexture&&this.frameTexture.srcTexture&&(this.frameTexture.srcTexture.destroyGC(!0),delete this.frameTexture.srcTexture),(!this.frameTexture||this.frameTexture&&!this.frameTexture.baseTexture)&&(this.frameTexture=PIXI.RenderTexture.create(s,o)),p?(this.frameTexture.frameShape=p,this.frameTexture.srcTexture=PIXI.RenderTexture.create(c,h),this.renderFrameRegion(p,0,0,c,h,c,h),this.frameTexture.srcTexture.copyPixels(this.frameCanvasTexture),this.renderFrameTexture(s,o,n,l,!!d)):this.frameTexture.fillColor(16711680),t(this.frameTexture)})}renderFrameRegion(e,t,r,a,s,o,n){return e&&a&&s&&o&&n?(this.generateFrameCanvas(),this.frameCanvasElement.width=o,this.frameCanvasElement.height=n,this.frameCanvas.setWidth(o),this.frameCanvas.setHeight(n),this.frameCanvasElement.setStyles({width:`${o}px`,height:`${n}px`}),e.scaleX=e.baseScaleX*(o/a),e.scaleY=e.baseScaleY*(n/s),e.set({left:-(t*e.scaleX),top:-(r*e.scaleY)}).setCoords(),e.dirty=!0,this.frameCanvas.frameShape&&this.frameCanvas.frameShape!==e&&(this.frameCanvas.remove(this.frameCanvas.frameShape),delete this.frameCanvas.frameShape),this.frameCanvas.frameShape||(this.frameCanvas.frameShape=e,this.frameCanvas.add(this.frameCanvas.frameShape)),this.frameCanvas.renderAll(),this.generateFrameCanvasTexture(),!0):!1}renderFrameTexture(e,t,r,a,s=!1){if(e=Math.max(0,e||0),t=Math.max(0,t||0),r=typeof r=="number"?Math.max(0,Math.min(1,r)):.5,a=typeof a=="number"?Math.max(0,Math.min(1,a)):.5,!e||!t)return;let{frameTexture:o}=this;if(!o)return;let{frameShape:n}=o;if(!n)return;let{srcW:l,srcH:c,fixedW:h,fixedH:u,regionsX:d,regionsY:m}=n.frameSourceData,p=Math.min(e,t),g=Math.max(l,c),f=p/g,v=Math.round(p*.05),T=Math.round(v*a),x=e-T*2,B=t-T*2,y=Math.min(x/e,B/t),F=Math.min(y,.5),b=Math.min(l/h*y,c/u*y),S=f*((b-F)*r+F),I=(W,j,J,ie)=>{let re=(W-j)*S,he=J;ie.forEach(pe=>{pe.isFixed&&(he-=pe.size*S)}),he=Math.max(0,he);let ne=he/re,le=[],Be=0;for(let pe=0;pe<ie.length-1;pe++){let Ie=d[pe];Be+=Ie.size*S*(Ie.isFixed?1:ne),le.push(Math.round(Be))}let _e=[];for(let pe=0;pe<=le.length;pe++)_e.push((pe<le.length?le[pe]:J)-(pe?le[pe-1]:0));return _e},_=I(l,h,x,d),E=I(c,u,B,m);if(d.length!==_.length||m.length!==_.length){BeFunky.throwError("Frame Region Dimension Mismatch",d,_,m,E);return}let D=[],w=0,N=0,M=0,z=0;for(let W=0;W<d.length;W++){N=0,z=0;let j=d[W].size,J=_[W];for(let ie=0;ie<m.length;ie++){let re=m[ie].size,he=E[ie];W>0&&W<d.length-1&&ie>0&&ie<m.length-1||D.push({src:{x:w,y:N,w:d[W].isFixed?j:Math.min(j,J),h:m[ie].isFixed?re:Math.min(re,he)},dst:{x:M,y:z,w:J,h:he}}),N+=re,z+=he}w+=j,M+=J}(o.width!==e||o.height!==t)&&o.resize(e,t);for(let W=0;W<D.length;W++){let j=D[W];s&&o.srcTexture?(o.srcTexture.frame=new PIXI.Rectangle(j.src.x,j.src.y,j.src.w,j.src.h),o.srcTexture.orig=o.srcTexture.trim=new PIXI.Rectangle(0,0,j.dst.w,j.dst.h),o.copyPixels(o.srcTexture,{x:j.dst.x+T,y:j.dst.y+T},W===0)):this.renderFrameRegion(n,j.src.x,j.src.y,j.src.w,j.src.h,j.dst.w,j.dst.h)&&o.copyPixels(this.frameCanvasTexture,{x:j.dst.x+T,y:j.dst.y+T},W===0)}}generateFrameCanvas(){if(!this.frameCanvas){let e=!1;this.frameCanvasElement=document.createElement("canvas"),BFN.appContainer.appendChild(this.frameCanvasElement),e?(this.frameCanvas=new fabric.Canvas(this.frameCanvasElement,{enableRetinaScaling:!1,backgroundColor:"white"}),this.frameCanvas.renderOnAddRemove=!1,this.frameCanvas.skipOffscreen=!1,this.frameCanvasElement.parentNode.remove(),this.frameCanvasContext=this.frameCanvas.getContext(),this.frameCanvasElement.setStyles({zIndex:1e11,pointerEvents:"none",position:"absolute",left:"auto",right:0}),document.body.appendChild(this.frameCanvasElement)):(this.frameCanvas=new fabric.StaticCanvas(this.frameCanvasElement,{enableRetinaScaling:!1}),this.frameCanvas.renderOnAddRemove=!1,this.frameCanvas.skipOffscreen=!1,this.frameCanvasContext=this.frameCanvas.getContext(),this.frameCanvasElement.setStyles({display:"none"}))}}generateFrameCanvasTexture(){this.frameCanvasTexture?this.frameCanvasTexture.update():(this.frameCanvasTexture=new PIXI.Texture(new PIXI.BaseTexture.fromCanvas(this.frameCanvasElement)),this.frameCanvasTexture.baseTexture.mipmap=!1)}};BFN.SingletonQueue.add(()=>{BFN.SmartFrameManager=new WB});if(BFN.EventDispatcher){let i=function(){BFN.EventDispatcher.call(this),this.init()};YZ=i,BFN.AnimatorEvents={UPDATE:new Event("UPDATE"),UPDATE_COMPLETE:new Event("UPDATE_COMPLETE"),INCREASE_COMPLETE:new Event("INCREASE_COMPLETE"),DECREASE_COMPLETE:new Event("DECREASE_COMPLETE")},BFN.AnimatorTypes={ANIMATION_TYPE_LINEAR:new Event("ANIMATION_TYPE_LINEAR"),ANIMATION_TYPE_EASE_IN:new Event("ANIMATION_TYPE_EASE_IN")},i.prototype=Object.create(BFN.EventDispatcher.prototype),i.prototype.init=function(){BeFunky.log("Animator Init"),this.initDefaultValues()},i.prototype.initDefaultValues=function(){this.id=null,this.animating=!1,this.animationFactor=0,this.animationType=BFN.AnimatorTypes.ANIMATION_TYPE_LINEAR,this.linearSteps=5,this.easeInDivisor=2,this.increasing=!1,this.decreasing=!1,this.animationEaseValue=0,this.animationGoalValue=0,this.recommendedFrameRate=48,this.speedFactor=this.recommendedFrameRate/BFN.frameRate,this.ignoreAnimationCalls=!1},i.prototype.setAnimatorFactor=function(e){this.animationFactor=Math.max(0,Math.min(1,e)),this.dispatchEvent(BFN.AnimatorEvents.UPDATE)},i.prototype.increase=function(){this.ignoreAnimationCalls||(this.animating=!0,this.increasing=!0,this.decreasing=!1,this.timeDuration=Math.round(this.linearSteps/this.recommendedFrameRate*1e3),this.timeStart=this.getTime()-this.timeDuration*this.animationFactor,this.timeEnd=this.timeStart+this.timeDuration,this.increaseUpdate())},i.prototype.decrease=function(){this.ignoreAnimationCalls||(this.animating=!0,this.increasing=!1,this.decreasing=!0,this.timeDuration=Math.round(this.linearSteps/this.recommendedFrameRate*1e3)*this.animationFactor,this.timeStart=this.getTime(),this.timeEnd=this.timeStart+this.timeDuration,this.decreaseUpdate())},i.prototype.easeValue=function(){this.ignoreAnimationCalls||(this.animating=!0,this.easeValueUpdate())},i.prototype.startUpdate=function(){this.ignoreAnimationCalls||(this.animating=!0,this.update())},i.prototype.stopUpdate=function(){this.ignoreAnimationCalls||(this.animating=!1)},i.prototype.increaseUpdate=function(){if(this.increasing){switch(this.animationType){case BFN.AnimatorTypes.ANIMATION_TYPE_LINEAR:this.animationFactor=this.timeEnd>this.timeStart?Math.min(1,(this.getTime()-this.timeStart)/(this.timeEnd-this.timeStart)):1;break;case BFN.AnimatorTypes.ANIMATION_TYPE_EASE_IN:let e=Math.max(1.1,this.easeInDivisor*this.speedFactor);Math.abs(1-this.animationFactor)/e>.001?this.animationFactor+=(1-this.animationFactor)/this.easeInDivisor:this.animationFactor=1;break}this.dispatchEvent(BFN.AnimatorEvents.UPDATE),this.animationFactor==1&&(this.animating=!1,this.increasing=!1,this.dispatchEvent(BFN.AnimatorEvents.UPDATE_COMPLETE),this.dispatchEvent(BFN.AnimatorEvents.INCREASE_COMPLETE));try{BFN.MainUI.requestRender()}catch(e){}setTimeout(this.increaseUpdate.bind(this),BFN.frameInterval)}},i.prototype.decreaseUpdate=function(){if(this.decreasing){switch(this.animationType){case BFN.AnimatorTypes.ANIMATION_TYPE_LINEAR:this.animationFactor=this.timeEnd>this.timeStart?1-Math.min(1,(this.getTime()-this.timeStart)/(this.timeEnd-this.timeStart)):0;break;case BFN.AnimatorTypes.ANIMATION_TYPE_EASE_IN:let e=Math.max(1.1,this.easeInDivisor*this.speedFactor);Math.abs(0-this.animationFactor)/e>.001?this.animationFactor+=(0-this.animationFactor)/this.easeInDivisor:this.animationFactor=0;break}this.dispatchEvent(BFN.AnimatorEvents.UPDATE),this.animationFactor==0&&(this.animating=!1,this.decreasing=!1,this.dispatchEvent(BFN.AnimatorEvents.UPDATE_COMPLETE),this.dispatchEvent(BFN.AnimatorEvents.DECREASE_COMPLETE));try{BFN.MainUI.requestRender()}catch(e){}setTimeout(this.decreaseUpdate.bind(this),BFN.frameInterval)}},i.prototype.easeValueUpdate=function(){if(this.animating){let e=Math.max(1.1,this.easeInDivisor*this.speedFactor);Math.abs(this.animationGoalValue-this.animationEaseValue)/e>.005?(this.animationEaseValue+=(this.animationGoalValue-this.animationEaseValue)/this.easeInDivisor,this.dispatchEvent(BFN.AnimatorEvents.UPDATE)):(this.animationEaseValue=this.animationGoalValue,this.animating=!1,this.dispatchEvent(BFN.AnimatorEvents.UPDATE),this.dispatchEvent(BFN.AnimatorEvents.UPDATE_COMPLETE));try{BFN.MainUI.requestRender()}catch(t){}setTimeout(this.easeValueUpdate.bind(this),BFN.frameInterval)}},i.prototype.update=function(){if(this.animating){this.dispatchEvent(BFN.AnimatorEvents.UPDATE);try{BFN.MainUI.requestRender()}catch(e){}setTimeout(this.update.bind(this),BFN.frameInterval)}},i.prototype.getTime=function(){return new Date().getTime()},Object.defineProperty(i.prototype,"animationCosFactor",{get:function(){return((this.animationFactor<.5?Math.sin(this.animationFactor*Math.PI)-1:1-Math.sin(this.animationFactor*Math.PI))+1)/2}}),Object.defineProperty(i.prototype,"animationSinFactor",{get:function(){return(Math.sin(this.animationFactor*Math.PI-Math.PI/2)+1)/2}}),BFN.Animator=i}var YZ;BFN.DraggerEvents={DRAGGING_STARTED:new Event("DRAGGING_STARTED"),DRAGGING:new Event("DRAGGING"),DRAGGING_COMPLETE:new Event("DRAGGING_COMPLETE")};BFN.ActiveDraggers=[];var $B=class extends BFN.EventDispatcher{constructor(){super();this.init()}init(){this.draggedItem=null,this.item=null,this.itemStartX=0,this.itemStartY=0,this.mouseStartX=0,this.mouseStartY=0,this.mouseDeltaX=0,this.mouseDeltaY=0,this.draggedX=0,this.draggedY=0,this.scale=1,this.useBounds=!0,this.autoDrag=!0,this.stickyDrag=!0,this.active=!1,this.dragging=!1,this.draggingPointerID=null,this.wasDragged=!1,this.pixelDragThreshold=0,this.pixelDragThresholdPassed=!1,this.pixelDragThresholdPreventEvent=!1,this.pointerEvent=null,this.altScale=null,this.altStickyDrag=null,this.preventSelectionDrag=!1,this.deselectItemGroup=!0,this.preRenderDragOnly=!1,this.draggingEventEmissionPending=!1,this.completeStopDragTimeoutID=null,this.bounds={minX:0,minY:0,maxX:100,maxY:100},this.ctrlKey=!1,this.shiftKey=!1,this.altKey=!1,this.lastMousePosition=new PIXI.Point,this.currentMousePosition=new PIXI.Point,this.dragVelocity=0,this.handleItemReleasedBind=this.handleItemReleased.bind(this),this.handleItemMouseMoveBind=this.handleItemMouseMove.bind(this),this.handleMainUIPreRenderBind=this.handleMainUIPreRender.bind(this)}drag(e){if(this.active)return;this.active=!0,this.dragging=!0,this.item=e;let t=BeFunky.globalPointerCoords;this.itemStartX=this.draggedX=this.item.x,this.itemStartY=this.draggedY=this.item.y,this.mouseStartX=t.x,this.mouseStartY=t.y,document.removeEventListener(BeFunky.pointerup,this.handleItemReleasedBind,!0),document.removeEventListener(BeFunky.pointermove,this.handleItemMouseMoveBind,!0),document.addEventListener(BeFunky.pointerup,this.handleItemReleasedBind,!0),document.addEventListener(BeFunky.pointermove,this.handleItemMouseMoveBind,!0),this.dispatchEvent(BFN.DraggerEvents.DRAGGING_STARTED),this.lastMousePosition.x=this.currentMousePosition.x=t.x,this.lastMousePosition.y=this.currentMousePosition.y=t.y,this.pixelDragThresholdPassed=!1,BFN.ActiveDraggers.includes(this)||BFN.ActiveDraggers.push(this),this.preRenderDragOnly&&BFN.MainUI.addEventListener(BFN.MainUIEvents.PRE_RENDER.type,this.handleMainUIPreRenderBind),BFN.MainUI.requestRender()}stopDrag(){!this.active||(this.preRenderDragOnly&&this.draggingEventEmissionPending&&this.dispatchEvent(BFN.DraggerEvents.DRAGGING),this.draggingEventEmissionPending=!1,BFN.MainUI.removeEventListener(BFN.MainUIEvents.PRE_RENDER.type,this.handleMainUIPreRenderBind),this.dragging=!1,this.draggingPointerID=null,this.ctrlKey=!1,this.shiftKey=!1,this.altKey=!1,document.removeEventListener(BeFunky.pointerup,this.handleItemReleasedBind,!0),document.removeEventListener(BeFunky.pointermove,this.handleItemMouseMoveBind,!0),this.item&&this.wasDragged&&BFN.SentryManager.reportBreadcrumb(BFN.SentryManager.getDisplayObjectInfo(this.item),"stop_drag"),this.draggedItem=this.item,this.item=null,BFN.MainUI.requestRender(),this.pointerEvent=null,this.completeStopDragTimeoutID=setTimeout(this.completeStopDrag.bind(this),0))}completeStopDrag(){!this.active||(this.dispatchEvent(BFN.DraggerEvents.DRAGGING_COMPLETE),this.draggedItem=null,this.wasDragged=!1,this.altScale=null,this.altStickyDrag=null,BFN.ActiveDraggers.includes(this)&&BFN.ActiveDraggers.splice(BFN.ActiveDraggers.indexOf(this),1),this.active=!1,this.completeStopDragTimeoutID!==null&&(clearTimeout(this.completeStopDragTimeoutID),this.completeStopDragTimeoutID=null))}setBounds(e,t,r,a){this.bounds.minX=e,this.bounds.minY=t,this.bounds.maxX=r,this.bounds.maxY=a}handleItemReleased(e){e.pointerType==="touch"&&this.draggingPointerID!==null&&this.draggingPointerID!==e.pointerId||this.stopDrag()}handleItemMouseMove(e){if(!this.item||e.pointerType==="touch"&&(this.draggingPointerID===null&&(this.draggingPointerID=e.pointerId),this.draggingPointerID!==e.pointerId))return;this.ctrlKey=e.ctrlKey||e.metaKey,this.shiftKey=e.shiftKey,this.altKey=e.altKey;let t=this.altScale===null?this.scale:this.altScale,r=this.altStickyDrag===null?this.stickyDrag:this.altStickyDrag,a=BeFunky.globalPointerCoords;if(this.mouseDeltaX=(a.x-this.mouseStartX)/t,this.mouseDeltaY=(a.y-this.mouseStartY)/t,this.pixelDragThreshold&&!this.pixelDragThresholdPassed){if(Math.sqrt(Math.pow(a.x-this.mouseStartX,2)+Math.pow(a.y-this.mouseStartY,2))>this.pixelDragThreshold)this.pixelDragThresholdPassed=!0,this.mouseStartX=a.x,this.mouseStartY=a.y;else if(this.pixelDragThresholdPreventEvent)return;this.mouseDeltaX=this.mouseDeltaY=0}if(!this.wasDragged&&(this.mouseDeltaX||this.mouseDeltaY)&&(this.wasDragged=!0,BFN.SentryManager.reportBreadcrumb(BFN.SentryManager.getDisplayObjectInfo(this.item,!0),"start_drag")),this.draggedX=this.itemStartX+this.mouseDeltaX,this.draggedY=this.itemStartY+this.mouseDeltaY,this.useBounds){let c=Math.max(this.bounds.minX,Math.min(this.bounds.maxX,this.draggedX)),h=Math.max(this.bounds.minY,Math.min(this.bounds.maxY,this.draggedY));r&&(this.draggedX<this.bounds.minX?this.mouseStartX+=(this.draggedX-this.bounds.minX)*t:this.draggedX>this.bounds.maxX&&(this.mouseStartX+=(this.draggedX-this.bounds.maxX)*t),this.draggedY<this.bounds.minY?this.mouseStartY+=(this.draggedY-this.bounds.minY)*t:this.draggedY>this.bounds.maxY&&(this.mouseStartY+=(this.draggedY-this.bounds.maxY)*t)),this.draggedX=c,this.draggedY=h}this.autoDrag&&(this.item.x=this.draggedX,this.item.y=this.draggedY);let s=BeFunky.globalPointerCoords;this.currentMousePosition.x=s.x,this.currentMousePosition.y=s.y;let o=this.currentMousePosition.x-this.lastMousePosition.x,n=this.currentMousePosition.y-this.lastMousePosition.y,l=Math.sqrt(Math.pow(o,2)+Math.pow(n,2));this.dragVelocity=l,this.lastMousePosition.x=this.currentMousePosition.x,this.lastMousePosition.y=this.currentMousePosition.y,BFN.MainUI.requestRender(),this.pointerEvent=e,this.preRenderDragOnly?this.draggingEventEmissionPending=!0:this.dispatchEvent(BFN.DraggerEvents.DRAGGING)}handleMainUIPreRender(){this.preRenderDragOnly?this.draggingEventEmissionPending&&(this.draggingEventEmissionPending=!1,this.dispatchEvent(BFN.DraggerEvents.DRAGGING)):BFN.MainUI.removeEventListener(BFN.MainUIEvents.PRE_RENDER.type,this.handleMainUIPreRenderBind)}get validDrag(){return this.item&&(!this.useBounds||this.useBounds&&(Math.abs(this.bounds.maxX-this.bounds.minX)>.1||Math.abs(this.bounds.maxY-this.bounds.minY)>.1))}};BFN.Dragger=$B;function Bt(){PIXI.Container.call(this),this.init()}Bt.prototype=Object.create(PIXI.Container.prototype);Bt.prototype.init=function(){BeFunky.log("HoverButton Init"),this.initDefaultValues(),this.initButtonContainer(),this.initButtonSprite(),this.initAnimators()};Bt.prototype.initDefaultValues=function(){this.testHitArea=!1,this.interactive=this.buttonMode=!0,this._selected=!1,this._hovered=!1,this._active=!0,this._handlePress=null,this._hoverButtonGroup=null,this.mouseover=this.handleMouseOver.bind(this),this.mouseout=this.handleMouseOut.bind(this),this.handleMouseDownBind=this.handleMouseDown.bind(this)};Bt.prototype.initButtonContainer=function(){this.buttonContainer=new PIXI.Container,this.addChild(this.buttonContainer)};Bt.prototype.initButtonSprite=function(){this.buttonSprite=new PIXI.Sprite,this.buttonSprite.anchor.x=this.buttonSprite.anchor.y=.5,this.buttonContainer.addChild(this.buttonSprite)};Bt.prototype.initAnimators=function(){this.hoverAnimator=new BFN.Animator,this.hoverAnimator.addEventListener(BFN.AnimatorEvents.UPDATE.type,this.handleAnimatorUpdate.bind(this)),this.selectAnimator=new BFN.Animator,this.selectAnimator.addEventListener(BFN.AnimatorEvents.UPDATE.type,this.handleAnimatorUpdate.bind(this)),this.activeAnimator=new BFN.Animator,this.activeAnimator.setAnimatorFactor(1),this.activeAnimator.addEventListener(BFN.AnimatorEvents.UPDATE.type,this.handleActiveAnimatorUpdate.bind(this))};Bt.prototype.updateDisplay=function(){let i=1;i=BFN.Util.interpolateNumber(i,1.2,this.hoverAnimator.animationFactor),i=BFN.Util.interpolateNumber(i,1.2,this.selectAnimator.animationFactor),this.buttonSprite.scale.x=this.buttonSprite.scale.y=i};Bt.prototype.setHitAreaSquare=function(i=0,e=0,t=!1){if(this.buttonSprite.hitArea=i>0&&e>0?new PIXI.Polygon:null,this.buttonSprite.hitArea){let{points:r}=this.buttonSprite.hitArea,a=(.5-this.buttonSprite.anchor.x)*this.texture.width,s=(.5-this.buttonSprite.anchor.y)*this.texture.height;for(let o=0;o<4;o++){let n=-Math.pow(-1,Math.min(1,o%3))*(i/2),l=-Math.pow(-1,Math.floor(o/2))*(e/2);r.push(n+a),r.push(l+s)}}this.drawHitArea(t)};Bt.prototype.setHitAreaCircle=function(i=0,e=!1){if(this.buttonSprite.hitArea=i>0?new PIXI.Polygon:null,this.buttonSprite.hitArea){let{points:t}=this.buttonSprite.hitArea,r=(.5-this.buttonSprite.anchor.x)*this.texture.width,a=(.5-this.buttonSprite.anchor.y)*this.texture.height,s=Math.PI/12;for(let o=0;o<24;o++){let n=Math.cos(o*s)*i,l=Math.sin(o*s)*i;t.push(n+r),t.push(l+a)}}this.drawHitArea(e)};Bt.prototype.drawHitArea=function(i){if(i=i||this.testHitArea,i&&this.buttonSprite.hitArea){this.hitAreaGraphic||(this.hitAreaGraphic=new PIXI.Graphics,this.hitAreaGraphic.interactive=!1),this.hitAreaGraphic.clear();let{points:e}=this.buttonSprite.hitArea;if(e.length>=6){for(let t=0;t<e.length;t+=2){let r=e[t],a=e[t+1];t?this.hitAreaGraphic.lineTo(r,a):(this.hitAreaGraphic.lineStyle(2,16777215),this.hitAreaGraphic.beginFill(16711680,.5),this.hitAreaGraphic.moveTo(r,a))}this.hitAreaGraphic.lineTo(e[0],e[1]),this.hitAreaGraphic.endFill(),this.buttonSprite.children.includes(this.hitAreaGraphic)||this.buttonSprite.addChild(this.hitAreaGraphic)}else this.buttonSprite.children.includes(this.hitAreaGraphic)&&this.buttonSprite.removeChild(this.hitAreaGraphic)}else this.hitAreaGraphic&&(this.hitAreaGraphic.clear(),this.buttonSprite.children.includes(this.hitAreaGraphic)&&this.buttonSprite.removeChild(this.hitAreaGraphic))};Bt.prototype.handleMouseOver=function(){this._hovered=!0,this.hoverAnimator.increase()};Bt.prototype.handleMouseOut=function(){this._hovered=!1,this.hoverAnimator.decrease()};Bt.prototype.handleMouseDown=function(i){if(!this._handlePress)return;if(!BeFunky.isMobile||!this._hoverButtonGroup||!this.parent||!BFN.MainUI.pointerEvent){this._handlePress(i);return}let e=this.parent.getPointerPosition(BFN.MainUI.pointerEvent),t=this,r=Math.sqrt(Math.pow(t.x-e.x,2)+Math.pow(t.y-e.y,2));this._hoverButtonGroup.filter(s=>s instanceof BFN.HoverButton&&s.visible&&s.active&&s.handlePress&&s.parent===this.parent).forEach(s=>{let o=Math.sqrt(Math.pow(s.x-e.x,2)+Math.pow(s.y-e.y,2));o<r&&(t=s,r=o)}),i.target=t,i.currentTarget&&(i.currentTarget=t),t.handlePress(i),!!this.testHitArea&&console.log(this!==t?`found button "${t.id}" closer than button that was clicked "${this.id}"`:`same as clicked "${this.id}"`)};Bt.prototype.handleAnimatorUpdate=function(){this.updateDisplay()};Bt.prototype.handleActiveAnimatorUpdate=function(){this.buttonContainer.scale.x=this.buttonContainer.scale.y=this.activeAnimator.animationFactor*.25+.75,this.buttonContainer.alpha=this.activeAnimator.animationFactor};Object.defineProperty(Bt.prototype,"texture",{set:function(i){this.buttonSprite.texture=i},get:function(){return this.buttonSprite.texture}});Object.defineProperty(Bt.prototype,"selected",{set:function(i){this._selected=i,this._selected?this.selectAnimator.increase():this.selectAnimator.decrease()},get:function(){return this._selected}});Object.defineProperty(Bt.prototype,"hovered",{get:function(){return this._hovered}});Object.defineProperty(Bt.prototype,"active",{set:function(i){this._active!=!!i&&(this._active=!!i,this.interactive=this.interactiveChildren=this._active,this._active?this.activeAnimator.increase():this.activeAnimator.decrease())},get:function(){return this._active}});Object.defineProperty(Bt.prototype,"handlePress",{set:function(i){this._handlePress&&(this.off("pointerdown",this.handleMouseDownBind),this._handlePress=null),typeof i=="function"&&(this._handlePress=i,this.on("pointerdown",this.handleMouseDownBind))},get:function(){return this._handlePress}});Object.defineProperty(Bt.prototype,"hoverButtonGroup",{set:function(i){i instanceof Array&&(this._hoverButtonGroup=i)},get:function(){return this._hoverButtonGroup}});BFN.HoverButton=Bt;BFN.CropHandleTypes={TYPE_CORNER:"TYPE_CORNER",TYPE_EDGE:"TYPE_EDGE"};function Xt(i,e,t){PIXI.Container.call(this),this._type=BFN.CropHandleTypes.hasOwnProperty(i)?i:BFN.CropHandleTypes.TYPE_CORNER,this._rotation=e||0,this._size=t||12,this.init()}Xt.prototype=Object.create(PIXI.Container.prototype);Xt.prototype.init=function(){BeFunky.log("CropHandle Init"),this.initDefaultValues(),this.initHandle(),this.initAnimator()};Xt.prototype.initDefaultValues=function(){this.interactive=this.buttonMode=!0,this.testHitArea=!1,this.hovered=!1,this.mouseDown=!1,this._handlePress=null,this._hoverButtonGroup=null,this.handleMouseOverBind=this.handleMouseOver.bind(this),this.handleMouseOutBind=this.handleMouseOut.bind(this),this.handleMouseDownBind=this.handleMouseDown.bind(this),this.handleMouseUpBind=this.handleMouseUp.bind(this),this.on("pointerover",this.handleMouseOverBind),this.on("pointerout",this.handleMouseOutBind),this.on("pointerdown",this.handleMouseDownBind)};Xt.prototype.initHandle=function(){switch(this.handle=new PIXI.Sprite,this.handle.interactive=!0,this.handle.interactiveChildren=!BeFunky.isMobile,this.handle.rotation=this._rotation,this.addChild(this.handle),this.fill=new PIXI.Graphics,this.handle.addChild(this.fill),this.outline=new PIXI.Graphics,this.handle.addChild(this.outline),this._type){case BFN.CropHandleTypes.TYPE_CORNER:this.initCorner();break;case BFN.CropHandleTypes.TYPE_EDGE:this.initEdge();break}};Xt.prototype.initCorner=function(){this.fill.x=this.fill.y=5,BeFunky.isMobile||(this.testHitArea?this.fill.beginFill(16711680,1):this.fill.beginFill(0,0),this.fill.drawRect(-this._size,-this._size,this._size*2,this._size*2),this.fill.endFill()),this.fill.beginFill(16777215),this.fill.moveTo(0,0),this.fill.lineTo(this._size+0,0),this.fill.lineTo(this._size+0,this._size/3+0),this.fill.lineTo(this._size/3+0,this._size/3+0),this.fill.lineTo(this._size/3+0,this._size+0),this.fill.lineTo(0,this._size+0),this.fill.lineTo(0,0),this.fill.endFill(),this.outline.x=this.outline.y=5,this.outline.lineStyle(1,0),this.outline.moveTo(0,0),this.outline.lineTo(this._size+0,0),this.outline.lineTo(this._size+0,this._size/3+0),this.outline.lineTo(this._size/3+0,this._size/3+0),this.outline.lineTo(this._size/3+0,this._size+0),this.outline.lineTo(0,this._size+0),this.outline.lineTo(0,0),BeFunky.isMobile&&this.setHitAreaCircle(this.fill.x+this._size/2,this.fill.y+this._size/2,22)};Xt.prototype.initEdge=function(){this.fill.y=5,BeFunky.isMobile||(this.testHitArea?this.fill.beginFill(16711680,1):this.fill.beginFill(0,0),this.fill.drawRect(-(this._size/2),-this._size,this._size,this._size*2),this.fill.endFill()),this.fill.beginFill(16777215),this.fill.drawRect(-(this._size/2),0,this._size,this._size/3),this.fill.endFill(),this.outline.y=5,this.outline.lineStyle(1,0),this.outline.drawRect(-(this._size/2),0,this._size,this._size/3),BeFunky.isMobile&&this.setHitAreaCircle(0,this.fill.y+this._size/6,22)};Xt.prototype.initAnimator=function(){this.animator=new BFN.Animator,this.animator.addEventListener(BFN.AnimatorEvents.UPDATE.type,this.handleAnimatorUpdate.bind(this))};Xt.prototype.setHitAreaCircle=function(i,e,t=0,r=!1){if(this.handle.hitArea=t>0?new PIXI.Polygon:null,this.handle.hitArea){let{points:a}=this.handle.hitArea,s=Math.PI/12;for(let o=0;o<24;o++){let n=Math.cos(o*s)*t,l=Math.sin(o*s)*t;a.push(n+i),a.push(l+e)}}this.drawHitArea(r)};Xt.prototype.drawHitArea=function(i){if(i=i||this.testHitArea,i&&this.handle.hitArea){this.hitAreaGraphic||(this.hitAreaGraphic=new PIXI.Graphics,this.hitAreaGraphic.interactive=!1),this.hitAreaGraphic.clear();let{points:e}=this.handle.hitArea;if(e.length>=6){for(let t=0;t<e.length;t+=2){let r=e[t],a=e[t+1];t?this.hitAreaGraphic.lineTo(r,a):(this.hitAreaGraphic.lineStyle(2,16777215),this.hitAreaGraphic.beginFill(16711680,.5),this.hitAreaGraphic.moveTo(r,a))}this.hitAreaGraphic.lineTo(e[0],e[1]),this.hitAreaGraphic.endFill(),this.handle.children.includes(this.hitAreaGraphic)||this.handle.addChild(this.hitAreaGraphic)}else this.handle.children.includes(this.hitAreaGraphic)&&this.handle.removeChild(this.hitAreaGraphic)}else this.hitAreaGraphic&&(this.hitAreaGraphic.clear(),this.handle.children.includes(this.hitAreaGraphic)&&this.handle.removeChild(this.hitAreaGraphic))};Xt.prototype.handleMouseOver=function(){this.hovered=!0,this.animator.increase()};Xt.prototype.handleMouseOut=function(){this.hovered=!1,this.mouseDown||this.animator.decrease()};Xt.prototype.handleMouseDown=function(i){if(this.mouseDown=!0,document.addEventListener(BeFunky.pointerup,this.handleMouseUpBind),!this._handlePress)return;if(!BeFunky.isMobile||!this._hoverButtonGroup||!this.parent||!BFN.MainUI.pointerEvent){this._handlePress(i);return}let e=this.parent.getPointerPosition(BFN.MainUI.pointerEvent),t=this,r=Math.sqrt(Math.pow(t.x-e.x,2)+Math.pow(t.y-e.y,2));this._hoverButtonGroup.filter(s=>s instanceof BFN.CropHandle&&s.visible&&s.handlePress&&s.parent===this.parent).forEach(s=>{let o=Math.sqrt(Math.pow(s.x-e.x,2)+Math.pow(s.y-e.y,2));o<r&&(t=s,r=o)}),i.target=i.currentTarget=t,t.handlePress(i),!!this.testHitArea&&console.log(this!==t?`found button "${t.id}" closer than button that was clicked "${this.id}"`:`same as clicked "${this.id}"`)};Xt.prototype.handleMouseUp=function(){this.mouseDown=!1,document.removeEventListener(BeFunky.pointerup,this.handleMouseUpBind),this.hovered||this.handleMouseOutBind()};Xt.prototype.handleAnimatorUpdate=function(){this.fill.alpha=1-this.animator.animationFactor/2};Object.defineProperty(Xt.prototype,"handlePress",{set:function(i){this._handlePress=null,typeof i=="function"&&(this._handlePress=i)},get:function(){return this._handlePress}});Object.defineProperty(Xt.prototype,"hoverButtonGroup",{set:function(i){i instanceof Array&&(this._hoverButtonGroup=i)},get:function(){return this._hoverButtonGroup}});BFN.CropHandle=Xt;function ai(i=16777215){PIXI.Container.call(this),this._color=i,this.init()}ai.prototype=Object.create(PIXI.Container.prototype);ai.prototype.init=function(){BeFunky.log("SquareButton Init"),this.initDefaultValues(),this.initSquareGraphic(),this.initAnimators()};ai.prototype.initDefaultValues=function(){this.interactive=!0,this._itemWidth=10,this._itemHeight=10,this.hovered=!1,this._selected=!1,this._unhoveredAlpha=.25,this._hoveredAlpha=.75,this.handleMouseOverBind=this.handleMouseOver.bind(this),this.handleMouseOutBind=this.handleMouseOut.bind(this),this.on("pointerover",this.handleMouseOverBind),this.on("pointerout",this.handleMouseOutBind)};ai.prototype.initSquareGraphic=function(){this.squareGraphic=new PIXI.Graphics,this.addChild(this.squareGraphic),this.drawButton()};ai.prototype.initAnimators=function(){this.hoverAnimator=new BFN.Animator,this.hoverAnimator.addEventListener(BFN.AnimatorEvents.UPDATE.type,this.handleAnimatorUpdate.bind(this)),this.hoverAnimator.setAnimatorFactor(0)};ai.prototype.setHoverAlphas=function(i,e){this._unhoveredAlpha=i,this._hoveredAlpha=e,this.updateDisplay()};ai.prototype.drawButton=function(){this.squareGraphic.clear(),this.squareGraphic.beginFill(this._color),this.squareGraphic.drawRect(0,0,10,10),this.squareGraphic.endFill()};ai.prototype.updateDisplay=function(){this.squareGraphic.width=this._itemWidth,this.squareGraphic.height=this._itemHeight,this.squareGraphic.alpha=this.hoverAnimator.animationFactor*(this._hoveredAlpha=this._unhoveredAlpha)+this._unhoveredAlpha};ai.prototype.handleMouseOver=function(){this.hovered=!0,this.hoverAnimator.increase()};ai.prototype.handleMouseOut=function(){this.hovered=!1,this.selected||this.hoverAnimator.decrease()};ai.prototype.handleAnimatorUpdate=function(){this.updateDisplay()};Object.defineProperty(ai.prototype,"color",{set:function(i){this._color!=i&&(this._color=i,this.drawButton())},get:function(){return this._selected}});Object.defineProperty(ai.prototype,"selected",{set:function(i){this._selected=i,!this.hovered&&!this.selected&&this.hoverAnimator.decrease()},get:function(){return this._selected}});Object.defineProperty(ai.prototype,"itemWidth",{set:function(i){this._itemWidth=i,this.updateDisplay()},get:function(){return this._itemWidth}});Object.defineProperty(ai.prototype,"itemHeight",{set:function(i){this._itemHeight=i,this.updateDisplay()},get:function(){return this._itemHeight}});BFN.SquareButton=ai;BFN.CanvasScaleBarsEvents={SCALING_STARTED:new Event("SCALING_STARTED"),SCALING_COMPLETE:new Event("SCALING_COMPLETE"),DIMENSIONS_UPDATED:new Event("DIMENSIONS_UPDATED"),SCALE_BAR_ACTION:new Event("SCALE_BAR_ACTION")};function tt(i=null){PIXI.Container.call(this),BFN.EventDispatcher.call(this),this.appViewState=i,this.init()}tt.prototype=window.azrc.extend(Object.create(PIXI.Container.prototype),Object.create(BFN.EventDispatcher.prototype));tt.prototype.init=function(){BeFunky.log("CanvasScaleBars Init"),this.initDefaultValues(),this.initScaleBars(),this.initFadeAnimator(),this.updateScaleBarPositions(),this.updateScaleBarSizes(),this.updateScaleBarScales()};tt.prototype.initDefaultValues=function(){switch(this.interactive=!0,this.appViewState){case BFN.AppModelViewStates.VIEWING_PHOTO_EDITOR:this.canvasModel=BFN.PhotoEditorCanvasModel;break;case BFN.AppModelViewStates.VIEWING_COLLAGE_MAKER:this.canvasModel=BFN.CollageMakerCanvasModel;break;case BFN.AppModelViewStates.VIEWING_DESIGNER:this.canvasModel=BFN.DesignerCanvasModel;break}this.scaleBarSize=20,this.scaleBarTouchHitSize=44,this.minSize=BFN.minImageSize,this.maxSize=BFN.maxImageSize,this._active=!0,this._showing=!1,this._enabled=!0,this._canvasScale=1,this._canvasWidth=100,this._canvasHeight=100,this.isTouch=!1,this.currentScaleBar=null,BFN.CanvasScaleBarsEvents.SCALE_BAR_ACTION.data={id:null,action:null},this.appViewState&&(this.hovered=!1,this.dragging=!1,setTimeout(function(){BFN.MainUI.addEventListener(BFN.MainUIEvents.MOUSE_OVER.type,this.handleMainUIMouseOver.bind(this)),BFN.MainUI.addEventListener(BFN.MainUIEvents.MOUSE_OUT.type,this.handleMainUIMouseOut.bind(this))}.bind(this),100),document.addEventListener(BeFunky.pointerdown,this.handleDocumentPressed.bind(this),!0),document.addEventListener(BeFunky.pointerup,this.handleDocumentReleased.bind(this),!0))};tt.prototype.handleDocumentPressed=function(){requestAnimationFrame(function(){this.interactive=this.interactiveChildren=!1}.bind(this))};tt.prototype.handleDocumentReleased=function(){this.interactive=this.interactiveChildren=!0};tt.prototype.initScaleBars=function(){this.scaleBarData=[{id:"left",rotation:Math.PI/2,direction:"vertical"},{id:"right",rotation:-(Math.PI/2),direction:"vertical"},{id:"top",rotation:Math.PI,direction:"horizontal"},{id:"bottom",rotation:0,direction:"horizontal"},{id:"topLeft",rotation:Math.PI,direction:"none"},{id:"topRight",rotation:-(Math.PI/2),direction:"none"},{id:"bottomLeft",rotation:Math.PI/2,direction:"none"},{id:"bottomRight",rotation:0,direction:"none"}],this.handleScaleBarMouseOverBind=this.handleScaleBarMouseOver.bind(this),this.handleScaleBarMouseOutBind=this.handleScaleBarMouseOut.bind(this),this.handleScaleBarPressedBind=this.handleScaleBarPressed.bind(this),this.handleScaleBarReleasedBind=this.handleScaleBarReleased.bind(this),this.handleScaleBarDraggerDraggingBind=this.handleScaleBarDraggerDragging.bind(this),this.handleScaleBarDraggerDraggingStartedBind=this.handleScaleBarDraggerDraggingStarted.bind(this),this.handleScaleBarDraggerDraggingCompleteBind=this.handleScaleBarDraggerDraggingComplete.bind(this),this.scaleBars={};for(let i=0;i<this.scaleBarData.length;i++){let e=this.scaleBarData[i],t=new BFN.SquareButton(4145484);switch(t.buttonMode=!1,t.itemWidth=t.itemHeight=this.scaleBarSize,t.setHoverAlphas(.6,1),t.id=e.id,t.rotation=e.rotation,t.roundedRectFilter=new BFN.filters.RoundedRectFilter,t.roundedRectFilter.strokeWidth=0,t.roundedRectFilter.strokeColor=0,t.roundedRectFilter.useTexture=1,t.roundedRectFilter.getCornerRadiusFromShortestSide=1,t.filters=[t.roundedRectFilter],e.direction){case"vertical":t.roundedRectFilter.edgePaddingX=4,t.roundedRectFilter.edgePaddingY=1;break;case"horizontal":t.roundedRectFilter.edgePaddingX=1,t.roundedRectFilter.edgePaddingY=4;break;case"none":t.roundedRectFilter.edgePadding=4;break}t.on(BeFunky.pointerover,this.handleScaleBarMouseOverBind),t.on(BeFunky.pointerout,this.handleScaleBarMouseOutBind),t.on(BeFunky.pointerdown,this.handleScaleBarPressedBind),this.addChild(t),this.scaleBars[t.id]=t,BeFunky.isMobile&&(t.hitArea=new PIXI.Rectangle(0,0,this.scaleBarTouchHitSize,this.scaleBarTouchHitSize))}this.scaleBarDragger=new BFN.Dragger,this.scaleBarDragger.stickyDrag=!1,this.scaleBarDragger.preventSelectionDrag=!0,this.scaleBarDragger.addEventListener(BFN.DraggerEvents.DRAGGING.type,this.handleScaleBarDraggerDraggingBind),this.scaleBarDragger.addEventListener(BFN.DraggerEvents.DRAGGING_STARTED.type,this.handleScaleBarDraggerDraggingStartedBind),this.scaleBarDragger.addEventListener(BFN.DraggerEvents.DRAGGING_COMPLETE.type,this.handleScaleBarDraggerDraggingCompleteBind)};tt.prototype.initFadeAnimator=function(){this.fadeAnimator=new BFN.Animator,this.fadeAnimator.linearSteps=10,this.fadeAnimator.addEventListener(BFN.AnimatorEvents.UPDATE.type,this.handleFadeAnimatorUpdate.bind(this)),this.appViewState&&this.fadeAnimator.setAnimatorFactor(1)};tt.prototype.show=function(){this._showing=!0,this._active&&this.fadeAnimator.increase()};tt.prototype.hide=function(){this._showing=!1,this.fadeAnimator.decrease()};tt.prototype.updateScaleBarPositions=function(){this.scaleBars.left.x=this.scaleBars.bottom.x=this.scaleBars.topLeft.x=this.scaleBars.bottomLeft.x=-(this._canvasWidth/2),this.scaleBars.right.x=this.scaleBars.top.x=this.scaleBars.topRight.x=this.scaleBars.bottomRight.x=this._canvasWidth/2,this.scaleBars.left.y=this.scaleBars.top.y=this.scaleBars.topLeft.y=this.scaleBars.topRight.y=-(this._canvasHeight/2),this.scaleBars.right.y=this.scaleBars.bottom.y=this.scaleBars.bottomLeft.y=this.scaleBars.bottomRight.y=this._canvasHeight/2};tt.prototype.updateScaleBarSizes=function(){this.scaleBars.left.itemWidth=this.scaleBars.right.itemWidth=this._canvasHeight,this.scaleBars.top.itemWidth=this.scaleBars.bottom.itemWidth=this._canvasWidth,BeFunky.isMobile&&(this.scaleBars.left.hitArea.width=this.scaleBars.right.hitArea.width=this._canvasHeight,this.scaleBars.top.hitArea.width=this.scaleBars.bottom.hitArea.width=this._canvasWidth)};tt.prototype.updateScaleBarScales=function(){for(let i in this.scaleBars){let e=this.scaleBars[i];switch(e.scale.y=1/this._canvasScale,i){case"topLeft":case"topRight":case"bottomLeft":case"bottomRight":e.scale.x=e.scale.y;break}}};tt.prototype.handleMainUIMouseOver=function(i){BFN.AppModel.viewState==this.appViewState&&(this.hovered=!0,this.isTouch=!1,this.show())};tt.prototype.handleMainUIMouseOut=function(i){this.hovered=!1,!this.dragging&&!this.isTouch&&this.hide()};tt.prototype.handleScaleBarMouseOver=function(i){!this.scaleBarDragger.dragging&&this._enabled&&(this.hoveredScaleBarID=i.currentTarget.id,setTimeout(function(){BFN.CursorScreen.cursor="arrow";let e=this.hoveredScaleBarID;switch(e){case"left":case"right":BFN.CursorScreen.cursorRotation=0;break;case"top":case"bottom":BFN.CursorScreen.cursorRotation=Math.PI/2;break;case"topLeft":case"bottomRight":BFN.CursorScreen.cursorRotation=Math.PI/4;break;case"topRight":case"bottomLeft":BFN.CursorScreen.cursorRotation=-(Math.PI/4);break}BFN.CanvasScaleBarsEvents.SCALE_BAR_ACTION.data.id=e,BFN.CanvasScaleBarsEvents.SCALE_BAR_ACTION.data.action="over",this.dispatchEvent(BFN.CanvasScaleBarsEvents.SCALE_BAR_ACTION)}.bind(this),0))};tt.prototype.handleScaleBarMouseOut=function(i){this.currentScaleBar?BFN.CanvasScaleBarsEvents.SCALE_BAR_ACTION.data.id=this.currentScaleBar.id:(BFN.CursorScreen.cursor=null,BFN.CanvasScaleBarsEvents.SCALE_BAR_ACTION.data.id=null),BFN.CanvasScaleBarsEvents.SCALE_BAR_ACTION.data.action="out",this.dispatchEvent(BFN.CanvasScaleBarsEvents.SCALE_BAR_ACTION)};tt.prototype.handleScaleBarPressed=function(i){if(!this.canvasModel.canvasScaling&&this._enabled){this.currentAspectRatio=this._canvasHeight/this._canvasWidth,this.currentScaleBar=i.currentTarget,this.hovered||(this.isTouch=!0,this.show()),this.isTouch&&(this.handleScaleBarMouseOverBind(i),this.currentScaleBar.handleMouseOver(),this.currentScaleBar.selected=!0);let e=this.currentScaleBar.id;switch(e){case"left":this.scaleBarDragger.setBounds(-this.maxSize,this.currentScaleBar.y,-(this.minSize/2),this.currentScaleBar.y);break;case"right":this.scaleBarDragger.setBounds(this.minSize/2,this.currentScaleBar.y,this.maxSize,this.currentScaleBar.y);break;case"top":this.scaleBarDragger.setBounds(this.currentScaleBar.x,-this.maxSize,this.currentScaleBar.x,-(this.minSize/2));break;case"bottom":this.scaleBarDragger.setBounds(this.currentScaleBar.x,this.minSize/2,this.currentScaleBar.x,this.maxSize);break;case"topLeft":this.scaleBarDragger.setBounds(-this.maxSize,-this.maxSize,-(this.minSize/2),-(this.minSize/2));break;case"topRight":this.scaleBarDragger.setBounds(this.minSize/2,-this.maxSize,this.maxSize,-(this.minSize/2));break;case"bottomLeft":this.scaleBarDragger.setBounds(-this.maxSize,this.minSize/2,-(this.minSize/2),this.maxSize);break;case"bottomRight":this.scaleBarDragger.setBounds(this.minSize/2,this.minSize/2,this.maxSize,this.maxSize);break}BFN.CanvasScaleBarsEvents.SCALE_BAR_ACTION.data.id=e,BFN.CanvasScaleBarsEvents.SCALE_BAR_ACTION.data.action="press",this.dispatchEvent(BFN.CanvasScaleBarsEvents.SCALE_BAR_ACTION),BFN.CursorScreen.cursorLock=!0,document.addEventListener(BeFunky.pointerup,this.handleScaleBarReleasedBind),this.scaleBarDragger.drag(this.currentScaleBar);for(let t in this.scaleBars){let r=this.scaleBars[t];r.selected=r==this.currentScaleBar,r.interactive=r==this.currentScaleBar}}};tt.prototype.handleScaleBarReleased=function(i){if(this.isTouch&&(this.handleScaleBarMouseOutBind(i),this.currentScaleBar&&(this.currentScaleBar.handleMouseOut(),this.currentScaleBar.selected=!1)),BFN.CursorScreen.cursorLock=!1,document.removeEventListener(BeFunky.pointerup,this.handleScaleBarReleasedBind),!!this.currentScaleBar){if(!this.currentScaleBar.hovered)BFN.CursorScreen.cursor=null,BFN.CanvasScaleBarsEvents.SCALE_BAR_ACTION.data.id=null;else{let e=this.currentScaleBar.id;BFN.CanvasScaleBarsEvents.SCALE_BAR_ACTION.data.id=e}BFN.CanvasScaleBarsEvents.SCALE_BAR_ACTION.data.action="release",this.dispatchEvent(BFN.CanvasScaleBarsEvents.SCALE_BAR_ACTION),this.currentScaleBar=null;for(let e in this.scaleBars){let t=this.scaleBars[e];t.selected=!1,t.interactive=!0}}};tt.prototype.handleScaleBarDraggerDragging=function(i){this.currentScaleBar&&(this._canvasWidth=Math.round(Math.abs(this.currentScaleBar.x*2)),this._canvasHeight=Math.round(Math.abs(this.currentScaleBar.y*2)),this.updateScaleBarPositions(),this.updateScaleBarSizes(),this.dispatchEvent(BFN.CanvasScaleBarsEvents.DIMENSIONS_UPDATED))};tt.prototype.handleScaleBarDraggerDraggingStarted=function(i){this.dragging=!0,this.dispatchEvent(BFN.CanvasScaleBarsEvents.SCALING_STARTED)};tt.prototype.handleScaleBarDraggerDraggingComplete=function(i){this.dragging=!1,this.dispatchEvent(BFN.CanvasScaleBarsEvents.SCALING_COMPLETE),this.hovered||this.handleMainUIMouseOut()};tt.prototype.handleFadeAnimatorUpdate=function(i){this.alpha=this.fadeAnimator.animationFactor};Object.defineProperty(tt.prototype,"enabled",{set:function(i){this._enabled=i},get:function(){return this._enabled}});Object.defineProperty(tt.prototype,"canvasScale",{set:function(i){this._canvasScale=i,this.scaleBarDragger.scale=this._canvasScale,this.updateScaleBarScales()},get:function(){return this._canvasScale}});Object.defineProperty(tt.prototype,"canvasWidth",{set:function(i){this._canvasWidth=i,this.updateScaleBarPositions(),this.updateScaleBarSizes()},get:function(){return this._canvasWidth}});Object.defineProperty(tt.prototype,"canvasHeight",{set:function(i){this._canvasHeight=i,this.updateScaleBarPositions(),this.updateScaleBarSizes()},get:function(){return this._canvasHeight}});Object.defineProperty(tt.prototype,"active",{set:function(i){this._active=i,this._active?this._active&&this._showing&&this.show():this.hide()},get:function(){return this._active}});BFN.CanvasScaleBars=tt;function Vi(i=16711680,e=1,t=0,r=0){PIXI.Container.call(this),BFN.EventDispatcher.call(this),this.baseOpacity=Math.max(0,Math.min(1,e)),this._color=i,this._opacity=this.baseOpacity,this._fitPaddingX=t,this._fitPaddingY=r,this.init()}Vi.prototype=window.azrc.extend(Object.create(PIXI.Container.prototype),Object.create(BFN.EventDispatcher.prototype));Vi.prototype.init=function(){BeFunky.log("CanvasFrame Init"),this.initDefaultValues(),this.initRectangles(),this.setInnerDimensions(100,100),this.setOuterDimensions(200,200)};Vi.prototype.initDefaultValues=function(){this.interactive=BeFunky.isMobile,this.rectBaseSize=128,this._canvasScale=1};Vi.prototype.initRectangles=function(){this.rectangles={},this.rectangles.top=this.createRect(-(this.rectBaseSize/2),-this.rectBaseSize,this.rectBaseSize,this.rectBaseSize),this.rectangles.bottom=this.createRect(-(this.rectBaseSize/2),0,this.rectBaseSize,this.rectBaseSize),this.rectangles.left=this.createRect(-this.rectBaseSize,-(this.rectBaseSize/2),this.rectBaseSize,this.rectBaseSize),this.rectangles.right=this.createRect(0,-(this.rectBaseSize/2),this.rectBaseSize,this.rectBaseSize)};Vi.prototype.setInnerDimensions=function(i,e){this.innerW=i,this.innerH=e,this.rectangles.left.x=-(this.innerW/2),this.rectangles.right.x=this.innerW/2,this.rectangles.top.y=-(this.innerH/2),this.rectangles.bottom.y=this.innerH/2,this.updateDisplay()};Vi.prototype.setOuterDimensions=function(i,e){this.outerW=i,this.outerH=e,this.updateDisplay()};Vi.prototype.updateDisplay=function(){let i=Math.max(this._fitPaddingX/this._canvasScale,(this.outerW-this.innerW*this._canvasScale)/2/this._canvasScale)/this.rectBaseSize,e=this.innerH/this.rectBaseSize,t=(this.innerW+i*this.rectBaseSize*2)/this.rectBaseSize,r=Math.max(this._fitPaddingY/this._canvasScale,(this.outerH-this.innerH*this._canvasScale)/2/this._canvasScale)/this.rectBaseSize;this.rectangles.left.scale.x=this.rectangles.right.scale.x=i,this.rectangles.left.scale.y=this.rectangles.right.scale.y=e,this.rectangles.top.scale.x=this.rectangles.bottom.scale.x=t,this.rectangles.top.scale.y=this.rectangles.bottom.scale.y=r,BFN.MainUI&&BFN.MainUI.requestRender()};Vi.prototype.createRect=function(i,e,t,r){let a=new PIXI.Sprite(PIXI.RenderTexture.create(t,r));return a.anchor.x=Math.max(0,Math.min(1,Math.abs(i/t))),a.anchor.y=Math.max(0,Math.min(1,Math.abs(e/r))),a.texture.fillColor(this._color,1),a.alpha=this._opacity,this.addChild(a),a};Object.defineProperty(Vi.prototype,"canvasScale",{set:function(i){this._canvasScale=i,this.updateDisplay()},get:function(){return this._canvasScale}});Object.defineProperty(Vi.prototype,"color",{set:function(i){if(typeof i=="number"){this._color=Math.max(0,Math.min(16777215,i));for(let e in this.rectangles)this.rectangles[e].texture.fillColor(this._color,1);BFN.MainUI.requestRender()}},get:function(){return this._color}});Object.defineProperty(Vi.prototype,"opacity",{set:function(i){this._opacity=Math.max(0,Math.min(1,i));for(let e in this.rectangles){let t=this.rectangles[e];t.alpha=this._opacity}BFN.MainUI.requestRender()},get:function(){return this._opacity}});BFN.CanvasFrame=Vi;function ji(i=0,e=.5){PIXI.Container.call(this),BFN.EventDispatcher.call(this),this._color=Math.max(0,Math.min(16777215,i)),this._opacity=Math.max(0,Math.min(1,e)),this.init()}ji.prototype=window.azrc.extend(Object.create(PIXI.Container.prototype),Object.create(BFN.EventDispatcher.prototype));ji.prototype.init=function(){BeFunky.log("CanvasGlow Init"),this.initDefaultValues(),this.initGlowTexture(),this.initSprites(),this.setDimensions(0,0)};ji.prototype.initDefaultValues=function(){this.interactive=this.interactiveChildren=!1,this.spriteSize=24,this.blurAmount=12,this._canvasScale=1,BFN.TransformItemIsolator.isolationAnimator.addEventListener(BFN.AnimatorEvents.UPDATE.type,()=>{this.alpha=Math.max(0,1-BFN.TransformItemIsolator.isolationAnimator.animationFactor*4)})};ji.prototype.initGlowTexture=function(){BFN.CanvasGlowTexture||(BFN.CanvasGlowTexture=PIXI.RenderTexture.create(this.spriteSize*3,this.spriteSize*3),BFN.CanvasGlowTexture.clear(),setTimeout(()=>{let i=PIXI.RenderTexture.create(BFN.CanvasGlowTexture.width,BFN.CanvasGlowTexture.height);i.clear(),i.fillRect(this.spriteSize,this.spriteSize,this.spriteSize,this.spriteSize,16777215,1);let e=new PIXI.Sprite(i);try{let t=new BFN.filters.DirectionalBlurFilter;t.blendAlpha=!0,t.iterations=4,t.biDirectional=!0,t.amount=this.blurAmount/this.spriteSize,t.setDimensions(i.width,i.height,this.spriteSize),e.filters=[t],BFN.Stage.render(e,BFN.CanvasGlowTexture)}catch(t){BeFunky.throwError("Failed to Generate CanvasGlowTexture - User will not see Canvas Shadow:",t)}i.destroyGC(!0),e.destroy(!0),BFN.MainUI.requestRender()},500)),this.glowTexture=BFN.CanvasGlowTexture};ji.prototype.initSprites=function(){this.sprites=[];for(let i=0;i<3;i++)for(let e=0;e<3;e++){if(i===1&&e===1)continue;let t=new PIXI.Sprite(new PIXI.Texture(this.glowTexture.baseTexture));t.pluginName="blend_picture",t.anchor.x=i/2,t.anchor.y=e/2,t.alpha=this._opacity,t.texture.frame=new PIXI.Rectangle(this.spriteSize*(2-i),this.spriteSize*(2-e),this.spriteSize,this.spriteSize),t.fillColor=this._color,t.intensity=1,this.addChild(t),this.sprites.push(t)}};ji.prototype.setDimensions=function(i,e){this._width===i&&this._height===e||(this._width=i,this._height=e,this.updateDisplay())};ji.prototype.updateDisplay=function(){for(let i=0;i<this.sprites.length;i++){let e=this.sprites[i];e.visible=this._width>0&&this._height>0,!!e.visible&&(e.x=this._width/2*Math.round((.5-e.anchor.x)/.5),e.y=this._height/2*Math.round((.5-e.anchor.y)/.5),e.scale.x=1/this._canvasScale,e.scale.y=1/this._canvasScale,Math.round(e.anchor.x*2)===1&&(e.scale.x=this._width/this.spriteSize),Math.round(e.anchor.y*2)===1&&(e.scale.y=this._height/this.spriteSize))}BFN.MainUI&&BFN.MainUI.requestRender()};Object.defineProperty(ji.prototype,"canvasScale",{set:function(i){this._canvasScale=i,this.updateDisplay()},get:function(){return this._canvasScale}});Object.defineProperty(ji.prototype,"color",{set:function(i){typeof i=="number"&&(this._color=Math.max(0,Math.min(16777215,i)),this.sprites.forEach(e=>{e.fillColor=this._color}),BFN.MainUI.requestRender())},get:function(){return this._color}});Object.defineProperty(ji.prototype,"opacity",{set:function(i){this._opacity=Math.max(0,Math.min(1,i)),this.sprites.forEach(e=>{e.alpha=this._opacity}),BFN.MainUI.requestRender()},get:function(){return this._opacity}});BFN.CanvasGlow=ji;function tr(i=0,e=.5){PIXI.Container.call(this),this._color=i,this._opacity=e,this.init()}tr.prototype=Object.create(PIXI.Container.prototype);tr.prototype.init=function(){BeFunky.log("WindowedVeil Init"),this.initDefaultValues(),this.initVeil(),this.initVeilMask(),this.update(200,200,50,50,100,100)};tr.prototype.initDefaultValues=function(){this.rectBaseSize=32,this.alphaFilter=new PIXI.filters.AlphaFilter,this.filters=[this.alphaFilter]};tr.prototype.initVeil=function(){this.veilSprite=new PIXI.Sprite(PIXI.RenderTexture.create(this.rectBaseSize,this.rectBaseSize)),this.veilSprite.texture.fillColor(this._color,this._opacity),this.veilSprite.pluginName="smooth_picture",this.addChild(this.veilSprite)};tr.prototype.initVeilMask=function(){this.veilMaskTexture=PIXI.RenderTexture.create(this.rectBaseSize,this.rectBaseSize),this.veilMaskTexture.fillColor(16777215),this.veilMaskSprite=new PIXI.Sprite(this.veilMaskTexture),this.veilMaskSprite.pluginName="blend_picture",this.veilMaskSprite.blendMode=BFN.CONST.BLEND_MODES.ALPHA,this.addChild(this.veilMaskSprite)};tr.prototype.update=function(i,e,t,r,a,s){this.outerW=i,this.outerH=e,this.innerX=t,this.innerY=r,this.innerW=a,this.innerH=s,this.updateDisplay()};tr.prototype.updateDisplay=function(){this.veilSprite.width=this.outerW,this.veilSprite.height=this.outerH,this.veilMaskSprite.x=this.innerX,this.veilMaskSprite.y=this.innerY,this.veilMaskSprite.width=this.innerW,this.veilMaskSprite.height=this.innerH,BFN.MainUI&&BFN.MainUI.requestRender()};tr.prototype.setMaskTexture=function(i=null,e=!1,t){if(i&&i.baseTexture){let r=new PIXI.Texture(i.baseTexture);r.rotate=[0,12,8,4][e+t*2],this.veilMaskTexture.resize(r.width,r.height),this.veilMaskTexture.copyPixels(r),r.destroy(!1)}else this.veilMaskTexture.resize(this.rectBaseSize,this.rectBaseSize),this.veilMaskTexture.fillColor(16777215);this.updateDisplay()};Object.defineProperty(tr.prototype,"color",{set:function(i){typeof i=="number"&&(this._color=Math.max(0,Math.min(16777215,i)),this.veilSprite.texture.fillColor(this._color,this._opacity),BFN.MainUI.requestRender())},get:function(){return this._color}});BFN.WindowedVeil=tr;function di(){PIXI.Sprite.call(this),this.init()}di.prototype=Object.create(PIXI.Sprite.prototype);di.prototype.init=function(){BeFunky.log("EyeDropper Init"),this.initDefaultValues(),this.initEyeDropper(),this.initEyeDropperMask(),this.initEyeDropperOutline(),this.initAnimator()};di.prototype.initDefaultValues=function(){this.interactive=!0,this.sourceTexture=null,this.active=!1,this.showing=!1,this.visible=!1,this.renderable=!1,this.hitArea=new PIXI.Rectangle,this.handleMainUIPreRenderBind=this.handleMainUIPreRender.bind(this)};di.prototype.initEyeDropper=function(){this.pixelSize=16,this.pixelRows=5,this.pixelCols=5,this.pixelThresholdX=Math.floor(this.pixelCols/2),this.pixelThresholdY=Math.floor(this.pixelRows/2),this.eyeDropperW=this.pixelSize*this.pixelCols,this.eyeDropperH=this.pixelSize*this.pixelRows,this.positionChanged=!1,this.offsetPoint=new PIXI.Point,this.eyeDropperContainer=new PIXI.Container,this.addChild(this.eyeDropperContainer),this.eyeDropperTexture=PIXI.RenderTexture.create(this.pixelCols,this.pixelRows,PIXI.SCALE_MODES.NEAREST),this.eyeDropperSprite=new PIXI.Sprite(this.eyeDropperTexture),this.eyeDropperSprite.anchor.x=this.eyeDropperSprite.anchor.y=.5,this.eyeDropperSprite.scale.x=this.eyeDropperSprite.scale.y=this.pixelSize,this.eyeDropperContainer.addChild(this.eyeDropperSprite),this.selectionSquare=new PIXI.Graphics,this.selectionSquare.lineStyle(3,0,.5),this.selectionSquare.drawRect(-(this.pixelSize/2),-(this.pixelSize/2),this.pixelSize,this.pixelSize),this.selectionSquare.lineStyle(2,16777215,1),this.selectionSquare.drawRect(-(this.pixelSize/2),-(this.pixelSize/2),this.pixelSize,this.pixelSize),this.eyeDropperContainer.addChild(this.selectionSquare)};di.prototype.initEyeDropperMask=function(){this.maskTexture=PIXI.RenderTexture.create(this.eyeDropperW,this.eyeDropperH,PIXI.settings.SCALE_MODE,window.bfn_resolution),BFN.graphics.drawShape("roundedRect",this.maskTexture,{strokeWidth:0,strokeColor:0,fillColor:4294967295,cornerRadius:Math.min(this.eyeDropperW,this.eyeDropperH)/2,paddingX:4,paddingY:4,clear:!0}),this.maskSprite=new PIXI.Sprite(this.maskTexture),this.maskSprite.anchor.x=this.maskSprite.anchor.y=.5,this.eyeDropperContainer.addChild(this.maskSprite),this.eyeDropperSprite.mask=this.maskSprite};di.prototype.initEyeDropperOutline=function(){this.outlineTexture=PIXI.RenderTexture.create(this.eyeDropperW,this.eyeDropperH,PIXI.settings.SCALE_MODE,window.bfn_resolution),BFN.graphics.drawShape("roundedRect",this.outlineTexture,{strokeWidth:4,strokeColor:2147483648,fillColor:0,cornerRadius:Math.min(this.eyeDropperW,this.eyeDropperH)/2,paddingX:2,paddingY:2,clear:!0}),BFN.graphics.drawShape("roundedRect",this.outlineTexture,{strokeWidth:2,strokeColor:4294967295,fillColor:0,cornerRadius:Math.min(this.eyeDropperW,this.eyeDropperH)/2,paddingX:3,paddingY:3,clear:!1}),this.outlineSprite=new PIXI.Sprite(this.outlineTexture),this.outlineSprite.anchor.x=this.outlineSprite.anchor.y=.5,this.eyeDropperContainer.addChild(this.outlineSprite)};di.prototype.initAnimator=function(){this.animator=new BFN.Animator,this.animator.linearSteps=10,this.animator.addEventListener(BFN.AnimatorEvents.UPDATE.type,this.handleAnimatorUpdate.bind(this)),this.animator.setAnimatorFactor(0)};di.prototype.activate=function(i,e,t){this.active||(this.active=!0,this.reset(),BFN.MainUI.addEventListener(BFN.MainUIEvents.PRE_RENDER.type,this.handleMainUIPreRenderBind),this.sourceTexture=i,this.eyeDropperContainer.x=e,this.eyeDropperContainer.y=t,this.positionChanged=!0,this.updateHitArea(),this.animator.setAnimatorFactor(0),BFN.MainUI.requestRender())};di.prototype.update=function(i,e){this.showing||(this.showing=!0,this.animator.increase()),this.eyeDropperContainer.x=i,this.eyeDropperContainer.y=e,this.positionChanged=!0,BFN.MainUI.requestRender()};di.prototype.deactivate=function(){!this.active||(this.active=!1,this.handleMainUIPreRender(),this.animator.setAnimatorFactor(1),this.animator.decrease(),this.reset())};di.prototype.reset=function(){BFN.MainUI.removeEventListener(BFN.MainUIEvents.PRE_RENDER.type,this.handleMainUIPreRenderBind),this.showing=!1;try{this.sourceTexture.destroyGC(!0)}catch(i){}this.sourceTexture=null};di.prototype.updateHitArea=function(){this.hitArea.width=BFN.StageModel.stageW,this.hitArea.height=BFN.StageModel.stageH};di.prototype.handleMainUIPreRender=function(){if(this.positionChanged){this.positionChanged=!1;let i=this.eyeDropperSprite.x<=this.pixelThresholdX||this.eyeDropperSprite.x>=this.sourceTexture.width-this.pixelThresholdX||this.eyeDropperSprite.y<=this.pixelThresholdY||this.eyeDropperSprite.y>=this.sourceTexture.height-this.pixelThresholdY;i&&this.eyeDropperTexture.fillColor(ht().hex),this.offsetPoint.x=this.pixelThresholdX-this.eyeDropperContainer.x,this.offsetPoint.y=this.pixelThresholdY-this.eyeDropperContainer.y,this.eyeDropperTexture.copyPixels(this.sourceTexture,this.offsetPoint,!i)}};di.prototype.handleAnimatorUpdate=function(){this.visible=this.active,this.renderable=this.animator.animationFactor>0,this.eyeDropperContainer.alpha=this.animator.animationFactor,this.eyeDropperContainer.scale.x=this.eyeDropperContainer.scale.y=1.2-this.animator.animationFactor*.2};Object.defineProperty(BFN,"EyeDropper",{get(){return BFN._EyeDropper||(BFN._EyeDropper=new di,BFN.MainUI.eyeDropperContainer.addChild(BFN._EyeDropper)),BFN._EyeDropper}});function mi(){PIXI.Sprite.call(this),this.init()}mi.prototype=Object.create(PIXI.Sprite.prototype);mi.prototype.init=function(){BeFunky.log("BrushCircle Init"),this.initDefaultValues(),this.initBrushGraphic(),this.initBrushSprite(),this.initAnimator()};mi.prototype.initDefaultValues=function(){this.visible=!1,this.showing=!1,this._radius=0,this._targetEnabled=!1,this._locked=!1,this.strokeWidth=2,this.strokeShadowWidth=.5,this.handleMouseMoveBind=this.handleMouseMove.bind(this)};mi.prototype.initBrushGraphic=function(){this.brushGraphic=new PIXI.Graphics,this.brushGraphic.boundsPadding=2};mi.prototype.initBrushSprite=function(){this.brushSpriteTexture=PIXI.RenderTexture.create(32,32,PIXI.settings.SCALE_MODE,window.bfn_resolution),this.brushSprite=new PIXI.Sprite(this.brushSpriteTexture),this.brushSprite.anchor.x=this.brushSprite.anchor.y=.5,this.addChild(this.brushSprite)};mi.prototype.initAnimator=function(){this.animator=new BFN.Animator,this.animator.addEventListener(BFN.AnimatorEvents.UPDATE.type,this.handleAnimatorUpdate.bind(this)),this.animator.setAnimatorFactor(0)};mi.prototype.show=function(i,e=null,t=!1){this._locked=this._locked||t,document.body.setStyles({cursor:"none"}),this.showing=!0,BFN.MainUI.on("pointermove",this.handleMouseMoveBind),i!=null&&this._radius!=Math.max(1,Math.round(i))&&(this._radius=Math.max(1,Math.round(i)),this.updateCircle()),this.animator.increase(),this.updatePosition(e)};mi.prototype.hide=function(i=!1){this._locked=i?!1:this._locked,!this._locked&&(document.body.setStyles({cursor:"auto"}),this.showing=!1,BFN.MainUI.off("pointermove",this.handleMouseMoveBind),this.animator.decrease())};mi.prototype.updateCircle=function(){let i=Math.round((this._radius+this.strokeWidth/2+this.strokeShadowWidth)*2);if(this.brushSprite.texture.resize(i,i),BFN.graphics.drawShape("ellipse",this.brushSprite.texture,{strokeWidth:this.strokeWidth+this.strokeShadowWidth*2,strokeColor:2147483648}),this._targetEnabled){let e=this.strokeWidth+this.strokeShadowWidth*2,t=i/2-this.strokeWidth/2-this.strokeShadowWidth-1;BFN.graphics.drawShape("roundedRect",this.brushSprite.texture,{fillColor:2147483648,paddingX:e,paddingY:t,clear:!1}),BFN.graphics.drawShape("roundedRect",this.brushSprite.texture,{fillColor:2147483648,paddingX:t,paddingY:e,clear:!1})}if(BFN.graphics.drawShape("ellipse",this.brushSprite.texture,{strokeWidth:this.strokeWidth,strokeColor:4294967295,paddingX:this.strokeShadowWidth,paddingY:this.strokeShadowWidth,clear:!1}),this._targetEnabled){let e=this.strokeWidth+this.strokeShadowWidth,t=i/2-this.strokeWidth/2-1;BFN.graphics.drawShape("roundedRect",this.brushSprite.texture,{fillColor:4294967295,paddingX:e,paddingY:t,clear:!1}),BFN.graphics.drawShape("roundedRect",this.brushSprite.texture,{fillColor:4294967295,paddingX:t,paddingY:e,clear:!1})}BFN.MainUI.requestRender()};mi.prototype.updatePosition=function(i=null){let e=i?i.data.getLocalPosition(BFN.MainUI):BFN.MainUI.getMousePosition();this.x=e.x,this.y=e.y,BFN.MainUI.requestRender()};mi.prototype.handleMouseMove=function(i){this.updatePosition(i)};mi.prototype.handleAnimatorUpdate=function(i){this.alpha=this.animator.animationFactor,this.visible=this.alpha>0};Object.defineProperty(mi.prototype,"targetEnabled",{set:function(i){this._targetEnabled!=i&&(this._targetEnabled=i,this.updateCircle())},get:function(){return this._targetEnabled}});Object.defineProperty(mi.prototype,"radius",{set:function(i){let e=Math.max(1,Math.round(i));this._radius!=e&&(this._radius=Math.round(e),this.updateCircle())},get:function(){return this._radius}});BFN.SingletonQueue.add(function(){BFN.BrushCircle=new mi});function Er(){PIXI.Sprite.call(this),this.init()}Er.prototype=Object.create(PIXI.Sprite.prototype);Er.prototype.init=function(){BeFunky.log("BrushCirclePreview Init"),this.initDefaultValues(),this.initAnimator()};Er.prototype.initDefaultValues=function(){this._radius=0,this.strokeWidth=2,this.strokeShadowWidth=.5,this.texture=PIXI.RenderTexture.create(32,32,PIXI.settings.SCALE_MODE,window.bfn_resolution),this.texture.clear(),this.anchor.x=this.anchor.y=.5};Er.prototype.initAnimator=function(){this.animator=new BFN.Animator,this.animator.addEventListener(BFN.AnimatorEvents.UPDATE.type,this.handleAnimatorUpdate.bind(this)),this.animator.setAnimatorFactor(0)};Er.prototype.show=function(i){if(this.visible||(this.x=BFN.StageModel.stageW/2,this.y=BFN.StageModel.stageH/2,this.animator.increase()),this._radius!=Math.max(1,Math.round(i))){this._radius=Math.max(1,Math.round(i));let e=Math.round((this._radius+this.strokeWidth/2+this.strokeShadowWidth)*2);this.texture.resize(e,e),BFN.graphics.drawShape("ellipse",this.texture,{strokeWidth:this.strokeWidth+this.strokeShadowWidth*2,strokeColor:2147483648}),BFN.graphics.drawShape("ellipse",this.texture,{strokeWidth:this.strokeWidth,strokeColor:4294967295,clear:!1,paddingX:this.strokeShadowWidth,paddingY:this.strokeShadowWidth}),BFN.MainUI.requestRender()}};Er.prototype.hide=function(){this.animator.decrease()};Er.prototype.handleAnimatorUpdate=function(i){this.alpha=this.animator.animationFactor,this.visible=this.alpha>0};BFN.SingletonQueue.add(function(){BFN.BrushCirclePreview=new Er});function Ti(i=!1,e=!1,t=1,r=!1,a=4294967295,s=4278190080,o=null){PIXI.Sprite.call(this),this.dashed=i,this.smoothPadding=e,this.lineThickness=t,this.isLinear=r,this.lighterColor=a,this.darkerColor=s,this.uniqueTextureID=o,this.isRuler=!1,this.init()}Ti.prototype=Object.create(PIXI.Sprite.prototype);Ti.prototype.init=function(){BeFunky.log("StrokeLine Init"),this.initDefaultValues(),this.initLineSprite()};Ti.prototype.initDefaultValues=function(){this._scale=1,this._adjustScaleX=1,this._adjustScaleY=1,this._length=1,this._highlight=!1,this.smoothPaddingAmount=10};Ti.prototype.initLineSprite=function(){this.uniqueTextureID&&(BFN.uniqueStrokeLineTextures||(BFN.uniqueStrokeLineTextures={})),this.uniqueTextureID&&BFN.uniqueStrokeLineTextures.hasOwnProperty(this.uniqueTextureID)&&(this.strokeLineTexture=BFN.uniqueStrokeLineTextures[this.uniqueTextureID]),this.strokeLineTexture||(this.dashed?(this.strokeLineTexture=PIXI.RenderTexture.create(8,this.lineThickness+(this.smoothPadding?this.smoothPaddingAmount:0),this.isLinear?PIXI.SCALE_MODES.LINEAR:PIXI.SCALE_MODES.NEAREST,window.bfn_resolution),BFN.graphics.drawShape("roundedRect",this.strokeLineTexture,{fillColor:this.darkerColor,edgePadding:0,paddingY:this.smoothPadding?this.smoothPaddingAmount/2:0,cornerRadius:0,clear:!0,paddingR:4}),BFN.graphics.drawShape("roundedRect",this.strokeLineTexture,{fillColor:this.lighterColor,edgePadding:0,paddingY:this.smoothPadding?this.smoothPaddingAmount/2:0,cornerRadius:0,clear:!1,paddingL:4})):(this.strokeLineTexture=PIXI.RenderTexture.create(8,this.lineThickness+(this.smoothPadding?this.smoothPaddingAmount:0),this.isLinear?PIXI.SCALE_MODES.LINEAR:PIXI.SCALE_MODES.NEAREST,window.bfn_resolution),BFN.graphics.drawShape("roundedRect",this.strokeLineTexture,{fillColor:this.lighterColor,edgePadding:0,paddingY:this.smoothPadding?this.smoothPaddingAmount/2:0,cornerRadius:0})),this.uniqueTextureID&&(BFN.uniqueStrokeLineTextures[this.uniqueTextureID]=this.strokeLineTexture)),this.strokeLine=new PIXI.extras.TilingSprite(this.strokeLineTexture,2,this.lineThickness+(this.smoothPadding?this.smoothPaddingAmount:0)),this.strokeLine.anchor.y=.5,this.strokeLine.y=-.001,this.addChild(this.strokeLine)};Ti.prototype.convertToMasked=function(){this.isMasked||(this.isMasked=!0,this.strokeLineMask=new PIXI.Graphics,this.strokeLine.mask=this.strokeLineMask,this.addChild(this.strokeLineMask),this.strokeLineMaskH=Math.ceil(this.strokeLineTexture.height/2)*2)};Ti.prototype.showMaskedLines=function(i=null){if(!!this.isMasked){if(this.maskedSegmentsClear||(this.strokeLineMask.clear(),this.maskedSegmentsClear=!0),!i){this.strokeLine.mask=null;return}this.strokeLine.mask=this.strokeLineMask,i.forEach(e=>{this.maskedSegmentsClear&&(this.maskedSegmentsClear=!1);let t=e.start,r=e.end;t<r&&(this.strokeLineMask.beginFill(16777215),this.strokeLineMask.drawRect(t,-(this.strokeLineMaskH/2),r-t,this.strokeLineMaskH),this.strokeLineMask.endFill())})}};Ti.prototype.convertToRuler=function(){this.isRuler||(this.isRuler=!0,this.isRulerClear=!0,this.uniqueTextureID&&BFN.uniqueStrokeLineTextures.hasOwnProperty(this.uniqueTextureID+"_ruler")&&(this.rulerTexture=BFN.uniqueStrokeLineTextures[this.uniqueTextureID+"_ruler"]),this.rulerTexture||(this.rulerTexture=PIXI.RenderTexture.create(8,this.lineThickness+(this.smoothPadding?this.smoothPaddingAmount:0),this.isLinear?PIXI.SCALE_MODES.LINEAR:PIXI.SCALE_MODES.NEAREST),BFN.graphics.drawShape("roundedRect",this.rulerTexture,{fillColor:4294902015,edgePadding:0,paddingY:this.smoothPadding?this.smoothPaddingAmount/2:0,cornerRadius:0}),this.uniqueTextureID&&(BFN.uniqueStrokeLineTextures[this.uniqueTextureID+"_ruler"]=this.rulerTexture)),this.rulerLine=new PIXI.extras.TilingSprite(this.rulerTexture,2,this.lineThickness+(this.smoothPadding?this.smoothPaddingAmount:0)),this.rulerLine.anchor.y=.5,this.addChild(this.rulerLine),this.rulerMask=new PIXI.Graphics,this.rulerLine.mask=this.rulerMask,this.addChild(this.rulerMask),this.rulerMaskH=Math.ceil(this.rulerTexture.height/2)*2)};Ti.prototype.showRulers=function(i=null){!this.isRuler||(this.isRulerClear||(this.rulerMask.clear(),this.isRulerClear=!0),!!i&&i.forEach(e=>{if(e&&e.hasOwnProperty("start")&&e.hasOwnProperty("end")){this.isRulerClear&&(this.isRulerClear=!1);let t=e.start,r=e.end;t<r&&(this.rulerMask.beginFill(16777215),this.rulerMask.drawRect(t,-(this.rulerMaskH/2),r-t,this.rulerMaskH),this.rulerMask.endFill())}}))};Ti.prototype.setAdjustScales=function(i,e){this._adjustScaleX=typeof i=="number"?i:this._adjustScaleX,this._adjustScaleY=typeof e=="number"?e:this._adjustScaleY};Ti.prototype.getStrokeLineHighlightTexture=function(){if(!this.strokeLineHighlightTexture)if(this.uniqueTextureID&&BFN.uniqueStrokeLineTextures.hasOwnProperty(this.uniqueTextureID+"_highlight"))this.strokeLineHighlightTexture=BFN.uniqueStrokeLineTextures[this.uniqueTextureID+"_highlight"];else{let i=3,e=1.5,t=BFN.ColorUtil.rgbaObjectToHexStringObject(BFN.ColorUtil.hexNumberToRGBAObject(this.lighterColor));this.strokeLineHighlightTexture=PIXI.RenderTexture.create(this.strokeLineTexture.width,Math.max(this.strokeLineTexture.height,this.lineThickness+i*2));let r=(this.strokeLineHighlightTexture.height-this.lineThickness)/2-i;this.strokeLineHighlightTexture.clear();for(let a=0;a<i;a++)this.strokeLineHighlightTexture.fillColorOverlap(parseInt("0x"+t.hex),Math.max(0,Math.min(1,t.alpha*(.05+e/20*a))),0,r+a,this.strokeLineHighlightTexture.width,this.lineThickness+(i-a)*2);this.strokeLineHighlightTexture.copyPixels(this.strokeLineTexture,{x:0,y:(this.strokeLineHighlightTexture.height-this.strokeLineTexture.height)/2},!1),this.uniqueTextureID&&(BFN.uniqueStrokeLineTextures[this.uniqueTextureID+"_highlight"]=this.strokeLineHighlightTexture)}return this.strokeLineHighlightTexture};Object.defineProperty(Ti.prototype,"length",{set:function(i){this._length=i,this.strokeLine.width=this._length*this._scale*this._adjustScaleX,this.isRuler&&(this.strokeLine.width=this.strokeLine.width);try{BFN.MainUI.requestRender()}catch(e){}},get:function(){return this.strokeLine.width}});Object.defineProperty(Ti.prototype,"scale",{set:function(i){this._scale=i,this.strokeLine.width=this._length*this._scale*this._adjustScaleX,this.strokeLine.scale.x=1/(this._scale*this._adjustScaleX),this.strokeLine.scale.y=1/(this._scale*this._adjustScaleY),this.isMasked&&(this.strokeLineMask.scale.x=this.strokeLine.scale.x,this.strokeLineMask.scale.y=this.strokeLine.scale.y),this.isRuler&&(this.rulerLine.width=this.strokeLine.width,this.rulerLine.scale.x=this.strokeLine.scale.x,this.rulerLine.scale.y=this.strokeLine.scale.y,this.rulerMask.scale.x=this.strokeLine.scale.x,this.rulerMask.scale.y=this.strokeLine.scale.y);try{BFN.MainUI.requestRender()}catch(e){}},get:function(){return this._scale}});Object.defineProperty(Ti.prototype,"highlight",{set:function(i){if(this._highlight!=!!i){this._highlight=!!i,this._highlight?this.strokeLine.texture=this.getStrokeLineHighlightTexture():this.strokeLine.texture!=this.strokeLineTexture&&(this.strokeLine.texture=this.strokeLineTexture);try{BFN.MainUI.requestRender()}catch(e){}}},get:function(){return this._highlight}});BFN.StrokeLine=Ti;function Ei(i=!1,e=!1,t=1,r=!1,a=4294967295,s=4278190080,o=null){PIXI.Sprite.call(this),this.dashed=i,this.smoothPadding=e,this.lineThickness=t,this.isLinear=r,this.lighterColor=a,this.darkerColor=s,this.uniqueTextureID=o,this.init()}Ei.prototype=Object.create(PIXI.Sprite.prototype);Ei.prototype.init=function(){BeFunky.log("StrokeRectangle Init"),this.initDefaultValues(),this.initStrokeLines(),this.updateDisplay()};Ei.prototype.initDefaultValues=function(){this._width=100,this._height=100,this._scale=1,this._adjustScaleX=1,this._adjustScaleY=1,this._invertScales=!1,this._highlight=!1};Ei.prototype.initStrokeLines=function(){this.strokeLineTop=new BFN.StrokeLine(this.dashed,this.smoothPadding,this.lineThickness,this.isLinear,this.lighterColor,this.darkerColor,this.uniqueTextureID),this.strokeLineTop.rotation=Math.PI*0,this.addChild(this.strokeLineTop),this.strokeLineRight=new BFN.StrokeLine(this.dashed,this.smoothPadding,this.lineThickness,this.isLinear,this.lighterColor,this.darkerColor,this.uniqueTextureID),this.strokeLineRight.rotation=Math.PI*.5,this.addChild(this.strokeLineRight),this.strokeLineBottom=new BFN.StrokeLine(this.dashed,this.smoothPadding,this.lineThickness,this.isLinear,this.lighterColor,this.darkerColor,this.uniqueTextureID),this.strokeLineBottom.rotation=Math.PI*1,this.addChild(this.strokeLineBottom),this.strokeLineLeft=new BFN.StrokeLine(this.dashed,this.smoothPadding,this.lineThickness,this.isLinear,this.lighterColor,this.darkerColor,this.uniqueTextureID),this.strokeLineLeft.rotation=Math.PI*1.5,this.addChild(this.strokeLineLeft)};Ei.prototype.setDimensions=function(i,e,t=null,r=null,a=null){this._width=Math.abs(i),this._height=Math.abs(e),this.setScales(t,r,a,!1),this.updateDisplay()};Ei.prototype.setScales=function(i,e,t,r=!0){this._scale=typeof i=="number"?i:this._scale,this._adjustScaleX=typeof e=="number"?e:this._adjustScaleX,this._adjustScaleY=typeof t=="number"?t:this._adjustScaleY;let a=this._invertScales?this._adjustScaleY:this._adjustScaleX,s=this._invertScales?this._adjustScaleX:this._adjustScaleY;this.strokeLineTop.setAdjustScales(a,s),this.strokeLineTop.scale=this._scale,this.strokeLineRight.setAdjustScales(s,a),this.strokeLineRight.scale=this._scale,this.strokeLineBottom.setAdjustScales(a,s),this.strokeLineBottom.scale=this._scale,this.strokeLineLeft.setAdjustScales(s,a),this.strokeLineLeft.scale=this._scale,r&&this.updateDisplay()};Ei.prototype.updateDisplay=function(){this.strokeLineTop.x=-(this._width/2),this.strokeLineTop.y=-(this._height/2),this.strokeLineTop.length=this._width,this.strokeLineRight.x=this._width/2,this.strokeLineRight.y=-(this._height/2),this.strokeLineRight.length=this._height,this.strokeLineBottom.x=this._width/2,this.strokeLineBottom.y=this._height/2,this.strokeLineBottom.length=this._width,this.strokeLineLeft.x=-(this._width/2),this.strokeLineLeft.y=this._height/2,this.strokeLineLeft.length=this._height};Object.defineProperty(Ei.prototype,"scale",{set:function(i){this.setScales(i)},get:function(){return this._scale}});Object.defineProperty(Ei.prototype,"invertScales",{set:function(i){this._invertScales=!!i},get:function(){return this._invertScales}});Object.defineProperty(Ei.prototype,"width",{get:function(){return this._width}});Object.defineProperty(Ei.prototype,"height",{get:function(){return this._height}});Object.defineProperty(Ei.prototype,"highlight",{set:function(i){this._highlight!=!!i&&(this._highlight=!!i,this.strokeLineLeft.highlight=this._highlight,this.strokeLineRight.highlight=this._highlight,this.strokeLineTop.highlight=this._highlight,this.strokeLineBottom.highlight=this._highlight)},get:function(){return this._highlight}});BFN.StrokeRectangle=Ei;function ir(i=!1,e=!1,t=1,r=!1,a=4294967295,s=4278190080,o=null){PIXI.Container.call(this),this.dashed=i,this.smoothPadding=e,this.lineThickness=t,this.isLinear=r,this.lighterColor=a,this.darkerColor=s,this.uniqueTextureID=o,this.init()}ir.prototype=Object.create(PIXI.Container.prototype);ir.prototype.init=function(){BeFunky.log("StrokeRectanglePool Init"),this.initDefaultValues()};ir.prototype.initDefaultValues=function(){this.interactive=!1,this.strokeRectangles=[],this.strokeRectangleIndex=0,this._scale=1,this._adjustScaleX=1,this._adjustScaleY=1};ir.prototype.add=function(i=0,e=0,t=128,r=128,a=0,s=!1){let o=this.strokeRectangleIndex>=this.strokeRectangles.length?this.createStrokeRectangle():this.strokeRectangles[this.strokeRectangleIndex];return o.invertScales=s,this.setTransform(o,i,e,t,r,a),this.addChild(o),this.strokeRectangleIndex++,BFN.MainUI.requestRender(),o};ir.prototype.setTransform=function(i,e=0,t=0,r=128,a=128,s=0){if(!i)return;let o=Math.sqrt(Math.pow(r,2)+Math.pow(a,2)),n=Math.atan2(a,r);i.x=e+Math.cos(s+n)*(o/2),i.y=t+Math.sin(s+n)*(o/2),i.setDimensions(r,a,this._scale,this._adjustScaleX,this._adjustScaleY),i.rotation=s};ir.prototype.clear=function(){for(this.strokeRectangleIndex=0;this.children.length;)this.removeChild(this.children[0]);BFN.MainUI.requestRender()};ir.prototype.setScales=function(i,e,t){this._scale=typeof i=="number"?i:this._scale,this._adjustScaleX=typeof e=="number"?e:this._adjustScaleX,this._adjustScaleY=typeof t=="number"?t:this._adjustScaleY,this.children.forEach(r=>{r.setScales(this._scale,this._adjustScaleX,this._adjustScaleY)})};ir.prototype.createStrokeRectangle=function(){let i=new BFN.StrokeRectangle(this.dashed,this.smoothPadding,this.lineThickness,this.isLinear,this.lighterColor,this.darkerColor,this.uniqueTextureID);return this.strokeRectangles.push(i),i};Object.defineProperty(ir.prototype,"poolScale",{set:function(i){this.setScales(i)},get:function(){return this._scale}});BFN.StrokeRectanglePool=ir;function xr(){PIXI.Sprite.call(this),this.init()}xr.prototype=Object.create(PIXI.Sprite.prototype);xr.prototype.init=function(){BeFunky.log("CropGrid Init"),this.initDefaultValues(),this.initOutline(),this.initGridLines(),this.updateDisplay(),this.outlineFilter=new BFN.filters.OutlineFilter(1,0),this.filters=[this.outlineFilter]};xr.prototype.initDefaultValues=function(){this._width=100,this._height=100,this._scale=1};xr.prototype.initOutline=function(){this.outline=new BFN.StrokeRectangle,this.addChild(this.outline)};xr.prototype.initGridLines=function(){this.gridLineTop=new BFN.StrokeLine,this.gridLineTop.rotation=Math.PI*0,this.addChild(this.gridLineTop),this.gridLineRight=new BFN.StrokeLine,this.gridLineRight.rotation=Math.PI*.5,this.addChild(this.gridLineRight),this.gridLineBottom=new BFN.StrokeLine,this.gridLineBottom.rotation=Math.PI*1,this.addChild(this.gridLineBottom),this.gridLineLeft=new BFN.StrokeLine,this.gridLineLeft.rotation=Math.PI*1.5,this.addChild(this.gridLineLeft)};xr.prototype.setDimensions=function(i,e){this._width=Math.abs(i),this._height=Math.abs(e),this.updateDisplay()};xr.prototype.updateDisplay=function(){this.outline.setDimensions(this._width,this._height),this.gridLineTop.x=-(this._width/2),this.gridLineTop.y=-(this._height/6),this.gridLineTop.length=this._width,this.gridLineRight.x=this._width/6,this.gridLineRight.y=-(this._height/2),this.gridLineRight.length=this._height,this.gridLineBottom.x=this._width/2,this.gridLineBottom.y=this._height/6,this.gridLineBottom.length=this._width,this.gridLineLeft.x=-(this._width/6),this.gridLineLeft.y=this._height/2,this.gridLineLeft.length=this._height};Object.defineProperty(xr.prototype,"scale",{set:function(i){this._scale=i,this.outline.scale=this._scale,this.gridLineTop.scale=this._scale,this.gridLineRight.scale=this._scale,this.gridLineBottom.scale=this._scale,this.gridLineLeft.scale=this._scale,this.updateDisplay(),BFN.MainUI.requestRender()},get:function(){return this._scale}});BFN.CropGrid=xr;function Ui(){PIXI.Container.call(this),this.init()}Ui.prototype=Object.create(PIXI.Container.prototype);Ui.prototype.init=function(){BeFunky.log("CheckerPanel Init"),this.initDefaultValues(),this.initCheckerTexture(),this.initCheckerSprite()};Ui.prototype.initDefaultValues=function(){this.interactive=!1,this.checkerSize=8,this.checkerColorA=14474460,this.checkerColorB=16777215,this._centered=!0,this._width=20,this._height=20,this._scale=1};Ui.prototype.initCheckerTexture=function(){this.checkerTexture=PIXI.RenderTexture.create(this.checkerSize*2,this.checkerSize*2),this.checkerTexture.fillRect(0,0,this.checkerSize*2,this.checkerSize*2,this.checkerColorA,1),this.checkerTexture.fillRect(0,0,this.checkerSize,this.checkerSize,this.checkerColorB,1),this.checkerTexture.fillRect(this.checkerSize,this.checkerSize,this.checkerSize,this.checkerSize,this.checkerColorB,1),this.checkerTexture.setScaleMode(PIXI.SCALE_MODES.NEAREST)};Ui.prototype.initCheckerSprite=function(){this.checkerSprite=new PIXI.extras.TilingSprite(this.checkerTexture,this.checkerSize*2,this.checkerSize*2),this.checkerSprite.interactive=!1,this.addChild(this.checkerSprite)};Ui.prototype.setDimensions=function(i,e){this._width=Math.abs(i),this._height=Math.abs(e),this.updateDisplay()};Ui.prototype.updateDisplay=function(){this.checkerSprite.anchor.x=this.checkerSprite.anchor.y=this._centered?.5:0,this.checkerSprite.scale.x=this.checkerSprite.scale.y=1/this._scale,this.checkerSprite.width=Math.max(0,this._width/this.checkerSprite.scale.x-1),this.checkerSprite.height=Math.max(0,this._height/this.checkerSprite.scale.y-1);try{BFN.MainUI.requestRender()}catch(i){}};Object.defineProperty(Ui.prototype,"centered",{set:function(i){this._centered=i,this.updateDisplay()},get:function(){return this._centered}});Object.defineProperty(Ui.prototype,"width",{set:function(i){this._width=Math.abs(i),this.updateDisplay()},get:function(){return this._width}});Object.defineProperty(Ui.prototype,"height",{set:function(i){this._height=Math.abs(i),this.updateDisplay()},get:function(){return this._height}});Object.defineProperty(Ui.prototype,"scale",{set:function(i){this._scale=i,this.updateDisplay()},get:function(){return this._scale}});BFN.CheckerPanel=Ui;function Fi(i=!0){PIXI.Sprite.call(this),this.autoRender=i,this.init()}Fi.prototype=Object.create(PIXI.Sprite.prototype);Fi.prototype.init=function(){BeFunky.log("BlendModeSprite Init"),this.initDefaultValues(),this.initSourceSprite(),this.initBlendFilters(),BFN.AppModel.appReady?(BFN.MainUI.addEventListener(BFN.MainUIEvents.PRE_RENDER.type,this.handleMainUIPreRender.bind(this)),this.setBlendMode(BFN.CONST.BLEND_MODES.NORMAL)):BFN.AppModel.addEventListener(BFN.AppModelEvents.APP_READY.type,function(i){BFN.MainUI.addEventListener(BFN.MainUIEvents.PRE_RENDER.type,this.handleMainUIPreRender.bind(this)),this.setBlendMode(BFN.CONST.BLEND_MODES.NORMAL)}.bind(this))};Fi.prototype.initDefaultValues=function(){this._intensity=1,this.texture=null,this.renderPending=!1};Fi.prototype.initSourceSprite=function(){this.sourceSprite=new PIXI.Sprite};Fi.prototype.initBlendFilters=function(){this.blendFilters={};for(let i in BFN.CONST.BLEND_MODES)this.blendFilters[BFN.CONST.BLEND_MODES[i]]=new BFN.filters.BlendModeFilter(BFN.CONST.BLEND_MODES[i])};Fi.prototype.setBlendMode=function(i){this.blendFilters.hasOwnProperty(i)?this.sourceSprite.filters=[this.blendFilters[i]]:this.sourceSprite.filters=[],this.updateDisplay()};Fi.prototype.setBaseTexture=function(i){this.texture!=null&&(this.texture.destroyGC(!0),this.texture=null),i&&(this.sourceSprite.texture=i,this.texture=PIXI.RenderTexture.create(this.sourceSprite.texture.width,this.sourceSprite.texture.height),this.updateDisplay())};Fi.prototype.setBlendIntensity=function(i){i=Math.min(1,Math.max(0,i));for(let e in this.blendFilters)this.blendFilters[e].intensity=i;this.updateDisplay()};Fi.prototype.setBlendTexture=function(i){if(i){for(let e in this.blendFilters)this.blendFilters[e].iChannel1=i;this.updateDisplay()}};Fi.prototype.updateDisplay=function(){this.autoRender&&(this.renderPending=!0,BFN.MainUI.requestRender())};Fi.prototype.renderDisplay=function(){BFN.Stage.render(this.sourceSprite,this.texture)};Fi.prototype.handleMainUIPreRender=function(){this.renderPending&&(this.renderPending=!1,this.texture&&this.renderDisplay())};Object.defineProperty(Fi.prototype,"intensity",{set:function(i){this._intensity=Math.max(0,Math.min(1,i))},get:function(){return this._intensity}});BFN.BlendModeSprite=Fi;function zt(i=!0){PIXI.Sprite.call(this),this.autoRender=i,this.init()}zt.prototype=Object.create(PIXI.Sprite.prototype);zt.prototype.init=function(){BeFunky.log("MaskBlendSprite Init"),this.initDefaultValues()};zt.prototype.initDefaultValues=function(){this.maskBlendTexture=null,this.displayUpdatePending=!1,this.renderPending=!1,this.sourceSprite=new PIXI.Sprite,this.maskBlendFilter=new BFN.filters.MaskBlendFilter,BFN.AppModel.appReady?BFN.MainUI.addEventListener(BFN.MainUIEvents.PRE_RENDER.type,this.handleMainUIPreRender.bind(this)):BFN.AppModel.addEventListener(BFN.AppModelEvents.APP_READY.type,function(i){BFN.MainUI.addEventListener(BFN.MainUIEvents.PRE_RENDER.type,this.handleMainUIPreRender.bind(this))}.bind(this))};zt.prototype.updateDisplay=function(){this.displayUpdatePending=!0,this.autoRender&&this.maskBlendTexture&&!this.renderPending&&(this.displayUpdatePending=!1,this.renderPending=!0,BFN.MainUI.requestRender())};zt.prototype.renderDisplay=function(){this.maskBlendTexture&&BFN.Stage.render(this.sourceSprite,this.texture)};zt.prototype.reset=function(){this.displayUpdatePending=!1,this.inverse=!1,this.blendColor=null,this.blendIntensity=1,this.inputTexture=null,this.blendTexture=null,this.maskTexture=null};zt.prototype.handleMainUIPreRender=function(){this.renderPending&&(this.renderPending=!1,this.renderDisplay())};Object.defineProperty(zt.prototype,"autoRender",{set:function(i){this._autoRender=i,this._autoRender&&this.displayUpdatePending&&this.updateDisplay()},get:function(){return this._autoRender}});Object.defineProperty(zt.prototype,"inverse",{set:function(i){i!=this.maskBlendFilter.inverse&&(this.maskBlendFilter.inverse=i,this.updateDisplay())},get:function(){return this.maskBlendFilter.inverse}});Object.defineProperty(zt.prototype,"unmaskedAlpha",{set:function(i){i!=this.maskBlendFilter.unmaskedAlpha&&(this.maskBlendFilter.unmaskedAlpha=i,this.updateDisplay())},get:function(){return this.maskBlendFilter.unmaskedAlpha}});Object.defineProperty(zt.prototype,"blendColor",{set:function(i){i!=this.maskBlendFilter.blendColor&&(this.maskBlendFilter.blendColor=i,this.updateDisplay())},get:function(){return this.maskBlendFilter.blendColor}});Object.defineProperty(zt.prototype,"blendIntensity",{set:function(i){i!=this.maskBlendFilter.blendIntensity&&(this.maskBlendFilter.blendIntensity=i,this.updateDisplay())},get:function(){return this.maskBlendFilter.blendIntensity}});Object.defineProperty(zt.prototype,"inputTexture",{set:function(i){if(this.maskBlendTexture!==null){try{this.maskBlendTexture.destroyGC(!0)}catch(e){}this.maskBlendTexture=null,this.texture=PIXI.Texture.EMPTY}i?(this.sourceSprite.texture=i,this.sourceSprite.filters=[this.maskBlendFilter],this.maskBlendTexture=PIXI.RenderTexture.create(this.sourceSprite.texture.width,this.sourceSprite.texture.height),this.texture=this.maskBlendTexture,this.updateDisplay()):(this.sourceSprite.texture=PIXI.Texture.EMPTY,this.sourceSprite.filters=[])},get:function(){return this.sourceSprite.texture}});Object.defineProperty(zt.prototype,"blendTexture",{set:function(i){this.maskBlendFilter.blendTexture=i,this.updateDisplay()},get:function(){return this.maskBlendFilter.blendTexture}});Object.defineProperty(zt.prototype,"maskTexture",{set:function(i){this.maskBlendFilter.maskTexture=i,this.updateDisplay()},get:function(){return this.maskBlendFilter.maskTexture}});Object.defineProperty(zt.prototype,"useInputAlpha",{set:function(i){this.maskBlendFilter.useInputAlpha=i,this.updateDisplay()},get:function(){return this.maskBlendFilter.useInputAlpha}});BFN.MaskBlendSprite=zt;function je(){PIXI.Sprite.call(this),this.init()}je.prototype=Object.create(PIXI.Sprite.prototype);je.prototype.init=function(){BeFunky.log("FrameSprite Init"),this.initDefaultValues()};je.prototype.initDefaultValues=function(){this.frameSprite=this,this.rotateValues=[0,2,4,6,8,10,12,14],this._frameWidth=100,this._frameHeight=100,this._framePadding=0,this._offsetFactorX=.5,this._offsetFactorY=.5,this._textureScale=1,this._textureScaleX=1,this._textureScaleY=1,this._isEmpty=!0,this._imageRect=new PIXI.Rectangle,this.textureFrame=new PIXI.Rectangle,this.adjustScale=1,this.excessX=0,this.excessY=0,this.frameScaling=!1,this.frameStretching=!1,this.frameAnchorSide=null,this.frameAnchorPoint=new PIXI.Point,this.updateDisplayCallback=null};je.prototype.setTexture=function(i=null){this.texture=i,this.baseTexture=this.texture&&this.texture.baseTexture?this.texture.baseTexture:null,this.updateValues()};je.prototype.updateValues=function(){this.textureFrame=new PIXI.Rectangle,this.baseWidth=this.texture.baseTexture.width,this.baseHeight=this.texture.baseTexture.height};je.prototype.startFrameScaling=function(i=null,e=!1){if(["l","tl","t","tr","r","br","b","bl"].includes(i)){this.frameScalingCentered&&!e&&this.stopFrameScaling(),this.frameScaling=!0,this.frameScalingCentered=e,this.frameAnchorSide=i;let r=this._frameWidth,a=this._frameHeight,s=Math.max(r/this.baseWidth,a/this.baseHeight),o=s*this._textureScaleX,n=s*this._textureScaleY,l=this.baseWidth*o,c=this.baseHeight*n,h=l-r,u=c-a,d=h*this._offsetFactorX,m=u*this._offsetFactorY;switch(this.initialRealDimensions=new PIXI.Point(l,c),this.initialFrameCenter=new PIXI.Point((d+r/2)/this.initialRealDimensions.x*this.baseWidth,(m+a/2)/this.initialRealDimensions.y*this.baseHeight),this.frameAnchorSide){case"l":this.frameAnchorPoint.x=d,this.frameAnchorPoint.y=m+a/2;break;case"tl":this.frameAnchorPoint.x=d,this.frameAnchorPoint.y=m;break;case"t":this.frameAnchorPoint.x=d+r/2,this.frameAnchorPoint.y=m;break;case"tr":this.frameAnchorPoint.x=d+r,this.frameAnchorPoint.y=m;break;case"r":this.frameAnchorPoint.x=d+r,this.frameAnchorPoint.y=m+a/2;break;case"br":this.frameAnchorPoint.x=d+r,this.frameAnchorPoint.y=m+a;break;case"b":this.frameAnchorPoint.x=d+r/2,this.frameAnchorPoint.y=m+a;break;case"bl":this.frameAnchorPoint.x=d,this.frameAnchorPoint.y=m+a;break}}else this.stopFrameScaling()};je.prototype.stopFrameScaling=function(){this.frameAnchorSide=null,this.frameScaling&&(this.frameScaling=!1),this.frameScalingCentered&&(this.frameScalingCentered=!1)};je.prototype.startFrameStretching=function(){this.frameStretching&&this.stopFrameStretching(),this.frameStretching=!0};je.prototype.stopFrameStretching=function(){this.frameStretching=!1};je.prototype.modifyFrameBorders=function(i=0,e=!0){let t=Math.max(0,this.textureFrame.x-i),r=Math.max(0,this.textureFrame.y-i),a=Math.max(t+1,Math.min(this.baseWidth,this.textureFrame.x+this.textureFrame.width+i)),s=Math.max(t+1,Math.min(this.baseHeight,this.textureFrame.y+this.textureFrame.height+i)),o=Math.max(1,a-t),n=Math.max(1,s-r),l=Math.max(o/this.baseWidth,n/this.baseHeight),c=this.baseWidth*l,h=this.baseHeight*l;this.textureScaleX=this.baseWidth/c,this.textureScaleY=this.baseHeight/h,this.offsetFactorX=this.baseWidth==o?.5:t/(this.baseWidth-o),this.offsetFactorY=this.baseHeight==n?.5:r/(this.baseHeight-n),e&&this.updateDisplay()};je.prototype.conformOffsetFactors=function(){if(this.texture.valid)try{let i=PIXI.GroupD8.isVertical(this.texture.rotate),e=i?this._frameHeight:this._frameWidth,t=i?this._frameWidth:this._frameHeight,r=Math.min(this.baseWidth/e,this.baseHeight/t),a=r/this._textureScaleX,s=r/this._textureScaleY,o=e*a,n=t*s,l=this.textureFrame.x+this.textureFrame.width/2,c=this.textureFrame.y+this.textureFrame.height/2,h=l-o/2,u=c-n/2,d=Math.max(0,this.baseWidth-o),m=Math.max(0,this.baseHeight-n);this.offsetFactorX=d?h/d:this._offsetFactorX,this.offsetFactorY=m?u/m:this._offsetFactorY}catch(i){}};je.prototype.updateDisplay=function(){if(this.texture.valid)try{this.frameStretching&&!this.frameWasStretching&&(this.frameWasStretching=!0);let i=PIXI.GroupD8.isVertical(this.texture.rotate),e=i?this._frameHeight:this._frameWidth,t=i?this._frameWidth:this._frameHeight;if(this.frameScaling){let d=this.initialRealDimensions.y/this.initialRealDimensions.x,m=e/this.initialRealDimensions.x,p=t/this.initialRealDimensions.y;this.textureFrame.width=Math.min(this.baseWidth,this.baseWidth*m),this.textureFrame.height=Math.min(this.baseHeight,this.baseHeight*p);let g=this.baseWidth/this.textureFrame.width*e,f=this.baseHeight/this.textureFrame.height*t,v=f/d,T=g*d;v>g&&(this.textureFrame.width=this.textureFrame.width*(g/v)),T>f&&(this.textureFrame.height=this.textureFrame.height*(f/T));let x=this.baseWidth/this.textureFrame.width*this._frameWidth,B=this.baseHeight/this.textureFrame.height*this._frameHeight;this.excessX=Math.max(0,this.baseWidth-this.textureFrame.width),this.excessY=Math.max(0,this.baseHeight-this.textureFrame.height);let y=this.frameAnchorPoint.x/this.initialRealDimensions.x*this.baseWidth,F=this.frameAnchorPoint.y/this.initialRealDimensions.y*this.baseHeight,b=new PIXI.Point(this.baseWidth/2-this.textureFrame.width/2,this.baseHeight/2-this.textureFrame.height/2);if(this.frameScalingCentered)b.x=this.initialFrameCenter.x-this.textureFrame.width/2,b.y=this.initialFrameCenter.y-this.textureFrame.height/2;else switch(this.frameAnchorSide){case"l":b.x=y,b.y=F-this.textureFrame.height/2;break;case"tl":b.x=y,b.y=F;break;case"t":b.x=y-this.textureFrame.width/2,b.y=F;break;case"tr":b.x=y-this.textureFrame.width,b.y=F;break;case"r":b.x=y-this.textureFrame.width,b.y=F-this.textureFrame.height/2;break;case"br":b.x=y-this.textureFrame.width,b.y=F-this.textureFrame.height;break;case"b":b.x=y-this.textureFrame.width/2,b.y=F-this.textureFrame.height;break;case"bl":b.x=y,b.y=F-this.textureFrame.height;break}this.textureFrame.x=Math.max(0,Math.min(this.baseWidth-this.textureFrame.width,b.x)),this.textureFrame.y=Math.max(0,Math.min(this.baseHeight-this.textureFrame.height,b.y)),this._offsetFactorX=this.excessX>.01?this.textureFrame.x/this.excessX:.5,this._offsetFactorY=this.excessY>.01?this.textureFrame.y/this.excessY:.5;let S=Math.max(e/this.baseWidth,t/this.baseHeight),I=this.baseWidth*S,_=this.baseHeight*S;this._textureScaleX=x/I,this._textureScaleY=B/_}else if(!this.frameStretching){let d=Math.min(this.baseWidth/e,this.baseHeight/t);this.frameWasStretching&&(this.frameWasStretching=!1,this._textureScaleX=d/(this.textureFrame.width/e),this._textureScaleY=d/(this.textureFrame.height/t));let m=d/this._textureScaleX,p=d/this._textureScaleY;this.textureFrame.width=Math.max(0,Math.min(this.baseWidth,Math.round(e*m))),this.textureFrame.height=Math.max(0,Math.min(this.baseHeight,Math.round(t*p))),this.excessX=Math.max(0,this.baseWidth-this.textureFrame.width),this.excessY=Math.max(0,this.baseHeight-this.textureFrame.height),this.textureFrame.x=this._offsetFactorX*this.excessX,this.textureFrame.y=this._offsetFactorY*this.excessY}let r=Math.min(this._frameWidth,Math.max(1,this._frameWidth-this._framePadding*2)),a=Math.min(this._frameHeight,Math.max(1,this._frameHeight-this._framePadding*2)),s=Math.max(0,(this._frameWidth-r)/2),o=Math.max(0,(this._frameHeight-a)/2),n=this.textureFrame.width*(r/this._frameWidth),l=this.textureFrame.height*(a/this._frameHeight),c=this.textureFrame.x+(this.textureFrame.width-n)/2,h=this.textureFrame.y+(this.textureFrame.height-l)/2,u=new PIXI.Rectangle(c,h,n,l);this.texture.frame=u,this.texture.orig=this.texture.trim=new PIXI.Rectangle(s,o,r,a),this.visible=r>1&&a>1,this._imageRect.width=this.width/this.textureFrame.width*this.baseWidth,this._imageRect.height=this.height/this.textureFrame.height*this.baseHeight,this._imageRect.x=-((this._imageRect.width-this.width)*this._offsetFactorX),this._imageRect.y=-((this._imageRect.height-this.height)*this._offsetFactorY),this.adjustScale=1/Math.min(this.baseWidth/e,this.baseHeight/t),this.updateDisplayCallback&&this.updateDisplayCallback(),BFN.MainUI.requestRender()}catch(i){}};je.prototype.flipH=function(){switch(this.texture.rotate){case 0:this.texture.rotate=12;break;case 2:this.texture.rotate=14;break;case 4:this.texture.rotate=8;break;case 6:this.texture.rotate=10;break;case 8:this.texture.rotate=4;break;case 10:this.texture.rotate=6;break;case 12:this.texture.rotate=0;break;case 14:this.texture.rotate=2;break}this.updateDisplay()};je.prototype.flipV=function(){switch(this.texture.rotate){case 0:this.texture.rotate=8;break;case 2:this.texture.rotate=10;break;case 4:this.texture.rotate=12;break;case 6:this.texture.rotate=14;break;case 8:this.texture.rotate=0;break;case 10:this.texture.rotate=2;break;case 12:this.texture.rotate=4;break;case 14:this.texture.rotate=6;break}this.updateDisplay()};je.prototype.rotateL=function(){switch(this.texture.rotate){case 0:this.texture.rotate=2;break;case 2:this.texture.rotate=4;break;case 4:this.texture.rotate=6;break;case 6:this.texture.rotate=0;break;case 8:this.texture.rotate=14;break;case 10:this.texture.rotate=8;break;case 12:this.texture.rotate=10;break;case 14:this.texture.rotate=12;break}this.conformOffsetFactors(),this.updateDisplay()};je.prototype.rotateR=function(){switch(this.texture.rotate){case 0:this.texture.rotate=6;break;case 2:this.texture.rotate=0;break;case 4:this.texture.rotate=2;break;case 6:this.texture.rotate=4;break;case 8:this.texture.rotate=10;break;case 10:this.texture.rotate=12;break;case 12:this.texture.rotate=14;break;case 14:this.texture.rotate=8;break}this.conformOffsetFactors(),this.updateDisplay()};je.prototype.destroy=function(i=!1){try{this.texture.destroyGC(i)}catch(e){}this.texture=PIXI.Texture.EMPTY};Object.defineProperty(je.prototype,"width",{get:function(){return this._frameWidth*this.scale.x}});Object.defineProperty(je.prototype,"height",{get:function(){return this._frameHeight*this.scale.y}});Object.defineProperty(je.prototype,"frameWidth",{set:function(i){this._frameWidth=Math.max(1,i)},get:function(){return this._frameWidth}});Object.defineProperty(je.prototype,"frameHeight",{set:function(i){this._frameHeight=Math.max(1,i)},get:function(){return this._frameHeight}});Object.defineProperty(je.prototype,"framePadding",{set:function(i){this._framePadding=Math.max(0,i)},get:function(){return this._framePadding}});Object.defineProperty(je.prototype,"offsetFactorX",{set:function(i){this._offsetFactorX=Math.max(0,Math.min(1,i))},get:function(){return this._offsetFactorX}});Object.defineProperty(je.prototype,"offsetFactorY",{set:function(i){this._offsetFactorY=Math.max(0,Math.min(1,i))},get:function(){return this._offsetFactorY}});Object.defineProperty(je.prototype,"rotate",{set:function(i){this.rotateValues.indexOf(i)!=-1&&(this.texture.rotate=i,this.conformOffsetFactors())},get:function(){return this.texture.rotate}});Object.defineProperty(je.prototype,"textureScale",{set:function(i){this._textureScale=Math.max(0,i),this._textureScaleX=this._textureScale,this._textureScaleY=this._textureScale,this.conformOffsetFactors()},get:function(){return this._textureScale}});Object.defineProperty(je.prototype,"textureScaleX",{set:function(i){this._textureScaleX=Math.max(0,i),this.conformOffsetFactors()},get:function(){return this._textureScaleX}});Object.defineProperty(je.prototype,"textureScaleY",{set:function(i){this._textureScaleY=Math.max(0,i),this.conformOffsetFactors()},get:function(){return this._textureScaleY}});Object.defineProperty(je.prototype,"isEmpty",{get:function(){return this._isEmpty}});Object.defineProperty(je.prototype,"imageRect",{get:function(){return this._imageRect}});BFN.FrameSprite=je;function bi(i=0,e=1){PIXI.Container.call(this),BFN.EventDispatcher.call(this),this._color=Math.max(0,Math.min(16777215,i)),this._opacity=Math.max(0,Math.min(1,e)),this._blendMode=0,this.init()}bi.prototype=window.azrc.extend(Object.create(PIXI.Container.prototype),Object.create(BFN.EventDispatcher.prototype));bi.prototype.init=function(){BeFunky.log("FrameBorder Init"),this.initDefaultValues()};bi.prototype.initDefaultValues=function(){this.interactive=this.interactiveChildren=!1,this.visible=!1,this.spriteSize=32,this.sprites=[],this._width=0,this._height=0,this._thickness=0};bi.prototype.initSprites=function(){if(!this.sprites.length){for(let i=0;i<4;i++){let e=this.createSprite();e.anchor.x=i%3?0:1,e.anchor.y=Math.floor(i/2)?0:1,e.gapFactor=[i%3?0:1,i%3?1:0,Math.floor(i/2)?0:1,Math.floor(i/2)?1:0]}for(let i=0;i<4;i++){let e=this.createSprite();e.anchor.x=i<2?1-i%2:.5,e.anchor.y=i<2?.5:1-i%2,e.gapFactor=[i<2?1:0,i<2?1:0,i<2?0:1,i<2?0:1]}}};bi.prototype.setDimensions=function(i,e){this._width===i&&this._height===e||(this._width=i,this._height=e,this.updateDisplay())};bi.prototype.updateDisplay=function(){this.initSprites();for(let i=0;i<this.sprites.length;i++){let e=this.sprites[i];e.visible=this._thickness>0,!!e.visible&&(i<4?(e.x=i%3?this._width:0,e.y=Math.floor(i/2)?this._height:0,e.scale.x=e.scale.y=this._thickness/this.spriteSize):(e.x=i==4?0:i===5?this._width:this._width/2,e.y=i==6?0:i===7?this._height:this._height/2,e.scale.x=Math.floor((i-4)/2)?this._width/this.spriteSize:this._thickness/this.spriteSize,e.scale.y=Math.floor((i-4)/2)?this._thickness/this.spriteSize:this._height/this.spriteSize),e.blendMode!==this._blendMode&&(e.blendMode=this._blendMode))}this.visible=this._thickness>0,BFN.MainUI&&BFN.MainUI.requestRender()};bi.prototype.destroy=function(){for(let i=0;i<this.sprites.length;i++)this.removeChild(this.sprites[i]),this.sprites[i].destroy(!1);this.sprites.splice(0),BFN.MainUI&&BFN.MainUI.requestRender()};bi.prototype.createSprite=function(){BFN.FrameBorderTexture||(BFN.FrameBorderTexture=PIXI.RenderTexture.create(this.spriteSize,this.spriteSize),BFN.FrameBorderTexture.fillColor(16777215),BFN.FrameBorderTexture.setScaleMode(PIXI.SCALE_MODES.NEAREST));let i=new PIXI.Sprite(BFN.FrameBorderTexture);return i.pluginName="blend_picture",i.alpha=this._opacity,i.fillColor=this._color,i.intensity=1,i.blendMode=this._blendMode,this.addChild(i),this.sprites.push(i),i};Object.defineProperty(bi.prototype,"thickness",{set:function(i){typeof i!="number"||this._thickness===i||(this._thickness=i,this.updateDisplay())},get:function(){return this._thickness}});Object.defineProperty(bi.prototype,"color",{set:function(i){typeof i!="number"||this._color===i||(this._color=Math.max(0,Math.min(16777215,i)),this.sprites.forEach(e=>{e.fillColor=this._color}),BFN.MainUI.requestRender())},get:function(){return this._color}});Object.defineProperty(bi.prototype,"opacity",{set:function(i){typeof i!="number"||this._opacity===i||(this._opacity=Math.max(0,Math.min(1,i)),this.sprites.forEach(e=>{e.alpha=this._opacity}),BFN.MainUI.requestRender())},get:function(){return this._opacity}});Object.defineProperty(bi.prototype,"blendMode",{set:function(i){typeof i!="number"||this._blendMode===i||(this._blendMode=i,this.sprites.forEach(e=>{e.blendMode=this._blendMode}),BFN.MainUI.requestRender())},get:function(){return this._blendMode}});Object.defineProperty(bi.prototype,"isFrameBorder",{get:function(){return!0}});BFN.FrameBorder=bi;function pi(){PIXI.Container.call(this),this.init()}pi.prototype=Object.create(PIXI.Container.prototype);pi.prototype.init=function(){BeFunky.log("PremiumWatermark Init"),this.initDefaultValues(),this.initEmblem(),this.initGraphicLoader()};pi.prototype.initDefaultValues=function(){this.interactive=!1,this.visible=!1,this._showing=!1,this.frameWidth=0,this.frameHeight=0,this.currentToolID=null,this._canvasScale=1,this._canvasScaling=!1,BFN.BfnService.addEventListener(BFN.BfnServiceEvents.USER_DATA_CHANGED.type,this.handleUserDataChanged.bind(this))};pi.prototype.initEmblem=function(){this.emblem=new PIXI.Sprite,this.emblem.interactive=!0,this.emblem.buttonMode=!0,this.emblem.anchor.y=1,this.emblem.pluginName="blend_picture",this.emblem.currentScale=1,this.emblem.on("click",function(){BFN.PhotoEditorCanvasTools.applyCurrentTool("WATERMARK","")})};pi.prototype.initGraphicLoader=function(){this.graphicLoader=new BFN.GraphicLoader,this.graphicLoader.graphicsData.emblem=BFN.imagesURL+"app/premium_emblem_v4_50_op.png",this.graphicLoader.addEventListener(BFN.GraphicLoaderEvents.LOADING_COMPLETE.type,this.handleGraphicsLoaded.bind(this)),setTimeout(function(){this.graphicLoader.loadGraphics()}.bind(this),1e3)};pi.prototype.setDimensions=function(i,e){this.frameWidth=Math.abs(i),this.frameHeight=Math.abs(e),this.updateDimensions()};pi.prototype.updateDimensions=function(){this.graphicLoader.graphicsLoaded&&(this.emblem.scale.x=this.emblem.scale.y=Math.min(this.frameWidth/3/this.emblem.texture.width,this.frameHeight/3/this.emblem.texture.height),this.emblem.x=Math.round(-(this.frameWidth/2)+10*this.emblem.scale.x),this.emblem.y=Math.round(this.frameHeight/2-10*this.emblem.scale.y),this.updateSmoothing()),BFN.MainUI.requestRender()};pi.prototype.updateSmoothing=function(){this.emblem.currentScale=this._canvasScaling?1:this.emblem.scale.x*this._canvasScale,BFN.MainUI.requestRender()};pi.prototype.updateDisplay=function(){this._showing=this.currentToolID&&UITools.toolPlusHash[this.currentToolID]&&!BFN.BfnService.userIsPlus,this.visible=this._showing,BFN.MainUI.requestRender()};pi.prototype.handleUserDataChanged=function(i){this.updateDisplay()};pi.prototype.handleGraphicsLoaded=function(i){this.emblem.texture=this.graphicLoader.graphics.emblem,this.addChild(this.emblem),this.updateDimensions()};Object.defineProperty(pi.prototype,"showing",{get:function(){return this._showing}});Object.defineProperty(pi.prototype,"canvasScaling",{set:function(i){this._canvasScaling=i,this.updateSmoothing()},get:function(){return this._canvasScaling}});Object.defineProperty(pi.prototype,"canvasScale",{set:function(i){this._canvasScale=i,this.updateSmoothing()},get:function(){return this._canvasScale}});BFN.SingletonQueue.add(function(){BFN.PremiumWatermark=new pi});function si(i=null,e=32,t=32){PIXI.Container.call(this),this.init(),this.texture=i,this.width=e,this.height=t}si.prototype=Object.create(PIXI.Container.prototype);si.prototype.init=function(){BeFunky.log("TileContainer Init"),this.initDefaultValues(),this.initTileContainer(),this.initTileContainerMask(),this.initTilePool()};si.prototype.initDefaultValues=function(){this.tiles=[],this.tilesX=0,this.tilesY=0,this.tilesNum=0,this.tilesTotalW=0,this.tilesTotalH=0,this.globalOffsetPoint=new PIXI.Point,this.localOffsetPoint=new PIXI.Point,this._smoothScale=1};si.prototype.initTileContainer=function(){this.tileContainer=new PIXI.Container,this.addChild(this.tileContainer)};si.prototype.initTileContainerMask=function(){this.tileContainerMask=new PIXI.Graphics,this.tileContainerMask.beginFill(16777215),this.tileContainerMask.drawRect(0,0,100,100),this.tileContainerMask.endFill(),this.addChild(this.tileContainerMask),this.tileContainer.mask=this.tileContainerMask};si.prototype.initTilePool=function(){this.tilePool=new BFN.SpritePool,this.tilePool.grow(100)};si.prototype.offset=function(i=0,e=0){this.globalOffsetPoint.x=i,this.globalOffsetPoint.y=e,this.updateSpritePlacement()};si.prototype.rotate=function(i){this.tileContainer.rotation=i;let e=Math.sqrt(Math.pow(this.localOffsetPoint.x,2)+Math.pow(this.localOffsetPoint.y,2)),t=Math.atan2(this.localOffsetPoint.y,this.localOffsetPoint.x)+this.tileContainer.rotation;this.globalOffsetPoint.x=Math.cos(t)*e,this.globalOffsetPoint.y=Math.sin(t)*e,BFN.MainUI.requestRender()};si.prototype.updateDisplay=function(){if(this.tileContainer.children.length&&this.tileContainer.removeChildren(0,this.tileContainer.children.length),this.tiles.splice(0),this.tilesX=0,this.tilesY=0,this.tilesNum=0,this.tilesTotalW=0,this.tilesTotalH=0,this._texture){this.tilesX=Math.ceil(this.containerDiagonal/this._texture.width)+1,this.tilesY=Math.ceil(this.containerDiagonal/this._texture.height)+1,this.tilesX+=this.tilesX%2?0:1,this.tilesY+=this.tilesY%2?0:1,this.tilesTotalW=this.tilesX*this._texture.width,this.tilesTotalH=this.tilesY*this._texture.height,this.tilesNum=this.tilesX*this.tilesY,this.tilePool.growTo(this.tilesNum);for(let i=0;i<this.tilesNum;i++){let e=this.tilePool.getSprite(i,null,this._texture);this.tiles.push(e),this.tileContainer.addChild(e)}this.updateSpritePlacement(),this.updateSpriteSmoothing()}BFN.MainUI.requestRender()};si.prototype.updateSpritePlacement=function(){if(this._texture){let i=Math.sqrt(Math.pow(this.globalOffsetPoint.x,2)+Math.pow(this.globalOffsetPoint.y,2)),e=Math.atan2(this.globalOffsetPoint.y,this.globalOffsetPoint.x)-this.tileContainer.rotation;this.localOffsetPoint.x=Math.cos(e)*i%this._texture.width,this.localOffsetPoint.y=Math.sin(e)*i%this._texture.height;let t=Math.sqrt(Math.pow(this.localOffsetPoint.x,2)+Math.pow(this.localOffsetPoint.y,2)),r=Math.atan2(this.localOffsetPoint.y,this.localOffsetPoint.x)+this.tileContainer.rotation;this.globalOffsetPoint.x=Math.cos(r)*t,this.globalOffsetPoint.y=Math.sin(r)*t;for(let a=0;a<this.tilesNum;a++){let s=a%this.tilesX*this._texture.width-this.tilesTotalW/2+this._texture.width/2,o=Math.floor(a/this.tilesY)*this._texture.height-this.tilesTotalH/2+this._texture.height/2;for(s+=this.localOffsetPoint.x,o+=this.localOffsetPoint.y;s<-(this.tilesTotalW/2);)s+=this.tilesTotalW;for(;s>this.tilesTotalW/2;)s-=this.tilesTotalW;for(;o<-(this.tilesTotalH/2);)o+=this.tilesTotalH;for(;o>this.tilesTotalH/2;)o-=this.tilesTotalH;let n=this.tiles[a];n.x=s,n.y=o}BFN.MainUI.requestRender()}};si.prototype.updateSpriteSmoothing=function(){for(let i=0;i<this.tiles.length;i++){let e=this.tiles[i];this._smoothScale<=1?(e.pluginName!="smooth_picture"&&(e.pluginName="smooth_picture",e.expandVertex=0),e.currentScale=this._smoothScale):e.pluginName!="sprite"&&(e.pluginName="sprite",e.currentScale=1)}};Object.defineProperty(si.prototype,"texture",{set:function(i){this._texture=i},get:function(){return this._texture}});Object.defineProperty(si.prototype,"width",{set:function(i){this._width=i,this.containerDiagonal=Math.floor(Math.sqrt(Math.pow(this._width,2)+Math.pow(this._height,2))),this.tileContainer.x=this._width/2,this.tileContainerMask.width=this._width},get:function(){return this._width}});Object.defineProperty(si.prototype,"height",{set:function(i){this._height=i,this.containerDiagonal=Math.floor(Math.sqrt(Math.pow(this._width,2)+Math.pow(this._height,2))),this.tileContainer.y=this._height/2,this.tileContainerMask.height=this._height},get:function(){return this._height}});Object.defineProperty(si.prototype,"smoothScale",{set:function(i){this._smoothScale=i,this.updateSpriteSmoothing()},get:function(){return this._smoothScale}});BFN.TileContainer=si;function Pi(){PIXI.Container.call(this),this.init()}Pi.prototype=Object.create(PIXI.Container.prototype);Pi.prototype.init=function(){BeFunky.log("GraphicsPixelGrid Init"),this.initDefaultValues()};Pi.prototype.initDefaultValues=function(){this.pixelHash={},this._itemWidth=0,this._itemHeight=0};Pi.prototype.clear=function(){for(let i in this.pixelHash){let e=this.pixelHash[i];for(let t in e)this.destroyPixel(t,i),delete e[t];delete this.pixelHash[i]}this.pixelHash={},this._itemWidth=0,this._itemHeight=0};Pi.prototype.generate=function(i,e,t=16777215,r=1){this.clear();for(let a=0;a<e;a++){let s={};this.pixelHash[a]=s;for(let o=0;o<i;o++)s[o]=this.createPixelGraphic(o,a,t,r)}this._itemWidth=i,this._itemHeight=e};Pi.prototype.getPixel=function(i,e){return this.pixelHash.hasOwnProperty(e)&&this.pixelHash[e].hasOwnProperty(i)?this.pixelHash[e][i]:null};Pi.prototype.destroyPixel=function(i,e){let t=this.getPixel(i,e);t&&(t.clear(),this.removeChild(t),this.pixelHash[e][i]=null)};Pi.prototype.setPixelColor=function(i,e,t){let r=this.getPixel(i,e);if(r){let a=r.alpha;this.destroyPixel(i,e),r=this.createPixelGraphic(i,e,t,a),this.pixelHash[e][i]=r}};Pi.prototype.setPixelAlpha=function(i,e,t){let r=this.getPixel(i,e);r&&(r.alpha=t)};Pi.prototype.createPixelGraphic=function(i,e,t=16777215,r=1){let a=new PIXI.Graphics;return a.beginFill(t,r),a.drawRect(0,0,1,1),a.endFill(),a.x=i,a.y=e,this.addChild(a),a};Object.defineProperty(Pi.prototype,"itemWidth",{get:function(){return this._itemWidth}});Object.defineProperty(Pi.prototype,"itemHeight",{get:function(){return this._itemHeight}});BFN.GraphicsPixelGrid=Pi;function Gi(i=5e3){PIXI.particles.ParticleContainer.call(this,i*2,{scale:!1,position:!1,rotation:!1,uvs:!1,alpha:!0},i,!0),this.init()}Gi.prototype=Object.create(PIXI.particles.ParticleContainer.prototype);Gi.prototype.init=function(){BeFunky.log("SpritePixelGrid Init"),this.initDefaultValues()};Gi.prototype.initDefaultValues=function(){this.pixelTexture=PIXI.RenderTexture.create(2,2),this.pixelTexture.setScaleMode(PIXI.SCALE_MODES.NEAREST),this.spritePool=new BFN.SpritePool,this.spritePool.spriteAnchor.x=this.spritePool.spriteAnchor.y=0,this._itemWidth=0,this._itemHeight=0};Gi.prototype.clear=function(){this.removeChildren();for(let i in this.pixelHash){let e=this.pixelHash[i];for(let t in e)delete e[t];delete this.pixelHash[i]}this.pixelHash={},this._itemWidth=0,this._itemHeight=0};Gi.prototype.generate=function(i,e,t=16777215,r=1){this.clear(),this.pixelTexture.fillRect(0,0,1,1,t),this.spritePool.growTo(i*e);for(let a=0;a<e;a++){let s={};this.pixelHash[a]=s;for(let o=0;o<i;o++){let n=this.spritePool.getSprite(a*i+o,{x:o,y:a},this.pixelTexture);n.alpha=r,this.addChild(n),s[o]=n}}this._itemWidth=i,this._itemHeight=e};Gi.prototype.getPixel=function(i,e){return this.pixelHash.hasOwnProperty(e)&&this.pixelHash[e].hasOwnProperty(i)?this.pixelHash[e][i]:null};Gi.prototype.destroyPixel=function(i,e){let t=this.getPixel(i,e);t&&(this.removeChild(t),this.pixelHash[e][i]=null)};Gi.prototype.setPixelAlpha=function(i,e,t){let r=this.getPixel(i,e);r&&(r.alpha=t)};Gi.prototype.setEveryPixelAlpha=function(i){for(let e in this.pixelHash){let t=this.pixelHash[e];for(let r in t){let a=t[r];a&&(a.alpha=i)}}};Object.defineProperty(Gi.prototype,"itemWidth",{get:function(){return this._itemWidth}});Object.defineProperty(Gi.prototype,"itemHeight",{get:function(){return this._itemHeight}});BFN.SpritePixelGrid=Gi;function rr(){this.hGuidesNum=BFN.maxImageSize,this.vGuidesNum=BFN.maxImageSize;let i=this.hGuidesNum+this.vGuidesNum;PIXI.particles.ParticleContainer.call(this,i,{scale:!0,position:!0,rotation:!0,uvs:!1,alpha:!1},i,!0),this.init()}rr.prototype=Object.create(PIXI.particles.ParticleContainer.prototype);rr.prototype.init=function(){BeFunky.log("PixelGrid Init"),this.initDefaultValues(),this.initGuides()};rr.prototype.initDefaultValues=function(){this._frameWidth=0,this._frameHeight=0,this.active=!0};rr.prototype.initGuides=function(){this.guideTexture=PIXI.RenderTexture.create(10,3),this.guideTexture.fillRect(0,1,10,1,16777215,.5),this.guideTexture.setScaleMode(PIXI.SCALE_MODES.NEAREST);let i=(e,t,r)=>{let a=new PIXI.Sprite(this.guideTexture);return a.anchor.x=a.anchor.y=.5,a.x=e,a.y=t,a.rotation=r,this.addChild(a),a};this.hGuides=[];for(let e=-Math.floor(this.hGuidesNum/2);e<Math.floor(this.hGuidesNum/2);e++)this.hGuides.push(i(0,e*1,0));this.vGuides=[];for(let e=-Math.floor(this.vGuidesNum/2);e<Math.floor(this.vGuidesNum/2);e++)this.vGuides.push(i(e*1,0,Math.PI/2))};rr.prototype.setFrameDimensions=function(i=0,e=0){this._frameWidth=i,this._frameHeight=e,this.updateDisplay()};rr.prototype.updateDisplay=function(){if(!this.active){this.visible&&(this.visible=!1);return}this._scale<5.5&&this.visible?this.visible=!1:this._scale<6?(this.alpha=(this._scale-5.5)/.5,this.visible||(this.visible=!0)):(this.alpha<1||!this.visible)&&(this.alpha=1,this.visible=!0),this.visible&&(this.hGuides.forEach(i=>{i.scale.x=this._frameWidth/this._scale,i.scale.y=1/this._scale}),this.vGuides.forEach(i=>{i.scale.x=this._frameHeight/this._scale,i.scale.y=1/this._scale}),BFN.MainUI&&BFN.MainUI.requestRender())};Object.defineProperty(rr.prototype,"frameWidth",{set:function(i){this._frameWidth=i,this.updateDisplay()},get:function(){return this._frameWidth}});Object.defineProperty(rr.prototype,"frameHeight",{set:function(i){this._frameHeight=i,this.updateDisplay()},get:function(){return this._frameHeight}});Object.defineProperty(rr.prototype,"canvasScale",{set:function(i){this._scale=i,this.updateDisplay()},get:function(){return this._canvasScale}});BFN.PixelGrid=rr;function Pr(){PIXI.Graphics.call(this),this.init()}Pr.prototype=Object.create(PIXI.Graphics.prototype);Pr.prototype.init=function(){BeFunky.log("AutoCollageGeneratorClusterItem Init"),this.initDefaultValues()};Pr.prototype.initDefaultValues=function(){this._menuImageVO=null,this._itemWidth=0,this._itemHeight=0};Pr.prototype.destroy=function(){this._menuImageVO=null,this.clear()};Object.defineProperty(Pr.prototype,"menuImageVO",{set:function(i){this._menuImageVO=i,this.clear(),this._menuImageVO.imageTexture&&this._menuImageVO.imageTexture.valid&&this._menuImageVO.imageTexture.baseTexture&&(this._itemWidth=this._menuImageVO.imageTexture.baseTexture.width,this._itemHeight=this._menuImageVO.imageTexture.baseTexture.height,this.beginFill(16777215),this.drawRect(0,0,this._itemWidth,this._itemHeight),this.endFill())},get:function(){return this._menuImageVO}});Object.defineProperty(Pr.prototype,"itemWidth",{get:function(){return this._itemWidth}});Object.defineProperty(Pr.prototype,"itemHeight",{get:function(){return this._itemHeight}});BFN.AutoCollageGeneratorClusterItem=Pr;function oi(){PIXI.Container.call(this),this.init()}oi.prototype=Object.create(PIXI.Container.prototype);oi.prototype.init=function(){BeFunky.log("AutoCollageGeneratorCluster Init"),this.initDefaultValues()};oi.prototype.initDefaultValues=function(){this._itemsNum=0,this._itemWidth=0,this._itemHeight=0,this.clusters=null,this.item=null,this.cluster=null,this.clusterA=null,this.clusterB=null,this.clusterC=null,this.hWidth=0,this.hHeight=0,this.hRatio=0,this.vWidth=0,this.vHeight=0,this.vRatio=0,this.hsRect=new BFN.Rectangle,this.hsWidth=0,this.hsHeight=0,this.hsRatio=0,this.vsRect=new BFN.Rectangle,this.vsWidth=0,this.vsHeight=0,this.vsRatio=0};oi.prototype.addItem=function(i){this.item&&(this.removeChild(this.item),this.item.destroy(),this.item=null,this._itemWidth=0,this._itemHeight=0),i&&i.menuImageVO&&!this.clusters&&(this.item=i,this.item.x=this.item.y=0,this.item.scale.x=this.item.scale.y=1,this.addChild(this.item),this._itemWidth=this.item.width,this._itemHeight=this.item.height)};oi.prototype.addCluster=function(i){this.item||(this.clusters||(this.clusters=[]),this.clusters.length<3&&(this.clusters.push(i),this._itemsNum=this.clusters.length,this.addChild(i),this.arrangeClusters()))};oi.prototype.clear=function(){if(this.item&&(this.removeChild(this.item),this.item.destroy(),this.item=null),this.clusters){for(let i=0;i<this.clusters.length;i++)this.cluster=this.clusters[i],this.removeChild(this.cluster),this.cluster.clear(),this.cluster=null;this.clusters.splice(0),this.clusters=null}this._itemWidth=0,this._itemHeight=null};oi.prototype.arrangeClusters=function(){for(let r=0;r<this.clusters.length;r++)this.cluster=this.clusters[r],this.cluster.x=this.cluster.y=0,this.cluster.scale.x=this.cluster.scale.y=1;if(this.clusters.length==1)this.cluster=this.clusters[0],this._itemWidth=this.cluster.width,this._itemHeight=this.cluster.height;else if(this.clusters.length==2)this.clusterA=this.clusters[0],this.clusterB=this.clusters[1],this.hWidth=this.getCombinedWidth(this.clusterA.rect,this.clusterB.rect),this.hHeight=this.clusterA.height,this.hRatio=this.getLongRatio(this.hWidth,this.hHeight),this.vWidth=this.clusterA.width,this.vHeight=this.getCombinedHeight(this.clusterA.rect,this.clusterB.rect),this.vRatio=this.getLongRatio(this.vWidth,this.vHeight),this.hRatio<this.vRatio?(this.clusterB.x=this.clusterA.width,this.clusterB.width=this.hWidth-this.clusterA.width,this.clusterB.height=this.clusterA.height,this._itemWidth=this.hWidth,this._itemHeight=this.hHeight):(this.clusterB.y=this.clusterA.height,this.clusterB.width=this.clusterA.width,this.clusterB.height=this.vHeight-this.clusterA.height,this._itemWidth=this.vWidth,this._itemHeight=this.vHeight);else if(this.clusters.length==3){let r=Number.MAX_VALUE,a=Math.random()<.5;for(let s=0;s<this.clusters.length;s++){this.clusterA=this.clusters[s];for(let o=0;o<this.clusters.length;o++)if(this.clusters[s]!=this.clusters[o]){this.clusterB=this.clusters[o];for(let n=0;n<this.clusters.length;n++)if(this.clusters[s]!=this.clusters[n]&&this.clusters[o]!=this.clusters[n]){this.clusterC=this.clusters[n],this.hWidth=this.getCombinedWidth(this.clusterA.rect,this.clusterB.rect)+(this.getCombinedWidth(this.clusterA.rect,this.clusterC.rect)-this.clusterA.width),this.hHeight=this.clusterA.height,this.hRatio=this.getLongRatio(this.hWidth,this.hHeight),this.vWidth=this.clusterA.width,this.vHeight=this.getCombinedHeight(this.clusterA.rect,this.clusterB.rect)+(this.getCombinedHeight(this.clusterA.rect,this.clusterC.rect)-this.clusterA.height),this.vRatio=this.getLongRatio(this.vWidth,this.vHeight),this.hsRect.width=this.clusterB.itemWidth,this.hsRect.height=this.getCombinedHeight(this.clusterB.rect,this.clusterC.rect),this.hsWidth=this.getCombinedWidth(this.clusterA.rect,this.hsRect),this.hsHeight=this.clusterA.height,this.hsRatio=this.getLongRatio(this.hsWidth,this.hsHeight),this.vsRect.width=this.getCombinedWidth(this.clusterB.rect,this.clusterC.rect),this.vsRect.height=this.clusterB.itemHeight,this.vsWidth=this.clusterA.width,this.vsHeight=this.getCombinedHeight(this.clusterA.rect,this.vsRect),this.vsRatio=this.getLongRatio(this.vsWidth,this.vsHeight);let l=a?Math.min(this.hRatio,this.vRatio):Math.min(this.hRatio,this.vRatio,this.hsRatio,this.vsRatio);if(l<r){r=l;var i=this.getClusterObject(),e=this.getClusterObject(),t=this.getClusterObject();switch(l){case this.hRatio:this._itemWidth=this.hWidth,this._itemHeight=this.hHeight,i.cluster=this.clusterA,i.width=this.clusterA.width,i.height=this.clusterA.height,e.cluster=this.clusterB,e.x=i.width,e.width=this.hWidth-this.getCombinedWidth(this.clusterA.rect,this.clusterC.rect),e.height=i.height,t.cluster=this.clusterC,t.x=e.x+e.width,t.width=this.hWidth-t.x,t.height=i.height;break;case this.vRatio:this._itemWidth=this.vWidth,this._itemHeight=this.vHeight,i.cluster=this.clusterA,i.width=this.clusterA.width,i.height=this.clusterA.height,e.cluster=this.clusterB,e.y=i.height,e.width=i.width,e.height=this.vHeight-this.getCombinedHeight(this.clusterA.rect,this.clusterC.rect),t.cluster=this.clusterC,t.y=e.y+e.height,t.width=i.width,t.height=this.vHeight-t.y;break;case this.hsRatio:this._itemWidth=this.hsWidth,this._itemHeight=this.hsHeight,i.cluster=this.clusterA,i.width=this.clusterA.width,i.height=this.clusterA.height,e.cluster=this.clusterB,e.x=i.width,e.width=this.hsWidth-i.width,e.height=Math.round(e.width/this.clusterB.width*this.clusterB.height),t.cluster=this.clusterC,t.x=i.width,t.y=e.height,t.width=this.hsWidth-i.width,t.height=this.hsHeight-e.height,Math.random()<.5&&(i.x=e.width,e.x=t.x=0);break;case this.vsRatio:this._itemWidth=this.vsWidth,this._itemHeight=this.vsHeight,i.cluster=this.clusterA,i.width=this.clusterA.width,i.height=this.clusterA.height,e.cluster=this.clusterB,e.y=i.height,e.height=this.vsHeight-i.height,e.width=Math.round(e.height/this.clusterB.height*this.clusterB.width),t.cluster=this.clusterC,t.x=e.width,t.y=i.height,t.width=this.vsWidth-e.width,t.height=this.vsHeight-i.height,Math.random()<.5&&(i.y=e.height,e.y=t.y=0);break}}}}}try{i.cluster.x=i.x,i.cluster.y=i.y,i.cluster.width=i.width,i.cluster.height=i.height,e.cluster.x=e.x,e.cluster.y=e.y,e.cluster.width=e.width,e.cluster.height=e.height,t.cluster.x=t.x,t.cluster.y=t.y,t.cluster.width=t.width,t.cluster.height=t.height}catch(s){}}};oi.prototype.getCombinedWidth=function(i,e){return Math.floor(i.width+Math.round(e.width*(i.height/e.height)))};oi.prototype.getCombinedHeight=function(i,e){return Math.floor(i.height+Math.round(e.height*(i.width/e.width)))};oi.prototype.getLongRatio=function(i,e){return i=Math.floor(i),e=Math.floor(e),i>e?i/e:e/i};oi.prototype.getClusterObject=function(){return{cluster:null,x:0,y:0,width:0,height:0}};Object.defineProperty(oi.prototype,"rect",{get:function(){return new BFN.Rectangle(0,0,this._itemWidth,this._itemHeight)}});Object.defineProperty(oi.prototype,"itemsNum",{get:function(){return this._itemsNum}});Object.defineProperty(oi.prototype,"itemWidth",{get:function(){return this._itemWidth}});Object.defineProperty(oi.prototype,"itemHeight",{get:function(){return this._itemHeight}});BFN.AutoCollageGeneratorCluster=oi;BFN.AutoCollageGeneratorEvents={SIZE_UPDATED:new Event("SIZE_UPDATED")};function Yi(){PIXI.Container.call(this),BFN.EventDispatcher.call(this),this.init()}Yi.prototype=window.azrc.extend(Object.create(PIXI.Container.prototype),Object.create(BFN.EventDispatcher.prototype));Yi.prototype.init=function(){BeFunky.log("AutoCollageGenerator Init"),this.initDefaultValues(),this.initClusterContainer()};Yi.prototype.initDefaultValues=function(){this._itemWidth=0,this._itemHeight=0,this.rootCluster=null,this.clusterItems=[]};Yi.prototype.initClusterContainer=function(){this.clusterContainer=new PIXI.Container,this.addChild(this.clusterContainer)};Yi.prototype.generate=function(i){if(this.clear(),i&&i.length)for(let t=0;t<i.length;t++){let r=i[t],a=new BFN.AutoCollageGeneratorClusterItem;a.menuImageVO=r,a.menuImageVO&&this.clusterItems.push(a)}this.generateCollage();let e=[];for(let t=0;t<this.clusterItems.length;t++){let r=this.clusterItems[t];if(r.menuImageVO){let a={},s=this.toLocal(r.toGlobal(new PIXI.Point(0,0))),o=this.toLocal(r.toGlobal(new PIXI.Point(r.itemWidth,r.itemHeight)));a.menuImageVO=r.menuImageVO,a.rect=new BFN.Rectangle(Math.round(s.x),Math.round(s.y),Math.round(o.x)-Math.round(s.x),Math.round(o.y)-Math.round(s.y)),e.push(a)}}return e};Yi.prototype.clear=function(){this.clearDisplay(),this.clusterItems.splice(0)};Yi.prototype.clearDisplay=function(){this.rootCluster&&(this.rootCluster.clear(),this.rootCluster=null,this.clusterContainer.removeChildren())};Yi.prototype.generateCollage=function(){this.clearDisplay();let i=[];for(let r=0;r<this.clusterItems.length;r++)i.push(this.clusterItems[r]);let e=[];for(;i.length;){let r=Math.floor(Math.random()*i.length);e.push(i[r]),i.splice(r,1)}let t=[];for(;e.length;)this.cluster=new BFN.AutoCollageGeneratorCluster,this.cluster.addItem(e.pop()),t.push(this.cluster);for(e.splice(0);t.length>1;){let r=[];for(let s=0;s<t.length;s++)r.push(t[s]);t.splice(0);let a=null;for(;r.length;)a||(a=new BFN.AutoCollageGeneratorCluster,t.push(a)),a.itemsNum<2?a.addCluster(r.pop()):a.itemsNum==2&&(r.length==1&&a.addCluster(r.pop()),a=null)}this.rootCluster=t[0],this.clusterContainer.addChild(this.rootCluster),t.splice(0),this.clusterContainer.scale.x=this.clusterContainer.scale.y=Math.min(Math.max(1,2e3/this.rootCluster.itemWidth,2e3/this.rootCluster.itemHeight),4e3/this.rootCluster.itemWidth,4e3/this.rootCluster.itemHeight),this._itemWidth=this.clusterContainer.width=Math.floor(this.clusterContainer.width),this._itemHeight=this.clusterContainer.height=Math.floor(this.clusterContainer.height),this.dispatchEvent(BFN.AutoCollageGeneratorEvents.SIZE_UPDATED)};Object.defineProperty(Yi.prototype,"itemWidth",{get:function(){return this._itemWidth}});Object.defineProperty(Yi.prototype,"itemHeight",{get:function(){return this._itemHeight}});BFN.AutoCollageGenerator=Yi;function Ni(){this.init()}Ni.prototype.init=function(){this.initDefaultValues(),this.initAutoCollageGenerator()};Ni.prototype.initDefaultValues=function(){this._collageMenuImageVOs=null,this.layoutObjects=[],this.layoutIndex=0,this.previewFitSize=1024};Ni.prototype.initAutoCollageGenerator=function(){this.autoCollageGenerator=new BFN.AutoCollageGenerator};Ni.prototype.reset=function(){if(this._collageMenuImageVOs){this._collageMenuImageVOs.splice(0),this._collageMenuImageVOs=null;for(let i=0;i<this.layoutObjects.length;i++)this.clearLayoutObject(this.layoutObjects[i]);this.layoutObjects.splice(0),this.layoutIndex=0,BFN.CollageWizardModal.disablePrevButton=!0,BFN.CollageWizardModal.disableNextButton=!0,BFN.CollageWizardModal.disableSelectCollageButton=!0,BFN.CollageWizardModal.previewImage=void 0}};Ni.prototype.generateAutoCollage=function(i){if(this.reset(),i&&i.length){this._collageMenuImageVOs=[];for(let e=0;e<i.length;e++)this._collageMenuImageVOs.push(i[e]);this._collageMenuImageVOs.length&&BFN.BfnService.getTexturesForMenuImageVOs(this._collageMenuImageVOs).then(this.nextLayout.bind(this))}};Ni.prototype.nextLayout=function(){if(this._collageMenuImageVOs&&this._collageMenuImageVOs.length){let i;if(!this.layoutObjects.length)i=this.getNewLayout(),i&&(this.layoutObjects.push(i),this.layoutIndex=0);else if(this.layoutIndex<this.layoutObjects.length-1)i=this.layoutObjects[++this.layoutIndex];else{i=this.getNewLayout();let e=this.layoutObjects[this.layoutObjects.length-1];e&&e.width===i.width&&e.height===i.height&&e.data.length>1&&e.data.every(({menuImageVO:t,rect:r},a)=>t===i.data[a].menuImageVO&&JSON.stringify(r)===JSON.stringify(i.data[a].rect))&&(i=this.getNewLayout()),i&&(this.layoutObjects.push(i),this.layoutIndex=this.layoutObjects.length-1)}BFN.CollageWizardModal.disablePrevButton=this.layoutIndex<0,i&&this.createPreview(i)}};Ni.prototype.prevLayout=function(){if(this._collageMenuImageVOs&&this._collageMenuImageVOs.length&&this.layoutIndex>0){let i=this.layoutObjects[--this.layoutIndex];BFN.CollageWizardModal.disablePrevButton=this.layoutIndex<0,i&&this.createPreview(i)}};Ni.prototype.getNewLayout=function(){if(this._collageMenuImageVOs){let i={};return i.data=this.autoCollageGenerator.generate(this._collageMenuImageVOs),i.width=this.autoCollageGenerator.itemWidth,i.height=this.autoCollageGenerator.itemHeight,this.autoCollageGenerator.clear(),i}return null};Ni.prototype.createPreview=function(i){if(BFN.CollageWizardModal.disableSelectCollageButton=i.data.length<0,i.imageSRC)this.setPreview(i.imageSRC);else{let e=!1;BeFunky.wait([80,"raf"],()=>{e||BeFunky.showLoadScreen()}),BFN.CollageWizardModal.disableNextButton=!0;let t=PIXI.RenderTexture.create(i.width,i.height);t.clear();let r=null,a=new PIXI.Sprite;a.pluginName="smooth_picture";for(let n=0;n<i.data.length;n++){let l=i.data[n],{menuImageVO:c}=l,{rect:h}=l;r=new PIXI.Texture(c.imageTexture.baseTexture),a.texture=r,a.scale.x=a.currentScale=h.width/r.width,a.scale.y=a.currentScaleY=h.height/r.height,a.x=h.x,a.y=h.y,BFN.Stage.render(a,t,!1),r.destroyGC(!1)}let s=Math.min(this.previewFitSize/t.width,this.previewFitSize/t.height),o=PIXI.RenderTexture.create(Math.floor(t.width*s),Math.floor(t.height*s));a.texture=t,a.scale.x=a.currentScale=o.width/t.width,a.scale.y=a.currentScaleY=o.height/t.height,a.x=0,a.y=0,BFN.Stage.render(a,o),t.destroyGC(!0),a.destroy(!0),BFN.Util.getHTMLImage(o,n=>{e=!0,o.destroyGC(!0),i.imageSRC=n.src,BFN.AutoCollage.setPreview(i.imageSRC),BFN.CollageWizardModal.disableNextButton=!1,BeFunky.hideLoadScreen()},!0)}};Ni.prototype.setPreview=function(i){BFN.CollageWizardModal.previewImage=i};Ni.prototype.selectCurrentLayout=function(){this.layoutObjects.length&&this.layoutIndex<this.layoutObjects.length&&(BFN.CollageMakerCanvasPhotoGridModel.autoCollageLayoutObject=this.layoutObjects[this.layoutIndex])};Ni.prototype.clearLayoutObject=function(i){for(let e=0;e<i.data.length;e++){let t=i.data[e];t.menuImageVO=null,t.rect=null,t.imageSRC=null,delete t.menuImageVO,delete t.rect,delete t.imageSRC}i.data.splice(0),i.data=null,delete i.data,delete i.width,delete i.height};BFN.AutoCollage=new Ni;BFN.maxBrushSize=1024;function Tr(){PIXI.Sprite.call(this),this.init()}Tr.prototype=Object.create(PIXI.Sprite.prototype);Tr.prototype.init=function(){BeFunky.log("ImagePainterBrush Init"),this.initDefaultValues()};Tr.prototype.initDefaultValues=function(){this.radius=25,this.hardness=1,this.strength=1,this.opacity=1,this.inverse=!1,this.useRoughCircleBrush=!1,this.sourceSprite=new PIXI.Sprite,this.sourceSprite.texture=null,this.texture=null,this.sourceSprite.pluginName="filter_renderer",this.brushFilter=BFN.ShaderPool.BrushFilter,this.brushFilter.resolution=1,this.brushFilter.mode="paint"};Tr.prototype.reset=function(){this.sourceSprite.texture&&(this.sourceSprite.texture.destroyGC(!0),this.sourceSprite.texture=null),this.texture&&(this.texture.destroyGC(!0),this.texture=null)};Tr.prototype.updateBrush=function(){this.reset(),this.brushFilter.mode="paint",this.sourceSprite.texture=PIXI.RenderTexture.create(this.radius*2,this.radius*2,1),this.sourceSprite.texture.clear(),this.texture=PIXI.RenderTexture.create(this.radius*2,this.radius*2,1)};Tr.prototype.updateFilter=function(){this.useRoughCircleBrush?(this.roughCircleBrushGraphic||(this.roughCircleBrushGraphic=new PIXI.Graphics),this.roughCircleBrushGraphic.clear(),this.roughCircleBrushGraphic.beginFill(8421504),this.roughCircleBrushGraphic.drawCircle(this.radius,this.radius,this.radius),this.roughCircleBrushGraphic.endFill(),this.sourceSprite.pluginName="sprite",this.sourceSprite.mask=this.roughCircleBrushGraphic):(this.brushFilter.radius=this.radius,this.brushFilter.hardness=this.hardness,this.brushFilter.strength=this.strength,this.brushFilter.opacity=this.opacity,this.brushFilter.inverse=this.inverse,this.sourceSprite.pluginName="filter_renderer",this.sourceSprite.mask=null,this.sourceSprite.bfn_shaders=[this.brushFilter]),this.updateTexture()};Tr.prototype.updateTexture=function(){this.texture&&BFN.Stage.render(this.sourceSprite,this.texture)};Object.defineProperty(Tr.prototype,"sourceTexture",{get:function(){return this.sourceSprite.texture}});BFN.ImagePainterBrush=Tr;BFN.ImagePainterEvents={BRUSH_RADIUS_UPDATED:new Event("BRUSH_RADIUS_UPDATED"),BRUSH_APPLIED:new Event("BRUSH_APPLIED"),BRUSH_DRAG_PROCESSED:new Event("BRUSH_DRAG_PROCESSED"),PAINT_UPDATED:new Event("PAINT_UPDATED"),PAINT_UPDATED_PRE_HISTORY:new Event("PAINT_UPDATED_PRE_HISTORY"),PAINTING_STARTED:new Event("PAINTING_STARTED"),PAINTING_COMPLETE:new Event("PAINTING_COMPLETE"),PAINT_APPLIED_UPDATED:new Event("PAINT_APPLIED_UPDATED"),PAINTING_ENABLED_UPDATED:new Event("PAINTING_ENABLED_UPDATED"),PAINTER_PRESSED:new Event("PAINTER PRESSED")};function Ae(){PIXI.Sprite.call(this),BFN.EventDispatcher.call(this),this.init()}Ae.prototype=window.azrc.extend(Object.create(PIXI.Sprite.prototype),Object.create(BFN.EventDispatcher.prototype));Ae.prototype.init=function(){BeFunky.log("ImagePainter Init"),this.initDefaultValues(),this.initBrushPool(),this.initBrush()};Ae.prototype.initDefaultValues=function(){this.interactive=!0,this.brushHardnessAdjustFactor=1,this.prevTexture=null,this.prevTextureSprite=new PIXI.Sprite,this.paintTexture=null,this.paintTextureSprite=new PIXI.Sprite,this.referenceContainer=new PIXI.Container,this.referenceContainer.addChild(this.prevTextureSprite),this.referenceContainer.addChild(this.paintTextureSprite),this.altTexture=null,this.regionTexture=null,this.regionSprite=new PIXI.Sprite,this.lowerResolutionForLargeImages=!0,this.minHistoryResolution=.5,this.enabled=!0,this._paintingEnabled=!0,this.usePaintTexture=!0,this.dispatchEventsAfterUpdate=!0,this.eraseMode=!1,this.singleClick=!1,this.ignoreInitialPress=!1,this.ignoreMouseMove=!1,this._brushSizeFactor=.25,this.brushRadius=25,this.brushHardness=1,this.brushStrength=1,this.brushOpacity=1,this._brushColor=16777215,this.painterWidth=0,this.painterHeight=0,this._scale=1,this._adjustScale=1,this.isSetup=!1,this.setupPending=!1,this.delaySetupTillPaintingEnabled=!1,this.dispatchPainterPressedEvent=!1,this.brushEnabled=!0,this.allowBrushCircle=!1,this.clicksEnabled=!0,this.scaleAffectsBrushRadius=!0,this.minBrushRadius=1,this.maxBrushRadius=BFN.maxBrushSize/2,this.brushStepDistance=10,this.brushX=0,this.brushX=0,this.brushPoint=new PIXI.Point,this.brushRect=new PIXI.Rectangle,this.brushBeta=0,this.backgroundColor=null,this.nearestScaleMode=!1,this._paintBounds={x:5,y:5,width:20,height:20,left:5,top:5,right:25,bottom:25},this._paintApplied=!1,this.brushGraphic=new PIXI.Graphics,this.staggerEnabled=!1,this.staggerInterval=5,this.staggerTimer=0,this.mouseDown=!1,this.mouseHovering=!1,this.brushSizeChanged=!1,this.hideBrushCircleAfterPaint=!1,this.batchRender=!1,this.brushPoints=[],this.brushDragRequested=!1,this.subjectIsolated=!1,this.handleMouseOverBind=this.handleMouseOver.bind(this),this.handleMouseOutBind=this.handleMouseOut.bind(this),this.handleHoveredMouseMoveBind=this.handleHoveredMouseMove.bind(this),this.handleMouseDownBind=this.handleMouseDown.bind(this),this.handleMouseMoveBind=this.handleMouseMove.bind(this),this.handleMouseUpBind=this.handleMouseUp.bind(this),this.handleTouchDownBind=this.handleTouchDown.bind(this),this.handleTouchMoveBind=this.handleTouchMove.bind(this),this.handleTouchUpBind=this.handleTouchUp.bind(this),this.handleCanvasScalingUpdatedBind=this.handleCanvasScalingUpdated.bind(this),this.preUndoCallback=null,this.preRedoCallback=null};Ae.prototype.initBrushPool=function(){BFN.hasOwnProperty("BrushPool")||(BFN.BrushPool=new BFN.SpritePool,BFN.BrushPool.grow(200)),this.brushPool=BFN.BrushPool,this.brushSpriteContainer=new PIXI.particles.ParticleContainer(5e3,{scale:!1,position:!0,rotation:!1,uvs:!1,alpha:!1}),this.maskRegionGraphic=new PIXI.Graphics,this.maskRegionGraphic.beginFill(16777215,1),this.maskRegionGraphic.drawRect(0,0,100,100),this.maskRegionGraphic.endFill(),BFN.Stage.state.blendModes[20]=[0,WebGLRenderingContext.ONE_MINUS_SRC_ALPHA]};Ae.prototype.initBrush=function(){this.brush=new BFN.ImagePainterBrush,this.brush.radius=this.brushRadius,this.brush.hardness=this.brushHardness,this.brush.strength=this.brushStrength};Ae.prototype.setup=function(i,e){if(this.reset(),this.painterWidth=i,this.painterHeight=e,this.texture)try{this.texture.destroyGC(!0)}catch(t){}this.texture=null,this.setupPending=!0,(!this.delaySetupTillPaintingEnabled||this.delaySetupTillPaintingEnabled&&this._paintingEnabled)&&this.completeSetup(),BFN.ImagePainterUndoManager.setImagePainter(this)};Ae.prototype.completeSetup=function(){if(this.enabled&&this.setupPending){let i=this.lowerResolutionForLargeImages&&this.painterWidth*this.painterHeight>Math.pow(2048,2)?.5:1,e=this.nearestScaleMode?PIXI.SCALE_MODES.NEAREST:PIXI.settings.SCALE_MODE;this.texture=PIXI.RenderTexture.create(this.painterWidth,this.painterHeight,e,i),this.backgroundColor===null?this.texture.clear():this.texture.fillColor(this.backgroundColor),this.usePaintTexture&&(this.paintTexture=PIXI.RenderTexture.create(this.painterWidth,this.painterHeight),this.paintTexture.clear(),this.paintTextureSprite.texture=this.paintTexture),this.prevTexture=PIXI.RenderTexture.create(this.painterWidth,this.painterHeight,PIXI.settings.SCALE_MODE,i),this.backgroundColor===null?this.prevTexture.clear():this.prevTexture.fillColor(this.backgroundColor),this.prevTextureSprite.texture=this.prevTexture,this.updatePrevTexture(),this.updateHitArea(),this.brushSizeFactor=this.brushSizeFactor,requestAnimationFrame(()=>{this.updateBrush()}),this.on("pointerover",this.handleMouseOverBind),this.on("pointerout",this.handleMouseOutBind),this.on("pointerdown",BeFunky.isMobile?this.handleTouchDownBind:this.handleMouseDownBind);let t=BFN.AppModel.sectionValue(BFN.PhotoEditorCanvasModel,BFN.CollageMakerCanvasModel,BFN.DesignerCanvasModel),r=BFN.AppModel.sectionValue(BFN.PhotoEditorCanvasModelEvents,BFN.CollageMakerCanvasModelEvents,BFN.DesignerCanvasModelEvents);t.addEventListener(r.CANVAS_SCALING_UPDATED.type,this.handleCanvasScalingUpdatedBind),this.isSetup=!0,this.setupPending=!1}};Ae.prototype.clear=function(i=!0){this.paintApplied=!1,this.texture&&(this.backgroundColor===null?this.texture.clear():this.texture.fillColor(this.backgroundColor),this.usePaintTexture&&this.paintTexture.clear(),i&&BFN.ImagePainterUndoManager.setImagePainter(this)),BFN.MainUI.requestRender()};Ae.prototype.reset=function(){if(this.paintApplied=!1,this.delaySetupTillPaintingEnabled&&(this._paintingEnabled=!1),this.isSetup){if(this.isSetup=!1,this.setupPending=!1,this.painterWidth=0,this.painterHeight=0,this.brush.reset(),this.texture){try{this.texture.destroyGC(!0)}catch(t){}this.texture=PIXI.Texture.EMPTY}if(this.usePaintTexture)try{this.paintTexture.destroyGC(!0)}catch(t){}this.paintTexture=null,this.paintTextureSprite.texture=PIXI.Texture.EMPTY;try{this.prevTexture.destroyGC(!0)}catch(t){}this.prevTexture=null,this.prevTextureSprite.texture=PIXI.Texture.EMPTY;try{this.regionTexture.destroyGC(!0)}catch(t){}this.regionTexture=null,this.regionSprite.texture=null,this.altTexture=null,this.updateHitArea(),BFN.ImagePainterUndoManager.reset(),BFN.BrushCirclePreview.hide(),BFN.BrushCircle.hide(),this.off("pointerover",this.handleMouseOverBind),this.off("pointerout",this.handleMouseOutBind),this.off("pointerdown",BeFunky.isMobile?this.handleTouchDownBind:this.handleMouseDownBind),document.removeEventListener(BeFunky.pointerup,this.handleMouseUpBind,!0),BFN.MainUI.off("pointermove",this.handleMouseMoveBind);let i=BFN.AppModel.sectionValue(BFN.PhotoEditorCanvasModel,BFN.CollageMakerCanvasModel,BFN.DesignerCanvasModel),e=BFN.AppModel.sectionValue(BFN.PhotoEditorCanvasModelEvents,BFN.CollageMakerCanvasModelEvents,BFN.DesignerCanvasModelEvents);i.removeEventListener(e.CANVAS_SCALING_UPDATED.type,this.handleCanvasScalingUpdatedBind)}};Ae.prototype.updateBrush=function(){this.brushGraphic.clear(),this.brushGraphic.beginFill(this._brushColor,1),this.brushGraphic.drawRect(0,0,this.brushRadius*2,this.brushRadius*2),this.brushGraphic.endFill(),this.brush.radius=this.brushRadius,this.brush.hardness=this.brushHardness*.98*Math.max(0,Math.min(1,this.brushHardnessAdjustFactor)),this.brush.strength=this.brushHardness*.95+.05,this.brush.opacity=this.brushOpacity,this.brush.updateBrush(),this.regionTexture?this.regionTexture.resize(this.brushRadius*2,this.brushRadius*2):this.regionTexture=PIXI.RenderTexture.create(this.brushRadius*2,this.brushRadius*2),this.regionSprite.texture=this.regionTexture,this.updateHitArea(),this.brushSizeChanged=!1,this.isSetup&&(this.mouseHovering&&this._paintingEnabled&&BFN.BrushCircle.show(this.brushRadius*this._scale/this._adjustScale),BFN.BrushCirclePreview.hide())};Ae.prototype.updateHitArea=function(){this.hitArea=new PIXI.Rectangle(-this.brushRadius,-this.brushRadius,this.painterWidth+this.brushRadius*2,this.painterHeight+this.brushRadius*2)};Ae.prototype.applyBrush=function(){this.paintApplied=!0,this.brushPoint.x=this.brushRect.x=this.brush.x=this.regionSprite.x=this.brushX-this.brushRadius,this.brushPoint.y=this.brushRect.y=this.brush.y=this.regionSprite.y=this.brushY-this.brushRadius,this.brushRect.width=this.brushRadius*2,this.brushRect.height=this.brushRadius*2,this._paintBounds.left=Math.max(0,Math.min(this._paintBounds.left,Math.floor(this.brushX-this.brushRadius))),this._paintBounds.right=Math.min(this.painterWidth,Math.max(this._paintBounds.right,Math.ceil(this.brushX+this.brushRadius))),this._paintBounds.top=Math.max(0,Math.min(this._paintBounds.top,Math.floor(this.brushY-this.brushRadius))),this._paintBounds.bottom=Math.min(this.painterHeight,Math.max(this._paintBounds.bottom,Math.ceil(this.brushY+this.brushRadius))),this.updatePaintBounds(),BFN.MainUI.requestRender(),this.dispatchEvent(BFN.ImagePainterEvents.BRUSH_APPLIED)};Ae.prototype.moveBrushTo=function(i,e){this.brushX=Math.floor(i),this.brushY=Math.floor(e),this.brushBeta=this.mouseDown?this.brushBeta:0,this._paintBounds.left=this._paintBounds.right=this.brushX,this._paintBounds.top=this._paintBounds.bottom=this.brushY,this.updatePaintBounds()};Ae.prototype.dragBrushTo=function(i,e,t=!1){let r=Math.floor(i)-this.brushX,a=Math.floor(e)-this.brushY,s=Math.sqrt(r*r+a*a),o=Math.atan2(a,r);if(!t&&s<this.brushStepDistance)return;this.brushBeta=this.mouseDown?this.brushBeta:o;let n=Math.max(1,Math.ceil(s/Math.max(1,this.brushStepDistance))),l=this.brushX,c=this.brushY;this.batchRender=!0,this.brushPoints.splice(0);for(let h=1;h<=n;h++)this.brushPoints.push(new PIXI.Point(Math.floor(l+Math.cos(o)*s*(h/n)),Math.floor(c+Math.sin(o)*s*(h/n))));if(this.brushPoints.length){if(this.brushEnabled){this.eraseMode?this.paintTextureSprite.blendMode=20:this.paintTextureSprite.blendMode=0,this.brushPool.growTo(this.brushPoints.length);for(let u=0;u<this.brushPoints.length;u++){let d=this.brushPool.getSprite(u,this.brushPoints[u],this.brush.texture);this.brushSpriteContainer.addChild(d)}let h=this.getDraggedBrushBounds(this.brushPoints,this.brushRadius);this.maskRegionGraphic.clear(),this.maskRegionGraphic.beginFill(16777215,1),this.maskRegionGraphic.drawRect(h.x,h.y,h.width,h.height),this.maskRegionGraphic.endFill(),this.brushSpriteContainer.mask=this.maskRegionGraphic,this.usePaintTexture?BFN.Stage.render(this.brushSpriteContainer,this.paintTexture,!1):BFN.Stage.render(this.brushSpriteContainer,this.texture,!1),this.brushSpriteContainer.mask=null,this.brushSpriteContainer.children.length&&this.brushSpriteContainer.removeChildren(0,this.brushSpriteContainer.children.length),this.usePaintTexture&&(this.texture.clearRect(h.x,h.y,h.width,h.height),this.prevTextureSprite.visible=!this.altTexture,this.referenceContainer.mask=this.maskRegionGraphic,BFN.Stage.render(this.referenceContainer,this.texture,!1),this.referenceContainer.mask=null)}for(let h=0;h<this.brushPoints.length;h++)this.brushX=this.brushPoints[h].x,this.brushY=this.brushPoints[h].y,this.applyBrush();this.batchRender=!1}};Ae.prototype.getDraggedBrushBounds=function(i,e){let t={x:0,y:0,width:0,height:0};if(i.length){let r=i[0],a=i[i.length-1],s=a.x-r.x,o=a.y-r.y,n,l,c,h;s<0?o<0?(n=a.x,l=a.y,c=r.x,h=r.y):(n=a.x,l=r.y,c=r.x,h=a.y):o<0?(n=r.x,l=a.y,c=a.x,h=r.y):(n=r.x,l=r.y,c=a.x,h=a.y),t.x=n-e,t.y=l-e,t.width=c-n+e*2,t.height=h-l+e*2}return t};Ae.prototype.updatePrevTexture=function(){this.altTexture?this.prevTexture.copyPixels(this.altTexture):this.prevTexture.copyPixels(this.texture)};Ae.prototype.updatePaintBounds=function(){this._paintBounds.x=this._paintBounds.left,this._paintBounds.y=this._paintBounds.top,this._paintBounds.width=Math.abs(this._paintBounds.right-this._paintBounds.left),this._paintBounds.height=Math.abs(this._paintBounds.bottom-this._paintBounds.top)};Ae.prototype.updateComplete=function(){this.usePaintTexture?this.paintTexture.clear():this.texture.clear()};Ae.prototype.updateStaggerTimer=function(){this.mouseDown&&(this.staggerTimer++,this.staggerTimer>=this.staggerInterval&&(this.staggerTimer=0,this.applyBrush()),setTimeout(this.updateStaggerTimer.bind(this),0))};Ae.prototype.cancelPaintStroke=function(){this.mouseDown&&(this.usePaintTexture?this.paintTexture.clear():this.texture.clear(),this.altTexture?this.altTexture.copyPixels(this.prevTexture):this.texture.copyPixels(this.prevTexture),this.dispatchEvent(BFN.ImagePainterEvents.BRUSH_APPLIED),this.mouseDown=!1,this.brushDragRequested=!1,this.mouseHovering||this.handleMouseOutBind(this),document.removeEventListener(BeFunky.pointerup,this.handleMouseUpBind,!0),(!this.singleClick||this.altTexture)&&BFN.MainUI.off("pointermove",this.handleMouseMoveBind),window.UIScreens.toggleMouseEvent(!0))};Ae.prototype.showBrushCircle=function(i){let e=BFN.AppModel.sectionValue(BFN.PhotoEditorCanvasModel,BFN.CollageMakerCanvasModel,BFN.DesignerCanvasModel);this.isSetup&&!e.canvasScaling&&!this.brushSizeChanged&&(this._paintingEnabled||this.allowBrushCircle)&&BFN.BrushCircle.show(this.brushRadius*this._scale/this._adjustScale,i)};Ae.prototype.hideBrushCircle=function(){this.isSetup&&BFN.BrushCircle.showing&&!this.mouseDown&&BFN.BrushCircle.hide()};Ae.prototype.handleMouseOver=function(i){this.mouseHovering=!0,BFN.MainUI.on("pointermove",this.handleHoveredMouseMoveBind),this.brushSizeChanged&&this.updateBrush(),this.showBrushCircle(i)};Ae.prototype.handleMouseOut=function(i){this.mouseHovering=!1,BFN.MainUI.off("pointermove",this.handleHoveredMouseMoveBind),this.hideBrushCircle()};Ae.prototype.handleHoveredMouseMove=function(i){this.isSetup&&!BFN.BrushCircle.showing&&this.showBrushCircle(i)};Ae.prototype.handleMouseDown=function(i){if(this.dispatchPainterPressedEvent&&(BFN.ImagePainterEvents.PAINTER_PRESSED.data={pointerEvent:i},this.dispatchEvent(BFN.ImagePainterEvents.PAINTER_PRESSED)),!(i&&i.data&&i.data.originalEvent&&(i.data.originalEvent.button===2||this.mouseDown))&&this._paintingEnabled&&this.clicksEnabled){this.mouseDown=!0,this.brushDragRequested=!1,this.updatePrevTexture(),BFN.Stage.render(this.brushGraphic,this.brush.sourceTexture),this.brush.updateFilter(),this.brushBeta=0,this.mouseStartPosition=this.getPointerPosition(i);let e=this.getMousePosition();e.x!=this.mouseStartPosition.x&&e.y!=this.mouseStartPosition.y&&(this.hideBrushCircleAfterPaint=!0,this.showBrushCircle(i)),this.moveBrushTo(this.mouseStartPosition.x,this.mouseStartPosition.y),this.ignoreInitialPress||this.dragBrushTo(this.mouseStartPosition.x,this.mouseStartPosition.y,!0),window.UIScreens.toggleMouseEvent(!1),document.addEventListener(BeFunky.pointerup,this.handleMouseUpBind,!0),this.dispatchEvent(BFN.ImagePainterEvents.PAINTING_STARTED),this.singleClick||(this.staggerEnabled&&(this.staggerTimer=0,this.updateStaggerTimer()),BFN.MainUI.on("pointermove",this.handleMouseMoveBind),BFN.smoothPictureDisabled=!0)}};Ae.prototype.handleMouseMove=function(i){this.ignoreMouseMove||(this.staggerTimer=0,this.lastMouseMoveEvent=i,this.brushDragRequested||(this.brushDragRequested=!0,this.handleMainUIPreRenderBind||(this.handleMainUIPreRenderBind=this.handleMainUIPreRender.bind(this)),BFN.MainUI.addEventListener(BFN.MainUIEvents.PRE_RENDER.type,this.handleMainUIPreRenderBind)))};Ae.prototype.handleMainUIPreRender=function(i){BFN.MainUI.removeEventListener(BFN.MainUIEvents.PRE_RENDER.type,this.handleMainUIPreRenderBind),this.processBrushDrag(this.lastMouseMoveEvent)};Ae.prototype.processBrushDrag=function(i){if(this.brushDragRequested&&this.mouseDown){this.brushDragRequested=!1,this.mouseCurrentPosition=this.getPointerPosition(i);let e=this.mouseCurrentPosition.x-this.mouseStartPosition.x,t=this.mouseCurrentPosition.y-this.mouseStartPosition.y;this.brushBeta=Math.atan2(t,e),this.dragBrushTo(this.mouseCurrentPosition.x,this.mouseCurrentPosition.y),this.mouseStartPosition=this.mouseCurrentPosition,this.dispatchEvent(BFN.ImagePainterEvents.BRUSH_DRAG_PROCESSED)}};Ae.prototype.handleMouseUp=function(i){BFN.smoothPictureDisabled=!1,this.mouseDown=!1,this.brushDragRequested=!1,this.mouseHovering?this.hideBrushCircleAfterPaint&&(this.hideBrushCircle(),this.hideBrushCircleAfterPaint=!1):this.handleMouseOutBind(this),this.dispatchEvent(BFN.ImagePainterEvents.PAINTING_COMPLETE),this.updateComplete(),document.removeEventListener(BeFunky.pointerup,this.handleMouseUpBind,!0),window.UIScreens.toggleMouseEvent(!0),(!this.singleClick||this.altTexture)&&(BFN.MainUI.off("pointermove",this.handleMouseMoveBind),this.dispatchEventsAfterUpdate&&(this.dispatchEvent(BFN.ImagePainterEvents.PAINT_UPDATED_PRE_HISTORY),this.dispatchEvent(BFN.ImagePainterEvents.PAINT_UPDATED)))};Ae.prototype.handleTouchDown=function(i){if(BFN.GestureManager.multiplePointersActive||this.touchDown){this.touchDown&&this.stopTouch();return}this.startTouch(),this.touchDownEvent=i,this.touchDownX=i.data.originalEvent.pageX,this.touchDownY=i.data.originalEvent.pageY};Ae.prototype.handleTouchMove=function(i){let e=i.data.originalEvent.pageX,t=i.data.originalEvent.pageY,r=e-this.touchDownX,a=t-this.touchDownY;Math.sqrt(Math.pow(r,2)+Math.pow(a,2))>5&&(this.applyTouch(),this.stopTouch())};Ae.prototype.handleTouchUp=function(i){this.applyTouch(),this.stopTouch(),BeFunky.dispatchPointerEvent("pointerup",document,"touch",i.clientX,i.clientY)};Ae.prototype.startTouch=function(){this.touchDown||(this.touchDown=!0,BFN.MainUI.on("pointermove",this.handleTouchMoveBind),document.addEventListener(BeFunky.pointerup,this.handleTouchUpBind,!0),this.touchTimeoutID=setTimeout(()=>{this.applyTouch(),this.stopTouch()},50))};Ae.prototype.stopTouch=function(){!this.touchDown||(delete this.touchDown,delete this.touchDownEvent,delete this.touchDownX,delete this.touchDownY,BFN.MainUI.off("pointermove",this.handleTouchMoveBind),document.removeEventListener(BeFunky.pointerup,this.handleTouchUpBind,!0),clearTimeout(this.touchTimeoutID))};Ae.prototype.applyTouch=function(){BFN.GestureManager.multiplePointersActive||!this.touchDownEvent||this.handleMouseDown(this.touchDownEvent)};Ae.prototype.handleCanvasScalingUpdated=function(i){let e=BFN.AppModel.sectionValue(BFN.PhotoEditorCanvasModel,BFN.CollageMakerCanvasModel,BFN.DesignerCanvasModel);BFN.ImagePainterUndoManager.currentImagePainter==this&&!e.canvasScaling&&(this.toolScale=this._scale,this.updateBrush())};Object.defineProperty(Ae.prototype,"toolScale",{set:function(i){this._scale=i,this.scaleUpdated=!0,this.brushSizeFactor=this.brushSizeFactor,this.scaleUpdated=!1},get:function(){return this._scale}});Object.defineProperty(Ae.prototype,"adjustScale",{set:function(i){this._adjustScale=i},get:function(){return this._adjustScale}});Object.defineProperty(Ae.prototype,"brushSizeFactor",{set:function(i){this._brushSizeFactor=Math.max(0,Math.min(1,i));let e=i*i;this.scaleAffectsBrushRadius?this.brushRadius=Math.round((Math.min(this.maxBrushRadius,this.painterWidth/2,this.painterHeight/2,this.painterWidth/2*(1/this._scale),this.painterHeight/2*(1/this._scale))-this.minBrushRadius)*e+this.minBrushRadius):this.brushRadius=Math.round((Math.min(this.maxBrushRadius,this.painterWidth/2,this.painterHeight/2)-this.minBrushRadius)*e+this.minBrushRadius),this.brushStepDistance=Math.round(Math.max(this.brushRadius/4,1)),this.dispatchEvent(BFN.ImagePainterEvents.BRUSH_RADIUS_UPDATED),BFN.AppModel.sectionValue(BFN.PhotoEditorCanvasModel,BFN.CollageMakerCanvasModel,BFN.DesignerCanvasModel).canvasScaling||(this.brushSizeChanged||(this.brushSizeChanged=!0,this.isSetup&&BFN.BrushCircle.showing&&BFN.BrushCircle.hide()),this.isSetup&&!this.scaleUpdated&&BFN.BrushCirclePreview.show(this.brushRadius*this._scale/this._adjustScale)),this.targetStep=Math.round(Math.min(Math.max(Math.max(this.painterWidth,this.painterHeight)/(this.brushRadius*2),4),10))},get:function(){return this._brushSizeFactor}});Object.defineProperty(Ae.prototype,"brushHardnessFactor",{set:function(i){this.brushHardness=Math.max(0,Math.min(1,i))},get:function(){return this.brushHardness}});Object.defineProperty(Ae.prototype,"brushStrengthFactor",{set:function(i){this.brushStrength=Math.max(0,Math.min(1,i*.95+.05)),this.paintTextureSprite.alpha=this.brushStrength},get:function(){return this.brushStrength}});Object.defineProperty(Ae.prototype,"brushOpacityFactor",{set:function(i){this.brushOpacity=Math.max(0,Math.min(1,i))},get:function(){return this.brushOpacity}});Object.defineProperty(Ae.prototype,"brushColor",{set:function(i){this._brushColor=i},get:function(){return this._brushColor}});Object.defineProperty(Ae.prototype,"paintingEnabled",{set:function(i){this._paintingEnabled!=i&&(this._paintingEnabled=i,this.delaySetupTillPaintingEnabled&&this._paintingEnabled&&this.completeSetup(),this.dispatchEvent(BFN.ImagePainterEvents.PAINTING_ENABLED_UPDATED))},get:function(){return this._paintingEnabled}});Object.defineProperty(Ae.prototype,"paintBounds",{set:function(i){i&&(this._paintBounds.x=this._paintBounds.left=Math.floor(i.x)-1,this._paintBounds.y=this._paintBounds.top=Math.floor(i.y)-1,this._paintBounds.width=Math.ceil(i.width)+2,this._paintBounds.height=Math.ceil(i.height)+2,this._paintBounds.right=this._paintBounds.x+this._paintBounds.width,this._paintBounds.bottom=this._paintBounds.y+this._paintBounds.height)},get:function(){return this._paintBounds}});Object.defineProperty(Ae.prototype,"paintApplied",{set:function(i){i!=this._paintApplied&&(this._paintApplied=i,this.dispatchEvent(BFN.ImagePainterEvents.PAINT_APPLIED_UPDATED))},get:function(){return BFN.ImagePainterUndoManager.currentImagePainter===this?this._paintApplied||BFN.ImagePainterUndoManager.memoryFreed:this._paintApplied}});BFN.ImagePainter=Ae;function ni(){PIXI.Sprite.call(this),this.init()}ni.prototype=Object.create(PIXI.Sprite.prototype);ni.prototype.init=function(){BeFunky.log("ImageTouchUp Init"),this.initDefaultValues(),this.initImageContainer(),this.initSourceSprite(),this.initRenderSprite(),this.initPainter()};ni.prototype.initDefaultValues=function(){this.sourceTexture=null,this.renderTexture=null,this._scale=1,this.active=!1,BFN.EffectManager.addEventListener(BFN.EffectManagerEvents.EFFECT_COMPLETE.type,this.handleEffectComplete.bind(this))};ni.prototype.initImageContainer=function(){this.imageContainer=new PIXI.Sprite,this.addChild(this.imageContainer)};ni.prototype.initSourceSprite=function(){this.sourceSprite=new PIXI.Sprite,this.sourceSprite.pluginName="smooth_picture",this.imageContainer.addChild(this.sourceSprite)};ni.prototype.initRenderSprite=function(){this.renderSprite=new PIXI.Sprite,this.renderSprite.pluginName="smooth_picture",this.imageContainer.addChild(this.renderSprite)};ni.prototype.initPainter=function(){this.painter=new BFN.ImagePainter,this.painter.pluginName="smooth_picture",this.painter.brushOpacityFactor=.1,this.painter.brushHardnessAdjustFactor=.7,this.imageContainer.addChild(this.painter),this.renderSprite.mask=this.painter};ni.prototype.handleTouchUpBrush=function(){this.updateTouchUpBrushParameters()};ni.prototype.handleUpdateTool=function(i){if(BFN.PhotoEditorCanvasModel.viewState==BFN.PhotoEditorCanvasModelViewStates.VIEWING_TOUCH_UP){let e=i,t=null;if(BFN.effectPresetMap.hasOwnProperty("touchup_"+e)&&BFN.effectMap.hasOwnProperty(BFN.effectPresetMap["touchup_"+e])&&(t=BFN.effectPresetMap["touchup_"+e]),t){switch(this.painter.brushOpacityFactor=.1,this.painter.brushHardnessAdjustFactor=.7,e){case"fix_redeye":this.painter.brushOpacityFactor=1,this.painter.brushHardnessAdjustFactor=1;break}let r=!1;e!=t&&UITools.getToolVO(t)!=UITools.getToolVO(e)&&(UITools.toolVOs[t]=UITools.getToolVO(e),r=!0);let a=UITools.getToolVO(e);this.currentToolID!=i&&(this.currentToolID=i,UITools.setToolValue("touch_up_brush","size",Math.round(a.brush_size*100)),UITools.setToolValue("touch_up_brush","hardness",Math.round(a.brush_hardness*100)),UITools.updateToolControls("touch_up_brush"),this.updateTouchUpBrushParameters());let s=!1;if(BFN.EffectManager.effectID!=t||r){s=!0,BFN.applyCancelMenu.setStyles({pointerEvents:"none"}),clearTimeout(this.timeoutID);let o=()=>{BFN.MainUI.viewportUpdating?this.timeoutID=setTimeout(o,16):(this.active&&(BFN.EffectManager.effectID=t),BFN.applyCancelMenu.setStyles({pointerEvents:""}))};this.timeoutID=setTimeout(o,16)}BFN.EffectManager.changing!=a.updating&&(BFN.EffectManager.changing=a.updating),s||(BFN.EffectManager.parameters=a),!a.updating&&!s&&BFN.EffectManager.processEffect()}}};ni.prototype.setSourceTexture=function(i){this.sourceTexture!=null&&(this.sourceTexture=null,this.sourceSprite.texture=PIXI.Texture.EMPTY),this.renderTexture!=null&&(this.renderTexture.destroyGC(!0),this.renderTexture=null),this.active=!1,this.currentToolID=null,i!=null?(this.active=!0,this.sourceTexture=i,this.renderTexture=PIXI.RenderTexture.create(32,32),BFN.EffectManager.setSourceTexture(this.sourceTexture),BFN.EffectManager.setRenderTexture(this.renderTexture),BFN.EffectManager.currentComponent=this,this.sourceSprite.texture=this.sourceTexture,this.renderSprite.texture=this.renderTexture,this.imageContainer.x=-Math.round(this.sourceTexture.width/2),this.imageContainer.y=-Math.round(this.sourceTexture.height/2),this.painter.setup(this.sourceTexture.width,this.sourceTexture.height),UITools.setToolValue("touch_up_brush","erase",!1),UITools.updateToolControl("touch_up_brush_erase"),this.updateTouchUpBrushParameters()):(this.painter.reset(),BFN.EffectManager.currentComponent==this&&BFN.EffectManager.reset())};ni.prototype.updateTouchUpBrushParameters=function(){let i=UITools.getToolVO("touch_up_brush");if(i){i.clear&&(this.painter.clear(!0),UITools.setToolValue("touch_up_brush","erase",!1),UITools.updateToolControl("touch_up_brush_erase")),this.painter.eraseMode!=i.erase&&(this.painter.eraseMode=i.erase),i.updating&&i.updating_id=="size"&&this.painter.brushSizeFactor!=i.size/100&&(this.painter.brushSizeFactor=i.size/100);let e=!1;!i.updating&&(i.updating_id=="size"||this.painter.brushSizeFactor!=i.size/100)&&(this.painter.brushSizeFactor=i.size/100,e=!0),!i.updating&&(i.updating_id=="hardness"||this.painter.brushHardnessFactor!=i.hardness/100)&&(this.painter.brushHardnessFactor=i.hardness/100,e=!0),e&&this.painter.updateBrush(),this.currentToolID&&(UITools.setToolValue(this.currentToolID,"brush_size",this.painter.brushSizeFactor),UITools.setToolValue(this.currentToolID,"brush_hardness",this.painter.brushHardnessFactor))}};ni.prototype.setSmoothingScale=function(i){this.sourceSprite.currentScale=i,this.renderSprite.currentScale=i,this.painter.currentScale=i};ni.prototype.handleEffectComplete=function(){BFN.MainUI.requestRender()};Object.defineProperty(ni.prototype,"toolScale",{set:function(i){this._scale=i,this.painter.toolScale=this._scale,this.setSmoothingScale(this._scale)},get:function(){return this._scale}});Object.defineProperty(ni.prototype,"modifiedTexture",{get:function(){let i=PIXI.RenderTexture.create(this.sourceSprite.width,this.sourceSprite.height);return this.imageContainer.x=this.imageContainer.y=0,this.setSmoothingScale(1),BFN.Stage.render(this.imageContainer,i),this.imageContainer.x=-Math.round(this.sourceTexture.width/2),this.imageContainer.y=-Math.round(this.sourceTexture.height/2),this.setSmoothingScale(this._scale),i}});Object.defineProperty(BFN,"ImageTouchUp",{get:function(){return BFN._ImageTouchUp||(BFN._ImageTouchUp=new ni),BFN._ImageTouchUp}});BFN.ImageEffectEvents={CLEAR_PAINT:new Event("CLEAR_PAINT"),INVERSE_PAINT:new Event("INVERSE_PAINT")};function at(){PIXI.Sprite.call(this),BFN.EventDispatcher.call(this),this.init()}at.prototype=window.azrc.extend(Object.create(PIXI.Sprite.prototype),Object.create(BFN.EventDispatcher.prototype));at.prototype.init=function(){BeFunky.log("ImageEffect Init"),this.initDefaultValues(),this.initImageContainer(),this.initSourceSprite(),this.initRenderSprite(),this.initMaskBlendSprite(),this.initMaskSprite(),this.initPainter()};at.prototype.initDefaultValues=function(){this.sourceTexture=null,this.renderTexture=null,this._inverse=!1,this._scale=1,this.active=!1,this.effectToolVO=null,this.effectReady=!1,this.effectFadeable=!1,this.sourceTransparency=!1,this.transparentMode=!1,this.hidePaint=!1,BFN.EffectManager.addEventListener(BFN.EffectManagerEvents.EFFECT_COMPLETE.type,this.handleEffectComplete.bind(this))};at.prototype.initImageContainer=function(){this.imageContainer=new PIXI.Sprite,this.addChild(this.imageContainer)};at.prototype.initSourceSprite=function(){this.sourceSprite=new PIXI.Sprite,this.sourceSprite.pluginName="smooth_picture",this.imageContainer.addChild(this.sourceSprite)};at.prototype.initRenderSprite=function(){this.renderSprite=new PIXI.Sprite,this.renderSprite.pluginName="smooth_picture",this.imageContainer.addChild(this.renderSprite)};at.prototype.initMaskBlendSprite=function(){this.maskBlendSprite=new BFN.MaskBlendSprite,this.maskBlendSprite.pluginName="smooth_picture",this.imageContainer.addChild(this.maskBlendSprite)};at.prototype.initMaskSprite=function(){this.maskSprite=new PIXI.Sprite(PIXI.RenderTexture.create(200,200)),this.maskSprite.texture.fillColor(16711680,.5),this.maskSprite.interactive=!1,this.imageContainer.addChild(this.maskSprite)};at.prototype.initPainter=function(){this.painter=new BFN.ImagePainter,this.painter.pluginName="smooth_picture",this.painter.paintingEnabled=!1,this.painter.delaySetupTillPaintingEnabled=!0,this.imageContainer.addChild(this.painter),BFN.ImagePainterUndoManager.addEventListener(BFN.ImagePainterUndoManagerEvents.PAINT_UPDATED.type,this.handlePainterUpdated.bind(this)),BFN.ImagePainterUndoManager.addEventListener(BFN.ImagePainterUndoManagerEvents.ALT_TEXTURE_UPDATED.type,this.handlePainterUpdated.bind(this)),this.painter.addEventListener(BFN.ImagePainterEvents.BRUSH_APPLIED.type,this.handlePainterUpdated.bind(this)),this.painter.addEventListener(BFN.ImagePainterEvents.PAINT_APPLIED_UPDATED.type,this.handlePainterPaintAppliedUpdated.bind(this)),this.painter.addEventListener(BFN.ImagePainterEvents.PAINTING_ENABLED_UPDATED.type,this.handlePainterPaintingEnabledUpdated.bind(this))};at.prototype.handleEffectGeneric=function(){let i=UITools.getToolVO("effect_generic");i.updating_id==="amount"&&(this.updateEffectIntensity(),this.effectToolVO&&this.effectToolVO.hasOwnProperty("amount")&&(this.effectToolVO.amount=i.amount),BFN.MainUI.requestRender())};at.prototype.handleEffectBrush=function(){this.updateEffectBrushParameters()};at.prototype.handleUpdateTool=function(i){if(BFN.PhotoEditorCanvasModel.viewState===BFN.PhotoEditorCanvasModelViewStates.VIEWING_EFFECT){let e=i,t=null;if(BFN.effectMap.hasOwnProperty(e)?t=e:BFN.effectPresetMap.hasOwnProperty(e)&&BFN.effectMap.hasOwnProperty(BFN.effectPresetMap[e])&&(t=BFN.effectPresetMap[e]),!t)return;let r=!1;e!==t&&UITools.getToolVO(t)!==UITools.getToolVO(e)&&(UITools.toolVOs[t]=UITools.getToolVO(e),r=!0,this.effectReady=!1),this.painter.visible=!BFN.EffectsNoPaint.includes(e);let a=UITools.getToolVO(e);this.effectFadeable=!!a.fadeable,this.effectToolVO=a,this.effectToolVO.hasOwnProperty("amount")||(this.effectToolVO.amount=100),this.currentToolID!==i&&(this.currentToolID=i,UITools.setToolValue("effect_generic","amount",a.hasOwnProperty("amount")?a.amount:100),UITools.applyTool("effect_generic"),UITools.updateToolControls("effect_generic")),a.updating_id==="reset"&&(Object.assign(a,a.defaultValues),UITools.updateToolControls(e),this.painter.clear(!0),UITools.setToolValue("effect_brush","erase",!1),UITools.updateToolControl("effect_brush_erase"));let s=!1;(BFN.EffectManager.effectID!==t||r)&&(s=BFN.EffectManager.autoProcess,BFN.applyCancelMenu.setStyles({pointerEvents:"none"}),cancelAnimationFrame(this.timeoutRAF),this.timeoutRAF=requestAnimationFrame(()=>{this.active&&(BFN.EffectManager.effectID=t),BFN.applyCancelMenu.setStyles({pointerEvents:""})}),this.updateMaskDisplay()),BFN.EffectManager.changing!==a.updating&&(!a.hasOwnProperty("real_time")||a.real_time)&&(BFN.EffectManager.changing=a.updating),s||(!a.hasOwnProperty("real_time")||a.real_time)&&(BFN.EffectManager.parameters=a),!a.updating&&!s&&BFN.EffectManager.processEffect()}};at.prototype.setSourceTexture=function(i){this.sourceTexture!=null&&(this.sourceTexture=null,this.sourceSprite.texture=PIXI.Texture.EMPTY),this.renderTexture!=null&&(this.renderTexture.destroyGC(!0),this.renderTexture=null,this.renderSprite.texture=PIXI.Texture.EMPTY),this.active=!1,this.currentToolID=null,this.effectReady=!1,this.effectFadeable=!1,this.sourceTransparency=!1,i?(this.active=!0,this.sourceTexture=i,this.renderTexture=i.renderClone(),BFN.EffectManager.autoProcess=!1,BFN.EffectManager.setSourceTexture(this.sourceTexture),BFN.EffectManager.setRenderTexture(this.renderTexture),BFN.EffectManager.currentComponent=this,BFN.EffectManager.autoProcess=!0,this.sourceTransparency=this.sourceTexture.determineTransparency(),this.updateTransparentMode(!0),this.maskSprite.width=this.sourceTexture.width,this.maskSprite.height=this.sourceTexture.height,this.imageContainer.x=-Math.round(this.sourceTexture.width/2),this.imageContainer.y=-Math.round(this.sourceTexture.height/2),this.painter.setup(this.sourceTexture.width,this.sourceTexture.height),this.inverse=!1,this.updateMaskDisplay(),UITools.setToolValue("effect_brush","show_mask",!1),UITools.setToolValue("effect_brush","select_action","subtract"),UITools.updateToolControls("effect_brush"),this.updateEffectBrushParameters()):(this.renderSprite.mask=null,this.maskBlendSprite.reset(),this.painter.reset(),BFN.EffectManager.currentComponent===this&&BFN.EffectManager.reset())};at.prototype.updateEffectIntensity=function(){let i=UITools.getToolVO("effect_generic");this.transparentMode?this.maskBlendSprite.blendIntensity=i.amount/100:this.renderSprite.alpha=i.amount/100};at.prototype.updateTransparentMode=function(i=!1){let e=this.sourceTransparency||!!(BFN.EffectManager.currentEffect&&BFN.EffectManager.currentEffect.outputTransparent);(this.transparentMode!==e||i)&&(this.transparentMode=e,this.transparentMode?(this.sourceSprite.visible=!1,this.sourceSprite.texture=this.sourceTexture,this.renderSprite.visible=!1,this.renderSprite.texture=PIXI.Texture.EMPTY,this.maskBlendSprite.visible=!0,this.maskBlendSprite.inputTexture=this.sourceTexture,this.maskBlendSprite.blendTexture=this.renderTexture,i||(this.showMask=this.showMask,this.handlePainterUpdated())):(this.renderSprite.visible=!0,this.renderSprite.texture=this.renderTexture,this.sourceSprite.visible=!0,this.sourceSprite.texture=this.sourceTexture,this.maskBlendSprite.visible=!1,this.maskBlendSprite.reset()),i||(this.updateEffectIntensity(),this.updateMaskDisplay()))};at.prototype.updateEffectBrushParameters=function(){let i=UITools.getToolVO("effect_brush");if(i){if(i.updating_id==="isolate_subject"&&!i.updating){let r=["blur","glow","replace_color","cinematic_film_grain","holgaart","motioncolor","multimedia","orton","sunburst","viewfinder","winter"],a=!1;for(let o=0;o<r.length;o++){let n=r[o];if(this.currentToolID.includes(n)){a=!0;break}}let s=a?this.inverse:!this.inverse;this.sourceTexture.altTexture=this.renderTexture,this.sourceTexture.altTextureInverse=!a,BFN.BackgroundRemovalManager.isolateSubjectOnPainter(this.sourceTexture,s,()=>{delete this.sourceTexture.altTexture,delete this.sourceTexture.altTextureInverse});return}i.clear&&(this.painter.clear(!0),UITools.setToolValue("effect_brush","erase",!1),UITools.updateToolControl("effect_brush_erase"),this.transparentMode&&this.maskBlendSprite.updateDisplay(),this.inverse&&(this.inverse=!1,this.updateMaskDisplay()),this.dispatchEvent(BFN.ImageEffectEvents.CLEAR_PAINT)),this.showMask!==i.show_mask&&(this.showMask=i.show_mask,this.updateMaskDisplay()),i.updating_id==="invert"&&(this.inverse=!this.inverse,this.updateMaskDisplay());let e=i.select_action==="subtract"?this.inverse:!this.inverse;this.painter.eraseMode!==e&&(this.painter.eraseMode=e),i.updating&&i.updating_id==="size"&&this.painter.brushSizeFactor!=i.size/100&&(this.painter.brushSizeFactor=i.size/100);let t=!1;!i.updating&&(i.updating_id==="size"||this.painter.brushSizeFactor!=i.size/100)&&(this.painter.brushSizeFactor=i.size/100,t=!0),!i.updating&&(i.updating_id==="hardness"||this.painter.brushHardnessFactor!=i.hardness/100)&&(this.painter.brushHardnessFactor=i.hardness/100,t=!0),!i.updating&&(i.updating_id==="strength"||this.painter.brushStrengthFactor!=i.strength/100)&&(this.painter.brushStrengthFactor=i.strength/100,t=!0),t&&this.painter.updateBrush()}};at.prototype.updateMaskDisplay=function(i=null){i=!!(i===null?this.showMask:i),this.sourceSprite.visible=i&&this.transparentMode||!this.transparentMode&&(this.effectFadeable||this.painter.paintApplied||!this.painter.paintApplied&&(i||this.inverse)),this.renderSprite.visible=!i&&!(this.inverse&&!this.painter.paintApplied)&&!this.transparentMode,this.maskBlendSprite.visible=!i&&this.transparentMode,this.maskSprite.visible=i&&!(this.inverse&&!this.painter.paintApplied);let e=this.painter.isSetup&&this.painter.paintApplied?this.painter:null;this.renderSprite.mask!==e&&(this.renderSprite.mask=this.transparentMode||this.hidePaint?null:e),this.maskSprite.mask!==e&&(this.maskSprite.mask=e),this.painter.renderable=!1,BFN.MainUI.requestRender()};at.prototype.setSmoothingScale=function(i){this.sourceSprite.currentScale=i,this.renderSprite.currentScale=i,this.maskBlendSprite.currentScale=i,this.painter.currentScale=i};at.prototype.handleEffectComplete=function(){this.updateTransparentMode(),this.effectReady||(this.effectReady=!0,this.inverse=this.inverse),this.transparentMode&&this.maskBlendSprite.updateDisplay()};at.prototype.handlePainterUpdated=function(i){if(this.hidePaint){this.maskBlendSprite.maskTexture!==PIXI.Texture.EMPTY&&(this.maskBlendSprite.maskTexture=PIXI.Texture.EMPTY);return}BFN.ImagePainterUndoManager.currentImagePainter===this.painter&&this.painter.isSetup&&this.transparentMode&&(this.maskBlendSprite.maskTexture!==this.painter.texture&&(this.maskBlendSprite.maskTexture=this.painter.texture),this.maskBlendSprite.updateDisplay())};at.prototype.handlePainterPaintAppliedUpdated=function(i){this.updateMaskDisplay()};at.prototype.handlePainterPaintingEnabledUpdated=function(){this.painter.isSetup&&!this.painter.paintingEnabled&&this.showMask&&(UITools.setToolValue("effect_brush","show_mask",!1),UITools.updateToolControl("effect_brush_show_mask"),this.showMask=UITools.getToolValue("effect_brush","show_mask"),this.updateMaskDisplay())};Object.defineProperty(at.prototype,"showMask",{set(i){this._showMask=i,this.transparentMode&&(this.maskBlendSprite.autoRender=!this.showMask)},get(){return this._showMask}});Object.defineProperty(at.prototype,"inverse",{set(i){this._inverse=i,this.maskBlendSprite.inverse=this._inverse&&!this.hidePaint,this.painter.inverseMask=!this._inverse,this.dispatchEvent(BFN.ImageEffectEvents.INVERSE_PAINT),BFN.MainUI.requestRender()},get(){return this._inverse}});Object.defineProperty(at.prototype,"toolScale",{set(i){this._scale=i,this.painter.toolScale=this._scale,this.setSmoothingScale(this._scale)},get(){return this._scale}});Object.defineProperty(at.prototype,"modifiedTexture",{get(){this.transparentMode&&this.maskBlendSprite.displayUpdatePending&&this.maskBlendSprite.renderDisplay();let i=PIXI.RenderTexture.create(this.sourceSprite.width,this.sourceSprite.height);return this.imageContainer.x=this.imageContainer.y=0,this.setSmoothingScale(1),this.updateMaskDisplay(!1),this.removeChild(this.imageContainer),BFN.Stage.render(this.imageContainer,i),this.imageContainer.x=-Math.round(this.sourceTexture.width/2),this.imageContainer.y=-Math.round(this.sourceTexture.height/2),this.setSmoothingScale(this._scale),this.updateMaskDisplay(),this.addChild(this.imageContainer),i}});Object.defineProperty(BFN,"ImageEffect",{get(){return BFN._ImageEffect||(BFN._ImageEffect=new at),BFN._ImageEffect}});function ut(){PIXI.Sprite.call(this),this.init()}ut.prototype=Object.create(PIXI.Sprite.prototype);ut.prototype.init=function(){BeFunky.log("ImageArtsy Init"),this.initDefaultValues(),this.initImageContainer(),this.initSourceSprite(),this.initRenderSprite(),this.initMaskBlendSprite(),this.initMaskSprite(),this.initPainter()};ut.prototype.initDefaultValues=function(){this.sourceTexture=null,this.renderTexture=null,this._inverse=!1,this._scale=1,this.sourceTransparency=!1,BFN.ArtsyManager.addEventListener(BFN.ArtsyManagerEvents.ARTSY_COMPLETE.type,this.handleArtsyComplete.bind(this))};ut.prototype.initImageContainer=function(){this.imageContainer=new PIXI.Sprite,this.addChild(this.imageContainer)};ut.prototype.initSourceSprite=function(){this.sourceSprite=new PIXI.Sprite,this.sourceSprite.pluginName="smooth_picture",this.imageContainer.addChild(this.sourceSprite)};ut.prototype.initRenderSprite=function(){this.renderSprite=new PIXI.Sprite,this.renderSprite.pluginName="smooth_picture",this.imageContainer.addChild(this.renderSprite)};ut.prototype.initMaskBlendSprite=function(){this.maskBlendSprite=new BFN.MaskBlendSprite,this.maskBlendSprite.pluginName="smooth_picture",this.imageContainer.addChild(this.maskBlendSprite)};ut.prototype.initMaskSprite=function(){this.maskSprite=new PIXI.Sprite(PIXI.RenderTexture.create(200,200)),this.maskSprite.texture.fillColor(16711680,.5),this.maskSprite.interactive=!1,this.imageContainer.addChild(this.maskSprite)};ut.prototype.initPainter=function(){this.painter=new BFN.ImagePainter,this.painter.pluginName="smooth_picture",this.painter.paintingEnabled=!1,this.painter.delaySetupTillPaintingEnabled=!0,this.imageContainer.addChild(this.painter),BFN.ImagePainterUndoManager.addEventListener(BFN.ImagePainterUndoManagerEvents.PAINT_UPDATED.type,this.handlePainterUpdated.bind(this)),BFN.ImagePainterUndoManager.addEventListener(BFN.ImagePainterUndoManagerEvents.ALT_TEXTURE_UPDATED.type,this.handlePainterUpdated.bind(this)),this.painter.addEventListener(BFN.ImagePainterEvents.BRUSH_APPLIED.type,this.handlePainterUpdated.bind(this)),this.painter.addEventListener(BFN.ImagePainterEvents.PAINT_APPLIED_UPDATED.type,this.handlePainterPaintAppliedUpdated.bind(this)),this.painter.addEventListener(BFN.ImagePainterEvents.PAINTING_ENABLED_UPDATED.type,this.handlePainterPaintingEnabledUpdated.bind(this))};ut.prototype.handleArtsyGeneric=function(){let i=UITools.getToolVO("artsy_generic");i.updating_id=="amount"&&(this.sourceTransparency?this.maskBlendSprite.blendIntensity=i.amount/100:this.renderSprite.alpha=i.amount/100,BFN.MainUI.requestRender())};ut.prototype.handleArtsyBrush=function(){this.updateArtsyBrushParameters()};ut.prototype.handleUpdateTool=function(i){if(BFN.PhotoEditorCanvasModel.viewState==BFN.PhotoEditorCanvasModelViewStates.VIEWING_ARTSY){let e=i,t=UITools.getToolVO(e);if(!t||t&&(t.updating||!t.hasOwnProperty("id")))return;let r=BFN.ArtsyToolIDs.hasOwnProperty(e)&&BFN.ArtsyToolParams.hasOwnProperty(e),a=BFN.ArtsyAdjustAndPaintToolObjects.hasOwnProperty(e);this.currentToolID!=e&&(r||a)&&(this.currentToolID=e,UITools.setToolValue("artsy_generic","amount",100),UITools.applyTool("artsy_generic"),UITools.updateToolControls("artsy_generic"));let s=t.id,o={},n=!1,l=null;if(r){let c=BFN.ArtsyToolParams[e];for(let u=0;u<c.length;u++){let d=c[u];if(t.hasOwnProperty(d)){let m=BFN.ArtsyToolColorParams.hasOwnProperty(e)&&BFN.ArtsyToolColorParams[e].length&&BFN.ArtsyToolColorParams[e].indexOf(d)!=-1;o[d]=(m?"#":"")+t[d]}}let h=BFN.ArtsyPresetObjects[e];n=h.hasOwnProperty("isArtsy")?h.isArtsy:!0,l=h.hasOwnProperty("maxPixels")?h.maxPixels:null}else if(a){for(let c in t.defaultValues)if(!["id","maxPixels"].includes(c)){let h=UITools.getParamObject(e+"_"+c),u=!!(h&&h.type&&h.type.includes("color"));o[c]=(u?"#":"")+t[c]}l=t.hasOwnProperty("maxPixels")?t.maxPixels:null}else return;BFN.ArtsyService.currentArtsyID=s,BFN.ArtsyService.isArtsy=n,BFN.ArtsyService.maxPixels=l,BFN.ArtsyManager.parameters=o}};ut.prototype.setSourceTexture=function(i){this.sourceTexture!=null&&(this.sourceTexture=null,this.sourceSprite.texture=PIXI.Texture.EMPTY),this.renderTexture!=null&&(this.renderTexture.destroyGC(!0),this.renderTexture=null,this.renderSprite.texture=PIXI.Texture.EMPTY),this.currentToolID=null,this.sourceTransparency=!1,i!=null?(this.sourceTexture=i,this.renderTexture=i.renderClone(),this.sourceTexture.baseTexture.hasOwnProperty("isTransparent"),this.sourceTransparency=this.sourceTexture.determineTransparency(),BFN.ArtsyManager.setSourceTexture(this.sourceTexture),BFN.ArtsyManager.setRenderTexture(this.renderTexture),this.sourceTransparency?(this.sourceSprite.texture=this.sourceTexture,this.sourceSprite.visible=!1,this.renderSprite.visible=!1,this.maskBlendSprite.visible=!0,this.maskBlendSprite.inputTexture=this.sourceTexture,this.maskBlendSprite.blendTexture=this.renderTexture):(this.maskBlendSprite.visible=!1,this.sourceSprite.visible=!0,this.renderSprite.visible=!0,this.sourceSprite.texture=this.sourceTexture,this.renderSprite.texture=this.renderTexture),this.maskSprite.width=this.sourceTexture.width,this.maskSprite.height=this.sourceTexture.height,this.imageContainer.x=-Math.round(this.sourceTexture.width/2),this.imageContainer.y=-Math.round(this.sourceTexture.height/2),this.painter.setup(this.sourceTexture.width,this.sourceTexture.height),this.inverse=!1,this.updateMaskDisplay(),UITools.setToolValue("artsy_brush","show_mask",!1),UITools.setToolValue("artsy_brush","select_action","subtract"),UITools.updateToolControls("artsy_brush"),this.updateArtsyBrushParameters()):(this.renderSprite.mask=null,this.maskBlendSprite.reset(),this.painter.reset(),BFN.ArtsyManager.reset())};ut.prototype.updateArtsyBrushParameters=function(){let i=UITools.getToolVO("artsy_brush");if(i){if(i.updating_id==="isolate_subject"&&!i.updating){this.sourceTexture.altTexture=this.renderTexture,this.sourceTexture.altTextureInverse=!0,BFN.BackgroundRemovalManager.isolateSubjectOnPainter(this.sourceTexture,!this.inverse,()=>{delete this.sourceTexture.altTexture,delete this.sourceTexture.altTextureInverse});return}i.clear&&(this.painter.clear(!0),UITools.setToolValue("artsy_brush","erase",!1),UITools.updateToolControl("artsy_brush_erase"),this.sourceTransparency&&this.maskBlendSprite.updateDisplay(),this.inverse&&(this.inverse=!1,this.updateMaskDisplay())),this.showMask!==i.show_mask&&(this.showMask=i.show_mask,this.updateMaskDisplay()),i.updating_id==="invert"&&(this.inverse=!this.inverse,this.updateMaskDisplay());let e=i.select_action==="subtract"?this.inverse:!this.inverse;this.painter.eraseMode!=e&&(this.painter.eraseMode=e),i.updating&&i.updating_id=="size"&&this.painter.brushSizeFactor!=i.size/100&&(this.painter.brushSizeFactor=i.size/100);let t=!1;!i.updating&&(i.updating_id=="size"||this.painter.brushSizeFactor!=i.size/100)&&(this.painter.brushSizeFactor=i.size/100,t=!0),!i.updating&&(i.updating_id=="hardness"||this.painter.brushHardnessFactor!=i.hardness/100)&&(this.painter.brushHardnessFactor=i.hardness/100,t=!0),!i.updating&&(i.updating_id=="strength"||this.painter.brushStrengthFactor!=i.strength/100)&&(this.painter.brushStrengthFactor=i.strength/100,t=!0),t&&this.painter.updateBrush()}};ut.prototype.updateMaskDisplay=function(i=null){i=!!(i===null?this.showMask:i),this.sourceSprite.visible=i&&this.sourceTransparency||!this.sourceTransparency,this.renderSprite.visible=!i&&!(this.inverse&&!this.painter.paintApplied)&&!this.sourceTransparency,this.maskBlendSprite.visible=!i&&this.sourceTransparency,this.maskSprite.visible=i&&!(this.inverse&&!this.painter.paintApplied);let e=this.painter.isSetup&&this.painter.paintApplied?this.painter:null;this.renderSprite.mask!==e&&(this.renderSprite.mask=this.sourceTransparency?null:e),this.maskSprite.mask!==e&&(this.maskSprite.mask=e),this.painter.renderable=!1,BFN.MainUI.requestRender()};ut.prototype.setSmoothingScale=function(i){this.sourceSprite.currentScale=i,this.renderSprite.currentScale=i,this.maskBlendSprite.currentScale=i,this.painter.currentScale=i};ut.prototype.handleArtsyComplete=function(){this.updateMaskDisplay(),this.sourceTransparency&&this.maskBlendSprite.updateDisplay()};ut.prototype.handlePainterUpdated=function(i){BFN.ImagePainterUndoManager.currentImagePainter===this.painter&&this.painter.isSetup&&this.sourceTransparency&&(this.maskBlendSprite.maskTexture!==this.painter.texture&&(this.maskBlendSprite.maskTexture=this.painter.texture),this.maskBlendSprite.updateDisplay())};ut.prototype.handlePainterPaintAppliedUpdated=function(i){this.updateMaskDisplay()};ut.prototype.handlePainterPaintingEnabledUpdated=function(){this.painter.isSetup&&!this.painter.paintingEnabled&&this.showMask&&(UITools.setToolValue("artsy_brush","show_mask",!1),UITools.updateToolControl("artsy_brush_show_mask"),this.showMask=UITools.getToolValue("artsy_brush","show_mask"),this.updateMaskDisplay())};Object.defineProperty(ut.prototype,"showMask",{set:function(i){this._showMask=i,this.sourceTransparency&&(this.maskBlendSprite.autoRender=!this.showMask)},get:function(){return this._showMask}});Object.defineProperty(ut.prototype,"inverse",{set:function(i){this._inverse=i,this.maskBlendSprite.inverse=this._inverse,this.painter.inverseMask=!this._inverse,BFN.MainUI.requestRender()},get:function(){return this._inverse}});Object.defineProperty(ut.prototype,"toolScale",{set:function(i){this._scale=i,this.painter.toolScale=this._scale,this.setSmoothingScale(this._scale)},get:function(){return this._scale}});Object.defineProperty(ut.prototype,"modifiedTexture",{get:function(){this.sourceTransparency&&this.maskBlendSprite.displayUpdatePending&&this.maskBlendSprite.renderDisplay();let i=PIXI.RenderTexture.create(this.sourceSprite.width,this.sourceSprite.height);return this.imageContainer.x=this.imageContainer.y=0,this.setSmoothingScale(1),this.updateMaskDisplay(!1),BFN.Stage.render(this.imageContainer,i),this.imageContainer.x=-Math.round(this.sourceTexture.width/2),this.imageContainer.y=-Math.round(this.sourceTexture.height/2),this.setSmoothingScale(this._scale),this.updateMaskDisplay(),i}});Object.defineProperty(BFN,"ImageArtsy",{get:function(){return BFN._ImageArtsy||(BFN._ImageArtsy=new ut),BFN._ImageArtsy}});function ar(){PIXI.Container.call(this),this.init()}ar.prototype=Object.create(PIXI.Container.prototype);ar.prototype.init=function(){BeFunky.log("ImageSquare Init"),this.initDefaultValues(),this.initDisplay()};ar.prototype.initDefaultValues=function(){this.sourceTexture=null,this.squareTexture=null,this._scale=1,this.itemWidth=0,this.itemHeight=0};ar.prototype.initDisplay=function(){this.imageContainer=new PIXI.Container,this.addChild(this.imageContainer),this.backgroundColorSprite=new PIXI.Sprite(PIXI.Texture.WHITE),this.backgroundColorSprite.pluginName="blend_picture",this.backgroundColorSprite.anchor.x=this.backgroundColorSprite.anchor.y=.5,this.imageContainer.addChild(this.backgroundColorSprite),this.squareSprite=new PIXI.Sprite,this.squareSprite.pluginName="smooth_picture",this.squareSprite.anchor.x=this.squareSprite.anchor.y=.5,this.imageContainer.addChild(this.squareSprite)};ar.prototype.handleSquare=function(){if(!(BFN.PhotoEditorCanvasModel.viewState==BFN.PhotoEditorCanvasModelViewStates.VIEWING_SQUARE&&this.sourceTexture))return;let i=UITools.getToolVO("frame_square");if(!i.updating&&i.updating_id==="use_avg_color"&&i.use_avg_color){let u=BFN.Util.getThumbTextureGL(this.squareTexture,64,!1,!1);UITools.setToolValue("frame_square","background_color",BFN.ColorUtil.hexNumberToHexString(BFN.Util.getTextureAverageColor(u,!0,!1))),UITools.setToolValue("frame_square","background_color_intensity",1),UITools.updateToolControls("frame_square"),u.destroyGC(!0),u=null}let e=Math.max(0,Math.min(1,i.crop/100)),t=Math.max(0,Math.min(1,(Math.max(-1,Math.min(1,i.position/100))+1)/2)),r=i.background_color===-1?-1:parseInt("0x"+i.background_color),a=i.background_color_intensity,s=Math.max(this.sourceTexture.width,this.sourceTexture.height),o=Math.min(this.sourceTexture.width,this.sourceTexture.height),n=this.sourceTexture.width-o,l=this.sourceTexture.height-o,c=Math.min(this.sourceTexture.width,s-Math.round(n*e)),h=Math.min(this.sourceTexture.height,s-Math.round(l*e));n=this.sourceTexture.width-c,l=this.sourceTexture.height-h,this.squareTexture.frame=new PIXI.Rectangle(Math.round(t*n),Math.round(t*l),c,h),this.backgroundColorSprite.visible=r!==-1&&a>0,this.backgroundColorSprite.visible&&(this.backgroundColorSprite.fillColor=r,this.backgroundColorSprite.intensity=1,this.backgroundColorSprite.alpha=a),this.backgroundColorSprite.width=this.backgroundColorSprite.height=Math.max(c,h),this.scale.x=this.scale.y=Math.min(o/c,o/h),this.updateSmoothing()};ar.prototype.setSourceTexture=function(i){if(!!this.sourceTexture==!!i||(this.sourceTexture=null,this.squareTexture&&this.squareTexture.destroyGC(!1),this.squareTexture=null,this.squareSprite.texture=PIXI.Texture.EMPTY,!i))return;let e=Math.min(i.width,i.height);this.sourceTexture=i,this.squareTexture=new PIXI.Texture(i.baseTexture),this.squareTexture.frame=new PIXI.Rectangle(Math.round((i.width-e)/2),Math.round((i.height-e)/2),e,e),this.squareSprite.texture=this.squareTexture,this.itemWidth=this.itemHeight=e-2,BFN.PhotoEditorCanvasTools.dispatchEvent(BFN.PhotoEditorCanvasToolsEvents.TOOL_DIMENSIONS_UPDATED),UITools.setToolValue("frame_square","crop",0),UITools.setToolValue("frame_square","position",0),UITools.setToolValue("frame_square","background_color","FFFFFF"),UITools.setToolValue("frame_square","background_color_intensity",1),UITools.updateToolControls("frame_square")};ar.prototype.updateSmoothing=function(){!(BFN.PhotoEditorCanvasModel.viewState==BFN.PhotoEditorCanvasModelViewStates.VIEWING_SQUARE&&this.sourceTexture)||(this.squareSprite.currentScale=this._scale*this.scale.x,this.squareSprite.currentScaleY=this._scale*this.scale.y)};Object.defineProperty(ar.prototype,"toolScale",{set:function(i){this._scale=i,this.updateSmoothing()},get:function(){return this._scale}});Object.defineProperty(ar.prototype,"modifiedTexture",{get:function(){if(!(BFN.PhotoEditorCanvasModel.viewState==BFN.PhotoEditorCanvasModelViewStates.VIEWING_SQUARE&&this.sourceTexture))return null;let i=PIXI.RenderTexture.create(this.backgroundColorSprite.width,this.backgroundColorSprite.height);return this.backgroundColorSprite.visible?i.fillColor(this.backgroundColorSprite.fillColor,this.backgroundColorSprite.alpha):i.clear(),i.copyPixels(this.squareTexture,{x:Math.round((this.backgroundColorSprite.width-this.squareTexture.width)/2),y:Math.round((this.backgroundColorSprite.height-this.squareTexture.height)/2)},!1),i}});Object.defineProperty(BFN,"ImageSquare",{get:function(){return BFN._ImageSquare||(BFN._ImageSquare=new ar),BFN._ImageSquare}});function Mi(){PIXI.Container.call(this),this.init()}Mi.prototype=Object.create(PIXI.Container.prototype);Mi.prototype.init=function(){BeFunky.log("ImageBorder Init"),this.initDefaultValues(),this.initImageContainer(),this.initDisplay()};Mi.prototype.initDefaultValues=function(){this._scale=1,this.minFrameW=this.minFrameH=0,this.maxFrameW=this.maxFrameH=0,this.borderData={}};Mi.prototype.initImageContainer=function(){this.imageContainer=new PIXI.Sprite,this.addChild(this.imageContainer)};Mi.prototype.initDisplay=function(){this.sourceTexture=null,this.borderTexture=null,this.borderFrameTexture=null,this.borderFilterSprite=new PIXI.Sprite,this.borderFilterSprite.pluginName="smooth_picture",this.borderFrameSprite=new PIXI.Sprite,this.borderFrameSprite.anchor.x=this.borderFrameSprite.anchor.y=.5,this.imageContainer.addChild(this.borderFrameSprite)};Mi.prototype.handleBorder=function(){!(BFN.PhotoEditorCanvasModel.viewState===BFN.PhotoEditorCanvasModelViewStates.VIEWING_BORDER&&this.sourceTexture)||(this.updateDisplay(),this.scale.x=this.scale.y=Math.min(this.sourceTexture.width/this.borderFrameTexture.width,this.sourceTexture.height/this.borderFrameTexture.height),this.updateSmoothing(),this.itemWidth=Math.round(this.borderFrameTexture.width*this.scale.x)-2,this.itemHeight=Math.round(this.borderFrameTexture.height*this.scale.y)-2,BFN.PhotoEditorCanvasTools.dispatchEvent(BFN.PhotoEditorCanvasToolsEvents.TOOL_DIMENSIONS_UPDATED))};Mi.prototype.setSourceTexture=function(i){if(!!this.sourceTexture==!!i||(this.sourceTexture=null,this.borderTexture&&this.borderTexture.destroyGC(!0),this.borderTexture=null,this.borderFrameTexture&&this.borderFrameTexture.destroyGC(!1),this.borderFrameTexture=null,this.borderFrameSprite.texture=PIXI.Texture.EMPTY,this.borderFilter||(this.borderFilter=new BFN.filters.BorderFilter,this.borderFilterSprite.filters=[this.borderFilter]),this.borderFilter.imageTexture=PIXI.Texture.EMPTY,this.minFrameW=this.minFrameH=0,this.maxFrameW=this.maxFrameH=0,!(i&&i.baseTexture)))return;this.sourceTexture=i,this.minFrameW=Math.round(this.sourceTexture.width),this.minFrameH=Math.round(this.sourceTexture.height);let e=Math.min(this.minFrameW,this.minFrameH),t=Math.round(e/4);t-=t%2,this.maxFrameW=Math.round(this.minFrameW+t*2),this.maxFrameH=Math.round(this.minFrameH+t*2);let r=Math.max(this.maxFrameW,this.maxFrameH),a=r>BFN.maxImageSize?BFN.maxImageSize/r:1;t=Math.round(t*a),t-=t%2,this.maxFrameW=Math.round(this.maxFrameW*a),this.maxFrameH=Math.round(this.maxFrameH*a),this.minFrameW=Math.round(this.maxFrameW-t*2),this.minFrameH=Math.round(this.maxFrameH-t*2),this.borderTexture=PIXI.RenderTexture.create(this.maxFrameW,this.maxFrameH),this.borderTexture.clear(),this.borderFrameTexture=new PIXI.Texture(this.borderTexture.baseTexture),this.borderFrameSprite.texture=this.borderFrameTexture,this.borderFilter.imageTexture=this.sourceTexture;let s=this.sourceTexture.determineTransparency();UITools.toggleControlItem("frame_border_matte_color",s)||requestAnimationFrame(()=>{UITools.toggleControlItem("frame_border_matte_color",s)}),UITools.setToolValue("frame_border","outer_color","000000"),UITools.setToolValue("frame_border","outer_color_intensity",1),UITools.setToolValue("frame_border","inner_color","FFFFFF"),UITools.setToolValue("frame_border","inner_color_intensity",1),UITools.setToolValue("frame_border","matte_color",-1),UITools.setToolValue("frame_border","matte_color_intensity",1),UITools.setToolValue("frame_border","outer_thickness",50),UITools.setToolValue("frame_border","inner_thickness",50),UITools.setToolValue("frame_border","corner_radius",0),UITools.setToolValue("frame_border","preserve_aspect_ratio",!1),UITools.updateToolControls("frame_border"),UITools.applyTool("frame_border")};Mi.prototype.updateDisplay=function(){if(!(BFN.PhotoEditorCanvasModel.viewState===BFN.PhotoEditorCanvasModelViewStates.VIEWING_BORDER&&this.sourceTexture))return;let i=UITools.getToolVO("frame_border"),e=i.outer_color,t=i.inner_color,r=i.matte_color,a=i.outer_color_intensity,s=i.inner_color_intensity,o=i.matte_color_intensity,n=i.outer_thickness/100,l=i.inner_thickness/100,c=i.corner_radius/100,h=i.preserve_aspect_ratio,{minFrameW:u,minFrameH:d,maxFrameW:m,maxFrameH:p}=this;h&&(this.sourceTexture.width<this.sourceTexture.height?m=Math.round(p*(this.sourceTexture.width/this.sourceTexture.height)):this.sourceTexture.width>this.sourceTexture.height&&(p=Math.round(m*(this.sourceTexture.height/this.sourceTexture.width))));let g=Math.round((m-u)/2),f=Math.round((p-d)/2),v=Math.floor(g/2*n),T=Math.floor(f/2*n),x=Math.floor(g/2*l),B=Math.floor(f/2*l),y=Math.round(v+x),F=Math.round(T+B),b=u+y*2,S=d+F*2;this.borderFrameTexture.frame=new PIXI.Rectangle(g-y+(this.maxFrameW-m)/2,f-F+(this.maxFrameH-p)/2,b,S),this.borderData.frameW=b*(this.sourceTexture.width/this.minFrameW),this.borderData.frameH=S*(this.sourceTexture.height/this.minFrameH);let I=Math.min(1,BFN.maxImageSize/Math.max(this.borderData.frameW,this.borderData.frameH));this.borderData.frameW=Math.round(this.borderData.frameW*I),this.borderData.frameH=Math.round(this.borderData.frameH*I),h&&(this.sourceTexture.width<this.sourceTexture.height?this.borderData.frameW=Math.round(this.borderData.frameH*(this.sourceTexture.width/this.sourceTexture.height)):this.sourceTexture.width>this.sourceTexture.height&&(this.borderData.frameH=Math.round(this.borderData.frameW*(this.sourceTexture.height/this.sourceTexture.width)))),this.borderData.borderW=Math.round(y*(this.borderData.frameW/b)),this.borderData.borderH=Math.round(F*(this.borderData.frameH/S)),this.borderData.innerBorderW=Math.round(x*(this.borderData.frameW/b)),this.borderData.innerBorderH=Math.round(B*(this.borderData.frameH/S)),this.borderData.imageW=this.borderData.frameW-this.borderData.borderW*2,this.borderData.imageH=this.borderData.frameH-this.borderData.borderH*2,this.borderFilter.imageDimensions=[u,d],this.borderFilter.borderW=x,this.borderFilter.borderH=B,this.borderFilter.cornerRadiusFactor=c,this.borderFilter.outerColor=e,this.borderFilter.innerColor=t,this.borderFilter.matteColor=r,this.borderFilter.outerColorAlpha=a,this.borderFilter.innerColorAlpha=s,this.borderFilter.matteColorAlpha=o,this.renderBorder(this.borderTexture)};Mi.prototype.renderBorder=function(i){!(BFN.PhotoEditorCanvasModel.viewState===BFN.PhotoEditorCanvasModelViewStates.VIEWING_BORDER&&this.sourceTexture)||(this.borderFilter.filterDimensions=[i.width,i.height],this.borderFilterSprite.width=i.width,this.borderFilterSprite.height=i.height,BFN.Stage.render(this.borderFilterSprite,i))};Mi.prototype.updateSmoothing=function(i=!1){!(BFN.PhotoEditorCanvasModel.viewState===BFN.PhotoEditorCanvasModelViewStates.VIEWING_BORDER&&this.sourceTexture)||(this.borderFrameSprite.currentScale=this._scale*this.scale.x,this.borderFrameSprite.currentScaleY=this._scale*this.scale.y)};Object.defineProperty(Mi.prototype,"toolScale",{set:function(i){this._scale=i,this.updateSmoothing()},get:function(){return this._scale}});Object.defineProperty(Mi.prototype,"modifiedTexture",{get:function(){if(!(BFN.PhotoEditorCanvasModel.viewState===BFN.PhotoEditorCanvasModelViewStates.VIEWING_BORDER&&this.sourceTexture))return null;let i=PIXI.RenderTexture.create(this.borderData.frameW,this.borderData.frameH);return this.borderFilter.imageDimensions=[this.borderData.imageW,this.borderData.imageH],this.borderFilter.borderW=this.borderData.innerBorderW,this.borderFilter.borderH=this.borderData.innerBorderH,this.renderBorder(i),i}});Object.defineProperty(BFN,"ImageBorder",{get:function(){return BFN._ImageBorder||(BFN._ImageBorder=new Mi),BFN._ImageBorder}});function Wt(){PIXI.Sprite.call(this),this.init()}Wt.prototype=Object.create(PIXI.Sprite.prototype);Wt.prototype.init=function(){BeFunky.log("ImageDropShadow Init"),this.initDefaultValues(),this.initImageContainer(),this.initBackground(),this.initBlurSprite(),this.initShadowSprite(),this.initSourceSprite(),this.initMaskSprite()};Wt.prototype.initDefaultValues=function(){this._scale=1,this.shadowMapSize=1024,this.imageContainerWidth=0,this.imageContainerHeight=0,this.renderPending=!1,this.handleMainUIPreRenderBind=this.handleMainUIPreRender.bind(this)};Wt.prototype.initImageContainer=function(){this.imageContainer=new PIXI.Sprite,this.addChild(this.imageContainer)};Wt.prototype.initBackground=function(){this.background=new PIXI.Graphics,this.imageContainer.addChild(this.background)};Wt.prototype.initBlurSprite=function(){this.invertChannelFilter=new BFN.filters.InvertChannelFilter,this.directionalBlurFilter=new BFN.filters.DirectionalBlurFilter,this.directionalBlurFilter.blendAlpha=!0,this.directionalBlurFilter.iterations=4,this.directionalBlurFilter.biDirectional=!0,this.blurredTexture=null,this.blurTexture=null,this.blurSprite=new PIXI.Sprite};Wt.prototype.initShadowSprite=function(){this.shadowTexture=null,this.shadowSprite=new PIXI.Sprite,this.shadowSprite.pluginName="blend_picture",this.imageContainer.addChild(this.shadowSprite)};Wt.prototype.initSourceSprite=function(){this.sourceTexture=null,this.sourceSprite=new PIXI.Sprite,this.sourceSprite.pluginName="blend_picture",this.imageContainer.addChild(this.sourceSprite)};Wt.prototype.initMaskSprite=function(){this.maskTexture=null,this.maskSprite=new PIXI.Sprite,this.imageContainer.addChild(this.maskSprite)};Wt.prototype.handleDropShadow=function(){BFN.PhotoEditorCanvasModel.viewState==BFN.PhotoEditorCanvasModelViewStates.VIEWING_DROP_SHADOW&&this.sourceTexture&&(this.renderPending||(this.renderPending=!0,BFN.MainUI.addEventListener(BFN.MainUIEvents.PRE_RENDER.type,this.handleMainUIPreRenderBind)),BFN.MainUI.requestRender())};Wt.prototype.setSourceTexture=function(i){if(this.blurredTexture!==null&&(this.blurredTexture.destroyGC(!0),this.blurredTexture=null),this.blurTexture!==null&&(this.blurTexture.destroyGC(!0),this.blurTexture=null,this.blurSprite.texture=PIXI.Texture.EMPTY),this.shadowTexture!==null&&(this.shadowTexture.destroyGC(!0),this.shadowTexture=null,this.shadowSprite.texture=PIXI.Texture.EMPTY,this.shadowSprite.mask=null),this.sourceTexture!==null&&(this.sourceTexture=null,this.sourceSprite.texture=PIXI.Texture.EMPTY),this.maskTexture!==null&&(this.maskTexture.destroyGC(!0),this.maskTexture=null,this.maskSprite.texture=PIXI.Texture.EMPTY),i){this.sourceTexture=i,this.sourceSprite.texture=i,this.sourceW=this.sourceTexture.width,this.sourceH=this.sourceTexture.height,this.maxBlurRadius=Math.ceil(Math.sqrt(this.sourceW**2+this.sourceH**2)/8);let e=Math.max(this.sourceW,this.sourceH);this.filterScaleFactor=this.shadowMapSize/(e+this.maxBlurRadius*2),this.filterMaxBlurRadius=Math.ceil(this.maxBlurRadius*this.filterScaleFactor);let t=this.shadowMapSize-this.filterMaxBlurRadius*2;this.filterScaleFactor=t/e,this.scaledSourceW=Math.round(this.sourceW*this.filterScaleFactor),this.scaledSourceH=Math.round(this.sourceH*this.filterScaleFactor),this.shadowMapW=Math.min(this.shadowMapSize,Math.round(this.scaledSourceW+this.filterMaxBlurRadius*2)),this.shadowMapH=Math.min(this.shadowMapSize,Math.round(this.scaledSourceH+this.filterMaxBlurRadius*2)),this.directionalBlurFilter.setDimensions(this.shadowMapW,this.shadowMapH,this.filterMaxBlurRadius),this.blurredTexture=PIXI.RenderTexture.create(this.shadowMapW,this.shadowMapH),this.blurTexture=PIXI.RenderTexture.create(this.shadowMapW,this.shadowMapH),this.blurTexture.copyPixels(this.sourceTexture,{x:this.filterMaxBlurRadius,y:this.filterMaxBlurRadius},!1,1,{x:this.scaledSourceW/this.sourceW,y:this.scaledSourceH/this.sourceH}),this.blurSprite.texture=this.blurTexture,this.blurSprite.filters=[this.directionalBlurFilter],this.maskTexture=this.sourceTexture.renderClone(),this.maskTexture.convertAlphaToLuma(),this.maskSprite.texture=this.maskTexture,this.maskSprite.visible=!1,this.imageContainer.x=-(this.sourceW/2),this.imageContainer.y=-(this.sourceH/2),this.shadowTexture=PIXI.RenderTexture.create(this.scaledSourceW,this.scaledSourceH),this.shadowSprite.texture=this.shadowTexture,this.shadowSprite.scale.x=this.shadowSprite.scale.y=1/this.filterScaleFactor,this.imageContainer.addChildAt(this.shadowSprite,1),this.sourceSprite.texture=this.sourceTexture;let r=UITools.getToolVO("frame_drop_shadow");for(let a in r.defaultValues)UITools.setToolValue("frame_drop_shadow",a,r.defaultValues[a]);UITools.updateToolControls("frame_drop_shadow"),UITools.applyTool("frame_drop_shadow"),this.updateDisplay(!0)}};Wt.prototype.updateDisplay=function(i=!1){if(BFN.PhotoEditorCanvasModel.viewState==BFN.PhotoEditorCanvasModelViewStates.VIEWING_DROP_SHADOW&&this.sourceTexture){let e=UITools.getToolVO("frame_drop_shadow"),t=e.size/100,r=e.density/100,a=e.distance/100,s=e.angle*(Math.PI/180),o=Math.round(t*this.filterMaxBlurRadius),n=e.type==="inner",l=Math.round(o/this.filterScaleFactor),c=this.sourceW+l*2,h=this.sourceH+l*2,u=this.filterMaxBlurRadius/this.filterScaleFactor*a,d=Math.round(Math.cos(s)*u),m=Math.round(Math.sin(s)*u);if(this.imageContainerWidth=n?this.sourceW:c+Math.abs(Math.min(0,l-Math.abs(d))),this.imageContainerHeight=n?this.sourceH:h+Math.abs(Math.min(0,l-Math.abs(m))),this.itemWidth=this.imageContainerWidth,this.itemHeight=this.imageContainerHeight,i)return;if(n&&this.shadowSprite.mask!==this.maskSprite?(this.maskSprite.visible=!0,this.shadowSprite.mask=this.maskSprite,this.imageContainer.addChildAt(this.sourceSprite,1)):!n&&this.shadowSprite.mask&&(this.maskSprite.visible=!1,this.shadowSprite.mask=null,this.imageContainer.addChildAt(this.shadowSprite,1)),this.imageContainer.x=-(this.imageContainerWidth/2),this.imageContainer.y=-(this.imageContainerHeight/2),this.sourceSprite.x=n?0:Math.max(0,(c-this.sourceW)/2-d),this.sourceSprite.y=n?0:Math.max(0,(h-this.sourceH)/2-m),this.shadowSprite.x=n?0:this.sourceSprite.x+d-l,this.shadowSprite.y=n?0:this.sourceSprite.y+m-l,this.shadowSprite.alpha=e.opacity/100,this.shadowSprite.fillColor=parseInt("0x"+e.shadow_color),this.shadowSprite.intensity=1,this.maskSprite.x=this.sourceSprite.x,this.maskSprite.y=this.sourceSprite.y,this.background.clear(),e.background_color!==-1&&(this.background.beginFill("0x"+e.background_color,1),this.background.drawRect(0,0,this.imageContainerWidth,this.imageContainerHeight),this.background.endFill()),this.directionalBlurFilter.amount=t,this.directionalBlurFilter.alphaChoke=r,this.blurSprite.filters=n?[this.invertChannelFilter,this.directionalBlurFilter]:[this.directionalBlurFilter],BFN.Stage.render(this.blurSprite,this.blurredTexture),n)(this.shadowTexture.width!==this.scaledSourceW||this.shadowTexture.height!==this.scaledSourceH)&&this.shadowTexture.resize(this.scaledSourceW,this.scaledSourceH),this.shadowTexture.copyPixels(this.blurredTexture,{x:Math.round(d*this.filterScaleFactor)-this.filterMaxBlurRadius,y:Math.round(m*this.filterScaleFactor)-this.filterMaxBlurRadius});else{let p=this.scaledSourceW+o*2,g=this.scaledSourceH+o*2;(this.shadowTexture.width!==p||this.shadowTexture.height!==g)&&this.shadowTexture.resize(p,g),this.shadowTexture.copyPixels(this.blurredTexture,{x:o-this.filterMaxBlurRadius,y:o-this.filterMaxBlurRadius})}this.setSmoothingScale(this._scale),BFN.PhotoEditorCanvasTools.dispatchEvent(BFN.PhotoEditorCanvasToolsEvents.TOOL_DIMENSIONS_UPDATED)}};Wt.prototype.setSmoothingScale=function(i,e=!0){this.sourceSprite.currentScale=i*this.sourceSprite.scale.y*(e?this.scale.y:1),this.shadowSprite.currentScale=i*this.shadowSprite.scale.y*(e?this.scale.y:1)};Wt.prototype.handleMainUIPreRender=function(i){this.renderPending=!1,BFN.MainUI.removeEventListener(BFN.MainUIEvents.PRE_RENDER.type,this.handleMainUIPreRenderBind),this.updateDisplay()};Object.defineProperty(Wt.prototype,"toolScale",{set:function(i){this._scale=i,this.setSmoothingScale(this._scale)},get:function(){return this._scale}});Object.defineProperty(Wt.prototype,"modifiedTexture",{get:function(){let i=Math.min(1,BFN.maxImageSize/this.imageContainerWidth,BFN.maxImageSize/this.imageContainerHeight),e=Math.min(BFN.maxImageSize,Math.floor(this.imageContainerWidth*i)),t=Math.min(BFN.maxImageSize,Math.floor(this.imageContainerHeight*i)),r=PIXI.RenderTexture.create(e,t),a=this.imageContainer.x,s=this.imageContainer.y;return this.imageContainer.x=0,this.imageContainer.y=0,this.imageContainer.scale.x=e/this.imageContainerWidth,this.imageContainer.scale.y=t/this.imageContainerHeight,this.setSmoothingScale(i,!1),BFN.Stage.render(this.imageContainer,r),this.imageContainer.x=a,this.imageContainer.y=s,this.imageContainer.scale.x=1,this.imageContainer.scale.y=1,this.setSmoothingScale(this._scale),r}});Object.defineProperty(BFN,"ImageDropShadow",{get:function(){return BFN._ImageDropShadow||(BFN._ImageDropShadow=new Wt),BFN._ImageDropShadow}});function $t(){PIXI.Sprite.call(this),this.init()}$t.prototype=Object.create(PIXI.Sprite.prototype);$t.prototype.init=function(){BeFunky.log("ImageFrame Init"),this.initDefaultValues(),this.initDisplay()};$t.prototype.initDefaultValues=function(){this.sourceTexture=null,this.currentFrameID=null,this.currentFrameName=null,this.currentFrameTranslation=null,this._scale=1,this.adjustScale=1,this.itemWidth=this.imageContainerWidth=0,this.itemHeight=this.imageContainerHeight=0,this.tiltAngle=0,this.backgroundColor=-1,this.handleFrameDisplayFrameUpdatedBind=this.handleFrameDisplayFrameUpdated.bind(this)};$t.prototype.initDisplay=function(){this.canvas=new PIXI.Container,this.addChild(this.canvas),this.imageContainer=new PIXI.Container,this.canvas.addChild(this.imageContainer),this.imageBackground=new PIXI.Graphics,this.imageContainer.addChild(this.imageBackground),this.imageCenterContainer=new PIXI.Container,this.imageContainer.addChild(this.imageCenterContainer),this.frameDisplay=new BFN.FrameDisplay,this.frameDisplay.addEventListener(BFN.FrameDisplayEvents.FRAME_UPDATED.type,this.handleFrameDisplayFrameUpdatedBind),this.imageCenterContainer.addChild(this.frameDisplay)};$t.prototype.handleFrameCropRotateGeneric=function(){let i=UITools.getToolVO("frame_crop_rotate_generic");switch(i.updating_id){case"rotate_counter_clockwise":this.frameDisplay.rotateCounterClockwise();break;case"rotate_clockwise":this.frameDisplay.rotateClockwise();break;case"flip_horizontal":this.frameDisplay.flipHorizontal();break;case"flip_vertical":this.frameDisplay.flipVertical();break;case"background_color":this.backgroundColor=i.background_color==-1?-1:parseInt(`0x${i.background_color}`),this.tiltFrame(this.tiltAngle);break;case"tilt":this.tiltFrame(i.tilt);break}this.frameDisplay.setPosition(i.position/100)};$t.prototype.handleFrameCropGeneric=function(){let i=UITools.getToolVO("frame_crop_generic");switch(i.updating_id){case"rotate_counter_clockwise":this.frameDisplay.rotateCounterClockwise();break;case"rotate_clockwise":this.frameDisplay.rotateClockwise();break;case"flip_horizontal":this.frameDisplay.flipHorizontal();break;case"flip_vertical":this.frameDisplay.flipVertical();break}this.frameDisplay.setPosition(i.position/100)};$t.prototype.handleFrameFullGeneric=function(){let i=UITools.getToolVO("frame_full_generic");switch(i.updating_id){case"rotate_counter_clockwise":this.frameDisplay.rotateCounterClockwise();break;case"rotate_clockwise":this.frameDisplay.rotateClockwise();break;case"flip_horizontal":this.frameDisplay.flipHorizontal();break;case"flip_vertical":this.frameDisplay.flipVertical();break;case"blend_mode":requestAnimationFrame(()=>{BFN.MainUI.requestRender()});break}this.frameDisplay.setColor(i.color_overlay==-1?-1:parseInt(`0x${i.color_overlay}`),i.color_overlay_intensity),this.frameDisplay.setBlendMode(i.blend_mode),this.frameDisplay.setPosition(i.position/100),this.frameDisplay.setOpacity(i.opacity/100)};$t.prototype.handleFrameSmartGeneric=function(){let i=UITools.getToolVO("frame_smart_generic");switch(i.updating_id){case"blend_mode":requestAnimationFrame(()=>{BFN.MainUI.requestRender()});break;case"scale":case"padding":BFN.SmartFrameManager.renderFrameTexture(this.sourceTexture.width,this.sourceTexture.height,i.scale/100,i.padding/100,i.updating);break}this.frameDisplay.setColor(i.color_overlay==-1?-1:parseInt(`0x${i.color_overlay}`),i.color_overlay_intensity),this.frameDisplay.setBlendMode(i.blend_mode),this.frameDisplay.setOpacity(i.opacity/100)};$t.prototype.handleUpdateTool=function(i){if(BFN.PhotoEditorCanvasModel.viewState===BFN.PhotoEditorCanvasModelViewStates.VIEWING_FRAME&&this.currentFrameID!==i){let e=UITools.getToolVO(i);this.currentFrameID=i,this.currentFrameName=e.frameName||"Frame",this.currentFrameTranslation=e.frameTranslation||"Frame";let t=`${BFN.remoteImagesURL}app/frames/${e.texture_category}/png/images/${e.texture}.png`;if(e.frame_type==="smart"){let l=UITools.getToolVO("frame_smart_generic");for(let c in l.defaultValues)l.hasOwnProperty(c)&&(l[c]=l.defaultValues[c]);t=`smart:${e.texture_category}:${e.texture}:${l.scale/100}:${l.padding/100}`}let r=this.showLoader(),a=()=>{this.frameDisplay.removeEventListener(BFN.FrameDisplayEvents.FRAME_LOADED.type,a),r()};this.frameDisplay.addEventListener(BFN.FrameDisplayEvents.FRAME_LOADED.type,a),this.frameDisplay.setupFrame(this.sourceTexture,t,e.texture_data,100,100,BFN.maxImageSize,BFN.maxImageSize),this.resetFrameDisplay(),this.itemWidth=this.frameDisplay.itemWidth,this.itemHeight=this.frameDisplay.itemHeight,this.imageContainer.x=-Math.round(this.itemWidth/2),this.imageContainer.y=-Math.round(this.itemHeight/2),BFN.PhotoEditorCanvasTools.dispatchEvent(BFN.PhotoEditorCanvasToolsEvents.TOOL_DIMENSIONS_UPDATED);let s=BFN.AppModel.sectionValue(BFN.PhotoEditorCanvasModel,BFN.CollageMakerCanvasModel,BFN.DesignerCanvasModel),o=BFN.AppModel.sectionValue(BFN.PhotoEditorCanvasModelEvents.FIT_IMAGE_TO_FRAME,BFN.CollageMakerCanvasModelEvents.FIT_COLLAGE_TO_FRAME,BFN.DesignerCanvasModelEvents.FIT_DESIGNER_TO_FRAME);s.dispatchEvent(o);let n=e.hasOwnProperty("blendMode")?e.blendMode:BFN.CONST.BLEND_MODES.NORMAL;switch(e.frame_type){case"crop_rotate":UITools.setToolValue("frame_crop_rotate_generic","blend_mode",n),UITools.updateToolControls("frame_crop_rotate_generic"),this.handleFrameCropRotateGeneric();break;case"crop":UITools.setToolValue("frame_crop_generic","blend_mode",n),UITools.updateToolControls("frame_crop_generic"),this.handleFrameCropGeneric();break;case"full":UITools.setToolValue("frame_full_generic","blend_mode",n),UITools.updateToolControls("frame_full_generic"),this.handleFrameFullGeneric();break;case"smart":UITools.setToolValue("frame_smart_generic","blend_mode",n),UITools.updateToolControls("frame_smart_generic"),this.handleFrameSmartGeneric();break}this.canvas.scale.x=this.canvas.scale.y=this.adjustScale=Math.min(1,this.frameDisplay.itemHeight/this.imageContainerHeight),this.itemWidth=Math.max(0,Math.round(this.imageContainerWidth*this.canvas.scale.x)-2),this.itemHeight=Math.max(0,Math.round(this.imageContainerHeight*this.canvas.scale.y)-2),BFN.PhotoEditorCanvasTools.dispatchEvent(BFN.PhotoEditorCanvasToolsEvents.TOOL_DIMENSIONS_UPDATED),BFN.MainUI.requestRender()}};$t.prototype.tiltFrame=function(i){this.tiltAngle=i;let e=Math.abs(i*(Math.PI/180)),t=this.frameDisplay.itemWidth,r=this.frameDisplay.itemHeight;this.imageContainerWidth=Math.max(0,Math.cos(e)*t+Math.sin(e)*r),this.imageContainerHeight=Math.max(0,Math.cos(e)*r+Math.sin(e)*t),this.imageContainer.x=-Math.round(this.imageContainerWidth/2),this.imageContainer.y=-Math.round(this.imageContainerHeight/2),this.imageCenterContainer.x=-this.imageContainer.x,this.imageCenterContainer.y=-this.imageContainer.y,this.imageCenterContainer.rotation=i*(Math.PI/180),this.frameDisplay.x=-(this.frameDisplay.itemWidth/2),this.frameDisplay.y=-(this.frameDisplay.itemHeight/2),this.imageBackground.clear(),this.backgroundColor!=-1?this.imageBackground.beginFill(this.backgroundColor):this.imageBackground.beginFill(0,0),this.imageBackground.drawRect(0,0,this.imageContainerWidth,this.imageContainerHeight),this.imageBackground.endFill(),this.canvas.scale.x=this.canvas.scale.y=this.adjustScale=Math.min(1,this.frameDisplay.itemHeight/this.imageContainerHeight),this.itemWidth=Math.max(0,Math.round(this.imageContainerWidth*this.canvas.scale.x)-2),this.itemHeight=Math.max(0,Math.round(this.imageContainerHeight*this.canvas.scale.y)-2),BFN.PhotoEditorCanvasTools.dispatchEvent(BFN.PhotoEditorCanvasToolsEvents.TOOL_DIMENSIONS_UPDATED),BFN.MainUI.requestRender()};$t.prototype.resetFrameDisplay=function(){UITools.setToolValue("frame_crop_rotate_generic","background_color",-1),UITools.setToolValue("frame_crop_rotate_generic","position",0),UITools.setToolValue("frame_crop_rotate_generic","tilt",0),UITools.updateToolControls("frame_crop_rotate_generic"),UITools.setToolValue("frame_crop_generic","position",0),UITools.updateToolControls("frame_crop_generic"),UITools.setToolValue("frame_full_generic","color_overlay",-1),UITools.setToolValue("frame_full_generic","color_overlay_intensity",1),UITools.setToolValue("frame_full_generic","blend_mode",BFN.CONST.BLEND_MODES.NORMAL),UITools.setToolValue("frame_full_generic","position",0),UITools.setToolValue("frame_full_generic","opacity",100),UITools.updateToolControls("frame_full_generic"),UITools.setToolValue("frame_smart_generic","color_overlay",-1),UITools.setToolValue("frame_smart_generic","color_overlay_intensity",1),UITools.setToolValue("frame_smart_generic","blend_mode",BFN.CONST.BLEND_MODES.NORMAL),UITools.setToolValue("frame_smart_generic","opacity",100),UITools.setToolValue("frame_smart_generic","scale",50),UITools.setToolValue("frame_smart_generic","padding",50),UITools.updateToolControls("frame_smart_generic"),this.frameDisplay.resetFrame(),this.tiltAngle=0,this.backgroundColor=-1,this.tiltFrame(this.tiltAngle)};$t.prototype.setSourceTexture=function(i){this.sourceTexture!=null&&(this.sourceTexture=null),i?this.sourceTexture=i:(this.currentFrameID=null,this.frameDisplay.destroyFrameTextures())};$t.prototype.showLoader=function(){let i=BFN.tertiaryMenu.activePresetId;return BFN.tertiaryMenu.loadingPresetIds=[...BFN.tertiaryMenu.loadingPresetIds,i],function(){BFN.tertiaryMenu.loadingPresetIds=BFN.tertiaryMenu.loadingPresetIds.filter(e=>e!==i)}};$t.prototype.handleFrameDisplayFrameUpdated=function(i){this.imageContainer.x=-Math.round(this.itemWidth/2),this.imageContainer.y=-Math.round(this.itemHeight/2),this.tiltFrame(this.tiltAngle)};Object.defineProperty($t.prototype,"toolScale",{set(i){this._scale=i,this.frameDisplay.canvasScale=i},get(){return this._scale}});Object.defineProperty($t.prototype,"modifiedTexture",{get(){let i=PIXI.RenderTexture.create(Math.floor(this.imageContainerWidth),Math.floor(this.imageContainerHeight));return this.canvas.x=Math.floor(i.width/2),this.canvas.y=Math.floor(i.height/2),this.canvas.scale.x=this.canvas.scale.y=this.adjustScale=1,this.frameDisplay.canvasScale=1,this.removeChild(this.canvas),BFN.Stage.render(this.canvas,i),this.addChild(this.canvas),this.canvas.x=this.canvas.y=0,this.canvas.scale.x=this.canvas.scale.y=this.adjustScale=Math.min(1,this.frameDisplay.itemHeight/this.imageContainerHeight),this.frameDisplay.canvasScale=this._scale,i}});Object.defineProperty(BFN,"ImageFrame",{get(){return BFN._ImageFrame||(BFN._ImageFrame=new $t),BFN._ImageFrame}});function dt(){PIXI.Sprite.call(this),this.init()}dt.prototype=Object.create(PIXI.Sprite.prototype);dt.prototype.init=function(){BeFunky.log("ImageTexture Init"),this.initDefaultValues(),this.initTexture(),this.initImageContainer(),this.initSourceSprite(),this.initBlendModeSprite(),this.initMaskSprite(),this.initPainter()};dt.prototype.initDefaultValues=function(){this.sourceTexture=null,this.textureTexture=null,this.currentTextureID=null,this.currentTextureName=null,this.currentTextureTranslation=null,this._scale=1};dt.prototype.initTexture=function(){this.textureContainer=new PIXI.Container,this.textureCenterContainer=new PIXI.Container,this.textureContainer.addChild(this.textureCenterContainer),this.textureSprite=new PIXI.Sprite,this.textureCenterContainer.addChild(this.textureSprite)};dt.prototype.initImageContainer=function(){this.imageContainer=new PIXI.Sprite,this.addChild(this.imageContainer)};dt.prototype.initSourceSprite=function(){this.sourceSprite=new PIXI.Sprite,this.sourceSprite.pluginName="smooth_picture",this.imageContainer.addChild(this.sourceSprite)};dt.prototype.initBlendModeSprite=function(){this.blendModeSprite=new BFN.BlendModeSprite(!1),this.blendModeSprite.pluginName="smooth_picture",this.imageContainer.addChild(this.blendModeSprite)};dt.prototype.initMaskSprite=function(){this.maskSprite=new PIXI.Sprite(PIXI.RenderTexture.create(200,200)),this.maskSprite.texture.fillColor(16711680,.5),this.maskSprite.interactive=!1,this.imageContainer.addChild(this.maskSprite)};dt.prototype.initPainter=function(){this.painter=new BFN.ImagePainter,this.painter.pluginName="smooth_picture",this.painter.paintingEnabled=!1,this.painter.delaySetupTillPaintingEnabled=!0,this.painter.renderable=!1,this.imageContainer.addChild(this.painter),this.painter.addEventListener(BFN.ImagePainterEvents.PAINT_APPLIED_UPDATED.type,this.handlePainterPaintAppliedUpdated.bind(this)),this.painter.addEventListener(BFN.ImagePainterEvents.PAINTING_ENABLED_UPDATED.type,this.handlePainterPaintingEnabledUpdated.bind(this))};dt.prototype.handleTextureGeneric=function(){let i=UITools.getToolVO("texture_generic");switch(this.blendModeSprite.setBlendMode(i.blend_mode),this.blendModeSprite.setBlendIntensity(i.opacity),i.updating_id){case"rotate_counter_clockwise":i.rotate_counter_clockwise&&(this.textureCenterContainer.rotation-=Math.PI/2,this.updateTextureTransform());break;case"rotate_clockwise":i.rotate_clockwise&&(this.textureCenterContainer.rotation+=Math.PI/2,this.updateTextureTransform());break;case"flip_horizontal":i.flip_horizontal&&(Math.abs(this.textureCenterContainer.rotation%Math.PI)?(this.textureSprite.y*=-1,this.textureSprite.scale.y*=-1):(this.textureSprite.x*=-1,this.textureSprite.scale.x*=-1),this.updateTextureTransform());break;case"flip_vertical":i.flip_vertical&&(Math.abs(this.textureCenterContainer.rotation%Math.PI)?(this.textureSprite.x*=-1,this.textureSprite.scale.x*=-1):(this.textureSprite.y*=-1,this.textureSprite.scale.y*=-1),this.updateTextureTransform());break}};dt.prototype.handleTextureBrush=function(){this.updateTextureBrushParameters()};dt.prototype.handleUpdateTool=function(i){if(BFN.PhotoEditorCanvasModel.viewState===BFN.PhotoEditorCanvasModelViewStates.VIEWING_TEXTURE){let e=UITools.getToolVO(i);if(UITools.setToolValue("texture_generic","opacity",e.alpha),UITools.setToolValue("texture_generic","blend_mode",e.blendMode),UITools.updateToolControls("texture_generic"),this.currentTextureID!==i){this.currentTextureID=i,this.currentTextureName=e.textureName||"Texture",this.currentTextureTranslation=e.textureTranslation||"Texture";let t=this.showLoader(),r=new Image;r.setAttribute("crossOrigin","Anonymous"),r.onload=()=>{this.setTexture(new PIXI.Texture(new PIXI.BaseTexture(r))),t()};let a=`${BFN.remoteImagesURL}app/texturemodel/original/${e.texture}`;BeFunky.isAppleAppStoreApp?BFN.RequestUtils.getBase64(a,({base64:s,error:o})=>{o||(r.src=s)}):r.src=`${BFN.remoteImagesURL}app/texturemodel/original/${e.texture}`}}};dt.prototype.setSourceTexture=function(i){this.sourceTexture!=null&&(this.sourceTexture=null,this.sourceSprite.texture=PIXI.Texture.EMPTY),this.textureTexture!=null&&(this.textureTexture.destroyGC(!0),this.textureTexture=null),this.blendModeSprite.autoRender=!1,i?(this.sourceTexture=i,this.sourceSprite.texture=this.sourceTexture,this.maskSprite.width=this.sourceTexture.width,this.maskSprite.height=this.sourceTexture.height,this.textureTexture=PIXI.RenderTexture.create(this.sourceTexture.width,this.sourceTexture.height),BFN.Stage.render(new PIXI.Container,this.textureTexture),this.textureCenterContainer.x=this.textureTexture.width/2,this.textureCenterContainer.y=this.textureTexture.height/2,this.blendModeSprite.autoRender=!0,this.blendModeSprite.setBlendMode(null),this.blendModeSprite.setBaseTexture(this.sourceTexture),this.blendModeSprite.setBlendTexture(this.textureTexture),this.imageContainer.x=-Math.round(this.sourceTexture.width/2),this.imageContainer.y=-Math.round(this.sourceTexture.height/2),this.painter.setup(this.sourceTexture.width,this.sourceTexture.height),this.inverse=!1,this.updateMaskDisplay(),UITools.setToolValue("texture_brush","show_mask",!1),UITools.setToolValue("texture_brush","select_action","subtract"),UITools.updateToolControls("texture_brush"),this.updateTextureBrushParameters()):(this.currentTextureID=null,this.sourceSprite.mask=null,this.blendModeSprite.mask=null,this.painter.reset(),BFN.FilterHelper.emptyPoolForFilter())};dt.prototype.setTexture=function(i){try{this.textureSprite.texture.destroyGC(!0),this.textureSprite.texture=null}catch(e){}i&&(this.textureSprite.rotation=0,this.textureSprite.scale.x=this.textureSprite.scale.y=1,this.textureSprite.texture=i,this.textureSprite.x=-(this.textureSprite.texture.width/2),this.textureSprite.y=-(this.textureSprite.texture.height/2),this.updateTextureTransform(),this.handleTextureGeneric())};dt.prototype.updateTextureTransform=function(){if(this.textureTexture&&this.textureSprite.texture){let i=this.textureTexture.width,e=this.textureTexture.height,t=Math.abs(this.textureCenterContainer.rotation%Math.PI)?this.textureSprite.texture.height:this.textureSprite.texture.width,r=Math.abs(this.textureCenterContainer.rotation%Math.PI)?this.textureSprite.texture.width:this.textureSprite.texture.height,a=Math.max(i/t,e/r);this.textureCenterContainer.scale.x=this.textureCenterContainer.scale.y=a,BFN.Stage.render(this.textureContainer,this.textureTexture),this.blendModeSprite.updateDisplay()}};dt.prototype.updateTextureBrushParameters=function(){let i=UITools.getToolVO("texture_brush");if(i){if(i.updating_id==="isolate_subject"&&!i.updating){this.sourceTexture.altTexture=this.blendModeSprite.texture,this.sourceTexture.altTextureInverse=!1,BFN.BackgroundRemovalManager.isolateSubjectOnPainter(this.sourceTexture,this.inverse,()=>{delete this.sourceTexture.altTexture,delete this.sourceTexture.altTextureInverse});return}i.clear&&(this.painter.clear(!0),UITools.setToolValue("texture_brush","erase",!1),UITools.updateToolControl("texture_brush_erase"),this.inverse&&(this.inverse=!1,this.updateMaskDisplay())),this.showMask!==i.show_mask&&(this.showMask=i.show_mask,this.updateMaskDisplay()),i.updating_id==="invert"&&(this.inverse=!this.inverse,this.updateMaskDisplay());let e=i.select_action==="subtract"?this.inverse:!this.inverse;this.painter.eraseMode!==e&&(this.painter.eraseMode=e),i.updating&&i.updating_id==="size"&&this.painter.brushSizeFactor!=i.size/100&&(this.painter.brushSizeFactor=i.size/100);let t=!1;!i.updating&&(i.updating_id==="size"||this.painter.brushSizeFactor!=i.size/100)&&(this.painter.brushSizeFactor=i.size/100,t=!0),!i.updating&&(i.updating_id==="hardness"||this.painter.brushHardnessFactor!=i.hardness/100)&&(this.painter.brushHardnessFactor=i.hardness/100,this.painter.updateBrush()),!i.updating&&(i.updating_id==="strength"||this.painter.brushStrengthFactor!=i.strength/100)&&(this.painter.brushStrengthFactor=i.strength/100,this.painter.updateBrush()),t&&this.painter.updateBrush()}};dt.prototype.updateMaskDisplay=function(i=null){i=!!(i===null?this.showMask:i),this.blendModeSprite.visible=!i&&!(this.inverse&&!this.painter.paintApplied),this.maskSprite.visible=i&&!(this.inverse&&!this.painter.paintApplied);let e=this.painter.isSetup&&this.painter.paintApplied?this.painter:null;this.blendModeSprite.mask!==e&&(this.blendModeSprite.mask=e),this.maskSprite.mask!==e&&(this.maskSprite.mask=e),this.painter.renderable=!1,BFN.MainUI.requestRender()};dt.prototype.setSmoothingScale=function(i){this.sourceSprite.currentScale=i,this.blendModeSprite.currentScale=i,this.painter.currentScale=i};dt.prototype.showLoader=function(){let i=BFN.tertiaryMenu.activePresetId;return BFN.tertiaryMenu.loadingPresetIds=[...BFN.tertiaryMenu.loadingPresetIds,i],function(){BFN.tertiaryMenu.loadingPresetIds=BFN.tertiaryMenu.loadingPresetIds.filter(e=>e!==i)}};dt.prototype.handlePainterPaintAppliedUpdated=function(i){this.updateMaskDisplay()};dt.prototype.handlePainterPaintingEnabledUpdated=function(){this.painter.isSetup&&!this.painter.paintingEnabled&&this.showMask&&(UITools.setToolValue("texture_brush","show_mask",!1),UITools.updateToolControl("texture_brush_show_mask"),this.showMask=UITools.getToolValue("texture_brush","show_mask"),this.updateMaskDisplay())};Object.defineProperty(dt.prototype,"inverse",{set(i){this._inverse=i,this.painter.inverseMask=!this._inverse,BFN.MainUI.requestRender()},get(){return this._inverse}});Object.defineProperty(dt.prototype,"toolScale",{set(i){this._scale=i,this.painter.toolScale=this._scale,this.setSmoothingScale(this._scale)},get(){return this._scale}});Object.defineProperty(dt.prototype,"modifiedTexture",{get(){let i=PIXI.RenderTexture.create(this.sourceTexture.width,this.sourceTexture.height);return this.imageContainer.x=0,this.imageContainer.y=0,this.setSmoothingScale(1),this.updateMaskDisplay(!1),BFN.Stage.render(this.imageContainer,i),this.imageContainer.x=-Math.round(this.sourceTexture.width/2),this.imageContainer.y=-Math.round(this.sourceTexture.height/2),this.setSmoothingScale(this._scale),this.updateMaskDisplay(),i}});Object.defineProperty(BFN,"ImageTexture",{get(){return BFN._ImageTexture||(BFN._ImageTexture=new dt),BFN._ImageTexture}});function Xe(){PIXI.Sprite.call(this),this.init()}Xe.prototype=Object.create(PIXI.Sprite.prototype);Xe.prototype.init=function(){BeFunky.log("ImageOverlay Init"),this.initDefaultValues(),this.initImageContainer(),this.initBackgroundSprite(),this.initWhiteVeil(),this.initOverlaySprite(),this.initOverlayMask(),this.initOverlayPattern(),this.initOverlayPatternMask(),this.initShadowContainer(),this.initShadowSprite(),this.initShadowMask(),this.initShadowPattern(),this.initBlurDisplay(),this.initMaskDragger()};Xe.prototype.initDefaultValues=function(){this.currentOverlayID=null,this.currentOverlayName=null,this.currentOverlayTranslation=null,this.sourceTexture=null,this.overlayTextureSource=null,this.overlayTexture=null,this.blurTexture=null,this.shadowTexture=null,this.shadowSourceTexture=null,this.overlayTextureSourceSprite=new PIXI.Sprite,this.overlayTextureSourceSprite.pluginName="smooth_picture",this._scale=1,this.baseScale=1,this.patternMode=!1,this.patternStartOffset=new PIXI.Point,this.blurAmount=0,this.blurUpdating=!1,this.blurPending=!1,this.blurIntervalActive=!1,this.shadowAmount=0,this.shadowUpdating=!1,this.shadowPending=!1,this.shadowIntervalActive=!1,this.eraseFilter=new BFN.filters.BlendModeFilter(BFN.CONST.BLEND_MODES.ERASE),this.shadowBlurFilter=new BFN.filters.GaussianBlurFilter};Xe.prototype.initImageContainer=function(){this.imageContainer=new PIXI.Sprite,this.imageContainer.interactive=!0,this.addChild(this.imageContainer)};Xe.prototype.initBackgroundSprite=function(){this.backgroundSprite=new PIXI.Sprite,this.backgroundSprite.pluginName="smooth_picture",this.imageContainer.addChild(this.backgroundSprite)};Xe.prototype.initWhiteVeil=function(){this.whiteVeil=new PIXI.Graphics,this.imageContainer.addChild(this.whiteVeil)};Xe.prototype.initOverlaySprite=function(){this.overlaySprite=new PIXI.Sprite,this.overlaySprite.pluginName="smooth_picture",this.imageContainer.addChild(this.overlaySprite)};Xe.prototype.initOverlayMask=function(){this.overlayMask=new PIXI.Sprite,this.overlayMask.anchor.x=this.overlayMask.anchor.y=.5,this.imageContainer.addChild(this.overlayMask)};Xe.prototype.initOverlayPattern=function(){this.overlayPatternTexture=PIXI.RenderTexture.create(32,32),this.overlayPatternTexture.clear(),this.overlayPattern=new BFN.TileContainer(this.overlayPatternTexture,32,32)};Xe.prototype.initOverlayPatternMask=function(){this.overlayPatternMaskTexture=null,this.overlayPatternMask=new PIXI.Sprite};Xe.prototype.initShadowContainer=function(){this.shadowContainer=new PIXI.Container};Xe.prototype.initShadowSprite=function(){this.shadowSprite=new PIXI.Sprite,this.shadowSprite.anchor.x=this.shadowSprite.anchor.y=.5,this.shadowSprite.pluginName="blend_picture",this.shadowSprite.currentScale=1,this.shadowContainer.addChild(this.shadowSprite),this.shadowSourceSprite=new PIXI.Sprite};Xe.prototype.initShadowMask=function(){this.shadowMask=new PIXI.Sprite,this.shadowMask.anchor.x=this.shadowMask.anchor.y=.5,this.shadowContainer.addChild(this.shadowMask),this.shadowSprite.mask=this.shadowMask};Xe.prototype.initShadowPattern=function(){this.shadowPatternTexture=PIXI.RenderTexture.create(32,32),this.shadowPatternTexture.clear(),this.shadowPattern=new BFN.TileContainer(this.shadowPatternTexture,32,32)};Xe.prototype.initBlurDisplay=function(){this.blurFilter=new BFN.filters.FastBlurWrapper,this.blurTexture=null,this.blurAmount=1,this.blurSprite=new PIXI.Sprite};Xe.prototype.initMaskDragger=function(){this.maskDragger=new BFN.Dragger,this.maskDragger.addEventListener(BFN.DraggerEvents.DRAGGING_STARTED.type,this.handleMaskDraggerDraggingStarted.bind(this)),this.maskDragger.addEventListener(BFN.DraggerEvents.DRAGGING.type,this.handleMaskDraggerDragging.bind(this)),this.imageContainer.on("pointerdown",i=>{this.maskDragger.drag(this.overlayMask),i.stopPropagation()})};Xe.prototype.handleOverlayGeneric=function(){let i=UITools.getToolVO("overlay_generic");i.updating_id==="reset"&&(this.overlayMask.x=this.shadowContainer.x=this.maskDragger.bounds.minX+(this.maskDragger.bounds.maxX-this.maskDragger.bounds.minX)/2,this.overlayMask.y=this.shadowContainer.y=this.maskDragger.bounds.minY+(this.maskDragger.bounds.maxY-this.maskDragger.bounds.minY)/2,UITools.setToolValue("overlay_generic","color","FFFFFF"),UITools.setToolValue("overlay_generic","opacity",.9),UITools.setToolValue("overlay_generic","size",1),UITools.setToolValue("overlay_generic","rotation",0),UITools.setToolValue("overlay_generic","blur_amount",0),UITools.setToolValue("overlay_generic","shadow_amount",0),UITools.updateToolControls("overlay_generic"),i=UITools.getToolVO("overlay_generic")),this.whiteVeil.alpha=i.opacity,this.whiteVeil.tint=parseInt(`0x${i.color}`);let e=(i.size*.8+.2)*this.baseScale,t=i.rotation*(Math.PI/180);this.overlayMask.scale.x=this.overlayMask.scale.y=e,this.overlayMask.rotation=this.patternMode?0:t,this.shadowContainer.scale.x=this.shadowContainer.scale.y=e,this.shadowContainer.rotation=this.patternMode?0:t,this.patternMode&&(this.overlayPattern.rotate(t),this.shadowPattern.rotate(t),i.updating_id==="rotation"&&this.updateOverlayPatternMaskTexture(),i.updating_id==="size"&&this.updatePatternSource()),this.updateOverlaySmoothing(e),this.blurAmount!=i.blur_amount&&(this.blurAmount=i.blur_amount,this.blurPending=!0),this.blurUpdating=!1,i.updating_id==="blur_amount"&&i.updating&&(this.blurUpdating=!0),this.blurUpdating?this.blurIntervalActive||(this.blurIntervalActive=!0,this.applyBlurInterval()):(this.blurIntervalActive=!1,this.blurPending&&this.applyBlur()),this.shadowAmount!=i.shadow_amount&&(this.shadowAmount=i.shadow_amount,this.shadowPending=!0),this.shadowUpdating=!1,i.updating_id==="shadow_amount"&&i.updating&&(this.shadowUpdating=!0),this.shadowUpdating?this.shadowIntervalActive||(this.shadowIntervalActive=!0,this.applyShadowInterval()):(this.shadowIntervalActive=!1,this.shadowPending&&this.applyShadow()),BFN.MainUI.requestRender()};Xe.prototype.handleUpdateTool=function(i){if(BFN.PhotoEditorCanvasModel.viewState===BFN.PhotoEditorCanvasModelViewStates.VIEWING_OVERLAY){let e=UITools.getToolVO(i);if(this.overlayMask.x=this.shadowContainer.x=this.maskDragger.bounds.minX+(this.maskDragger.bounds.maxX-this.maskDragger.bounds.minX)/2,this.overlayMask.y=this.shadowContainer.y=this.maskDragger.bounds.minY+(this.maskDragger.bounds.maxY-this.maskDragger.bounds.minY)/2,UITools.setToolValue("overlay_generic","color","FFFFFF"),UITools.setToolValue("overlay_generic","opacity",.9),UITools.setToolValue("overlay_generic","size",1),UITools.setToolValue("overlay_generic","rotation",0),UITools.setToolValue("overlay_generic","blur_amount",0),UITools.setToolValue("overlay_generic","shadow_amount",0),UITools.updateToolControls("overlay_generic"),UITools.applyTool("overlay_generic"),this.currentOverlayID!==i){this.patternMode=i.indexOf("patterns_patterns")!==-1,this.currentOverlayID=i,this.currentOverlayName=e.overlayName,this.currentOverlayTranslation=e.overlayTranslation;let t=this.showLoader(),r=a=>{t(),this.handleOverlayLoaded(a)};BFN.OverlaysItemLoader.load(e.categoryName,e.overlayID,r,!1)}}};Xe.prototype.setSourceTexture=function(i){this.sourceTexture!=null&&(this.sourceTexture=null),this.backgroundTexture!=null&&(this.backgroundTexture.destroyGC(!0),this.backgroundTexture=null,this.backgroundSprite.texture=PIXI.Texture.EMPTY),this.overlayTexture!=null&&(this.overlayTexture.destroyGC(!0),this.overlayTexture=null,this.overlaySprite.texture=PIXI.Texture.EMPTY,this.overlayMask.texture=PIXI.Texture.EMPTY,this.shadowMask.texture=PIXI.Texture.EMPTY),this.blurTexture!=null&&(this.blurTexture.destroyGC(!0),this.blurFilter.dispose(),this.blurTexture=null),this.overlayPatternMaskTexture!=null&&(this.overlayPatternMaskTexture.destroyGC(!0),this.overlayPatternMaskTexture=null,this.overlayPatternMask.texture=PIXI.Texture.EMPTY),this.shadowTexture!=null&&(this.shadowTexture.destroyGC(!0),this.shadowTexture=null,this.shadowSprite.texture=PIXI.Texture.EMPTY),this.shadowSourceTexture!=null&&(this.shadowSourceTexture.destroyGC(!0),this.shadowSourceTexture=null),i?(this.sourceTexture=i,this.overlayPattern.width=this.sourceTexture.width,this.overlayPattern.height=this.sourceTexture.height,this.shadowPattern.width=this.sourceTexture.width,this.shadowPattern.height=this.sourceTexture.height,this.backgroundTexture=PIXI.RenderTexture.create(this.sourceTexture.width,this.sourceTexture.height),this.backgroundSprite.texture=this.backgroundTexture,this.applyBlur(),this.overlaySprite.texture=this.sourceTexture,this.imageContainer.x=-Math.round(this.sourceTexture.width/2),this.imageContainer.y=-Math.round(this.sourceTexture.height/2),this.whiteVeil.clear(),this.whiteVeil.beginFill(16777215,1),this.whiteVeil.drawRect(0,0,this.sourceTexture.width,this.sourceTexture.height),this.whiteVeil.endFill(),this.maskDragger.setBounds(0,0,this.sourceTexture.width,this.sourceTexture.height)):(this.blurFilter.dispose(),this.currentOverlayID=null)};Xe.prototype.applyBlurInterval=function(){this.blurPending&&this.applyBlur(),this.blurIntervalActive&&setTimeout(this.applyBlurInterval.bind(this),100)};Xe.prototype.applyBlur=function(){let i=this.blurFilter.render(this.blurAmount,this.sourceTexture);this.backgroundTexture.copyPixels(i),this.blurPending=!1,BFN.MainUI.requestRender()};Xe.prototype.applyShadowInterval=function(){this.shadowPending&&this.applyShadow(),this.shadowIntervalActive&&setTimeout(this.applyShadowInterval.bind(this),100)};Xe.prototype.applyShadow=function(){this.shadowSourceTexture&&this.shadowSourceTexture.width&&this.shadowSourceTexture.height&&this.shadowBlurFilter.setInputDimensions(this.shadowSourceTexture.width,this.shadowSourceTexture.height),this.shadowBlurFilter.blur=this.shadowAmount,this.shadowSourceSprite.filters=[this.shadowBlurFilter],BFN.Stage.render(this.shadowSourceSprite,this.shadowTexture),BFN.Stage.render(this.shadowSourceSprite,this.shadowTexture,!1),this.shadowSprite.visible=this.shadowAmount>0,this.shadowPending=!1,this.patternMode&&BFN.Stage.render(this.shadowContainer,this.shadowPatternTexture),BFN.MainUI.requestRender()};Xe.prototype.updatePatternSource=function(){if(this.patternMode){let i=Math.round(this.overlayMask.texture.width*this.overlayMask.scale.x),e=Math.round(this.overlayMask.texture.height*this.overlayMask.scale.y);this.overlayMask.x=i/2,this.overlayMask.y=e/2,this.shadowContainer.x=this.overlayMask.x,this.shadowContainer.y=this.overlayMask.y,this.overlayPatternTexture.resize(i,e),BFN.Stage.render(this.overlayMask,this.overlayPatternTexture),this.overlayPattern.updateDisplay(),this.updateOverlayPatternMaskTexture(),this.shadowPatternTexture.resize(i,e),BFN.Stage.render(this.shadowContainer,this.shadowPatternTexture),this.shadowPattern.updateDisplay()}};Xe.prototype.updateOverlayPatternMaskTexture=function(){BFN.Stage.render(this.overlayPattern,this.overlayPatternMaskTexture)};Xe.prototype.updateOverlaySmoothing=function(i=1){this.shadowSprite.currentScale=this.baseScale,this.overlayTextureSource&&this.overlayTexture&&(this.overlayTextureSourceSprite.currentScale=i,BFN.Stage.render(this.overlayTextureSourceSprite,this.overlayTexture))};Xe.prototype.setSmoothingScale=function(i){this.backgroundSprite.currentScale=i,this.overlaySprite.currentScale=i};Xe.prototype.showLoader=function(){let i=BFN.tertiaryMenu.activePresetId;return BFN.tertiaryMenu.loadingPresetIds=[...BFN.tertiaryMenu.loadingPresetIds,i],function(){BFN.tertiaryMenu.loadingPresetIds=BFN.tertiaryMenu.loadingPresetIds.filter(e=>e!==i)}};Xe.prototype.handleOverlayLoaded=function(i){if(this.overlayPatternMaskTexture!=null&&(this.overlayPatternMaskTexture.destroyGC(!0),this.overlayPatternMaskTexture=null,this.overlayPatternMask.texture=PIXI.Texture.EMPTY),i){if(this.patternMode){try{this.imageContainer.removeChild(this.overlayMask)}catch(o){}try{this.imageContainer.removeChild(this.shadowContainer)}catch(o){}this.overlayPattern.offset(0,0),this.shadowPattern.offset(0,0),this.overlayPatternMaskTexture=PIXI.RenderTexture.create(this.sourceTexture.width,this.sourceTexture.height),this.overlayPatternMaskTexture.clear(),this.overlayPatternMask.texture=this.overlayPatternMaskTexture,this.imageContainer.addChild(this.overlayPatternMask),this.imageContainer.addChild(this.shadowPattern),this.overlaySprite.mask=this.overlayPatternMask}else{try{this.imageContainer.removeChild(this.overlayPatternMask)}catch(o){}try{this.imageContainer.removeChild(this.shadowPattern)}catch(o){}this.imageContainer.addChild(this.overlayMask),this.imageContainer.addChild(this.shadowContainer),this.overlaySprite.mask=this.overlayMask}this.maskDragger.autoDrag=!this.patternMode,this.maskDragger.useBounds=!this.patternMode,this.overlayTextureSource!=null&&(this.overlayTextureSource.destroyGC(!0),this.overlayTextureSource=null),this.overlayTexture!=null&&(this.overlayTexture.destroyGC(!0),this.overlayTexture=null),this.shadowTexture!=null&&(this.shadowTexture.destroyGC(!0),this.shadowTexture=null),this.shadowSourceTexture!=null&&(this.shadowSourceTexture.destroyGC(!0),this.shadowSourceTexture=null),this.overlayTextureSource=i,this.overlayTextureSourceSprite.texture=this.overlayTextureSource,this.overlayTexture=this.overlayTextureSource.renderClone(),this.overlayMask.texture=this.overlayTexture,this.shadowMask.texture=this.overlayTexture;let e=16,t=this.overlayTexture.width+e*2,r=this.overlayTexture.height+e*2,a=PIXI.RenderTexture.create(t,r);a.fillRect(0,0,t,r,0,1);let s=a.renderClone();s.copyPixels(this.overlayTexture,{x:e,y:e},!0,1,1),this.eraseFilter.iChannel1=s,this.shadowSourceSprite.texture=a,this.shadowSourceSprite.filters=[this.eraseFilter],this.shadowSourceTexture=a.renderClone(),BFN.Stage.render(this.shadowSourceSprite,this.shadowSourceTexture),a.destroyGC(!0),this.eraseFilter.iChannel1=null,s.destroyGC(!0),this.shadowSourceSprite.texture=this.shadowSourceTexture,this.shadowTexture=this.shadowSourceTexture.renderClone(),this.shadowSprite.texture=this.shadowTexture,this.applyShadow(),this.sourceTexture&&(this.baseScale=Math.min(this.sourceTexture.width/this.overlayTexture.width,this.sourceTexture.height/this.overlayTexture.height)*.9,this.overlayMask.scale.x=this.overlayMask.scale.y=this.baseScale,this.shadowContainer.scale.x=this.shadowContainer.scale.y=this.baseScale,this.patternMode?this.updatePatternSource():(this.overlayMask.x=this.sourceTexture.width/2,this.overlayMask.y=this.sourceTexture.height/2,this.shadowContainer.x=this.sourceTexture.width/2,this.shadowContainer.y=this.sourceTexture.height/2),this.updateOverlaySmoothing(this.baseScale)),BFN.MainUI.requestRender()}else console.log("OVERLAY TEXTURE NOT FOUND")};Xe.prototype.handleMaskDraggerDraggingStarted=function(i){this.patternMode&&(this.patternStartOffset.x=this.overlayPattern.globalOffsetPoint.x,this.patternStartOffset.y=this.overlayPattern.globalOffsetPoint.y)};Xe.prototype.handleMaskDraggerDragging=function(i){if(this.patternMode){let e=this.patternStartOffset.x+this.maskDragger.mouseDeltaX,t=this.patternStartOffset.y+this.maskDragger.mouseDeltaY;this.overlayPattern.offset(e,t),this.shadowPattern.offset(e,t),this.updateOverlayPatternMaskTexture()}else this.shadowContainer.x=this.overlayMask.x,this.shadowContainer.y=this.overlayMask.y};Object.defineProperty(Xe.prototype,"toolScale",{set(i){this._scale=i,this.maskDragger.scale=this._scale,this.setSmoothingScale(this._scale)},get(){return this._scale}});Object.defineProperty(Xe.prototype,"modifiedTexture",{get(){let i=PIXI.RenderTexture.create(this.sourceTexture.width,this.sourceTexture.height);return this.imageContainer.x=0,this.imageContainer.y=0,this.setSmoothingScale(1),BFN.Stage.render(this.imageContainer,i),this.imageContainer.x=-Math.round(this.sourceTexture.width/2),this.imageContainer.y=-Math.round(this.sourceTexture.height/2),this.setSmoothingScale(this._scale),i}});Object.defineProperty(BFN,"ImageOverlay",{get(){return BFN._ImageOverlay||(BFN._ImageOverlay=new Xe),BFN._ImageOverlay}});function yt(i,e,t,r,a){PIXI.Sprite.call(this),this._elementVO=i,this._sourcePoint=e,this._centerPoint=t,this._displayDimensions=r,this.useThumb=a||!1,this.init()}yt.prototype=Object.create(PIXI.Sprite.prototype);yt.prototype.init=function(){BeFunky.log("LensFlareDisplayElement Init"),this.initDefaultValues(),this.updateProperties()};yt.prototype.initDefaultValues=function(){this.PId2=Math.PI/2,this.radsPerDeg=Math.PI/180,this.elementBaseDimensions=new PIXI.Point,this.elementBeta=0,this._ignoreActiveProperty=!1,this._intensityFactor=0,this.lensTintFilter=new BFN.filters.LensTintFilter,this.usesColorOverlay=!1,this.staticElement=!1,this.textureSource=null,this.elementSprite=new PIXI.Sprite,this.handleAssetUpdatedBind=this.handleAssetUpdated.bind(this),this.handlePropertyUpdatedBind=this.handlePropertyUpdated.bind(this),this.handlePositionUpdatedBind=this.handlePositionUpdated.bind(this),this._elementVO.addEventListener(BFN.LensFlareElementVOEvents.ASSET_UPDATED.type,this.handleAssetUpdatedBind),this._elementVO.addEventListener(BFN.LensFlareElementVOEvents.PROPERTY_UPDATED.type,this.handlePropertyUpdatedBind),this._elementVO.addEventListener(BFN.LensFlareElementVOEvents.POSITION_UPDATED.type,this.handlePositionUpdatedBind),this.handleMainUIPreRenderBind=this.handleMainUIPreRender.bind(this)};yt.prototype.createStaticMask=function(){if(!this.staticMaskCreated){if(!BFN.LensFlareManager.staticMaskTexture){let i=new PIXI.Graphics;i.beginFill(16777215),i.drawRect(0,0,1024,1024),i.endFill();let e=PIXI.RenderTexture.create(1024,1024);BFN.Stage.render(i,e);let t=BFN.ShaderPool.BrushFilter;t.radius=512,t.hardness=.1;let r=new PIXI.Sprite;r.pluginName="filter_renderer",r.texture=e,r.bfn_shaders=[t];let a=PIXI.RenderTexture.create(1024,1024);BFN.Stage.render(r,a),i.clear(),e.destroyGC(!0),r.filters=[],r.destroy(!0),BFN.LensFlareManager.staticMaskTexture=a}this.staticContainer=new PIXI.Container,this.staticSprite=new PIXI.Sprite,this.staticContainer.addChild(this.staticSprite),this.staticMask=new PIXI.Sprite(BFN.LensFlareManager.staticMaskTexture),this.staticMask.anchor.x=this.staticMask.anchor.y=.5,this.staticContainer.addChild(this.staticMask),this.staticSprite.mask=this.staticMask,this.staticMaskCreated=!0}};yt.prototype.updateAsset=function(){if(BFN.LensFlareData.assets.hasOwnProperty(this._elementVO.getProperty("assetID"))){let i=BFN.LensFlareData.assets[this._elementVO.getProperty("assetID")];if(this.destroyTextures(),this.staticElement=i.static,this.textureSource=this.useThumb?i.thumbTexture:i.imageTexture,this.textureSource){this.elementSprite.texture=this.textureSource;let e=BFN.Util.cloneTexture(this.textureSource);this.staticElement?(this.texture=PIXI.RenderTexture.create(this._displayDimensions.x,this._displayDimensions.y),this.createStaticMask(),this.staticSprite.texture=e,this.staticSprite.scale.x=this.staticSprite.scale.y=Math.max(this._displayDimensions.x,this._displayDimensions.y)/Math.min(this.staticSprite.texture.width,this.staticSprite.texture.height),this.staticSprite.x=(this._displayDimensions.x-this.staticSprite.texture.width*this.staticSprite.scale.x)/2,this.staticSprite.y=(this._displayDimensions.y-this.staticSprite.texture.height*this.staticSprite.scale.y)/2,this.elementBaseDimensions.x=this.staticMask.texture.width,this.elementBaseDimensions.y=this.staticMask.texture.height,BFN.MainUI.addEventListener(BFN.MainUIEvents.PRE_RENDER.type,this.handleMainUIPreRenderBind)):(this.texture=e,this.elementBaseDimensions.x=this.texture.width,this.elementBaseDimensions.y=this.texture.height,BFN.MainUI.removeEventListener(BFN.MainUIEvents.PRE_RENDER.type,this.handleMainUIPreRenderBind)),this.updatePosition(),this.updateScale(),this.updateProperties()}}};yt.prototype.updatePosition=function(){let i=this._sourcePoint.x-this._centerPoint.x,e=this._sourcePoint.y-this._centerPoint.y,t=Math.sqrt(i*i+e*e);this.elementBeta=Math.atan2(e,i);let r=this._sourcePoint.x-Math.cos(this.elementBeta)*t*2*this._elementVO.getProperty("sourceDistanceFactor")+Math.cos(this.elementBeta+this.PId2)*t*2*this._elementVO.getProperty("centerDistanceFactor")+this._displayDimensions.x/2,a=this._sourcePoint.y-Math.sin(this.elementBeta)*t*2*this._elementVO.getProperty("sourceDistanceFactor")+Math.sin(this.elementBeta+this.PId2)*t*2*this._elementVO.getProperty("centerDistanceFactor")+this._displayDimensions.y/2;this.staticElement?(this.x=this.y=0,this.anchor.x=this.anchor.y=0,this.staticMask.x=r,this.staticMask.y=a,this.renderPending=!0):(this.x=r,this.y=a,this.anchor.x=this.anchor.y=.5),this.updateRotation()};yt.prototype.updateRotation=function(){let i=(this._elementVO.getProperty("rotationLock")?this.elementBeta:0)+this._elementVO.getProperty("rotationOffset")*this.radsPerDeg;this.staticElement?(this.rotation=0,this.staticMask.rotation=i):this.rotation=i};yt.prototype.updateScale=function(){if(this.elementBaseDimensions.x>0&&this.elementBaseDimensions.y>0){let e=Math.max(this._displayDimensions.x,this._displayDimensions.y)/Math.max(this.elementBaseDimensions.x,this.elementBaseDimensions.y)*this._elementVO.getProperty("sizeFactor");e=Math.max(0,e+e*this._intensityFactor*this._elementVO.getProperty("sizeFactorGlobal")),this.staticElement?(this.scale.x=this.scale.y=1,this.staticMask.scale.x=e*this._elementVO.getProperty("stretchXFactor"),this.staticMask.scale.y=e*this._elementVO.getProperty("stretchYFactor"),this.renderPending=!0):(this.scale.x=e*this._elementVO.getProperty("stretchXFactor"),this.scale.y=e*this._elementVO.getProperty("stretchYFactor"))}};yt.prototype.updateIntensity=function(){this._ignoreActiveProperty?this.alpha=1:this.alpha=this._elementVO.getProperty("intensityFactor")+this._elementVO.getProperty("intensityFactor")*this._intensityFactor*this._elementVO.getProperty("intensityFactorGlobal")};yt.prototype.updateProperties=function(){this.visible=this._ignoreActiveProperty?!0:this._elementVO.getProperty("active"),this.updateColor(),this.updateIntensity(),this.updateScale(),this.updateRotation()};yt.prototype.updateColor=function(){let i=-1,e=this._elementVO.getProperty("colorGlobal"),t=this._elementVO.getProperty("color");if(e>=0?i=e:t>=0&&(i=t),i>=0){this.usesColorOverlay=!0;let r="0x"+i.toString(16);this.lensTintFilter.color=r}else this.usesColorOverlay=!1;this.updateBlendMode()};yt.prototype.updateBlendMode=function(){if(this.blendMode=PIXI.BLEND_MODES.NORMAL,!this._ignoreActiveProperty)switch(this._elementVO.getProperty("blendMode")){case"screen":this.blendMode=PIXI.BLEND_MODES.SCREEN;break;case"add":this.blendMode=PIXI.BLEND_MODES.ADD;break}try{this.staticElement?(this.usesColorOverlay?this.staticSprite.filters=[this.lensTintFilter]:this.staticSprite.filters=[],BFN.Stage.render(this.staticContainer,this.texture)):(this.usesColorOverlay?this.elementSprite.filters=[this.lensTintFilter]:this.elementSprite.filters=[],BFN.Stage.render(this.elementSprite,this.texture))}catch(i){}};yt.prototype.destroyElement=function(){this.destroyTextures(),this.staticMaskCreated&&(this.staticSprite.mask=null,this.staticContainer.removeChild(this.staticMask),this.staticMask.destroy(!1),this.staticMask.texture=null,this.staticMask=null,this.staticContainer.removeChild(this.staticSprite),this.staticSprite.filters=[],this.staticSprite.destroy(!1),this.staticSprite.texture=null,this.staticSprite=null,this.staticContainer=null),this.elementSprite.filters=[],this.elementSprite.destroy(!1),this.elementSprite=null,this.textureSource=null,this._elementVO.removeEventListener(BFN.LensFlareElementVOEvents.ASSET_UPDATED.type,this.handleAssetUpdatedBind),this._elementVO.removeEventListener(BFN.LensFlareElementVOEvents.PROPERTY_UPDATED.type,this.handlePropertyUpdatedBind),this._elementVO.removeEventListener(BFN.LensFlareElementVOEvents.POSITION_UPDATED.type,this.handlePositionUpdatedBind),this._elementVO=null,BFN.MainUI.removeEventListener(BFN.MainUIEvents.PRE_RENDER.type,this.handleMainUIPreRenderBind),this.destroy(!0)};yt.prototype.destroyTextures=function(){try{this.texture.destroyGC(!0)}catch(i){}if(this.texture=PIXI.Texture.EMPTY,this.staticMaskCreated){try{this.staticSprite.texture.destroyGC(!0)}catch(i){}this.staticSprite.texture=PIXI.Texture.EMPTY}};yt.prototype.applyColorOverlay=function(i,e,t){};yt.prototype.handleAssetUpdated=function(i){this.updateAsset()};yt.prototype.handlePropertyUpdated=function(i){this.updateProperties()};yt.prototype.handlePositionUpdated=function(i){this.updatePosition()};yt.prototype.handleMainUIPreRender=function(i){this.staticMask&&this.renderPending&&(this.renderPending=!1,BFN.Stage.render(this.staticContainer,this.texture))};Object.defineProperty(yt.prototype,"elementVO",{get:function(){return this._elementVO}});Object.defineProperty(yt.prototype,"ignoreActiveProperty",{set:function(i){this._ignoreActiveProperty=i,this.updateProperties()},get:function(){return this._ignoreActiveProperty}});Object.defineProperty(yt.prototype,"intensityFactor",{set:function(i){this._intensityFactor=i,this.updateScale(),this.updateIntensity()},get:function(){return this._intensityFactor}});BFN.LensFlareDisplayElement=yt;BFN.LensFlareDisplayEvents={ELEMENTS_ADDED:new Event("ELEMENTS_ADDED")};function ft(i){PIXI.Sprite.call(this),BFN.EventDispatcher.call(this),this.useThumbs=i||!1,this.init()}ft.prototype=window.azrc.extend(Object.create(PIXI.Sprite.prototype),Object.create(BFN.EventDispatcher.prototype));ft.prototype.init=function(){BeFunky.log("LensFlareDisplay Init"),this.initDefaultValues(),this.initDisplay()};ft.prototype.initDefaultValues=function(){this.elements=[],this._sourcePoint=new PIXI.Point,this._centerPoint=new PIXI.Point,this._displayDimensions=new PIXI.Point,this.displayTexture=null,this.anchor.x=this.anchor.y=.5,this._intenseMode=!0,this._intensityFactor=0,this._itemWidth=this._displayDimensions.x,this._itemHeight=this._displayDimensions.y,this.maxSize=1200,this.scaleFactor=1,this.handleLensFlareManagerThumbsLoadedBind=this.handleLensFlareManagerThumbsLoaded.bind(this),this.handleLensFlareManagerAssetsLoadedBind=this.handleLensFlareManagerAssetsLoaded.bind(this),this.handleMainUIPreRenderBind=this.handleMainUIPreRender.bind(this)};ft.prototype.initDisplay=function(){this.displayContainer=new PIXI.Container,this.addChild(this.displayContainer),this.blackBackground=new PIXI.Graphics,this.blackBackground.visible=!0,this.displayContainer.addChild(this.blackBackground),this.elementContainer=new PIXI.Container,this.displayContainer.addChild(this.elementContainer),this.elementContainerMask=new PIXI.Graphics,this.displayContainer.addChild(this.elementContainerMask),this.elementContainer.mask=this.elementContainerMask};ft.prototype.setDisplayDimensions=function(i,e){this.scaleFactor=1,(i>this.maxSize||e>this.maxSize)&&(this.scaleFactor=Math.min(this.maxSize/i,this.maxSize/e),i=Math.round(i*this.scaleFactor),e=Math.round(e*this.scaleFactor)),this.scale.x=this.scale.y=1/this.scaleFactor,this._itemWidth=this._displayDimensions.x=i,this._itemHeight=this._displayDimensions.y=e,this.texture=PIXI.Texture.EMPTY;try{this.displayTexture.destroyGC(!0),this.displayTexture=null}catch(t){}i>0&&e>0&&(this.displayTexture=PIXI.RenderTexture.create(i,e),this._intenseMode||(BFN.MainUI.addEventListener(BFN.MainUIEvents.PRE_RENDER.type,this.handleMainUIPreRenderBind),this.texture=this.displayTexture)),this.displayContainer.x=this._intenseMode?-Math.round(this._itemWidth/2):0,this.displayContainer.y=this._intenseMode?-Math.round(this._itemHeight/2):0,this.blackBackground.clear(),this.blackBackground.beginFill(0),this.blackBackground.drawRect(0,0,this._itemWidth,this._itemHeight),this.blackBackground.endFill(),this.elementContainerMask.clear(),this.elementContainerMask.beginFill(16777215),this.elementContainerMask.drawRect(0,0,this._itemWidth,this._itemHeight),this.elementContainerMask.endFill()};ft.prototype.clearElements=function(){for(let i=0;i<this.elements.length;i++){let e=this.elements[i];e.destroyElement(),this.elementContainer.removeChild(e)}this.elements.splice(0)};ft.prototype.addElements=function(i){this.clearElements();let e=[];for(let t=0;t<i.length;t++){let r=i[t],a=r.getProperty("assetID");if(a){let s=new BFN.LensFlareDisplayElement(r,this._sourcePoint,this._centerPoint,this._displayDimensions,this.useThumbs);this.elementContainer.addChild(s),this.elements.push(s),e.push(a)}}this.updateElementPositions(),this.useThumbs?(BFN.LensFlareManager.addEventListener(BFN.LensFlareManagerEvents.THUMBS_LOADED.type,this.handleLensFlareManagerThumbsLoadedBind),BFN.LensFlareManager.loadAssetThumbs(e)):(BFN.LensFlareManager.addEventListener(BFN.LensFlareManagerEvents.ASSETS_LOADED.type,this.handleLensFlareManagerAssetsLoadedBind),BFN.LensFlareManager.loadAssets(e))};ft.prototype.addElementsComplete=function(){for(let i=0;i<this.elements.length;i++){let e=this.elements[i];e.updateAsset(),e.intensityFactor=this._intensityFactor}this.renderPending=!0,BFN.MainUI.requestRender(),this.dispatchEvent(BFN.LensFlareDisplayEvents.ELEMENTS_ADDED)};ft.prototype.setSourcePoint=function(i,e){this._sourcePoint.x=i*this.scaleFactor,this._sourcePoint.y=e*this.scaleFactor,this.updateElementPositions()};ft.prototype.setCenterPoint=function(i,e){this._centerPoint.x=i*this.scaleFactor,this._centerPoint.y=e*this.scaleFactor,this.updateElementPositions()};ft.prototype.updateElementPositions=function(){for(let i=0;i<this.elements.length;i++)this.elements[i].elementVO.dispatchEvent(BFN.LensFlareElementVOEvents.POSITION_UPDATED);this.renderPending=!0,BFN.MainUI.requestRender()};ft.prototype.setGlobalColors=function(i){for(let e=0;e<this.elements.length;e++){let t=this.elements[e],r=t.elementVO.getProperty("colorGlobalGroup");if(i.hasOwnProperty(r)){let a=parseInt("0x"+i[r]);t.elementVO.getProperty("colorGlobal")!=a&&t.elementVO.setProperty("colorGlobal",a)}}this.renderPending=!0,BFN.MainUI.requestRender()};ft.prototype.getElementVOClones=function(){return[]};ft.prototype.handleLensFlareManagerThumbsLoaded=function(){BFN.LensFlareManager.removeEventListener(BFN.LensFlareManagerEvents.THUMBS_LOADED.type,this.handleLensFlareManagerThumbsLoadedBind),this.addElementsComplete()};ft.prototype.handleLensFlareManagerAssetsLoaded=function(){BFN.LensFlareManager.removeEventListener(BFN.LensFlareManagerEvents.ASSETS_LOADED.type,this.handleLensFlareManagerAssetsLoadedBind),this.addElementsComplete()};ft.prototype.handleMainUIPreRender=function(i){this.renderPending&&(this.renderPending=!1,this._intenseMode||BFN.Stage.render(this.displayContainer,this.displayTexture))};Object.defineProperty(ft.prototype,"sourcePoint",{get:function(){return this._sourcePoint}});Object.defineProperty(ft.prototype,"centerPoint",{get:function(){return this._centerPoint}});Object.defineProperty(ft.prototype,"displayDimensions",{get:function(){return this._displayDimensions}});Object.defineProperty(ft.prototype,"intenseMode",{set:function(i){this._intenseMode!=i&&(this._intenseMode=i,this.blackBackground.visible=!this._intenseMode,this.blendMode=this._intenseMode?PIXI.BLEND_MODES.NORMAL:PIXI.BLEND_MODES.SCREEN,this._intenseMode?(this.displayContainer.x=-Math.round(this._itemWidth/2),this.displayContainer.y=-Math.round(this._itemHeight/2),this.addChild(this.displayContainer),BFN.MainUI.removeEventListener(BFN.MainUIEvents.PRE_RENDER.type,this.handleMainUIPreRenderBind),this.texture=PIXI.Texture.EMPTY):(this.displayContainer.x=this.displayContainer.y=0,this.removeChild(this.displayContainer),this.displayTexture&&(BFN.MainUI.addEventListener(BFN.MainUIEvents.PRE_RENDER.type,this.handleMainUIPreRenderBind),this.texture=this.displayTexture,this.renderPending=!0)),BFN.MainUI.requestRender())},get:function(){return this._intenseMode}});Object.defineProperty(ft.prototype,"intensityFactor",{set:function(i){this._intensityFactor=i;for(let e=0;e<this.elements.length;e++){let t=this.elements[e];t.intensityFactor=this._intensityFactor}this.renderPending=!0,BFN.MainUI.requestRender()},get:function(){return this._intensityFactor}});Object.defineProperty(ft.prototype,"itemWidth",{get:function(){return this._itemWidth}});Object.defineProperty(ft.prototype,"itemHeight",{get:function(){return this._itemHeight}});BFN.LensFlareDisplay=ft;function st(){PIXI.Sprite.call(this),this.init()}st.prototype=Object.create(PIXI.Sprite.prototype);st.prototype.init=function(){BeFunky.log("ImageLensFlare Init"),this.initDefaultValues(),this.initImageContainer(),this.initBlackBackground(),this.initSourceSprite(),this.initLensFlareDisplay(),this.initControls(),this.initControlDragger()};st.prototype.initDefaultValues=function(){this.interactive=!0,this.sourceTexture=null,this.currentPresetID=null,this.currentPresetName=null,this.hovering=!1,this._scale=1,this.newSession=!1,this.keepGuidesOn=!1,this.on("pointerover",this.handleToolMouseOver.bind(this)),this.on("pointerout",this.handleToolMouseOut.bind(this)),this.on("pointerdown",this.handleToolMouseDown.bind(this))};st.prototype.initImageContainer=function(){this.imageContainer=new PIXI.Sprite,this.addChild(this.imageContainer)};st.prototype.initBlackBackground=function(){this.blackBackground=new PIXI.Sprite,this.imageContainer.addChild(this.blackBackground)};st.prototype.initSourceSprite=function(){this.sourceSprite=new PIXI.Sprite,this.imageContainer.addChild(this.sourceSprite)};st.prototype.initLensFlareDisplay=function(){this.lensFlareDisplay=new BFN.LensFlareDisplay,this.imageContainer.addChild(this.lensFlareDisplay)};st.prototype.initControls=function(){this.controls=new PIXI.Container,this.addChild(this.controls),this.flareSourceControl=BeFunky.isMobile?this.getFlareControl(20,22):this.getFlareControl(15),this.controls.addChild(this.flareSourceControl),this.flareCenterControl=BeFunky.isMobile?this.getFlareControl(15,22):this.getFlareControl(10),this.controls.addChild(this.flareCenterControl)};st.prototype.initControlDragger=function(){this.controlDragger=new BFN.Dragger,this.controlDragger.addEventListener(BFN.DraggerEvents.DRAGGING.type,this.handleControlDraggerDragging.bind(this)),this.controlDragger.addEventListener(BFN.DraggerEvents.DRAGGING_STARTED.type,this.handleControlDraggerDraggingStarted.bind(this)),this.controlDragger.addEventListener(BFN.DraggerEvents.DRAGGING_COMPLETE.type,this.handleControlDraggerDraggingComplete.bind(this))};st.prototype.handleLensFlareGeneric=function(){let i=UITools.getToolVO("lens_flare_generic");this.lensFlareDisplay.intenseMode=i.intense_mode=="intense",this.lensFlareDisplay.intensityFactor=i.intensity/100,BFN.StageModel.setRefreshFactor(i.updating?.5:1)};st.prototype.handleUpdateTool=function(i){if(BFN.PhotoEditorCanvasModel.viewState==BFN.PhotoEditorCanvasModelViewStates.VIEWING_LENS_FLARE){let e=UITools.getToolVO(i);if(this.newSession){this.newSession=!1;for(let r=1;r<=5;r++){let a="color_value_"+r;e.hasOwnProperty(a)&&UITools.setToolValue(i,a,e.defaultValues[a])}UITools.updateToolControls(i),UITools.setToolValue("lens_flare_generic","intense_mode","normal"),UITools.setToolValue("lens_flare_generic","intensity",0),UITools.updateToolControls("lens_flare_generic"),this.handleLensFlareGeneric()}if(e=UITools.getToolVO(i),this.currentPresetID!=e.presetID){this.currentPresetID=e.presetID,this.currentPresetName=BFN.LensFlareData.presets[this.currentPresetID].presetName;let r=!1,a=BFN.LensFlareData.presets[this.currentPresetID].elementVOs,s=[];for(let o=0;o<a.length;o++){let n=a[o];s.push(n.clone()),n.properties.blendMode=="add"&&(r=!0)}this.lensFlareDisplay.addElements(s)}let t=null;for(let r=1;r<=5;r++)e.hasOwnProperty("color_value_"+r)&&(t||(t={}),t[r]=e["color_value_"+r]);t&&this.lensFlareDisplay.setGlobalColors(t)}};st.prototype.setSourceTexture=function(i){let e=i&&!this.sourceTexture;this.sourceTexture!=null&&(this.sourceTexture=null,this.sourceSprite.texture=PIXI.Texture.EMPTY),i&&(this.sourceTexture=i,this.sourceSprite.texture=this.sourceTexture,this.newSession=!0),this.resetControls(e),this.updateDisplay(),this.sourceTexture||(this.currentPresetID=null,this.lensFlareDisplay.clearElements())};st.prototype.resetControls=function(i){if(this.keepGuidesOn=!1,this.controls.visible=!0,this.lensFlareDisplay.intenseMode=!1,this.lensFlareDisplay.intensityFactor=0,this.sourceTexture&&i){let e=Math.min(this.sourceTexture.width,this.sourceTexture.height)/4;this.setSourcePoint(e,-e),this.setCenterPoint(0,0)}BFN.MainUI.requestRender()};st.prototype.setSourcePoint=function(i,e){this.flareSourceControl.x=i,this.flareSourceControl.y=e,this.lensFlareDisplay.setSourcePoint(i,e),BFN.MainUI.requestRender()};st.prototype.setCenterPoint=function(i,e){this.flareCenterControl.x=i,this.flareCenterControl.y=e,this.lensFlareDisplay.setCenterPoint(i,e),BFN.MainUI.requestRender()};st.prototype.updateDisplay=function(){this.hitArea=new PIXI.Rectangle,this.blackBackgroundTexture||(this.blackBackgroundTexture=PIXI.RenderTexture.create(32,32),this.blackBackgroundTexture.fillColor(0),this.blackBackground.texture=this.blackBackgroundTexture),this.lensFlareDisplay.setDisplayDimensions(0,0),this.sourceTexture&&(this.hitArea=new PIXI.Rectangle(-this.sourceTexture.width,-this.sourceTexture.height,this.sourceTexture.width*2,this.sourceTexture.height*2),this.blackBackground.width=this.sourceTexture.width,this.blackBackground.height=this.sourceTexture.height,this.imageContainer.x=-Math.round(this.sourceTexture.width/2),this.imageContainer.y=-Math.round(this.sourceTexture.height/2),this.lensFlareDisplay.x=Math.round(this.sourceTexture.width/2),this.lensFlareDisplay.y=Math.round(this.sourceTexture.height/2),this.lensFlareDisplay.setDisplayDimensions(this.sourceTexture.width,this.sourceTexture.height),this.lensFlareDisplay.setSourcePoint(this.flareSourceControl.x,this.flareSourceControl.y),this.lensFlareDisplay.setCenterPoint(this.flareCenterControl.x,this.flareCenterControl.y))};st.prototype.getFlareControl=function(i,e){let t=2,r=.5,a=Math.round((i+t/2+r)*2),s=PIXI.RenderTexture.create(a,a,PIXI.settings.SCALE_MODE,window.bfn_resolution),o,n;o=t+r*2,n=a/2-t/2-r-1,BFN.graphics.drawShape("roundedRect",s,{fillColor:2147483648,paddingX:o,paddingY:n,quality:.5,clear:!0}),BFN.graphics.drawShape("roundedRect",s,{fillColor:2147483648,paddingX:n,paddingY:o,quality:.5,clear:!1}),BFN.graphics.drawShape("ellipse",s,{strokeWidth:t+r*2,strokeColor:2147483648,quality:.5,clear:!1}),o=t+r,n=a/2-t/2-1,BFN.graphics.drawShape("roundedRect",s,{fillColor:4294967295,paddingX:o,paddingY:n,quality:.5,clear:!1}),BFN.graphics.drawShape("roundedRect",s,{fillColor:4294967295,paddingX:n,paddingY:o,quality:.5,clear:!1}),BFN.graphics.drawShape("ellipse",s,{strokeWidth:t,strokeColor:4294967295,paddingX:r,paddingY:r,quality:.5,clear:!1});let l=new PIXI.Sprite(s);if(l.interactive=!0,l.buttonMode=!0,l.anchor.x=l.anchor.y=.5,typeof e=="number"&&e>i){l.hitArea=new PIXI.Polygon;let c=Math.PI/12;for(let h=0;h<24;h++){let u=Math.round(Math.cos(h*c)*e),d=Math.round(Math.sin(h*c)*e);l.hitArea.points.push(u,d)}}return l.on("pointerdown",this.handleFlareControlPressed.bind(this)),l};st.prototype.handleToolMouseOver=function(i){this.hovering=!0,this.controls.visible=!0,BFN.MainUI.requestRender()};st.prototype.handleToolMouseOut=function(i){this.hovering=!1,this.controlDragger.dragging||(this.controls.visible=this.keepGuidesOn,BFN.MainUI.requestRender())};st.prototype.handleToolMouseDown=function(i){this.hovering||(this.keepGuidesOn=!0,this.handleToolMouseOver())};st.prototype.handleFlareControlPressed=function(i){this.sourceTexture&&(this.controlDragger.setBounds(-this.sourceTexture.width,-this.sourceTexture.height,this.sourceTexture.width,this.sourceTexture.height),this.controlDragger.drag(i.currentTarget),i.stopPropagation())};st.prototype.handleControlDraggerDragging=function(i){switch(this.controlDragger.item){case this.flareSourceControl:this.lensFlareDisplay.setSourcePoint(this.controlDragger.draggedX,this.controlDragger.draggedY);break;case this.flareCenterControl:this.lensFlareDisplay.setCenterPoint(this.controlDragger.draggedX,this.controlDragger.draggedY);break}};st.prototype.handleControlDraggerDraggingStarted=function(i){this.hovering||(this.keepGuidesOn=!0,this.handleToolMouseOver())};st.prototype.handleControlDraggerDraggingComplete=function(i){this.hovering||this.handleToolMouseOut(null)};Object.defineProperty(st.prototype,"toolScale",{set:function(i){this._scale=i,this.controlDragger.scale=this._scale,this.flareSourceControl.scale.x=this.flareSourceControl.scale.y=1/this._scale,this.flareCenterControl.scale.x=this.flareCenterControl.scale.y=1/this._scale},get:function(){return this._scale}});Object.defineProperty(st.prototype,"modifiedTexture",{get:function(){let i=PIXI.RenderTexture.create(this.sourceTexture.width,this.sourceTexture.height);return this.imageContainer.x=0,this.imageContainer.y=0,BFN.Stage.render(this.imageContainer,i),this.imageContainer.x=-Math.round(this.sourceTexture.width/2),this.imageContainer.y=-Math.round(this.sourceTexture.height/2),i}});Object.defineProperty(BFN,"ImageLensFlare",{get:function(){return BFN._ImageLensFlare||(BFN._ImageLensFlare=new st),BFN._ImageLensFlare}});function $e(){PIXI.Sprite.call(this),this.init()}$e.prototype=Object.create(PIXI.Sprite.prototype);$e.prototype.init=function(){BeFunky.log("ImageCrop Init"),this.initDefaultValues(),this.initImageContainer(),this.initSprites(),this.initCropFrame(),this.initCropGrid(),this.initCropHandles(),this.initDragger()};$e.prototype.initDefaultValues=function(){this.sourceTexture=null,this._scale=1,this.cropRatioLocked=!1,this.cropRatio=1,this.cropWidth=0,this.cropWidth=0,this.minCropSize=20,this.handleSize=20,this.imageBounds={minX:0,minY:0,maxX:0,maxY:0},this.currentCropHandle=null,this.cropRatios=BFN.CropRatioMap,this.handleCropFrameDraggingBind=this.handleCropFrameDragging.bind(this),this.handleCropFrameDraggingCompleteBind=this.handleCropFrameDraggingComplete.bind(this),this.handleCropHandleDraggingBind=this.handleCropHandleDragging.bind(this),this.handleCropHandleDraggingCompleteBind=this.handleCropHandleDraggingComplete.bind(this)};$e.prototype.initImageContainer=function(){this.imageContainer=new PIXI.Container,this.addChild(this.imageContainer)};$e.prototype.initSprites=function(){this.uncroppedSprite=new PIXI.Sprite,this.uncroppedSprite.pluginName="blend_picture",this.uncroppedSprite.alpha=.5,this.imageContainer.addChild(this.uncroppedSprite),this.croppedSprite=new PIXI.Sprite,this.croppedSprite.pluginName="blend_picture",this.imageContainer.addChild(this.croppedSprite)};$e.prototype.initCropFrame=function(){this.cropFrameContainer=new PIXI.Container,this.imageContainer.addChild(this.cropFrameContainer),this.cropFrameMask=new PIXI.Graphics,this.cropFrameMask.beginFill(16777215,1),this.cropFrameMask.drawRect(-50,-50,100,100),this.cropFrameMask.endFill(),this.cropFrameMask.interactive=!0,this.cropFrameMask.on("pointerdown",this.handleCropFramePress.bind(this)),this.cropFrame=new PIXI.Sprite,this.cropFrame.interactive=!0,this.cropFrame.addChild(this.cropFrameMask),this.cropFrameContainer.addChild(this.cropFrame),this.croppedSprite.mask=this.cropFrameMask};$e.prototype.initCropGrid=function(){this.cropGrid=new BFN.CropGrid,this.cropFrame.addChild(this.cropGrid)};$e.prototype.initCropHandles=function(){this.cropHandlesGroup=[],this.cropHandles={},this.cropHandleContainer=new PIXI.Container,this.cropFrameContainer.addChild(this.cropHandleContainer),this.cornerHandleIDs=["tl","tr","br","bl"];for(let i=0;i<this.cornerHandleIDs.length;i++){let e=this.cornerHandleIDs[i],t=new BFN.CropHandle(BFN.CropHandleTypes.TYPE_CORNER,i*Math.PI/2,this.handleSize);t.id=e,t.type="corner",t.handlePress=this.handleCropHandlePress.bind(this),t.hoverButtonGroup=this.cropHandlesGroup,this.cropHandles[e]=t,this.cropHandleContainer.addChild(t),this.cropHandlesGroup.push(t)}this.sideHandleIDs=["t","r","b","l"];for(let i=0;i<this.sideHandleIDs.length;i++){let e=this.sideHandleIDs[i],t=new BFN.CropHandle(BFN.CropHandleTypes.TYPE_EDGE,i*Math.PI/2,this.handleSize);t.id=e,t.type="side",t.handlePress=this.handleCropHandlePress.bind(this),t.hoverButtonGroup=this.cropHandlesGroup,this.cropHandles[e]=t,this.cropHandleContainer.addChild(t),this.cropHandlesGroup.push(t)}for(let i in this.cropHandles){let e=this.cropHandles[i];switch(i){case"tl":e.anchorHandle=this.cropHandles.br;break;case"tr":e.anchorHandle=this.cropHandles.bl;break;case"br":e.anchorHandle=this.cropHandles.tl;break;case"bl":e.anchorHandle=this.cropHandles.tr;break;case"t":e.anchorHandle=this.cropHandles.b;break;case"r":e.anchorHandle=this.cropHandles.l;break;case"b":e.anchorHandle=this.cropHandles.t;break;case"l":e.anchorHandle=this.cropHandles.r;break}}};$e.prototype.initDragger=function(){this.dragger=new BFN.Dragger,this.dragger.stickyDrag=!1};$e.prototype.handleCrop=function(){if(BFN.PhotoEditorCanvasModel.viewState==BFN.PhotoEditorCanvasModelViewStates.VIEWING_CROP&&this.sourceTexture&&!this.dragger.dragging){let i=UITools.getToolVO("crop"),e=i.updating_id;if(e=="aspect_ratio"&&this.cropRatios.hasOwnProperty(i.aspect_ratio)){let t=i.aspect_ratio,r=this.cropRatios[t];if(t=="freeform")i.lock_aspect_ratio=!1;else{switch(i.lock_aspect_ratio=!0,t=="original_ratio"&&(r=this.sourceTexture.height/this.sourceTexture.width),i.orientation){case"landscape":this.cropRatio=r<1?r:1/r,this.cropWidth=Math.min(Math.round(this.sourceTexture.width*.9),Math.round(this.sourceTexture.height/this.cropRatio*.9)),this.cropHeight=Math.round(this.cropWidth*this.cropRatio);break;case"portrait":this.cropRatio=r>1?r:1/r,this.cropHeight=Math.min(Math.round(this.sourceTexture.height*.9),Math.round(this.sourceTexture.width*this.cropRatio*.9)),this.cropWidth=Math.round(this.cropHeight/this.cropRatio);break}this.cropFrame.x=this.cropFrame.y=0,this.updateCropHandlePositions()}UITools.setToolValue("crop","crop_width",this.cropWidth),UITools.setToolValue("crop","crop_height",this.cropHeight),UITools.updateToolControls("crop")}if(this.cropRatioLocked=i.lock_aspect_ratio,this.cropRatioLocked)switch(e=="lock_aspect_ratio"&&(this.cropRatio=this.cropHeight/this.cropWidth),e){case"crop_width":this.cropWidth=Math.max(this.minCropSize,this.minCropSize/this.cropRatio,Math.min(this.sourceTexture.width,i.crop_width)),this.cropHeight=Math.min(this.sourceTexture.height,this.cropWidth*this.cropRatio),this.cropWidth=this.cropHeight/this.cropRatio,this.cropWidth=Math.round(this.cropWidth),this.cropHeight=Math.round(this.cropHeight),UITools.setToolValue("crop","crop_width",this.cropWidth),UITools.setToolValue("crop","crop_height",this.cropHeight),UITools.updateToolControls("crop");break;case"crop_height":this.cropHeight=Math.max(this.minCropSize,this.minCropSize*this.cropRatio,Math.min(this.sourceTexture.height,i.crop_height)),this.cropWidth=Math.min(this.sourceTexture.width,this.cropHeight/this.cropRatio),this.cropHeight=this.cropWidth*this.cropRatio,this.cropWidth=Math.round(this.cropWidth),this.cropHeight=Math.round(this.cropHeight),UITools.setToolValue("crop","crop_width",this.cropWidth),UITools.setToolValue("crop","crop_height",this.cropHeight),UITools.updateToolControls("crop");break}else if(e=="lock_aspect_ratio")i.aspect_ratio="freeform",UITools.updateToolControl("crop_aspect_ratio");else switch(this.cropWidth=Math.round(Math.max(this.minCropSize,Math.min(this.sourceTexture.width,i.crop_width))),this.cropHeight=Math.round(Math.max(this.minCropSize,Math.min(this.sourceTexture.height,i.crop_height))),e){case"crop_width":case"crop_height":this.updateOrientation(),UITools.setToolValue("crop","orientation",this.orientation),UITools.updateToolControl("crop_orientation");break}if(e=="orientation"){let t=this.cropHeight/this.cropWidth;switch(i.orientation){case"landscape":this.cropRatio=t<1?t:1/t,this.cropWidth=Math.min(Math.round(this.sourceTexture.width*.9),Math.round(this.sourceTexture.height/this.cropRatio*.9)),this.cropHeight=Math.round(this.cropWidth*this.cropRatio);break;case"portrait":this.cropRatio=t>1?t:1/t,this.cropHeight=Math.min(Math.round(this.sourceTexture.height*.9),Math.round(this.sourceTexture.width*this.cropRatio*.9)),this.cropWidth=Math.round(this.cropHeight/this.cropRatio);break}this.cropFrame.x=this.cropFrame.y=0,this.updateCropHandlePositions(),UITools.setToolValue("crop","crop_width",this.cropWidth),UITools.setToolValue("crop","crop_height",this.cropHeight),UITools.updateToolControls("crop")}this.updateCropFrameCenter(),BFN.MainUI.requestRender()}};$e.prototype.setSourceTexture=function(i){if(this.reset(),i){this.imageContainer.x=Math.floor(-(i.width/2)),this.imageContainer.y=Math.floor(-(i.height/2)),this.cropFrameContainer.x=Math.abs(this.imageContainer.x),this.cropFrameContainer.y=Math.abs(this.imageContainer.y),this.sourceTexture=i,this.uncroppedSprite.texture=this.sourceTexture,this.croppedSprite.texture=this.sourceTexture,this.imageBounds.minX=-(i.width/2),this.imageBounds.minY=-(i.height/2),this.imageBounds.maxX=i.width/2,this.imageBounds.maxY=i.height/2,this.cropWidth=Math.round(this.sourceTexture.width*.9),this.cropHeight=Math.round(this.sourceTexture.height*.9),this.updateCropHandlePositions(),this.updateDraggerBounds();let e=UITools.getParamObject("crop_crop_width");e.min=this.minCropSize,e.max=this.sourceTexture.width;let t=UITools.getParamObject("crop_crop_height");t.min=this.minCropSize,t.max=this.sourceTexture.height,UITools.setToolValue("crop","aspect_ratio","freeform"),this.updateOrientation(),UITools.setToolValue("crop","orientation",this.orientation),UITools.setToolValue("crop","crop_width",this.cropWidth),UITools.setToolValue("crop","crop_height",this.cropHeight),UITools.setToolValue("crop","lock_aspect_ratio",!1),UITools.updateToolControls("crop")}};$e.prototype.updateCropFrameDisplay=function(){this.cropFrameMask.width=this.cropWidth,this.cropFrameMask.height=this.cropHeight,this.cropGrid.setDimensions(this.cropWidth,this.cropHeight)};$e.prototype.updateCropFrameCenter=function(){if(this.currentCropHandle){let i=this.currentCropHandle,e=this.currentCropHandle.anchorHandle;switch(i.id){case"tl":case"l":case"bl":this.cropFrame.x=e.x-this.cropWidth/2;break;case"tr":case"r":case"br":this.cropFrame.x=e.x+this.cropWidth/2}switch(i.id){case"tl":case"t":case"tr":this.cropFrame.y=e.y-this.cropHeight/2;break;case"bl":case"b":case"br":this.cropFrame.y=e.y+this.cropHeight/2}}else this.cropFrame.x=Math.max(-(this.sourceTexture.width/2)+this.cropWidth/2,Math.min(this.sourceTexture.width/2-this.cropWidth/2,this.cropFrame.x)),this.cropFrame.y=Math.max(-(this.sourceTexture.height/2)+this.cropHeight/2,Math.min(this.sourceTexture.height/2-this.cropHeight/2,this.cropFrame.y));this.updateCropHandlePositions()};$e.prototype.updateCropHandlePositions=function(){for(let i in this.cropHandles){let e=this.cropHandles[i];switch(i){case"tl":case"bl":case"l":e.x=this.cropFrame.x-this.cropWidth/2,e.type=="side"&&(e.y=this.cropFrame.y);break;case"tr":case"br":case"r":e.x=this.cropFrame.x+this.cropWidth/2,e.type=="side"&&(e.y=this.cropFrame.y);break}switch(i){case"tl":case"tr":case"t":e.y=this.cropFrame.y-this.cropHeight/2,e.type=="side"&&(e.x=this.cropFrame.x);break;case"bl":case"br":case"b":e.y=this.cropFrame.y+this.cropHeight/2,e.type=="side"&&(e.x=this.cropFrame.x);break}e.x=Math.floor(e.x),e.y=Math.floor(e.y)}this.updateCropHandleVisibility(),this.updateCropFrameDisplay()};$e.prototype.updateCropHandleVisibility=function(){let i=this.cropWidth*this._scale<this.handleSize*4||this.cropHeight*this._scale<this.handleSize*4;for(let e in this.cropHandles){let t=this.cropHandles[e],r=!0;switch(e){case"tl":case"tr":case"br":case"bl":break;case"l":case"r":r=this.cropHeight*this._scale>this.handleSize*2;break;case"t":case"b":r=this.cropWidth*this._scale>this.handleSize*2;break}if(t.visible=r,r){switch(e){case"tl":case"bl":case"l":t.handle.x=i?-this.handleSize:0;break;case"tr":case"br":case"r":t.handle.x=i?this.handleSize:0;break}switch(e){case"tl":case"tr":case"t":t.handle.y=i?-this.handleSize:0;break;case"bl":case"br":case"b":t.handle.y=i?this.handleSize:0;break}}}};$e.prototype.updateCropHandleScales=function(){let i=1/this._scale;for(let e in this.cropHandles){let t=this.cropHandles[e];t.scale.x=t.scale.y=i}};$e.prototype.updateDraggerBounds=function(){let i=this.sourceTexture.width/2-this.cropWidth/2,e=this.sourceTexture.height/2-this.cropHeight/2;this.dragger.setBounds(-i,-e,i,e)};$e.prototype.updateOrientation=function(){this.orientation=this.cropHeight/this.cropWidth<1?"landscape":"portrait"};$e.prototype.setSmoothingScale=function(i){this.uncroppedSprite.currentScale=i,this.croppedSprite.currentScale=i};$e.prototype.reset=function(){this.sourceTexture!=null&&(this.sourceTexture=null,this.uncroppedSprite.texture=PIXI.Texture.EMPTY,this.croppedSprite.texture=PIXI.Texture.EMPTY),this.cropFrame.x=this.cropFrame.y=0};$e.prototype.handleCropFramePress=function(i){BFN.ImageCrop.sourceTexture&&(this.updateDraggerBounds(),this.dragger.addEventListener(BFN.DraggerEvents.DRAGGING.type,this.handleCropFrameDraggingBind),this.dragger.addEventListener(BFN.DraggerEvents.DRAGGING_COMPLETE.type,this.handleCropFrameDraggingCompleteBind),this.dragger.drag(this.cropFrame))};$e.prototype.handleCropFrameDragging=function(i){this.updateCropHandlePositions()};$e.prototype.handleCropFrameDraggingComplete=function(i){this.dragger.removeEventListener(BFN.DraggerEvents.DRAGGING.type,this.handleCropFrameDraggingBind),this.dragger.removeEventListener(BFN.DraggerEvents.DRAGGING_COMPLETE.type,this.handleCropFrameDraggingCompleteBind)};$e.prototype.handleCropHandlePress=function(i){if(this.sourceTexture){this.currentCropHandle=this.cropHandles[i.currentTarget.id],this.dragger.setBounds(this.imageBounds.minX,this.imageBounds.minY,this.imageBounds.maxX,this.imageBounds.maxY),this.dragger.addEventListener(BFN.DraggerEvents.DRAGGING.type,this.handleCropHandleDraggingBind),this.dragger.addEventListener(BFN.DraggerEvents.DRAGGING_COMPLETE.type,this.handleCropHandleDraggingCompleteBind);let e=this.currentCropHandle,t=this.currentCropHandle.anchorHandle;this.cropRatio=this.cropHeight/this.cropWidth;let r=Math.max(this.minCropSize,this.minCropSize/(this.cropRatioLocked?this.cropRatio:1)),a=Math.max(this.minCropSize,this.minCropSize*(this.cropRatioLocked?this.cropRatio:1));switch(e.id){case"tl":case"l":case"bl":this.dragger.bounds.maxX=t.x-r;break;case"tr":case"r":case"br":this.dragger.bounds.minX=t.x+r;break}switch(e.id){case"tl":case"t":case"tr":this.dragger.bounds.maxY=t.y-a;break;case"bl":case"b":case"br":this.dragger.bounds.minY=t.y+a;break}switch(e.id){case"l":case"r":this.dragger.bounds.minY=this.dragger.bounds.maxY=e.y;break;case"t":case"b":this.dragger.bounds.minX=this.dragger.bounds.maxX=e.x;break}this.dragger.drag(this.currentCropHandle),BFN.TooltipScreen.show("W: "+this.cropWidth+", H: "+this.cropHeight,!0,!0),BFN.TooltipScreen.setPosition(BeFunky.globalPointerCoords.x,BeFunky.globalPointerCoords.y,{onCanvas:!0})}};$e.prototype.handleCropHandleDragging=function(i){let e=this.currentCropHandle,t=this.currentCropHandle.anchorHandle,r=Math.abs(t.x-e.x)||this.cropWidth,a=Math.abs(t.y-e.y)||this.cropHeight;if(this.cropRatioLocked)if(e.type=="corner"){let s=r*(r*this.cropRatio),o=a*(a/this.cropRatio);switch(s<o?r=a/this.cropRatio:a=r*this.cropRatio,e.id){case"tl":case"bl":t.x-r<this.dragger.bounds.minX&&(r=t.x-this.dragger.bounds.minX,a=r*this.cropRatio);break;case"tr":case"br":t.x+r>this.dragger.bounds.maxX&&(r=this.dragger.bounds.maxX-t.x,a=r*this.cropRatio);break}switch(e.id){case"tl":case"tr":t.y-a<this.dragger.bounds.minY&&(a=t.y-this.dragger.bounds.minY,r=a/this.cropRatio);break;case"bl":case"br":t.y+a>this.dragger.bounds.maxY&&(a=this.dragger.bounds.maxY-t.y,r=a/this.cropRatio);break}}else switch(e.id){case"l":case"r":a=r*this.cropRatio,this.cropFrame.y-a/2<this.imageBounds.minY&&(a=(this.cropFrame.y-this.imageBounds.minY)*2),this.cropFrame.y+a/2>this.imageBounds.maxY&&(a=(this.imageBounds.maxY-this.cropFrame.y)*2),r=a/this.cropRatio;break;case"t":case"b":r=a/this.cropRatio,this.cropFrame.x-r/2<this.imageBounds.minX&&(r=(this.cropFrame.x-this.imageBounds.minX)*2),this.cropFrame.x+r/2>this.imageBounds.maxX&&(r=(this.imageBounds.maxX-this.cropFrame.x)*2),a=r*this.cropRatio;break}this.cropWidth=Math.floor(r),this.cropHeight=Math.floor(a),this.updateCropFrameCenter(),this.updateOrientation(),UITools.setToolValue("crop","orientation",this.orientation),UITools.setToolValue("crop","crop_width",this.cropWidth),UITools.setToolValue("crop","crop_height",this.cropHeight),UITools.updateToolControls("crop"),BFN.TooltipScreen.setMessage("W: "+this.cropWidth+", H: "+this.cropHeight)};$e.prototype.handleCropHandleDraggingComplete=function(i){this.dragger.removeEventListener(BFN.DraggerEvents.DRAGGING.type,this.handleCropHandleDraggingBind),this.dragger.removeEventListener(BFN.DraggerEvents.DRAGGING_COMPLETE.type,this.handleCropHandleDraggingCompleteBind),this.currentCropHandle=null,BFN.TooltipScreen.hide()};Object.defineProperty($e.prototype,"toolScale",{set:function(i){this._scale=i,this.dragger.scale=this._scale,this.cropGrid.scale=this._scale,this.updateCropHandleVisibility(),this.updateCropHandleScales(),this.setSmoothingScale(this._scale)},get:function(){return this._scale}});Object.defineProperty($e.prototype,"modifiedTexture",{get:function(){let i=PIXI.RenderTexture.create(Math.round(this.cropWidth),Math.round(this.cropHeight)),e=Math.max(-(this.sourceTexture.width-i.width),Math.min(0,-(this.cropHandles.tl.x+this.cropFrameContainer.x))),t=Math.max(-(this.sourceTexture.height-i.height),Math.min(0,-(this.cropHandles.tl.y+this.cropFrameContainer.y)));return i.copyPixels(this.sourceTexture,new PIXI.Point(e,t)),i}});Object.defineProperty($e.prototype,"cropOffsetLeft",{get:function(){return-((this.cropHandles.l.x+this.cropHandles.r.x)/2)}});Object.defineProperty($e.prototype,"cropOffsetTop",{get:function(){return-((this.cropHandles.t.y+this.cropHandles.b.y)/2)}});Object.defineProperty($e.prototype,"cropRect",{get:function(){return new BFN.Rectangle(Math.round(this.cropHandles.l.x-this.imageBounds.minX),Math.round(this.cropHandles.t.y-this.imageBounds.minY),Math.round(this.cropWidth),Math.round(this.cropHeight))}});Object.defineProperty(BFN,"ImageCrop",{get:function(){return BFN._ImageCrop||(BFN._ImageCrop=new $e),BFN._ImageCrop}});function Di(){PIXI.Sprite.call(this),this.init()}Di.prototype=Object.create(PIXI.Sprite.prototype);Di.prototype.init=function(){BeFunky.log("ImagePaintBrush Init"),this.initDefaultValues(),this.initImageContainer(),this.initSourceSprite(),this.initPainter()};Di.prototype.initDefaultValues=function(){this._scale=1,this.sourceTexture=null};Di.prototype.initImageContainer=function(){this.imageContainer=new PIXI.Sprite,this.addChild(this.imageContainer)};Di.prototype.initSourceSprite=function(){this.sourceSprite=new PIXI.Sprite,this.sourceSprite.pluginName="smooth_picture",this.imageContainer.addChild(this.sourceSprite)};Di.prototype.initPainter=function(){this.painter=new BFN.ImagePainter,this.painter.pluginName="blend_picture",this.painter.blendMode=BFN.CONST.BLEND_MODES.NORMAL,this.painter.lowerResolutionForLargeImages=!1,this.painter.minHistoryResolution=1,this.imageContainer.addChild(this.painter)};Di.prototype.handlePaintBrush=function(){BFN.PhotoEditorCanvasModel.viewState==BFN.PhotoEditorCanvasModelViewStates.VIEWING_PAINT_BRUSH&&this.updatePaintBrushParameters()};Di.prototype.setSourceTexture=function(i){this.sourceTexture!=null&&(this.sourceTexture=null,this.sourceSprite.texture=PIXI.Texture.EMPTY),i!=null?(this.sourceTexture=i,this.sourceSprite.texture=this.sourceTexture,this.imageContainer.x=-Math.round(this.sourceTexture.width/2),this.imageContainer.y=-Math.round(this.sourceTexture.height/2),this.painter.setup(this.sourceTexture.width,this.sourceTexture.height),UITools.setToolValue("paint_brush","erase",!1),UITools.updateToolControls("paint_brush"),this.updatePaintBrushParameters()):this.painter.reset()};Di.prototype.updatePaintBrushParameters=function(){let i=UITools.getToolVO("paint_brush");if(i){this.painter.blendMode!=i.blend_mode&&(this.painter.blendMode=i.blend_mode),this.painter.alpha!=i.opacity&&(this.painter.alpha=i.opacity),i.clear&&(this.painter.clear(!0),UITools.setToolValue("paint_brush","erase",!1),UITools.updateToolControl("paint_brush_erase")),this.painter.eraseMode!=i.erase&&(this.painter.eraseMode=i.erase),i.updating&&i.updating_id=="size"&&this.painter.brushSizeFactor!=i.size/100&&(this.painter.brushSizeFactor=i.size/100);let e=!1;!i.updating&&(i.updating_id=="size"||this.painter.brushSizeFactor!=i.size/100)&&(this.painter.brushSizeFactor=i.size/100,e=!0),!i.updating&&(i.updating_id=="hardness"||this.painter.brushHardnessFactor!=i.hardness/100)&&(this.painter.brushHardnessFactor=i.hardness/100,e=!0),!i.updating&&(i.updating_id=="strength"||this.painter.brushStrengthFactor!=i.strength/100)&&(this.painter.brushStrengthFactor=i.strength/100,e=!0),!i.updating&&(i.updating_id=="color"||this.painter.brushColor!="0x"+i.color)&&(this.painter.brushColor="0x"+i.color,e=!0),e&&this.painter.updateBrush()}};Di.prototype.setSmoothingScale=function(i){this.sourceSprite.currentScale=i,this.painter.currentScale=i};Object.defineProperty(Di.prototype,"toolScale",{set:function(i){this._scale=i,this.painter.toolScale=this._scale,this.setSmoothingScale(this._scale)},get:function(){return this._scale}});Object.defineProperty(Di.prototype,"modifiedTexture",{get:function(){if(this.sourceTexture){let i=PIXI.RenderTexture.create(this.sourceTexture.width,this.sourceTexture.height);return this.imageContainer.x=this.imageContainer.y=0,this.setSmoothingScale(1),this.removeChild(this.imageContainer),BFN.Stage.render(this.imageContainer,i),this.imageContainer.x=-Math.round(this.sourceTexture.width/2),this.imageContainer.y=-Math.round(this.sourceTexture.height/2),this.setSmoothingScale(this._scale),this.addChild(this.imageContainer),i}return null}});Object.defineProperty(BFN,"ImagePaintBrush",{get:function(){return BFN._ImagePaintBrush||(BFN._ImagePaintBrush=new Di),BFN._ImagePaintBrush}});function mt(){PIXI.Sprite.call(this),this.init()}mt.prototype=Object.create(PIXI.Sprite.prototype);mt.prototype.init=function(){BeFunky.log("ImageClone Init"),this.initDefaultValues(),this.initImageContainer(),this.initSourceSprite(),this.initCloneSprite(),this.initPainter(),this.initTargetSprite(),this.initDestinationSprite()};mt.prototype.initDefaultValues=function(){this._scale=1,this.originalTexture=null,this.sourceTexture=null,this.mouseDown=!1,this.waiting=!1,this.targetSet=!1,this.cloneOffsetPoint=null,this.erasing=!1,this.ctrlKeyCodes=[17,91,93],this.ctrlKeyCode=null,this.ctrlKeyDown=!1,this.handlePainterMouseDownBind=this.handlePainterMouseDown.bind(this),this.handlePainterMouseMoveBind=this.handlePainterMouseMove.bind(this),this.handlePainterMouseOverBind=this.handlePainterMouseOver.bind(this),this.handlePainterMouseOutBind=this.handlePainterMouseOut.bind(this),this.handlePainterKeyDownBind=this.handlePainterKeyDown.bind(this),this.handlePainterKeyUpBind=this.handlePainterKeyUp.bind(this),this.handleBrushCircleAnimatorUpdateBind=this.handleBrushCircleAnimatorUpdate.bind(this)};mt.prototype.initImageContainer=function(){this.imageContainer=new PIXI.Sprite,this.addChild(this.imageContainer)};mt.prototype.initSourceSprite=function(){this.sourceSprite=new PIXI.Sprite,this.sourceSprite.pluginName="smooth_picture",this.imageContainer.addChild(this.sourceSprite)};mt.prototype.initCloneSprite=function(){this.cloneContainer=new PIXI.Container,this.imageContainer.addChild(this.cloneContainer),this.cloneSprite=new PIXI.Sprite,this.cloneSprite.pluginName="smooth_picture",this.cloneContainer.addChild(this.cloneSprite)};mt.prototype.initPainter=function(){this.painter=new BFN.ImagePainter,this.painter.pluginName="smooth_picture",this.painter.allowBrushCircle=!0,this.painter.dispatchPainterPressedEvent=!0,this.painter.minHistoryResolution=1,this.painter.addEventListener(BFN.ImagePainterEvents.PAINT_UPDATED_PRE_HISTORY.type,this.handlePaintUpdatedPreHistory.bind(this)),this.cloneContainer.addChild(this.painter),this.cloneSprite.mask=this.painter};mt.prototype.initTargetSprite=function(){let i=10,e=2,t=.5,r=Math.round((i+e/2+t)*2);this.targetTexture=PIXI.RenderTexture.create(r,r,PIXI.settings.SCALE_MODE,window.bfn_resolution);let a,s;a=e+t*2,s=r/2-e/2-t-1,BFN.graphics.drawShape("roundedRect",this.targetTexture,{fillColor:2147483648,paddingX:a,paddingY:s,clear:!0}),BFN.graphics.drawShape("roundedRect",this.targetTexture,{fillColor:2147483648,paddingX:s,paddingY:a,clear:!1}),BFN.graphics.drawShape("ellipse",this.targetTexture,{strokeWidth:e+t*2,strokeColor:2147483648,clear:!1}),a=e+t,s=r/2-e/2-1,BFN.graphics.drawShape("roundedRect",this.targetTexture,{fillColor:4294967295,paddingX:a,paddingY:s,clear:!1}),BFN.graphics.drawShape("roundedRect",this.targetTexture,{fillColor:4294967295,paddingX:s,paddingY:a,clear:!1}),BFN.graphics.drawShape("ellipse",this.targetTexture,{strokeWidth:e,strokeColor:4294967295,paddingX:t,paddingY:t,clear:!1}),this.target=new PIXI.Container,this.target.interactive=!1,this.addChild(this.target),this.targetSprite=new PIXI.Sprite(this.targetTexture),this.targetSprite.interactive=!1,this.targetSprite.hitArea=new PIXI.Rectangle(0,0,0,0),this.targetSprite.anchor.x=this.targetSprite.anchor.y=.5,this.target.addChild(this.targetSprite)};mt.prototype.initDestinationSprite=function(){let i=10,e=2,t=.5,r=Math.round((i+e/2+t)*2);this.destinationTexture=PIXI.RenderTexture.create(r,r,PIXI.settings.SCALE_MODE,window.bfn_resolution);let a,s;a=0,s=r/2-e/2-t-1,BFN.graphics.drawShape("roundedRect",this.destinationTexture,{fillColor:2147483648,paddingX:a,paddingY:s,clear:!0}),BFN.graphics.drawShape("roundedRect",this.destinationTexture,{fillColor:2147483648,paddingX:s,paddingY:a,clear:!1}),a=0,s=r/2-e/2-1,BFN.graphics.drawShape("roundedRect",this.destinationTexture,{fillColor:4294967295,paddingX:a,paddingY:s,clear:!1}),BFN.graphics.drawShape("roundedRect",this.destinationTexture,{fillColor:4294967295,paddingX:s,paddingY:a,clear:!1}),this.destination=new PIXI.Container,this.destination.interactive=!1,this.addChild(this.destination),this.destinationSprite=new PIXI.Sprite(this.destinationTexture),this.destinationSprite.interactive=!1,this.destinationSprite.hitArea=new PIXI.Rectangle(0,0,0,0),this.destinationSprite.anchor.x=this.destinationSprite.anchor.y=.5,this.destination.addChild(this.destinationSprite)};mt.prototype.handleClone=function(){BFN.PhotoEditorCanvasModel.viewState==BFN.PhotoEditorCanvasModelViewStates.VIEWING_CLONE&&this.updateCloneParameters()};mt.prototype.setSourceTexture=function(i){this.originalTexture=null,this.sourceTexture!=null&&(this.sourceTexture.destroyGC(!0),this.sourceTexture=null,this.sourceSprite.texture=PIXI.Texture.EMPTY),i!=null?(this.originalTexture=i,this.sourceTexture=PIXI.RenderTexture.create(i.width,i.height),this.sourceTexture.copyPixels(i),this.sourceSprite.texture=this.sourceTexture,this.cloneSprite.texture=this.sourceTexture,this.painter.altTexture=this.sourceTexture,this.imageContainer.x=-Math.round(this.sourceTexture.width/2),this.imageContainer.y=-Math.round(this.sourceTexture.height/2),this.painter.setup(this.sourceTexture.width,this.sourceTexture.height),this.updateCloneParameters(),this.resetTarget(),this.painter.addEventListener(BFN.ImagePainterEvents.PAINTER_PRESSED.type,this.handlePainterMouseDownBind),BFN.MainUI.on("pointermove",this.handlePainterMouseMoveBind),this.painter.on("pointerover",this.handlePainterMouseOverBind),this.painter.on("pointerout",this.handlePainterMouseOutBind),BFN.BrushCircle.animator.addEventListener(BFN.AnimatorEvents.UPDATE.type,this.handleBrushCircleAnimatorUpdateBind)):(this.painter.reset(),BFN.BrushCircle.targetEnabled=!1,UITools.setToolValue("clone","brush_erase",!1),UITools.updateToolControl("clone_brush_erase"),this.painter.removeEventListener(BFN.ImagePainterEvents.PAINTER_PRESSED.type,this.handlePainterMouseDownBind),BFN.MainUI.off("pointermove",this.handlePainterMouseMoveBind),this.painter.off("pointerover",this.handlePainterMouseOverBind),this.painter.off("pointerout",this.handlePainterMouseOutBind),this.handlePainterMouseOutBind(),BFN.BrushCircle.animator.removeEventListener(BFN.AnimatorEvents.UPDATE.type,this.handleBrushCircleAnimatorUpdateBind))};mt.prototype.resetTarget=function(){this.targetSet=!1,this.targetSprite.visible=!1,this.destinationSprite.visible=!1,this.cloneOffsetPoint=null,this.cloneSprite.x=this.cloneSprite.y=0,BFN.BrushCircle.targetEnabled=!0,this.painter.paintingEnabled=!1,BFN.MainUI.requestRender()};mt.prototype.updateCloneParameters=function(){let i=UITools.getToolVO("clone");if(i){i.target_reset&&this.resetTarget(),i.brush_clear&&(this.painter.clear(!0),this.sourceTexture.copyPixels(this.originalTexture),UITools.setToolValue("clone","brush_erase",!1),UITools.updateToolControl("clone_brush_erase")),this.erasing!=i.brush_erase&&(this.erasing=i.brush_erase,BFN.BrushCircle.targetEnabled=!this.targetSet&&!this.erasing,this.cloneSprite.x=this.cloneSprite.y=0,this.erasing?this.cloneSprite.texture=this.originalTexture:(this.cloneSprite.texture=this.sourceTexture,this.cloneOffsetPoint&&(this.cloneSprite.x=-Math.round(this.cloneOffsetPoint.x),this.cloneSprite.y=-Math.round(this.cloneOffsetPoint.y)))),i.updating&&i.updating_id=="brush_size"&&this.painter.brushSizeFactor!=i.brush_size/100&&(this.painter.brushSizeFactor=i.brush_size/100);let e=!1;!i.updating&&(i.updating_id=="brush_size"||this.painter.brushSizeFactor!=i.brush_size/100)&&(this.painter.brushSizeFactor=i.brush_size/100,e=!0),!i.updating&&(i.updating_id=="brush_hardness"||this.painter.brushSizeFactor!=i.brush_hardness/100)&&(this.painter.brushHardnessFactor=i.brush_hardness/100,e=!0),!i.updating&&(i.updating_id=="brush_strength"||this.painter.brushOpacityFactor!=i.brush_strength/100)&&(this.painter.brushOpacityFactor=i.brush_strength/100,e=!0),e&&this.painter.updateBrush()}};mt.prototype.setSmoothingScale=function(i){this.sourceSprite.currentScale=i,this.cloneSprite.currentScale=i,this.painter.currentScale=i};mt.prototype.handlePainterMouseDown=function(i){if(i=i.data.pointerEvent,!this.erasing){let e=this.painter.getPointerPosition(i);!this.targetSet||this.ctrlKeyDown?(this.ctrlKeyDown&&this.resetTarget(),this.targetSet=!0,this.targetSprite.visible=!0,this.destinationSprite.visible=!0,this.target.x=e.x+this.imageContainer.x,this.target.y=e.y+this.imageContainer.y,this.target.alpha=1,this.target.visible=!0,BFN.BrushCircle.targetEnabled=!1,this.painter.paintingEnabled=!0,i.data.originalEvent.stopImmediatePropagation()):this.cloneOffsetPoint||(this.cloneOffsetPoint=new PIXI.Point(this.target.x-this.imageContainer.x-e.x,this.target.y-this.imageContainer.y-e.y),this.cloneSprite.x=-Math.round(this.cloneOffsetPoint.x),this.cloneSprite.y=-Math.round(this.cloneOffsetPoint.y)),this.cloneOffsetPoint&&(this.target.x=e.x+this.imageContainer.x+this.cloneOffsetPoint.x,this.target.y=e.y+this.imageContainer.y+this.cloneOffsetPoint.y,this.destination.x=e.x+this.imageContainer.x,this.destination.y=e.y+this.imageContainer.y),BFN.MainUI.requestRender()}};mt.prototype.handlePainterMouseMove=function(i){if(this.mouseDown&&!this.painter.mouseDown&&!this.waiting){this.mouseDown=!1,this.waiting=!0,setTimeout(function(){this.waiting=!1}.bind(this),50);return}if(this.waiting)return;this.mouseDown=this.painter.mouseDown;let e=this.painter.getPointerPosition(i);this.cloneOffsetPoint&&(this.target.x=e.x+this.imageContainer.x+this.cloneOffsetPoint.x,this.target.y=e.y+this.imageContainer.y+this.cloneOffsetPoint.y),this.destination.x=e.x+this.imageContainer.x,this.destination.y=e.y+this.imageContainer.y};mt.prototype.handlePainterMouseOver=function(i){document.addEventListener("keydown",this.handlePainterKeyDownBind,!1)};mt.prototype.handlePainterMouseOut=function(i){document.removeEventListener("keydown",this.handlePainterKeyDownBind)};mt.prototype.handlePainterKeyDown=function(i){this.targetSet&&!this.erasing&&!this.ctrlKeyDown&&this.ctrlKeyCodes.indexOf(i.keyCode)!=-1&&(this.targetSprite.visible=!1,this.destinationSprite.visible=!1,BFN.MainUI.requestRender(),BFN.BrushCircle.targetEnabled=!0,this.ctrlKeyDown=!0,this.ctrlKeyCode=i.keyCode,document.addEventListener("keyup",this.handlePainterKeyUpBind,!1))};mt.prototype.handlePainterKeyUp=function(i){this.ctrlKeyDown&&this.ctrlKeyCode==i.keyCode&&(this.targetSet&&(this.targetSprite.visible=!0,this.destinationSprite.visible=!0,BFN.MainUI.requestRender()),BFN.BrushCircle.targetEnabled=!1,this.ctrlKeyDown=!1,this.ctrlKeyCode=null,document.removeEventListener("keyup",this.handlePainterKeyUpBind))};mt.prototype.handleBrushCircleAnimatorUpdate=function(i){this.target.alpha=this.destination.alpha=BFN.BrushCircle.animator.animationFactor,this.target.visible=this.destination.visible=this.target.alpha>0&&!this.erasing,this.targetSet&&!this.cloneOffsetPoint&&(this.target.alpha=1,this.target.visible=!0)};mt.prototype.handlePaintUpdatedPreHistory=function(i){this.setSmoothingScale(1),BFN.Stage.render(this.cloneContainer,this.sourceTexture,!1),this.setSmoothingScale(this._scale),this.painter.clear(!1)};Object.defineProperty(mt.prototype,"toolScale",{set:function(i){this._scale=i,this.painter.toolScale=this._scale,this.target.scale.x=this.target.scale.y=1/this._scale,this.destination.scale.x=this.destination.scale.y=1/this._scale,this.setSmoothingScale(this._scale)},get:function(){return this._scale}});Object.defineProperty(mt.prototype,"modifiedTexture",{get:function(){if(this.sourceTexture){let i=PIXI.RenderTexture.create(this.sourceTexture.width,this.sourceTexture.height);return this.imageContainer.x=this.imageContainer.y=0,this.setSmoothingScale(1),BFN.Stage.render(this.imageContainer,i),this.imageContainer.x=-Math.round(this.sourceTexture.width/2),this.imageContainer.y=-Math.round(this.sourceTexture.height/2),this.setSmoothingScale(this._scale),i}return null}});Object.defineProperty(BFN,"ImageClone",{get:function(){return BFN._ImageClone||(BFN._ImageClone=new mt),BFN._ImageClone}});function Ct(){PIXI.Sprite.call(this),this.init()}Ct.prototype=Object.create(PIXI.Sprite.prototype);Ct.prototype.init=function(){BeFunky.log("ImageBlemish Init"),this.initDefaultValues(),this.initImageContainer(),this.initSourceSprite(),this.initResultSprite(),this.initPainter()};Ct.prototype.initDefaultValues=function(){this._scale=1,this.sourceTexture=null,this.resultTexture=null,this.erasing=!1,this.replaceFilter=new BFN.filters.ReplaceFilter,this.alphaFilter=new BFN.filters.BlendModeFilter(BFN.CONST.BLEND_MODES.ALPHA),this.blendModeSprite=new BFN.BlendModeSprite(!1),this.eraseSprite=new PIXI.Sprite,this.handleAltBitmapDataUpdatedBind=this.handleAltBitmapDataUpdated.bind(this)};Ct.prototype.initImageContainer=function(){this.imageContainer=new PIXI.Sprite,this.addChild(this.imageContainer)};Ct.prototype.initSourceSprite=function(){this.sourceSprite=new PIXI.Sprite};Ct.prototype.initResultSprite=function(){this.resultSprite=new PIXI.Sprite,this.imageContainer.addChild(this.resultSprite)};Ct.prototype.initPainter=function(){this.painter=new BFN.ImagePainter,this.painter.brushEnabled=!1,this.painter.minHistoryResolution=1,this.painter.addEventListener(BFN.ImagePainterEvents.BRUSH_APPLIED.type,this.handleBrushApplied.bind(this)),this.imageContainer.addChild(this.painter)};Ct.prototype.handleBlemish=function(){if(BFN.PhotoEditorCanvasModel.viewState==BFN.PhotoEditorCanvasModelViewStates.VIEWING_BLEMISH_FIX){let i=UITools.getToolVO("blemish_fix");if(i){i.brush_clear&&(this.painter.clear(!0),this.resultTexture.copyPixels(this.sourceTexture),UITools.setToolValue("blemish_fix","brush_erase",!1),UITools.updateToolControl("blemish_fix_brush_erase")),this.erasing=i.brush_erase,this.painter.singleClick==this.erasing&&(this.painter.singleClick=!this.erasing);let e=i.brush_size/100*.2+.1,t=i.brush_size/100*.08+.02;i.updating&&i.updating_id=="brush_size"&&this.painter.brushSizeFactor!=e&&(this.painter.brushSizeFactor=e);let r=!1;!i.updating&&(i.updating_id=="brush_size"||this.painter.brushSizeFactor!=e)&&(this.painter.brushSizeFactor=e,r=!0),!i.updating&&(i.updating_id=="brush_hardness"||this.painter.brushHardnessFactor!=t)&&(this.painter.brushHardnessFactor=i.brush_hardness/100,r=!0),r&&this.painter.updateBrush()}}};Ct.prototype.reset=function(){this.sourceTexture!=null&&(this.sourceTexture=null),this.sourceSprite.texture=PIXI.Texture.EMPTY;try{this.resultTexture.destroyGC(!0)}catch(i){}this.resultTexture=null,this.resultSprite.texture=PIXI.Texture.EMPTY,this.painter.altTexture=null,BFN.ImagePainterUndoManager.removeEventListener(BFN.ImagePainterUndoManagerEvents.ALT_TEXTURE_UPDATED.type,this.handleAltBitmapDataUpdatedBind)};Ct.prototype.setSourceTexture=function(i){this.reset(),i?(this.imageContainer.x=-Math.round(i.width/2),this.imageContainer.y=-Math.round(i.height/2),this.sourceTexture=i,this.resultTexture=i.renderClone(),this.sourceSprite.texture=this.sourceTexture,this.resultSprite.texture=this.resultTexture,this.painter.altTexture=this.resultTexture,BFN.ImagePainterUndoManager.addEventListener(BFN.ImagePainterUndoManagerEvents.ALT_TEXTURE_UPDATED.type,this.handleAltBitmapDataUpdatedBind),UITools.setToolValue("blemish_fix","brush_erase",!1),UITools.setToolValue("blemish_fix","brush_size",50),UITools.setToolValue("blemish_fix","brush_hardness",40),UITools.updateToolControls("blemish_fix")):(this.imageContainer.x=0,this.imageContainer.y=0),this.updatePainter()};Ct.prototype.updatePainter=function(){this.sourceTexture?(this.painter.painterWidth!=this.sourceTexture.width||this.painter.painterHeight!=this.sourceTexture.height)&&this.painter.setup(this.sourceTexture.width,this.sourceTexture.height):this.painter.reset()};Ct.prototype.removeBlemish=function(){if(this.resultTexture){let i=new PIXI.Rectangle(this.painter.brushRect.x,this.painter.brushRect.y,this.painter.brushRect.width,this.painter.brushRect.height),e=PIXI.RenderTexture.create(i.width,i.height);e.copyPixels(this.resultTexture,new PIXI.Point(-i.x,-i.y)),this.replaceDarksWithAverage(e);let t=BFN.Util.getTextureAverageColor(e,!0),r=this.getColorBrightness(t),a=[],s=PIXI.RenderTexture.create(i.width,i.height),o=[];for(let u=0;u<8;u++){let d=0,m=0;switch(u){case 0:case 1:case 7:d=-Math.floor(i.width/2);break;case 3:case 4:case 5:d=Math.floor(i.width/2);break}switch(u){case 1:case 2:case 3:m=-Math.floor(i.height/2);break;case 5:case 6:case 7:d=Math.floor(i.height/2);break}let p=new PIXI.Rectangle(i.x+d,i.y+m,i.width,i.height);s.copyPixels(this.resultTexture,new PIXI.Point(-p.x,-p.y));let g=this.getColorBrightness(BFN.Util.getTextureAverageColor(s,!0));a.push(p),o.push(g)}let n=0,l=1;for(let u=0;u<o.length;u++){let d=o[u],m=Math.abs(r-d);m<l&&(n=u,l=m)}let c=a[n];s.copyPixels(this.resultTexture,new PIXI.Point(-c.x,-c.y)),a.splice(0),o.splice(0);let h=e.renderClone();this.blendModeSprite.setBaseTexture(h),this.blendModeSprite.setBlendTexture(s),this.blendModeSprite.setBlendMode(BFN.CONST.BLEND_MODES.LIGHTEN),this.blendModeSprite.renderDisplay(),this.alphaFilter.intensity=1,this.alphaFilter.iChannel1=this.painter.brush.texture,this.blendModeSprite.filters=[this.alphaFilter],BFN.Stage.render(this.blendModeSprite,e),h.destroyGC(!0),this.resultTexture.copyPixels(e,new PIXI.Point(i.x,i.y),!1),e.destroyGC(!0),s.destroyGC(!0)}BFN.MainUI.requestRender()};Ct.prototype.erase=function(){if(this.sourceTexture&&this.resultTexture){let i=new PIXI.Rectangle(this.painter.brushRect.x,this.painter.brushRect.y,this.painter.brushRect.width,this.painter.brushRect.height),e=PIXI.RenderTexture.create(i.width,i.height);e.copyPixels(this.sourceTexture,new PIXI.Point(-i.x,-i.y));let t=e.renderClone();this.eraseSprite.texture=t,this.alphaFilter.intensity=1,this.alphaFilter.iChannel1=this.painter.brush.texture,this.eraseSprite.filters=[this.alphaFilter],BFN.Stage.render(this.eraseSprite,e),t.destroyGC(!0),this.resultTexture.copyPixels(e,new PIXI.Point(i.x,i.y),!1),e.destroyGC(!0),this.eraseSprite.texture=PIXI.Texture.EMPTY}BFN.MainUI.requestRender()};Ct.prototype.replaceDarksWithAverage=function(i){this.replaceFilter.mode="darks";let e=BFN.Util.getTextureAverageColor(i,!0);this.replaceFilter.color=e;let t=i.renderClone(),r=new PIXI.Sprite(t);r.filters=[this.replaceFilter],BFN.Stage.render(r,i),t.destroyGC(!0),r.filters=[],r.destroy(!0)};Ct.prototype.getColorBrightness=function(i){let e=this.hexToRGB(i);return Math.sqrt(e[0]*e[0]*.241+e[1]*e[1]*.691+e[2]*e[2]*.068)/255};Ct.prototype.hexToRGB=function(i){let e=i>>16&255,t=i>>8&255,r=i&255;return[e,t,r]};Ct.prototype.handleBrushApplied=function(i){this.erasing?this.erase():this.removeBlemish()};Ct.prototype.handleAltBitmapDataUpdated=function(i){};Object.defineProperty(Ct.prototype,"toolScale",{set:function(i){this._scale=i,this.painter.toolScale=this._scale},get:function(){return this._scale}});Object.defineProperty(Ct.prototype,"modifiedTexture",{get:function(){if(this.sourceTexture){let i=PIXI.RenderTexture.create(this.sourceTexture.width,this.sourceTexture.height);return this.imageContainer.x=this.imageContainer.y=0,BFN.Stage.render(this.imageContainer,i),this.imageContainer.x=-Math.round(this.sourceTexture.width/2),this.imageContainer.y=-Math.round(this.sourceTexture.height/2),i}return null}});Object.defineProperty(BFN,"ImageBlemish",{get:function(){return BFN._ImageBlemish||(BFN._ImageBlemish=new Ct),BFN._ImageBlemish}});function St(){PIXI.Sprite.call(this),this.init()}St.prototype=Object.create(PIXI.Sprite.prototype);St.prototype.init=function(){BeFunky.log("ImageBackground Init"),this.initDefaultValues(),this.initImageContainer(),this.initSourceSprite(),this.initMaskBlendSprite(),this.initMaskSprite(),this.initPainter()};St.prototype.initDefaultValues=function(){this._scale=1,this.sourceTexture=null,this.transparent=!0};St.prototype.initImageContainer=function(){this.imageContainer=new PIXI.Sprite,this.addChild(this.imageContainer)};St.prototype.initSourceSprite=function(){this.sourceSprite=new PIXI.Sprite,this.sourceSprite.pluginName="smooth_picture",this.imageContainer.addChild(this.sourceSprite)};St.prototype.initMaskBlendSprite=function(){this.maskBlendSprite=new BFN.MaskBlendSprite,this.maskBlendSprite.pluginName="smooth_picture",this.maskBlendSprite.useInputAlpha=!0,this.imageContainer.addChild(this.maskBlendSprite)};St.prototype.initMaskSprite=function(){this.maskSprite=new PIXI.Sprite(PIXI.RenderTexture.create(200,200)),this.maskSprite.texture.fillColor(16711680,.5),this.maskSprite.interactive=!1,this.imageContainer.addChild(this.maskSprite)};St.prototype.initPainter=function(){this.painter=new BFN.ImagePainter,this.painter.pluginName="smooth_picture",this.imageContainer.addChild(this.painter),BFN.ImagePainterUndoManager.addEventListener(BFN.ImagePainterUndoManagerEvents.PAINT_UPDATED.type,this.handlePainterUpdated.bind(this)),BFN.ImagePainterUndoManager.addEventListener(BFN.ImagePainterUndoManagerEvents.ALT_TEXTURE_UPDATED.type,this.handlePainterUpdated.bind(this)),this.painter.addEventListener(BFN.ImagePainterEvents.BRUSH_APPLIED.type,this.handlePainterUpdated.bind(this)),this.painter.addEventListener(BFN.ImagePainterEvents.PAINT_APPLIED_UPDATED.type,this.handlePainterPaintAppliedUpdated.bind(this)),this.painter.addEventListener(BFN.ImagePainterEvents.PAINTING_ENABLED_UPDATED.type,this.handlePainterPaintingEnabledUpdated.bind(this))};St.prototype.handleBackground=function(){if(BFN.PhotoEditorCanvasModel.viewState===BFN.PhotoEditorCanvasModelViewStates.VIEWING_BACKGROUND){let i=UITools.getToolVO("background");this.transparent!==i.transparent&&(this.transparent=i.transparent,requestAnimationFrame(()=>{UITools.disableControlItem("background_fill_color",this.transparent),UITools.disableControlItem("background_fill_amount",this.transparent),UITools.disableControlItem("background_opacity",this.transparent)}));let e=this.transparent?0:i.opacity/100,t=this.transparent?-1:i.fill_color,r=this.transparent?1:i.fill_amount/100;this.maskBlendSprite.unmaskedAlpha!=e&&(this.maskBlendSprite.unmaskedAlpha=e),this.maskBlendSprite.blendColor!=t&&(this.maskBlendSprite.blendColor=t),this.maskBlendSprite.blendIntensity!=r&&(this.maskBlendSprite.blendIntensity=r)}};St.prototype.handleBackgroundBrush=function(){this.updateBackgroundBrushParameters()};St.prototype.setSourceTexture=function(i){this.sourceTexture!=null&&(this.sourceTexture=null,this.sourceSprite.texture=PIXI.Texture.EMPTY),i?(this.sourceTexture=i,this.sourceSprite.texture=this.sourceTexture,this.maskBlendSprite.inputTexture=this.sourceTexture,this.maskSprite.width=this.sourceTexture.width,this.maskSprite.height=this.sourceTexture.height,this.imageContainer.x=-Math.round(i.width/2),this.imageContainer.y=-Math.round(i.height/2),this.painter.setup(this.sourceTexture.width,this.sourceTexture.height),this.transparent=!1,this.inverse=!1,this.updateMaskDisplay(),UITools.setToolValue("background","transparent",!0),UITools.setToolValue("background","fill_color","FFFFFF"),UITools.setToolValue("background","fill_amount",100),UITools.setToolValue("background","opacity",100),UITools.updateToolControls("background"),UITools.setToolValue("background_brush","show_mask",!1),UITools.setToolValue("background_brush","select_action","subtract"),UITools.updateToolControls("background_brush"),this.updateBackgroundBrushParameters()):(this.maskBlendSprite.reset(),this.painter.reset())};St.prototype.updateBackgroundBrushParameters=function(){let i=UITools.getToolVO("background_brush");if(i){if(i.updating_id==="isolate_subject"&&!i.updating){BFN.BackgroundRemovalManager.isolateSubjectOnPainter(this.sourceTexture,this.inverse,()=>{UITools.setToolValue("background_brush","select_action","add"),UITools.updateToolControl("background_brush_select_action");let r=i.select_action==="subtract"?this.inverse:!this.inverse;this.painter.eraseMode!=r&&(this.painter.eraseMode=r)});return}i.clear&&(this.painter.clear(!0),UITools.setToolValue("background_brush","erase",!1),UITools.updateToolControl("background_brush_erase"),this.maskBlendSprite.updateDisplay(),this.inverse&&(this.inverse=!1,this.updateMaskDisplay())),this.showMask!==i.show_mask&&(this.showMask=i.show_mask,this.updateMaskDisplay()),i.updating_id=="invert"&&(this.inverse=!this.inverse,this.updateMaskDisplay());let e=i.select_action==="subtract"?this.inverse:!this.inverse;this.painter.eraseMode!=e&&(this.painter.eraseMode=e),i.updating&&i.updating_id=="size"&&this.painter.brushSizeFactor!=i.size/100&&(this.painter.brushSizeFactor=i.size/100);let t=!1;!i.updating&&(i.updating_id=="size"||this.painter.brushSizeFactor!=i.size/100)&&(this.painter.brushSizeFactor=i.size/100,t=!0),!i.updating&&(i.updating_id=="hardness"||this.painter.brushHardnessFactor!=i.hardness/100)&&(this.painter.brushHardnessFactor=i.hardness/100,t=!0),!i.updating&&(i.updating_id=="strength"||this.painter.brushStrengthFactor!=i.strength/100)&&(this.painter.brushStrengthFactor=i.strength/100,t=!0),t&&this.painter.updateBrush()}};St.prototype.updateMaskDisplay=function(i=null){i=!!(i===null?this.showMask:i),this.sourceSprite.visible=i,this.maskBlendSprite.visible=!i,this.maskSprite.visible=i&&(this.painter.paintApplied||this.inverse);let e=this.painter.isSetup&&this.painter.paintApplied?this.painter:null;this.maskSprite.mask!==e&&(this.maskSprite.mask=e),this.painter.renderable=!1,BFN.MainUI.requestRender()};St.prototype.setSmoothingScale=function(i){this.sourceSprite.currentScale=i,this.maskBlendSprite.currentScale=i,this.painter.currentScale=i};St.prototype.handlePainterUpdated=function(i){BFN.ImagePainterUndoManager.currentImagePainter===this.painter&&this.painter.isSetup&&(this.maskBlendSprite.maskTexture!==this.painter.texture&&(this.maskBlendSprite.maskTexture=this.painter.texture),this.maskBlendSprite.updateDisplay())};St.prototype.handlePainterPaintAppliedUpdated=function(i){this.updateMaskDisplay()};St.prototype.handlePainterPaintingEnabledUpdated=function(){this.painter.isSetup&&!this.painter.paintingEnabled&&this.showMask&&(UITools.setToolValue("background_brush","show_mask",!1),UITools.updateToolControl("background_brush_show_mask"),this.showMask=UITools.getToolValue("background_brush","show_mask"),this.updateMaskDisplay())};Object.defineProperty(St.prototype,"showMask",{set:function(i){this._showMask=i,this.maskBlendSprite.autoRender=!this.showMask},get:function(){return this._showMask}});Object.defineProperty(St.prototype,"inverse",{set:function(i){this._inverse=i,this.maskBlendSprite.inverse=this._inverse,this.painter.inverseMask=this._inverse},get:function(){return this._inverse}});Object.defineProperty(St.prototype,"toolScale",{set:function(i){this._scale=i,this.painter.toolScale=this._scale,this.setSmoothingScale(this._scale)},get:function(){return this._scale}});Object.defineProperty(St.prototype,"modifiedTexture",{get:function(){if(this.sourceTexture){this.maskBlendSprite.displayUpdatePending&&this.maskBlendSprite.renderDisplay();let i=PIXI.RenderTexture.create(this.sourceTexture.width,this.sourceTexture.height);return this.imageContainer.x=this.imageContainer.y=0,this.setSmoothingScale(1),this.updateMaskDisplay(!1),BFN.Stage.render(this.imageContainer,i),this.imageContainer.x=-Math.round(this.sourceTexture.width/2),this.imageContainer.y=-Math.round(this.sourceTexture.height/2),this.setSmoothingScale(this._scale),this.updateMaskDisplay(),i}return null}});Object.defineProperty(BFN,"ImageBackground",{get:function(){return BFN._ImageBackground||(BFN._ImageBackground=new St),BFN._ImageBackground}});var{html:Rs,defineCustomElement:QM,appLang:Zr,icon:jB,useLanguageUpdate:ZM,useMediaQuery:e1,useLayoutEffect:Ls,useRef:t1,useState:YB}=BeFunky.lit;function bn(){QM("cutout-modal",i1)}function i1({isOpen:i=!1,trimTexture:e,fullTexture:t,trimTransparency:r=!1}){let a=this,[s,o]=YB(null),[n,l]=YB(null),c=Ut("cutout_trim_transparency"),h=Ut("cutout_export_as_layer");Ls(()=>{a.setClass("modal modal--button-sm cutout-modal")});let u=e1(`(min-width: ${BFN.CSS.desktopAppMinWidth}px)`),d=t1();return d.current=x,Ls(v,[t,e,r,i,n]),Ls(()=>{if(!!i)return T(),()=>BeFunky.closeModal(a,!1)},[i]),Ls(()=>{i&&T()},[u]),ZM("app"),u?m():p();function m(){return Rs`
        <div class="cutout-modal__left-column">
            ${g()}
        </div>
        <div class="cutout-modal__right-column">
            ${f()}
        </div>
        `}function p(){return Rs`
        ${g()}
        <div class="cutout-modal__mobile-content">
            ${f()}
        </div>
        `}function g(){if(!(!n||!s))return Rs`
        <div class="cutout-modal__image-wrapper" style=${`width: ${n.width}px; height: ${n.height}px;`}>
            <img class="cutout-modal__image" src=${s.src} style=${`width: ${s.width}px; height: ${s.height}px`} alt="Cutout Preview">
        </div>
        `}function f(){return Rs`
        <h2 class="cutout-modal__header">${Zr("cutout_options")}</h2>

        <div class="control-item">
            <div class="checkbox">
                <input type="checkbox" id="cutout_modal_trim_transparency" .checked=${c.value} @change=${c.onChange}>
                <label class="checkbox__label" for="cutout_modal_trim_transparency">
                    <span class="checkbox__box checkbox__box--sm">
                        ${jB("checkmark-icon","icon checkbox__icon icon--12")}
                    </span>
                    <string>${Zr("trim_transparency")}</string>
                </label>
                <p class="checkbox__description">${Zr(c.description)}</p>
            </div>
        </div>

        <div class="control-item">
            <div class="checkbox">
                <input type="checkbox" id="cutout_modal_export" .checked=${h.value} @change=${h.onChange}>
                <label class="checkbox__label" for="cutout_modal_export">
                    <span class="checkbox__box checkbox__box--sm">
                        ${jB("checkmark-icon","icon checkbox__icon icon--12")}
                    </span>
                    <string>${Zr("export_as_layer")}</string>
                </label>
                <p class="checkbox__description">${Zr(h.description)}</p>
            </div>
        </div>

        <div class="button-group" style=${u?"padding-top: 1rem; margin-top: auto;":"margin-top: 1.5rem;"}>
            <button @click=${B=>UITools.onButtonControlClick(B,"cutout_options_modal_cancel")} class="modal__button button button--grey-300">
                ${Zr("cancel")}
            </button>
            <button @click=${B=>UITools.onButtonControlClick(B,"cutout_options_modal_apply")} class="modal__button button button--blue focus-initially">
                ${Zr("apply")}
            </button>
        </div>`}function v(){if(!i||!t||!e||!n){s&&o(null);return}let B=r?e:t,y=n.width,F=n.height,[b,S]=BFN.TextureUtils.getScaledDimensions(B,{maxWidth:y,maxHeight:F}),I=y*window.devicePixelRatio,_=F*window.devicePixelRatio,E=Math.min(1,BFN.maxImageSize/I,BFN.maxImageSize/_);I=Math.floor(I*E),_=Math.floor(_*E);let[D,w]=BFN.TextureUtils.getScaledDimensions(B,{maxWidth:I,maxHeight:_}),N=BFN.Util.resizeTexture(B,D,w),M=BFN.TextureUtils.textureToBase64(N,{isTransparent:BFN.Util.isTransparent(N)});N.destroyGC(!0),o({src:M,width:b,height:S})}function T(){BeFunky.openModal(a,{onClose:()=>{if(a.isOpen=!1,a.fullTexture){try{a.fullTexture.destroyGC(!1)}catch(B){}a.fullTexture=void 0}if(a.trimTexture){try{a.trimTexture.destroyGC(!1)}catch(B){}a.trimTexture=void 0}},size:u?[944,480]:[1e3,1e3],isFullWidthOnMobile:!0,onWindowResize:B=>d.current(B)})}function x({availableWidth:B,availableHeight:y},F=!0){let b;if(u){let S=320,I=24;b={width:B-S-I*2,height:y-I*2}}else{let S=a.querySelector(".cutout-modal__mobile-content").getBoundingClientRect().height;if(!S){if(F)return requestAnimationFrame(()=>x({availableWidth:B,availableHeight:y},!1));BeFunky.logWarning("Failed to get content height for cutout"),S=240}let I=32,_=32;b={width:B-_*2,height:y-S-I-_*2}}(!n||b.width!==n.width||b.height!==n.height)&&l(b)}}function Pe(){PIXI.Sprite.call(this),this.init()}Pe.prototype=Object.create(PIXI.Sprite.prototype);Pe.prototype.init=function(){BeFunky.log("ImageCutout Init"),this.initDefaultValues(),this.initImageContainer(),this.initDisplay(),this.initCutoutOptionsModal()};Pe.prototype.initDefaultValues=function(){this._scale=1,this.cutoutActive=!1,this.quickSelectActive=!1,this.PIx2=Math.PI*2,this.PId4=Math.PI/4,this.itemWidth=0,this.itemHeight=0,this.shapePoints=[],this.selectionPoints=[],this.shapeStartPoint=null,this.selectionStartPoint=null,this.showMask=!1,this.selectionMode=null,this.inverse=!1,this.erase=!1,this.invertSelection=!1,this.backgroundColor=-1,this.trimTransparency=!0,this.tolerance=.5,this.shiftKey=!1,this.spaceKey=!1,this.pressedKeyCodes=[],this.initialLumaColor=0,this.isNewCanvas=!1,this.cutoutRect=null,this.shapeBounds={minX:0,minY:0,maxX:0,maxY:0},this.featherBase=1024,this.featherAmount=1,this.featherAmountMax=1,this.featherAmountMin=0,this.featherFilter=new BFN.filters.GaussianBlurFilter,this.cutoutMaskFilter=new BFN.filters.CutoutMaskFilter,this.selectionStrength=1,this.readyCallback=null,this.handleMouseOverBind=this.handleMouseOver.bind(this),this.handleMouseOutBind=this.handleMouseOut.bind(this),this.handleMouseDownBind=this.handleMouseDown.bind(this),this.handleMouseMoveBind=this.handleMouseMove.bind(this),this.handleMouseUpBind=this.handleMouseUp.bind(this),this.handleKeyDownBind=this.handleKeyDown.bind(this),this.handleKeyUpBind=this.handleKeyUp.bind(this),this.handlePaintingCompleteBind=this.handlePaintingComplete.bind(this),this.handleCanvasScalingUpdatedBind=this.handleCanvasScalingUpdated.bind(this),BFN.ImagePainterUndoManager.addEventListener(BFN.ImagePainterUndoManagerEvents.ALT_TEXTURE_UPDATED.type,this.handleAltTextureUpdated.bind(this))};Pe.prototype.initImageContainer=function(){this.imageContainer=new PIXI.Sprite,this.imageContainer.interactive=!0,this.imageContainer.on("pointerover",this.handleMouseOverBind),this.imageContainer.on("pointerout",this.handleMouseOutBind),this.imageContainer.on("pointerdown",this.handleMouseDownBind),this.addChild(this.imageContainer)};Pe.prototype.initDisplay=function(){this.sourceTexture=null,this.lumaTexture=null,this.cutoutTexture=null,this.sourceSprite=new PIXI.Sprite,this.selectionShape=new PIXI.Graphics,this.selectionSprite=new PIXI.Sprite,this.selectionSprite.pluginName="smooth_picture",this.selectionSprite.texture=PIXI.RenderTexture.create(1,1),this.selectionSprite.texture.clear(),this.cutoutSprite=new PIXI.Sprite,this.cutoutSprite.pluginName="smooth_picture",this.imageContainer.addChild(this.cutoutSprite),this.quickSelectTextureMaxSize=2048,this.quickSelectTextureScaleFactor={xy:1,x:1,y:1,w:0,h:0},this.quickSelectRadius=0,this.quickSelectRadiusMin=0,this.quickSelectRadiusMax=0,this.quickSelectRegionSize=0,this.quickSelectPoints=[],this.quickSelectSprite=new PIXI.Sprite,this.quickSelectSprite.alpha=.5,this.quickSelectSprite.pluginName="blend_picture",this.quickSelectSprite.currentScale=.75,this.imageContainer.addChild(this.quickSelectSprite),this.magicBrushFilter=new BFN.filters.MagicBrushFilter,this.quickSelectRegionSprite=new PIXI.Sprite,this.quickSelectRegionSprite.filters=[this.magicBrushFilter],this.painter=new BFN.ImagePainter,this.painter.usePaintTexture=!1,this.painter.alpha=.5,this.painter.tint=16711680,this.painter.dispatchEventsAfterUpdate=!1,this.painter.addEventListener(BFN.ImagePainterEvents.PAINTING_COMPLETE.type,this.handlePaintingCompleteBind),this.painter.preRedoCallback=()=>{this.lumaTexture&&(BFN.ImagePainterUndoManager.regionIndex===-1||BFN.ImagePainterUndoManager.regionIndex===0&&BFN.ImagePainterUndoManager.direction==="undo")&&this.lumaTexture.fillColor(this.initialLumaColor)},this.imageContainer.addChild(this.painter),this.selectionCanvas=new PIXI.Graphics,this.selectionCanvas.blendMode=21,this.addChild(this.selectionCanvas)};Pe.prototype.initCutoutOptionsModal=function(){bn(),this.cutoutOptionsModal=BeFunky.lit.elem`<cutout-modal id="cutout_options_modal"></cutout-modal>`};Pe.prototype.handleCutout=function(){if(BFN.PhotoEditorCanvasModel.viewState==BFN.PhotoEditorCanvasModelViewStates.VIEWING_CUTOUT){let i=UITools.getToolVO("cutout");if(i.updating_id==="remove_background"&&!i.updating){BFN.BackgroundRemovalManager.isolateSubjectOnPainter(this.sourceTexture,this.inverse,()=>{this.updateCutoutTexture()});return}let e=!1;!i.updating&&i.updating_id==="clear"&&(this.painter.clear(),this.resetLumaTexture(),e=!0),this.selectionMode!==i.mode&&(this.selectionMode=i.mode,this.selectionCanvas.visible=this.selectionMode!=="brush",UITools.toggleControlItem("cutout_brush_size",["brush","magic_brush"].includes(this.selectionMode)),UITools.toggleControlItem("cutout_strength",this.selectionMode!=="magic_brush"),UITools.toggleControlItem("cutout_hardness",this.selectionMode!=="magic_brush"),UITools.toggleControlItem("cutout_tolerance",this.selectionMode==="magic_brush"),this.painter.paintingEnabled=this.selectionMode==="brush"),this.updateQuickSelectTextures(this.selectionMode==="magic_brush"),this.backgroundColor!==i.background_color&&(this.backgroundColor=i.background_color,e=!0);let t=i.brush_size/100;if(i.updating&&i.updating_id==="brush_size"&&this.painter.brushSizeFactor!=t&&(this.painter.brushSizeFactor=t),!i.updating&&(i.updating_id==="brush_size"||this.painter.brushSizeFactor!=t)&&(this.painter.brushSizeFactor=t,this.painter.updateBrush()),!i.updating){this.cutoutOptionsModal.trimTransparency!==i.trim_transparency&&(this.cutoutOptionsModal.trimTransparency=i.trim_transparency),this.tolerance=i.tolerance/100,this.magicBrushFilter.tolerance=this.tolerance,this.selectionStrength=i.strength/100,this.featherAmount=(this.featherAmountMax-this.featherAmountMin)*(1-i.hardness/100)+this.featherAmountMin;let r=i.hardness/100;if((this.painter.brushStrengthFactor!=this.selectionStrength||this.painter.brushHardnessFactor!=r)&&(this.painter.brushStrengthFactor=this.selectionStrength,this.painter.brushHardnessFactor=r,this.painter.updateBrush()),this.featherFilter.blur!=this.featherAmount&&(this.featherFilter.blur=this.featherAmount),this.showMask!=i.show_mask&&(this.showMask=i.show_mask,e=!0),i.updating_id==="invert"&&(this.inverse=!this.inverse,e=!0),this.erase=i.select_action==="subtract",i.updating_id==="options_modal_cancel")this.cutoutOptionsModal.isOpen=!1;else if(i.updating_id==="options_modal_apply"){if(this.trimTransparency=i.trim_transparency,i.export_as_layer){let a=this.trimTransparency?this.cutoutOptionsModal.trimTexture.renderClone():this.cutoutOptionsModal.fullTexture.renderClone(),s=BFN.ImageLibraryManager.createMenuImageVOFromTexture(a),o={type:"frame_texture",texture:s.imageTexture,projectItemAssetID:s.id};BFN.TransformModel.layerItem||(o.initialPosition=this.cutoutRect&&this.trimTransparency?new PIXI.Point(this.cutoutRect.x,this.cutoutRect.y):new PIXI.Point,o.initialScale=new PIXI.Point(1,1)),this.cutoutOptionsModal.isOpen=!1,UITools.setToolValue("editor_apply_cancel","cancel",!0,!1),UITools.applyTool("editor_apply_cancel"),UITools.setToolValue("editor_apply_cancel","cancel",!1,!1),BFN.TransformModel.layerItem&&BFN.TransformItemIsolator.active?(this.exportedItemObject=o,BFN.TransformItemIsolator.reselectOnReleaseComplete=!1):BFN.PhotoEditorCanvasModel.addedItem=o,UITools.setToolValue("editor_main","image_manager",!0),UITools.applyTool("editor_main"),UITools.setToolValue("editor_main","image_manager",!1)}else this.cutoutOptionsModal.isOpen=!1,BFN.applyCancelMenu.alternateApply=!1,UITools.setToolValue("editor_apply_cancel","apply",!0,!1),UITools.applyTool("editor_apply_cancel"),UITools.setToolValue("editor_apply_cancel","apply",!1,!1);return}}e&&!this.isNewCanvas&&this.updateCutoutTexture(),this.isNewCanvas=!1}};Pe.prototype.reset=function(){this.sourceTexture=null,this.sourceSprite.texture=PIXI.Texture.EMPTY,this.sourceSprite.filters=[];try{this.lumaTexture.destroyGC(!0)}catch(i){}this.lumaTexture=null,this.cutoutMaskFilter.lumaTexture=PIXI.Texture.EMPTY;try{this.cutoutTexture.destroyGC(!0)}catch(i){}this.cutoutTexture=null,this.cutoutSprite.texture=PIXI.Texture.EMPTY,this.updateQuickSelectTextures(!1),this.painter.altTexture=null,this.hitArea=null,BFN.BrushCircle.showing&&BFN.BrushCircle.hide(!0),BFN.PhotoEditorCanvasModel.removeEventListener(BFN.PhotoEditorCanvasModelEvents.CANVAS_SCALING_UPDATED.type,this.handleCanvasScalingUpdatedBind),BFN.CollageMakerCanvasModel.removeEventListener(BFN.CollageMakerCanvasModelEvents.CANVAS_SCALING_UPDATED.type,this.handleCanvasScalingUpdatedBind),BFN.DesignerCanvasModel.removeEventListener(BFN.DesignerCanvasModelEvents.CANVAS_SCALING_UPDATED.type,this.handleCanvasScalingUpdatedBind),BFN.MainUI.off("pointermove",this.handleMouseMoveBind),BFN.MainUI.off("pointerup",this.handleMouseUpBind),BFN.MainUI.off("pointerupoutside",this.handleMouseUpBind)};Pe.prototype.setSourceTexture=function(i){if(this.reset(),i){BFN.applyCancelMenu.alternateApply=!BFN.TransformItemIsolator.active||BFN.TransformItemIsolator.active&&BFN.TransformItemIsolator.usingAlternateMenu,this.trimTransparency=!0,this.itemWidth=i.width,this.itemHeight=i.height,this.imageContainer.x=-Math.round(i.width/2),this.imageContainer.y=-Math.round(i.height/2),this.sourceTexture=i,this.sourceSprite.texture=this.sourceTexture,this.sourceSprite.filters=[this.cutoutMaskFilter],this.lumaTexture=PIXI.RenderTexture.create(this.sourceTexture.width,this.sourceTexture.height),this.lumaTexture.fillColor(0),this.cutoutMaskFilter.lumaTexture=this.lumaTexture,this.cutoutTexture=PIXI.RenderTexture.create(this.sourceTexture.width,this.sourceTexture.height),this.cutoutTexture.fillColor(0),this.cutoutSprite.texture=this.cutoutTexture,this.quickSelectTextureScaleFactor.xy=Math.min(1,this.quickSelectTextureMaxSize/Math.max(this.sourceTexture.width,this.sourceTexture.height)),this.quickSelectTextureScaleFactor.w=Math.round(this.sourceTexture.width*this.quickSelectTextureScaleFactor.xy),this.quickSelectTextureScaleFactor.h=Math.round(this.sourceTexture.height*this.quickSelectTextureScaleFactor.xy),this.quickSelectTextureScaleFactor.x=this.quickSelectTextureScaleFactor.w/this.sourceTexture.width,this.quickSelectTextureScaleFactor.y=this.quickSelectTextureScaleFactor.h/this.sourceTexture.height,this.hitArea=new PIXI.Rectangle(-(this.sourceTexture.width*2),-(this.sourceTexture.height*2),this.sourceTexture.width*5,this.sourceTexture.height*5),this.painter.altTexture=this.lumaTexture,this.isNewCanvas=!0,this.featherAmountMax=1,this.featherAmountMin=0,this.inverse=!1,this.showMask=!1,UITools.setToolValue("cutout","show_mask",!1),UITools.setToolValue("cutout","select_action","subtract"),UITools.updateToolControls("cutout");let e=BFN.AppModel.sectionValue(BFN.PhotoEditorCanvasModel,BFN.CollageMakerCanvasModel,BFN.DesignerCanvasModel),t=BFN.AppModel.sectionValue(BFN.PhotoEditorCanvasModelEvents,BFN.CollageMakerCanvasModelEvents,BFN.DesignerCanvasModelEvents);e.addEventListener(t.CANVAS_SCALING_UPDATED.type,this.handleCanvasScalingUpdatedBind),requestAnimationFrame(()=>{this.readyCallback&&(this.readyCallback(),this.readyCallback=null)})}else this.imageContainer.x=0,this.imageContainer.y=0;this.updatePainter(),this.resetLumaTexture(),this.updateCutoutTexture()};Pe.prototype.updateQuickSelectTextures=function(i=!1){if(this.quickSelectActive!==i)if(this.quickSelectActive=i,this.quickSelectActive)this.quickSelectTexture=PIXI.RenderTexture.create(this.quickSelectTextureScaleFactor.w,this.quickSelectTextureScaleFactor.h),this.quickSelectTexture.clear(),this.quickSelectSprite.texture=this.quickSelectTexture,this.quickSelectSprite.scale.x=1/this.quickSelectTextureScaleFactor.x,this.quickSelectSprite.scale.y=1/this.quickSelectTextureScaleFactor.y,this.quickSelectRegionTexture=PIXI.RenderTexture.create(32,32),this.quickSelectRegionTexture.clear(),this.quickSelectRegionSprite.texture=this.quickSelectRegionTexture,this.quickSelectRegionResultTexture=PIXI.RenderTexture.create(32,32),this.quickSelectRegionResultTexture.clear(),this.quickSelectRegionUnionTexture=PIXI.RenderTexture.create(32,32),this.quickSelectRegionUnionTexture.clear(),this.magicBrushFilter.unionTexture=this.quickSelectRegionUnionTexture;else{try{this.quickSelectTexture.destroyGC(!0)}catch(e){}this.quickSelectTexture=null,this.quickSelectSprite.texture=PIXI.Texture.EMPTY;try{this.quickSelectRegionTexture.destroyGC(!0)}catch(e){}this.quickSelectRegionTexture=null,this.quickSelectRegionSprite.texture=PIXI.Texture.EMPTY;try{this.quickSelectRegionResultTexture.destroyGC(!0)}catch(e){}this.quickSelectRegionResultTexture=null;try{this.quickSelectRegionUnionTexture.destroyGC(!0)}catch(e){}this.quickSelectRegionUnionTexture=null,this.magicBrushFilter.unionTexture=PIXI.Texture.EMPTY}};Pe.prototype.updateQuickSelectRegionTextures=function(){this.quickSelectRadius=Math.round(this.painter.brushRadius*this.quickSelectTextureScaleFactor.xy),this.quickSelectRegionSize=this.quickSelectRadius*2,(this.quickSelectRegionTexture.width!=this.quickSelectRegionSize||this.quickSelectRegionTexture.height!=this.quickSelectRegionSize)&&(this.quickSelectRegionTexture.resize(this.quickSelectRegionSize,this.quickSelectRegionSize),this.quickSelectRegionResultTexture.resize(this.quickSelectRegionSize,this.quickSelectRegionSize),this.quickSelectRegionUnionTexture.resize(this.quickSelectRegionSize,this.quickSelectRegionSize))};Pe.prototype.updatePainter=function(){this.sourceTexture?(this.painter.painterWidth!=this.sourceTexture.width||this.painter.painterHeight!=this.sourceTexture.height)&&this.painter.setup(this.sourceTexture.width,this.sourceTexture.height):this.painter.reset()};Pe.prototype.resetLumaTexture=function(){this.lumaTexture&&this.lumaTexture.fillColor(0)};Pe.prototype.updateCutoutTexture=function(){!this.lumaTexture||(this.cutoutMaskFilter.showMask=this.showMask,this.cutoutMaskFilter.useMask=!(BFN.ImagePainterUndoManager.regionIndex<0||BFN.ImagePainterUndoManager.regionIndex===0&&BFN.ImagePainterUndoManager.direction==="undo"),this.cutoutMaskFilter.inverse=this.inverse||BFN.ImagePainterUndoManager.regionIndex<0||BFN.ImagePainterUndoManager.regionIndex==0&&BFN.ImagePainterUndoManager.direction=="undo",this.cutoutMaskFilter.backgroundColor=this.backgroundColor,BFN.Stage.render(this.sourceSprite,this.cutoutTexture),this.cutoutRect=null)};Pe.prototype.processFeather=function(i){if(this.featherAmount){let e=Math.max(i.width,i.height),t=this.featherBase/e,r=Math.round(i.width*t),a=Math.round(i.height*t),s=PIXI.RenderTexture.create(r,a);s.copyPixels(i,null,null,null,{x:s.width/i.width,y:s.height/i.height});let o=new PIXI.Sprite(s);this.featherFilter.setInputDimensions(s.width,s.height),o.filters=[this.featherFilter];let n=PIXI.RenderTexture.create(s.width,s.height);BFN.Stage.render(o,n),i.copyPixels(n,null,null,null,{x:i.width/s.width,y:i.height/s.height}),s.destroyGC(!0),o.filters=[],o.destroy(!1),n.destroyGC(!0),n=null}};Pe.prototype.showCutoutOptionsModal=function(){let i=this.getCutoutTexture(!1),e=this.getCutoutTexture(!0);if(i&&e)this.cutoutOptionsModal.isOpen=!0,this.cutoutOptionsModal.fullTexture=i,this.cutoutOptionsModal.trimTexture=e;else{try{i.destroyGC(!1)}catch(t){}try{e.destroyGC(!1)}catch(t){}}};Pe.prototype.startQuickSelect=function(){this.updateQuickSelectRegionTextures();let i=this.imageContainer.getPointerPosition(this.pointerEvent),e=i.x>=0&&i.x<this.sourceTexture.width&&i.y>=0&&i.y<this.sourceTexture.height;i.x=Math.max(0,Math.min(this.sourceTexture.width,i.x)),i.y=Math.max(0,Math.min(this.sourceTexture.height,i.y)),this.shapeBounds.minX=this.shapeBounds.maxX=i.x,this.shapeBounds.minY=this.shapeBounds.maxY=i.x,this.mousePosition=i;let t=this.selectionCanvas.getPointerPosition(this.pointerEvent);this.selectionCanvas.moveTo(t.x,t.y),this.cutoutActive=!0,this.quickSelectBounds=null,e&&this.quickSelect(i)};Pe.prototype.moveQuickSelect=function(){let i=this.imageContainer.getPointerPosition(this.pointerEvent);this.mousePosition||(this.mousePosition=i);let e=i.x-this.mousePosition.x,t=i.y-this.mousePosition.y;if(Math.sqrt(Math.pow(e,2)+Math.pow(t,2))>1/this._scale){let a=this.selectionCanvas.getPointerPosition(this.pointerEvent);this.selectionCanvas.lineStyle(1,16777215),this.selectionCanvas.lineTo(a.x,a.y),this.dragQuickSelectTo(i),this.mousePosition=i}};Pe.prototype.stopQuickSelect=function(i=!0){if(i&&this.quickSelectBounds){let e=Math.round((this.quickSelectBounds.maxX-this.quickSelectBounds.minX)/this.quickSelectTextureScaleFactor.x),t=Math.round((this.quickSelectBounds.maxY-this.quickSelectBounds.minY)/this.quickSelectTextureScaleFactor.y);e>0&&t>0&&(this.selectionSprite.texture.resize(e,t),this.selectionSprite.anchor.x=this.selectionSprite.anchor.y=0,this.selectionSprite.scale.x=this.selectionSprite.scale.y=this.selectionSprite.currentScale=1,this.quickSelectSprite.fillColor=this.invertSelection?0:16777215,this.quickSelectSprite.intensity=1,this.quickSelectSprite.x=-(this.quickSelectBounds.minX/this.quickSelectTextureScaleFactor.x),this.quickSelectSprite.y=-(this.quickSelectBounds.minY/this.quickSelectTextureScaleFactor.y),this.quickSelectSprite.alpha=1,BFN.Stage.render(this.quickSelectSprite,this.selectionSprite.texture),delete this.quickSelectSprite.fillColor,delete this.quickSelectSprite.intensity,this.quickSelectSprite.x=0,this.quickSelectSprite.y=0,this.quickSelectSprite.alpha=.5,this.painter.updatePrevTexture(),(BFN.ImagePainterUndoManager.regionIndex<0||BFN.ImagePainterUndoManager.regionIndex==0&&BFN.ImagePainterUndoManager.direction=="undo")&&(this.initialLumaColor=0,this.invertSelection&&(this.initialLumaColor=16777215,this.lumaTexture.fillColor(this.initialLumaColor))),this.selectionSprite.x=this.quickSelectBounds.minX/this.quickSelectTextureScaleFactor.x,this.selectionSprite.y=this.quickSelectBounds.minY/this.quickSelectTextureScaleFactor.y,BFN.Stage.render(this.selectionSprite,this.lumaTexture,!1),this.selectionSprite.texture.resize(1,1),this.painter.paintBounds=new PIXI.Rectangle(Math.floor(this.selectionSprite.x),Math.floor(this.selectionSprite.y),e+1,t+1),this.painter.dispatchEvent(BFN.ImagePainterEvents.PAINT_UPDATED))}this.quickSelectTexture.clear(),this.selectionCanvas.clear(),i&&this.updateCutoutTexture(),BFN.MainUI.off("pointermove",this.handleMouseMoveBind),BFN.MainUI.off("pointerup",this.handleMouseUpBind),BFN.MainUI.off("pointerupoutside",this.handleMouseUpBind),document.removeEventListener("keydown",this.handleKeyDownBind),document.removeEventListener("keyup",this.handleKeyUpBind),this.resetPressedKeys(),BFN.MainUI.requestRender(),this.cutoutActive=!1};Pe.prototype.dragQuickSelectTo=function(i){if(!this.sourceTexture)return;let e=Math.floor(i.x)-this.mousePosition.x,t=Math.floor(i.y)-this.mousePosition.y,r=Math.sqrt(e*e+t*t),a=Math.atan2(t,e),s=4,o=this.quickSelectRadius/s,n=Math.max(1,Math.ceil(r/Math.max(1,o))),l=this.mousePosition.x,c=this.mousePosition.y;for(let h=1;h<=n;h++){let u=Math.max(0,Math.min(this.sourceTexture.width,Math.floor(l+Math.cos(a)*r*(h/n)))),d=Math.max(0,Math.min(this.sourceTexture.height,Math.floor(c+Math.sin(a)*r*(h/n))));(h<=s||h==n)&&this.quickSelectPoints.push({x:u,y:d})}for(;this.quickSelectPoints.length;){let h=this.quickSelectPoints.shift();this.quickSelect(h)}};Pe.prototype.quickSelect=function(i){if(!this.sourceTexture)return;let e=Math.round(i.x*this.quickSelectTextureScaleFactor.x),t=Math.round(i.y*this.quickSelectTextureScaleFactor.y),r=Math.round(e-this.quickSelectRadius),a=Math.round(t-this.quickSelectRadius);this.quickSelectBounds||(this.quickSelectBounds={minX:Math.round(e),minY:Math.round(t),maxX:Math.round(e),maxY:Math.round(t)}),this.quickSelectBounds.minX=Math.max(0,Math.min(this.quickSelectBounds.minX,r,this.quickSelectTexture.width)),this.quickSelectBounds.minY=Math.max(0,Math.min(this.quickSelectBounds.minY,a,this.quickSelectTexture.height)),this.quickSelectBounds.maxX=Math.min(this.quickSelectTexture.width,Math.max(this.quickSelectBounds.maxX,r+this.quickSelectRegionSize,0)),this.quickSelectBounds.maxY=Math.min(this.quickSelectTexture.height,Math.max(this.quickSelectBounds.maxY,a+this.quickSelectRegionSize,0)),this.quickSelectRegionTexture.copyPixels(this.sourceTexture,{x:-r,y:-a},void 0,void 0,this.quickSelectTextureScaleFactor),this.quickSelectRegionUnionTexture.copyPixels(this.quickSelectTexture,{x:-r,y:-a}),this.quickSelectTexture.clearRect(r,a,this.quickSelectRegionSize,this.quickSelectRegionSize),BFN.Stage.render(this.quickSelectRegionSprite,this.quickSelectRegionResultTexture,!1),this.quickSelectTexture.copyPixels(this.quickSelectRegionResultTexture,{x:r,y:a},!1),BFN.MainUI.requestRender()};Pe.prototype.startLasso=function(){let i=this.imageContainer.getPointerPosition(this.pointerEvent);i.x=Math.max(0,Math.min(this.sourceTexture.width,i.x)),i.y=Math.max(0,Math.min(this.sourceTexture.height,i.y)),this.shapePoints.push(new PIXI.Point(i.x,i.y)),this.shapeBounds.minX=this.shapeBounds.maxX=i.x,this.shapeBounds.minY=this.shapeBounds.maxY=i.x,this.mousePosition=i;let e=this.selectionCanvas.getPointerPosition(this.pointerEvent);this.selectionCanvas.moveTo(e.x,e.y),this.cutoutActive=!0};Pe.prototype.moveLasso=function(){let i=this.imageContainer.getPointerPosition(this.pointerEvent);i.x=Math.max(0,Math.min(this.sourceTexture.width,i.x)),i.y=Math.max(0,Math.min(this.sourceTexture.height,i.y)),this.mousePosition||(this.mousePosition=i);let e=i.x-this.mousePosition.x,t=i.y-this.mousePosition.y;if(Math.sqrt(Math.pow(e,2)+Math.pow(t,2))>1){this.shapePoints.push(new PIXI.Point(i.x,i.y)),this.shapeBounds.minX=Math.min(this.shapeBounds.minX,i.x),this.shapeBounds.minY=Math.min(this.shapeBounds.minY,i.y),this.shapeBounds.maxX=Math.max(this.shapeBounds.maxX,i.x),this.shapeBounds.maxY=Math.max(this.shapeBounds.maxY,i.y),this.mousePosition=i;let a=this.selectionCanvas.getPointerPosition(this.pointerEvent);this.selectionCanvas.lineStyle(1,16777215),this.selectionCanvas.lineTo(a.x,a.y)}};Pe.prototype.stopLasso=function(i=!0){if(i&&this.shapePoints.length){let e=this.shapeBounds.maxX-this.shapeBounds.minX,t=this.shapeBounds.maxY-this.shapeBounds.minY;if(e>0&&t>0){let r=2*Math.min(1,BFN.maxImageSize/(Math.max(e,t)*2));this.selectionShape.clear(),this.selectionShape.moveTo(this.shapePoints[0].x*r,this.shapePoints[0].y*r),this.selectionShape.beginFill(this.invertSelection?0:16777215);for(let o=1;o<this.shapePoints.length;o++)this.selectionShape.lineTo(this.shapePoints[o].x*r,this.shapePoints[o].y*r);this.selectionShape.endFill(),this.selectionShape.x=-(this.shapeBounds.minX*r),this.selectionShape.y=-(this.shapeBounds.minY*r),this.selectionSprite.texture.resize(Math.round(e*r),Math.round(t*r)),this.selectionSprite.anchor.x=this.selectionSprite.anchor.y=0,this.selectionSprite.scale.x=this.selectionSprite.scale.y=this.selectionSprite.currentScale=1/r,BFN.Stage.render(this.selectionShape,this.selectionSprite.texture),this.painter.updatePrevTexture(),(BFN.ImagePainterUndoManager.regionIndex<0||BFN.ImagePainterUndoManager.regionIndex==0&&BFN.ImagePainterUndoManager.direction=="undo")&&(this.initialLumaColor=0,this.invertSelection&&(this.initialLumaColor=16777215,this.lumaTexture.fillColor(this.initialLumaColor))),this.selectionSprite.x=this.shapeBounds.minX,this.selectionSprite.y=this.shapeBounds.minY;let a=PIXI.RenderTexture.create(this.lumaTexture.width,this.lumaTexture.height);BFN.Stage.render(this.selectionSprite,a,!1),this.selectionSprite.texture.resize(1,1),this.processFeather(a),this.lumaTexture.copyPixels(a,null,!1,Math.max(0,Math.min(1,this.selectionStrength*.95+.05))),a.destroyGC(!0);let s={minX:this.shapeBounds.minX,minY:this.shapeBounds.minY,maxX:this.shapeBounds.maxX,maxY:this.shapeBounds.maxY};if(this.featherAmount){let o=Math.ceil(this.featherBase*.26*this.featherAmount);s.minX=Math.max(0,s.minX-o),s.minY=Math.max(0,s.minY-o),s.maxX=Math.min(this.lumaTexture.width,s.maxX+o),s.maxY=Math.min(this.lumaTexture.height,s.maxY+o)}this.painter.paintBounds=new PIXI.Rectangle(s.minX,s.minY,s.maxX-s.minX,s.maxY-s.minY),this.painter.dispatchEvent(BFN.ImagePainterEvents.PAINT_UPDATED)}}this.selectionCanvas.clear(),this.shapePoints.splice(0),i&&this.updateCutoutTexture(),BFN.MainUI.off("pointermove",this.handleMouseMoveBind),BFN.MainUI.off("pointerup",this.handleMouseUpBind),BFN.MainUI.off("pointerupoutside",this.handleMouseUpBind),document.removeEventListener("keydown",this.handleKeyDownBind),document.removeEventListener("keyup",this.handleKeyUpBind),this.resetPressedKeys(),BFN.MainUI.requestRender(),this.cutoutActive=!1};Pe.prototype.showPolygonStopButton=function(i=0,e=0){if(!this.polygonStopButton){let t=BeFunky.isMobile?20:10,r=new PIXI.Graphics;r.beginFill(16711680,.5),r.lineStyle(4,16777215),r.drawCircle(t+2,t+2,t),r.endFill();let a=PIXI.RenderTexture.create(t*2+4,t*2+4);BFN.Stage.render(r,a),this.polygonStopButton=new PIXI.Sprite(a),this.polygonStopButton.pluginName="smooth_picture",this.polygonStopButton.anchor.x=this.polygonStopButton.anchor.y=.5,this.polygonStopButton.scale.x=this.polygonStopButton.scale.y=this.polygonStopButton.currentScale=.5,this.polygonStopButton.rotation=this.PId4}this.polygonStopButton.x=i,this.polygonStopButton.y=e,this.polygonStopButton.scale.x=this.polygonStopButton.scale.y=1/this._scale*.5,this.addChild(this.polygonStopButton)};Pe.prototype.hidePolygonStopButton=function(){try{this.removeChild(this.polygonStopButton)}catch(i){}};Pe.prototype.startPolygon=function(){if(this.thisTapTime=performance.now(),this.lastTapTime&&this.thisTapTime-this.lastTapTime<200){this.stopPolygon();return}this.lastTapTime=this.thisTapTime,BFN.MainUI.off("pointerup",this.handleMouseUpBind),BFN.MainUI.off("pointerupoutside",this.handleMouseUpBind);let i=this.shiftKey&&this.snapShapePoint?this.snapShapePoint:this.imageContainer.getPointerPosition(this.pointerEvent),e=this.shiftKey&&this.snapShapePoint?this.snapSelectionPoint:this.selectionCanvas.getPointerPosition(this.pointerEvent);if(!this.shapeStartPoint){this.shapeBounds.minX=this.shapeBounds.maxX=i.x,this.shapeBounds.minY=this.shapeBounds.maxY=i.y,this.shapeStartPoint=i,this.selectionStartPoint=e;let t=this.getPointerPosition(this.pointerEvent);this.showPolygonStopButton(t.x,t.y)}if(this.shapePoints.length){this.shapeBounds.minX=Math.min(this.shapeBounds.minX,i.x),this.shapeBounds.minY=Math.min(this.shapeBounds.minY,i.y),this.shapeBounds.maxX=Math.max(this.shapeBounds.maxX,i.x),this.shapeBounds.maxY=Math.max(this.shapeBounds.maxY,i.y);let t=i.x-this.shapeStartPoint.x,r=i.y-this.shapeStartPoint.y,a=Math.sqrt(Math.pow(t,2)+Math.pow(r,2)),s=this.shapePoints[this.shapePoints.length-1],o=i.x-s.x,n=i.y-s.y,l=Math.sqrt(Math.pow(o,2)+Math.pow(n,2)),c=BeFunky.isMobile?10:5,h=BeFunky.isMobile?5:1;if(a<c/this._scale||l<h/this._scale){this.stopPolygon();return}}this.shapePoints.push(i),this.selectionPoints.push(e),this.movePolygon(),BFN.MainUI.requestRender(),BFN.TransformModel.layerItem?(BFN.alternateMenu.isDisabled=!0,UIToggler.toggleMainMenu(!1)):(UIToggler.toggleNavBar(!1),UIToggler.toggleMainMenu(!1),UIToggler.toggleZoomMenu(!1)),this.cutoutActive=!0};Pe.prototype.movePolygon=function(){if(this.selectionPoints.length){let i=this.selectionCanvas.getPointerPosition(this.pointerEvent);this.selectionCanvas.clear(),this.selectionCanvas.moveTo(this.selectionStartPoint.x,this.selectionStartPoint.y);for(let e=0;e<this.selectionPoints.length;e++)this.selectionCanvas.lineStyle(1,16777215),this.selectionCanvas.lineTo(this.selectionPoints[e].x,this.selectionPoints[e].y);if(this.shiftKey){let e=this.shapePoints[this.selectionPoints.length-1],t=this.selectionPoints[this.selectionPoints.length-1],r=i.x-t.x,a=i.y-t.y,s=Math.sqrt(Math.pow(r,2)+Math.pow(a,2)),o=i.x-t.x,n=i.y-t.y,l=Math.sqrt(Math.pow(o,2)+Math.pow(n,2)),c=(Math.atan2(n,o)+this.PIx2)%this.PIx2,h=Math.round(c/this.PId4);this.snapShapePoint=new PIXI.Point,this.snapShapePoint.x=e.x+Math.cos(h*this.PId4)*s,this.snapShapePoint.y=e.y+Math.sin(h*this.PId4)*s,this.snapSelectionPoint=new PIXI.Point,this.snapSelectionPoint.x=t.x+Math.cos(h*this.PId4)*l,this.snapSelectionPoint.y=t.y+Math.sin(h*this.PId4)*l,this.selectionCanvas.lineStyle(1,16777215),this.selectionCanvas.lineTo(this.snapSelectionPoint.x,this.snapSelectionPoint.y)}else this.snapShapePoint=null,this.snapSelectionPoint=null,this.selectionCanvas.lineStyle(1,16777215),this.selectionCanvas.lineTo(i.x,i.y)}};Pe.prototype.stopPolygon=function(i=!0){if(this.hidePolygonStopButton(),i&&this.shapePoints.length>2){let e=this.shapeBounds.maxX-this.shapeBounds.minX,t=this.shapeBounds.maxY-this.shapeBounds.minY;if(e>0&&t>0){let r=2*Math.min(1,BFN.maxImageSize/(Math.max(e,t)*2));this.selectionShape.clear(),this.selectionShape.moveTo(this.shapePoints[0].x*r,this.shapePoints[0].y*r),this.selectionShape.beginFill(this.invertSelection?0:16777215);for(let o=1;o<this.shapePoints.length;o++)this.selectionShape.lineTo(this.shapePoints[o].x*r,this.shapePoints[o].y*r);this.selectionShape.endFill(),this.selectionShape.x=-(this.shapeBounds.minX*r),this.selectionShape.y=-(this.shapeBounds.minY*r),this.selectionSprite.texture.resize(Math.round(e*r),Math.round(t*r)),this.selectionSprite.anchor.x=this.selectionSprite.anchor.y=0,this.selectionSprite.scale.x=this.selectionSprite.scale.y=this.selectionSprite.currentScale=1/r,BFN.Stage.render(this.selectionShape,this.selectionSprite.texture),this.painter.updatePrevTexture(),(BFN.ImagePainterUndoManager.regionIndex<0||BFN.ImagePainterUndoManager.regionIndex==0&&BFN.ImagePainterUndoManager.direction=="undo")&&(this.initialLumaColor=0,this.invertSelection&&(this.initialLumaColor=16777215,this.lumaTexture.fillColor(this.initialLumaColor))),this.selectionSprite.x=this.shapeBounds.minX,this.selectionSprite.y=this.shapeBounds.minY;let a=PIXI.RenderTexture.create(this.lumaTexture.width,this.lumaTexture.height);BFN.Stage.render(this.selectionSprite,a,!1),this.selectionSprite.texture.resize(1,1),this.processFeather(a),this.lumaTexture.copyPixels(a,null,!1,Math.max(0,Math.min(1,this.selectionStrength*.95+.05))),a.destroyGC(!0);let s={minX:this.shapeBounds.minX,minY:this.shapeBounds.minY,maxX:this.shapeBounds.maxX,maxY:this.shapeBounds.maxY};if(this.featherAmount){let o=Math.ceil(this.featherBase*.26*this.featherAmount);s.minX=Math.max(0,s.minX-o),s.minY=Math.max(0,s.minY-o),s.maxX=Math.min(this.lumaTexture.width,s.maxX+o),s.maxY=Math.min(this.lumaTexture.height,s.maxY+o)}this.painter.paintBounds=new PIXI.Rectangle(s.minX,s.minY,s.maxX-s.minX,s.maxY-s.minY),this.painter.dispatchEvent(BFN.ImagePainterEvents.PAINT_UPDATED)}}this.selectionCanvas.clear(),this.shapePoints.splice(0),this.selectionPoints.splice(0),this.shapeStartPoint=null,this.selectionStartPoint=null,this.snapPoint=null,BFN.TransformModel.layerItem?(BFN.alternateMenu.isDisabled=!1,UIToggler.toggleMainMenu(!0)):(UIToggler.toggleNavBar(!0),UIToggler.toggleMainMenu(!0),UIToggler.toggleZoomMenu(!0)),i&&this.updateCutoutTexture(),BFN.MainUI.off("pointermove",this.handleMouseMoveBind),BFN.MainUI.off("pointerup",this.handleMouseUpBind),BFN.MainUI.off("pointerupoutside",this.handleMouseUpBind),document.removeEventListener("keydown",this.handleKeyDownBind),document.removeEventListener("keyup",this.handleKeyUpBind),this.resetPressedKeys(),BFN.MainUI.requestRender(),this.cutoutActive=!1};Pe.prototype.startCircle=function(){this.shapeStartPoint=this.imageContainer.getPointerPosition(this.pointerEvent),this.selectionStartPoint=this.selectionCanvas.getPointerPosition(this.pointerEvent),this.cutoutActive=!0};Pe.prototype.moveCircle=function(){if(this.selectionStartPoint){let i=this.selectionCanvas.getPointerPosition(this.pointerEvent),e=Math.min(this.selectionStartPoint.x,i.x),t=Math.min(this.selectionStartPoint.y,i.y),r=Math.abs(this.selectionStartPoint.x-i.x),a=Math.abs(this.selectionStartPoint.y-i.y);this.shiftKey&&(r=a=Math.min(r,a),e=Math.max(e,this.selectionStartPoint.x-r),t=Math.max(t,this.selectionStartPoint.y-a)),this.selectionCanvas.clear(),this.selectionCanvas.lineStyle(1,16777215),this.selectionCanvas.drawEllipse(e+r/2,t+a/2,r/2,a/2)}};Pe.prototype.stopCircle=function(i=!0){if(i&&this.shapeStartPoint){let e=this.imageContainer.getPointerPosition(this.pointerEvent),t=Math.min(this.shapeStartPoint.x,e.x),r=Math.min(this.shapeStartPoint.y,e.y),a=Math.abs(this.shapeStartPoint.x-e.x),s=Math.abs(this.shapeStartPoint.y-e.y);if(this.shiftKey&&(a=s=Math.min(a,s),t=Math.max(t,this.shapeStartPoint.x-a),r=Math.max(r,this.shapeStartPoint.y-s)),this.shapeBounds.minX=t,this.shapeBounds.minY=r,this.shapeBounds.maxX=t+a,this.shapeBounds.maxY=r+s,a>0&&s>0){let o=2*Math.min(1,BFN.maxImageSize/(Math.max(a,s)*2));this.selectionShape.clear(),this.selectionShape.beginFill(this.invertSelection?0:16777215),this.selectionShape.drawEllipse((t+a/2)*o,(r+s/2)*o,a/2*o,s/2*o),this.selectionShape.endFill(),this.selectionShape.x=-(this.shapeBounds.minX*o),this.selectionShape.y=-(this.shapeBounds.minY*o),this.selectionSprite.texture.resize(Math.round(a*o),Math.round(s*o)),this.selectionSprite.anchor.x=this.selectionSprite.anchor.y=0,this.selectionSprite.scale.x=this.selectionSprite.scale.y=this.selectionSprite.currentScale=1/o,BFN.Stage.render(this.selectionShape,this.selectionSprite.texture),this.painter.updatePrevTexture(),(BFN.ImagePainterUndoManager.regionIndex<0||BFN.ImagePainterUndoManager.regionIndex==0&&BFN.ImagePainterUndoManager.direction=="undo")&&(this.initialLumaColor=0,this.invertSelection&&(this.initialLumaColor=16777215,this.lumaTexture.fillColor(this.initialLumaColor))),this.selectionSprite.x=this.shapeBounds.minX,this.selectionSprite.y=this.shapeBounds.minY;let n=PIXI.RenderTexture.create(this.lumaTexture.width,this.lumaTexture.height);BFN.Stage.render(this.selectionSprite,n,!1),this.selectionSprite.texture.resize(1,1),this.processFeather(n),this.lumaTexture.copyPixels(n,null,!1,Math.max(0,Math.min(1,this.selectionStrength*.95+.05))),n.destroyGC(!0);let l={minX:this.shapeBounds.minX,minY:this.shapeBounds.minY,maxX:this.shapeBounds.maxX,maxY:this.shapeBounds.maxY};if(this.featherAmount){let c=Math.ceil(this.featherBase*.26*this.featherAmount);l.minX=Math.max(0,l.minX-c),l.minY=Math.max(0,l.minY-c),l.maxX=Math.min(this.lumaTexture.width,l.maxX+c),l.maxY=Math.min(this.lumaTexture.height,l.maxY+c)}this.painter.paintBounds=new PIXI.Rectangle(l.minX,l.minY,l.maxX-l.minX,l.maxY-l.minY),this.painter.dispatchEvent(BFN.ImagePainterEvents.PAINT_UPDATED)}}this.selectionCanvas.clear(),this.shapeStartPoint=null,this.selectionStartPoint=null,i&&this.updateCutoutTexture(),BFN.MainUI.off("pointermove",this.handleMouseMoveBind),BFN.MainUI.off("pointerup",this.handleMouseUpBind),BFN.MainUI.off("pointerupoutside",this.handleMouseUpBind),document.removeEventListener("keydown",this.handleKeyDownBind),document.removeEventListener("keyup",this.handleKeyUpBind),this.resetPressedKeys(),BFN.MainUI.requestRender(),this.cutoutActive=!1};Pe.prototype.startRectangle=function(){this.shapeStartPoint=this.imageContainer.getPointerPosition(this.pointerEvent),this.selectionStartPoint=this.selectionCanvas.getPointerPosition(this.pointerEvent),this.cutoutActive=!0};Pe.prototype.moveRectangle=function(){if(this.selectionStartPoint){let i=this.selectionCanvas.getPointerPosition(this.pointerEvent),e=Math.min(this.selectionStartPoint.x,i.x),t=Math.min(this.selectionStartPoint.y,i.y),r=Math.abs(this.selectionStartPoint.x-i.x),a=Math.abs(this.selectionStartPoint.y-i.y);this.shiftKey&&(r=a=Math.min(r,a),e=Math.max(e,this.selectionStartPoint.x-r),t=Math.max(t,this.selectionStartPoint.y-a)),this.selectionCanvas.clear(),this.selectionCanvas.lineStyle(1,16777215),this.selectionCanvas.drawRect(e,t,r,a)}};Pe.prototype.stopRectangle=function(i=!0){if(i&&this.shapeStartPoint){let e=this.imageContainer.getPointerPosition(this.pointerEvent),t=Math.min(this.shapeStartPoint.x,e.x),r=Math.min(this.shapeStartPoint.y,e.y),a=Math.abs(this.shapeStartPoint.x-e.x),s=Math.abs(this.shapeStartPoint.y-e.y);if(this.shiftKey&&(a=s=Math.min(a,s),t=Math.max(t,this.shapeStartPoint.x-a),r=Math.max(r,this.shapeStartPoint.y-s)),this.shapeBounds.minX=t,this.shapeBounds.minY=r,this.shapeBounds.maxX=t+a,this.shapeBounds.maxY=r+s,a>0&&s>0){let o=2*Math.min(1,BFN.maxImageSize/(Math.max(a,s)*2));this.selectionShape.clear(),this.selectionShape.beginFill(this.invertSelection?0:16777215),this.selectionShape.drawRect(t*o,r*o,a*o,s*o),this.selectionShape.endFill(),this.selectionShape.x=-(this.shapeBounds.minX*o),this.selectionShape.y=-(this.shapeBounds.minY*o),this.selectionSprite.texture.resize(Math.round(a*o),Math.round(s*o)),this.selectionSprite.anchor.x=this.selectionSprite.anchor.y=0,this.selectionSprite.scale.x=this.selectionSprite.scale.y=this.selectionSprite.currentScale=1/o,BFN.Stage.render(this.selectionShape,this.selectionSprite.texture),this.painter.updatePrevTexture(),(BFN.ImagePainterUndoManager.regionIndex<0||BFN.ImagePainterUndoManager.regionIndex==0&&BFN.ImagePainterUndoManager.direction=="undo")&&(this.initialLumaColor=0,this.invertSelection&&(this.initialLumaColor=16777215,this.lumaTexture.fillColor(this.initialLumaColor))),this.selectionSprite.x=this.shapeBounds.minX,this.selectionSprite.y=this.shapeBounds.minY;let n=PIXI.RenderTexture.create(this.lumaTexture.width,this.lumaTexture.height);BFN.Stage.render(this.selectionSprite,n,!1),this.selectionSprite.texture.resize(1,1),this.processFeather(n),this.lumaTexture.copyPixels(n,null,!1,Math.max(0,Math.min(1,this.selectionStrength*.95+.05))),n.destroyGC(!0);let l={minX:this.shapeBounds.minX,minY:this.shapeBounds.minY,maxX:this.shapeBounds.maxX,maxY:this.shapeBounds.maxY};if(this.featherAmount){let c=Math.ceil(this.featherBase*.26*this.featherAmount);l.minX=Math.max(0,l.minX-c),l.minY=Math.max(0,l.minY-c),l.maxX=Math.min(this.lumaTexture.width,l.maxX+c),l.maxY=Math.min(this.lumaTexture.height,l.maxY+c)}this.painter.paintBounds=new PIXI.Rectangle(l.minX,l.minY,l.maxX-l.minX,l.maxY-l.minY),this.painter.dispatchEvent(BFN.ImagePainterEvents.PAINT_UPDATED)}}this.selectionCanvas.clear(),this.shapeStartPoint=null,this.selectionStartPoint=null,i&&this.updateCutoutTexture(),BFN.MainUI.off("pointermove",this.handleMouseMoveBind),BFN.MainUI.off("pointerup",this.handleMouseUpBind),BFN.MainUI.off("pointerupoutside",this.handleMouseUpBind),document.removeEventListener("keydown",this.handleKeyDownBind),document.removeEventListener("keyup",this.handleKeyUpBind),this.resetPressedKeys(),BFN.MainUI.requestRender(),this.cutoutActive=!1};Pe.prototype.applyBrush=function(i=!0){i?(this.painter.updatePrevTexture(),(BFN.ImagePainterUndoManager.regionIndex<0||BFN.ImagePainterUndoManager.regionIndex==0&&BFN.ImagePainterUndoManager.direction=="undo")&&(this.initialLumaColor=0,this.invertSelection&&(this.initialLumaColor=16777215,this.lumaTexture.fillColor(this.initialLumaColor))),this.lumaTexture.copyPixels(this.painter.texture,null,!1,Math.max(0,Math.min(1,this.selectionStrength*.95+.05)),null,this.invertSelection?0:16777215),this.painter.dispatchEvent(BFN.ImagePainterEvents.PAINT_UPDATED)):this.painter.cancelPaintStroke(),this.painter.clear(!1),i&&this.updateCutoutTexture(),BFN.MainUI.off("pointermove",this.handleMouseMoveBind),BFN.MainUI.off("pointerup",this.handleMouseUpBind),BFN.MainUI.off("pointerupoutside",this.handleMouseUpBind),document.removeEventListener("keydown",this.handleKeyDownBind),document.removeEventListener("keyup",this.handleKeyUpBind),this.resetPressedKeys(),BFN.MainUI.requestRender()};Pe.prototype.resetPressedKeys=function(){let i=this.pressedKeyCodes.length;for(;--i>-1;){let e=this.pressedKeyCodes[i];this.handleKeyUpBind({keyCode:e})}};Pe.prototype.calculateCutoutRect=function(){if(this.cutoutRect=new BFN.Rectangle(0,0,this.lumaTexture.width,this.lumaTexture.height),!this.lumaTexture)return;let e=Math.min(1,1024/Math.max(this.lumaTexture.width,this.lumaTexture.height)),t=this.lumaTexture;e<1&&(t=PIXI.RenderTexture.create(Math.round(this.lumaTexture.width*e),Math.round(this.lumaTexture.height*e)),t.copyPixels(this.lumaTexture,void 0,void 0,void 0,{x:t.width/this.lumaTexture.width,y:t.height/this.lumaTexture.height}));let r=BFN.Util.getAlphaBounds(t,void 0,1/e,!0,void 0,this.cutoutMaskFilter.inverse);t!==this.lumaTexture&&(t.destroyGC(!0),t=null),r.width&&r.height&&(this.cutoutRect.left=Math.round(r.left),this.cutoutRect.top=Math.round(r.top),this.cutoutRect.right=this.lumaTexture.width-Math.round(r.right),this.cutoutRect.bottom=this.lumaTexture.height-Math.round(r.bottom))};Pe.prototype.getCutoutTexture=function(i=!1){if(!this.lumaTexture)return null;this.showMask&&(this.showMask=!1,UITools.setToolValue("cutout","show_mask",!1),UITools.updateToolControl("cutout_show_mask"),this.updateCutoutTexture(),BFN.MainUI.requestRender());let e=new PIXI.Texture(this.cutoutTexture.baseTexture);return i&&(this.cutoutRect||this.calculateCutoutRect(),e.frame=new PIXI.Rectangle(this.cutoutRect.x,this.cutoutRect.y,this.cutoutRect.width,this.cutoutRect.height),e.orig=e.trim=new PIXI.Rectangle(0,0,this.cutoutRect.width,this.cutoutRect.height)),e};Pe.prototype.handleMouseOver=function(i){switch(this.selectionMode){case"magic_brush":BFN.CursorScreen.cursor="select_cross",BFN.BrushCircle.show(this.painter.brushRadius*this._scale,i,!0);break;case"lasso":BFN.CursorScreen.cursor="select_lasso";break;case"polygon":BFN.CursorScreen.cursor="select_poly";break;case"circle":BFN.CursorScreen.cursor="select_cross";break;case"rectangle":BFN.CursorScreen.cursor="select_cross";break;case"brush":break}};Pe.prototype.handleMouseOut=function(i){switch(this.selectionMode){case"magic_brush":BFN.BrushCircle.hide(!0);break}BFN.CursorScreen.cursor=null};Pe.prototype.handleMouseDown=function(i){if(i)this.pointerEvent=i;else if(this.pointerEvent)i=this.pointerEvent;else return;if(!(i&&i.data&&i.data.originalEvent&&i.data.originalEvent.button===2)){switch(this.invertSelection=i.data.originalEvent.altKey||this.erase,this.invertSelection=i.data.originalEvent.altKey&&this.erase?!1:this.invertSelection,this.invertSelection=this.inverse?!this.invertSelection:this.invertSelection,this.shiftKey=i.data.originalEvent.shiftKey,this.selectionMode){case"magic_brush":this.startQuickSelect(i);break;case"lasso":this.startLasso(i);break;case"polygon":break;case"circle":this.startCircle(i);break;case"rectangle":this.startRectangle(i);break;case"brush":break}BFN.MainUI.on("pointermove",this.handleMouseMoveBind),BFN.MainUI.on("pointerup",this.handleMouseUpBind),BFN.MainUI.on("pointerupoutside",this.handleMouseUpBind),document.addEventListener("keydown",this.handleKeyDownBind),document.addEventListener("keyup",this.handleKeyUpBind),BFN.MainUI.requestRender()}};Pe.prototype.handleMouseMove=function(i){if(i)this.pointerEvent=i;else if(this.pointerEvent)i=this.pointerEvent;else return;if(!this.spaceKey){switch(this.selectionMode){case"magic_brush":this.moveQuickSelect(i);break;case"lasso":this.moveLasso(i);break;case"polygon":this.movePolygon();break;case"circle":this.moveCircle(i);break;case"rectangle":this.moveRectangle(i);break;case"brush":break}BFN.MainUI.requestRender()}};Pe.prototype.handleMouseUp=function(i){if(i)this.pointerEvent=i;else if(this.pointerEvent)i=this.pointerEvent;else return;switch(this.shiftKey=i.data.originalEvent.shiftKey,this.selectionMode){case"magic_brush":this.stopQuickSelect();break;case"lasso":this.stopLasso();break;case"polygon":this.startPolygon();break;case"circle":this.stopCircle();break;case"rectangle":this.stopRectangle();break;case"brush":break}};Pe.prototype.handlePaintingComplete=function(i){this.applyBrush()};Pe.prototype.alternateHistoryAction=function(){return this.cutoutActive?(this.handleKeyDown({keyCode:27}),!0):!1};Pe.prototype.handleKeyDown=function(i){if(this.pressedKeyCodes.indexOf(i.keyCode)==-1){switch(this.pressedKeyCodes.push(i.keyCode),i.keyCode){case 16:this.shiftKey=!0,this.handleMouseMoveBind();break;case 32:this.spaceKey=!0,BFN.PhotoEditorCanvasTools.dispatchEvent(BFN.PhotoEditorCanvasToolsEvents.START_CANVAS_DRAG);break;case 27:switch(this.pressedKeyCodes.splice(this.pressedKeyCodes.indexOf(27),1),this.selectionMode){case"magic_brush":this.stopQuickSelect(!1);break;case"lasso":this.stopLasso(!1);break;case"polygon":this.stopPolygon(!1);break;case"circle":this.stopCircle(!1);break;case"rectangle":this.stopRectangle(!1);break;case"brush":this.applyBrush(!1);break}break}this.painter.ignoreMouseMove=this.spaceKey}};Pe.prototype.handleKeyUp=function(i){let e=this.pressedKeyCodes.indexOf(i.keyCode);if(e>=0){switch(this.pressedKeyCodes.splice(e,1),i.keyCode){case 16:this.shiftKey=!1,this.handleMouseMoveBind();break;case 32:this.spaceKey=!1,BFN.PhotoEditorCanvas.canvasDragger.stopDrag();break}this.painter.ignoreMouseMove=this.spaceKey}};Pe.prototype.handleAltTextureUpdated=function(i){!BFN.ImagePainterUndoManager.undoExists&&!BFN.ImagePainterUndoManager.memoryFreed&&this.resetLumaTexture(),this.updateCutoutTexture()};Pe.prototype.handleCanvasScalingUpdated=function(i){this.selectionMode=="magic_brush"&&BFN.BrushCircle.showing&&!BFN.PhotoEditorCanvasModel.canvasScaling&&BFN.BrushCircle.show(this.painter.brushRadius*this._scale,this.pointerEvent,!0)};Object.defineProperty(Pe.prototype,"toolScale",{set(i){this._scale=i,this.painter.toolScale=this._scale,this.selectionCanvas.scale.x=this.selectionCanvas.scale.y=1/this._scale,this.cutoutSprite.currentScale=this._scale},get(){return this._scale}});Object.defineProperty(Pe.prototype,"modifiedTexture",{get(){return this.getCutoutTexture(this.trimTransparency).renderClone()}});Object.defineProperty(BFN,"ImageCutout",{get(){return BFN._ImageCutout||(BFN._ImageCutout=new Pe),BFN._ImageCutout}});function Et(){PIXI.Sprite.call(this),this.init()}Et.prototype=Object.create(PIXI.Sprite.prototype);Et.prototype.init=function(){BeFunky.log("ImageRotator Init"),this.initDefaultValues(),this.initCanvas(),this.initImage(),this.initGrid(),this.initRotatorMask(),this.initGridAnimator(),this.updateGridDisplay()};Et.prototype.initDefaultValues=function(){this.sourceTexture=null,this._scale=1,this.straightening=!1,this.straightenAngle=0,this.imageWidth=0,this.imageHeight=0,this.itemWidth=0,this.itemHeight=0,this.gridSegmentSize=40,this.rightAngleIndex=0,this.adjustedImageWidth=0,this.adjustedImageHeight=0,this.adjustedImageCenterBeta=0,this.imageCenterBeta=0,this.imageRadius=0,this.imageBetaOffset=0,this.cropScale=0,this.cropWidth=0,this.cropHeight=0};Et.prototype.initCanvas=function(){this.canvas=new PIXI.Container,this.addChild(this.canvas)};Et.prototype.initImage=function(){this.imageContainer=new PIXI.Container,this.canvas.addChild(this.imageContainer),this.image=new PIXI.Sprite,this.imageContainer.addChild(this.image)};Et.prototype.initGrid=function(){this.grid=new PIXI.Graphics,this.addChild(this.grid)};Et.prototype.initRotatorMask=function(){this.rotatorMask=new PIXI.Graphics,this.addChild(this.rotatorMask),this.mask=this.rotatorMask};Et.prototype.initGridAnimator=function(){this.gridAnimator=new BFN.Animator,this.gridAnimator.addEventListener(BFN.AnimatorEvents.UPDATE.type,this.handleGridAnimatorUpdate.bind(this))};Et.prototype.handleRotate=function(){if(BFN.PhotoEditorCanvasModel.viewState==BFN.PhotoEditorCanvasModelViewStates.VIEWING_ROTATE){let i=UITools.getToolVO("rotate");switch(i.updating_id){case"rotate_clockwise":case"rotate_counter_clockwise":case"flip_horizontal":case"flip_vertical":this.performRotateAction(i.updating_id);break;case"straighten":this.straightenAngle=i.straighten*(Math.PI/180),this.updateStraightening(),!this.straightening&&i.updating?(this.straightening=!0,this.gridAnimator.increase()):this.straightening&&!i.updating&&(this.straightening=!1,this.gridAnimator.decrease());break}}};Et.prototype.setSourceTexture=function(i){this.reset(),i&&(this.sourceTexture=i,this.image.texture=this.sourceTexture,this.setupRotator())};Et.prototype.setupRotator=function(){UITools.setToolValue("rotate","straighten",0),UITools.updateToolControl("rotate_straighten"),this.imageWidth=this.adjustedImageWidth=this.sourceTexture?this.sourceTexture.width:0,this.imageHeight=this.adjustedImageHeight=this.sourceTexture?this.sourceTexture.height:0,this.image.x=-(this.imageWidth/2),this.image.y=-(this.imageHeight/2),this.image.scale.x=1,this.image.scale.y=1,this.image.rotation=0,this.straightenAngle=0,this.rightAngleIndex=0,this.imageCenterBeta=this.adjustedImageCenterBeta=Math.atan2(this.imageHeight,this.imageWidth),this.imageRadius=Math.sqrt(Math.pow(this.imageWidth/2,2)+Math.pow(this.imageHeight/2,2)),this.updateStraightening(),this.drawRotatorMask(),this.drawGrid()};Et.prototype.performRotateAction=function(i){switch(i){case"rotate_clockwise":this.rightAngleIndex=(this.rightAngleIndex+1)%4;break;case"rotate_counter_clockwise":this.rightAngleIndex=(this.rightAngleIndex+4-1)%4;break;case"flip_horizontal":this.image.scale.x*=this.rightAngleIndex%2?1:-1,this.image.scale.y*=this.rightAngleIndex%2?-1:1;break;case"flip_vertical":this.image.scale.x*=this.rightAngleIndex%2?-1:1,this.image.scale.y*=this.rightAngleIndex%2?1:-1;break}this.image.rotation=this.rightAngleIndex*(Math.PI/2),this.imageBetaOffset=0,this.image.scale.x==-1&&this.image.scale.y==-1?this.imageBetaOffset=Math.PI:this.image.scale.x==-1?this.imageBetaOffset=Math.PI-this.imageCenterBeta*2:this.image.scale.y==-1&&(this.imageBetaOffset=-(this.imageCenterBeta*2)),this.image.x=-(Math.cos(this.imageCenterBeta+this.image.rotation+this.imageBetaOffset)*this.imageRadius),this.image.y=-(Math.sin(this.imageCenterBeta+this.image.rotation+this.imageBetaOffset)*this.imageRadius),this.updateStraightening(),this.drawRotatorMask(),BFN.MainUI.requestRender()};Et.prototype.updateStraightening=function(){this.adjustedImageWidth=this.rightAngleIndex%2?this.imageHeight:this.imageWidth,this.adjustedImageHeight=this.rightAngleIndex%2?this.imageWidth:this.imageHeight,this.adjustedImageCenterBeta=Math.atan2(this.adjustedImageHeight,this.adjustedImageWidth),this.imageContainer.rotation=this.straightenAngle;let i=this.imageContainer.rotation,e=Math.abs(i),t=this.adjustedImageWidth>this.adjustedImageHeight?this.adjustedImageCenterBeta:Math.PI/2-this.adjustedImageCenterBeta,r=Math.PI-t-e,a=Math.sin(r)?Math.sin(t)*this.imageRadius/Math.sin(r):this.imageRadius;this.cropScale=a/this.imageRadius,this.cropWidth=Math.round(this.adjustedImageWidth*this.cropScale),this.cropHeight=Math.round(this.adjustedImageHeight*this.cropScale),this.rotatorMask.scale.x=this.rotatorMask.scale.y=this.cropScale,this.itemWidth=this.cropWidth,this.itemHeight=this.cropHeight,BFN.PhotoEditorCanvasTools.dispatchEvent(BFN.PhotoEditorCanvasToolsEvents.TOOL_DIMENSIONS_UPDATED),BFN.MainUI.requestRender()};Et.prototype.drawRotatorMask=function(){this.rotatorMask.clear(),this.rotatorMask.beginFill(16777215),this.rotatorMask.drawRect(-(this.adjustedImageWidth/2),-(this.adjustedImageHeight/2),this.adjustedImageWidth,this.adjustedImageHeight),this.rotatorMask.endFill()};Et.prototype.drawGrid=function(){if(this.sourceTexture){this.grid.scale.x=this.grid.scale.y=1/this._scale,this.gridSegmentSize=Math.round(Math.max(40,Math.round(Math.max(this.imageWidth,this.imageHeight)/20))*this._scale);let i=Math.ceil(Math.max(this.imageWidth,this.imageHeight)/this.gridSegmentSize)+2;i+=i%2?0:1,this.grid.clear();for(let e=0;e<i;e++){let t=Math.floor((i-1)/2*this.gridSegmentSize),r=Math.floor(e*this.gridSegmentSize-t);this.grid.lineStyle(3,0,.5),this.grid.moveTo(-t,r),this.grid.lineTo(t,r),this.grid.moveTo(r,-t),this.grid.lineTo(r,t)}for(let e=0;e<i;e++){let t=Math.floor((i-1)/2*this.gridSegmentSize),r=Math.floor(e*this.gridSegmentSize-t);this.grid.lineStyle(1,16777215,.5),this.grid.moveTo(-t,r),this.grid.lineTo(t,r),this.grid.moveTo(r,-t),this.grid.lineTo(r,t)}}};Et.prototype.updateGridDisplay=function(){this.grid.alpha=this.gridAnimator.animationFactor,this.grid.visible=this.grid.alpha>0};Et.prototype.reset=function(){this.sourceTexture!=null&&(this.sourceTexture=null),this.image.texture=PIXI.Texture.EMPTY};Et.prototype.handleGridAnimatorUpdate=function(i){this.updateGridDisplay()};Object.defineProperty(Et.prototype,"toolScale",{set:function(i){this._scale=i,this.drawGrid()},get:function(){return this._scale}});Object.defineProperty(Et.prototype,"modifiedTexture",{get:function(){let i=PIXI.RenderTexture.create(Math.round(this.cropWidth),Math.round(this.cropHeight));return this.canvas.x=i.width/2,this.canvas.y=i.height/2,BFN.Stage.render(this.canvas,i),this.canvas.x=this.canvas.y=0,i}});Object.defineProperty(BFN,"ImageRotator",{get:function(){return BFN._ImageRotator||(BFN._ImageRotator=new Et),BFN._ImageRotator}});function fi(){PIXI.Sprite.call(this),this.init()}fi.prototype=Object.create(PIXI.Sprite.prototype);fi.prototype.init=function(){BeFunky.log("ImageResize Init"),this.initDefaultValues(),this.initDisplay()};fi.prototype.initDefaultValues=function(){this.sourceTexture=null,this._scale=1,this._scaling=!1,this.resizeWidth=0,this.resizeHeight=0,this.imageWidth=0,this.imageHeight=0,this.itemWidth=0,this.itemHeight=0,this.lockAspectRatio=!0,this.aspectRatio=1};fi.prototype.initDisplay=function(){this.imageContainer=new PIXI.Container,this.addChild(this.imageContainer),this.image=new PIXI.Sprite,this.image.pluginName="smooth_picture",this.imageContainer.addChild(this.image)};fi.prototype.handleResize=function(){if(BFN.PhotoEditorCanvasModel.viewState==BFN.PhotoEditorCanvasModelViewStates.VIEWING_RESIZE){let i=UITools.getToolVO("resize");if(this.lockAspectRatio!=i.lock_aspect_ratio&&(this.lockAspectRatio=i.lock_aspect_ratio,this.lockAspectRatio&&(this.aspectRatio=this.resizeHeight/this.resizeWidth)),this.lockAspectRatio){let r=Math.floor(BFN.maxImageSize/(this.aspectRatio<1?1:this.aspectRatio)),a=Math.floor(BFN.maxImageSize*(this.aspectRatio<1?this.aspectRatio:1));switch(i.updating_id){case"resize_width":{this.resizeHeight=Math.max(BFN.minImageSize,Math.min(a,i.resize_width*this.aspectRatio)),this.resizeWidth=this.resizeHeight/this.aspectRatio;break}case"resize_height":{this.resizeWidth=Math.max(BFN.minImageSize,Math.min(r,i.resize_height/this.aspectRatio)),this.resizeHeight=this.resizeWidth*this.aspectRatio;break}case"resize_xscale":{i.updating&&(this.updatingScaleX=i.resize_xscale);let s=(this.updatingScaleX||i.resize_xscale)/100;this.resizeHeight=Math.max(BFN.minImageSize,Math.min(a,s*this.imageWidth*this.aspectRatio)),this.resizeWidth=this.resizeHeight/this.aspectRatio,i.updating||delete this.updatingScaleX;break}case"resize_yscale":{i.updating&&(this.updatingScaleY=i.resize_yscale);let s=(this.updatingScaleY||i.resize_yscale)/100;this.resizeWidth=Math.max(BFN.minImageSize,Math.min(r,s*this.imageHeight/this.aspectRatio)),this.resizeHeight=this.resizeWidth*this.aspectRatio,i.updating||delete this.updatingScaleY;break}}}else switch(i.updating_id){case"resize_width":case"resize_height":{this.resizeWidth=Math.max(BFN.minImageSize,Math.min(BFN.maxImageSize,i.resize_width)),this.resizeHeight=Math.max(BFN.minImageSize,Math.min(BFN.maxImageSize,i.resize_height));break}case"resize_xscale":case"resize_yscale":{i.updating&&(this.updatingScaleX=i.resize_xscale,this.updatingScaleY=i.resize_yscale);let r=(this.updatingScaleX||i.resize_xscale)/100,a=(this.updatingScaleY||i.resize_yscale)/100;this.resizeWidth=Math.max(BFN.minImageSize,Math.min(BFN.maxImageSize,r*this.imageWidth)),this.resizeHeight=Math.max(BFN.minImageSize,Math.min(BFN.maxImageSize,a*this.imageHeight)),i.updating||(delete this.updatingScaleX,delete this.updatingScaleY);break}}this.image.isResize=!i.updating,this.resizeWidth=Math.round(this.resizeWidth),this.resizeHeight=Math.round(this.resizeHeight),UITools.setToolValue("resize","resize_width",this.resizeWidth),UITools.setToolValue("resize","resize_height",this.resizeHeight);let e=this.resizeWidth===BFN.maxImageSize?"ceil":"round",t=this.resizeWidth===BFN.maxImageSize?"ceil":"round";UITools.setToolValue("resize","resize_xscale",Math[e](this.resizeWidth/this.imageWidth*100)),UITools.setToolValue("resize","resize_yscale",Math[t](this.resizeHeight/this.imageHeight*100)),UITools.updateToolControls("resize"),this.updateSize()}};fi.prototype.setSourceTexture=function(i){this.reset(),i&&(this.sourceTexture=i,this.image.texture=this.sourceTexture,this.image.isResize=!0,this.setupResizer(),UITools.setToolValue("resize","resize_width",this.imageWidth),UITools.setToolValue("resize","resize_height",this.imageHeight),UITools.setToolValue("resize","resize_xscale",100),UITools.setToolValue("resize","resize_yscale",100),UITools.setToolValue("resize","lock_aspect_ratio",!0),UITools.updateToolControls("resize"))};fi.prototype.setupResizer=function(){this.imageWidth=this.resizeWidth=this.sourceTexture?this.sourceTexture.width:0,this.imageHeight=this.resizeHeight=this.sourceTexture?this.sourceTexture.height:0,this.lockAspectRatio=!1,this.updateSize(),this.updateScaleBounds()};fi.prototype.updateSize=function(){this.imageContainer.x=-Math.round(this.imageWidth/2)+(this.imageWidth-this.resizeWidth)/2,this.imageContainer.y=-Math.round(this.imageHeight/2)+(this.imageHeight-this.resizeHeight)/2,this.image.scale.x=this.resizeWidth/this.imageWidth,this.image.scale.y=this.resizeHeight/this.imageHeight,this.itemWidth=this.resizeWidth,this.itemHeight=this.resizeHeight,this.updateSmoothing(),BFN.PhotoEditorCanvasTools.dispatchEvent(BFN.PhotoEditorCanvasToolsEvents.TOOL_DIMENSIONS_UPDATED),BFN.MainUI.requestRender()};fi.prototype.updateScaleBounds=function(){let i=UITools.getParamObject("resize_resize_xscale");i.min=Math.floor(BFN.minImageSize/this.imageWidth*100),i.max=Math.ceil(BFN.maxImageSize/this.imageWidth*100);let e=UITools.getParamObject("resize_resize_yscale");e.min=Math.floor(BFN.minImageSize/this.imageHeight*100),e.max=Math.ceil(BFN.maxImageSize/this.imageHeight*100)};fi.prototype.updateSmoothing=function(i){i==null&&(i=!0),this.image.currentScale=i?this.image.scale.x*this._scale:this.image.scale.x,this.image.currentScaleY=i?this.image.scale.y*this._scale:this.image.scale.y};fi.prototype.reset=function(){this.sourceTexture!=null&&(this.sourceTexture=null),this.image.texture=PIXI.Texture.EMPTY};Object.defineProperty(fi.prototype,"toolScale",{set:function(i){this._scale=i,this.updateSmoothing()},get:function(){return this._scale}});Object.defineProperty(fi.prototype,"toolScaling",{set:function(i){this._scaling=i,this.image.isResize=!this._scaling},get:function(){return this._scaling}});Object.defineProperty(fi.prototype,"modifiedTexture",{get:function(){let i=PIXI.RenderTexture.create(Math.round(this.resizeWidth),Math.round(this.resizeHeight));return this.updateSmoothing(!1),this.imageContainer.x=0,this.imageContainer.y=0,this.image.isResize=!0,BFN.Stage.render(this.imageContainer,i),this.updateSize(),i}});Object.defineProperty(BFN,"ImageResize",{get:function(){return BFN._ImageResize||(BFN._ImageResize=new fi),BFN._ImageResize}});function wi(){PIXI.Sprite.call(this),this.init()}wi.prototype=Object.create(PIXI.Sprite.prototype);wi.prototype.init=function(){BeFunky.log("ImageSlimming Init"),this.initDefaultValues(),this.initDisplay()};wi.prototype.initDefaultValues=function(){this.sourceTexture=null,this._scale=1,this.slimmingWidth=0,this.imageWidth=0,this.itemWidth=0,this.itemHeight=0,this.slimmingAmount=1,this.slimmingFactor=1};wi.prototype.initDisplay=function(){this.imageContainer=new PIXI.Container,this.addChild(this.imageContainer),this.image=new PIXI.Sprite,this.image.pluginName="blend_picture",this.imageContainer.addChild(this.image)};wi.prototype.handleSlimming=function(){if(BFN.PhotoEditorCanvasModel.viewState==BFN.PhotoEditorCanvasModelViewStates.VIEWING_SLIMMING){let i=UITools.getToolVO("slimming");this.slimmingAmount=i.amount/100,this.updateSize()}};wi.prototype.setSourceTexture=function(i){this.reset(),i&&(this.sourceTexture=i,this.image.texture=this.sourceTexture,this.setupSlimming(),UITools.setToolValue("slimming","amount",Math.round(this.slimmingAmount*100)),UITools.updateToolControls("slimming"))};wi.prototype.setupSlimming=function(){this.imageWidth=this.slimmingWidth=this.sourceTexture?this.sourceTexture.width:0,this.imageHeight=this.sourceTexture?this.sourceTexture.height:0,this.slimmingAmount=.3,this.updateSize()};wi.prototype.updateSize=function(){this.slimmingFactor=1-this.slimmingAmount*.05,this.slimmingWidth=Math.round(this.slimmingFactor*this.imageWidth),this.imageContainer.x=-Math.round(this.imageWidth/2)+(this.imageWidth-this.slimmingWidth)/2,this.imageContainer.y=-Math.round(this.imageHeight/2),this.image.scale.x=this.slimmingWidth/this.imageWidth,this.itemWidth=this.slimmingWidth,this.itemHeight=this.imageHeight,this.updateSmoothing(),BFN.PhotoEditorCanvasTools.dispatchEvent(BFN.PhotoEditorCanvasToolsEvents.TOOL_DIMENSIONS_UPDATED)};wi.prototype.updateSmoothing=function(i){i==null&&(i=!0),this.image.currentScale=i?this.image.scale.x*this._scale:this.image.scale.x,this.image.currentScaleY=i?this._scale:1};wi.prototype.reset=function(){this.sourceTexture!=null&&(this.sourceTexture=null),this.image.texture=PIXI.Texture.EMPTY};Object.defineProperty(wi.prototype,"toolScale",{set:function(i){this._scale=i,this.updateSmoothing()},get:function(){return this._scale}});Object.defineProperty(wi.prototype,"modifiedTexture",{get:function(){let i=PIXI.RenderTexture.create(Math.round(this.slimmingWidth),Math.round(this.imageHeight));return this.updateSmoothing(!1),this.imageContainer.x=0,this.imageContainer.y=0,BFN.Stage.render(this.imageContainer,i),this.updateSize(),i}});Object.defineProperty(BFN,"ImageSlimming",{get:function(){return BFN._ImageSlimming||(BFN._ImageSlimming=new wi),BFN._ImageSlimming}});function xt(){PIXI.Sprite.call(this),this.init()}xt.prototype=Object.create(PIXI.Sprite.prototype);xt.prototype.init=function(){BeFunky.log("ImageReshape Init"),this.initDefaultValues(),this.initImageContainer(),this.initDisplay()};xt.prototype.initDefaultValues=function(){this.sourceTexture=null,this.sourceTextureLoRes=null,this.resultTexture=null,this._scale=1,this.blurAmount=.4,this.draftResolution=1,this.draftActive=!1,this.renderPending=!1,this.workingTextureMaxSide=1024,this.displacementResizeFactor=1,this.liquifyBrushFilter=new BFN.filters.LiquifyBrushFilter,this.blurFilter=new BFN.filters.FastBlurWrapper,this.displacementFilter=new BFN.filters.DisplacementFilter,this.handleAltBitmapDataUpdatedBind=this.handleAltBitmapDataUpdated.bind(this),this.handleMainUIPreRenderBind=this.handleMainUIPreRender.bind(this)};xt.prototype.initImageContainer=function(){this.imageContainer=new PIXI.Container,this.addChild(this.imageContainer)};xt.prototype.initDisplay=function(){this.brushPixelSourceTexture=null,this.brushPixelSourceSprite=new PIXI.Sprite,this.brushPixelSourceRendereredTexture=null,this.brushPixelSourceRendereredSprite=new PIXI.Sprite,this.sourceSprite=new PIXI.Sprite,this.resultSprite=new PIXI.Sprite,this.resultSprite.pluginName="smooth_picture",this.imageContainer.addChild(this.resultSprite),this.displacementTexture=null,this.displacementSprite=new PIXI.Sprite,this.displacementBlurredTexture=null,this.displacementBlurredSprite=new PIXI.Sprite,this.painter=new BFN.ImagePainter,this.painter.brushEnabled=!1,this.painter.brushHardnessFactor=0,this.painter.staggerInterval=25,this.painter.scaleAffectsBrushRadius=!1,this.painter.minHistoryResolution=1,this.painter.addEventListener(BFN.ImagePainterEvents.BRUSH_APPLIED.type,this.handleBrushApplied.bind(this)),this.painter.addEventListener(BFN.ImagePainterEvents.PAINTING_STARTED.type,this.handlePaintingStarted.bind(this)),this.painter.addEventListener(BFN.ImagePainterEvents.PAINTING_COMPLETE.type,this.handlePaintingComplete.bind(this)),this.imageContainer.addChild(this.painter)};xt.prototype.handleReshape=function(){if(BFN.PhotoEditorCanvasModel.viewState==BFN.PhotoEditorCanvasModelViewStates.VIEWING_RESHAPE){let i=UITools.getToolVO("reshape"),e=!1;if(i.updating_id=="reset")this.painter.clear(),this.displacementTexture.fillRect(0,0,this.displacementTexture.width,this.displacementTexture.height,32896,1),this.displacementBlurredTexture.copyPixels(this.displacementTexture),e=!0,i.mode=="erase"&&(UITools.setToolValue("reshape","mode","smudge"),UITools.updateToolControl("reshape_mode"),this.liquifyBrushFilter.mode=i.mode);else{let t=i.brush_size/100*.6+.15;i.updating&&i.updating_id=="brush_size"&&this.painter.brushSizeFactor!=t&&(this.painter.brushSizeFactor=t),!i.updating&&(i.updating_id=="brush_size"||this.painter.brushSizeFactor!=t||this.painter.brushSizeChanged)&&(this.painter.brushSizeFactor=t,this.painter.updateBrush(),this.updateBrushPixelSource()),this.liquifyBrushFilter.pressure=i.pressure/100,this.liquifyBrushFilter.mode=i.mode,this.painter.ignoreInitialPress=i.mode=="smudge",this.painter.staggerEnabled=i.mode!="smudge";let r=i.strength/100;r!=this.displacementFilter.strength&&(e=!0),this.displacementFilter.strength=r}i.updating_id=="strength"&&this.draftActive!=i.updating&&(e=!1,this.toggleDraft(i.updating)),e&&(this.renderPending=!0,BFN.MainUI.requestRender())}};xt.prototype.reset=function(){this.sourceTexture!=null&&(this.sourceTexture=null);try{this.sourceTextureLoRes.destroyGC(!0)}catch(i){}this.sourceTextureLoRes=null,this.sourceSprite.texture=PIXI.Texture.EMPTY;try{this.resultTexture.destroyGC(!0)}catch(i){}this.resultTexture=null,this.sourceSprite.texture=PIXI.Texture.EMPTY;try{this.displacementTexture.destroyGC(!0)}catch(i){}this.displacementTexture=null,this.displacementSprite.texture=PIXI.Texture.EMPTY;try{this.displacementBlurredTexture.destroyGC(!0)}catch(i){}this.displacementBlurredTexture=null,this.displacementBlurredSprite.texture=PIXI.Texture.EMPTY,this.painter.altTexture=null,BFN.ImagePainterUndoManager.removeEventListener(BFN.ImagePainterUndoManagerEvents.ALT_TEXTURE_UPDATED.type,this.handleAltBitmapDataUpdatedBind),BFN.MainUI.removeEventListener(BFN.MainUIEvents.PRE_RENDER.type,this.handleMainUIPreRenderBind)};xt.prototype.setSourceTexture=function(i){if(this.reset(),i){this.sourceTexture=i;let e=this.sourceTexture.width*this.sourceTexture.height;e>3072**2?this.draftResolution=.25:e>2048**2?this.draftResolution=.5:this.draftResolution=1,this.sourceTextureLoRes=PIXI.RenderTexture.create(this.sourceTexture.width,this.sourceTexture.height,void 0,this.draftResolution),this.sourceTextureLoRes.copyPixels(this.sourceTexture),this.imageContainer.x=-Math.round(this.sourceTexture.width/2),this.imageContainer.y=-Math.round(this.sourceTexture.height/2),this.displacementResizeFactor=Math.min(1,this.workingTextureMaxSide/Math.max(this.sourceTexture.width,this.sourceTexture.height)),this.resultTexture=this.sourceTexture.renderClone(),this.resultTexture.clear(),this.displacementTexture=PIXI.RenderTexture.create(Math.floor(this.sourceTexture.width*this.displacementResizeFactor),Math.floor(this.sourceTexture.height*this.displacementResizeFactor)),this.displacementTexture.fillColor(32896),this.displacementBlurredTexture=this.displacementTexture.renderClone(),this.sourceSprite.texture=this.sourceTexture,this.resultSprite.texture=this.resultTexture,this.displacementSprite.texture=this.displacementTexture,this.displacementBlurredSprite.texture=this.displacementBlurredTexture,this.displacementFilter.inputSprite=this.sourceSprite,this.displacementFilter.iChannel1=this.displacementBlurredTexture,this.sourceSprite.filters=[this.displacementFilter],this.painter.altTexture=this.displacementTexture,BFN.ImagePainterUndoManager.addEventListener(BFN.ImagePainterUndoManagerEvents.ALT_TEXTURE_UPDATED.type,this.handleAltBitmapDataUpdatedBind),BFN.MainUI.addEventListener(BFN.MainUIEvents.PRE_RENDER.type,this.handleMainUIPreRenderBind),UITools.setToolValue("reshape","pressure",50),UITools.setToolValue("reshape","brush_size",50),UITools.setToolValue("reshape","strength",100),UITools.setToolValue("reshape","mode","smudge"),UITools.updateToolControls("reshape"),BFN.Stage.render(this.sourceSprite,this.resultTexture),this.renderPending=!0,BFN.MainUI.requestRender()}else this.imageContainer.x=0,this.imageContainer.y=0,this.blurFilter.dispose();this.updatePainter()};xt.prototype.toggleDraft=function(i){this.draftActive!==i&&(this.draftActive=i,BFN.StageModel.setRefreshFactor(i?.5:1),this.sourceSprite.texture=i?this.sourceTextureLoRes:this.sourceTexture,this.renderPending=!0,BFN.MainUI.requestRender())};xt.prototype.updateSmoothing=function(){this.resultSprite.currentScale=this._scale};xt.prototype.updateItemDimensions=function(){this.sourceTexture&&(this.itemWidth=Math.floor(this.sourceTexture.width-2/this._scale),this.itemHeight=Math.floor(this.sourceTexture.height-2/this._scale))};xt.prototype.updateBrushPixelSource=function(){try{this.brushPixelSourceTexture.destroyGC(!0)}catch(i){}this.brushPixelSourceTexture=PIXI.RenderTexture.create(Math.round(this.painter.brush.texture.width),this.painter.brush.texture.height),this.brushPixelSourceTexture.fillRect(0,0,this.brushPixelSourceTexture.width,this.brushPixelSourceTexture.height,16777215,1),this.brushPixelSourceSprite.texture=this.brushPixelSourceTexture;try{this.brushPixelSourceRendereredTexture.destroyGC(!0)}catch(i){}this.brushPixelSourceRendereredTexture=PIXI.RenderTexture.create(this.brushPixelSourceTexture.width,this.brushPixelSourceTexture.height),this.brushPixelSourceRendereredTexture.fillRect(0,0,this.brushPixelSourceRendereredTexture.width,this.brushPixelSourceRendereredTexture.height,16777215,1),this.brushPixelSourceRendereredSprite.texture=this.brushPixelSourceRendereredTexture,this.liquifyBrushFilter.vTextureCoordMax=this.brushPixelSourceTexture.width/BFN.FilterHelper.getNextPowerOfTwo(this.brushPixelSourceTexture.width),this.brushPixelSourceSprite.filters=[this.liquifyBrushFilter]};xt.prototype.applyBrush=function(){if(this.displacementTexture){let i=this.painter.brushRect;this.brushPixelSourceTexture.copyPixels(this.displacementTexture,new PIXI.Point(-i.x,-i.y),!0),this.brushPixelSourceRendereredSprite.x=i.x,this.brushPixelSourceRendereredSprite.y=i.y,this.liquifyBrushFilter.beta=this.painter.brushBeta,BFN.Stage.render(this.brushPixelSourceSprite,this.brushPixelSourceRendereredTexture,!0),this.displacementTexture.fillRect(i.x,i.y,this.brushPixelSourceTexture.width,this.brushPixelSourceTexture.height,16711680,.5),BFN.Stage.render(this.brushPixelSourceRendereredSprite,this.displacementTexture,!1);let e=this.blurFilter.render(this.blurAmount,this.displacementTexture);this.displacementBlurredTexture.copyPixels(e),this.renderPending=!0,BFN.MainUI.requestRender()}};xt.prototype.updatePainter=function(){this.sourceTexture?((this.painter.painterWidth!=this.displacementTexture.width||this.painter.painterHeight!=this.displacementTexture.height)&&this.painter.setup(this.displacementTexture.width,this.displacementTexture.height),this.painter.scale.x=this.painter.scale.y=1/this.displacementResizeFactor,this.updatePainterToolScale()):this.painter.reset()};xt.prototype.updatePainterToolScale=function(){this.painter.toolScale=this._scale/this.displacementResizeFactor};xt.prototype.handleBrushApplied=function(){this.applyBrush()};xt.prototype.handleAltBitmapDataUpdated=function(i){BFN.Stage.render(this.displacementSprite,this.displacementBlurredTexture,!0);let e=this.blurFilter.render(this.blurAmount,this.displacementTexture);this.displacementBlurredTexture.copyPixels(e),this.renderPending=!0,BFN.MainUI.requestRender()};xt.prototype.handleMainUIPreRender=function(i){this.renderPending&&(this.renderPending=!1,BFN.Stage.render(this.sourceSprite,this.resultTexture))};xt.prototype.handlePaintingStarted=function(i){this.toggleDraft(!0)};xt.prototype.handlePaintingComplete=function(i){this.toggleDraft(!1)};Object.defineProperty(xt.prototype,"toolScale",{set:function(i){this._scale=i,this.updatePainterToolScale(),this.updateSmoothing(),this.updateItemDimensions()},get:function(){return this._scale}});Object.defineProperty(xt.prototype,"modifiedTexture",{get:function(){return this.resultTexture.renderClone()}});Object.defineProperty(BFN,"ImageReshape",{get:function(){return BFN._ImageReshape||(BFN._ImageReshape=new xt),BFN._ImageReshape}});function sr(){PIXI.Sprite.call(this),this.init()}sr.prototype=Object.create(PIXI.Sprite.prototype);sr.prototype.init=function(){BeFunky.log("ImageTilter Init"),this.initDefaultValues(),this.initDisplay()};sr.prototype.initDefaultValues=function(){this.sourceTexture=null,this._scale=1,this.itemWidth=this.imageContainerWidth=0,this.itemHeight=this.imageContainerHeight=0};sr.prototype.initDisplay=function(){this.imageContainer=new PIXI.Container,this.addChild(this.imageContainer),this.imageBackground=new PIXI.Graphics,this.imageContainer.addChild(this.imageBackground),this.imageCenterContainer=new PIXI.Container,this.imageContainer.addChild(this.imageCenterContainer),this.image=new PIXI.Sprite,this.image.pluginName="smooth_picture",this.imageCenterContainer.addChild(this.image)};sr.prototype.handleTilt=function(){if(this.sourceTexture&&BFN.PhotoEditorCanvasModel.viewState==BFN.PhotoEditorCanvasModelViewStates.VIEWING_TILT){let i=UITools.getToolVO("tilt"),e=i.tilt_amount,t=Math.abs(e*(Math.PI/180)),r=this.sourceTexture.width,a=this.sourceTexture.height;this.imageContainerWidth=Math.cos(t)*r+Math.sin(t)*a,this.imageContainerHeight=Math.cos(t)*a+Math.sin(t)*r,this.imageBackground.clear(),i.background_color!=-1?this.imageBackground.beginFill("0x"+i.background_color):this.imageBackground.beginFill(0,0),this.imageBackground.drawRect(0,0,this.imageContainerWidth,this.imageContainerHeight),this.imageBackground.endFill(),this.imageContainer.x=-Math.round(this.imageContainerWidth/2),this.imageContainer.y=-Math.round(this.imageContainerHeight/2),this.imageCenterContainer.x=-this.imageContainer.x,this.imageCenterContainer.y=-this.imageContainer.y,this.imageCenterContainer.rotation=e*(Math.PI/180);let s=Math.min(1,this.image.texture.height/this.imageContainerHeight);this.scale.x=this.scale.y=s,this.itemWidth=Math.round(this.imageContainerWidth*s),this.itemHeight=Math.round(this.imageContainerHeight*s),this.image.currentScale=this._scale*s,BFN.PhotoEditorCanvasTools.dispatchEvent(BFN.PhotoEditorCanvasToolsEvents.TOOL_DIMENSIONS_UPDATED),BFN.MainUI.requestRender()}else this.imageContainer.x=0,this.imageContainer.y=0,this.imageCenterContainer.x=0,this.imageCenterContainer.y=0,this.imageCenterContainer.rotation=0};sr.prototype.setSourceTexture=function(i){this.reset(),i&&(this.sourceTexture=i,this.image.texture=this.sourceTexture,this.image.x=-(this.image.texture.width/2),this.image.y=-(this.image.texture.height/2),this.scale.x=this.scale.y=1,this.itemWidth=this.sourceTexture.width,this.itemHeight=this.sourceTexture.height,UITools.setToolValue("tilt","tilt_amount",0),UITools.setToolValue("tilt","background_color",-1),UITools.updateToolControls("tilt"))};sr.prototype.reset=function(){this.sourceTexture=null,this.image.texture=PIXI.Texture.EMPTY,this.image.x=0,this.image.y=0};Object.defineProperty(sr.prototype,"toolScale",{set:function(i){this._scale=i,this.image.currentScale=this._scale*this.scale.x},get:function(){return this._scale}});Object.defineProperty(sr.prototype,"modifiedTexture",{get:function(){let i=Math.min(1,BFN.maxImageSize/this.imageContainerWidth,BFN.maxImageSize/this.imageContainerHeight),e=Math.min(BFN.maxImageSize,Math.floor(this.imageContainerWidth*i)),t=Math.min(BFN.maxImageSize,Math.floor(this.imageContainerHeight*i)),r=PIXI.RenderTexture.create(e,t);return this.imageContainer.x=this.imageContainer.y=0,this.imageContainer.scale.x=this.imageContainer.scale.y=this.image.currentScale=i,BFN.Stage.render(this.imageContainer,r),this.imageContainer.x=-Math.round(this.imageContainerWidth/2),this.imageContainer.y=-Math.round(this.imageContainerHeight/2),this.imageContainer.scale.x=this.imageContainer.scale.y=1,this.image.currentScale=this._scale*this.scale.x,r}});Object.defineProperty(BFN,"ImageTilter",{get:function(){return BFN._ImageTilter||(BFN._ImageTilter=new sr),BFN._ImageTilter}});function He(){PIXI.Container.call(this),this.init()}He.prototype=Object.create(PIXI.Container.prototype);He.prototype.init=function(){BeFunky.log("FunkyMask Init"),this.initDefaultValues(),this.initMask(),this.initMaskGuide(),this.initMaskGuideShape(),this.initMaskGuideHandles(),this.initDraggers(),BFN.AppModel.appReady?BFN.MainUI.addEventListener(BFN.MainUIEvents.PRE_RENDER.type,this.handleMainUIPreRender.bind(this)):BFN.AppModel.addEventListener(BFN.AppModelEvents.APP_READY.type,function(i){BFN.MainUI.addEventListener(BFN.MainUIEvents.PRE_RENDER.type,this.handleMainUIPreRender.bind(this))}.bind(this))};He.prototype.initDefaultValues=function(){this._scale=1,this._hardness=.5,this._maskTarget=null,this.interactive=!0,this.renderPending=!1,this.hovered=!1,this.dragging=!1,this.keepGuidesOn=!1,this.showOuterHandles=!0,this.showRatioHandles=!1,this.strokeWidth=2,this.strokeShadowWidth=1,this.on("pointerover",this.handleToolMouseOver.bind(this)),this.on("pointerout",this.handleToolMouseOut.bind(this)),this.on("pointerdown",this.handleToolMouseDown.bind(this)),this.handleKeyDownBind=this.handleKeyDown.bind(this),this.handleKeyUpBind=this.handleKeyUp.bind(this)};He.prototype.initMask=function(){this.maskSourceSize=512,this.maskSourceScale=1,this.maskSourceFill=new PIXI.Graphics,this.maskSourceFill.beginFill(16777215),this.maskSourceFill.drawRect(0,0,this.maskSourceSize,this.maskSourceSize),this.maskSourceFill.endFill(),this.maskSourceTexture=PIXI.RenderTexture.create(this.maskSourceSize,this.maskSourceSize),BFN.Stage.render(this.maskSourceFill,this.maskSourceTexture),this.maskSourceSprite=new PIXI.Sprite(this.maskSourceTexture),this.maskSourceFilter=BFN.ShaderPool.BrushFilter,this.maskSourceFilter.radius=this.maskSourceSize/2,this.maskContainer=new PIXI.Container,this.addChild(this.maskContainer),this.maskTexture=PIXI.RenderTexture.create(this.maskSourceSize,this.maskSourceSize),this.maskSprite=new PIXI.Sprite(this.maskTexture),this.maskSprite.anchor.x=this.maskSprite.anchor.y=.5,this.maskContainer.addChild(this.maskSprite)};He.prototype.initMaskGuide=function(){this.maskGuide=new PIXI.Graphics,this.maskGuide.interactive=!0,this.addChild(this.maskGuide)};He.prototype.initMaskGuideShape=function(){this.maskGuideShape=new PIXI.Graphics,this.maskGuideShape.interactive=!0,this.maskGuide.addChild(this.maskGuideShape),this.maskGuideShape.on("pointerdown",function(){BFN.GestureManager.multiplePointersActive||this.positionDragger.drag(this.maskGuide)}.bind(this)),this.resolutionFilter=new BFN.filters.PlainFilter,this.resolutionFilter.resolution=2,this.maskGuideShape.filters=[this.resolutionFilter]};He.prototype.initMaskGuideHandles=function(){this.handleTextureSquare=PIXI.RenderTexture.create(20,20,PIXI.settings.SCALE_MODE,window.bfn_resolution),BFN.graphics.drawShape("roundedRect",this.handleTextureSquare,{fillColor:1073741824,cornerRadius:4}),BFN.graphics.drawShape("roundedRect",this.handleTextureSquare,{strokeWidth:1.5,strokeColor:4294967295,fillColor:4282154954,cornerRadius:3,paddingX:1,paddingY:1,clear:!1}),this.handleTextureCircle=PIXI.RenderTexture.create(20,20,PIXI.settings.SCALE_MODE,window.bfn_resolution),BFN.graphics.drawShape("ellipse",this.handleTextureCircle,{fillColor:1073741824}),BFN.graphics.drawShape("ellipse",this.handleTextureCircle,{strokeWidth:1.5,strokeColor:4294967295,fillColor:4282154954,paddingX:1,paddingY:1,clear:!1}),this.handleData=["left","top","right","bottom"],this.outerHandles={},this.innerHandles={},this.ratioHandles={},this.allHandles=[];for(let i=0;i<this.handleData.length;i++){let e=new BFN.HoverButton;e.id=this.handleData[i],e.texture=this.handleTextureSquare,e.handlePress=this.handleOuterHandlePress.bind(this),e.hoverButtonGroup=this.allHandles,this.outerHandles[e.id]=e,this.maskGuide.addChild(e),this.allHandles.push(e),BeFunky.isMobile?e.setHitAreaCircle(22):(e.addChildAt(this.getHandleTouchSurface(),0),e.on("pointerover",function(s){this.maskGuide.addChild(s.currentTarget)}.bind(this)));let t=new BFN.HoverButton;t.id=this.handleData[i],t.texture=this.handleTextureCircle,t.handlePress=this.handleInnerHandlePress.bind(this),t.hoverButtonGroup=this.allHandles,this.innerHandles[t.id]=t,this.maskGuide.addChild(t),this.allHandles.push(t),BeFunky.isMobile?t.setHitAreaCircle(22):(t.addChildAt(this.getHandleTouchSurface(),0),t.on("pointerover",function(s){this.maskGuide.addChild(s.currentTarget)}.bind(this)));let r=new BFN.HoverButton;r.id=this.handleData[i],r.texture=this.handleTextureSquare,r.handlePress=this.handleRatioHandlePress.bind(this),r.hoverButtonGroup=this.allHandles,this.ratioHandles[r.id]=r,this.maskGuide.addChildAt(r,1),this.allHandles.push(r),BeFunky.isMobile?r.setHitAreaCircle(22):r.addChildAt(this.getHandleTouchSurface(),0);let a=new PIXI.Graphics;a.rotation=i*(Math.PI/2),a.filters=[this.resolutionFilter],r.addChildAt(a,0),r.line=a}};He.prototype.initDraggers=function(){this.positionDragger=new BFN.Dragger,this.positionDragger.addEventListener(BFN.DraggerEvents.DRAGGING.type,this.handlePositionDraggerDragging.bind(this)),this.positionDragger.addEventListener(BFN.DraggerEvents.DRAGGING_STARTED.type,this.handleDraggingStarted.bind(this)),this.positionDragger.addEventListener(BFN.DraggerEvents.DRAGGING_COMPLETE.type,this.handleDraggingComplete.bind(this)),this.outerHandleDragger=new BFN.Dragger,this.outerHandleDragger.autoDrag=!1,this.outerHandleDragger.useBounds=!1,this.outerHandleDragger.addEventListener(BFN.DraggerEvents.DRAGGING.type,this.handleOuterHandleDraggerDragging.bind(this)),this.outerHandleDragger.addEventListener(BFN.DraggerEvents.DRAGGING_STARTED.type,this.handleDraggingStarted.bind(this)),this.outerHandleDragger.addEventListener(BFN.DraggerEvents.DRAGGING_COMPLETE.type,this.handleDraggingComplete.bind(this)),this.innerHandleDragger=new BFN.Dragger,this.innerHandleDragger.autoDrag=!1,this.innerHandleDragger.useBounds=!1,this.innerHandleDragger.addEventListener(BFN.DraggerEvents.DRAGGING.type,this.handleInnerHandleDraggerDragging.bind(this)),this.innerHandleDragger.addEventListener(BFN.DraggerEvents.DRAGGING_STARTED.type,this.handleDraggingStarted.bind(this)),this.innerHandleDragger.addEventListener(BFN.DraggerEvents.DRAGGING_COMPLETE.type,this.handleDraggingComplete.bind(this)),this.ratioHandleDragger=new BFN.Dragger,this.ratioHandleDragger.autoDrag=!1,this.ratioHandleDragger.useBounds=!1,this.ratioHandleDragger.addEventListener(BFN.DraggerEvents.DRAGGING.type,this.handleRatioHandleDraggerDragging.bind(this)),this.ratioHandleDragger.addEventListener(BFN.DraggerEvents.DRAGGING_STARTED.type,this.handleDraggingStarted.bind(this)),this.ratioHandleDragger.addEventListener(BFN.DraggerEvents.DRAGGING_COMPLETE.type,this.handleDraggingComplete.bind(this))};He.prototype.setup=function(i,e,t){if(t==null&&(t=1),i>0&&e>0){this.imageDiagonal=(Math.sqrt(Math.pow(i,2)+Math.pow(e,2))+10)*2,this.longestSide=Math.max(i,e),this.hitArea=new PIXI.Rectangle(0-this.longestSide-100,0-this.longestSide-100,i+(this.longestSide+100)*2,e+(this.longestSide+100)*2),this.maxSize=this.longestSide*2,this.minSize=this.maxSize/20,this.maskSourceScale=this.maskSourceSize/this.longestSide,this.maskContainer.scale.x=this.maskContainer.scale.y=1/this.maskSourceScale;let r=BeFunky.isMobile?10:20;this.ratioHandleDistance=Math.round(Math.max(i,e)/r);for(let a=0;a<this.handleData.length;a++){let s=this.handleData[a],o=this.ratioHandles[s];o.line.clear(),o.line.lineStyle(this.strokeWidth+this.strokeShadowWidth*2,0,.5),o.line.moveTo(0,0),o.line.lineTo(this.ratioHandleDistance,0),o.line.lineStyle(this.strokeWidth,16777215),o.line.moveTo(0,0),o.line.lineTo(this.ratioHandleDistance,0)}this.maskGuide.x=i/2,this.maskGuide.y=e/2,this.focusR=0,this.focusW=i*t,this.focusH=e*t,this.positionDragger.setBounds(0,0,i,e),this.toggleGuide(!0),this.updateMaskGuide(),this.updateMaskTransform(),this.updateMaskDisplay(),document.addEventListener("keydown",this.handleKeyDownBind,!1),document.addEventListener("keyup",this.handleKeyUpBind,!1)}};He.prototype.reset=function(){this.keepGuidesOn=!1,document.removeEventListener("keydown",this.handleKeyDownBind),document.removeEventListener("keyup",this.handleKeyUpBind)};He.prototype.toggleGuide=function(i,e=!1){i=!!i,this.maskGuide.visible=this.guideVisible=e?i:i||this.keepGuidesOn,BFN.MainUI.requestRender()};He.prototype.updateMaskGuide=function(){this.maskGuide.scale.x=this.maskGuide.scale.y=1/this._scale,this.maskGuideShape.rotation=this.focusR,this.maskGuideShape.clear(),this.showOuterHandles&&this.maskGuideShape.lineStyle(this.strokeWidth+this.strokeShadowWidth*2,0,.5),this.maskGuideShape.beginFill(16777215,0),this.maskMode=="linear"?(this.maskGuideShape.drawRect(-(this.imageDiagonal/2)*this._scale,-(this.focusH/2)*this._scale,this.imageDiagonal*this._scale,this.focusH*this._scale),this.maskGuideShape.endFill(),this.maskGuideShape.lineStyle(this.strokeWidth+this.strokeShadowWidth*2,0,.5),this.maskGuideShape.drawRect(-(this.imageDiagonal/2)*this._scale,-(this.focusH/2)*this._scale*this._hardness,this.imageDiagonal*this._scale,this.focusH*this._scale*this._hardness),this.maskGuideShape.lineStyle(this.strokeWidth,16777215),this.showOuterHandles&&this.maskGuideShape.drawRect(-(this.imageDiagonal/2)*this._scale,-(this.focusH/2)*this._scale,this.imageDiagonal*this._scale,this.focusH*this._scale),this.maskGuideShape.drawRect(-(this.imageDiagonal/2)*this._scale,-(this.focusH/2)*this._scale*this._hardness,this.imageDiagonal*this._scale,this.focusH*this._scale*this._hardness)):this.maskMode=="square"?(this.maskGuideShape.drawRect(-(this.focusW/2)*this._scale,-(this.focusH/2)*this._scale,this.focusW*this._scale,this.focusH*this._scale),this.maskGuideShape.endFill(),this.maskGuideShape.lineStyle(this.strokeWidth+this.strokeShadowWidth*2,0,.5),this.maskGuideShape.drawRect(-(this.focusW/2)*this._scale*this._hardness,-(this.focusH/2)*this._scale*this._hardness,this.focusW*this._scale*this._hardness,this.focusH*this._scale*this._hardness),this.maskGuideShape.lineStyle(this.strokeWidth,16777215),this.showOuterHandles&&this.maskGuideShape.drawRect(-(this.focusW/2)*this._scale,-(this.focusH/2)*this._scale,this.focusW*this._scale,this.focusH*this._scale),this.maskGuideShape.drawRect(-(this.focusW/2)*this._scale*this._hardness,-(this.focusH/2)*this._scale*this._hardness,this.focusW*this._scale*this._hardness,this.focusH*this._scale*this._hardness)):(this.maskGuideShape.drawEllipse(0,0,this.focusW/2*this._scale,this.focusH/2*this._scale),this.maskGuideShape.endFill(),this.maskGuideShape.lineStyle(this.strokeWidth+this.strokeShadowWidth*2,0,.5),this.maskGuideShape.drawEllipse(0,0,this.focusW/2*this._scale*this._hardness,this.focusH/2*this._scale*this._hardness),this.maskGuideShape.lineStyle(this.strokeWidth,16777215),this.showOuterHandles&&this.maskGuideShape.drawEllipse(0,0,this.focusW/2*this._scale,this.focusH/2*this._scale),this.maskGuideShape.drawEllipse(0,0,this.focusW/2*this._scale*this._hardness,this.focusH/2*this._scale*this._hardness));for(let i=0;i<this.handleData.length;i++){let e=this.handleData[i],t=this.outerHandles[e],r=this.innerHandles[e],a=this.ratioHandles[e];switch(e){case"left":this.betaOffset=Math.PI,this.handleDistance=this.focusW/2,t.visible=r.visible=a.visible=this.maskMode!="linear";break;case"top":this.betaOffset=-(Math.PI/2),this.handleDistance=this.focusH/2;break;case"right":this.betaOffset=0,this.handleDistance=this.focusW/2,t.visible=r.visible=a.visible=this.maskMode!="linear";break;case"bottom":this.betaOffset=Math.PI/2,this.handleDistance=this.focusH/2;break}this.showOuterHandles||(t.visible=!1),this.showRatioHandles||(a.visible=!1),t.rotation=this.focusR,t.x=Math.cos(this.focusR+this.betaOffset)*this.handleDistance*this._scale,t.y=Math.sin(this.focusR+this.betaOffset)*this.handleDistance*this._scale,r.rotation=this.focusR,r.x=Math.cos(this.focusR+this.betaOffset)*this.handleDistance*this._scale*this._hardness,r.y=Math.sin(this.focusR+this.betaOffset)*this.handleDistance*this._scale*this._hardness,a.rotation=this.focusR,a.x=r.x+Math.cos(this.focusR+this.betaOffset)*this.ratioHandleDistance*this._scale,a.y=r.y+Math.sin(this.focusR+this.betaOffset)*this.ratioHandleDistance*this._scale,a.line.scale.x=this._scale}};He.prototype.updateMaskTransform=function(){this.maskSprite.rotation=this.focusR,this.maskSprite.x=this.maskGuide.x*this.maskSourceScale,this.maskSprite.y=this.maskGuide.y*this.maskSourceScale,this.maskSprite.scale.x=this.maskMode=="linear"?this.imageDiagonal*this.maskSourceScale/this.maskSourceSize:this.focusW*this.maskSourceScale/this.maskSourceSize,this.maskSprite.scale.y=this.focusH*this.maskSourceScale/this.maskSourceSize};He.prototype.updateMaskDisplay=function(){this.maskSourceFilter.strength=1,this.maskSourceFilter.radius=this.maskSourceSize/2,this.maskSourceFilter.hardness=this._hardness,this.maskSourceFilter.mode=this._maskMode,this.maskSourceSprite.bfn_shaders=[this.maskSourceFilter],this.maskSourceSprite.pluginName="filter_renderer",this.renderPending=!0};He.prototype.setOpacity=function(i){this.maskContainer.alpha=i};He.prototype.getHandleTouchSurface=function(){let i=new PIXI.Graphics;return i.interactive=!0,i.beginFill(16777215,0),i.drawCircle(0,0,20),i.endFill(),i};He.prototype.handleMainUIPreRender=function(i){this.renderPending&&(this.renderPending=!1,BFN.Stage.render(this.maskSourceSprite,this.maskTexture))};He.prototype.handleToolMouseOver=function(i){this.hovered=!0,this.toggleGuide(!0)};He.prototype.handleToolMouseOut=function(i){this.hovered=!1,this.dragging||this.toggleGuide(!1)};He.prototype.handleToolMouseDown=function(i){this.hovered||(this.keepGuidesOn=!0,this.handleToolMouseOver())};He.prototype.handleOuterHandlePress=function(i){BFN.GestureManager.multiplePointersActive||(this.maskGuide.addChild(i.currentTarget),this.outerHandleDragger.drag(i.currentTarget))};He.prototype.handleInnerHandlePress=function(i){BFN.GestureManager.multiplePointersActive||(this.maskGuide.addChild(i.currentTarget),this.innerHandleDragger.drag(i.currentTarget))};He.prototype.handleRatioHandlePress=function(i){BFN.GestureManager.multiplePointersActive||this.ratioHandleDragger.drag(i.currentTarget)};He.prototype.handlePositionDraggerDragging=function(i){this.updateMaskTransform()};He.prototype.handleOuterHandleDraggerDragging=function(i){let e=this.outerHandleDragger.item,t=this.maskGuide.getPointerPosition(BFN.MainUI.pointerEvent),r=t.x/this._scale,a=t.y/this._scale,s=Math.max(this.minSize/2,Math.min(this.maxSize/2,Math.sqrt(r**2+a**2))),o=this.outerHandleDragger.shiftKey,n;switch(o&&(n=this.focusH/this.focusW),e.id){case"left":this.focusR=Math.atan2(a,r)-Math.PI,this.focusW=s*2,this.focusH=o?this.focusW*n:this.focusH;break;case"top":this.focusR=Math.atan2(a,r)+Math.PI/2,this.focusH=s*2,this.focusW=o?this.focusH/n:this.focusW;break;case"right":this.focusR=Math.atan2(a,r),this.focusW=s*2,this.focusH=o?this.focusW*n:this.focusH;break;case"bottom":this.focusR=Math.atan2(a,r)-Math.PI/2,this.focusH=s*2,this.focusW=o?this.focusH/n:this.focusW;break}this.updateMaskGuide(),this.updateMaskTransform()};He.prototype.handleInnerHandleDraggerDragging=function(i){let e=this.innerHandleDragger.item,t=this.maskGuide.getPointerPosition(BFN.MainUI.pointerEvent),r=t.x/this._scale,a=t.y/this._scale,s=Math.sqrt(Math.pow(r,2)+Math.pow(a,2));switch(e.id){case"left":case"right":this._hardness=Math.max(.1,Math.min(.9,s/(this.focusW/2)));break;case"top":case"bottom":this._hardness=Math.max(.1,Math.min(.9,s/(this.focusH/2)));break}this.updateMaskGuide(),this.updateMaskDisplay()};He.prototype.handleRatioHandleDraggerDragging=function(i){let e=this.ratioHandleDragger.item,t=this.maskGuide.getPointerPosition(BFN.MainUI.pointerEvent),r=t.x/this._scale/this._hardness,a=t.y/this._scale/this._hardness,s=Math.sqrt(Math.pow(r,2)+Math.pow(a,2));s=Math.max(this.minSize/2,Math.min(this.maxSize/2,s-this.ratioHandleDistance/this._hardness));let o=this.ratioHandleDragger.shiftKey,n;switch(o&&(n=this.focusH/this.focusW),e.id){case"left":this.focusR=Math.atan2(a,r)-Math.PI,this.focusW=s*2,this.focusH=o?this.focusW*n:this.focusH;break;case"top":this.focusR=Math.atan2(a,r)+Math.PI/2,this.focusH=s*2,this.focusW=o?this.focusH/n:this.focusW;break;case"right":this.focusR=Math.atan2(a,r),this.focusW=s*2,this.focusH=o?this.focusW*n:this.focusH;break;case"bottom":this.focusR=Math.atan2(a,r)-Math.PI/2,this.focusH=s*2,this.focusW=o?this.focusH/n:this.focusW;break}this.updateMaskGuide(),this.updateMaskTransform()};He.prototype.handleDraggingStarted=function(i){this.dragging=!0,this.hovered||(this.keepGuidesOn=!0,this.handleToolMouseOver())};He.prototype.handleDraggingComplete=function(i){this.dragging=!1,this.hovered||this.toggleGuide(!1)};He.prototype.handleKeyDown=function(i){if(i.keyCode==32&&this.hovered&&this.guideVisible){let e=this.keepGuidesOn;this.keepGuidesOn=!1,this.toggleGuide(!1),this.keepGuidesOn=e}};He.prototype.handleKeyUp=function(i){i.keyCode==32&&this.hovered&&!this.guideVisible&&this.toggleGuide(!0)};Object.defineProperty(He.prototype,"scale",{set:function(i){this._scale=i,this.positionDragger.scale=this._scale,this.updateMaskGuide()},get:function(){return this._scale}});Object.defineProperty(He.prototype,"maskMode",{set:function(i){(i=="radial"||i=="square"||i=="linear")&&i!=this._maskMode&&(this._maskMode=i,this.updateMaskGuide(),this.updateMaskTransform(),this.updateMaskDisplay())},get:function(){return this._maskMode}});Object.defineProperty(He.prototype,"maskTarget",{set:function(i){this._maskTarget&&(this._maskTarget.mask=null,this._maskTarget=null),this._maskTarget=i,this._maskTarget.mask=this.maskSprite},get:function(){return this._maskTarget}});Object.defineProperty(He.prototype,"draggerActive",{get:function(){return this.positionDragger.dragging||this.outerHandleDragger.dragging||this.innerHandleDragger.dragging||this.ratioHandleDragger.dragging}});BFN.FunkyMask=He;function jt(){PIXI.Sprite.call(this),this.init()}jt.prototype=Object.create(PIXI.Sprite.prototype);jt.prototype.init=function(){BeFunky.log("ImageFocus Init"),this.initDefaultValues(),this.initImageContainer(),this.initFilterSprite(),this.initRenderSprite(),this.initOpacitySprite(),this.initSourceSprite(),this.initFunkyMask(),BFN.AppModel.appReady?BFN.MainUI.addEventListener(BFN.MainUIEvents.PRE_RENDER.type,this.handleMainUIPreRender.bind(this)):BFN.AppModel.addEventListener(BFN.AppModelEvents.APP_READY.type,function(i){BFN.MainUI.addEventListener(BFN.MainUIEvents.PRE_RENDER.type,this.handleMainUIPreRender.bind(this))}.bind(this))};jt.prototype.initDefaultValues=function(){this.sourceTexture=null,this.renderTexture=null,this._inverse=!1,this._scale=1,this.mosaicSegments={minX:0,maxX:0,minY:0,maxY:0},this.renderPending=!1,this.blurFilter=new BFN.filters.FastBlurWrapper(null,null,!1),this.pixelateFilter=new BFN.filters.PixelateFilter,this.grayFilter=new BFN.filters.GrayFilter};jt.prototype.initImageContainer=function(){this.imageContainer=new PIXI.Sprite,this.addChild(this.imageContainer)};jt.prototype.initFilterSprite=function(){this.filterMinBlur=0,this.filterMaxBlur=0,this.filterMaxSize=1024,this.filterSprite=new PIXI.Sprite};jt.prototype.initRenderSprite=function(){this.renderSprite=new PIXI.Sprite,this.renderSprite.pluginName="smooth_picture",this.imageContainer.addChild(this.renderSprite)};jt.prototype.initOpacitySprite=function(){this.opacitySprite=new PIXI.Sprite,this.opacitySprite.pluginName="smooth_picture",this.opacitySprite.alpha=0,this.imageContainer.addChild(this.opacitySprite)};jt.prototype.initSourceSprite=function(){this.sourceSprite=new PIXI.Sprite,this.sourceSprite.pluginName="smooth_picture",this.imageContainer.addChild(this.sourceSprite)};jt.prototype.initFunkyMask=function(){this.funkyMask=new BFN.FunkyMask,this.funkyMask.maskTarget=this.sourceSprite,this.imageContainer.addChild(this.funkyMask)};jt.prototype.handleFocus=function(){if(BFN.PhotoEditorCanvasModel.viewState==BFN.PhotoEditorCanvasModelViewStates.VIEWING_FOCUS){let i=UITools.getToolVO("funky_focus"),e=[];if(this.funkyMask.maskMode!=i.mode&&(this.funkyMask.maskMode=i.mode),i.grayscale&&e.push(this.grayFilter),i.mosaic){let t=1-Math.max(0,Math.min(1,i.blur_amount/100));this.pixelateFilter.segmentsX=Math.round((this.mosaicSegments.maxX-this.mosaicSegments.minX)*t+this.mosaicSegments.minX),this.pixelateFilter.segmentsY=Math.round((this.mosaicSegments.maxY-this.mosaicSegments.minY)*t+this.mosaicSegments.minY),e.push(this.pixelateFilter)}else{i.updating_id=="blur_amount"&&i.updating?BFN.StageModel.setRefreshFactor(.25):BFN.StageModel.setRefreshFactor(1);let t=this.blurFilter.apply(i.blur_amount/100);t.length&&e.push(t[0])}this._inverse!=i.inverse&&(this._inverse=i.inverse,this.imageContainer.addChildAt(this.opacitySprite,0),this._inverse?(this.imageContainer.addChildAt(this.sourceSprite,0),this.funkyMask.maskTarget=this.renderSprite,this.opacitySprite.texture=this.renderSprite.texture):(this.imageContainer.addChildAt(this.renderSprite,0),this.funkyMask.maskTarget=this.sourceSprite,this.opacitySprite.texture=this.sourceSprite.texture)),this.opacitySprite.alpha=this._inverse?0:Math.max(0,Math.min(1,1-i.opacity/100)),this.funkyMask.setOpacity(this._inverse?i.opacity/100:1),this.filterSprite.filters=e,this.renderPending=!0,BFN.MainUI.requestRender()}};jt.prototype.setSourceTexture=function(i){this.filterTexture!=null&&(this.filterTexture.destroyGC(!0),this.filterTexture=null),this.sourceTexture!=null&&(this.sourceTexture=null,this.sourceSprite.texture=PIXI.Texture.EMPTY),this.renderTexture!=null&&(this.renderTexture.destroyGC(!0),this.renderTexture=null),this.opacitySprite.texture=null,i?(this.sourceTexture=i,this.renderTexture=PIXI.RenderTexture.create(this.sourceTexture.width,this.sourceTexture.height),this.renderTexture.copyPixels(this.sourceTexture),this.filterScale=Math.min(1,this.filterMaxSize/this.sourceTexture.width,this.filterMaxSize/this.sourceTexture.height),this.filterMinBlur=Math.min(Math.floor(this.sourceTexture.width*this.filterScale)/this.filterMaxSize,Math.floor(this.sourceTexture.height*this.filterScale)/this.filterMaxSize)/4,this.filterMaxBlur=Math.min(Math.floor(this.sourceTexture.width*this.filterScale)/this.filterMaxSize,Math.floor(this.sourceTexture.height*this.filterScale)/this.filterMaxSize)*1,this.renderSprite.texture=this.renderTexture,this.sourceSprite.texture=this.sourceTexture,this.filterSprite.texture=this.sourceTexture,this.opacitySprite.texture=this._inverse?this.renderTexture:this.sourceTexture,this.imageContainer.x=-Math.round(this.sourceTexture.width/2),this.imageContainer.y=-Math.round(this.sourceTexture.height/2),this.pixelateFilter.textureW=this.sourceTexture.width,this.pixelateFilter.textureH=this.sourceTexture.height,Math.min(this.sourceTexture.width,this.sourceTexture.height)==this.sourceTexture.width?(this.mosaicSegments.minX=Math.min(8,this.sourceTexture.width),this.mosaicSegments.maxX=Math.min(64,this.sourceTexture.width),this.segmentRange=this.mosaicSegments.maxX-this.mosaicSegments.minX,this.ratio=this.sourceTexture.height/this.sourceTexture.width,this.mosaicSegments.minY=Math.max(1,Math.round(this.mosaicSegments.minX*this.ratio)),this.mosaicSegments.maxY=this.mosaicSegments.minY+Math.round(this.segmentRange*this.ratio)):(this.mosaicSegments.minY=Math.min(8,this.sourceTexture.height),this.mosaicSegments.maxY=Math.min(64,this.sourceTexture.height),this.segmentRange=this.mosaicSegments.maxY-this.mosaicSegments.minY,this.ratio=this.sourceTexture.width/this.sourceTexture.height,this.mosaicSegments.minX=Math.max(1,Math.round(this.mosaicSegments.minY*this.ratio)),this.mosaicSegments.maxX=this.mosaicSegments.minX+Math.round(this.segmentRange*this.ratio)),this.funkyMask.setup(this.sourceTexture.width,this.sourceTexture.height,.8),this.resetControls()):this.funkyMask.reset()};jt.prototype.resetControls=function(){let i=UITools.getToolVO("funky_focus").defaultValues;for(let e in i)UITools.setToolValue("funky_focus",e,i[e]);UITools.updateToolControls("funky_focus")};jt.prototype.setSmoothingScale=function(i){this.renderSprite.currentScale=i,this.opacitySprite.currentScale=i,this.sourceSprite.currentScale=i};jt.prototype.handleMainUIPreRender=function(i){this.renderPending&&BFN.PhotoEditorCanvasModel.viewState==BFN.PhotoEditorCanvasModelViewStates.VIEWING_FOCUS&&(this.renderPending=!1,BFN.Stage.render(this.filterSprite,this.renderTexture))};Object.defineProperty(jt.prototype,"toolScale",{set:function(i){this._scale=i,this.funkyMask.scale=this._scale,this.setSmoothingScale(this._scale)},get:function(){return this._scale}});Object.defineProperty(jt.prototype,"modifiedTexture",{get:function(){let i=PIXI.RenderTexture.create(this.sourceTexture.width,this.sourceTexture.height);this.imageContainer.x=0,this.imageContainer.y=0,this.setSmoothingScale(1);let e=this.funkyMask.guideVisible;return this.funkyMask.toggleGuide(!1,!0),BFN.Stage.render(this.imageContainer,i),this.imageContainer.x=-Math.round(this.sourceTexture.width/2),this.imageContainer.y=-Math.round(this.sourceTexture.height/2),this.setSmoothingScale(this._scale),this.funkyMask.toggleGuide(e,!0),i}});Object.defineProperty(BFN,"ImageFocus",{get:function(){return BFN._ImageFocus||(BFN._ImageFocus=new jt),BFN._ImageFocus}});function gi(){PIXI.Sprite.call(this),this.init()}gi.prototype=Object.create(PIXI.Sprite.prototype);gi.prototype.init=function(){BeFunky.log("ImageVignette Init"),this.initDefaultValues(),this.initImageContainer(),this.initBlendModeSprite(),this.initSourceSprite(),this.initColorSurface(),this.initFunkyMask()};gi.prototype.initDefaultValues=function(){this.sourceTexture=null,this._scale=1,this._vignetteColor=-1,this.forceDisplayUpdate=!1};gi.prototype.initImageContainer=function(){this.imageContainer=new PIXI.Sprite,this.addChild(this.imageContainer)};gi.prototype.initBlendModeSprite=function(){this.blendModeSprite=new BFN.BlendModeSprite(!1),this.blendModeSprite.pluginName="smooth_picture",this.imageContainer.addChild(this.blendModeSprite)};gi.prototype.initSourceSprite=function(){this.sourceSprite=new PIXI.Sprite,this.sourceSprite.pluginName="smooth_picture",this.imageContainer.addChild(this.sourceSprite)};gi.prototype.initColorSurface=function(){this.colorSurfaceTexture=null};gi.prototype.initFunkyMask=function(){this.funkyMask=new BFN.FunkyMask,this.funkyMask.maskTarget=this.sourceSprite,this.funkyMask.showOuterHandles=!1,this.funkyMask.showRatioHandles=!0,this.imageContainer.addChild(this.funkyMask)};gi.prototype.handleVignette=function(){if(BFN.PhotoEditorCanvasModel.viewState===BFN.PhotoEditorCanvasModelViewStates.VIEWING_VIGNETTE){let i=UITools.getToolVO("funky_vignette");i.updating_id==="clear"&&(this.resetControls(),i=UITools.getToolVO("funky_vignette")),this.funkyMask.maskMode!==i.mode&&(this.funkyMask.maskMode=i.mode),this.blendModeSprite.setBlendMode(parseInt(i.blend_mode)),this.blendModeSprite.setBlendIntensity(i.opacity),this.colorSurfaceTexture&&this._vignetteColor!==`0x${i.color}`&&(this._vignetteColor=`0x${i.color}`,this.colorSurfaceTexture.fillColor(this._vignetteColor)),this.forceDisplayUpdate?(this.forceDisplayUpdate=!1,this.blendModeSprite.renderDisplay()):this.blendModeSprite.updateDisplay()}};gi.prototype.setSourceTexture=function(i){this.sourceTexture!=null&&(this.sourceTexture=null,this.sourceSprite.texture=PIXI.Texture.EMPTY),this.colorSurfaceTexture!=null&&(this.colorSurfaceTexture.destroyGC(!0),this.colorSurfaceTexture=null),this._vignetteColor=-1,this.blendModeSprite.autoRender=!1,this.blendModeSprite.setBlendMode(null),this.blendModeSprite.setBaseTexture(null),this.blendModeSprite.setBlendTexture(null),i?(this.sourceTexture=i,this.sourceSprite.texture=this.sourceTexture,this.colorSurfaceTexture=PIXI.RenderTexture.create(this.sourceTexture.width,this.sourceTexture.height),this.blendModeSprite.autoRender=!0,this.blendModeSprite.setBaseTexture(this.sourceTexture),this.blendModeSprite.setBlendTexture(this.colorSurfaceTexture),this.imageContainer.x=-Math.round(this.sourceTexture.width/2),this.imageContainer.y=-Math.round(this.sourceTexture.height/2),this.resetControls()):this.funkyMask.reset()};gi.prototype.resetControls=function(){this.sourceTexture&&(this.imageDiagonal=Math.sqrt(Math.pow(this.sourceTexture.width,2)+Math.pow(this.sourceTexture.height,2)),this.funkyMask.setup(this.sourceTexture.width,this.sourceTexture.height,1),this.funkyMask._hardness=.2,this.funkyMask.focusW=this.funkyMask.focusH=this.imageDiagonal,this.funkyMask.updateMaskGuide(),this.funkyMask.updateMaskTransform(),this.funkyMask.updateMaskDisplay(),this.forceDisplayUpdate=!0);let{defaultValues:i}=UITools.getToolVO("funky_vignette");for(let e in i)e!=="mode"&&UITools.setToolValue("funky_vignette",e,i[e]);UITools.setToolValue("funky_vignette","blend_mode",BFN.CONST.BLEND_MODES.NORMAL),UITools.updateToolControls("funky_vignette")};gi.prototype.setSmoothingScale=function(i){this.blendModeSprite.currentScale=i,this.sourceSprite.currentScale=i};Object.defineProperty(gi.prototype,"toolScale",{set(i){this._scale=i,this.funkyMask.scale=this._scale,this.setSmoothingScale(this._scale)},get(){return this._scale}});Object.defineProperty(gi.prototype,"modifiedTexture",{get(){let i=PIXI.RenderTexture.create(this.sourceTexture.width,this.sourceTexture.height);this.imageContainer.x=0,this.imageContainer.y=0,this.setSmoothingScale(1);let{guideVisible:e}=this.funkyMask;return this.funkyMask.toggleGuide(!1,!0),BFN.Stage.render(this.imageContainer,i),this.imageContainer.x=-Math.round(this.sourceTexture.width/2),this.imageContainer.y=-Math.round(this.sourceTexture.height/2),this.setSmoothingScale(this._scale),this.funkyMask.toggleGuide(e),i}});Object.defineProperty(BFN,"ImageVignette",{get(){return BFN._ImageVignette||(BFN._ImageVignette=new gi),BFN._ImageVignette}});function Ye(){PIXI.Container.call(this),this.init()}Ye.prototype=Object.create(PIXI.Container.prototype);Ye.prototype.init=function(){BeFunky.log("TransformFrame Init"),this.initDefaultValues(),this.initImageSprite(),this.initFrameSprite()};Ye.prototype.initDefaultValues=function(){this.texture=null,this.baseTexture=null};Ye.prototype.initImageSprite=function(){this.imageSprite=new PIXI.Sprite,this.imageSprite.tint=8421504};Ye.prototype.initFrameSprite=function(){this.frameSprite=new BFN.FrameSprite,this.frameSprite.updateDisplayCallback=this.updateDisplayCallback.bind(this),this.addChild(this.frameSprite)};Ye.prototype.setTexture=function(i=null){this.texture=i,this.baseTexture=null,i&&i.baseTexture&&(this.baseTexture=i.baseTexture,this.imageSprite.texture=new PIXI.Texture(this.baseTexture),this.frameSprite.setTexture(i))};Ye.prototype.updateDisplay=function(){this.frameSprite.updateDisplay()};Ye.prototype.updateDisplayCallback=function(){this.baseTexture&&(this.imageSprite.scale.x=this.frameSprite.width/this.frameSprite.textureFrame.width,this.imageSprite.scale.y=this.frameSprite.height/this.frameSprite.textureFrame.height,this.imageSprite.x=-((this.imageSprite.width-this.frameSprite.width)*this.frameSprite.offsetFactorX),this.imageSprite.y=-((this.imageSprite.height-this.frameSprite.height)*this.frameSprite.offsetFactorY))};Ye.prototype.destroy=function(i=!1){this.baseTexture=null,this.removeChild(this.frameSprite),this.frameSprite.destroy(i),this.removeChild(this.imageSprite),this.imageSprite.destroy(!1)};Object.defineProperty(Ye.prototype,"frameWidth",{set:function(i){this.frameSprite.frameWidth=i},get:function(){return this.frameSprite.frameWidth}});Object.defineProperty(Ye.prototype,"frameHeight",{set:function(i){this.frameSprite.frameHeight=i},get:function(){return this.frameSprite.frameHeight}});Object.defineProperty(Ye.prototype,"offsetFactorX",{set:function(i){this.frameSprite.offsetFactorX=i},get:function(){return this.frameSprite.offsetFactorX}});Object.defineProperty(Ye.prototype,"offsetFactorY",{set:function(i){this.frameSprite.offsetFactorY=i},get:function(){return this.frameSprite.offsetFactorY}});Object.defineProperty(Ye.prototype,"textureScale",{set:function(i){this.frameSprite.textureScale=i},get:function(){return this.frameSprite.textureScale}});Object.defineProperty(Ye.prototype,"textureScaleX",{set:function(i){this.frameSprite.textureScaleX=i},get:function(){return this.frameSprite.textureScaleX}});Object.defineProperty(Ye.prototype,"textureScaleY",{set:function(i){this.frameSprite.textureScaleY=i},get:function(){return this.frameSprite.textureScaleY}});Object.defineProperty(Ye.prototype,"adjustScale",{get:function(){return this.frameSprite.adjustScale}});Object.defineProperty(Ye.prototype,"excessX",{get:function(){return this.frameSprite.excessX}});Object.defineProperty(Ye.prototype,"excessY",{get:function(){return this.frameSprite.excessY}});Object.defineProperty(Ye.prototype,"width",{get:function(){return this.frameSprite.width*this.scale.x}});Object.defineProperty(Ye.prototype,"height",{get:function(){return this.frameSprite.height*this.scale.y}});Object.defineProperty(Ye.prototype,"pluginName",{set:function(i){this.imageSprite.pluginName=i,this.frameSprite.pluginName=i},get:function(){return this.frameSprite.pluginName}});Object.defineProperty(Ye.prototype,"currentScale",{set:function(i){this.imageSprite.currentScale=i,this.frameSprite.currentScale=i},get:function(){return this.frameSprite.currentScale}});Object.defineProperty(Ye.prototype,"currentScaleY",{set:function(i){this.imageSprite.currentScaleY=i,this.frameSprite.currentScaleY=i},get:function(){return this.frameSprite.currentScaleY}});Object.defineProperty(Ye.prototype,"blendMode",{set:function(i){this.frameSprite.blendMode=i},get:function(){return this.frameSprite.blendMode}});Object.defineProperty(Ye.prototype,"smoothEdges",{set:function(i){this.imageSprite.smoothEdges=i,this.frameSprite.smoothEdges=i},get:function(){return this.frameSprite.smoothEdges}});Object.defineProperty(Ye.prototype,"fillColor",{set:function(i){this.frameSprite.fillColor=i},get:function(){return this.frameSprite.fillColor}});Object.defineProperty(Ye.prototype,"intensity",{set:function(i){this.frameSprite.intensity=i},get:function(){return this.frameSprite.intensity}});Object.defineProperty(Ye.prototype,"tint",{set:function(i){this.frameSprite.tint=i},get:function(){return this.frameSprite.tint}});BFN.TransformFrame=Ye;BFN.TransformItemEvents={ITEM_DISPLAY_UPDATED:new Event("ITEM_DISPLAY_UPDATED"),GET_SNAP_COORDINATES:new Event("GET_SNAP_COORDINATES"),PRESS_ITEM:new Event("PRESS_ITEM"),SELECT_ITEM:new Event("SELECT_ITEM"),DESELECT_ITEM:new Event("DESELECT_ITEM"),DUPLICATE_ITEM:new Event("DUPLICATE_ITEM"),REMOVE_ITEM:new Event("REMOVE_ITEM"),DESTROY_ITEM:new Event("DESTROY_ITEM"),REGISTER_TRANSITION:new Event("REGISTER_TRANSITION"),TRANSITION_APPLIED:new Event("TRANSITION_APPLIED"),TEXT_DISPLAY_UPDATED:new Event("TEXT_DISPLAY_UPDATED"),ACCURATE_BOUNDS_UPDATED:new Event("ACCURATE_BOUNDS_UPDATED"),THUMB_UPDATED:new Event("THUMB_UPDATED")};BFN.TransformItemTextBaseFontSize=20;BFN.TransformItemTextBaseLineHeight=1.05;BFN.TransformItemTextStrokePercentMin=.005;BFN.TransformItemTextStrokePercentMax=.15;BFN.TransformItemTextStrokePercentDefault=.07676767677;function Q(i,e){switch(PIXI.Container.call(this),BFN.EventDispatcher.call(this),this.itemObject=i,this.appViewState=e,this.appViewState){case BFN.AppModelViewStates.VIEWING_PHOTO_EDITOR:this.transformLayer=BFN.PhotoEditorCanvas.transformLayer;break;case BFN.AppModelViewStates.VIEWING_COLLAGE_MAKER:this.transformLayer=BFN.CollageMakerCanvas.transformLayer;break;case BFN.AppModelViewStates.VIEWING_DESIGNER:this.transformLayer=BFN.DesignerCanvas.transformLayer;break}this.init()}Q.prototype=window.azrc.extend(Object.create(PIXI.Container.prototype),Object.create(BFN.EventDispatcher.prototype));Q.prototype.init=function(){BeFunky.log("TransformItem Init"),this.initDefaultValues(),this.initItemContent(),this.initLongPressValues(),this.updateSmoothingScale(),this.initialized=!0};Q.prototype.initDefaultValues=function(){switch(Object.defineProperty(this,"interactive",{set(i){this._interactive=!!i},get(){return this._interactive&&!this.lockedOrHidden}}),Object.defineProperty(this,"interactiveChildren",{set(i){this._interactiveChildren=!!i},get(){return this._interactiveChildren&&!this.lockedOrHidden}}),Object.defineProperty(this,"buttonMode",{set(i){this._buttonMode=!!i},get(){return this._buttonMode&&!this.lockedOrHidden}}),this.interactive=!0,this.interactiveChildren=!0,this.buttonMode=!0,this.hitArea=new PIXI.Polygon,this.textMaskMaxSize=2048,this.addedTextScaleFactor=BeFunky.isMobile?.8:.5,this.addedTextureScaleFactor=BeFunky.isMobile?.6:.5,this.mouseChildren=!1,this.updateProjectItemVO=BeFunky.debounce(this.updateProjectItemVO.bind(this),10),this.isTemplateItem=BFN.ProjectManager.sourceTemplateLoading,this.isGoodie=this.itemObject.hasOwnProperty("isGoodie")?this.itemObject.isGoodie:!1,this.graphicStyle=this.itemObject.graphicStyle,this.isShape=!1,this.fabricShape=null,this.selectedByMouse=!1,this.flippedHorizontal=!1,this.flippedVertical=!1,this.transforming=!1,this.accurateBounds=null,this.snapCoordinates=[],this.otherItemAccurateBoundsList=[],this.snapGapRects={},this.destroyed=!1,this.zIndexUpdating=!1,this.zIndexStart=null,this.bounds=new PIXI.Rectangle,this.itemBoundsData=null,this.itemGroupData={},this.transitionVO=null,this.lastTransitionVO=null,this.currentTransformItemStateVO=null,this._align=null,this._borderEnabled=!1,this._overlayColorEnabled=!1,this._overlayColor=-1,this._overlayColorIntensity=0,this._tintColorEnabled=!1,this._tintColor=-1,this._locked=!1,this._hidden=!1,this._isTransparent=void 0,this.shapeUpdatePending=!1,this.textUpdatePending=!1,this.textPadding=BFN.TransformItemTextBaseFontSize,this.fontSizeNormalizeFactor=1,this.textBackgroundEnabled=!1,this.textBackgroundColor=-1,this.textBackgroundIntensity=1,this.textBackgroundPadding=20,this._textCurveEnabled=!1,this._textCurveAmount=null,this.thumbTexture=null,this.thumbImage=null,this.presetItemThumbTextures=[],this.itemMoved=!1,this.preventEditText=!1,this.preventBaseTextureDestroy=!1,this.debugAccurateBounds=!1,this.ignoreAccurateBounds=this.itemObject.hasOwnProperty("projectItemVO"),this.accurateBoundsTimer=0,this.accurateBoundsRequested=!1,this.accurateBoundsIndervalID=null,this.transformTool=null,this.model=null,this.canvasModel=null,this.canvasModelEvents=null,this.appViewState){case BFN.AppModelViewStates.VIEWING_PHOTO_EDITOR:this.transformTool=BFN.PhotoEditorCanvas.transformTool,this.model=BFN.PhotoEditorModel,this.canvasModel=BFN.PhotoEditorCanvasModel,this.canvasModelEvents=BFN.PhotoEditorCanvasModelEvents;break;case BFN.AppModelViewStates.VIEWING_COLLAGE_MAKER:this.transformTool=BFN.CollageMakerCanvas.transformTool,this.model=BFN.CollageMakerModel,this.canvasModel=BFN.CollageMakerCanvasModel,this.canvasModelEvents=BFN.CollageMakerCanvasModelEvents;break;case BFN.AppModelViewStates.VIEWING_DESIGNER:this.transformTool=BFN.DesignerCanvas.transformTool,this.model=BFN.DesignerModel,this.canvasModel=BFN.DesignerCanvasModel,this.canvasModelEvents=BFN.DesignerCanvasModelEvents;break}if(this.projectVO=this.itemObject.hasOwnProperty("projectVO")?this.itemObject.projectVO:this.model.projectVO,this.basicShapeVO=this.itemObject.hasOwnProperty("basicShapeVO")?this.itemObject.basicShapeVO:null,this.itemID=`item_${BeFunky.randomString(10)}`,this.projectItemVOMutable=!0,this.itemObject.hasOwnProperty("projectItemVO"))this.projectItemVO=this.itemObject.projectItemVO,(this.itemObject.isDuplicate||!this.projectItemVO.itemID)&&(this.projectItemVO.itemID=`item_${BeFunky.randomString(10)}`),this.projectItemVO.itemID&&(this.itemID=this.projectItemVO.itemID);else{switch(this.projectItemVO=new BFN.ProjectItemVO,this.projectItemVO.itemID=`item_${BeFunky.randomString(10)}`,this.itemID=`item_${BeFunky.randomString(10)}`,this.projectItemVO.itemID=this.itemID,this.itemObject.type){case"text":this.projectItemVO.type="label",this.projectItemVO.labelWordBreaksEnabled=!0;break;case"texture":this.itemObject.texture?this.projectItemVO.type=this.itemObject.texture.baseTexture.hasOwnProperty("fabricShape")?"graphic":"image":this.projectItemVO.type=this.basicShapeVO?"graphic":"image";break;case"frame_texture":this.projectItemVO.type="mask_image";break}if(this.itemObject.hasOwnProperty("projectItemAssetID"))switch(this.projectItemVO.type){case"graphic":this.projectItemVO.graphicID=this.itemObject.projectItemAssetID;break;case"image":this.projectItemVO.imageID=this.itemObject.projectItemAssetID;break;case"mask_image":this.projectItemVO.maskImageID=this.itemObject.projectItemAssetID;break}}this.graphicStyle&&(this.projectItemVO.graphicStyle=this.graphicStyle),this.projectItemVO.thumbImageSRC&&(this.thumbImageSRC=this.projectItemVO.thumbImageSRC,this.thumbImageSRCPending=!1,delete this.projectItemVO.thumbImageSRC),this.maskFlippedHorizontal=this.projectItemVO.maskImageMaskFlippedHorizontal,this.maskFlippedVertical=this.projectItemVO.maskImageMaskFlippedVertical,this.itemObject.hasOwnProperty("readyCallback")&&(this.readyCallback=this.itemObject.readyCallback,delete this.itemObject.readyCallback),this.handleMainUIPostPreRenderBind=this.handleMainUIPostPreRender.bind(this),this.handleCanvasScalingUpdatedBind=this.handleCanvasScalingUpdated.bind(this),this.canvasModel.addEventListener(this.canvasModelEvents.CANVAS_SCALING_UPDATED.type,this.handleCanvasScalingUpdatedBind),this.queueShapeUpdate=BeFunky.debounce(this.queueShapeUpdate.bind(this),0),this.queueTextUpdate=BeFunky.debounce(this.queueTextUpdate.bind(this),0),this.updateHitArea=BeFunky.debounce(this.updateHitArea.bind(this),0),BFN.Util.addSetterCallback(this,"rotation",this.updateDropShadowTransform.bind(this)),BFN.Util.addSetterCallback(this.scale,"x",this.updateDropShadowTransform.bind(this)),BFN.Util.addSetterCallback(this.scale,"y",this.updateDropShadowTransform.bind(this))};Q.prototype.initItemContent=function(){switch(this.layerType=null,this.layerName=null,this.layerNum=-1,this.type=this.itemObject.type,this.type){case"texture":case"frame_texture":if(this.itemObject.texture&&this.itemObject.texture.baseTexture&&this.addPresetItemThumbTexture(this.itemObject.texture.baseTexture),this.layerType=this.isGoodie?this.basicShapeVO?"shape":"graphic":"image",this.type==="frame_texture")if(this.handleFrameDraggerDraggingBind=this.handleFrameDraggerDragging.bind(this),this.handleFrameDraggerDraggingCompleteBind=this.handleFrameDraggerDraggingComplete.bind(this),this.itemContent=new BFN.FrameSprite,this.itemContent.updateDisplayCallback=()=>{this.resetTransparency()},this.itemObject.texture.baseTexture.isTemplateAsset=this.isTemplateItem,this.itemContent.setTexture(new PIXI.Texture(this.itemObject.texture.baseTexture)),this.itemObject.hasOwnProperty("projectItemVO")?(this.itemContent.frameWidth=this.projectItemVO.maskImageFrameWidth,this.itemContent.frameHeight=this.projectItemVO.maskImageFrameHeight,this.itemContent.textureScale=1,this.itemContent.offsetFactorX=this.projectItemVO.maskImageOffsetFactorX,this.itemContent.offsetFactorY=this.projectItemVO.maskImageOffsetFactorY,this.scale.x=this.projectItemVO.transformScaleX,this.scale.y=this.projectItemVO.transformScaleY,this.itemContent.scale.x=1/this.projectItemVO.transformScaleX,this.itemContent.scale.y=1/this.projectItemVO.transformScaleY):(this.itemContent.frameWidth=this.itemContent.texture.baseTexture.width,this.itemContent.frameHeight=this.itemContent.texture.baseTexture.height),this.itemContent.updateDisplay(),this.itemObject.hasOwnProperty("maskTexture")&&this.itemObject.maskTexture){let e=this.itemObject.maskTexture.baseTexture.hasOwnProperty("fabricShape");if(this.isShape=!!this.basicShapeVO||e,this.fabricShape=e?this.itemObject.maskTexture.baseTexture.fabricShape:null,this.isShape){if(this.fabricShape){let t=null;(this.itemObject.isDuplicate||this.itemObject.newShape)&&(t=()=>{if(this.readyCallback){try{this.readyCallback(this)}catch(r){}delete this.readyCallback}this.itemObject.newShape&&delete this.itemObject.newShape,this.updateShapeTexture(),BFN.MainUI.requestRender()}),this.itemContentMask=new PIXI.Sprite(BFN.SVGManager.getTexture(this.fabricShape,t,{x:this.itemContent.frameWidth,y:this.itemContent.frameHeight})),this.itemContentMask.maskAlphaOnly=!0}else if(this.itemContentMask=new PIXI.Sprite(this.itemObject.maskTexture),this.itemContentMask.pluginName="smooth_picture",this.itemContentMask.maskAlphaOnly=!0,this.updateShapeTexture(),BFN.BasicShapeManager.strokeShapeTypes.includes(this.basicShapeVO.type)&&(this.borderBasicShapeVO=this.basicShapeVO.clone({stroke:-1}),this.itemContentBorder=new PIXI.Sprite,this.itemContentBorder.pluginName="blend_picture"),this.readyCallback){try{this.readyCallback(this)}catch(t){}delete this.readyCallback}}else this.itemContentMask=new PIXI.Sprite(this.itemObject.maskTexture),this.itemContentMask.pluginName="smooth_picture",this.updateShapeTexture()}else this.borderBasicShapeVO=new BFN.BasicShapeVO("rectangle",{fill:-1,stroke:-1}),this.itemContentBorder=new BFN.FrameBorder;else if(this.isShape=!1,this.itemObject.texture?(this.isShape=this.itemObject.texture.baseTexture.hasOwnProperty("fabricShape"),this.fabricShape=this.isShape?this.itemObject.texture.baseTexture.fabricShape:null):this.isShape=!!this.basicShapeVO,this.isShape){this.layerType=this.basicShapeVO?"shape":"graphic";let e=null;this.thumbImageSRC&&(this.thumbImage?this.thumbImage.src=this.thumbImageSRC:(this.thumbImage=new Image,this.thumbImage.src=this.thumbImageSRC));let t=()=>{if(e.baseTexture.isTemplateAsset=this.isTemplateItem,!BeFunky.isSmartphone&&!this.thumbImageSRC&&!this.basicShapeVO&&this.isGoodie&&BFN.SVGManager.textureHasModifiedShapeColors(this.itemContent.texture)||this.updateShapeTexture(),this.thumbImageSRC)this.thumbTexture=null,this.thumbImage?this.thumbImage.src=this.thumbImageSRC:(this.thumbImage=new Image,this.thumbImage.src=this.thumbImageSRC),delete this.thumbImageSRC,delete this.thumbImageSRCPending;else if(!BeFunky.isSmartphone){let a=BFN.TransformStateModel.getThumb(this),s=BFN.Util.getHTMLImage(a,null,!0);a.destroyGC(!0),this.thumbTexture&&(this.thumbTexture.destroyGC(!0),this.thumbTexture=null),this.thumbImage?this.thumbImage.src=s.src:(this.thumbImage=new Image,this.thumbImage.src=s.src)}this.updateContentDimensions(),this.updateSmoothingScale()};if(this.basicShapeVO)e=PIXI.RenderTexture.create(this.basicShapeVO.shapeW,this.basicShapeVO.shapeH),e.fillColor(0,0),this.thumbImageSRC&&(this.thumbImageSRCPending=!0),setTimeout(t,0);else{this.thumbImageSRC&&(this.thumbImageSRCPending=!0);let r=null;this.itemObject.isDuplicate&&this.itemObject.sourceTransformItem&&(r=this.itemObject.sourceTransformItem.itemContent.texture.baseTexture.fabricShapeColorMap||null),e=BFN.SVGManager.getTexture(this.fabricShape,t,null,r)}this.itemContent=new PIXI.Sprite(e)}else this.itemObject.texture.baseTexture.isTemplateAsset=this.isTemplateItem,this.itemContent=new PIXI.Sprite(new PIXI.Texture(this.itemObject.texture.baseTexture));if(this.updateContentDimensions(),this.itemObject.hasOwnProperty("projectItemVO"))this.type==="frame_texture"&&(this.scale.x=this.projectItemVO.transformScaleX,this.scale.y=this.projectItemVO.transformScaleY);else if(this.itemObject.hasOwnProperty("initialDimensions")&&this.itemObject.initialDimensions)this.scale.x=this.itemObject.initialDimensions.x/this.itemContent.texture.baseTexture.width,this.scale.y=this.itemObject.initialDimensions.y/this.itemContent.texture.baseTexture.height;else if(this.itemObject.hasOwnProperty("initialScale")&&this.itemObject.initialScale)this.scale.x=this.itemObject.initialScale.x,this.scale.y=this.itemObject.initialScale.y;else{let e=Math.min(this.itemObject.initialFrameWidth/this.itemContentW,this.itemObject.initialFrameHeight/this.itemContentH)*this.addedTextureScaleFactor;if(this.scale.x=this.scale.y=this.isShape?e:Math.min(1,e),!this.itemObject.projectItemVO&&this.projectItemVO.type==="graphic"&&this.basicShapeVO)switch(this.basicShapeVO.type){case"line":this.scale.y*=.2;break;case"arrow":this.scale.y*=.5;break}}this.updateFrameTextureDisplay(),this.resetFrameTextureScale();break;case"text":this.layerType="text";let i=this.itemObject.isDuplicate?"":this.itemObject.text||BeFunky.LanguageManager.getString("click_when_selected");this.iText=new fabric.TextboxPad(i,{left:0,top:0,textAlign:"left",fontFamily:BFN.FabricManager.defaultFontFamily,fontSize:BFN.TransformItemTextBaseFontSize,padding:10,lineHeight:BFN.TransformItemTextBaseLineHeight,wordBreaksEnabled:this.projectItemVO.labelWordBreaksEnabled}),this.iText.transformItem=this,this.iText.strokeWidth=0,this.iText.objectCaching=!1,this.iText.paintFirst="stroke",this.iText._styleProperties.push("strokePercent"),this.conformTextWidthToContent(this.iText),this.iText.selectable=!1,this.iText.hasBorders=!1,this.iText.hasControls=!1,this.defaultTextStyles={fontFamily:BFN.FabricManager.defaultFontFamily,fontSize:BFN.TransformItemTextBaseFontSize,fill:"rgb(0,0,0,1)",textBackgroundColor:"",stroke:"",strokeWidth:1,strokePercent:BFN.TransformItemTextStrokePercentDefault};for(let e=0;e<this.iText.text.length;e++)this.iText._extendStyles(e,this.defaultTextStyles);if(this.itemsAffectedByTextHeight=[],this.preChangeTextHeight=0,this.handleTextHeightChangedBind=this.handleTextHeightChanged.bind(this),this.iText.on("height:changed",this.handleTextHeightChangedBind),this.itemObject.hasOwnProperty("isDuplicate")&&this.itemObject.isDuplicate&&this.itemObject.hasOwnProperty("sourceTransformItem")&&this.itemObject.sourceTransformItem){let{sourceTransformItem:e}=this.itemObject;this.textScale=e.textScale,this.iText.width=e.iText.width,this.iText.scaleX=this.iText.scaleY=this.textScale,this.iTexture=e.iTexture.renderClone();let t=e.iText?e.iText.text.length:"_",r=e.getTextStyleData(),a=(r?r.fontSize==="mixed"?r.fontSizeStart==="mixed"?r.fontSizeMin:r.fontSizeStart:r.fontSize:"_")||"_";this.duplicateData={textLength:t,fontSize:a}}else{let e={backgroundEnabled:"textBackgroundEnabled",backgroundColor:"textBackgroundColor",backgroundIntensity:"textBackgroundIntensity",backgroundPadding:"textBackgroundPadding",outlineEnabled:"textOutlineEnabled",highlightEnabled:"textHighlightEnabled"};for(let o in BFN.FabricManager.userStyle.itemStyles)e.hasOwnProperty(o)&&(this.hasOwnProperty(e[o])||BFN.Util.hasPropertyDescriptor(this,e[o]))&&(this[e[o]]=BFN.FabricManager.userStyle.itemStyles[o]);for(let o in BFN.FabricManager.userStyle.globalStyles)this.iText[o]=BFN.FabricManager.userStyle.globalStyles[o];for(let o=0;o<this.iText.text.length;o++)this.iText._extendStyles(o,BFN.FabricManager.userStyle.charStyles),this.iText._extendStyles(o,{fontSize:BFN.TransformItemTextBaseFontSize});this.conformTextWidthToContent(this.iText),this.textScale=this.itemObject.initialFrameWidth*this.addedTextScaleFactor/this.iText.width,this.iText.scaleX=this.iText.scaleY=this.textScale;let t=this.iText.width*this.textScale,r=this.iText.height*this.textScale,a=Math.round(t+this.textPadding*2*this.textScale),s=Math.round(r+this.textPadding*2*this.textScale);this.iTexture=PIXI.RenderTexture.create(a,s)}this.itemContent=new PIXI.Sprite(this.iTexture),this.updateContentDimensions(),this.scale.x=this.scale.y=1;break}if(this.addChild(this.itemContent),this.itemContent.pluginName="blend_picture",this.itemContent.currentScale=1,this.itemContent.blendMode=BFN.CONST.BLEND_MODES.NORMAL,this.itemContent.smoothEdges=!0,this.itemBlendMode=BFN.CONST.BLEND_MODES.NORMAL,this.itemContentMask&&(this.addChild(this.itemContentMask),this.itemContent.mask=this.itemContentMask),this.itemContentBorder&&this.addChild(this.itemContentBorder),this.type==="text"&&(this.hiResTextReady=!1,this.hiResTextRect=new BFN.Rectangle,this.hiResTextTexture=PIXI.RenderTexture.create(16,16,PIXI.SCALE_MODES.LINEAR,BFN.HiResTextManager.enableRetinaScaling?2:1),this.hiResTextSprite=new PIXI.Sprite(this.hiResTextTexture),this.hiResTextSprite.interactive=!1,this.hiResTextSprite.visible=!1,this.hiResTextSprite.pluginName="blend_picture",this.hiResTextSprite.blendMode=BFN.CONST.BLEND_MODES.NORMAL,this.addChild(this.hiResTextSprite),BFN.HiResTextManager.showHiResTextHelpers&&(this.hiResTextHelper=new PIXI.Graphics,this.addChild(this.hiResTextHelper))),this.type==="text"&&!(this.itemObject.hasOwnProperty("isDuplicate")&&this.itemObject.isDuplicate)&&!this.itemObject.hasOwnProperty("projectItemVO")&&this.setTextWidth(this.itemContentW),this.shapeColorGroupsNum=0,this.shapeColorMap=null,this.shapeObjectFills=!1,this.isGoodie&&this.isShape&&this.layerType==="graphic"&&this.itemContent.texture&&this.itemContent.texture.baseTexture){let i=this.itemContent.texture.baseTexture;if(i.fabricShapeColorMap){this.shapeColorMap=this.itemContent.texture.baseTexture.fabricShapeColorMap;for(let e in this.itemContent.texture.baseTexture.fabricShapeColorMap)this.shapeColorGroupsNum=Math.max(this.shapeColorGroupsNum,parseInt(e)+1)}i.fabricShape&&(this.shapeObjectFills=!!i.fabricShape.containsObjectFills)}if(this.shapeColorMap&&this.itemObject.isDuplicate&&this.itemObject.sourceTransformItem&&BFN.SVGManager.textureHasModifiedShapeColors(this.itemObject.sourceTransformItem.itemContent.texture)){let i=this.itemObject.sourceTransformItem.itemContent.texture.baseTexture.fabricShapeColorMap;for(let e in i){let t=i[e];if(this.shapeColorMap.hasOwnProperty(e)){let r=this.shapeColorMap[e];r.colorHash=t.colorHash,r.colorOpacity=t.colorOpacity}}}BFN.queuedDropShadowItems||(BFN.queuedDropShadowItems=[]),this.dropShadowVO=new BFN.DropShadowVO(this.projectItemVO.dropShadowValues),this.itemObject.isDuplicate&&this.itemObject.sourceTransformItem&&!this.itemObject.sourceTransformItem.itemContentShadow.isEmpty?(this.itemContentShadow=new BFN.TransformItemDropShadow(this.itemObject.sourceTransformItem.itemContentShadow.sourceTexture,this.itemObject.sourceTransformItem.itemContentShadow.shadowTexture),this.itemContentShadow.isDuplicate=!0):this.itemContentShadow=new BFN.TransformItemDropShadow,this.addChildAt(this.itemContentShadow,0),this.itemObject.hasOwnProperty("isDuplicate")&&delete this.itemObject.isDuplicate,this.itemObject.hasOwnProperty("sourceTransformItem")&&delete this.itemObject.sourceTransformItem,this.hoverDropFilter=new BFN.filters.ColorOverlayFilter,this.hoverDropFilter.roundingDisabled=!0,this.hoverDropFilter.color=2154751,this.handleHoverDropAnimatorUpdateBind=this.handleHoverDropAnimatorUpdate.bind(this),this.hoverDropAnimator=new BFN.Animator,this.hoverDropAnimator.addEventListener(BFN.AnimatorEvents.UPDATE.type,this.handleHoverDropAnimatorUpdateBind)};Q.prototype.conformTextWidthToContent=function(i){i.width=Math.pow(2,14),i.initDimensions();let{lines:e}=i._splitTextIntoLines(i.text),t=0;for(let r=0;r<e.length;r++)t=Math.ceil(Math.max(t,i.measureLine(r).width+1));i.width=t};Q.prototype.pressItem=function(i){BFN.TransformItemEvents.PRESS_ITEM.targetItem=this,BFN.TransformItemEvents.PRESS_ITEM.externalPress=!0,BFN.TransformItemEvents.PRESS_ITEM.data={},BFN.TransformItemEvents.PRESS_ITEM.data.originalEvent=i,this.dispatchEvent(BFN.TransformItemEvents.PRESS_ITEM)};Q.prototype.refreshItemThumb=function(){UILayers.handleItemsUpdated()};Q.prototype.refreshItemName=function(){UILayers.handleItemsUpdated()};Q.prototype.initLongPressValues=function(){this.longPressOccurred=!1,this.handlePointerDownBind=this.handlePointerDown.bind(this),this.on("pointerdown",this.handlePointerDownBind)};Q.prototype.handlePointerDown=function(i){this.initiateLongPress()};Q.prototype.initiateLongPress=function(){this.longPressOccurred=!1;let i=e=>{this.longPressOccurred=!0,setTimeout(()=>{this.longPressOccurred=!1},0),BeFunky.dispatchPointerEvent("pointerup",document,e.pointerType,e.clientX,e.clientY,{longPressUp:!0}),this.transformLayer.transformTool.gizmoDragger.dragging&&this.transformLayer.transformTool.gizmoDragger.stopDrag(),this.pressItem(e)};BFN.LongPressManager.initiateLongPress(i)};Q.prototype.selectItem=function(){this.dispatchEvent(BFN.TransformItemEvents.SELECT_ITEM)};Q.prototype.deselectItem=function(){this.dispatchEvent(BFN.TransformItemEvents.DESELECT_ITEM)};Q.prototype.duplicateItem=function(){this.dispatchEvent(BFN.TransformItemEvents.DUPLICATE_ITEM)};Q.prototype.removeItem=function(){this.dispatchEvent(BFN.TransformItemEvents.REMOVE_ITEM)};Q.prototype.destroyItem=function(){this.destroyed||(this.off("pointerdown",this.handlePointerDownBind),this.type==="text"&&this.iText&&this.iText.off("height:changed",this.handleTextHeightChangedBind),this.dispatchEvent(BFN.TransformItemEvents.DESTROY_ITEM))};Q.prototype.updateAccurateBounds=function(i=!1){let e=this.debugAccurateBounds;if(!this.currentTransformItemStateVO)return;let t=this.currentTransformItemStateVO;if(t.accurateBounds)if(this.accurateBounds=t.accurateBounds,i)e&&console.log(this.layerName,"- State has Accurate Bounds, But Recalculating ( Alpha Bounds Forced )");else{e&&(console.log(this.layerName,"- State has Accurate Bounds, Skipping Recalculation"),console.log("")),this.updateHiResTextBounds(),!this.shapeUpdatePending&&!this.textUpdatePending&&this.updateDropShadowSource(),this.dispatchEvent(BFN.TransformItemEvents.ACCURATE_BOUNDS_UPDATED);return}else this.accurateBounds=BFN.Util.getTransformItemBounds(this,!0),this.accurateBounds.minX=this.accurateBounds.minY=0,this.accurateBounds.maxX=this.accurateBounds.width,this.accurateBounds.maxY=this.accurateBounds.height,this.accurateBounds.centerX=this.accurateBounds.width/2,this.accurateBounds.centerY=this.accurateBounds.height/2;if(this.ignoreAccurateBounds){e&&(console.log(this.layerName,"- Accurate Bounds Ignored, Using Approximation from",t.accurateBounds?"state":"polygon"),console.log(""));return}if(this.accurateBoundsTimer=10,this.projectItemVO.hasOwnProperty("labelBounds")&&(this.accurateBoundsTimer=0),this.accurateBoundsRequested){e&&(console.log(this.layerName,"- Accurate Bounds Already Requested, Ignoring Call..."),console.log(""));return}e&&console.log(this.layerName,"Countdown Starting"),this.accurateBoundsRequested=!0,BFN.accurateBoundsQueue.push(this);let r=()=>{if(BFN.accurateBoundsQueue.length&&BFN.accurateBoundsQueue[0]!==this){BFN.accurateBoundsQueue.includes(this)?setTimeout(r,0):this.accurateBoundsRequested=!1;return}if(--this.accurateBoundsTimer>0){BFN.accurateBoundsQueue.includes(this)?setTimeout(r,0):this.accurateBoundsRequested=!1;return}if(e&&console.log(this.layerName,"Countdown Complete"),BFN.accurateBoundsQueue.shift(),this.accurateBoundsRequested=!1,!this.parent){e&&console.log(this.layerName,"No Parent, Aborting...");return}if(!this.currentTransformItemStateVO)return;let a=this.currentTransformItemStateVO;if(a.accurateBounds)if(this.accurateBounds=a.accurateBounds,i)e&&console.log(this.layerName,"- State has Accurate Bounds, But Recalculating ( Alpha Bounds Forced )");else{e&&(console.log(this.layerName,"- State has Accurate Bounds, Skipping Recalculation"),console.log("")),this.updateHiResTextBounds(),!this.shapeUpdatePending&&!this.textUpdatePending&&this.updateDropShadowSource(),this.dispatchEvent(BFN.TransformItemEvents.ACCURATE_BOUNDS_UPDATED);return}else e&&console.log(this.layerName,"- State has No Accurate Bounds, Calculating...");let s=BFN.Util.getTransformItemBounds(this),o=BFN.Util.getTransformItemTexture(this,s);if(o){e&&(console.log(this.layerName,"- Calculating Accurate Alpha Bounds Now..."),console.log(""));let n=1/Math.max(o.width/s.width,o.height/s.height);if(this.accurateBounds=BFN.Util.getAlphaBounds(o,null,n,!1,!1),o.clear(),o.resize(256,256),this.accurateBounds.noBounds){let l=BFN.Util.getTransformItemBounds(this,!0);this.accurateBounds.minX=this.accurateBounds.minY=0,this.accurateBounds.maxX=this.accurateBounds.width=l.width,this.accurateBounds.maxY=this.accurateBounds.height=l.height,this.accurateBounds.centerX=l.width/2,this.accurateBounds.centerY=l.height/2}if(a.accurateBounds=Object.assign({},this.accurateBounds),this.projectItemVO.hasOwnProperty("labelBounds")){let l=s.minX+this.accurateBounds.minX,c=s.minY+this.accurateBounds.minY,h=this.projectItemVO.labelBounds.x-l,u=this.projectItemVO.labelBounds.y-c;this.x+=h,this.y+=u,this.projectItemVO.transformX=this.x,this.projectItemVO.transformY=this.y,this.projectItemVO.labelBounds=null,delete this.projectItemVO.labelBounds,this.setTransitionStartState(),this.setTransitionEndState(),BFN.ProjectManager.requestLocalSave()}else if(this.projectItemVO.hasOwnProperty("positionOffsetVectors")){for(let l=0;l<this.projectItemVO.positionOffsetVectors.length;l++){let c=this.projectItemVO.positionOffsetVectors[l];this.x+=Math.cos(c.direction)*c.distance,this.y+=Math.sin(c.direction)*c.distance}this.projectItemVO.transformX=this.x,this.projectItemVO.transformY=this.y,this.projectItemVO.positionOffsetVectors.splice(0),this.projectItemVO.positionOffsetVectors=null,delete this.projectItemVO.positionOffsetVectors,this.setTransitionStartState(),this.setTransitionEndState(),BFN.ProjectManager.requestLocalSave()}this.updateHiResTextBounds(),this.updateDropShadowSource(),this.dispatchEvent(BFN.TransformItemEvents.ACCURATE_BOUNDS_UPDATED)}BFN.MainUI.requestRender()};r()};Q.prototype.updateSmoothingScale=function(i,e=!0){let t=this.type==="frame_texture"&&!this.canvasScaling?this.itemContent.adjustScale*this.itemContent.textureScaleX:1,r=this.type==="frame_texture"&&!this.canvasScaling?this.itemContent.adjustScale*this.itemContent.textureScaleY:1;this.itemContent.currentScale=(i?this.scale.x*Math.abs(this.itemContent.scale.x)*i:this.canvasScaling?1:this.scale.x*Math.abs(this.itemContent.scale.x)*this.canvasScale)*t,this.itemContent.currentScaleY=(i?this.scale.y*Math.abs(this.itemContent.scale.y)*i:this.canvasScaling?1:this.scale.y*Math.abs(this.itemContent.scale.y)*this.canvasScale)*r,this.itemContentBorder&&(this.itemContentBorder.currentScale=i?this.scale.x*Math.abs(this.itemContentBorder.scale.x)*i:this.canvasScaling?1:this.scale.x*Math.abs(this.itemContentBorder.scale.x)*this.canvasScale,this.itemContentBorder.currentScaleY=i?this.scale.y*Math.abs(this.itemContentBorder.scale.y)*i:this.canvasScaling?1:this.scale.y*Math.abs(this.itemContentBorder.scale.y)*this.canvasScale),this.itemContentShadow&&(this.itemContentShadow.smoothingScaleX=i?1/this.itemContentShadow.adjustScaleX*i:this.canvasScaling?1:1/this.itemContentShadow.adjustScaleX*this.canvasScale,this.itemContentShadow.smoothingScaleY=i?1/this.itemContentShadow.adjustScaleY*i:this.canvasScaling?1:1/this.itemContentShadow.adjustScaleY*this.canvasScale),this.curvedText&&this.curvedText.setSmoothingScale(i?this.scale.x*i:this.canvasScaling?1:this.scale.x*this.canvasScale),e&&BFN.MainUI.requestRender()};Q.prototype.setItemScaleMode=function(i){this.itemContent.texture.setScaleMode(i),this.curvedText&&this.curvedText.setScaleMode(i)};Q.prototype.updateContentDimensions=function(){(this.itemContentW!=this.itemContent.width||this.itemContentH!=this.itemContent.height)&&(this.type==="text"?(this.itemContent.scale.x=Math.abs(this.itemContent.scale.x)*(this.flippedHorizontal?-1:1),this.itemContent.scale.y=Math.abs(this.itemContent.scale.y)*(this.flippedVertical?-1:1),this.textItemContentW=this.itemContent.width-Math.round(this.textPadding*2*this.textScale),this.textItemContentH=this.itemContent.height-Math.round(this.textPadding*2*this.textScale),this.textCurveActive?(this.itemContentW=this.curvedText.width,this.itemContentH=this.curvedText.height):(this.itemContentW=this.textItemContentW,this.itemContentH=this.textItemContentH)):(this.itemContentW=this.itemContent.width,this.itemContentH=this.itemContent.height,this.basicShapeVO&&(this.itemContentW=this.type==="frame_texture"?Math.round(this.basicShapeVO.shapeW/this.basicShapeVO.fitScale):100,this.itemContentH=this.type==="frame_texture"?Math.round(this.basicShapeVO.shapeH/this.basicShapeVO.fitScale):100)),this.itemContentW=Math.abs(this.itemContentW),this.itemContentH=Math.abs(this.itemContentH),this.textCurveActive&&this.updateDropShadowPosition(),this.updateBounds())};Q.prototype.updateBounds=function(){if(this.bounds=new PIXI.Rectangle(0,0,this.itemContentW,this.itemContentH),this.polygon=[new PIXI.Point(0,0),new PIXI.Point(this.itemContentW,0),new PIXI.Point(this.itemContentW,this.itemContentH),new PIXI.Point(0,this.itemContentH)],this.type==="text"){let i=this.textPadding*this.textScale;this.textPolygon=[new PIXI.Point(-i,-i),new PIXI.Point(this.itemContentW+i,-i),new PIXI.Point(this.itemContentW+i,this.itemContentH+i),new PIXI.Point(-i,this.itemContentH+i)]}this.updateHitArea()};Q.prototype.updateHitArea=function(){if(this.destroyed)return;this.hitArea.points.splice(0);let i=10/this.canvasScale,e=this.itemContentW,t=this.itemContentH;this.itemContentBorder&&this.itemContentBorder.isFrameBorder&&(e+=this.itemContentBorder.thickness*2,t+=this.itemContentBorder.thickness*2);let r=this.itemContentW*this.scale.x,a=this.itemContentH*this.scale.y,s=!!(this.basicShapeVO&&this.basicShapeVO.hitAreaPolygonPoints),o=!!(this.textCurveActive&&this.curvedText&&this.curvedText.hitAreaPolygonPoints);if(r<i||a<i||!s&&!o){let n=(r<i?(i-r)/2:0)/this.scale.x,l=(a<i?(i-a)/2:0)/this.scale.y,c=-n+(this.itemContentW-e)/2,h=-l+(this.itemContentH-t)/2,u=e+n*2,d=t+l*2;this.hitArea.points.push(c,h,c+u,h,c+u,h+d,c,h+d)}else s?this.basicShapeVO.hitAreaPolygonPoints.forEach(n=>{let l=this.maskFlippedHorizontal?!this.flippedHorizontal:this.flippedHorizontal,c=this.maskFlippedVertical?!this.flippedVertical:this.flippedVertical,h=l?this.basicShapeVO.shapeW-n.x:n.x,u=c?this.basicShapeVO.shapeH-n.y:n.y;this.hitArea.points.push(h/this.basicShapeVO.shapeW*this.itemContentW),this.hitArea.points.push(u/this.basicShapeVO.shapeH*this.itemContentH)}):o&&this.curvedText.hitAreaPolygonPoints.forEach(n=>{this.hitArea.points.push(n.x/this.curvedText.width*this.itemContentW),this.hitArea.points.push(n.y/this.curvedText.height*this.itemContentH)})};Q.prototype.destroy=function(i=[]){if(!this.destroyed){if(this.destroyPresetItemThumbTextures(),this.type==="frame_texture"&&(this.hoverDropAnimator.setAnimatorFactor(0),this.hoverDropAnimator.removeEventListener(BFN.AnimatorEvents.UPDATE.type,this.handleHoverDropAnimatorUpdateBind),this.hoverDropAnimator=null,this.hoverDropFilter=null),this.canvasModel.removeEventListener(this.canvasModelEvents.CANVAS_SCALING_UPDATED.type,this.handleCanvasScalingUpdatedBind),!this.itemContent.texture.baseTexture.isPattern)try{this.itemContent.texture.destroyGC(!i.includes(this.itemContent.texture.baseTexture)&&!this.preventBaseTextureDestroy)}catch(e){}if(this.itemContent.destroy(!1),this.curvedText&&(this.removeChild(this.curvedText),this.curvedText.destroyCurvedText(),this.curvedText=null),this.itemContentMask&&(this.itemContent.mask=null,this.itemContentMask.texture.destroyGC(!i.includes(this.itemContentMask.texture.baseTexture)),this.itemContentMask.destroy(!1),this.removeChild(this.itemContentMask)),this.itemContentMaskTexture&&(i.includes(this.itemContentMaskTexture.baseTexture)||this.itemContentMaskTexture.destroyGC(!0),this.itemContentMaskTexture=null),this.itemContentBorder&&(this.itemContentBorder.texture&&this.itemContentBorder.texture!==PIXI.Texture.EMPTY&&this.itemContentBorder.texture.destroyGC(!0),this.itemContentBorder.destroy(!1),this.removeChild(this.itemContentBorder),this.itemContentBorder=null),this.itemContentShadow&&(this.itemContentShadow.destroy(),this.removeChild(this.itemContentShadow),this.itemContentShadow=null),this.type!=="text"){try{this.thumbTexture.destroyGC(!0)}catch(e){}try{this.thumbImage.src=""}catch(e){}}this.thumbTexture=null,this.thumbImage=null,this.removeChild(this.itemContent),this.itemContent=null,this.hiResTextTexture&&(this.hiResTextTexture.destroy(!0),this.hiResTextTexture=null),this.hiResTextSprite&&this.children.includes(this.hiResTextSprite)&&(this.hiResTextSprite.destroy(!1),this.removeChild(this.hiResTextSprite),this.hiResTextSprite=null),this.hiResTextHelper&&this.children.includes(this.hiResTextHelper)&&(this.removeChild(this.hiResTextHelper),this.hiResTextHelper=null),this.destroyed=!0}};Q.prototype.updateHiResTextBounds=function(i=!0,e=null,t=!1){if(!BFN.HiResTextManager.useHiResText){e&&e();return}if(this.type!=="text"||BFN.FabricManager.showingTransformItemIText||BFN.FabricManager.currentTextTransformItem===this&&!t){e&&e();return}e&&(this.updateHiResTextBoundsCallback=e),this.hiResTextReady=!1,this.toggleHiResText(!1);let r=BFN.HiResTextManager.hiResTextViewportBounds,{globalTextPolygon:a}=this,s=Math.max(r.left,Math.min(a[0].x,a[1].x,a[2].x,a[3].x)),o=Math.max(r.top,Math.min(a[0].y,a[1].y,a[2].y,a[3].y)),n=Math.min(r.right,Math.max(a[0].x,a[1].x,a[2].x,a[3].x)),l=Math.min(r.bottom,Math.max(a[0].y,a[1].y,a[2].y,a[3].y)),c=new BFN.Rectangle(s,o,n-s,l-o),h=this.toLocal(new PIXI.Point(Math.round(c.x),Math.round(c.y)),BFN.MainUI);this.hiResTextRect.globalX=Math.round(c.x),this.hiResTextRect.globalY=Math.round(c.y),this.hiResTextRect.x=h.x,this.hiResTextRect.y=h.y,this.hiResTextRect.width=Math.max(0,Math.ceil(c.width)),this.hiResTextRect.height=Math.max(0,Math.ceil(c.height)),BFN.HiResTextManager.showHiResTextHelpers&&(this.hiResTextHelper.x=this.hiResTextRect.x,this.hiResTextHelper.y=this.hiResTextRect.y,this.hiResTextHelper.rotation=-this.rotation,this.hiResTextHelper.scale.x=this.hiResTextHelper.scale.y=1/this.canvasScale/this.scale.x,this.hiResTextHelper.clear(),this.hiResTextRect.width&&this.hiResTextRect.height&&(this.hiResTextHelper.lineStyle(2,65280),this.hiResTextHelper.drawRect(0,0,this.hiResTextRect.width,this.hiResTextRect.height),this.hiResTextRect.width>10&&this.hiResTextRect.height>10&&(this.hiResTextHelper.lineStyle(1,65280),this.hiResTextHelper.drawRect(5,5,this.hiResTextRect.width-10,this.hiResTextRect.height-10)))),i&&!this.awaitingPreRender&&(this.awaitingPreRender=!0,BFN.MainUI.addEventListener(BFN.MainUIEvents.POST_PRE_RENDER.type,this.handleMainUIPostPreRenderBind))};Q.prototype.handleMainUIPostPreRender=function(){BFN.MainUI.removeEventListener(BFN.MainUIEvents.POST_PRE_RENDER.type,this.handleMainUIPostPreRenderBind),this.awaitingPreRender=!1,BFN.HiResTextManager.conformHiResTextCanvas(),BFN.FabricManager.showingTransformItemIText||this.renderHiResText(this.updateHiResTextBoundsCallback?this.updateHiResTextBoundsCallback:void 0),delete this.updateHiResTextBoundsCallback};Q.prototype.updateHiResText=function(){};Q.prototype.renderHiResText=function(i=null){BFN.HiResTextManager.useHiResText&&this.type==="text"&&this.hiResTextRect.width&&this.hiResTextRect.height&&!this.hiResTextReady&&(this.hiResTextTexture.resize(Math.ceil(this.hiResTextRect.width),Math.ceil(this.hiResTextRect.height)),BFN.HiResTextManager.showHiResTextHelpers&&this.hiResTextTexture.fillColor(128,.5),this.hiResTextSprite.x=this.hiResTextRect.x,this.hiResTextSprite.y=this.hiResTextRect.y,this.hiResTextSprite.rotation=-this.rotation,this.hiResTextSprite.scale.x=this.hiResTextSprite.scale.y=1/this.canvasScale/this.scale.x,BFN.HiResTextManager.conformITextToTransformItem(this),BFN.HiResTextManager.drawHiResTextToTransformItem(this),this.hiResTextReady=!0,this.toggleHiResText(!0),BFN.MainUI.requestRender()),i&&i()};Q.prototype.toggleHiResText=function(i){if(this.type!=="text")return;let e=!!(BFN.HiResTextManager.useHiResText&&this.hiResTextReady&&i),t=!([BFN.TransformModel.selectedTransformItem,BFN.TransformModel.selectedTransformItemText].includes(this)&&BFN.FabricManager.showingTransformItemIText);this.hiResTextSprite.visible=e&&t,this.itemContent.visible=!e&&t&&!this.textCurveActive,this.curvedText&&(this.curvedText.visible=!e&&t&&this.textCurveActive)};Q.prototype.createTransition=function(i,e=!1,t=!1,r=null){this.transitionVO&&(this.transitionVO.id!==i||!this.transitionVO.isGroupTransition&&this.isGroupTransition)&&(this.lastTransitionVO=null),this.transitionVO=new BFN.TransformItemTransitionVO,this.transitionVO.id=i,this.transitionVO.translation=r,this.transitionVO.transformItem=this,this.transitionVO.isCreateTransition=e,this.transitionVO.isGroupTransition=!!this.isGroupTransition,this.transitionVO.useGroupIcon=t,this.setTransitionStartState(),this.accurateBounds&&(this.transitionVO.startState.accurateBounds=Object.assign({},this.accurateBounds)),this.type==="text"&&this.iText&&this.updateItemsAffectedByTextHeight()};Q.prototype.registerTransition=function(i=!1,e=!0){if(this.transitionVO){let t=this.dropShadowVO.enabled&&(this.itemContentShadow.isEmpty||this.dropShadowRequiresRefresh);this.transitionVO.startState.refreshDropShadow=t,this.transitionVO.endState.refreshDropShadow=t,this.setTransitionEndState(),this.currentTransformItemStateVO=this.transitionVO.endState,i?(this.lastTransitionVO?(this.currentTransformItemStateVO=this.lastTransitionVO.endState,this.updateStateVO(this.currentTransformItemStateVO)):(this.ignoreTextHeight||(this.transitionVO.batchIDPlaceholder=this.registerItemsAffectedByTextHeight()),this.lastTransitionVO=this.transitionVO,this.dispatchEvent(BFN.TransformItemEvents.REGISTER_TRANSITION)),e&&(this.currentTransformItemStateVO&&(this.currentTransformItemStateVO.accurateBounds=null),this.updateAccurateBounds())):(this.ignoreTextHeight||(this.transitionVO.batchIDPlaceholder=this.registerItemsAffectedByTextHeight()),this.lastTransitionVO=null,this.dispatchEvent(BFN.TransformItemEvents.REGISTER_TRANSITION),e?(this.currentTransformItemStateVO&&(this.currentTransformItemStateVO.accurateBounds=null),this.updateAccurateBounds()):this.currentTransformItemStateVO&&!this.currentTransformItemStateVO.accurateBounds&&this.transitionVO.startState.accurateBounds&&(this.debugAccurateBounds&&console.log(this.layerName,"- Applying startState Bounds to endState Bounds"),this.currentTransformItemStateVO.accurateBounds=Object.assign({},this.transitionVO.startState.accurateBounds)))}this.duplicateData&&delete this.duplicateData,this.updateProjectItemVO()};Q.prototype.setTransition=function(i){this.transitionVO=i,this.lastTransitionVO=null};Q.prototype.setTransitionStartState=function(){this.transitionVO&&this.updateStateVO(this.transitionVO.startState)};Q.prototype.setTransitionEndState=function(){this.transitionVO&&this.updateStateVO(this.transitionVO.endState)};Q.prototype.updateStateVO=function(i){this.parent&&(i.parent=this.parent,i.zIndex=this.parent.getChildIndex(this)),i.locked=this._locked,i.hidden=this._hidden,i.x=this.x,i.y=this.y,i.scaleX=this.scale.x,i.scaleY=this.scale.y,i.rotation=this.rotation,i.opacity=this.alpha*100,i.blendMode=this.itemBlendMode,i.tintEnabled=this.tintColorEnabled,i.tint=this.tintColor,i.overlayColorEnabled=this.overlayColorEnabled,i.overlayColor=this.overlayColor,i.overlayColorIntensity=this.overlayColorIntensity,i.flippedHorizontal=this.flippedHorizontal,i.flippedVertical=this.flippedVertical,i.dropShadowValues=this.dropShadowVO.getValues(),this.basicShapeVO&&(i.basicShapeValues=Object.assign({},this.basicShapeVO.getValues())),i.shapeColorMap=this.getShapeColorMap(),this.type==="text"&&(i.text=this.iText.text,i.textStyle=this.getTextStyle(),i.textWidth=this.iText.width,i.textScale=this.textScale,i.textItemScale=this.scale.x,i.textBackgroundEnabled=this.textBackgroundEnabled,i.textBackgroundColor=this.textBackgroundColor,i.textBackgroundIntensity=this.textBackgroundIntensity,i.textBackgroundPadding=this.textBackgroundPadding,i.textOutlineEnabled=this.textOutlineEnabled,i.textHighlightEnabled=this.textHighlightEnabled,i.textCurveEnabled=this.textCurveEnabled,i.textCurveAmount=this.textCurveAmount),this.type==="frame_texture"&&(i.imageID=this.projectItemVO.maskImageID,i.imageTexture=this.itemContent.texture,i.maskImageFrameWidth=this.itemContent.frameWidth,i.maskImageFrameHeight=this.itemContent.frameHeight,i.maskImageOffsetFactorX=this.itemContent.offsetFactorX,i.maskImageOffsetFactorY=this.itemContent.offsetFactorY,i.maskImageTextureScale={x:this.itemContent.textureScaleX,y:this.itemContent.textureScaleY},this.borderBasicShapeVO&&(i.borderEnabled=this._borderEnabled,i.borderValues={stroke:this.borderBasicShapeVO.stroke,strokeAlpha:this.borderBasicShapeVO.strokeAlpha,strokeWidth:this.borderBasicShapeVO.strokeWidth})),this.type==="texture"&&(i.imageID=this.projectItemVO.imageID,i.imageTexture=this.itemContent.texture)};Q.prototype.getTransition=function(){return this.transitionVO};Q.prototype.clearTransition=function(){this.lastTransitionVO=null};Q.prototype.applyTransformItemState=function(i,e=!0){this.currentTransformItemStateVO=i;try{i.parent&&i.parent.children.indexOf(this)!==-1&&i.parent.getChildIndex(this)!=i.zIndex?i.parent.setChildIndex(this,Math.min(this.parent.children.length-1,i.zIndex)):i.parent&&i.parent.children.indexOf(this)===-1?(i.parent.addChild(this),i.parent.setChildIndex(this,Math.min(this.parent.children.length-1,i.zIndex))):this.parent&&!i.parent&&this.parent.removeChild(this)}catch(t){BeFunky.log("LAYER ORDER ERROR")}this.locked=i.locked,this.hidden=i.hidden,this.updateValue(this,"x",i,"x"),this.updateValue(this,"y",i,"y"),this.updateValue(this.scale,"x",i,"scaleX"),this.updateValue(this.scale,"y",i,"scaleY"),this.updateValue(this,"rotation",i,"rotation"),this.alpha=i.opacity/100,this.tintColorEnabled=i.tintEnabled,this.tintColor=i.tint,this.overlayColorEnabled=i.overlayColorEnabled,this.overlayColor=i.overlayColor,this.overlayColorIntensity=i.overlayColorIntensity,this.setBlendMode(i.blendMode),this.basicShapeVO&&i.basicShapeValues&&this.basicShapeVO.setValues(i.basicShapeValues),this.setShapeColorMap(i.shapeColorMap,!1),this._borderEnabled=i.borderEnabled,this.borderBasicShapeVO&&i.borderValues&&this.borderBasicShapeVO.setValues(i.borderValues),this.textCurveEnabled=i.textCurveEnabled,this.textCurveAmount=i.textCurveAmount,this.dropShadowVO.setValues(i.dropShadowValues),["text","frame_texture"].includes(this.type)||this.shapeUpdatePending||(this.shapeUpdatePending=!0,this.queueShapeUpdate()),this.type==="text"&&(this.pendingTransformItemState=i,this.textUpdatePending||(this.textUpdatePending=!0,BFN.MainUI.rendering=!1,this.renderable=!1,this.queueTextUpdate())),this.type==="frame_texture"?(i.imageID&&this.projectItemVO.maskImageID!==i.imageID&&(this.projectItemVO.maskImageID=i.imageID),i.imageTexture&&this.itemContent.texture!==i.imageTexture&&(this.itemObject.texture=i.imageTexture,this.itemContent.setTexture(i.imageTexture),this.updateThumb()),this.itemContent.frameWidth=i.maskImageFrameWidth,this.itemContent.frameHeight=i.maskImageFrameHeight,this.itemContent.textureScaleX=i.maskImageTextureScale.x,this.itemContent.textureScaleY=i.maskImageTextureScale.y,this.itemContent.offsetFactorX=i.maskImageOffsetFactorX,this.itemContent.offsetFactorY=i.maskImageOffsetFactorY,this.itemContent.updateDisplay(),this.itemContentW=this.itemContent.frameWidth,this.itemContentH=this.itemContent.frameHeight,this.updateBounds(),this.updateSmoothingScale()):this.updateHitArea(),this.type==="texture"&&!this.isGoodie&&(i.imageID&&this.projectItemVO.imageID!==i.imageID&&(this.projectItemVO.imageID=i.imageID),i.imageTexture&&this.itemContent.texture!==i.imageTexture&&(this.itemObject.texture=i.imageTexture,this.itemContent.texture=i.imageTexture,this.updateThumb(),this.updateContentDimensions())),i.flippedHorizontal!=this.flippedHorizontal&&this.flipHorizontal(),i.flippedVertical!=this.flippedVertical&&this.flipVertical(),this.updateFrameTextureDisplay(),this.resetFrameTextureScale(),this.thumbImageSRC&&!this.thumbImageSRCPending&&(delete this.thumbImageSRC,delete this.thumbImageSRCPending),e&&(this.transitionVO=this.lastTransitionVO=null),this.dispatchEvent(BFN.TransformItemEvents.TRANSITION_APPLIED),this.shapeUpdatePending||this.updateSmoothingScale(),i.refreshDropShadow&&(!this.itemContentShadow.shadowStateID||this.itemContentShadow.shadowStateID&&this.itemContentShadow.shadowStateID!==this.currentTransformItemStateVO.id)?this.clearDropShadow():this.updateDropShadowDisplay(),this.updateAccurateBounds(),this.updateProjectItemVO(),this.model.updateProjectVO(),BFN.MainUI.requestRender()};Q.prototype.updateValue=function(i,e,t,r){try{i[e]=t[r]}catch(a){}};Q.prototype.updateProjectItemVO=function(){if(this.projectItemVO&&!BFN.ProjectManager.transformItemsPending){switch(this.projectItemVO.type){case"graphic":this.basicShapeVO&&(this.projectItemVO.basicShapeValues=this.basicShapeVO.getValues()),this.graphicStyle&&(this.projectItemVO.graphicStyle=this.graphicStyle),this.projectItemVO.shapeColorMap=this.getShapeColorMap();break;case"image":this.graphicStyle&&(this.projectItemVO.graphicStyle=this.graphicStyle);break;case"mask_image":this.type==="frame_texture"&&(this.projectItemVO.maskImageFrameWidth=this.itemContent.frameWidth,this.projectItemVO.maskImageFrameHeight=this.itemContent.frameHeight,this.projectItemVO.maskImageOffsetFactorX=this.itemContent.offsetFactorX,this.projectItemVO.maskImageOffsetFactorY=this.itemContent.offsetFactorY,this.projectItemVO.maskImageTextureScale={x:this.itemContent.textureScaleX,y:this.itemContent.textureScaleY},this.basicShapeVO&&(this.projectItemVO.basicShapeValues=this.basicShapeVO.getValues()),this.borderBasicShapeVO&&(this.projectItemVO.borderEnabled=this._borderEnabled,this.projectItemVO.borderValues={stroke:this.borderBasicShapeVO.stroke,strokeAlpha:this.borderBasicShapeVO.strokeAlpha,strokeWidth:this.borderBasicShapeVO.strokeWidth}));break;case"label":this.type==="text"&&(this.projectItemVO.labelText=this.iText.text,this.projectItemVO.labelTextStyles=this.getTextStyle(),this.projectItemVO.labelWidth=this.iText.width,this.projectItemVO.labelTextScale=this.textScale,this.projectItemVO.labelTextItemScale=this.scale.x,this.projectItemVO.labelTextBackgroundEnabled=this.textBackgroundEnabled,this.projectItemVO.labelTextBackgroundColor=this.textBackgroundColor,this.projectItemVO.labelTextBackgroundIntensity=this.textBackgroundIntensity,this.projectItemVO.labelTextBackgroundPadding=this.textBackgroundPadding,this.projectItemVO.labelTextOutlineEnabled=this.textOutlineEnabled,this.projectItemVO.labelTextHighlightEnabled=this.textHighlightEnabled,this.projectItemVO.labelTextCurveEnabled=this.textCurveEnabled,this.projectItemVO.labelTextCurveAmount=this.textCurveAmount,this.projectItemVO.labelWordBreaksEnabled=this.iText.wordBreaksEnabled);break;default:return}this.projectItemVO.dropShadowValues=this.dropShadowVO.getValues(),this.projectItemVO.layerName=this.layerName,this.projectItemVO.layerNum=this.layerNum,this.parent&&(this.projectItemVO.transformZIndex=this.parent.getChildIndex(this)),this.projectItemVO.isGoodie=this.isGoodie,this.projectItemVO.transformLocked=this._locked,this.projectItemVO.transformHidden=this._hidden,this.projectItemVO.transformX=this.x,this.projectItemVO.transformY=this.y,this.projectItemVO.transformRotation=this.rotation,this.projectItemVO.transformScaleX=this.scale.x,this.projectItemVO.transformScaleY=this.scale.y,this.projectItemVO.transformWidth=this.itemContentW*this.scale.x,this.projectItemVO.transformHeight=this.itemContentH*this.scale.y,this.projectItemVO.transformFlippedHorizontal=this.flippedHorizontal,this.projectItemVO.transformFlippedVertical=this.flippedVertical,this.projectItemVO.transformOpacity=this.alpha*100,this.projectItemVO.transformBlendMode=this.itemBlendMode,this.projectItemVO.transformOverlayColorEnabled=this.overlayColorEnabled,this.projectItemVO.transformOverlayColor=this.overlayColor,this.projectItemVO.transformOverlayColorIntensity=this.overlayColorIntensity,this.projectItemVO.transformTintColorEnabled=this.tintColorEnabled,this.projectItemVO.transformTintColor=this.tintColor,BFN.ProjectManager.requestLocalSave()}};Q.prototype.updateFrameTextureDisplay=function(){this.type==="frame_texture"&&(this.itemContent.frameWidth=this.itemContentW*this.scale.x,this.itemContent.frameHeight=this.itemContentH*this.scale.y,this.itemContent.scale.x=1/this.scale.x*(this.flippedHorizontal?-1:1),this.itemContent.scale.y=1/this.scale.y*(this.flippedVertical?-1:1),this.itemContent.updateDisplay())};Q.prototype.resetFrameTextureScale=function(){this.type==="frame_texture"&&(this.itemContent.frameWidth=Math.abs(this.itemContent.width/this.itemContent.scale.x),this.itemContent.frameHeight=Math.abs(this.itemContent.height/this.itemContent.scale.y),this.itemContent.x=this.flippedHorizontal?this.itemContent.frameWidth:0,this.itemContent.y=this.flippedVertical?this.itemContent.frameHeight:0,this.itemContent.scale.x=this.flippedHorizontal?-1:1,this.itemContent.scale.y=this.flippedVertical?-1:1,this.itemContent.updateDisplay(),this.scale.x=this.scale.y=1,this.updateContentDimensions(),this.shapeUpdatePending||(this.shapeUpdatePending=!0,this.queueShapeUpdate()))};Q.prototype.resetFrameTexture=function(){this.type==="frame_texture"&&(this.clearDropShadow(),this.createTransition("history_image_region"),this.itemContent.textureScaleX=this.itemContent.textureScaleY=1,this.itemContent.offsetFactorX=this.itemContent.offsetFactorY=.5,this.itemContent.updateDisplay(),this.updateContentDimensions(),this.updateAccurateBounds(),this.updateSmoothingScale(),this.registerTransition(!1,!1),BFN.TransformModel.transformToolFrame&&BFN.TransformModel.transformToolFrame.transformItem===this&&BFN.TransformModel.transformToolFrame.setup(this))};Q.prototype.fitFrameToImage=function(){if(this.type==="frame_texture"){this.clearDropShadow(),this.createTransition("history_image_region");let i=this.itemContent.imageRect.x,e=this.itemContent.imageRect.y,t=Math.sqrt(i**2+e**2),r=Math.atan2(e,i)+this.rotation;this.x+=Math.cos(r)*t,this.y+=Math.sin(r)*t,this.itemContent.frameWidth=this.itemContent.imageRect.width,this.itemContent.frameHeight=this.itemContent.imageRect.height,this.itemContent.textureScaleX=this.itemContent.textureScaleY=1,this.itemContent.offsetFactorX=this.itemContent.offsetFactorY=.5,this.itemContent.updateDisplay(),this.resetFrameTextureScale(),this.updateContentDimensions(),this.updateAccurateBounds(),this.updateSmoothingScale(),this.transformTool.updateDisplay(),this.registerTransition(!1,!1),BFN.TransformModel.transformToolFrame&&BFN.TransformModel.transformToolFrame.transformItem===this&&BFN.TransformModel.transformToolFrame.setup(this)}};Q.prototype.dragFrame=function(i){this.type==="frame_texture"&&(BFN.hasOwnProperty("FrameDragger")||(BFN.FrameDragger=new BFN.Dragger,BFN.FrameDragger.useBounds=!1,BFN.FrameDragger.autoDrag=!1),this.frameDraggerStartMousePosition=this.getPointerPosition(i),this.frameStartOffsetFactors=new PIXI.Point(this.itemContent.offsetFactorX,this.itemContent.offsetFactorY),this.frameOffsetFactorPixelSteps=new PIXI.Point(this.itemContent.excessX?1/(this.itemContent.excessX*this.itemContent.adjustScale*this.itemContent.textureScaleX):0,this.itemContent.excessY?1/(this.itemContent.excessY*this.itemContent.adjustScale*this.itemContent.textureScaleY):0),this.clearDropShadow(),this.createTransition("history_image_region"),BFN.FrameDragger.addEventListener(BFN.DraggerEvents.DRAGGING.type,this.handleFrameDraggerDraggingBind),BFN.FrameDragger.addEventListener(BFN.DraggerEvents.DRAGGING_COMPLETE.type,this.handleFrameDraggerDraggingCompleteBind),BFN.FrameDragger.drag(this))};Q.prototype.handleFrameDraggerDragging=function(){if(this.type==="frame_texture"){let i=this.getPointerPosition(BFN.MainUI.pointerEvent),e=(this.frameDraggerStartMousePosition.x-i.x)*(this.flippedHorizontal?-1:1),t=(this.frameDraggerStartMousePosition.y-i.y)*(this.flippedVertical?-1:1),r=this.frameStartOffsetFactors.x+e*this.frameOffsetFactorPixelSteps.x,a=this.frameStartOffsetFactors.y+t*this.frameOffsetFactorPixelSteps.y;r<0?(this.frameStartOffsetFactors.x+=Math.abs(r),r=0):r>1&&(this.frameStartOffsetFactors.x-=r-1,r=1),a<0?(this.frameStartOffsetFactors.y+=Math.abs(a),a=0):a>1&&(this.frameStartOffsetFactors.y-=a-1,a=1),this.itemContent.offsetFactorX=r,this.itemContent.offsetFactorY=a,this.itemContent.updateDisplay()}};Q.prototype.handleFrameDraggerDraggingComplete=function(){this.type==="frame_texture"&&(BFN.FrameDragger.removeEventListener(BFN.DraggerEvents.DRAGGING.type,this.handleFrameDraggerDraggingBind),BFN.FrameDragger.removeEventListener(BFN.DraggerEvents.DRAGGING_COMPLETE.type,this.handleFrameDraggerDraggingCompleteBind),BFN.FrameDragger.wasDragged?this.registerTransition():this.updateDropShadowSource())};Q.prototype.showImageDropState=function(){this.hoverDropAnimator&&BFN.TransformModel.awaitingDrop&&(this.hasDropOptions=this.type==="frame_texture"&&!this.itemContentMask&&this.isTransparent,this.hoverDropAnimator.increase())};Q.prototype.hideImageDropState=function(){this.hoverDropAnimator&&this.hoverDropAnimator.decrease()};Q.prototype.handleHoverDropAnimatorUpdate=function(i){let e=this.projectItemVO.transformOpacity/100;this.alpha=e+this.hoverDropAnimator.animationFactor*(1-e),this.hoverDropFilter.intensity=this.hoverDropAnimator.animationFactor*.4,this.itemContent.blendMode=this.hoverDropAnimator.animationFactor>0?BFN.CONST.BLEND_MODES.NORMAL:this.itemBlendMode;let t=this.hoverDropAnimator.animationFactor>0?[this.hoverDropFilter]:[];this.itemContent.filters=this.itemContent.visible?t:[],this.type==="text"&&(this.hiResTextSprite&&(this.hiResTextSprite.filters=this.hiResTextSprite.visible?t:[]),this.curvedText&&(this.curvedText.filters=this.curvedText.visible?t:[])),this.itemContentBorder&&(this.itemContentBorder.filters=this.itemContentBorder.visible?t:[])};Q.prototype.resetTransparency=function(){this._isTransparent!==void 0&&(this._isTransparent=void 0)};Q.prototype.updateThumb=function(){if(this.thumbImageSRC)this.thumbImage=new Image,this.thumbImage.src=this.thumbImageSRC,delete this.thumbImageSRC,delete this.thumbImageSRCPending;else if(!BeFunky.isSmartphone){let i=BFN.TransformStateModel.getThumb(this),e=BFN.Util.getHTMLImage(i,null,!0);i.destroyGC(!0),this.thumbImage=e}this.dispatchEvent(BFN.TransformItemEvents.THUMB_UPDATED)};Q.prototype.replaceImage=function({_imageID:i,_imageTexture:e,_historyTag:t="replace_image",_historyTranslation:r=null,_xOffset:a=0,_yOffset:s=0,_keepFrameTextureParams:o=!1,_frameTextureParams:n=null,_maintainFlipState:l=!1}){if(this.type==="frame_texture"){this.clearDropShadow(),this.createTransition(t,!1,!1,r),this.itemObject.texture=e,this.projectItemVO.maskImageID=i;let c={};o&&(c.textureScaleX=this.itemContent.textureScaleX,c.textureScaleY=this.itemContent.textureScaleY,c.offsetFactorX=this.itemContent.offsetFactorX,c.offsetFactorY=this.itemContent.offsetFactorY),n&&(n.hasOwnProperty("frameWidth")&&(c.frameWidth=n.frameWidth),n.hasOwnProperty("frameHeight")&&(c.frameHeight=n.frameHeight),n.hasOwnProperty("textureScaleX")&&(c.textureScaleX=n.textureScaleX),n.hasOwnProperty("textureScaleY")&&(c.textureScaleY=n.textureScaleY),n.hasOwnProperty("offsetFactorX")&&(c.offsetFactorX=n.offsetFactorX),n.hasOwnProperty("offsetFactorY")&&(c.offsetFactorY=n.offsetFactorY)),this.itemContent.wasReplaced=!0,this.itemContent.setTexture(new PIXI.Texture(e.baseTexture)),this.itemContent.frameWidth=c.frameWidth||this.itemContent.frameWidth,this.itemContent.frameHeight=c.frameHeight||this.itemContent.frameHeight,this.itemContent.textureScaleX=c.textureScaleX||1,this.itemContent.textureScaleY=c.textureScaleY||1,this.itemContent.offsetFactorX=c.offsetFactorX||.5,this.itemContent.offsetFactorY=c.offsetFactorY||.5,this.itemContent.updateDisplay(),this.x+=a,this.y+=s,this.updateShapeTexture(),this.updateContentDimensions(),this.flippedHorizontal&&(this.flipHorizontal(),l&&this.flipHorizontal()),this.flippedVertical&&(this.flipVertical(),l&&this.flipVertical()),this.updateSmoothingScale(),this.updateThumb(),this.registerTransition(),t==="replace_image"&&this.addPresetItemThumbTexture(e.baseTexture,this.transitionVO.endState.creationTime)}else this.type==="texture"&&!this.isGoodie&&(this.clearDropShadow(),this.createTransition(t,!1,!1,r),this.itemObject.texture=e,this.projectItemVO.imageID=i,this.itemContent.wasReplaced=!0,this.itemContent.texture=e,this.x+=a,this.y+=s,this.updateContentDimensions(),this.flippedHorizontal&&(this.flipHorizontal(),l&&this.flipHorizontal()),this.flippedVertical&&(this.flipVertical(),l&&this.flipVertical()),this.updateSmoothingScale(),this.updateThumb(),this.registerTransition(),t==="replace_image"&&this.addPresetItemThumbTexture(e.baseTexture,this.transitionVO.endState.creationTime));this.resetTransparency()};Q.prototype.getShapeColorGroupColor=function(i){let e={color:-1,opacity:1};return this.shapeColorMap&&this.shapeColorMap.hasOwnProperty(i)&&(e.color=this.shapeColorMap[i].colorHash,e.opacity=this.shapeColorMap[i].colorOpacity),e};Q.prototype.setShapeColorGroupColor=function(i,e=-1,t=1,r=!0,a=!1){if(this.shapeColorMap&&this.shapeColorMap.hasOwnProperty(i)){let s=this.shapeColorMap[i];if((e===-1&&s.colorHash!==-1||a)&&(e=s.colorHashOriginal,t=s.colorOpacityOriginal),s.colorHash=e,s.colorOpacity=t,this.hasOwnProperty("updateShapeTextureTimeout")&&(clearTimeout(this.updateShapeTextureTimeout),delete this.updateShapeTextureTimeout),r)this.updateShapeTexture(!0);else try{this.itemContent.texture.baseTexture.drawPeriod,this.updateShapeTextureTimeout=setTimeout(()=>{clearTimeout(this.updateShapeTextureTimeout),delete this.updateShapeTextureTimeout,this.updateShapeTexture(!1)},this.itemContent.texture.baseTexture.drawPeriod)}catch(o){}}};Q.prototype.getShapeColorMap=function(){if(!this.shapeColorMap)return null;let i={};for(let e in this.shapeColorMap){let t=this.shapeColorMap[e];i[e]={colorHash:t.colorHash,colorOpacity:t.colorOpacity}}return i};Q.prototype.setShapeColorMap=function(i,e=!0){if(!(!i||!this.shapeColorMap)){for(let t in i){let r=i[t];this.shapeColorMap[t]=this.shapeColorMap[t]||{};for(let a in r)this.shapeColorMap[t][a]=r[a]}e&&this.updateShapeTexture()}};Q.prototype.queueShapeUpdate=function(){BFN.updatingShapeQueue.indexOf(this)===-1&&BFN.updatingShapeQueue.push(this),!BFN.UndoManager.updating&&!BFN.updatingShapeTransformItem?(this.shapeUpdatePending=!1,BFN.updatingShapeTransformItem=this,this.updateShapeTexture(),this.updateDropShadowSource(),BFN.updatingShapeTransformItem=null,BFN.updatingShapeQueue.indexOf(this)!==-1&&BFN.updatingShapeQueue.splice(BFN.updatingShapeQueue.indexOf(this),1)):this.queueShapeUpdate()};Q.prototype.updateShapeTexture=function(i=!0,e=!1){if(!!this.parent){if(this.isShape){let t=this.itemContentMask?this.itemContentMask:this.itemContent,r=null;if(this.type==="frame_texture"){this.basicShapeVO?this.basicShapeVO.updateTexture(t.texture,this.itemContent.frameWidth,this.itemContent.frameHeight,i):BFN.SVGManager.updateTexture(t.texture,null,null,this.itemContent.frameWidth,this.itemContent.frameHeight,!0,!0);let a=this.maskFlippedHorizontal?!this.flippedHorizontal:this.flippedHorizontal,s=this.maskFlippedVertical?!this.flippedVertical:this.flippedVertical;t.x=a?this.itemContent.frameWidth:0,t.y=s?this.itemContent.frameHeight:0,t.scale.x=a?-1:1,t.scale.y=s?-1:1,i||(t.x/=this.scale.x,t.y/=this.scale.y,t.scale.x/=this.scale.x,t.scale.y/=this.scale.y),this.basicShapeVO&&(t.x/=this.basicShapeVO.fitScale,t.y/=this.basicShapeVO.fitScale,t.scale.x/=this.basicShapeVO.fitScale,t.scale.y/=this.basicShapeVO.fitScale,t.scale.x*=this.itemContent.frameWidth*Math.abs(this.itemContent.scale.x)/(t.texture.width*Math.abs(t.scale.x)),t.scale.y*=this.itemContent.frameHeight*Math.abs(this.itemContent.scale.y)/(t.texture.height*Math.abs(t.scale.y))),this.updateBorderTexture(i)}else this.basicShapeVO?(this.basicShapeVO.updateTexture(t.texture,Math.round(this.scale.x*100),Math.round(this.scale.y*100),i),r={x:this.scale.x*this.basicShapeVO.fitScale,y:this.scale.y*this.basicShapeVO.fitScale}):r=BFN.SVGManager.updateTexture(t.texture,this.scale.x,this.scale.y,null,null,i,e),t.scale.x=1/r.x*(this.flippedHorizontal?-1:1),t.scale.y=1/r.y*(this.flippedVertical?-1:1);this.basicShapeVO&&i&&this.updateHitArea()}else if(this.type==="frame_texture"){if(this.itemContentMask){this.itemContentMaskTexture||(this.itemContentMaskTexture=this.itemContentMask.texture,this.itemContentMask.texture=PIXI.RenderTexture.create(32,32));let t=Math.min(1,this.itemContent.frameWidth/this.itemContentMaskTexture.baseTexture.width),r=Math.min(1,this.itemContent.frameHeight/this.itemContentMaskTexture.baseTexture.height),a=Math.round(this.itemContentMaskTexture.width*t),s=Math.round(this.itemContentMaskTexture.height*r);(this.itemContentMask.texture.width!=a||this.itemContentMask.texture.height!=s)&&(this.itemContentMask.texture.resize(a,s),this.itemContentMask.texture.copyPixels(this.itemContentMaskTexture,void 0,void 0,void 0,{x:a/this.itemContentMaskTexture.width,y:s/this.itemContentMaskTexture.height})),this.itemContentMask.x=this.maskFlippedHorizontal?Math.abs(this.itemContent.x-this.itemContentW):this.itemContent.x,this.itemContentMask.y=this.maskFlippedVertical?Math.abs(this.itemContent.y-this.itemContentH):this.itemContent.y,this.itemContentMask.scale.x=this.itemContent.frameWidth/this.itemContentMask.texture.width*(this.itemContentMask.x?-1:1),this.itemContentMask.scale.y=this.itemContent.frameHeight/this.itemContentMask.texture.height*(this.itemContentMask.y?-1:1)}this.updateBorderTexture(i)}BFN.MainUI.requestRender()}};Q.prototype.updateBorderTexture=function(i=!0){if(this.type!=="frame_texture"||!this.itemContentBorder||!this.borderBasicShapeVO)return;let e={};if(this.basicShapeVO&&Object.assign(e,this.basicShapeVO.getValues()),e.fill=-1,e.stroke=this.borderBasicShapeVO.stroke,e.strokeAlpha=this.borderBasicShapeVO.strokeAlpha,e.strokeWidth=this.borderBasicShapeVO.strokeWidth,this.borderBasicShapeVO.setValues(e),this.itemContentBorder.isFrameBorder)this.borderBasicShapeVO.stroke===-1||!this._borderEnabled?this.itemContentBorder.thickness!==0&&(this.itemContentBorder.thickness=0,this.itemContentBorder.destroy(),this.updateHitArea()):(this.itemContentBorder.initSprites(),this.itemContentBorder.setDimensions(this.itemContent.frameWidth,this.itemContent.frameHeight),this.itemContentBorder.color=parseInt(`0x${this.borderBasicShapeVO.stroke}`),this.itemContentBorder.opacity=this.borderBasicShapeVO.strokeAlpha,this.itemContentBorder.thickness=this.borderBasicShapeVO.strokeWidth,this.itemContentBorder.scale.x=this.itemContentBorder.scale.y=1,i?this.updateHitArea():(this.itemContentBorder.scale.x/=this.scale.x,this.itemContentBorder.scale.y/=this.scale.y));else{if(this.itemContentBorder.visible=this._borderEnabled&&!(e.stroke===-1||e.strokeAlpha<=0||e.strokeWidth<1),this.itemContentBorder.visible)this.itemContentBorder.texture===PIXI.Texture.EMPTY&&(this.itemContentBorder.texture=PIXI.RenderTexture.create(32,32));else{this.itemContentBorder.texture&&this.itemContentBorder.texture!==PIXI.Texture.EMPTY&&(this.itemContentBorder.texture.destroyGC(!0),this.itemContentBorder.texture=PIXI.Texture.EMPTY);return}this.borderBasicShapeVO.updateTexture(this.itemContentBorder.texture,this.itemContent.frameWidth,this.itemContent.frameHeight,i),this.itemContentMask?(this.itemContentBorder.x=this.itemContentMask.x,this.itemContentBorder.y=this.itemContentMask.y,this.itemContentBorder.scale.x=this.itemContentMask.scale.x,this.itemContentBorder.scale.y=this.itemContentMask.scale.y):(this.itemContentBorder.x=0,this.itemContentBorder.y=0,this.itemContentBorder.scale.x=1,this.itemContentBorder.scale.y=1,i||(this.itemContentBorder.scale.x/=this.scale.x,this.itemContentBorder.scale.y/=this.scale.y),this.itemContentBorder.scale.x/=this.borderBasicShapeVO.fitScale,this.itemContentBorder.scale.y/=this.borderBasicShapeVO.fitScale,this.itemContentBorder.scale.x*=this.itemContent.frameWidth*this.itemContent.scale.x/(this.itemContentBorder.texture.width*this.itemContentBorder.scale.x),this.itemContentBorder.scale.y*=this.itemContent.frameHeight*this.itemContent.scale.y/(this.itemContentBorder.texture.height*this.itemContentBorder.scale.y))}BFN.MainUI.requestRender()};Q.prototype.clearDropShadow=function(){this.itemContentShadow.clearShadowTexture()};Q.prototype.updateDropShadowSource=function(){if(!this.dropShadowVO.enabled){this.itemContentShadow.clearShadowTexture(),delete this.itemContent.wasReplaced;return}if(!this.itemContentShadow.isEmpty&&!this.itemContentShadow.isDuplicate){delete this.itemContent.wasReplaced;return}let i=()=>{BFN.queuedDropShadowItems[0]===this?setTimeout(()=>{if(BFN.queuedDropShadowItems.shift(),this.dropShadowVO.enabled){if(!this.itemContentShadow.isDuplicate){let e=!!(this.itemContent.wasReplaced&&this.itemContentMask&&this.itemContent.mask===this.itemContentMask);BFN.Util.getTransformItemTexture(this,null,!0,this.itemContentShadow.sourceTexture,e)}this.updateDropShadowDisplay(),this.itemContentShadow.isDuplicate?delete this.itemContentShadow.isDuplicate:this.updateDropShadowTexture(!0),BFN.MainUI.requestRender()}delete this.itemContent.wasReplaced},0):requestAnimationFrame(i)};BFN.queuedDropShadowItems.includes(this)||(BFN.queuedDropShadowItems.push(this),i())};Q.prototype.updateDropShadowDisplay=function(){this.updateDropShadowPosition(),this.updateDropShadowScale(),this.updateDropShadowTransform(),this.updateDropShadowOffset(),this.updateDropShadowVisuals()};Q.prototype.updateDropShadowTexture=function(i=!1){if(!this.dropShadowVO.enabled||!this.parent)return;if(this.itemContentShadow.size=this.dropShadowVO.size,this.itemContentShadow.density=this.dropShadowVO.density/100,i){BFN.queuedDropShadowItems.includes(this)&&BFN.queuedDropShadowItems.splice(BFN.queuedDropShadowItems.indexOf(this),1),this.itemContentShadow.updateShadowTexture(this.currentTransformItemStateVO?this.currentTransformItemStateVO.id:null);return}let e=()=>{BFN.queuedDropShadowItems[0]===this?setTimeout(()=>{BFN.queuedDropShadowItems.shift(),this.dropShadowVO.enabled&&(this.itemContentShadow.updateShadowTexture(this.currentTransformItemStateVO?this.currentTransformItemStateVO.id:null),BFN.MainUI.requestRender())},0):requestAnimationFrame(e)};BFN.queuedDropShadowItems.includes(this)||(BFN.queuedDropShadowItems.push(this),e())};Q.prototype.updateDropShadowPosition=function(){this.itemContentShadow.x=this.itemContentW/2,this.itemContentShadow.y=this.itemContentH/2};Q.prototype.updateDropShadowScale=function(){if(!this.dropShadowVO.enabled||!(this.itemContentShadow._sourceTexture&&this.itemContentShadow._sourceTexture.adjustScale))return;let i=this.dropShadowVO.scale/100;this.itemContentShadow.adjustScaleX=this.itemContentShadow._sourceTexture.adjustScale.x/i,this.itemContentShadow.adjustScaleY=this.itemContentShadow._sourceTexture.adjustScale.y/i,this.updateSmoothingScale()};Q.prototype.updateDropShadowTransform=function(){!this.dropShadowVO||!this.dropShadowVO.enabled||(this.itemContentShadow.parentScaleX=this.scale.x,this.itemContentShadow.parentScaleY=this.scale.y,this.itemContentShadow.parentRotation=this.rotation)};Q.prototype.updateDropShadowOffset=function(){if(!this.dropShadowVO.enabled)return;let i=(this.dropShadowVO.angle+90)*(Math.PI/180);this.itemContentShadow.offsetX=Math.cos(i)*this.dropShadowVO.distance,this.itemContentShadow.offsetY=Math.sin(i)*this.dropShadowVO.distance};Q.prototype.updateDropShadowVisuals=function(){!this.dropShadowVO.enabled||(this.itemContentShadow.color=parseInt(`0x${this.dropShadowVO.color}`),this.itemContentShadow.opacity=this.dropShadowVO.opacity,this.itemContentShadow.blendMode=this.dropShadowVO.blend_mode)};Q.prototype.setTextWidth=function(i,e=!1,t=!0){if(this.iText){this.textScale=i/this.iText.width;let r=BFN.maxImageSize,a=Math.round((this.iText.width+this.textPadding*2)*this.textScale),s=Math.round((this.iText.height+this.textPadding*2)*this.textScale),o=1;if((a>r||s>r)&&(o=Math.min(r/a,r/s),this.textScale*=o,a=Math.min(r,Math.round((this.iText.width+this.textPadding*2)*this.textScale)),s=Math.min(r,Math.round((this.iText.height+this.textPadding*2)*this.textScale))),this.scale.x=this.scale.y=1/o,this.iTexture.resize(a,s,!1),t){let n=e?this.iTexture.renderClone():null;n&&(this.iTexture.copyPixels(n,null,!0,1,{x:this.iTexture.width/n.width,y:this.iTexture.height/n.height}),n.destroyGC(!0),n=null),this.itemContent.texture=this.iTexture,this.updateTextDisplay()}this.itemContent.visible=t&&!this.textCurveActive,this.updateContentDimensions(),this.initialized&&this.updateHiResTextBounds(),this.itemContent.x=this.flippedHorizontal?this.itemContentW:0,this.itemContent.y=this.flippedVertical?this.itemContentH:0,this.itemContent.anchor.x=this.textPadding/a*this.textScale,this.itemContent.anchor.y=this.textPadding/s*this.textScale}};Q.prototype.generateFabricCanvas=function(){if(!BFN.hasOwnProperty("fabricCanvas")){let i=!1;BFN.fabricCanvasElement=document.createElement("canvas"),BFN.appContainer.appendChild(BFN.fabricCanvasElement),i?(BFN.fabricCanvas=new fabric.Canvas(BFN.fabricCanvasElement,{enableRetinaScaling:!1}),BFN.fabricCanvasElement.parentNode.remove(),BFN.fabricCanvasElement.setStyles({zIndex:1e11,pointerEvents:"none"}),document.body.appendChild(BFN.fabricCanvasElement)):(BFN.fabricCanvas=new fabric.StaticCanvas(BFN.fabricCanvasElement,{enableRetinaScaling:!1}),BFN.fabricCanvasContext=BFN.fabricCanvas.getContext(),BFN.fabricCanvasElement.setStyles({display:"none"}))}};Q.prototype.generateITextClone=function(){BFN.hasOwnProperty("iTextClone")||(BFN.iTextClone=new fabric.TextboxPad("iTextClone",{left:0,top:0,textAlign:"left",fontFamily:BFN.FabricManager.defaultFontFamily,fontSize:BFN.TransformItemTextBaseFontSize,fill:"rgb(0,0,0)",padding:10}),BFN.iTextClone.objectCaching=!1,BFN.iTextClone.paintFirst="stroke",BFN.iTextClone.noScaleCache=!1,BFN.iTextClone.strokeWidth=0,BFN.iTextClone.objectCaching=!1,BFN.fabricCanvas.add(BFN.iTextClone))};Q.prototype.generateFabricCanvasTexture=function(){BFN.hasOwnProperty("fabricCanvasTexture")?BFN.fabricCanvasTexture.update():(BFN.fabricCanvasTexture=new PIXI.Texture(new PIXI.BaseTexture.fromCanvas(BFN.fabricCanvasElement)),BFN.fabricCanvasTexture.baseTexture.mipmap=!1)};Q.prototype.updateTextDisplay=function(){for(let t in this.iText.styles){let r=this.iText.styles[t];for(let a in r){let s=r[a];s&&(s.hasOwnProperty("fontSize")&&s.hasOwnProperty("strokePercent")&&(s.strokeWidth=s.fontSize*s.strokePercent),s.hasOwnProperty("strokeWidth")&&(s.strokeWidth=Math.max(s.strokeWidth,1/this.textScale)))}}this.generateFabricCanvas(),this.generateITextClone();let{styles:i}=this.iText,e={};for(let t in i){e[t]={};for(let r in i[t]){e[t][r]={};for(let a in i[t][r])e[t][r][a]=i[t][r][a]}}BFN.iTextClone.text=this.iText.text,BFN.iTextClone.width=this.iText.width,BFN.iTextClone.styles=e,BFN.iTextClone.textAlign=this.iText.textAlign,BFN.iTextClone.charSpacing=this.iText.charSpacing,BFN.iTextClone.lineHeight=this.iText.lineHeight,BFN.iTextClone.outlineEnabled=this.iText.outlineEnabled,BFN.iTextClone.highlightEnabled=this.iText.highlightEnabled,this.updateITextBackgroundDisplay(),BFN.iTextClone.backgroundOverrideColor=this.iText.backgroundOverrideColor,BFN.iTextClone.backgroundOverridePadding=this.iText.backgroundOverridePadding,BFN.iTextClone.wordBreaksEnabled=this.iText.wordBreaksEnabled,BFN.iTextClone.initDimensions(),BFN.iTextClone.left=this.textPadding*this.textScale,BFN.iTextClone.top=this.textPadding*this.textScale,BFN.iTextClone.scaleX=BFN.iTextClone.scaleY=this.textScale,BFN.fabricCanvasElement.width=(BFN.iTextClone.width+this.textPadding*2)*BFN.iTextClone.scaleX,BFN.fabricCanvasElement.height=(BFN.iTextClone.height+this.textPadding*2)*BFN.iTextClone.scaleY,BFN.fabricCanvasElement.setStyles({width:`${BFN.fabricCanvasElement.width}px`,height:`${BFN.fabricCanvasElement.height}px`}),BFN.fabricCanvasContext.lineJoin="round",BFN.fabricCanvas.renderAll(),this.generateFabricCanvasTexture(),this.iTexture.copyPixels(BFN.fabricCanvasTexture),this.updateCurvedTextDisplay(),requestAnimationFrame(()=>{BFN.fabricCanvasElement.width=16,BFN.fabricCanvasElement.height=16,BFN.fabricCanvasElement.setStyles({width:`${BFN.fabricCanvasElement.width}px`,height:`${BFN.fabricCanvasElement.height}px`}),this.updateSmoothingScale(),this.updateAccurateBounds(!0),BFN.MainUI.requestRender(),this.dispatchEvent(BFN.TransformItemEvents.TEXT_DISPLAY_UPDATED),BFN.updatingTextTransformItem=null,BFN.updatingTextQueue.indexOf(this)!==-1&&BFN.updatingTextQueue.splice(BFN.updatingTextQueue.indexOf(this),1)})};Q.prototype.getITextMask=function(i){if(this.type!=="text"||!this.iText||!i)return;if(this.textCurveActive){this.curvedText.getCTextMask(i);return}this.generateFabricCanvas(),this.generateITextClone();let{styles:e}=this.iText,t={};for(let n in e){t[n]={};for(let l in e[n]){t[n][l]={};for(let c in e[n][l]){let h=e[n][l][c];if(h)switch(c){case"stroke":case"fill":h="white";break;case"textBackgroundColor":h="";break}t[n][l][c]=h}}}BFN.iTextClone.text=this.iText.text,BFN.iTextClone.width=this.iText.width,BFN.iTextClone.styles=t,BFN.iTextClone.textAlign=this.iText.textAlign,BFN.iTextClone.charSpacing=this.iText.charSpacing,BFN.iTextClone.lineHeight=this.iText.lineHeight,BFN.iTextClone.backgroundColor="",BFN.iTextClone.backgroundOverrideColor="",BFN.iTextClone.backgroundOverridePadding=0,BFN.iTextClone.initDimensions();let r=this.textMaskMaxSize/Math.max(BFN.iTextClone.width+this.textPadding*2,BFN.iTextClone.height+this.textPadding*2);BFN.iTextClone.left=this.textPadding*r,BFN.iTextClone.top=this.textPadding*r,BFN.iTextClone.scaleX=BFN.iTextClone.scaleY=r,BFN.fabricCanvasElement.width=(BFN.iTextClone.width+this.textPadding*2)*r,BFN.fabricCanvasElement.height=(BFN.iTextClone.height+this.textPadding*2)*r,BFN.fabricCanvasElement.setStyles({width:`${BFN.fabricCanvasElement.width}px`,height:`${BFN.fabricCanvasElement.height}px`}),BFN.fabricCanvasContext.lineJoin="round",BFN.fabricCanvas.renderAll(),this.generateFabricCanvasTexture();let a=(n=0)=>{let l=BFN.Util.getAlphaBounds(BFN.fabricCanvasTexture),c=new BFN.Rectangle(l.left-n,l.top-n,l.width+n*2,l.height+n*2),h=this.textMaskMaxSize/Math.max(c.width,c.height);return BFN.iTextClone.left=BFN.iTextClone.left*h-c.left*h,BFN.iTextClone.top=BFN.iTextClone.top*h-c.top*h,BFN.iTextClone.scaleX=BFN.iTextClone.scaleX*h,BFN.iTextClone.scaleY=BFN.iTextClone.scaleY*h,BFN.fabricCanvasElement.width=Math.round(c.width*h),BFN.fabricCanvasElement.height=Math.round(c.height*h),BFN.fabricCanvasElement.setStyles({width:`${BFN.fabricCanvasElement.width}px`,height:`${BFN.fabricCanvasElement.height}px`}),BFN.fabricCanvasContext.lineJoin="round",BFN.fabricCanvas.renderAll(),BFN.fabricCanvasTexture.update(),l},s={x:this.iText.scaleX*this.iText.width/(BFN.iTextClone.scaleX*BFN.iTextClone.width)*(this.textScale/this.iText.scaleX),y:this.iText.scaleY*this.iText.height/(BFN.iTextClone.scaleY*BFN.iTextClone.height)*(this.textScale/this.iText.scaleY)},o=a(10);requestAnimationFrame(()=>{a(),requestAnimationFrame(()=>{BFN.fabricCanvasElement.width=16,BFN.fabricCanvasElement.height=16,BFN.fabricCanvasElement.setStyles({width:`${BFN.fabricCanvasElement.width}px`,height:`${BFN.fabricCanvasElement.height}px`});let n=PIXI.RenderTexture.create(BFN.fabricCanvasTexture.width,BFN.fabricCanvasTexture.height);n.fillColor(0),n.copyPixels(BFN.fabricCanvasTexture,null,!1);let l={x:this.iText.scaleX*this.iText.width/(BFN.iTextClone.scaleX*BFN.iTextClone.width)*(this.textScale/this.iText.scaleX)*this.scale.x,y:this.iText.scaleY*this.iText.height/(BFN.iTextClone.scaleY*BFN.iTextClone.height)*(this.textScale/this.iText.scaleY)*this.scale.y},c=new BFN.Rectangle(o.left*s.x*this.scale.x,o.top*s.y*this.scale.y,n.width*l.x,n.height*l.y);i({boundsRect:c,maskTexture:n})})})};Q.prototype.updateITextBackgroundDisplay=function(){this.iText.backgroundOverrideColor=this.textBackgroundColor==-1||!this.textBackgroundEnabled?"":BFN.ColorUtil.hexStringObjectToRGBAString({hex:this.textBackgroundColor,alpha:this.textBackgroundIntensity}),this.iText.backgroundOverridePadding=this.textBackgroundPadding/100*this.textPadding};Q.prototype.queueTextUpdate=function(){if(this.pendingTransformItemState)if(BFN.updatingTextQueue.indexOf(this)===-1&&BFN.updatingTextQueue.push(this),!BFN.UndoManager.updating&&!BFN.updatingTextTransformItem){this.textUpdatePending=!1,BFN.updatingTextTransformItem=this,this.iText._forceClearCache=!0,this.iText._clearCache(),this.iText.text=this.pendingTransformItemState.text,this.iText.textAlign=this.pendingTransformItemState.textStyle.textAlign,this.iText.charSpacing=this.pendingTransformItemState.textStyle.charSpacing,this.iText.lineHeight=this.pendingTransformItemState.textStyle.lineHeight,this.iText.width=this.pendingTransformItemState.textWidth,this.iText.scaleX=this.iText.scaleY=this.pendingTransformItemState.textScale,this.textBackgroundEnabled=this.pendingTransformItemState.textBackgroundEnabled,this.textBackgroundColor=this.pendingTransformItemState.textBackgroundColor,this.textBackgroundIntensity=this.pendingTransformItemState.textBackgroundIntensity,this.textBackgroundPadding=this.pendingTransformItemState.textBackgroundPadding,this.textOutlineEnabled=this.pendingTransformItemState.textOutlineEnabled,this.textHighlightEnabled=this.pendingTransformItemState.textHighlightEnabled,this.updateITextBackgroundDisplay();let{styles:i}=this.pendingTransformItemState.textStyle,e={};for(let t in i){let r=e[t]={};for(let a in i[t]){let s=r[a]=Object.assign({},i[t][a]);s.fontSize&&s.stroke&&!s.strokeWidth&&(s.strokePercent=s.strokePercent||BFN.TransformItemTextStrokePercentDefault,s.strokeWidth=s.strokePercent*s.fontSize)}}this.iText.styles=e,this.conformITextToSmallestFontSize(),this.iText.__skipDimension=!1,this.iText.initDimensions(),setTimeout(()=>{this.setTextWidth(this.pendingTransformItemState.textWidth*this.pendingTransformItemState.textScale*this.pendingTransformItemState.textItemScale),this.pendingTransformItemState=null,this.renderable=!0,BFN.MainUI.rendering=!0,this.updateProjectItemVO()},1)}else this.queueTextUpdate();else BFN.updatingTextTransformItem===this&&(BFN.updatingTextTransformItem=null),BFN.updatingTextQueue.indexOf(this)!==-1&&BFN.updatingTextQueue.splice(BFN.updatingTextQueue.indexOf(this),1),this.pendingTransformItemState=null,this.textUpdatePending=!1,this.renderable=!0,BFN.MainUI.rendering=!0,this.updateProjectItemVO()};Q.prototype.setITextStyle=function(i={}){if(this.type==="text"&&this.currentTransformItemStateVO){this.pendingTransformItemState=Object.assign(new BFN.TransformItemStateVO,this.currentTransformItemStateVO),this.pendingTransformItemState.textStyle=JSON.parse(JSON.stringify(this.currentTransformItemStateVO.textStyle));let e=!1,t=!1;for(let r in i){let a=i[r];if(BFN.FabricManager.itemStyles.includes(r))switch(r){case"backgroundEnabled":this.textBackgroundEnabled=a,this.pendingTransformItemState.textBackgroundEnabled=this.textBackgroundEnabled,this.textBackgroundColor==-1&&(this.textBackgroundColor=BFN.FabricManager.defaultBackgroundColor,this.pendingTransformItemState.textBackgroundColor=this.textBackgroundColor),e=!0,t=!0;break;case"backgroundColor":this.textBackgroundColor=a,this.pendingTransformItemState.textBackgroundColor=this.textBackgroundColor,e=!0,t=!0;break;case"backgroundIntensity":this.textBackgroundIntensity=a,this.pendingTransformItemState.textBackgroundIntensity=this.textBackgroundIntensity,e=!0,t=!0;break;case"backgroundPadding":this.textBackgroundPadding=a,this.pendingTransformItemState.textBackgroundPadding=this.textBackgroundPadding,e=!0,t=!0;break;case"outlineEnabled":if(this.textOutlineEnabled=a,this.pendingTransformItemState.textOutlineEnabled=this.textOutlineEnabled,this.textOutlineEnabled&&this.iText.styleIsEmpty("stroke")){let s=BFN.FabricManager.userStyle.charStyles,o=s.stroke?s.stroke:BFN.ColorUtil.hexStringObjectToRGBAString({hex:BFN.FabricManager.defaultOutlineColor,alpha:1});this.iText.setStyles({stroke:o},this.pendingTransformItemState.textStyle.styles,!0)}e=!0,t=!0;break;case"highlightEnabled":if(this.textHighlightEnabled=a,this.pendingTransformItemState.textHighlightEnabled=this.textHighlightEnabled,this.textHighlightEnabled&&this.iText.styleIsEmpty("textBackgroundColor")){let s=BFN.FabricManager.userStyle.charStyles,o=s.textBackgroundColor?s.textBackgroundColor:BFN.ColorUtil.hexStringObjectToRGBAString({hex:BFN.FabricManager.defaultHighlightColor,alpha:1});this.iText.setStyles({textBackgroundColor:o},this.pendingTransformItemState.textStyle.styles,!0)}e=!0,t=!0;break}else if(BFN.FabricManager.globalStyles.includes(r))this.pendingTransformItemState.textStyle[r]=a,this.iText[r]=a,t=!0;else{for(let s in this.pendingTransformItemState.textStyle.styles){let o=this.pendingTransformItemState.textStyle.styles[s];for(let n in o){let l=o[n];l[r]=a}}this.iText.styles=this.pendingTransformItemState.textStyle.styles,t=!0}}e&&this.updateITextBackgroundDisplay(),t&&!this.textUpdatePending&&(this.textUpdatePending=!0,BFN.MainUI.rendering=!1,this.renderable=!1,this.queueTextUpdate())}};Q.prototype.conformITextToSmallestFontSize=function(){if(this.iText){let i=null,{styles:e}=this.iText;for(let r in e){let a=e[r];for(let s in a){let o=a[s];o.hasOwnProperty("fontSize")||(o.fontSize=BFN.TransformItemTextBaseFontSize);let{fontSize:n}=o;i=i===null?n:Math.min(i,n)}}let t=i===null?1:BFN.TransformItemTextBaseFontSize/i;for(let r in e){let a=e[r];for(let s in a){let o=a[s];o.fontSize*=t}}this.textBackgroundPadding*=t,this.iText.charSpacing*=t,this.iText.width*=t,this.iText.scaleX/=t,this.iText.scaleY/=t,this.fontSizeNormalizeFactor=t}};Q.prototype.exitTextEditing=function(){this.ignoreTextHeight=!0,requestAnimationFrame(()=>{delete this.ignoreTextHeight}),this.resetTextIfEmpty(),this.conformITextToSmallestFontSize(),this.iText.exitEditing()};Q.prototype.resetTextIfEmpty=function(){if(this.iText.text.trim()===""){this.iText.text=BeFunky.LanguageManager.getString("click_when_selected"),this.iText.styles={},this.iText.styles[0]={};for(let i=0;i<this.iText.text.length;i++){let e={};Object.assign(e,this.defaultTextStyles),this.iText.backupStyle&&Object.assign(e,this.iText.backupStyle),e.fontSize=BFN.TransformItemTextBaseFontSize,this.iText.styles[0][i]=e}}};Q.prototype.getTextStyle=function(){if(this.type==="text"&&this.iText){let i={};i.textAlign=this.iText.textAlign,i.charSpacing=this.iText.charSpacing,i.lineHeight=this.iText.lineHeight,i.styles={};for(let e in this.iText.styles){i.styles[e]={};for(let t in this.iText.styles[e]){i.styles[e][t]={};for(let r in this.iText.styles[e][t])i.styles[e][t][r]=this.iText.styles[e][t][r]}}return i}return null};Q.prototype.getTextStyleData=function(i={}){let e={backgroundColor:-1},t=i;for(let r in e)t.hasOwnProperty(r)||(t[`${r}Empty`]=!1);if(this.type=="text"){let r=(o,n,l)=>{o.hasOwnProperty(n)||(o[n]=l)},a=o=>{r(o,"fontSize",BFN.TransformItemTextBaseFontSize),r(o,"fontWeight",""),r(o,"fontStyle",""),r(o,"underline",!1),r(o,"textBackgroundColor",""),r(o,"strokePercent",BFN.TransformItemTextStrokePercentDefault)},s=(o,n)=>{e.hasOwnProperty(o)&&n===e[o]&&(t[`${o}Empty`]=!0),t.hasOwnProperty(o)?t[o]!=n&&(t[o]="mixed"):t[o]=n};if(t.strokeEmpty=!!t.strokeEmpty||this.iText.styleIsEmpty("stroke"),t.textBackgroundColorEmpty=!!t.textBackgroundColorEmpty||this.iText.styleIsEmpty("textBackgroundColor"),s("backgroundEnabled",this.textBackgroundEnabled),s("backgroundColor",this.textBackgroundColor),s("backgroundIntensity",this.textBackgroundIntensity),s("backgroundPadding",this.textBackgroundPadding),s("outlineEnabled",this.textOutlineEnabled),s("highlightEnabled",this.textHighlightEnabled),BFN.FabricManager.globalStyles.forEach(o=>{s(o,this.iText[o])}),this.iText.getSelectionStyles&&this.iText.isEditing){let o=this.iText.selectionStart||0,n=o+1;this.iText.text.length&&this.iText.selectionStart>0&&(o===this.iText.text.length||this.iText.selectionStart===this.iText.selectionEnd)&&(o--,n--);let l=this.iText.text.length?this.iText.getSelectionStyles(o,n,!0):this.iText.backupStyle?[this.iText.backupStyle]:null;l&&l.length&&(Object.assign(t,l[0]),t.hasOwnProperty("fontSize")&&(t.fontSize=t.fontSizeMin=t.fontSizeStart=Math.round(this.scale.x*this.textScale*t.fontSize)))}else for(let o in this.iText.styles){let n=this.iText.styles[o];for(let l in n){let c=n[l];a(c);for(let h in c)if(h==="fontSize"){let u=Math.round(this.scale.x*this.textScale*c[h]);s("fontSize",u),t.fontSizeMin=t.hasOwnProperty("fontSizeMin")?Math.min(t.fontSizeMin,u):u}else s(h,c[h]);parseInt(o)===0&&parseInt(l)===0&&s("fontSizeStart",t.fontSize)}}}return t};Q.prototype.getAvailableGroupItems=function(){let i=BFN.GroupManager.getGroupVOsFromItemIDs([this.itemID]),e=[];i.forEach(r=>{r.itemIDs.forEach(a=>{!e.includes(a)&&a!==this.itemID&&e.push(a)})});let t=[];return this.transformLayer.children.forEach(r=>{r instanceof BFN.TransformItem&&r.projectItemVO&&r!==this&&!t.includes(r)&&e.includes(r.itemID)&&t.push(r)}),t};Q.prototype.updateItemsAffectedByTextHeight=function(){if(this.type!=="text"||!this.iText||![BFN.TransformModel.selectedTransformItem,BFN.TransformModel.selectedTransformItemText].includes(this))return;this.preChangeTextHeight=Math.round(this.iText.height*this.textScale*this.scale.y);let i=this.getAvailableGroupItems(),e=this.localPolygon,t=new PIXI.Point((e[0].x+e[2].x)/2,(e[0].y+e[2].y)/2),r=new PIXI.Point(e[2].x,e[2].y),a=BFN.Util.rotatePoint(t,r,-this.rotation).y,s=o=>{let n=!0;for(let l=0;l<o.length;l++)if(n){let c=o[l];BFN.Util.rotatePoint(t,c,-this.rotation).y<a&&(n=!1)}return n};this.itemsAffectedByTextHeight.splice(0),i.forEach(o=>{let n=s(o.localPolygon);if(!n&&o.accurateBounds){let l=BFN.Util.getTransformItemBounds(o),c=l.minX+o.accurateBounds.left,h=l.maxX-o.accurateBounds.right,u=l.minY+o.accurateBounds.top,d=l.maxY-o.accurateBounds.bottom;n=s([new PIXI.Point(c,u),new PIXI.Point(h,u),new PIXI.Point(h,d),new PIXI.Point(c,d)])}n&&this.itemsAffectedByTextHeight.push({item:o,startPoint:new PIXI.Point(o.x,o.y)})})};Q.prototype.handleTextHeightChanged=function(i){if(this.type!=="text"||!this.iText||this.textCurveActive||![BFN.TransformModel.selectedTransformItem,BFN.TransformModel.selectedTransformItemText].includes(this)||!this.itemsAffectedByTextHeight.length||this.ignoreTextHeight)return;let t=Math.round(this.iText.height*this.textScale*this.scale.y)-this.preChangeTextHeight,r=this.rotation+Math.PI/2;this.itemsAffectedByTextHeight.forEach(a=>{a.item.toggleHiResText(!(Math.abs(t)>0)),a.item.x=a.startPoint.x+Math.cos(r)*t,a.item.y=a.startPoint.y+Math.sin(r)*t}),BFN.TransformItemBoundingBoxes.updateItems(),BFN.MainUI.requestRender()};Q.prototype.registerItemsAffectedByTextHeight=function(){if(this.type!=="text"||!this.iText||this.textCurveActive||![BFN.TransformModel.selectedTransformItem,BFN.TransformModel.selectedTransformItemText].includes(this)||!this.itemsAffectedByTextHeight.length)return null;let e=Math.round(this.iText.height*this.textScale*this.scale.y)-this.preChangeTextHeight;if(Math.abs(e)<1)return this.itemsAffectedByTextHeight.forEach(a=>{a.item.type==="text"&&a.item.iText&&a.item.toggleHiResText(!0)}),BFN.MainUI.requestRender(),null;this.itemsAffectedByTextHeight.forEach(a=>{a.item.x=a.startPoint.x,a.item.y=a.startPoint.y});let t=`offset_items_${BeFunky.randomString(10)}`;BFN.TransformStateModel.startBulkTransition(t);let r=this.rotation+Math.PI/2;return this.itemsAffectedByTextHeight.forEach(a=>{a.item.createTransition("offset_item"),a.item.x=a.startPoint.x+Math.cos(r)*e,a.item.y=a.startPoint.y+Math.sin(r)*e,a.item.registerTransition()}),BFN.TransformStateModel.stopBulkTransition(),this.itemsAffectedByTextHeight.splice(0),t};Q.prototype.updateCurvedTextDisplay=function(){if(this.type!=="text"||this.destroyed)return;let i=!!this.textCurveActive;this.textCurveActive=this._textCurveEnabled&&this._textCurveAmount!==null,this.textCurveActive?(this.curvedText||(this.curvedText=new BFN.TransformItemCurvedText(this),this.addChild(this.curvedText)),this.curvedText.renderCurvedText(this._textCurveAmount)):i&&this.curvedText.resetCurvedText();let e=this.preEditItemDisplayW||this.itemContentW*this.scale.x;this.updateContentDimensions();let t=this.itemContentW*this.scale.x;if(this.refreshItemContentTransform(),this.textCurveSizeChanged){this.textCurveSizeChanged=!1;let r=e/2,a=t/2,s=Math.cos(this.rotation),o=Math.sin(this.rotation);this.x+=(r-a)*s,this.y+=(r-a)*o,this.textCurveActive!==i&&this.toggleHiResText(!0)}BFN.TransformModel.selectedTransformItem===this&&this.transformTool.updateDisplay()};Q.prototype.setBlendMode=function(i){this.itemBlendMode=i,this.itemContent.blendMode=i,this.type==="text"&&(this.hiResTextSprite.blendMode=i,this.curvedText&&(this.curvedText.blendMode=i)),this.itemContentBorder&&!this.itemContentMask&&(this.itemContentBorder.blendMode=i),BFN.MainUI.requestRender()};Q.prototype.toggleBlendMode=function(i){let e=i?this.itemBlendMode:BFN.CONST.BLEND_MODES.NORMAL;this.itemContent.blendMode=e,this.itemContentBorder&&this.itemContentBorder.isFrameBorder&&(this.itemContentBorder.blendMode=e),this.hiResTextSprite&&(this.hiResTextSprite.blendMode=e),this.curvedText&&(this.curvedText.blendMode=e),BFN.MainUI.requestRender()};Q.prototype.flipHorizontal=function(){this.flippedHorizontal=!this.flippedHorizontal,this.refreshItemContentTransform(),BFN.FabricManager.conformITextToTransformItem(this),BFN.FabricManager.conformCTextToIText(this),this.updateCurvedTextDisplay(),this.basicShapeVO&&this.updateHitArea(),this.updateHiResTextBounds(),this.updateHiResText()};Q.prototype.flipVertical=function(){this.flippedVertical=!this.flippedVertical,this.refreshItemContentTransform(),BFN.FabricManager.conformITextToTransformItem(this),BFN.FabricManager.conformCTextToIText(this),this.updateCurvedTextDisplay(),this.basicShapeVO&&this.updateHitArea(),this.updateHiResTextBounds(),this.updateHiResText()};Q.prototype.refreshItemContentTransform=function(){this.itemContent.scale.x=Math.abs(this.itemContent.scale.x)*(this.flippedHorizontal?-1:1),this.itemContent.x=this.flippedHorizontal?this.itemContentW:0,this.itemContentMask&&(this.itemContentMask.x=this.maskFlippedHorizontal?Math.abs(this.itemContent.x-this.itemContentW):this.itemContent.x,this.isShape?this.itemContentMask.scale.x=this.itemContent.scale.x*(this.maskFlippedHorizontal?-1:1):this.itemContentMask.scale.x=Math.abs(this.itemContentMask.scale.x)*(this.itemContentMask.x?-1:1)),this.itemContent.scale.y=Math.abs(this.itemContent.scale.y)*(this.flippedVertical?-1:1),this.itemContent.y=this.flippedVertical?this.itemContentH:0,this.itemContentMask&&(this.itemContentMask.y=this.maskFlippedVertical?Math.abs(this.itemContent.y-this.itemContentH):this.itemContent.y,this.isShape?this.itemContentMask.scale.y=this.itemContent.scale.y*(this.maskFlippedVertical?-1:1):this.itemContentMask.scale.y=Math.abs(this.itemContentMask.scale.y)*(this.itemContentMask.y?-1:1)),this.type==="frame_texture"&&this.borderBasicShapeVO&&this.itemContentBorder&&!this.itemContentBorder.isFrameBorder&&this.itemContentBorder.visible&&this.itemContentMask&&(this.itemContentBorder.x=this.itemContentMask.x,this.itemContentBorder.y=this.itemContentMask.y,this.itemContentBorder.scale.x=this.itemContentMask.scale.x,this.itemContentBorder.scale.y=this.itemContentMask.scale.y)};Q.prototype.setItemZIndex=function(i,e=!0){if(this.parent){i=Math.max(0,Math.min(this.parent.children.length-1,i));let t=this.parent.getChildIndex(this);i!=t&&(this.zIndexUpdating||(this.zIndexUpdating=!0,this.zIndexStart=t,this.createTransition("history_layer_order")),this.parent.setChildIndex(this,i),t=this.parent.getChildIndex(this),BFN.MainUI.requestRender()),this.zIndexUpdating&&!e&&(this.zIndexUpdating=!1,this.zIndexStart!=t&&(this.parent&&this.parent.children.forEach(r=>{r.type!=="group"&&r.projectItemVO&&(r.projectItemVO.transformZIndex=this.parent.getChildIndex(r))}),this.registerTransition(),BFN.TransformLayerManager.updateTransformItemsImmediately(!1)),UILayers.handleItemsUpdated())}};Q.prototype.changeItemIndex=function(i){if(this.parent){let{globalPolygon:e}=this,t=this.parent.getChildIndex(this),r=-1,a=[];for(let o=0;o<this.parent.children.length;o++){let n=this.parent.children[o],l=this.parent.getChildIndex(n);(this===n||this!==n&&BFN.Util.polygonHitTest(e,n.globalPolygon))&&a.push({index:l})}a.sort((o,n)=>o.index-n.index);for(let o=0;o<a.length;o++)if(t==a[o].index){switch(i){case"backwards":o>0&&(r=a[o-1].index,this.parent.setChildIndex(this,r));break;case"forwards":o<a.length-1&&(r=a[o+1].index,this.parent.setChildIndex(this,r));break}break}let s=t!=r&&r!=-1;return s&&(this.parent.children.forEach(o=>{o.type!=="group"&&o.projectItemVO&&(o.projectItemVO.transformZIndex=this.parent.getChildIndex(o))}),this.parent.dispatchEvent(BFN.TransformLayerEvents.ITEMS_UPDATED)),s}return!1};Q.prototype.moveBackwards=function(){return this.changeItemIndex("backwards")};Q.prototype.moveForwards=function(){return this.changeItemIndex("forwards")};Q.prototype.updateItemBoundsData=function(){if(this.accurateBounds&&this.parent){let i=BFN.Util.getTransformItemBounds(this,!!this.accurateBounds.noBounds),e=new BFN.Rectangle;e.left=i.minX+this.accurateBounds.minX,e.right=i.minX+this.accurateBounds.minX+this.accurateBounds.width,e.top=i.minY+this.accurateBounds.minY,e.bottom=i.minY+this.accurateBounds.minY+this.accurateBounds.height;let t=this.globalPolygon,r=Math.sqrt(Math.pow(t[0].x-t[1].x,2)+Math.pow(t[0].y-t[1].y,2)),a=Math.sqrt(Math.pow(t[1].x-t[2].x,2)+Math.pow(t[1].y-t[2].y,2));this.itemBoundsData={item:this,bounds:e,globalPolygon:t,globalPolygonW:r,globalPolygonH:a,localPolygon:this.localBorderPolygon}}else this.itemBoundsData=null};Q.prototype.updateItemGroupData=function(){if(!this.parent)return;let i=BFN.TransformItemGroup;if(i.rotation!==0&&i.isStretchable){let e=BFN.Util.rotatePoint(new PIXI.Point(i.x,i.y),new PIXI.Point(this.x,this.y),-i.rotation);this.itemGroupData.dx=e.x-i.x,this.itemGroupData.dy=e.y-i.y,this.itemGroupData.rr=this.rotation-i.rotation}else this.itemGroupData.dx=this.x-i.x,this.itemGroupData.dy=this.y-i.y,this.itemGroupData.rr=this.rotation;this.itemGroupData.iv=i.isStretchable?Math.abs(Math.cos(this.itemGroupData.rr))<i.oneTenthDegree:!1,this.itemGroupData.sx=this.scale.x,this.itemGroupData.sy=this.scale.y,this.itemGroupData.bw=this.textCurveActive?this.textItemContentW:this.bounds.width,this.itemGroupData.bh=this.textCurveActive?this.textItemContentH:this.bounds.height,this.itemGroupData.dz=this.parent.getChildIndex(this),this.itemGroupData.bm=this.itemBlendMode,this.itemGroupData.dd=Math.sqrt(Math.pow(this.itemGroupData.dx,2)+Math.pow(this.itemGroupData.dy,2)),this.itemGroupData.bt=Math.atan2(this.itemGroupData.dy,this.itemGroupData.dx)};Q.prototype.preloadThumbnail=function(i=0){!this.thumbImage&&this.type!=="text"&&setTimeout(()=>{if(!this.thumbImage){let e=BFN.TransformStateModel.getThumb(this),t=BFN.Util.getHTMLImage(e,null,!0);e.destroyGC(!0),this.thumbImage=t}},i)};Q.prototype.addPresetItemThumbTexture=function(i,e=performance.now()){if(!i||i&&i.hasOwnProperty("fabricShape"))return;let t=new PIXI.Texture(i),r=BFN.PhotoEditorMenuModel.getPresetItemThumbTexture(t);t.destroy(!1),r&&(r.creationTime=e,r.originalBaseTexture=i,this.presetItemThumbTextures.push(r),this.presetItemThumbTextures.sort((a,s)=>a.timestamp-s.timestamp))};Q.prototype.getPresetItemThumbTexture=function(){let i=null;if(this.presetItemThumbTextures.length&&this.currentTransformItemStateVO)for(let e=0;e<this.presetItemThumbTextures.length;e++){let t=this.presetItemThumbTextures[e];t.creationTime<=this.currentTransformItemStateVO.creationTime&&(i=t)}return i};Q.prototype.destroyPresetItemThumbTextures=function(i=-1){let e=this.presetItemThumbTextures.length;for(;--e>-1;){let t=this.presetItemThumbTextures[e];t.creationTime>=i&&(t.destroy(!0),this.presetItemThumbTextures.splice(e,1))}this.presetItemThumbTextures.sort((t,r)=>t.timestamp-r.timestamp)};Q.prototype.handleCanvasScalingUpdated=function(i){this.canvasScaling||this.updateHitArea(),this.updateSmoothingScale()};Object.defineProperty(Q.prototype,"itemWidth",{get(){return this.itemContent.width}});Object.defineProperty(Q.prototype,"itemHeight",{get(){return this.itemContent.height}});Object.defineProperty(Q.prototype,"globalPolygon",{get(){let i=[];for(let e=0;e<this.polygon.length;e++){let t=this.polygon[e],r=BFN.MainUI.toLocal(t,this);i.push(r)}return i}});Object.defineProperty(Q.prototype,"globalBorderPolygon",{get(){if(!(this.itemContentBorder&&this.itemContentBorder.isFrameBorder&&this.borderBasicShapeVO.strokeWidth>0&&this.borderBasicShapeVO.stroke!==-1))return this.globalPolygon;let i=[];for(let e=0;e<this.polygon.length;e++){let t=this.polygon[e].clone();t.x+=this.borderBasicShapeVO.strokeWidth*(e%3?1:-1),t.y+=this.borderBasicShapeVO.strokeWidth*(Math.floor(e/2)?1:-1);let r=BFN.MainUI.toLocal(t,this);i.push(r)}return i}});Object.defineProperty(Q.prototype,"globalTextPolygon",{get(){if(this.type==="text"){let i=[];for(let e=0;e<this.textPolygon.length;e++){let t=this.textPolygon[e],r=BFN.MainUI.toLocal(t,this);i.push(r)}return i}return null}});Object.defineProperty(Q.prototype,"localPolygon",{get(){let i=[];for(let e=0;e<this.polygon.length;e++){let t=this.polygon[e],r=this.transformLayer.toLocal(t,this);i.push(r)}return i}});Object.defineProperty(Q.prototype,"localBorderPolygon",{get(){if(!(this.itemContentBorder&&this.itemContentBorder.isFrameBorder&&this.borderBasicShapeVO.strokeWidth>0&&this.borderBasicShapeVO.stroke!==-1))return this.localPolygon;let i=[];for(let e=0;e<this.polygon.length;e++){let t=this.polygon[e].clone();t.x+=this.borderBasicShapeVO.strokeWidth*(e%3?1:-1),t.y+=this.borderBasicShapeVO.strokeWidth*(Math.floor(e/2)?1:-1);let r=this.transformLayer.toLocal(t,this);i.push(r)}return i}});Object.defineProperty(Q.prototype,"localTextPolygon",{get(){if(this.type==="text"){let i=[];for(let e=0;e<this.textPolygon.length;e++){let t=this.textPolygon[e],r=this.transformLayer.toLocal(t,this);i.push(r)}return i}return null}});Object.defineProperty(Q.prototype,"localCurvedTextPatchPolygon",{get(){if(!this.textCurveActive)return this.localPolygon;let i=Math.min(0,(this.itemContentW-this.textItemContentW)/2),e=Math.max(this.itemContentW,this.textItemContentW),t=[new PIXI.Point(i,0),new PIXI.Point(e+i,0),new PIXI.Point(e+i,this.itemContentH),new PIXI.Point(i,this.itemContentH)],r=[];for(let a=0;a<t.length;a++){let s=t[a],o=this.transformLayer.toLocal(s,this);r.push(o)}return r}});Object.defineProperty(Q.prototype,"localPatchPolygon",{get(){return this.textCurveActive?this.localCurvedTextPatchPolygon:this.localPolygon}});Object.defineProperty(Q.prototype,"align",{set(i){this._align=i,this.dispatchEvent(BFN.TransformItemEvents.ITEM_DISPLAY_UPDATED),this._align=null},get(){return this._align}});Object.defineProperty(Q.prototype,"textOutlineEnabled",{set(i){this.iText&&(this.iText.outlineEnabled=!!i)},get(){return this.iText?!!this.iText.outlineEnabled:!1}});Object.defineProperty(Q.prototype,"textHighlightEnabled",{set(i){this.iText&&(this.iText.highlightEnabled=!!i)},get(){return this.iText?!!this.iText.highlightEnabled:!1}});Object.defineProperty(Q.prototype,"textCurveEnabled",{set(i){this.type==="text"&&(this._textCurveEnabled!==i&&(this._textCurveEnabled=i,this._textCurveEnabled&&this._textCurveAmount===null?this.textCurveAmount=BFN.CurvedTextManager.defaultCurveAmount:BFN.UndoManager.updating||this.updateCurvedTextDisplay()),this.textCurveSizeChanged=!1)},get(){return this._textCurveEnabled}});Object.defineProperty(Q.prototype,"textCurveAmount",{set(i){this.type==="text"&&(i=typeof i=="number"?parseFloat((Math.round(Math.max(-100,Math.min(100,i)))/100).toFixed(2)):null,this._textCurveAmount!==i&&(this._textCurveAmount=i,this._textCurveAmount===null&&(this._textCurveEnabled=!1),BFN.UndoManager.updating||this.updateCurvedTextDisplay()),this.textCurveSizeChanged=!1)},get(){return this._textCurveAmount===null?null:Math.max(-100,Math.min(100,Math.round(this._textCurveAmount*100)))}});Object.defineProperty(Q.prototype,"borderEnabled",{set(i){this._borderEnabled!==!!i&&this.borderBasicShapeVO&&(this._borderEnabled=!!i)},get(){return this._borderEnabled}});Object.defineProperty(Q.prototype,"overlayColorEnabled",{set(i){this._overlayColorEnabled!==!!i&&(this._overlayColorEnabled=!!i,this.overlayColor=this.overlayColor,this.overlayColorIntensity=this.overlayColorIntensity)},get(){return this._overlayColorEnabled}});Object.defineProperty(Q.prototype,"overlayColor",{set(i){this._overlayColor=i,this.itemContent.fillColor=this._overlayColor==-1||!this.overlayColorEnabled?0:parseInt(`0x${this._overlayColor}`),BFN.MainUI.requestRender()},get(){return this._overlayColor}});Object.defineProperty(Q.prototype,"overlayColorIntensity",{set(i){this._overlayColorIntensity=i,this.itemContent.intensity=this._overlayColor==-1||!this.overlayColorEnabled?0:this._overlayColorIntensity,BFN.MainUI.requestRender()},get(){return this._overlayColorIntensity}});Object.defineProperty(Q.prototype,"tintColorEnabled",{set(i){this._tintColorEnabled!==!!i&&(this._tintColorEnabled=!!i,this.tintColor=this.tintColor)},get(){return this._tintColorEnabled}});Object.defineProperty(Q.prototype,"tintColor",{set(i){this._tintColor=i,this.itemContent.tint=this._tintColor===-1||!this.tintColorEnabled?16777215:parseInt(`0x${this._tintColor}`),BFN.MainUI.requestRender()},get(){return this._tintColor}});Object.defineProperty(Q.prototype,"locked",{set(i){this._locked=i},get(){return this._locked}});Object.defineProperty(Q.prototype,"hidden",{set(i){this._hidden=i},get(){return this._hidden}});Object.defineProperty(Q.prototype,"lockedOrHidden",{get(){return this._locked||this._hidden}});Object.defineProperty(Q.prototype,"isTransparent",{get(){return this._isTransparent===void 0&&(this._isTransparent=!1,this.type==="text"||this.isShape?this._isTransparent=!0:(this.type==="texture"||this.type==="frame_texture")&&(this._isTransparent=this.itemContent.texture.determineTransparency())),this._isTransparent}});Object.defineProperty(Q.prototype,"canvasScale",{get(){switch(this.appViewState){case BFN.AppModelViewStates.VIEWING_PHOTO_EDITOR:return BFN.PhotoEditorCanvasModel.canvasScale;case BFN.AppModelViewStates.VIEWING_COLLAGE_MAKER:return BFN.CollageMakerCanvasModel.canvasScale;case BFN.AppModelViewStates.VIEWING_DESIGNER:return BFN.DesignerCanvasModel.canvasScale;default:return 1}}});Object.defineProperty(Q.prototype,"canvasScaling",{get(){switch(this.appViewState){case BFN.AppModelViewStates.VIEWING_PHOTO_EDITOR:return BFN.PhotoEditorCanvasModel.canvasScaling;case BFN.AppModelViewStates.VIEWING_COLLAGE_MAKER:return BFN.CollageMakerCanvasModel.canvasScaling;case BFN.AppModelViewStates.VIEWING_DESIGNER:return BFN.DesignerCanvasModel.canvasScaling;default:return!1}}});Object.defineProperty(Q.prototype,"itemName",{set(i){this.layerName=i||null,this.refreshItemName(),this.updateProjectItemVO()},get(){if(this.layerName)return this.layerName;if(this.type==="text"&&!BFN.FabricManager.isDefaultText(this.iText.text)){let i=15,e=this.iText.text.substring(0,Math.min(i,this.iText.text.length));return e+=e.length<this.iText.text.length?"...":"",e}return BeFunky.LanguageManager.getStringReplacements(`layer_${this.layerType}`,{number:this.layerNum.toString()})}});Object.defineProperty(Q.prototype,"thumbImage",{set(i){this.handleThumbImageLoadedBind||(this.handleThumbImageLoadedBind=function(){this._thumbImage&&this._thumbImage.src&&this.refreshItemThumb()}.bind(this)),this._thumbImage&&this._thumbImage.removeEventListener("load",this.handleThumbImageLoadedBind),this._thumbImage=i,this._thumbImage&&(this._thumbImage.addEventListener("load",this.handleThumbImageLoadedBind),this.handleThumbImageLoadedBind())},get(){return this._thumbImage}});Object.defineProperty(Q.prototype,"assetOrigin",{get(){try{let i=this.projectItemVO.graphicID||this.projectItemVO.imageID||this.projectItemVO.maskImageID||null;if(i){let e=this.itemContent.texture.baseTexture.isTemplateAsset?"Template":BFN.UserActionManager.getAssetOrigin(i);if(e)return e}else if(this.type==="texture"&&this.isGoodie&&this.isShape&&this.basicShapeVO)return"Basic Shape"}catch(i){}return""}});Object.defineProperty(Q.prototype,"itemInfo",{get(){let i="";if(this.type==="text"){let e=this.iText?this.iText.text.length:"_",t=this.getTextStyleData(),r=(t?t.fontSize==="mixed"?t.fontSizeStart==="mixed"?t.fontSizeMin:t.fontSizeStart:t.fontSize:"_")||"_";this.duplicateData&&(e=this.duplicateData.textLength||e,r=this.duplicateData.fontSize||r),i=`Text[Length:${e}, Size:${r}px]`}else this.projectItemVO&&(this.projectItemVO.graphicID?i="Graphic":this.projectItemVO.imageID?i="Image":this.projectItemVO.maskImageID?(i="MaskImage",this.projectItemVO.basicShapeValues?i=i+`[${"BasicShape:"+BFN.formatKeyString(this.projectItemVO.basicShapeValues.type)}]`:this.projectItemVO.maskImageMaskID&&(i=i+`[${BFN.formatKeyString(BFN.getImageType(this.projectItemVO.maskImageMaskID))}]`)):this.projectItemVO.basicShapeValues&&(i="BasicShape:"+BFN.formatKeyString(this.projectItemVO.basicShapeValues.type)));return i}});Object.defineProperty(Q.prototype,"itemInfoLite",{get(){let i="";return this.type==="text"?i="Text":this.projectItemVO&&(this.projectItemVO.graphicID?i="Graphic":this.projectItemVO.imageID?i="Image":this.projectItemVO.maskImageID?(i="MaskImage",this.projectItemVO.basicShapeValues?i=i+"[BasicShape]":this.projectItemVO.maskImageMaskID&&(i=i+`[${BFN.formatKeyString(BFN.getImageType(this.projectItemVO.maskImageMaskID))}]`)):this.projectItemVO.basicShapeValues&&(i="BasicShape")),i}});Object.defineProperty(Q.prototype,"itemDimensions",{get(){let i=this.localPolygon,e=Math.round(Math.sqrt((i[1].x-i[0].x)**2+(i[1].y-i[0].y)**2)),t=Math.round(Math.sqrt((i[2].x-i[1].x)**2+(i[2].y-i[1].y)**2));return`${e}x${t}px`}});Object.defineProperty(Q.prototype,"textureDimensions",{get(){let i="?";return this.itemContent&&this.itemContent.texture&&this.itemContent.texture.baseTexture&&(i=`${this.itemContent.texture.baseTexture.width}x${this.itemContent.texture.baseTexture.height}px`,this.itemContentMask&&this.itemContentMask.texture&&this.itemContentMask.texture.baseTexture&&(i+=`[${this.itemContentMask.texture.baseTexture.width}x${this.itemContentMask.texture.baseTexture.height}px]`)),i}});BFN.TransformItem=Q;BFN.TransformItemGroupEvents={};function ce(){PIXI.Container.call(this),BFN.EventDispatcher.call(this),this.init()}ce.prototype=window.azrc.extend(Object.create(PIXI.Container.prototype),Object.create(BFN.EventDispatcher.prototype));ce.prototype.init=function(){BeFunky.log("TransformItemGroup Init"),this.initDefaultValues(),this.initItemContent(),this.initStrokeRectanglePool(),this.initFadeAnimator(),this.initContextMenu(),this.initLongPressValues()};ce.prototype.initDefaultValues=function(){this.interactive=!0,this.buttonMode=!0,this.activePointerID=null,this.type="group",this.oneTenthDegree=Math.PI/1800,this._canvasScale=1,this._selectedItems=[],this._selectedItemTypes=[],this._selectedItemsBackup=[],this.subSelectedItem=null,this.pendingTextItems=[],this.allowedKeys=[17,18,91,93],this.pressedKeys=[],this.selectedByMouse=!1,this.groupBounds=null,this.accurateBounds=null,this.accurateBoundsQueue=[],this.snapCoordinates=[],this.otherItemAccurateBoundsList=[],this.snapGapRects={},this.transitionID=null,this.transitionBatchID=null,this.accurateBoundsUpdating=!1,this.duplicatingGroup=!1,this._dropShadowVO=new BFN.DropShadowVO,this._dropShadowDefaultValues=this._dropShadowVO.getValues(),this._dropShadowMixedValues=[],this._dropShadowEmpty=!1,this.handleItemAccurateBoundsUpdatedBind=this.handleItemAccurateBoundsUpdated.bind(this),this.handleItemTextDisplayUpdatedBind=this.handleItemTextDisplayUpdated.bind(this),this.handleDocumentMouseDownBind=this.handleDocumentMouseDown.bind(this),this.handleDocumentMouseMoveBind=this.handleDocumentMouseMove.bind(this),this.handleDocumentMouseUpBind=this.handleDocumentMouseUp.bind(this),this.handleDocumentKeyDownBind=this.handleDocumentKeyDown.bind(this),this.handleDocumentKeyUpBind=this.handleDocumentKeyUp.bind(this),document.addEventListener(BeFunky.pointerdown,this.handleDocumentMouseDownBind,!0),document.addEventListener("keydown",this.handleDocumentKeyDownBind,!0),window.addEventListener("blur",()=>{(this.pressedKeys.length||!this.interactive)&&(this.pressedKeys.splice(0),this.interactive=!0,document.removeEventListener("keyup",this.handleDocumentKeyUpBind,!0))}),this.handleViewstateChangedBind=this.handleViewstateChanged.bind(this),BFN.AppModel.addEventListener(BFN.AppModelEvents.VIEWSTATE_UPDATED.type,this.handleViewstateChangedBind),BFN.PhotoEditorCanvasModel.addEventListener(BFN.PhotoEditorCanvasModelEvents.VIEWSTATE_UPDATED.type,this.handleViewstateChangedBind)};ce.prototype.handleViewstateChanged=function(){this._selectedItemsBackup.splice(0)};ce.prototype.initItemContent=function(){this.itemContent=new PIXI.Sprite,this.addChild(this.itemContent),this.itemContent.texture=PIXI.RenderTexture.create(128,128),this.itemContent.texture.clear(),this.updateContentDimensions()};ce.prototype.initStrokeRectanglePool=function(){this.strokeRectanglePoolHolder=new PIXI.Container,this.addChild(this.strokeRectanglePoolHolder),this.strokeRectanglePool=new BFN.StrokeRectanglePool(!1,!0,2,!0,4287274495,4287274495,"undashed_selection_line"),this.strokeRectanglePoolHolder.addChild(this.strokeRectanglePool)};ce.prototype.initFadeAnimator=function(){this.fadeAnimator=new BFN.Animator,this.fadeAnimator.setAnimatorFactor(1),this.fadeAnimator.addEventListener(BFN.AnimatorEvents.UPDATE.type,this.handleFadeAnimatorUpdate.bind(this))};ce.prototype.initContextMenu=function(){this.contextMenu=document.getElementById("context_menu_transform_group");let i={delete_selection:{onClick:()=>{e("transform_delete"),this.contextMenu.hide()},shortcutText:"Del"},duplicate_selection:{onClick:()=>e("transform_duplicate"),hasDivider:!0,shortcutText:BFN.shortcutText("D")},align:{onClick:()=>{},hasDivider:!0,children:{align_left:{onClick:()=>e("transform_align_left")},align_center:{onClick:()=>e("transform_align_center")},align_right:{onClick:()=>e("transform_align_right")},align_top:{onClick:()=>e("transform_align_top")},align_middle:{onClick:()=>e("transform_align_middle")},align_bottom:{onClick:()=>e("transform_align_bottom")}}},flip:{onClick:()=>{},hasDivider:!0,children:{horizontal:{onClick:()=>e("transform_flip_horizontal")},vertical:{onClick:()=>e("transform_flip_vertical")}}},layer_order:{onClick:()=>{},hasDivider:!0,children:{move_backwards:{onClick:()=>e("transform_move_backwards")},move_forwards:{onClick:()=>e("transform_move_forwards")}}},create_group:{onClick:()=>{this.contextMenu.hide(),e("transform_create_group")}},add_to_group:{children:{}},remove_from_group:{children:{}}};BeFunky.Params.isAdmin&&(i.patch={hasDivider:!0,children:{}}),BeFunky.contextMenu(this.contextMenu,i,{hideOnClick:!1}),BeFunky.Params.isAdmin&&this.contextMenu.hideButton("patch"),this.contextMenu.enabled=!1,this.contextMenu.target=document.querySelector("#appStage canvas");function e(t){UITools.setControlValue(t,!0),UITools.applyToolControl(t),UITools.setControlValue(t,!1)}};ce.prototype.updateSelectedItems=function(i=[],e=!1){i=[...i];let t=!1,r;for(r=this._selectedItems.length;--r>-1;){let a=this._selectedItems[r];i.includes(a)||(t=!0,this._selectedItems.splice(r,1))}i.forEach(a=>{this._selectedItems.includes(a)||(t=!0,this._selectedItems.push(a))}),this.updateSelectedItemTypes(),t&&(this.lastTransitionVO=null,this.updateGroupDisplay(e?0:1),BFN.TransformLayerManager.updateSelectedItems())};ce.prototype.updateGroupDisplay=function(i=this.fadeAnimator.animationFactor){this.updateSelectedItemsRotation(),this.updateItemBoundsData(),this.strokeRectanglePool.clear(),this.strokeRectanglePool.setScales(this._canvasScale,1,1);let e=this.isStretchable,t=e&&this.selectedItemsRotation||0,r=Math.abs(t)>this.oneTenthDegree,a=e&&r?[]:null,s=null;if(this._selectedItems.forEach(({itemBoundsData:o})=>{o&&(a?a.push(...o.localPolygon):s?(s.left=Math.min(s.left,o.bounds.left),s.top=Math.min(s.top,o.bounds.top),s.right=Math.max(s.right,o.bounds.right),s.bottom=Math.max(s.bottom,o.bounds.bottom)):s=new BFN.Rectangle(o.bounds.x,o.bounds.y,o.bounds.width,o.bounds.height))}),a){let o=BFN.Util.rectFromPointCloud(a,t);s=new BFN.Rectangle(o.tl.x,o.tl.y,o.width,o.height)}if(s){if(this.selectedByMouse=!1,this.x=s.x,this.y=s.y,this.rotation=t,this.scale.x=1,this.scale.y=1,this.itemContent.width=s.width,this.itemContent.height=s.height,this.updateItemGroupData(),this.updateContentDimensions(),this.minSize=1,this.transformLayer){let o=0,{transformTool:n}=this.transformLayer;this._selectedItems.forEach(({type:l,itemGroupData:c,isShape:h})=>{let u=1;switch(l){case"text":u=n.minSizeText;break;case"frame_texture":u=n.minSizeFrame;break;case"texture":h||(u=n.minSizeFrame);break}let d=Math.min(1,Math.max(u/c.bw,u/c.bh));o=Math.max(o,d)}),o&&(this.minSize=Math.max(1,Math.round(Math.min(this.itemContentW,this.itemContentH)*o)))}if(this.transformLayer){let o=this.transformLayer.canvas.transformIndicatorContainer;o.children.includes(this.strokeRectanglePoolHolder)||o.addChildAt(this.strokeRectanglePoolHolder,0);let n=o.toLocal(new PIXI.Point,this);this.strokeRectanglePoolHolder.x=n.x,this.strokeRectanglePoolHolder.y=n.y,this.strokeRectanglePoolHolder.rotation=this.rotation,this.strokeRectanglePoolHolder.scale.x=this.scale.x,this.strokeRectanglePoolHolder.scale.y=this.scale.y,this.strokeRectanglePool.rotation=-this.rotation,this.strokeRectanglePool.setScales(this._canvasScale,this.scale.x,this.scale.y)}this._selectedItems.forEach(({itemBoundsData:o,itemGroupData:n})=>{o&&n&&this.strokeRectanglePool.add(o.item.x-this.x,o.item.y-this.y,o.globalPolygonW/this._canvasScale,o.globalPolygonH/this._canvasScale,o.item.rotation,!!n.iv)})}else this.strokeRectanglePoolHolder.parent&&this.strokeRectanglePoolHolder.parent.removeChild(this.strokeRectanglePoolHolder);this.fadeAnimator.animationFactor!==i&&this.fadeAnimator.setAnimatorFactor(Math.max(0,Math.min(1,i))),BFN.MainUI.requestRender()};ce.prototype.updateSelectedItemTypes=function(){this._selectedItemTypes.splice(0),this._selectedItems.forEach(i=>{let e=i.type;(e==="texture"||e==="frame_texture")&&(e=i.isGoodie?i.basicShapeVO?"shape":"graphic":e==="texture"?"image":i.itemContentMask?"masked_image":"framed_image"),this._selectedItemTypes.includes(e)||this._selectedItemTypes.push(e)})};ce.prototype.updateSelectedItemsRotation=function(){let i=r=>{if(r>=-Math.PI||r<=Math.PI)return r;for(;r<-Math.PI;)r+=Math.PI*2;for(;r>Math.PI;)r-=Math.PI*2;return r},e=(r,a)=>{let s=Math.abs(a-r);return Math.abs(Math.cos(s)*Math.sin(s))<this.oneTenthDegree},t=null;if(this._selectedItems.length){t=i(this._selectedItems[0].rotation);for(let r=1;r<this._selectedItems.length;r++){let a=this._selectedItems[r],s=i(a.rotation);if(e(t,s))Math.abs(s)<Math.abs(t)&&(t=s);else{t=null;break}}}this._selectedItemsRotation=t};ce.prototype.updateItemBoundsData=function(){this._selectedItems.forEach(i=>{i.updateItemBoundsData()})};ce.prototype.updateItemGroupData=function(){this._selectedItems.forEach(i=>{i.updateItemGroupData()})};ce.prototype.toggleGroupItem=function(i){return this._selectedItems.includes(i)?(this.removeGroupItem(i),!1):(this.addGroupItem(i),!0)};ce.prototype.addGroupItems=function(i){if(i&&i.length){let e=[...this._selectedItems];i.forEach(t=>{t&&t.parent&&!e.includes(t)&&e.push(t)}),this.updateSelectedItems(e),this.updateAccurateBounds()}};ce.prototype.addGroupItem=function(i){if(i&&i.parent&&!this._selectedItems.includes(i)){let e=[...this._selectedItems];e.push(i),this.updateSelectedItems(e),this.updateAccurateBounds()}};ce.prototype.removeGroupItem=function(i){let e=[...this._selectedItems],t=e.indexOf(i);if(t!=-1)if(e.splice(t,1),e.length<=1){if(this.transformLayer&&this.transformLayer.resetTransformItemGroup(),e.length){let r=e[0];r.selectedByMouse=!1,r.selectItem()}}else this.updateSelectedItems(e),this.updateAccurateBounds()};ce.prototype.clearItems=function(){this.updateSelectedItems()};ce.prototype.updateGroupTransform=function(){this._selectedItems.forEach((e,t)=>{let{itemGroupData:r}=e,a=r.dx*this.scale.x,s=r.dy*this.scale.y,o=Math.atan2(s,a),n=Math.sqrt(a**2+s**2);e.x=this.x+Math.cos(o+this.rotation)*n,e.y=this.y+Math.sin(o+this.rotation)*n,e.rotation=r.rr+this.rotation,e.scale.x=r.sx*this.scale[r.iv?"y":"x"],e.scale.y=r.sy*this.scale[r.iv?"x":"y"],e.updateFrameTextureDisplay()});let i=()=>{if(BFN.MainUI.removeEventListener(BFN.MainUIEvents.PRE_RENDER.type,i),this.transformLayer){let t=this.transformLayer.canvas.transformIndicatorContainer.toLocal(new PIXI.Point,this);this.strokeRectanglePoolHolder.x=t.x,this.strokeRectanglePoolHolder.y=t.y,this.strokeRectanglePoolHolder.rotation=this.rotation,this.strokeRectanglePoolHolder.scale.x=this.scale.x,this.strokeRectanglePoolHolder.scale.y=this.scale.y,this.strokeRectanglePool.setScales(this._canvasScale,this.scale.x,this.scale.y)}};BFN.MainUI.addEventListener(BFN.MainUIEvents.PRE_RENDER.type,i),BFN.MainUI.requestRender()};ce.prototype.createGroup=function(i=null){i&&this._selectedItems.length>1&&BFN.GroupManager.createGroup(i,this._selectedItems)};ce.prototype.duplicateGroup=function(){if(this.selectedItems.length<=1||!this.transformLayer||this.duplicatingGroup)return;let{transformLayer:i}=this,e=[...this.selectedItems].sort((l,c)=>i.children.indexOf(l)-i.children.indexOf(c));this.duplicatingGroup=!0,this.transitionID="duplicate_selection",this.transitionBatchID=this.transitionID+BeFunky.randomString(10),BFN.TransformStateModel.startBulkTransition(this.transitionBatchID);let t=null,r=[],a=l=>{l.duplicatedItem&&r.push(l.duplicatedItem),requestAnimationFrame(t)};i.addEventListener(BFN.TransformLayerEvents.ITEM_DUPLICATED.type,a),t=()=>{if(e.length)e.shift().duplicateItem();else{i.removeEventListener(BFN.TransformLayerEvents.ITEM_DUPLICATED.type,a),this.duplicatingGroup=!1,BFN.TransformStateModel.stopBulkTransition();let l=new BFN.TransformItemTransitionVO;l.id=this.transitionID,l.batchIDPlaceholder=this.transitionBatchID,BFN.TransformStateModel.addTransition(l),this.transitionID=null,this.transitionBatchID=null,BFN.GroupManager.selectItems(r)}},t();let s=!1,o=10,n=()=>{this.duplicatingGroup?(o>0?o--:s||(s=!0,BeFunky.showLoadScreen({isCancellable:!1})),requestAnimationFrame(n)):s&&(s=!1,BeFunky.hideLoadScreen())};n()};ce.prototype.pressItem=function(i){BFN.TransformItemEvents.PRESS_ITEM.targetItem=this,BFN.TransformItemEvents.PRESS_ITEM.externalPress=!0,BFN.TransformItemEvents.PRESS_ITEM.data={},BFN.TransformItemEvents.PRESS_ITEM.data.originalEvent=i,this.dispatchEvent(BFN.TransformItemEvents.PRESS_ITEM)};ce.prototype.initLongPressValues=function(){this.longPressOccurred=!1,this.handlePointerDownBind=this.handlePointerDown.bind(this),this.on("pointerdown",this.handlePointerDownBind)};ce.prototype.handlePointerDown=function(i){this.initiateLongPress()};ce.prototype.initiateLongPress=function(){this.longPressOccurred=!1;let i=e=>{this.longPressOccurred=!0,setTimeout(()=>{this.longPressOccurred=!1},0),BeFunky.dispatchPointerEvent("pointerup",document,e.pointerType,e.clientX,e.clientY,{longPressUp:!0}),this.transformLayer.transformTool.gizmoDragger.dragging&&this.transformLayer.transformTool.gizmoDragger.stopDrag(),this.pressItem(e)};BFN.LongPressManager.initiateLongPress(i)};ce.prototype.updateAccurateBounds=function(){this.groupBounds=BFN.Util.getTransformItemBounds(this),this.accurateBounds=BFN.Util.getTransformItemBounds(this),this.accurateBounds.minX=0,this.accurateBounds.maxX=this.accurateBounds.width,this.accurateBounds.centerX=this.accurateBounds.width/2,this.accurateBounds.centerOffsetX=0,this.accurateBounds.minY=0,this.accurateBounds.maxY=this.accurateBounds.height,this.accurateBounds.centerY=this.accurateBounds.height/2,this.accurateBounds.centerOffsetY=0,this._selectedItems.length?(this.accurateBoundsUpdating=!0,this._selectedItems.forEach(i=>{i.removeEventListener(BFN.TransformItemEvents.ACCURATE_BOUNDS_UPDATED.type,this.handleItemAccurateBoundsUpdatedBind),i.addEventListener(BFN.TransformItemEvents.ACCURATE_BOUNDS_UPDATED.type,this.handleItemAccurateBoundsUpdatedBind),this.accurateBoundsQueue.includes(i)||this.accurateBoundsQueue.push(i)}),this._selectedItems.forEach(i=>{this.pendingTextItems.includes(i)||i.updateAccurateBounds()})):(this.accurateBoundsUpdatedCallback=null,this.isTextStyleTransition=!1)};ce.prototype.handleItemAccurateBoundsUpdated=function(i){let e=i.dispatcher,t=this.accurateBoundsQueue.indexOf(e);if(e.removeEventListener(BFN.TransformItemEvents.ACCURATE_BOUNDS_UPDATED.type,this.handleItemAccurateBoundsUpdatedBind),t!=-1&&this.accurateBoundsQueue.splice(t,1),!this.accurateBoundsQueue.length&&this._selectedItems.length){this.isTextStyleTransition&&(this.isTextStyleTransition=!1,this.updateGroupDisplay(),this.groupBounds=BFN.Util.getTransformItemBounds(this));let r=null;this._selectedItems.forEach(a=>{let s=BFN.Util.getTransformItemBounds(a,!!a.accurateBounds.noBounds);r?(r.left=Math.min(r.left,s.minX+a.accurateBounds.minX),r.top=Math.min(r.top,s.minY+a.accurateBounds.minY),r.right=Math.max(r.right,s.minX+a.accurateBounds.minX+a.accurateBounds.width),r.bottom=Math.max(r.bottom,s.minY+a.accurateBounds.minY+a.accurateBounds.height)):r=new BFN.Rectangle(s.minX+a.accurateBounds.minX,s.minY+a.accurateBounds.minY,a.accurateBounds.width,a.accurateBounds.height)}),r&&(this.accurateBounds.minX=r.x-this.groupBounds.minX,this.accurateBounds.minY=r.y-this.groupBounds.minY,this.accurateBounds.maxX=this.accurateBounds.minX+r.width,this.accurateBounds.maxY=this.accurateBounds.minY+r.height,this.accurateBounds.width=this.accurateBounds.maxX-this.accurateBounds.minX,this.accurateBounds.height=this.accurateBounds.maxY-this.accurateBounds.minY,this.accurateBounds.left=this.accurateBounds.minX,this.accurateBounds.top=this.accurateBounds.minY,this.accurateBounds.right=this.groupBounds.maxX-r.right,this.accurateBounds.bottom=this.groupBounds.maxY-r.bottom,this.accurateBounds.centerX=this.accurateBounds.minX+this.accurateBounds.width/2,this.accurateBounds.centerY=this.accurateBounds.minY+this.accurateBounds.height/2,this.accurateBounds.centerOffsetX=this.accurateBounds.centerX-(this.groupBounds.centerX-this.groupBounds.minX),this.accurateBounds.centerOffsetY=this.accurateBounds.centerY-(this.groupBounds.centerY-this.groupBounds.minY)),this.accurateBoundsUpdatedCallback&&(this.accurateBoundsUpdatedCallback(),this.accurateBoundsUpdatedCallback=null),this.accurateBoundsUpdating=!1}};ce.prototype.updateSmoothingScale=function(){this._selectedItems.forEach(i=>{i.updateSmoothingScale()})};ce.prototype.updateContentDimensions=function(){(this.itemContentW!=this.itemContent.width||this.itemContentH!=this.itemContent.height)&&(this.itemContentW=this.itemContent.width,this.itemContentH=this.itemContent.height,this.updateBounds())};ce.prototype.updateBounds=function(){this.bounds=new PIXI.Rectangle(0,0,this.itemContentW,this.itemContentH),this.polygon=[new PIXI.Point(0,0),new PIXI.Point(this.itemContentW,0),new PIXI.Point(this.itemContentW,this.itemContentH),new PIXI.Point(0,this.itemContentH)],this.updateHitArea()};ce.prototype.updateHitArea=function(){this.hitArea=new PIXI.Rectangle(0,0,this.itemContentW,this.itemContentH),this._selectedItems.forEach(i=>{i.updateHitArea()})};ce.prototype.toggleTransform=function(i){if(this.parent&&this._selectedItems.length){let e=[];this._selectedItems.forEach(t=>{t.parent==this.parent&&e.push({item:t,dz:t.itemGroupData.dz,bm:t.itemGroupData.bm})}),e.sort((t,r)=>t.dz-r.dz);for(let t=0;t<e.length;t++){let{item:r,dz:a}=e[t];r.parent.setChildIndex(r,i?r.parent.children.length-2:a),r.toggleBlendMode(!i)}}};ce.prototype.updateHiResTextBounds=function(){this._selectedItems.forEach(i=>{i.updateHiResTextBounds(!1)})};ce.prototype.updateHiResText=function(){this._selectedItems.forEach(i=>{BFN.HiResTextManager.processHiResTextItem(i)})};ce.prototype.renderHiResText=function(){};ce.prototype.removeItem=function(){this.transformLayer&&this.transformLayer.selectedItem==this&&this.transformLayer.removeItem(this)};ce.prototype.alignItems=function(i){if(this._align&&this.transformLayer&&this._selectedItems.length){let e=this.transformLayer.getItemSelectionBounds(this._selectedItems);if(!i){let t={left:-(this.transformLayer.frameWidth/2),center:0,right:this.transformLayer.frameWidth/2,top:-(this.transformLayer.frameHeight/2),middle:0,bottom:this.transformLayer.frameHeight/2};Math.abs(e[this._align]-t[this._align])<=1&&(i=!0,e[this._align]=t[this._align])}i?this._selectedItems.forEach(t=>{t._align=this._align,this.transformLayer.alignItem(t,e[this._align]),t._align=null}):(this.transformLayer.alignItem(this),this.updateGroupTransform()),this.updateGroupDisplay(),this.updateAccurateBounds(),this.transformLayer.transformTool.updateDisplay()}};ce.prototype.setOverlayColor=function(i=-1,e=0){this._selectedItems.forEach(t=>{t.overlayColor=i,t.overlayColorIntensity=e})};ce.prototype.setTintColor=function(i=-1){this._selectedItems.forEach(e=>{e.tintColor=i})};ce.prototype.setBlendMode=function(i){this._selectedItems.forEach(e=>{e.setBlendMode(i)})};ce.prototype.setOpacity=function(i=100){this._selectedItems.forEach(e=>{e.alpha=i/100}),BFN.MainUI.requestRender()};ce.prototype.flipHorizontal=function(){this._selectedItems.forEach(i=>{i.flipHorizontal()}),BFN.MainUI.requestRender()};ce.prototype.flipVertical=function(){this._selectedItems.forEach(i=>{i.flipVertical()}),BFN.MainUI.requestRender()};ce.prototype.moveBackwards=function(){return this.changeItemIndex("backwards")};ce.prototype.moveForwards=function(){return this.changeItemIndex("forwards")};ce.prototype.changeItemIndex=function(i){if(!this.parent||!this._selectedItems.length)return!1;let{globalPolygon:e}=this,t=[];if(this.parent.children.forEach(h=>{if(h!=this&&!this._selectedItems.includes(h)&&BFN.Util.polygonHitTest(e,h.globalPolygon)){let u=h.parent.getChildIndex(h);t.push({item:h,zIndex:u})}}),!t.length)return!1;t.sort((h,u)=>h.zIndex-u.zIndex);let r=t[0].zIndex,a=t[t.length-1].zIndex,s=[];if(this._selectedItems.forEach(h=>{if(h.parent&&h.parent==this.parent){let u=h.parent.getChildIndex(h);s.push({item:h,zIndex:u})}}),!s.length)return!1;s.sort((h,u)=>h.zIndex-u.zIndex);let o=s[0].zIndex,n=s[s.length-1].zIndex,l=null,c=-1;switch(i){case"backwards":if(n<r)return!1;for(let u=0;u<t.length;u++)t[u].zIndex<n&&(l=t[u].item,c=n);break;case"forwards":if(o>a)return!1;let h=t.length;for(;--h>-1;)t[h].zIndex>o&&(l=t[h].item,c=o);break}return l&&c!=-1?(l.createTransition("history_layer_order",!1,!0),l.parent.setChildIndex(l,c),l.registerTransition(!1,!1),t.forEach(({item:h})=>{h.updateItemGroupData()}),s.forEach(({item:h})=>{h.updateItemGroupData()}),l.parent.dispatchEvent(BFN.TransformLayerEvents.ITEMS_UPDATED),!0):!1};ce.prototype.updateHitAreaOrTextWidths=function(){this._selectedItems.forEach(i=>{i.type==="text"?this.pendingTextItems.push(i):i.basicShapeVO?i.updateContentDimensions():i.updateHitArea()}),this.processPendingTextItems()};ce.prototype.processPendingTextItems=function(){if(this.pendingTextItems.length){let i=this.pendingTextItems[0];i.addEventListener(BFN.TransformItemEvents.TEXT_DISPLAY_UPDATED.type,this.handleItemTextDisplayUpdatedBind),i.setTextWidth(i.itemGroupData.bw*this.scale.x,!0),i.itemGroupData.sx=i.scale.x/this.scale.x,i.itemGroupData.sy=i.scale.y/this.scale.y}};ce.prototype.handleItemTextDisplayUpdated=function(i){this.pendingTextItems[0].removeEventListener(BFN.TransformItemEvents.TEXT_DISPLAY_UPDATED.type,this.handleItemTextDisplayUpdatedBind),this.pendingTextItems.shift(),requestAnimationFrame(this.processPendingTextItems.bind(this))};ce.prototype.updateFrameTextureDisplay=function(){};ce.prototype.resetFrameTextureScale=function(){this._selectedItems.forEach(i=>{i.resetFrameTextureScale(),i.itemGroupData.sx=i.scale.x/this.scale[i.itemGroupData.iv?"y":"x"],i.itemGroupData.sy=i.scale.y/this.scale[i.itemGroupData.iv?"x":"y"]})};ce.prototype.updateShapeTexture=function(i=!0){this._selectedItems.forEach(e=>{e.updateShapeTexture(i)})};ce.prototype.updateBorderTexture=function(i=!0){this._selectedItems.forEach(e=>{e.updateBorderTexture(i)})};ce.prototype.updateDropShadowValues=function(){this._dropShadowMixedValues.splice(0),this._dropShadowEmpty=!1;let i=null;this._selectedItems.forEach(e=>{if(!i){i=e.dropShadowVO.getValues();return}i.color===this._dropShadowDefaultValues.color&&(this._dropShadowEmpty=!0);for(let t in i)this._dropShadowMixedValues.includes(t)||i[t]!==e.dropShadowVO[t]&&(this._dropShadowMixedValues.push(t),i[t]=this._dropShadowDefaultValues[t])}),this._dropShadowVO.setValues(i||this._dropShadowDefaultValues)};ce.prototype.setDropShadowValues=function(i,e){if(this._dropShadowVO[i]=e,this._selectedItems.forEach(t=>{t.dropShadowVO[i]=e}),i==="enabled"&&e){let t=BFN.TransformModel.defaultDropShadowVO.getValues();delete t.enabled,this._selectedItems.forEach(r=>{r.dropShadowVO.color===-1&&r.dropShadowVO.setValues(t)}),this.updateDropShadowValues()}};ce.prototype.clearDropShadow=function(){this._selectedItems.forEach(i=>{i.clearDropShadow()})};ce.prototype.createTransition=function(i,e=!0){this.transitionID&&this.transitionID!=i&&(this.lastTransitionVO=null),this.lastTransitionVO&&this.lastTransitionVO.id!=i&&(this.lastTransitionVO=null),this.transitionID=i,this.transitionBatchID=this.transitionID+BeFunky.randomString(10),BFN.TransformStateModel.startBulkTransition(this.transitionBatchID),e&&this._selectedItems.forEach(t=>{t.isGroupTransition=!0,t.createTransition(this.transitionID),delete t.isGroupTransition})};ce.prototype.registerTransition=function(i,e,t=!0,r=null,a=!1){this.accurateBoundsUpdatedCallback=e?r:null,this.isTextStyleTransition=a,t&&this._selectedItems.forEach(o=>{o.registerTransition(i,e)}),BFN.TransformStateModel.stopBulkTransition();let s=function(){let o=new BFN.TransformItemTransitionVO;return o.id=this.transitionID,o.batchIDPlaceholder=this.transitionBatchID,BFN.TransformStateModel.addTransition(o),o}.bind(this);i?(this.lastTransitionVO||(this.lastTransitionVO=s()),e&&this.updateAccurateBounds()):(this.lastTransitionVO=null,s(),e&&this.updateAccurateBounds()),this.transitionID=null,this.transitionBatchID=null};ce.prototype.getGroupItemData=function(){let i={overlayColor:-1,tintColor:-1,borderColor:-1,shapeFillBak:-1,shapeStrokeBak:-1,textCurveAmount:null},e={};for(let r in i)e[`${r}Empty`]=!1;let t=(r,a)=>{if(i.hasOwnProperty(r)&&a===i[r]&&(e[`${r}Empty`]=!0),!e.hasOwnProperty(r))e[r]=a;else if(e[r]!=a)switch(r){case"shapeStrokeWidth":e[r]!==a&&(e.shapeStrokeWidthMixed=!0),e[r]=Math.max(e[r],a);break;case"shapeHideFill":case"shapeHideStroke":e[r]=!!(e[r]||a);break;case"borderThickness":e[r]!==a&&(e.borderThicknessMixed=!0),e[r]=Math.max(e[r],a);break;default:e[r]="mixed"}};return this.selectedItems.forEach(r=>{t("opacity",Math.round(r.alpha*100)),t("blendMode",r.itemBlendMode),t("overlayColorEnabled",r.overlayColorEnabled),t("overlayColor",r.overlayColor),t("overlayColorIntensity",r.overlayColorIntensity),t("tintColorEnabled",r.tintColorEnabled),t("tintColor",r.tintColor),r.type==="text"&&(t("textCurveEnabled",r.textCurveEnabled),t("textCurveAmount",r.textCurveAmount)),r.basicShapeVO&&(t("shapeFill",r.basicShapeVO.fill),t("shapeFillExists",r.basicShapeVO.fill!==-1),t("shapeFillAlpha",r.basicShapeVO.fillAlpha),t("shapeStroke",r.basicShapeVO.stroke),t("shapeStrokeExists",r.basicShapeVO.stroke!==-1),t("shapeStrokeAlpha",r.basicShapeVO.strokeAlpha),t("shapeStrokeWidth",r.basicShapeVO.strokeWidth),t("shapeFillBak",r.basicShapeVO.fillBak),t("shapeStrokeBak",r.basicShapeVO.strokeBak),t("shapeHideFill",["line"].includes(r.basicShapeVO.type)),t("shapeHideStroke",["star","arrow"].includes(r.basicShapeVO.type))),r.borderBasicShapeVO?(t("borderEnabled",r.borderEnabled),t("borderColor",r.borderBasicShapeVO.stroke),t("borderAlpha",r.borderBasicShapeVO.strokeAlpha),t("borderThickness",r.borderBasicShapeVO.strokeWidth)):e.borderHide||(e.borderHide=!0)}),e};ce.prototype.getTextGroupStyleData=function(){let i={};return this.groupType==="text"&&this.selectedItems.forEach(e=>{e.getTextStyleData(i)}),i};ce.prototype.handleDocumentMouseDown=function(i){if(i.target instanceof HTMLCanvasElement&&i.button!=2){if(BFN.AppModel.sectionValue(BFN.PhotoEditorCanvas.transformLayer,BFN.CollageMakerCanvas.transformLayer,BFN.DesignerCanvas.transformLayer).groupActivePointerID||BFN.AppModel.viewingEditor&&!BFN.PhotoEditorModel.currentTexture||BFN.AppModel.viewingEditor&&BFN.PhotoEditorCanvasModel.viewState!==BFN.PhotoEditorCanvasModelViewStates.VIEWING_CANVAS||BFN.PhotoEditorCanvasModel.viewState!==BFN.PhotoEditorCanvasModelViewStates.VIEWING_CANVAS||BFN.TransformItemIsolator.active||BFN.TransformModel.transformToolFrame&&BFN.TransformModel.transformToolFrame.active||BFN.EyeDropper.active||this.activePointerID!==null)return;this.documentMouseDownPoint={x:i.pageX,y:i.pageY},this.activePointerID=i.pointerId,this.documentMouseMoved=!1,this.documentMouseMovedPastThreshold=!1,this.allowSelectionDrag=!1,this.eraseSelection=!1,document.addEventListener(BeFunky.pointermove,this.handleDocumentMouseMoveBind,!0),document.addEventListener(BeFunky.pointerup,this.handleDocumentMouseUpBind,!0),this._selectedItemsBackup.splice(0),BFN.TransformModel.selectedTransformItem&&(BFN.TransformModel.selectedTransformItem instanceof BFN.TransformItem?this._selectedItemsBackup.push(BFN.TransformModel.selectedTransformItem):BFN.TransformModel.selectedTransformItem===this&&this.selectedItems.length&&this._selectedItemsBackup.push(...this.selectedItems))}};ce.prototype.handleDocumentMouseMove=function(i){if(this.activePointerID===null||this.activePointerID!==i.pointerId)return;let e=!1,t=!0;if(BFN.ActiveDraggers.forEach(o=>{e=o.preventSelectionDrag||e,t=o.deselectItemGroup&&t}),e=!!(e||BFN.preventSelectionDrag),BFN.preventSelectionDrag=!1,e){document.removeEventListener(BeFunky.pointermove,this.handleDocumentMouseMoveBind,!0),document.removeEventListener(BeFunky.pointerup,this.handleDocumentMouseUpBind,!0),this.activePointerID=null,t&&this.transformLayer&&this.transformLayer.children.includes(this)&&this.transformLayer.resetTransformItemGroup();return}if(!this.documentMouseMoved){this.documentMouseMoved=!0;let o=i.ctrlKey||i.metaKey||i.altKey;this.allowSelectionDrag=!BFN.ActiveDraggers.length;let n=BFN.AppModel.sectionValue(BFN.PhotoEditorCanvas,BFN.CollageMakerCanvas,BFN.DesignerCanvas);BFN.ActiveDraggers.includes(n.canvasDragger)&&(!n.canvasDragger.validDrag||o)&&(n.canvasDragger.stopDrag(),this.allowSelectionDrag=!0),o&&(BFN.ActiveDraggers.forEach(l=>{l.stopDrag()}),this.allowSelectionDrag=!0),this.allowSelectionDrag&&i.altKey&&(this.eraseSelection=!0)}let r=i.pageX-this.documentMouseDownPoint.x,a=i.pageY-this.documentMouseDownPoint.y;if(Math.sqrt(Math.pow(r,2)+Math.pow(a,2))>5&&(this.documentMouseMovedPastThreshold=!0,document.removeEventListener(BeFunky.pointermove,this.handleDocumentMouseMoveBind,!0),this.allowSelectionDrag&&!BFN.FabricManager.currentTextTransformItem)){let o=BFN.AppModel.sectionValue(BFN.PhotoEditorCanvas.transformLayer,BFN.CollageMakerCanvas.transformLayer,BFN.DesignerCanvas.transformLayer);o.textTransformItem=null;let n=[];o.lastDeselectedItem&&o.lastDeselectedItem.type!=="group"&&(i.metaKey||i.ctrlKey)&&n.push(o.lastDeselectedItem),o.selectedItem&&o.selectedItem.type!=="group"&&!n.includes(o.selectedItem)&&n.push(o.selectedItem),o.deselectItem(!(i.ctrlKey||i.metaKey)),o.startGroupSelection(this.activePointerID,i.ctrlKey||i.metaKey||this.eraseSelection,this.eraseSelection,n),document.removeEventListener(BeFunky.pointerup,this.handleDocumentMouseUpBind,!0),this.activePointerID=null}};ce.prototype.handleDocumentMouseUp=function(i){this.activePointerID=null,document.removeEventListener(BeFunky.pointermove,this.handleDocumentMouseMoveBind,!0),document.removeEventListener(BeFunky.pointerup,this.handleDocumentMouseUpBind,!0),this.transformLayer&&(this.transformLayer.updateTransformItemGroup(),delete this.transformLayer.lastDeselectedItem)};ce.prototype.handleDocumentKeyDown=function(i){this.allowedKeys.includes(i.keyCode)&&!this.pressedKeys.includes(i.keyCode)&&(this.pressedKeys.push(i.keyCode),this.interactive&&(this.interactive=!1,document.addEventListener("keyup",this.handleDocumentKeyUpBind,!0))),i.keyCode===27&&BFN.AppModel.sectionValue(BFN.PhotoEditorCanvas.transformLayer,BFN.CollageMakerCanvas.transformLayer,BFN.DesignerCanvas.transformLayer).groupActivePointerID&&(BFN.GroupManager.selectItems(),BeFunky.dispatchPointerEvent("pointerup",document,void 0,BeFunky.globalPointerEvent.clientX,BeFunky.globalPointerEvent.clientY,{ignorePointerID:!0}),this._selectedItemsBackup.length&&setTimeout(()=>{BFN.GroupManager.selectItems(this._selectedItemsBackup)},0))};ce.prototype.handleDocumentKeyUp=function(i){this.interactive||(this.allowedKeys.includes(i.keyCode)&&this.pressedKeys.includes(i.keyCode)&&this.pressedKeys.splice(this.pressedKeys.indexOf(i.keyCode),1),this.pressedKeys.length||(this.interactive=!0,document.removeEventListener("keyup",this.handleDocumentKeyUpBind,!0)))};ce.prototype.handleFadeAnimatorUpdate=function(i){this.strokeRectanglePool.alpha=this.fadeAnimator.animationFactor,this.strokeRectanglePool.visible=this.fadeAnimator.animationFactor>0};Object.defineProperty(ce.prototype,"itemWidth",{get(){return this.itemContent.width}});Object.defineProperty(ce.prototype,"itemHeight",{get(){return this.itemContent.height}});Object.defineProperty(ce.prototype,"groupType",{get(){let i=null,e=!0;return this.selectedItems.forEach(t=>{let r=t.type;r==="texture"||r==="frame_texture"?r=t.isGoodie?t.basicShapeVO?"shape":"graphic":"image":e=!1,i?i!==r&&(i="mixed",r==="shape"&&(e=!1)):i=r}),i==="mixed"&&e&&(i="graphic_image_mix"),i}});Object.defineProperty(ce.prototype,"containsMask",{get(){for(let i=0;i<this.selectedItems.length;i++)if(this.selectedItems[i].itemContentMask)return!0;return!1}});Object.defineProperty(ce.prototype,"basicShapeVO",{get(){return this.groupType==="shape"?(this._basicShapeVO||(this._basicShapeVO=new BFN.BasicShapeVO("group")),this._basicShapeVO):null}});Object.defineProperty(ce.prototype,"borderBasicShapeVO",{get(){return this.groupType==="image"?(this._borderBasicShapeVO||(this._borderBasicShapeVO=new BFN.BasicShapeVO("group")),this._borderBasicShapeVO):null}});Object.defineProperty(ce.prototype,"dropShadowVO",{get(){return this._dropShadowVO}});Object.defineProperty(ce.prototype,"dropShadowMixedValues",{get(){return this._dropShadowMixedValues}});Object.defineProperty(ce.prototype,"dropShadowEmpty",{get(){return this._dropShadowEmpty}});Object.defineProperty(ce.prototype,"globalPolygon",{get(){let i=[];for(let e=0;e<this.polygon.length;e++){let t=this.polygon[e],r=BFN.MainUI.toLocal(t,this);i.push(r)}return i}});Object.defineProperty(ce.prototype,"globalBorderPolygon",{get(){return this.globalPolygon}});Object.defineProperty(ce.prototype,"localPolygon",{get(){if(!this.transformLayer)return[0,0,0,0];let i=[];for(let e=0;e<this.polygon.length;e++){let t=this.polygon[e],r=this.transformLayer.toLocal(t,this);i.push(r)}return i}});Object.defineProperty(ce.prototype,"selectedItems",{get(){return this._selectedItems}});Object.defineProperty(ce.prototype,"selectedItemsBackup",{get(){return this._selectedItemsBackup}});Object.defineProperty(ce.prototype,"selectedItemsRotation",{get(){return this._selectedItemsRotation}});Object.defineProperty(ce.prototype,"selectedItemTypes",{get(){return this._selectedItemTypes}});Object.defineProperty(ce.prototype,"isStretchable",{get(){return!this._selectedItemTypes.includes("text")&&this._selectedItemsRotation!==null}});Object.defineProperty(ce.prototype,"canvasScale",{set(i){this._canvasScale=i,this.strokeRectanglePool.setScales(this._canvasScale,this.scale.x,this.scale.y),this.transformLayer&&this.updateGroupTransform()},get(){return this._canvasScale}});Object.defineProperty(ce.prototype,"align",{set(i){this._align=i,this.alignItems(BeFunky.globalPointerEvent.ctrlKey||BeFunky.globalPointerEvent.metaKey),this._align=null},get(){return this._align}});Object.defineProperty(ce.prototype,"groupInfo",{get(){let i={};this.selectedItems.forEach(t=>{let r=t.itemInfoLite;i[r]||(i[r]=0),i[r]++});let e=[];for(let t in i)e.push(`${t}(${i[t]})`);return e.sort(),e.join("/")}});Object.defineProperty(ce.prototype,"groupInfoLite",{get(){return`${BFN.formatKeyString(this.groupType)} ( ${this.selectedItems.length} Count )`}});Object.defineProperty(ce.prototype,"groupDimensions",{get(){let{localPolygon:i}=this,e=Math.round(Math.sqrt((i[1].x-i[0].x)**2+(i[1].y-i[0].y)**2)),t=Math.round(Math.sqrt((i[2].x-i[1].x)**2+(i[2].y-i[1].y)**2));return`${e}x${t}px`}});BFN.SingletonQueue.add(()=>{BFN.TransformItemGroup=new ce});function lt(){PIXI.Container.call(this),BFN.EventDispatcher.call(this),this.init()}lt.prototype=window.azrc.extend(Object.create(PIXI.Container.prototype),Object.create(BFN.EventDispatcher.prototype));lt.prototype.init=function(){BeFunky.log("TransformItemIsolator Init"),this.initDefaultValues(),this.initBackground(),this.initItem(),this.initAnimators()};lt.prototype.initDefaultValues=function(){this.interactive=!1,this.canvasModel=null,this.canvas=null,this.transformParamsStart={},this.transformParamsEnd={},this.itemTextureFrame=new BFN.Rectangle,this.reselectOnReleaseComplete=!0,this.backgroundContainerActive=!0,this.shiftParamsStart={x:0,y:0,w:0,h:0},this.shiftParamsEnd={x:0,y:0,w:0,h:0},this.usingAlternateMenu=!1,this.imageLayerEdited=!1,this._itemWidth=0,this._itemHeight=0,this.handleIsolatedItemThumbUpdatedBind=BeFunky.debounce(this.handleIsolatedItemThumbUpdated.bind(this),"raf"),this.handleCanvasScaleUpdatedBind=this.handleCanvasScaleUpdated.bind(this),BFN.PhotoEditorCanvasModel.addEventListener(BFN.PhotoEditorCanvasModelEvents.VIEWSTATE_UPDATED.type,this.handlePhotoEditorCanvasViewstateUpdated.bind(this))};lt.prototype.initBackground=function(){this.backgroundContainer=new PIXI.Container,this.addChild(this.backgroundContainer),this.backgroundTexture=PIXI.RenderTexture.create(32,32),this.backgroundSprite=new PIXI.Sprite(this.backgroundTexture),this.backgroundSprite.pluginName="smooth_picture",this.backgroundContainer.addChild(this.backgroundSprite)};lt.prototype.initItem=function(){this.itemTexture=PIXI.RenderTexture.create(32,32),this.itemSprite=new PIXI.Sprite(this.itemTexture),this.itemSprite.visible=!1,this.itemSprite.pluginName="smooth_picture",this.itemSprite.anchor.x=this.itemSprite.anchor.y=.5,this.addChild(this.itemSprite),this.itemSpriteOffset=new PIXI.Point};lt.prototype.initAnimators=function(){this.isolationAnimator=new BFN.Animator,this.isolationAnimator.linearSteps=32,this.isolationAnimator.addEventListener(BFN.AnimatorEvents.UPDATE.type,this.handleIsolationAnimatorUpdate.bind(this)),this.isolationAnimator.addEventListener(BFN.AnimatorEvents.INCREASE_COMPLETE.type,this.handleIsolationAnimatorIncreaseComplete.bind(this)),this.isolationAnimator.addEventListener(BFN.AnimatorEvents.DECREASE_COMPLETE.type,this.handleIsolationAnimatorDecreaseComplete.bind(this)),this.shiftAnimator=new BFN.Animator,this.shiftAnimator.linearSteps=8,this.shiftAnimator.setAnimatorFactor(1),this.shiftAnimator.addEventListener(BFN.AnimatorEvents.UPDATE.type,this.handleShiftAnimatorUpdate.bind(this)),this.shiftAnimator.addEventListener(BFN.AnimatorEvents.INCREASE_COMPLETE.type,this.handleShiftAnimatorIncreaseComplete.bind(this))};lt.prototype.isolateTransformItem=function(i=null,e=null,t=null,r=!1){if(!!i==!!this.isolatedTransformItem)return;i&&(this.isolatedCallback=e,this.releasedCallback=t,this.usingAlternateMenu=r),this.canvasModel=BFN.AppModel.sectionValue(BFN.PhotoEditorCanvasModel,BFN.CollageMakerCanvasModel,BFN.DesignerCanvasModel),this.canvas=BFN.AppModel.sectionValue(BFN.PhotoEditorCanvas,BFN.CollageMakerCanvas,BFN.DesignerCanvas);let a=this.canvas.transformItemIsolatorContainer,{transformLayer:s}=this.canvas;if(i&&!i.isGoodie&&(i.type==="texture"||i.type==="frame_texture")&&(this.isolatedTransformItem=i,this.isolatedTransformItem.deselectItem(),a.addChild(this),BFN.CollageMakerCanvas.canvasScaleBars.active=!1,BFN.GlobalHistoryModel.updateGlobalHistoryButtons()),!i&&this.isolatedTransformItem){let I=0,_=0,E=0,D=0;switch(this.canvasModel){case BFN.PhotoEditorCanvasModel:I=this.canvasModel.imageFitPaddingX*2,_=this.canvasModel.imageFitPaddingY*2,E=BFN.PhotoEditorCanvas.canvasImage.width,D=BFN.PhotoEditorCanvas.canvasImage.height;break;case BFN.CollageMakerCanvasModel:I=this.canvasModel.collageFitPaddingX*2,_=this.canvasModel.collageFitPaddingY*2,E=BFN.CollageMakerCanvas.canvasPhotoGrid.gridWidth,D=BFN.CollageMakerCanvas.canvasPhotoGrid.gridHeight;break;case BFN.DesignerCanvasModel:I=this.canvasModel.designerFitPaddingX*2,_=this.canvasModel.designerFitPaddingY*2,E=BFN.DesignerCanvas.canvasWidth,D=BFN.DesignerCanvas.canvasHeight;break}this.transformParamsStart.canvasScale=E&&D?Math.min(1,(BFN.StageModel.stageW-I)/E,(BFN.StageModel.stageH-_)/D):1,UITools.setControlValue("layer_isolator_display_canvas",!0),UITools.updateToolControl("layer_isolator_display_canvas"),UITools.applyTool("layer"),this.canvasModel.disregardScaleRange=!0,this.canvasModel.canvasScaling=!0,this.transformParamsEnd.canvasScale=this.canvasModel.canvasScale,this.itemSprite.visible=!0,UIToggler.toggleMainMenu(!1),this.isolationAnimator.decrease(),this.isolatedTransformItem.removeEventListener(BFN.TransformItemEvents.THUMB_UPDATED.type,this.handleIsolatedItemThumbUpdatedBind),this.imageLayerEdited&&(this.trackImageLayerEdited(),this.imageLayerEdited=!1);return}if(this.imageLayerEdited=!1,BFN.TransformGuides.updateVisibility(),!this.isolatedTransformItem)return;this.isolatedTransformItem.renderable=!1;let o=s.layerBounds;o||(o=new BFN.Rectangle);let n=(I,_)=>{o.left=Math.min(o.left,-(I/2)),o.right=Math.max(o.right,I/2),o.top=Math.min(o.top,-(_/2)),o.bottom=Math.max(o.bottom,_/2)};switch(this.canvas){case BFN.PhotoEditorCanvas:n(BFN.PhotoEditorCanvas.canvasImage.imageWidth,BFN.PhotoEditorCanvas.canvasImage.imageHeight);break;case BFN.CollageMakerCanvas:n(BFN.CollageMakerCanvas.canvasPhotoGrid.gridWidth,BFN.CollageMakerCanvas.canvasPhotoGrid.gridHeight);break;case BFN.DesignerCanvas:n(BFN.DesignerCanvas.canvasWidth,BFN.DesignerCanvas.canvasHeight);break}if(!o.width||!o.height)return;let l=Math.min(1,BFN.maxImageSize/o.width,BFN.maxImageSize/o.height),c=Math.round(o.width*l),h=Math.round(o.height*l);switch(this.backgroundTexture.resize(c,h),this.canvas){case BFN.PhotoEditorCanvas:let I=this.canvas.canvasImage.currentScale;this.canvas.canvasImage.currentScale=l,this.canvas.canvasImage.x=(-o.x-this.canvas.canvasImage.imageWidth/2)*l,this.canvas.canvasImage.y=(-o.y-this.canvas.canvasImage.imageHeight/2)*l,this.canvas.canvasImage.scale.x=this.canvas.canvasImage.scale.y=l,BFN.Stage.render(this.canvas.canvasImage,this.backgroundTexture,!0),this.canvas.canvasImage.currentScale=I,this.canvas.canvasImage.x=0,this.canvas.canvasImage.y=0,this.canvas.canvasImage.scale.x=this.canvas.canvasImage.scale.y=1;break;case BFN.CollageMakerCanvas:let _={backgroundX:this.canvas.background.x,backgroundY:this.canvas.background.y,gridScale:this.canvas.canvasPhotoGrid.canvasScale,gridX:this.canvas.canvasPhotoGrid.x,gridY:this.canvas.canvasPhotoGrid.y};this.canvas.background.x=-(this.canvas.canvasPhotoGrid.gridWidth/2+o.x*l),this.canvas.background.y=-(this.canvas.canvasPhotoGrid.gridHeight/2+o.y*l),this.canvas.background.scale.x=this.canvas.canvasPhotoGrid.gridWidth/this.canvas.background.itemWidth,this.canvas.background.scale.y=this.canvas.canvasPhotoGrid.gridHeight/this.canvas.background.itemHeight,BFN.Stage.render(this.canvas.background,this.backgroundTexture,!0),this.canvas.background.x=_.backgroundX,this.canvas.background.y=_.backgroundY,this.canvas.background.scale.x=this.canvas.background.scale.y=1,this.canvas.canvasPhotoGrid.canvasScale=l,this.canvas.canvasPhotoGrid.x=-o.x*l,this.canvas.canvasPhotoGrid.y=-o.y*l,this.canvas.canvasPhotoGrid.scale.x=this.canvas.canvasPhotoGrid.scale.y=l,BFN.Stage.render(this.canvas.canvasPhotoGrid,this.backgroundTexture,!1),this.canvas.canvasPhotoGrid.canvasScale=_.gridScale,this.canvas.canvasPhotoGrid.x=_.gridX,this.canvas.canvasPhotoGrid.y=_.gridY,this.canvas.canvasPhotoGrid.scale.x=this.canvas.canvasPhotoGrid.scale.y=1;break;case BFN.DesignerCanvas:let E={backgroundX:this.canvas.background.x,backgroundY:this.canvas.background.y};this.canvas.background.x=-(this.canvas.canvasWidth/2+o.x*l),this.canvas.background.y=-(this.canvas.canvasHeight/2+o.y*l),this.canvas.background.scale.x=this.canvas.canvasWidth/this.canvas.background.itemWidth,this.canvas.background.scale.y=this.canvas.canvasHeight/this.canvas.background.itemHeight,BFN.Stage.render(this.canvas.background,this.backgroundTexture,!0),this.canvas.background.x=E.backgroundX,this.canvas.background.y=E.backgroundY,this.canvas.background.scale.x=this.canvas.background.scale.y=1;break}let u=new PIXI.Point(s.x,s.y);s.x=-(o.x*l),s.y=-(o.y*l),s.scale.x=s.scale.y=l,s.toggleHiResTextDisplay(!1),s.transformItems.forEach(I=>{I.updateSmoothingScale(l,!1)});let d=s.parent,m=s.parent.children.indexOf(s);s.parent.removeChild(s),BFN.Stage.render(s,this.backgroundTexture,!1),d.addChildAt(s,m),s.x=u.x,s.y=u.y,s.scale.x=s.scale.y=1,s.toggleHiResTextDisplay(!0),s.transformItems.forEach(I=>{I.updateSmoothingScale(null,!1)}),this.isolatedTransformItem.renderable=!0;let p=[0,12,8,4][this.isolatedTransformItem.flippedHorizontal+this.isolatedTransformItem.flippedVertical*2],g=null;switch(this.isolatedTransformItem.type){case"texture":{g=this.isolatedTransformItem.itemContent.texture.baseTexture,this.itemTexture.resize(Math.floor(g.width),Math.floor(g.height));let _=new PIXI.Texture(g);_.rotate=p,this.itemTexture.copyPixels(_),_.destroyGC(!1)}break;case"frame_texture":{let I=this.isolatedTransformItem.itemContent;g=I.baseTexture,this.itemTexture.resize(Math.floor(I.textureFrame.width),Math.floor(I.textureFrame.height));let _=new PIXI.Texture(g);_.rotate=p,this.itemTextureFrame.x=Math.min(I.textureFrame.x,g.width-this.itemTexture.width),this.itemTextureFrame.y=Math.min(I.textureFrame.y,g.height-this.itemTexture.height),this.itemTextureFrame.width=this.itemTexture.width,this.itemTextureFrame.height=this.itemTexture.height;let E=this.isolatedTransformItem.flippedHorizontal?-Math.min(g.width-(this.itemTextureFrame.x+this.itemTexture.width),g.width-this.itemTexture.width):-this.itemTextureFrame.x,D=this.isolatedTransformItem.flippedVertical?-Math.min(g.height-(this.itemTextureFrame.y+this.itemTexture.height),g.height-this.itemTexture.height):-this.itemTextureFrame.y;this.itemTexture.copyPixels(_,{x:E,y:D}),_.destroyGC(!1)}break}this.itemSpriteOffset.x=-(this.itemTexture.width/2%1),this.itemSpriteOffset.y=-(this.itemTexture.height/2%1);let f=this.isolatedTransformItem.itemContentW*this.isolatedTransformItem.scale.x,v=this.isolatedTransformItem.itemContentH*this.isolatedTransformItem.scale.y,T=Math.sqrt(f**2+v**2),x=Math.atan2(v,f),B=this.isolatedTransformItem.x+Math.cos(this.isolatedTransformItem.rotation+x)*(T/2),y=this.isolatedTransformItem.y+Math.sin(this.isolatedTransformItem.rotation+x)*(T/2),F=0,b=0;switch(this.canvasModel){case BFN.PhotoEditorCanvasModel:F=this.canvasModel.imageFitPaddingX*2,b=this.canvasModel.imageFitPaddingY*2;break;case BFN.CollageMakerCanvasModel:F=this.canvasModel.collageFitPaddingX*2,b=this.canvasModel.collageFitPaddingY*2;break;case BFN.DesignerCanvasModel:F=this.canvasModel.designerFitPaddingX*2,b=this.canvasModel.designerFitPaddingY*2;break}this.transformParamsStart.canvasScale=this.canvasModel.canvasScale,this.transformParamsEnd.canvasScale=Math.min(1,(BFN.StageModel.stageW-F)/this.itemTexture.width,(BFN.StageModel.stageH-b)/this.itemTexture.height),this.transformParamsStart.x=B,this.transformParamsStart.y=y,this.transformParamsStart.width=f,this.transformParamsStart.height=v,this.transformParamsStart.rotation=(this.isolatedTransformItem.rotation+Math.PI*4)%(Math.PI*2),this.transformParamsStart.rotation>Math.PI&&(this.transformParamsStart.rotation-=Math.PI*2),this.transformParamsStart.alpha=this.isolatedTransformItem.alpha,this.transformParamsEnd.x=0,this.transformParamsEnd.y=0,this.transformParamsEnd.width=this.itemTexture.width,this.transformParamsEnd.height=this.itemTexture.height,this.transformParamsEnd.rotation=0,this.transformParamsEnd.alpha=1,this.backgroundContainer.x=this.transformParamsStart.x,this.backgroundContainer.y=this.transformParamsStart.y,this.backgroundContainer.rotation=this.transformParamsStart.rotation,this.backgroundContainer.scale.x=this.backgroundContainer.scale.y=1;let S=this.backgroundContainer.toLocal(this.toGlobal(new PIXI.Point(o.x,o.y)));this.backgroundSprite.x=S.x,this.backgroundSprite.y=S.y,this.backgroundSprite.rotation=-this.backgroundContainer.rotation,this.backgroundSprite.scale.x=this.backgroundSprite.scale.y=this.backgroundSprite.currentScale=1/l,g&&(g.backgroundSpritePosition={x:S.x,y:S.y}),this._itemWidth=this.itemTexture.width,this._itemHeight=this.itemTexture.height,this.itemSprite.visible=!0,this.canvas.canvas.visible=!1,UIToggler.toggleMainMenu(!1),UITools.setControlValue("layer_isolator_display_canvas",!0),UITools.updateToolControl("layer_isolator_display_canvas"),UITools.applyTool("layer"),this.isolatedTransformItem.addEventListener(BFN.TransformItemEvents.THUMB_UPDATED.type,this.handleIsolatedItemThumbUpdatedBind),this.canvasModel.addEventListener("CANVAS_SCALE_UPDATED",this.handleCanvasScaleUpdatedBind),this.canvasModel.disregardScaleRange=!0,this.canvasModel.canvasScaling=!0,this.isolationAnimator.setAnimatorFactor(0),this.isolationAnimator.increase(),UIHistory.updateHistoryAvailable(),BFN.canvasFooter.resetEnabled=!1,BFN.MainUI.requestRender()};lt.prototype.releaseTransformItem=function(i=!1){this.waitingToRelease=i,this.waitingToRelease||this.isolateTransformItem()};lt.prototype.toggleBackground=function(i){this.backgroundContainerActive=!!i,this.updateBackgroundContainerAlpha()};lt.prototype.updateBackgroundContainerAlpha=function(){this.backgroundContainer.alpha=this.backgroundContainerActive?1:1-this.isolationAnimator.animationFactor,BFN.MainUI.requestRender()};lt.prototype.shiftCanvasTo=function(i=0,e=0,t=0,r=0){this.shiftParamsStart={x:this.backgroundSprite.x,y:this.backgroundSprite.y,w:this._itemWidth,h:this._itemHeight},this.shiftParamsEnd={x:i,y:e,w:t,h:r};let a=!1;for(let s in this.shiftParamsStart)this.shiftParamsEnd.hasOwnProperty(s)&&Math.round(this.shiftParamsStart[s])!==Math.round(this.shiftParamsEnd[s])&&(a=!0);return a&&(this.shiftAnimator.setAnimatorFactor(0),this.shiftAnimator.increase()),a};lt.prototype.trackImageLayerEdited=function(){let i=new BFN.UserActionVO;i.eventID="image_layer_edited",i.register()};lt.prototype.handleIsolatedItemThumbUpdated=function(i){if(!this.active||this.animating)return;let e=this.isolatedTransformItem,t=[0,12,8,4][e.flippedHorizontal+e.flippedVertical*2],r=null;switch(e.type){case"texture":{r=e.itemContent.texture.baseTexture,this.itemTexture.resize(Math.floor(r.width),Math.floor(r.height));let m=new PIXI.Texture(r);m.rotate=t,this.itemTexture.copyPixels(m),m.destroyGC(!1);break}case"frame_texture":{let d=e.itemContent;r=d.baseTexture,this.itemTexture.resize(Math.floor(d.textureFrame.width),Math.floor(d.textureFrame.height));let m=new PIXI.Texture(r);m.rotate=t,this.itemTextureFrame.x=Math.min(d.textureFrame.x,r.width-this.itemTexture.width),this.itemTextureFrame.y=Math.min(d.textureFrame.y,r.height-this.itemTexture.height),this.itemTextureFrame.width=this.itemTexture.width,this.itemTextureFrame.height=this.itemTexture.height;let p=e.flippedHorizontal?-Math.min(r.width-(this.itemTextureFrame.x+this.itemTexture.width),r.width-this.itemTexture.width):-this.itemTextureFrame.x,g=e.flippedVertical?-Math.min(r.height-(this.itemTextureFrame.y+this.itemTexture.height),r.height-this.itemTexture.height):-this.itemTextureFrame.y;this.itemTexture.copyPixels(m,{x:p,y:g}),m.destroyGC(!1);break}}let a=!1;r&&(!r.backgroundSpritePosition&&r.imageOffset&&(r.backgroundSpritePosition={x:this.backgroundSprite.x+r.imageOffset.x/this.backgroundContainer.scale.x,y:this.backgroundSprite.y+r.imageOffset.y/this.backgroundContainer.scale.y},delete r.imageOffset),r.backgroundSpritePosition&&(a=this.shiftCanvasTo(r.backgroundSpritePosition.x,r.backgroundSpritePosition.y,this.itemTexture.width,this.itemTexture.height)));let s=this.isolatedTransformItem.itemContentW*this.isolatedTransformItem.scale.x,o=this.isolatedTransformItem.itemContentH*this.isolatedTransformItem.scale.y,n=Math.sqrt(s**2+o**2),l=Math.atan2(o,s),c=this.isolatedTransformItem.x+Math.cos(this.isolatedTransformItem.rotation+l)*(n/2),h=this.isolatedTransformItem.y+Math.sin(this.isolatedTransformItem.rotation+l)*(n/2);this.transformParamsStart.x=c,this.transformParamsStart.y=h,this.transformParamsStart.width=s,this.transformParamsStart.height=o,this.transformParamsEnd.width=this.itemTexture.width,this.transformParamsEnd.height=this.itemTexture.height,this._itemWidth=this.itemTexture.width,this._itemHeight=this.itemTexture.height,this.itemTexture.determineTransparency();try{this.altSourceTexture.destroyGC(!0)}catch(d){}this.altSourceTexture=this.itemTexture.renderClone(),BFN.GlobalHistoryModel.updateGlobalHistoryButtons();let u=BFN.AppModel.sectionValue(BFN.PhotoEditorCanvas,BFN.CollageMakerCanvas,BFN.DesignerCanvas);u.updateCheckerPanel(),u.updateTransformLayerVeil(),a||requestAnimationFrame(()=>{this.handleShiftAnimatorIncreaseComplete()}),BFN.MainUI.requestRender()};lt.prototype.handlePhotoEditorCanvasViewstateUpdated=function(i){this.active&&(this.itemSprite.visible=BFN.PhotoEditorCanvasModel.viewState===BFN.PhotoEditorCanvasModelViewStates.VIEWING_CANVAS)};lt.prototype.handleCanvasScaleUpdated=function(i){this.backgroundSprite.currentScale=this.backgroundContainer.scale.x*this.canvasModel.canvasScale,this.backgroundSprite.currentScaleY=this.backgroundContainer.scale.y*this.canvasModel.canvasScale,this.itemSprite.currentScale=this.itemSprite.scale.x*this.canvasModel.canvasScale,this.itemSprite.currentScaleY=this.itemSprite.scale.y*this.canvasModel.canvasScale};lt.prototype.handleIsolationAnimatorUpdate=function(i){let e=(this.transformParamsStart.x-this.transformParamsEnd.x)*(1-this.isolationAnimator.animationSinFactor),t=(this.transformParamsStart.y-this.transformParamsEnd.y)*(1-this.isolationAnimator.animationSinFactor),r=(this.transformParamsStart.width-this.transformParamsEnd.width)*(1-this.isolationAnimator.animationSinFactor),a=(this.transformParamsStart.height-this.transformParamsEnd.height)*(1-this.isolationAnimator.animationSinFactor),s=(this.transformParamsStart.rotation-this.transformParamsEnd.rotation)*(1-this.isolationAnimator.animationSinFactor),o=(this.transformParamsStart.alpha-this.transformParamsEnd.alpha)*(1-this.isolationAnimator.animationSinFactor);this.itemSprite.x=this.transformParamsEnd.x+e+this.itemSpriteOffset.x,this.itemSprite.y=this.transformParamsEnd.y+t+this.itemSpriteOffset.y,this.itemSprite.width=this.transformParamsEnd.width+r,this.itemSprite.height=this.transformParamsEnd.height+a,this.itemSprite.rotation=this.transformParamsEnd.rotation+s,this.itemSprite.alpha=this.transformParamsEnd.alpha+o,this.backgroundContainer.x=this.itemSprite.x,this.backgroundContainer.y=this.itemSprite.y,this.backgroundContainer.scale.x=this.itemSprite.width/this.transformParamsStart.width,this.backgroundContainer.scale.y=this.itemSprite.height/this.transformParamsStart.height,this.backgroundContainer.rotation=this.itemSprite.rotation,this.canvasModel.canvasScale=(this.transformParamsEnd.canvasScale-this.transformParamsStart.canvasScale)*this.isolationAnimator.animationSinFactor+this.transformParamsStart.canvasScale,this.canvas.transformLayerVeil.opacity=this.canvas.transformLayerVeil.baseOpacity*(1-this.isolationAnimator.animationFactor),this.updateBackgroundContainerAlpha()};lt.prototype.handleIsolationAnimatorIncreaseComplete=function(i){this.canvasModel.disregardScaleRange=!1,this.canvasModel.canvasScaling=!1,BFN.ZoomManager.updateZoomRange(),BFN.ZoomRegion.updatePreview(),this.canvas.layerToolContainer.addChild(BFN.PhotoEditorCanvas.canvasTools),this.itemTexture.determineTransparency(),this.altSourceTexture=this.itemTexture.renderClone(),UIToggler.topNavBar.isEditingLayer=!0,this.isolatedCallback&&setTimeout(()=>{requestAnimationFrame(()=>{this.itemSprite.visible=!1,this.isolatedCallback(),this.canvasModel.canvasScaling=!0,this.canvasModel.canvasScale=this.canvasModel.canvasScale,this.canvasModel.canvasScaling=!1;let e=BFN.SentryManager.getDisplayObjectInfo(this.isolatedTransformItem);BFN.SentryManager.reportBreadcrumb(e,"layer_isolated","app_action")})},50)};lt.prototype.handleIsolationAnimatorDecreaseComplete=function(i){if(this.usingAlternateMenu=!1,this.canvasModel.disregardScaleRange=!1,BFN.CollageMakerCanvas.canvasScaleBars.active=!0,this.itemSprite.visible=!1,BFN.PhotoEditorCanvas.canvasToolsContainer.addChild(BFN.PhotoEditorCanvas.canvasTools),this.canvasModel.removeEventListener("CANVAS_SCALE_UPDATED",this.handleCanvasScaleUpdatedBind),this.canvasModel.canvasScaling=!1,this.canvasModel=null,this.canvas.canvas.visible=!0,this.canvas=null,this._itemWidth=0,this._itemHeight=0,this.backgroundTexture.resize(32,32),this.backgroundTexture.clear(),this.itemTexture.resize(32,32),this.itemTexture.clear(),this.isolatedTransformItem){let e=BFN.SentryManager.getDisplayObjectInfo(this.isolatedTransformItem);BFN.SentryManager.reportBreadcrumb(e,"layer_released","app_action"),this.reselectOnReleaseComplete&&this.isolatedTransformItem.selectItem(),this.isolatedTransformItem=null,BFN.TransformGuides.updateVisibility(),this.parent&&this.parent.removeChild(this)}this.reselectOnReleaseComplete=!0,BFN.ZoomManager.updateZoomRange(),BFN.ZoomRegion.updatePreview();try{this.altSourceTexture.destroyGC(!0)}catch(e){}if(UIToggler.toggleMainMenu(!0),UIToggler.topNavBar.isEditingLayer=!1,this.releasedCallback){let e=this.releasedCallback;setTimeout(()=>{requestAnimationFrame(()=>{e()})},50)}this.isolatedCallback=null,this.releasedCallback=null,BFN.GlobalHistoryModel.updateGlobalHistoryButtons(),UIHistory.updateHistoryAvailable(),BFN.canvasFooter.resetEnabled=!0,BFN.HiResTextManager.updateHighResText()};lt.prototype.handleShiftAnimatorUpdate=function(i){let e=this.shiftParamsEnd.x-this.shiftParamsStart.x,t=this.shiftParamsEnd.y-this.shiftParamsStart.y;this.backgroundSprite.x=this.shiftParamsStart.x+e*this.shiftAnimator.animationSinFactor,this.backgroundSprite.y=this.shiftParamsStart.y+t*this.shiftAnimator.animationSinFactor,this.itemSprite.x=-(e*(1-this.shiftAnimator.animationSinFactor))*this.backgroundContainer.scale.x+this.itemSpriteOffset.x,this.itemSprite.y=-(t*(1-this.shiftAnimator.animationSinFactor))*this.backgroundContainer.scale.y+this.itemSpriteOffset.y,BFN.AppModel.sectionValue(BFN.PhotoEditorCanvas,BFN.CollageMakerCanvas,BFN.DesignerCanvas).updateCheckerPanel()};lt.prototype.handleShiftAnimatorIncreaseComplete=function(i){this.usingAlternateMenu&&this.waitingToRelease&&this.releaseTransformItem()};Object.defineProperty(lt.prototype,"active",{get(){return!!this.isolatedTransformItem}});Object.defineProperty(lt.prototype,"activeFactor",{get(){return this.isolationAnimator.animationSinFactor}});Object.defineProperty(lt.prototype,"animating",{get(){return!!(this.isolationAnimator.animating||this.shiftAnimator.animating)}});Object.defineProperty(lt.prototype,"itemWidth",{get(){let i=this._itemWidth;if(BFN.PhotoEditorCanvasModel.viewState!==BFN.PhotoEditorCanvasModelViewStates.VIEWING_CANVAS){let{currentTool:e}=BFN.PhotoEditorCanvasTools;e&&e.hasOwnProperty("itemWidth")&&(i=e.itemWidth)}return i}});Object.defineProperty(lt.prototype,"itemHeight",{get(){let i=this._itemHeight;if(BFN.PhotoEditorCanvasModel.viewState!==BFN.PhotoEditorCanvasModelViewStates.VIEWING_CANVAS){let{currentTool:e}=BFN.PhotoEditorCanvasTools;e&&e.hasOwnProperty("itemHeight")&&(i=e.itemHeight)}return i}});BFN.SingletonQueue.add(()=>{BFN.TransformItemIsolator=new lt});function or(){PIXI.Container.call(this),this.init()}or.prototype=Object.create(PIXI.Container.prototype);or.prototype.init=function(){BeFunky.log("TransformItemBoundingBoxes Init"),this.initDefaultValues(),this.initStrokeRectanglePool()};or.prototype.initDefaultValues=function(){this.interactive=!1,this.itemData=[],this._scale=1};or.prototype.initStrokeRectanglePool=function(){this.strokeRectanglePool=new BFN.StrokeRectanglePool(!1,!0,2,!0,3011608961,3011608961,"undashed_selection_line_gray"),this.addChild(this.strokeRectanglePool)};or.prototype.selectItems=function(i=[]){if(!i)return;let e=this.parent,t=null,r=1;try{t=i.length?i[0].transformLayer.canvas.transformItemBoundingBoxesContainer:null}catch(a){}try{r=i.length?i[0].transformLayer.canvas.model.canvasScale:1}catch(a){}e!==t&&(t?t.addChild(this):e&&e.removeChild(this)),this.strokeRectanglePool.clear(),this.itemData.splice(0),i.forEach(a=>{let s=this.strokeRectanglePool.add(a.x,a.y,a.itemContentW*a.scale.x,a.itemContentH*a.scale.y,a.rotation);s.visible=!a.hidden,this.itemData.push({item:a,strokeRectangle:s})}),this.lineScale=r,BFN.MainUI.requestRender()};or.prototype.updateItems=function(){this.itemData.forEach(i=>{let e=i.item,t=i.strokeRectangle;t.visible=!e.hidden,this.strokeRectanglePool.setTransform(t,e.x,e.y,e.itemContentW*e.scale.x,e.itemContentH*e.scale.y,e.rotation)})};or.prototype.clear=function(){this.selectItems()};or.prototype.includesItem=function(i){if(!i||!this.itemData.length)return!1;let e=this.itemData.length;for(;--e>-1;)if(this.itemData[e].item===i)return!0;return!1};Object.defineProperty(or.prototype,"lineScale",{set:function(i){this.strokeRectanglePool.poolScale=i},get:function(){return this.strokeRectanglePool.poolScale}});BFN.SingletonQueue.add(()=>{BFN.TransformItemBoundingBoxes=new or});function ct(i,e){PIXI.Container.call(this),this._sourceTexture=null,this._shadowTexture=null,i&&i.adjustScale&&e&&(this._sourceTexture=i.renderClone(),this._sourceTexture.adjustScale=Object.assign({},i.adjustScale),this._shadowTexture=e.renderClone()),this.init()}ct.prototype=Object.create(PIXI.Container.prototype);ct.prototype.init=function(){BeFunky.log("TransformItemDropShadow Init"),this.initDefaultValues(),this.initDisplay()};ct.prototype.initDefaultValues=function(){this.interactive=this.interactiveChildren=!1,this.renderable=!this.isEmpty,this._shadowStateID=null,this._adjustScaleX=1,this._adjustScaleY=1,this._parentScaleX=1,this._parentScaleY=1,this._parentRotation=0,this._offsetX=0,this._offsetY=0,this._size=0,this._density=0,this._opacity=100,this._destroyed=!1};ct.prototype.initDisplay=function(){this.scaleContainer=new PIXI.Container,this.addChild(this.scaleContainer),this.rotationContainer=new PIXI.Container,this.scaleContainer.addChild(this.rotationContainer),this.shadowSprite=new PIXI.Sprite(this._shadowTexture||void 0),this.shadowSprite.pluginName="blend_picture",this.shadowSprite.fillColor=0,this.shadowSprite.intensity=1,this.shadowSprite.anchor.x=this.shadowSprite.anchor.y=.5,this.rotationContainer.addChild(this.shadowSprite)};ct.prototype.updateShadowTexture=function(i=null){if(!this._sourceTexture||this._destroyed)return;let e=this._sourceTexture.width+this._size*2,t=this._sourceTexture.height+this._size*2;this._shadowTexture||(this._shadowTexture=PIXI.RenderTexture.create(e,t),this.shadowSprite.texture=this._shadowTexture,this.renderable=!0),(this._shadowTexture.width!==e||this._shadowTexture.height!==t)&&this._shadowTexture.resize(e,t),this._shadowTexture.copyPixels(this._sourceTexture,{x:this._size,y:this._size}),BFN.DirectionalBlurManager.blurTexture(this._shadowTexture,{maxSpread:Math.max(.01,this._size),amount:1,alphaChoke:this._density,iterations:Math.min(5,this._size+1)}),this._shadowStateID=i};ct.prototype.clearShadowTexture=function(){this._sourceTexture&&(this._sourceTexture.destroyGC(!0),this._sourceTexture=null),this._shadowTexture&&(this._shadowTexture.destroyGC(!0),this._shadowTexture=null,this.shadowSprite.texture=PIXI.Texture.EMPTY,this.renderable=!1),this._shadowStateID=null};ct.prototype.destroy=function(){this.clearShadowTexture(),this.shadowSprite.destroy(!0),this.rotationContainer.removeChild(this.shadowSprite),this.rotationContainer.destroy(!0),this.scaleContainer.removeChild(this.rotationContainer),this.scaleContainer.destroy(!0),this.removeChild(this.scaleContainer),this._destroyed=!0};Object.defineProperty(ct.prototype,"shadowStateID",{get:function(){return this._shadowStateID}});Object.defineProperty(ct.prototype,"sourceTexture",{get:function(){return this._sourceTexture||(this._sourceTexture=PIXI.RenderTexture.create(32,32)),this._sourceTexture}});Object.defineProperty(ct.prototype,"shadowTexture",{get:function(){return this._shadowTexture}});Object.defineProperty(ct.prototype,"isEmpty",{get:function(){return!(this._sourceTexture&&this._shadowTexture)}});Object.defineProperty(ct.prototype,"adjustScaleX",{set:function(i){this._adjustScaleX!==i&&(this._adjustScaleX=i,this.shadowSprite.scale.x=1/this._adjustScaleX)},get:function(){return this._adjustScaleX}});Object.defineProperty(ct.prototype,"adjustScaleY",{set:function(i){this._adjustScaleY!==i&&(this._adjustScaleY=i,this.shadowSprite.scale.y=1/this._adjustScaleY)},get:function(){return this._adjustScaleY}});Object.defineProperty(ct.prototype,"parentScaleX",{set:function(i){this._parentScaleX!==i&&(this._parentScaleX=i,this.scaleContainer.scale.x=1/this._parentScaleX)},get:function(){return this._parentScaleX}});Object.defineProperty(ct.prototype,"parentScaleY",{set:function(i){this._parentScaleY!==i&&(this._parentScaleY=i,this.scaleContainer.scale.y=1/this._parentScaleY)},get:function(){return this._parentScaleY}});Object.defineProperty(ct.prototype,"parentRotation",{set:function(i){this._parentRotation!==i&&(this._parentRotation=i,this.rotationContainer.rotation=-this._parentRotation,this.shadowSprite.rotation=this._parentRotation)},get:function(){return this._parentRotation}});Object.defineProperty(ct.prototype,"offsetX",{set:function(i){this._offsetX!==i&&(this._offsetX=i,this.shadowSprite.x=this._offsetX)},get:function(){return this._offsetX}});Object.defineProperty(ct.prototype,"offsetY",{set:function(i){this._offsetY!==i&&(this._offsetY=i,this.shadowSprite.y=this._offsetY)},get:function(){return this._offsetY}});Object.defineProperty(ct.prototype,"size",{set:function(i){this._size=Math.max(0,i)},get:function(){return this._size}});Object.defineProperty(ct.prototype,"density",{set:function(i){this._density=Math.max(0,Math.min(1,i))},get:function(){return this._density}});Object.defineProperty(ct.prototype,"opacity",{set:function(i){i=Math.max(0,Math.min(100,i)),this._opacity!==i&&(this._opacity=i,this.shadowSprite.alpha=this._opacity/100)},get:function(){return this._opacity}});Object.defineProperty(ct.prototype,"color",{set:function(i){i=Math.max(0,Math.min(16777215,i)),this.shadowSprite.fillColor!==i&&(this.shadowSprite.fillColor=i)},get:function(){return this.shadowSprite.fillColor}});Object.defineProperty(ct.prototype,"blendMode",{set:function(i){this.shadowSprite.blendMode!==i&&(this.shadowSprite.blendMode=i)},get:function(){return this.shadowSprite.blendMode}});Object.defineProperty(ct.prototype,"smoothingScaleX",{set:function(i){this.shadowSprite.currentScale=i},get:function(){return this.shadowSprite.currentScale}});Object.defineProperty(ct.prototype,"smoothingScaleY",{set:function(i){this.shadowSprite.currentScaleY=i},get:function(){return this.shadowSprite.currentScaleY}});BFN.TransformItemDropShadow=ct;function Dt(i){if(PIXI.Container.call(this),this.valid=i&&i instanceof BFN.TransformItem&&i.type==="text",!this.valid){BeFunky.throwError("TransformItemCurvedText Source Invalid");return}this._sourceTransformItem=i,this.init()}Dt.prototype=Object.create(PIXI.Container.prototype);Dt.prototype.init=function(){BeFunky.log("TransformItemCurvedText Init"),this.initDefaultValues(),this.initCText(),this.initDisplay()};Dt.prototype.initDefaultValues=function(){this.interactive=this.interactiveChildren=!1,this._width=0,this._height=0,this._curveAmount=0,this._hitAreaPolygonPoints=null,this._iText=this._sourceTransformItem.iText};Dt.prototype.initCText=function(){this._cText=new fabric.CurvedText("",{left:0,top:0,textAlign:"left",fontFamily:BFN.FabricManager.defaultFontFamily,fontSize:BFN.TransformItemTextBaseFontSize,fill:"rgb(0,0,0)",padding:10}),this._cText.objectCaching=!1,this._cText.paintFirst="stroke",this._cText.noScaleCache=!1,this._cText.strokeWidth=0,this._cText.objectCaching=!1,this._cText.debugCurve=!1};Dt.prototype.initDisplay=function(){this.curvedTextTexture=null,this.curvedTextSprite=new PIXI.Sprite,this.curvedTextSprite.pluginName="blend_picture",this.addChild(this.curvedTextSprite)};Dt.prototype.destroyCurvedText=function(){this.resetCurvedText(),this.removeChild(this.curvedTextSprite),this.curvedTextSprite=null,this._iText=this._cText=this._sourceTransformItem=null,this.valid=!1};Dt.prototype.resetCurvedText=function(){this.curvedTextTexture&&(this.curvedTextTexture.destroyGC(!0),this.curvedTextTexture=null),this.curvedTextSprite.texture=PIXI.Texture.EMPTY,this.curvedTextSprite.x=this.curvedTextSprite.y=0,this.curvedTextSprite.scale.x=this.curvedTextSprite.scale.y=1,this._width=this._height=0,this._hitAreaPolygonPoints&&(this._hitAreaPolygonPoints.splice(0),this._hitAreaPolygonPoints=null)};Dt.prototype.renderCurvedText=function(i=0){if(typeof i!="number")return;this._curveAmount=Math.max(-1,Math.min(1,i));let{textPadding:e,textScale:t}=this._sourceTransformItem,r=this._cText;if(BFN.FabricManager.styleUpdating){let{bounds:n}=BFN.FabricManager.conformCTextToIText(this._sourceTransformItem,!1,!0)._getCurveCharData();this._width=n.width*t,this._height=n.height*t}else{let n=BFN.CurvedTextManager.renderCurvedText(this,this.curvedTextTexture);this.curvedTextTexture||(this.curvedTextSprite.texture=this.curvedTextTexture=n);let{adjustScale:l}=n;this.curvedTextSprite.x=-(e*t),this.curvedTextSprite.y=-(e*t),this.curvedTextSprite.scale.x=this.curvedTextSprite.scale.y=1/l,this._width=Math.round(this.curvedTextSprite.width-e*2*t),this._height=Math.round(this.curvedTextSprite.height-e*2*t),r=BFN.curveText}this._hitAreaPolygonPoints||(this._hitAreaPolygonPoints=[]),this._hitAreaPolygonPoints.splice(0);let{chars:a,bounds:s,attributes:o}=r._getCurveCharData();if(this._curveAmount===0||!a.length)this._hitAreaPolygonPoints.push(new PIXI.Point(0,0)),this._hitAreaPolygonPoints.push(new PIXI.Point(this._width,0)),this._hitAreaPolygonPoints.push(new PIXI.Point(this._width,this._height)),this._hitAreaPolygonPoints.push(new PIXI.Point(0,this._height));else{let{circleRadius:n,lineH:l,activeBeta:c,directionFactor:h,circleCenter:u}=o,d=n+l/2,m=Math.max(0,n-l/2),p=[],g=[],f=Math.PI/60,v=Math.max(1,Math.round(c/f));f=c/v;for(let y=0;y<=v;y++){let F=f*y,b=h<0?(Math.PI+c)/2-F:F-(Math.PI+c)/2,S=(u.x-s.minX+Math.cos(b)*d)*t,I=(u.y-s.minY+Math.sin(b)*d)*t;if(p.push(new PIXI.Point(S,I)),m){let _=(u.x-s.minX+Math.cos(b)*m)*t,E=(u.y-s.minY+Math.sin(b)*m)*t;g.push(new PIXI.Point(_,E))}}let T=Math.abs(Math.PI*2-c),x=Math.PI/1800,B=Math.abs(Math.atan2(Math.sin(T),Math.cos(T)))<x;g.length?g.reverse():B&&p.pop(),this._hitAreaPolygonPoints.push(...p,...g),(this._sourceTransformItem.flippedHorizontal||this._sourceTransformItem.flippedVertical)&&this._hitAreaPolygonPoints.forEach(y=>{this._sourceTransformItem.flippedHorizontal&&(y.x=this._width-y.x),this._sourceTransformItem.flippedVertical&&(y.y=this._height-y.y)})}};Dt.prototype.updateDisplay=function(){if(!this.curvedTextTexture)return;let{textPadding:i,textScale:e}=this._sourceTransformItem,t=i*e,{adjustScale:r}=this.curvedTextTexture;this.curvedTextSprite.x=this._flipX?this._width+t:-t,this.curvedTextSprite.y=this._flipY?this._height+t:-t,this.curvedTextSprite.scale.x=(this._flipX?-1:1)/r,this.curvedTextSprite.scale.y=(this._flipY?-1:1)/r};Dt.prototype.setScaleMode=function(i){this.curvedTextTexture&&this.curvedTextTexture.setScaleMode(i)};Dt.prototype.setSmoothingScale=function(i){this.curvedTextSprite.currentScale=i*this.curvedTextSprite.scale.x};Dt.prototype.getCTextMask=function(i){BFN.CurvedTextManager.generateCurvedTextMask(this,i,!1)};Object.defineProperty(Dt.prototype,"sourceTransformItem",{get:function(){return this._sourceTransformItem}});Object.defineProperty(Dt.prototype,"cText",{get:function(){return this._cText}});Object.defineProperty(Dt.prototype,"width",{get:function(){return this._width}});Object.defineProperty(Dt.prototype,"height",{get:function(){return this._height}});Object.defineProperty(Dt.prototype,"curveAmount",{get:function(){return this._curveAmount}});Object.defineProperty(Dt.prototype,"blendMode",{set:function(i){this.curvedTextSprite.blendMode=i},get:function(){return this.curvedTextSprite.blendMode}});Object.defineProperty(Dt.prototype,"hitAreaPolygonPoints",{get:function(){return this._hitAreaPolygonPoints}});BFN.TransformItemCurvedText=Dt;BFN.TransformLayerEvents={ITEM_SELECTED:new Event("ITEM_SELECTED"),ITEMS_UPDATED:new Event("ITEMS_UPDATED"),ITEM_DISPLAY_UPDATED:new Event("ITEMS_UPDATED"),ITEM_DUPLICATED:new Event("ITEM_DUPLICATED")};function Me(i,e){switch(PIXI.Sprite.call(this),BFN.EventDispatcher.call(this),this.appViewState=i,this.canvas=e,this.model=null,this.appViewState){case BFN.AppModelViewStates.VIEWING_PHOTO_EDITOR:this.model=BFN.PhotoEditorModel;break;case BFN.AppModelViewStates.VIEWING_COLLAGE_MAKER:this.model=BFN.CollageMakerModel;break;case BFN.AppModelViewStates.VIEWING_DESIGNER:this.model=BFN.DesignerModel;break}this.init()}Me.prototype=window.azrc.extend(Object.create(PIXI.Sprite.prototype),Object.create(BFN.EventDispatcher.prototype));Me.prototype.init=function(){BeFunky.log("TransformLayer Init"),this.initDefaultValues(),this.initSelectionRect()};Me.prototype.initDefaultValues=function(){this.interactive=!0,this._scale=1,this.selectedItem=null,this.transformItems=[],this.frameWidth=0,this.frameHeight=0,this.nudgeDistance=1,this.altPressed=!1,this.dPressed=!1,this.usedBaseTextures=[],this.lastPressedItem=null,this.lastSelectedItem=null,this.lastClickedItem=null,this.handleGroupMouseMoveBind=this.handleGroupMouseMove.bind(this),this.handleGroupMouseUpBind=this.handleGroupMouseUp.bind(this),this.handleItemMouseOverBind=this.handleItemMouseOver.bind(this),this.handleItemMouseOutBind=this.handleItemMouseOut.bind(this),this.handleItemPressedBind=this.handleItemPressed.bind(this),this.handleItemReleasedBind=this.handleItemReleased.bind(this),this.handleItemDisplayUpdatedBind=this.handleItemDisplayUpdated.bind(this),this.handleGetSnapCoordinatesBind=this.handleGetSnapCoordinates.bind(this),this.handleSelectItemBind=this.handleSelectItem.bind(this),this.handleDeselectItemBind=this.handleDeselectItem.bind(this),this.handleRemoveItemBind=this.handleRemoveItem.bind(this),this.handleDestroyItemBind=this.handleDestroyItem.bind(this),this.handleDuplicateItemBind=this.handleDuplicateItem.bind(this),this.handleRegisterTransitionBind=this.handleRegisterTransition.bind(this),this.handleTransitionAppliedBind=this.handleTransitionApplied.bind(this),this.handleKeyDownBind=this.handleKeyDown.bind(this),this.handleAltKeyUpBind=this.handleAltKeyUp.bind(this)};Me.prototype.initSelectionRect=function(){this.selectionRect=new BFN.Rectangle,this.selectionOrigin=new PIXI.Point,this.canvasSelectionOrigin=new PIXI.Point,this.transformItemBounds=[],this.groupedTransformItems=[],this.retainedTransformItems=[],this.handleTransformItemGroupPressedBind=this.handleTransformItemGroupPressed.bind(this),this.selectionShape=new PIXI.Graphics,this.selectionShape.beginFill(11184895,.4),this.selectionShape.drawRect(0,0,100,100),this.selectionShape.endFill()};Me.prototype.addItem=function(i){i.initialFrameWidth=this.frameWidth,i.initialFrameHeight=this.frameHeight;let e=!!i.isDuplicate,t=null;i.hasOwnProperty("accurateBounds")&&(t=i.accurateBounds,delete i.accurateBounds);let r=new BFN.TransformItem(i,this.appViewState);if(i.projectItemVO&&i.projectItemVO.layerNum!=-1&&!e)r.layerName=i.projectItemVO.layerName,r.layerNum=i.projectItemVO.layerNum;else{r.layerName=null;let s=0;this.children.forEach(o=>{o.layerType==r.layerType&&(s=Math.max(s,o.layerNum))}),r.layerNum=s+1}if(i.projectItemVO&&i.projectItemVO.layerName&&e){let s=c=>{let h=c.split(" (");if(h.length>1){let d=h.pop().split(")");if(d.length===2){let m=parseInt(d.shift());if(!isNaN(m))return m}}return NaN},o=i.projectItemVO.layerName;if(!isNaN(s(o))){let c=o.split(" (");c.pop(),o=c.join(" (")}r.layerName=o;let n=[];this.children.forEach(c=>{if(c instanceof BFN.TransformItem&&c.projectItemVO&&c.projectItemVO.layerName&&c.projectItemVO.layerName.includes(o)){let h=s(c.projectItemVO.layerName);!isNaN(h)&&h>0&&!n.includes(h)&&n.push(h)}});let l=0;for(;++l;)if(!n.includes(l)){r.layerName+=" ("+l+")";break}}i.hasOwnProperty("initialPosition")&&i.initialPosition?(r.x=i.initialPosition.x-this.frameWidth/2,r.y=i.initialPosition.y-this.frameHeight/2):i.hasOwnProperty("initialCenterPosition")&&i.initialCenterPosition?(r.x=i.initialCenterPosition.x-r.itemContentW*r.scale.x/2,r.y=i.initialCenterPosition.y-r.itemContentH*r.scale.y/2):(r.x=-(r.itemContentW/2)*r.scale.x,r.y=-(r.itemContentH/2)*r.scale.y),r.updateFrameTextureDisplay(),r.on("pointerover",this.handleItemMouseOverBind),r.on("pointerout",this.handleItemMouseOutBind),r.on("pointerdown",this.handleItemPressedBind),r.on("pointerup",this.handleItemReleasedBind),r.addEventListener(BFN.TransformItemEvents.ITEM_DISPLAY_UPDATED.type,this.handleItemDisplayUpdatedBind),r.addEventListener(BFN.TransformItemEvents.GET_SNAP_COORDINATES.type,this.handleGetSnapCoordinatesBind),r.addEventListener(BFN.TransformItemEvents.PRESS_ITEM.type,this.handleItemPressedBind),r.addEventListener(BFN.TransformItemEvents.SELECT_ITEM.type,this.handleSelectItemBind),r.addEventListener(BFN.TransformItemEvents.DESELECT_ITEM.type,this.handleDeselectItemBind),r.addEventListener(BFN.TransformItemEvents.REMOVE_ITEM.type,this.handleRemoveItemBind),r.addEventListener(BFN.TransformItemEvents.DESTROY_ITEM.type,this.handleDestroyItemBind),r.addEventListener(BFN.TransformItemEvents.DUPLICATE_ITEM.type,this.handleDuplicateItemBind),r.addEventListener(BFN.TransformItemEvents.REGISTER_TRANSITION.type,this.handleRegisterTransitionBind),r.addEventListener(BFN.TransformItemEvents.TRANSITION_APPLIED.type,this.handleTransitionAppliedBind),this.transformItems.push(r),BFN.TransformItemGroup.duplicatingGroup&&(r.isGroupTransition=!0);let a="history_"+(e?"duplicate_":"new_");return r.type=="text"?a+="text":r.isGoodie?a+=r.basicShapeVO?"shape":"graphic":a+="image",r.createTransition(a,!0),r.isGroupTransition&&delete r.isGroupTransition,this.addChild(r),r.registerTransition(!1,!t),t&&(r.currentTransformItemStateVO.accurateBounds=t,r.transitionVO&&(r.transitionVO.startState.accurateBounds=t,r.transitionVO.endState.accurateBounds=t)),this.model.updateProjectVO(),r.updateAccurateBounds(),BFN.ProjectManager.transformItemsPending||this.dispatchEvent(BFN.TransformLayerEvents.ITEMS_UPDATED),BFN.TransformModel.addedTransformItem=r,BFN.TransformModel.selectItemOnAdd&&this.selectItem(r),r};Me.prototype.selectItem=function(i){this.debouncingHideMeasurements=!1,this.altPressed&&this.handleAltKeyUpBind(null,!0),!this.clickItem(i)&&(BFN.TransformModel.transformToolFrame&&BFN.TransformModel.transformToolFrame.active&&BFN.TransformModel.transformToolFrame.setup(null),i&&(this.transformItems.includes(i)||i.type=="group")&&(this.handleSelectedItemTransition(i),this.selectedItem=i,window.addEventListener("keydown",this.handleKeyDownBind),this.dispatchEvent(BFN.TransformLayerEvents.ITEM_SELECTED)))};Me.prototype.deselectItem=function(i=!0,e=!1){if(!(BFN.GestureManager.multiplePointersActive||BFN.EyeDropper.active)&&(this.textTransformItem=null,this.selectedItem)){if((BFN.CursorScreen.cursorLock||BFN.CursorScreen.cursor)&&(BFN.CursorScreen.cursorLock=!1,BFN.CursorScreen.cursor=null),e&&this.selectedItem.type=="frame_texture")return;if(this.selectedItem&&this.selectedItem.type=="frame_texture"){let{transformToolFrame:t}=this.selectedItem.transformTool;if(t.transformItem===this.selectedItem){t.setup(null);return}}this.lastDeselectedItem=this.selectedItem,this.selectedItem=null,window.removeEventListener("keydown",this.handleKeyDownBind),i&&this.resetTransformItemGroup(),this.lastPressedItem=null,this.lastSelectedItem=null,this.lastClickedItem=null,this.dispatchEvent(BFN.TransformLayerEvents.ITEM_SELECTED)}};Me.prototype.clickItem=function(i,e=!1){if(BFN.GestureManager.multiplePointersActive||BFN.EyeDropper.active)return!1;if(i&&i.type==="frame_texture"&&(e||i.selectedByMouse))if(this.awaitingDoubleClick&&this.awaitingDoubleClickTimeoutID){if(clearTimeout(this.awaitingDoubleClickTimeoutID),this.awaitingDoubleClick=!1,this.awaitingDoubleClickTimeoutID=null,i==this.lastPressedItem)return BFN.TransformModel.transformToolFrame.transformItem!==BFN.TransformModel.selectedTransformItem&&BFN.TransformModel.transformToolFrame.setup(BFN.TransformModel.selectedTransformItem),!0}else!this.awaitingDoubleClick&&!this.awaitingDoubleClickTimeoutID&&(this.awaitingDoubleClick=!0,this.awaitingDoubleClickTimeoutID=setTimeout(()=>{this.awaitingDoubleClick=!1,this.awaitingDoubleClickTimeoutID=null},250));return!1};Me.prototype.handleSelectedItemTransition=function(i){let e=[...BFN.alternateMenu.querySelectorAll(".popover.active")];this.selectedItem&&this.selectedItem.type===i.type?(e.forEach(t=>{t.originalStrongValue=t.strong,t.strong=!0}),setTimeout(()=>{e.forEach(t=>{t.strong=!!t.originalStrongValue,delete t.originalStrongValue})},0)):(e.forEach(t=>t.setStyles({display:"none"})),requestAnimationFrame(()=>{e.forEach(t=>t.setStyles({display:"block"}))}))};Me.prototype.enableChildren=function(){this.interactiveChildren=!0};Me.prototype.disableChildren=function(){this.interactiveChildren=!1};Me.prototype.toggleFlattenDisplayMode=function(i,e){e=e||1,this.toggleTransparentBasicShapeDisplay(!i),this.toggleHiResTextDisplay(!i),this.toggleItemScaleSmoothing(!i,e),this.setItemScaleMode(i&&e===1?PIXI.SCALE_MODES.NEAREST:PIXI.SCALE_MODES.LINEAR,["text"])};Me.prototype.toggleTransparentBasicShapeDisplay=function(i){for(let e=0;e<this.transformItems.length;e++){let t=this.transformItems[e];if(t.isGoodie&&t.basicShapeVO)if(i)t.renderable=!0;else{let a=t.basicShapeVO.fill===-1&&t.basicShapeVO.stroke===-1;t.renderable=!a}}BFN.MainUI.requestRender()};Me.prototype.toggleHiResTextDisplay=function(i){for(let e=0;e<this.transformItems.length;e++){let t=this.transformItems[e];t.type==="text"&&t.toggleHiResText(!!i)}BFN.MainUI.requestRender()};Me.prototype.toggleItemScaleSmoothing=function(i,e){e=typeof e=="number"?Math.max(0,Math.min(1,e)):1;for(let t=0;t<this.transformItems.length;t++)this.transformItems[t].updateSmoothingScale(i?0:e)};Me.prototype.setItemScaleMode=function(i,e=null){if(!!([PIXI.SCALE_MODES.LINEAR,PIXI.SCALE_MODES.NEAREST].includes(i)&&e&&e instanceof Array)){for(let t=0;t<this.transformItems.length;t++){let r=this.transformItems[t],a=r.rotation===0?i:PIXI.SCALE_MODES.LINEAR;e.includes(r.type)&&r.setItemScaleMode(a)}BFN.MainUI.requestRender()}};Me.prototype.removeItem=function(i){i&&(i==this.selectedItem&&i.type!="group"&&this.deselectItem(),i==BFN.TransformModel.focusedTransformItem&&(BFN.TransformModel.focusedTransformItem=null),i.type=="group"&&i.selectedItems.length?(i.createTransition("history_remove_selection",!1),i._selectedItems.forEach(e=>{this.children.indexOf(e)!=-1&&this.transformItems.indexOf(e)!=-1&&(e.clearDropShadow(),e.createTransition("history_remove_selection"),this.removeChild(e),e.registerTransition(!1,!1))}),i.registerTransition(!1,!1,!1),this.deselectItem(),this.model.updateProjectVO(),this.dispatchEvent(BFN.TransformLayerEvents.ITEMS_UPDATED)):this.children.indexOf(i)!=-1&&this.transformItems.indexOf(i)!=-1&&(i.clearDropShadow(),i.createTransition(i.type=="text"?"history_delete_text":i.isGoodie?"history_delete_graphic":"history_delete_image"),this.removeChild(i),i.registerTransition(),this.model.updateProjectVO(),this.dispatchEvent(BFN.TransformLayerEvents.ITEMS_UPDATED)))};Me.prototype.destroyItem=function(i){i&&(i==this.selectedItem&&this.deselectItem(),this.transformItems.indexOf(i)!=-1&&(this.children.indexOf(i)!=-1&&this.removeChild(i),this.transformItems.splice(this.transformItems.indexOf(i),1),i.off("pointerover",this.handleItemMouseOverBind),i.off("pointerout",this.handleItemMouseOutBind),i.off("pointerdown",this.handleItemPressedBind),i.off("pointerup",this.handleItemPressedBind),i.removeEventListener(BFN.TransformItemEvents.ITEM_DISPLAY_UPDATED.type,this.handleItemDisplayUpdatedBind),i.removeEventListener(BFN.TransformItemEvents.GET_SNAP_COORDINATES.type,this.handleGetSnapCoordinatesBind),i.removeEventListener(BFN.TransformItemEvents.PRESS_ITEM.type,this.handleItemPressedBind),i.removeEventListener(BFN.TransformItemEvents.SELECT_ITEM.type,this.handleSelectItemBind),i.removeEventListener(BFN.TransformItemEvents.DESELECT_ITEM.type,this.handleDeselectItemBind),i.removeEventListener(BFN.TransformItemEvents.REMOVE_ITEM.type,this.handleRemoveItemBind),i.removeEventListener(BFN.TransformItemEvents.DESTROY_ITEM.type,this.handleDestroyItemBind),i.removeEventListener(BFN.TransformItemEvents.DUPLICATE_ITEM.type,this.handleDuplicateItemBind),i.destroy(this.usedBaseTextures),i=null,this.model.updateProjectVO(),this.dispatchEvent(BFN.TransformLayerEvents.ITEMS_UPDATED)))};Me.prototype.removeAllItems=function(){let i=this.transformItems.length;for(BFN.TransformStateModel.startBulkTransition("removeall");--i>-1;)this.removeItem(this.transformItems[i]);BFN.TransformStateModel.stopBulkTransition()};Me.prototype.destroyAllItems=function(){this.usedBaseTextures=BFN.GlobalHistoryModel.getUsedBaseTextures(this.appViewState);let i=this.transformItems.length;for(;--i>-1;)this.destroyItem(this.transformItems[i]);this.usedBaseTextures.splice(0)};Me.prototype.alignItem=function(i,e=null){if(i.accurateBounds){let t=BFN.Util.getTransformItemBounds(i),r={x:0,y:0},a=e===null;switch(i.align){case"left":r.x=(a?-(this.frameWidth/2):e)-(t.minX+i.accurateBounds.left);break;case"center":r.x=(a?0:e)-(t.centerX+i.accurateBounds.centerOffsetX);break;case"right":r.x=(a?this.frameWidth/2:e)-(t.maxX-i.accurateBounds.right);break;case"top":r.y=(a?-(this.frameHeight/2):e)-(t.minY+i.accurateBounds.top);break;case"middle":r.y=(a?0:e)-(t.centerY+i.accurateBounds.centerOffsetY);break;case"bottom":r.y=(a?this.frameHeight/2:e)-(t.maxY-i.accurateBounds.bottom);break}i.x+=r.x,i.y+=r.y,i.updateHiResTextBounds(),BFN.MainUI.requestRender()}};Me.prototype.getAveragePosition=function(i=[],e=null){let t=0;return i.length&&(i.forEach(r=>{let a=BFN.Util.getTransformItemBounds(r);switch(e){case"left":t+=a.minX+r.accurateBounds.left;break;case"center":t+=a.centerX+r.accurateBounds.centerOffsetX;break;case"right":t+=a.maxX-r.accurateBounds.right;break;case"top":t+=a.minY+r.accurateBounds.top;break;case"middle":t+=a.centerY+r.accurateBounds.centerOffsetY;break;case"bottom":t+=a.maxY-r.accurateBounds.bottom;break}}),t/=i.length),t};Me.prototype.getItemSelectionBounds=function(i=[]){let e=null;return i&&i.length&&i.forEach(t=>{let r=BFN.Util.getTransformItemBounds(t);e||(e={}),e.left=e.hasOwnProperty("left")?Math.min(e.left,r.minX+t.accurateBounds.left):r.minX+t.accurateBounds.left,e.right=e.hasOwnProperty("right")?Math.max(e.right,r.maxX-t.accurateBounds.right):r.maxX-t.accurateBounds.right,e.top=e.hasOwnProperty("top")?Math.min(e.top,r.minY+t.accurateBounds.top):r.minY+t.accurateBounds.top,e.bottom=e.hasOwnProperty("bottom")?Math.max(e.bottom,r.maxY-t.accurateBounds.bottom):r.maxY-t.accurateBounds.bottom}),e?(e.center=(e.left+e.right)/2,e.middle=(e.top+e.bottom)/2):e={left:0,center:0,right:0,top:0,middle:0,bottom:0},e};Me.prototype.offsetAllItems=function(i,e){BeFunky.log("OFFSET ITEMS",i,e);let t=[];this.children.forEach(r=>{r instanceof BFN.TransformItem&&t.push(r)}),!!t.length&&(BFN.UndoManager.isBatchHistoryAction&&BFN.TransformStateModel.startBulkTransition(`offset_items_${BeFunky.randomString(10)}`),t.forEach(r=>{BFN.UndoManager.isBatchHistoryAction&&r.createTransition("offset_item"),r.x+=Math.round(i),r.y+=Math.round(e),BFN.UndoManager.isBatchHistoryAction&&r.registerTransition()}),BFN.TransformStateModel.stopBulkTransition(),BFN.MainUI.requestRender())};Me.prototype.hasText=function(){return this.children.some(i=>i instanceof BFN.TransformItem&&i.type==="text")};Me.prototype.startGroupSelection=function(i,e=!1,t=!1,r=[]){if(i!==null){this.groupActivePointerID=i,BFN.SentryManager.reportBreadcrumb(`Available Items: ${BFN.TransformLayerManager.transformItems.length} | Selected Items: ${BFN.TransformItemGroup.selectedItems.length}`,"start_selection_drag"),document.removeEventListener(BeFunky.pointerup,this.handleGroupMouseUpBind,!0),document.removeEventListener(BeFunky.pointercancel,this.handleGroupMouseUpBind,!0),document.removeEventListener(BeFunky.pointermove,this.handleGroupMouseMoveBind,!0),document.addEventListener(BeFunky.pointerup,this.handleGroupMouseUpBind,!0),document.addEventListener(BeFunky.pointercancel,this.handleGroupMouseUpBind,!0),document.addEventListener(BeFunky.pointermove,this.handleGroupMouseMoveBind,!0),this.eraseSelection=t,this.retainedTransformItems.splice(0),e&&(BFN.TransformItemGroup.selectedItems.forEach(a=>{this.retainedTransformItems.push(a)}),r.forEach(a=>{this.retainedTransformItems.includes(a)||this.retainedTransformItems.push(a)})),this.transformItemBounds.splice(0);for(let a=0;a<this.transformItems.length;a++){let s=this.transformItems[a];this.children.includes(s)&&s.accurateBounds&&(s.updateItemBoundsData(),s.itemBoundsData&&!s.hidden&&this.transformItemBounds.push(s.itemBoundsData))}this.updateGroupSelection()}};Me.prototype.updateGroupSelection=function(){if(!BFN.MainUI.pointerEvent.data.isPrimary)return;let i=this.getPointerPosition(BFN.MainUI.pointerEvent),e=this.canvas.getPointerPosition(BFN.MainUI.pointerEvent);this.canvas.transformIndicatorContainer.children.includes(this.selectionShape)||(this.selectionOrigin.x=i.x,this.selectionOrigin.y=i.y,this.canvasSelectionOrigin.x=e.x,this.canvasSelectionOrigin.y=e.y,this.canvas.transformIndicatorContainer.addChild(this.selectionShape)),this.selectionRect.left=Math.floor(Math.min(this.selectionOrigin.x,i.x)),this.selectionRect.top=Math.floor(Math.min(this.selectionOrigin.y,i.y)),this.selectionRect.right=Math.ceil(Math.max(this.selectionOrigin.x,i.x)),this.selectionRect.bottom=Math.ceil(Math.max(this.selectionOrigin.y,i.y)),this.selectionShape.x=Math.floor(Math.min(this.canvasSelectionOrigin.x,e.x)),this.selectionShape.y=Math.floor(Math.min(this.canvasSelectionOrigin.y,e.y)),this.selectionShape.scale.x=(Math.ceil(Math.max(this.canvasSelectionOrigin.x,e.x))-this.selectionShape.x)/100,this.selectionShape.scale.y=(Math.ceil(Math.max(this.canvasSelectionOrigin.y,e.y))-this.selectionShape.y)/100;let t=[BFN.MainUI.toLocal(new PIXI.Point(this.selectionRect.left,this.selectionRect.top),this),BFN.MainUI.toLocal(new PIXI.Point(this.selectionRect.right,this.selectionRect.top),this),BFN.MainUI.toLocal(new PIXI.Point(this.selectionRect.right,this.selectionRect.bottom),this),BFN.MainUI.toLocal(new PIXI.Point(this.selectionRect.left,this.selectionRect.bottom),this)];if(this.groupedTransformItems.splice(0),this.retainedTransformItems.forEach(r=>{this.groupedTransformItems.push(r)}),this.eraseSelection){if(this.groupedTransformItems.length){let r=this.transformItemBounds.length;for(;--r>-1;){let a=this.transformItemBounds[r],s=this.groupedTransformItems.indexOf(a.item);s!=-1&&BFN.Util.polygonHitTest(t,a.globalPolygon)&&this.groupedTransformItems.splice(s,1)}}}else this.transformItemBounds.forEach(r=>{!this.retainedTransformItems.includes(r.item)&&!r.item.locked&&BFN.Util.polygonHitTest(t,r.globalPolygon)&&this.groupedTransformItems.push(r.item)});this.groupedTransformItems.length?(this.children.includes(BFN.TransformItemGroup)||(BFN.TransformItemGroup.transformLayer=this,this.addChild(BFN.TransformItemGroup)),BFN.TransformItemGroup.canvasScale=this._scale):this.children.includes(BFN.TransformItemGroup)&&(BFN.TransformItemGroup.transformLayer=null,this.removeChild(BFN.TransformItemGroup)),BFN.TransformItemGroup.updateSelectedItems(this.groupedTransformItems),BFN.MainUI.requestRender()};Me.prototype.stopGroupSelection=function(){this.groupActivePointerID=null,BFN.SentryManager.reportBreadcrumb(`Available Items: ${BFN.TransformLayerManager.transformItems.length} | Selected Items: ${BFN.TransformItemGroup.selectedItems.length}`,"stop_selection_drag"),document.removeEventListener(BeFunky.pointerup,this.handleGroupMouseUpBind,!0),document.removeEventListener(BeFunky.pointercancel,this.handleGroupMouseUpBind,!0),document.removeEventListener(BeFunky.pointermove,this.handleGroupMouseMoveBind,!0),this.canvas.transformIndicatorContainer.children.includes(this.selectionShape)&&this.canvas.transformIndicatorContainer.removeChild(this.selectionShape),this.groupedTransformItems.length&&(this.groupedTransformItems.length==1?(this.groupedTransformItems[0].selectItem(),this.resetTransformItemGroup()):this.updateTransformItemGroup()),BFN.MainUI.requestRender()};Me.prototype.updateTransformItemGroup=function(){BFN.TransformItemGroup.selectedItems.length&&(BFN.TransformItemGroup.scale.x==1&&BFN.TransformItemGroup.rotation==0&&BFN.TransformItemGroup.updateItemGroupData(),BFN.TransformItemGroup.updateContentDimensions(),BFN.TransformItemGroup.updateAccurateBounds(),BFN.TransformItemGroup.removeEventListener(BFN.TransformItemEvents.GET_SNAP_COORDINATES.type,this.handleGetSnapCoordinatesBind),BFN.TransformItemGroup.addEventListener(BFN.TransformItemEvents.GET_SNAP_COORDINATES.type,this.handleGetSnapCoordinatesBind),BFN.TransformItemGroup.remainingItem=null,BFN.TransformItemGroup.selectedByMouse=!1,this.selectItem(BFN.TransformItemGroup),this.transformTool.updateDisplay(),BFN.TransformModel.selectedGroupType!=BFN.TransformItemGroup.groupType&&(BFN.TransformModel.selectedTransformItem=BFN.TransformItemGroup),BFN.TransformModel.updateGroupMenu(),BFN.TransformItemGroup.groupType=="text"&&BFN.FabricManager.updateTextMenu(BFN.TransformItemGroup.getTextGroupStyleData()),BFN.TransformItemGroup.off("pointerdown",this.handleTransformItemGroupPressedBind),BFN.TransformItemGroup.on("pointerdown",this.handleTransformItemGroupPressedBind),BFN.TransformItemGroup.removeEventListener(BFN.TransformItemEvents.PRESS_ITEM.type,this.handleTransformItemGroupPressedBind),BFN.TransformItemGroup.addEventListener(BFN.TransformItemEvents.PRESS_ITEM.type,this.handleTransformItemGroupPressedBind),BFN.SentryManager.reportBreadcrumb(BFN.TransformItemGroup.groupInfo,"item_selection_updated","selection_interaction")),BFN.TransformItemGroup.lastSelectionCount=BFN.TransformItemGroup.selectedItems.length,this.textTransformItem=null};Me.prototype.resetTransformItemGroup=function(){this.groupedTransformItems.splice(0),BFN.TransformItemGroup.off("pointerdown",this.handleTransformItemGroupPressedBind),BFN.TransformItemGroup.removeEventListener(BFN.TransformItemEvents.PRESS_ITEM.type,this.handleTransformItemGroupPressedBind),BFN.TransformItemGroup.clearItems(),this.selectedItem==BFN.TransformItemGroup&&this.deselectItem(),this.children.includes(BFN.TransformItemGroup)&&(BFN.TransformItemGroup.removeEventListener(BFN.TransformItemEvents.GET_SNAP_COORDINATES.type,this.handleGetSnapCoordinatesBind),BFN.TransformItemGroup.transformLayer=null,this.removeChild(BFN.TransformItemGroup)),BFN.TransformItemGroup.lastSelectionCount>0&&(BFN.TransformItemGroup.lastSelectionCount=0,BFN.SentryManager.reportBreadcrumb("Reset / Empty","item_selection_updated","selection_interaction"))};Me.prototype.handleGroupMouseMove=function(i){this.updateGroupSelection()};Me.prototype.handleGroupMouseUp=function(i){this.groupActivePointerID!==null&&(this.groupActivePointerID===i.pointerId||i.data&&i.data.ignorePointerID)&&this.stopGroupSelection()};Me.prototype.handleTransformItemGroupPressed=function(i,e=!1){if(BFN.GestureManager.multiplePointersActive)return;BFN.ZoomRegion.hide();let{originalEvent:t}=i.data;if(t.button===2||BFN.TransformItemGroup.longPressOccurred){let a,s;a=()=>{let o=BFN.GroupManager.getCommonGroupVOsFromItemIDs(BFN.TransformLayerManager.selectedItemIDs),n=BFN.GroupManager.getSectionGroupVOs(),l=n.length;for(;--l>-1;){let c=n[l];o.includes(c)&&n.splice(l,1)}if(n.length){BFN.TransformItemGroup.contextMenu.showButton("add_to_group");let c={};n.forEach(h=>{c[h.name]={onClick:()=>{BFN.GroupManager.addItemsToGroup(h.id,BFN.TransformLayerManager.selectedItemIDs),a(),s()},translate:!1}}),BFN.TransformItemGroup.contextMenu.updateChildren("add_to_group",c)}else BFN.TransformItemGroup.contextMenu.hideButton("add_to_group")},s=()=>{let o=BFN.GroupManager.getGroupVOsFromItemIDs(BFN.TransformLayerManager.selectedItemIDs);if(o.length){BFN.TransformItemGroup.contextMenu.showButton("remove_from_group");let n={};o.forEach(l=>{n[l.name]={onClick:()=>{BFN.GroupManager.removeItemsFromGroup(l.id,BFN.TransformLayerManager.selectedItemIDs),a(),s()},translate:!1}}),BFN.TransformItemGroup.contextMenu.updateChildren("remove_from_group",n)}else BFN.TransformItemGroup.contextMenu.hideButton("remove_from_group")},a(),s(),BFN.TransformItemGroup.subSelectedItem=null,BFN.TransformItemGroup.contextMenu.show(t.clientX,t.clientY),BFN.TransformItemGroup.selectedByMouse=!1,this.selectItem(BFN.TransformItemGroup),i.stopPropagation();return}if(this.selectedItem===BFN.TransformItemGroup&&!e&&BFN.MainUI.pointerEvent){let a=BFN.MainUI.getPointerPosition(BFN.MainUI.pointerEvent),s=null;for(let o=0;o<BFN.TransformItemGroup.selectedItems.length;o++){let n=BFN.TransformItemGroup.selectedItems[o],l=n.globalPolygon;n.parent&&BFN.Util.polygonHitTest([a],l)&&(!s||s&&n.parent.children.indexOf(n)>s.parent.children.indexOf(s))&&(s=n)}BFN.TransformItemGroup.subSelectedItem=s}BFN.TransformItemGroup.selectedByMouse=!0,i.externalPress&&(BFN.TransformItemGroup.selectedByMouse=!1),this.selectItem(BFN.TransformItemGroup),i.stopPropagation()};Me.prototype.handleItemMouseOver=function(i){let e=i.currentTarget;setTimeout(()=>{!BFN.TransformModel.awaitingDrop||e.type==="text"&&BFN.FabricManager.isDefaultText(e.iText.text)||e.lockedOrHidden||(BFN.TransformModel.focusedTransformItem=e)},0)};Me.prototype.handleItemMouseOut=function(i){BFN.TransformModel.focusedTransformItem=null};Me.prototype.handleItemPressed=function(i){if(BFN.GestureManager.multiplePointersActive)return;let e=i.target||i.targetItem,{originalEvent:t}=i.data;if(i.externalPress&&(this.textTransformItem=null),this.pressedTransformItem=e||this.pressedTransformItem,!this.pressedTransformItem){BeFunky.throwError("Pressed TransformItem Invalid (Touch Behavior Likely)");return}if(BeFunky.isMobile&&this.pressedTransformItem!==this.selectedItem&&!this.allowZoomedPress&&!i.externalPress){let h=this.pressedTransformItem,u=(p=!1)=>{this.allowZoomedPress=!0,this.handleItemPressedBind(i),delete this.allowZoomedPress,BeFunky.dispatchPointerEvent("pointerup",document,i.pointerType,i.data.global.x,i.data.global.y),p&&BFN.ZoomManager.centerItem(h)},d=()=>{this.canvas.canvasDragger.removeEventListener(BFN.DraggerEvents.DRAGGING_COMPLETE.type,d),BFN.ZoomManager.isZoomedIn&&!this.canvas.canvasDragger.wasDragged&&!BFN.GestureManager.multiplePointersActive&&u(!0)},m=p=>{document.removeEventListener(BeFunky.pointerup,m,!0),document.removeEventListener(BeFunky.pointercancel,m,!0),p.data&&p.data.longPressUp?this.canvas.canvasDragger.removeEventListener(BFN.DraggerEvents.DRAGGING_COMPLETE.type,d):!BFN.ZoomManager.isZoomedIn&&!BFN.TransformItemGroup.documentMouseMovedPastThreshold&&!BFN.GestureManager.multiplePointersActive&&u(!1)};this.textTransformItem=null,document.addEventListener(BeFunky.pointerup,m,!0),document.addEventListener(BeFunky.pointercancel,m,!0),this.canvas.canvasDragger.addEventListener(BFN.DraggerEvents.DRAGGING_COMPLETE.type,d),this.canvas.handleMoveTouchSurfacePressed(i);return}e=this.pressedTransformItem,delete this.pressedTransformItem,BFN.ZoomRegion.hide();let r=e.lockedOrHidden&&!i.externalPress;r&&this.textTransformItem&&(this.textTransformItem=null);let a=h=>{this.lastPressedItem=h,this.lastSelectedItem=h},s=()=>{i.stopPropagation()},o=t.button===2||e.longPressOccurred,n=t.ctrlKey||t.metaKey,l=t.altKey;if(n||l)return this.selectedItem===BFN.TransformItemGroup?(l||r?BFN.TransformItemGroup.removeGroupItem(e):BFN.TransformItemGroup.toggleGroupItem(e)&&a(e),this.transformTool.updateDisplay(),s()):this.selectedItem?(this.selectedItem===e?this.deselectItem():!l&&!r&&(this.children.includes(BFN.TransformItemGroup)||(BFN.TransformItemGroup.transformLayer=this,this.addChild(BFN.TransformItemGroup)),BFN.TransformItemGroup.canvasScale=this._scale,BFN.TransformItemGroup.addGroupItems([this.selectedItem,e]),a(e),this.updateTransformItemGroup()),s()):(r||(e.selectedByMouse=!1,this.selectItem(e),a(e)),s());if(r)return s();if(this.resetTransformItemGroup(),!o&&!n&&!l&&e!==this.selectedItem&&!i.externalPress){let h=[];this.children.forEach(m=>{m instanceof BFN.TransformItem&&m.projectItemVO&&!h.includes(m.projectItemVO.itemID)&&h.push(m.projectItemVO.itemID)});let u=BFN.GroupManager.getGroupVOsFromItemIDs([e.itemID]),d=[];if(u.forEach(m=>{m.itemIDs.forEach(p=>{!d.includes(p)&&h.includes(p)&&d.push(p)})}),d.length>1){BFN.GroupManager.selectGroups(u.map(m=>m.id),!0),this.handleTransformItemGroupPressed(i,!0);return}}if(o){let h,u,d;return h=()=>{let m=BFN.GroupManager.getGroupVOsFromItemIDs([e.itemID]);if(m.length){BFN.TransformModel.contextMenu.showButton("select_group");let p={};m.forEach(g=>{p[g.name]={onClick:f=>{let v=!!(f.metaKey||f.ctrlKey);BFN.GroupManager.selectGroups([g.id],!1,v)},translate:!1}}),BFN.TransformModel.contextMenu.updateChildren("select_group",p)}else BFN.TransformModel.contextMenu.hideButton("select_group")},u=()=>{let m=BFN.GroupManager.getGroupVOsFromItemIDs([e.itemID]),p=BFN.GroupManager.getSectionGroupVOs(),g=p.length;for(;--g>-1;){let f=p[g];m.includes(f)&&p.splice(g,1)}if(p.length){BFN.TransformModel.contextMenu.showButton("add_to_group");let f={};p.forEach(v=>{f[v.name]={onClick:()=>{BFN.GroupManager.addItemsToGroup(v.id,[e.itemID]),h(),u(),d()},translate:!1}}),BFN.TransformModel.contextMenu.updateChildren("add_to_group",f)}else BFN.TransformModel.contextMenu.hideButton("add_to_group")},d=()=>{let m=BFN.GroupManager.getGroupVOsFromItemIDs([e.itemID]);if(m.length){BFN.TransformModel.contextMenu.showButton("remove_from_group");let p={};m.forEach(g=>{p[g.name]={onClick:()=>{BFN.GroupManager.removeItemsFromGroup(g.id,[e.itemID]),h(),u(),d()},translate:!1}}),BFN.TransformModel.contextMenu.updateChildren("remove_from_group",p)}else BFN.TransformModel.contextMenu.hideButton("remove_from_group")},h(),u(),d(),BFN.TransformModel.contextMenu.toggleButton("canvas",e.type==="frame_texture"),BFN.TransformModel.contextMenu.show(t.clientX,t.clientY),e.selectedByMouse=!1,this.selectItem(e),a(e),s()}if(e.type==="frame_texture"&&t.shiftKey){e.dragFrame(i);return}e.selectedByMouse=!0;let c=!1;e===this.selectedItem&&(c=!0),i.externalPress&&(e.selectedByMouse=!1),this.selectItem(e),a(e),e.itemMoved=!1,e.type==="text"&&c?this.textTransformItem=e:this.textTransformItem=null,s()};Me.prototype.handleItemReleased=function(i){if(!BFN.GestureManager.multiplePointersActive&&this.textTransformItem&&this.textTransformItem.type=="text"&&!this.textTransformItem.itemMoved&&!this.textTransformItem.preventEditText&&![BFN.TransformModel.focusedTransformItem,BFN.TransformModel.targetTransformItem].includes(this.textTransformItem)){let e=this.textTransformItem?this.textTransformItem:null;this.deselectItem(),e&&(BFN.FabricManager.editText(e,i.data.global.x,i.data.global.y),BFN.TransformModel.selectedTransformItemText=e)}};Me.prototype.handleItemDisplayUpdated=function(i){let e=i.dispatcher;e.align&&this.alignItem(e),this.dispatchEvent(BFN.TransformLayerEvents.ITEM_DISPLAY_UPDATED)};Me.prototype.handleGetSnapCoordinates=function(i){let e=i.dispatcher;if(e.snapCoordinates.splice(0),!BFN.TransformModel.snappingEnabled)return;let t=new BFN.Rectangle(-(this.frameWidth/2),-(this.frameHeight/2),this.frameWidth,this.frameHeight);e.snapCoordinates.push({id:"canvas",bounds:t,position:"horizontal",value:t.left}),e.snapCoordinates.push({id:"canvas",bounds:t,position:"horizontal",value:t.center}),e.snapCoordinates.push({id:"canvas",bounds:t,position:"horizontal",value:t.right}),e.snapCoordinates.push({id:"canvas",bounds:t,position:"vertical",value:t.top}),e.snapCoordinates.push({id:"canvas",bounds:t,position:"vertical",value:t.middle}),e.snapCoordinates.push({id:"canvas",bounds:t,position:"vertical",value:t.bottom}),BFN.TransformGuides&&BFN.TransformGuides.visible&&BFN.TransformGuides.transformGuideData&&BFN.TransformGuides.transformGuideData.length&&BFN.TransformGuides.transformGuideData.forEach(n=>{e.snapCoordinates.push({id:"guide",bounds:t,position:n.axis==="x"?"horizontal":"vertical",value:n.value})});let r=[],{children:a}=this,s=e.type=="group"?e.selectedItems:[];this.transformItems.forEach(n=>{if(n&&e!=n&&a.includes(n)&&n.accurateBounds&&!s.includes(n)&&!n.hidden){let l=BFN.Util.getTransformItemBounds(n),c=new BFN.Rectangle(l.minX+n.accurateBounds.minX,l.minY+n.accurateBounds.minY,n.accurateBounds.width,n.accurateBounds.height);e.snapCoordinates.push({bounds:c,position:"horizontal",value:c.left}),e.snapCoordinates.push({bounds:c,position:"horizontal",value:c.center}),e.snapCoordinates.push({bounds:c,position:"horizontal",value:c.right}),e.snapCoordinates.push({bounds:c,position:"vertical",value:c.top}),e.snapCoordinates.push({bounds:c,position:"vertical",value:c.middle}),e.snapCoordinates.push({bounds:c,position:"vertical",value:c.bottom}),r.push(c)}}),e.otherItemAccurateBoundsList.splice(0),e.otherItemAccurateBoundsList.push(...r);let o=e.snapGapRects={};for(let n=0;n<r.length;n++){let l=r[n];for(let c=0;c<r.length;c++){let h=r[c];if(h!=l){let u=h.neighbors(l);if(u&&["right","bottom"].includes(u.side)){let d=!0,m=r.length;for(;--m>-1&&d;){let p=r[m];if(![l,h].includes(p)&&p.intersects(u.intersectRect,1)&&!p.containsRect(u.intersectRect))switch(u.direction){case"horizontal":d=p.left<u.intersectRect.left&&p.right>u.intersectRect.right;break;case"vertical":d=p.top<u.intersectRect.top&&p.bottom>u.intersectRect.bottom;break}}if(d){let p=(Math.round(u.distance*10)/10).toFixed(1);o.hasOwnProperty(u.direction)||(o[u.direction]={}),o[u.direction].hasOwnProperty(p)||(o[u.direction][p]=[]),o[u.direction][p].push(u.gapRect)}}}}}for(let n in o)for(let l in o[n]){let c=o[n][l],h=c.length;for(;--h>-1;){let u=c[h],d=h;for(;--d>-1;){let m=c[d];if(u.intersects(m))switch(n){case"horizontal":Math.abs(u.left-m.left)<1&&Math.abs(u.right-m.right)<1&&(m.top=Math.min(m.top,u.top),m.bottom=Math.max(m.bottom,u.bottom),c.splice(h,1));break;case"vertical":Math.abs(u.top-m.top)<1&&Math.abs(u.bottom-m.bottom)<1&&(m.left=Math.min(m.left,u.left),m.right=Math.max(m.right,u.right),c.splice(h,1));break}}}}};Me.prototype.handleSelectItem=function(i){let e=i.dispatcher;e.selectedByMouse=!1,this.selectItem(e)};Me.prototype.handleDeselectItem=function(i){this.deselectItem()};Me.prototype.handleRemoveItem=function(i){this.removeItem(i.dispatcher)};Me.prototype.handleDestroyItem=function(i){this.destroyItem(i.dispatcher)};Me.prototype.handleDuplicateItem=function(i){this.duplicatingItem=!0;let e=i.dispatcher,t={isDuplicate:!0,sourceTransformItem:e,projectItemVO:e.projectItemVO};for(let n in e.itemObject)t.hasOwnProperty(n)||(t[n]=e.itemObject[n]);if(t.hasOwnProperty("projectItemVO")){let n=new BFN.ProjectItemVO;Object.assign(n,t.projectItemVO),e.type=="text"&&(n.labelTextStyles=JSON.parse(JSON.stringify(t.projectItemVO.labelTextStyles))),e.thumbImage&&e.thumbImage.src&&(n.thumbImageSRC=e.thumbImage.src),t.projectItemVO=n}t.hasOwnProperty("basicShapeVO")&&(t.basicShapeVO=t.basicShapeVO.clone(),t.hasOwnProperty("maskTexture")&&(t.maskTexture=PIXI.RenderTexture.create(32,32))),e.thumbImage&&e.thumbImage.src&&(t.thumbImage=new Image,t.thumbImage.src=e.thumbImage.src),e.accurateBounds&&(t.accurateBounds=Object.assign({},e.accurateBounds)),BFN.TransformModel.selectItemOnAdd=!1;let r=this.addItem(t);BFN.TransformModel.selectItemOnAdd=!0;let a=r.getTransition();t.thumbImage&&(r.thumbImage=t.thumbImage,delete t.thumbImage);let s=new BFN.TransformItemStateVO;e.updateStateVO(s),s.x+=10,s.y+=10,s.zIndex+=1,s.imageTexture=null,e.accurateBounds&&(s.accurateBounds=Object.assign({},e.accurateBounds)),r.ignoreAccurateBounds=!1;let o=()=>{r.removeEventListener(BFN.TransformItemEvents.TEXT_DISPLAY_UPDATED.type,o),r.updateStateVO(a.endState),r.updateProjectItemVO(),r.ignoreAccurateBounds=!1,BFN.TransformItemGroup.duplicatingGroup||r.selectItem(),BFN.TransformLayerEvents.ITEM_DUPLICATED.duplicatedItem=r,this.dispatchEvent(BFN.TransformLayerEvents.ITEM_DUPLICATED),delete BFN.TransformLayerEvents.ITEM_DUPLICATED.duplicatedItem,delete this.duplicatingItem};r.type=="text"?(r.addEventListener(BFN.TransformItemEvents.TEXT_DISPLAY_UPDATED.type,o),BFN.MainUI.renderCanvas(),r.applyTransformItemState(s),BFN.MainUI.renderCanvas()):(r.applyTransformItemState(s),o())};Me.prototype.handleRegisterTransition=function(i){BFN.TransformStateModel.addTransition(i.dispatcher.getTransition()),this.model.updateProjectVO()};Me.prototype.handleTransitionApplied=function(i){this.children.includes(i.dispatcher)&&this.dispatchEvent(BFN.TransformLayerEvents.ITEM_DISPLAY_UPDATED),this.duplicatingItem||this.deselectItem(),BFN.ProjectManager.transformItemsPending||this.dispatchEvent(BFN.TransformLayerEvents.ITEMS_UPDATED)};Me.prototype.handleKeyDown=function(i){if(this.debounceHideMeasurements||(this.debounceHideMeasurements=BeFunky.debounce(()=>{this.debouncingHideMeasurements&&(this.debouncingHideMeasurements=!1,this.transformTool.item&&!this.altPressed&&this.transformTool.fadeAnimator.increase())},500)),!BeFunky.isModalOpen()&&!BeFunky.isLoadScreenActive()&&!(BFN.TransformModel.transformToolFrame&&BFN.TransformModel.transformToolFrame.active&&i.keyCode!=27)&&this.appViewState==BFN.AppModel.viewState&&this.selectedItem&&!this.selectedItem.transforming&&!BFN.FabricManager.styleUpdating&&!BFN.FabricManager.styleChangeRequested&&!BFN.isSortableListDragActive&&!BeFunky.isTextBoxFocused()){let e=r=>{if(this.selectedItem.lockedOrHidden)return;let a=this.selectedItem.type=="group";this.selectedItem.createTransition(a?"history_nudge_selection":"history_nudge"),r(),this.transformTool.showItemMeasurements(),this.transformTool.fadeAnimator.decrease(),this.debouncingHideMeasurements=!0,this.debounceHideMeasurements(),a&&this.selectedItem.updateGroupTransform(),this.selectedItem.registerTransition(!0,!1),this.dispatchEvent(BFN.TransformLayerEvents.ITEM_DISPLAY_UPDATED),i.preventDefault()},t=r=>{r+=` : ${BFN.SentryManager.getDisplayObjectInfo(this.selectedItem)}`,BFN.SentryManager.reportBreadcrumb(`Key: "${i.key}" (${i.keyCode})${BFN.SentryManager.getSpecialKeyString(i)}${r?" -> "+r:""}`,"key_down","keyboard_layer")};switch(i.keyCode){case 18:if(this.selectedItem.lockedOrHidden)return;!this.altPressed&&BFN.TransformModel.showMeasurements&&(this.altPressed=!0,window.addEventListener("keyup",this.handleAltKeyUpBind),window.addEventListener("blur",this.handleAltKeyUpBind),this.transformTool.showItemMeasurements(),this.transformTool.fadeAnimator.decrease());break;case 37:e(()=>{this.selectedItem.x-=this.nudgeDistance/this._scale});break;case 38:e(()=>{this.selectedItem.y-=this.nudgeDistance/this._scale});break;case 39:e(()=>{this.selectedItem.x+=this.nudgeDistance/this._scale});break;case 40:e(()=>{this.selectedItem.y+=this.nudgeDistance/this._scale});break;case 8:case 46:t("removeItem/Group"),BFN.TransformModel.removeSelection(),i.preventDefault();break;case 68:this.dPressed||(t("duplicateItem/Group"),this.dPressed=!0,setTimeout(()=>{this.dPressed=!1},200),this.selectedItem.type=="group"&&!this.selectedItem.duplicatingGroup?this.selectedItem.duplicateGroup():this.selectedItem.duplicateItem()),(i.metaKey||i.ctrlKey)&&i.preventDefault();break;case 27:t("deselectItem"),this.deselectItem();break}}};Me.prototype.handleAltKeyUp=function(i,e=!1){(e||i.keyCode===18)&&(this.altPressed=!1,window.removeEventListener("keyup",this.handleAltKeyUpBind),window.removeEventListener("blur",this.handleAltKeyUpBind),this.transformTool.item&&!this.debouncingHideMeasurements&&this.transformTool.fadeAnimator.increase())};Object.defineProperty(Me.prototype,"itemsExist",{get(){for(let i=0;i<this.transformItems.length;i++)if(this.children.includes(this.transformItems[i]))return!0;return!1}});Object.defineProperty(Me.prototype,"canvasScale",{set(i){this._scale=i,this.children.includes(BFN.TransformItemGroup)&&(BFN.TransformItemGroup.canvasScale=i),(this.altPressed||this.debouncingHideMeasurements)&&(this.altPressed&&this.handleAltKeyUpBind(null,!0),this.transformTool.transformSnapGuides.hideLines())},get(){return this._scale}});Object.defineProperty(Me.prototype,"layerBounds",{get(){let i=null;return this.transformItems.forEach(e=>{this.children.includes(e)&&e.visible&&e.renderable&&(e.type==="text"?e.localTextPolygon:e.localPolygon).forEach(r=>{i?(i.left=Math.min(i.left,r.x),i.right=Math.max(i.right,r.x),i.top=Math.min(i.top,r.y),i.bottom=Math.max(i.bottom,r.y)):i=new BFN.Rectangle(r.x,r.y)})}),i}});BFN.TransformLayer=Me;function Yt(){PIXI.Container.call(this),this.init()}Yt.prototype=Object.create(PIXI.Container.prototype);Yt.prototype.init=function(){BeFunky.log("TransformToolSnapGuides Init"),this.initDefaultValues(),this.initStrokeLines(),this.initGraphics(),this.initRulerLabels(),this.hideLines()};Yt.prototype.initDefaultValues=function(){this._centerX=0,this._centerY=0,this._width=100,this._height=100,this._scale=1,this.bgFillFilter=new BFN.filters.BackgroundFillFilter,this.bgFillFilter.resolution=BFN.Stage.resolution};Yt.prototype.initStrokeLines=function(){this.strokeLinesH=["top","middle","bottom"],this.strokeLinesV=["left","center","right"],this.strokeLineSides=[...this.strokeLinesH,...this.strokeLinesV],this.strokeLines={},this.strokeLineSides.forEach(i=>{this.strokeLines[i]=this.createStrokeLine(i)})};Yt.prototype.initGraphics=function(){this.graphics=new PIXI.Graphics,this.addChild(this.graphics)};Yt.prototype.initRulerLabels=function(){this.allRulerLabels=[],this.availableRulerLabels=[],this.usedRulerLabels=[],this.rulerLabelData=[],this.rulerLabelContainer=new PIXI.Container,this.addChild(this.rulerLabelContainer)};Yt.prototype.setCenter=function(i,e){this._centerX=i,this._centerY=e,this.updateDisplay()};Yt.prototype.setDimensions=function(i,e){this._width=Math.abs(i),this._height=Math.abs(e),this.updateDisplay()};Yt.prototype.updateDisplay=function(){this.strokeLines.top.y=this._centerY-this._height/2,this.strokeLines.middle.y=this._centerY,this.strokeLines.bottom.y=this._centerY+this._height/2,this.strokeLines.left.x=this._centerX-this._width/2,this.strokeLines.center.x=this._centerX,this.strokeLines.right.x=this._centerX+this._width/2,BFN.MainUI&&BFN.MainUI.requestRender()};Yt.prototype.showLine=function(i,e=null,t=null,r=null){if(!this.strokeLines.hasOwnProperty(i))return;if(this.mainUIItemBounds=null,r){let n=BFN.MainUI.toLocal(new PIXI.Point(r.x,r.y)),l=BFN.MainUI.toLocal(new PIXI.Point(r.x+r.width,r.y+r.height));this.mainUIItemBounds=new BFN.Rectangle(n.x,n.y,l.x-n.x,l.y-n.y)}let a=[];e&&e.forEach(n=>{if(n&&n.startPoint&&n.endPoint){let l=this.strokeLines[i],c={};this.strokeLinesH.includes(i)?(c.start=Math.round(l.toLocal(n.startPoint).x*this._scale),c.end=Math.round(l.toLocal(n.endPoint).x*this._scale)):this.strokeLinesV.includes(i)&&(c.start=Math.round(l.toLocal(n.startPoint).x*this._scale),c.end=Math.round(l.toLocal(n.endPoint).x*this._scale)),a.push(c)}});let s=[];t&&t.forEach(n=>{if(n&&n.startPoint&&n.endPoint){let l=this.strokeLines[i],c={};this.strokeLinesH.includes(i)?(c.start=l.toLocal(n.startPoint).x*this._scale,c.end=l.toLocal(n.endPoint).x*this._scale,n.endPoint.x-n.startPoint.x>0&&this.rulerLabelData.push({line:i,value:(Math.round((n.endPoint.x-n.startPoint.x)/this._scale*10)/10).toFixed(1).toString(),x:(n.startPoint.x+n.endPoint.x)/2})):this.strokeLinesV.includes(i)&&(c.start=l.toLocal(n.startPoint).x*this._scale,c.end=l.toLocal(n.endPoint).x*this._scale,c.end-c.start>0&&this.rulerLabelData.push({line:i,value:(Math.round((n.endPoint.y-n.startPoint.y)/this._scale*10)/10).toFixed(1).toString(),y:(n.startPoint.y+n.endPoint.y)/2})),s.push(c)}});let o=this.strokeLines[i];o.showMaskedLines(a),o.showRulers(s),o.visible=!0,BFN.MainUI&&BFN.MainUI.requestRender()};Yt.prototype.hideLines=function(){this.strokeLineSides.forEach(i=>{this.strokeLines[i].visible=!1}),this.graphics.clear(),this.hideRulerLabels(),BFN.MainUI&&BFN.MainUI.requestRender()};Yt.prototype.showRulerLabel=function(i="0",e=0,t=0,r=null){let a=null;this.availableRulerLabels.length?(a=this.availableRulerLabels.shift(),a.text=i,a.visible=!0):(a=new PIXI.Text(i,{fontFamily:"Times New Roman",fontSize:13,fill:16777215,align:"center",padding:3}),a.filters=[this.bgFillFilter],a.texture.setScaleMode(PIXI.SCALE_MODES.NEAREST),this.allRulerLabels.push(a),this.rulerLabelContainer.addChild(a));let s=0;switch(a.x=e,a.y=t,a.anchor.x=a.anchor.y=.5,r){case"vertical":if(this.mainUIItemBounds){let o=BFN.MainUI.toLocal(new PIXI.Point(a.x,a.y),this.rulerLabelContainer);o.y<=this.mainUIItemBounds.middle?(o.y=Math.max(a.texture.height*a.scale.y/2+s,o.y),o.y=Math.min(this.mainUIItemBounds.top-a.texture.height*a.scale.y/2-s,o.y)):o.y>=this.mainUIItemBounds.middle&&(o.y=Math.min(BFN.StageModel.stageH-a.texture.height*a.scale.y/2-s,o.y),o.y=Math.max(this.mainUIItemBounds.bottom+a.texture.height*a.scale.y/2+s,o.y));let n=this.rulerLabelContainer.toLocal(o,BFN.MainUI);a.y=n.y}break;case"horizontal":if(this.mainUIItemBounds){let o=BFN.MainUI.toLocal(new PIXI.Point(a.x,a.y),this.rulerLabelContainer);o.x<=this.mainUIItemBounds.center?(o.x=Math.max(a.texture.width*a.scale.x/2+s,o.x),o.x=Math.min(this.mainUIItemBounds.left-a.texture.width*a.scale.x/2-s,o.x)):o.x>=this.mainUIItemBounds.center&&(o.x=Math.min(BFN.StageModel.stageW-a.texture.width*a.scale.x/2-s,o.x),o.x=Math.max(this.mainUIItemBounds.right+a.texture.width*a.scale.x/2+s,o.x));let n=this.rulerLabelContainer.toLocal(o,BFN.MainUI);a.x=n.x}break}this.usedRulerLabels.push(a)};Yt.prototype.showRulerLabels=function(){this.rulerLabelData.forEach(i=>{let e=this.strokeLines[i.line];i.hasOwnProperty("x")||(i.x=this.rulerLabelContainer.toLocal(new PIXI.Point(e.x,0),this).x,i.y=this.rulerLabelContainer.toLocal(new PIXI.Point(0,i.y)).y,i.lineDirection="vertical"),i.hasOwnProperty("y")||(i.x=this.rulerLabelContainer.toLocal(new PIXI.Point(i.x)).x,i.y=this.rulerLabelContainer.toLocal(new PIXI.Point(0,e.y),this).y,i.lineDirection="horizontal"),this.showRulerLabel(i.value,i.x,i.y,i.lineDirection)})};Yt.prototype.hideRulerLabels=function(){this.availableRulerLabels.splice(0),this.availableRulerLabels.push(...this.allRulerLabels),this.usedRulerLabels.forEach(i=>{i.visible=!1}),this.usedRulerLabels.splice(0),this.rulerLabelData.splice(0)};Yt.prototype.createStrokeLine=function(i){if(!this.strokeLineSides.includes(i))return;let e=BFN.maxImageSize*4,t=new BFN.StrokeLine(!1,!0,1,!1,4280344831,4278190080,"transform_tool_snap_guide");return this.strokeLinesH.includes(i)&&(t.x=-(e/2)),this.strokeLinesV.includes(i)&&(t.y=-(e/2)),t.length=e,t.rotation=this.strokeLinesV.includes(i)?Math.PI/2:0,t.convertToMasked(),t.convertToRuler(),this.addChild(t),t};Object.defineProperty(Yt.prototype,"scale",{set:function(i){this._scale=i,this.strokeLineSides.forEach(e=>{this.strokeLines[e].scale=this._scale}),this.graphics.scale.x=this.graphics.scale.y=1/this._scale,this.rulerLabelContainer.scale.x=this.rulerLabelContainer.scale.y=1/this._scale,BFN.MainUI.requestRender()},get:function(){return this._scale}});BFN.TransformToolSnapGuides=Yt;function ye(i){PIXI.Sprite.call(this),this.transformLayer=i,this.init()}ye.prototype=Object.create(PIXI.Sprite.prototype);ye.prototype.init=function(){BeFunky.log("TransformTool Init"),this.initDefaultValues(),this.initTransformSnapGuides(),this.initTransformTool(),this.initTransformToolGizmo(),this.initHandleTextures(),this.initTextHandles(),this.initScaleHandles(),this.initRotationHandle(),this.initDraggers(),this.initFadeAnimator(),this.initTransformToolFrame()};ye.prototype.initDefaultValues=function(){this.PIx2=Math.PI*2,this.PId2=Math.PI/2,this.rotationHandleOffset=25,this.snapSections=24,this.snapDistance=2,this.snapSectionBeta=this.PIx2/this.snapSections,this.screenPixelSnapThreshold=6,this.itemWidth=0,this.itemHeight=0,this._scale=1,this.frameWidth=0,this.frameHeight=0,this.minSize=1,this.minSizeText=10,this.minSizeFrame=10,this.currentTextHandle=null,this.currentScaleHandle=null,this.textAnchor=new PIXI.Point,this.textControl=new PIXI.Point,this.scaleAnchor=new PIXI.Point,this.scaleControl=new PIXI.Point,this.deltaPoint=new PIXI.Point,this.anchorCenter=!1,this.hBeta=0,this.snapDistanceTransform=0,this.snapGuidesCleared=!0,this.otherItemAccurateBounds=[],this.gizmoPadding=10,this.gizmoPaddingDiagonal=Math.sqrt(Math.pow(this.gizmoPadding,2)*2),this.itemZIndex=0,this.iTextData=null,this.itemData=null,this.drawSnapHelpers=!1,this.transformHandles=[],this.handleItemAccurateBoundsUpdatedBind=this.handleItemAccurateBoundsUpdated.bind(this)};ye.prototype.initTransformSnapGuides=function(){this.transformSnapGuidesContainer=new PIXI.Container,this.addChild(this.transformSnapGuidesContainer)};ye.prototype.initTransformTool=function(){this.transformTool=new PIXI.Container,this.transformTool.interactive=!0,this.addChild(this.transformTool)};ye.prototype.initTransformToolGizmo=function(){this.transformGizmo=new PIXI.Container,this.transformGizmo.interactive=!1,this.transformGizmo.interactiveChildren=!1,this.transformTool.addChild(this.transformGizmo),this.transformGizmoOutline=new BFN.StrokeRectangle(!0,!0,2,!0,4293783021,4287274495,"dashed_transform_line"),this.transformGizmoOutline.setDimensions(this.itemWidth,this.itemHeight),this.transformGizmo.addChild(this.transformGizmoOutline),this.transformGizmoHandle=new BFN.StrokeLine(!0,!0,2,!0,4293783021,4287274495,"dashed_transform_line"),this.transformGizmoHandle.rotation=-this.PId2,this.transformGizmo.addChild(this.transformGizmoHandle)};ye.prototype.initHandleTextures=function(){this.handleTextureSquare=PIXI.RenderTexture.create(20,20,PIXI.settings.SCALE_MODE,window.bfn_resolution),BFN.graphics.drawShape("roundedRect",this.handleTextureSquare,{fillColor:268435456,cornerRadius:4,paddingY:5}),BFN.graphics.drawShape("roundedRect",this.handleTextureSquare,{strokeWidth:1,strokeColor:4287274495,fillColor:4294967295,cornerRadius:1,paddingX:1,paddingY:6,clear:!1}),this.handleTextureCircle=PIXI.RenderTexture.create(24,24,PIXI.settings.SCALE_MODE,window.bfn_resolution),BFN.graphics.drawShape("ellipse",this.handleTextureCircle,{strokeWidth:1.5,strokeColor:4287274495,fillColor:4294967295,paddingX:4,paddingY:4,clear:!1})};ye.prototype.initTextHandles=function(){this.textHandles={},this.textHandleIDs=["l","r"];for(let i=0;i<this.textHandleIDs.length;i++){let e=this.textHandleIDs[i],t=new BFN.HoverButton;t.buttonMode=!1,t.id=e,t.texture=this.handleTextureSquare,t.on("pointerover",this.handleTextHandleOver.bind(this)),t.on("pointerout",this.handleTextHandleOut.bind(this)),t.handlePress=this.handleTextHandlePress.bind(this),t.hoverButtonGroup=this.transformHandles,this.textHandles[e]=t,this.transformTool.addChild(t),this.transformHandles.push(t),!!BeFunky.isMobile&&t.setHitAreaCircle(22)}};ye.prototype.initScaleHandles=function(){this.scaleHandles={},this.scaleHandleIDs=["l","tl","t","tr","r","br","b","bl"],this.sideHandleIDs=["l","t","r","b"];for(let i=0;i<this.scaleHandleIDs.length;i++){let e=this.scaleHandleIDs[i],t=new BFN.HoverButton;t.buttonMode=!1,t.id=e,t.texture=i%2?this.handleTextureCircle:this.handleTextureSquare,t.on("pointerover",this.handleScaleHandleOver.bind(this)),t.on("pointerout",this.handleScaleHandleOut.bind(this)),t.handlePress=this.handleScaleHandlePress.bind(this),t.hoverButtonGroup=this.transformHandles,this.scaleHandles[e]=t,this.transformTool.addChild(t),this.transformHandles.push(t),!!BeFunky.isMobile&&t.setHitAreaCircle(22)}};ye.prototype.initRotationHandle=function(){this.rotationHandle=new BFN.HoverButton,this.rotationHandle.id="rt",this.rotationHandle.buttonMode=!1,this.rotationHandle.texture=this.handleTextureCircle,this.rotationHandle.on("pointerover",this.handleRotationHandleOver.bind(this)),this.rotationHandle.on("pointerout",this.handleRotationHandleOut.bind(this)),this.rotationHandle.handlePress=this.handleRotationHandlePress.bind(this),this.rotationHandle.hoverButtonGroup=this.transformHandles,this.rotationHandle.selectAnimator.addEventListener(BFN.AnimatorEvents.UPDATE.type,this.handleRotationHandleSelectAnimatorUpdate.bind(this)),this.transformTool.addChild(this.rotationHandle),this.transformHandles.push(this.rotationHandle),!!BeFunky.isMobile&&this.rotationHandle.setHitAreaCircle(22)};ye.prototype.initDraggers=function(){this.toolDraggers=[],this.gizmoDragger=new BFN.Dragger,this.gizmoDragger.useBounds=!0,this.gizmoDragger.stickyDrag=!1,this.gizmoDragger.pixelDragThreshold=5,this.gizmoDragger.preventSelectionDrag=!0,this.gizmoDragger.deselectItemGroup=!1,this.gizmoDragger.preRenderDragOnly=!0,this.gizmoDragger.addEventListener(BFN.DraggerEvents.DRAGGING_STARTED.type,this.handleTransformGizmoDraggingStarted.bind(this)),this.gizmoDragger.addEventListener(BFN.DraggerEvents.DRAGGING.type,this.handleTransformGizmoDragging.bind(this)),this.gizmoDragger.addEventListener(BFN.DraggerEvents.DRAGGING_COMPLETE.type,this.handleTransformGizmoDraggingComplete.bind(this)),this.toolDraggers.push(this.gizmoDragger),this.textHandleDragger=new BFN.Dragger,this.textHandleDragger.useBounds=!1,this.textHandleDragger.autoDrag=!1,this.textHandleDragger.preventSelectionDrag=!0,this.textHandleDragger.deselectItemGroup=!1,this.textHandleDragger.preRenderDragOnly=!0,this.textHandleDragger.addEventListener(BFN.DraggerEvents.DRAGGING_STARTED.type,this.handleTextHandleDraggingStarted.bind(this)),this.textHandleDragger.addEventListener(BFN.DraggerEvents.DRAGGING.type,this.handleTextHandleDragging.bind(this)),this.textHandleDragger.addEventListener(BFN.DraggerEvents.DRAGGING_COMPLETE.type,this.handleTextHandleDraggingComplete.bind(this)),this.toolDraggers.push(this.textHandleDragger),this.scaleHandleDragger=new BFN.Dragger,this.scaleHandleDragger.useBounds=!1,this.scaleHandleDragger.autoDrag=!1,this.scaleHandleDragger.preventSelectionDrag=!0,this.scaleHandleDragger.deselectItemGroup=!1,this.scaleHandleDragger.preRenderDragOnly=!0,this.scaleHandleDragger.addEventListener(BFN.DraggerEvents.DRAGGING_STARTED.type,this.handleScaleHandleDraggingStarted.bind(this)),this.scaleHandleDragger.addEventListener(BFN.DraggerEvents.DRAGGING.type,this.handleScaleHandleDragging.bind(this)),this.scaleHandleDragger.addEventListener(BFN.DraggerEvents.DRAGGING_COMPLETE.type,this.handleScaleHandleDraggingComplete.bind(this)),this.toolDraggers.push(this.scaleHandleDragger),this.rotationHandleDragger=new BFN.Dragger,this.rotationHandleDragger.useBounds=!1,this.rotationHandleDragger.autoDrag=!1,this.rotationHandleDragger.preventSelectionDrag=!0,this.rotationHandleDragger.deselectItemGroup=!1,this.rotationHandleDragger.preRenderDragOnly=!0,this.rotationHandleDragger.addEventListener(BFN.DraggerEvents.DRAGGING_STARTED.type,this.handleRotationHandleDraggingStarted.bind(this)),this.rotationHandleDragger.addEventListener(BFN.DraggerEvents.DRAGGING.type,this.handleRotationHandleDragging.bind(this)),this.rotationHandleDragger.addEventListener(BFN.DraggerEvents.DRAGGING_COMPLETE.type,this.handleRotationHandleDraggingComplete.bind(this)),this.toolDraggers.push(this.rotationHandleDragger)};ye.prototype.initFadeAnimator=function(){this.fadeAnimator=new BFN.Animator,this.fadeAnimator.addEventListener(BFN.AnimatorEvents.UPDATE.type,this.handleFadeAnimatorUpdate.bind(this)),this.fadeAnimator.addEventListener(BFN.AnimatorEvents.INCREASE_COMPLETE.type,this.handleFadeAnimatorUpdateComplete.bind(this)),this.fadeAnimator.setAnimatorFactor(0)};ye.prototype.updateOtherItemAccurateBounds=function(){if(!this.item||!this.item.accurateBounds)return;let i=this.transformLayer.children,e=this.item.type=="group"?this.item.selectedItems:[];this.otherItemAccurateBounds.splice(0),this.transformLayer.transformItems.forEach(t=>{if(t&&this.item!=t&&i.includes(t)&&t.accurateBounds&&!e.includes(t)){let r=BFN.Util.getTransformItemBounds(t),a=new BFN.Rectangle(r.minX+t.accurateBounds.minX,r.minY+t.accurateBounds.minY,t.accurateBounds.width,t.accurateBounds.height);this.otherItemAccurateBounds.push(a)}})};ye.prototype.showItemMeasurements=function(i=!0){if(this.transformSnapGuides.hideLines(),!this.item||!this.item.accurateBounds||!BFN.TransformModel.showMeasurements)return;i&&this.updateOtherItemAccurateBounds();let e=BFN.Util.getTransformItemBounds(this.item),t=new BFN.Rectangle(e.minX+this.item.accurateBounds.minX,e.minY+this.item.accurateBounds.minY,this.item.accurateBounds.width,this.item.accurateBounds.height),r={},a=["left","center","right"],s=["top","middle","bottom"],o=[...a,...s];o.forEach(T=>{let x=r[T]={};x.rulerSegmentA={startPoint:new PIXI.Point,endPoint:new PIXI.Point},x.rulerSegmentB={startPoint:new PIXI.Point,endPoint:new PIXI.Point},a.includes(T)&&(x.axis="y",x.rulerSegmentA.side="top",x.rulerSegmentB.side="bottom",x.rulerSegmentA.startPoint.x=x.rulerSegmentA.endPoint.x=t[T],x.rulerSegmentB.startPoint.x=x.rulerSegmentB.endPoint.x=t[T],x.rulerSegmentA.startPoint.y=Math.min(t.top,-(this.frameHeight/2)),x.rulerSegmentA.endPoint.y=t.top,x.rulerSegmentB.startPoint.y=t.bottom,x.rulerSegmentB.endPoint.y=Math.max(t.bottom,this.frameHeight/2)),s.includes(T)&&(x.axis="x",x.rulerSegmentA.side="left",x.rulerSegmentB.side="right",x.rulerSegmentA.startPoint.y=x.rulerSegmentA.endPoint.y=t[T],x.rulerSegmentB.startPoint.y=x.rulerSegmentB.endPoint.y=t[T],x.rulerSegmentA.startPoint.x=Math.min(t.left,-(this.frameWidth/2)),x.rulerSegmentA.endPoint.x=t.left,x.rulerSegmentB.startPoint.x=t.right,x.rulerSegmentB.endPoint.x=Math.max(t.right,this.frameWidth/2))}),this.itemNeighbors||(this.itemNeighbors={left:[],top:[],right:[],bottom:[]});for(let T in this.itemNeighbors)this.itemNeighbors[T].splice(0);this.otherItemAccurateBounds.forEach(T=>{let x=t.neighbors(T);x&&this.itemNeighbors[x.side].push(x)});let n=(T,x,B)=>B>=T&&B<=x,l={};o.forEach(T=>{let x=r[T];this.itemNeighbors[x.rulerSegmentA.side].forEach(F=>{let b=F.intersectRect,S=!1;switch(x.rulerSegmentA.side){case"left":n(b.top,b.bottom,t[T])&&b.left>x.rulerSegmentA.startPoint.x&&(x.rulerSegmentA.startPoint.x=b.left,S=!0);break;case"top":n(b.left,b.right,t[T])&&b.top>x.rulerSegmentA.startPoint.y&&(x.rulerSegmentA.startPoint.y=b.top,S=!0);break}S&&(l[T]||(l[T]={}),l[T][x.rulerSegmentA.side]||(l[T][x.rulerSegmentA.side]=F.rect))}),this.itemNeighbors[x.rulerSegmentB.side].forEach(F=>{let b=F.intersectRect,S=!1;switch(x.rulerSegmentB.side){case"right":n(b.top,b.bottom,t[T])&&b.right<x.rulerSegmentB.endPoint.x&&(x.rulerSegmentB.endPoint.x=b.right,S=!0);break;case"bottom":n(b.left,b.right,t[T])&&b.bottom<x.rulerSegmentB.endPoint.y&&(x.rulerSegmentB.endPoint.y=b.bottom,S=!0);break}S&&(l[T]||(l[T]={}),l[T][x.rulerSegmentB.side]||(l[T][x.rulerSegmentB.side]=F.rect))})});let c={left:[],top:[],right:[],bottom:[]};o.forEach(T=>{let x=r[T];x.rulerSegmentA.startPoint=this.toGlobal(x.rulerSegmentA.startPoint),x.rulerSegmentA.endPoint=this.toGlobal(x.rulerSegmentA.endPoint),x.rulerSegmentB.startPoint=this.toGlobal(x.rulerSegmentB.startPoint),x.rulerSegmentB.endPoint=this.toGlobal(x.rulerSegmentB.endPoint);let B=Math.round(x.rulerSegmentA.endPoint[x.axis]-x.rulerSegmentA.startPoint[x.axis]),y=Math.round(x.rulerSegmentB.endPoint[x.axis]-x.rulerSegmentB.startPoint[x.axis]),F=c[x.rulerSegmentA.side],b=c[x.rulerSegmentB.side];F.push(B),b.push(y),F.length>1&&F[F.length-1]===F[F.length-2]&&(x.rulerSegmentA=null),b.length>1&&b[b.length-1]===b[b.length-2]&&(x.rulerSegmentB=null)});let h=this.transformLayer.toGlobal(new PIXI.Point(t.x,t.y)),u=this.transformLayer.toGlobal(new PIXI.Point(t.x+t.width,t.y+t.height)),d=new BFN.Rectangle(h.x,h.y,u.x-h.x,u.y-h.y);for(let T in r){let x=r[T];this.showSnapGuideLine(T,[x.rulerSegmentA,x.rulerSegmentB],[x.rulerSegmentA,x.rulerSegmentB],d)}this.snapGuidesCleared||this.transformSnapGuides.hideLines(),this.transformSnapGuides.setCenter(t.center,t.middle),this.transformSnapGuides.setDimensions(t.width,t.height),this.transformSnapGuides.showRulerLabels();let m=this.transformSnapGuides.graphics.toLocal(new PIXI.Point(h.x,h.y)),p=this.transformSnapGuides.graphics.toLocal(new PIXI.Point(u.x,u.y)),g=new BFN.Rectangle(m.x,m.y,p.x-m.x,p.y-m.y);this.transformSnapGuides.graphics.clear(),this.transformSnapGuides.graphics.lineStyle(1,2154751),this.transformSnapGuides.graphics.drawRect(g.x,g.y,g.width,g.height);let f=new PIXI.Point,v=new PIXI.Point;for(let T in l)for(let x in l[T]){let B=l[T][x];switch(x){case"left":f.x=v.x=B.right,f.y=B.top,v.y=B.bottom;break;case"right":f.x=v.x=B.left,f.y=B.top,v.y=B.bottom;break;case"top":f.y=v.y=B.bottom,f.x=B.left,v.x=B.right;break;case"bottom":f.y=v.y=B.top,f.x=B.left,v.x=B.right;break}let y=this.transformSnapGuides.graphics.toLocal(f,this.transformLayer),F=this.transformSnapGuides.graphics.toLocal(v,this.transformLayer);this.transformSnapGuides.graphics.moveTo(y.x,y.y),this.transformSnapGuides.graphics.lineTo(F.x,F.y)}};ye.prototype.selectItem=function(i,e){i&&(i!=this.item&&(this.fadeAnimator.setAnimatorFactor(0),this.deselectItem(),this.item=i,this.updateDisplay()),this.itemCenterOffsetX=0,this.itemCenterOffsetY=0,this.item.selectedByMouse&&this.item.accurateBounds?(this.item.transforming=!0,this.gizmoDragger.scale=this._scale,this.gizmoDragger.drag(this.transformTool),this.fadeAnimator.decrease(),this.item.type=="group"&&this.item.fadeAnimator.decrease()):(this.fadeAnimator.increase(),this.item.type=="group"&&this.item.fadeAnimator.increase()))};ye.prototype.deselectItem=function(){this.toolDraggers.forEach(i=>{i.dragging&&i.stopDrag(),i.active&&i.completeStopDrag()}),this.item&&(this.item.transforming=!1,this.item=null),this.fadeAnimator.decrease(),this.transformSnapGuides.hideLines(),BFN.MainUI.tooltip=null};ye.prototype.disableHandles=function(i){for(let e in this.textHandles){let t=this.textHandles[e];t!=i&&(t.interactive=!1)}for(let e in this.scaleHandles){let t=this.scaleHandles[e];t!=i&&(t.interactive=!1)}this.rotationHandle!=i&&(this.rotationHandle.interactive=!1)};ye.prototype.enableHandles=function(){for(let i in this.textHandles){let e=this.textHandles[i];e.interactive=!0}for(let i in this.scaleHandles){let e=this.scaleHandles[i];e.interactive=!0}this.rotationHandle.interactive=!0};ye.prototype.updateHandleScales=function(){for(let i in this.textHandles){let e=this.textHandles[i];e.scale.x=e.scale.y=1/this._scale}for(let i in this.scaleHandles){let e=this.scaleHandles[i];e.scale.x=e.scale.y=1/this._scale}this.rotationHandle.scale.x=this.rotationHandle.scale.y=1/this._scale};ye.prototype.drawGizmo=function(){this.transformGizmoOutline.setDimensions(this.itemWidth+this.gizmoPadding/this._scale*2,this.itemHeight+this.gizmoPadding/this._scale*2),this.transformGizmoHandle.visible=!(this.item&&this.item.lockedOrHidden),this.transformGizmoHandle.y=-(this.itemHeight/2+this.gizmoPadding/this._scale),this.transformGizmoHandle.length=this.rotationHandleOffset*(1/this._scale)};ye.prototype.updateDisplay=function(){this.item&&!BFN.UndoManager.updating&&(this.updateTransformValues(),this.updateHandleDisplay(),this.updateTextHandlePosition(),this.updateScaleHandlePosition(),this.updateRotationHandlePosition(),this.drawGizmo())};ye.prototype.updateTransformValues=function(){if(this.item){let i=this.item.bounds,e=this.item.x,t=this.item.y;if(this.itemBaseWidth=i.width,this.itemBaseHeight=i.height,this.item.textCurveActive&&BFN.FabricManager.showingTransformItemIText){let{bounds:r}=this.item.curvedText.cText._getCurveCharData();this.itemBaseWidth=r.width*this.item.textScale,this.itemBaseHeight=r.height*this.item.textScale;let a=(i.width-this.itemBaseWidth)/2;e+=Math.cos(this.item.rotation)*a,t+=Math.sin(this.item.rotation)*a}this.itemWidth=this.itemBaseWidth*this.item.scale.x,this.itemHeight=this.itemBaseHeight*this.item.scale.y,this.itemRadius=Math.sqrt(Math.pow(this.itemWidth,2)+Math.pow(this.itemHeight,2))/2,this.itemCenterBeta=Math.atan2(this.itemHeight/2,this.itemWidth/2),this.itemCenterX=e+Math.cos(this.itemCenterBeta+this.item.rotation)*this.itemRadius,this.itemCenterY=t+Math.sin(this.itemCenterBeta+this.item.rotation)*this.itemRadius,this.itemAspectRatio=this.item.scale.x/this.item.scale.y,this.transformGizmo.x=this.transformGizmo.y=0,this.transformGizmo.rotation=this.item.rotation,this.hBeta=this.item.rotation,this.vBeta=this.hBeta-this.PId2,this.transformTool.x=this.itemCenterX,this.transformTool.y=this.itemCenterY}};ye.prototype.updateHandleDisplay=function(){let i=this.item.type==="text"&&!this.item.textCurveActive&&!this.item.lockedOrHidden;if(!this.hasOwnProperty("textHandlesVisible")||this.textHandlesVisible!==i){this.textHandlesVisible=i;for(let r=0;r<this.textHandleIDs.length;r++){let a=this.textHandleIDs[r],s=this.textHandles[a];s.visible=i}}let e=(!["text","group"].includes(this.item.type)||this.item.isStretchable)&&!this.item.lockedOrHidden;if(!this.hasOwnProperty("sideHandlesVisible")||this.sideHandlesVisible!==e){this.sideHandlesVisible=e;for(let r=0;r<this.sideHandleIDs.length;r++){let a=this.sideHandleIDs[r],s=this.scaleHandles[a];s.visible=e}}let t=!this.item.lockedOrHidden;if(!this.hasOwnProperty("scaleHandlesVisible")||this.scaleHandlesVisible!==t){for(let r in this.scaleHandles)if((this.sideHandleIDs.includes(r)?"side":"corner")==="corner"){let s=this.scaleHandles[r];s.visible=t}}this.rotationHandle.visible=!this.item.lockedOrHidden};ye.prototype.updateTextHandlePosition=function(){let i=(this.itemHeight+this.gizmoPadding/this._scale*2)*this._scale;for(let e in this.textHandles){let t=this.textHandles[e];t.rotation=this.hBeta;let r=null,a=null;switch(t.id){case"l":r=this.hBeta-Math.PI,a=this.hBeta+Math.PI;break;case"r":r=this.hBeta,a=this.hBeta;break}r!==null&&(t.betaPadding=a,t.noPaddingX=this.transformGizmo.x+Math.cos(r)*(this.itemWidth/2),t.noPaddingY=this.transformGizmo.y+Math.sin(r)*(this.itemWidth/2),t.x=t.noPaddingX+Math.cos(t.betaPadding)*(this.gizmoPadding/this._scale),t.y=t.noPaddingY+Math.sin(t.betaPadding)*(this.gizmoPadding/this._scale),t.rotation=this.hBeta+this.PId2,t.active=i>this.handleTextureCircle.width+this.handleTextureSquare.width-8)}};ye.prototype.updateScaleHandlePosition=function(){let i=(this.itemWidth+this.gizmoPadding/this._scale*2)*this._scale,e=(this.itemHeight+this.gizmoPadding/this._scale*2)*this._scale;for(let t in this.scaleHandles){let r=this.sideHandleIDs.includes(t)?"side":"corner",a=null,s=null,o=null;switch(t){case"tl":a=this.itemCenterBeta+this.hBeta-Math.PI,s=-(Math.PI*.75)+this.hBeta;break;case"tr":a=-this.itemCenterBeta+this.hBeta,s=-(Math.PI*.25)+this.hBeta;break;case"bl":a=Math.PI-this.itemCenterBeta+this.hBeta,s=Math.PI*.75+this.hBeta;break;case"br":a=this.itemCenterBeta+this.hBeta,s=Math.PI*.25+this.hBeta;break;case"l":a=this.hBeta-Math.PI,o=this.hBeta+Math.PI;break;case"r":a=this.hBeta,o=this.hBeta;break;case"t":a=this.hBeta-Math.PI/2,o=this.hBeta-Math.PI/2;break;case"b":a=this.hBeta+Math.PI/2,o=this.hBeta+Math.PI/2;break}if(a!==null){let n=this.scaleHandles[t];switch(r){case"corner":n.betaDiagonal=s,n.noPaddingX=this.transformGizmo.x+Math.cos(a)*this.itemRadius,n.noPaddingY=this.transformGizmo.y+Math.sin(a)*this.itemRadius,n.x=n.noPaddingX+Math.cos(s)*(this.gizmoPaddingDiagonal/this._scale),n.y=n.noPaddingY+Math.sin(s)*(this.gizmoPaddingDiagonal/this._scale);break;case"side":let l=["l","r"].includes(n.id);n.betaPadding=o,n.noPaddingX=this.transformGizmo.x+Math.cos(a)*((l?this.itemWidth:this.itemHeight)/2),n.noPaddingY=this.transformGizmo.y+Math.sin(a)*((l?this.itemWidth:this.itemHeight)/2),n.x=n.noPaddingX+Math.cos(n.betaPadding)*(this.gizmoPadding/this._scale),n.y=n.noPaddingY+Math.sin(n.betaPadding)*(this.gizmoPadding/this._scale),n.rotation=this.hBeta+(l?this.PId2:0),n.active=(l?e:i)>this.handleTextureCircle.width+this.handleTextureSquare.width-8;break}}}};ye.prototype.updateRotationHandlePosition=function(){this.rotationHandle.x=this.transformGizmo.x-Math.cos(this.vBeta)*(-Math.abs(this.itemHeight/2)-this.rotationHandleOffset*(1/this._scale)-this.gizmoPadding/this._scale),this.rotationHandle.y=this.transformGizmo.y-Math.sin(this.vBeta)*(-Math.abs(this.itemHeight/2)-this.rotationHandleOffset*(1/this._scale)-this.gizmoPadding/this._scale)};ye.prototype.initTransformToolFrame=function(){this.transformToolFrame=new BFN.TransformToolFrame(this),this.addChild(this.transformToolFrame)};ye.prototype.resizeText=function(){let i=BFN.MainUI.getPointerPosition(BFN.MainUI.pointerEvent),e=new PIXI.Point(i.x+BFN.MainUI.x-this.textAnchor.x,i.y+BFN.MainUI.y-this.textAnchor.y),r=Math.cos(Math.atan2(e.y,e.x)+this.textControl.beta-this.hBeta)<=0?0:Math.ceil((this.getPointToLineDistance(e,Math.tan(this.vBeta))-this.gizmoPadding*2)/this._scale),a=this.item,s=a.iText,o=a.textScale*a.scale.x;this.item.iText.width=r/o,this.item.iText.initDimensions(),r=s.width*o,s.width=r/o,s.initDimensions();let n=Math.ceil(s.height*o);this.textControl.beta<Math.PI/2?(s.left=this.iTextData.topLeft.x,s.top=this.iTextData.topLeft.y,this.item.x=this.itemData.topLeft.x,this.item.y=this.itemData.topLeft.y):(s.left=this.iTextData.topRight.x-Math.cos(this.hBeta)*r*this._scale,s.top=this.iTextData.topRight.y-Math.sin(this.hBeta)*r*this._scale,this.item.x=this.itemData.topRight.x-Math.cos(this.hBeta)*r,this.item.y=this.itemData.topRight.y-Math.sin(this.hBeta)*r),BFN.FabricManager.fabricCanvas.renderAll(),this.itemWidth=r,this.itemHeight=n,this.itemRadius=Math.sqrt(Math.pow(this.itemWidth,2)+Math.pow(this.itemHeight,2))/2,this.itemCenterBeta=Math.atan2(this.itemHeight/2,this.itemWidth/2),this.updateDisplayForTextResize()};ye.prototype.updateDisplayForTextResize=function(){this.item&&(this.itemCenterX=this.item.x+Math.cos(this.itemCenterBeta+this.item.rotation)*this.itemRadius,this.itemCenterY=this.item.y+Math.sin(this.itemCenterBeta+this.item.rotation)*this.itemRadius,this.transformTool.x=this.itemCenterX,this.transformTool.y=this.itemCenterY,this.updateTextHandlePosition(),this.updateScaleHandlePosition(),this.updateRotationHandlePosition(),this.drawGizmo())};ye.prototype.freeformScale=function(){if(!!!(!["text","group"].includes(this.item.type)||this.item.isStretchable))return;let e=this.sideHandleIDs.includes(this.currentScaleHandle.id)?"side":"corner",t=["l","r"].includes(this.currentScaleHandle.id),r=null,a=()=>{switch(r=this.transformTool.getPointerPosition(BFN.MainUI.pointerEvent),e){case"corner":this.scaleControl.x=r.x-Math.cos(this.currentScaleHandle.betaDiagonal)*(this.gizmoPaddingDiagonal/this._scale),this.scaleControl.y=r.y-Math.sin(this.currentScaleHandle.betaDiagonal)*(this.gizmoPaddingDiagonal/this._scale);break;case"side":this.scaleControl.x=r.x-Math.cos(this.currentScaleHandle.betaPadding)*(this.gizmoPadding/this._scale),this.scaleControl.y=r.y-Math.sin(this.currentScaleHandle.betaPadding)*(this.gizmoPadding/this._scale);break}},s=()=>{let m=!0,p=null;if(e==="side"&&(m=(this.item.rotation+this.PIx2)%this.PId2<Math.PI/180,p=!!((this.item.rotation+this.PIx2)%this.PIx2/this.PId2%2)?t?"vertical":"horizontal":t?"horizontal":"vertical"),BFN.TransformModel.snappingEnabled&&this.scaleHandleDragger.wasDragged&&m){let g=!1,f=!1,v={};for(let B=0;B<this.item.snapCoordinates.length;B++){let y=this.item.snapCoordinates[B],F=this.transformLayer.toLocal(this.scaleControl,this.transformTool);switch(y.position){case"horizontal":let b=F.x-y.value;if(Math.abs(b)<(g?this.snapDistanceTransformSnapped:this.snapDistanceTransform)){g||(F.x=y.value);let I=this.transformTool.toLocal(F,this.transformLayer);this.scaleControl.x=I.x,this.scaleControl.y=I.y,g=!0,v.hasOwnProperty("center")||(v.center={maskedSegment:null,values:[],axis:"y"}),v.center.values.includes(y.bounds.top)||v.center.values.push(y.bounds.top),v.center.values.includes(y.bounds.bottom)||v.center.values.push(y.bounds.bottom)}break;case"vertical":let S=F.y-y.value;if(Math.abs(S)<(f?this.snapDistanceTransformSnapped:this.snapDistanceTransform)){f||(F.y=y.value);let I=this.transformTool.toLocal(F,this.transformLayer);this.scaleControl.x=I.x,this.scaleControl.y=I.y,f=!0,v.hasOwnProperty("middle")||(v.middle={maskedSegment:null,values:[],axis:"x"}),v.middle.values.includes(y.bounds.left)||v.middle.values.push(y.bounds.left),v.middle.values.includes(y.bounds.right)||v.middle.values.push(y.bounds.right)}break}}let T=BFN.Util.getTransformItemBounds(this.item,!0);T.x={a:T.minX,b:T.maxX},T.y={a:T.minY,b:T.maxY};for(let B in v)if(e==="corner"||p==="horizontal"&&B==="center"&&g||p==="vertical"&&B==="middle"&&f){let y=v[B];y.maskedSegment={startPoint:new PIXI.Point,endPoint:new PIXI.Point},y.maskedSegment.startPoint[y.axis]=T[y.axis].a,y.maskedSegment.endPoint[y.axis]=T[y.axis].b,y.values.sort((F,b)=>F-b);for(let F=0;F<y.values.length;F++)y.maskedSegment.startPoint[y.axis]=Math.min(y.maskedSegment.startPoint[y.axis],y.values[F]),y.maskedSegment.endPoint[y.axis]=Math.max(y.maskedSegment.endPoint[y.axis],y.values[F]);y.maskedSegment.startPoint=this.transformLayer.toGlobal(y.maskedSegment.startPoint),y.maskedSegment.endPoint=this.transformLayer.toGlobal(y.maskedSegment.endPoint),this.showSnapGuideLine(B,[y.maskedSegment])}let x=this.transformLayer.toLocal(this.scaleControl,this.transformTool);this.transformSnapGuides.setCenter(x.x,x.y),this.transformSnapGuides.setDimensions(3,3)}};a(),s();let o=new PIXI.Point(this.scaleAnchor.x,this.scaleAnchor.y);o=this.transformGizmo.toLocal(o,this.transformTool);let n=new PIXI.Point(this.scaleControl.x,this.scaleControl.y);n=this.transformGizmo.toLocal(n,this.transformTool);let l=new PIXI.Point(this.currentScaleHandle.noPaddingX,this.currentScaleHandle.noPaddingY);l=this.transformGizmo.toLocal(l,this.transformTool);let c=e==="side"&&!t?!1:(o.x-l.x)*(o.x-n.x)<0,h=e==="side"&&t?!1:(o.y-l.y)*(o.y-n.y)<0,u=this.minSize,d=this.minSize;switch(this.item.type){case"group":u=d=this.item.minSize;break;case"text":u=d=this.minSizeText;break;case"frame_texture":u=d=this.minSizeFrame;let m=this.item.itemContent.frameSprite;m.frameScaling&&(u=Math.max(u,m.initialRealDimensions.x/m.baseWidth*this.minSizeFrame),d=Math.max(d,m.initialRealDimensions.y/m.baseHeight*this.minSizeFrame));break;case"texture":this.item.isShape||(u=d=this.minSizeFrame);break}if(this.scaleHandleDragger.altKey){switch(this.anchorCenter||(this.anchorCenter=!0,this.transformGizmo.x=this.transformGizmo.y=0,this.transformTool.x=this.itemCenterX,this.transformTool.y=this.itemCenterY,this.updateDisplay(),BFN.MainUI.renderCanvas(),r=this.transformTool.getPointerPosition(BFN.MainUI.pointerEvent)),a(),s(),e){case"corner":this.newItemWidth=this.getPointToLineDistance(this.scaleControl,Math.tan(this.vBeta))*2,this.newItemHeight=this.getPointToLineDistance(this.scaleControl,Math.tan(this.hBeta))*2;break;case"side":t?(this.newItemWidth=this.getPointToLineDistance(this.scaleControl,Math.tan(this.vBeta))*2,this.newItemHeight=this.itemHeight):(this.newItemWidth=this.itemWidth,this.newItemHeight=this.getPointToLineDistance(this.scaleControl,Math.tan(this.hBeta))*2);break}this.newItemWidth=c?u:Math.max(u,this.newItemWidth),this.newItemHeight=h?d:Math.max(d,this.newItemHeight)}else{this.anchorCenter=!1;let m=new PIXI.Point(this.scaleControl.x,this.scaleControl.y);m=this.transformGizmo.toLocal(m,this.transformTool);let p=new PIXI.Point(this.scaleAnchor.x,this.scaleAnchor.y);switch(p=this.transformGizmo.toLocal(p,this.transformTool),e){case"corner":let f=Math.sqrt(Math.pow(this.scaleControl.x-this.scaleAnchor.x,2)+Math.pow(this.scaleControl.y-this.scaleAnchor.y,2)),v=Math.abs(Math.atan2(m.y-p.y,m.x-p.x));v=v>this.PId2?Math.PI-v:v,this.newItemWidth=Math.cos(v)*f,this.newItemHeight=Math.sin(v)*f;break;case"side":t?(this.newItemWidth=Math.abs(p.x-m.x),this.newItemHeight=this.itemHeight):(this.newItemWidth=this.itemWidth,this.newItemHeight=Math.abs(p.y-m.y));break}this.newItemWidth=c?u:Math.max(u,this.newItemWidth),this.newItemHeight=h?d:Math.max(d,this.newItemHeight);let g=new PIXI.Point(p.x,p.y);switch(this.currentScaleHandle.id){case"tl":g.x-=this.newItemWidth/2,g.y-=this.newItemHeight/2;break;case"tr":g.x+=this.newItemWidth/2,g.y-=this.newItemHeight/2;break;case"bl":g.x-=this.newItemWidth/2,g.y+=this.newItemHeight/2;break;case"br":g.x+=this.newItemWidth/2,g.y+=this.newItemHeight/2;break;case"l":g.x-=this.newItemWidth/2;break;case"r":g.x+=this.newItemWidth/2;break;case"t":g.y-=this.newItemHeight/2;break;case"b":g.y+=this.newItemHeight/2;break}g=this.transformTool.toLocal(g,this.transformGizmo),this.transformGizmo.x=g.x,this.transformGizmo.y=g.y,g=this.toLocal(g,this.transformTool),this.itemCenterX=g.x,this.itemCenterY=g.y}switch(this.item.scale.x=this.newItemWidth/this.itemBaseWidth,this.item.scale.y=this.newItemHeight/this.itemBaseHeight,this.itemAspectRatio=this.item.scale.x/this.item.scale.y,this.itemWidth=this.itemBaseWidth*this.item.scale.x,this.itemHeight=this.itemBaseHeight*this.item.scale.y,this.itemRadius=Math.sqrt(Math.pow(this.itemWidth,2)+Math.pow(this.itemHeight,2))/2,this.itemCenterBeta=Math.atan2(this.itemHeight/2,this.itemWidth/2),this.item.updateFrameTextureDisplay(),this.item.x=this.itemCenterX-Math.cos(this.hBeta+this.itemCenterBeta)*this.itemRadius,this.item.y=this.itemCenterY-Math.sin(this.hBeta+this.itemCenterBeta)*this.itemRadius,this.currentScaleHandle.id){case"tl":case"br":BFN.CursorScreen.cursorRotation=this.hBeta+this.itemCenterBeta;break;case"tr":case"bl":BFN.CursorScreen.cursorRotation=this.hBeta-this.itemCenterBeta;break;case"l":case"r":BFN.CursorScreen.cursorRotation=this.hBeta;break;case"tr":case"bl":BFN.CursorScreen.cursorRotation=this.vBeta;break}if(this.updateTextHandlePosition(),this.updateScaleHandlePosition(),this.updateRotationHandlePosition(),this.anchorCenter){let m=this.getInverseScaleHandle(this.currentScaleHandle);this.scaleAnchor.x=m.noPaddingX,this.scaleAnchor.y=m.noPaddingY}this.item.type=="group"&&this.item.updateGroupTransform()};ye.prototype.constrainedScale=function(){let i=this.sideHandleIDs.includes(this.currentScaleHandle.id)?"side":"corner",e=["l","r"].includes(this.currentScaleHandle.id);if(i==="side")switch(this.item.type){case"text":case"group":return}this.scaleHandleDragger.altKey?this.anchorCenter||(this.anchorCenter=!0,this.transformGizmo.x=this.transformGizmo.y=0,this.transformTool.x=this.itemCenterX,this.transformTool.y=this.itemCenterY):this.anchorCenter=!1;let t=this.transformTool.getPointerPosition(BFN.MainUI.pointerEvent);switch(i){case"corner":this.scaleControl.x=t.x-Math.cos(this.currentScaleHandle.betaDiagonal)*(this.gizmoPaddingDiagonal/this._scale),this.scaleControl.y=t.y-Math.sin(this.currentScaleHandle.betaDiagonal)*(this.gizmoPaddingDiagonal/this._scale);break;case"side":this.scaleControl.x=t.x-Math.cos(this.currentScaleHandle.betaPadding)*(this.gizmoPadding/this._scale),this.scaleControl.y=t.y-Math.sin(this.currentScaleHandle.betaPadding)*(this.gizmoPadding/this._scale);break}let r=1,a;if(this.item.type==="text"&&this.item.textCurveActive){let y=Math.sqrt(this.item.textItemContentW**2+this.item.textItemContentH**2)/2;r=Math.sqrt(this.item.itemContentW**2+this.item.itemContentH**2)/2/y,a=this.item.textItemContentH/this.item.textItemContentW}else a=this.itemBaseHeight/this.itemBaseWidth/this.itemAspectRatio;let s=this.minSize;switch(this.item.type){case"group":s=this.item.minSize;break;case"text":s=this.minSizeText;break;case"frame_texture":s=this.minSizeFrame;break;case"texture":this.item.isShape||(s=this.minSizeFrame);break}let o=Math.max(s,s/a),n=Math.max(s,s*a),l=s,c=l*a,h=Math.sqrt(l**2+c**2),u=s,d=u/a,m=Math.sqrt(d**2+u**2),p=Math.max(h,m)/2*r,g=[];if(BFN.TransformModel.snappingEnabled&&this.scaleHandleDragger.wasDragged&&i==="corner"){let y=null;switch(this.currentScaleHandle.id){case"tl":case"br":y=this.item.rotation+this.itemCenterBeta;break;case"bl":case"tr":y=this.item.rotation-this.itemCenterBeta;break}if(y!==null){let F=Math.sin(y),b=Math.cos(y),S=F?b?F/b:1/0:0;this.drawSnapHelpers&&(this.itemGuidesGraphic.clear(),this.itemGuidesGraphic.lineStyle(1,16711935),this.itemGuidesGraphic.moveTo(this.itemCenterX-b*2e3,this.itemCenterY-F*2e3),this.itemGuidesGraphic.lineTo(this.itemCenterX+b*2e3,this.itemCenterY+F*2e3),this.itemGuidesGraphic.lineStyle(null));let I=this.transformLayer.toLocal(new PIXI.Point(this.currentScaleHandle.noPaddingX,this.currentScaleHandle.noPaddingY),this.transformTool),_=this.transformLayer.toLocal(this.scaleAnchor,this.transformTool),E=Math.atan2(I.y-_.y,I.x-_.x);this.item.snapCoordinates.forEach(w=>{let N=new PIXI.Point(w.value,w.value);switch(w.position){case"horizontal":N.y=S===0?this.itemCenterY:S===1/0?NaN:S*(N.x-this.itemCenterX)+this.itemCenterY;break;case"vertical":N.x=S===0?NaN:S===1/0?this.itemCenterX:(N.y-this.itemCenterY)/S+this.itemCenterX;break}if(!isNaN(N.x)&&!isNaN(N.y)){let M=Math.atan2(N.y-_.y,N.x-_.x),z=Math.sqrt((N.x-_.x)**2+(N.y-_.y)**2);Math.abs(M-E)<this.PId2&&z>p&&(N.snapCoordinate=w,g.push(N),this.drawSnapHelpers&&(this.itemGuidesGraphic.beginFill(65280),this.itemGuidesGraphic.drawCircle(N.x,N.y,3),this.itemGuidesGraphic.endFill()))}})}}let f=null,v=null,T=null;switch(this.currentScaleHandle.id){case"tl":case"br":f=(this.hBeta-this.PId2+this.itemCenterBeta+this.PIx2)%this.PIx2;break;case"tr":case"bl":f=(this.hBeta+this.PId2-this.itemCenterBeta+this.PIx2)%this.PIx2;break;case"l":case"r":f=(this.hBeta-this.PId2+this.PIx2)%this.PIx2;break;case"t":case"b":f=(this.hBeta+this.PIx2)%this.PIx2;break}this.deltaPoint.x=this.scaleControl.x-this.scaleAnchor.x,this.deltaPoint.y=this.scaleControl.y-this.scaleAnchor.y;let x=0,B=0;switch(i){case"corner":f%Math.PI==0?(v=1/0,this.newItemRadius=Math.max(p,Math.abs(this.deltaPoint.y)/2)):f%Math.PI===this.PId2?(v=0,this.newItemRadius=Math.max(p,Math.abs(this.deltaPoint.x)/2)):(v=Math.tan(f),this.newItemRadius=Math.max(p,this.getPointToLineDistance(this.deltaPoint,v)/2));break;case"side":if(f%Math.PI==0)v=1/0,e?(x=Math.max(o,Math.abs(this.deltaPoint.x))/2,this.newItemRadius=x/Math.cos(this.itemCenterBeta)):(B=Math.max(n,Math.abs(this.deltaPoint.y))/2,this.newItemRadius=B/Math.sin(this.itemCenterBeta));else if(f%Math.PI===this.PId2)v=0,e?(x=Math.max(o,Math.abs(this.deltaPoint.x))/2,this.newItemRadius=x/Math.cos(this.itemCenterBeta)):(B=Math.max(n,Math.abs(this.deltaPoint.y))/2,this.newItemRadius=B/Math.sin(this.itemCenterBeta));else{v=Math.tan(f);let y=this.getPointToLineDistance(this.deltaPoint,v);e?(x=Math.max(o,y)/2,this.newItemRadius=x/Math.cos(this.itemCenterBeta)):(B=Math.max(n,y)/2,this.newItemRadius=B/Math.sin(this.itemCenterBeta))}break}switch(this.deltaPoint.x=this.currentScaleHandle.noPaddingX-this.scaleControl.x,this.deltaPoint.y=this.currentScaleHandle.noPaddingY-this.scaleControl.y,i){case"corner":v===1/0?T=Math.abs(this.deltaPoint.y)/2>this.newItemRadius:v===0?T=Math.abs(this.deltaPoint.x)/2>this.newItemRadius:T=this.getPointToLineDistance(this.deltaPoint,v)/2>this.newItemRadius;break;case"side":v===1/0?e?T=Math.abs(this.deltaPoint.x)/2>x:T=Math.abs(this.deltaPoint.y)/2>B:v===0?e?T=Math.abs(this.deltaPoint.x)/2>x:T=Math.abs(this.deltaPoint.y)/2>B:e?T=this.getPointToLineDistance(this.deltaPoint,v)/2>x:T=this.getPointToLineDistance(this.deltaPoint,v)/2>B;break}if(this.newItemRadius=T?p:Math.max(p,this.newItemRadius),BFN.TransformModel.snappingEnabled&&i==="corner"){let y=this.transformLayer.toLocal(this.scaleAnchor,this.transformTool);this.drawSnapHelpers&&(this.itemGuidesGraphic.beginFill(11184895,.5),this.itemGuidesGraphic.drawCircle(y.x,y.y,6),this.itemGuidesGraphic.endFill());let F=null,b=g.length;for(;--b>-1;){let S=g[b],I=Math.sqrt((S.x-y.x)**2+(S.y-y.y)**2)/2,_=Math.sqrt((S.x-this.itemCenterX)**2+(S.y-this.itemCenterY)**2),E=this.anchorCenter?_:I;Math.abs(this.newItemRadius-E)<this.screenPixelSnapThreshold/this._scale&&(F=S,this.newItemRadius=E)}if(F){this.drawSnapHelpers&&(this.itemGuidesGraphic.beginFill(16776960),this.itemGuidesGraphic.drawCircle(F.x,F.y,6),this.itemGuidesGraphic.endFill());let S={};for(let _=0;_<this.item.snapCoordinates.length;_++){let E=this.item.snapCoordinates[_];switch(E.position){case"horizontal":Math.abs(F.x-E.value)<1&&(S.hasOwnProperty("center")||(S.center={maskedSegment:null,values:[],axis:"y"}),S.center.values.includes(E.bounds.top)||S.center.values.push(E.bounds.top),S.center.values.includes(E.bounds.bottom)||S.center.values.push(E.bounds.bottom));break;case"vertical":Math.abs(F.y-E.value)<1&&(S.hasOwnProperty("middle")||(S.middle={maskedSegment:null,values:[],axis:"x"}),S.middle.values.includes(E.bounds.left)||S.middle.values.push(E.bounds.left),S.middle.values.includes(E.bounds.right)||S.middle.values.push(E.bounds.right));break}}let I=BFN.Util.getTransformItemBounds(this.item,!0);I.x={a:I.minX,b:I.maxX},I.y={a:I.minY,b:I.maxY};for(let _ in S){let E=S[_];E.maskedSegment={startPoint:new PIXI.Point,endPoint:new PIXI.Point},E.maskedSegment.startPoint[E.axis]=I[E.axis].a,E.maskedSegment.endPoint[E.axis]=I[E.axis].b,E.values.sort((D,w)=>D-w);for(let D=0;D<E.values.length;D++)E.maskedSegment.startPoint[E.axis]=Math.min(E.maskedSegment.startPoint[E.axis],E.values[D]),E.maskedSegment.endPoint[E.axis]=Math.max(E.maskedSegment.endPoint[E.axis],E.values[D]);E.maskedSegment.startPoint=this.transformLayer.toGlobal(E.maskedSegment.startPoint),E.maskedSegment.endPoint=this.transformLayer.toGlobal(E.maskedSegment.endPoint),this.showSnapGuideLine(_,[E.maskedSegment])}this.transformSnapGuides.setCenter(F.x,F.y),this.transformSnapGuides.setDimensions(3,3)}}if(this.newItemWidth=Math.cos(this.itemCenterBeta)*this.newItemRadius*2,this.newItemHeight=Math.sin(this.itemCenterBeta)*this.newItemRadius*2,x=this.newItemWidth/2,B=this.newItemHeight/2,!this.anchorCenter){let y=new PIXI.Point(this.scaleAnchor.x,this.scaleAnchor.y),F=null;switch(this.currentScaleHandle.id){case"tl":case"br":F=this.hBeta+this.itemCenterBeta;break;case"tr":case"bl":F=this.hBeta-this.itemCenterBeta;break;case"l":case"r":F=this.hBeta;break;case"t":case"b":F=this.hBeta+this.PId2;break}let b=Math.cos(F)*(i==="corner"?this.newItemRadius:e?x:B),S=Math.sin(F)*(i==="corner"?this.newItemRadius:e?x:B);switch(this.currentScaleHandle.id){case"tl":case"bl":case"l":case"t":y.x-=b,y.y-=S;break;case"tr":case"br":case"r":case"b":y.x+=b,y.y+=S;break}this.transformGizmo.x=y.x,this.transformGizmo.y=y.y,y=this.toLocal(y,this.transformTool),this.itemCenterX=y.x,this.itemCenterY=y.y}if(this.item.scale.x=this.newItemWidth/this.itemBaseWidth,this.item.scale.y=this.item.scale.x/this.itemAspectRatio,this.itemWidth=this.itemBaseWidth*this.item.scale.x,this.itemHeight=this.itemBaseHeight*this.item.scale.y,this.itemRadius=Math.sqrt(Math.pow(this.itemWidth,2)+Math.pow(this.itemHeight,2))/2,this.item.updateFrameTextureDisplay(),this.item.x=this.itemCenterX-Math.cos(this.hBeta+this.itemCenterBeta)*this.newItemRadius,this.item.y=this.itemCenterY-Math.sin(this.hBeta+this.itemCenterBeta)*this.newItemRadius,this.updateTextHandlePosition(),this.updateScaleHandlePosition(),this.updateRotationHandlePosition(),this.anchorCenter){let y=this.getInverseScaleHandle(this.currentScaleHandle);this.scaleAnchor.x=y.noPaddingX,this.scaleAnchor.y=y.noPaddingY}if(this.item.type=="text"&&this.item==BFN.TransformModel.selectedTransformItem){let y=this.item.iText;for(let F in y.styles){let b=y.styles[F];for(let S in b){let I=b[S];I.hasOwnProperty("strokePercent")&&I.hasOwnProperty("fontSize")&&(I.strokeWidth=Math.max(1/(this.item.textScale*this.item.scale.x),I.fontSize*I.strokePercent))}}BFN.FabricManager.updateTextMenu(this.item.getTextStyleData())}else this.item.type=="group"&&this.item.groupType==="text"&&this.item==BFN.TransformModel.selectedTransformItem&&BFN.FabricManager.updateTextMenu(this.item.getTextGroupStyleData());this.item.type=="group"&&this.item.updateGroupTransform()};ye.prototype.constrainedRotate=function(){if(this.rotationHandleDraggerBeta=(Math.atan2(this.rotationHandleDragger.draggedY,this.rotationHandleDragger.draggedX)+this.PIx2)%this.PIx2,this.rotationHandle.x=Math.cos(Math.atan2(this.rotationHandleDragger.draggedY,this.rotationHandleDragger.draggedX))*this.rotationRadius,this.rotationHandle.y=Math.sin(Math.atan2(this.rotationHandleDragger.draggedY,this.rotationHandleDragger.draggedX))*this.rotationRadius,this.rotationHandleDragger.shiftKey||this.rotationHandleDragger.dragVelocity<3){let i=Math.round(this.rotationHandleDraggerBeta/this.snapSectionBeta),e=Math.sqrt(Math.pow(this.rotationHandleDragger.draggedX,2)+Math.pow(this.rotationHandleDragger.draggedY,2)),t=Math.min(Math.PI/180,this.snapDistance*(1/this._scale)/e);(Math.abs(this.rotationHandleDraggerBeta-i*this.snapSectionBeta)<t||this.rotationHandleDragger.shiftKey)&&(this.rotationHandle.x=Math.cos(i*this.snapSectionBeta)*this.rotationRadius,this.rotationHandle.y=Math.sin(i*this.snapSectionBeta)*this.rotationRadius)}this.item.rotation=this.transformGizmo.rotation=Math.atan2(this.rotationHandle.y,this.rotationHandle.x)+this.PId2,BFN.CursorScreen.cursorRotation=this.item.rotation,this.hBeta=this.item.rotation,this.vBeta=this.hBeta-this.PId2,this.item.x=this.itemCenterX-Math.cos(this.hBeta+this.itemCenterBeta)*this.itemRadius,this.item.y=this.itemCenterY-Math.sin(this.hBeta+this.itemCenterBeta)*this.itemRadius,this.updateTextHandlePosition(),this.updateScaleHandlePosition(),this.item.type=="group"&&this.item.updateGroupTransform()};ye.prototype.setItemScale=function(i,e=!1){this.item&&this.item.type=="text"&&(this.item.scale.x=this.item.scale.y=Math.max(.01,i)/this.item.textScale,this.itemWidth=this.item.scale.x*this.itemBaseWidth,this.itemHeight=this.item.scale.y*this.itemBaseHeight,this.itemRadius=Math.sqrt(Math.pow(this.itemWidth,2)+Math.pow(this.itemHeight,2))/2,this.itemCenterBeta=Math.atan2(this.itemHeight/2,this.itemWidth/2),this.item.x=this.itemCenterX-Math.cos(this.hBeta+this.itemCenterBeta)*this.itemRadius,this.item.y=this.itemCenterY-Math.sin(this.hBeta+this.itemCenterBeta)*this.itemRadius,e&&this.conformItemToBounds(),this.updateTextHandlePosition(),this.updateScaleHandlePosition(),this.updateRotationHandlePosition(),this.drawGizmo(),e&&this.updateDisplay())};ye.prototype.conformItemToBounds=function(){if(this.item){let i=BFN.Util.getTransformItemBounds(this.item,!0),e=this.frameWidth/2+(i.width/2+10),t=this.frameHeight/2+(i.height/2+10);this.itemCenterX=Math.max(-e,Math.min(e,this.itemCenterX)),this.itemCenterY=Math.max(-t,Math.min(t,this.itemCenterY)),this.item.x=this.itemCenterX-Math.cos(this.hBeta+this.itemCenterBeta)*this.itemRadius,this.item.y=this.itemCenterY-Math.sin(this.hBeta+this.itemCenterBeta)*this.itemRadius,this.item.type=="group"&&this.item.updateGroupTransform()}};ye.prototype.fitItemToCanvas=function(i=!1){if(this.item&&this.item.type==="frame_texture"){this.item.clearDropShadow(),this.item.createTransition(i?"transform_fill_canvas":"transform_fit_to_canvas");let e=this.frameWidth+this.frameWidth%2,t=this.frameHeight+this.frameHeight%2,r=Math.min(e/this.item.itemContentW,t/this.item.itemContentH),a=Math.round(this.item.itemContentW*r),s=Math.round(this.item.itemContentH*r);if(a+=a%2,s+=s%2,this.item.rotation=0,this.item.x=-(a/2),this.item.y=-(s/2),this.item.scale.x=a/this.item.itemContentW,this.item.scale.y=s/this.item.itemContentH,this.item.updateFrameTextureDisplay(),this.item.resetFrameTextureScale(),i){this.updateTransformValues();let n=this.item.itemContent;a<e?n.startFrameScaling("l",!0):s<t&&n.startFrameScaling("t",!0),this.item.x=-(e/2),this.item.y=-(t/2),this.item.scale.x=e/this.itemBaseWidth,this.item.scale.y=t/this.itemBaseHeight,this.item.updateFrameTextureDisplay(),n.stopFrameScaling(),this.item.resetFrameTextureScale()}let o=()=>{if(!this.item.shapeUpdatePending){this.item.updateContentDimensions(),this.item.registerTransition(),this.updateDisplay(),BFN.MainUI.requestRender();return}setTimeout(o,0)};o()}};ye.prototype.getPointToLineDistance=function(i,e){if(e==0)return Math.abs(i.y);{let t=(i.y+1/e*i.x)/(e- -1/e),r=e*t;return Math.sqrt(Math.pow(t-i.x,2)+Math.pow(r-i.y,2))}};ye.prototype.getInverseTextHandle=function(i){return this.textHandles[this.textHandleIDs[(this.textHandleIDs.indexOf(i.id)+1)%this.textHandleIDs.length]]};ye.prototype.getInverseScaleHandle=function(i){return this.scaleHandles[this.scaleHandleIDs[(this.scaleHandleIDs.indexOf(i.id)+4)%this.scaleHandleIDs.length]]};ye.prototype.getInverseFrameAnchorSide=function(){let i=null;return this.item&&this.item.type=="frame_texture"&&this.currentScaleHandle&&(i=this.getInverseScaleHandle(this.currentScaleHandle).id,this.item.flippedHorizontal&&(i.includes("l")?i=i.replace("l","r"):i.includes("r")&&(i=i.replace("r","l"))),this.item.flippedVertical&&(i.includes("t")?i=i.replace("t","b"):i.includes("b")&&(i=i.replace("b","t")))),i};ye.prototype.showSnapGuideLine=function(i,e=null,t=null,r){this.snapGuidesCleared||(this.snapGuidesCleared=!0,this.transformSnapGuides.hideLines()),this.transformSnapGuides.showLine(i,e,t,r)};ye.prototype.toggleItemTransform=function(i){this.item&&this.item.parent&&(this.item.type==="group"?this.item.toggleTransform(i):(i?(this.itemZIndex=this.item.parent.getChildIndex(this.item),this.item.parent.setChildIndex(this.item,this.item.parent.children.length-1)):(this.item.parent.setChildIndex(this.item,this.itemZIndex),this.itemZIndex=0),this.item.toggleBlendMode(!i)))};ye.prototype.handleTextHandleOver=function(i){setTimeout(()=>{this.item&&(BFN.CursorScreen.cursor="arrow",BFN.CursorScreen.cursorRotation=this.item.rotation)},0)};ye.prototype.handleTextHandleOut=function(i){this.textHandleDragger.dragging||(BFN.CursorScreen.cursor=null)};ye.prototype.handleTextHandlePress=function(i){if(this.item){BFN.CursorScreen.cursorLock=!0,this.item.transforming=!0,this.currentTextHandle=this.textHandles[i.target.id],this.currentTextHandle.selected=!0,this.disableHandles(this.currentTextHandle),this.item.transformLayer.disableChildren(),this.textControl.x=this.currentTextHandle.transform.worldTransform.tx,this.textControl.y=this.currentTextHandle.transform.worldTransform.ty,this.textControl.beta=this.currentTextHandle.betaPadding-this.hBeta;let e=this.getInverseTextHandle(this.currentTextHandle);this.textAnchor.x=e.transform.worldTransform.tx,this.textAnchor.y=e.transform.worldTransform.ty,this.textAnchor.beta=e.betaPadding-this.hBeta,this.textHandleDragger.scale=this._scale,this.textHandleDragger.drag(this.currentTextHandle),i.stopPropagation()}};ye.prototype.handleScaleHandleOver=function(i){let e=i.target;setTimeout(()=>{if(this.item&&e){switch(BFN.CursorScreen.cursor="arrow",this.hoveredScaleHandle=e,this.hoveredScaleHandle.id){case"tl":case"br":BFN.CursorScreen.cursorRotation=this.hBeta+this.itemCenterBeta;break;case"tr":case"bl":BFN.CursorScreen.cursorRotation=this.hBeta-this.itemCenterBeta;break;case"l":case"r":BFN.CursorScreen.cursorRotation=this.hBeta;break;case"t":case"b":BFN.CursorScreen.cursorRotation=this.vBeta;break}this.hoveredScaleHandle&&!["text","group"].includes(this.item.type)&&!this.sideHandleIDs.includes(this.hoveredScaleHandle.id)&&!this.scaleHandleDragger.dragging&&(BFN.MainUI.tooltip="scaling_tooltip")}},0)};ye.prototype.handleScaleHandleOut=function(i){this.scaleHandleDragger.dragging||(BFN.CursorScreen.cursor=null,BFN.MainUI.tooltip=null)};ye.prototype.handleScaleHandlePress=function(i){if(this.item){BFN.CursorScreen.cursorLock=!0,BFN.MainUI.tooltip=null,this.item.transforming=!0,this.currentScaleHandle=this.scaleHandles[i.target.id],this.currentScaleHandle.selected=!0,this.transformSnapGuides.hideLines(),this.snapGuidesCleared=!0,this.disableHandles(this.currentScaleHandle),this.item.transformLayer.disableChildren();let e=this.getInverseScaleHandle(this.currentScaleHandle);if(this.scaleAnchor.x=e.noPaddingX,this.scaleAnchor.y=e.noPaddingY,this.scaleHandleDragger.scale=this._scale,this.scaleHandleDragger.drag(this.currentScaleHandle),i.stopPropagation(),!["text","group"].includes(this.item.type)){let t=Math.round(this.item.itemContentW*this.item.scale.x),r=Math.round(this.item.itemContentH*this.item.scale.y);BFN.TooltipScreen.show(t+" x "+r,!0,!0),BFN.TooltipScreen.setPosition(i.data.originalEvent.clientX,i.data.originalEvent.clientY,{onCanvas:!0})}}};ye.prototype.handleRotationHandleOver=function(i){setTimeout(()=>{this.item&&(BFN.CursorScreen.cursor="rotate",BFN.CursorScreen.cursorRotation=this.item.rotation)},0)};ye.prototype.handleRotationHandleOut=function(i){this.rotationHandleDragger.dragging||(BFN.CursorScreen.cursor=null)};ye.prototype.handleRotationHandlePress=function(i){if(this.rotationRadius=Math.sqrt(Math.pow(this.rotationHandle.x,2)+Math.pow(this.rotationHandle.y,2)),this.item){BFN.CursorScreen.cursorLock=!0,this.item.transforming=!0,this.rotationHandle.selected=!0,this.disableHandles(this.rotationHandle),this.item.transformLayer.disableChildren(),this.rotationHandleDragger.scale=this._scale,this.rotationHandleDragger.drag(this.rotationHandle),i.stopPropagation();let e=(Math.round((this.item.rotation+Math.PI*2)%(Math.PI*2)*(180/Math.PI)*2)/2).toFixed(1);BFN.TooltipScreen.show(e+"\xB0",!0,!0),BFN.TooltipScreen.setPosition(i.data.originalEvent.clientX,i.data.originalEvent.clientY,{onCanvas:!0})}};ye.prototype.handleRotationHandleSelectAnimatorUpdate=function(i){};ye.prototype.handleTransformGizmoDraggingStarted=function(i){if(BFN.smoothPictureDisabled=!0,this.item){BFN.TransformToolSnapGaps.show(),this.prepareItemForDragging(),this.item.accurateBoundsRequested&&this.item.addEventListener(BFN.TransformItemEvents.ACCURATE_BOUNDS_UPDATED.type,this.handleItemAccurateBoundsUpdatedBind);let e=this.item.isGoodie?"history_move_graphic":"history_move_image";switch(this.item.type){case"text":e="history_move_text";break;case"group":e="history_move_selection";break}this.item.createTransition(e)}this.handleTransformGizmoDragging(i)};ye.prototype.prepareItemForDragging=function(){if(this.item){this.item.dispatchEvent(BFN.TransformItemEvents.GET_SNAP_COORDINATES);let i=BFN.Util.getTransformItemBounds(this.item);this.itemCenterOffsetX=this.transformTool.x-(i.minX+this.item.accurateBounds.minX+this.item.accurateBounds.width/2),this.itemCenterOffsetY=this.transformTool.y-(i.minY+this.item.accurateBounds.minY+this.item.accurateBounds.height/2);let e=this.frameWidth/2+(i.width/2+10),t=this.frameHeight/2+(i.height/2+10);this.gizmoDragger.setBounds(-e,-t,e,t)}};ye.prototype.handleItemAccurateBoundsUpdated=function(i){i.dispatcher.removeEventListener(BFN.TransformItemEvents.ACCURATE_BOUNDS_UPDATED.type,this.handleItemAccurateBoundsUpdatedBind),this.item&&this.item.transforming&&this.gizmoDragger.dragging&&this.prepareItemForDragging()};ye.prototype.handleTransformGizmoDragging=function(i){if(this.snapDistanceTransform=this.screenPixelSnapThreshold*(1/this._scale),this.snapDistanceTransformSnapped=1/this._scale,this.snapGuidesCleared=!1,this.item){if(this.gizmoDragger.wasDragged&&!this.item.itemMoved&&(this.item.itemMoved=!0,this.toggleItemTransform(!0)),this.itemCenterX=this.transformTool.x,this.itemCenterY=this.transformTool.y,BFN.TransformModel.snappingEnabled&&this.gizmoDragger.wasDragged&&this.item.accurateBounds){let e=!1,t=!1,r={};for(let f=0;f<this.item.snapCoordinates.length;f++){let v=this.item.snapCoordinates[f],T={},x=null;switch(v.position){case"horizontal":T.left=this.itemCenterX-this.item.accurateBounds.width/2-v.value-this.itemCenterOffsetX,T.center=this.itemCenterX-v.value-this.itemCenterOffsetX,T.right=this.itemCenterX+this.item.accurateBounds.width/2-v.value-this.itemCenterOffsetX,Math.abs(T.left)<(e?this.snapDistanceTransformSnapped:this.snapDistanceTransform)?(this.itemCenterX=e?this.itemCenterX:v.value+this.item.accurateBounds.width/2+this.itemCenterOffsetX,x="left",e=!0):Math.abs(T.center)<(e?this.snapDistanceTransformSnapped:this.snapDistanceTransform)?(this.itemCenterX=e?this.itemCenterX:v.value+this.itemCenterOffsetX,x="center",e=!0):Math.abs(T.right)<(e?this.snapDistanceTransformSnapped:this.snapDistanceTransform)&&(this.itemCenterX=e?this.itemCenterX:v.value-this.item.accurateBounds.width/2+this.itemCenterOffsetX,x="right",e=!0),x&&(r.hasOwnProperty(x)||(r[x]={maskedSegment:null,rulerSegmentA:null,rulerSegmentB:null,values:[],axis:"y"}),r[x].values.push(v.bounds.top,v.bounds.bottom));break;case"vertical":T.top=this.itemCenterY-this.item.accurateBounds.height/2-v.value-this.itemCenterOffsetY,T.middle=this.itemCenterY-v.value-this.itemCenterOffsetY,T.bottom=this.itemCenterY+this.item.accurateBounds.height/2-v.value-this.itemCenterOffsetY,Math.abs(T.top)<(t?this.snapDistanceTransformSnapped:this.snapDistanceTransform)?(this.itemCenterY=t?this.itemCenterY:v.value+this.item.accurateBounds.height/2+this.itemCenterOffsetY,x="top",t=!0):Math.abs(T.middle)<(t?this.snapDistanceTransformSnapped:this.snapDistanceTransform)?(this.itemCenterY=t?this.itemCenterY:v.value+this.itemCenterOffsetY,x="middle",t=!0):Math.abs(T.bottom)<(t?this.snapDistanceTransformSnapped:this.snapDistanceTransform)&&(this.itemCenterY=t?this.itemCenterY:v.value-this.item.accurateBounds.height/2+this.itemCenterOffsetY,x="bottom",t=!0),x&&(r.hasOwnProperty(x)||(r[x]={maskedSegment:null,rulerSegmentA:null,rulerSegmentB:null,values:[],axis:"x"}),r[x].values.push(v.bounds.left,v.bounds.right));break}}BFN.TransformToolSnapGaps.clearSnapGaps();let a={left:null,top:null,right:null,bottom:null},s=new BFN.Rectangle(this.itemCenterX-this.item.accurateBounds.width/2-this.itemCenterOffsetX,this.itemCenterY-this.item.accurateBounds.height/2-this.itemCenterOffsetY,this.item.accurateBounds.width,this.item.accurateBounds.height),o=()=>{let f={left:null,top:null,right:null,bottom:null};return this.item.otherItemAccurateBoundsList.forEach(v=>{let T=s.neighbors(v);T&&(!f[T.side]||f[T.side].distance>T.distance)&&(f[T.side]=T)}),f},n=o(),l={horizontal:null,vertical:null},c=this.item.snapGapRects;for(let f in n){let v=n[f];if(v){let T=v.direction;for(let x in c[T])c[T][x].forEach(y=>{let F=v.intersectRect.neighbors(y);if(F&&F.direction===T&&!s.intersects(F.gapRect)){let b=x-v.distance;Math.abs(b)<this.snapDistanceTransform&&(["right","bottom"].includes(f)&&(b*=-1),l[T]===null&&(l[T]=b),Math.abs(b)<Math.abs(l[T])&&(l[T]=b))}})}}for(let f in l){let v=f==="horizontal"?n.left:n.top,T=f==="horizontal"?n.right:n.bottom;if(v&&T){let B=(v.distance+T.distance)/2-v.distance;Math.abs(B)<this.snapDistanceTransform&&(l[f]===null||l[f]!==null&&Math.abs(B)<Math.abs(l[f]))&&(l[f]=B,f==="horizontal"?a.left=a.right=!0:f==="vertical"&&(a.top=a.bottom=!0))}}for(let f in l)if(l[f])switch(f){case"horizontal":this.itemCenterX+=l[f];break;case"vertical":this.itemCenterY+=l[f];break}s.x=this.itemCenterX-this.item.accurateBounds.width/2-this.itemCenterOffsetX,s.y=this.itemCenterY-this.item.accurateBounds.height/2-this.itemCenterOffsetY,n=o();let h={horizontal:[],vertical:[]};for(let f in n){let v=n[f];if(v){let T=v.direction;for(let x in c[T])parseFloat(x).toFixed(1).toString()===(Math.round(v.distance*10)/10).toFixed(1).toString()&&c[T][x].forEach(y=>{let F=v.gapRect.neighbors(y);F&&F.direction===T&&l[T]!==null&&(h[T].includes(y)||h[T].push(y),a[f]=!0)})}}for(let f in n){let v=n[f];v&&a[f]&&h[v.direction].push(v.gapRect)}for(let f in h)h[f].forEach(T=>{let x=BFN.TransformToolSnapGaps.toLocal(new PIXI.Point(T.left,T.top),this),B=BFN.TransformToolSnapGaps.toLocal(new PIXI.Point(T.right,T.bottom),this),y=new BFN.Rectangle(x.x,x.y,B.x-x.x,B.y-x.y),F="";switch(f){case"horizontal":F+=(Math.round(T.width*10)/10).toFixed(1);break;case"vertical":F+=(Math.round(T.height*10)/10).toFixed(1);break}BFN.TransformToolSnapGaps.drawSnapGap(y,f,F)});let u={x:{a:this.itemCenterX-this.item.accurateBounds.width/2-this.itemCenterOffsetX,b:this.itemCenterX+this.item.accurateBounds.width/2-this.itemCenterOffsetX,c:this.itemCenterX-this.itemCenterOffsetX},y:{a:this.itemCenterY-this.item.accurateBounds.height/2-this.itemCenterOffsetY,b:this.itemCenterY+this.item.accurateBounds.height/2-this.itemCenterOffsetY,c:this.itemCenterY-this.itemCenterOffsetY}},d={x:{a:[],b:[]},y:{a:[],b:[]}},m=["left","center","right","top","middle","bottom"],p=["a","c","b"],g=["x","y"];m.forEach(f=>{if(r.hasOwnProperty(f)){let v=r[f],T=g[(g.indexOf(v.axis)+1)%2];v.maskedSegment={startPoint:new PIXI.Point,endPoint:new PIXI.Point},v.rulerSegmentA={startPoint:new PIXI.Point,endPoint:new PIXI.Point},v.rulerSegmentB={startPoint:new PIXI.Point,endPoint:new PIXI.Point},v.maskedSegment.startPoint[v.axis]=u[v.axis].a,v.maskedSegment.startPoint[T]=u[T][p[m.indexOf(f)%p.length]],v.maskedSegment.endPoint[v.axis]=u[v.axis].b,v.maskedSegment.endPoint[T]=u[T][p[m.indexOf(f)%p.length]],v.rulerSegmentA.startPoint[v.axis]=v.rulerSegmentA.endPoint[v.axis]=u[v.axis].a,v.rulerSegmentB.startPoint[v.axis]=v.rulerSegmentB.endPoint[v.axis]=u[v.axis].b,v.values.sort((_,E)=>_-E);for(let _=0;_<v.values.length;_++){let E=v.values[_],D=v.values[v.values.length-1-_];v.maskedSegment.startPoint[v.axis]=Math.min(v.maskedSegment.startPoint[v.axis],E,u[v.axis].a),v.maskedSegment.endPoint[v.axis]=Math.max(v.maskedSegment.startPoint[v.axis],E,u[v.axis].b),E<v.rulerSegmentA.endPoint[v.axis]-1&&(v.rulerSegmentA.startPoint[v.axis]=E),D>v.rulerSegmentB.startPoint[v.axis]+1&&(v.rulerSegmentB.endPoint[v.axis]=D)}v.maskedSegment.startPoint=this.toGlobal(v.maskedSegment.startPoint),v.maskedSegment.endPoint=this.toGlobal(v.maskedSegment.endPoint),v.rulerSegmentA.startPoint=this.toGlobal(v.rulerSegmentA.startPoint),v.rulerSegmentA.endPoint=this.toGlobal(v.rulerSegmentA.endPoint),v.rulerSegmentB.startPoint=this.toGlobal(v.rulerSegmentB.startPoint),v.rulerSegmentB.endPoint=this.toGlobal(v.rulerSegmentB.endPoint);let x=Math.round(v.rulerSegmentA.endPoint[v.axis]-v.rulerSegmentA.startPoint[v.axis]),B=Math.round(v.rulerSegmentB.endPoint[v.axis]-v.rulerSegmentB.startPoint[v.axis]);switch(d[v.axis].a.includes(x)?v.rulerSegmentA=null:d[v.axis].a.push(x),d[v.axis].b.includes(B)?v.rulerSegmentB=null:d[v.axis].b.push(B),f){case"top":case"middle":case"bottom":a.left&&(v.rulerSegmentA={startPoint:new PIXI.Point,endPoint:new PIXI.Point}),a.right&&(v.rulerSegmentB={startPoint:new PIXI.Point,endPoint:new PIXI.Point});break;case"left":case"center":case"right":a.top&&(v.rulerSegmentA={startPoint:new PIXI.Point,endPoint:new PIXI.Point}),a.bottom&&(v.rulerSegmentB={startPoint:new PIXI.Point,endPoint:new PIXI.Point});break}let y=this.transformLayer.toGlobal(new PIXI.Point(s.x,s.y)),F=this.transformLayer.toGlobal(new PIXI.Point(s.x+s.width,s.y+s.height)),b=new BFN.Rectangle(y.x,y.y,F.x-y.x,F.y-y.y),S=[];BFN.TransformToolSnapGaps.usedSnapGapLabels.forEach(_=>{let E=BFN.TransformToolSnapGaps.labelContainer.toGlobal(new PIXI.Point(_.x,_.y)),D=new BFN.Rectangle(E.x-_.width/2,E.y-_.height/2,_.width,_.height);D.intersectsLine(v.maskedSegment.startPoint,v.maskedSegment.endPoint)&&S.push(D)});let I=[v.maskedSegment];if(S.length){S.sort((ie,re)=>ie[v.axis]-re[v.axis]);let _=v.maskedSegment,E=_.startPoint[v.axis],D=_.endPoint[v.axis],w=_.endPoint[T],N=["right","bottom"],M=["left","top"],z=1,W,j,J=()=>{if(j>W){let ie=new PIXI.Point;ie[v.axis]=W,ie[T]=w;let re=new PIXI.Point;re[v.axis]=j,re[T]=w,I.push({startPoint:ie,endPoint:re})}};I.splice(0);for(let ie=0;ie<S.length;ie++){let re=S[ie];ie||(W=E),j=re[M[g.indexOf(v.axis)]]-z,J(),W=re[N[g.indexOf(v.axis)]]+z,ie===S.length-1&&(j=D,J())}}this.showSnapGuideLine(f,I,BFN.TransformModel.showMeasurements?[v.rulerSegmentA,v.rulerSegmentB]:null,b)}})}this.transformTool.x=this.itemCenterX,this.transformTool.y=this.itemCenterY,this.snapGuidesCleared||this.transformSnapGuides.hideLines(),this.transformSnapGuides.setCenter(this.itemCenterX-this.itemCenterOffsetX,this.itemCenterY-this.itemCenterOffsetY),this.transformSnapGuides.setDimensions(this.item.accurateBounds.width,this.item.accurateBounds.height),this.transformSnapGuides.showRulerLabels(),this.item.x=this.itemCenterX-Math.cos(this.hBeta+this.itemCenterBeta)*this.itemRadius,this.item.y=this.itemCenterY-Math.sin(this.hBeta+this.itemCenterBeta)*this.itemRadius,this.item.type=="group"&&this.item.updateGroupTransform()}this.item&&this.gizmoDragger.wasDragged&&this.item.updateHiResTextBounds()};ye.prototype.handleTransformGizmoDraggingComplete=function(i){!this.item,BFN.smoothPictureDisabled=!1;let e=null;this.item&&(this.item.transforming=!1,this.item.itemMoved&&(this.item.itemMoved=!1,this.item.type==="group"&&this.item.subSelectedItem&&(this.item.subSelectedItem=null),this.conformItemToBounds(),this.updateDisplay(),this.toggleItemTransform(!1),this.item.registerTransition(!1,!1)),this.item.subSelectedItem&&(e=this.item.subSelectedItem,this.item.subSelectedItem=null),e||(this.fadeAnimator.increase(),this.item.type=="group"&&this.item.fadeAnimator.increase()),BFN.TransformToolSnapGaps.clearSnapGaps(),BFN.TransformToolSnapGaps.hide(),this.item.updateHiResText()),BFN.TransformStateModel.stopBulkTransition(),e&&(e.selectedByMouse=!1,e.transformLayer.deselectItem(),e.transformLayer.lastPressedItem=e,e.transformLayer.clickItem(e,!0),e.transformLayer.selectItem(e))};ye.prototype.handleTextHandleDraggingStarted=function(i){if(BFN.smoothPictureDisabled=!0,this.item&&this.item.type=="text"){this.item.buttonMode=!1,this.item.clearDropShadow(),this.item.createTransition("history_resize_text"),BFN.FabricManager.showTransformItemIText(this.item);let e=this.item.iText;this.iTextData={topLeft:{x:e.left,y:e.top},topRight:{x:e.left+Math.cos(this.hBeta)*(e.width*e.scaleX),y:e.top+Math.sin(this.hBeta)*(e.width*e.scaleX)}};let t=this.item;this.itemData={topLeft:{x:t.x,y:t.y},topRight:{x:t.x+Math.cos(this.hBeta)*this.itemWidth,y:t.y+Math.sin(this.hBeta)*this.itemWidth}},this.handleTextHandleDragging(i)}};ye.prototype.handleTextHandleDragging=function(i){this.item&&this.item.type=="text"&&(this.resizeText(),this.item.toggleHiResText(!1))};ye.prototype.handleTextHandleDraggingComplete=function(i){this.item||BeFunky.throwError("Item was deselected before handleTextHandleDraggingComplete"),BFN.CursorScreen.cursorLock=!1,BFN.smoothPictureDisabled=!1,this.item&&(this.item.buttonMode=!0,this.item.transforming=!1,this.textHandleDragger.wasDragged?(this.item.setTextWidth(this.itemWidth),this.conformItemToBounds(),this.updateDisplayForTextResize(),this.item.registerTransition(),BFN.FabricManager.hideTransformItemIText(this.item)):(BFN.FabricManager.hideTransformItemIText(this.item),this.item.updateDropShadowSource()),(!this.currentTextHandle||this.currentTextHandle&&!this.currentTextHandle.hovered)&&(BFN.CursorScreen.cursor=null)),this.currentTextHandle&&(this.currentTextHandle.selected=!1,this.currentTextHandle=null),this.enableHandles(),this.item.transformLayer.enableChildren(),this.transformGizmo.x=this.transformGizmo.y=0,this.transformTool.x=this.itemCenterX,this.transformTool.y=this.itemCenterY,this.updateDisplay(),this.item&&this.item.updateHiResTextBounds()};ye.prototype.handleScaleHandleDraggingStarted=function(i){if(this.transformSnapGuidesContainer.alpha=1,this.transformSnapGuidesContainer.visible=!0,BFN.smoothPictureDisabled=!0,this.item){BFN.TransformModel.snappingEnabled&&(this.item.dispatchEvent(BFN.TransformItemEvents.GET_SNAP_COORDINATES),this.drawSnapHelpers&&(BFN.PhotoEditorCanvas.transformLayerVeil.opacity=0,this.snapLinesGraphic||(this.snapLinesGraphic=new PIXI.Graphics,BFN.PhotoEditorCanvas.canvas.addChild(this.snapLinesGraphic)),this.snapLinesGraphic.x=this.transformLayer.x,this.snapLinesGraphic.y=this.transformLayer.y,this.snapLinesGraphic.clear(),this.snapLinesGraphic.lineStyle(1,16711680),this.item.snapCoordinates.forEach(r=>{switch(r.position){case"horizontal":this.snapLinesGraphic.moveTo(r.value,-2e3),this.snapLinesGraphic.lineTo(r.value,2e3);break;case"vertical":this.snapLinesGraphic.moveTo(-2e3,r.value),this.snapLinesGraphic.lineTo(2e3,r.value);break}}),this.itemGuidesGraphic||(this.itemGuidesGraphic=new PIXI.Graphics,BFN.PhotoEditorCanvas.canvas.addChild(this.itemGuidesGraphic)),this.itemGuidesGraphic.x=this.transformLayer.x,this.itemGuidesGraphic.y=this.transformLayer.y,this.itemGuidesGraphic.clear())),this.item.buttonMode=!1;let e=this.item.isGoodie?"history_scale_graphic":"history_scale_image";switch(this.item.type){case"text":e="history_font_size";break;case"group":e="history_scale_selection";break}this.item.clearDropShadow(),this.item.createTransition(e),this.toggleItemTransform(!0),this.transformToolVO=UITools.getToolVO("transform")}};ye.prototype.handleScaleHandleDragging=function(i){if(this.snapDistanceTransform=this.screenPixelSnapThreshold*(1/this._scale),this.snapDistanceTransformSnapped=1/this._scale,this.snapGuidesCleared=!1,this.item&&this.currentScaleHandle){let e=this.sideHandleIDs.includes(this.currentScaleHandle.id),t=this.scaleHandleDragger.ctrlKey,r=this.scaleHandleDragger.shiftKey,a=this.scaleHandleDragger.altKey;if(this.item.type=="frame_texture"){let n=this.item.itemContent.frameSprite.frameScaling,l=this.item.itemContent.frameSprite.frameStretching,c=this.item.itemContent.frameSprite.frameScalingCentered,h=this.item.itemContent.frameSprite;t||e?(l&&(h.stopFrameStretching(),h.updateDisplay()),(!n||a!=c)&&h.startFrameScaling(this.getInverseFrameAnchorSide(),a)):(n&&h.stopFrameScaling(),r?l||h.startFrameStretching():l&&(h.stopFrameStretching(),h.updateDisplay()))}let s=!!(!["text","group"].includes(this.item.type)||this.item.isStretchable);(r||e)&&s?this.freeformScale():this.constrainedScale(),this.item.updateSmoothingScale();let o=n=>{n.basicShapeVO?n.updateShapeTexture(!1):n.borderBasicShapeVO&&n.updateBorderTexture(!1)};this.item===BFN.TransformItemGroup?this.item.selectedItems.forEach(n=>{o(n)}):o(this.item),this.snapGuidesCleared||this.transformSnapGuides.hideLines()}if(this.drawGizmo(),this.item&&BFN.TooltipScreen.active){let e=Math.round(this.item.itemContentW*this.item.scale.x),t=Math.round(this.item.itemContentH*this.item.scale.y);BFN.TooltipScreen.setMessage(e+" x "+t)}this.item&&this.item.updateHiResTextBounds()};ye.prototype.handleScaleHandleDraggingComplete=function(i){this.transformSnapGuidesContainer.alpha=0,this.transformSnapGuidesContainer.visible=!1,this.item||BeFunky.throwError("Item was deselected before handleScaleHandleDraggingComplete"),BFN.CursorScreen.cursorLock=!1,BFN.smoothPictureDisabled=!1,this.item&&this.item.type==="frame_texture"&&(this.item.itemContent.frameSprite.stopFrameScaling(),this.item.itemContent.frameSprite.stopFrameStretching()),this.conformItemToBounds(),this.toggleItemTransform(!1),this.item&&(this.item.buttonMode=!0,this.item.transforming=!1,this.scaleHandleDragger.wasDragged?(this.item.resetFrameTextureScale(),this.item.updateShapeTexture(),this.item.type=="group"?this.item.updateHitAreaOrTextWidths():this.item.type=="text"?this.item.setTextWidth(this.item.textItemContentW*this.item.scale.x,!0):this.item.updateHitArea(),this.item.ignoreTextHeight=!0,this.item.registerTransition(!1,this.item.type!="text"),delete this.item.ignoreTextHeight):this.item.type==="group"?BFN.TransformStateModel.stopBulkTransition():this.item.updateDropShadowSource(),this.item.updateSmoothingScale(),this.currentScaleHandle&&!this.currentScaleHandle.hovered&&(BFN.CursorScreen.cursor=null)),this.currentScaleHandle&&(this.currentScaleHandle.selected=!1),this.currentScaleHandle=null,this.enableHandles(),this.item?this.item.transformLayer.enableChildren():BFN.AppModel.sectionValue(BFN.PhotoEditorCanvas.transformLayer,BFN.CollageMakerCanvas.transformLayer,BFN.DesignerCanvas.transformLayer).enableChildren(),this.transformGizmo.x=this.transformGizmo.y=0,this.transformTool.x=this.itemCenterX,this.transformTool.y=this.itemCenterY,this.updateDisplay(),BFN.TooltipScreen.active&&BFN.TooltipScreen.hide()};ye.prototype.handleRotationHandleDraggingStarted=function(i){if(BFN.smoothPictureDisabled=!0,this.item){this.item.buttonMode=!1;let e=this.item.isGoodie?"history_rotate_graphic":"history_rotate_image";switch(this.item.type){case"text":e="history_rotate_text";break;case"group":e="history_rotate_selection";break}this.item.createTransition(e),this.toggleItemTransform(!0)}};ye.prototype.handleRotationHandleDragging=function(i){this.item&&this.constrainedRotate(),this.drawGizmo();let e=(Math.round((this.item.rotation+Math.PI*2)%(Math.PI*2)*(180/Math.PI)*2)/2).toFixed(1);BFN.TooltipScreen.setMessage(e+"\xB0"),this.item&&this.item.updateHiResTextBounds()};ye.prototype.handleRotationHandleDraggingComplete=function(i){this.item||BeFunky.throwError("Item was deselected before handleRotationHandleDraggingComplete"),BFN.CursorScreen.cursorLock=!1,BFN.smoothPictureDisabled=!1,this.conformItemToBounds(),this.toggleItemTransform(!1),this.item&&(this.item.buttonMode=!0,this.item.transforming=!1,this.rotationHandleDragger.wasDragged?this.item.registerTransition(!1,!0):this.item.type==="group"&&BFN.TransformStateModel.stopBulkTransition(),this.item.updateSmoothingScale(),this.rotationHandle.hovered||(BFN.CursorScreen.cursor=null)),this.rotationHandle.selected=!1,this.enableHandles(),this.item.transformLayer.enableChildren(),this.updateDisplay(),BFN.TooltipScreen.hide()};ye.prototype.handleFadeAnimatorUpdate=function(i){this.transformTool.alpha=this.fadeAnimator.animationFactor,this.transformTool.visible=this.transformTool.alpha>0,this.transformSnapGuidesContainer.alpha=1-this.fadeAnimator.animationFactor,this.transformSnapGuidesContainer.visible=this.transformSnapGuidesContainer.alpha>0};ye.prototype.handleFadeAnimatorUpdateComplete=function(i){this.transformSnapGuides.hideLines()};Object.defineProperty(ye.prototype,"scale",{set:function(i){this._scale=i;try{this.transformGizmoOutline.scale=this.transformGizmoHandle.scale=this._scale,this.transformSnapGuides.scale=this._scale,this.transformToolFrame.scale=this._scale,this.updateHandleScales(),this.updateTextHandlePosition(),this.updateScaleHandlePosition(),this.updateRotationHandlePosition(),this.drawGizmo()}catch(e){}},get:function(){return this._scale}});Object.defineProperty(ye.prototype,"transformSnapGuides",{get:function(){return this._transformSnapGuides||(this._transformSnapGuides=new BFN.TransformToolSnapGuides,this.transformSnapGuidesContainer.addChild(this._transformSnapGuides)),this._transformSnapGuides}});BFN.TransformTool=ye;function Fe(i){PIXI.Container.call(this),this.transformTool=i,this.init()}Fe.prototype=Object.create(PIXI.Container.prototype);Fe.prototype.init=function(){BeFunky.log("TransformToolFrame Init"),this.initDefaultValues(),this.initScaleHandleTextures(),this.initControlContainer(),this.initImageSprite(),this.initImageSpriteVeil(),this.initTouchSurfaces(),this.initFadeContainer(),this.initSpriteOutlines(),this.initScaleHandles(),this.initDraggers(),this.initFadeAnimator()};Fe.prototype.initDefaultValues=function(){this.active=!1,this.focusedFrameSprite=null,this.transformItem=null,this.currentScaleHandle=null,this.scaleControlBounds=null,this.scaleMode=null,this.scaleHandleIDs=["l","tl","t","tr","r","br","b","bl"],this.cornerHandleIDs=["tl","tr","br","bl"],this.sideHandleIDs=["l","t","r","b"],this.PId2=Math.PI/2,this.imageOutlinePadding=10,this.scaleAnchor=new PIXI.Point,this.scaleControl=new PIXI.Point,this._scale=1};Fe.prototype.initScaleHandleTextures=function(){this.handleTextureCorner=PIXI.RenderTexture.create(20,20,PIXI.settings.SCALE_MODE,window.bfn_resolution),BFN.graphics.drawShape("roundedRect",this.handleTextureCorner,{fillColor:268435456,cornerRadius:2,paddingX:1,paddingT:1.5,paddingB:9.5}),BFN.graphics.drawShape("roundedRect",this.handleTextureCorner,{fillColor:268435456,cornerRadius:2,paddingY:1,paddingL:1.5,paddingR:9.5,clear:!1}),BFN.graphics.drawShape("roundedRect",this.handleTextureCorner,{fillColor:4287274495,cornerRadius:1,paddingX:2,paddingT:2.5,paddingB:10.5,clear:!1}),BFN.graphics.drawShape("roundedRect",this.handleTextureCorner,{fillColor:4287274495,cornerRadius:1,paddingY:2,paddingL:2.5,paddingR:10.5,clear:!1}),BFN.graphics.drawShape("roundedRect",this.handleTextureCorner,{fillColor:4294967295,cornerRadius:1,paddingX:3,paddingT:3.5,paddingB:11.5,clear:!1}),BFN.graphics.drawShape("roundedRect",this.handleTextureCorner,{fillColor:4294967295,cornerRadius:1,paddingY:3,paddingL:3.5,paddingR:11.5,clear:!1}),this.handleTextureSide=PIXI.RenderTexture.create(20,20,PIXI.settings.SCALE_MODE,window.bfn_resolution),BFN.graphics.drawShape("roundedRect",this.handleTextureSide,{fillColor:268435456,cornerRadius:2,paddingY:5}),BFN.graphics.drawShape("roundedRect",this.handleTextureSide,{strokeWidth:1,strokeColor:4287274495,fillColor:4294967295,cornerRadius:1,paddingX:1,paddingY:6,clear:!1}),this.handleTextureCircle=PIXI.RenderTexture.create(24,24,PIXI.settings.SCALE_MODE,window.bfn_resolution),BFN.graphics.drawShape("ellipse",this.handleTextureCircle,{strokeWidth:1.5,strokeColor:4287274495,fillColor:4294967295,paddingX:4,paddingY:4,clear:!1})};Fe.prototype.initControlContainer=function(){this.controlContainer=new PIXI.Container,this.addChild(this.controlContainer)};Fe.prototype.initImageSprite=function(){this.imageSprite=new PIXI.Sprite,this.imageSprite.pluginName="smooth_picture",this.controlContainer.addChild(this.imageSprite)};Fe.prototype.initImageSpriteVeil=function(){this.imageSpriteVeil=new BFN.WindowedVeil(ht().hex,.6),this.controlContainer.addChild(this.imageSpriteVeil),ui(({hex:i})=>{this.imageSpriteVeil.color=i})};Fe.prototype.initTouchSurfaces=function(){this.imageTouchSurface=new PIXI.Graphics,this.imageTouchSurface.interactive=!0,this.imageTouchSurface.beginFill(0,0),this.imageTouchSurface.drawRect(0,0,100,100),this.imageTouchSurface.endFill(),this.imageTouchSurface.on("pointerover",this.handleTouchSurfaceOver.bind(this)),this.imageTouchSurface.on("pointerout",this.handleTouchSurfaceOut.bind(this)),this.imageTouchSurface.on("pointerdown",this.handleTouchSurfacePress.bind(this)),this.controlContainer.addChild(this.imageTouchSurface),this.frameTouchSurface=new PIXI.Graphics,this.frameTouchSurface.interactive=!0,this.frameTouchSurface.beginFill(0,0),this.frameTouchSurface.drawRect(0,0,100,100),this.frameTouchSurface.endFill(),this.frameTouchSurface.on("pointerover",this.handleTouchSurfaceOver.bind(this)),this.frameTouchSurface.on("pointerout",this.handleTouchSurfaceOut.bind(this)),this.frameTouchSurface.on("pointerdown",this.handleTouchSurfacePress.bind(this)),this.controlContainer.addChild(this.frameTouchSurface)};Fe.prototype.initFadeContainer=function(){this.fadeContainer=new PIXI.Container,this.controlContainer.addChild(this.fadeContainer)};Fe.prototype.initSpriteOutlines=function(){this.imageSpriteOutline=new BFN.StrokeRectangle(!0,!0,2,!0,4290824698,4287274495,"transform_tool_image_outline"),this.imageSpriteOutline.setDimensions(200,200),this.fadeContainer.addChild(this.imageSpriteOutline),this.frameSpriteOutline=new BFN.StrokeRectangle(!1,!0,1,!0,4290824698,4287274495,"transform_tool_frame_outline"),this.frameSpriteOutline.setDimensions(100,100),this.fadeContainer.addChild(this.frameSpriteOutline)};Fe.prototype.initScaleHandles=function(){this.scaleHandleContainer=new PIXI.Container,this.fadeContainer.addChild(this.scaleHandleContainer),this.imageScaleHandles={};for(let i=0;i<this.cornerHandleIDs.length;i++)this.imageScaleHandles[this.cornerHandleIDs[i]]=this.createScaleHandle(this.cornerHandleIDs[i],"image");this.frameScaleHandles={};for(let i=0;i<this.scaleHandleIDs.length;i++)this.frameScaleHandles[this.scaleHandleIDs[i]]=this.createScaleHandle(this.scaleHandleIDs[i],"frame")};Fe.prototype.initDraggers=function(){this.touchSurfaceDragger=new BFN.Dragger,this.touchSurfaceDragger.useBounds=!1,this.touchSurfaceDragger.autoDrag=!1,this.touchSurfaceDragger.preventSelectionDrag=!0,this.touchSurfaceDragger.deselectItemGroup=!1,this.touchSurfaceDragger.addEventListener(BFN.DraggerEvents.DRAGGING_STARTED.type,this.handleTouchSurfaceDraggingStarted.bind(this)),this.touchSurfaceDragger.addEventListener(BFN.DraggerEvents.DRAGGING.type,this.handleTouchSurfaceDragging.bind(this)),this.touchSurfaceDragger.addEventListener(BFN.DraggerEvents.DRAGGING_COMPLETE.type,this.handleTouchSurfaceDraggingComplete.bind(this)),this.scaleHandleDragger=new BFN.Dragger,this.scaleHandleDragger.useBounds=!1,this.scaleHandleDragger.autoDrag=!1,this.scaleHandleDragger.preventSelectionDrag=!0,this.scaleHandleDragger.deselectItemGroup=!1,this.scaleHandleDragger.addEventListener(BFN.DraggerEvents.DRAGGING_STARTED.type,this.handleScaleHandleDraggingStarted.bind(this)),this.scaleHandleDragger.addEventListener(BFN.DraggerEvents.DRAGGING.type,this.handleScaleHandleDragging.bind(this)),this.scaleHandleDragger.addEventListener(BFN.DraggerEvents.DRAGGING_COMPLETE.type,this.handleScaleHandleDraggingComplete.bind(this))};Fe.prototype.initFadeAnimator=function(){this.fadeAnimator=new BFN.Animator,this.fadeAnimator.addEventListener(BFN.AnimatorEvents.UPDATE.type,this.handleFadeAnimatorUpdate.bind(this)),this.fadeAnimator.setAnimatorFactor(0)};Fe.prototype.setup=function(i=null){try{this.imageSprite.texture.destroy(!1)}catch(e){}if(this.imageSprite.texture=PIXI.Texture.EMPTY,i&&i.type=="frame_texture"){let e=i!==this.transformItem;this.transformItem=i,this.focusedFrameSprite=this.transformItem.itemContent.frameSprite,this.imageSprite.renderable=!0,this.imageSprite.texture=new PIXI.Texture(this.focusedFrameSprite.baseTexture),this.imageSprite.texture.rotate=this.transformItem.flippedHorizontal?this.transformItem.flippedVertical?4:12:this.transformItem.flippedVertical?8:0,this.controlContainer.x=this.transformItem.x,this.controlContainer.y=this.transformItem.y,this.controlContainer.rotation=this.transformItem.rotation,this.updateImageTouchSurfaceDisplay(),this.updateFrameTouchSurfaceDisplay(),this.updateOutlineDisplays(),this.updateScaleHandlePositions(),this.updateImageSpriteDisplay(),this.fadeAnimator.increase(),this.active=!0,this.transformTool.fadeAnimator.decrease(),BFN.TransformModel.selectedTransformItem===this.transformItem&&(BFN.TransformModel.selectedTransformItem=this.transformItem),this.setScaleControlRange(),this.updateScaleControl(),setTimeout(()=>{this.transformItem&&(this.transformItem.renderable=!1,BFN.MainUI.renderCanvas(),e&&BFN.SentryManager.reportBreadcrumb(BFN.SentryManager.getDisplayObjectInfo(this.transformItem),"enter_crop_layer","app_action"))},50);let t=null;if(this.transformItem.itemContentMask&&!this.transformItem.isShape){let s=this.transformItem.itemContentMask.texture,o=new PIXI.Sprite(s),n=PIXI.RenderTexture.create(s.width,s.height);n.fillColor(16777215);let l=new PIXI.Sprite(n);l.mask=o,t=PIXI.RenderTexture.create(s.width,s.height),BFN.Stage.render(l,t),n.destroyGC(!0),l.mask=null,l.destroy(!0),o.destroy(!1)}let r=this.transformItem.maskFlippedHorizontal?!this.transformItem.flippedHorizontal:this.transformItem.flippedHorizontal,a=this.transformItem.maskFlippedVertical?!this.transformItem.flippedVertical:this.transformItem.flippedVertical;this.imageSpriteVeil.setMaskTexture(t||(this.transformItem.itemContentMask?this.transformItem.itemContentMask.texture:null),r,a),t&&t.destroyGC(!0)}else this.imageSprite.renderable=!1,this.fadeAnimator.decrease(),this.active=!1,this.transformTool.fadeAnimator.increase(),this.transformItem&&(BFN.SentryManager.reportBreadcrumb(BFN.SentryManager.getDisplayObjectInfo(this.transformItem),"exit_crop_layer","app_action"),BFN.TransformModel.selectedTransformItem===this.transformItem&&(BFN.TransformModel.selectedTransformItem=this.transformItem),this.transformItem.renderable=!0,this.transformItem=null,this.focusedFrameSprite=null);this.scale=this.scale,BFN.PIXITicker.nudge(),BFN.MainUI.tooltip=null,BFN.MainUI.requestRender()};Fe.prototype.setImageScale=function(i=1,e=!1){if(!this.transformItem){this.imageScaleObject&&delete this.imageScaleObject;return}if(i=Math.max(1,i),this.imageScaleObject||(this.imageScaleObject={}),this.imageScaleObject.scaling||(this.imageScaleObject.scaling=!0,this.imageScaleObject.scale=-1,this.imageScaleObject.imageBaseScale=1/Math.max(this.frameTouchSurface.width/this.imageTouchSurface.width,this.frameTouchSurface.height/this.imageTouchSurface.height),this.imageScaleObject.imageBaseWidth=this.imageTouchSurface.width,this.imageScaleObject.imageBaseHeight=this.imageTouchSurface.height,this.imageScaleObject.imageBaseOriginX=this.frameTouchSurface.x+this.frameTouchSurface.width/2-this.imageTouchSurface.x,this.imageScaleObject.imageBaseOriginY=this.frameTouchSurface.y+this.frameTouchSurface.height/2-this.imageTouchSurface.y,this.imageScaleObject.imageBaseOriginFactorX=this.imageScaleObject.imageBaseOriginX/this.imageScaleObject.imageBaseWidth,this.imageScaleObject.imageBaseOriginFactorY=this.imageScaleObject.imageBaseOriginY/this.imageScaleObject.imageBaseHeight,this.transformItem.clearDropShadow(),this.transformItem.createTransition("history_image_region")),this.imageScaleObject.scale!=i){this.imageScaleObject.scale=i;let t=i/this.imageScaleObject.imageBaseScale;this.imageTouchSurface.width=Math.max(this.frameTouchSurface.width,this.imageScaleObject.imageBaseWidth*t),this.imageTouchSurface.height=Math.max(this.frameTouchSurface.height,this.imageScaleObject.imageBaseHeight*t),this.imageTouchSurface.x=this.frameTouchSurface.x+this.frameTouchSurface.width/2-this.imageTouchSurface.width*this.imageScaleObject.imageBaseOriginFactorX,this.imageTouchSurface.y=this.frameTouchSurface.y+this.frameTouchSurface.height/2-this.imageTouchSurface.height*this.imageScaleObject.imageBaseOriginFactorY,this.imageTouchSurface.x=Math.min(this.frameTouchSurface.x,Math.max(this.frameTouchSurface.x+this.frameTouchSurface.width-this.imageTouchSurface.width,this.imageTouchSurface.x)),this.imageTouchSurface.y=Math.min(this.frameTouchSurface.y,Math.max(this.frameTouchSurface.y+this.frameTouchSurface.height-this.imageTouchSurface.height,this.imageTouchSurface.y)),this.updateImageOutlineDisplay(),this.updateImageScaleHandlePositions(),this.updateImageSpriteDisplay(),this.updateTransformItem(),this.updateImageSpriteVeilDisplay()}this.imageScaleObject.scaling&&!e&&(delete this.imageScaleObject,this.transformItem.updateContentDimensions(),this.transformItem.updateAccurateBounds(),this.transformItem.updateSmoothingScale(),this.transformItem.registerTransition(!1,!1),this.setup(this.transformItem))};Fe.prototype.setScaleControlRange=function(){if(!this.transformItem)return;let i=this.focusedFrameSprite,e=Math.max(this.frameTouchSurface.width/this.imageTouchSurface.width,this.frameTouchSurface.height/this.imageTouchSurface.height),t=this.imageTouchSurface.width*e,r=this.imageTouchSurface.height*e,a=this.transformTool.minSizeFrame,s=this.frameTouchSurface.width/a*i.baseWidth,o=this.frameTouchSurface.height/a*i.baseHeight,n=Math.min(s/t,o/r),l=UITools.getParamObject("layer_mask_image_crop_size");l.max=Math.max(100,Math.floor(n*100)),UITools.updateToolControl("layer_mask_image_crop_size")};Fe.prototype.updateScaleControl=function(){if(!this.transformItem)return;let i=1/Math.max(this.frameTouchSurface.width/this.imageTouchSurface.width,this.frameTouchSurface.height/this.imageTouchSurface.height),e=Math.floor(i*100),t=UITools.getParamObject("layer_mask_image_crop_size");t.max=Math.max(100,e,t.max),UITools.setControlValue("layer_mask_image_crop_size",e),UITools.updateToolControl("layer_mask_image_crop_size")};Fe.prototype.updateTransformItem=function(){if(this.transformItem){let i=this.focusedFrameSprite,e=this.frameTouchSurface.width,t=this.frameTouchSurface.height,r=i.baseWidth,a=i.baseHeight,s=Math.max(e/r,t/a),o=r*s,n=a*s,l=this.imageTouchSurface.width,c=this.imageTouchSurface.height,h=this.imageTouchSurface.width-this.frameTouchSurface.width,u=this.imageTouchSurface.height-this.frameTouchSurface.height;i.frameWidth=e,i.frameHeight=t,i.textureScaleX=l/o,i.textureScaleY=c/n,i.offsetFactorX=h?Math.max(0,Math.min(1,(this.frameTouchSurface.x-this.imageTouchSurface.x)/h)):.5,i.offsetFactorY=u?Math.max(0,Math.min(1,(this.frameTouchSurface.y-this.imageTouchSurface.y)/u)):.5,this.transformItem.flippedHorizontal&&(i.offsetFactorX=1-i.offsetFactorX),this.transformItem.flippedVertical&&(i.offsetFactorY=1-i.offsetFactorY),i.updateDisplay();let d=this.frameTouchSurface.x,m=this.frameTouchSurface.y,p=Math.sqrt(d**2+m**2),g=Math.atan2(m,d)+this.transformItem.rotation;this.transformItem.x=this.controlContainer.x+Math.cos(g)*p,this.transformItem.y=this.controlContainer.y+Math.sin(g)*p,this.transformItem.itemContent.x=this.transformItem.flippedHorizontal?this.frameTouchSurface.width:0,this.transformItem.itemContent.y=this.transformItem.flippedVertical?this.frameTouchSurface.height:0}};Fe.prototype.updateImageSpriteDisplay=function(){this.updateImageSpriteDimensions(),this.updateImageSpritePosition()};Fe.prototype.updateImageSpriteDimensions=function(){this.imageSprite.width=this.imageTouchSurface.width,this.imageSprite.height=this.imageTouchSurface.height,this.updateImageSpriteSmoothing()};Fe.prototype.updateImageSpritePosition=function(){this.imageSprite.x=this.imageTouchSurface.x,this.imageSprite.y=this.imageTouchSurface.y};Fe.prototype.updateImageSpriteSmoothing=function(){this.imageSprite.currentScale=this.imageSprite.scale.x*this._scale,this.imageSprite.currentScaleY=this.imageSprite.scale.y*this._scale};Fe.prototype.updateImageSpriteVeilDisplay=function(){this.imageSpriteVeil.x=this.imageTouchSurface.x,this.imageSpriteVeil.y=this.imageTouchSurface.y,this.imageSpriteVeil.update(this.imageTouchSurface.width,this.imageTouchSurface.height,this.frameTouchSurface.x-this.imageTouchSurface.x,this.frameTouchSurface.y-this.imageTouchSurface.y,this.frameTouchSurface.width,this.frameTouchSurface.height)};Fe.prototype.updateImageTouchSurfaceDisplay=function(){this.updateImageTouchSurfaceDimensions(),this.updateImageTouchSurfacePosition()};Fe.prototype.updateImageTouchSurfaceDimensions=function(){this.transformItem&&(this.imageTouchSurface.width=Math.abs(this.focusedFrameSprite.imageRect.width),this.imageTouchSurface.height=Math.abs(this.focusedFrameSprite.imageRect.height),this.updateImageSpriteDimensions(),this.updateImageSpriteVeilDisplay())};Fe.prototype.updateImageTouchSurfacePosition=function(){this.transformItem&&(this.imageTouchSurface.x=this.transformItem.flippedHorizontal?Math.abs(this.focusedFrameSprite.imageRect.x)+Math.abs(this.focusedFrameSprite.width)-Math.abs(this.focusedFrameSprite.imageRect.width):this.focusedFrameSprite.imageRect.x,this.imageTouchSurface.y=this.transformItem.flippedVertical?Math.abs(this.focusedFrameSprite.imageRect.y)+Math.abs(this.focusedFrameSprite.height)-Math.abs(this.focusedFrameSprite.imageRect.height):this.focusedFrameSprite.imageRect.y,this.updateImageSpriteVeilDisplay())};Fe.prototype.updateImageTouchSurfaceHitArea=function(){let i=this.imageOutlinePadding/(this._scale*this.imageTouchSurface.scale.x),e=this.imageOutlinePadding/(this._scale*this.imageTouchSurface.scale.y);this.imageTouchSurface.hitArea=new PIXI.Rectangle(-i,-e,this.imageTouchSurface.width/this.imageTouchSurface.scale.x+i*2,this.imageTouchSurface.height/this.imageTouchSurface.scale.y+e*2)};Fe.prototype.updateFrameTouchSurfaceDisplay=function(){this.updateFrameTouchSurfaceDimensions(),this.updateFrameTouchSurfacePosition()};Fe.prototype.updateFrameTouchSurfaceDimensions=function(){this.transformItem&&(this.frameTouchSurface.width=Math.abs(this.focusedFrameSprite.width),this.frameTouchSurface.height=Math.abs(this.focusedFrameSprite.height),this.updateImageSpriteVeilDisplay())};Fe.prototype.updateFrameTouchSurfacePosition=function(){this.transformItem&&(this.frameTouchSurface.x=0,this.frameTouchSurface.y=0,this.updateImageSpriteVeilDisplay())};Fe.prototype.updateOutlineDisplays=function(){this.updateFrameOutlineDisplay(),this.updateImageOutlineDisplay()};Fe.prototype.updateImageOutlineDisplay=function(){this.updateImageOutlineDimensions(),this.updateImageOutlinePosition()};Fe.prototype.updateImageOutlineDimensions=function(){this.imageSpriteOutline.setDimensions(this.imageTouchSurface.width+this.imageOutlinePadding/this._scale*2,this.imageTouchSurface.height+this.imageOutlinePadding/this._scale*2)};Fe.prototype.updateImageOutlinePosition=function(){this.imageSpriteOutline.x=this.imageTouchSurface.x+this.imageTouchSurface.width/2,this.imageSpriteOutline.y=this.imageTouchSurface.y+this.imageTouchSurface.height/2};Fe.prototype.updateFrameOutlineDisplay=function(){this.updateFrameOutlineDimensions(),this.updateFrameOutlinePosition()};Fe.prototype.updateFrameOutlineDimensions=function(){this.frameSpriteOutline.setDimensions(this.frameTouchSurface.width,this.frameTouchSurface.height)};Fe.prototype.updateFrameOutlinePosition=function(){this.frameSpriteOutline.x=this.frameTouchSurface.x+this.frameTouchSurface.width/2,this.frameSpriteOutline.y=this.frameTouchSurface.y+this.frameTouchSurface.height/2};Fe.prototype.updateScaleHandlePositions=function(){this.updateFrameScaleHandlePositions(),this.updateImageScaleHandlePositions()};Fe.prototype.updateImageScaleHandlePositions=function(){for(let i in this.imageScaleHandles){let e=this.imageScaleHandles[i];e.noPaddingX=this.imageSpriteOutline.x,e.noPaddingY=this.imageSpriteOutline.y,e.id.includes("l")&&(e.noPaddingX-=this.imageTouchSurface.width/2),e.id.includes("r")&&(e.noPaddingX+=this.imageTouchSurface.width/2),e.id.includes("t")&&(e.noPaddingY-=this.imageTouchSurface.height/2),e.id.includes("b")&&(e.noPaddingY+=this.imageTouchSurface.height/2),e.id.includes("l")&&(e.x=e.noPaddingX-this.imageOutlinePadding/this._scale),e.id.includes("r")&&(e.x=e.noPaddingX+this.imageOutlinePadding/this._scale),e.id.includes("t")&&(e.y=e.noPaddingY-this.imageOutlinePadding/this._scale),e.id.includes("b")&&(e.y=e.noPaddingY+this.imageOutlinePadding/this._scale)}};Fe.prototype.updateFrameScaleHandlePositions=function(){for(let i in this.frameScaleHandles){let e=this.frameScaleHandles[i];e.noPaddingX=this.frameSpriteOutline.x,e.noPaddingY=this.frameSpriteOutline.y,e.id.includes("l")&&(e.noPaddingX-=this.frameTouchSurface.width/2),e.id.includes("r")&&(e.noPaddingX+=this.frameTouchSurface.width/2),e.id.includes("t")&&(e.noPaddingY-=this.frameTouchSurface.height/2),e.id.includes("b")&&(e.noPaddingY+=this.frameTouchSurface.height/2),e.x=e.noPaddingX,e.y=e.noPaddingY}};Fe.prototype.updateFrameScaleHandleDisplay=function(){let i=this.frameSpriteOutline.width*this._scale,e=this.frameSpriteOutline.height*this._scale,t=this.handleTextureCorner.width+this.handleTextureSide.width-2;for(let r in this.frameScaleHandles){let a=this.frameScaleHandles[r];switch(a.type){case"corner":break;case"side":a.active=a.horizontal?e>t:i>t;break}}};Fe.prototype.updateOutlineScales=function(){this.frameSpriteOutline.scale=this._scale,this.imageSpriteOutline.scale=this._scale};Fe.prototype.updateScaleHandleScales=function(){for(let i in this.frameScaleHandles){let e=this.frameScaleHandles[i];e.scale.x=e.scale.y=1/this._scale}for(let i in this.imageScaleHandles){let e=this.imageScaleHandles[i];e.scale.x=e.scale.y=1/this._scale}};Fe.prototype.toggleInteraction=function(i,e=null){i=!!i,this.imageTouchSurface.interactive=i||!i&&this.imageTouchSurface==e,this.frameTouchSurface.interactive=i||!i&&this.frameTouchSurface==e;for(let t in this.imageScaleHandles){let r=this.imageScaleHandles[t];(i||r!=e)&&(r.interactive=i)}for(let t in this.frameScaleHandles){let r=this.frameScaleHandles[t];(i||r!=e)&&(r.interactive=i)}this.transformTool.transformLayer.interactiveChildren=i};Fe.prototype.updateCursorOrientation=function(i){if(i){let e=i.group+"SpriteOutline",t=this.hasOwnProperty(e)?this[e]:null;if(t){let r=this.controlContainer.toGlobal(new PIXI.Point(i.noPaddingX,i.noPaddingY)),a=this.controlContainer.toGlobal(new PIXI.Point(t.x,t.y));BFN.CursorScreen.cursorRotation=Math.atan2(a.y-r.y,a.x-r.x)}}};Fe.prototype.dragImage=function(){let i=this.controlContainer.getPointerPosition(BFN.MainUI.pointerEvent),e=i.x-this.containerMouseDownPoint.x,t=i.y-this.containerMouseDownPoint.y,r=this.imageTouchSurface.width-this.frameTouchSurface.width,a=this.imageTouchSurface.height-this.frameTouchSurface.height,s=this.frameTouchSurface.x-r,o=this.frameTouchSurface.x,n=this.frameTouchSurface.y-a,l=this.frameTouchSurface.y,c=this.containerItemStartPoint.x+e,h=this.containerItemStartPoint.y+t;this.containerMouseDownPoint.x+=Math.min(0,c-s)+Math.max(0,c-o),this.containerMouseDownPoint.y+=Math.min(0,h-n)+Math.max(0,h-l),this.imageTouchSurface.x=Math.max(s,Math.min(o,c)),this.imageTouchSurface.y=Math.max(n,Math.min(l,h)),this.updateImageOutlinePosition(),this.updateImageScaleHandlePositions(),this.updateTransformItem(),this.updateImageSpritePosition(),this.updateImageSpriteVeilDisplay()};Fe.prototype.dragFrame=function(){let i=this.controlContainer.getPointerPosition(BFN.MainUI.pointerEvent),e=i.x-this.containerMouseDownPoint.x,t=i.y-this.containerMouseDownPoint.y,r=this.imageTouchSurface.width-this.frameTouchSurface.width,a=this.imageTouchSurface.height-this.frameTouchSurface.height,s=this.imageTouchSurface.x,o=this.imageTouchSurface.x+r,n=this.imageTouchSurface.y,l=this.imageTouchSurface.y+a,c=this.containerItemStartPoint.x+e,h=this.containerItemStartPoint.y+t;this.containerMouseDownPoint.x+=Math.min(0,c-s)+Math.max(0,c-o),this.containerMouseDownPoint.y+=Math.min(0,h-n)+Math.max(0,h-l),this.frameTouchSurface.x=Math.max(s,Math.min(o,c)),this.frameTouchSurface.y=Math.max(n,Math.min(l,h)),this.updateFrameOutlinePosition(),this.updateFrameScaleHandlePositions(),this.updateTransformItem(),this.updateImageSpriteVeilDisplay()};Fe.prototype.updateScaleControlBounds=function(){if(this.scaleControlBounds={},!this.currentScaleHandle||!this.transformItem||!this.scaleMode)return;let i=this.getInverseScaleHandle(this.currentScaleHandle);this.scaleAnchor.x=i.noPaddingX,this.scaleAnchor.y=i.noPaddingY;let e=this.currentScaleHandle,t=this.focusedFrameSprite,r=this.scaleHandleDragger.altKey,a=new BFN.Rectangle(this.imageTouchSurface.x,this.imageTouchSurface.y,this.imageTouchSurface.width,this.imageTouchSurface.height),s=new BFN.Rectangle(this.frameTouchSurface.x,this.frameTouchSurface.y,this.frameTouchSurface.width,this.frameTouchSurface.height),o=this.transformTool.minSizeFrame,n=Math.max(o,a.width/t.baseWidth*o),l=Math.max(o,a.height/t.baseHeight*o),c=s.width/o*t.baseWidth,h=s.height/o*t.baseHeight;switch(e.type){case"corner":let u=e.id.includes("l")?e:i,d=e.id.includes("r")?e:i,m=d.noPaddingX-u.noPaddingX,p=d.noPaddingY-u.noPaddingY,g=Math.atan2(p,m),f=g+Math.PI/2;this.scaleControlBounds.slope=Math.sin(f)/Math.cos(f),this.scaleControlBounds.beta=g,this.scaleControlBounds.sign=e.noPaddingY-this.scaleAnchor.y<this.scaleControlBounds.slope*(e.noPaddingX-this.scaleAnchor.x)?-1:1;break;case"side":break}switch(e.group){case"image":if(this.scaleControlBounds.center=a.centerX,this.scaleControlBounds.middle=a.centerY,this.scaleControlBounds.ratio=a.height/a.width,this.scaleControlBounds.maxDiagonal=Math.min(Math.sqrt(c**2+(c*this.scaleControlBounds.ratio)**2),Math.sqrt(h**2+(h/this.scaleControlBounds.ratio)**2))/(r?2:1),this.scaleMode&&this.scaleMode.includes("freeform"))e.id.includes("l")&&(this.scaleControlBounds.right=r?Math.min(s.left,a.left+(a.right-s.right)):s.left,this.scaleControlBounds.left=r?a.centerX-c/2:a.right-c),e.id.includes("t")&&(this.scaleControlBounds.bottom=r?Math.min(s.top,a.top+(a.bottom-s.bottom)):s.top,this.scaleControlBounds.top=r?a.centerY-h/2:a.bottom-h),e.id.includes("r")&&(this.scaleControlBounds.left=r?Math.max(s.right,a.right-(s.left-a.left)):s.right,this.scaleControlBounds.right=r?a.centerX+c/2:a.left+c),e.id.includes("b")&&(this.scaleControlBounds.top=r?Math.max(s.bottom,a.bottom-(s.top-a.top)):s.bottom,this.scaleControlBounds.bottom=r?a.centerY+h/2:a.top+h),e.type==="side"&&(e.horizontal?this.scaleControlBounds.top=this.scaleControlBounds.bottom=a.centerY:this.scaleControlBounds.left=this.scaleControlBounds.right=a.centerX);else if(this.scaleMode.includes("constrained"))switch(this.scaleControlBounds.minDiagonal=0,e.type){case"corner":let u,d;r?(u=Math.max(s.right-a.centerX,a.centerX-s.left),d=Math.max(s.bottom-a.centerY,a.centerY-s.top)):(e.id.includes("l")&&(u=a.right-s.left),e.id.includes("t")&&(d=a.bottom-s.top),e.id.includes("r")&&(u=s.right-a.left),e.id.includes("b")&&(d=s.bottom-a.top));let m=u*this.scaleControlBounds.ratio,p=d/this.scaleControlBounds.ratio,g=Math.sqrt(u**2+m**2),f=Math.sqrt(d**2+p**2);this.scaleControlBounds.minDiagonal=Math.max(g,f);break;case"side":break}break;case"frame":if(this.scaleControlBounds.center=s.centerX,this.scaleControlBounds.middle=s.centerY,this.scaleControlBounds.ratio=s.height/s.width,this.scaleControlBounds.minDiagonal=Math.max(Math.sqrt(n**2+(n*this.scaleControlBounds.ratio)**2),Math.sqrt(l**2+(l/this.scaleControlBounds.ratio)**2))/(r?2:1),this.scaleMode.includes("freeform"))e.id.includes("l")&&(this.scaleControlBounds.left=r?Math.max(a.left,s.left-(a.right-s.right)):a.left,this.scaleControlBounds.right=r?s.centerX-n/2:s.right-n),e.id.includes("t")&&(this.scaleControlBounds.top=r?Math.max(a.top,s.top-(a.bottom-s.bottom)):a.top,this.scaleControlBounds.bottom=r?s.centerY-l/2:s.bottom-l),e.id.includes("r")&&(this.scaleControlBounds.right=r?Math.min(a.right,s.right+(s.left-a.left)):a.right,this.scaleControlBounds.left=r?s.centerX+n/2:s.left+n),e.id.includes("b")&&(this.scaleControlBounds.bottom=r?Math.min(a.bottom,s.bottom+(s.top-a.top)):a.bottom,this.scaleControlBounds.top=r?s.centerY+l/2:s.top+l),e.type==="side"&&(e.horizontal?this.scaleControlBounds.top=this.scaleControlBounds.bottom=s.centerY:this.scaleControlBounds.left=this.scaleControlBounds.right=s.centerX);else if(this.scaleMode.includes("constrained"))switch(this.scaleControlBounds.maxDiagonal=0,e.type){case"corner":let u,d;r?(u=Math.min(a.right-s.centerX,s.centerX-a.left),d=Math.min(a.bottom-s.centerY,s.centerY-a.top)):(e.id.includes("l")&&(u=s.right-a.left),e.id.includes("t")&&(d=s.bottom-a.top),e.id.includes("r")&&(u=a.right-s.left),e.id.includes("b")&&(d=a.bottom-s.top));let m=u*this.scaleControlBounds.ratio,p=d/this.scaleControlBounds.ratio,g=Math.sqrt(u**2+m**2),f=Math.sqrt(d**2+p**2);this.scaleControlBounds.maxDiagonal=Math.min(g,f);break;case"side":break}break}};Fe.prototype.freeformScale=function(){let i=this.currentScaleHandle,e=this.scaleHandleDragger.altKey,t=this.controlContainer.getPointerPosition(BFN.MainUI.pointerEvent);this.scaleControl.x=t.x,this.scaleControl.y=t.y,i.group==="image"&&(i.id.includes("l")&&(this.scaleControl.x+=this.imageOutlinePadding/this._scale),i.id.includes("r")&&(this.scaleControl.x-=this.imageOutlinePadding/this._scale),i.id.includes("t")&&(this.scaleControl.y+=this.imageOutlinePadding/this._scale),i.id.includes("b")&&(this.scaleControl.y-=this.imageOutlinePadding/this._scale)),this.scaleControlBounds&&(this.scaleControlBounds.hasOwnProperty("left")&&(this.scaleControl.x=Math.max(this.scaleControlBounds.left,this.scaleControl.x)),this.scaleControlBounds.hasOwnProperty("right")&&(this.scaleControl.x=Math.min(this.scaleControlBounds.right,this.scaleControl.x)),this.scaleControlBounds.hasOwnProperty("top")&&(this.scaleControl.y=Math.max(this.scaleControlBounds.top,this.scaleControl.y)),this.scaleControlBounds.hasOwnProperty("bottom")&&(this.scaleControl.y=Math.min(this.scaleControlBounds.bottom,this.scaleControl.y)));let r=i.group==="image"?this.imageTouchSurface:this.frameTouchSurface,a=()=>{r.width=Math.abs(e?(this.scaleControlBounds.center-this.scaleControl.x)*2:this.scaleAnchor.x-this.scaleControl.x),r.x=e?this.scaleControlBounds.center-r.width/2:i.id.includes("l")?this.scaleControl.x:this.scaleAnchor.x},s=()=>{r.height=Math.abs(e?(this.scaleControlBounds.middle-this.scaleControl.y)*2:this.scaleAnchor.y-this.scaleControl.y),r.y=e?this.scaleControlBounds.middle-r.height/2:i.id.includes("t")?this.scaleControl.y:this.scaleAnchor.y};switch(i.type){case"corner":a(),s();break;case"side":i.horizontal?a():s();break}};Fe.prototype.constrainedScale=function(){let i=this.currentScaleHandle,e=this.scaleHandleDragger.altKey,t=this.controlContainer.getPointerPosition(BFN.MainUI.pointerEvent);this.scaleControl.x=t.x,this.scaleControl.y=t.y,i.group==="image"&&(i.id.includes("l")&&(this.scaleControl.x+=this.imageOutlinePadding/this._scale),i.id.includes("r")&&(this.scaleControl.x-=this.imageOutlinePadding/this._scale),i.id.includes("t")&&(this.scaleControl.y+=this.imageOutlinePadding/this._scale),i.id.includes("b")&&(this.scaleControl.y-=this.imageOutlinePadding/this._scale));let r=new PIXI.Point(this.scaleControl.x-(e?this.scaleControlBounds.center:this.scaleAnchor.x),this.scaleControl.y-(e?this.scaleControlBounds.middle:this.scaleAnchor.y)),a=this.getPointToLineDistance(r,this.scaleControlBounds.slope);(r.y<this.scaleControlBounds.slope*r.x?-1:1)!=this.scaleControlBounds.sign&&(a=this.scaleControlBounds.minDiagonal),i.type==="corner"&&(a=Math.min(this.scaleControlBounds.maxDiagonal,Math.max(this.scaleControlBounds.minDiagonal,a)));let o=i.group==="image"?this.imageTouchSurface:this.frameTouchSurface;switch(i.type){case"corner":o.width=Math.abs(Math.cos(this.scaleControlBounds.beta)*a*(e?2:1)),o.height=Math.abs(Math.sin(this.scaleControlBounds.beta)*a*(e?2:1));break;case"side":break}if(e)o.x=this.scaleControlBounds.center-o.width/2,o.y=this.scaleControlBounds.middle-o.height/2;else switch(i.type){case"corner":switch(i.id){case"tl":o.x=this.scaleAnchor.x-o.width,o.y=this.scaleAnchor.y-o.height;break;case"tr":o.x=this.scaleAnchor.x,o.y=this.scaleAnchor.y-o.height;break;case"br":o.x=this.scaleAnchor.x,o.y=this.scaleAnchor.y;break;case"bl":o.x=this.scaleAnchor.x-o.width,o.y=this.scaleAnchor.y;break}break;case"side":break}};Fe.prototype.createScaleHandle=function(i,e){this.scaleHandles||(this.scaleHandles=[]);let t=new BFN.HoverButton;return t.buttonMode=!1,t.id=i,t.group=e,t.type=this.sideHandleIDs.includes(i)?"side":"corner",t.horizontal=["l","r"].includes(i),t.texture=e=="image"?this.handleTextureCircle:t.type=="side"?this.handleTextureSide:this.handleTextureCorner,t.rotation=t.horizontal?Math.PI/2:t.type=="corner"?this.cornerHandleIDs.indexOf(i)*(Math.PI/2):0,t.on("pointerover",this.handleScaleHandleOver.bind(this)),t.on("pointerout",this.handleScaleHandleOut.bind(this)),t.handlePress=this.handleScaleHandlePress.bind(this),t.hoverButtonGroup=this.scaleHandles,this.scaleHandleContainer.addChild(t),this.scaleHandles.push(t),e=="frame"&&this.cornerHandleIDs.includes(i)&&(t.buttonSprite.anchor.x=t.buttonSprite.anchor.y=.3),BeFunky.isMobile&&t.setHitAreaCircle(22),t};Fe.prototype.getInverseScaleHandle=function(i){let e=null;if(i&&i.group&&i.id){let t;switch(i.group){case"image":t=this.cornerHandleIDs.indexOf(i.id),t>=0&&(e=this.imageScaleHandles[this.cornerHandleIDs[(t+2)%this.cornerHandleIDs.length]]);break;case"frame":t=this.scaleHandleIDs.indexOf(i.id),t>=0&&(e=this.frameScaleHandles[this.scaleHandleIDs[(t+4)%this.scaleHandleIDs.length]]);break}}return e};Fe.prototype.getPointToLineDistance=function(i,e){if(e==0)return Math.abs(i.y);if(e==1/0)return Math.abs(i.x);{let t=(i.y+1/e*i.x)/(e- -1/e),r=e*t;return Math.sqrt(Math.pow(t-i.x,2)+Math.pow(r-i.y,2))}};Fe.prototype.handleTouchSurfaceOver=function(i){let e=i.target;setTimeout(()=>{if(this.transformTool.item&&i.target)switch(BFN.CursorScreen.cursor="move",e){case this.imageTouchSurface:this.imageSpriteOutline.hovered=!0,this.imageSpriteOutline.highlight=!0;break;case this.frameTouchSurface:this.frameSpriteOutline.hovered=!0,this.frameSpriteOutline.highlight=!0;break}},0)};Fe.prototype.handleTouchSurfaceOut=function(i){this.imageSpriteOutline.hovered=!1,this.frameSpriteOutline.hovered=!1,this.touchSurfaceDragger.dragging||(BFN.CursorScreen.cursor=null,this.imageSpriteOutline.highlight=!1,this.frameSpriteOutline.highlight=!1)};Fe.prototype.handleTouchSurfacePress=function(i){if(this.transformItem){BFN.CursorScreen.cursorLock=!0,this.transformItem.transforming=!0;let e=i.target;this.toggleInteraction(!1,e),this.containerMouseDownPoint=this.controlContainer.getPointerPosition(BFN.MainUI.pointerEvent),this.containerItemStartPoint=new PIXI.Point(e.x,e.y),this.touchSurfaceDragger.drag(e),i.stopPropagation()}};Fe.prototype.handleScaleHandleOver=function(i){let e=i.target;setTimeout(function(){this.transformItem&&i.target&&(BFN.CursorScreen.cursor="arrow",e.parent.setChildIndex(e,e.parent.children.length-1),this.updateCursorOrientation(e),this.sideHandleIDs.includes(e.id)||(BFN.MainUI.tooltip="scaling_tooltip"))}.bind(this),0)};Fe.prototype.handleScaleHandleOut=function(i){this.scaleHandleDragger.dragging||(BFN.CursorScreen.cursor=null),BFN.MainUI.tooltip=null};Fe.prototype.handleScaleHandlePress=function(i){if(this.transformItem){BFN.CursorScreen.cursorLock=!0,this.transformItem.transforming=!0,this.currentScaleHandle=i.target,this.currentScaleHandle.selected=!0,this.toggleInteraction(!1,this.currentScaleHandle),this.scaleHandleDragger.drag(this.currentScaleHandle);let e=Math.round(this.currentScaleHandle.group==="frame"?this.frameTouchSurface.width:this.imageTouchSurface.width),t=Math.round(this.currentScaleHandle.group==="frame"?this.frameTouchSurface.height:this.imageTouchSurface.height);BFN.TooltipScreen.show(e+" x "+t,!0,!0),BFN.TooltipScreen.setPosition(i.data.originalEvent.clientX,i.data.originalEvent.clientY,{onCanvas:!0}),i.stopPropagation()}};Fe.prototype.handleTouchSurfaceDraggingStarted=function(i){if(BFN.smoothPictureDisabled=!0,this.transformItem){let e="invalid_frame_transform_move",t=this.touchSurfaceDragger.item;if(t)switch(t){case this.imageTouchSurface:e="history_image_region";break;case this.frameTouchSurface:e="history_move_image";break}this.transformItem.clearDropShadow(),this.transformItem.createTransition(e)}};Fe.prototype.handleTouchSurfaceDragging=function(i){switch(this.touchSurfaceDragger.item){case this.imageTouchSurface:this.dragImage();break;case this.frameTouchSurface:this.dragFrame();break}};Fe.prototype.handleTouchSurfaceDraggingComplete=function(i){this.imageSpriteOutline.highlight=this.imageSpriteOutline.hovered,this.frameSpriteOutline.highlight=this.frameSpriteOutline.hovered,BFN.CursorScreen.cursorLock=!1,BFN.smoothPictureDisabled=!1,this.toggleInteraction(!0),this.transformItem&&(this.transformItem.transforming=!1,this.touchSurfaceDragger.draggedItem===this.frameTouchSurface&&(this.transformItem.transformTool.updateTransformValues(),this.transformItem.transformTool.conformItemToBounds()),this.transformItem.updateContentDimensions(),this.transformItem.updateSmoothingScale(),this.setup(this.transformItem),this.transformTool.updateDisplay(),this.transformItem.registerTransition(!1))};Fe.prototype.handleScaleHandleDraggingStarted=function(i){if(BFN.smoothPictureDisabled=!0,this.transformItem){let e="invalid_frame_transform_scale",t=this.scaleHandleDragger.item;if(t)switch(t.group){case"image":e="history_image_region";break;case"frame":e="history_scale_image";break}this.transformItem.clearDropShadow(),this.transformItem.createTransition(e),this.transformToolVO=UITools.getToolVO("transform")}};Fe.prototype.handleScaleHandleDragging=function(i){if(this.transformItem&&this.currentScaleHandle){let e=this.scaleHandleDragger.shiftKey,t=this.scaleHandleDragger.altKey,r=(e||this.currentScaleHandle.type=="side"?"freeform":"constrained")+"_"+(t?"center":"opposite");switch(this.scaleMode!=r&&(this.scaleMode=r,this.updateScaleControlBounds()),this.scaleMode.includes("freeform")?this.freeformScale():this.constrainedScale(),this.currentScaleHandle.group){case"image":this.updateImageOutlineDisplay(),this.updateImageScaleHandlePositions(),this.updateImageSpriteDisplay();break;case"frame":this.updateFrameOutlineDisplay(),this.updateFrameScaleHandlePositions(),this.updateFrameScaleHandleDisplay();break}if(this.updateTransformItem(),this.transformItem.basicShapeVO){this.transformItem.updateShapeTexture(!1);let a=this.transformItem.maskFlippedHorizontal?!this.transformItem.flippedHorizontal:this.transformItem.flippedHorizontal,s=this.transformItem.maskFlippedVertical?!this.transformItem.flippedVertical:this.transformItem.flippedVertical;this.imageSpriteVeil.setMaskTexture(this.transformItem.itemContentMask?this.transformItem.itemContentMask.texture:null,a,s)}if(this.updateImageSpriteVeilDisplay(),this.updateCursorOrientation(this.currentScaleHandle),this.updateScaleControl(),BFN.TooltipScreen.active){let a=Math.round(this.currentScaleHandle.group==="frame"?this.frameTouchSurface.width:this.imageTouchSurface.width),s=Math.round(this.currentScaleHandle.group==="frame"?this.frameTouchSurface.height:this.imageTouchSurface.height);BFN.TooltipScreen.setMessage(a+" x "+s)}}};Fe.prototype.handleScaleHandleDraggingComplete=function(i){BFN.CursorScreen.cursorLock=!1,BFN.smoothPictureDisabled=!1,this.currentScaleHandle&&(this.currentScaleHandle.selected=!1),this.currentScaleHandle=null,this.scaleControlBounds=null,this.scaleMode=null,this.toggleInteraction(!0),this.transformItem&&(this.transformItem.transforming=!1,this.scaleHandleDragger.wasDragged?(this.scaleHandleDragger.draggedItem.group==="frame"&&(this.transformItem.transformTool.updateTransformValues(),this.transformItem.transformTool.conformItemToBounds()),this.transformItem.updateShapeTexture(),this.transformItem.updateContentDimensions(),this.transformItem.updateSmoothingScale(),this.setup(this.transformItem),this.transformTool.updateDisplay(),this.transformItem.registerTransition(!1)):this.transformItem.updateDropShadowSource()),BFN.TooltipScreen.active&&BFN.TooltipScreen.hide()};Fe.prototype.handleFadeAnimatorUpdate=function(i){this.fadeContainer.alpha=this.fadeAnimator.animationFactor,this.visible=!!this.fadeContainer.alpha};Object.defineProperty(Fe.prototype,"scale",{set:function(i){this._scale=Math.max(0,i),this.transformItem&&(this.updateImageOutlineDimensions(),this.updateImageScaleHandlePositions(),this.updateImageTouchSurfaceHitArea(),this.updateFrameScaleHandleDisplay(),this.updateScaleHandleScales(),this.updateOutlineScales(),this.updateImageSpriteSmoothing())},get:function(){return this._scale}});BFN.TransformToolFrame=Fe;function qi(){PIXI.Container.call(this),BFN.EventDispatcher.call(this),this.init()}qi.prototype=window.azrc.extend(Object.create(PIXI.Container.prototype),Object.create(BFN.EventDispatcher.prototype));qi.prototype.init=function(){BeFunky.log("TransformToolSnapGaps Init"),this.initDefaultValues(),this.initDisplay()};qi.prototype.initDefaultValues=function(){this.interactive=!1,this.interactiveChildren=!1,this._scale=1,this.bgFillFilter=new BFN.filters.BackgroundFillFilter,this.bgFillFilter.resolution=BFN.Stage.resolution,this.graphic=new PIXI.Graphics,this.addChild(this.graphic)};qi.prototype.initDisplay=function(){this.snapGapGraphic=new PIXI.Graphics,this.addChild(this.snapGapGraphic),this.allSnapGapLabels=[],this.availableSnapGapLabels=[],this.usedSnapGapLabels=[],this.labelContainer=new PIXI.Container,this.addChild(this.labelContainer)};qi.prototype.show=function(){this.canvasModel=BFN.AppModel.sectionValue(BFN.PhotoEditorCanvasModel,BFN.CollageMakerCanvasModel,BFN.DesignerCanvasModel),this.canvas=BFN.AppModel.sectionValue(BFN.PhotoEditorCanvas,BFN.CollageMakerCanvas,BFN.DesignerCanvas);let i=this.canvas.transformToolSnapGapsContainer;i.children.includes(BFN.TransformToolSnapGaps)||(BFN.TransformToolSnapGaps.canvasScale=this.canvasModel.canvasScale,i.addChild(BFN.TransformToolSnapGaps))};qi.prototype.hide=function(){this.canvas=BFN.AppModel.sectionValue(BFN.PhotoEditorCanvas,BFN.CollageMakerCanvas,BFN.DesignerCanvas);let i=this.canvas.transformToolSnapGapsContainer;i.children.includes(BFN.TransformToolSnapGaps)&&i.removeChild(BFN.TransformToolSnapGaps)};qi.prototype.drawRect=function(i,e){i&&e&&(this.graphic.beginFill(65280,.2),this.graphic.drawRect(i.x,i.y,e.x-i.x,e.y-i.y),this.graphic.endFill())};qi.prototype.clearSnapGaps=function(){this.snapGapGraphic.clear(),this.availableSnapGapLabels.splice(0),this.availableSnapGapLabels.push(...this.allSnapGapLabels),this.usedSnapGapLabels.forEach(i=>{i.visible=!1}),this.usedSnapGapLabels.splice(0)};qi.prototype.drawSnapGap=function(i,e,t){if(!i||!["horizontal","vertical"].includes(e)||!t)return;this.snapGapGraphic.beginFill(16711935,.25),this.snapGapGraphic.drawRect(i.x,i.y,i.width,i.height),this.snapGapGraphic.endFill();let r=BFN.TransformModel.showMeasurements?16711935:2154751,a=new PIXI.Point;switch(e){case"horizontal":this.snapGapGraphic.lineStyle(1,r),this.snapGapGraphic.moveTo(i.x,i.y),this.snapGapGraphic.lineTo(i.x+i.width,i.y),this.snapGapGraphic.moveTo(i.x,i.y+i.height),this.snapGapGraphic.lineTo(i.x+i.width,i.y+i.height),a.x=i.x+i.width/2,a.y=i.y+i.height/2;break;case"vertical":this.snapGapGraphic.lineStyle(1,r),this.snapGapGraphic.moveTo(i.x,i.y),this.snapGapGraphic.lineTo(i.x,i.y+i.height),this.snapGapGraphic.moveTo(i.x+i.width,i.y),this.snapGapGraphic.lineTo(i.x+i.width,i.y+i.height),a.x=i.x+i.width/2,a.y=i.y+i.height/2;break}if(this.snapGapGraphic.lineStyle(null),!BFN.TransformModel.showMeasurements)return;let s=null;this.availableSnapGapLabels.length?(s=this.availableSnapGapLabels.shift(),s.text=t,s.visible=!0):(s=new PIXI.Text(t,{fontFamily:"Times New Roman",fontSize:13,fill:16777215,align:"center",padding:3}),s.filters=[this.bgFillFilter],s.anchor.x=s.anchor.y=.5,s.texture.setScaleMode(PIXI.SCALE_MODES.NEAREST),this.allSnapGapLabels.push(s),this.labelContainer.addChild(s)),s.x=a.x,s.y=a.y,this.usedSnapGapLabels.push(s)};Object.defineProperty(qi.prototype,"canvasScale",{set:function(i){this._scale=i,this.scale.x=this.scale.y=1/this._scale},get:function(){return this._scale}});BFN.SingletonQueue.add(function(){BFN.TransformToolSnapGaps=new qi});function Ve(){PIXI.Container.call(this),BFN.EventDispatcher.call(this),this.init()}Ve.prototype=window.azrc.extend(Object.create(PIXI.Container.prototype),Object.create(BFN.EventDispatcher.prototype));Ve.prototype.init=function(){BeFunky.log("TransformGuides Init"),this.initDefaultValues(),this.initGuideBars(),this.initGuideRulerMarks(),this.initGuideMarkers(),this.initGuideLines(),this.initGuideLock(),this.initGuideClear(),this.initGuideDragger(),this.initContextMenu(),this.updateGuideBarDisplay(),this.updateVisibility()};Ve.prototype.initDefaultValues=function(){this.interactive=!0,this.interactiveChildren=!0,this.iconBase64Data={lock_locked:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAA4AAAAQBAMAAADUulMJAAAAElBMVEUAAAAAAAAAAAAAAAAAAAAAAADgKxmiAAAABXRSTlMA5zOZZqu80ccAAABFSURBVAjXY2BgUBQUYgACltDQUAcgrRoEREBaVIGBKRBEAzESbRoKAsEgLlgAQTOFKoBpllAHiHgoRJw51ACmDkHDzAEABwINSTHDDiEAAAAASUVORK5CYII=",lock_unlocked:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAA4AAAASBAMAAACZcvICAAAAFVBMVEUAAAAAAAAAAAAAAAAAAAAAAAAAAAASAQCkAAAABnRSTlMA5zOZZsxFe4rUAAAASklEQVQI12NgYFAUFGIAApa0tDQHIK2WBERAWkyBgSkRRAMxiA6D0gyotFkaCCQziEEFEDRTmgKYZklzgIinQcSZ0wxg6hA0zBwAHDoQawcLHeMAAAAASUVORK5CYII=",clear:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAwAAAAMAgMAAAArG7R0AAAACVBMVEUAAAAAAAAAAACDY+nAAAAAAnRSTlMA8iUgXggAAAApSURBVAjXYwhgYGVIYZAEwhQGNscJDIzTHBgYMhlAGMQGiYHkQGpAagGiVAbNG1KVKAAAAABJRU5ErkJggg=="},this._colorMode=ht().name,this._colors={dark:{guide_bar:2763835,lock:11383244,clear:11383244,ruler_mark:11383244,marker_fill:11383244,marker_stroke:2369073},light:{guide_bar:16777215,lock:6118261,clear:6118261,ruler_mark:6118261,marker_fill:16777215,marker_stroke:6118261}},ui(()=>{this.colorMode=ht().name}),this.transformGuideData=[],this.guides={},this.activeGuide=null,this.guidesLocked=!1,this.pressedID=null,this.pressedAxis=null,this.pressedValue=null,this.snapData=[],this.snappedItems=[],this.snapValue=null,this.snapDistance=5,this.guideBarAvailable=!0,this.handleGuideMarkerPressBind=this.handleGuideMarkerPress.bind(this),this.handleGuideMarkerOverBind=this.handleGuideMarkerOver.bind(this),this.handleGuideMarkerOutBind=this.handleGuideMarkerOut.bind(this),BFN.AppModel.addEventListener(BFN.AppModelEvents.VIEWSTATE_UPDATED.type,this.handleAppViewstateUpdated.bind(this)),BFN.StageModel.addEventListener(BFN.StageModelEvents.STAGE_DIMENSIONS_UPDATED.type,this.handleStageDimensionsUpdated.bind(this)),BFN.PhotoEditorCanvasModel.addEventListener(BFN.PhotoEditorCanvasModelEvents.VIEWSTATE_UPDATED.type,this.handlePhotoEditorCanvasViewstateUpdated.bind(this)),BFN.PhotoEditorModel.addEventListener(BFN.PhotoEditorModelEvents.SOURCE_IMAGE_UPDATED.type,this.updateVisibility.bind(this)),this.on("pointerdown",()=>{BFN.preventSelectionDrag=!0})};Ve.prototype.initGuideBars=function(){this.guideBarThickness=24,this.guideBarTexture=PIXI.RenderTexture.create(this.guideBarThickness,this.guideBarThickness),this.guideBarTexture.fillColor(this._colors[this._colorMode].guide_bar),this.guideBarCornerLeft=new PIXI.Sprite(this.guideBarTexture),this.guideBarCornerLeft.interactive=!0,this.addChild(this.guideBarCornerLeft),this.guideBarCornerRight=new PIXI.Sprite(this.guideBarTexture),this.guideBarCornerRight.interactive=!0,this.addChild(this.guideBarCornerRight),this.guideBarLeft=this.createGuideBar("y",0,this.guideBarThickness),this.addChild(this.guideBarLeft),this.guideBarTop=this.createGuideBar("x",this.guideBarThickness,0),this.addChild(this.guideBarTop)};Ve.prototype.initGuideRulerMarks=function(){this.guideRulerMarks=new PIXI.Graphics,this.addChild(this.guideRulerMarks)};Ve.prototype.initGuideMarkers=function(){this.guideMarkerTexture=null,this.guideMarkersContainer=new PIXI.Container,this.addChild(this.guideMarkersContainer),this.guideMarkersMask=new PIXI.Graphics,this.addChild(this.guideMarkersMask),this.guideMarkersContainer.mask=this.guideMarkersMask};Ve.prototype.initGuideLines=function(){this.guideLineTexture=null,this.guideLinesContainer=new PIXI.Container,this.guideLinesContainer.interactive=this.guideLinesContainer.interactiveChildren=!1,this.addChild(this.guideLinesContainer)};Ve.prototype.initGuideLock=function(){this.guideLockTextureLocked=PIXI.Texture.from(this.iconBase64Data.lock_locked),this.guideLockTextureLocked.baseTexture.scaleMode=PIXI.SCALE_MODES.NEAREST,this.guideLockTextureUnlocked=PIXI.Texture.from(this.iconBase64Data.lock_unlocked),this.guideLockTextureUnlocked.baseTexture.scaleMode=PIXI.SCALE_MODES.NEAREST,this.guideLockButton=new PIXI.Sprite,this.guideLockButton.interactive=!0,this.guideLockButton.buttonMode=!0,this.guideLockButton.pluginName="blend_picture",this.guideLockButton.fillColor=this._colors[this._colorMode].lock,this.guideLockButton.intensity=1,this.guideLockButton.anchor.x=this.guideLockButton.anchor.y=.5,this.guideLockButton.x=this.guideLockButton.y=this.guideBarThickness/2,this.guideLockButton.hitArea=new PIXI.Rectangle(-(this.guideBarThickness/2),-(this.guideBarThickness/2),this.guideBarThickness,this.guideBarThickness),this.addChild(this.guideLockButton),this.guideLockButton.on("pointerover",()=>{BFN.MainUI.tooltip=this.guidesLocked?"unlock_guides":"lock_guides",this.guideLockButton.alpha=.7,BFN.MainUI.requestRender()}),this.guideLockButton.on("pointerout",()=>{BFN.MainUI.tooltip=null,this.guideLockButton.alpha=1,BFN.MainUI.requestRender()}),this.guideLockButton.on("pointerdown",()=>{this.guidesLocked=!this.guidesLocked,BFN.MainUI.tooltip=this.guidesLocked?"unlock_guides":"lock_guides",this.saveGuides(),this.updateGuideLockDisplay()}),this.updateGuideLockDisplay()};Ve.prototype.initGuideClear=function(){this.guideClearTexture=PIXI.Texture.from(this.iconBase64Data.clear),this.guideClearTexture.baseTexture.scaleMode=PIXI.SCALE_MODES.NEAREST,this.guideClearButton=new PIXI.Sprite(this.guideClearTexture),this.guideClearButton.interactive=!0,this.guideClearButton.buttonMode=!0,this.guideClearButton.pluginName="blend_picture",this.guideClearButton.fillColor=this._colors[this._colorMode].clear,this.guideClearButton.intensity=1,this.guideClearButton.anchor.x=this.guideClearButton.anchor.y=.5,this.guideClearButton.x=this.guideBarThickness*1.5,this.guideClearButton.y=this.guideBarThickness/2,this.guideClearButton.hitArea=new PIXI.Rectangle(-(this.guideBarThickness/2),-(this.guideBarThickness/2),this.guideBarThickness,this.guideBarThickness),this.addChild(this.guideClearButton),this.guideClearButton.on("pointerover",()=>{BFN.MainUI.tooltip="clear_guides",this.guideClearButton.alpha=.7,BFN.MainUI.requestRender()}),this.guideClearButton.on("pointerout",()=>{BFN.MainUI.tooltip=null,this.guideClearButton.alpha=1,BFN.MainUI.requestRender()}),this.guideClearButton.on("pointerdown",()=>{this.transformGuideData.splice(0),this.updateDisplay(!0),this.saveGuides(),this.contextMenu.hide()})};Ve.prototype.initGuideDragger=function(){this.guideDragger=new BFN.Dragger,this.guideDragger.useBounds=!1,this.guideDragger.autoDrag=!1,this.guideDragger.addEventListener(BFN.DraggerEvents.DRAGGING.type,this.handleGuideDraggerDragging.bind(this)),this.guideDragger.addEventListener(BFN.DraggerEvents.DRAGGING_COMPLETE.type,this.handleGuideDraggerDraggingComplete.bind(this))};Ve.prototype.initContextMenu=function(){this.contextMenu=document.getElementById("context_menu_transform_guides"),BeFunky.contextMenu(this.contextMenu,{add_guide:{onClick:()=>{this.addGuide(this.pressedAxis,this.pressedValue,!0),this.contextMenu.hide()}},remove_guide:{onClick:()=>{this.removeGuide(this.pressedID)}},clear_guides:{onClick:()=>{this.transformGuideData.splice(0),this.updateDisplay(!0),this.saveGuides(),this.contextMenu.hide()}},lock_guides:{onClick:()=>{this.guidesLocked=!0,this.saveGuides(),this.updateGuideLockDisplay(),this.contextMenu.hide()}},unlock_guides:{onClick:()=>{this.guidesLocked=!1,this.saveGuides(),this.updateGuideLockDisplay(),this.contextMenu.hide()}}}),this.contextMenu.enabled=!1,this.contextMenu.target=document.querySelector("#appStage canvas")};Ve.prototype.addGuide=function(i,e,t=!1){if(!["x","y"].includes(i)||typeof e!="number")return;let r={id:`${i}_${BeFunky.randomString(10)}`,axis:i,value:e};return this.transformGuideData.push(r),this.updateDisplay(!0),t&&this.saveGuides(),r};Ve.prototype.removeGuide=function(i){let e=this.transformGuideData.length;for(;--e>-1;)if(this.transformGuideData[e].id===i){this.transformGuideData.splice(e,1);break}this.updateDisplay(!0),this.saveGuides()};Ve.prototype.setTransformGuideData=function(i=[],e=!1){this.transformGuideData.splice(0);try{this.transformGuideData.push(...i)}catch(t){}this.guidesLocked=e,setTimeout(()=>{this.updateDisplay(!0),this.updateGuideLockDisplay()},0)};Ve.prototype.updateGuideBarDisplay=function(){this.visible&&(this.guideBarTop.width=Math.max(10,BFN.StageModel.stageW-this.guideBarThickness*2),this.guideBarLeft.height=Math.max(10,BFN.StageModel.stageH-this.guideBarThickness),this.guideBarCornerRight.x=BFN.StageModel.stageW-this.guideBarThickness,this.guideClearButton.x=BFN.StageModel.stageW-this.guideBarThickness/2,this.guideMarkersMask.clear(),this.guideMarkersMask.beginFill(16777215),this.guideMarkersMask.drawRect(this.guideBarTop.x,this.guideBarTop.y,this.guideBarTop.width,Math.max(10,BFN.StageModel.stageH-this.guideBarTop.y)),this.guideMarkersMask.endFill(),this.guideMarkersMask.beginFill(16777215),this.guideMarkersMask.drawRect(this.guideBarLeft.x,this.guideBarLeft.y,Math.max(10,BFN.StageModel.stageW-this.guideBarLeft.x),this.guideBarLeft.height),this.guideMarkersMask.endFill(),this.guideMarkersMask.hitArea=new PIXI.Rectangle(0,0,0,0))};Ve.prototype.updateDisplay=function(i=!1){if(BFN.AppModel.viewState&&this.visible){if(i){let e=this.transformGuideData.map(t=>t.id);for(let t in this.guides)e.includes(t)||this.destroyGuide(t);this.transformGuideData.forEach(t=>{this.createGuide(t)})}for(let e in this.guides)this.updateGuidePosition(e);this.drawGuideRulerMarks(),BFN.MainUI.requestRender()}};Ve.prototype.updateGuidePosition=function(i){if(this.guides.hasOwnProperty(i)){let e=BFN.AppModel.sectionValue(BFN.PhotoEditorCanvas,BFN.CollageMakerCanvas,BFN.DesignerCanvas),{transformLayer:t}=e,r=this.guides[i],a=e.toGlobal(new PIXI.Point),s=t.toGlobal(new PIXI.Point(r.value,r.value)),o=r.marker;o[r.axis]=s[r.axis]-BFN.MainUI[r.axis];let n=r.line,l=s[r.axis]-BFN.MainUI[r.axis];l%1||(l-=.001),n[r.axis]=l,n[r.perpendicularAxis]=a[r.perpendicularAxis]-BFN.MainUI[r.perpendicularAxis]}};Ve.prototype.drawGuideRulerMarks=function(){let{transformLayer:i}=BFN.AppModel.sectionValue(BFN.PhotoEditorCanvas,BFN.CollageMakerCanvas,BFN.DesignerCanvas),e=i.toGlobal(new PIXI.Point(-Math.round(i.frameWidth/2),-Math.round(i.frameHeight/2)));e.x-=BFN.MainUI.x,e.y-=BFN.MainUI.y;let t=i.canvasScale,r=t*2,a=t*10,s=t*20,o=t*100,n=4,l=r<n?a<n?s<n?o:s:a:r,c=this._colors[this._colorMode].ruler_mark;this.guideRulerMarks.clear();let h,u,d,m,p,g,f=T=>{switch(p=1,l){case r:m=u%50?u%5?.3:.5:.7,m===.3&&(p=Math.min(1,(l-n)*2));break;case a:m=u%10?.5:.7,m===.5&&u%2&&(p=Math.min(1,(l-n)*2));break;case s:m=u%5?.5:.7,m===.5&&(p=Math.min(1,(l-n)*2));break;case o:m=.7;break}switch(d=m*this.guideBarThickness,this.guideRulerMarks.lineStyle(1,c,p),T){case"x":this.guideRulerMarks.moveTo(h,this.guideBarThickness-d),this.guideRulerMarks.lineTo(h,this.guideBarThickness);break;case"y":this.guideRulerMarks.moveTo(this.guideBarThickness-d,h),this.guideRulerMarks.lineTo(this.guideBarThickness,h);break}},v=T=>{for(this.guideRulerMarks.lineStyle(1,c,1),T==="x"?(this.guideRulerMarks.moveTo(0,this.guideBarThickness-.001),this.guideRulerMarks.lineTo(BFN.StageModel.stageW,this.guideBarThickness-.001),this.guideRulerMarks.moveTo(BFN.StageModel.stageW-this.guideBarThickness-.001,0),this.guideRulerMarks.lineTo(BFN.StageModel.stageW-this.guideBarThickness-.001,this.guideBarThickness)):(this.guideRulerMarks.moveTo(this.guideBarThickness-.001,0),this.guideRulerMarks.lineTo(this.guideBarThickness-.001,BFN.StageModel.stageH)),g=T==="x"?this.guideBarTop:this.guideBarLeft,h=e[T],h%1||(h-=.001),u=0;h>g[T];)f(T),h-=l,u++;for(h=e[T],h%1||(h-=.001),u=0;h<g[T]+(T==="x"?g.width:g.height);)h>g[T]&&f(T),h+=l,u++};v("x"),v("y")};Ve.prototype.saveGuides=function(i=!0){let e=BFN.AppModel.sectionValue(BFN.PhotoEditorModel,BFN.CollageMakerModel,BFN.DesignerModel);e.projectVO.transformGuides=[...this.transformGuideData],e.projectVO.transformGuidesLocked=this.guidesLocked;let t=i;BFN.AppModel.viewingEditor&&BFN.ImageEditManager.editingImage&&(t=!1),t&&BFN.ProjectManager.requestLocalSave()};Ve.prototype.updateVisibility=function(){let i=UITools.getToolValue("alignment","guides")===!0,e=BFN.PhotoEditorCanvasModel.viewState===BFN.PhotoEditorCanvasModelViewStates.VIEWING_CANVAS&&!BFN.TransformItemIsolator.isolatedTransformItem&&(!BFN.AppModel.viewingEditor||BFN.AppModel.viewingEditor&&BFN.PhotoEditorModel.currentTexture);this.visible=this.guideLinesContainer.visible=i&&e,BFN.MainUI&&(this.updateGuideBarDisplay(),this.updateDisplay(!0),BFN.MainUI.requestRender())};Ve.prototype.updateColors=function(){this.guideBarTexture.fillColor(this._colors[this._colorMode].guide_bar),this.guideLockButton.fillColor=this._colors[this._colorMode].lock,this.guideClearButton.fillColor=this._colors[this._colorMode].clear,this.drawGuideRulerMarks(),this.guideMarkerTexture&&this.guideMarkerTexture.copyPixels(this.guideMarkerTextures[this._colorMode]),BFN.MainUI.requestRender()};Ve.prototype.updateGuideLockDisplay=function(){this.guideLockButton.texture=this.guidesLocked?this.guideLockTextureLocked:this.guideLockTextureUnlocked,this.guideMarkersContainer.visible=!this.guidesLocked,this.guideMarkersContainer.interactiveChildren=!this.guidesLocked,this.guideBarLeft.buttonMode=this.guideBarTop.buttonMode=!this.guidesLocked,BFN.MainUI&&BFN.MainUI.requestRender()};Ve.prototype.updateTooltip=function(i=0,e=0){let t=this.getTooltipString(this.activeGuide);this.guideDragger.dragging?BFN.TooltipScreen.active?BFN.TooltipScreen.setMessage(t,!1,!0):(BFN.TooltipScreen.show(t,!0,!0),BFN.TooltipScreen.setPosition(i,e,{onCanvas:!0})):this.guideDragger.dragging||BFN.TooltipScreen.hide()};Ve.prototype.getTooltipString=function(i){let e="n/a";if(i){let{transformLayer:t}=BFN.AppModel.sectionValue(BFN.PhotoEditorCanvas,BFN.CollageMakerCanvas,BFN.DesignerCanvas),r=0,a=0;switch(i.axis){case"x":r=i.value+t.frameWidth/2,a=t.frameWidth-r,e=`\u25C4 ${(Math.round(r*10)/10).toFixed(1)}px | ${(Math.round(a*10)/10).toFixed(1)}px \u25BA`;break;case"y":r=i.value+t.frameHeight/2,a=t.frameHeight-r,e=`\u25B2 ${(Math.round(r*10)/10).toFixed(1)}px | ${(Math.round(a*10)/10).toFixed(1)} px \u25BC`;break}}return e};Ve.prototype.generateSnapData=function(){this.snapData.splice(0);let{transformLayer:i}=BFN.AppModel.sectionValue(BFN.PhotoEditorCanvas,BFN.CollageMakerCanvas,BFN.DesignerCanvas);i.children.forEach(e=>{if(e.type!=="group"){let t=BFN.Util.getTransformItemBounds(e),r=new BFN.Rectangle(t.minX+e.accurateBounds.minX,t.minY+e.accurateBounds.minY,e.accurateBounds.width,e.accurateBounds.height);switch(this.activeGuide.axis){case"x":this.snapData.push({item:e,value:r.left},{item:e,value:r.right});break;case"y":this.snapData.push({item:e,value:r.top},{item:e,value:r.bottom});break}}})};Ve.prototype.processSnapData=function(){let{transformLayer:i}=BFN.AppModel.sectionValue(BFN.PhotoEditorCanvas,BFN.CollageMakerCanvas,BFN.DesignerCanvas),e=Math.round(i.toLocal(new PIXI.Point(this.guideDragger.draggedX,this.guideDragger.draggedY),this)[this.activeGuide.axis]);this.snapValue=null;let t=[];if(BFN.TransformModel.snappingEnabled&&this.snapData.length){let r=this.snapDistance/i.canvasScale,a=r,s=null;this.snapData.forEach(o=>{let n=o.value,l=Math.abs(n-e);l<r&&l<=a&&(a=l,s=n)}),s!==null&&(this.snapValue=e=s,this.snapData.forEach(o=>{if(!t.includes(o.item)){let n=o.value;Math.abs(n-s)<=.5&&t.push(o.item)}}))}if(t){let r=this.snappedItems.length;for(;--r>-1;){let a=this.snappedItems[r];t.includes(a)||(a.hoverDropAnimator.decrease(),this.snappedItems.splice(r,1))}t.forEach(a=>{!this.snappedItems.includes(a)&&a.hoverDropAnimator&&(a.hoverDropAnimator.increase(),this.snappedItems.push(a))})}else this.snappedItems.forEach(r=>{r.hoverDropAnimator.decrease()}),this.snappedItems.splice(0);return e};Ve.prototype.createGuideBar=function(i,e,t){let r=new PIXI.Sprite(this.guideBarTexture);return r.interactive=!0,r.buttonMode=!0,r.axis=i,r.x=e,r.y=t,r.on("pointerdown",this.handleGuideBarPress.bind(this)),r.on("pointerout",this.handleGuideMarkerOutBind),r};Ve.prototype.getGuideMarkerTexture=function(){if(!this.guideMarkerTexture){let i={dark:.7,light:.85},e=this.guideBarThickness,t=Math.round(this.guideBarThickness*.5);t+=t%2?0:1;let r=a=>{let s=PIXI.RenderTexture.create(e,t),o=new PIXI.Graphics,n=Math.floor(t/4)+1;o.lineStyle(1.5,this._colors[a].marker_stroke,i[a],0),o.beginFill(this._colors[a].marker_fill),o.moveTo(0,0),o.lineTo(Math.round(this.guideBarThickness*.8)-1,0),o.lineTo(this.guideBarThickness-1,n),o.lineTo(Math.round(this.guideBarThickness*.8)-1,Math.round(t/2)),o.lineTo(0,Math.round(t/2)),o.lineTo(0,0),o.endFill();let l=o.generateCanvasTexture();return s.copyPixels(l,{x:(s.width-l.width)/2,y:(s.height-l.height)/2}),o.clear(),s};this.guideMarkerTextures={dark:r("dark"),light:r("light")},this.guideMarkerTexture=PIXI.RenderTexture.create(e,t),this.guideMarkerTexture.copyPixels(this.guideMarkerTextures[this._colorMode])}return this.guideMarkerTexture};Ve.prototype.getGuideLineTexture=function(){if(!this.guideLineTexture){let i=4096,e=new PIXI.Graphics;e.moveTo(0,0);for(let t=0;t<=i;t+=4){let r=t%8?15592941:4145484;e.lineStyle(3,r,.8,0),e.lineTo(t,0)}this.guideLineTexture=PIXI.RenderTexture.create(i,1),BFN.Stage.render(e,this.guideLineTexture),e.clear()}return this.guideLineTexture};Ve.prototype.createGuide=function(i){if(!this.guides.hasOwnProperty(i.id)){let e={id:i.id,axis:i.axis,perpendicularAxis:i.axis==="x"?"y":"x",value:i.value};this.guides[i.id]=e,e.marker=new PIXI.Sprite(this.getGuideMarkerTexture()),e.marker.interactive=!0,e.marker.buttonMode=!0,e.marker.anchor.x=e.marker.anchor.y=.5,e.marker.x=e.marker.y=Math.round(this.guideBarThickness/2+2),e.marker.rotation=i.axis==="x"?Math.PI/2:0,e.marker.guide=e,e.marker.on("pointerdown",this.handleGuideMarkerPressBind),e.marker.on("pointerover",this.handleGuideMarkerOverBind),e.marker.on("pointerout",this.handleGuideMarkerOutBind),this.guideMarkersContainer.addChild(e.marker),e.line=new PIXI.Sprite(this.getGuideLineTexture()),e.line.interactive=!1,e.line.anchor.x=e.line.anchor.y=.5,e.line.rotation=i.axis==="x"?Math.PI/2:0,e.line.guide=i,this.guideLinesContainer.addChild(e.line)}};Ve.prototype.destroyGuide=function(i){if(this.guides.hasOwnProperty(i)){let e=this.guides[i];this.guideMarkersContainer.children.includes(e.marker)&&this.guideMarkersContainer.removeChild(e.marker),e.marker.off("pointerdown",this.handleGuideMarkerPressBind),e.marker.off("pointerover",this.handleGuideMarkerOverBind),e.marker.off("pointerout",this.handleGuideMarkerOutBind),e.marker.destroy(!1),this.guideLinesContainer.children.includes(e.line)&&this.guideLinesContainer.removeChild(e.line),e.line.destroy(!1);for(let t in e)delete e[t];delete this.guides[i]}};Ve.prototype.handleAppViewstateUpdated=function(i){BFN.AppModel.sectionValue(BFN.PhotoEditorCanvas,BFN.CollageMakerCanvas,BFN.DesignerCanvas).transformGuidesContainer.addChild(this.guideLinesContainer);let t=!0;BFN.AppModel.viewingEditor&&BFN.ImageEditManager.editingImage&&(t=!1);let r=BFN.AppModel.sectionValue(BFN.PhotoEditorModel,BFN.CollageMakerModel,BFN.DesignerModel);t?this.setTransformGuideData(r.projectVO.transformGuides,r.projectVO.transformGuidesLocked):this.setTransformGuideData(),this.updateVisibility()};Ve.prototype.handleStageDimensionsUpdated=function(i){setTimeout(()=>{this.updateGuideBarDisplay(),this.updateDisplay()},0)};Ve.prototype.handlePhotoEditorCanvasViewstateUpdated=function(i){this.updateVisibility()};Ve.prototype.handleGuideBarPress=function(i){if(!this.guideBarAvailable)return;let e=i.target,{transformLayer:t}=BFN.AppModel.sectionValue(BFN.PhotoEditorCanvas,BFN.CollageMakerCanvas,BFN.DesignerCanvas),r=e.axis,a=Math.round(t.getPointerPosition(i)[e.axis]);if(i.data.originalEvent.button===2){this.guidesLocked?(this.contextMenu.hideButton("add_guide"),this.contextMenu.showButton("unlock_guides"),this.contextMenu.hideButton("lock_guides")):(this.contextMenu.showButton("add_guide"),this.contextMenu.showButton("lock_guides"),this.contextMenu.hideButton("unlock_guides")),this.contextMenu.hideButton("remove_guide"),this.transformGuideData.length?this.contextMenu.showButton("clear_guides"):this.contextMenu.hideButton("clear_guides"),this.contextMenu.show(i.data.originalEvent.clientX,i.data.originalEvent.clientY),this.pressedAxis=r,this.pressedValue=a,i.stopPropagation();return}if(this.guidesLocked){i.stopPropagation();return}let s=this.addGuide(r,a);this.guides.hasOwnProperty(s.id)&&(this.activeGuide=this.guides[s.id],this.guideBarAvailable=!1,this.guideDragger.drag(this.activeGuide.marker),this.generateSnapData(),this.activeGuide.value=this.processSnapData(),this.updateGuidePosition(this.activeGuide.id),this.updateTooltip(i.data.originalEvent.clientX,i.data.originalEvent.clientY))};Ve.prototype.handleGuideMarkerPress=function(i){if(!this.guideBarAvailable)return;let e=i.target,t=()=>{this.contextMenu.showButton("remove_guide"),this.contextMenu.hideButton("add_guide"),this.contextMenu.hideButton("clear_guides"),this.contextMenu.hideButton("lock_guides"),this.contextMenu.hideButton("unlock_guides"),this.contextMenu.show(i.data.originalEvent.clientX,i.data.originalEvent.clientY),this.pressedID=e.guide.id};if(i.data.originalEvent.button===2){t(),i.stopPropagation();return}this.activeGuide=e.guide,this.guideBarAvailable=!1,this.guideDragger.drag(this.activeGuide.marker),this.generateSnapData(),this.activeGuide.value=this.processSnapData(),this.processSnapData(),this.updateGuidePosition(this.activeGuide.id),this.updateTooltip(i.data.originalEvent.clientX,i.data.originalEvent.clientY),i.stopPropagation(),BFN.MainUIEvents.MOUSE_DOWN.data={canvasPressed:!0,originalEvent:i.data.originalEvent},BFN.MainUI.dispatchEvent(BFN.MainUIEvents.MOUSE_DOWN),BFN.LongPressManager.initiateLongPress(()=>{this.guideDragger.stopDrag(),BFN.preventSelectionDrag=!0,t()})};Ve.prototype.handleGuideMarkerOver=function(i){if(!this.guideDragger.dragging&&this.guideMarkersContainer.children.includes(i.target)){let e=i.target;this.guideMarkersContainer.addChild(e),BFN.MainUI.requestRender(),setTimeout(()=>{let t=this.getTooltipString(e.guide);BFN.TooltipScreen.show(t,!0,!0),BFN.TooltipScreen.setPosition(i.data.originalEvent.clientX,i.data.originalEvent.clientY,{onCanvas:!0}),BFN.MainUI.requestRender()},0)}};Ve.prototype.handleGuideMarkerOut=function(i){this.guideDragger.dragging||BFN.TooltipScreen.hide()};Ve.prototype.handleGuideDraggerDragging=function(i){if(!this.activeGuide)return;let e=this.processSnapData(),t=this.transformGuideData.find(r=>r.id===this.activeGuide.id);t&&(t.value=e),this.activeGuide.value=e,this.updateGuidePosition(this.activeGuide.id),this.updateTooltip()};Ve.prototype.handleGuideDraggerDraggingComplete=function(i){let e=BFN.AppModel.sectionValue(BFN.PhotoEditorCanvas,BFN.CollageMakerCanvas,BFN.DesignerCanvas).transformLayer,t=this.activeGuide?this.snapValue||Math.round(e.toLocal(new PIXI.Point(this.guideDragger.draggedX,this.guideDragger.draggedY),this)[this.activeGuide.axis]):null,r=this.activeGuide?this.transformGuideData.find(s=>s.id===this.activeGuide.id):null;r&&(r.value=t),this.activeGuide&&t!==null&&(this.activeGuide.value=t,this.activeGuide=null);let a=r?this.transformGuideData.find(s=>s.axis===r.axis&&s.value===r.value&&r.id!==s.id):null;a?(this.transformGuideData.splice(this.transformGuideData.indexOf(a),1),this.updateDisplay(!0)):this.updateDisplay(),this.snapData.splice(0),this.snapValue=null,this.snappedItems.length&&(this.snappedItems.forEach(s=>{s.hoverDropAnimator.decrease()}),this.snappedItems.splice(0)),this.saveGuides(),this.updateTooltip(),setTimeout(()=>{this.guideBarAvailable=!0},200)};Object.defineProperty(Ve.prototype,"colorMode",{set(i){!this._colors.hasOwnProperty(i)||(this._colorMode=i,this.updateColors())},get(){return this._colorMode}});BFN.SingletonQueue.add(()=>{BFN.TransformGuides=new Ve});function Ba(){PIXI.Sprite.call(this),this.init()}Ba.prototype=Object.create(PIXI.Sprite.prototype);Ba.prototype.init=function(){BeFunky.log("PhotoEditorCanvasImage Init"),this.initDefaultValues()};Ba.prototype.initDefaultValues=function(){this.interactive=!0};Object.defineProperty(Ba.prototype,"imageWidth",{get:function(){try{return this.texture.width}catch(i){return 0}}});Object.defineProperty(Ba.prototype,"imageHeight",{get:function(){try{return this.texture.height}catch(i){return 0}}});BFN.SingletonQueue.add(function(){BFN.PhotoEditorCanvasImage=new Ba});BFN.PhotoEditorCanvasToolsEvents={TOOL_OVER:new Event("TOOL_OVER"),TOOL_OUT:new Event("TOOL_OUT"),START_CANVAS_DRAG:new Event("START_CANVAS_DRAG"),TOOL_DIMENSIONS_UPDATED:new Event("TOOL_DIMENSIONS_UPDATED")};function Oe(){PIXI.Container.call(this),BFN.EventDispatcher.call(this),this.init()}Oe.prototype=window.azrc.extend(Object.create(PIXI.Container.prototype),Object.create(BFN.EventDispatcher.prototype));Oe.prototype.init=function(){BeFunky.log("PhotoEditorCanvasTools Init"),this.initDefaultValues(),this.initToolMap(),this.initToolContainer(),this.initPremiumWatermark()};Oe.prototype.initDefaultValues=function(){this._scale=1,this._scaling=!1,this.tools=[],this.currentTool=null,this.altSourceTexture=null,this.fitAfterApply=!1,this.toolPressed=!1,this.handleToolOverBind=this.handleToolOver.bind(this),this.handleToolOutBind=this.handleToolOut.bind(this),this.handleToolPressedBind=this.handleToolPressed.bind(this),this.handleToolReleasedBind=this.handleToolReleased.bind(this),BFN.PhotoEditorCanvasModel.addEventListener(BFN.PhotoEditorCanvasModelEvents.VIEWSTATE_UPDATED.type,this.handleCanvasViewStateUpdated.bind(this)),this.addEventListener(BFN.PhotoEditorCanvasToolsEvents.TOOL_DIMENSIONS_UPDATED.type,this.handleToolDimensionsUpdated.bind(this))};Oe.prototype.initToolMap=function(){this.toolMap={},this.toolMap[BFN.PhotoEditorCanvasModelViewStates.VIEWING_TOUCH_UP]={id:"touchup",init:this.initTouchUp.bind(this)},this.toolMap[BFN.PhotoEditorCanvasModelViewStates.VIEWING_EFFECT]={id:"effect",init:this.initEffect.bind(this)},this.toolMap[BFN.PhotoEditorCanvasModelViewStates.VIEWING_ARTSY]={id:"artsy",init:this.initArtsy.bind(this)},this.toolMap[BFN.PhotoEditorCanvasModelViewStates.VIEWING_SQUARE]={id:"square",init:this.initSquare.bind(this)},this.toolMap[BFN.PhotoEditorCanvasModelViewStates.VIEWING_BORDER]={id:"border",init:this.initBorder.bind(this)},this.toolMap[BFN.PhotoEditorCanvasModelViewStates.VIEWING_DROP_SHADOW]={id:"dropShadow",init:this.initDropShadow.bind(this)},this.toolMap[BFN.PhotoEditorCanvasModelViewStates.VIEWING_FRAME]={id:"frame",init:this.initFrame.bind(this)},this.toolMap[BFN.PhotoEditorCanvasModelViewStates.VIEWING_TEXTURE]={id:"texture",init:this.initTexture.bind(this)},this.toolMap[BFN.PhotoEditorCanvasModelViewStates.VIEWING_OVERLAY]={id:"overlay",init:this.initOverlay.bind(this)},this.toolMap[BFN.PhotoEditorCanvasModelViewStates.VIEWING_LENS_FLARE]={id:"flare",init:this.initLensFlare.bind(this)},this.toolMap[BFN.PhotoEditorCanvasModelViewStates.VIEWING_CROP]={id:"crop",init:this.initCrop.bind(this)},this.toolMap[BFN.PhotoEditorCanvasModelViewStates.VIEWING_ROTATE]={id:"rotator",init:this.initRotator.bind(this)},this.toolMap[BFN.PhotoEditorCanvasModelViewStates.VIEWING_RESIZE]={id:"resizer",init:this.initResizer.bind(this)},this.toolMap[BFN.PhotoEditorCanvasModelViewStates.VIEWING_SLIMMING]={id:"slimming",init:this.initSlimming.bind(this)},this.toolMap[BFN.PhotoEditorCanvasModelViewStates.VIEWING_RESHAPE]={id:"reshape",init:this.initReshape.bind(this)},this.toolMap[BFN.PhotoEditorCanvasModelViewStates.VIEWING_TILT]={id:"tilter",init:this.initTilter.bind(this)},this.toolMap[BFN.PhotoEditorCanvasModelViewStates.VIEWING_FOCUS]={id:"focus",init:this.initFocus.bind(this)},this.toolMap[BFN.PhotoEditorCanvasModelViewStates.VIEWING_VIGNETTE]={id:"vignette",init:this.initVignette.bind(this)},this.toolMap[BFN.PhotoEditorCanvasModelViewStates.VIEWING_PAINT_BRUSH]={id:"paintBrush",init:this.initPaintBrush.bind(this)},this.toolMap[BFN.PhotoEditorCanvasModelViewStates.VIEWING_CLONE]={id:"clone",init:this.initClone.bind(this)},this.toolMap[BFN.PhotoEditorCanvasModelViewStates.VIEWING_BLEMISH_FIX]={id:"blemish",init:this.initBlemish.bind(this)},this.toolMap[BFN.PhotoEditorCanvasModelViewStates.VIEWING_BACKGROUND]={id:"background",init:this.initBackground.bind(this)},this.toolMap[BFN.PhotoEditorCanvasModelViewStates.VIEWING_CUTOUT]={id:"cutout",init:this.initCutout.bind(this)},BFN.PhotoEditorCanvasModelViewStates.VIEWING_MATTING&&(this.toolMap[BFN.PhotoEditorCanvasModelViewStates.VIEWING_MATTING]={id:"matting",init:this.initMatting.bind(this)})};Oe.prototype.initToolContainer=function(){this.toolContainer=new PIXI.Container,this.addChild(this.toolContainer)};Oe.prototype.initTouchUp=function(){this.touchup=BFN.ImageTouchUp,this.touchup.interactive=!0,this.tools.push(this.touchup),this.toolContainer.addChild(this.touchup)};Oe.prototype.initEffect=function(){this.effect=BFN.ImageEffect,this.effect.interactive=!0,this.effect.toolScale=this._scale,this.tools.push(this.effect),this.toolContainer.addChild(this.effect)};Oe.prototype.initArtsy=function(){this.artsy=BFN.ImageArtsy,this.artsy.interactive=!0,this.tools.push(this.artsy),this.toolContainer.addChild(this.artsy)};Oe.prototype.initSquare=function(){this.square=BFN.ImageSquare,this.square.interactive=!0,this.tools.push(this.square),this.toolContainer.addChild(this.square)};Oe.prototype.initBorder=function(){this.border=BFN.ImageBorder,this.border.interactive=!0,this.tools.push(this.border),this.toolContainer.addChild(this.border)};Oe.prototype.initDropShadow=function(){this.dropShadow=BFN.ImageDropShadow,this.dropShadow.interactive=!0,this.tools.push(this.dropShadow),this.toolContainer.addChild(this.dropShadow)};Oe.prototype.initFrame=function(){this.frame=BFN.ImageFrame,this.frame.interactive=!0,this.tools.push(this.frame),this.toolContainer.addChild(this.frame)};Oe.prototype.initTexture=function(){this.texture=BFN.ImageTexture,this.texture.interactive=!0,this.tools.push(this.texture),this.toolContainer.addChild(this.texture)};Oe.prototype.initOverlay=function(){this.overlay=BFN.ImageOverlay,this.tools.push(this.overlay),this.toolContainer.addChild(this.overlay)};Oe.prototype.initLensFlare=function(){this.flare=BFN.ImageLensFlare,this.tools.push(this.flare),this.toolContainer.addChild(this.flare)};Oe.prototype.initCrop=function(){this.crop=BFN.ImageCrop,this.tools.push(this.crop),this.toolContainer.addChild(this.crop)};Oe.prototype.initRotator=function(){this.rotator=BFN.ImageRotator,this.rotator.interactive=!0,this.tools.push(this.rotator),this.toolContainer.addChild(this.rotator)};Oe.prototype.initResizer=function(){this.resizer=BFN.ImageResize,this.resizer.interactive=!0,this.tools.push(this.resizer),this.toolContainer.addChild(this.resizer)};Oe.prototype.initSlimming=function(){this.slimming=BFN.ImageSlimming,this.slimming.interactive=!0,this.tools.push(this.slimming),this.toolContainer.addChild(this.slimming)};Oe.prototype.initReshape=function(){this.reshape=BFN.ImageReshape,this.reshape.interactive=!0,this.tools.push(this.reshape),this.toolContainer.addChild(this.reshape)};Oe.prototype.initTilter=function(){this.tilter=BFN.ImageTilter,this.tilter.interactive=!0,this.tools.push(this.tilter),this.toolContainer.addChild(this.tilter)};Oe.prototype.initFocus=function(){this.focus=BFN.ImageFocus,this.tools.push(this.focus),this.toolContainer.addChild(this.focus)};Oe.prototype.initVignette=function(){this.vignette=BFN.ImageVignette,this.tools.push(this.vignette),this.toolContainer.addChild(this.vignette)};Oe.prototype.initPaintBrush=function(){this.paintBrush=BFN.ImagePaintBrush,this.tools.push(this.paintBrush),this.toolContainer.addChild(this.paintBrush)};Oe.prototype.initClone=function(){this.clone=BFN.ImageClone,this.tools.push(this.clone),this.toolContainer.addChild(this.clone)};Oe.prototype.initBlemish=function(){this.blemish=BFN.ImageBlemish,this.tools.push(this.blemish),this.toolContainer.addChild(this.blemish)};Oe.prototype.initBackground=function(){this.background=BFN.ImageBackground,this.tools.push(this.background),this.toolContainer.addChild(this.background)};Oe.prototype.initMatting=function(){this.matting=BFN.ImageMatting,this.tools.push(this.matting),this.toolContainer.addChild(this.matting)};Oe.prototype.initCutout=function(){this.cutout=BFN.ImageCutout,this.tools.push(this.cutout),this.toolContainer.addChild(this.cutout)};Oe.prototype.initPremiumWatermark=function(){this.premiumWatermark=BFN.PremiumWatermark,this.addChild(this.premiumWatermark)};Oe.prototype.handleEditorApplyCancel=function(){if(BFN.PhotoEditorCanvasModel.viewState!==BFN.PhotoEditorCanvasModelViewStates.VIEWING_CANVAS){let i=!BFN.applyCancelMenu.alternateApply&&!BFN.PhotoEditorCanvas.canvasToolsContainer.children.includes(BFN.PhotoEditorCanvas.canvasTools)&&!BFN.TransformItemIsolator.active,e=BFN.TransformItemIsolator.active||BFN.TransformModel.layerItem,t=this.currentTool?this.currentTool.hasOwnProperty("adjustScale")?this.currentTool.adjustScale:this.currentTool.scale.x:1,r=!1;if(UITools.getToolValue("editor_apply_cancel","updating_id")==="apply"){if(!BFN.applyCancelMenu.upgradeMode&&BFN.applyCancelMenu.alternateApply){switch(BFN.PhotoEditorCanvasModel.viewState){case BFN.PhotoEditorCanvasModelViewStates.VIEWING_CUTOUT:BFN.ImageCutout.showCutoutOptionsModal();break}return}r=this.applyCurrentTool()}else this.fitAfterApply=!1;if(BFN.ColorPickerPanel.colorButton&&(BFN.ColorPickerPanel.colorButton=null),e||(BFN.PhotoEditorCanvasModel.viewState=BFN.PhotoEditorCanvasModelViewStates.VIEWING_CANVAS,BFN.PhotoEditorCanvas.updateCanvasImage()),this.fitAfterApply){let a=BFN.AppModel.sectionValue(BFN.PhotoEditorCanvasModel,BFN.CollageMakerCanvasModel,BFN.DesignerCanvasModel),s=BFN.AppModel.sectionValue(BFN.PhotoEditorCanvasModelEvents.FIT_IMAGE_TO_FRAME_ANIMATED,BFN.CollageMakerCanvasModelEvents.FIT_COLLAGE_TO_FRAME_ANIMATED,BFN.DesignerCanvasModelEvents.FIT_DESIGNER_TO_FRAME_ANIMATED);t!=1&&(a.canvasScaling=!0,a.canvasScale*=t,a.canvasScaling=!1),a.dispatchEvent(s)}e?requestAnimationFrame(()=>{if(BFN.TransformItemIsolator.usingAlternateMenu){let a=document.getElementById("layer_isolator_tool_menu").querySelector("tabbed-layout");a&&a.activeTab===a.tabNames[1]&&(a.activeTab="")}i&&BFN.PhotoEditorCanvas.canvasToolsContainer.addChild(BFN.PhotoEditorCanvas.canvasTools),BFN.PhotoEditorCanvasModel.viewState=BFN.PhotoEditorCanvasModelViewStates.VIEWING_CANVAS,BFN.TransformItemIsolator.usingAlternateMenu&&(UIToggler.closeAlternateMenu(),BFN.TransformModel.layerItem=null,BFN.TransformItemIsolator.releaseTransformItem(r))}):i&&BFN.PhotoEditorCanvas.canvasToolsContainer.addChild(BFN.PhotoEditorCanvas.canvasTools)}};Oe.prototype.applyCurrentTool=function(i,e="_UPGRADE"){let t=this.premiumWatermark.showing&&!BFN.ImageEditManager.editingImage;if(this.fitAfterApply=!1,this.currentTool){!BFN.TransformModel.layerItem&&!BFN.TransformItemIsolator.active&&!t&&BFN.smoothPictureAction(()=>{BFN.PhotoEditorModel.updateCurrentTexture(this.currentTool.modifiedTexture)});let r="image_updated",a,s=null,o=null,n=Date.now(),l={};switch(this.currentTool){case this.touchup:r=BFN.EffectManager.parameters!=null&&BFN.EffectManager.parameters.hasOwnProperty("toolID")?BFN.EffectManager.parameters.toolID:BFN.EffectManager.effectID,l.hasParameters=!!BFN.EffectManager.parameters,l.hasParameters&&(l.toolID=BFN.EffectManager.parameters.toolID),l.effectID=BFN.EffectManager.effectID,r==="perfectskin"&&(r="skin_heal");let u="TOUCHUP";switch(r){case"fix_redeye":u="REDEYE";break;case"flashspot":u="FLASHSPOT_FIXER";break;case"blemish_fix":u="BLEMISH";break;case"clone":u="CLONE";break;case"eye_color":u="EYECOLOR";break;case"lipstick":u="LIPSTICK";break;case"bronzer":u="BRONZER";break;case"blush":u="BLUSH";break;case"wrinkles":u="WRINKLE_REMOVER";break;case"teeth_whiten":u="TEETH_WHITEN";break;case"eye_brighten":u="EYE_BRIGHTEN";break;case"eyebrow_pencil":u="EYEBROW_PENCIL";break;case"mascara":u="MASCARA";break;case"hair_color":u="HAIR_COLOR";break;case"perfectskin":u="PERFECT_SKIN";break;case"skin_heal":u="PERFECT_SKIN";break}t?BFN.BfnService.upgrade(i||"TOUCHUP",u+e,"touchup"):BFN.BfnService.track("CREATE","BASIC",u);break;case this.effect:if(r=BFN.EffectManager.effectID&&BFN.EffectManager.parameters&&BFN.EffectManager.parameters.hasOwnProperty("effectName")?BFN.EffectManager.parameters.effectName:BFN.EffectManager.effectID,l.hasParameters=!!BFN.EffectManager.parameters,l.hasParameters&&(l.effectName=BFN.EffectManager.parameters.effectName),l.effectID=BFN.EffectManager.effectID,BFN.EffectManager.parameters!=null&&BFN.EffectManager.parameters.hasOwnProperty("toolID"))try{let d="",m=BFN.effectPresetMap[BFN.EffectManager.parameters.toolID]?"photo_effects":BFN.EffectManager.parameters.toolID;BFN.UIToolData.hasOwnProperty(BFN.EffectManager.parameters.toolID)?(d=BFN.EffectManager.parameters.toolID.toUpperCase(),o=BFN.EffectManager.parameters.toolID):(d=BFN.EffectManager.parameters.toolID.split("_").slice(1).join("_").toUpperCase(),o=BFN.EffectManager.parameters.toolID),t?BFN.BfnService.upgrade(i||"BASIC_EFFECTS",d+e,m):BFN.BfnService.track("CREATE","BASIC_EFFECTS",d)}catch(d){}break;case this.artsy:if(r="artsy",o=BFN.ImageArtsy.currentToolID?BFN.ImageArtsy.currentToolID:null,BFN.ImageArtsy.currentToolID){if(BFN.ArtsyPresetObjects.hasOwnProperty(BFN.ImageArtsy.currentToolID)&&BFN.ArtsyPresetObjects[BFN.ImageArtsy.currentToolID]&&BFN.ArtsyPresetObjects[BFN.ImageArtsy.currentToolID].name)r=BFN.ArtsyPresetObjects[BFN.ImageArtsy.currentToolID].name,a=BFN.ArtsyPresetObjects[BFN.ImageArtsy.currentToolID].translation;else if(BFN.ArtsyAdjustAndPaintToolObjects.hasOwnProperty(BFN.ImageArtsy.currentToolID)){let d=BFN.ImageArtsy.currentToolID;r=BFN.ArtsyAdjustAndPaintToolObjects[d].name||d,o=d}}if(BFN.ImageArtsy.currentToolID!==void 0&&BFN.ImageArtsy.currentToolID!=null){let d=BFN.ArtsyPresetObjects.hasOwnProperty(BFN.ImageArtsy.currentToolID)?BFN.ArtsyPresetObjects[BFN.ImageArtsy.currentToolID].isArtsy?"artsy":"enhance_dlx":void 0;t?BFN.BfnService.upgrade(i||"EFFECTS",BFN.ImageArtsy.currentToolID.toUpperCase()+e,d):BFN.BfnService.track("CREATE","EFFECTS",BFN.ImageArtsy.currentToolID.toUpperCase())}break;case this.square:r="fit_to_square",this.fitAfterApply=!0,BFN.BfnService.track("CREATE","FRAMES","FIT_TO_SQUARE");break;case this.border:r="border",this.fitAfterApply=!0,BFN.BfnService.track("CREATE","FRAMES","BORDER");break;case this.dropShadow:r="drop_shadow",this.fitAfterApply=!0,BFN.BfnService.track("CREATE","FRAMES","DROP_SHADOW");break;case this.frame:r=BFN.ImageFrame.currentFrameName,a=BFN.ImageFrame.currentFrameTranslation,o=BFN.ImageFrame.currentFrameID?BFN.ImageFrame.currentFrameID:null,this.fitAfterApply=!0;try{let d=BFN.ImageFrame.currentFrameID.split("_").slice(2).join("_").toUpperCase();t?BFN.BfnService.upgrade(i||"FRAMES",d+e,"frames"):BFN.BfnService.track("CREATE","FRAMES",`FRAMES_${d}`)}catch(d){}break;case this.texture:r=BFN.ImageTexture.currentTextureName,a=BFN.ImageTexture.currentTextureTranslation,o=BFN.ImageTexture.currentTextureID?BFN.ImageTexture.currentTextureID:null;try{let d=BFN.ImageTexture.currentTextureID.split("_").slice(1).join("_").toUpperCase();t?BFN.BfnService.upgrade(i||"TEXTURE",d+e,"texture"):BFN.BfnService.track("CREATE","TEXTURE",d)}catch(d){}break;case this.overlay:r=BFN.ImageOverlay.currentOverlayName,a=BFN.ImageOverlay.currentOverlayTranslation,o=BFN.ImageOverlay.currentOverlayID?BFN.ImageOverlay.currentOverlayID:null;try{let d=BFN.ImageOverlay.currentOverlayID.split("_").slice(1).join("_").toUpperCase();t?BFN.BfnService.upgrade(i||"OVERLAY",d+e,"template"):BFN.BfnService.track("CREATE","OVERLAY",d)}catch(d){}break;case this.flare:r=BFN.ImageLensFlare.currentPresetName,o=BFN.ImageLensFlare.currentPresetID?BFN.ImageLensFlare.currentPresetID:null;try{let d=BFN.ImageLensFlare.currentPresetID.replace(" ","_").toUpperCase();t?BFN.BfnService.upgrade(i||"LENS_FLARE",d+e,"lens_flares"):BFN.BfnService.track("CREATE","LENS_FLARE",d)}catch(d){}break;case this.crop:BFN.BfnService.track("CREATE","BASIC","CROP"),r="crop",s=new PIXI.Point(this.crop.cropOffsetLeft,this.crop.cropOffsetTop),this.fitAfterApply=!0;break;case this.rotator:BFN.BfnService.track("CREATE","BASIC","ROTATE"),r="rotate",this.fitAfterApply=!0;break;case this.resizer:BFN.BfnService.track("CREATE","BASIC","RESIZE"),r="resize",this.fitAfterApply=!0;break;case this.slimming:t?BFN.BfnService.upgrade(i||"TOUCHUP",`SLIMMING${e}`,"touchup"):BFN.BfnService.track("CREATE","BASIC","WEIGHT_LOSS"),r="slimming";break;case this.reshape:t?BFN.BfnService.upgrade(i||"RESHAPE",`RESHAPE${e}`,"reshape"):BFN.BfnService.track("CREATE","BASIC","RESHAPE"),r="reshape";break;case this.tilter:BFN.BfnService.track("CREATE","BASIC","TILT"),r="tilt",this.fitAfterApply=!0;break;case this.focus:t?BFN.BfnService.upgrade(i||"EDIT",`FUNKY_FOCUS${e}`,"funky_focus"):BFN.BfnService.track("CREATE","BASIC","FUNKYFOCUS"),r="funky_focus";break;case this.vignette:t?BFN.BfnService.upgrade(i||"EDIT",`VIGNETTE${e}`,"vignette"):BFN.BfnService.track("CREATE","BASIC","VIGNETTE"),r="vignette";break;case this.paintBrush:BFN.BfnService.track("CREATE","BASIC","PAINT_BRUSH"),r="paint_brush";break;case this.clone:t?BFN.BfnService.upgrade(i||"TOUCHUP",`CLONE${e}`,"clone"):BFN.BfnService.track("CREATE","BASIC","CLONE"),r="clone";break;case this.blemish:BFN.BfnService.track("CREATE","BASIC","BLEMISH"),r="blemish_fix";break;case this.background:t?BFN.BfnService.upgrade(i||"EDIT",`BACKGROUND${e}`,"background"):BFN.BfnService.track("CREATE","BASIC","BACKGROUND"),r="background";break;case this.matting:t?BFN.BfnService.upgrade(i||"EDIT",`MATTING${e}`,"matting"):BFN.BfnService.track("CREATE","BASIC","MATTING"),r="matting";break;case this.cutout:t?BFN.BfnService.upgrade(i||"EDIT",`CUTOUT${e}`,"cutout"):BFN.BfnService.track("CREATE","BASIC","CUTOUT"),r="cutout";break}r||(BeFunky.throwError("Missing historyTag",BFN.PhotoEditorCanvasModel.viewState,JSON.stringify(l)),r="image_updated"),o||(o=r);let c=BFN.UserActionManager.getEditorToolObject(o);if(c.imageLayer=!1,t){let u=[c.toolType,c.toolName];return c.toolSearchID&&u.push(c.toolSearchID),BFN.UserActionManager.addUpgradeAction(u),!1}if(BFN.TransformModel.layerItem&&BFN.TransformItemIsolator.active){if(!["texture","frame_texture"].includes(BFN.TransformModel.layerItem.type))return!1;let u=BFN.TransformItemIsolator.isolatedTransformItem,d=BFN.TransformItemIsolator.itemTexture,{sourceTexture:m}=this.currentTool,p;BFN.smoothPictureAction(()=>{p=this.currentTool.modifiedTexture});let g=new BFN.Rectangle((m.width-p.width)/2,(m.height-p.height)/2,p.width,p.height);switch(this.currentTool){case this.crop:g=this.crop.cropRect;break;case this.cutout:this.cutout.trimTransparency&&this.cutout.cutoutRect&&(g=this.cutout.cutoutRect);break}if(!g)return!1;p.rotate=u.type==="texture"?0:[0,12,8,4][u.flippedHorizontal+u.flippedVertical*2];let f=p.renderClone();p.copyPixels(f),f.destroyGC(!0),BFN.TransformItemIsolator.usingAlternateMenu&&(this.fitAfterApply=!1,p.width>d.width||p.height>d.height?(d.resize(p.width,p.height),d.copyPixels(p)):d.copyPixels(p,{x:g.x,y:g.y}));let T=BFN.ImageLibraryManager.createMenuImageVOFromTexture(p,null,!1).id;switch(u.type){case"texture":{let x=u.itemContentW*u.scale.x,B=u.itemContentH*u.scale.y,y=x*(g.x/m.width),F=B*(g.y/m.height),b=Math.sqrt(Math.pow(y,2)+Math.pow(F,2)),S=Math.atan2(F,y)+u.rotation,I={x:Math.cos(S)*b,y:Math.sin(S)*b};u.replaceImage({_imageID:T,_imageTexture:p,_historyTag:r,_historyTranslation:a,_xOffset:I.x,_yOffset:I.y});break}case"frame_texture":{let x=u.itemContent,B=x.frameWidth*(g.x/m.width),y=x.frameHeight*(g.y/m.height),F=Math.sqrt(Math.pow(B,2)+Math.pow(y,2)),b=Math.atan2(y,B)+u.rotation,S={x:Math.cos(b)*F,y:Math.sin(b)*F},I={frameWidth:x.frameWidth*(p.width/m.width),frameHeight:x.frameHeight*(p.height/m.height)},_=Math.max(I.frameWidth/p.width,I.frameHeight/p.height),E=p.width*_,D=p.height*_;I.textureScaleX=I.frameWidth/E,I.textureScaleY=I.frameHeight/D,u.replaceImage({_imageID:T,_imageTexture:p,_historyTag:r,_historyTranslation:a,_xOffset:S.x,_yOffset:S.y,_keepFrameTextureParams:!1,_frameTextureParams:I,_maintainFlipState:!0});break}}p.baseTexture.imageOffset={x:-(p.width/2)-(g.x-m.width/2),y:-(p.height/2)-(g.y-m.height/2)},u.transitionVO&&(n=u.transitionVO.timestamp),c.imageLayer=!0,BFN.TransformItemIsolator.imageLayerEdited=!0}else BFN.AppModel.viewingEditor&&(n=BFN.PhotoEditorHistoryModel.addTextureToHistory(r,BFN.PhotoEditorModel.currentTexture,a),s&&(BFN.PhotoEditorCanvasModel.itemOffsetPoint=s));Array.isArray(a)?UIMessages.display(`${BeFunky.LanguageManager.getStringReplacements(...a)} ${BeFunky.LanguageManager.getString("applied")}`):UIMessages.display(`${BeFunky.LanguageManager.getString(a||r)} ${BeFunky.LanguageManager.getString("applied")}`);let h=new BFN.UserActionVO;return h.eventID="editing_applied",h.eventObject=c,h.actionSection=BFN.AppModel.sectionValue("editor","collage","designer"),h.actionTimestamp=n,h.register(),!0}};Oe.prototype.updateToolView=function(){let i=!1;!this.altSourceTexture&&BFN.TransformItemIsolator.active&&BFN.TransformItemIsolator.altSourceTexture&&(this.altSourceTexture=BFN.TransformItemIsolator.altSourceTexture,i=!0);let e=this.altSourceTexture?this.altSourceTexture:BFN.PhotoEditorModel.currentTexture;if(i&&(this.altSourceTexture=null),this.toolMap.hasOwnProperty(BFN.PhotoEditorCanvasModel.viewState)){let a=this.toolMap[BFN.PhotoEditorCanvasModel.viewState];this.hasOwnProperty(a.id)||a.init()}BFN.applyCancelMenu.alternateApply=!1;for(let a in this.toolMap){let s=this.toolMap[a];if(this.hasOwnProperty(s.id)){let o=this[s.id];o.visible=BFN.PhotoEditorCanvasModel.viewState===a,o.setSourceTexture(o.visible&&e!=null?e:null)}}this.updateToolScales(),this.currentTool&&(this.currentTool.off("pointerover",this.handleToolOverBind),this.currentTool.off("pointerout",this.handleToolOutBind),this.currentTool.off("pointerdown",this.handleToolPressedBind)),this.currentTool=null;for(let a=0;a<this.tools.length;a++){let s=this.tools[a];s.visible&&(this.currentTool=s)}if(this.currentTool)this.currentTool.interactive&&(this.currentTool.on("pointerover",this.handleToolOverBind),this.currentTool.on("pointerout",this.handleToolOutBind),this.currentTool.on("pointerdown",this.handleToolPressedBind)),this.updatePremiumWatermarkDimensions();else{this.premiumWatermark.currentToolID=null,this.premiumWatermark.updateDisplay(),BFN.ImagePainterUndoManager.reset();try{BFN.FilterHelper.emptyPoolForFilter()}catch(a){}}let t=BFN.AppModel.sectionValue(BFN.PhotoEditorCanvasModel,BFN.CollageMakerCanvasModel,BFN.DesignerCanvasModel),r=BFN.AppModel.sectionValue(BFN.PhotoEditorCanvasModelEvents.FIT_IMAGE_TO_FRAME_ANIMATED,BFN.CollageMakerCanvasModelEvents.FIT_COLLAGE_TO_FRAME_ANIMATED,BFN.DesignerCanvasModelEvents.FIT_DESIGNER_TO_FRAME_ANIMATED);switch(this.currentTool){case this.square:case this.border:case this.dropShadow:case this.frame:case this.overlay:case this.flare:case this.crop:case this.rotator:case this.resizer:case this.slimming:case this.tilter:case this.focus:case this.vignette:t.dispatchEvent(r);break;default:this.altSourceTexture&&t.dispatchEvent(r);break}BFN.GlobalHistoryModel.updateGlobalHistoryMenuState(),this.currentTool||setTimeout(()=>{BFN.MainUI.renderCanvas(),setTimeout(()=>{BFN.MainUI.renderCanvas()},BFN.frameInterval)},BFN.frameInterval)};Oe.prototype.updateToolScales=function(){switch(this.premiumWatermark.canvasScale=this._scale,this.effect&&(this.effect.toolScale=this._scale),BFN.PhotoEditorCanvasModel.viewState){case BFN.PhotoEditorCanvasModelViewStates.VIEWING_TOUCH_UP:this.touchup.toolScale=this._scale;break;case BFN.PhotoEditorCanvasModelViewStates.VIEWING_EFFECT:this.effect.toolScale=this._scale;break;case BFN.PhotoEditorCanvasModelViewStates.VIEWING_ARTSY:this.artsy.toolScale=this._scale;break;case BFN.PhotoEditorCanvasModelViewStates.VIEWING_SQUARE:this.square.toolScale=this._scale;break;case BFN.PhotoEditorCanvasModelViewStates.VIEWING_BORDER:this.border.toolScale=this._scale;break;case BFN.PhotoEditorCanvasModelViewStates.VIEWING_DROP_SHADOW:this.dropShadow.toolScale=this._scale;break;case BFN.PhotoEditorCanvasModelViewStates.VIEWING_FRAME:this.frame.toolScale=this._scale;break;case BFN.PhotoEditorCanvasModelViewStates.VIEWING_TEXTURE:this.texture.toolScale=this._scale;break;case BFN.PhotoEditorCanvasModelViewStates.VIEWING_OVERLAY:this.overlay.toolScale=this._scale;break;case BFN.PhotoEditorCanvasModelViewStates.VIEWING_LENS_FLARE:this.flare.toolScale=this._scale;break;case BFN.PhotoEditorCanvasModelViewStates.VIEWING_CROP:this.crop.toolScale=this._scale;break;case BFN.PhotoEditorCanvasModelViewStates.VIEWING_ROTATE:this.rotator.toolScale=this._scale;break;case BFN.PhotoEditorCanvasModelViewStates.VIEWING_RESIZE:this.resizer.toolScale=this._scale;break;case BFN.PhotoEditorCanvasModelViewStates.VIEWING_SLIMMING:this.slimming.toolScale=this._scale;break;case BFN.PhotoEditorCanvasModelViewStates.VIEWING_RESHAPE:this.reshape.toolScale=this._scale;break;case BFN.PhotoEditorCanvasModelViewStates.VIEWING_TILT:this.tilter.toolScale=this._scale;break;case BFN.PhotoEditorCanvasModelViewStates.VIEWING_FOCUS:this.focus.toolScale=this._scale;break;case BFN.PhotoEditorCanvasModelViewStates.VIEWING_VIGNETTE:this.vignette.toolScale=this._scale;break;case BFN.PhotoEditorCanvasModelViewStates.VIEWING_PAINT_BRUSH:this.paintBrush.toolScale=this._scale;break;case BFN.PhotoEditorCanvasModelViewStates.VIEWING_CLONE:this.clone.toolScale=this._scale;break;case BFN.PhotoEditorCanvasModelViewStates.VIEWING_BLEMISH_FIX:this.blemish.toolScale=this._scale;break;case BFN.PhotoEditorCanvasModelViewStates.VIEWING_BACKGROUND:this.background.toolScale=this._scale;break;case BFN.PhotoEditorCanvasModelViewStates.VIEWING_MATTING:this.matting.toolScale=this._scale;break;case BFN.PhotoEditorCanvasModelViewStates.VIEWING_CUTOUT:this.cutout.toolScale=this._scale;break}};Oe.prototype.updatePremiumWatermarkDimensions=function(){if(this.currentTool){let i=0,e=0;this.currentTool.hasOwnProperty("itemWidth")&&this.currentTool.hasOwnProperty("itemHeight")?(i=this.currentTool.itemWidth,e=this.currentTool.itemHeight):BFN.TransformItemIsolator.active?(i=BFN.TransformItemIsolator.itemWidth,e=BFN.TransformItemIsolator.itemHeight):BFN.AppModel.viewingEditor&&BFN.PhotoEditorModel.currentTexture&&(i=BFN.PhotoEditorModel.currentTexture.width,e=BFN.PhotoEditorModel.currentTexture.height),this.premiumWatermark.setDimensions(i,e)}};Oe.prototype.handleCanvasViewStateUpdated=function(i){this.updateToolView(),BFN.PhotoEditorCanvas.updateCheckerPanel(),BFN.PhotoEditorCanvas.updateToolPosition()};Oe.prototype.handleToolDimensionsUpdated=function(i){this.updatePremiumWatermarkDimensions()};Oe.prototype.handleToolOver=function(i){(!BFN.ImagePainterUndoManager.currentImagePainter||BFN.ImagePainterUndoManager.currentImagePainter&&!BFN.ImagePainterUndoManager.currentImagePainter.paintingEnabled)&&this.dispatchEvent(BFN.PhotoEditorCanvasToolsEvents.TOOL_OVER)};Oe.prototype.handleToolOut=function(i){this.dispatchEvent(BFN.PhotoEditorCanvasToolsEvents.TOOL_OUT)};Oe.prototype.handleToolPressed=function(i){(!BFN.ImagePainterUndoManager.currentImagePainter||BFN.ImagePainterUndoManager.currentImagePainter&&!BFN.ImagePainterUndoManager.currentImagePainter.paintingEnabled)&&this.dispatchEvent(BFN.PhotoEditorCanvasToolsEvents.START_CANVAS_DRAG),this.toolPressed=!0,document.addEventListener(BeFunky.pointerup,this.handleToolReleasedBind)};Oe.prototype.handleToolReleased=function(i){this.toolPressed=!1,document.removeEventListener(BeFunky.pointerup,this.handleToolReleasedBind)};Object.defineProperty(Oe.prototype,"scale",{set(i){this._scale=i,this.updateToolScales()},get(){return this._scale}});Object.defineProperty(Oe.prototype,"scaling",{set(i){this._scaling=i,this.premiumWatermark.canvasScaling=this._scaling,this.currentTool&&(this.currentTool.toolScaling=this._scaling)},get(){return this._scaling}});BFN.SingletonQueue.add(()=>{BFN.PhotoEditorCanvasTools=new Oe});function xe(){PIXI.Sprite.call(this),this.init()}xe.prototype=Object.create(PIXI.Sprite.prototype);xe.prototype.init=function(){BeFunky.log("PhotoEditorCanvas Init"),this.initDefaultValues(),this.initCheckerPanel(),this.initCanvas(),this.initCanvasImageOriginal(),this.initCanvasImage(),this.initCanvasTools(),this.initTransformCanvas(),this.initTransformLayer(),this.initCanvasPixelGrid(),this.initTransformLayerVeil(),this.initCanvasGlow(),this.initTransformIndicatorContainer(),this.initTransformGuidesContainer(),this.initTransformItemBoundingBoxesContainer(),this.initTransformTool(),this.initTransformToolSnapGaps(),this.initTransformItemIsolator(),this.initLayerToolContainer(),this.initMoveTouchSurface(),this.initCanvasDragger(),this.initAnimators(),BFN.AppModel.viewingEditor&&this.updateCanvasView()};xe.prototype.initDefaultValues=function(){this.interactive=!0,this.mouseOver=!1,this.hoverSurfaceOver=!1,this.model=BFN.PhotoEditorCanvasModel,BFN.StageModel.addEventListener(BFN.StageModelEvents.STAGE_DIMENSIONS_UPDATED.type,this.handleStageDimensionsUpdated.bind(this)),BFN.PhotoEditorModel.addEventListener(BFN.PhotoEditorModelEvents.SOURCE_IMAGE_UPDATED.type,this.handleSourceImageUpdated.bind(this)),BFN.PhotoEditorModel.addEventListener(BFN.PhotoEditorModelEvents.CURRENT_IMAGE_UPDATED.type,this.handleCurrentImageUpdated.bind(this)),BFN.PhotoEditorCanvasModel.addEventListener(BFN.PhotoEditorCanvasModelEvents.VIEWSTATE_UPDATED.type,this.handleCanvasViewStateUpdated.bind(this)),BFN.PhotoEditorCanvasModel.addEventListener(BFN.PhotoEditorCanvasModelEvents.CANVAS_SCALE_UPDATED.type,this.handleCanvasScaleUpdated.bind(this)),BFN.PhotoEditorCanvasModel.addEventListener(BFN.PhotoEditorCanvasModelEvents.CANVAS_SCALING_UPDATED.type,this.handleCanvasScalingUpdated.bind(this)),BFN.PhotoEditorCanvasModel.addEventListener(BFN.PhotoEditorCanvasModelEvents.FIT_IMAGE_TO_FRAME.type,this.handleFitImageToFrame.bind(this)),BFN.PhotoEditorCanvasModel.addEventListener(BFN.PhotoEditorCanvasModelEvents.FIT_IMAGE_TO_FRAME_ANIMATED.type,this.handleFitImageToFrameAnimated.bind(this)),BFN.PhotoEditorCanvasModel.addEventListener(BFN.PhotoEditorCanvasModelEvents.ITEM_ADDED.type,this.handleItemAdded.bind(this)),BFN.PhotoEditorCanvasModel.addEventListener(BFN.PhotoEditorCanvasModelEvents.OFFSET_ITEMS.type,this.handleOffsetItems.bind(this)),BFN.PhotoEditorCanvasModel.addEventListener(BFN.PhotoEditorCanvasModelEvents.FLATTEN_ITEMS.type,this.handleFlattenItems.bind(this)),BFN.PhotoEditorCanvasModel.addEventListener(BFN.PhotoEditorCanvasModelEvents.CLEAR_ITEMS.type,this.handleClearItems.bind(this)),this.on("pointerover",this.handleCanvasMouseOver.bind(this)),this.on("pointerout",this.handleCanvasMouseOut.bind(this)),this.handleCanvasKeyDownBind=this.handleCanvasKeyDown.bind(this),this.handleCanvasSpaceKeyUpBind=this.handleCanvasSpaceKeyUp.bind(this),this.handleCanvasOKeyUpBind=this.handleCanvasOKeyUp.bind(this),document.addEventListener("keydown",this.handleCanvasKeyDownBind,!0)};xe.prototype.initCheckerPanel=function(){this.checkerPanel=new BFN.CheckerPanel,this.checkerPanel.setDimensions(0,0),this.addChild(this.checkerPanel)};xe.prototype.initCanvas=function(){this.canvasContainer=new PIXI.Sprite,this.canvasContainer.interactive=!0,this.addChild(this.canvasContainer),this.canvas=new PIXI.Sprite,this.canvasContainer.addChild(this.canvas)};xe.prototype.initCanvasImageOriginal=function(){this.canvasImageOriginal=new PIXI.Sprite,this.canvasImageOriginal.interactive=!0,this.canvasImageOriginal.visible=!1,this.canvasImageOriginal.pluginName="smooth_picture",this.canvasImageOriginal.on("pointerover",this.handleHoverSurfaceOver.bind(this)),this.canvasImageOriginal.on("pointerout",this.handleHoverSurfaceOut.bind(this)),this.canvasImageOriginal.on("pointerdown",this.handleCanvasImagePressed.bind(this)),this.canvas.addChild(this.canvasImageOriginal)};xe.prototype.initCanvasImage=function(){this.canvasImage=BFN.PhotoEditorCanvasImage,this.canvasImage.pluginName="smooth_picture",this.canvasImage.on("pointerover",this.handleHoverSurfaceOver.bind(this)),this.canvasImage.on("pointerout",this.handleHoverSurfaceOut.bind(this)),this.canvasImage.on("pointerdown",this.handleCanvasImagePressed.bind(this)),this.canvas.addChild(this.canvasImage)};xe.prototype.initCanvasTools=function(){this.canvasToolsContainer=new PIXI.Container,this.canvasContainer.addChild(this.canvasToolsContainer),this.canvasTools=BFN.PhotoEditorCanvasTools,this.canvasToolsContainer.addChild(this.canvasTools),this.canvasTools.addEventListener(BFN.PhotoEditorCanvasToolsEvents.TOOL_OVER.type,this.handleHoverSurfaceOver.bind(this)),this.canvasTools.addEventListener(BFN.PhotoEditorCanvasToolsEvents.TOOL_OUT.type,this.handleHoverSurfaceOut.bind(this)),this.canvasTools.addEventListener(BFN.PhotoEditorCanvasToolsEvents.START_CANVAS_DRAG.type,this.handleToolStartCanvasDrag.bind(this)),this.canvasTools.addEventListener(BFN.PhotoEditorCanvasToolsEvents.TOOL_DIMENSIONS_UPDATED.type,this.handleToolDimensionsUpdated.bind(this))};xe.prototype.initTransformCanvas=function(){this.transformCanvas=new PIXI.Container,this.transformCanvas.interactive=!1,this.canvasContainer.addChild(this.transformCanvas)};xe.prototype.initTransformLayer=function(){this.transformLayer=new BFN.TransformLayer(BFN.AppModelViewStates.VIEWING_PHOTO_EDITOR,this),this.transformLayer.addEventListener(BFN.TransformLayerEvents.ITEMS_UPDATED.type,this.handleTransformItemsUpdated.bind(this)),this.transformLayer.addEventListener(BFN.TransformLayerEvents.ITEM_SELECTED.type,this.handleTransformItemSelected.bind(this)),this.transformLayer.addEventListener(BFN.TransformLayerEvents.ITEM_DISPLAY_UPDATED.type,this.handleTransformItemDisplayUpdated.bind(this)),this.canvas.addChild(this.transformLayer)};xe.prototype.initCanvasPixelGrid=function(){BFN.PhotoEditorCanvasModel.usePixelGrid&&(this.canvasPixelGrid=new BFN.PixelGrid,this.canvas.addChild(this.canvasPixelGrid))};xe.prototype.initTransformLayerVeil=function(){this.transformLayerVeil=new BFN.CanvasFrame(ht().hex,1,BFN.PhotoEditorCanvasModel.imageFitPaddingX,BFN.PhotoEditorCanvasModel.imageFitPaddingY),this.addChild(this.transformLayerVeil),ui(({hex:i})=>{this.transformLayerVeil.color=i})};xe.prototype.initCanvasGlow=function(){this.canvasGlow=new BFN.CanvasGlow,this.addChild(this.canvasGlow)};xe.prototype.initTransformIndicatorContainer=function(){this.transformIndicatorContainer=new PIXI.Container,this.transformIndicatorContainer.interactiveChildren=!1,this.addChild(this.transformIndicatorContainer)};xe.prototype.initTransformGuidesContainer=function(){this.transformGuidesContainer=new PIXI.Container,this.addChild(this.transformGuidesContainer)};xe.prototype.initTransformItemBoundingBoxesContainer=function(){this.transformItemBoundingBoxesContainer=new PIXI.Container,this.addChild(this.transformItemBoundingBoxesContainer)};xe.prototype.initTransformTool=function(){this.transformTool=new BFN.TransformTool(this.transformLayer),this.addChild(this.transformTool),this.transformLayer.transformTool=this.transformTool};xe.prototype.initTransformToolSnapGaps=function(){this.transformToolSnapGapsContainer=new PIXI.Container,this.addChild(this.transformToolSnapGapsContainer)};xe.prototype.initTransformItemIsolator=function(){this.transformItemIsolatorContainer=new PIXI.Container,this.canvasContainer.addChild(this.transformItemIsolatorContainer)};xe.prototype.initLayerToolContainer=function(){this.layerToolContainer=new PIXI.Container,this.addChild(this.layerToolContainer)};xe.prototype.initMoveTouchSurface=function(){this.moveTouchSurface=new PIXI.Graphics,this.moveTouchSurface.interactive=!0,this.moveTouchSurface.visible=!1,this.moveTouchSurface.beginFill(0,0),this.moveTouchSurface.drawRect(-50,-50,100,100),this.moveTouchSurface.endFill(),this.moveTouchSurface.on("pointerover",this.handleHoverSurfaceOver.bind(this)),this.moveTouchSurface.on("pointerout",this.handleHoverSurfaceOut.bind(this)),this.moveTouchSurface.on("pointerdown",this.handleMoveTouchSurfacePressed.bind(this)),this.addChild(this.moveTouchSurface)};xe.prototype.initCanvasDragger=function(){this.canvasDragger=new BFN.Dragger,this.canvasDragger.pixelDragThreshold=5,this.canvasDragger.pixelDragThresholdPreventEvent=!0,this.canvasDragger.addEventListener(BFN.DraggerEvents.DRAGGING.type,this.handleCanvasDraggerDragging.bind(this)),this.canvasDragger.addEventListener(BFN.DraggerEvents.DRAGGING_COMPLETE.type,this.handleCanvasDraggerDraggingComplete.bind(this))};xe.prototype.initAnimators=function(){this.fitImageAnimator=new BFN.Animator,this.fitImageAnimator.linearSteps=10,this.fitImageAnimator.addEventListener(BFN.AnimatorEvents.UPDATE.type,this.handleFitImageAnimatorUpdate.bind(this)),this.fitImageAnimator.addEventListener(BFN.AnimatorEvents.UPDATE_COMPLETE.type,this.handleFitImageAnimatorUpdateComplete.bind(this))};xe.prototype.updateCanvasContainerPosition=function(){let i=BFN.MainUI.viewportOverrideW||BFN.StageModel.stageW,e=BFN.MainUI.viewportOverrideH||BFN.StageModel.stageH,t=BFN.PhotoEditorCanvasModel.imageFitPaddingX*2,r=BFN.PhotoEditorCanvasModel.imageFitPaddingY*2,a=this.canvasImageOriginal.visible?this.canvasImageOriginal.texture.width:this.canvasImage.imageWidth,s=this.canvasImageOriginal.visible?this.canvasImageOriginal.texture.height:this.canvasImage.imageHeight;BFN.TransformItemIsolator.active&&this.transformItemIsolatorContainer.children.includes(BFN.TransformItemIsolator)&&(a=a-(a-BFN.TransformItemIsolator.itemWidth)*BFN.TransformItemIsolator.activeFactor,s=s-(s-BFN.TransformItemIsolator.itemHeight)*BFN.TransformItemIsolator.activeFactor),!this.canvasImageOriginal.visible&&BFN.PhotoEditorCanvasTools.currentTool&&BFN.PhotoEditorCanvasTools.currentTool.hasOwnProperty("itemWidth")&&BFN.PhotoEditorCanvasTools.currentTool.hasOwnProperty("itemHeight")&&(a=BFN.PhotoEditorCanvasTools.currentTool.itemWidth,s=BFN.PhotoEditorCanvasTools.currentTool.itemHeight),this.canvasImageOriginal.visible&&(this.canvasImageOriginal.x=(this.canvasImage.imageWidth-this.canvasImageOriginal.texture.width)/2,this.canvasImageOriginal.y=(this.canvasImage.imageHeight-this.canvasImageOriginal.texture.height)/2);let o=a?this.scale.x*a:1,n=s?this.scale.y*s:1,l=Math.max(0,a-i/o*a+1/this.scale.x*t),c=Math.max(0,s-e/n*s+1/this.scale.y*r);this.canvasDragger.setBounds(-(l/2),-(c/2),l/2,c/2),this.canvasContainer.x=Math.round(Math.min(this.canvasDragger.bounds.maxX,Math.max(this.canvasDragger.bounds.minX,this.canvasContainer.x))),this.canvasContainer.y=Math.round(Math.min(this.canvasDragger.bounds.maxY,Math.max(this.canvasDragger.bounds.minY,this.canvasContainer.y)))};xe.prototype.updateCanvasContainerDisplay=function(){this.updateCanvasContainerPosition(),this.layerToolContainer.x=this.canvasContainer.x,this.layerToolContainer.y=this.canvasContainer.y,this.transformItemBoundingBoxesContainer.x=this.canvasContainer.x,this.transformItemBoundingBoxesContainer.y=this.canvasContainer.y,this.updateCheckerPanel(),this.updateTransformLayerVeil(),this.updateToolPosition(),BFN.TransformGuides.updateDisplay(),BFN.MainUI.requestRender()};xe.prototype.updateToolPosition=function(){this.transformTool.x=this.canvasContainer.x,this.transformTool.y=this.canvasContainer.y,this.transformLayerVeil.x=this.canvasContainer.x+this.canvas.x+this.canvasImage.imageWidth/2,this.transformLayerVeil.y=this.canvasContainer.y+this.canvas.y+this.canvasImage.imageHeight/2};xe.prototype.updateCanvasImage=function(){BFN.PhotoEditorModel.currentTexture==null?(this.canvasImage.texture=PIXI.Texture.EMPTY,this.canvas.x=this.transformCanvas.x=0,this.canvas.y=this.transformCanvas.y=0):(this.canvasImage.texture=BFN.PhotoEditorModel.currentTexture,this.canvas.x=this.transformCanvas.x=-Math.round(this.canvasImage.texture.width/2),this.canvas.y=this.transformCanvas.y=-Math.round(this.canvasImage.texture.height/2)),this.transformLayer.x=-this.canvas.x,this.transformLayer.y=-this.canvas.y,this.canvasPixelGrid&&(this.canvasPixelGrid.x=this.transformLayer.x,this.canvasPixelGrid.y=this.transformLayer.y),this.updateCanvasContainerDisplay(),BFN.MainUI.requestRender()};xe.prototype.updateCanvasView=function(){switch(this.canvasImage.visible=BFN.PhotoEditorCanvasModel.viewState==BFN.PhotoEditorCanvasModelViewStates.VIEWING_CANVAS,this.canvasTools.visible=!this.canvasImage.visible,this.transformLayer.visible=this.canvasImage.visible,this.transformTool.visible=this.canvasImage.visible,BFN.PhotoEditorCanvasModel.viewState){case BFN.PhotoEditorCanvasModelViewStates.VIEWING_CANVAS:this.transformLayer.visible=!0,this.transformLayer.enableChildren(),this.canvas.addChild(this.transformLayer),this.canvasPixelGrid&&this.canvas.addChild(this.canvasPixelGrid);break;default:this.transformLayer.visible=!1,this.transformLayer.disableChildren(),this.transformCanvas.addChild(this.transformLayer)}this.transformLayerVeil.visible=BFN.PhotoEditorCanvasModel.viewState==BFN.PhotoEditorCanvasModelViewStates.VIEWING_CANVAS,this.updateTransformLayerVeil(),BFN.ZoomManager.updateZoomRange(),BFN.MainUI&&BFN.MainUI.requestRender()};xe.prototype.updatePosition=function(){this.x=Math.round(BFN.StageModel.stageW/2),this.y=Math.round(BFN.StageModel.stageH/2),this.transformGuidesContainer.x=-(this.x/this.scale.x),this.transformGuidesContainer.y=-(this.y/this.scale.y),BFN.TransformGuides.updateDisplay(),this.updateTransformLayerVeilOuterDimensions(),this.updateCanvasContainerDisplay()};xe.prototype.updateScale=function(){this.scale.x=this.scale.y=this.canvasTools.scale=this.transformLayer.canvasScale=this.transformTool.scale=this.canvasDragger.scale=BFN.PhotoEditorCanvasModel.canvasScale,this.transformItemBoundingBoxesContainer.children.includes(BFN.TransformItemBoundingBoxes)&&(BFN.TransformItemBoundingBoxes.lineScale=BFN.PhotoEditorCanvasModel.canvasScale),this.transformGuidesContainer.scale.x=1/this.scale.x,this.transformGuidesContainer.scale.y=1/this.scale.y,this.transformGuidesContainer.x=-(this.x/this.scale.x),this.transformGuidesContainer.y=-(this.y/this.scale.y),BFN.TransformGuides.updateDisplay(),this.canvasImage.currentScale=this.canvasImageOriginal.currentScale=BFN.PhotoEditorCanvasModel.canvasScale,this.transformLayerVeil.canvasScale=BFN.PhotoEditorCanvasModel.canvasScale,this.canvasGlow.canvasScale=BFN.PhotoEditorCanvasModel.canvasScale,this.canvasPixelGrid&&(this.canvasPixelGrid.canvasScale=BFN.PhotoEditorCanvasModel.canvasScale),this.updateCanvasContainerDisplay(),BFN.MainUI.requestRender()};xe.prototype.fitImageToFrame=function(i=!1){let e=BFN.PhotoEditorCanvasModel.imageFitPaddingX*2,t=BFN.PhotoEditorCanvasModel.imageFitPaddingY*2,r=this.canvasImage.width,a=this.canvasImage.height;BFN.TransformItemIsolator.active&&BFN.TransformItemIsolator.itemWidth>0&&BFN.TransformItemIsolator.itemHeight>0&&(r=BFN.TransformItemIsolator.itemWidth,a=BFN.TransformItemIsolator.itemHeight);let s=BFN.PhotoEditorCanvasModel.viewState!==BFN.PhotoEditorCanvasModelViewStates.VIEWING_CANVAS?BFN.PhotoEditorCanvasTools.currentTool:null;s&&(r=s.hasOwnProperty("itemWidth")?s.itemWidth:r,a=s.hasOwnProperty("itemHeight")?s.itemHeight:a),!(r<=0||a<=0)&&(this.fitScale=Math.min(1,(BFN.StageModel.stageW-e)/r,(BFN.StageModel.stageH-t)/a),i?(BFN.PhotoEditorCanvasModel.canvasScaling=!0,this.startScale=BFN.PhotoEditorCanvasModel.canvasScale,Math.abs(this.fitScale-this.startScale)>.001?this.fitImageAnimator.setAnimatorFactor(0):this.fitImageAnimator.setAnimatorFactor(1),this.fitImageAnimator.increase()):(BFN.PhotoEditorCanvasModel.canvasScale=this.fitScale,BFN.PhotoEditorCanvasModel.canvasScaling=!1,BFN.ZoomManager.updateZoomRange()))};xe.prototype.updateCheckerPanel=function(){this.checkerPanel.x=this.canvasContainer.x+this.canvas.x+this.canvasImage.imageWidth/2,this.checkerPanel.y=this.canvasContainer.y+this.canvas.y+this.canvasImage.imageHeight/2,this.checkerPanel.scale=BFN.PhotoEditorCanvasModel.canvasScale;let i={x:0,y:0};if(this.canvasImageOriginal.visible)this.canvasImageOriginal.texture.width>1&&this.canvasImageOriginal.texture.height>1&&(i.x=this.canvasImageOriginal.texture.width,i.y=this.canvasImageOriginal.texture.height);else if(BFN.PhotoEditorCanvasModel.viewState===BFN.PhotoEditorCanvasModelViewStates.VIEWING_CANVAS)this.canvasImage.imageWidth>1&&this.canvasImage.imageHeight>1&&(i.x=this.canvasImage.imageWidth,i.y=this.canvasImage.imageHeight);else{let e=BFN.PhotoEditorCanvasTools.currentTool;if(e&&!(e.itemWidth===void 0||e.itemHeight===void 0)){let t=e.itemWidth,r=e.itemHeight;i.x=t,i.y=r}else i.x=this.canvasImage.imageWidth,i.y=this.canvasImage.imageHeight}if(BFN.TransformItemIsolator.active&&this.transformItemIsolatorContainer.children.includes(BFN.TransformItemIsolator)){let e=BFN.TransformItemIsolator.itemWidth,t=BFN.TransformItemIsolator.itemHeight;BFN.TransformItemIsolator.shiftAnimator.animating&&(e=BFN.TransformItemIsolator.shiftParamsEnd.w-(BFN.TransformItemIsolator.shiftParamsEnd.w-BFN.TransformItemIsolator.shiftParamsStart.w)*(1-BFN.TransformItemIsolator.shiftAnimator.animationSinFactor),t=BFN.TransformItemIsolator.shiftParamsEnd.h-(BFN.TransformItemIsolator.shiftParamsEnd.h-BFN.TransformItemIsolator.shiftParamsStart.h)*(1-BFN.TransformItemIsolator.shiftAnimator.animationSinFactor)),i.x=i.x-(i.x-e)*BFN.TransformItemIsolator.activeFactor,i.y=i.y-(i.y-t)*BFN.TransformItemIsolator.activeFactor}this.checkerPanel.setDimensions(i.x,i.y),this.updateCanvasGlow()};xe.prototype.updateCanvasGlow=function(){let i=this.checkerPanel.width,e=this.checkerPanel.height;this.canvasGlow.x=this.canvasContainer.x-i/2%1,this.canvasGlow.y=this.canvasContainer.y-e/2%1,this.canvasGlow.setDimensions(i,e)};xe.prototype.updateTransformLayerVeil=function(){if(this.canvasImageOriginal.visible)this.transformLayer.frameWidth=this.canvasImageOriginal.texture.width,this.transformLayer.frameHeight=this.canvasImageOriginal.texture.height,this.transformTool.frameWidth=this.canvasImageOriginal.texture.width,this.transformTool.frameHeight=this.canvasImageOriginal.texture.height;else if(BFN.PhotoEditorCanvasModel.viewState==BFN.PhotoEditorCanvasModelViewStates.VIEWING_CANVAS)this.transformLayer.frameWidth=this.canvasImage.imageWidth,this.transformLayer.frameHeight=this.canvasImage.imageHeight,this.transformTool.frameWidth=this.canvasImage.imageWidth,this.transformTool.frameHeight=this.canvasImage.imageHeight;else{let t=BFN.PhotoEditorCanvasTools.currentTool;if(t&&!(t.itemWidth===void 0||t.itemHeight===void 0)){let r=t.itemWidth,a=t.itemHeight;this.transformLayer.frameWidth=r,this.transformLayer.frameHeight=a,this.transformTool.frameWidth=r,this.transformTool.frameHeight=a}else this.transformLayer.frameWidth=this.canvasImage.imageWidth,this.transformLayer.frameHeight=this.canvasImage.imageHeight,this.transformTool.frameWidth=this.canvasImage.imageWidth,this.transformTool.frameHeight=this.canvasImage.imageHeight}let i=this.transformLayer.frameWidth,e=this.transformLayer.frameHeight;BFN.TransformItemIsolator.active&&this.transformItemIsolatorContainer.children.includes(BFN.TransformItemIsolator)&&(i=this.transformLayer.frameWidth-(this.transformLayer.frameWidth-BFN.TransformItemIsolator.itemWidth)*BFN.TransformItemIsolator.activeFactor,e=this.transformLayer.frameHeight-(this.transformLayer.frameHeight-BFN.TransformItemIsolator.itemHeight)*BFN.TransformItemIsolator.activeFactor),this.canvasPixelGrid&&(this.canvasPixelGrid.active!=BFN.PhotoEditorCanvasModel.usePixelGrid&&(this.canvasPixelGrid.active=BFN.PhotoEditorCanvasModel.usePixelGrid),this.canvasPixelGrid.setFrameDimensions(i,e)),this.moveTouchSurface.scale.x=i/100,this.moveTouchSurface.scale.y=e/100,this.drawTransformLayerVeil(i,e)};xe.prototype.updateTransformLayerVeilOuterDimensions=function(){this.transformLayerVeil.setOuterDimensions(BFN.StageModel.stageW+20,BFN.StageModel.stageH+2)};xe.prototype.drawTransformLayerVeil=function(i,e){i=Math.round(i),e=Math.round(e),this.transformLayerVeil.setInnerDimensions(i,e)};xe.prototype.getFlattenedImage=function(i=null){if(this.canvasImage.texture&&this.canvasImage.texture.width&&this.canvasImage.texture.height){let e=1,t=this.canvasImage.texture.width,r=this.canvasImage.texture.height;typeof i=="number"&&(i=Math.max(BFN.minImageSize,Math.min(BFN.maxImageSize,i)),e=i/Math.max(t,r),t=Math.round(t*e),r=Math.round(r*e));let a={x:this.canvas.x,y:this.canvas.y};this.canvas.x=this.canvas.y=0,this.transformLayer.toggleFlattenDisplayMode(!0,e),this.canvasImage.currentScale=e,this.canvasContainer.removeChild(this.canvas),this.canvasFlattenContainer||(this.canvasFlattenContainer=new PIXI.Container),this.canvasFlattenContainer.addChild(this.canvas),this.canvasFlattenContainer.scale.x=this.canvasFlattenContainer.scale.y=e;let s=PIXI.RenderTexture.create(t,r);return BFN.smoothPictureAction(()=>{BFN.Stage.render(this.canvasFlattenContainer,s)}),this.canvas.x=a.x,this.canvas.y=a.y,this.canvasContainer.addChildAt(this.canvas,0),this.canvasImage.currentScale=BFN.PhotoEditorCanvasModel.canvasScale,this.transformLayer.toggleFlattenDisplayMode(!1),s}return null};xe.prototype.handleStageDimensionsUpdated=function(){this.updatePosition()};xe.prototype.handleSourceImageUpdated=function(){this.canvasImageOriginal.texture=BFN.PhotoEditorModel.sourceTexture};xe.prototype.handleCurrentImageUpdated=function(){this.updateCanvasImage()};xe.prototype.handleCanvasViewStateUpdated=function(){this.updateCanvasView()};xe.prototype.handleCanvasScaleUpdated=function(){this.updateScale()};xe.prototype.handleCanvasScalingUpdated=function(){this.canvasTools.scaling=BFN.PhotoEditorCanvasModel.canvasScaling};xe.prototype.handleFitImageToFrame=function(){this.fitImageToFrame()};xe.prototype.handleFitImageToFrameAnimated=function(){this.fitImageToFrame(!0)};xe.prototype.handleItemAdded=function(){BFN.PhotoEditorCanvasModel.addedItem&&(BFN.GlobalHistoryModel.updateGlobalHistoryMenuState(),this.transformLayer.addItem(BFN.PhotoEditorCanvasModel.addedItem),BFN.PhotoEditorCanvasModel.addedItem=null)};xe.prototype.handleOffsetItems=function(){this.transformLayer.offsetAllItems(BFN.PhotoEditorCanvasModel.itemOffsetPoint.x,BFN.PhotoEditorCanvasModel.itemOffsetPoint.y)};xe.prototype.handleFlattenItems=function(){let i=this.getFlattenedImage();if(i){BFN.PhotoEditorModel.updateCurrentTexture(i);let e=BFN.PhotoEditorHistoryModel.addTextureToHistory("layers_flattened",BFN.PhotoEditorModel.currentTexture),t=new BFN.UserActionVO;t.eventID="editing_applied",t.eventObject={toolType:"Other",toolName:"Flatten"},t.actionSection="editor",t.actionTimestamp=e,this.transformLayer.children.forEach(r=>{r instanceof BFN.TransformItem&&(t.transformItems||(t.transformItems=[]),t.transformItems.push(r))}),t.register(),this.transformLayer.removeAllItems(),UIMessages.display("layers_flattened")}};xe.prototype.handleClearItems=function(){this.transformLayer.destroyAllItems()};xe.prototype.handleCanvasImagePressed=function(i){BFN.CursorScreen.cursor="grabbing",BFN.CursorScreen.cursorLock=!0,this.canvasDragger.drag(this.canvasContainer)};xe.prototype.handleToolStartCanvasDrag=function(i){this.handleCanvasImagePressed(i)};xe.prototype.handleToolDimensionsUpdated=function(i){this.updateCanvasContainerDisplay(),BFN.ZoomManager.updateZoomRange()};xe.prototype.handleTransformItemsUpdated=function(){let i=this.transformLayer.itemsExist;BFN.PhotoEditorCanvasModel.itemsExist!=i&&(BFN.PhotoEditorCanvasModel.itemsExist=i)};xe.prototype.handleTransformItemSelected=function(){this.transformLayer.selectedItem?(this.transformTool.selectItem(this.transformLayer.selectedItem),BFN.TransformModel.selectedTransformItem!=this.transformLayer.selectedItem&&(BFN.TransformModel.selectedTransformItem=this.transformLayer.selectedItem)):(this.transformTool.deselectItem(),BFN.TransformModel.selectedTransformItem=null)};xe.prototype.handleTransformItemDisplayUpdated=function(){this.transformTool.updateDisplay()};xe.prototype.handleHoverSurfaceOver=function(i){setTimeout(function(){this.hoverSurfaceOver=!0,BFN.CursorScreen.cursor=this.canvasDragger.dragging?"grabbing":"grab"}.bind(this),0)};xe.prototype.handleHoverSurfaceOut=function(i){this.hoverSurfaceOver=!1,BFN.CursorScreen&&(BFN.CursorScreen.cursor=this.canvasDragger.dragging?"grabbing":"auto")};xe.prototype.handleMoveTouchSurfacePressed=function(i){i.stopPropagation(),this.handleCanvasImagePressed(null)};xe.prototype.handleCanvasMouseOver=function(i){this.mouseOver=!0};xe.prototype.handleCanvasMouseOut=function(i){this.mouseOver=!1};xe.prototype.handleCanvasKeyDown=function(i){BFN.AppModel.viewState==BFN.AppModelViewStates.VIEWING_PHOTO_EDITOR&&!BeFunky.isTextBoxFocused()&&(i.keyCode==32&&!this.moveTouchSurface.visible?(BFN.PIXITicker.nudge(),document.addEventListener("keyup",this.handleCanvasSpaceKeyUpBind,!0),window.addEventListener("blur",this.handleCanvasSpaceKeyUpBind,!0),this.moveTouchSurface.visible=!0,BFN.MainUI.requestRender(),this.canvasTools.toolPressed&&this.canvasTools.dispatchEvent(BFN.PhotoEditorCanvasToolsEvents.START_CANVAS_DRAG)):i.keyCode===79&&!(i.ctrlKey||i.metaKey)&&BFN.PhotoEditorModel.currentTexture&&(BFN.PIXITicker.nudge(),document.addEventListener("keyup",this.handleCanvasOKeyUpBind,!0),window.addEventListener("blur",this.handleCanvasOKeyUpBind,!0),this.canvasImageOriginal.visible=!0,this.canvasImage.visible=!1,this.canvasTools.visible=!1,this.transformLayer.visible=!1,this.transformTool.visible=!1,this.updateCanvasContainerDisplay()))};xe.prototype.handleCanvasSpaceKeyUp=function(i){this.handleHoverSurfaceOut(),document.removeEventListener("keyup",this.handleCanvasSpaceKeyUpBind,!0),window.removeEventListener("blur",this.handleCanvasSpaceKeyUpBind,!0),this.moveTouchSurface.visible=!1,BFN.MainUI.requestRender(),this.canvasTools.toolPressed&&this.canvasDragger.stopDrag(),BFN.PIXITicker.nudge()};xe.prototype.handleCanvasOKeyUp=function(i){this.handleHoverSurfaceOut(),document.removeEventListener("keyup",this.handleCanvasOKeyUpBind,!0),window.removeEventListener("blur",this.handleCanvasOKeyUpBind,!0),this.canvasImageOriginal.visible=!1,this.canvasImage.visible=this.canvasTools.currentTool==null,this.canvasTools.visible=!this.canvasImage.visible,this.transformLayer.visible=this.canvasImage.visible,this.transformTool.visible=this.canvasImage.visible,this.updateCanvasContainerDisplay(),BFN.MainUI.requestRender(),BFN.PIXITicker.nudge()};xe.prototype.handleCanvasDraggerDragging=function(){this.updateCanvasContainerDisplay(),BFN.TransformModel.selectedTransformItem&&BFN.TransformModel.selectedTransformItem.type==="group"&&BFN.TransformModel.selectedTransformItem.updateGroupTransform()};xe.prototype.handleCanvasDraggerDraggingComplete=function(){BFN.CursorScreen.cursorLock=!1,BFN.CursorScreen.cursor=this.hoverSurfaceOver?"grab":"auto"};xe.prototype.handleFitImageAnimatorUpdate=function(){BFN.PhotoEditorCanvasModel.canvasScale=(this.fitScale-this.startScale)*this.fitImageAnimator.animationSinFactor+this.startScale};xe.prototype.handleFitImageAnimatorUpdateComplete=function(){BFN.PhotoEditorCanvasModel.canvasScaling=!1,BFN.ZoomManager.updateZoomRange()};Object.defineProperty(xe.prototype,"canvasDimensions",{get:function(){let i={width:0,height:0};return this.canvasImage.texture&&this.canvasImage.texture.width&&this.canvasImage.texture.height&&(i.width=this.canvasImage.texture.width,i.height=this.canvasImage.texture.height),i}});BFN.SingletonQueue.add(function(){BFN.PhotoEditorCanvas=new xe});function ea(){PIXI.Sprite.call(this),this.init()}ea.prototype=Object.create(PIXI.Sprite.prototype);ea.prototype.init=function(){BeFunky.log("PhotoEditor Init"),this.initDefaultValues(),this.initCanvas()};ea.prototype.initDefaultValues=function(){BFN.AppModel.addEventListener(BFN.AppModelEvents.APP_READY.type,this.handleAppReady.bind(this))};ea.prototype.initCanvas=function(){this.addChild(BFN.PhotoEditorCanvas)};ea.prototype.handleAppReady=function(){BFN.MainUI.addEventListener(BFN.MainUIEvents.MOUSE_DOWN.type,this.handleMainUIPressed.bind(this))};ea.prototype.handleMainUIPressed=function(i){if(BFN.AppModel.viewState==BFN.AppModelViewStates.VIEWING_PHOTO_EDITOR&&!BFN.ColorPickerPanel.colorButton&&!BeFunky.isLoadScreenActive()&&BFN.TransformModel.selectedTransformItem){let e=i.data.canvasPressed,t=i.data.originalEvent,r=!(e&&(t.ctrlKey||t.metaKey||t.altKey)),{canvasDragger:a,transformLayer:s}=BFN.PhotoEditorCanvas,o=()=>{s.deselectItem(r,t.shiftKey),t.ctrlKey||t.metaKey||delete s.lastDeselectedItem};if(!BFN.ZoomManager.isZoomedIn||!a.dragging)o();else if(a.dragging){let n=()=>{a.removeEventListener(BFN.DraggerEvents.DRAGGING_COMPLETE.type,n),a.wasDragged||o()};a.addEventListener(BFN.DraggerEvents.DRAGGING_COMPLETE.type,n)}}};BFN.SingletonQueue.add(function(){BFN.PhotoEditor=new ea});function nr(){PIXI.Container.call(this),this.init()}nr.prototype=Object.create(PIXI.Container.prototype);nr.prototype.init=function(){BeFunky.log("CollageMakerCanvasBackground Init"),this.initDefaultValues(),this.initBackgroundGraphic(),this.updateDisplay()};nr.prototype.initDefaultValues=function(){this.interactive=!0,this._itemWidth=340,this._itemHeight=340,this._color=UITools.getToolValue("collage_customize","background_color"),this.updateDisplayQueued=!1};nr.prototype.initBackgroundGraphic=function(){this.backgroundGraphic=new PIXI.Graphics,this.addChild(this.backgroundGraphic)};nr.prototype.queueUpdateDisplay=function(){this.updateDisplayQueued||(this.updateDisplayQueued=!0,requestAnimationFrame(function(){this.updateDisplayQueued=!1,this.updateDisplay()}.bind(this)))};nr.prototype.updateDisplay=function(){this.backgroundGraphic.clear(),this._color!=-1&&this._itemWidth>0&&this._itemHeight>0&&(this.backgroundGraphic.beginFill(parseInt("0x"+this._color)),this.backgroundGraphic.drawRect(0,0,this._itemWidth,this._itemHeight),this.backgroundGraphic.endFill());try{BFN.MainUI.requestRender()}catch(i){}};Object.defineProperty(nr.prototype,"itemWidth",{set:function(i){this._itemWidth=i,this.updateDisplay()},get:function(){return this._itemWidth}});Object.defineProperty(nr.prototype,"itemHeight",{set:function(i){this._itemHeight=i,this.updateDisplay()},get:function(){return this._itemHeight}});Object.defineProperty(nr.prototype,"color",{set:function(i){this._color=i,this.updateDisplay()},get:function(){return this._color}});BFN.SingletonQueue.add(function(){BFN.CollageMakerCanvasBackground=new nr});function Je(){PIXI.Container.call(this),this.init()}Je.prototype=Object.create(PIXI.Container.prototype);Je.prototype.init=function(){BeFunky.log("PhotoGridChildContentImage Init"),this.initDefaultValues(),this.initFrameSprite(),this.initDragger()};Je.prototype.initDefaultValues=function(){this._scale=1,this.photoGridDimensions=new PIXI.Point};Je.prototype.initFrameSprite=function(){this.frameSprite=new BFN.FrameSprite,this.frameSprite.pluginName="smooth_picture",this.frameSprite.expandVertex=0,this.addChild(this.frameSprite)};Je.prototype.initDragger=function(){this.frameSpriteOffsetFactorStartX=0,this.frameSpriteOffsetFactorStartY=0,this.handleDraggingStartedBind=this.handleDraggingStarted.bind(this),this.handleDraggingCompleteBind=this.handleDraggingComplete.bind(this),this.handleDraggingBind=this.handleDragging.bind(this),this._dragger=new BFN.Dragger,this._dragger.stickyDrag=!0,this._dragger.useBounds=!0,this._dragger.autoDrag=!1,this._dragger.addEventListener(BFN.DraggerEvents.DRAGGING_STARTED.type,this.handleDraggingStartedBind),this._dragger.addEventListener(BFN.DraggerEvents.DRAGGING_COMPLETE.type,this.handleDraggingCompleteBind),this._dragger.addEventListener(BFN.DraggerEvents.DRAGGING.type,this.handleDraggingBind)};Je.prototype.setBaseTexture=function(i=null,e=!0,t=0){try{this.frameSprite.texture.destroyGC(!1)}catch(r){}this.frameSprite.texture=PIXI.Texture.EMPTY,i&&this.frameSprite.setTexture(new PIXI.Texture(i)),e?this.reset(t):t!=0&&(this.frameSprite.texture.rotate=t,this.frameSprite.updateDisplay()),this.updateSmoothing()};Je.prototype.setSize=function(i,e){this._itemWidth=i,this._itemHeight=e,this.frameSprite.frameWidth=this._itemWidth,this.frameSprite.frameHeight=this._itemHeight,this.frameSprite.updateDisplay(),this.updateSmoothing()};Je.prototype.resize=function(i){this.frameSprite.textureScale=i,this.frameSprite.updateDisplay(),this.updateSmoothing()};Je.prototype.setPhotoGridDimensions=function(i,e){this.photoGridDimensions.x=i,this.photoGridDimensions.y=e};Je.prototype.drag=function(){this.updateDragBounds(),this._dragger.drag(this.frameSprite)};Je.prototype.revertImagePosition=function(){this.frameSprite.offsetFactorX=this.frameSpriteOffsetFactorStartX,this.frameSprite.offsetFactorY=this.frameSpriteOffsetFactorStartY,this.frameSprite.updateDisplay()};Je.prototype.updateSmoothing=function(){this.frameSprite.currentScale=this._scale*this.frameSprite.adjustScale*this.frameSprite.textureScale};Je.prototype.flip=function(i){switch(i){case"horizontal":this.frameSprite.flipH();break;case"vertical":this.frameSprite.flipV();break}};Je.prototype.rotate=function(i){switch(i){case"left":this.frameSprite.rotateL();break;case"right":this.frameSprite.rotateR();break}this.updateSmoothing()};Je.prototype.reset=function(i=0,e=1,t=.5,r=.5){this.frameSprite&&(this.frameSprite.texture.rotate=i,this.frameSprite.textureScale=e,this.frameSprite.offsetFactorX=t,this.frameSprite.offsetFactorY=r,this.frameSprite.updateDisplay(),this.updateSmoothing())};Je.prototype.updateDragBounds=function(){this.frameSpriteOffsetFactorStartX=this.frameSprite.offsetFactorX,this.frameSpriteOffsetFactorStartY=this.frameSprite.offsetFactorY;let i=this.frameSprite.excessX*this.frameSprite.offsetFactorX*(this._scale*this.frameSprite.adjustScale*this.frameSprite.textureScale),e=(this.frameSprite.excessX-this.frameSprite.excessX*this.frameSprite.offsetFactorX)*(this._scale*this.frameSprite.adjustScale*this.frameSprite.textureScale),t=this.frameSprite.excessY*this.frameSprite.offsetFactorY*(this._scale*this.frameSprite.adjustScale*this.frameSprite.textureScale),r=(this.frameSprite.excessY-this.frameSprite.excessY*this.frameSprite.offsetFactorY)*(this._scale*this.frameSprite.adjustScale*this.frameSprite.textureScale);switch(this.frameSprite.texture.rotate){case 0:this._dragger.setBounds(-e,-r,i,t);break;case 2:this._dragger.setBounds(-r,-i,t,e);break;case 4:this._dragger.setBounds(-i,-t,e,r);break;case 6:this._dragger.setBounds(-t,-e,r,i);break;case 8:this._dragger.setBounds(-e,-t,i,r);break;case 10:this._dragger.setBounds(-r,-e,t,i);break;case 12:this._dragger.setBounds(-i,-r,e,t);break;case 14:this._dragger.setBounds(-t,-i,r,e);break}};Je.prototype.destroy=function(){this._dragger.removeEventListener(BFN.DraggerEvents.DRAGGING.type,this.handleDraggingBind),this._dragger=null,this.frameSprite.destroy(),this.removeChild(this.frameSprite),this.frameSprite=null};Je.prototype.handleDraggingStarted=function(i){BFN.smoothPictureDisabled=!0};Je.prototype.handleDraggingComplete=function(i){BFN.smoothPictureDisabled=!1};Je.prototype.handleDragging=function(i){let e=this._dragger.draggedX/(this._scale*this.frameSprite.adjustScale*this.frameSprite.textureScale),t=this._dragger.draggedY/(this._scale*this.frameSprite.adjustScale*this.frameSprite.textureScale),r=e,a=t;switch(this.frameSprite.texture.rotate){case 0:r=e,a=t;break;case 2:r=-t,a=e;break;case 4:r=-e,a=-t;break;case 6:r=t,a=-e;break;case 8:r=e,a=-t;break;case 10:r=t,a=e;break;case 12:r=-e,a=t;break;case 14:r=-t,a=-e;break}let s=this.frameSpriteOffsetFactorStartX-r/this.frameSprite.excessX,o=this.frameSpriteOffsetFactorStartY-a/this.frameSprite.excessY;this.frameSprite.offsetFactorX=this.frameSprite.excessX?s:this.frameSprite.offsetFactorX,this.frameSprite.offsetFactorY=this.frameSprite.excessY?o:this.frameSprite.offsetFactorY,this.frameSprite.updateDisplay()};Object.defineProperty(Je.prototype,"texture",{get:function(){return this.frameSprite?this.frameSprite.texture:null}});Object.defineProperty(Je.prototype,"dragger",{get:function(){return this._dragger}});Object.defineProperty(Je.prototype,"scale",{set:function(i){this._scale=i,this.updateSmoothing()},get:function(){return this._scale}});Object.defineProperty(Je.prototype,"resizeScale",{get:function(){return this.frameSprite.textureScale}});Object.defineProperty(Je.prototype,"resizeScaleX",{get:function(){return this.frameSprite.textureScaleX}});Object.defineProperty(Je.prototype,"resizeScaleY",{get:function(){return this.frameSprite.textureScaleY}});Object.defineProperty(Je.prototype,"itemWidth",{get:function(){return this._itemWidth}});Object.defineProperty(Je.prototype,"itemHeight",{get:function(){return this._itemHeight}});BFN.PhotoGridChildContentImage=Je;BFN.PhotoGridChildContentEvents={SELECT:new Event("EDGE_BAR_HOVERED"),DRAG:new Event("EDGE_BAR_PRESSED"),DELETE:new Event("INSERT_CHILD"),FORCE_ISOLATION_RELEASE:new Event("SELECT_CHILD"),IMAGE_UPDATED:new Event("DRAG_CHILD"),IMAGE_POSITION_UPDATED:new Event("DELETE_CHILD")};function Ue(){PIXI.Container.call(this),BFN.EventDispatcher.call(this),this.init()}Ue.prototype=window.azrc.extend(Object.create(PIXI.Container.prototype),Object.create(BFN.EventDispatcher.prototype));Ue.prototype.init=function(){BeFunky.log("PhotoGridChildContent Init"),this.initDefaultValues(),this.initContentContainer(),this.initBackground(),this.initContentImage(),this.initHoverVeil(),this.initRoundedRectFilter(),this.initAnimators()};Ue.prototype.initDefaultValues=function(){this.strokeWidth=2,this._isEmpty=!0,this._scale=1,this._rounding=0,this._cleanDelete=!1,this._directSelect=!1,this._awaitingDrop=!1,this._highlightEnabled=!1,this._isolated=!1,this._imageEnabled=!0,this._itemWidth=100,this._itemHeight=100,this._backgroundColor="FFFFFF",this._borderColor="D6D6EE ",this.mouseMoved=!1,this.mouseOver=!1,this.pressed=!1};Ue.prototype.initContentContainer=function(){this.contentContainer=new PIXI.Container,this.addChild(this.contentContainer)};Ue.prototype.initBackground=function(){this.background=new PIXI.Graphics,this.background.beginFill(16777215,.5),this.background.drawRect(0,0,100,100),this.background.endFill(),this.contentContainer.addChild(this.background),this.backgroundColor=this._backgroundColor};Ue.prototype.initContentImage=function(){this.handleContentImageDraggingBind=this.handleContentImageDragging.bind(this),this.handleContentImageDraggingCompleteBind=this.handleContentImageDraggingComplete.bind(this),this._contentImage=new BFN.PhotoGridChildContentImage,this._contentImage.visible=!1,this._contentImage.dragger.addEventListener(BFN.DraggerEvents.DRAGGING.type,this.handleContentImageDraggingBind),this.contentContainer.addChild(this._contentImage)};Ue.prototype.initHoverVeil=function(){this.handleMouseOverBind=this.handleMouseOver.bind(this),this.handleMouseOutBind=this.handleMouseOut.bind(this),this.handleMouseDownBind=this.handleMouseDown.bind(this),this.handleMouseMoveBind=this.handleMouseMove.bind(this),this.handleMouseUpBind=this.handleMouseUp.bind(this),this._hoverVeil=new PIXI.Graphics,this._hoverVeil.interactive=!0,this._hoverVeil.beginFill(16777215,.7),this._hoverVeil.drawRect(0,0,100,100),this._hoverVeil.endFill(),this._hoverVeil.on("pointerover",this.handleMouseOverBind),this._hoverVeil.on("pointerout",this.handleMouseOutBind),this._hoverVeil.on("pointerdown",this.handleMouseDownBind),this.contentContainer.addChild(this._hoverVeil)};Ue.prototype.initRoundedRectFilter=function(){this.roundedRectFilter=new BFN.filters.RoundedRectFilter,this.roundedRectFilter.autoFit=!1,this.roundedRectFilter.edgePadding=0,this.roundedRectFilter.strokeWidth=this.strokeWidth,this.roundedRectFilter.useTexture=1,this.roundedRectFilter.roundingDisabled=!0,window.bfn_resolution>=2&&(this.roundedRectFilter.resolution=window.bfn_resolution),this.borderColor=this._borderColor};Ue.prototype.initAnimators=function(){this.handleHoverAnimatorUpdateBind=this.handleHoverAnimatorUpdate.bind(this),this.handleFadeAnimatorUpdateBind=this.handleFadeAnimatorUpdate.bind(this),this.hoverAnimator=new BFN.Animator,this.hoverAnimator.addEventListener(BFN.AnimatorEvents.UPDATE.type,this.handleHoverAnimatorUpdateBind),this.hoverAnimator.setAnimatorFactor(0),this.fadeAnimator=new BFN.Animator,this.fadeAnimator.linearSteps=12,this.fadeAnimator.addEventListener(BFN.AnimatorEvents.UPDATE.type,this.handleFadeAnimatorUpdateBind),this.fadeAnimator.setAnimatorFactor(1)};Ue.prototype.setImage=function(i=null,e=!0,t=!1,r=0){i?(this.roundedRectFilter.strokeWidth=0,this.contentContainer.filters=[this.roundedRectFilter],this._isEmpty=!1,this.background.visible=!1,this._contentImage.visible=!0,this._contentImage.setBaseTexture(i.baseTexture,e,r),this.updateSize()):(this.roundedRectFilter.strokeWidth=this.strokeWidth,this.contentContainer.filters=[this.roundedRectFilter],this._isEmpty=!0,this.background.visible=!0,this._contentImage.visible=!1,this._contentImage.setBaseTexture(null)),t||this.dispatchEvent(BFN.PhotoGridChildContentEvents.IMAGE_UPDATED),BFN.MainUI.requestRender()};Ue.prototype.setSize=function(i,e){this._itemWidth=Math.max(0,i),this._itemHeight=Math.max(0,e),this.updateSize()};Ue.prototype.updateSize=function(){if(this._itemWidth<=1||this._itemHeight<=1){this.visible=!1;return}else this.visible=!0;this.background.width=this._hoverVeil.width=this._itemWidth,this.background.height=this._hoverVeil.height=this._itemHeight,this.updateRoundedRectFilter(),this._contentImage.setSize(this._itemWidth,this._itemHeight)};Ue.prototype.updateRoundedRectFilter=function(){this.roundedRectFilter.quality=this.roundedRectFilter.cornerRadius?.75:0,this.roundedRectFilter.cornerRadius=this._rounding*Math.min(this._itemWidth,this._itemHeight)/2,this.roundedRectFilter.spriteSize=[this._itemWidth,this._itemHeight],this.contentContainer.filters=[this.roundedRectFilter]};Ue.prototype.flashItem=function(){this.fadeAnimator.setAnimatorFactor(0),this.fadeAnimator.increase()};Ue.prototype.selectItem=function(i=!1){this._directSelect=i,this.dispatchEvent(BFN.PhotoGridChildContentEvents.SELECT)};Ue.prototype.deleteItem=function(i=!1){this._isEmpty?(this._cleanDelete=i,this.dispatchEvent(BFN.PhotoGridChildContentEvents.DELETE)):this.setImage(null)};Ue.prototype.toggleBorder=function(i,e=0){this.roundedRectFilter.strokeWidth=i&&this._isEmpty?this.strokeWidth:this._isEmpty||!this._imageEnabled?e:0,this.contentContainer.filters=[this.roundedRectFilter]};Ue.prototype.destroy=function(){this.hoverAnimator.removeEventListener(BFN.AnimatorEvents.UPDATE.type,this.handleHoverAnimatorUpdateBind),this.hoverAnimator=null,this.fadeAnimator.removeEventListener(BFN.AnimatorEvents.UPDATE.type,this.handleFadeAnimatorUpdateBind),this.fadeAnimator=null,this.filters=[],this.roundedRectFilter=null,this._hoverVeil.off("pointerover",this.handleMouseOverBind),this._hoverVeil.off("pointerout",this.handleMouseOutBind),this._hoverVeil.off("pointerdown",this.handleMouseDownBind),this.removeChild(this._hoverVeil),this._hoverVeil=null,this.contentContainer.removeChild(this._contentImage),this._contentImage.destroy(),this._contentImage=null,this.contentContainer.removeChild(this.background),this.background=null,this.contentContainer.mask=null,this.removeChild(this.contentContainer),this.contentContainer=null};Ue.prototype.handleContentImageDragging=function(i){!this._isolated&&!this.mouseOver&&(this._contentImage.revertImagePosition(),this._contentImage.dragger.removeEventListener(BFN.DraggerEvents.DRAGGING_COMPLETE.type,this.handleContentImageDraggingCompleteBind),this._contentImage.dragger.stopDrag(),this.dispatchEvent(BFN.PhotoGridChildContentEvents.DRAG))};Ue.prototype.handleMouseOver=function(i){setTimeout(function(){this.mouseOver=!0,(!BFN.PhotoGrid.draggedChild||BFN.PhotoGrid.draggedChild&&BFN.PhotoGrid.draggedChild.content!=this)&&(this._awaitingDrop?this.hoverAnimator.increase():this._isEmpty||(BFN.CursorScreen.cursorLock||(BFN.CursorScreen.cursorRotation=0),BFN.CursorScreen.cursor="move"))}.bind(this),0)};Ue.prototype.handleMouseOut=function(i){this.mouseOver=!1,this._highlightEnabled||this.hoverAnimator.decrease(),this._contentImage.dragger.dragging||(BFN.CursorScreen.cursor=null)};Ue.prototype.handleMouseDown=function(i){if(BFN.GestureManager.multiplePointersActive)return;this.mouseOver=!0,i.data.pointerType=="touch"&&BFN.PhotoGrid.startTouchDragHoverDetection();let e=i.data.originalEvent;this.rightClick=e.button===2,this.mouseDownPoint=BFN.MainUI.getPointerPosition(i),!(!this._isEmpty&&(e.ctrlKey||e.metaKey||e.altKey))&&(!BFN.ActiveDraggers.includes(this._contentImage.dragger)&&!this._isEmpty&&BFN.ActiveDraggers.push(this._contentImage.dragger),this.mouseMoved=!1,this.pressed=!0,document.addEventListener(BeFunky.pointermove,this.handleMouseMoveBind),document.addEventListener(BeFunky.pointerup,this.handleMouseUpBind))};Ue.prototype.handleMouseMove=function(i){this.mouseMovePoint=BFN.MainUI.getPointerPosition(BFN.MainUI.pointerEvent);let e=this.mouseMovePoint.x-this.mouseDownPoint.x,t=this.mouseMovePoint.y-this.mouseDownPoint.y;Math.sqrt(Math.pow(e,2)+Math.pow(t,2))>5&&(this.mouseMoved=!0,this.handleMouseUpBind())};Ue.prototype.handleMouseUp=function(i){this.pressed=!1,document.removeEventListener(BeFunky.pointermove,this.handleMouseMoveBind),document.removeEventListener(BeFunky.pointerup,this.handleMouseUpBind),BFN.ActiveDraggers.includes(this._contentImage.dragger)&&BFN.ActiveDraggers.splice(BFN.ActiveDraggers.indexOf(this._contentImage.dragger),1),!BFN.GestureManager.multiplePointersActive&&(this.mouseMoved&&!this.rightClick?this._isEmpty||(this._contentImage.dragger.addEventListener(BFN.DraggerEvents.DRAGGING_COMPLETE.type,this.handleContentImageDraggingCompleteBind),this._contentImage.drag()):BFN.PhotoGrid.gridChildIsolated||this.selectItem(!0))};Ue.prototype.handleContentImageDraggingComplete=function(i){this._contentImage.dragger.removeEventListener(BFN.DraggerEvents.DRAGGING_COMPLETE.type,this.handleContentImageDraggingCompleteBind),BFN.PhotoGrid.gridChildIsolated||this.dispatchEvent(BFN.PhotoGridChildContentEvents.IMAGE_POSITION_UPDATED)};Ue.prototype.handleHoverAnimatorUpdate=function(i){this._hoverVeil.alpha=this.hoverAnimator.animationFactor};Ue.prototype.handleFadeAnimatorUpdate=function(i){this.alpha=this.fadeAnimator.animationFactor};Object.defineProperty(Ue.prototype,"isEmpty",{get:function(){return this._isEmpty}});Object.defineProperty(Ue.prototype,"image",{get:function(){return this._contentImage}});Object.defineProperty(Ue.prototype,"veil",{get:function(){return this._hoverVeil}});Object.defineProperty(Ue.prototype,"backgroundColor",{set:function(i){this._backgroundColor=i,this.background.tint=parseInt("0x"+this._backgroundColor)},get:function(){return this._backgroundColor}});Object.defineProperty(Ue.prototype,"borderColor",{set:function(i){this._borderColor=i,this.roundedRectFilter.strokeColor=parseInt("0xFF"+this._borderColor),this._hoverVeil.tint=parseInt("0x"+this._borderColor)},get:function(){return this._borderColor}});Object.defineProperty(Ue.prototype,"rounding",{set:function(i){this._rounding=i,this.updateRoundedRectFilter()},get:function(){return this._rounding}});Object.defineProperty(Ue.prototype,"cleanDelete",{get:function(){return this._cleanDelete}});Object.defineProperty(Ue.prototype,"directSelect",{get:function(){return this._directSelect}});Object.defineProperty(Ue.prototype,"awaitingDrop",{set:function(i){this._awaitingDrop=i,this._awaitingDrop||this.hoverAnimator.decrease()},get:function(){return this._awaitingDrop}});Object.defineProperty(Ue.prototype,"highlightEnabled",{set:function(i){this._highlightEnabled=i,this._highlightEnabled?this.hoverAnimator.increase():this.hoverAnimator.decrease()},get:function(){return this._highlightEnabled}});Object.defineProperty(Ue.prototype,"isolated",{set:function(i){this._isolated=i},get:function(){return this._isolated}});Object.defineProperty(Ue.prototype,"imageEnabled",{set:function(i){this._imageEnabled=i,!this._imageEnabled||this._isEmpty?(this.contentContainer.filters=[this.roundedRectFilter],this.background.visible=!0,this._contentImage.visible=!1):(this.contentContainer.filters=[],this.background.visible=!1,this._contentImage.visible=!0)},get:function(){return this._imageEnabled}});Object.defineProperty(Ue.prototype,"itemWidth",{set:function(i){this._itemWidth=i,this.updateSize()},get:function(){return this._itemWidth}});Object.defineProperty(Ue.prototype,"itemHeight",{set:function(i){this._itemHeight=i,this.updateSize()},get:function(){return this._itemHeight}});BFN.PhotoGridChildContent=Ue;function At(i,e=null){PIXI.Container.call(this),this.side=i,this.gridChild=e,this.init()}At.prototype=Object.create(PIXI.Container.prototype);At.prototype.init=function(){BeFunky.log("PhotoGridChildEdgeBar Init"),this.initDefaultValues(),this.initContainer(),this.initShapes(),this.initAnimator(),this.updateDisplay()};At.prototype.initDefaultValues=function(){this.interactive=!0,this.showEdgeBar=!1,this.baseSize=50,this.color=13413119,this._id=null,this.cornerAWidth=this.baseSize,this.cornerBWidth=this.baseSize,this.blockWidth=this.baseSize,this._itemWidth=this.baseSize*3,this._itemHeight=this.baseSize,this.handleMouseOverBind=this.handleMouseOver.bind(this),this.handleMouseOutBind=this.handleMouseOut.bind(this),this.on("pointerover",this.handleMouseOverBind),this.on("pointerout",this.handleMouseOutBind)};At.prototype.initContainer=function(){switch(this.container=new PIXI.Container,this.container.alpha=0,this.addChild(this.container),this.side){case"left":this.container.rotation=-(Math.PI/2);break;case"top":this.container.rotation=0;break;case"right":this.container.rotation=Math.PI/2;break;case"bottom":this.container.rotation=Math.PI;break}};At.prototype.initShapes=function(){this.cornerA=new PIXI.Graphics,this.cornerA.beginFill(this.color),this.cornerA.moveTo(0,0),this.cornerA.lineTo(0,this.baseSize),this.cornerA.lineTo(-this.baseSize,0),this.cornerA.lineTo(0,0),this.cornerA.endFill(),this.container.addChild(this.cornerA),this.cornerAPolygon=[new PIXI.Point(0,0),new PIXI.Point(0,this.baseSize),new PIXI.Point(-this.baseSize,0)],this.cornerATriangle=new BFN.Triangle,this.cornerB=new PIXI.Graphics,this.cornerB.beginFill(this.color),this.cornerB.moveTo(0,0),this.cornerB.lineTo(0,this.baseSize),this.cornerB.lineTo(this.baseSize,0),this.cornerB.lineTo(0,0),this.cornerB.endFill(),this.container.addChild(this.cornerB),this.cornerBPolygon=[new PIXI.Point(0,0),new PIXI.Point(0,this.baseSize),new PIXI.Point(this.baseSize,0)],this.cornerBTriangle=new BFN.Triangle,this.block=new PIXI.Graphics,this.block.beginFill(this.color),this.block.drawRect(-(this.baseSize/2),0,this.baseSize,this.baseSize),this.block.endFill(),this.container.addChild(this.block),this.blockPolygon=[new PIXI.Point(-(this.baseSize/2),0),new PIXI.Point(this.baseSize/2,0),new PIXI.Point(this.baseSize/2,this.baseSize),new PIXI.Point(-(this.baseSize/2),this.baseSize)],this.blockRectangle=new BFN.Rectangle};At.prototype.initAnimator=function(){this.showEdgeBar&&(this.handleAnimatorUpdateBind=this.handleAnimatorUpdate.bind(this),this._animator=new BFN.Animator,this._animator.addEventListener(BFN.AnimatorEvents.UPDATE.type,this.handleAnimatorUpdateBind),this._animator.setAnimatorFactor(0))};At.prototype.setSize=function(i,e,t,r){this.cornerAWidth=i,this.blockWidth=e,this.cornerBWidth=t,this._itemWidth=this.cornerAWidth+this.blockWidth+this.cornerBWidth,this._itemHeight=r,this.updateDisplay()};At.prototype.updateDisplay=function(){this.cornerA.x=-(this.blockWidth/2),this.cornerA.width=this.cornerAWidth,this.cornerA.height=this._itemHeight,this.cornerB.x=this.blockWidth/2,this.cornerB.width=this.cornerBWidth,this.cornerB.height=this._itemHeight,this.block.width=this.blockWidth,this.block.height=this._itemHeight};At.prototype.destroy=function(){this.showEdgeBar&&(this._animator.removeEventListener(BFN.AnimatorEvents.UPDATE.type,this.handleAnimatorUpdateBind),this._animator=null),this.container.removeChild(this.block),this.block=null,this.container.removeChild(this.cornerB),this.cornerB=null,this.container.removeChild(this.cornerA),this.cornerA=null,this.removeChild(this.container),this.container=null,this.off("pointerover",this.handleMouseOverBind),this.off("pointerout",this.handleMouseOutBind)};At.prototype.updateGlobalBounds=function(){this.cornerAPolygon.forEach((i,e)=>{let t=BFN.MainUI.toLocal(i,this.cornerA);this.cornerATriangle[`x${e+1}`]=t.x+BFN.MainUI.x+BFN.leftMenuMinimumWidth,this.cornerATriangle[`y${e+1}`]=t.y+BFN.MainUI.y+BFN.topNavBarHeight}),this.cornerBPolygon.forEach((i,e)=>{let t=BFN.MainUI.toLocal(i,this.cornerB);this.cornerBTriangle[`x${e+1}`]=t.x+BFN.MainUI.x+BFN.leftMenuMinimumWidth,this.cornerBTriangle[`y${e+1}`]=t.y+BFN.MainUI.y+BFN.topNavBarHeight}),this.blockRectangle=null,this.blockPolygon.forEach(i=>{let e=BFN.MainUI.toLocal(i,this.block);this.blockRectangle?(this.blockRectangle.left=Math.min(this.blockRectangle.left,e.x),this.blockRectangle.right=Math.max(this.blockRectangle.right,e.x),this.blockRectangle.top=Math.min(this.blockRectangle.top,e.y),this.blockRectangle.bottom=Math.max(this.blockRectangle.bottom,e.y)):this.blockRectangle=new BFN.Rectangle(e.x,e.y)}),this.blockRectangle?(this.blockRectangle.x+=BFN.MainUI.x+BFN.leftMenuMinimumWidth,this.blockRectangle.y+=BFN.MainUI.y+BFN.topNavBarHeight):this.blockRectangle=new BFN.Rectangle};At.prototype.containsGlobalPoint=function(i,e){return this.cornerATriangle.contains(i,e)||this.cornerBTriangle.contains(i,e)||this.blockRectangle.contains(i,e)};At.prototype.handleMouseOver=function(i){this.showEdgeBar&&this._animator.increase()};At.prototype.handleMouseOut=function(i){this.showEdgeBar&&this._animator.decrease()};At.prototype.handleAnimatorUpdate=function(i){this.container.alpha=this._animator.animationFactor*.8+.2};Object.defineProperty(At.prototype,"id",{set(i){this._id=i},get(){return this._id}});Object.defineProperty(At.prototype,"animator",{get(){return this._animator}});Object.defineProperty(At.prototype,"itemWidth",{get(){return this._itemWidth}});Object.defineProperty(At.prototype,"itemHeight",{get(){return this._itemHeight}});BFN.PhotoGridChildEdgeBar=At;BFN.PhotoGridChildEvents={EDGE_BAR_HOVERED:new Event("EDGE_BAR_HOVERED"),EDGE_BAR_PRESSED:new Event("EDGE_BAR_PRESSED"),INSERT_CHILD:new Event("INSERT_CHILD"),SELECT_CHILD:new Event("SELECT_CHILD"),DRAG_CHILD:new Event("DRAG_CHILD"),DELETE_CHILD:new Event("DELETE_CHILD"),CHILD_IMAGE_UPDATED:new Event("CHILD_IMAGE_UPDATED"),CHILD_IMAGE_POSITION_UPDATED:new Event("CHILD_IMAGE_POSITION_UPDATED"),TRANSITION_COMPLETE:new Event("TRANSITION_COMPLETE")};function De(){PIXI.Container.call(this),BFN.EventDispatcher.call(this),this.init()}De.prototype=window.azrc.extend(Object.create(PIXI.Container.prototype),Object.create(BFN.EventDispatcher.prototype));De.prototype.init=function(){BeFunky.log("PhotoGridChild Init"),this.initDefaultValues(),this.initBackground(),this.initChildContent(),this.initEdgeBars(),this.initTransitionAnimator()};De.prototype.initDefaultValues=function(){this.interactive=!0,this._destroyed=!1,this._id=null,this._gap=0,this._rounding=0,this._scale=1,this._hoveredEdge=null,this._rect=new BFN.Rectangle,this._factorRect=new BFN.Rectangle,this._attemptUngrouping=!1,this._attemptSeparation=!1,this._itemWidth=100,this._itemHeight=100,this._edgeBarInset=BeFunky.isMobile?12:6,this._transitionRect=new BFN.Rectangle,this._awaitingDrop=!1,this.globalRect=new BFN.Rectangle,this._menuImageVO=null,this.projectItemVO=new BFN.ProjectItemVO,this.projectItemVO.type="grid_cell",this.handleKeyDownBind=this.handleKeyDown.bind(this),this.handleKeyUpBind=this.handleKeyUp.bind(this)};De.prototype.initBackground=function(){this.background=new PIXI.Graphics};De.prototype.initChildContent=function(){this.childContentContainer=new PIXI.Container,this.addChild(this.childContentContainer),this.gridChildContentEventHandlers=[{event:BFN.PhotoGridChildContentEvents.SELECT,handler:this.handleChildContentSelect.bind(this)},{event:BFN.PhotoGridChildContentEvents.DRAG,handler:this.handleChildContentDrag.bind(this)},{event:BFN.PhotoGridChildContentEvents.DELETE,handler:this.handleChildContentDelete.bind(this)},{event:BFN.PhotoGridChildContentEvents.IMAGE_UPDATED,handler:this.handleChildContentImageUpdated.bind(this)},{event:BFN.PhotoGridChildContentEvents.IMAGE_POSITION_UPDATED,handler:this.handleChildContentImagePositionUpdated.bind(this)}],this.childContent=new BFN.PhotoGridChildContent;for(let i=0;i<this.gridChildContentEventHandlers.length;i++)this.childContent.addEventListener(this.gridChildContentEventHandlers[i].event.type,this.gridChildContentEventHandlers[i].handler);this.childContentContainer.addChild(this.childContent)};De.prototype.initEdgeBars=function(){this.edgeBarData=["left","top","right","bottom"],this.edgeBars={},this.edgeBarContainer=new PIXI.Container,this.addChild(this.edgeBarContainer),this.handleEdgeBarOverBind=this.handleEdgeBarOver.bind(this),this.handleEdgeBarOutBind=this.handleEdgeBarOut.bind(this),this.handleEdgeBarPressedBind=this.handleEdgeBarPressed.bind(this);for(let i=0;i<this.edgeBarData.length;i++){let e=new BFN.PhotoGridChildEdgeBar(this.edgeBarData[i],this);e.id=this.edgeBarData[i],e.on("pointerover",this.handleEdgeBarOverBind),e.on("pointerout",this.handleEdgeBarOutBind),e.on("pointerdown",this.handleEdgeBarPressedBind),this.edgeBarContainer.addChild(e),this.edgeBars[e.id]=e}};De.prototype.initTransitionAnimator=function(){this.handleTransitionAnimatorUpdateBind=this.handleTransitionAnimatorUpdate.bind(this),this.handleTransitionAnimatorUpdateCompleteBind=this.handleTransitionAnimatorUpdateComplete.bind(this),this.transitionAnimator=new BFN.Animator,this.transitionAnimator.linearSteps=16,this.transitionAnimator.addEventListener(BFN.AnimatorEvents.UPDATE.type,this.handleTransitionAnimatorUpdateBind),this.transitionAnimator.addEventListener(BFN.AnimatorEvents.UPDATE_COMPLETE.type,this.handleTransitionAnimatorUpdateCompleteBind)};De.prototype.setSize=function(i,e){this._itemWidth=Math.max(0,i),this._itemHeight=Math.max(0,e),this.updateSize()};De.prototype.makeTransition=function(){this.updateRect(),BFN.smoothPictureDisabled=!0,this.transitionAnimator.setAnimatorFactor(0),this.transitionAnimator.increase()};De.prototype.updateSize=function(){if(this.destroyed)return;if(this._itemWidth<=1||this._itemHeight<=1){this.visible=!1;return}else this.visible=!0;this.drawBackground(),this.childContent.isolated||(this.childContent.x=this._gap/2,this.childContent.y=this._gap/2,this.childContent.setSize(Math.max(0,this._itemWidth-this._gap),Math.max(0,this._itemHeight-this._gap)));let i=this._edgeBarInset/this._scale,e=new BFN.Rectangle;e.x=Math.min(this._itemWidth/2,Math.max(i,this.childContent.x)),e.y=Math.min(this._itemHeight/2,Math.max(i,this.childContent.y)),e.width=Math.min(Math.max(0,this._itemWidth-i*2),this.childContent.itemWidth),e.height=Math.min(Math.max(0,this._itemHeight-i*2),this.childContent.itemHeight);for(let t in this.edgeBars){let r=this.edgeBars[t];switch(t){case"top":r.x=e.x+e.width/2,r.y=0,r.setSize(e.x,e.width,this._itemWidth-e.x-e.width,e.y);break;case"bottom":r.x=e.x+e.width/2,r.y=this._itemHeight,r.setSize(this._itemWidth-e.x-e.width,e.width,e.x,this._itemHeight-e.y-e.height);break;case"left":r.x=0,r.y=e.y+e.height/2,r.setSize(this._itemHeight-e.y-e.height,e.height,e.y,e.x);break;case"right":r.x=this._itemWidth,r.y=e.y+e.height/2,r.setSize(e.y,e.height,this._itemHeight-e.y-e.height,this._itemWidth-e.x-e.width);break}}};De.prototype.drawBackground=function(){};De.prototype.updateRounding=function(){this.drawBackground(),this.childContent.rounding=this._rounding};De.prototype.handleDrop=function(){BFN.SentryManager.reportBreadcrumb(BFN.SentryManager.getDisplayObjectInfo(this),"drop_grid_child_image"),this._hoveredEdge?this.dispatchEvent(BFN.PhotoGridChildEvents.INSERT_CHILD):this.childContent&&this.childContent.selectItem()};De.prototype.updateProjectItemVO=function(){this.projectItemVO.gridCellImageID=this._menuImageVO?this._menuImageVO.id:null,this.projectItemVO.gridCellRect=this._rect.rectangleObject,this.projectItemVO.gridCellTextureOffsetFactorX=this.content.image.frameSprite.offsetFactorX,this.projectItemVO.gridCellTextureOffsetFactorY=this.content.image.frameSprite.offsetFactorY,this.projectItemVO.gridCellTextureRotate=this.content.image.frameSprite.rotate,this.projectItemVO.gridCellTextureScale=this.content.image.frameSprite.textureScale};De.prototype.destroy=function(){if(!this._destroyed){this._destroyed=!0,this.transitionAnimator.removeEventListener(BFN.AnimatorEvents.UPDATE.type,this.handleTransitionAnimatorUpdateBind),this.transitionAnimator.removeEventListener(BFN.AnimatorEvents.UPDATE_COMPLETE.type,this.handleTransitionAnimatorUpdateCompleteBind);for(let i in this.edgeBars){let e=this.edgeBars[i];e.off("pointerover",this.handleEdgeBarOverBind),e.off("pointerout",this.handleEdgeBarOutBind),e.off("pointerdown",this.handleEdgeBarPressedBind),this.edgeBarContainer.removeChild(e),e.destroy(),this.edgeBars[i]=null,delete this.edgeBars[i]}this.edgeBars=null,this.removeChild(this.edgeBarContainer),this.edgeBarContainer=null,this.childContent.isolated&&this.childContent.dispatchEvent(BFN.PhotoGridChildContentEvents.FORCE_ISOLATION_RELEASE),this.childContentContainer.removeChild(this.childContent);for(let i=0;i<this.gridChildContentEventHandlers.length;i++)this.childContent.removeEventListener(this.gridChildContentEventHandlers[i].event.type,this.gridChildContentEventHandlers[i].handler);this.childContent.destroy(),this.childContent=null,this.removeChild(this.childContentContainer),this.childContentContainer=null,this.removeChild(this.background),this.background=null,this._menuImageVO=null,this.projectItemVO=null}};De.prototype.updateRect=function(){this._rect.left=Math.round(this.x),this._rect.right=Math.round(this.x+this._itemWidth),this._rect.top=Math.round(this.y),this._rect.bottom=Math.round(this.y+this._itemHeight)};De.prototype.updateGlobalBounds=function(){let i=[new PIXI.Point(0,0),new PIXI.Point(this._itemWidth,0),new PIXI.Point(this._itemWidth,this._itemHeight),new PIXI.Point(0,this._itemHeight)];this.globalRect=null,i.forEach(e=>{let t=BFN.MainUI.toLocal(e,this);this.globalRect?(this.globalRect.left=Math.min(this.globalRect.left,t.x),this.globalRect.right=Math.max(this.globalRect.right,t.x),this.globalRect.top=Math.min(this.globalRect.top,t.y),this.globalRect.bottom=Math.max(this.globalRect.bottom,t.y)):this.globalRect=new BFN.Rectangle(t.x,t.y)}),this.globalRect?(this.globalRect.x+=BFN.MainUI.x+BFN.leftMenuMinimumWidth,this.globalRect.y+=BFN.MainUI.y+BFN.topNavBarHeight):this.globalRect=new BFN.Rectangle;for(let e in this.edgeBars)this.edgeBars[e].updateGlobalBounds()};De.prototype.handleChildContentSelect=function(i){this.dispatchEvent(BFN.PhotoGridChildEvents.SELECT_CHILD)};De.prototype.handleChildContentDrag=function(i){this.dispatchEvent(BFN.PhotoGridChildEvents.DRAG_CHILD)};De.prototype.handleChildContentDelete=function(i){this.dispatchEvent(BFN.PhotoGridChildEvents.DELETE_CHILD)};De.prototype.handleChildContentImageUpdated=function(i){this.dispatchEvent(BFN.PhotoGridChildEvents.CHILD_IMAGE_UPDATED)};De.prototype.handleChildContentImagePositionUpdated=function(i){this.dispatchEvent(BFN.PhotoGridChildEvents.CHILD_IMAGE_POSITION_UPDATED)};De.prototype.handleEdgeBarOver=function(i){if(!BeFunky.isPointerDown||BeFunky.isPointerDown&&this._awaitingDrop){let e=i.currentTarget,t=i.data.originalEvent.shiftKey,r=i.data.originalEvent.ctrlKey||i.data.originalEvent.metaKey;this._hoveredEdge=e.id,this._attemptUngrouping=t,this._attemptSeparation=r||this._awaitingDrop,document.addEventListener("keydown",this.handleKeyDownBind),document.addEventListener("keyup",this.handleKeyUpBind),setTimeout(function(){this.dispatchEvent(BFN.PhotoGridChildEvents.EDGE_BAR_HOVERED)}.bind(this),0)}};De.prototype.handleEdgeBarOut=function(i){this._hoveredEdge=null,this._attemptUngrouping=!1,this._attemptSeparation=!1,document.removeEventListener("keydown",this.handleKeyDownBind),document.removeEventListener("keyup",this.handleKeyUpBind),this.dispatchEvent(BFN.PhotoGridChildEvents.EDGE_BAR_HOVERED)};De.prototype.handleEdgeBarPressed=function(i){let e=i.currentTarget,t=i.data.originalEvent.shiftKey,r=i.data.originalEvent.ctrlKey||i.data.originalEvent.metaKey,a=i.data.originalEvent.altKey;r&&a?(e.showEdgeBar&&e.animator.setAnimatorFactor(0),this.dispatchEvent(BFN.PhotoGridChildEvents.INSERT_CHILD)):(i.data.pointerType=="touch"&&(this._hoveredEdge=e.id,this._attemptUngrouping=t,this._attemptSeparation=r,this.dispatchEvent(BFN.PhotoGridChildEvents.EDGE_BAR_HOVERED)),this.dispatchEvent(BFN.PhotoGridChildEvents.EDGE_BAR_PRESSED))};De.prototype.handleKeyDown=function(i){i.shiftKey&&(this._attemptUngrouping=!0),(i.metaKey||i.ctrlKey)&&(this._attemptSeparation=!0),(i.metaKey||i.ctrlKey||i.shiftKey)&&this.dispatchEvent(BFN.PhotoGridChildEvents.EDGE_BAR_HOVERED)};De.prototype.handleKeyUp=function(i){i.keyCode==16&&(this._attemptUngrouping=!1),(i.keyCode==17||i.keyCode==91||i.keyCode==93)&&(this._attemptSeparation=!1),(i.keyCode==16||i.keyCode==17||i.keyCode==91||i.keyCode==93)&&this.dispatchEvent(BFN.PhotoGridChildEvents.EDGE_BAR_HOVERED)};De.prototype.handleTransitionAnimatorUpdate=function(i){this.x=(this._transitionRect.x-this._rect.x)*this.transitionAnimator.animationSinFactor+this._rect.x,this.y=(this._transitionRect.y-this._rect.y)*this.transitionAnimator.animationSinFactor+this._rect.y,this.setSize((this._transitionRect.width-this._rect.width)*this.transitionAnimator.animationSinFactor+this._rect.width,(this._transitionRect.height-this._rect.height)*this.transitionAnimator.animationSinFactor+this._rect.height)};De.prototype.handleTransitionAnimatorUpdateComplete=function(i){this.updateRect(),BFN.smoothPictureDisabled=!1,this.dispatchEvent(BFN.PhotoGridChildEvents.TRANSITION_COMPLETE)};Object.defineProperty(De.prototype,"destroyed",{get:function(){return this._destroyed}});Object.defineProperty(De.prototype,"id",{set:function(i){this._id=i},get:function(){return this._id}});Object.defineProperty(De.prototype,"contentContainer",{get:function(){return this.childContentContainer}});Object.defineProperty(De.prototype,"content",{get:function(){return this.childContent}});Object.defineProperty(De.prototype,"backgroundColor",{set:function(i){this.childContent.backgroundColor=i},get:function(){return this.childContent.backgroundColor}});Object.defineProperty(De.prototype,"borderColor",{set:function(i){this.childContent.borderColor=i},get:function(){return this.childContent.borderColor}});Object.defineProperty(De.prototype,"gap",{set:function(i){this._gap=i,this.updateSize()},get:function(){return this._gap}});Object.defineProperty(De.prototype,"rounding",{set:function(i){this._rounding=i,this.updateRounding()},get:function(){return this._rounding}});Object.defineProperty(De.prototype,"scale",{set:function(i){this._scale=i,this.childContent.image.scale=this._scale,this.updateSize()},get:function(){return this._scale}});Object.defineProperty(De.prototype,"hoveredEdge",{get:function(){return this._hoveredEdge}});Object.defineProperty(De.prototype,"hoveredEdgeLocked",{get:function(){return this._hoveredEdge=="left"&&this._factorRect.left==0||this._hoveredEdge=="top"&&this._factorRect.top==0||this._hoveredEdge=="right"&&this._factorRect.right==1||this._hoveredEdge=="bottom"&&this._factorRect.bottom==1}});Object.defineProperty(De.prototype,"rect",{get:function(){return this._rect}});Object.defineProperty(De.prototype,"factorRect",{get:function(){return this._factorRect}});Object.defineProperty(De.prototype,"attemptUngrouping",{get:function(){return this._attemptUngrouping}});Object.defineProperty(De.prototype,"attemptSeparation",{get:function(){return this._attemptSeparation}});Object.defineProperty(De.prototype,"dragPosition",{set:function(i){this._dragPosition=i},get:function(){return this._dragPosition}});Object.defineProperty(De.prototype,"transitionRect",{get:function(){return this._transitionRect}});Object.defineProperty(De.prototype,"awaitingDrop",{set:function(i){this._awaitingDrop=this.childContent.awaitingDrop=i},get:function(){return this._awaitingDrop}});Object.defineProperty(De.prototype,"itemWidth",{set:function(i){this._itemWidth=i,this.updateSize()},get:function(){return this._itemWidth}});Object.defineProperty(De.prototype,"itemHeight",{set:function(i){this._itemHeight=i,this.updateSize()},get:function(){return this._itemHeight}});Object.defineProperty(De.prototype,"menuImageVO",{set:function(i){this._menuImageVO=i,this.updateProjectItemVO()},get:function(){return this._menuImageVO}});BFN.PhotoGridChild=De;function Rt(){PIXI.Container.call(this),this.init()}Rt.prototype=Object.create(PIXI.Container.prototype);Rt.prototype.init=function(){BeFunky.log("PhotoGridIsolator Init"),this.initDefaultValues(),this.initVeil(),this.initContentContainer(),this.initAnimator()};Rt.prototype.initDefaultValues=function(){this.visible=!1,this._padding=0,this._itemWidth=0,this._itemHeight=0,this.originalPosition=new PIXI.Point,this.hovered=!1,this.dragging=!1,this.gridChild=null,this.handleMainUIMouseDownBind=this.handleMainUIMouseDown.bind(this),this.handleForceIsolationReleaseBind=this.handleForceIsolationRelease.bind(this)};Rt.prototype.initVeil=function(){this.veil=new PIXI.Graphics,this.veil.interactive=!0,this.veil.beginFill(1909805,.7),this.veil.drawRect(0,0,100,100),this.veil.endFill(),this.addChild(this.veil)};Rt.prototype.initContentContainer=function(){this.contentContainer=new PIXI.Container,this.addChild(this.contentContainer)};Rt.prototype.initAnimator=function(){this.handleAnimatorUpdateBind=this.handleAnimatorUpdate.bind(this),this.handleAnimatorDecreaseCompleteBind=this.handleAnimatorDecreaseComplete.bind(this),this.animator=new BFN.Animator,this.animator.addEventListener(BFN.AnimatorEvents.UPDATE.type,this.handleAnimatorUpdateBind),this.animator.addEventListener(BFN.AnimatorEvents.DECREASE_COMPLETE.type,this.handleAnimatorDecreaseCompleteBind),this.animator.setAnimatorFactor(0)};Rt.prototype.captureGridChild=function(i,e=!1){i&&!this.gridChild&&(this.gridChild=i,this.gridChild.content.isolated=!0,this.originalPosition.x=this.gridChild.content.x,this.originalPosition.y=this.gridChild.content.y,this.gridChild.content.addEventListener(BFN.PhotoGridChildContentEvents.FORCE_ISOLATION_RELEASE.type,this.handleForceIsolationReleaseBind),this.gridChild.content.x=this.gridChild.x+this.gridChild.content.x,this.gridChild.content.y=this.gridChild.y+this.gridChild.content.y,this.contentContainer.addChild(this.gridChild.content),this.frameSprite=this.gridChild.content.image.frameSprite,this.initialOffsetFactorX=this.frameSprite.offsetFactorX,this.initialOffsetFactorY=this.frameSprite.offsetFactorY,this.initialScale=this.frameSprite.textureScale,this.initialRotate=this.frameSprite.texture.rotate,BFN.MainUI.addEventListener(BFN.MainUIEvents.MOUSE_DOWN.type,this.handleMainUIMouseDownBind),this.visible=!0,e?(this.animator.setAnimatorFactor(1),this.animator.dispatchEvent(BFN.AnimatorEvents.INCREASE_COMPLETE)):this.animator.increase(),document.querySelectorAll(".draggable-panel").addClass("disabled"),BFN.SentryManager.reportBreadcrumb(BFN.SentryManager.getDisplayObjectInfo(this.gridChild),"enter_grid_child_edit","app_action"))};Rt.prototype.releaseGridChild=function(i=!1){BFN.MainUI.removeEventListener(BFN.MainUIEvents.MOUSE_DOWN.type,this.handleMainUIMouseDownBind),i?(this.animator.setAnimatorFactor(0),this.animator.dispatchEvent(BFN.AnimatorEvents.DECREASE_COMPLETE)):this.animator.decrease()};Rt.prototype.updateDisplay=function(){this.veil.x=-this._padding,this.veil.y=-this._padding,this.veil.width=this._itemWidth+this._padding*2,this.veil.height=this._itemHeight+this._padding*2};Rt.prototype.revertChanges=function(){this.gridChild&&this.frameSprite&&(this.frameSprite.offsetFactorX=this.initialOffsetFactorX,this.frameSprite.offsetFactorY=this.initialOffsetFactorY,this.frameSprite.textureScale=this.initialScale,this.frameSprite.texture.rotate=this.initialRotate,this.frameSprite.updateDisplay(),this.gridChild.content.image.updateSmoothing())};Rt.prototype.handleMainUIMouseDown=function(i){this.gridChild&&!this.gridChild.content.pressed&&BFN.PhotoGrid.isolateGridChild(null)};Rt.prototype.handleForceIsolationRelease=function(i){this.animator.setAnimatorFactor(0),this.handleAnimatorDecreaseCompleteBind(null)};Rt.prototype.handleAnimatorUpdate=function(i){this.veil.alpha=this.animator.animationFactor};Rt.prototype.handleAnimatorDecreaseComplete=function(i){this.gridChild&&(this.gridChild.content.isolated=!1,this.gridChild.content.removeEventListener(BFN.PhotoGridChildContentEvents.FORCE_ISOLATION_RELEASE.type,this.handleForceIsolationReleaseBind),this.gridChild.content.x=this.originalPosition.x,this.gridChild.content.y=this.originalPosition.y,this.gridChild.contentContainer.addChild(this.gridChild.content),i&&(this.initialOffsetFactorX!=this.frameSprite.offsetFactorX||this.initialOffsetFactorY!=this.frameSprite.offsetFactorY||this.initialScale!=this.frameSprite.textureScale||this.initialRotate!=this.frameSprite.texture.rotate)&&this.gridChild.content.dispatchEvent(BFN.PhotoGridChildContentEvents.IMAGE_UPDATED),BFN.SentryManager.reportBreadcrumb(BFN.SentryManager.getDisplayObjectInfo(this.gridChild),"exit_grid_child_edit","app_action"),this.gridChild=null,this.frameSprite=null),this.visible=!1,document.querySelectorAll(".draggable-panel").removeClass("disabled"),BFN.HiResTextManager.updateHighResText()};Object.defineProperty(Rt.prototype,"padding",{set:function(i){this._padding=i,this.updateDisplay()},get:function(){return this._padding}});Object.defineProperty(Rt.prototype,"itemWidth",{set:function(i){this._itemWidth=i,this.updateDisplay()},get:function(){return this._itemWidth}});Object.defineProperty(Rt.prototype,"itemHeight",{set:function(i){this._itemHeight=i,this.updateDisplay()},get:function(){return this._itemHeight}});BFN.PhotoGridIsolator=Rt;function qt(){PIXI.Container.call(this),this.init()}qt.prototype=Object.create(PIXI.Container.prototype);qt.prototype.init=function(){BeFunky.log("PhotoGridDragBar Init"),this.initDefaultValues(),this.initBlock(),this.initIndicator(),this.initAnimator()};qt.prototype.initDefaultValues=function(){this.baseSize=2,this._direction="horizontal",this._length=this.baseSize,this._scale=1,this._indicatorSide=null};qt.prototype.initBlock=function(){this.blockContainer=new PIXI.Container,this.addChild(this.blockContainer),this.block=new PIXI.Graphics,this.block.beginFill(0),this.block.drawRect(-(this.baseSize/2),-(this.baseSize/2),this.baseSize,this.baseSize),this.block.endFill(),this.blockContainer.addChild(this.block),this.block.dashedLineFilter=new BFN.filters.DashedLineFilter,this.block.dashedLineFilter.dashSize=10,this.block.filters=[this.block.dashedLineFilter]};qt.prototype.initIndicator=function(){this.indicatorContainer=new PIXI.Container,this.addChild(this.indicatorContainer),this.indicator=new PIXI.Graphics,this.indicator.beginFill(0),this.indicator.drawRect(-(this.baseSize/2),-(this.baseSize/2),this.baseSize,this.baseSize),this.indicator.endFill(),this.indicatorContainer.addChild(this.indicator),this.indicator.dashedLineFilter=new BFN.filters.DashedLineFilter,this.indicator.dashedLineFilter.dashSize=10,this.indicator.filters=[this.indicator.dashedLineFilter]};qt.prototype.initAnimator=function(){this.handleAnimatorUpdateBind=this.handleAnimatorUpdate.bind(this),this._animator=new BFN.Animator,this._animator.addEventListener(BFN.AnimatorEvents.UPDATE.type,this.handleAnimatorUpdateBind),this._animator.setAnimatorFactor(0)};qt.prototype.show=function(){this._animator.increase()};qt.prototype.hide=function(){this._animator.decrease()};qt.prototype.updateDisplay=function(){this.block.width=this._direction=="horizontal"?this._length:this.baseSize,this.block.height=this._direction=="vertical"?this._length:this.baseSize,this.indicator.width=this._direction=="horizontal"?this._length*.96:this.baseSize,this.indicator.height=this._direction=="vertical"?this._length*.96:this.baseSize,this.updateScale()};qt.prototype.updateScale=function(){if(this.blockContainer.scale.x=this.indicatorContainer.scale.x=this._direction=="vertical"?1/this._scale:1,this.blockContainer.scale.y=this.indicatorContainer.scale.y=this._direction=="horizontal"?1/this._scale:1,this.indicatorContainer.x=0,this.indicatorContainer.y=0,this._indicatorSide)switch(this.indicator.visible=!0,this._indicatorSide){case"left":this.indicatorContainer.x=this.baseSize*4/this._scale;break;case"top":this.indicatorContainer.y=this.baseSize*4/this._scale;break;case"right":this.indicatorContainer.x=-(this.baseSize*4/this._scale);break;case"bottom":this.indicatorContainer.y=-(this.baseSize*4/this._scale);break}else this.indicator.visible=!1};qt.prototype.handleAnimatorUpdate=function(i){this.blockContainer.alpha=this._animator.animationFactor*.8+.2,this.visible=this._animator.animationFactor>0};Object.defineProperty(qt.prototype,"animator",{get:function(){return this._animator}});Object.defineProperty(qt.prototype,"direction",{set:function(i){this._direction=i,this.updateDisplay()},get:function(){return this._direction}});Object.defineProperty(qt.prototype,"length",{set:function(i){this._length=i,this.updateDisplay()},get:function(){return this._length}});Object.defineProperty(qt.prototype,"scale",{set:function(i){this._scale=i,this.updateScale()},get:function(){return this._scale}});Object.defineProperty(qt.prototype,"indicatorSide",{set:function(i){this._indicatorSide=i,this.updateDisplay()},get:function(){return this._indicatorSide}});BFN.PhotoGridDragBar=qt;function li(){PIXI.Container.call(this),this.init()}li.prototype=Object.create(PIXI.Container.prototype);li.prototype.init=function(){BeFunky.log("PhotoGridEdgeIndicator Init"),this.initDefaultValues(),this.initDisplay(),this.initDashedFilter()};li.prototype.initDefaultValues=function(){this.visible=!1,this._direction="horizontal",this._length=100,this._offset=0,this._scale=1};li.prototype.initDisplay=function(){this.holder=new PIXI.Container,this.addChild(this.holder),this.outerIndicator=new PIXI.Graphics,this.holder.addChild(this.outerIndicator),this.innerIndicator=new PIXI.Graphics,this.innerIndicator.visible=!1,this.holder.addChild(this.innerIndicator)};li.prototype.initDashedFilter=function(){this.dashedLineFilter=new BFN.filters.DashedLineFilter,this.dashedLineFilter.dashSize=10,this.filters=[this.dashedLineFilter]};li.prototype.drawIndicators=function(){switch(this.outerIndicator.clear(),this.innerIndicator.clear(),this.holder.scale.x=this.holder.scale.y=1,this.outerIndicator.beginFill(0),this.innerIndicator.beginFill(8421504),this._direction){case"horizontal":this.outerIndicator.drawRect(-50,-1,100,2),this.innerIndicator.drawRect(-50,-1,100,2);break;case"vertical":this.outerIndicator.drawRect(-1,-50,2,100),this.innerIndicator.drawRect(-1,-50,2,100);break}this.updateLength(),this.updateOffset(),this.updateScale()};li.prototype.updateLength=function(){switch(this._direction){case"horizontal":this.holder.scale.x=(this._length-Math.abs(this._offset/this._scale)*4)/100,this.holder.scale.y=1/this._scale;break;case"vertical":this.holder.scale.x=1/this._scale,this.holder.scale.y=(this._length-Math.abs(this._offset/this._scale)*4)/100;break}};li.prototype.updateOffset=function(){switch(this.holder.x=this.holder.y=0,this._direction){case"horizontal":this.holder.y=this._offset/this._scale;break;case"vertical":this.holder.x=this._offset/this._scale;break}this.updateLength()};li.prototype.updateScale=function(){this.updateLength()};Object.defineProperty(li.prototype,"direction",{set:function(i){(i=="horizontal"||i=="vertical")&&(this._direction=i,this.drawIndicators())},get:function(){return this._direction}});Object.defineProperty(li.prototype,"length",{set:function(i){this._length=i,this.updateLength()},get:function(){return this._length}});Object.defineProperty(li.prototype,"offset",{set:function(i){this._offset=i,this.updateOffset()},get:function(){return this._length}});Object.defineProperty(li.prototype,"scale",{set:function(i){this._scale=i,this.updateOffset(),this.updateScale()},get:function(){return this._scale}});Object.defineProperty(li.prototype,"showing",{set:function(i){this.visible=i},get:function(){return this.visible}});Object.defineProperty(li.prototype,"selected",{set:function(i){this.outerIndicator=!i,this.innerIndicator.visible=i},get:function(){return this.innerIndicator.visible}});BFN.PhotoGridEdgeIndicator=li;BFN.PhotoGridEvents={PHOTO_GRID_SNAP_SHOT:new Event("PHOTO_GRID_SNAP_SHOT")};function me(){PIXI.Container.call(this),BFN.EventDispatcher.call(this),this.init()}me.prototype=window.azrc.extend(Object.create(PIXI.Container.prototype),Object.create(BFN.EventDispatcher.prototype));me.prototype.init=function(){BeFunky.log("PhotoGrid Init"),this.initDefaultValues(),this.initGridContainer(),this.initChildContainer(),this.initDragBar(),this.initEdgeIndicators(),this.initMenu(),this.initGridIsolator(),this.initDragger(),this.setSize(0,0)};me.prototype.initDefaultValues=function(){this.minSize=BFN.minImageSize*2,this.snapDistance=5,this.maxGap=0,this.maxGapFactor=.1,this._gridChildIsolated=!1,this._scale=1,this._backgroundColor="FFFFFF",this._gap=0,this._rounding=0,this.childBackgroundColor="000000",this.childBorderColor="000000",this._gridChildren=[],this._focusedChild=null,this._targetChild=null,this._selectedChild=null,this._draggedChild=null,this._awaitingDrop=!1,this._matchesTemplate=!1,this.includedChildren=[],this.excludedChildren=[],this.attachedChildren=[],this.transitionChildren=[],this.positions=[],this.intersectRect=new BFN.Rectangle,this.snapCoords=[],this.separationAchieved=!1,this.dragBarPosition=0,this._insertedGridChild=null,this.handleChildMouseOverBind=this.handleChildMouseOver.bind(this),this.handleChildMouseOutBind=this.handleChildMouseOut.bind(this),this.gridChildEventHandlers=[{event:BFN.PhotoGridChildEvents.EDGE_BAR_HOVERED,handler:this.handleEdgeBarHovered.bind(this)},{event:BFN.PhotoGridChildEvents.EDGE_BAR_PRESSED,handler:this.handleEdgeBarPressed.bind(this)},{event:BFN.PhotoGridChildEvents.INSERT_CHILD,handler:this.handleInsertChild.bind(this)},{event:BFN.PhotoGridChildEvents.SELECT_CHILD,handler:this.handleSelectChild.bind(this)},{event:BFN.PhotoGridChildEvents.DRAG_CHILD,handler:this.handleDragChild.bind(this)},{event:BFN.PhotoGridChildEvents.DELETE_CHILD,handler:this.handleDeleteChild.bind(this)},{event:BFN.PhotoGridChildEvents.CHILD_IMAGE_UPDATED,handler:this.handleChildImageUpdated.bind(this)},{event:BFN.PhotoGridChildEvents.CHILD_IMAGE_POSITION_UPDATED,handler:this.handleChildImagePositionUpdated.bind(this)},{event:BFN.PhotoGridChildEvents.TRANSITION_COMPLETE,handler:this.handleChildTransitionComplete.bind(this)}],this.handleEdgeBarReleasedBind=this.handleEdgeBarReleased.bind(this),this.handleDropChildBind=this.handleDropChild.bind(this),this.detectingTouchDragHovers=!1,this.detectHoversManuallyBind=this.detectHoversManually.bind(this),this.stopTouchDragHoverDetectionBind=this.stopTouchDragHoverDetection.bind(this)};me.prototype.initGridContainer=function(){this.gridContainer=new PIXI.Container,this.addChild(this.gridContainer)};me.prototype.initChildContainer=function(){this.childContainer=new PIXI.Container,this.gridContainer.addChild(this.childContainer)};me.prototype.initDragBar=function(){this.dragBar=new BFN.PhotoGridDragBar,this.gridContainer.addChild(this.dragBar)};me.prototype.initEdgeIndicators=function(){this.edgeIndicatorData=[{id:"left",direction:"vertical",offset:5},{id:"top",direction:"horizontal",offset:5},{id:"right",direction:"vertical",offset:-5},{id:"bottom",direction:"horizontal",offset:-5}],this.edgeIndicators={},this.edgeIndicatorContainer=new PIXI.Container,this.addChild(this.edgeIndicatorContainer);for(let i=0;i<this.edgeIndicatorData.length;i++){let e=this.edgeIndicatorData[i],t=new BFN.PhotoGridEdgeIndicator;t.direction=e.direction,t.offset=e.offset,this.edgeIndicators[e.id]=t,this.edgeIndicatorContainer.addChild(t)}};me.prototype.initMenu=function(){this.contextMenu=document.getElementById("context_menu_collage"),BeFunky.contextMenu(this.contextMenu,{add_image:{onClick:this.handleAddImage.bind(this)},edit_image:{onClick:this.handleEditImage.bind(this)},remove_image:{onClick:this.handleRemoveImage.bind(this)},delete_cell:{onClick:this.handleDeleteCell.bind(this)}}),this.contextMenu.target=document.querySelector("#appStage canvas"),this.contextMenu.enabled=!1,this.contextMenu.addEventListener("SHOW",()=>{this.contextMenu.enabled=!1})};me.prototype.initGridIsolator=function(){this.gridIsolator=new BFN.PhotoGridIsolator,this.addChild(this.gridIsolator)};me.prototype.initDragger=function(){this.dragger=new BFN.Dragger,this.dragger.autoDrag=!1,this.dragger.stickyDrag=!1,this.dragger.preventSelectionDrag=!0,this.dragger.addEventListener(BFN.DraggerEvents.DRAGGING.type,this.handleDragging.bind(this)),this.dragger.addEventListener(BFN.DraggerEvents.DRAGGING_COMPLETE.type,this.handleDraggingComplete.bind(this))};me.prototype.setSize=function(i,e){this._itemWidth=i,this._itemHeight=e,this.hitArea=new PIXI.Rectangle(0,0,i,e),this.updateDisplay(),this.updateGaps(),this._matchesTemplate&&(this._matchesTemplate=!1)};me.prototype.showEdgeIndicators=function(i=0,e=0,t=0,r=0){this.edgeIndicators.left.showing=i>0,this.edgeIndicators.left.selected=i>1,this.edgeIndicators.top.showing=e>0,this.edgeIndicators.top.selected=e>1,this.edgeIndicators.right.showing=t>0,this.edgeIndicators.right.selected=t>1,this.edgeIndicators.bottom.showing=r>0,this.edgeIndicators.bottom.selected=r>1,BFN.MainUI.requestRender()};me.prototype.updateDisplay=function(){this.gridIsolator.itemWidth=this._itemWidth,this.gridIsolator.itemHeight=this._itemHeight,this.edgeIndicators.left.x=-this.gapPixels,this.edgeIndicators.left.y=this._itemHeight/2,this.edgeIndicators.left.length=this._itemHeight+this.gapPixels*2,this.edgeIndicators.left.scale=this._scale,this.edgeIndicators.top.x=this._itemWidth/2,this.edgeIndicators.top.y=-this.gapPixels,this.edgeIndicators.top.length=this._itemWidth+this.gapPixels*2,this.edgeIndicators.top.scale=this._scale,this.edgeIndicators.right.x=this._itemWidth+this.gapPixels,this.edgeIndicators.right.y=this._itemHeight/2,this.edgeIndicators.right.length=this._itemHeight+this.gapPixels*2,this.edgeIndicators.right.scale=this._scale,this.edgeIndicators.bottom.x=this._itemWidth/2,this.edgeIndicators.bottom.y=this._itemHeight+this.gapPixels,this.edgeIndicators.bottom.length=this._itemWidth+this.gapPixels*2,this.edgeIndicators.bottom.scale=this._scale;for(let i=0;i<this._gridChildren.length;i++){let e=this._gridChildren[i];e.x=Math.round(e.factorRect.left*this._itemWidth),e.y=Math.round(e.factorRect.top*this._itemHeight),e.setSize(Math.round(e.factorRect.right*this._itemWidth)-e.x,Math.round(e.factorRect.bottom*this._itemHeight)-e.y),e.content.image.setPhotoGridDimensions(this._itemWidth,this._itemHeight)}};me.prototype.setMaxGapFromDimensions=function(i,e){this.maxGap=Math.round(Math.min(i,e)*this.maxGapFactor)};me.prototype.updateGaps=function(){for(let i=0;i<this._gridChildren.length;i++){let e=this._gridChildren[i];e.gap=this._gap*this.maxGap}this.gridIsolator.padding=this._gap*this.maxGap};me.prototype.updateRounding=function(){for(let i=0;i<this._gridChildren.length;i++){let e=this._gridChildren[i];e.rounding=this._rounding}};me.prototype.addGridChild=function(i,e,t,r){let a=new BFN.PhotoGridChild;a.x=i,a.y=e,a.setSize(t,r),a.backgroundColor=this.childBackgroundColor,a.borderColor=this.childBorderColor,a.gap=this._gap*this.maxGap,a.rounding=this._rounding,a.scale=this._scale,a.on("pointerover",this.handleChildMouseOverBind),a.on("pointerout",this.handleChildMouseOutBind);for(let s=0;s<this.gridChildEventHandlers.length;s++)a.addEventListener(this.gridChildEventHandlers[s].event.type,this.gridChildEventHandlers[s].handler);return this.childContainer.addChild(a),this._gridChildren.push(a),this.updateRect(a),this.updateFactorRect(a),a.content.image.setPhotoGridDimensions(this._itemWidth,this._itemHeight),this._matchesTemplate&&(this._matchesTemplate=!1),a};me.prototype.clearAllGridChildren=function(){let i=this._gridChildren.length;for(;--i>-1;){let e=this._gridChildren[i];this.clearGridChild(e)}};me.prototype.clearGridChild=function(i){i.menuImageVO=null,i.content.setImage(null)};me.prototype.removeAllGridChildren=function(){let i=this._gridChildren.length;for(;--i>-1;){let e=this._gridChildren[i];this.removeGridChild(e)}this._gridChildren.splice(0)};me.prototype.removeGridChild=function(i){if(this._gridChildren.indexOf(i)!==-1&&this.childContainer.getChildIndex(i)!==-1){i.off("pointerover",this.handleChildMouseOverBind),i.off("pointerout",this.handleChildMouseOutBind);for(let e=0;e<this.gridChildEventHandlers.length;e++)i.removeEventListener(this.gridChildEventHandlers[e].event.type,this.gridChildEventHandlers[e].handler);i.destroy(),this.childContainer.removeChild(i),this._gridChildren.splice(this._gridChildren.indexOf(i),1),i=null,this._matchesTemplate&&(this._matchesTemplate=!1)}};me.prototype.isolateGridChild=function(i=null,e=!1){i?(this._gridChildIsolated=!0,BFN.CollageMakerCanvas.canvasScaleBars.enabled=!1,this.gridIsolator.captureGridChild(i),BFN.CollageMakerCanvas.transformLayer.visible=!1,UIToggler.openAlternateMenu("edit_image",["collage_image_menu"]),UITools.setToolValue("collage_image","size",i.content.image.resizeScale*100),UITools.updateToolControl("collage_image_size")):(this._gridChildIsolated=!1,BFN.CollageMakerCanvas.canvasScaleBars.enabled=!0,this.gridIsolator.releaseGridChild(e),BFN.CollageMakerCanvas.transformLayer.visible=!0,UIToggler.closeAlternateMenu(),this.selectedChild=null)};me.prototype.hideDragBar=function(){this.dragBar.hide()};me.prototype.getPhotoGridSnapShot=function(){this.dispatchEvent(BFN.PhotoGridEvents.PHOTO_GRID_SNAP_SHOT)};me.prototype.toggleEmptyCells=function(i){for(let e=0;e<this._gridChildren.length;e++){let t=this._gridChildren[e];t.visible=!((t.content.isEmpty||!t.content.imageEnabled)&&!i),t.content.background.visible=(t.content.isEmpty||!t.content.imageEnabled)&&i}};me.prototype.toggleBorders=function(i,e=0){for(let t=0;t<this._gridChildren.length;t++)this._gridChildren[t].content.toggleBorder(i,e)};me.prototype.repair=function(){let i={},e={},t=0;for(let s=0;s<this._gridChildren.length;s++){let o=this._gridChildren[s];this.updateRect(o),this.updateFactorRect(o),i.hasOwnProperty(o.rect.left)||(i[o.rect.left]=[]),i.hasOwnProperty(o.rect.right)||(i[o.rect.right]=[]),i[o.rect.left].push(o),i[o.rect.right].push(o),e.hasOwnProperty(o.rect.top)||(e[o.rect.top]=[]),e.hasOwnProperty(o.rect.bottom)||(e[o.rect.bottom]=[]),e[o.rect.top].push(o),e[o.rect.bottom].push(o)}let r=this.repairChildren(i,"x"),a=this.repairChildren(e,"y");(t||r||a)&&(console.log(""),t&&console.log(`Repaired Coordinates for ${t} Overlapping Children`),r&&console.log(`Repaired Coordinates for ${r} Children on X-Axis`),a&&console.log(`Repaired Coordinates for ${a} Children on Y-Axis`))};me.prototype.repairChildren=function(i,e){let t=[],r={},a=Object.keys(i);a.sort((o,n)=>o-n);let s=a.length;for(;--s>0;){let o=a[s],n=a[s-1];Math.abs(o-n)<=1&&(t=t.concat(i[o]),i[n]=i[n].concat(i[o]),i[o].splice(0),delete i[o],r[o]=parseInt(n),a.splice(s,1))}return t=t.unique(),t.forEach(o=>{let n=o.itemWidth,l=o.itemHeight;switch(e){case"x":r.hasOwnProperty(o.rect.left)&&(n+=o.rect.left-r[o.rect.left],o.x=r[o.rect.left]),r.hasOwnProperty(o.rect.right)&&(n+=r[o.rect.right]-o.rect.right),o.setSize(n,l);break;case"y":r.hasOwnProperty(o.rect.top)&&(l+=o.rect.top-r[o.rect.top],o.y=r[o.rect.top]),r.hasOwnProperty(o.rect.bottom)&&(l+=r[o.rect.bottom]-o.rect.bottom),o.setSize(n,l);break}this.updateRect(o),this.updateFactorRect(o)}),t.length};me.prototype.updateRect=function(i){i.updateRect()};me.prototype.updateFactorRect=function(i){i.factorRect.left=Math.max(0,i.x/this._itemWidth),i.factorRect.right=Math.min(1,(i.x+i.itemWidth)/this._itemWidth),i.factorRect.top=Math.max(0,i.y/this._itemHeight),i.factorRect.bottom=Math.min(1,(i.y+i.itemHeight)/this._itemHeight)};me.prototype.setChildVeilVisibility=function(i){for(let e=0;e<this._gridChildren.length;e++){let t=this._gridChildren[e];t.content.veil.visible=i}};me.prototype.getGridMenuImageVOs=function(){let i=[];for(let e=0;e<this.gridChildren.length;e++){let t=this.gridChildren[e];t.menuImageVO&&i.push(t.menuImageVO)}return i};me.prototype.getChildUnderPosition=function(i,e){let t=BFN.CollageMakerCanvas.toLocal(new PIXI.Point,this.childContainer);i-=t.x,e-=t.y;for(let r=0;r<this.gridChildren.length;r++){let a=this.gridChildren[r];if(a.rect.contains(i,e))return a}return null};me.prototype.handleAddImage=function(i){this._selectedChild&&!this._selectedChild.destroyed&&(this._targetChild=this._selectedChild,BFN.ImageLibraryManager.uploadImages(e=>{!e.isComplete&&e.menuImageVO&&BFN.ImageLibraryManager.addImageToCanvas(e.menuImageVO)},{allowMultiple:!1}))};me.prototype.handleEditImage=function(i){this._selectedChild&&!this._selectedChild.destroyed&&this.isolateGridChild(this._selectedChild)};me.prototype.handleRemoveImage=function(i){this._selectedChild&&!this._selectedChild.destroyed&&(this._selectedChild.content.isEmpty||(this._selectedChild.menuImageVO=null,this._selectedChild.content.setImage(null)))};me.prototype.handleDeleteCell=function(i){this._selectedChild&&!this._selectedChild.destroyed&&(this._selectedChild.content.isEmpty||(this._selectedChild.menuImageVO=null,this._selectedChild.content.setImage(null,!0,!0)),this._selectedChild.content.deleteItem(i.ctrlKey||i.metaKey))};me.prototype.handleDragging=function(i){if(this.dragger.wasDragged){this.dragBar.x=Math.round(this.dragger.draggedX),this.dragBar.y=Math.round(this.dragger.draggedY);let e=!0,t=null;for(let r=0;r<this.snapCoords.length;r++){let a=this.snapCoords[r];switch(this.dragBar.direction){case"horizontal":Math.abs(this.dragBar.y-a)<this.snapDistance/this._scale&&(t=Math.round(a));break;case"vertical":Math.abs(this.dragBar.x-a)<this.snapDistance/this._scale&&(t=Math.round(a));break}}if(t!==null){for(let r=0;r<this.includedChildren.length;r++){let a=this.includedChildren[r],s;switch(this.dragBar.direction){case"horizontal":s=a.dragPosition==="after"?a.rect.bottom-t:t-a.rect.top;break;case"vertical":s=a.dragPosition==="after"?a.rect.right-t:t-a.rect.left;break}if(s<this.minSize+this.gapPixels*2){e=!1;break}}if(e)switch(this.dragBar.direction){case"horizontal":this.dragBar.y=t;break;case"vertical":this.dragBar.x=t;break}}for(let r=0;r<this.includedChildren.length;r++){let a=this.includedChildren[r];switch(this.dragBar.direction){case"horizontal":a.y=a.dragPosition==="after"?this.dragBar.y:a.y,a.itemHeight=a.dragPosition==="after"?a.rect.bottom-this.dragBar.y:this.dragBar.y-a.rect.top;break;case"vertical":a.x=a.dragPosition==="after"?this.dragBar.x:a.x,a.itemWidth=a.dragPosition==="after"?a.rect.right-this.dragBar.x:this.dragBar.x-a.rect.left;break}this.updateFactorRect(a)}}};me.prototype.handleDraggingComplete=function(i){this.dragBar.hide(),this._matchesTemplate&&(this._matchesTemplate=!1)};me.prototype.handleChildMouseOver=function(i){let{currentTarget:e}=i;setTimeout(()=>{this._focusedChild=e},0)};me.prototype.handleChildMouseOut=function(i){this._focusedChild=null};me.prototype.handleEdgeBarHovered=function(i){let e=i.dispatcher;if(e.hoveredEdge&&!this.dragger.item){this.includedChildren.splice(0),this.includedChildren.push(e);let t=new BFN.Rectangle,r=null;switch(e.hoveredEdge){case"left":case"right":t.top=e.y,t.bottom=e.y+e.itemHeight,t.left=t.right=e.x+(e.hoveredEdge==="right"?e.itemWidth:0),r="vertical";break;case"top":case"bottom":t.left=e.x,t.right=e.x+e.itemWidth,t.top=t.bottom=e.y+(e.hoveredEdge==="bottom"?e.itemHeight:0),r="horizontal";break}if(this.separationAchieved=!1,e.attemptSeparation)this.separationAchieved=!0;else if(e.attemptUngrouping&&!e.hoveredEdgeLocked){for(let a=0;a<this._gridChildren.length;a++)if(e=this._gridChildren[a],this.includedChildren.indexOf(e)===-1)switch(r){case"vertical":(e.x==t.x||e.x+e.itemWidth==t.x)&&e.y==t.top&&e.y+e.itemHeight==t.bottom&&(this.includedChildren.push(e),this.separationAchieved=!0);break;case"horizontal":(e.y==t.y||e.y+e.itemHeight==t.y)&&e.x==t.left&&e.x+e.itemWidth==t.right&&(this.includedChildren.push(e),this.separationAchieved=!0);break}}if(e=i.dispatcher,!this.separationAchieved&&!e.hoveredEdgeLocked)for(;;){let a=!1;for(let s=0;s<this._gridChildren.length;s++)if(e=this._gridChildren[s],this.includedChildren.indexOf(e)===-1)switch(r){case"vertical":(e.x==t.x||e.x+e.itemWidth==t.x)&&(e.y>=t.top&&e.y<=t.bottom||e.y+e.itemHeight>=t.top&&e.y+e.itemHeight<=t.bottom||e.y<t.top&&e.y+e.itemHeight>t.bottom)&&(t.top=Math.min(t.top,e.y),t.bottom=Math.max(t.bottom,e.y+e.itemHeight),this.includedChildren.push(e),a=!0);break;case"horizontal":(e.y==t.y||e.y+e.itemHeight==t.y)&&(e.x>=t.left&&e.x<=t.right||e.x+e.itemWidth>=t.left&&e.x+e.itemWidth<=t.right||e.x<t.left&&e.x+e.itemWidth>t.right)&&(t.left=Math.min(t.left,e.x),t.right=Math.max(t.right,e.x+e.itemWidth),this.includedChildren.push(e),a=!0);break}if(!a)break}if(e=i.dispatcher,this.separationAchieved||!e.hoveredEdgeLocked){switch(r){case"horizontal":this.intersectRect.left=t.left,this.intersectRect.right=t.right,this.intersectRect.top=0,this.intersectRect.bottom=this._itemHeight;break;case"vertical":this.intersectRect.left=0,this.intersectRect.right=this._itemWidth,this.intersectRect.top=t.top,this.intersectRect.bottom=t.bottom;break}this.dragBar.direction=r,this.dragBar.length=this.dragBar.direction==="horizontal"?t.width:t.height,this.dragBar.indicatorSide=this.separationAchieved&&e.attemptSeparation?e.hoveredEdge:null,this.dragBar.x=t.x+t.width/2,this.dragBar.y=t.y+t.height/2,this.dragBar.show(),e.awaitingDrop||(BFN.CursorScreen.cursor="arrow",BFN.CursorScreen.cursorRotation=this.dragBar.direction==="horizontal"?Math.PI/2:0)}else e.hoveredEdgeLocked&&!this.separationAchieved&&(this.dragger.dragging||(this.dragBar.hide(),BFN.CursorScreen.cursor=null))}else this.dragger.dragging||(this.dragBar.hide(),BFN.CursorScreen.cursor=null)};me.prototype.handleEdgeBarPressed=function(i){document.addEventListener(BeFunky.pointerup,this.handleEdgeBarReleasedBind),BFN.smoothPictureDisabled=!0,BFN.CursorScreen.cursorLock=!0;let e=i.dispatcher;if(!e.hoveredEdgeLocked||e.hoveredEdgeLocked&&this.separationAchieved){this.excludedChildren.splice(0);for(let r=0;r<this._gridChildren.length;r++)e=this.gridChildren[r],this.includedChildren.indexOf(e)===-1&&this.excludedChildren.push(e);this.snapCoords.splice(0),this.snapCoords.push(0),this.snapCoords.push(this.dragBar.direction==="horizontal"?this._itemHeight:this._itemWidth);for(let r=0;r<this.excludedChildren.length;r++){e=this.excludedChildren[r];let a=Math.floor(this.dragBar.direction==="horizontal"?e.y:e.x),s=Math.floor(this.dragBar.direction==="horizontal"?e.y+e.itemHeight:e.x+e.itemWidth);this.snapCoords.indexOf(a)===-1&&this.snapCoords.push(a),this.snapCoords.indexOf(s)===-1&&this.snapCoords.push(s)}let t=new BFN.Rectangle(this.intersectRect.x,this.intersectRect.y,this.intersectRect.width,this.intersectRect.height);for(let r=0;r<this.excludedChildren.length;r++)if(e=this.excludedChildren[r],e.rect.x=e.x,e.rect.y=e.y,e.rect.width=e.itemWidth,e.rect.height=e.itemHeight,e.rect.intersects(this.intersectRect))switch(this.dragBar.direction){case"horizontal":e.rect.bottom<=this.dragBar.y?t.top=Math.max(t.top,e.rect.bottom):e.rect.top>=this.dragBar.y&&(t.bottom=Math.min(t.bottom,e.rect.top));break;case"vertical":e.rect.right<=this.dragBar.x?t.left=Math.max(t.left,e.rect.right):e.rect.left>=this.dragBar.x&&(t.right=Math.min(t.right,e.rect.left));break}for(let r=0;r<this.includedChildren.length;r++)if(e=this.includedChildren[r],e.rect.x=e.x,e.rect.y=e.y,e.rect.width=e.itemWidth,e.rect.height=e.itemHeight,e.rect.intersects(this.intersectRect)){let a=this.minSize+this.gapPixels*2;switch(this.dragBar.direction){case"horizontal":e.rect.top<this.dragBar.y?t.top=Math.max(t.top,e.rect.top+a):e.rect.bottom>this.dragBar.y&&(t.bottom=Math.min(t.bottom,e.rect.bottom-a)),e.rect.bottom==this.dragBar.y?e.dragPosition="before":e.rect.top==this.dragBar.y&&(e.dragPosition="after");break;case"vertical":e.rect.left<this.dragBar.x?t.left=Math.max(t.left,e.rect.left+a):e.rect.right>this.dragBar.x&&(t.right=Math.min(t.right,e.rect.right-a)),e.rect.right==this.dragBar.x?e.dragPosition="before":e.rect.left==this.dragBar.x&&(e.dragPosition="after");break}}switch(this.intersectRect.x=t.x,this.intersectRect.y=t.y,this.intersectRect.width=t.width,this.intersectRect.height=t.height,this.dragBar.direction){case"horizontal":this.dragBarPosition=this.dragBar.y,this.intersectRect.top<this.intersectRect.bottom?this.dragger.setBounds(this.dragBar.x,this.intersectRect.top,this.dragBar.x,this.intersectRect.bottom):this.dragger.setBounds(this.dragBar.x,this.dragBar.y,this.dragBar.x,this.dragBar.y);break;case"vertical":this.dragBarPosition=this.dragBar.x,this.intersectRect.left<this.intersectRect.right?this.dragger.setBounds(this.intersectRect.left,this.dragBar.y,this.intersectRect.right,this.dragBar.y):this.dragger.setBounds(this.dragBar.x,this.dragBar.y,this.dragBar.x,this.dragBar.y);break}this.dragger.drag(this.dragBar)}};me.prototype.handleEdgeBarReleased=function(i){switch(document.removeEventListener(BeFunky.pointerup,this.handleEdgeBarReleasedBind),BFN.smoothPictureDisabled=!1,BFN.CursorScreen.cursorLock=!1,this.dragBar.direction){case"horizontal":this.dragBar.y!=this.dragBarPosition&&(BFN.CollageMakerHistoryModel.historyAction="layout_updated",this.getPhotoGridSnapShot());break;case"vertical":this.dragBar.x!=this.dragBarPosition&&(BFN.CollageMakerHistoryModel.historyAction="layout_updated",this.getPhotoGridSnapShot());break}};me.prototype.handleInsertChild=function(i){BFN.CollageMakerHistoryModel.historyAction="grid_cell_inserted";let e=i.dispatcher,{hoveredEdge:t}=e;this.attachedChildren.splice(0),this.attachedChildren.push(e);let r=new BFN.Rectangle(e.x,e.y,e.itemWidth,e.itemHeight);for(;;){let l=!1;for(let c=0;c<this._gridChildren.length;c++){let h=this._gridChildren[c];if(this.attachedChildren.indexOf(h)===-1)switch(this.dragBar.direction){case"vertical":(h.x==r.right||h.x+h.itemWidth==r.left)&&h.y==r.top&&h.y+h.itemHeight==r.bottom&&(r.left=Math.min(r.left,h.x),r.right=Math.max(r.right,h.x+h.itemWidth),this.attachedChildren.push(h),l=!0);break;case"horizontal":(h.y==r.bottom||h.y+h.itemHeight==r.top)&&h.x==r.left&&h.x+h.itemWidth==r.right&&(r.top=Math.min(r.top,h.y),r.bottom=Math.max(r.bottom,h.y+h.itemHeight),this.attachedChildren.push(h),l=!0);break}}if(!l)break}this._insertedGridChild=null;let a,s,o,n;switch(this.dragBar.direction){case"vertical":this.attachedChildren.sort((l,c)=>l.x-c.x),a=r.width/(this.attachedChildren.length+1),s=(r.width-a)/r.width,a=r.width;for(let l=0;l<this.attachedChildren.length;l++){let c=this.attachedChildren[l];c.transitionRect.width=Math.round(c.itemWidth*s),c.transitionRect.height=c.itemHeight,a-=c.transitionRect.width,c==i.dispatcher&&(o=t==="left"?l:l+1)}this._insertedGridChild=this.addGridChild(e.x+(t==="left"?0:e.itemWidth),r.y,0,r.height),this._insertedGridChild.content.flashItem(),this._insertedGridChild.content.selectItem(),this.attachedChildren.splice(o,0,this._insertedGridChild),n=r.x;for(let l=0;l<this.attachedChildren.length;l++){let c=this.attachedChildren[l];c==this._insertedGridChild?(c.transitionRect.width=a,c.transitionRect.height=c.itemHeight,c.transitionRect.x=n,c.transitionRect.y=c.y,this.transitionChildren.push(c),c.makeTransition(),n+=c.transitionRect.width):(c.transitionRect.x=n,c.transitionRect.y=c.y,this.transitionChildren.push(c),c.makeTransition(),n+=c.transitionRect.width)}break;case"horizontal":this.attachedChildren.sort((l,c)=>l.y-c.y),a=r.height/(this.attachedChildren.length+1),s=(r.height-a)/r.height,a=r.height;for(let l=0;l<this.attachedChildren.length;l++){let c=this.attachedChildren[l];c.transitionRect.width=c.itemWidth,c.transitionRect.height=Math.round(c.itemHeight*s),a-=c.transitionRect.height,c==i.dispatcher&&(o=t==="top"?l:l+1)}this._insertedGridChild=this.addGridChild(r.x,e.y+(t==="top"?0:e.itemHeight),r.width,0),this._insertedGridChild.content.flashItem(),this._insertedGridChild.content.selectItem(),this.attachedChildren.splice(o,0,this._insertedGridChild),n=r.y;for(let l=0;l<this.attachedChildren.length;l++){let c=this.attachedChildren[l];c==this._insertedGridChild?(c.transitionRect.width=c.itemWidth,c.transitionRect.height=a,c.transitionRect.x=c.x,c.transitionRect.y=n,this.transitionChildren.push(c),c.makeTransition(),n+=c.transitionRect.height):(c.transitionRect.x=c.x,c.transitionRect.y=n,this.transitionChildren.push(c),c.makeTransition(),n+=c.transitionRect.height)}break}this.dragBar.animator.setAnimatorFactor(0)};me.prototype.handleSelectChild=function(i){this._selectedChild=i.dispatcher,this._selectedChild.content.directSelect&&(this._selectedChild.content.isEmpty?(this.contextMenu.showButton("add_image"),this.contextMenu.hideButton("edit_image"),this.contextMenu.hideButton("remove_image")):(this.contextMenu.hideButton("add_image"),this.contextMenu.showButton("edit_image"),this.contextMenu.showButton("remove_image")),this._gridChildren.length>1?this.contextMenu.showButton("delete_cell"):this.contextMenu.hideButton("delete_cell"),this.contextMenu.enabled=!0)};me.prototype.handleDragChild=function(i){this._draggedChild=i.dispatcher,BFN.DragScreen.show(this._draggedChild.menuImageVO.thumbURL),this.awaitingDrop=!0,document.addEventListener(BeFunky.pointerup,this.handleDropChildBind),BFN.SentryManager.reportBreadcrumb(BFN.SentryManager.getDisplayObjectInfo(this._draggedChild),"drag_grid_child_image")};me.prototype.handleDropChild=function(i){if(this.awaitingDrop=!1,document.removeEventListener(BeFunky.pointerup,this.handleDropChildBind),this._focusedChild){if(this._draggedChild&&this._draggedChild==this._focusedChild&&!this._draggedChild.hoveredEdge){this.draggedChild=null;return}if(this._focusedChild.handleDrop(),this._selectedChild&&this._draggedChild){BFN.CollageMakerHistoryModel.ignoreSnapshot=!0;let e=this._draggedChild.content.image.frameSprite.rotate,{menuImageVO:t}=this._draggedChild;if(this._selectedChild.content.isEmpty)this._draggedChild.menuImageVO=null,this._draggedChild.content.setImage(null);else{let r=this._selectedChild.content.image.frameSprite.rotate;this._draggedChild.menuImageVO=this._selectedChild.menuImageVO,this._draggedChild.content.setImage(this._selectedChild.content.image.texture,!0,!1,r),this._draggedChild.content.image.frameSprite.rotate=r}BFN.CollageMakerHistoryModel.ignoreSnapshot=!1,this._selectedChild.menuImageVO=t,this._selectedChild.content.setImage(t.imageTexture,!0,!1,e)}}this.draggedChild=null,this.selectedChild=null};me.prototype.handleDeleteChild=function(i){if(this._gridChildren.length>1){BFN.CollageMakerHistoryModel.historyAction="grid_cell_deleted";let e=i.dispatcher,t=new BFN.Rectangle(0,e.y,this._itemWidth,e.itemHeight),r=new BFN.Rectangle(e.x,0,e.itemWidth,this._itemHeight),a=[],s=[],o,n,l,c,h;for(o=0;o<this._gridChildren.length;o++)l=this._gridChildren[o],this.updateRect(l),l!=e&&(t.intersects(l.rect)&&a.push(l),r.intersects(l.rect)&&s.push(l));let u=!1,d=!1;for(o=a.length;--o>-1;)l=a[o],l.rect.top<t.top||l.rect.bottom>t.bottom?l.rect.right<=e.rect.left?t.left=Math.max(t.left,l.rect.right):l.rect.left>=e.rect.right&&(t.right=Math.min(t.right,l.rect.left)):l.rect.right==e.rect.left?u=!0:l.rect.left==e.rect.right&&(d=!0);let m=!1,p=!1;for(o=s.length;--o>-1;)l=s[o],l.rect.left<r.left||l.rect.right>r.right?l.rect.bottom<=e.rect.top?r.top=Math.max(r.top,l.rect.bottom):l.rect.top>=e.rect.bottom&&(r.bottom=Math.min(r.bottom,l.rect.top)):l.rect.bottom==e.rect.top?m=!0:l.rect.top==e.rect.bottom&&(p=!0);for(t.left=u?t.left:e.rect.left,t.right=d?t.right:e.rect.right,r.top=m?r.top:e.rect.top,r.bottom=p?r.bottom:e.rect.bottom,a.splice(0),s.splice(0),o=0;o<this._gridChildren.length;o++)l=this._gridChildren[o],l!=e&&!l.rect.intersects(e.rect)&&(t.intersects(l.rect)&&a.push(l),r.intersects(l.rect)&&s.push(l));let g=null,f,v,T;if(a.sort((x,B)=>x.x-B.x),s.sort((x,B)=>x.y-B.y),a.length&&s.length?g=Math.random()<.5?a:s:a.length?g=a:s.length&&(g=s),g&&g.length&&!e.content.cleanDelete){for(this.positions.splice(0),o=0;o<g.length;o++)if(l=g[o],!l.rect.intersects(e.rect)){if(g==a){if(f=Math.round(e.x+e.itemWidth/2),v=t.width/(t.width-e.itemWidth),T=l.x,T>f&&(T-=e.itemWidth),l.transitionRect.x=Math.round((T-t.left)*v)+t.left,l.transitionRect.y=l.y,l.transitionRect.width=Math.round(l.itemWidth*v),l.transitionRect.height=l.itemHeight,this.positions.indexOf(l.transitionRect.x)===-1||this.positions.indexOf(l.transitionRect.x+l.transitionRect.width)===-1)for(n=0;n<this.positions.length;n++)h=this.positions[n],c=h-l.transitionRect.x,Math.abs(c)==1&&(console.log("ADJUST HORIZONTAL POSITION"),l.transitionRect.x+=c,l.transitionRect.width-=c);this.positions.indexOf(l.transitionRect.x)===-1&&this.positions.push(l.transitionRect.x),this.positions.indexOf(l.transitionRect.x+l.transitionRect.width)===-1&&this.positions.push(l.transitionRect.x+l.transitionRect.width),this.transitionChildren.push(l),l.makeTransition()}else if(g==s){if(f=Math.round(e.y+e.itemHeight/2),v=r.height/(r.height-e.itemHeight),T=l.y,T>f&&(T-=e.itemHeight),l.transitionRect.x=Math.max(0,l.x),l.transitionRect.y=Math.max(0,Math.round((T-r.top)*v)+r.top),l.transitionRect.width=Math.min(l.itemWidth,this._itemWidth-l.transitionRect.x),l.transitionRect.height=Math.min(Math.round(l.itemHeight*v),this._itemHeight-l.transitionRect.y),this.positions.indexOf(l.transitionRect.y)===-1||this.positions.indexOf(l.transitionRect.y+l.transitionRect.height)===-1)for(n=0;n<this.positions.length;n++)h=this.positions[n],c=h-l.transitionRect.y,Math.abs(c)==1&&(console.log("ADJUST VERTICAL POSITION"),l.transitionRect.y+=c,l.transitionRect.height-=c);this.positions.indexOf(l.transitionRect.y)===-1&&this.positions.push(l.transitionRect.y),this.positions.indexOf(l.transitionRect.y+l.transitionRect.height)===-1&&this.positions.push(l.transitionRect.y+l.transitionRect.height),this.transitionChildren.push(l),l.makeTransition()}}this.positions.splice(0)}this.removeGridChild(e),this.transitionChildren.length||this.handleChildTransitionCompleteTimeout()}};me.prototype.handleChildImageUpdated=function(i){this._insertedGridChild||(BFN.CollageMakerHistoryModel.historyAction="image_updated",this.getPhotoGridSnapShot())};me.prototype.handleChildImagePositionUpdated=function(i){BFN.CollageMakerHistoryModel.historyAction="image_position_updated",BFN.CollageMakerHistoryModel.focusedGridChild=i.dispatcher,this.getPhotoGridSnapShot(),BFN.CollageMakerHistoryModel.focusedGridChild=null};me.prototype.handleChildTransitionComplete=function(i){let e=i.dispatcher;this.updateFactorRect(e),this.transitionChildren.indexOf(e)!==-1&&(this.transitionChildren.splice(this.transitionChildren.indexOf(e),1),this.transitionChildren.length||setTimeout(this.handleChildTransitionCompleteTimeout.bind(this),10))};me.prototype.handleChildTransitionCompleteTimeout=function(i){if(this._insertedGridChild&&(this._insertedGridChild.content.imageEnabled=!1),this.getPhotoGridSnapShot(),this._insertedGridChild&&(this._insertedGridChild.content.imageEnabled=!0),this._insertedGridChild){let e=this._insertedGridChild.content.isEmpty;this._insertedGridChild=null,e||this.handleChildImageUpdated(null)}};me.prototype.startTouchDragHoverDetection=function(){this.detectingTouchDragHovers||(this.detectingTouchDragHovers=!0,this.gridChildren.forEach(i=>{i.updateGlobalBounds()}),this.unhoverHoveredItem(),this.detectHoversManuallyBind(BeFunky.globalPointerEvent),document.addEventListener(BeFunky.pointermove,this.detectHoversManuallyBind,!0),document.addEventListener(BeFunky.pointerup,this.stopTouchDragHoverDetectionBind,!0))};me.prototype.stopTouchDragHoverDetection=function(){!this.detectingTouchDragHovers||(this.detectingTouchDragHovers=!1,setTimeout(()=>{this.unhoverHoveredItem()},0),document.removeEventListener(BeFunky.pointermove,this.detectHoversManuallyBind,!0),document.removeEventListener(BeFunky.pointerup,this.stopTouchDragHoverDetectionBind,!0))};me.prototype.unhoverHoveredItem=function(){if(this.hoveredItem)switch(this.hoveredItemType){case"content":this.hoveredItem.content.handleMouseOutBind();break;case"edge":let e=this.hoveredItem;e.handleMouseOutBind(),e.gridChild.handleEdgeBarOutBind();break}this.handleChildMouseOutBind(),this.hoveredItem=null,this.hoveredItemType=null};me.prototype.detectHoversManually=function(i){if(BFN.TransformTouchDragManager.detectHoversManuallyBind(i),BFN.TransformTouchDragManager.hoveredItem){this.hoveredItem&&this.unhoverHoveredItem();return}let e=(o,n=null)=>{if(o!=this.hoveredItem&&(this.unhoverHoveredItem(),this.hoveredItem=o,this.hoveredItemType=n,this.hoveredItem&&this.hoveredItemType))switch(this.hoveredItemType){case"content":this.hoveredItem.content.handleMouseOverBind(),this.handleChildMouseOverBind({currentTarget:this.hoveredItem});break;case"edge":let c=this.hoveredItem;c.handleMouseOverBind(),c.gridChild.handleEdgeBarOverBind({currentTarget:c,data:{originalEvent:i}}),this.handleChildMouseOverBind({currentTarget:c.gridChild});break}},t=BeFunky.globalPointerCoords.x,r=BeFunky.globalPointerCoords.y-BFN.appRect.top,a=null,s=null;this.gridChildren.forEach(o=>{if(o.globalRect.contains(t,r)){let n=null;for(let l in o.edgeBars){let c=o.edgeBars[l];c.containsGlobalPoint(t,r)&&(n=c)}n?(a=n,s="edge"):(a=o,s="content")}}),e(a,s)};Object.defineProperty(me.prototype,"isEmpty",{get(){let i=!0;for(let e=0;e<this._gridChildren.length;e++)if(!this._gridChildren[e].content.isEmpty){i=!1;break}return i}});Object.defineProperty(me.prototype,"gridChildIsolated",{get(){return this._gridChildIsolated}});Object.defineProperty(me.prototype,"scale",{set(i){this._scale=i;for(let e=0;e<this._gridChildren.length;e++){let t=this._gridChildren[e];t.scale=this._scale}this.dragBar.scale=this._scale,this.edgeIndicators.left.scale=this._scale,this.edgeIndicators.top.scale=this._scale,this.edgeIndicators.right.scale=this._scale,this.edgeIndicators.bottom.scale=this._scale,this.dragger.scale=this._scale},get(){return this._scale}});Object.defineProperty(me.prototype,"backgroundColor",{set(i){if(this._backgroundColor=i,this.childBackgroundColor="000000",this.childBorderColor="000000",this._backgroundColor===-1)this.childBackgroundColor="FFFFFF",this.childBorderColor="000000";else{let e=parseInt(`0x${this._backgroundColor}`),t=BFN.Util.hex2hsv(e),r=t.v,a=t.v;t.v>.65?(r-=t.v*.3,a-=t.v*.4):(r+=(1-t.v)*.3,a+=(1-t.v)*.4),t.v=r,this.childBackgroundColor=BFN.Util.hsv2rgb(t).hex.split("#").join(""),t.v=a,this.childBorderColor=BFN.Util.hsv2rgb(t).hex.split("#").join("")}for(let e=0;e<this._gridChildren.length;e++){let t=this._gridChildren[e];t.backgroundColor=this.childBackgroundColor,t.borderColor=this.childBorderColor}},get(){return this._backgroundColor}});Object.defineProperty(me.prototype,"gap",{set(i){this._gap=i,this.updateGaps()},get(){return this._gap}});Object.defineProperty(me.prototype,"gapPixels",{get(){return Math.round(this._gap*this.maxGap/2)}});Object.defineProperty(me.prototype,"rounding",{set(i){this._rounding=i,this.updateRounding()},get(){return this._rounding}});Object.defineProperty(me.prototype,"gridChildren",{get(){return this._gridChildren}});Object.defineProperty(me.prototype,"focusedChild",{get(){return this._focusedChild}});Object.defineProperty(me.prototype,"targetChild",{set(i){this._targetChild=i},get(){return this._targetChild}});Object.defineProperty(me.prototype,"randomEmptyChild",{get(){let i=null,e=[];for(let t=0;t<this.gridChildren.length;t++){let r=this.gridChildren[t];r.content.isEmpty&&e.push(r)}return e.length&&(i=e[Math.floor(Math.random()*e.length)]),e.splice(0),i}});Object.defineProperty(me.prototype,"selectedChild",{set(i){this._selectedChild=i},get(){return this._selectedChild}});Object.defineProperty(me.prototype,"draggedChild",{set(i){this._draggedChild=i},get(){return this._draggedChild}});Object.defineProperty(me.prototype,"awaitingDrop",{set(i){this._awaitingDrop!=i&&(i?BeFunky.globalPointerEvent.pointerType==="touch"&&this.startTouchDragHoverDetection():this.stopTouchDragHoverDetection()),this._awaitingDrop=i;for(let e=0;e<this._gridChildren.length;e++){let t=this._gridChildren[e];t.awaitingDrop=this._awaitingDrop}},get(){return this._awaitingDrop}});Object.defineProperty(me.prototype,"matchesTemplate",{set(i){this._matchesTemplate=i},get(){return this._matchesTemplate}});Object.defineProperty(me.prototype,"itemWidth",{set(i){this._itemWidth=i,this.setSize(this._itemWidth,this._itemHeight)},get(){return this._itemWidth}});Object.defineProperty(me.prototype,"itemHeight",{set(i){this._itemHeight=i,this.setSize(this._itemWidth,this._itemHeight)},get(){return this._itemHeight}});BFN.SingletonQueue.add(()=>{BFN.PhotoGrid=new me});BFN.CollageMakerCanvasPhotoGridEvents={RESIZING:new Event("RESIZING"),RESIZING_COMPLETE:new Event("RESIZING_COMPLETE")};function Re(){PIXI.Container.call(this),BFN.EventDispatcher.call(this),this.init()}Re.prototype=window.azrc.extend(Object.create(PIXI.Container.prototype),Object.create(BFN.EventDispatcher.prototype));Re.prototype.init=function(){BeFunky.log("CollageMakerCanvasPhotoGrid Init"),this.initDefaultValues(),this.initPhotoGridContainer(),this.initPatternBackground(),this.initPhotoGrid()};Re.prototype.initDefaultValues=function(){this.interactive=!0,this._canvasScale=1,this._gridWidth=1,this._gridHeight=1,this.longestSide=Math.max(this._gridWidth,this._gridHeight),this.adjustmentScaleFactor=1,this.currentAspectRatio=1,this.originalAspectRatio=1,this.aspectRatios=BFN.CropRatioMap,this.manualGridResize=!1,this.lastTemplate=null,this.customizePending=!1,this.handleMainUIPreRenderBind=this.handleMainUIPreRender.bind(this),this.targetGridChildren=[],this.gridImageIDs=[],this.autoFillMenuImageVOIndex=0,this.autoFillMenuImageVOs=null,this.updateCurrentTransition=!1,this.transitionVO=null,this.transitionUpdating=!1,this.uniqueTransitionTags=["background_color","background_pattern"],this.pendingAutoCollageBaseTextures=[],window.addEventListener("INIT_COMPLETE",()=>{UITools.updateParamObject("collage_customize_width",{max:BFN.maxImageSize}),UITools.updateParamObject("collage_customize_height",{max:BFN.maxImageSize})}),BFN.CollageMakerTemplateModel.addEventListener(BFN.CollageMakerTemplateModelEvents.CURRENT_TEMPLATE_UPDATED.type,this.handleCurrentTemplateUpdated.bind(this)),BFN.CollageMakerTemplateModel.addEventListener(BFN.CollageMakerTemplateModelEvents.FREEFORM.type,this.handleFreeformTemplate.bind(this)),BFN.CollageMakerHistoryModel.addEventListener(BFN.CollageMakerHistoryModelEvents.APPLY_CURRENT_SNAPSHOT.type,this.handleApplyCurrentSnapShot.bind(this)),BFN.CollageMakerCanvasPhotoGridModel.addEventListener(BFN.CollageMakerCanvasPhotoGridModelEvents.COLLAGE_SETTINGS_UPDATED.type,this.handleCollageSettingsUpdated.bind(this)),BFN.CollageMakerCanvasPhotoGridModel.addEventListener(BFN.CollageMakerCanvasPhotoGridModelEvents.CLEAR_ALL.type,this.handleClearAll.bind(this)),BFN.CollageMakerCanvasPhotoGridModel.addEventListener(BFN.CollageMakerCanvasPhotoGridModelEvents.AUTO_COLLAGE_LAYOUT_OBJECT.type,this.handleAutoCollageLayoutObject.bind(this))};Re.prototype.initPhotoGridContainer=function(){this.photoGridContainer=new PIXI.Container,this.addChild(this.photoGridContainer)};Re.prototype.initPatternBackground=function(){this.patternBackgroundTextureSourceSprite=new PIXI.Sprite,this.patternBackgroundTextureSourceSprite.pluginName="smooth_picture",this.patternBackgroundTextureSourceSprite.smoothing=!0,this.patternBackgroundTexture=PIXI.RenderTexture.create(32,32),this.patternBackgroundTexture.clear(),this.patternBackground=new BFN.TileContainer(this.patternBackgroundTexture,32,32),this.patternBackground.visible=!1,this.photoGridContainer.addChild(this.patternBackground)};Re.prototype.initPhotoGrid=function(){this.photoGrid=BFN.PhotoGrid,this.photoGrid.addEventListener(BFN.PhotoGridEvents.PHOTO_GRID_SNAP_SHOT.type,this.handlePhotoGridSnapShot.bind(this)),this.photoGridContainer.addChild(this.photoGrid)};Re.prototype.initInitialTemplate=function(){this.resetBackground(),BFN.CollageMakerTemplateModel.currentTemplate=BFN.CollageMakerTemplateData.templateCategoryVOs[0].templateVOs[0]};Re.prototype.handleCustomize=function(){this.customizePending||(this.customizePending=!0,BFN.MainUI.addEventListener(BFN.MainUIEvents.PRE_RENDER.type,this.handleMainUIPreRenderBind)),BFN.MainUI.requestRender()};Re.prototype.handleMainUIPreRender=function(){if(this.customizePending){this.customizePending=!1,BFN.MainUI.removeEventListener(BFN.MainUIEvents.PRE_RENDER.type,this.handleMainUIPreRenderBind);let i=UITools.getToolVO("collage_customize");switch(i.updating_id){case"rotate_ccw":case"rotate_cw":case"flip_h":case"flip_v":{this.reorientLayout(i.updating_id);return}case"lock_aspect_ratio":{i.lock_aspect_ratio||this.setFreeformAspectRatio(i);return}case"aspect_ratio":{if(this.aspectRatios.hasOwnProperty(i.aspect_ratio)){let a=i.aspect_ratio==="freeform";if(!!i.lock_aspect_ratio===a&&(i.lock_aspect_ratio=!a,UITools.updateToolControl("collage_customize_lock_aspect_ratio")),a)return;let s=this.aspectRatios[i.aspect_ratio];s===-1?s=this.originalAspectRatio:(this.currentAspectRatio-1)*(s-1)<0&&(s=1/s);let o=s<=1?this.longestSide:Math.round(this.longestSide/s),n=s<=1?Math.round(this.longestSide*s):this.longestSide;if(o===this._gridWidth&&n===this._gridHeight)return;i.width=o,i.height=n,i.updating_id="width",this.currentAspectRatio=s}else{this.setFreeformAspectRatio(i);return}break}case"orientation":{if((this._gridHeight/this._gridWidth<=1?"landscape":"portrait")===i.orientation)return;let s=this._gridHeight,o=this._gridWidth;if(s===this._gridWidth&&o===this._gridHeight)return;i.width=s,i.height=o,i.updating_id="width",this.currentAspectRatio=o/s;break}}if(!this.transitionUpdating){this.transitionUpdating=!0;let a="settings";switch(i.updating_id){case"width":case"height":a="dimensions_changed";break;case"background_color":a=i.background_color==-1?"background_transparent":"background_color";break;case"spacing":a="spacing";break;case"corner_rounding":a="corner_rounding";break}this.createHistoryTransition(a)}BFN.CollageMakerCanvasBackground.color!=i.background_color&&(BFN.CollageMakerCanvasBackground.color=i.background_color),i.updating_id==="background_color"&&this.patternBackground.visible&&this.setPatternBackgroundTexture(null),this.photoGrid.backgroundColor!=BFN.CollageMakerCanvasBackground.color&&!this.patternBackground.visible&&(this.photoGrid.backgroundColor=BFN.CollageMakerCanvasBackground.color);let e=!1;i.updating_id==="spacing"&&this.photoGrid.gap!=i.spacing/100&&(this.photoGrid.gap=i.spacing/100,e=!0);let t=!1;i.updating_id==="corner_rounding"&&this.photoGrid.rounding!=i.corner_rounding/100&&(this.photoGrid.rounding=i.corner_rounding/100,t=!0);let r=!1;if(i.updating_id==="width"||i.updating_id==="height"){if(i.width!=this._gridWidth||i.height!=this._gridHeight){let{width:a}=i,{height:s}=i;if(this.manualGridResize)this.setFreeformAspectRatio(i);else{if(i.lock_aspect_ratio)switch(i.updating_id){case"width":s=Math.min(BFN.maxImageSize,Math.max(BFN.minCollageSize,Math.round(a*this.currentAspectRatio))),a=Math.round(s/this.currentAspectRatio);break;case"height":a=Math.min(BFN.maxImageSize,Math.max(BFN.minCollageSize,Math.round(s/this.currentAspectRatio))),s=Math.round(a*this.currentAspectRatio);break}UITools.setToolValue("collage_customize","width",a,i.updating),UITools.setToolValue("collage_customize","height",s,i.updating),UITools.updateToolControls("collage_customize"),this.longestSide=Math.max(a,s)}this._gridWidth=a,this._gridHeight=s;let o=this._gridHeight/this._gridWidth<=1?"landscape":"portrait";o!==i.orientation&&(i.orientation=o,UITools.updateToolControl("collage_customize_orientation")),this.updatePhotoGridDisplay(),this.updatePatternBackgroundDisplay()}i.updating?this.dispatchEvent(BFN.CollageMakerCanvasPhotoGridEvents.RESIZING):(this.adjustGridSizeToLongestSide(),this.updatePhotoGridDisplay(),this.updatePatternBackgroundDisplay(),r=!0,this.dispatchEvent(BFN.CollageMakerCanvasPhotoGridEvents.RESIZING_COMPLETE),this.adjustmentScaleFactor=1)}!r&&(e||t)&&this.updatePhotoGridDisplay(!1),!i.updating&&this.transitionUpdating&&(this.transitionUpdating=!1,this.registerHistoryTransition()),!i.updating&&this.manualGridResize&&(this.manualGridResize=!1)}};Re.prototype.handleCollageImage=function(){let i=UITools.getToolVO("collage_image");if(this.photoGrid.selectedChild&&this.photoGrid.selectedChild.content&&this.photoGrid.selectedChild.content.image)switch(i.updating_id){case"size":this.photoGrid.selectedChild.content.image.resize(i.size/100);break;case"rotate_clockwise":this.photoGrid.selectedChild.content.image.rotate("right");break;case"rotate_counter_clockwise":this.photoGrid.selectedChild.content.image.rotate("left");break;case"flip_horizontal":this.photoGrid.selectedChild.content.image.flip("horizontal");break;case"flip_vertical":this.photoGrid.selectedChild.content.image.flip("vertical");break;case"open_in_editor":if(!BFN.BfnService.userIsPlus){BFN.BfnService.upgrade("COLLAGE","EDIT_IMAGE_UPGRADE"),BFN.UserActionManager.addUpgradeAction(["Open Grid Image in Editor"]);return}let e=this.photoGrid.selectedChild;this.photoGrid.isolateGridChild(null,!0);try{BFN.BfnService.track("CREATE","COLLAGE","OPEN_IMAGE_EDITOR")}catch(t){}BFN.PhotoEditorModel.currentTexture&&BFN.IndexedDB.disabledReason?BeFunky.confirm("confirm_edit_image",{onConfirm:()=>{BFN.ImageEditManager.openGridCellInEditor(e)},onCancel:()=>{this.photoGrid.selectedChild=e,this.photoGrid.isolateGridChild(e)},focusConfirmButton:!1}):BFN.ImageEditManager.openGridCellInEditor(e);break}BFN.MainUI.requestRender()};Re.prototype.autoFill=function(i){if(i&&i.length){if(!this.autoFillMenuImageVOs){this.autoFillMenuImageVOs=[];for(let e=0;e<i.length;e++)this.autoFillMenuImageVOs.push(i[e])}if(BFN.CollageMakerCanvasPhotoGridModel.freeform)this.autoFillMenuImageVOs.shuffle(),this.autoFillMenuImageVOs.length>3&&this.autoFillMenuImageVOs.splice(3),BFN.BfnService.getTexturesForMenuImageVOs(this.autoFillMenuImageVOs).then(this.processAutoFillMenuImageVOs.bind(this));else{this.targetGridChildren.splice(0),this.gridImageIDs.splice(0);for(let e=0;e<this.photoGrid.gridChildren.length;e++){let t=this.photoGrid.gridChildren[e];t.content.isEmpty?this.targetGridChildren.push(t):this.gridImageIDs.indexOf(t.menuImageVO.id)==-1&&this.gridImageIDs.push(t.menuImageVO.id)}if(this.targetGridChildren.shuffle(),this.targetGridChildren.length){let e=this.autoFillMenuImageVOs.length;for(;--e>-1&&this.autoFillMenuImageVOs.length>this.targetGridChildren.length;){let t=this.autoFillMenuImageVOs[e];this.gridImageIDs.includes(t.id)&&this.autoFillMenuImageVOs.splice(e,1)}this.autoFillMenuImageVOs.length>this.targetGridChildren.length&&this.autoFillMenuImageVOs.splice(this.targetGridChildren.length),this.autoFillMenuImageVOIndex=0,BFN.BfnService.getTexturesForMenuImageVOs(this.autoFillMenuImageVOs).then(this.processAutoFillMenuImageVOs.bind(this))}else this.autoFillMenuImageVOs.splice(0),this.autoFillMenuImageVOs=null}}};Re.prototype.processAutoFillMenuImageVOs=function(){if(this.autoFillMenuImageVOs&&this.autoFillMenuImageVOs.length)if(BFN.CollageMakerCanvasPhotoGridModel.freeform){for(let i=0;i<this.autoFillMenuImageVOs.length;i++){let e=this.autoFillMenuImageVOs[i],t=Math.round(this._gridWidth/2*Math.random())-this._gridWidth/4,r=Math.round(this._gridHeight/2*Math.random())-this._gridHeight/4;BFN.CollageMakerCanvasModel.addedItem={type:"texture",texture:e.imageTexture,initialCenterPosition:new PIXI.Point(t,r),projectItemAssetID:e.id},BFN.ProjectService.saveLocalAssetForMenuImageVO(e,"collage").catch(a=>{BeFunky.logError("Failed to store Blob for MenuImageVO",a,e)})}BFN.TransformModel.selectedTransformItem&&BFN.TransformModel.selectedTransformItem.deselectItem()}else{if(BFN.CollageMakerHistoryModel.historyAction!=="auto_fill"&&(BFN.CollageMakerHistoryModel.ignoreSnapshot=!0,BFN.CollageMakerHistoryModel.historyAction="auto_fill"),this.targetGridChildren.length){BFN.PhotoGrid.targetChild=this.targetGridChildren.shift();let i;for(;i=this.autoFillMenuImageVOs[this.autoFillMenuImageVOIndex],this.autoFillMenuImageVOIndex=(this.autoFillMenuImageVOIndex+1)%this.autoFillMenuImageVOs.length,this.gridImageIDs.length;){if(this.gridImageIDs.indexOf(i.id)===-1)break;if(!this.autoFillMenuImageVOIndex){this.gridImageIDs.splice(0);break}}this.autoFillMenuImageVOIndex||this.autoFillMenuImageVOs.shuffle(),i&&BFN.ImageLibraryManager.addImageToCanvas(i,{hasTexture:!0});return}BFN.CollageMakerHistoryModel.historyAction==="auto_fill"&&(BFN.CollageMakerHistoryModel.ignoreSnapshot=!1,this.photoGrid.getPhotoGridSnapShot(),BFN.CollageMakerHistoryModel.historyAction=null)}this.autoFillMenuImageVOs=null};Re.prototype.assignImageToTargetGridChild=function(i){this.photoGrid.targetChild&&this.photoGrid.targetChild.content!=null&&(BFN.TransformStateModel.safeBaseTextures.includes(i.imageTexture.baseTexture)||BFN.TransformStateModel.safeBaseTextures.push(i.imageTexture.baseTexture),this.photoGrid.targetChild.menuImageVO=i,this.photoGrid.targetChild.content.setImage(i.imageTexture),this.photoGrid.targetChild=null,BFN.TransformStateModel.safeBaseTextures.splice(0)),this.processAutoFillMenuImageVOs()};Re.prototype.preparePhotoGrid=function(i,e,t,r){this.photoGrid.removeAllGridChildren(),this.photoGrid.setSize(i,e),this.photoGrid.gap=t,this.photoGrid.rounding=r};Re.prototype.updatePhotoGridDisplay=function(i=!0){this.currentAspectRatio=this._gridHeight/this.gridWidth,this.photoGridContainer.x=-(this._gridWidth/2),this.photoGridContainer.y=-(this._gridHeight/2),this.photoGrid.setMaxGapFromDimensions(this._gridWidth,this._gridHeight),this.photoGrid.x=this.photoGrid.gapPixels,this.photoGrid.y=this.photoGrid.gapPixels,this.photoGrid.setSize(this._gridWidth-this.photoGrid.gapPixels*2,this._gridHeight-this.photoGrid.gapPixels*2),i&&BFN.CollageMakerCanvasPhotoGridModel.dispatchEvent(BFN.CollageMakerCanvasPhotoGridModelEvents.GRID_SIZE_CHANGED)};Re.prototype.adjustGridSizeToLongestSide=function(){this.adjustmentScaleFactor=Math.min(this.longestSide/Math.round(this._gridWidth),this.longestSide/Math.round(this._gridHeight)),this._gridWidth=Math.max(BFN.minCollageSize,Math.round(this._gridWidth*this.adjustmentScaleFactor)),this._gridHeight=Math.max(BFN.minCollageSize,Math.round(this._gridHeight*this.adjustmentScaleFactor)),this.updateToolVO(this._gridWidth,this._gridHeight)};Re.prototype.setPatternBackgroundTexture=function(i){this.patternBackground.visible=!1;try{this.patternBackgroundTextureSourceSprite.texture.destroy(!1)}catch(e){}this.patternBackgroundTextureSourceSprite.texture=PIXI.Texture.EMPTY,BFN.CollageMakerCanvasPhotoGridModel.backgroundPatternTexture=i?new PIXI.Texture(i.baseTexture):null,i&&(i.baseTexture.hasOwnProperty("averageColor")&&(this.photoGrid.backgroundColor=i.baseTexture.averageColor.toString(16)),this.patternBackgroundTextureSourceSprite.texture=new PIXI.Texture(i.baseTexture),this.patternBackground.visible=!0),this.updatePatternBackgroundDisplay()};Re.prototype.updatePatternBackgroundDisplay=function(){if(this.patternBackground.visible){let i=Math.max(this._gridWidth/this.patternBackgroundTextureSourceSprite.texture.width,this._gridHeight/this.patternBackgroundTextureSourceSprite.texture.height)/2,e=Math.round(this.patternBackgroundTextureSourceSprite.texture.baseTexture.width*i),t=Math.round(this.patternBackgroundTextureSourceSprite.texture.baseTexture.height*i);this.patternBackgroundTextureSourceSprite.scale.x=this.patternBackgroundTextureSourceSprite.scale.y=this.patternBackgroundTextureSourceSprite.currentScale=i,this.patternBackgroundTexture.resize(e,t),BFN.Stage.render(this.patternBackgroundTextureSourceSprite,this.patternBackgroundTexture),this.patternBackground.width=this._gridWidth,this.patternBackground.height=this._gridHeight,this.patternBackground.updateDisplay()}else this.patternBackgroundTexture.clear(),this.patternBackgroundTexture.resize(32,32),this.patternBackground.width=32,this.patternBackground.height=32,this.patternBackground.updateDisplay()};Re.prototype.resetBackground=function(i){BFN.CollageMakerCanvasBackground.color="FFFFFF",this.setPatternBackgroundTexture(null),this.photoGrid.backgroundColor=BFN.CollageMakerCanvasBackground.color};Re.prototype.reorientLayout=function(i){if(BFN.CollageMakerCanvasPhotoGridModel.freeform||!["flip_h","flip_v","rotate_cw","rotate_ccw"].includes(i))return;let e=(r,a,s)=>{let o=r[a];r[a]=r[s],r[s]=o};this.photoGrid.repair();let t=new BFN.PhotoGridSnapshotVO;t.historyAction=["flip_h","flip_v"].includes(i)?"layout_flipped":"layout_rotated",t.snapshotWidth=this._gridWidth,t.snapshotHeight=this._gridHeight,t.gridWidth=this.photoGrid.itemWidth,t.gridHeight=this.photoGrid.itemHeight,t.rounding=this.photoGrid.rounding,t.gap=this.photoGrid.gap,t.backgroundColor=BFN.CollageMakerCanvasBackground.color,t.backgroundPatternBaseTexture=this.patternBackground.visible?this.patternBackgroundTextureSourceSprite.texture.baseTexture:null,this.photoGrid.gridChildren.forEach(r=>{r.updateRect(),r.updateProjectItemVO();let a=new BFN.PhotoGridSnapshotChildVO;a.rect=r.rect.clone(),a.menuImageVO=r.menuImageVO,r.content.imageEnabled&&!r.content.isEmpty&&r.content.image.frameSprite.texture.valid&&(a.texture=new PIXI.Texture(r.content.image.frameSprite.texture.baseTexture),a.offsetFactorX=r.content.image.frameSprite.offsetFactorX,a.offsetFactorY=r.content.image.frameSprite.offsetFactorY,a.rotate=r.content.image.frameSprite.rotate,a.textureScale=r.content.image.frameSprite.textureScale);let{gridWidth:s,gridHeight:o}=t,{rect:n}=a;switch(i){case"flip_h":{n.x=s-n.x-n.width;break}case"flip_v":{n.y=o-n.y-n.height;break}case"rotate_cw":{let l=o-n.bottom,c=n.x;n.x=l,n.y=c,e(n,"width","height");break}case"rotate_ccw":{let l=n.y,c=s-n.right;n.x=l,n.y=c,e(n,"width","height");break}}t.snapshotChildren.push(a)}),t.historyAction==="layout_rotated"&&(e(t,"snapshotWidth","snapshotHeight"),e(t,"gridWidth","gridHeight")),this.applyPhotoGridSnapshot(t),BFN.CollageMakerHistoryModel.historyAction=t.historyAction,BFN.PhotoGrid.getPhotoGridSnapShot(),BFN.CollageMakerHistoryModel.historyAction=null};Re.prototype.getScreenCapture=function(i=!0,e=0,t=null){let r=1,a=this._gridWidth,s=this._gridHeight;typeof t=="number"&&(t=Math.max(BFN.minImageSize,Math.min(BFN.maxImageSize,t)),r=t/Math.max(a,s),a=Math.round(a*r),s=Math.round(s*r));let o=PIXI.RenderTexture.create(a,s);return this.patternBackground.visible?(this.patternBackground.smoothScale=r,this.patternBackground.scale.x=this.patternBackground.scale.y=r,BFN.smoothPictureAction(()=>{BFN.Stage.render(this.patternBackground,o)}),this.patternBackground.smoothScale=this._canvasScale,this.patternBackground.scale.x=this.patternBackground.scale.y=1):BFN.CollageMakerCanvasBackground.color!=-1&&o.fillColor(parseInt(`0x${BFN.CollageMakerCanvasBackground.color}`)),BFN.CollageMakerCanvasPhotoGridModel.freeform||(this.photoGrid.childContainer.x=this.photoGrid.childContainer.y=this.photoGrid.gapPixels,this.photoGrid.setChildVeilVisibility(!1),this.photoGrid.toggleBorders(!1,e),this.photoGrid.toggleEmptyCells(i),this.photoGrid.scale=r,this.photoGridFlattenContainer||(this.photoGridFlattenContainer=new PIXI.Container),this.photoGridFlattenContainer.addChild(this.photoGrid.childContainer),this.photoGridFlattenContainer.scale.x=this.photoGridFlattenContainer.scale.y=r,BFN.smoothPictureAction(()=>{BFN.Stage.render(this.photoGridFlattenContainer,o,!1)}),this.photoGrid.gridContainer.addChildAt(this.photoGrid.childContainer,0),this.photoGrid.childContainer.x=this.photoGrid.childContainer.y=0,this.photoGrid.setChildVeilVisibility(!0),this.photoGrid.toggleBorders(!0),this.photoGrid.toggleEmptyCells(!0),this.photoGrid.scale=this._canvasScale),o};Re.prototype.updateToolVO=function(i=null,e=null,t=null,r=null,a=null,s=null,o=null,n=null,l=null){if(i!==null&&UITools.setToolValue("collage_customize","width",i),e!==null&&UITools.setToolValue("collage_customize","height",e),t!==null&&UITools.setToolValue("collage_customize","spacing",t),r!==null&&UITools.setToolValue("collage_customize","corner_rounding",r),a!==null&&UITools.setToolValue("collage_customize","background_color",a),s!==null&&UITools.setToolValue("collage_customize","lock_aspect_ratio",s),i!==null&&e!==null){let c=e/i<=1?"landscape":"portrait";UITools.setToolValue("collage_customize","orientation",c)}o!==null&&(BFN.secondaryMenu.spacingEnabled=Boolean(o),BFN.tertiaryMenu.spacingEnabled=Boolean(o)),n!==null&&(BFN.secondaryMenu.roundingEnabled=Boolean(n),BFN.tertiaryMenu.roundingEnabled=Boolean(n)),l!==null&&(BFN.secondaryMenu.collageReorientEnabled=Boolean(l),BFN.tertiaryMenu.collageReorientEnabled=Boolean(l)),UITools.updateToolControls("collage_customize")};Re.prototype.updateOriginalAspectRatio=function(){this.originalAspectRatio=this._gridHeight/this.gridWidth};Re.prototype.setFreeformAspectRatio=function(i=null){let e=i||UITools.getToolVO("collage_customize");e.aspect_ratio!=="freeform"&&(e.aspect_ratio="freeform",UITools.updateToolControl("collage_customize_aspect_ratio"))};Re.prototype.updateSettings=function(i){let e=UITools.getToolVO("collage_customize");this.photoGrid.contextMenu.hide(),this.photoGrid.gap=e.spacing/100,this.photoGrid.rounding=e.corner_rounding/100,this._gridWidth=e.width,this._gridHeight=e.height,this.longestSide=Math.max(this._gridWidth,this._gridHeight),BFN.CollageMakerCanvasBackground.color=e.background_color,this.updatePhotoGridDisplay(),this.updatePatternBackgroundDisplay(),BFN.ZoomManager.updateZoomRange(),BFN.CollageMakerCanvas.fitCollageToFrame(),BFN.CollageMakerModel.updateProjectVO()};Re.prototype.createPhotoGridSnapshot=function(){if(!BFN.CollageMakerHistoryModel.ignoreSnapshot){this.photoGrid.repair();let i=new BFN.PhotoGridSnapshotVO;if(i.historyAction=BFN.CollageMakerHistoryModel.historyAction,i.snapshotWidth=this._gridWidth,i.snapshotHeight=this._gridHeight,i.gridWidth=this.photoGrid.itemWidth,i.gridHeight=this.photoGrid.itemHeight,i.rounding=this.photoGrid.rounding,i.gap=this.photoGrid.gap,i.backgroundColor=BFN.CollageMakerCanvasBackground.color,i.backgroundPatternBaseTexture=this.patternBackground.visible?this.patternBackgroundTextureSourceSprite.texture.baseTexture:null,!BeFunky.isSmartphone){let e=Math.min(BFN.GlobalHistoryModel.globalHistoryMenuPreviewSize,Math.max(this._gridWidth,this._gridHeight)),t=2/BFN.GlobalHistoryModel.globalHistoryMenuPreviewSize*e;i.previewTexture=this.getScreenCapture(!0,t,e),i.thumbTexture=BFN.Util.getThumbTexture(i.previewTexture,BFN.GlobalHistoryModel.globalHistoryMenuThumbSize,!0,!1)}if(!BFN.CollageMakerCanvasPhotoGridModel.freeform)for(let e=0;e<this.photoGrid.gridChildren.length;e++){let t=this.photoGrid.gridChildren[e];t.updateRect(),t.updateProjectItemVO();let r=new BFN.PhotoGridSnapshotChildVO;r.rect=t.rect.clone(),r.menuImageVO=t.menuImageVO,t.content.imageEnabled&&!t.content.isEmpty&&t.content.image.frameSprite.texture.valid&&(r.texture=new PIXI.Texture(t.content.image.frameSprite.texture.baseTexture),r.offsetFactorX=t.content.image.frameSprite.offsetFactorX,r.offsetFactorY=t.content.image.frameSprite.offsetFactorY,r.rotate=t.content.image.frameSprite.rotate,r.textureScale=t.content.image.frameSprite.textureScale),i.snapshotChildren.push(r)}BFN.CollageMakerHistoryModel.addPhotoGridSnapshotToHistory(i),BFN.CollageMakerModel.updateProjectVO()}};Re.prototype.createHistoryTransition=function(i){if(this.updateCurrentTransition=!1,this.transitionVO){if(this.uniqueTransitionTags.indexOf(i)==-1&&this.transitionVO.id==i&&this.transitionVO==BFN.TransformStateModel.currentTransition&&this.transitionVO.timestamp==BFN.UndoManager.getTimestamp()){this.updateCurrentTransition=!0;return}this.transitionVO=null}this.transitionVO||(this.transitionVO=new BFN.TransformItemTransitionVO,this.transitionVO.id=i,this.transitionVO.alternateHistoryAction="collage_settings_updated",this.transitionVO.startState.collageSettings.background_color=BFN.CollageMakerCanvasBackground.color,this.transitionVO.startState.collageSettings.spacing=this.photoGrid.gap*100,this.transitionVO.startState.collageSettings.corner_rounding=this.photoGrid.rounding*100,this.transitionVO.startState.collageSettings.width=this._gridWidth,this.transitionVO.startState.collageSettings.height=this._gridHeight,this.transitionVO.startState.collageSettings.backgroundPatternBaseTexture=this.patternBackground.visible?this.patternBackgroundTextureSourceSprite.texture.baseTexture:null)};Re.prototype.registerHistoryTransition=function(){this.photoGrid.repair();let i=this.updateCurrentTransition&&this.transitionVO&&this.transitionVO==BFN.TransformStateModel.currentTransition&&this.transitionVO.timestamp==BFN.UndoManager.getTimestamp();if(this.transitionVO.previewTexture&&this.transitionVO.previewTexture.destroyGC(!0),this.transitionVO.previewImage=null,this.transitionVO.thumbTexture&&this.transitionVO.thumbTexture.destroyGC(!0),this.transitionVO.thumbImage=null,!BeFunky.isSmartphone){let e=Math.min(BFN.GlobalHistoryModel.globalHistoryMenuPreviewSize,Math.max(this._gridWidth,this._gridHeight)),t=2/BFN.GlobalHistoryModel.globalHistoryMenuPreviewSize*e;try{this.transitionVO.previewTexture=this.getScreenCapture(!0,t,e),this.transitionVO.thumbTexture=BFN.Util.getThumbTexture(this.transitionVO.previewTexture,BFN.GlobalHistoryModel.globalHistoryMenuThumbSize,!0,!1)}catch(r){this.transitionVO.previewTexture=null,this.transitionVO.thumbTexture=null}}this.transitionVO.endState.collageSettings.background_color=BFN.CollageMakerCanvasBackground.color,this.transitionVO.endState.collageSettings.spacing=this.photoGrid.gap*100,this.transitionVO.endState.collageSettings.corner_rounding=this.photoGrid.rounding*100,this.transitionVO.endState.collageSettings.width=this._gridWidth,this.transitionVO.endState.collageSettings.height=this._gridHeight,this.transitionVO.endState.collageSettings.backgroundPatternBaseTexture=this.patternBackground.visible?this.patternBackgroundTextureSourceSprite.texture.baseTexture:null,i?BFN.TransformStateModel.dispatchEvent(BFN.TransformStateModelEvents.TRANSITIONS_UPDATED):BFN.TransformStateModel.addTransition(this.transitionVO),BFN.CollageMakerModel.updateProjectVO()};Re.prototype.applyCurrentTemplate=function(){BFN.CollageMakerCanvasPhotoGridModel.freeform&&BFN.CollageMakerCanvasModel.dispatchEvent(BFN.CollageMakerCanvasModelEvents.CLEAR_ITEMS),BFN.CollageMakerCanvasPhotoGridModel.freeform=!1;let i=this.lastTemplate=BFN.CollageMakerTemplateModel.currentTemplate,e=[];for(let a=0;a<this.photoGrid.gridChildren.length&&e.length<i.preset.matrix.items.length;a++){let s=this.photoGrid.gridChildren[a];s.menuImageVO&&!s.content.isEmpty&&e.push(s.menuImageVO)}this.updateToolVO(i.preset.matrix.width,i.preset.matrix.height,i.preset.gap,i.preset.itemRoundness,BFN.CollageMakerCanvasBackground.color,!1,!0,!0,!0),this.preparePhotoGrid(i.preset.matrix.width,i.preset.matrix.height,i.preset.gap/100,i.preset.itemRoundness/100),this._gridWidth=i.preset.matrix.width,this._gridHeight=i.preset.matrix.height,BFN.CollageMakerHistoryModel.ignoreSnapshot=!0;for(let a=0;a<i.preset.matrix.items.length;a++){let s=i.preset.matrix.items[a];if(s&&s.hasOwnProperty("x")&&s.hasOwnProperty("y")&&s.hasOwnProperty("width")&&s.hasOwnProperty("height")){let o=this.photoGrid.addGridChild(s.x,s.y,s.width,s.height);e.length&&(o.menuImageVO=e.shift(),o.content.setImage(o.menuImageVO.imageTexture)),o.updateProjectItemVO()}}e.splice(0),BFN.CollageMakerHistoryModel.ignoreSnapshot=!1,this.longestSide=BFN.defaultCollageSize,this.adjustGridSizeToLongestSide(),this.updateOriginalAspectRatio(),this.setFreeformAspectRatio(),this.updateSettings(),BFN.CollageMakerHistoryModel.historyAction="new_grid_template",this.photoGrid.getPhotoGridSnapShot(),this.photoGrid.matchesTemplate=!0;let t=null,r=null;if(BFN.CollageMakerTemplateData.templateCategories.forEach(a=>{!t&&i.categoryID===a.id&&(t=a.name,r=BFN.CollageMakerHistoryModel.snapshotVOs.length?BFN.CollageMakerHistoryModel.snapshotVOs[BFN.CollageMakerHistoryModel.snapshotVOs.length-1]:null)}),t&&r){let a=new BFN.UserActionVO;a.eventID="collage_layout_selected",a.eventObject={templateType:"Constrained",templateCategory:t},a.actionSection="collage",a.actionTimestamp=r.timestamp,a.register()}};Re.prototype.applyFreeformTemplate=function(){BFN.CollageMakerCanvasModel.dispatchEvent(BFN.CollageMakerCanvasModelEvents.CLEAR_ITEMS),BFN.CollageMakerHistoryModel.resetHistory(),BFN.CollageMakerCanvasPhotoGridModel.freeform=!0,this.updateToolVO(BFN.CollageMakerTemplateModel.freeformWidth,BFN.CollageMakerTemplateModel.freeformHeight,0,0,BFN.CollageMakerCanvasBackground.color,!1,!1,!1,!1),this.preparePhotoGrid(BFN.CollageMakerTemplateModel.freeformWidth,BFN.CollageMakerTemplateModel.freeformHeight,0,0),this._gridWidth=BFN.CollageMakerTemplateModel.freeformWidth,this._gridHeight=BFN.CollageMakerTemplateModel.freeformHeight,this.longestSide=BFN.defaultCollageSize,this.adjustGridSizeToLongestSide(),this.updateOriginalAspectRatio(),this.setFreeformAspectRatio(),this.updateSettings();let i=new BFN.UserActionVO;i.eventID="collage_layout_selected",i.eventObject={templateType:"Freeform",templateCategory:"Blank"},i.actionSection="collage",i.actionTimestamp=0,i.register()};Re.prototype.applyAutoCollageLayoutObject=function(){let i=BFN.CollageMakerCanvasPhotoGridModel.autoCollageLayoutObject;if(i){let{freeform:e}=BFN.CollageMakerCanvasPhotoGridModel;this.updateToolVO(i.width,i.height,0,0,BFN.CollageMakerCanvasBackground.color,!1,!e,!e,!e),this.preparePhotoGrid(i.width,i.height,0,0),this._gridWidth=i.width,this._gridHeight=i.height;let t=null;if(BFN.CollageMakerCanvasPhotoGridModel.freeform){this.pendingAutoCollageBaseTextures.splice(0);for(let s=0;s<i.data.length;s++){let o=i.data[s],{baseTexture:n}=o.menuImageVO.imageTexture;this.pendingAutoCollageBaseTextures.includes(n)||this.pendingAutoCollageBaseTextures.push(n)}BFN.CollageMakerCanvasModel.dispatchEvent(BFN.CollageMakerCanvasModelEvents.CLEAR_ITEMS),this.pendingAutoCollageBaseTextures.splice(0),this.longestSide=BFN.defaultCollageSize,this.adjustGridSizeToLongestSide(),this.updateOriginalAspectRatio(),this.setFreeformAspectRatio(),this.updateSettings(),BFN.TransformStateModel.blockAddedTransitions=!0;let a=this.longestSide/Math.max(i.width,i.height);for(let s=0;s<i.data.length;s++){let o=i.data[s],{rect:n}=o,l=new PIXI.Point(n.x*a,n.y*a),c=new PIXI.Point(n.width*a,n.height*a);BFN.CollageMakerCanvasModel.addedItem={type:"frame_texture",texture:o.menuImageVO.imageTexture,projectItemAssetID:o.menuImageVO.id,initialPosition:l,initialDimensions:c},BFN.ProjectService.saveLocalAssetForMenuImageVO(o.menuImageVO,"collage").catch(h=>{BeFunky.logError("Failed to store Blob for MenuImageVO",h,o.menuImageVO)}),BFN.TransformModel.selectedTransformItem&&BFN.TransformModel.selectedTransformItem.preloadThumbnail(s*5+50)}BFN.TransformModel.selectedTransformItem&&BFN.TransformModel.selectedTransformItem.deselectItem(),BFN.TransformStateModel.blockAddedTransitions=!1,BFN.TransformStateModel.clearTransitions()}else{BFN.CollageMakerHistoryModel.ignoreSnapshot=!0;for(let a=0;a<i.data.length;a++){let s=i.data[a],{rect:o}=s,n=this.photoGrid.addGridChild(o.x,o.y,o.width,o.height);n.menuImageVO=s.menuImageVO,n.content.setImage(n.menuImageVO.imageTexture),BFN.ProjectService.saveLocalAssetForMenuImageVO(s.menuImageVO,"collage").catch(l=>{BeFunky.logError("Failed to store Blob for MenuImageVO",l,s.menuImageVO)}),n.updateProjectItemVO()}BFN.CollageMakerHistoryModel.ignoreSnapshot=!1,this.longestSide=BFN.defaultCollageSize,this.adjustGridSizeToLongestSide(),this.updateOriginalAspectRatio(),this.setFreeformAspectRatio(),this.updateSettings(),BFN.CollageMakerHistoryModel.historyAction="collage_wizard",this.photoGrid.getPhotoGridSnapShot(),t=BFN.CollageMakerHistoryModel.snapshotVOs.length?BFN.CollageMakerHistoryModel.snapshotVOs[BFN.CollageMakerHistoryModel.snapshotVOs.length-1]:null}let r=new BFN.UserActionVO;r.eventID="collage_layout_selected",r.eventObject={templateType:BFN.CollageMakerCanvasPhotoGridModel.freeform?"Freeform":"Constrained",templateCategory:"Collage Wizard"},r.actionSection="collage",r.actionTimestamp=!BFN.CollageMakerCanvasPhotoGridModel.freeform&&t?t.timestamp:0,r.register()}};Re.prototype.applyPhotoGridSnapshot=function(i=null){let e=i||BFN.CollageMakerHistoryModel.currentSnapshotVO;if(!!e){if(this.photoGrid.hideDragBar(),this.updateToolVO(e.snapshotWidth,e.snapshotHeight,e.gap*100,e.rounding*100,e.backgroundColor),this.preparePhotoGrid(e.gridWidth,e.gridHeight,e.gap,e.rounding),this._gridWidth=e.snapshotWidth,this._gridHeight=e.snapshotHeight,BFN.CollageMakerCanvasBackground.color!=e.backgroundColor&&(BFN.CollageMakerCanvasBackground.color=e.backgroundColor),e.backgroundPatternBaseTexture){let t=new PIXI.Texture(e.backgroundPatternBaseTexture);this.setPatternBackgroundTexture(t),t.destroyGC(!1)}else this.patternBackground.visible&&this.setPatternBackgroundTexture(null);this.photoGrid.backgroundColor!=BFN.CollageMakerCanvasBackground.color&&!this.patternBackground.visible&&(this.photoGrid.backgroundColor=BFN.CollageMakerCanvasBackground.color),BFN.CollageMakerHistoryModel.ignoreSnapshot=!0;for(let t=0;t<e.snapshotChildren.length;t++){let r=e.snapshotChildren[t],a=this.photoGrid.addGridChild(r.rect.x,r.rect.y,r.rect.width,r.rect.height);a.menuImageVO=r.menuImageVO,r.texture&&r.texture.valid&&a.content.setImage(r.texture),a.content.image.frameSprite.offsetFactorX=r.offsetFactorX,a.content.image.frameSprite.offsetFactorY=r.offsetFactorY,a.content.image.frameSprite.rotate=r.rotate,a.content.image.frameSprite.textureScale=r.textureScale,a.content.image.frameSprite.offsetFactorX=r.offsetFactorX,a.content.image.frameSprite.offsetFactorY=r.offsetFactorY,a.content.image.frameSprite.updateDisplay(),a.updateProjectItemVO()}BFN.CollageMakerHistoryModel.ignoreSnapshot=!1,this.setFreeformAspectRatio(),this.updateSettings()}};Re.prototype.applyCollageSettings=function(){if(BFN.CollageMakerCanvasPhotoGridModel.collageSettings){let{collageSettings:i}=BFN.CollageMakerCanvasPhotoGridModel;if(this.updateToolVO(i.width,i.height,i.spacing,i.corner_rounding,i.background_color),this._gridWidth=i.width,this._gridHeight=i.height,BFN.CollageMakerCanvasBackground.color!=i.background_color&&(BFN.CollageMakerCanvasBackground.color=i.background_color),i.backgroundPatternBaseTexture){let e=new PIXI.Texture(i.backgroundPatternBaseTexture);this.setPatternBackgroundTexture(e),e.destroyGC(!1)}else this.patternBackground.visible&&this.setPatternBackgroundTexture(null);this.photoGrid.backgroundColor!=BFN.CollageMakerCanvasBackground.color&&!this.patternBackground.visible&&(this.photoGrid.backgroundColor=BFN.CollageMakerCanvasBackground.color),this.setFreeformAspectRatio(),this.updateSettings()}};Re.prototype.handlePhotoGridSnapShot=function(i){this.createPhotoGridSnapshot()};Re.prototype.handleCurrentTemplateUpdated=function(i){if(!this.photoGrid.matchesTemplate||BFN.CollageMakerTemplateModel.currentTemplate!=this.lastTemplate){let e=BFN.CollageMakerCanvasModel.itemsExist;BFN.CollageMakerCanvasPhotoGridModel.freeform&&e?BeFunky.confirm("confirm_template_mode_change",{onConfirm:this.applyCurrentTemplate.bind(this)}):this.applyCurrentTemplate()}};Re.prototype.handleFreeformTemplate=function(){let i=BFN.CollageMakerCanvasModel.itemsExist||!this.photoGrid.isEmpty;BFN.CollageMakerCanvasPhotoGridModel.freeform?console.log("ALREADY IN FREEFORM MODE"):i?BeFunky.confirm("confirm_template_mode_change",{onConfirm:this.applyFreeformTemplate.bind(this)}):this.applyFreeformTemplate()};Re.prototype.handleAutoCollageLayoutObject=function(i){this.applyAutoCollageLayoutObject()};Re.prototype.handleApplyCurrentSnapShot=function(i){this.applyPhotoGridSnapshot()};Re.prototype.handleCollageSettingsUpdated=function(i){this.applyCollageSettings()};Re.prototype.handleClearAll=function(i){BFN.CollageMakerCanvasPhotoGridModel.freeform?(this.resetBackground(),this.applyFreeformTemplate()):(this.photoGrid.removeAllGridChildren(),BFN.CollageMakerHistoryModel.resetHistory(),this.initInitialTemplate())};Object.defineProperty(Re.prototype,"canvasScale",{set(i){this._canvasScale=i,this.patternBackground.smoothScale=this._canvasScale,this.photoGrid.scale=this._canvasScale},get(){return this._canvasScale}});Object.defineProperty(Re.prototype,"gridWidth",{get(){return this._gridWidth}});Object.defineProperty(Re.prototype,"gridHeight",{get(){return this._gridHeight}});BFN.SingletonQueue.add(()=>{BFN.CollageMakerCanvasPhotoGrid=new Re});function be(){PIXI.Sprite.call(this),this.init()}be.prototype=Object.create(PIXI.Sprite.prototype);be.prototype.init=function(){BeFunky.log("CollageMakerCanvas Init"),this.initDefaultValues(),this.initCheckerPanel(),this.initCanvas(),this.initBackground(),this.initPhotoGrid(),this.initTransformLayer(),this.initTransformLayerVeil(),this.initCanvasGlow(),this.initCanvasScaleBars(),this.initTransformIndicatorContainer(),this.initTransformGuidesContainer(),this.initTransformItemBoundingBoxesContainer(),this.initTransformTool(),this.initTransformToolSnapGaps(),this.initTransformItemIsolator(),this.initLayerToolContainer(),this.initMoveTouchSurface(),this.initCanvasDragger(),this.initAnimators(),setTimeout(function(){this.updateLayout(),this.updateCanvasView(),this.updateDisplay()}.bind(this),0)};be.prototype.initDefaultValues=function(){this.interactive=!0,this.mouseOver=!1,this.model=BFN.CollageMakerCanvasModel,BFN.StageModel.addEventListener(BFN.StageModelEvents.STAGE_DIMENSIONS_UPDATED.type,this.handleStageDimensionsUpdated.bind(this)),BFN.CollageMakerCanvasModel.addEventListener(BFN.CollageMakerCanvasModelEvents.CANVAS_SCALE_UPDATED.type,this.handleCanvasScaleUpdated.bind(this)),BFN.CollageMakerCanvasModel.addEventListener(BFN.CollageMakerCanvasModelEvents.FIT_COLLAGE_TO_FRAME.type,this.handleFitCollageToFrame.bind(this)),BFN.CollageMakerCanvasModel.addEventListener(BFN.CollageMakerCanvasModelEvents.FIT_COLLAGE_TO_FRAME_ANIMATED.type,this.handleFitCollageToFrameAnimated.bind(this)),BFN.CollageMakerCanvasModel.addEventListener(BFN.CollageMakerCanvasModelEvents.ITEM_ADDED.type,this.handleItemAdded.bind(this)),BFN.CollageMakerCanvasModel.addEventListener(BFN.CollageMakerCanvasModelEvents.CLEAR_ITEMS.type,this.handleClearItems.bind(this)),BFN.CollageMakerCanvasPhotoGridModel.addEventListener(BFN.CollageMakerCanvasPhotoGridModelEvents.GRID_SIZE_CHANGED.type,this.handleGridSizeChanged.bind(this)),this.on("pointerover",this.handleCanvasMouseOver.bind(this)),this.on("pointerout",this.handleCanvasMouseOut.bind(this)),this.handleCanvasKeyDownBind=this.handleCanvasKeyDown.bind(this),this.handleCanvasSpaceKeyUpBind=this.handleCanvasSpaceKeyUp.bind(this),document.addEventListener("keydown",this.handleCanvasKeyDownBind,!1)};be.prototype.initCheckerPanel=function(){this.checkerPanel=new BFN.CheckerPanel,this.checkerPanel.setDimensions(0,0),this.addChild(this.checkerPanel)};be.prototype.initCanvas=function(){this.canvasContainer=new PIXI.Sprite,this.canvasContainer.interactive=!0,this.addChild(this.canvasContainer),this.canvas=new PIXI.Sprite,this.canvasContainer.addChild(this.canvas)};be.prototype.initBackground=function(){this.background=BFN.CollageMakerCanvasBackground,this.canvas.addChild(this.background)};be.prototype.initPhotoGrid=function(){this.canvasPhotoGrid=BFN.CollageMakerCanvasPhotoGrid,this.canvasPhotoGrid.addEventListener(BFN.CollageMakerCanvasPhotoGridEvents.RESIZING_COMPLETE.type,this.handleCanvasPhotoGridResizingComplete.bind(this)),this.canvas.addChild(this.canvasPhotoGrid);let i=()=>{this.canvasPhotoGrid.interactive=this.canvasPhotoGrid.interactiveChildren=!BFN.CollageMakerCanvasPhotoGridModel.freeform};i(),BFN.CollageMakerCanvasPhotoGridModel.addEventListener(BFN.CollageMakerCanvasPhotoGridModelEvents.FREEFORM_UPDATED.type,i)};be.prototype.initTransformLayer=function(){this.transformLayerContainer=new PIXI.Container,this.canvas.addChild(this.transformLayerContainer),this.transformLayer=new BFN.TransformLayer(BFN.AppModelViewStates.VIEWING_COLLAGE_MAKER,this),this.transformLayer.addEventListener(BFN.TransformLayerEvents.ITEMS_UPDATED.type,this.handleTransformItemsUpdated.bind(this)),this.transformLayer.addEventListener(BFN.TransformLayerEvents.ITEM_SELECTED.type,this.handleTransformItemSelected.bind(this)),this.transformLayer.addEventListener(BFN.TransformLayerEvents.ITEM_DISPLAY_UPDATED.type,this.handleTransformItemDisplayUpdated.bind(this)),this.transformLayerContainer.addChild(this.transformLayer)};be.prototype.initTransformLayerVeil=function(){this.transformLayerVeil=new BFN.CanvasFrame(ht().hex,1,BFN.CollageMakerCanvasModel.collageFitPaddingX,BFN.CollageMakerCanvasModel.collageFitPaddingY),this.addChild(this.transformLayerVeil),ui(({hex:i})=>{this.transformLayerVeil.color=i})};be.prototype.initCanvasGlow=function(){this.canvasGlow=new BFN.CanvasGlow,this.addChild(this.canvasGlow)};be.prototype.initCanvasScaleBars=function(){this.canvasScaleBars=new BFN.CanvasScaleBars(BFN.AppModelViewStates.VIEWING_COLLAGE_MAKER),this.canvasScaleBars.minSize=BFN.minCollageSize,this.canvasScaleBars.addEventListener(BFN.CanvasScaleBarsEvents.SCALING_STARTED.type,this.handleCanvasScaleBarsScalingStarted.bind(this)),this.canvasScaleBars.addEventListener(BFN.CanvasScaleBarsEvents.SCALING_COMPLETE.type,this.handleCanvasScaleBarsScalingComplete.bind(this)),this.canvasScaleBars.addEventListener(BFN.CanvasScaleBarsEvents.DIMENSIONS_UPDATED.type,this.handleCanvasScaleBarsDimensionsUpdated.bind(this)),this.canvasScaleBars.addEventListener(BFN.CanvasScaleBarsEvents.SCALE_BAR_ACTION.type,this.handleCanvasScaleBarsScaleBarAction.bind(this)),this.addChild(this.canvasScaleBars)};be.prototype.initTransformIndicatorContainer=function(){this.transformIndicatorContainer=new PIXI.Container,this.transformIndicatorContainer.interactiveChildren=!1,this.addChild(this.transformIndicatorContainer)};be.prototype.initTransformGuidesContainer=function(){this.transformGuidesContainer=new PIXI.Container,this.addChild(this.transformGuidesContainer)};be.prototype.initTransformItemBoundingBoxesContainer=function(){this.transformItemBoundingBoxesContainer=new PIXI.Container,this.addChild(this.transformItemBoundingBoxesContainer)};be.prototype.initTransformTool=function(){this.transformTool=new BFN.TransformTool(this.transformLayer),this.addChild(this.transformTool),this.transformLayer.transformTool=this.transformTool};be.prototype.initTransformToolSnapGaps=function(){this.transformToolSnapGapsContainer=new PIXI.Container,this.addChild(this.transformToolSnapGapsContainer)};be.prototype.initTransformItemIsolator=function(){this.transformItemIsolatorContainer=new PIXI.Container,this.canvasContainer.addChild(this.transformItemIsolatorContainer)};be.prototype.initLayerToolContainer=function(){this.layerToolContainer=new PIXI.Container,this.addChild(this.layerToolContainer)};be.prototype.initMoveTouchSurface=function(){this.moveTouchSurface=new PIXI.Graphics,this.moveTouchSurface.interactive=!0,this.moveTouchSurface.visible=!1,this.moveTouchSurface.beginFill(0,0),this.moveTouchSurface.drawRect(-50,-50,100,100),this.moveTouchSurface.endFill(),this.moveTouchSurface.on("pointerover",this.handleHoverSurfaceOver.bind(this)),this.moveTouchSurface.on("pointerout",this.handleHoverSurfaceOut.bind(this)),this.moveTouchSurface.on("pointerdown",this.handleMoveTouchSurfacePressed.bind(this)),this.addChild(this.moveTouchSurface)};be.prototype.initCanvasDragger=function(){this.canvasDragger=new BFN.Dragger,this.canvasDragger.pixelDragThreshold=5,this.canvasDragger.pixelDragThresholdPreventEvent=!0,this.canvasDragger.addEventListener(BFN.DraggerEvents.DRAGGING.type,this.handleCanvasDraggerDragging.bind(this)),this.canvasDragger.addEventListener(BFN.DraggerEvents.DRAGGING_COMPLETE.type,this.handleCanvasDraggerDraggingComplete.bind(this))};be.prototype.initAnimators=function(){this.fitCollageAnimator=new BFN.Animator,this.fitCollageAnimator.linearSteps=10,this.fitCollageAnimator.addEventListener(BFN.AnimatorEvents.UPDATE.type,this.handleFitCollageAnimatorUpdate.bind(this)),this.fitCollageAnimator.addEventListener(BFN.AnimatorEvents.UPDATE_COMPLETE.type,this.handleFitCollageAnimatorUpdateComplete.bind(this))};be.prototype.handleCustomize=function(){this.canvasPhotoGrid.handleCustomize()};be.prototype.handleCollageImage=function(){this.canvasPhotoGrid.handleCollageImage()};be.prototype.updateLayout=function(){this.canvas.x=-(this.canvasPhotoGrid.gridWidth/2),this.canvas.y=-(this.canvasPhotoGrid.gridHeight/2),this.background.itemWidth=this.canvasPhotoGrid.gridWidth,this.background.itemHeight=this.canvasPhotoGrid.gridHeight,this.canvasScaleBars.canvasWidth=this.canvasPhotoGrid.gridWidth,this.canvasScaleBars.canvasHeight=this.canvasPhotoGrid.gridHeight,this.canvasPhotoGrid.x=-this.canvas.x,this.canvasPhotoGrid.y=-this.canvas.y,this.transformLayer.x=-this.canvas.x,this.transformLayer.y=-this.canvas.y};be.prototype.updateCanvasContainerPosition=function(){let i=BFN.MainUI.viewportOverrideW||BFN.StageModel.stageW,e=BFN.MainUI.viewportOverrideH||BFN.StageModel.stageH,t=BFN.CollageMakerCanvasModel.collageFitPaddingX*2,r=BFN.CollageMakerCanvasModel.collageFitPaddingY*2,a=this.canvasPhotoGrid.gridWidth,s=this.canvasPhotoGrid.gridHeight;BFN.TransformItemIsolator.active&&this.transformItemIsolatorContainer.children.includes(BFN.TransformItemIsolator)&&(a=a-(a-BFN.TransformItemIsolator.itemWidth)*BFN.TransformItemIsolator.activeFactor,s=s-(s-BFN.TransformItemIsolator.itemHeight)*BFN.TransformItemIsolator.activeFactor),BFN.PhotoEditorCanvasTools.currentTool&&BFN.PhotoEditorCanvasTools.currentTool.hasOwnProperty("itemWidth")&&BFN.PhotoEditorCanvasTools.currentTool.hasOwnProperty("itemHeight")&&(a=BFN.PhotoEditorCanvasTools.currentTool.itemWidth,s=BFN.PhotoEditorCanvasTools.currentTool.itemHeight);let o=this.scale.x*a,n=this.scale.y*s,l=Math.max(0,a-i/o*a+1/this.scale.x*t),c=Math.max(0,s-e/n*s+1/this.scale.y*r);this.canvasDragger.setBounds(-(l/2),-(c/2),l/2,c/2),this.canvasContainer.x=Math.round(Math.min(this.canvasDragger.bounds.maxX,Math.max(this.canvasDragger.bounds.minX,this.canvasContainer.x))),this.canvasContainer.y=Math.round(Math.min(this.canvasDragger.bounds.maxY,Math.max(this.canvasDragger.bounds.minY,this.canvasContainer.y)))};be.prototype.updateCanvasContainerDisplay=function(){this.updateCanvasContainerPosition(),this.layerToolContainer.x=this.canvasContainer.x,this.layerToolContainer.y=this.canvasContainer.y,this.transformItemBoundingBoxesContainer.x=this.canvasContainer.x,this.transformItemBoundingBoxesContainer.y=this.canvasContainer.y,this.canvasScaleBars.x=this.canvasContainer.x,this.canvasScaleBars.y=this.canvasContainer.y,this.updateCheckerPanel(),this.updateTransformLayerVeil(),this.updateToolPosition(),BFN.TransformGuides.updateDisplay(),BFN.MainUI.requestRender()};be.prototype.updateToolPosition=function(){this.transformTool.x=this.transformLayerVeil.x=this.canvasContainer.x,this.transformTool.y=this.transformLayerVeil.y=this.canvasContainer.y};be.prototype.updateDisplay=function(){this.updateCanvasContainerDisplay(),BFN.MainUI.requestRender()};be.prototype.updateCanvasView=function(){this.updateTransformLayerVeil(),BFN.ZoomManager.updateZoomRange(),BFN.MainUI&&BFN.MainUI.requestRender()};be.prototype.updatePosition=function(){this.x=Math.round(BFN.StageModel.stageW/2),this.y=Math.round(BFN.StageModel.stageH/2),this.transformGuidesContainer.x=-(this.x/this.scale.x),this.transformGuidesContainer.y=-(this.y/this.scale.y),BFN.TransformGuides.updateDisplay(),this.updateTransformLayerVeilOuterDimensions(),this.updateCanvasContainerDisplay()};be.prototype.updateScale=function(){this.scale.x=this.scale.y=this.transformLayer.canvasScale=this.transformTool.scale=this.canvasDragger.scale=BFN.CollageMakerCanvasModel.canvasScale,this.transformItemBoundingBoxesContainer.children.includes(BFN.TransformItemBoundingBoxes)&&(BFN.TransformItemBoundingBoxes.lineScale=BFN.CollageMakerCanvasModel.canvasScale),this.transformGuidesContainer.scale.x=1/this.scale.x,this.transformGuidesContainer.scale.y=1/this.scale.y,this.transformGuidesContainer.x=-(this.x/this.scale.x),this.transformGuidesContainer.y=-(this.y/this.scale.y),BFN.TransformGuides.updateDisplay(),this.layerToolContainer.children.includes(BFN.PhotoEditorCanvasTools)&&(BFN.PhotoEditorCanvasTools.scale=BFN.CollageMakerCanvasModel.canvasScale),this.canvasPhotoGrid.canvasScale=BFN.CollageMakerCanvasModel.canvasScale,this.canvasScaleBars.canvasScale=BFN.CollageMakerCanvasModel.canvasScale,this.transformLayerVeil.canvasScale=BFN.CollageMakerCanvasModel.canvasScale,this.canvasGlow.canvasScale=BFN.CollageMakerCanvasModel.canvasScale,this.updateCanvasContainerDisplay(),BFN.MainUI.requestRender()};be.prototype.fitCollageToFrame=function(i=!1){let e=BFN.CollageMakerCanvasModel.collageFitPaddingX*2,t=BFN.CollageMakerCanvasModel.collageFitPaddingY*2,r=this.canvasPhotoGrid.gridWidth,a=this.canvasPhotoGrid.gridHeight;BFN.TransformItemIsolator.active&&(r=BFN.TransformItemIsolator.itemWidth,a=BFN.TransformItemIsolator.itemHeight),!(r<=0||a<=0)&&(this.fitScale=Math.min(1,(BFN.StageModel.stageW-e)/r,(BFN.StageModel.stageH-t)/a),i?(BFN.CollageMakerCanvasModel.canvasScaling=!0,BFN.CollageMakerCanvasModel.disregardScaleRange=!0,BFN.CollageMakerCanvasModel.canvasScale/=this.canvasPhotoGrid.adjustmentScaleFactor,this.startScale=BFN.CollageMakerCanvasModel.canvasScale,Math.abs(this.fitScale-this.startScale)>.001?this.fitCollageAnimator.setAnimatorFactor(0):this.fitCollageAnimator.setAnimatorFactor(1),this.fitCollageAnimator.increase()):(BFN.CollageMakerCanvasModel.canvasScale=this.fitScale,BFN.CollageMakerCanvasModel.canvasScaling=!1,BFN.ZoomManager.updateZoomRange()))};be.prototype.updateCheckerPanel=function(){this.checkerPanel.x=this.canvasContainer.x,this.checkerPanel.y=this.canvasContainer.y,this.checkerPanel.scale=BFN.CollageMakerCanvasModel.canvasScale;let i={x:0,y:0};if(this.canvasPhotoGrid.gridWidth>1&&this.canvasPhotoGrid.gridHeight>1&&(i.x=this.canvasPhotoGrid.gridWidth,i.y=this.canvasPhotoGrid.gridHeight),BFN.TransformItemIsolator.active&&this.transformItemIsolatorContainer.children.includes(BFN.TransformItemIsolator)){let e=BFN.TransformItemIsolator.itemWidth,t=BFN.TransformItemIsolator.itemHeight;BFN.TransformItemIsolator.shiftAnimator.animating&&(e=BFN.TransformItemIsolator.shiftParamsEnd.w-(BFN.TransformItemIsolator.shiftParamsEnd.w-BFN.TransformItemIsolator.shiftParamsStart.w)*(1-BFN.TransformItemIsolator.shiftAnimator.animationSinFactor),t=BFN.TransformItemIsolator.shiftParamsEnd.h-(BFN.TransformItemIsolator.shiftParamsEnd.h-BFN.TransformItemIsolator.shiftParamsStart.h)*(1-BFN.TransformItemIsolator.shiftAnimator.animationSinFactor)),i.x=i.x-(i.x-e)*BFN.TransformItemIsolator.activeFactor,i.y=i.y-(i.y-t)*BFN.TransformItemIsolator.activeFactor}this.checkerPanel.setDimensions(i.x,i.y),this.updateCanvasGlow()};be.prototype.updateCanvasGlow=function(){let i=this.checkerPanel.width,e=this.checkerPanel.height;this.canvasGlow.x=this.canvasContainer.x-i/2%1,this.canvasGlow.y=this.canvasContainer.y-e/2%1,this.canvasGlow.setDimensions(i,e)};be.prototype.updateTransformLayerVeil=function(){this.transformLayer.frameWidth=this.canvasPhotoGrid.gridWidth,this.transformLayer.frameHeight=this.canvasPhotoGrid.gridHeight,this.transformTool.frameWidth=this.canvasPhotoGrid.gridWidth,this.transformTool.frameHeight=this.canvasPhotoGrid.gridHeight;let i=this.transformLayer.frameWidth,e=this.transformLayer.frameHeight;BFN.TransformItemIsolator.active&&this.transformItemIsolatorContainer.children.includes(BFN.TransformItemIsolator)&&(i=this.transformLayer.frameWidth-(this.transformLayer.frameWidth-BFN.TransformItemIsolator.itemWidth)*BFN.TransformItemIsolator.activeFactor,e=this.transformLayer.frameHeight-(this.transformLayer.frameHeight-BFN.TransformItemIsolator.itemHeight)*BFN.TransformItemIsolator.activeFactor),this.moveTouchSurface.scale.x=i/100,this.moveTouchSurface.scale.y=e/100,this.drawTransformLayerVeil(i,e)};be.prototype.updateTransformLayerVeilOuterDimensions=function(){this.transformLayerVeil.setOuterDimensions(BFN.StageModel.stageW+20,BFN.StageModel.stageH+2)};be.prototype.drawTransformLayerVeil=function(i,e){i=Math.round(i),e=Math.round(e),this.transformLayerVeil.setInnerDimensions(i,e)};be.prototype.getFlattenedImage=function(i=null,e=!1){let t=this.canvasPhotoGrid.getScreenCapture(e,0,i);if(this.transformLayer.itemsExist){let r=t.width>t.height?t.width/this.canvasPhotoGrid.gridWidth:t.height/this.canvasPhotoGrid.gridHeight;this.transformLayerContainer.removeChild(this.transformLayer),this.transformLayer.toggleFlattenDisplayMode(!0,r),this.transformLayerFlattenContainer||(this.transformLayerFlattenContainer=new PIXI.Container),this.transformLayerFlattenContainer.addChild(this.transformLayer),this.transformLayerFlattenContainer.scale.x=this.transformLayerFlattenContainer.scale.y=r,BFN.smoothPictureAction(()=>{BFN.Stage.render(this.transformLayerFlattenContainer,t,!1)}),this.transformLayer.toggleFlattenDisplayMode(!1),this.transformLayerContainer.addChild(this.transformLayer)}return t};be.prototype.handleStageDimensionsUpdated=function(){this.updatePosition()};be.prototype.handleCanvasScaleUpdated=function(){this.updateScale()};be.prototype.handleFitCollageToFrame=function(){this.fitCollageToFrame()};be.prototype.handleFitCollageToFrameAnimated=function(){this.fitCollageToFrame(!0)};be.prototype.handleItemAdded=function(){BFN.CollageMakerCanvasModel.addedItem&&(BFN.GlobalHistoryModel.updateGlobalHistoryMenuState(),this.transformLayer.addItem(BFN.CollageMakerCanvasModel.addedItem),BFN.CollageMakerCanvasModel.addedItem=null)};be.prototype.handleClearItems=function(){this.transformLayer.destroyAllItems(),BFN.TransformStateModel.clearTransitions()};be.prototype.handleGridSizeChanged=function(){this.updateLayout(),this.updateCanvasContainerDisplay(),this.transformLayer.frameWidth=this.canvasPhotoGrid.gridWidth,this.transformLayer.frameHeight=this.canvasPhotoGrid.gridHeight,this.updateTransformLayerVeil()};be.prototype.handleCanvasPhotoGridResizingComplete=function(i){this.fitCollageToFrame(!0)};be.prototype.handleCanvasScaleBarsScalingStarted=function(i){this.canvasPhotoGrid.manualGridResize=!0};be.prototype.handleCanvasScaleBarsScalingComplete=function(i){UITools.setToolValue("collage_customize","width",this.canvasScaleBars.canvasWidth,!1),UITools.setToolValue("collage_customize","height",this.canvasScaleBars.canvasHeight,!1),UITools.updateToolControls("collage_customize"),UITools.applyTool("collage_customize")};be.prototype.handleCanvasScaleBarsDimensionsUpdated=function(i){UITools.setToolValue("collage_customize","width",this.canvasScaleBars.canvasWidth,!0),UITools.setToolValue("collage_customize","height",this.canvasScaleBars.canvasHeight,!0),UITools.updateToolControls("collage_customize"),UITools.applyTool("collage_customize")};be.prototype.handleCanvasScaleBarsScaleBarAction=function(i){let e=i.data.id;switch(i.data.action){case"over":BFN.PhotoGrid.showEdgeIndicators(e=="topLeft"||e=="left"||e=="bottomLeft"?1:0,e=="topLeft"||e=="top"||e=="topRight"?1:0,e=="topRight"||e=="right"||e=="bottomRight"?1:0,e=="bottomRight"||e=="bottom"||e=="bottomLeft"?1:0);break;case"out":e||BFN.PhotoGrid.showEdgeIndicators();break;case"press":BFN.PhotoGrid.showEdgeIndicators(e=="topLeft"||e=="left"||e=="bottomLeft"?2:0,e=="topLeft"||e=="top"||e=="topRight"?2:0,e=="topRight"||e=="right"||e=="bottomRight"?2:0,e=="bottomRight"||e=="bottom"||e=="bottomLeft"?2:0);break;case"release":e?BFN.PhotoGrid.showEdgeIndicators(e=="topLeft"||e=="left"||e=="bottomLeft"?1:0,e=="topLeft"||e=="top"||e=="topRight"?1:0,e=="topRight"||e=="right"||e=="bottomRight"?1:0,e=="bottomRight"||e=="bottom"||e=="bottomLeft"?1:0):BFN.PhotoGrid.showEdgeIndicators();break}};be.prototype.handleTransformItemsUpdated=function(){let i=this.transformLayer.itemsExist;BFN.CollageMakerCanvasModel.itemsExist!=i&&(BFN.CollageMakerCanvasModel.itemsExist=i)};be.prototype.handleTransformItemSelected=function(){this.transformLayer.selectedItem?(this.transformTool.selectItem(this.transformLayer.selectedItem),BFN.TransformModel.selectedTransformItem!=this.transformLayer.selectedItem&&(BFN.TransformModel.selectedTransformItem=this.transformLayer.selectedItem)):(this.transformTool.deselectItem(),BFN.TransformModel.selectedTransformItem=null)};be.prototype.handleTransformItemDisplayUpdated=function(){this.transformTool.updateDisplay()};be.prototype.handleHoverSurfaceOver=function(i){setTimeout(function(){this.hoverSurfaceOver=!0,BFN.CursorScreen.cursor=this.canvasDragger.dragging?"grabbing":"grab"}.bind(this),0)};be.prototype.handleHoverSurfaceOut=function(i){this.hoverSurfaceOver=!1,BFN.CursorScreen&&(BFN.CursorScreen.cursor=this.canvasDragger.dragging?"grabbing":"auto")};be.prototype.handleMoveTouchSurfacePressed=function(i){i.stopPropagation(),this.canvasDragger.drag(this.canvasContainer)};be.prototype.handleCanvasMouseOver=function(i){this.mouseOver=!0};be.prototype.handleCanvasMouseOut=function(i){this.mouseOver=!1};be.prototype.handleCanvasKeyDown=function(i){BFN.AppModel.viewState==BFN.AppModelViewStates.VIEWING_COLLAGE_MAKER&&!(document.activeElement instanceof HTMLInputElement)&&!(document.activeElement instanceof HTMLTextAreaElement)&&i.keyCode==32&&!this.moveTouchSurface.visible&&(BFN.PIXITicker.nudge(),document.addEventListener("keyup",this.handleCanvasSpaceKeyUpBind,!1),this.moveTouchSurface.visible=!0,BFN.MainUI.requestRender(),i.preventDefault())};be.prototype.handleCanvasSpaceKeyUp=function(i){this.handleHoverSurfaceOut(),document.removeEventListener("keyup",this.handleCanvasSpaceKeyUpBind),this.moveTouchSurface.visible=!1,BFN.MainUI.requestRender(),BFN.PIXITicker.nudge()};be.prototype.handleCanvasDraggerDragging=function(){this.updateCanvasContainerDisplay(),BFN.TransformModel.selectedTransformItem&&BFN.TransformModel.selectedTransformItem.type==="group"&&BFN.TransformModel.selectedTransformItem.updateGroupTransform()};be.prototype.handleCanvasDraggerDraggingComplete=function(){BeFunky.log("DRAGGING CANVAS COMPLETED")};be.prototype.handleFitCollageAnimatorUpdate=function(){BFN.CollageMakerCanvasModel.canvasScale=(this.fitScale-this.startScale)*this.fitCollageAnimator.animationSinFactor+this.startScale};be.prototype.handleFitCollageAnimatorUpdateComplete=function(){BFN.CollageMakerCanvasModel.canvasScaling=!1,BFN.CollageMakerCanvasModel.disregardScaleRange=!1,BFN.ZoomManager.updateZoomRange()};Object.defineProperty(be.prototype,"canvasDimensions",{get:function(){return{width:this.canvasPhotoGrid.gridWidth,height:this.canvasPhotoGrid.gridHeight}}});BFN.SingletonQueue.add(function(){BFN.CollageMakerCanvas=new be});function ta(){PIXI.Sprite.call(this),this.init()}ta.prototype=Object.create(PIXI.Sprite.prototype);ta.prototype.init=function(){BeFunky.log("CollageMaker Init"),this.initDefaultValues(),this.initCanvas()};ta.prototype.initDefaultValues=function(){BFN.AppModel.addEventListener(BFN.AppModelEvents.APP_READY.type,this.handleAppReady.bind(this))};ta.prototype.initCanvas=function(){this.addChild(BFN.CollageMakerCanvas)};ta.prototype.handleAppReady=function(){BFN.MainUI.addEventListener(BFN.MainUIEvents.MOUSE_DOWN.type,this.handleMainUIPressed.bind(this))};ta.prototype.handleMainUIPressed=function(i){if(BFN.AppModel.viewState==BFN.AppModelViewStates.VIEWING_COLLAGE_MAKER&&!BFN.ColorPickerPanel.colorButton&&!BeFunky.isLoadScreenActive()&&BFN.TransformModel.selectedTransformItem){let e=i.data.canvasPressed,t=i.data.originalEvent,r=!(e&&(t.ctrlKey||t.metaKey||t.altKey));BFN.CollageMakerCanvas.transformLayer.deselectItem(r,t.shiftKey)}};BFN.SingletonQueue.add(function(){BFN.CollageMaker=new ta});function lr(){PIXI.Container.call(this),this.init()}lr.prototype=Object.create(PIXI.Container.prototype);lr.prototype.init=function(){BeFunky.log("DesignerCanvasBackground Init"),this.initDefaultValues(),this.initBackgroundGraphic(),this.updateDisplay()};lr.prototype.initDefaultValues=function(){this.interactive=!0,this._itemWidth=340,this._itemHeight=340,this._color=UITools.getToolValue("collage_customize","background_color"),this.updateDisplayQueued=!1};lr.prototype.initBackgroundGraphic=function(){this.backgroundGraphic=new PIXI.Graphics,this.addChild(this.backgroundGraphic)};lr.prototype.queueUpdateDisplay=function(){this.updateDisplayQueued||(this.updateDisplayQueued=!0,setTimeout(function(){this.updateDisplayQueued=!1,this.updateDisplay()}.bind(this),0))};lr.prototype.updateDisplay=function(){this.backgroundGraphic.clear(),this._color!=-1&&this._itemWidth>0&&this._itemHeight>0&&(this.backgroundGraphic.beginFill(parseInt("0x"+this._color)),this.backgroundGraphic.drawRect(0,0,this._itemWidth,this._itemHeight),this.backgroundGraphic.endFill());try{BFN.MainUI.requestRender()}catch(i){}};Object.defineProperty(lr.prototype,"itemWidth",{set:function(i){this._itemWidth=i,this.updateDisplay()},get:function(){return this._itemWidth}});Object.defineProperty(lr.prototype,"itemHeight",{set:function(i){this._itemHeight=i,this.updateDisplay()},get:function(){return this._itemHeight}});Object.defineProperty(lr.prototype,"color",{set:function(i){this._color=i,this.updateDisplay()},get:function(){return this._color}});BFN.SingletonQueue.add(function(){BFN.DesignerCanvasBackground=new lr});function Se(){PIXI.Sprite.call(this),this.init()}Se.prototype=Object.create(PIXI.Sprite.prototype);Se.prototype.init=function(){BeFunky.log("DesignerCanvas Init"),this.initDefaultValues(),this.initCheckerPanel(),this.initCanvas(),this.initBackground(),this.initTransformLayer(),this.initTransformLayerVeil(),this.initCanvasGlow(),this.initTransformIndicatorContainer(),this.initTransformGuidesContainer(),this.initTransformItemBoundingBoxesContainer(),this.initTransformTool(),this.initTransformToolSnapGaps(),this.initTransformItemIsolator(),this.initLayerToolContainer(),this.initMoveTouchSurface(),this.initCanvasDragger(),this.initAnimators(),setTimeout(()=>{this.setSize(1,1),BFN.ZoomManager.updateZoomRange()},0)};Se.prototype.initDefaultValues=function(){this.interactive=!0,this.mouseOver=!1,this._canvasWidth=20,this._canvasHeight=20,this.customizePending=!1,this.handleMainUIPreRenderBind=this.handleMainUIPreRender.bind(this),this.updateCurrentTransition=!1,this.transitionVO=null,this.transitionUpdating=!1,this.uniqueTransitionTags=["background_color","resize_template"],this.fitToFrameAfterResize=!1,this.model=BFN.DesignerCanvasModel,BFN.StageModel.addEventListener(BFN.StageModelEvents.STAGE_DIMENSIONS_UPDATED.type,this.handleStageDimensionsUpdated.bind(this)),BFN.DesignerCanvasModel.addEventListener(BFN.DesignerCanvasModelEvents.CANVAS_SCALE_UPDATED.type,this.handleCanvasScaleUpdated.bind(this)),BFN.DesignerCanvasModel.addEventListener(BFN.DesignerCanvasModelEvents.FIT_DESIGNER_TO_FRAME.type,this.handleFitDesignerToFrame.bind(this)),BFN.DesignerCanvasModel.addEventListener(BFN.DesignerCanvasModelEvents.FIT_DESIGNER_TO_FRAME_ANIMATED.type,this.handleFitDesignerToFrameAnimated.bind(this)),BFN.DesignerCanvasModel.addEventListener(BFN.DesignerCanvasModelEvents.ITEM_ADDED.type,this.handleItemAdded.bind(this)),BFN.DesignerCanvasModel.addEventListener(BFN.DesignerCanvasModelEvents.CLEAR_ITEMS.type,this.handleClearItems.bind(this)),BFN.DesignerCanvasModel.addEventListener(BFN.DesignerCanvasModelEvents.DESIGNER_SETTINGS_UPDATED.type,this.handleDesignerSettingsUpdated.bind(this)),this.on("pointerover",this.handleCanvasMouseOver.bind(this)),this.on("pointerout",this.handleCanvasMouseOut.bind(this)),this.handleCanvasKeyDownBind=this.handleCanvasKeyDown.bind(this),this.handleCanvasSpaceKeyUpBind=this.handleCanvasSpaceKeyUp.bind(this),document.addEventListener("keydown",this.handleCanvasKeyDownBind,!1)};Se.prototype.initCheckerPanel=function(){this.checkerPanel=new BFN.CheckerPanel,this.checkerPanel.setDimensions(0,0),this.addChild(this.checkerPanel)};Se.prototype.initCanvas=function(){this.canvasContainer=new PIXI.Sprite,this.canvasContainer.interactive=!0,this.addChild(this.canvasContainer),this.canvas=new PIXI.Sprite,this.canvasContainer.addChild(this.canvas)};Se.prototype.initBackground=function(){this.background=BFN.DesignerCanvasBackground,this.canvas.addChild(this.background)};Se.prototype.initTransformLayer=function(){this.transformLayerContainer=new PIXI.Container,this.canvas.addChild(this.transformLayerContainer),this.transformLayer=new BFN.TransformLayer(BFN.AppModelViewStates.VIEWING_DESIGNER,this),this.transformLayer.addEventListener(BFN.TransformLayerEvents.ITEMS_UPDATED.type,this.handleTransformItemsUpdated.bind(this)),this.transformLayer.addEventListener(BFN.TransformLayerEvents.ITEM_SELECTED.type,this.handleTransformItemSelected.bind(this)),this.transformLayer.addEventListener(BFN.TransformLayerEvents.ITEM_DISPLAY_UPDATED.type,this.handleTransformItemDisplayUpdated.bind(this)),this.transformLayerContainer.addChild(this.transformLayer)};Se.prototype.initTransformLayerVeil=function(){this.transformLayerVeil=new BFN.CanvasFrame(ht().hex,1,BFN.DesignerCanvasModel.designerFitPaddingX,BFN.DesignerCanvasModel.designerFitPaddingY),this.addChild(this.transformLayerVeil),ui(({hex:i})=>{this.transformLayerVeil.color=i})};Se.prototype.initCanvasGlow=function(){this.canvasGlow=new BFN.CanvasGlow,this.addChild(this.canvasGlow)};Se.prototype.initTransformIndicatorContainer=function(){this.transformIndicatorContainer=new PIXI.Container,this.transformIndicatorContainer.interactiveChildren=!1,this.addChild(this.transformIndicatorContainer)};Se.prototype.initTransformGuidesContainer=function(){this.transformGuidesContainer=new PIXI.Container,this.addChild(this.transformGuidesContainer)};Se.prototype.initTransformItemBoundingBoxesContainer=function(){this.transformItemBoundingBoxesContainer=new PIXI.Container,this.addChild(this.transformItemBoundingBoxesContainer)};Se.prototype.initTransformTool=function(){this.transformTool=new BFN.TransformTool(this.transformLayer),this.addChild(this.transformTool),this.transformLayer.transformTool=this.transformTool};Se.prototype.initTransformToolSnapGaps=function(){this.transformToolSnapGapsContainer=new PIXI.Container,this.addChild(this.transformToolSnapGapsContainer)};Se.prototype.initTransformItemIsolator=function(){this.transformItemIsolatorContainer=new PIXI.Container,this.canvasContainer.addChild(this.transformItemIsolatorContainer)};Se.prototype.initLayerToolContainer=function(){this.layerToolContainer=new PIXI.Container,this.addChild(this.layerToolContainer)};Se.prototype.initMoveTouchSurface=function(){this.moveTouchSurface=new PIXI.Graphics,this.moveTouchSurface.interactive=!0,this.moveTouchSurface.visible=!1,this.moveTouchSurface.beginFill(0,0),this.moveTouchSurface.drawRect(-50,-50,100,100),this.moveTouchSurface.endFill(),this.moveTouchSurface.on("pointerover",this.handleHoverSurfaceOver.bind(this)),this.moveTouchSurface.on("pointerout",this.handleHoverSurfaceOut.bind(this)),this.moveTouchSurface.on("pointerdown",this.handleMoveTouchSurfacePressed.bind(this)),this.addChild(this.moveTouchSurface)};Se.prototype.initCanvasDragger=function(){this.canvasDragger=new BFN.Dragger,this.canvasDragger.pixelDragThreshold=5,this.canvasDragger.pixelDragThresholdPreventEvent=!0,this.canvasDragger.addEventListener(BFN.DraggerEvents.DRAGGING.type,this.handleCanvasDraggerDragging.bind(this)),this.canvasDragger.addEventListener(BFN.DraggerEvents.DRAGGING_COMPLETE.type,this.handleCanvasDraggerDraggingComplete.bind(this))};Se.prototype.initAnimators=function(){this.fitDesignerAnimator=new BFN.Animator,this.fitDesignerAnimator.linearSteps=10,this.fitDesignerAnimator.addEventListener(BFN.AnimatorEvents.UPDATE.type,this.handleFitDesignerAnimatorUpdate.bind(this)),this.fitDesignerAnimator.addEventListener(BFN.AnimatorEvents.UPDATE_COMPLETE.type,this.handleFitDesignerAnimatorUpdateComplete.bind(this))};Se.prototype.handleCustomize=function(){this.customizePending||(this.customizePending=!0,BFN.MainUI.addEventListener(BFN.MainUIEvents.PRE_RENDER.type,this.handleMainUIPreRenderBind)),BFN.MainUI.requestRender()};Se.prototype.handleMainUIPreRender=function(){if(this.customizePending){this.customizePending=!1,BFN.MainUI.removeEventListener(BFN.MainUIEvents.PRE_RENDER.type,this.handleMainUIPreRenderBind);let i=UITools.getToolVO("collage_customize");if(!this.transitionUpdating){this.transitionUpdating=!0;let e="settings";switch(i.updating_id){case"background_color":e=i.background_color==-1?"background_transparent":"background_color";break;case"width":case"height":e="resize_template";break}this.createHistoryTransition(e)}if(BFN.DesignerCanvasBackground.color!=i.background_color&&(BFN.DesignerCanvasBackground.color=i.background_color),["width","height"].includes(i.updating_id)&&(this._canvasWidth!=i.width||this._canvasHeight!=i.height)){if(i.smart_resize){let e=BFN.TransformLayerManager.smartResizeLayers(i.width,i.height);e&&(this.transitionVO.batchIDPlaceholder=e,this.transitionVO.isSettingsTransition=!0)}this.setSize(i.width,i.height),UITools.setToolValue("collage_customize","width",BFN.CollageMakerCanvas.canvasPhotoGrid.gridWidth),UITools.setToolValue("collage_customize","height",BFN.CollageMakerCanvas.canvasPhotoGrid.gridHeight),UITools.updateToolControls("collage_customize"),this.fitToFrameAfterResize&&(this.fitToFrameAfterResize=!1,this.fitDesignerToFrame(!0))}!i.updating&&this.transitionUpdating&&(this.transitionUpdating=!1,this.registerHistoryTransition())}};Se.prototype.createHistoryTransition=function(i){if(this.updateCurrentTransition=!1,this.transitionVO){if(this.uniqueTransitionTags.indexOf(i)==-1&&this.transitionVO.id==i&&this.transitionVO==BFN.TransformStateModel.currentTransition&&this.transitionVO.timestamp==BFN.UndoManager.getTimestamp()){this.updateCurrentTransition=!0;return}this.transitionVO=null}this.transitionVO||(this.transitionVO=new BFN.TransformItemTransitionVO,this.transitionVO.id=i,this.transitionVO.alternateHistoryAction="designer_settings_updated",this.transitionVO.startState.designerSettings.background_color=BFN.DesignerCanvasBackground.color,this.transitionVO.startState.designerSettings.width=this._canvasWidth,this.transitionVO.startState.designerSettings.height=this._canvasHeight)};Se.prototype.registerHistoryTransition=function(){let i=this.updateCurrentTransition&&this.transitionVO&&this.transitionVO==BFN.TransformStateModel.currentTransition&&this.transitionVO.timestamp==BFN.UndoManager.getTimestamp();this.transitionVO.previewTexture&&this.transitionVO.previewTexture.destroyGC(!0),this.transitionVO.previewImage=null,this.transitionVO.thumbTexture&&this.transitionVO.thumbTexture.destroyGC(!0),this.transitionVO.thumbImage=null;let e=Math.min(BFN.GlobalHistoryModel.globalHistoryMenuPreviewSize,Math.max(this._canvasWidth,this._canvasHeight));this.transitionVO.previewTexture=this.getFlattenedImage(e),this.transitionVO.thumbTexture=BFN.Util.getThumbTexture(this.transitionVO.previewTexture,BFN.GlobalHistoryModel.globalHistoryMenuThumbSize,!0,!1),this.transitionVO.endState.designerSettings.background_color=BFN.DesignerCanvasBackground.color,this.transitionVO.endState.designerSettings.width=this._canvasWidth,this.transitionVO.endState.designerSettings.height=this._canvasHeight,i?BFN.TransformStateModel.dispatchEvent(BFN.TransformStateModelEvents.TRANSITIONS_UPDATED):BFN.TransformStateModel.addTransition(this.transitionVO),BFN.DesignerModel.updateProjectVO(!1)};Se.prototype.setSize=function(i,e){this._canvasWidth=this.background.itemWidth=i,this._canvasHeight=this.background.itemHeight=e,BFN.secondaryMenu&&(BFN.secondaryMenu.designerCanvasSize=[this._canvasWidth,this._canvasHeight]),BFN.tertiaryMenu&&(BFN.tertiaryMenu.designerCanvasSize=[this._canvasWidth,this._canvasHeight]),BFN.ZoomManager.updateZoomRange(),this.updateDisplay()};Se.prototype.updateCanvasContainerPosition=function(){let i=BFN.MainUI.viewportOverrideW||BFN.StageModel.stageW,e=BFN.MainUI.viewportOverrideH||BFN.StageModel.stageH;this.visible=this._canvasWidth>1&&this._canvasHeight>1;let t=BFN.DesignerCanvasModel.designerFitPaddingX*2,r=BFN.DesignerCanvasModel.designerFitPaddingY*2,a=this._canvasWidth,s=this._canvasHeight;BFN.TransformItemIsolator.active&&this.transformItemIsolatorContainer.children.includes(BFN.TransformItemIsolator)&&(a-=(a-BFN.TransformItemIsolator.itemWidth)*BFN.TransformItemIsolator.activeFactor,s-=(s-BFN.TransformItemIsolator.itemHeight)*BFN.TransformItemIsolator.activeFactor),BFN.PhotoEditorCanvasTools.currentTool&&BFN.PhotoEditorCanvasTools.currentTool.hasOwnProperty("itemWidth")&&BFN.PhotoEditorCanvasTools.currentTool.hasOwnProperty("itemHeight")&&(a=BFN.PhotoEditorCanvasTools.currentTool.itemWidth,s=BFN.PhotoEditorCanvasTools.currentTool.itemHeight);let o=this.scale.x*a,n=this.scale.y*s,l=Math.max(0,a-i/o*a+1/this.scale.x*t),c=Math.max(0,s-e/n*s+1/this.scale.y*r);this.canvasDragger.setBounds(-(l/2),-(c/2),l/2,c/2),this.canvasContainer.x=Math.round(Math.min(this.canvasDragger.bounds.maxX,Math.max(this.canvasDragger.bounds.minX,this.canvasContainer.x))),this.canvasContainer.y=Math.round(Math.min(this.canvasDragger.bounds.maxY,Math.max(this.canvasDragger.bounds.minY,this.canvasContainer.y)))};Se.prototype.updateCanvasContainerDisplay=function(){this.updateCanvasContainerPosition(),this.layerToolContainer.x=this.canvasContainer.x,this.layerToolContainer.y=this.canvasContainer.y,this.transformItemBoundingBoxesContainer.x=this.canvasContainer.x,this.transformItemBoundingBoxesContainer.y=this.canvasContainer.y,this.updateCheckerPanel(),this.updateTransformLayerVeil(),this.updateToolPosition(),BFN.TransformGuides.updateDisplay(),BFN.MainUI.requestRender()};Se.prototype.updateToolPosition=function(){this.transformTool.x=this.transformLayerVeil.x=this.canvasContainer.x,this.transformTool.y=this.transformLayerVeil.y=this.canvasContainer.y};Se.prototype.updateDisplay=function(){this.canvas.x=-(this._canvasWidth/2),this.canvas.y=-(this._canvasHeight/2),this.transformLayer.x=-this.canvas.x,this.transformLayer.y=-this.canvas.y,this.updateCanvasContainerDisplay(),BFN.MainUI.requestRender()};Se.prototype.updatePosition=function(){this.x=Math.round(BFN.StageModel.stageW/2),this.y=Math.round(BFN.StageModel.stageH/2),this.transformGuidesContainer.x=-(this.x/this.scale.x),this.transformGuidesContainer.y=-(this.y/this.scale.y),BFN.TransformGuides.updateDisplay(),this.updateTransformLayerVeilOuterDimensions(),this.updateCanvasContainerDisplay()};Se.prototype.updateScale=function(){this.scale.x=this.scale.y=this.transformLayer.canvasScale=this.transformTool.scale=this.canvasDragger.scale=BFN.DesignerCanvasModel.canvasScale,this.transformItemBoundingBoxesContainer.children.includes(BFN.TransformItemBoundingBoxes)&&(BFN.TransformItemBoundingBoxes.lineScale=BFN.DesignerCanvasModel.canvasScale),this.transformGuidesContainer.scale.x=1/this.scale.x,this.transformGuidesContainer.scale.y=1/this.scale.y,this.transformGuidesContainer.x=-(this.x/this.scale.x),this.transformGuidesContainer.y=-(this.y/this.scale.y),BFN.TransformGuides.updateDisplay(),this.layerToolContainer.children.includes(BFN.PhotoEditorCanvasTools)&&(BFN.PhotoEditorCanvasTools.scale=BFN.DesignerCanvasModel.canvasScale),this.transformLayerVeil.canvasScale=BFN.DesignerCanvasModel.canvasScale,this.canvasGlow.canvasScale=BFN.DesignerCanvasModel.canvasScale,this.updateCanvasContainerDisplay(),BFN.MainUI.requestRender()};Se.prototype.fitDesignerToFrame=function(i=!1){let e=BFN.DesignerCanvasModel.designerFitPaddingX*2,t=BFN.DesignerCanvasModel.designerFitPaddingY*2,r=this._canvasWidth,a=this._canvasHeight;BFN.TransformItemIsolator.active&&(r=BFN.TransformItemIsolator.itemWidth,a=BFN.TransformItemIsolator.itemHeight),!(r<=0||a<=0)&&(this.fitScale=Math.min(1,(BFN.StageModel.stageW-e)/r,(BFN.StageModel.stageH-t)/a),i?(BFN.DesignerCanvasModel.canvasScaling=!0,this.startScale=BFN.DesignerCanvasModel.canvasScale,Math.abs(this.fitScale-this.startScale)>.001?this.fitDesignerAnimator.setAnimatorFactor(0):this.fitDesignerAnimator.setAnimatorFactor(1),this.fitDesignerAnimator.increase()):(BFN.DesignerCanvasModel.canvasScale=this.fitScale,BFN.DesignerCanvasModel.canvasScaling=!1,BFN.ZoomManager.updateZoomRange()))};Se.prototype.updateCheckerPanel=function(){this.checkerPanel.x=this.canvasContainer.x,this.checkerPanel.y=this.canvasContainer.y,this.checkerPanel.scale=BFN.DesignerCanvasModel.canvasScale;let i={x:0,y:0};if(this._canvasWidth>1&&this._canvasHeight>1&&(i.x=this._canvasWidth,i.y=this._canvasHeight),BFN.TransformItemIsolator.active&&this.transformItemIsolatorContainer.children.includes(BFN.TransformItemIsolator)){let e=BFN.TransformItemIsolator.itemWidth,t=BFN.TransformItemIsolator.itemHeight;BFN.TransformItemIsolator.shiftAnimator.animating&&(e=BFN.TransformItemIsolator.shiftParamsEnd.w-(BFN.TransformItemIsolator.shiftParamsEnd.w-BFN.TransformItemIsolator.shiftParamsStart.w)*(1-BFN.TransformItemIsolator.shiftAnimator.animationSinFactor),t=BFN.TransformItemIsolator.shiftParamsEnd.h-(BFN.TransformItemIsolator.shiftParamsEnd.h-BFN.TransformItemIsolator.shiftParamsStart.h)*(1-BFN.TransformItemIsolator.shiftAnimator.animationSinFactor)),i.x=i.x-(i.x-e)*BFN.TransformItemIsolator.activeFactor,i.y=i.y-(i.y-t)*BFN.TransformItemIsolator.activeFactor}this.checkerPanel.setDimensions(i.x,i.y),this.updateCanvasGlow()};Se.prototype.updateCanvasGlow=function(){let i=this.checkerPanel.width,e=this.checkerPanel.height;this.canvasGlow.x=this.canvasContainer.x-i/2%1,this.canvasGlow.y=this.canvasContainer.y-e/2%1,this.canvasGlow.setDimensions(i,e)};Se.prototype.updateTransformLayerVeil=function(){this.transformLayer.frameWidth=this._canvasWidth,this.transformLayer.frameHeight=this._canvasHeight,this.transformTool.frameWidth=this._canvasWidth,this.transformTool.frameHeight=this._canvasHeight;let i=this.transformLayer.frameWidth,e=this.transformLayer.frameHeight;BFN.TransformItemIsolator.active&&this.transformItemIsolatorContainer.children.includes(BFN.TransformItemIsolator)&&(i=this.transformLayer.frameWidth-(this.transformLayer.frameWidth-BFN.TransformItemIsolator.itemWidth)*BFN.TransformItemIsolator.activeFactor,e=this.transformLayer.frameHeight-(this.transformLayer.frameHeight-BFN.TransformItemIsolator.itemHeight)*BFN.TransformItemIsolator.activeFactor),this.moveTouchSurface.scale.x=i/100,this.moveTouchSurface.scale.y=e/100,this.drawTransformLayerVeil(i,e)};Se.prototype.updateTransformLayerVeilOuterDimensions=function(){this.transformLayerVeil.setOuterDimensions(BFN.StageModel.stageW+20,BFN.StageModel.stageH+2)};Se.prototype.drawTransformLayerVeil=function(i,e){i=Math.round(i),e=Math.round(e),this.transformLayerVeil.setInnerDimensions(i,e)};Se.prototype.getFlattenedImage=function(i=null){let e=1,t=this._canvasWidth,r=this._canvasHeight;typeof i=="number"&&(i=Math.max(BFN.minImageSize,Math.min(BFN.maxImageSize,i)),e=i/Math.max(t,r),t=Math.round(t*e),r=Math.round(r*e));let a=PIXI.RenderTexture.create(t,r);return BFN.DesignerCanvasBackground.color!=-1?a.fillColor(parseInt(`0x${BFN.DesignerCanvasBackground.color}`)):a.clear(),this.transformLayer.itemsExist&&(this.transformLayerContainer.removeChild(this.transformLayer),this.transformLayer.toggleFlattenDisplayMode(!0,e),this.transformLayerFlattenContainer||(this.transformLayerFlattenContainer=new PIXI.Container),this.transformLayerFlattenContainer.addChild(this.transformLayer),this.transformLayerFlattenContainer.scale.x=this.transformLayerFlattenContainer.scale.y=e,BFN.smoothPictureAction(()=>{BFN.Stage.render(this.transformLayerFlattenContainer,a,!1)}),this.transformLayer.toggleFlattenDisplayMode(!1),this.transformLayerContainer.addChild(this.transformLayer)),BFN.MainUI.requestRender(),a};Se.prototype.debugSmartResizePreview=function(i=BFN.maxImageSize){!BeFunky.Params.isAdmin||this.getResizedImage(i,e=>{this.previewTexture?(this.previewTexture.destroyGC(!0),this.previewTexture=e,this.previewSprite.texture=this.previewTexture):(this.previewTexture=e,this.previewSprite=new PIXI.Sprite(this.previewTexture),this.previewSprite.pluginName="smooth_picture",BFN.MainUI.addChild(this.previewSprite)),this.previewSprite.scale.x=this.previewSprite.scale.y=this.previewSprite.currentScale=800/this.previewTexture.width,BFN.MainUI.requestRender()})};Se.prototype.getResizedImage=function(i=1024,e=null){if(!e)return;!BFN.AppModel.viewState===BFN.AppModelViewStates.VIEWING_DESIGNER&&e(null),i=Math.max(BFN.minImageSize,Math.min(BFN.maxImageSize,i));let t=()=>{BFN.accurateBoundsQueue.length?requestAnimationFrame(t):requestAnimationFrame(()=>{let n=this.getFlattenedImage();BFN.UndoManager.undo(),BFN.TransformStateModel.purgeLaterTransitions(),e(n)})},r=()=>{UIHistory.removeEventListener(UIHistoryEvents.HISTORY_ITEMS_UPDATED.type,r),t()};UIHistory.addEventListener(UIHistoryEvents.HISTORY_ITEMS_UPDATED.type,r);let a=i/Math.max(this._canvasWidth,this._canvasHeight),s=Math.round(a*this._canvasWidth),o=Math.round(a*this._canvasHeight);UITools.setToolValue("collage_customize","smart_resize",!0),UITools.setToolValue("collage_customize","width",s),UITools.setToolValue("collage_customize","height",o),UITools.applyTool("collage_customize")};Se.prototype.handleStageDimensionsUpdated=function(){this.updatePosition()};Se.prototype.handleCanvasScaleUpdated=function(){this.updateScale()};Se.prototype.handleFitDesignerToFrame=function(){this.fitDesignerToFrame()};Se.prototype.handleFitDesignerToFrameAnimated=function(){this.fitDesignerToFrame(!0)};Se.prototype.handleItemAdded=function(){BFN.DesignerCanvasModel.addedItem&&(BFN.GlobalHistoryModel.updateGlobalHistoryMenuState(),this.transformLayer.addItem(BFN.DesignerCanvasModel.addedItem),BFN.DesignerCanvasModel.addedItem=null)};Se.prototype.handleClearItems=function(){this.transformLayer.destroyAllItems(),BFN.TransformStateModel.clearTransitions()};Se.prototype.handleDesignerSettingsUpdated=function(){if(!BFN.DesignerCanvasModel.designerSettings){BeFunky.logError("No Designer Settings Available");return}let i=BFN.DesignerCanvasModel.designerSettings,e=UITools.getToolVO("collage_customize");UITools.setToolValue("collage_customize","background_color",i.background_color),UITools.updateToolControls("collage_customize"),BFN.DesignerCanvasBackground.color!=e.background_color&&(BFN.DesignerCanvasBackground.color=e.background_color),i.width&&i.height&&(this._canvasWidth!==i.width||this._canvasHeight!==i.height)&&this.setSize(i.width,i.height),BFN.DesignerModel.updateProjectVO(!1)};Se.prototype.handleTransformItemsUpdated=function(){let i=this.transformLayer.itemsExist;BFN.DesignerCanvasModel.itemsExist!=i&&(BFN.DesignerCanvasModel.itemsExist=i)};Se.prototype.handleTransformItemSelected=function(){this.transformLayer.selectedItem?(this.transformTool.selectItem(this.transformLayer.selectedItem),BFN.TransformModel.selectedTransformItem!=this.transformLayer.selectedItem&&(BFN.TransformModel.selectedTransformItem=this.transformLayer.selectedItem)):(this.transformTool.deselectItem(),BFN.TransformModel.selectedTransformItem=null)};Se.prototype.handleTransformItemDisplayUpdated=function(){this.transformTool.updateDisplay()};Se.prototype.handleHoverSurfaceOver=function(i){setTimeout(()=>{this.hoverSurfaceOver=!0,BFN.CursorScreen.cursor=this.canvasDragger.dragging?"grabbing":"grab"},0)};Se.prototype.handleHoverSurfaceOut=function(i){this.hoverSurfaceOver=!1,BFN.CursorScreen&&(BFN.CursorScreen.cursor=this.canvasDragger.dragging?"grabbing":"auto")};Se.prototype.handleMoveTouchSurfacePressed=function(i){i.stopPropagation(),this.canvasDragger.drag(this.canvasContainer)};Se.prototype.handleCanvasMouseOver=function(i){this.mouseOver=!0};Se.prototype.handleCanvasMouseOut=function(i){this.mouseOver=!1};Se.prototype.handleCanvasKeyDown=function(i){BFN.AppModel.viewState==BFN.AppModelViewStates.VIEWING_DESIGNER&&!(document.activeElement instanceof HTMLInputElement)&&!(document.activeElement instanceof HTMLTextAreaElement)&&i.keyCode==32&&!this.moveTouchSurface.visible&&(BFN.PIXITicker.nudge(),document.addEventListener("keyup",this.handleCanvasSpaceKeyUpBind,!1),this.moveTouchSurface.visible=!0,BFN.MainUI.requestRender(),i.preventDefault())};Se.prototype.handleCanvasSpaceKeyUp=function(i){this.handleHoverSurfaceOut(),document.removeEventListener("keyup",this.handleCanvasSpaceKeyUpBind),this.moveTouchSurface.visible=!1,BFN.MainUI.requestRender(),BFN.PIXITicker.nudge()};Se.prototype.handleCanvasDraggerDragging=function(){this.updateCanvasContainerDisplay(),BFN.TransformModel.selectedTransformItem&&BFN.TransformModel.selectedTransformItem.type==="group"&&BFN.TransformModel.selectedTransformItem.updateGroupTransform()};Se.prototype.handleCanvasDraggerDraggingComplete=function(){BeFunky.log("DRAGGING CANVAS COMPLETED")};Se.prototype.handleFitDesignerAnimatorUpdate=function(){BFN.DesignerCanvasModel.canvasScale=(this.fitScale-this.startScale)*this.fitDesignerAnimator.animationSinFactor+this.startScale};Se.prototype.handleFitDesignerAnimatorUpdateComplete=function(){BFN.DesignerCanvasModel.canvasScaling=!1,BFN.ZoomManager.updateZoomRange()};Object.defineProperty(Se.prototype,"canvasWidth",{get(){return this._canvasWidth}});Object.defineProperty(Se.prototype,"canvasHeight",{get(){return this._canvasHeight}});Object.defineProperty(Se.prototype,"canvasDimensions",{get:function(){return{width:this._canvasWidth,height:this._canvasHeight}}});BFN.SingletonQueue.add(()=>{BFN.DesignerCanvas=new Se});function ia(){PIXI.Sprite.call(this),this.init()}ia.prototype=Object.create(PIXI.Sprite.prototype);ia.prototype.init=function(){BeFunky.log("Designer Init"),this.initDefaultValues(),this.initCanvas()};ia.prototype.initDefaultValues=function(){BFN.AppModel.addEventListener(BFN.AppModelEvents.APP_READY.type,this.handleAppReady.bind(this))};ia.prototype.initCanvas=function(){this.addChild(BFN.DesignerCanvas)};ia.prototype.handleAppReady=function(){BFN.MainUI.addEventListener(BFN.MainUIEvents.MOUSE_DOWN.type,this.handleMainUIPressed.bind(this))};ia.prototype.handleMainUIPressed=function(i){if(BFN.AppModel.viewState==BFN.AppModelViewStates.VIEWING_DESIGNER&&!BFN.ColorPickerPanel.colorButton&&!BeFunky.isLoadScreenActive()&&BFN.TransformModel.selectedTransformItem){let e=i.data.canvasPressed,t=i.data.originalEvent,r=!(e&&(t.ctrlKey||t.metaKey||t.altKey));BFN.DesignerCanvas.transformLayer.deselectItem(r,t.shiftKey)}};BFN.SingletonQueue.add(function(){BFN.Designer=new ia});BFN.MainUIEvents={MOUSE_OVER:new Event("MOUSE_OVER"),MOUSE_OUT:new Event("MOUSE_OUT"),MOUSE_DOWN:new Event("MOUSE_DOWN"),MOUSE_WHEEL:new Event("MOUSE_WHEEL"),PRE_RENDER:new Event("PRE_RENDER"),POST_PRE_RENDER:new Event("POST_PRE_RENDER"),RENDERED:new Event("RENDERED")};function ot(){PIXI.Container.call(this),BFN.EventDispatcher.call(this),this.init()}ot.prototype=window.azrc.extend(Object.create(PIXI.Container.prototype),Object.create(BFN.EventDispatcher.prototype));ot.prototype.init=function(){BeFunky.log("MainUI Init"),this.initDefaultValues(),this.initPhotoEditor(),this.initCollageMaker(),this.initDesigner(),this.initBrushCircle(),this.initEyeDropper(),this.initTransformGuides(),this.initHiResTextViewport(),this.initMainUIMask()};ot.prototype.initDefaultValues=function(){this.interactive=!0,this.hitArea=new PIXI.Rectangle(0,0,1e3,1e3),this.renderRequested=!0,this.rendering=!0,this.renderTime=0,this.renderAvailable=!1,this._viewportUpdating=!1,this.animationFrameRequested=!1,this._tooltip=null,this._renderingCanvas=!1,this.idleRenderFunctions=[],BFN.AppModel.addEventListener(BFN.AppModelEvents.APP_READY.type,this.handleAppReady.bind(this)),BFN.AppModel.addEventListener(BFN.AppModelEvents.VIEWSTATE_UPDATED.type,this.handleViewStateUpdated.bind(this)),BFN.StageModel.addEventListener(BFN.StageModelEvents.STAGE_DIMENSIONS_UPDATED.type,this.handleStageDimensionsUpdated.bind(this)),document.addEventListener(BeFunky.pointerdown,i=>{!(i.target instanceof HTMLCanvasElement)&&!(i.target&&i.target.preventItemDeselect)&&!BeFunky.isModalOpen()&&!BeFunky.isLoadScreenActive()&&(BFN.MainUIEvents.MOUSE_DOWN.data={canvasPressed:!1,originalEvent:i},this.dispatchEvent(BFN.MainUIEvents.MOUSE_DOWN))}),this.on("pointerdown",this.handlePointerDown.bind(this)),this.on(BeFunky.pointerover,i=>{this.dispatchEvent(BFN.MainUIEvents.MOUSE_OVER)}),this.on(BeFunky.pointerout,i=>{this.dispatchEvent(BFN.MainUIEvents.MOUSE_OUT)}),BFN.StageModel.appStage.addEventListener("wheel",i=>{i.altKey&&(BFN.MainUIEvents.MOUSE_WHEEL.deltaY=i.deltaY,this.dispatchEvent(BFN.MainUIEvents.MOUSE_WHEEL),i.preventDefault())}),this.pointerEvent=null,BFN.Stage.plugins.interaction.on("pointerdown",i=>{this.pointerEvent=i}),BFN.Stage.plugins.interaction.on("pointermove",i=>{this.pointerEvent=i}),BFN.Stage.plugins.interaction.on("pointerup",i=>{this.pointerEvent=i})};ot.prototype.showMainUIContextMenu=function(i,e,t){let r=null,a=[BFN.PhotoEditorCanvas,BFN.PhotoEditorCanvas.transformLayerVeil,BFN.PhotoEditorCanvasImage],s=[BFN.CollageMakerCanvas,BFN.CollageMakerCanvas.transformLayerVeil,BFN.CollageMakerCanvasBackground],o=[BFN.DesignerCanvas,BFN.DesignerCanvas.transformLayerVeil,BFN.DesignerCanvasBackground];a.includes(i)&&BFN.PhotoEditorCanvasModel.viewState===BFN.PhotoEditorCanvasModelViewStates.VIEWING_CANVAS?r=BFN.PhotoEditorCanvasModel.contextMenu:s.includes(i)?r=BFN.CollageMakerCanvasModel.contextMenu:o.includes(i)&&(r=BFN.DesignerCanvasModel.contextMenu),r&&(r.toggleButton("undo",BFN.UndoManager.undoExists),r.toggleButton("redo",BFN.UndoManager.redoExists),r.toggleButton("reset",!!BFN.GlobalHistoryModel.globalHistoryVOs.length),r.toggleButton("save_to_image_manager",!!BFN.GlobalHistoryModel.globalHistoryVOs.length),r.show(e,t))};ot.prototype.initPhotoEditor=function(){this.photoEditor=BFN.PhotoEditor,this.photoEditor.visible=!1,this.addChild(this.photoEditor)};ot.prototype.initCollageMaker=function(){this.collageMaker=BFN.CollageMaker,this.collageMaker.visible=!1,this.addChild(this.collageMaker)};ot.prototype.initDesigner=function(){this.designer=BFN.Designer,this.designer.visible=!1,this.addChild(this.designer)};ot.prototype.initBrushCircle=function(){this.addChild(BFN.BrushCircle),this.addChild(BFN.BrushCirclePreview)};ot.prototype.initEyeDropper=function(){this.eyeDropperContainer=new PIXI.Container,this.addChild(this.eyeDropperContainer)};ot.prototype.initTransformGuides=function(){this.transformGuides=BFN.TransformGuides,this.addChild(this.transformGuides)};ot.prototype.initHiResTextViewport=function(){BFN.HiResTextManager.showHiResTextHelpers&&this.addChild(BFN.HiResTextManager.hiResTextViewport)};ot.prototype.initMainUIMask=function(){this.mainUIMask=new PIXI.Graphics,this.addChild(this.mainUIMask)};ot.prototype.requestRender=function(){BFN.MainUI.renderRequested=!0};ot.prototype.addIdleRenderFunction=function(i){if(typeof i!="function")return BeFunky.logError("Non-function passed to addIdleRenderFunction",i);BFN.MainUI.idleRenderFunctions.push(i)};ot.prototype.updateAppView=function(){this.photoEditor.visible=BFN.AppModel.viewState===BFN.AppModelViewStates.VIEWING_PHOTO_EDITOR,this.collageMaker.visible=BFN.AppModel.viewState===BFN.AppModelViewStates.VIEWING_COLLAGE_MAKER,this.designer.visible=BFN.AppModel.viewState===BFN.AppModelViewStates.VIEWING_DESIGNER,BFN.MainUI.requestRender()};ot.prototype.updateDimensions=function(){this.hitArea.width=BFN.StageModel.stageW,this.hitArea.height=BFN.StageModel.stageH,this.mainUIMask.clear(),this.mainUIMask.beginFill(16777215,1),this.mainUIMask.drawRect(0,0,BFN.StageModel.stageW,BFN.StageModel.stageH),this.mainUIMask.endFill(),this.mask=this.mainUIMask,BFN.MainUI.requestRender()};ot.prototype.animate=function(i){if(BFN.MainUI.viewportUpdating&&BFN.StageModel.updateStageDimensions(),i>=BFN.MainUI.renderTime-1&&(BFN.MainUI.renderTime=i+BFN.frameInterval,BFN.MainUI.renderAvailable=!0),BFN.MainUI.renderRequested&&BFN.MainUI.renderAvailable&&!BFN.MainUI.animationFrameRequested&&(BFN.MainUI.animationFrameRequested=!0,BFN.MainUI.renderRequested=!1,BFN.MainUI.renderAvailable=!1,BFN.MainUI.animationFrameRequested=!1,BFN.MainUI.rendering&&(BFN.MainUI.dispatchEvent(BFN.MainUIEvents.PRE_RENDER),BFN.MainUI.dispatchEvent(BFN.MainUIEvents.POST_PRE_RENDER),BFN.MainUI.renderCanvas(),BFN.MainUI.dispatchEvent(BFN.MainUIEvents.RENDERED))),BFN.MainUI.idleRenderFunctions.length&&!BFN.MainUI.renderRequested&&!BFN.MainUI.animationFrameRequested&&BFN.MainUI.renderAvailable){let e=BFN.MainUI.idleRenderFunctions.shift();requestIdleCallback(e)}requestAnimationFrame(BFN.MainUI.animate)};ot.prototype.renderCanvas=function(){this._renderingCanvas=!0,BFN.Stage.render(BFN.MainUI),this._renderingCanvas=!1};ot.prototype.getFlattenedImage=function(){let i=PIXI.RenderTexture.create(BFN.StageModel.stageW,BFN.StageModel.stageH);i.fillColor(ht().hex);let e=new PIXI.Point(BFN.MainUI.x,BFN.MainUI.y);return BFN.MainUI.x=BFN.MainUI.y=0,BFN.smoothPictureAction(()=>{BFN.Stage.render(BFN.MainUI,i,!1)}),BFN.MainUI.x=e.x,BFN.MainUI.y=e.y,i};ot.prototype.handleAppReady=function(){this.updateAppView()};ot.prototype.handleViewStateUpdated=function(){this.updateAppView()};ot.prototype.handleStageDimensionsUpdated=function(){this.updateDimensions()};ot.prototype.handlePointerDown=function(i){let{originalEvent:e}=i.data;try{if(e.button===2)this.showMainUIContextMenu(i.target,e.clientX,e.clientY);else{let{target:t}=i,r=a=>{BFN.TransformItemGroup.documentMouseMoved=!0,this.showMainUIContextMenu(t,a.clientX,a.clientY)};BFN.LongPressManager.initiateLongPress(r)}}catch(t){}BFN.MainUIEvents.MOUSE_DOWN.data={canvasPressed:!0,originalEvent:e},this.dispatchEvent(BFN.MainUIEvents.MOUSE_DOWN)};Object.defineProperty(ot.prototype,"viewportUpdating",{set(i){this._viewportUpdating=i,this._viewportUpdating||(BFN.StageModel.updateStageDimensions(),delete this.viewportOverrideW,delete this.viewportOverrideH),BFN.StageModel.updateAppViewportDimensions()},get(){return this._viewportUpdating}});Object.defineProperty(ot.prototype,"tooltip",{set(i){this._tooltip!==i&&(this._tooltip=i,this._tooltip||BFN.TooltipScreen.hide())},get(){return this._tooltip}});Object.defineProperty(ot.prototype,"renderingCanvas",{get(){return this._renderingCanvas}});BFN.SingletonQueue.add(()=>{BFN.MainUI=new ot,BFN.MainUI.animate()});BFN.UI.applyCancelUpgradeButtons=(i,{id:e})=>function(){this.init=function(){this.initDefaultValues()},this.initDefaultValues=function(){this.upgradeMode=!1,this.cancelButton=document.getElementById(`${e}_cancel`),this.applyButton=document.getElementById(`${e}_apply`),this.upgradeButton=document.getElementById(`${e}_upgrade`),this._alternateApply=!1,this.applyButton.addEventListener("click",this.handleClick),this.upgradeButton.addEventListener("click",this.handleClick),BeFunky.onFreeTrialEnabledChange(t=>{this.upgradeButton.setLang(t?"Start Free Trial":"upgrade")})},this.handleClick=t=>{this._upgradeMode&&(t.stopImmediatePropagation(),BFN.PhotoEditorCanvasTools.applyCurrentTool())},Object.defineProperty(this,"upgradeMode",{set(t){this._upgradeMode=t,this.toggleClass("button-group--must-upgrade",this._upgradeMode)},get(){return this._upgradeMode}}),Object.defineProperty(this,"alternateApply",{set(t){this._alternateApply=t},get(){return this._alternateApply}}),this.init()}.bind(i)();BFN.UI.autocomplete=BeFunky.autocomplete;BFN.UI.batchProcessingImageItem=(i,e)=>function(){this.init=function(){this.initDefaultValues()},this.initDefaultValues=function(){this.batchImageVO=e,this.addClass("batch-item"),this.background=document.createElement("div"),this.background.addClass("batch-item__background"),this.appendChild(this.background),this.image=document.createElement("div"),this.image.addClass("batch-item__image"),this.background.appendChild(this.image),this.imageOverlay=document.createElement("div"),this.imageOverlay.addClass("batch-item__image-overlay"),this.image.appendChild(this.imageOverlay),this.imageOverlayVeil=document.createElement("div"),this.imageOverlayVeil.addClass("batch-item__image-overlay-veil"),this.imageOverlayVeil.innerHTML='<div class="loading-spinner"></div>',this.image.appendChild(this.imageOverlayVeil),this.imageOverlayLoader=this.imageOverlayVeil.querySelector(".loading-spinner"),this.cropControls=document.createElement("div"),this.cropControls.addClass("batch-item__crop-controls"),this.image.appendChild(this.cropControls),this.cropVeilT=this.addCropVeil(this.cropControls,"top"),this.cropVeilL=this.addCropVeil(this.cropControls,"left"),this.cropVeilR=this.addCropVeil(this.cropControls,"right"),this.cropVeilB=this.addCropVeil(this.cropControls,"bottom"),this.cropRegion=this.addCropRegion(this.cropControls),this.label=document.createElement("div"),this.label.addClass("batch-item__label"),this.label.textContent=`${e.imageW} \xD7 ${e.imageH}`,this.appendChild(this.label),this.isNew=!0,this.setStyles({display:"none"}),this.updateImageDisplay()},this.setBatchMode=function(t){switch(this.imageOverlay.removeClass("active"),t){case"resize":this.cropControls.removeClass("active");break;case"crop":this.cropControls.addClass("active"),this.resize("none");break;default:this.cropControls.removeClass("active"),this.resize("none"),t==="dynamic"&&this.imageOverlay.addClass("active");break}},this.setImageOverlayOpacity=function(t=100){this.imageOverlay.setStyles({opacity:t/100})},this.setImageOverlaySRC=function(t=null,r=!0,a=!1){this.hasOwnProperty("imageOverlayObjectURL")&&(URL.revokeObjectURL(this.imageOverlayObjectURL),delete this.imageOverlayObjectURL),t&&(this.imageOverlayObjectURL=t),this.imageOverlaySRC=t,this.imageOverlayFadeable=r,a||this.applyImageOverlaySRC()},this.applyImageOverlaySRC=function(){if(this.hasOwnProperty("imageOverlaySRC")&&this.hasOwnProperty("imageOverlayFadeable")){let t=this.imageOverlaySRC,r=this.imageOverlayFadeable;delete this.imageOverlaySRC,delete this.imageOverlayFadeable,this.imageOverlay.setStyles({background:t?`url(${t})`:"",backgroundSize:"100% 100%",width:"100%",height:"100%"}),t&&!r?this.image.setStyles({background:""}):this.image.setStyles({background:`url(${this.batchImageVO.thumbSRC})`,backgroundSize:"100% 100%",width:"100%",height:"100%"})}},this.setBackgroundColor=function(t=-1){this.batchImageVO.backgroundColor=t,this.updateBackgroundDisplay()},this.setImageType=function(t="jpg"){["jpg","png"].includes(t)&&(this.batchImageVO.imageType=t)},this.updateBackgroundDisplay=function(){this.background.setStyles({background:this.batchImageVO.backgroundColor===-1?"":`#${this.batchImageVO.backgroundColor}`})},this.updateImageDisplay=function(){let t=new Image;t.addEventListener("load",()=>{let r=Math.max(e.imageW,e.imageH);this.background.setStyles({width:`${e.imageW/r*100}%`,height:`${e.imageH/r*100}%`}),this.image.setStyles({background:`url(${t.src})`,backgroundSize:"100% 100%",width:"100%",height:"100%"}),this.isNew&&(this.isNew=!1,this.setStyles({display:""}))}),t.src=e.thumbSRC},this.toggleImageOverlayVeil=function(t,r){this.imageOverlayVeil.toggleClass("active",t),this.imageOverlayLoader.toggleClass("active",t&&r)},this.resize=function(t="none"){this.resizeToolVO||(this.resizeToolVO=UITools.getToolVO("batch_resize"));let r=e.imageW,a=e.imageH,s=Math.max(e.imageW,e.imageH),o=a/r,n=r,l=a;switch(t){case"scale":{let{scale:p}=this.resizeToolVO;n=Math.round(r*(p/100)),l=Math.round(a*(p/100));break}case"longest_side":{let p=this.resizeToolVO.longest_side;n=Math.round(o>1?p/o:p),l=Math.round(o>1?p:p*o);break}case"width":{let{width:p}=this.resizeToolVO;n=p,l=Math.round(p*o);break}case"height":{let{height:p}=this.resizeToolVO;n=Math.round(p/o),l=p;break}case"exact_size":{let p=this.resizeToolVO.exact_width,g=this.resizeToolVO.exact_height;n=p,l=g;break}}let c=Math.min(n,l),h=Math.max(n,l);c<BFN.minImageSize?(n=Math.round(o>1?BFN.minImageSize:BFN.minImageSize/o),l=Math.round(o>1?BFN.minImageSize*o:BFN.minImageSize)):h>BFN.maxImageSize&&(n=Math.round(o>1?BFN.maxImageSize/o:BFN.maxImageSize),l=Math.round(o>1?BFN.maxImageSize:BFN.maxImageSize*o));let u=this.resizeToolVO.use_padding;if(t==="exact_size")if(h=Math.max(n,l),this.background.setStyles({width:`${n/h*100}%`,height:`${l/h*100}%`}),u){let p=l/n,g=o/p,f=g>1?100/g:100,v=g>1?100:100*g;this.image.setStyles({width:`${f}%`,height:`${v}%`})}else this.image.setStyles({width:"100%",height:"100%"});else this.background.setStyles({width:`${r/s*100}%`,height:`${a/s*100}%`}),this.image.setStyles({width:"100%",height:"100%"});let d='<svg class="icon icon--12" style="margin: -3px 3px 0 2px;"><use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="#arrow-icon"></use></svg>',m=`${r} \xD7 ${a}`;(r!==n||a!==l)&&(m+=` ${d} <strong>${n} \xD7 ${l}</strong>`),this.label.innerHTML=m,this.label.setStyles({visibility:t==="none"?"hidden":"visible"}),this.batchImageVO.resizeData.width=n,this.batchImageVO.resizeData.height=l,this.batchImageVO.resizeData.padding=u},this.setCropRatio=function(t=-1,r="landscape"){let{imageW:a}=e,{imageH:s}=e,o=s/a;t===-1&&(t=o>1?1/o:o),r==="portrait"&&t!==-2&&(t=1/t),t===-2&&(t=o);let n=t/o,l=n>1?100/n:100,c=n>1?100:100*n,h=50-l/2,u=50-c/2;this.cropRegion.setStyles({left:`${h}%`,top:`${u}%`,width:`${l}%`,height:`${c}%`}),this.updateCropVeil(),this.updateCropData()},this.updateCropVeil=function(){let t=parseFloat(this.cropRegion.style.left.replace("%","")),r=parseFloat(this.cropRegion.style.top.replace("%","")),a=parseFloat(this.cropRegion.style.width.replace("%","")),s=parseFloat(this.cropRegion.style.height.replace("%",""));this.cropVeilT.setStyles({bottom:`${100-r}%`}),this.cropVeilB.setStyles({top:`${r+s}%`}),this.cropVeilL.setStyles({top:`${r}%`,bottom:`${100-r-s}%`,right:`${100-t}%`}),this.cropVeilR.setStyles({top:`${r}%`,bottom:`${100-r-s}%`,left:`${t+a}%`})},this.updateCropData=function(){let t=Math.max(0,Math.min(1,parseFloat(this.cropRegion.style.left.replace("%",""))/100)),r=Math.max(0,Math.min(1,parseFloat(this.cropRegion.style.top.replace("%",""))/100)),a=Math.max(0,Math.min(1,parseFloat(this.cropRegion.style.width.replace("%",""))/100)),s=Math.max(0,Math.min(1,parseFloat(this.cropRegion.style.height.replace("%",""))/100)),{cropData:o}=this.batchImageVO;o.x=Math.round(t*this.batchImageVO.imageW),o.y=Math.round(r*this.batchImageVO.imageH),o.width=Math.round(a*this.batchImageVO.imageW),o.height=Math.round(s*this.batchImageVO.imageH)},this.destroy=function(){if(this.parentNode){this.parentNode.removeChild(this),this.image.setStyles({background:""}),this.imageOverlay.setStyles({background:""});try{this.batchImageVO.thumbTexture.destroyGC(!0)}catch(t){}this.batchImageVO.thumbTexture=null,this.batchImageVO.thumbSRC&&(URL.revokeObjectURL(this.batchImageVO.thumbSRC),this.batchImageVO.thumbSRC=null),this.batchImageVO=null}},this.addCropVeil=function(t,r){let a=document.createElement("div");return a.addClass("batch-item__crop-veil"),a.addClass(r),t.appendChild(a),a},this.addCropRegion=function(t){let r=document.createElement("div");r.addClass("batch-item__crop-region"),r.imageItem=this,r.container=t,r.region=r,t.appendChild(r);let a=["top","middle","bottom"];return["left","center","right"].forEach(o=>{let n=document.createElement("div");n.addClass("batch-item__crop-region-column"),r.appendChild(n),a.forEach(l=>{if(!(l==="middle"&&o==="center")){let c=document.createElement("div");c.addClass("batch-item__crop-region-handle"),c.addClass(l),c.addClass(o),c.handleID=`${l}_${o}`,c.handleType=l==="middle"||o==="center"?"side":"corner",c.imageItem=this,c.container=t,c.region=r,n.appendChild(c)}})}),r},this.init()}.bind(i)();BFN.UI.batchProcessingModal=i=>function(){this.init=function(){this.initDefaultValues(),this.initSaveModal()},this.initDefaultValues=function(){this.scrollContainerHeight=0,this.imagesPerRow=0,this.imageItemSize=BFN.BatchProcessingManager.itemSize,this.toolButtonData=[],this.menu=this.querySelector(".batch-processing__menu"),[this.menuToolsSection,this.menuControlsSection]=[...this.querySelectorAll(".batch-processing__menu-section")],this.selectedToolButtonList=this.querySelector(".batch-processing__tool-list"),this.selectedToolButtonList.innerHTML="",BFN.UI.sortableList(this.selectedToolButtonList),this.selectedToolButtonList.addEventListener("LIST_ORDER_UPDATED",this.handlePrimaryButtonListOrderUpdated.bind(this)),this.controlsHeader=this.querySelector(".batch-processing__controls-header"),this.controlsContainer=this.querySelector(".batch-processing__controls-container"),this.controlsCancelApplyButtons=document.getElementById("batch_processing_apply_cancel_menu"),this.batchDynamicControls=this.controlsContainer.querySelector("#batch_dynamic_controls"),this.navbar=this.querySelector(".batch-processing__navbar"),this.clearButton=document.getElementById("batch_processing_clear_images"),this.saveButton=document.getElementById("batch_processing_save_images"),this.imageItems=[],this.imagesContainer=this.querySelector(".batch-processing__images-container"),this.scrollContainer=document.getElementById("batch_processing_images_scroll_container"),BFN.UI.scrollStopDispatcher(this.scrollContainer,()=>{BFN.BatchProcessingManager.processVisibleImageItems()}),this.scrollContainer.addEventListener("scroll",e=>{BeFunky.isLoadScreenActive()&&(e.stopImmediatePropagation(),e.preventDefault())},!0),this.dragDropArea=document.getElementById("batch_processing_drag_drop_area"),this.updateImageItems(),this.maxWidth=80*16,this.maxHeight=50*16,BFN.HelpClueManager.setup("batch_processing",{side:"top",positionFactor:.89,left:"auto",right:"3.9rem",top:"2.75rem",zIndex:"1",container:this.querySelector(".popover-placeholder")})},this.initSaveModal=function(){this.saveModal=document.getElementById("batch_processing_save");let[e,t]=[...this.saveModal.querySelectorAll(".modal__button")];e.addEventListener("click",()=>BeFunky.closeModal(this.saveModal)),t.addEventListener("click",()=>{BeFunky.closeModal(this.saveModal),BFN.BatchProcessingManager.saveImages()})},this.open=function(){BeFunky.openModal(this,{closeOnClickOutside:!1,onOpen:()=>{BFN.AppModel.viewingEditor&&BFN.PhotoEditorCanvasModel.viewState!==BFN.PhotoEditorCanvasModelViewStates.VIEWING_CANVAS&&BFN.PhotoEditorCanvasModel.exitCurrentEditorTool(),BFN.retrievePresetThumbHelperGraphics("effect"),UITools.setToolValue("batch_processing","section",null,!1),UITools.applyToolControl("batch_processing_section"),this.showWalkthrough()},onClose:()=>{UITools.setToolValue("batch_processing","section",null,!1),UITools.applyToolControl("batch_processing_section")},closeOnEscape:()=>UITools.getToolValue("batch_processing","section")?(UITools.setToolValue("batch_processing","section",null,!1),UITools.applyToolControl("batch_processing_section"),!1):!0,onWindowResize:this.updateModalSize.bind(this),size:"xxl"})},this.close=function(){BeFunky.closeModal(this)},this.showWalkthrough=function(){BFN.HelpClueManager.setup("batch_upload",{side:"top",top:"1.5rem",left:"-3.5rem",zIndex:"1",container:()=>document.getElementById("batch_upload_placeholder")}),BFN.HelpClueManager.setup("batch_edit",{side:"left",positionFactor:0,top:"2.5rem",left:"-1.25rem",zIndex:"1",container:()=>document.getElementById("batch_edit_placeholder")}),BFN.HelpClueManager.showWalkthrough(["batch_upload","batch_edit"])},this.updateToolButtons=function(e){e&&(this.toolButtonData.forEach(t=>{e.includes(t)||t.button.parentNode.removeChild(t.button)}),e.forEach(t=>{this.toolButtonData.includes(t)||t.button||(t.button=this.createToolButton(t.id,t.name))}),this.toolButtonData.splice(0),this.toolButtonData.push(...e),this.toolButtonData.forEach(t=>{t.button.string.textContent=BeFunky.LanguageManager.getString(t.name),this.selectedToolButtonList.appendChild(t.button)}),this.selectedToolButtonList.refreshList())},this.createToolButton=function(e,t=null){let r=document.createElement("div").setClass("batch-processing__tool-button-row sortable-list__item");r.dataset.batchId=e;let a=document.createElement("button").setClass("button button--grey-200 batch-processing__open-tool");t=t||e;let s=document.createElement("string").setLang(t);a.appendChild(s),r.string=s,a.addEventListener("click",()=>{UITools.setToolValue("batch_processing","section",e,!1),UITools.applyTool("batch_processing")});let o=document.createElement("button").setClass("button button--grey-200 button--icon batch-processing__remove-tool"),n='<svg class="icon icon--10"><use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="#cancel-icon"></use></svg>';return o.innerHTML=n,o.addEventListener("click",()=>{BFN.BatchToolManager.selectedIDs=BFN.BatchToolManager.selectedIDs.filter(l=>l!==e)}),r.appendChild(a),r.appendChild(o),r},this.showControls=function(e=null,t=null){if(e){this.controlsHeader.langId=t||e;let r=`batch_${e}_controls`;[...this.controlsContainer.querySelectorAll(".control-item-set")].forEach(s=>{let o=s.id===r;s.setStyles({display:o?"block":"none"}),o&&s.appendChild(this.controlsCancelApplyButtons)}),this.menu.addClass("slide"),this.menuToolsSection.addClass("focus-avoid"),this.menuControlsSection.removeClass("focus-avoid")}else this.menu.removeClass("slide"),this.menuToolsSection.removeClass("focus-avoid"),this.menuControlsSection.addClass("focus-avoid")},this.setDynamicControls=function(e,t){if(!e||!t)return!1;for(;this.batchDynamicControls.lastChild;)this.batchDynamicControls.removeChild(this.batchDynamicControls.lastChild);delete this.batchDynamicControls.buttonContainer;let r="batch_effect";UITools.removeToolVO(r);let a=UITools.createToolVO(r);return a.toolID=t,e.forEach(s=>{let o=s.controlID.replace("batch_effect_",""),n=s.controlParamObject,{controlID:l}=s,c=n.type;UITools.toolControlIDs[r].push(l),UITools.controlToolIDs[l]=r,UITools.controlParamObjects[l]=n;let h=n.hasOwnProperty("defaultValue")?n.defaultValue:!1;switch(UITools.setToolValue(r,o,h),c){case"color":case"color_item":case"color_palette":n.hasOwnProperty("intensityEnabled")&&n.intensityEnabled&&UITools.setToolValue(r,`${n.name}_intensity`,1);break}a.defaultValues[o]=h}),a.updating_id=null,UITools.setupControlItems(e,this.batchDynamicControls),e.forEach(s=>{UITools.registerControl(s.controlID)}),!0},this.setResizeMode=function(e){let t=`batch_resize_${e}_controls`;[...this.controlsContainer.querySelectorAll(".batch-resize-control-container")].forEach(a=>{a.setStyles({display:a.id===t?"block":"none"})})},this.addBatchImage=function(e=null){if(!e)return;let t=document.createElement("div");return BFN.UI.batchProcessingImageItem(t,e),this.updateImageItemSize(t),this.imagesContainer.appendChild(t),this.toggleDragArea(!1),t},this.updateImageItemSize=function(e=null){e&&e.setStyles({width:`${this.imageItemSize}px`,height:`${this.imageItemSize}px`})},this.openSaveDialog=function(){BeFunky.openModal(this.saveModal,{closeOnClickOutside:!1,size:"extra-small"}),BFN.WatermarkManager.activate();let e=this.getImageItems();if(e.length){let t=e[0].batchImageVO.imageBlob;BFN.TextureUtils.blobOrBase64ToTexture(t,({texture:r})=>{let a=this.saveModal.querySelector(".watermark-control");a.sourceTexture=r},{textureSize:BFN.maxImageSize})}},this.toggleDragArea=function(e){this.dragDropArea.toggleClass("drag-drop-area--initial",e)},this.updateImageItems=function(){this.imageItems.splice(0),this.imageItems.push(...this.imagesContainer.querySelectorAll(".batch-item")),this.clearButton.setStyles({display:this.imageItems.length?"block":"none"}),this.saveButton.disabled=!this.imageItems.length,this.toggleDragArea(!this.imageItems.length)},this.getImageItems=function(){return[...this.imageItems]},this.getVisibleImageItems=function(){let e=[];return this.getImageItems().forEach((r,a)=>{let s=16,o=8,n=Math.floor(a/this.imagesPerRow)*(this.imageItemSize+o)+s-this.scrollContainer.scrollTop,l=n+this.imageItemSize;(n>0&&n<this.scrollContainerHeight||l>0&&l<this.scrollContainerHeight)&&e.push(r)}),e},this.getTotalImageBytes=function(){let e=0;return this.getImageItems().forEach(({batchImageVO:r})=>{r.imageBlob&&(e+=r.imageBlob.size)}),e},this.handleClose=()=>{this.close()},this.updateModalSize=({availableWidth:e,availableHeight:t})=>{let r=17*16,a=24,s=e-r-a*2;this.scrollContainer.style.setProperty("--scrollable-content-width",`${s}px`),this.imagesPerRow=Math.ceil(s/(BFN.BatchProcessingManager.itemSize+8)),this.imagesContainer.setStyles({gridTemplateColumns:`repeat(${this.imagesPerRow}, 1fr)`});let o=(this.imagesPerRow-1)*8;this.imageItemSize=Math.floor((s-o)/this.imagesPerRow),this.getImageItems().forEach(h=>{this.updateImageItemSize(h)});let l=56,c=48;this.scrollContainerHeight=t-l-c},this.handlePrimaryButtonListOrderUpdated=()=>{let e=this.selectedToolButtonList.listItems.map(t=>t.dataset.batchId);BFN.BatchToolManager._selectedIDs.splice(0),BFN.BatchToolManager._selectedIDs.push(...e),BFN.SettingsManager.updateSetting("batch_processing_fav",e.slice())},this.init()}.bind(i)();BFN.UI.checkboxItem=(i,{controlID:e,paramObject:{name:t,description:r,checkboxColor:a}})=>function(){this.datasetClone=this.dataset,this.outerHTML=`
        <div class="checkbox ${a?`checkbox--${a}`:""}">
            <input type="checkbox" id="${e}">
                <label class="checkbox__label" for="${e}">
                <span class="checkbox__box checkbox__box--sm">
                    <svg class="icon checkbox__icon icon--12">
                        <use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="#checkmark-icon"></use>
                    </svg>
                </span>
                <string data-lang="${t}">${BeFunky.LanguageManager.getString(t)}</string>
            </label>
            ${r?`<p class="checkbox__description" data-lang="${r}">${BeFunky.LanguageManager.getString(r)}</p>`:""}
        </div>
    `,this.init=function(){Object.assign(document.getElementById(e).dataset,this.datasetClone),UITools.registerCheckBoxControl(e)},this.init()}.bind(i)();BFN.UI.colorButton=(i,e=!1,t=!0)=>function(){this.addClass("color-button"),this.innerHTML=t?`<span class="color-button__triangle"></span>
        <div class="color-button-border">${e?"<string></string>":""}</div>`:`<div class="color-button-border">${e?"<string></string>":""}</div>`,this.init=function(){this.initDefaultValues(),this.updateButtonDisplay()},this.initDefaultValues=function(){this._color=-1,this._hashColor=-1,this._isMixed=!1,this._intensity=1,this._intensityEnabled=!1,this._emptyEnabled=!0,this._resetColorEnabled=!1,this._mixedColorEnabled=!1,this._borderEnabled=!1,this._fineChangeEnabled=!1,this._pickerName=null,e&&(this.innerString=this.querySelector("string")),this.emptyButtonClasses=["button","button--has-icon","button--grey-200","empty"],this.buttonDisplayUpdatedEvent=new Event("button_display_updated")},this.updateButtonDisplay=()=>requestAnimationFrame(()=>{this.removeClass("color-button--mixed"),this.hashColor===-1&&!this._isMixed?(this.classList.add(...this.emptyButtonClasses),this.innerHTML='<svg class="icon icon--18s"><use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="#no-color-icon"></use></svg>'):(this.classList.remove(...this.emptyButtonClasses),this.innerHTML=t?`<span class="color-button__triangle"></span>
                <div class="color-button-border">${e?"<string></string>":""}</div>`:`<div class="color-button-border">${e?"<string></string>":""}</div>`,this._isMixed&&!this.hasClass("color-button--mixed")&&(this.appendChild(document.createElement("div").setClass("color-button--dash")),this.addClass("color-button--mixed"))),this.setStyles({backgroundColor:this._isMixed?"var(--secondary-000)":this.hashColor===-1?"":`#${this.hashColor}`}),this.dispatchEvent(this.buttonDisplayUpdatedEvent)}),Object.defineProperty(this,"color",{set(r){this._color===r&&!this._isMixed||(this._color=r,this._hashColor=r===-1?-1:BFN.ColorUtil.hexNumberToHexString(r),this._hashColor==="0"&&(this._hashColor="000"),this._isMixed=!1,this.updateButtonDisplay())},get(){return this._color}}),Object.defineProperty(this,"hashColor",{set(r){this._hashColor===r&&!this._isMixed||(e&&(this.innerString.innerHTML=r),this._hashColor=r,this._color=r===-1?-1:parseInt(`0x${r}`),this._isMixed=!1,this.updateButtonDisplay())},get(){return this._hashColor}}),Object.defineProperty(this,"isMixed",{set(r){this._isMixed!==r&&(this._isMixed=r,this.updateButtonDisplay())},get(){return this._isMixed}}),Object.defineProperty(this,"intensity",{set(r){this._intensity=r},get(){return this._intensity}}),Object.defineProperty(this,"intensityEnabled",{set(r){this._intensityEnabled=r},get(){return this._intensityEnabled}}),Object.defineProperty(this,"emptyEnabled",{set(r){this._emptyEnabled=r},get(){return this._emptyEnabled}}),Object.defineProperty(this,"resetColorEnabled",{set(r){this._resetColorEnabled=r},get(){return this._resetColorEnabled}}),Object.defineProperty(this,"mixedColorEnabled",{set(r){!r||(this.displayMixedColorButton(),this._mixedColorEnabled=r)},get(){return this._mixedColorEnabled}}),Object.defineProperty(this,"borderEnabled",{set(r){this._borderEnabled!==r&&(this._borderEnabled=r,this.addClass("color-button-picker"))},get(){return this._borderEnabled}}),Object.defineProperty(this,"fineChangeEnabled",{set(r){this._fineChangeEnabled=r},get(){return this._fineChangeEnabled}}),Object.defineProperty(this,"pickerName",{set(r){this._pickerName=r},get(){return this._pickerName}}),this.init()}.bind(i)();BFN.UI.colorItem=(i,{controlID:e,paramObject:{name:t,colorExistsButtonID:r=null}})=>function(){this.outerHTML=`
            <div id="${e}_color_container" class="color-item">
                <label class="control-item-label" data-lang="${t}">
                    ${BeFunky.LanguageManager.getString(t)}
                </label>
                ${r?'<span class="color-exists-button-placeholder"></span>':""}
                <button id="${e}"></button>
            </div>
        `,this.init=function(){let a=document.getElementById(`${e}_color_container`),s=document.getElementById(e);if(UITools.registerColorControl(e),r){let n=document.getElementById(r);n&&(s.colorExistsButton=n,a.querySelector(".color-exists-button-placeholder").appendChild(n),o())}s.addEventListener("button_display_updated",o);function o(){s.colorExistsButton&&s.colorExistsButton.setStyles({display:s.color==-1?"none":"block"})}},this.init()}.bind(i)();BFN.UI.colorPalette=(i,{controlID:e,paramObject:{name:t,defaultValue:r,colors:a=null,presetsOnly:s=!1,useLabel:o=!1,displayValues:n=!1,styleOverrides:l=null}})=>function(){if(this.setAttribute("id",`${e}_color_container`),o){let c=`
        <label class="control-item-label" style="margin-bottom: 0.75rem;" data-lang="${t}">
            ${BeFunky.LanguageManager.getString(t)}
        </label>
        `;this.insertAdjacentHTML("beforebegin",c)}this.init=function(){if(this.colorPresetButtons=[],!a)return;let c=new Event("change"),h=0;a.forEach((u,d)=>{let m=document.createElement("div").addClass("color-button-row");this.appendChild(m),d===0&&(this.colorButton=document.createElement("button"),this.colorButton.id=e,this.colorButton.hashColor=r,this.colorButton.presetButtons=this,this.colorButton.addEventListener("change",()=>this.updateColorPresetButtons()),s&&this.colorButton.setStyles({display:"none"}),m.appendChild(this.colorButton),UITools.registerColorControl(e,this.colorButton)),u.filter(Boolean).forEach((p,g)=>{let f=document.createElement("button").addClass("color-button--preset");f.id=`${e}_preset_${++h}`,BFN.UI.colorButton(f,n,!1),f.addEventListener("click",v=>{this.colorButton.hashColor=v.currentTarget.hashColor,this.colorButton.dispatchEvent(c)}),f.hashColor=p,f.emptyEnabled=p===-1,l&&(l.global&&f.setStyles(l.global),l.unique&&l.unique[d]&&l.unique[d][g]&&f.setStyles(l.unique[d][g])),this.colorPresetButtons.push(f),m.appendChild(f)})}),this.updateColorPresetButtons()},this.updateColorPresetButtons=function(){this.colorPresetButtons.forEach(c=>{c.toggleClass("color-button--selected",c.color===this.colorButton.color)})},this.hexToRGB=function(c){let h=c>>16&255,u=c>>8&255,d=c&255;return[h,u,d]},this.init()}.bind(i)();BFN.UI.colorGroup=(i,{controlID:e,paramObject:{name:t,defaultValue:r,colorGroupData:a=null,useLabel:s=!1,intensityEnabled:o=!1,intensityWhileTransparent:n=!1,emptyEnabled:l=!1,resetColorEnabled:c=!0,hueLocked:h=!1,fineChangeEnabled:u=!1,colorsPerRow:d=5,maxVisibleRows:m=2,rowMarginAdjustment:p=12}})=>function(){let g=new Event("change"),f=new Event("finechange"),v=`
        <label class="control-item-label" style="margin-bottom: 0.75rem;" data-lang="${t}">
            ${BeFunky.LanguageManager.getString(t)}
        </label>
    `;this.setAttribute("id",`${e}_color_container`);let T=m*31+(m-1)*p+Math.min(2,m)*2;this.setStyles({overflowY:"auto",overflowX:"hidden",maxHeight:`${T}px`}),s&&this.insertAdjacentHTML("beforebegin",v),this.init=function(){this.colorButtons=[],this.colorButtonPool=[],this.colorButtonPlaceholders=[],this.colorButtonPlaceholderPool=[],this.colorButtonRows=[],this.colorButtonRowPool=[],this.masterColorButton=document.createElement("button"),this.masterColorButton.id=e,this.masterColorButton.setStyles({display:"none",width:"2rem",height:"2rem"}),this.masterColorButton.colorGroup=this,this.appendChild(this.masterColorButton),UITools.registerColorControl(e),this.setColorGroupData(a)},this.setColorGroupData=function(x){if(this.resetColorGroup(),!(x&&x.length))return;x.forEach(y=>{if(y.hasOwnProperty("color")){let F=this.getColorButton();F.index=this.colorButtons.length,F.groupID=y.hasOwnProperty("id")?y.id:F.index,F.pickerName=`${BeFunky.LanguageManager.getString("color")} # ${F.index+1}`,F.hashColor=y.color,F.intensity=o&&y.hasOwnProperty("intensity")?Math.max(0,Math.min(1,y.intensity)):1,this.colorButtons.push(F)}});let B=null;if(this.colorButtons.forEach(y=>{y.index%d==0&&(B=this.getColorButtonRow(),B.colorsNum=0,this.colorButtonRows.push(B),this.appendChild(B)),B.colorsNum++,B.appendChild(y)}),B)for(let y=B.colorsNum;y<d;y++){let F=this.getColorButtonPlaceholder();this.colorButtonPlaceholders.push(F),B.appendChild(F)}},this.resetColorGroup=function(){this.colorButtons.forEach(x=>{x.parentElement.removeChild(x)}),this.colorButtonPool.push(...this.colorButtons),this.colorButtons.splice(0),this.colorButtonPlaceholders.forEach(x=>{x.parentElement.removeChild(x)}),this.colorButtonPlaceholderPool.push(...this.colorButtonPlaceholders),this.colorButtonPlaceholders.splice(0),this.colorButtonRows.forEach(x=>{x.parentElement.removeChild(x)}),this.colorButtonRowPool.push(...this.colorButtonRows),this.colorButtonRows.splice(0)},this.getColorButton=function(){return this.colorButtonPool.shift()||this.createColorButton()},this.createColorButton=function(){let x=document.createElement("button");return BFN.UI.colorButton(x),x.intensityEnabled=o,x.intensityWhileTransparent=n,x.emptyEnabled=l,x.resetColorEnabled=c,x.hueLocked=h,x.borderEnabled=!0,x.fineChangeEnabled=u,x.addEventListener("click",B=>{let y=B.currentTarget,F=UITools.controlToolIDs[e],b=e.replace(`${F}_`,"");UITools.setToolValue(F,`${b}_index`,y.index),UITools.setToolValue(F,`${b}_group_id`,y.groupID),BFN.ColorPickerPanel.colorButton=y}),x.addEventListener("change",B=>{let y=B.currentTarget;this.masterColorButton.hashColor=y.hashColor,o&&(this.masterColorButton.intensity=y.intensity),this.masterColorButton.dispatchEvent(g)}),u&&x.addEventListener("finechange",B=>{let y=B.currentTarget;this.masterColorButton.hashColor=y.hashColor,o&&(this.masterColorButton.intensity=y.intensity),this.masterColorButton.dispatchEvent(f)}),x},this.getColorButtonPlaceholder=function(){return this.colorButtonPlaceholderPool.shift()||this.createColorButtonPlaceholder()},this.createColorButtonPlaceholder=function(){return document.createElement("div").setStyles({width:"2rem",height:"2rem"})},this.getColorButtonRow=function(){return this.colorButtonRowPool.shift()||this.createColorButtonRow()},this.createColorButtonRow=function(){return document.createElement("div").addClass("color-button-row")},this.init()}.bind(i)();BFN.UI.colorPickerHSV=i=>function(){this.addClass("color-picker__hsv"),this.innerHTML=`
        <div class="color-picker__hsv-sv">
            <div class="color-picker__hsv-sv-indicator">
                <div class="color-picker__hsv-sv-indicator-display"></div>
            </div>
        </div>
        <div class="color-picker__hsv-h">
            <div class="color-picker__hsv-h-indicator">
                <div class="color-picker__hsv-h-indicator-display"></div>
            </div>
        </div>
    `,this.init=function(){this.initDefaultValues(),this.initPickerHSV(),this.updateIndicators()},this.initDefaultValues=function(){this._color=16711680,this.h=0,this.s=1,this.v=1,this.updating=!1,this.baseRect={width:0,height:0,left:0,top:0,right:0,bottom:0},this.gridWidth=212,this.gridHeight=118,this.changeEvent=new Event("change")},this.initPickerHSV=function(){function e(s,o,n){let l=document.createElementNS("http://www.w3.org/2000/svg",s);for(let u in o)l.setAttribute(u,o[u]);l.classList.add("color-picker__hsv-gradient"),Object.prototype.toString.call(n)!=="[object Array]"&&(n=[n]);let c=0,h=n[0]&&n.length||0;for(;c<h;c++)l.appendChild(n[c]);return l}let t={xmlns:"http://www.w3.org/2000/svg",version:"1.1",width:"100%",height:"100%",oncontextmenu:"return false"},r=e("svg",t,[e("defs",{},e("linearGradient",{id:"gradient-hsv",x1:"100%",y1:"0%",x2:"0%",y2:"0%"},[e("stop",{offset:"0%","stop-color":"#FF0000","stop-opacity":"1"}),e("stop",{offset:"16.7%","stop-color":"#FF00FF","stop-opacity":"1"}),e("stop",{offset:"33.3%","stop-color":"#0000FF","stop-opacity":"1"}),e("stop",{offset:"50%","stop-color":"#00FFFF","stop-opacity":"1"}),e("stop",{offset:"66.7%","stop-color":"#00FF00","stop-opacity":"1"}),e("stop",{offset:"83.3%","stop-color":"#FFFF00","stop-opacity":"1"}),e("stop",{offset:"100%","stop-color":"#FF0000","stop-opacity":"1"})])),e("rect",{x:"0",y:"0",width:"100%",height:"100%",fill:"url(#gradient-hsv)"})]);this.pickerH=this.querySelector(".color-picker__hsv-h"),this.pickerH.appendChild(r),this.pickerH.addEventListener(BeFunky.pointerdown,this.handlePickerHPressed),this.pickerH.addEventListener("dragstart",s=>s.preventDefault()),this.pickerIndicatorH=this.querySelector(".color-picker__hsv-h-indicator"),this.pickerIndicatorDisplayH=this.querySelector(".color-picker__hsv-h-indicator-display");let a=e("svg",t,[e("defs",{},[e("linearGradient",{id:"gradient-black",x1:"0%",y1:"100%",x2:"0%",y2:"0%"},[e("stop",{offset:"0%","stop-color":"#000000","stop-opacity":"1"}),e("stop",{offset:"100%","stop-color":"#000000","stop-opacity":"0"})]),e("linearGradient",{id:"gradient-white",x1:"0%",y1:"100%",x2:"100%",y2:"100%"},[e("stop",{offset:"0%","stop-color":"#FFFFFF","stop-opacity":"1"}),e("stop",{offset:"100%","stop-color":"#FFFFFF","stop-opacity":"0"})])]),e("rect",{x:"-1%",y:"-1%",width:"102%",height:"102%",fill:"url(#gradient-white)"}),e("rect",{x:"-1%",y:"-1%",width:"102%",height:"102%",fill:"url(#gradient-black)"})]);this.pickerSV=this.querySelector(".color-picker__hsv-sv"),this.pickerSV.appendChild(a),this.pickerSV.addEventListener(BeFunky.pointerdown,this.handlePickerSVPressed),this.pickerSV.addEventListener("dragstart",s=>s.preventDefault()),this.pickerIndicatorSV=this.querySelector(".color-picker__hsv-sv-indicator"),this.pickerIndicatorDisplaySV=this.querySelector(".color-picker__hsv-sv-indicator-display"),this.pickerIndicatorDisplaySV.addEventListener(BeFunky.pointerdown,s=>{this.handlePickerSVPressed(s),s.stopPropagation()})},this.setColor=function(e){this._color=e;let t=this.hex2hsv(e);this.h=t.h,this.s=t.s,this.v=t.v,this.updateIndicators()},this.updateColor=function(){this._color=parseInt(this.hsv2rgb({h:this.h,s:this.s,v:this.v}).hex.replace("#",""),16)},this.updateIndicators=(e=!0)=>{cancelAnimationFrame(this.updateIndicatorsAF),this.updateIndicatorsAF=requestAnimationFrame(()=>{if(e){let s=this.hsv2rgb({h:this.h,s:1,v:1}).hex;this.pickerIndicatorDisplayH.setStyles({backgroundColor:s}),this.pickerSV.setStyles({backgroundColor:s}),this.pickerIndicatorH.setStyles({transform:`translateX(${Math.round(this.h/360*this.gridWidth)}px)`})}let t={width:this.gridWidth,height:this.gridHeight},r=Math.round(this.s*t.width),a=Math.round((1-this.v)*t.height);this.pickerIndicatorSV.setStyles({transform:`translateX(${r}px) translateY(${a}px)`}),this.pickerIndicatorDisplaySV.setStyles({backgroundColor:`#${this.hashColor}`})})},this.hsv2rgb=function({h:e,s:t,v:r}){let a,s,o,n,l;e=e%360/60,l=r*t,n=l*(1-Math.abs(e%2-1)),a=s=o=r-l,e=~~e,a+=[l,n,0,0,n,l][e],s+=[n,l,l,n,0,0][e],o+=[0,0,n,l,l,n][e];let c=Math.floor(a*255),h=Math.floor(s*255),u=Math.floor(o*255);return{r:c,g:h,b:u,hex:`#${(16777216|u|h<<8|c<<16).toString(16).slice(1)}`}},this.rgb2hsv=function({r:e,g:t,b:r}){(e>1||t>1||r>1)&&(e/=255,t/=255,r/=255);let a,s,o,n;return o=Math.max(e,t,r),n=o-Math.min(e,t,r),a=n===0?null:o===e?(t-r)/n+(t<r?6:0):o===t?(r-e)/n+2:(e-t)/n+4,a=a%6*60,s=n===0?0:n/o,{h:a,s,v:o}},this.hex2rgb=function(e){return{r:e>>16&255,g:e>>8&255,b:e&255}},this.hex2hsv=function(e){return this.rgb2hsv(this.hex2rgb(e))},this.handlePickerHPressed=e=>{document.addEventListener(BeFunky.pointermove,this.handlePickerHMove),document.addEventListener(BeFunky.pointerup,this.handlePickerHReleased);let t=this.pickerH.getBoundingClientRect();this.baseRect.width=0,this.baseRect.height=t.height,this.baseRect.left=t.left,this.baseRect.top=t.top,this.updating=!0,this.handlePickerHMove(e,!1)},this.handlePickerSVPressed=e=>{document.addEventListener(BeFunky.pointermove,this.handlePickerSVMove),document.addEventListener(BeFunky.pointerup,this.handlePickerSVReleased);let t=this.pickerSV.getBoundingClientRect();this.baseRect.width=t.width,this.baseRect.height=t.height,this.baseRect.left=t.left,this.baseRect.top=t.top,this.updating=!0,this.handlePickerSVMove(e,!1)},this.handlePickerHMove=(e,t=!0)=>{let r=Math.max(0,Math.min(this.offsetWidth,e.pageX-this.baseRect.left));this.h=r/this.offsetWidth*360,this.updateColor(),this.updateIndicators(),t?this.throttleDispatchChangeEvent():this.dispatchEvent(this.changeEvent)},this.handlePickerSVMove=(e,t=!0)=>{let r=Math.max(0,Math.min(this.baseRect.width,e.clientX-this.baseRect.left)),a=Math.max(0,Math.min(this.baseRect.height,e.clientY-this.baseRect.top));this.s=r/this.baseRect.width,this.v=1-a/this.baseRect.height,this.updateColor(),this.updateIndicators(!1),t?this.throttleDispatchChangeEvent():this.dispatchEvent(this.changeEvent)},this.throttleDispatchChangeEvent=BeFunky.throttle(()=>requestAnimationFrame(()=>{this.updating&&this.dispatchEvent(this.changeEvent)}),33,!0),this.handlePickerHReleased=()=>{document.removeEventListener(BeFunky.pointermove,this.handlePickerHMove),document.removeEventListener(BeFunky.pointerup,this.handlePickerHReleased),this.updating=!1,this.dispatchEvent(this.changeEvent)},this.handlePickerSVReleased=()=>{document.removeEventListener(BeFunky.pointermove,this.handlePickerSVMove),document.removeEventListener(BeFunky.pointerup,this.handlePickerSVReleased),this.updating=!1,this.dispatchEvent(this.changeEvent)},Object.defineProperty(this,"color",{set(e){this.setColor(e)},get(){return this._color}}),Object.defineProperty(this,"hashColor",{get(){return(16777216|this._color).toString(16).slice(1)}}),Object.defineProperty(this,"hLocked",{set(e){e?this.pickerH.addClass("locked"):this.pickerH.removeClass("locked")},get(){return this.pickerH.hasClass("locked")}}),this.init()}.bind(i)();BFN.UI.cursorScreen=i=>function(){this.init=function(){this.initDefaultValues()},this.initDefaultValues=function(){let e=this.getNativeArrowCursor,t={arrow:"data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink' width='32' height='32'%3e %3cdefs%3e %3cpath id='b' d='M22.86 14v-3L28 16l-5.14 5v-3H9.14v3L4 16l5.14-5v3h13.72z'/%3e %3cfilter id='a' width='137.7%25' height='190.5%25' x='-18.9%25' y='-45.3%25' filterUnits='objectBoundingBox'%3e %3cfeMorphology in='SourceAlpha' operator='dilate' radius='1.18' result='shadowSpreadOuter1'/%3e %3cfeOffset in='shadowSpreadOuter1' result='shadowOffsetOuter1'/%3e %3cfeGaussianBlur in='shadowOffsetOuter1' result='shadowBlurOuter1' stdDeviation='1'/%3e %3cfeComposite in='shadowBlurOuter1' in2='SourceAlpha' operator='out' result='shadowBlurOuter1'/%3e %3cfeColorMatrix in='shadowBlurOuter1' values='0 0 0 0 0.117647059 0 0 0 0 0.125490196 0 0 0 0 0.141176471 0 0 0 0.5 0'/%3e %3c/filter%3e %3c/defs%3e %3cg fill='none' fill-rule='evenodd' transform='rotate(0 16 16)'%3e %3cuse fill='black' filter='url(%23a)' xlink:href='%23b'/%3e %3cuse fill='black' xlink:href='%23b'/%3e %3cpath stroke='white' d='M22.36 13.5V9.82L28.72 16l-6.36 6.18V18.5H9.64v3.68L3.28 16l6.36-6.18v3.68h12.72z'/%3e %3c/g%3e %3c/svg%3e",move:"data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink' width='32' height='32'%3e %3cdefs%3e %3cfilter id='a' width='142.5%25' height='142.5%25' x='-21.2%25' y='-21.2%25' filterUnits='objectBoundingBox'%3e %3cfeMorphology in='SourceAlpha' operator='dilate' radius='1.18' result='shadowSpreadOuter1'/%3e %3cfeOffset in='shadowSpreadOuter1' result='shadowOffsetOuter1'/%3e %3cfeGaussianBlur in='shadowOffsetOuter1' result='shadowBlurOuter1' stdDeviation='1'/%3e %3cfeComposite in='shadowBlurOuter1' in2='SourceAlpha' operator='out' result='shadowBlurOuter1'/%3e %3cfeColorMatrix in='shadowBlurOuter1' result='shadowMatrixOuter1' values='0 0 0 0 0.117647059 0 0 0 0 0.125490196 0 0 0 0 0.141176471 0 0 0 0.5 0'/%3e %3cfeMerge%3e %3cfeMergeNode in='shadowMatrixOuter1'/%3e %3cfeMergeNode in='SourceGraphic'/%3e %3c/feMerge%3e %3c/filter%3e %3cpath id='b' d='M14.86 20.43h1.85L13 26l-3.71-5.57h1.85v-5.57H5.57v1.85L0 13l5.57-3.71v1.85h5.57V5.57H9.3L13 0l3.71 5.57h-1.85v5.57h5.57V9.3L26 13l-5.57 3.71v-1.85h-5.57v5.57z'/%3e %3c/defs%3e %3cg fill='none' fill-rule='evenodd' filter='url(%23a)' transform='translate(3 3)'%3e %3cuse fill='black' xlink:href='%23b'/%3e %3cpath stroke='white' d='M15.36 19.93h2.29L13 26.9l-4.65-6.97h2.3v-4.57H6.06v2.29L-.9 13l6.97-4.65v2.3h4.57V6.06H8.35L13-.9l4.65 6.97h-2.3v4.57h4.58V8.35L26.9 13l-6.97 4.65v-2.3h-4.57v4.58z'/%3e %3c/g%3e %3c/svg%3e",rotateFallback:"data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink' width='32' height='32'%3e %3cdefs%3e %3cfilter id='a' width='147.9%25' height='138.7%25' x='-21.5%25' y='-21.2%25' filterUnits='objectBoundingBox'%3e %3cfeMorphology in='SourceAlpha' operator='dilate' radius='1.18' result='shadowSpreadOuter1'/%3e %3cfeOffset in='shadowSpreadOuter1' result='shadowOffsetOuter1'/%3e %3cfeGaussianBlur in='shadowOffsetOuter1' result='shadowBlurOuter1' stdDeviation='1'/%3e %3cfeComposite in='shadowBlurOuter1' in2='SourceAlpha' operator='out' result='shadowBlurOuter1'/%3e %3cfeColorMatrix in='shadowBlurOuter1' result='shadowMatrixOuter1' values='0 0 0 0 0.117647059 0 0 0 0 0.125490196 0 0 0 0 0.141176471 0 0 0 0.5 0'/%3e %3cfeMerge%3e %3cfeMergeNode in='shadowMatrixOuter1'/%3e %3cfeMergeNode in='SourceGraphic'/%3e %3c/feMerge%3e %3c/filter%3e %3cpath id='b' d='M12.8 8.36a7.5 7.5 0 1 0 5.2 7.55h3a10.5 10.5 0 1 1-8.2-10.66l-3.21-3.2L11.63 0l4.77 4.77 2.05 2.04-6.82 6.81-2.04-2.04 3.22-3.22z'/%3e %3c/defs%3e %3cg fill='none' fill-rule='evenodd' filter='url(%23a)' transform='translate(5 3)'%3e %3cuse fill='%231E2024' xlink:href='%23b'/%3e %3cpath stroke='white' d='M11.83 8.63a7 7 0 1 0 5.66 7.26l.03-.48h4l-.02.52a11 11 0 1 1-10.13-11.4L8.88 2.04 11.63-.7l4.77 4.77 2.75 2.75-7.52 7.52-2.75-2.75 2.95-2.95z'/%3e %3c/g%3e %3c/svg%3e",rotate:"data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink' width='32' height='32'%3e %3cdefs%3e %3cpath id='b' d='M27.07 16.81l1.97-1.22-.98 7.23-6.3-2.72 1.97-1.22C22.48 15.43 19.49 13 16 13c-3.5 0-6.5 2.44-7.74 5.91l1.92 1.2-6.3 2.7-.99-7.22 2.03 1.25C6.77 12.23 11.04 9 16 9c4.95 0 9.21 3.21 11.07 7.81z'/%3e %3cfilter id='a' width='134.8%25' height='164.6%25' x='-17.4%25' y='-32.3%25' filterUnits='objectBoundingBox'%3e %3cfeMorphology in='SourceAlpha' operator='dilate' radius='1.18' result='shadowSpreadOuter1'/%3e %3cfeOffset in='shadowSpreadOuter1' result='shadowOffsetOuter1'/%3e %3cfeGaussianBlur in='shadowOffsetOuter1' result='shadowBlurOuter1' stdDeviation='1'/%3e %3cfeComposite in='shadowBlurOuter1' in2='SourceAlpha' operator='out' result='shadowBlurOuter1'/%3e %3cfeColorMatrix in='shadowBlurOuter1' values='0 0 0 0 0.117647059 0 0 0 0 0.125490196 0 0 0 0 0.141176471 0 0 0 0.5 0'/%3e %3c/filter%3e %3c/defs%3e %3cg fill='none' fill-rule='evenodd' transform='rotate(0 16 16)'%3e %3cuse fill='black' filter='url(%23a)' xlink:href='%23b'/%3e %3cuse fill='black' xlink:href='%23b'/%3e %3cpath stroke='white' d='M27.3 16.08l2.38-1.48-1.22 8.94-7.78-3.36 2.43-1.5c-1.28-3.13-4.04-5.18-7.11-5.18-3.08 0-5.85 2.06-7.13 5.2l2.38 1.48-7.78 3.36-1.22-8.94 2.44 1.5C6.76 11.52 11.12 8.5 16 8.5c4.87 0 9.22 3 11.3 7.58z'/%3e %3c/g%3e %3c/svg%3e",selectLasso:"data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink' width='32' height='32'%3e %3cdefs%3e %3cpath id='b' d='M17.86 23.6c-.14.33-.39.75-.67 1.31A7.05 7.05 0 0 1 6 26.69l.6-1.33 1.9 1.14c2.4 1.37 5.4.41 6.87-1.98-1.98.57-4.02-.23-4.67-1.89-.35-.9-.22-1.9.27-2.75A6.83 6.83 0 0 1 9.5 15.7c0-4.42 4.48-8 10-8s10 3.58 10 8-4.48 8-10 8c-.56 0-1.1-.04-1.64-.1zm.53-1.96c.37.04.73.06 1.11.06 4.46 0 8-2.73 8-6s-3.54-6-8-6-8 2.73-8 6c0 .98.32 1.91.89 2.74.26-.17.55-.32.86-.43 2.1-.8 4.36 0 5.05 1.76a3 3 0 0 1 .1 1.87zm-4.7-2.45c-1.44.48-2.23 1.76-1.75 2.84.47 1.08 2.03 1.57 3.47 1.08 1.44-.48 2.23-1.76 1.75-2.84-.47-1.08-2.03-1.57-3.47-1.08z'/%3e %3cfilter id='a' width='135.7%25' height='140%25' x='-17.9%25' y='-15.2%25' filterUnits='objectBoundingBox'%3e %3cfeMorphology in='SourceAlpha' operator='dilate' radius='.9' result='shadowSpreadOuter1'/%3e %3cfeOffset dy='1' in='shadowSpreadOuter1' result='shadowOffsetOuter1'/%3e %3cfeGaussianBlur in='shadowOffsetOuter1' result='shadowBlurOuter1' stdDeviation='1'/%3e %3cfeComposite in='shadowBlurOuter1' in2='SourceAlpha' operator='out' result='shadowBlurOuter1'/%3e %3cfeColorMatrix in='shadowBlurOuter1' values='0 0 0 0 0.117647059 0 0 0 0 0.125490196 0 0 0 0 0.141176471 0 0 0 0.5 0'/%3e %3c/filter%3e %3cpath id='d' d='M2.5 2.5l7 2.5L6 6 4.5 9.5z'/%3e %3cfilter id='c' width='235.3%25' height='232.9%25' x='-66.4%25' y='-52.1%25' filterUnits='objectBoundingBox'%3e %3cfeMorphology in='SourceAlpha' operator='dilate' radius='1.05' result='shadowSpreadOuter1'/%3e %3cfeOffset dy='1' in='shadowSpreadOuter1' result='shadowOffsetOuter1'/%3e %3cfeGaussianBlur in='shadowOffsetOuter1' result='shadowBlurOuter1' stdDeviation='1'/%3e %3cfeComposite in='shadowBlurOuter1' in2='SourceAlpha' operator='out' result='shadowBlurOuter1'/%3e %3cfeColorMatrix in='shadowBlurOuter1' values='0 0 0 0 0.117647059 0 0 0 0 0.125490196 0 0 0 0 0.141176471 0 0 0 0.5 0'/%3e %3c/filter%3e %3c/defs%3e %3cg fill='none' fill-rule='evenodd'%3e %3cg fill-rule='nonzero'%3e %3cuse fill='black' filter='url(%23a)' xlink:href='%23b'/%3e %3cuse fill='black' fill-rule='evenodd' xlink:href='%23b'/%3e %3cpath stroke='white' d='M18.16 24.13a14.97 14.97 0 0 1-.53 1.01 7.55 7.55 0 0 1-11.98 1.9l-.25-.24.98-2.16.48.3c.9.55 1.53.92 1.89 1.13a4.52 4.52 0 0 0 5.45-.87c-1.76.04-3.36-.86-3.96-2.39a3.6 3.6 0 0 1 .14-2.89A7.27 7.27 0 0 1 9 15.7c0-4.72 4.72-8.5 10.5-8.5S30 10.98 30 15.7c0 4.72-4.72 8.5-10.5 8.5-.45 0-.9-.02-1.34-.07zm.82-2.94l.52.01c4.17 0 7.5-2.52 7.5-5.5s-3.33-5.5-7.5-5.5-7.5 2.52-7.5 5.5c0 .71.19 1.41.56 2.07.16-.09.34-.16.51-.23 2.34-.88 4.9.01 5.7 2.05.2.51.27 1.05.21 1.6zm-5.13-1.53c-1.19.4-1.8 1.39-1.45 2.17.36.82 1.63 1.22 2.85.8 1.19-.4 1.8-1.38 1.45-2.16-.36-.82-1.63-1.22-2.85-.8z'/%3e %3c/g%3e %3cuse fill='black' filter='url(%23c)' xlink:href='%23d'/%3e %3cuse fill='black' xlink:href='%23d'/%3e %3cpath stroke='white' d='M6.37 6.42L4.4 10.99 1.75 1.7l9.38 3.35-4.76 1.37z'/%3e %3c/g%3e %3c/svg%3e",selectPolygon:"data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink' width='32' height='32'%3e %3cdefs%3e %3cpath id='b' d='M17.63 22.9c-.52 1.24-1 2.25-1.44 3.01-2.07 3.57-6.35 4.8-9.75 2.86A7.01 7.01 0 0 1 5 27.7l.6-1.33 1.9 1.14c2.4 1.37 5.4.41 6.87-1.98-1.98.57-4.02-.23-4.67-1.89a3.32 3.32 0 0 1 .8-3.46v-7.71l8.45 2.33L29.5 8.9v14H17.63zm-.16-1.5H27.6v-9.5l-8.55 4.5-6.65-1.5v4.05c2.05-.7 4.22.1 4.9 1.82.08.2.14.42.17.63zm-4.78-1.21c-1.44.48-2.23 1.76-1.75 2.84.47 1.08 2.03 1.57 3.47 1.08 1.44-.48 2.23-1.76 1.75-2.84-.47-1.08-2.03-1.57-3.47-1.08z'/%3e %3cfilter id='a' width='134.3%25' height='140.4%25' x='-17.1%25' y='-15.4%25' filterUnits='objectBoundingBox'%3e %3cfeMorphology in='SourceAlpha' operator='dilate' radius='.9' result='shadowSpreadOuter1'/%3e %3cfeOffset dy='1' in='shadowSpreadOuter1' result='shadowOffsetOuter1'/%3e %3cfeGaussianBlur in='shadowOffsetOuter1' result='shadowBlurOuter1' stdDeviation='1'/%3e %3cfeComposite in='shadowBlurOuter1' in2='SourceAlpha' operator='out' result='shadowBlurOuter1'/%3e %3cfeColorMatrix in='shadowBlurOuter1' values='0 0 0 0 0.117647059 0 0 0 0 0.125490196 0 0 0 0 0.141176471 0 0 0 0.5 0'/%3e %3c/filter%3e %3cpath id='d' d='M2.5 2.5l7 2.5L6 6 4.5 9.5z'/%3e %3cfilter id='c' width='235.3%25' height='232.9%25' x='-66.4%25' y='-52.1%25' filterUnits='objectBoundingBox'%3e %3cfeMorphology in='SourceAlpha' operator='dilate' radius='1.05' result='shadowSpreadOuter1'/%3e %3cfeOffset dy='1' in='shadowSpreadOuter1' result='shadowOffsetOuter1'/%3e %3cfeGaussianBlur in='shadowOffsetOuter1' result='shadowBlurOuter1' stdDeviation='1'/%3e %3cfeComposite in='shadowBlurOuter1' in2='SourceAlpha' operator='out' result='shadowBlurOuter1'/%3e %3cfeColorMatrix in='shadowBlurOuter1' values='0 0 0 0 0.117647059 0 0 0 0 0.125490196 0 0 0 0 0.141176471 0 0 0 0.5 0'/%3e %3c/filter%3e %3c/defs%3e %3cg fill='none' fill-rule='evenodd'%3e %3cuse fill='black' filter='url(%23a)' xlink:href='%23b'/%3e %3cuse fill='black' xlink:href='%23b'/%3e %3cpath stroke='white' d='M17.96 23.4a26.57 26.57 0 0 1-1.34 2.76c-2.2 3.8-6.78 5.13-10.43 3.05a7.51 7.51 0 0 1-1.54-1.17l-.25-.24.98-2.16.48.3c.9.55 1.53.92 1.89 1.13a4.52 4.52 0 0 0 5.45-.87c-1.76.04-3.36-.86-3.96-2.39a3.78 3.78 0 0 1 .76-3.83V11.8l8.89 2.46L30 8.05V23.4H17.96zm-.09-2.5h9.23v-8.17l-7.98 4.2-6.22-1.4v2.77c2.09-.42 4.16.5 4.86 2.29l.11.31zm-5.02-.24c-1.19.4-1.8 1.39-1.45 2.17.36.82 1.63 1.22 2.85.8 1.19-.4 1.8-1.38 1.45-2.16-.36-.82-1.63-1.22-2.85-.8z'/%3e %3cuse fill='black' filter='url(%23c)' xlink:href='%23d'/%3e %3cuse fill='black' xlink:href='%23d'/%3e %3cpath stroke='white' d='M6.37 6.42L4.4 10.99 1.75 1.7l9.38 3.35-4.76 1.37z'/%3e %3c/g%3e %3c/svg%3e"};this.cursors={auto:{native:"auto"},arrow:{get native(){return e()},svg:t.arrow,svgIsRotated:!0},move:{native:"move",svg:t.move},rotate:{cur:`${BFN.imagesURL}cursors/rotate-fallback.cur`,svg:BeFunky.isSafari?t.rotateFallback:t.rotate,svgIsRotated:!BeFunky.isSafari},select_cross:{native:"crosshair"},select_poly:{cur:`${BFN.imagesURL}cursors/select-polygon.cur`,svg:t.selectPolygon,svgOffset:"0 0"},select_lasso:{cur:`${BFN.imagesURL}cursors/select-lasso.cur`,svg:t.selectLasso,svgOffset:"0 0"},grab:{native:BeFunky.isChromium||BeFunky.isSafari?"-webkit-grab":"grab"},grabbing:{native:BeFunky.isChromium||BeFunky.isSafari?"-webkit-grabbing":"grabbing"},none:{native:"none"}},this.validCursors=Object.keys(this.cursors),this.cursor=this._cursor=this.defaultNativeCursor="auto",this.cursorRotation=this._cursorRotation=0,this.cursorLock=this._cursorLock=!1,this.lockedCursor=void 0,this.prevCursorStyle=""},this.updateCursor=(e=!1)=>{clearTimeout(this.updateCursorST),cancelAnimationFrame(this.updateCursorAF);let t=()=>{this.updateCursorAF=requestAnimationFrame(()=>{let r=this.getCursorStyle();r!==this.prevCursorStyle&&(this.prevCursorStyle=r,this.setStyles(r))})};e?t():this.updateCursorST=setTimeout(t,0)},this.getCursorStyle=()=>{let e=this.cursors[this.lockedCursor||this._cursor],t=[];if(e.svg){let r=`url("${e.svg}") ${e.svgOffset||"16 16"}`;e.svgIsRotated&&this._cursorRotation!==0&&(r=r.replace("rotate(0 ",`rotate(${this._cursorRotation} `)),t.push(r)}return e.cur&&t.push(`url("${e.cur}")`),t.push(e.native||this.defaultNativeCursor),{cursor:t.join(", ")}},this.getNativeArrowCursor=()=>{let t=(this._cursorRotation%45>=45/2?Math.ceil:Math.floor)(this._cursorRotation/45)*45;return t%=180,{0:"ew-resize",45:"nwse-resize",90:"ns-resize",135:"nesw-resize"}[t]},Object.defineProperty(this,"cursor",{set(e){(!e||!this.validCursors.includes(e))&&(e=this.defaultNativeCursor),e!==this._cursor&&(this._cursor=e,this._cursorLock||this.updateCursor())},get(){return this._cursor}}),Object.defineProperty(this,"cursorRotation",{set(e){typeof e!="number"&&(e=0),e=e*180/Math.PI,e<0&&(e-=Math.floor(e/360)*360),e=Math.round(e),e!==this._cursorRotation&&(this._cursorRotation=e,this._cursorLock?this.cursors[this.lockedCursor].svgIsRotated&&this.updateCursor(!0):this.cursors[this._cursor].svgIsRotated&&this.updateCursor(!0))},get(){return this._cursorRotation}}),Object.defineProperty(this,"cursorLock",{set(e){e=!!e,e!==this._cursorLock&&(this._cursorLock=e,this._cursorLock?this.lockedCursor=this._cursor:(this.lockedCursor=void 0,this.updateCursor()))},get(){return this._cursorLock}}),this.init()}.bind(i)();BFN.UI.draggablePanel=(i,e,t=!1)=>function(){this.init=function(){this.initDefaultValues(),BFN.addFloatingElement(this)},this.initDefaultValues=function(){this.addClass("draggable-panel"),this.addClass("focus-avoid"),setTimeout(()=>{this.addClass("animated")},100),this.panelHeader=e||this.querySelector("panel-header"),typeof this.panelHeader.then=="function"?this.panelHeader.then(r=>{this.panelHeader=r,this.panelHeader.addEventListener(BeFunky.pointerdown,this.handleTopBarPress)}):this.panelHeader.addEventListener(BeFunky.pointerdown,this.handleTopBarPress),this.addEventListener(BeFunky.pointerdown,this.handlePanelPress,!0),this.cursorStartPoint={},this.topBarStartPoint={},this.deltaPoint={},this._panelSize=null,this.addEventListener(BeFunky.pointerdown,r=>this.handleDraggablePanelClick(r)),BFN.StageModel.addEventListener(BFN.StageModelEvents.STAGE_DIMENSIONS_UPDATED.type,this.handleStageDimensionsUpdated.bind(this))},this.show=function(r=null,a=null){this.addClass("active"),this.removeClass("focus-avoid"),typeof this.onShow=="function"&&this.onShow(),r!==null&a!==null&&this.setPosition(r,a),BFN.focusFloatingElement(this)},this.hide=function(){this.removeClass("active"),this.addClass("focus-avoid"),typeof this.onHide=="function"&&this.onHide(),setTimeout(()=>{this.hasClass("active")||this.setStyles({zIndex:-1})},300)},this.setPosition=function(r,a){let s=Math.max(0,Math.min(BFN.appRect.width-this.panelSize.width,r)),o=Math.max(0,Math.min(BFN.appRect.height-this.panelSize.height,a));this.setStyles({left:`${Math.round(s)}px`,top:`${Math.round(o)}px`})},this.handleTopBarPress=r=>{document.addEventListener(BeFunky.pointerup,this.handleTopBarRelease),document.addEventListener(BeFunky.pointermove,this.handleTopBarDrag),this.cursorStartPoint.x=r.clientX,this.cursorStartPoint.y=r.clientY;let a=s=>getComputedStyle(this).getPropertyValue(s);this.topBarStartPoint.x=parseInt(a("left").replace("px","")),this.topBarStartPoint.y=parseInt(a("top").replace("px",""))},this.handleTopBarRelease=()=>{document.removeEventListener(BeFunky.pointerup,this.handleTopBarRelease),document.removeEventListener(BeFunky.pointermove,this.handleTopBarDrag)},this.handleTopBarDrag=r=>{this.deltaPoint.x=r.clientX-this.cursorStartPoint.x,this.deltaPoint.y=r.clientY-this.cursorStartPoint.y,this.setPosition(this.topBarStartPoint.x+this.deltaPoint.x,this.topBarStartPoint.y+this.deltaPoint.y),t&&this.panelHeader.dispatchEvent(new CustomEvent("drag",{bubbles:!1}))},this.handlePanelPress=r=>{BFN.focusFloatingElement(this),this.hasClass("disabled")&&this.handleTopBarPress(r)},this.handleDraggablePanelClick=function(r){r.stopPropagation(),r.currentTarget!==BFN.ColorPickerPanel&&BFN.ColorPickerPanel.colorButton&&(BFN.ColorPickerPanel.colorButton=null)},this.handleStageDimensionsUpdated=function(r){if(this._panelSize){let a=parseInt(this.style.left.replace("px","")),s=parseInt(this.style.top.replace("px",""));this.setPosition(a,s)}},Object.defineProperty(this,"panelSize",{get(){return(!this._panelSize||!this._panelSize.width)&&(this._panelSize=this.getBoundingClientRect()),{width:this._panelSize.width,height:this._panelSize.height}}}),this.init()}.bind(i)();var r1=i=>{BeFunky.isWiderThanMobile()||BFN.secondaryMenu.dispatchEvent(new CustomEvent("UPDATE_MENU_HEIGHT",{detail:{isExpanded:!1,height:BFN.getSecondaryMenuHeightOnMobile(i)},bubbles:!0}))},vi=r1;BFN.UI.graphicManagerItem=(i,e,t)=>function(){let r=BFN.getImageType(e.id);this.setAttribute("class",`graphic-manager__item graphic-manager__item--${r} button`),this.init=function(){this.addGraphic(),this.addButtons(),this.addPlusBadge(),this.menuImageVO=e,BeFunky.draggableElement(this,t,{dragScreen:BFN.DragScreen}),this.dataset.tooltip="drag_or_double_click",this.addEventListener("dblclick",this.handleDoubleClick),this.addEventListener("dragstarted",this.handleDragStarted),this.addEventListener("dragstopped",this.handleDragStopped)},this.addGraphic=function(){let{thumbURL:s}=e,o=`url("${s}") no-repeat center`,n="contain",l=new Image;l.onload=()=>{let c=document.createElement("div").addClass("graphic-manager__placeholder").setStyles({background:o,backgroundSize:n}),h=this.firstElementChild,u=document.createElement("div").addClass("graphic-manager__hover-container");h?this.insertBefore(c,h):this.appendChild(c),this.appendChild(u)},l.onerror=()=>{this.hasRetried?BeFunky.logError("Failed to load thumbnail for a second time"):(this.hasRetried=!0,BeFunky.logError("Failed to load thumbnail. Trying again in 3 seconds..."),setTimeout(this.addGraphic.bind(this),3e3))},l.src=s},this.addButtons=function(){if(e.isRemovable){let s=a("remove","cancel-icon","remove_from_graphic_manager");s.addEventListener("click",this.handleRemoveButtonClick),this.appendChild(s)}},this.addPlusBadge=function(){if(e.isPlus&&!BFN.BfnService.userIsPlus){let s=document.createElement("div").setClass("badge badge--plus");this.appendChild(s)}};function a(s,o,n){let l=document.createElement("button");return l.setAttribute("class",`button button--icon button--grey-200 graphic-manager__button graphic-manager__button--${s}`),n&&(l.dataset.tooltip=n),o&&(l.innerHTML=`
                <svg class="icon icon icon--12">
                    <use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="#${o}"></use>
                </svg>
            `),l}this.handleRemoveButtonClick=()=>{BFN.GraphicLibraryManager.removeGraphic(e.id)},this.handleDoubleClick=()=>{BFN.GraphicLibraryManager.getIndex(e.id)!==-1&&this.addToCanvas()},this.handleDragStarted=()=>{BFN.DragScreen.show(e.thumbURL),vi("editor_graphic_menu"),document.addEventListener("keyup",this.handleEscape)},this.handleDragStopped=s=>{let{canvasCoordinates:o}=s.detail;document.removeEventListener("keyup",this.handleEscape),!!o&&this.addToCanvas(o)},this.addToCanvas=s=>{if(e.isPlus&&!BFN.BfnService.userIsPlus){BFN.BfnService.upgrade("GOODIES",`${e.trackingID}_UPGRADE`),BFN.UserActionManager.addUpgradeAction(["Add Plus Graphic"],!1);return}BFN.ImageLibraryManager.addImageToCanvas(e,{forceLayer:!0,isGoodie:!0,initialCenterPosition:s}),vi("editor_graphic_menu"),BFN.BfnService.track("CREATE","GOODIES",e.trackingID)},this.handleEscape=s=>{s.key==="Escape"&&this.cancelDragging()},this.init()}.bind(i)();BFN.UI.graphicManagerShape=(i,e,t,r)=>function(){this.setClass("graphic-manager__shape"),this.setAttribute("data-tooltip",e),this.innerHTML=t,this.init=function(){this.addEventListener("click",()=>this.addToCanvas()),BeFunky.draggableElement(this,r,{dragScreen:BFN.DragScreen}),this.addEventListener("dragstarted",this.handleDragStarted),this.addEventListener("dragstopped",this.handleDragStopped)},this.handleDragStarted=()=>{let s=`data:image/svg+xml,${(o=>o.replace(/#EDEDED/,"white").replace(/</g,"%3C").replace(/>/g,"%3E").replace(/#/g,"%23"))(t)}`;BFN.DragScreen.show(s),vi("editor_graphic_menu"),document.addEventListener("keyup",this.handleEscape)},this.handleDragStopped=a=>{let s=a.detail.canvasCoordinates;document.removeEventListener("keyup",this.handleEscape),!!s&&this.addToCanvas(s)},this.addToCanvas=a=>{BFN.BasicShapeManager.createShape(e,a),vi("editor_graphic_menu"),BFN.BfnService.track("CREATE","SHAPES",e)},this.handleEscape=a=>{a.key==="Escape"&&this.cancelDragging()},this.init()}.bind(i)();BFN.UI.imageManagerItem=(i,e,t)=>function(){let r=BFN.getImageType(e.id);this.setAttribute("class",`image-manager__item image-manager__item--${r}`),this.init=function(){this.addImage(),this.addButtons(),this.menuImageVO=e,this.lastPreloadedURL="",BeFunky.draggableElement(this,t,{dragScreen:BFN.DragScreen}),this.dataset.tooltip="drag_or_double_click",this.addEventListener("dragstarted",this.handleDragStarted),this.addEventListener("dragstopped",this.handleDragStopped)},this.addImage=function(){let{id:s,thumbURL:o,thumbWidth:n=0,thumbHeight:l=0,isTransparent:c}=e,h=BFN.CSS.imageManagerThumbSize,u=`url("${o}") no-repeat center`,d=n>=h&&l>=h?"cover":"contain";c&&(u+=`, url('${BFN.imagesURL}app/checker_pattern.jpg') repeat`,d+=", auto");let m=new Image;m.onload=()=>{let p=document.createElement("div").addClass("image-manager__placeholder").setStyles({background:u,backgroundSize:d}),g=document.createElement("div").addClass("image-manager__hover-container"),f=this.firstElementChild;f?this.insertBefore(p,f):this.appendChild(p),this.appendChild(g)},m.onerror=()=>{this.hasRetried?BeFunky.logError("Failed to load thumbnail for a second time"):(this.hasRetried=!0,BFN.getImageType(s)==="pixabay"?(BeFunky.logError("Failed to load expired Pixabay image. Trying again..."),BFN.ImageLibraryService.getPixabayImageById(s.replace("pixabay_","")).then(p=>{e.imageURL=p.imageURL,e.thumbURL=p.thumbURL,this.addImage(),requestIdleCallback(()=>BFN.ImageLibraryManager.updateImageStore())}).catch(p=>{BeFunky.throwError("Unable to get updated Pixabay image",p)})):(BeFunky.logError("Failed to load thumbnail. Trying again in 3 seconds..."),setTimeout(this.addImage.bind(this),3e3)))},m.src=o},this.addButtons=function(){if(!e.isSaved){let s=a("save","download-icon","save_to_befunky");s.addEventListener("click",this.handleSaveButtonClick),this.appendChild(s)}if(e.isRemovable){let s=a("remove","cancel-icon","remove_from_image_manager");s.addEventListener("click",this.handleRemoveButtonClick),this.appendChild(s)}};function a(s,o,n){let l=document.createElement("button");return l.setAttribute("class",`button button--icon button--xs button--grey-200 image-manager__button image-manager__button--${s}`),n&&(l.dataset.tooltip=n),o&&(l.innerHTML=`
                <svg class="icon icon--14">
                    <use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="#${o}"></use>
                </svg>
            `),l}this.handleRemoveButtonClick=()=>{BFN.ImageLibraryManager.removeImage(e.id)},this.handleSaveButtonClick=()=>{BFN.ImageLibraryManager.saveImageAsLayer(e)},this.handleDragStarted=()=>{BFN.DragScreen.show(e.thumbURL),document.addEventListener("keyup",this.handleEscape),vi("editor_image_manager_menu"),BFN.AppModel.viewingCollage&&!BFN.CollageMakerCanvasPhotoGridModel.freeform&&(BFN.PhotoGrid.awaitingDrop=!0),BFN.TransformModel.awaitingDrop=!e.isSVG,e.imageURL&&e.imageURL!==this.lastPreloadedURL&&(BeFunky.isChromium||BeFunky.isSafari)&&(this.lastPreloadedURL=e.imageURL,BFN.RequestUtils.getBlob(e.imageURL,()=>{}))},this.handleDragStopped=s=>{let{canvasCoordinates:o}=s.detail;document.removeEventListener("keyup",this.handleEscape),o?BFN.ImageLibraryManager.addImageToCanvas(e,{initialCenterPosition:o}):(BFN.PhotoGrid.awaitingDrop=!1,BFN.TransformModel.awaitingDrop=!1,BFN.TransformModel.focusedTransformItem=null,BFN.TransformModel.targetTransformItem=null)},this.handleEscape=s=>{s.key==="Escape"&&this.cancelDragging()},this.init()}.bind(i)();BFN.UI.messageScreen=i=>function(){this.addClass("message-screen");let e='<div class="center-container"></div>';this.insertAdjacentHTML("beforeend",e),this.init=function(){this.active=!1,this.messageQueue=[],this.transitionTimeQueue=[],this.centerContainer=this.querySelector(".center-container"),this.messageContainer=document.createElement("div").addClass("message-container"),this.transitionTime=750,this.easeInTransition=()=>`all ${this.transitionTime}ms cubic-bezier(0, 0, 0.3, 0.7)`,this.easeOutTransition=()=>`all ${this.transitionTime}ms cubic-bezier(0, 0, 0.7, 0.3)`},this.show=function(t,r){r=parseInt(r),(!r||r<=0)&&(r=750),this.messageQueue.push(t),this.transitionTimeQueue.push(r),this.active||this.processMessageQueue()},this.processMessageQueue=function(){if(this.messageQueue.length){this.active||(this.active=!0,this.addClass("active"));let t=this.messageQueue.shift();this.messageContainer.innerHTML=/^[a-z0-9_]+$/.test(t)?BeFunky.LanguageManager.getString(t):t,this.transitionTime=this.transitionTimeQueue.shift(),this.messageContainer.setStyles({opacity:0,transition:this.easeInTransition()}),this.centerContainer.appendChild(this.messageContainer),this.messageContainerHeight=parseInt(this.messageContainer.getBoundingClientRect().height),this.messageContainer.setStyles({transform:`translateY(-${this.messageContainerHeight/2}px)`,opacity:1}),setTimeout(()=>requestAnimationFrame(this.handleEaseInEnd),this.transitionTime)}else this.active=!1,this.removeClass("active")},this.handleEaseInEnd=()=>{this.messageContainer.setStyles({transform:`translateY(-${this.messageContainerHeight}px)`,opacity:0,transition:this.easeOutTransition()}),setTimeout(()=>requestAnimationFrame(this.handleEaseOutEnd),this.transitionTime)},this.handleEaseOutEnd=()=>{this.messageContainer.setStyles({transform:"unset",transition:""}),this.centerContainer.removeChild(this.messageContainer),setTimeout(this.processMessageQueue.bind(this),0)},this.init()}.bind(i)();BFN.UI.popover=i=>function(){let e=document.createDocumentFragment();for(;this.firstChild;)e.appendChild(this.firstChild);this.innerHTML=`
        <div class="popover-arrow"></div>
        <div class="popover-container"></div>
    `,this.querySelector(".popover-container").appendChild(e),this.setStyles({display:"block"}),this.init=function(){this.initDefaultValues()},this.initDefaultValues=function(){this.isActive=!1,this.panelPressed=!1,this.sides=["left","top","right","bottom"],this._side=this.sides[0],this._positionFactor=.5,this._strong=!1,this._positionEdge=!1,this.arrow=this.querySelector(".popover-arrow"),this.container=this.querySelector(".popover-container"),this.arrowBase=null,this.addEventListener(BeFunky.pointerdown,()=>{this.panelPressed=!0}),this.useTransform=!(this.dataset.transform&&this.dataset.transform==="false"),this.dataset.side&&(this.side=this.dataset.side),this.dataset.position&&(this.positionFactor=Number(this.dataset.position)),this.dataset.strong&&(this._strong=this.dataset.strong),this.dataset.positionEdge&&(this._positionEdge=this.dataset.positionEdge),BFN.MainUI.addIdleRenderFunction(this.updateDisplay.bind(this))},this.show=function(t=!1){this.updateDisplay(),this.addClass("active"),document.addEventListener(BeFunky.pointerdown,this.handleDocumentMouseDown),this.isActive=!0,t&&BeFunky.temporarilyFocusDiv(this.container)},this.bounce=function(){this.addClass("bounce"),setTimeout(()=>{this.removeClass("bounce")},100)},this.hide=function(){this.removeClass("active"),document.removeEventListener(BeFunky.pointerdown,this.handleDocumentMouseDown),this.isActive=!1},this.hideUnlessPressed=function(){this.panelPressed||this.hide(),this.panelPressed=!1},this.updateDisplay=function(){if(this.offsetParent===null)return;this.arrowBase=28;let t=this.container.getBoundingClientRect(),r=this._positionEdge?this.arrowBase/2:this.arrowBase,a=-Math.round((t.width-r*2)*this._positionFactor+r),s=-Math.round((t.height-r*2)*this._positionFactor+r),o={left:-45,right:-225,top:-315,bottom:-135};this.arrow.setStyles({transform:`rotate(${o[this._side]}deg)`});let n={left:{x:10,y:s},right:{x:-(t.width+10),y:s},top:{x:a,y:10},bottom:{x:a,y:-(t.height+10)}},l=this.useTransform?{transform:`translateX(${n[this._side].x}px) translateY(${n[this._side].y}px)`}:{left:`${n[this._side].x}px`,top:`${n[this._side].y}px`};this.container.setStyles(l)},this.handleDocumentMouseDown=()=>{this._strong||(this.hideUnlessPressed(),this.panelPressed=!1)},Object.defineProperty(this,"side",{set(t){this.sides.indexOf(t)!==-1&&(this._side=t,this.isActive&&this.updateDisplay())},get(){return this._side}}),Object.defineProperty(this,"positionFactor",{set(t){this._positionFactor=Math.max(0,Math.min(1,t)),this.isActive&&this.updateDisplay()},get(){return this._positionFactor}}),Object.defineProperty(this,"strong",{set(t){this._strong=t},get(){return this._strong}}),Object.defineProperty(this,"positionEdge",{set(t){this._positionEdge=!!t,this.isActive&&this.updateDisplay()},get(){return this._positionEdge}}),this.init()}.bind(i)();BFN.UI.resizeTemplateModal=i=>function(){this.init=function(){this.initDefaultValues(),this.initAspectRatioDropdown(),this.initDimensionsScrubbers(),this.initCheckboxes(),this.initButtons()},this.initDefaultValues=function(){this.defaultAspectRatio="freeform",this.startSize=Math.min(11*300,BFN.maxImageSize),this.smartResizeGuide=this.querySelector(".note")},this.initAspectRatioDropdown=function(){this.aspectRatioDropdown=document.getElementById("resize_template_aspect_ratio"),this.presetSizes=BFN.DropDownData.resizeTemplateSizes,this.aspectRatioDropdown.label="template_size_presets",this.aspectRatioDropdown.options=this.presetSizes,this.aspectRatioDropdown.dropdownMaxHeight=260,this.aspectRatioDropdown.onChange=e=>{let t=this.presetSizes.find(({value:o})=>o===e).value.split("x").map(o=>parseInt(o)).filter(Boolean);if(t.length!==2)return;let[r,a]=t,s=Math.max(a,r);if(s>BFN.maxImageSize){let o=BFN.maxImageSize/s;a=Math.round(a*o),r=Math.round(r*o)}this.widthScrubber.minValue=this.heightScrubber.minValue=BFN.minImageSize,this.widthScrubber.maxValue=this.heightScrubber.maxValue=BFN.maxImageSize,this.widthScrubber.value=r,this.heightScrubber.value=a,this.updateLockedAspectRatio()}},this.initDimensionsScrubbers=function(){this.widthScrubber=document.getElementById("resize_template_width"),this.heightScrubber=document.getElementById("resize_template_height"),this.widthScrubber.unit=this.heightScrubber.unit="px",this.widthScrubber.minValue=this.heightScrubber.minValue=BFN.minImageSize,this.widthScrubber.maxValue=this.heightScrubber.maxValue=BFN.maxImageSize,this.widthScrubber.addEventListener("change",this.handleScrubberChange.bind(this)),this.heightScrubber.addEventListener("change",this.handleScrubberChange.bind(this))},this.initCheckboxes=function(){this.lockAspectRatioCheckbox=document.getElementById("resize_template_lock_aspect_ratio"),BFN.UI.checkboxItem(this.lockAspectRatioCheckbox,{controlID:"resize_template_lock_aspect_ratio",paramObject:{name:"lock_aspect_ratio"}}),this.lockAspectRatioCheckbox=document.getElementById("resize_template_lock_aspect_ratio"),this.lockAspectRatioCheckbox.addEventListener("change",()=>{this.updateLockedAspectRatio()}),this.smartResizeCheckbox=document.getElementById("resize_template_smart_resize"),BFN.UI.checkboxItem(this.smartResizeCheckbox,{controlID:"resize_template_smart_resize",paramObject:{name:"smart_resize"}}),this.smartResizeCheckbox=document.getElementById("resize_template_smart_resize"),this.smartResizeCheckbox.addEventListener("change",()=>{this.toggleSmartResizeGuide()})},this.initButtons=function(){this.swapButton=this.querySelector(".resize-template__swap-dimensions"),this.cancelButton=this.querySelector(".resize-template__cancel"),this.resizeButton=this.querySelector(".resize-template__resize"),this.swapButton.addEventListener("click",()=>this.swapDimensions()),this.cancelButton.addEventListener("click",()=>this.close()),this.resizeButton.addEventListener("click",()=>this.resizeProject())},this.open=function(){BeFunky.openModal(this,{onOpen:()=>{let e=BFN.DesignerModel.projectVO.projectWidth||this.startSize,t=BFN.DesignerModel.projectVO.projectHeight||this.startSize;this.widthScrubber.minValue=this.heightScrubber.minValue=BFN.minImageSize,this.widthScrubber.maxValue=this.heightScrubber.maxValue=BFN.maxImageSize,this.widthScrubber.value=e,this.heightScrubber.value=t;let r=`${e} x ${t}`,a=this.presetSizes.find(({value:o})=>o===r),s=a?a.value:this.defaultAspectRatio;this.switchAspectRatio(s),this.updateLockedAspectRatio(),UITools.toggleControlItem("resize_template_lock_aspect_ratio",!0),this.lockAspectRatioCheckbox.checked=!0,UITools.toggleControlItem("resize_template_smart_resize",!0),this.smartResizeCheckbox.checked=!0,this.resizeButton.setStyles({display:"block"}),this.toggleSmartResizeGuide()},size:"small",addAnchorBottomClass:!BeFunky.isWiderThanMobile(),isFullWidthOnMobile:!0})},this.close=function(){BeFunky.closeModal(this)},this.handleScrubberChange=function(e){if(this.lockAspectRatioCheckbox.checked){let s=e.target,o=s===this.widthScrubber?this.heightScrubber:this.widthScrubber,n=s===this.widthScrubber?this.lockedAspectRatio:1/this.lockedAspectRatio,l=Math.round(s.value*n);l<o.minValue?(o.value=o.minValue,s.value=Math.round(o.minValue/n)):l>o.maxValue?(o.value=o.maxValue,s.value=Math.round(o.maxValue/n)):o.value=l}let t=`${this.widthScrubber.value} x ${this.heightScrubber.value}`,r=this.presetSizes.find(({value:s})=>s===t),a=r?r.value:this.defaultAspectRatio;this.aspectRatioDropdown.value=a},this.switchAspectRatio=function(e){typeof e!="string"&&(e=this.defaultAspectRatio),this.aspectRatioDropdown.value=e},this.updateLockedAspectRatio=function(){this.lockedAspectRatio=this.heightScrubber.value/this.widthScrubber.value,this.lockAspectRatioCheckbox.checked&&this.lockedAspectRatio!==1?this.lockedAspectRatio<1?(this.widthScrubber.minValue=Math.round(BFN.minImageSize/this.lockedAspectRatio),this.heightScrubber.minValue=BFN.minImageSize,this.widthScrubber.maxValue=BFN.maxImageSize,this.heightScrubber.maxValue=Math.round(BFN.maxImageSize*this.lockedAspectRatio)):this.lockedAspectRatio>1&&(this.widthScrubber.minValue=BFN.minImageSize,this.heightScrubber.minValue=Math.round(BFN.minImageSize*this.lockedAspectRatio),this.widthScrubber.maxValue=Math.round(BFN.maxImageSize/this.lockedAspectRatio),this.heightScrubber.maxValue=BFN.maxImageSize):(this.widthScrubber.minValue=this.heightScrubber.minValue=BFN.minImageSize,this.widthScrubber.maxValue=this.heightScrubber.maxValue=BFN.maxImageSize)},this.swapDimensions=function(){this.widthScrubber.minValue=this.heightScrubber.minValue=BFN.minImageSize,this.widthScrubber.maxValue=this.heightScrubber.maxValue=BFN.maxImageSize;let e=this.heightScrubber.value,t=this.widthScrubber.value;this.widthScrubber.value=e,this.heightScrubber.value=t,this.updateLockedAspectRatio()},this.resizeProject=function(){requestIdleCallback(()=>this.close()),BFN.DesignerCanvas.fitToFrameAfterResize=!0;let e=this.smartResizeCheckbox.checked;UITools.setToolValue("collage_customize","smart_resize",e),UITools.setToolValue("collage_customize","width",this.widthScrubber.value),UITools.setToolValue("collage_customize","height",this.heightScrubber.value),UITools.applyTool("collage_customize");let t=this.presetSizes.find(({value:a})=>a===this.aspectRatioDropdown.value);BFN.DesignerModel.projectVO.printDPI=t.dpi||300;let r=new BFN.UserActionVO;r.eventID="design_layout_resized",r.eventObject={preset:t.name,smartResize:e},r.track()},this.toggleSmartResizeGuide=function(){let e=this.smartResizeCheckbox.checked;this.smartResizeGuide.setStyles({display:"",visibility:e?"":"hidden"})},this.init()}.bind(i)();BFN.UI.scrollStopDispatcher=(i,e,t=100)=>function(){this.init=function(){this.initDefaultValues()},this.initDefaultValues=function(){this.awaitingPointerUp=!1;let r=s=>{this.awaitingPointerUp=!1,document.removeEventListener(BeFunky.pointerup,r),document.removeEventListener("touchend",r),e()},a=s=>{this.awaitingPointerUp=!1,document.removeEventListener(BeFunky.pointerup,r),document.removeEventListener("touchend",r),this.debounceCallback()};this.addEventListener("scroll",()=>{BeFunky.isPointerDown&&!this.awaitingPointerUp&&(this.awaitingPointerUp=!0,document.addEventListener(BeFunky.pointerup,r),document.addEventListener("touchend",a)),this.debounceCallback()})},this.debounceCallback=BeFunky.debounce(function(){this.awaitingPointerUp||e()},t),this.init()}.bind(i)();var qB=ca(qo());BFN.UI.selectableList=(i,e,t,r)=>function(){this.addClass("selectable-list"),this.init=function(){this.initDefaultValues(),this.initFuse(),this.initHeader(),this.initList()},this.initDefaultValues=function(){this._selectedIDs=[],this._choices=[],this.listItems={}},this.initFuse=function(){let a={shouldSort:!0,includeScore:!0,threshold:.2,location:0,distance:100,maxPatternLength:32,minMatchCharLength:this.minValueLength,keys:["translatedName"]};this.setupFuse=()=>{this.choices.forEach(s=>s.translatedName=BeFunky.LanguageManager.getString(s.name)),this.fuse=new qB.default(this.choices,a)}},this.initHeader=function(){let a=document.createElement("div").addClass("selectable-list__header");a.innerHTML=`
            <svg class="icon selectable-list__search-icon">
                <use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="#search-icon"></use>
            </svg>
            <input type="search" class="input selectable-list__input" placeholder="${BeFunky.LanguageManager.getString(e)}" data-lang="${e}">
            <button class="button button--icon button--transparent selectable-list__clear-search">
                <svg class="icon icon--14">
                    <use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="#cancel-icon"></use>
                </svg>
            </button>
        `,this.appendChild(a),this.input=a.querySelector("input"),this.clearButton=a.querySelector("button");let s=25,o=BeFunky.debounce(this.handleTextUpdate.bind(this),s);this.input.addEventListener("change",o),this.input.addEventListener("keyup",o),this.clearButton.addEventListener("click",()=>{this.input.value="",o()}),this.currentValue="",this.minValueLength=2,this.visibleChoices="all";let n=BeFunky.LanguageManager.language.app;BeFunky.LanguageManager.addLanguageUpdateListener(()=>{!this.choices.length||n===BeFunky.LanguageManager.language.app||(n=BeFunky.LanguageManager.language.app,this.setupFuse(),this.displayVisibleChoices())})},this.initList=function(){this.list=document.createElement("div").addClass("selectable-list__list"),this.list.addClass("scrollable-content"),this.appendChild(this.list),this.noResultsItem=document.createElement("div").setClass("selectable-list__item selectable-list__item--no-results"),t&&(this.choices=t)},this.generateListItems=function(){this.list.innerHTML="",this.listItems={},this.visibleChoices=this.getVisibleChoiceIDs();let a=document.createDocumentFragment();this.choices.forEach(({id:s,name:o})=>{let n=document.createElement("button").setClass("button button--grey-200 button--fullwidth button--has-icon selectable-list__item");this.visibleChoices!=="all"&&!this.visibleChoices.includes(s)&&n.setStyles({display:"none"}),n.innerHTML=`
                <string data-lang="${o}">${BeFunky.LanguageManager.getString(o)}</string>
                <svg class="icon icon--14">
                    <use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="#checkmark-icon"></use>
                </svg>
            `,n.addEventListener("click",()=>this.handleItemSelection(s,n)),this.listItems[s]=n,a.appendChild(n)}),a.appendChild(this.noResultsItem),this.list.appendChild(a)},this.updateAllSelections=function(){Object.entries(this.listItems).forEach(([a,s])=>{s.toggleClass("button--selected",this._selectedIDs.includes(a))})},this.displayVisibleChoices=function(){let a=this.getVisibleChoiceIDs();if(this.visibleChoices===a||Array.isArray(this.visibleChoices)&&this.visibleChoices.length&&this.visibleChoices.isIdenticalTo(a))return;this.visibleChoices=a;let s=this.visibleChoices==="all"?()=>!0:n=>this.visibleChoices.includes(n),o=()=>{Object.entries(this.listItems).forEach(([n,l])=>{l.setStyles({display:s(n)?"":"none"})})};Array.isArray(this.visibleChoices)&&!this.visibleChoices.length?(this.noResultsItem.innerHTML=`
                <img src="${BFN.imagesURL}illustrations/no-search-results-sidebar.svg" alt="">
                ${BeFunky.LanguageManager.getStringReplacements("no_results_for",{query:`"<strong>${this.currentValue}</strong>"`})}
            `,this.list.addClass("selectable-list__list--no-results")):requestAnimationFrame(()=>{o(),this.list.removeClass("selectable-list__list--no-results")})},this.getVisibleChoiceIDs=function(){return this.currentValue.length<this.minValueLength?"all":this.fuse.search(this.currentValue).filter(({score:a})=>a<.5).map(({item:a})=>a.id)},this.handleTextUpdate=function(){let{value:a}=this.input,s=/[^a-z0-9-_ \u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]+/g;a=a.toLowerCase().replace(s,"").trim(),a!==this.currentValue&&(this.currentValue=a,this.displayVisibleChoices())},this.handleItemSelection=function(a,s){let o="button--selected",n=!s.hasClass(o),l=this._selectedIDs.includes(a);if(n&&!l)return this._selectedIDs.splice(0,0,a),this.listItems[a].addClass(o),r(this._selectedIDs);if(!n&&l)return this._selectedIDs.splice(this._selectedIDs.indexOf(a),1),this.listItems[a].removeClass(o),r(this._selectedIDs)},Object.defineProperty(this,"selectedIDs",{set(a){this._selectedIDs.isIdenticalTo(a)||(this._selectedIDs.splice(0),a instanceof Array&&this._selectedIDs.push(...a),this.updateAllSelections())},get(){return this._selectedIDs}}),Object.defineProperty(this,"choices",{set(a){if(!Array.isArray(a)||!a.every(o=>o.id&&o.name)){BeFunky.throwError("choices must be an array of objects with id and name properties");return}if(this._choices.isIdenticalTo(a))return;this._choices=a.slice();let s=Object.keys(this._choices);this.selectedIDs=this.selectedIDs.filter(o=>s.includes(o)),this.setupFuse(),this.generateListItems()},get(){return this._choices}}),this.init()}.bind(i)();BFN.UI.slider=(i,{start:e,step:t,min:r,max:a,pips:s,enableStartEvent:o=!1},n)=>function(){return window.noUiSlider.create(this,{start:e,step:t,behaviour:BeFunky.isWiderThanMobile()?"snap":"drag",animationDuration:0,connect:[!0,!1],range:{min:r,max:a},pips:s,keyboardPageMultiplier:10}),this.addClass("bfn-slider"),this.addEventListener("focusout",()=>this.removeClass("bfn-slider--active")),this.init=function(){this.handleElement=this.querySelector(".noUi-handle"),this.handleElement.slider=this,this.noUiSlider.on("slide",this.createUpdateHandler("slide")),this.noUiSlider.on("end",this.createUpdateHandler("end")),o&&this.noUiSlider.on("start",this.createUpdateHandler("start")),this.notches=this.querySelectorAll(".noUi-pips .noUi-marker.noUi-marker-large"),this.notches.length>0&&this.setNotchSliderStyles(this.notches,this.noUiSlider),this.lastEventValue=null,this.lastEventType="end",this.onUpdate=