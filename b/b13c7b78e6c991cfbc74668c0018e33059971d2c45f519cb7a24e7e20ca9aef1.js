var commerceApp=angular.module("CommerceApp",["CommonUtilApp","ngCookies"]),deferredPromisesGetUser=[],getUserCallInProgress=!1,deferredPromisesGetCart=[],getCartCallInProgress=!1,getProductPriceCallInProgress=!1,deferredPromisesGetProductReferences=[],getProductReferencesCallInProgress=!1,productPriceMap=new Map,getPotentialPromotionsCallInProgress=!1,potentialPromotionsMap=new Map,prodRef="";
commerceApp.constant("COMMERCE_CONSTANTS",{CART_DETAILS:"cartDetails",INVALIDATION_TIMEOUT:"invalidationTimeout",COMMERCE_PREFIX:"cmrc_",REL_PROD:"relatedProducts_",USER_DETAILS:"userDetails",PRODUCT_REFERENCES:"productReferences",CATEGORY_LISTING:"categoryListing_",EMPTY_USER_JSON:"{'uid':''}",EMPTY_CART_JSON:"{'cartId':''}",POTENTIAL_PROMOTIONS:"potentialPromotions",BLOCK_SIZE:"16",SYNDICATION_FEED:"syndicationFeed",AFFIRM_ALLOWED:"affirmAllowed",B2C:"B2C",B2B:"B2B",B2B_PATH:"business/",EMPTY:"",
CHANNEL_COOKIE:"Channel",LOGIN_POPUP_COOKIE:"loginPopup"});
commerceApp.service("CommerceService",["$q","$sce","$cookies","COMMERCE_CONSTANTS","CommonUtilService",function(e,p,w,g,l){cs_commonLogger("in CommerceService...");cs_this=this;this.getPurchasableCatalog=function(){var a=document.getElementById("commerceLoad").getAttribute("data-purchasable-catalog");cs_commonLogger("purchasableCatalog: "+a);return"true"==a?!0:!1};this.getServiceCommerceURL=function(){var a=document.getElementById("commerceLoad").getAttribute("data-commerce-service");cs_commonLogger("serviceCommerceURL: "+
a);return a};this.getPlatformCommerceURL=function(){var a=document.getElementById("commerceLoad").getAttribute("data-commerce-platform");cs_commonLogger("platformCommerceURL: "+a);return a};this.getCommerceServiceSite=function(){var a=document.getElementById("commerceLoad").getAttribute("data-commerce-b2c-service-site");cs_this.getCustomerChannel()==g.B2B&&(a=document.getElementById("commerceLoad").getAttribute("data-commerce-b2b-service-site"));cs_commonLogger("commerceServiceSite: "+a);return a};
this.getInvalidationTimeout=function(){var a=document.getElementById("commerceLoad").getAttribute("data-session-timeout");cs_commonLogger("invalidationTimeout: "+a);return a};this.getAffirmScriptURL=function(){var a=document.getElementById("commerceLoad").getAttribute("data-commerce-affirm-script-url");cs_commonLogger("affirmScriptURL: "+a);return a};this.getAffirmPublicApiKey=function(){var a=document.getElementById("commerceLoad").getAttribute("data-commerce-affirm-api-key");cs_commonLogger("affirmPublicApiKey: "+
a);return a};this.getWTBPagePath=function(){var a=document.getElementById("commerceLoad").getAttribute("data-wtb-page-path");a=null!=a?a:"";cs_commonLogger("wtbPagePath: "+a);return a};this.getCommerceLang=function(){var a=document.getElementById("commerceLoad").getAttribute("data-commerce-lang");a=null!=a?"\x26lang\x3d"+a:"";cs_commonLogger("commerceLang: "+a);return a};this.getCommercePrefix=function(){return g.COMMERCE_PREFIX+l.getLocale().toLowerCase()+"_"};this.generatePlatformURL=function(a,
c){a=cs_this.gotoCommerceURL(a);return a+="?fields\x3dFULL"+(c&&c!=g.EMPTY?"\x26"+c:g.EMPTY)};this.gotoCommerceURL=function(a){var c=cs_this.getPlatformCommerceURL()+"/";"us"!=l.getCountry().toLowerCase()&&(c+=l.getLanguage().toLowerCase()+"-"+l.getCountry().toLowerCase()+"/");return c+="store/"+cs_this.getPathFromCustomerChannel(cs_this.getCustomerChannel())+a};this.gotoBusinessCommerceURL=function(a){var c=cs_this.getPlatformCommerceURL()+"/";"us"!=l.getCountry().toLowerCase()&&(c+=l.getLanguage().toLowerCase()+
"-"+l.getCountry().toLowerCase()+"/");return c+="store/"+cs_this.getPathFromCustomerChannel(g.B2B)+a};this.generateServiceURL=function(a,c){return cs_this.getServiceCommerceURL()+"/"+cs_this.getCommerceServiceSite()+a+"?fields\x3dFULL"+(c&&c!=g.EMPTY?"\x26"+c:g.EMPTY)+cs_this.getCommerceLang()};this.initialize=function(a,c){cs_commonLogger("in initialize..."+a);var b=e.defer();a=cs_this.getSessionVariable(g.INVALIDATION_TIMEOUT);var d=(new Date).getTime();null==a?(cs_commonLogger("invalidationTimeout doesn't exist in session storage"),
d+=6E4*cs_this.getInvalidationTimeout(),cs_this.setSessionVariable(g.INVALIDATION_TIMEOUT,d),cs_commonLogger("invalidationTimeout set as: "+d)):(cs_commonLogger("invalidationTimeout exists in session storage"),cs_commonLogger("invalidationTimeout: "+a),cs_commonLogger("currentTimeInMilliseconds: "+d),a<d?(cs_commonLogger("out of session"),cs_this.removeAllSessionVariable(),cs_commonLogger("empty session storage")):cs_commonLogger("within session"));c?(cs_commonLogger("do not force user details to load first"),
b.resolve()):(c=cs_this.getSessionVariable(g.USER_DETAILS),cs_this.getPurchasableCatalog()&&null==c?(cs_commonLogger("user details doesnt exist, fetching it first."),cs_this.getUser().then(function(){cs_commonLogger("fetched user detail first, now continue to other calls");b.resolve()},function(){}