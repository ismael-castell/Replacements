var R={};R.controls={};R.controllers={};var RC=R.controllers;if(!window.addDOMLoadEvent){function addDOMLoadEvent(func){if(window.__disableAddDOMLoadEvent){return;}
if(!window.__load_events){var init=function(){if(arguments.callee.done)return;arguments.callee.done=true;if(window.__load_timer){clearInterval(window.__load_timer);window.__load_timer=null;}
for(var i=0;i<window.__load_events.length;i++){window.__load_events[i]();}
window.__load_events=null;};if(document.addEventListener){document.addEventListener("DOMContentLoaded",init,false);}
if(/WebKit/i.test(navigator.userAgent)&&(navigator.userAgent.match(/AppleWebKit\/(\d+)/)[1]<525)){window.__load_timer=setInterval(function(){if(/loaded|complete/.test(document.readyState)){init();}},10);}
window.onload=init;window.__load_events=[];}
window.__load_events.push(func);}}
function oldGlobalNamespaceShit(){}
var autocompletes=new Object();var suggesters=new Object();var markdownLoaded=false;var browser=null;var OUNCES_TO_GRAMS=28.3495231;var GRAMS_TO_OUNCES=0.0352739619;var METERS_TO_YARDS=1.0936133;var YARDS_TO_METERS=0.9144;var wmd_instances=new Object();var wmd_delayed=new Array();var balloon={timer:null,cur:null};function getViewportSize(){if(typeof window.innerWidth!='undefined'){return[window.innerWidth,window.innerHeight];}else{return[document.documentElement.clientWidth,document.documentElement.clientHeight];}}
function getNameAndId(element,arrayNotation){var result;if(element.id){var indexStart=arrayNotation?element.id.indexOf('['):element.id.lastIndexOf('_');if(indexStart>=0){var name=element.id.substring(0,indexStart);var id=element.id.substring(indexStart+1,element.id.length-(arrayNotation?1:0));result={'name':name,'id':id};}}
return result;}
function getId(element,arrayNotation){var result=getNameAndId(element,arrayNotation);return result?result.id:null;}
function prependPath(s){return R.utils.prependPath(s);}
function photoParameters(src){var p="owner="+escape(document.location.pathname.replace("/photos",""));if(src)p+="&src="+src;return p;}
function navigateToFirstLink(element,new_window){var elements=element.getElementsByTagName('a');if(elements.length>0){var href=elements[0].getAttribute('href');if(href!='#'){if(!new_window){document.location.href=href;}else{window.open(href);}}}}
function navigateWithSelect(select){document.location.replace(select.options[select.selectedIndex].value)}
function locationMapClicked(marker){if(marker&&marker.data){Element.show('map_indicator');new Ajax.Updater('location_results','/people/geo/browse?'+$H(marker.data).toQueryString(),{method:'get',onComplete:function(){Element.hide('map_indicator')}});}}
function tableRowSelected(row){nid=getNameAndId(row,true);if(nid){if(nid.name=='edit_pattern'){document.location.href='/patterns/edit/'+nid.id;}else{document.location.href=prependPath(nid.id);}}}
function projectPhotoUpdated(){}
function suggest(event,model,field,force){var id=model+'_'+field+'_id';var name=model+'_'+field+'_name';var prompted=model+'_'+field+'_prompted';var value=$(name).value;var previous=autocompletes[id];var changed=!previous||(previous!=value);autocompletes[id]=value;if($(prompted)){$(prompted).value="false";}
if(changed||force){if(changed){$(id).value="";}
if(value!=""){var controller;if(field=='pattern'){if($('pattern_information')){new Effect.Fade('pattern_information');}
controller='patterns';}else if(field=='yarn'){if($('yarn_information')){new Effect.Fade('yarn_information');}
controller='yarns';}else if(field=='shop'){controller='shops';}else if(field=='fiber_company'){controller='fibers/brands';}
if(controller){var src=model+'_'+field;var url='/'+controller+'/suggestions?src='+src+'&query='+encodeURIComponent(value);if(suggesters[controller]!=url){suggesters[controller]=url;var box=name+'_suggestions';var indicator=$(name+'_indicator');if(indicator){if(R.swatch.isSwatching('FRONTEND12')){indicator.src='/images/assets/icons/ui/tiny-loader.svg';indicator.className='icon_16 i-icon o-icon--loading_tiny';}else{indicator.src='/images/circle-ball-dark-antialiased.gif';}}
new Ajax.Request(url+'&suggestions='+box,{asynchronous:true,evalScripts:true,onComplete:function(){suggesters[controller]=null;if(indicator)indicator.src='/images/silk-link.png';if(R.swatch.isSwatching('FRONTEND12')&&indicator){indicator.src='/images/assets/icons/ui/link.svg?v=22';}}});}}}}}
function suggestionSelected(field,selected_id,selected_name){var id=$(field+'_id')
var name=$(field+'_name')
if(!selected_id){selected_id='';}
id.value=selected_id;autocompletes[field]=selected_name;var indexed=false;if(field.indexOf('packs_')==0){indexed=true;indexed_summary=$(field+"_summary");}
if(!selected_id){if(field=='project_pattern'){$('project_classifications').show();$('pattern_summary_content').innerHTML='';Element.hide($('pattern_summary'));}else if(field=='queued_project_pattern'){R.queue.updateHiddenElements();}
if(field=='project_yarn'||field=='stash_yarn'){$('yarn_summary_content').innerHTML='';Element.hide($('yarn_summary'));}
if(field=='stash_yarn'){$('stash_summary').innerHTML='';Element.hide($('stash_summary'));}else if(indexed&&field.indexOf('_yarn')>0){updateYarnSummaries(selected_id,field.indexOf('packs')>=0,field);}}else{name.value=selected_name;if(field=='project_pattern'){$('project_classifications').hide();R.coreItems.updatePatternSummary(selected_id);Element.show($('pattern_summary'));}else if(field=='queued_project_pattern'){new Ajax.Request(prependPath('pattern_selected?pattern_id='+selected_id),{asynchronous:true,evalScripts:true,method:'get'});}
if(field=='stash_yarn'){updateStashSummary(selected_id);Element.show($('stash_summary'));R.coreItems.updateYarnSummary(selected_id);Element.show($('yarn_summary'));}else if(field.indexOf('_yarn')>0){updateYarnSummaries(selected_id,field.indexOf('packs')>=0,field);}}
suggestionsClosed(field);}
function suggestionsClosed(field,prompt,skip_effect){var suggestions=$(field+'_name_suggestions')
var prompted=$(field+'_prompted')
if($(prompted)){$(prompted).value=prompt?"true":"false";}
if(!prompt){if(suggestions){if(skip_effect){Element.hide(suggestions);}else{new Effect.DropOut(suggestions);}}}else{if(suggestions){new Effect.Fade(suggestions);}}}
function suggestionPromptCancelled(field,prompt){var prompted=$(field+'_prompted')
if($(prompted)){$(prompted).value="false";}
if(field=='queued_project_pattern'){new Effect.Fade('pattern_information',{queue:'end'})}else if(field=='queued_project_yarn'){new Effect.Fade('yarn_information',{queue:'end'})}}
var updateDroppablesIEHacked=false;function updateDroppablesIEHack(){if(updateDroppablesIEHacked)return;updateDroppablesIEHacked=true;if(Browser.isMSIE()){Event.observe(document.body,"drag",function(){if(!/li|p|input|textarea/i.test(Event.element(event).tagName)){return false;}},false);Event.observe(document.body,"selectstart",function(){if(!/li|p|input|textarea/i.test(Event.element(event).tagName)){return false;}},false);}}
function updateDroppables(){$$('.droppable_photo').each(function(element){updateDroppablesIEHack();if(element.droppable){return;}
element.droppable=true;var cropper=$('cropper_'+getId(element));if(cropper){if(Browser.hasTouchEvents){cropper.style.display='block';}else{Event.observe(element,'mouseover',function(event){cropper.style.display='block';});Event.observe(element,'mouseout',function(event){cropper.style.display='none';});}}
Droppables.add(element,{hoverclass:'hover',accept:'draggable_photo',onDrop:function(drop){var src=drop.getAttribute("original")?drop.getAttribute("original"):drop.src;if(element.id=="photo_placeholder"){var indicator=$('placeholder_indicator');indicator.style.display='block';new Ajax.Request('/photos',{method:'post',postBody:photoParameters(src),onComplete:function(req){indicator.style.display='none';new Insertion.Before('photo_placeholder_border',req.responseText);updateDroppables();updateSortables();}});}else{element.style.backgroundImage="url('"+src+"')";element.style.backgroundRepeat="no-repeat";element.style.backgroundPosition="0px 0px";new Ajax.Request('/photos/'+getId(element),{method:'post',postBody:photoParameters(src)+"&_method=put",onComplete:function(req){new Insertion.Before('photo_placeholder_border',req.responseText);updateDroppables();}});}}});if(cropper){var droppablePhoto=new Draggable(cropper,{longPress:false,'reverteffect':function(element,top_offset,left_offset){new Effect.Move(element,{x:-left_offset,y:-top_offset,duration:0});}});droppablePhoto.startDrag=function(event){};droppablePhoto.endDrag=function(event){this.previousLeft=null;this.previousTop=null;if(this.cropperPos){cropper.style.left=this.cropperPos[0]+"px";cropper.style.top=this.cropperPos[1]+"px";cropper.style.visibility="visible";}
if(this.moved){params=photoParameters()+'&_method=put&x_offset='+this.xOffset+"&y_offset="+this.yOffset;new Ajax.Request('/photos/'+getId(element),{method:'post',postBody:params});}
Event.stop(event);};droppablePhoto.updateDrag=function(event,pointer){var loc=Position.cumulativeOffset(element);var left=pointer[0]-loc[0];var top=pointer[1]-loc[1];if(!this.cropperPos){this.cropperPos=[cropper.offsetLeft,cropper.offsetTop];}
if(this.previousLeft&&this.previousTop){topNudge=top-this.previousTop;leftNudge=left-this.previousLeft;if(element.style.backgroundPosition){var previous=element.style.backgroundPosition.split(" ");var previousLeft=parseInt(previous[0].replace("px",""));var previousTop=parseInt(previous[1].replace("px",""));this.yOffset=previousLeft+leftNudge;this.xOffset=previousTop+topNudge;cropper.style.left=(cropper.offsetLeft+leftNudge)+"px";cropper.style.top=(cropper.offsetTop+topNudge)+"px";cropper.style.visibility="hidden";element.style.backgroundPosition=this.yOffset+"px "+this.xOffset+"px";this.moved=true;}}
this.previousLeft=left;this.previousTop=top
Event.stop(event);};}});}
function updateDraggables(){$$('.draggable_photo').each(function(element){new Draggable(element,{'scroll':window,'longPress':false,'ghosting':true,'revert':true,'reverteffect':function(element,top_offset,left_offset){new Effect.Move(element,{x:-left_offset,y:-top_offset,duration:0});}});});}
function updateSortables(){if($('photo_browser')){Sortable.create('photo_browser',{tag:'div',only:'sortable',constraint:null,longPress:false,overlap:'horizontal',onUpdate:function(huh){params=Sortable.serialize('photo_browser',{'tag':'div','name':'photo_order'});new Ajax.Request('/photos/reorder',{method:'post',postBody:params,evalScripts:true});}});}}
function updateZoomables(){R.photos.updateZoomables();}
function updateLibrarySortables(){if($('volumes')&&$('volumes').hasClassName('sortable')){Sortable.create('shelved_books',{tag:'div',only:'volume',longPress:false,handle:'mover',constraint:null,scroll:window,onUpdate:saveLibrarySortOrder});}}
function saveLibrarySortOrder(e){var ids=new Array();$$('#shelved_books .volume').each(function(element){if(Element.visible(element)){ids.push("volume[]="+getId(element));}});new Ajax.Request(prependPath('sort?'+ids.join('&')),{asynchronous:true});}
function updateMenuLinks(parentId){var selector='.menu_link a';if(parentId){selector=parentId+" "+selector;}
updateMenuLinksForSelector(selector);updateMenuLinksForSelector('a.menu_link');}
function updateMenuLinksForSelector(selector){$$(selector).each(function(element){Event.observe(element,'click',function(event){var menuId=element.parentNode.id+"_menu";if(!$(menuId)&&R.swatch&&R.swatch.isSwatching('FRONTEND12')){menuId=element.id+"_menu";}
if(!$(menuId))return;var observerClass=element.parentNode.id+"_observer";Event.stop(event);$$('#'+menuId+' .close a').each(function(element){Event.observe(element,'click',function(event){Element.hide(menuId);Event.stop(event);});});if(Element.visible(menuId)){Element.hide(menuId);$$('.'+observerClass).each(function(element){Element.removeClassName(element,'active_menu');});}else{var selectInput=function(){var input=null;$$("#"+menuId+" input").each(function(element){if(input==null&&element.type!='hidden'){input=element;}});if(input){Field.focus(input)}};$$('.'+observerClass).each(function(element){Element.addClassName(element,'active_menu');});Element.show(menuId);if(selectInput)selectInput();}});});}
function updateDialogLinks(){$$("a.dialog").each(function(a){Event.observe(a,'click',function(event){var box=a.id+'_redbox';initializeRedbox(box);RedBox.loading();new Ajax.Updater(box,a.getAttribute('href'),{asynchronous:true,onComplete:function(request){RedBox.addHiddenContent(box);},evalScripts:true});Event.stop(event)});});}
function updateYarnSummaries(selected_id,pack,field){var yarn_ids=new Array();$$('form input.yarn_id').each(function(element){yarn_ids.push("yarn_ids[]="+element.value);});var summary_id="yarn_"+selected_id+"_summary";var on_complete=function(){if($('yarn_'+selected_id+'_content')){new Effect.Highlight('yarn_'+selected_id+'_content',{duration:.5});R.controls.updateRatingControls(summary_id);}}
if(pack){var url=prependPath('yarn_selected?yarn_id='+selected_id+'&field='+field+'&'+yarn_ids.join('&'))
url=url.replace('/contribute/','/');url=url.replace('/edit/','/');new Ajax.Request(url,{asynchronous:true,evalScripts:true,method:'get',onComplete:on_complete})}else if($('yarn_summaries')){var url=prependPath('yarns?'+yarn_ids.join('&')).replace('/edit/','/');new Ajax.Updater('yarn_summaries',url,{onComplete:on_complete});}}
function updateStashSummary(id){new Ajax.Updater('stash_summary',prependPath('summary?yarn_id='+id),{method:'get',onComplete:function(){new Effect.Highlight('stash_summary',{duration:.5});}});}
function avatarMouseOver(element){if(balloon.timeout){clearTimeout(balloon.timeout);}
balloon.timeout=setTimeout(function(){avatarBalloon(element);},1000);}
function avatarMouseOut(avatar){balloonCloser();}
function updateAvatars(){}
function balloonCloser(event){if(balloon.timeout){clearTimeout(balloon.timeout);}
if(balloon.cur){balloon.timeout=setTimeout(function(){balloon.cur.hide();},500);}}
function avatarBalloon(element){if(element.id&&element.id.indexOf('avatar_')==-1){var login=element.id;if(login.indexOf('_')>=0){login=login.replace('ab_','').replace('user_','');}
balloon.cur=new HelpBalloon({title:login,returnElement:true,dataURL:'/people/'+login+'/bubble'});new Insertion.Bottom(document.body,'<span id="'+balloon.cur.properties.id+'"></span>');balloon.cur.elements.icon=$(element).getElementsByTagName('img')[0]||element;balloon.cur.show();var bubble=balloon.cur.elements.container;Event.observe(bubble,'mouseover',function(event){if(balloon.timeout){clearTimeout(balloon.timeout);}
Event.observe(bubble,'mouseout',balloonCloser);});}}
function adminLoaded(){discussionsLoaded();}
function dialogLoaded(){}
function discussionsLoaded(){R.forums.onload();}
function slideshowLoaded(){}
function editorLoaded(){$$('.remote_image').each(function(element){Event.observe(element,'load',function(){new Effect.Appear(element);});});updateSortables();updateDraggables();updateDroppables();}
function removeMarkdownEditor(textarea_id){if(R.drafts){R.drafts.cancelDraft($(textarea_id));}
var t=wmd_instances[textarea_id];wmd_instances[textarea_id]=null;if(t&&t.editor){t.editor.destroy();}
if(t&&t.previewManager){t.previewManager.destroy();}}
function applyDelayedEditors(){if(typeof(Attacklab)!='undefined'&&Attacklab&&Attacklab.wmd&&Attacklab.wmd.editor){$A(wmd_delayed).each(function(d){applyMarkdownEditor(d);});}else{setTimeout(function(){applyDelayedEditors();},50);}}
function applyMarkdownEditor(textarea,preview){if(typeof(Attacklab)!='undefined'&&Attacklab&&Attacklab.wmd&&Attacklab.wmd.editor){if($(textarea)){wmd_instances[textarea]={editor:new Attacklab.wmd.editor($(textarea)),previewManager:null};if(R.controls.markdownSuggesterEnabled){new R.controls.MarkdownSuggester(textarea);}
if(R.drafts){R.drafts.enableDraft(textarea);}
if(R.markdown){R.markdown.addEditorFeatures(textarea);}}}else{wmd_delayed.push(textarea);}}
function triggeredMarkdownEditor(f,focus){var textarea=$(f);var preview=$(f+"_html");var content=$(f+"_content");var focusTextarea=focus;if(preview){Event.observe(preview,'click',function(){Element.hide(preview);Element.show(textarea);if(content){Element.show(content);if(focusTextarea){R.utils.focusTextField(textarea);}}});}}
function addOpenSearch(){window.sidebar.addSearchEngine("http://www.ravelry.com/search.src","http://www.ravelry.com/favicon.ico","Ravelry","Web");}
function initializeRedbox(box){if(!$(box)){new Insertion.Bottom(document.body,"<div id='"+box+"'></div>");}}
function slideLoading(){Element.show('default_indicator');}
function slideLoaded(){R.photos.slideLoaded();}
function slideshowRedbox(){return false;}
function setCookie(name,value,expires,path,domain,secure){if(typeof(secure)=='undefined'){secure=true;}
if(value.length>2048){value=value.substring(0,2048);}
value=encodeURIComponent(value);document.cookie=name+"="+value+'; SameSite=None'+
((expires)?"; expires="+expires.toGMTString():"")+
((path)?"; path="+path:"")+
((domain)?"; domain="+domain:"")+
((secure)?"; secure":"");}
function getCookie(name){var dc=document.cookie;var prefix=name+"=";var begin=dc.indexOf("; "+prefix);if(begin==-1){begin=dc.indexOf(prefix);if(begin!=0)return null;}else{begin+=2;}
var end=document.cookie.indexOf(";",begin);if(end==-1){end=dc.length;}
var cookie="";try{cookie=decodeURIComponent(dc.substring(begin+prefix.length,end));}catch(er){}
return cookie;}
function deleteCookie(name,path,domain){if(getCookie(name)){document.cookie=name+"="+
((path)?"; path="+path:"")+
((domain)?"; domain="+domain:"")+"; expires=Thu, 01-Jan-70 00:00:01 GMT";}}
function setWidthCookie(){if(window.innerWidth){deleteCookie('last_inner_width');setCookie('last_inner_width',window.innerWidth,null,'/');if(Element.hasClassName(document.body,'rsp')){setCookie('responsive_inner_width',window.innerWidth,null,'/');}}}
function captchaReady(){var captcha=null;if(navigator.appName.indexOf("Microsoft")!=-1){captcha=window['captcha'];}else{captcha=document['captcha'];}
if(captcha){var id=captcha.fGetId();if(id!="null"&&id!=null&&id!=''){var expires=new Date((new Date()).getTime()+(1000*60*60*24*365*10));setCookie('captchaid',id,expires,'/');if(window.localStorage){try{localStorage.setItem("captchaid",id);}catch(e){}}}else{id=getCookie('radvid');if(id&&id!=''){captcha.fSetId(id);}}}}
function localStorageReady(){var localStorageUsed=false;if(window.localStorage){try{var id=localStorage.getItem("captchaid");if(id!=null&&id!=''){var cookieId=getCookie('captchaid');if(cookieId!=id){var expires=new Date((new Date()).getTime()+(1000*60*60*24*365*10));setCookie('captchaid',id,expires,'/');}
localStorageUsed=true;}}catch(e){}
if(!localStorageUsed){var cookieId=getCookie('radvid');if(cookieId!='null'&&cookieId!=null&&cookieId!=''&&cookieId!=id){try{localStorage.setItem("captchaid",cookieId);}catch(e){}}}
R.forums.drafts.migrateUnsavedDrafts();}}
R.behaviors=function(){var registry=$H({});return{register:function(key,func){if(!registry[key]){registry[key]=$A();}
registry[key].push(func);},applyBehavior:function(key){var funcs=registry[key];if(funcs){funcs.each(function(f){f();});}},applyAll:function(){registry.each(function(pair){pair.value.each(function(f){f();});});}};}();R.behaviors.register("character_counted",function(){$$('.character_counted').each(function(input){var maxLength=parseInt(input.getAttribute('maxLength'));input.setAttribute('maxLength',99999);input.observe('keyup',function(){var display=input.next('.character_count')||input.previous('.character_count')||$('character_count');if(display){var currentLength=input.value.length;var message="";if(currentLength<(maxLength/1.5)){message="";}else if(currentLength<=maxLength){message=maxLength+" characters or less. <strong>"+(maxLength-currentLength)+"</strong> characters remaining.";}else{message="Too long! Remove at least <strong>"+(currentLength-maxLength)+"</strong> characters";}
display.innerHTML=message;if(message==""){$(display).hide();$(display).removeClassName('character_count_active');}else{$(display).show();$(display).addClassName('character_count_active');}}
return true;});});});R.behaviors.register("clickable_once",function(){$$('.clickable_once').each(function(link){link.observe('click',function(){link.onclick=function(){return false;};var img=$(link).down('img');if(img){if(R.swatch.isSwatching('FRONTEND12')){img.src='/images/assets/icons/ui/tiny-loader.svg';img.className='icon_16 i-icon o-icon--loading_tiny';}else{img.src='/images/circle-ball-dark-antialiased.gif';}}
return true;});});});R.behaviors.register('submit_in_progress',function(){$$('form.submit_in_progress').each(function(form){form.observe('submit',function(){$(form).addClassName('submit_in_progress--active');var button=form.down('.clicker');var indicator=button.parentNode.down('.submit_in_progress__indicator');if(!indicator){indicator=R.controls.createAjaxIndicator();indicator.className='submit_in_progress__indicator';button.parentNode.insertBefore(indicator,button);}
return true;});});});R.behaviors.register("defaulted_input",function(){$$('input.defaulted_input').each(function(input){var defaultValue=input.getAttribute('data-default');var keepValue=input.getAttribute('data-default-keep')=='1';if(!defaultValue||input.__applied_defaulted_input){return;}
input.__applied_defaulted_input=true;var form=input.up('form');if(form&&!form.__url_input_field){form.__url_input_field=true;var currentSubmit=form.onsubmit;form.onsubmit=function(){form.getElementsBySelector('input.defaulted_input').each(function(child){if(child.getAttribute('data-default')==child.value){child.value='';}});if(currentSubmit){return currentSubmit();}else{return true;}};}
if(input.value==''){input.value=defaultValue;}
Event.observe(input,'focus',function(e){if(input.value==defaultValue){if(!keepValue)input.value='';input.select();}});var dimWhenDefault=function(){if(input.value==defaultValue){input.addClassName('default_value');}else{input.removeClassName('default_value');}};dimWhenDefault();Event.observe(input,'keyup',dimWhenDefault);Event.observe(input,'blur',function(){if(input.value==''){input.value=defaultValue;dimWhenDefault();}});});});R.behaviors.register("image_field",function(){R.controls.initializeImageFields();});R.behaviors.register("html5_autofocus",function(){var input=$$('input[autofocus]').first();if(input)input.focus();});R.behaviors.register("toggle_button",function(){$$('.toggle_button label').each(function(label){label.observe('click',function(){label.up().siblings().each(function(sibling){siblingLabel=sibling.down('label');if(siblingLabel){siblingLabel.removeClassName('selected');}});label.addClassName('selected');return true;});});});R.behaviors.register("toggle_select",function(){$$('select').each(function(select){var when=select.getAttribute('data-toggle-when');if(when&&when!=''){var toggler=function(){var field=select.getAttribute('data-toggle-on');if(R.utils.selectedValue(select)==when){$(field).show();}else{$(field).hide();}
var input=$(field).down('input');if(input){R.utils.focusTextField(input);}};Event.observe(select,'change',toggler);Event.observe(select,'keyup',toggler);toggler();}});});R.pageview={};R.pageview.unloaded=false;R.pageview.base='/sinatra';R.pageview.img=null;R.pageviewComplete=function(data){R.pageview.img=new Image(1,1);if(data['url']){var unloadUrl=(R.pageview.base+data['url']).replace('/pageview/','/unload/');var unloader=function(tag){if(!R.pageview.unloaded){R.pageview.unloaded=true;R.pageview.img.src=unloadUrl;}};window.addEventListener('beforeunload',function(){console.log('beforeunload');});window.addEventListener('pagehide',function(){unloader('pagehide');});window.addEventListener('visibilitychange',function(){if(document.hidden){unloader('visibilitychange');}});}
if($('visits_today')){if(data['visits_24h']&&data['visits_24h']>1){$('visits_today').style.visibility='visible';$('visits_today_count').innerHTML=parseInt(data['visits_24h']);}
if(data['visits_5m']&&data['visits_5m']>1){$('visits_now').style.visibility='visible';$('visits_now_count').innerHTML=parseInt(data['visits_5m']);}}};R.locale=function(){return{changeLocale:function(code){setCookie('change_locale',code,null,'/');document.location.reload();}};}();R.Storage=function(){var available=null;return{hset:function(key,hashKey,object){object=Object.clone(object);object.__lru=(new Date()).getTime();object.__id=hashKey;var hash={};var serialized=localStorage.getItem(key);if(serialized){hash=serialized.evalJSON(true);}
hash[hashKey]=object;localStorage.setItem(key,Object.toJSON(hash));},hgetall:function(key,includeKeys){var serialized=localStorage.getItem(key);var hash={};if(serialized){hash=serialized.evalJSON(true);}
if(includeKeys){return hash;}else{return $H(hash).values();}},hdel:function(key,hashKey){var hash=R.Storage.hgetall(key,true);delete hash[hashKey];localStorage.setItem(key,Object.toJSON(hash));},htrim:function(key,lruCount){var trimmedHash={};var values=R.Storage.hgetall(key);values.sort(function(a,b){return b.__lru-a.__lru;});if(values.length>lruCount){for(var i=0;i<lruCount;i++){var value=values[i];trimmedHash[value.__id]=value;}
localStorage.setItem(key,Object.toJSON(trimmedHash));}}};}();R.NullStorage=function(){return{hset:function(){},hdel:function(){},hgetall:function(key,includeKeys){return includeKeys?{}:[];},htrim:function(){}};}();try{localStorage.setItem('localStorageTest','1');localStorage.removeItem('localStorageTest');}catch(e){R.Storage=R.NullStorage;}
R.accounts=function(){var delayedCheck=null;var cloudCover=null;var splashTakeoverSubmitDelay=350;var loginTransitionTime=1000;return{initialize:function(){var resetExplanation=$('no_reset_email_explanation');var radio=$('email_index_');if(resetExplanation&&radio){setInterval(function(){radio.checked?resetExplanation.show():resetExplanation.hide();},50);}
if($('email')&&$('email').value!=''&&$('password')){$('password').focus();}},submitPasswordReset:function(form){if($('password_errors')){new Effect.BlindUp($('password_errors'),{duration:0.250});}
$('reset_indicator').show();$(form).down('.clicker').hide();setTimeout(function(){form.submit();},1000);return false;},initializeLogin:function(){if($('user_login')){Field.focus('user_login');}
var returnTo=$('return_to');if(returnTo&&returnTo.value!==''&&returnTo.value.indexOf('#')<0){if(window.location.hash!==''){returnTo.value=returnTo.value+window.location.hash;}}
var smallBreakpoint=window.matchMedia("(max-width: "+Browser.smallBreakpointWidth+"px)").matches;var takeover=$(document.body).hasClassName('splash--with_takeover');if(takeover&&smallBreakpoint){var loginTop=$$('.splash_page__login').first().offsetTop;window.scroll({top:loginTop,left:0,behavior:'smooth'});}
$$('.splash_page__video--dynamic').each(function(video){if(window.getComputedStyle(video).display!="none"){var source=document.createElement('source');source.src=video.getAttribute('data-source-src-1');source.type=video.getAttribute('data-source-type-1');video.appendChild(source);var source=document.createElement('source');source.src=video.getAttribute('data-source-src-2');source.type=video.getAttribute('data-source-type-2');video.appendChild(source);var source=document.createElement('source');source.src=video.getAttribute('data-source-src-3');source.type=video.getAttribute('data-source-type-3');video.appendChild(source);video.setAttribute('preload','auto');}else{video.setAttribute('data-hidden','true');}});R$$('form').each(function(form){var password=form.down("input[type='password']");var revealButton=form.down('.splash_page__reveal');var ariaLive=form.down('[aria-live]');if(revealButton){var matchPasswordAndRevealColor=function(){var bg=window.getComputedStyle(password).backgroundColor;if(bg){revealButton.style.backgroundColor=bg;}};revealButton.observe('click',function(e){form.toggleClassName('with_reveal_password');if(form.hasClassName('with_reveal_password')){password.setAttribute('type','text');ariaLive.innerHTML='Your password is now visible';}else{password.setAttribute('type','password');ariaLive.innerHTML='Your password is now hidden';}
R.utils.focusTextField(password);matchPasswordAndRevealColor();e.preventDefault();return false;});matchPasswordAndRevealColor();setTimeout(function(){matchPasswordAndRevealColor();},100);document.addEventListener('focusin',function(e){matchPasswordAndRevealColor();});document.addEventListener('focusout',function(e){matchPasswordAndRevealColor();});}
Event.observe(form,'submit',function(e){if(takeover&&!$(document.body).hasClassName('with_form_submit')){setTimeout(function(){form.submit();},splashTakeoverSubmitDelay);$$('.splash_page__throbber').each(function(throbber){throbber.addClassName('splash_page__throbber--active');});window.scroll({top:loginTop,left:0,behavior:'smooth'});if(smallBreakpoint){window.scroll({top:0,left:0,behavior:'smooth'});}
$(document.body).addClassName('with_form_submit');Event.stop(e);return false;}else if($('splash_video')){R.accounts.loginWithTransition(form);Event.stop(e);}else{$(document.body).addClassName('with_form_submit');}});});if($('splash_page_balloon_bob')){var reducedMotion=window.matchMedia&&window.matchMedia('(prefers-reduced-motion: reduce)').matches
if(!reducedMotion){cloudCover=new R.splash.CloudCover();}
$$('.splash_page__motion_controls a').each(function(control){var action=control.getAttribute('data-action');if(action=='play'){control.observe('click',function(e){$(document.body).removeClassName('without_motion');if(cloudCover)cloudCover.startClouds(true);Event.stop(e);$$('.splash_page__motion_controls__pause').first().focus();});}else if(action=='pause'){control.observe('click',function(e){$(document.body).addClassName('without_motion');if(cloudCover)cloudCover.stopClouds();Event.stop(e);$$('.splash_page__motion_controls__play').first().focus();});}});}},loginWithTransition:function(form){R.accounts.toggleTransition(true);var submit=$$("button[type='submit']").first();if(submit){submit.focus();}
setTimeout(function(){form.submit();},loginTransitionTime);},toggleTransition:function(formSubmit){if(formSubmit||!$(document.body).hasClassName('with_interstitial')){var video=document.querySelector('video:not([data-hidden])');if(video&&!R.utils.reduceMotion()){video.playbackRate=1;video.play();}
$(document.body).addClassName('with_interstitial');if(formSubmit){$(document.body).addClassName('with_form_submit');}
if(!window.pageHideEvent){window.pageHideEvent=window.addEventListener("pagehide",function(){$(document.body).removeClassName('with_interstitial');$(document.body).removeClassName('with_form_submit');},false);}}else{$(document.body).removeClassName('with_form_submit');$(document.body).removeClassName('with_interstitial');}},logout:function(){var tokenContainer=$('authenticity-token');var form=document.createElement('form');form.style.display='none';document.body.appendChild(form);form.method='POST';form.action='/account/logout';var input=document.createElement('input');input.setAttribute('type','hidden');input.setAttribute('name','authenticity_token');if(tokenContainer){input.setAttribute('value',tokenContainer.content);}
form.appendChild(input);form.submit();},delayedCheckUsername:function(username){if(delayedCheck){clearTimeout(delayedCheck);delayedCheck=null;}
delayedCheck=setTimeout(function(){R.accounts.checkUsername(username);},500);},checkUsername:function(username){var email='';if(!username){username=$('user_login').value;email=$('email').value;}
new Ajax.Request('/account/check?username='+username+'&email='+email);}};}();R.splash=function(){};R.splash.CloudCover=function(){var me=this;this.initialClouds=$A();this.clouds=$A();this.waiting=false;Event.observe(document,'visibilitychange',function(){if(document.visibilityState==='visible'){me.waiting=false;}else{me.waiting=true;}});};R.splash.CloudCover.prototype.initialize=function(){if(!this.initialized){this.initialized=true;var me=this;$$('.splash_page__cloud').map(function(element){var cloud=new R.splash.CloudCover.Cloud(element);me.initialClouds.push(cloud);me.clouds.push(cloud);});}}
R.splash.CloudCover.Cloud=function(element,initializeStyle){var me=this;var offscreenLeft='-17vw';var offscreenRight='117vw';this.element=$(element);this.cloudSize=this.element.getAttribute('data-cloud-size');this.cloudAspect=parseFloat(this.element.getAttribute('data-cloud-aspect'));this.paused=true;if(this.cloudSize=='small'){this.size=1;}else if(this.cloudSize=='medium'){this.size=2;}else if(this.cloudSize=='large'){this.size=3;}else{this.size=0;}
this.element.style.transition='transform '+(100*this.size/3.0)+'s linear';if(initializeStyle){this.element.className='splash_page__cloud has_motion';this.element.setAttribute('data-size',this.size);this.element.style.transform='translate('+offscreenLeft+', 0)';var widthPercentage={1:10,2:16.5,3:15}[this.size]
this.element.style.width=widthPercentage+'vw';this.element.style.height=(widthPercentage*this.cloudAspect)+'vw';this.element.style.top=Math.floor(Math.random()*90)+'%';setTimeout(function(){me.element.style.transform='translate('+offscreenRight+', 0)';},10);}else{this.element.style.transform='translate('+offscreenRight+', 0)';}};R.splash.CloudCover.prototype.stopClouds=function(){this.paused=true;this.initialized=false;$$('.splash_page__cloud').map(function(cloud){cloud.style.transform=window.getComputedStyle(cloud).transform;});}
R.splash.CloudCover.prototype.startClouds=function(unpause){if(unpause){this.paused=false;}
if(this.waiting||this.paused){return;}
if(!this.initialized){this.initialize();}
var me=this;this.addCloud(this.initialClouds);var time=5000+Math.floor(Math.random()*1000);setTimeout(function(){me.startClouds();},time);}
R.splash.CloudCover.prototype.addCloud=function(choices){var newCloud=document.createElement('DIV');newCloud.className=''
var choice=Math.floor(Math.random()*choices.length);var cloudSize=choices[choice].cloudSize;var cloudAspect=choices[choice].cloudAspect;newCloud.setAttribute('data-cloud-size',cloudSize);newCloud.setAttribute('data-cloud-aspect',cloudAspect);choices[0].element.parentNode.insertBefore(newCloud,choices[0].element);new R.splash.CloudCover.Cloud(newCloud,true);};R.admin={};R.admin.yarns=function(){var selectedYarnList=function(){var ids=new Array();$$('input.yarn_id_checkbox').each(function(element){if(element.checked)ids.push(element.getAttribute("value"));});return ids.join(',');};return{expungeSelectedYarns:function(){$('expunge_yarn_list').value=selectedYarnList();$('expunge_yarn_form').submit();},mergeSelectedYarns:function(){$('merge_yarn_list').value=selectedYarnList();$('merge_yarn_form').submit();},mergeTo:function(toYarnId){$('to_yarn_id').value=toYarnId;$('merge_form').submit();$$('.merge .clicker').each(Element.hide);Element.show($('default_indicator'));},expunge:function(yarnId){$$('#mini_yarn_'+yarnId+' .merge .clicker').each(Element.hide);Element.show($('yarn_'+yarnId+'_indicator'));new Ajax.Request('/yarns/library/'+yarnId+'/expunge',{method:'post',evalScripts:true});}};}();R.admin.patterns=function(){var selectedPatternList=function(){var ids=new Array();$$('input.checkbox#pattern_id').each(function(element){if(element.checked){ids.push(element.getAttribute("value"));}});return ids.join(',');};return{mergeSelectedPatterns:function(){$('merge_pattern_list').value=selectedPatternList();$('merge_pattern_form').submit();},moveSelectedPatterns:function(){$('move_pattern_list').value=selectedPatternList();$('move_pattern_form').submit();},expungeSelectedPatterns:function(){$('expunge_pattern_list').value=selectedPatternList();$('expunge_pattern_form').submit();},mergeTo:function(toPatternId){$('to_pattern_id').value=toPatternId;$('merge_form').submit();$$('.merge .clicker').each(Element.hide);Element.show($('default_indicator'));},expunge:function(patternId){$$('#mini_pattern_'+patternId+' .merge .clicker').each(Element.hide);Element.show($('pattern_'+patternId+'_indicator'));new Ajax.Request('/patterns/library/'+patternId+'/expunge',{method:'post',evalScripts:true});},expungeTemplate:function(select){var textarea=$(select).up('form').down('textarea');if(textarea.value===''&&select.selectedIndex>0){textarea.value=select.options[select.selectedIndex].value+". ";textarea.focus();R.utils.setSelectionRange(textarea,textarea.value.length,textarea.value.length);}},findByUrl:function(url,index){new Ajax.Request('/patterns/find_by_url?url='+encodeURIComponent(url)+"&index="+index,{method:'get'});}};}();R.admin.patternSources=function(){return{mergeTo:function(toPatternSourceId){Element.show($('default_indicator'));$('merge_into_pattern_source_id').value=toPatternSourceId;$('merge_form').submit();$$('.merge .clicker').each(Element.hide);},findByUrl:function(url,index){new Ajax.Request('/patterns/sources/find_by_url?url='+encodeURIComponent(url)+"&index="+index,{method:'get'});}};}();R.admin.shops=function(){return{findByUrl:function(url,index){new Ajax.Request('/shops/find_by_url?url='+encodeURIComponent(url)+"&index="+index,{method:'get'});}};}();var Admin={Patterns:R.admin.patterns,Yarns:R.admin.yarns}
R.ads=function(){var STATUS_REVISION=7;var shown=new Array();var yarnLinkZoneLoaded=false;var sawMouseOrTouch=false;return{observe:function(zone){if(window.performance&&window.performance.navigation.type===2){$$('.clipper').each(function(c){c.style.visibility='visible';});}
if(['notebook_vertical','forum_topic','group_topic','pattern_projects','featured_source','featured_crochet_pattern','featured_pattern'].indexOf(zone)>=0){Element.observe(zone,'mouseover',function(){Element.down(zone,'.clipper').style.visibility='visible';});Element.observe(zone,'mouseout',function(){Element.down(zone,'.clipper').style.visibility='hidden';});}},more:function(zone,creativeId,targetableId,start,pager){url="/enablers/more/"+zone;if(targetableId){url+="?tid="+targetableId;}
document.location.href=url;},rewind:function(zone,creativeId,targetableId){shown.push(creativeId);var stamp=new Date().getTime()+';'+Math.random();var url="/enablers/s/"+zone+"/?s="+stamp+"&rewind="+creativeId;if(targetableId){url+="&tid="+targetableId;}
new Ajax.Request(url);},clip:function(adId,creativeId){$("cliplink_"+creativeId).innerHTML='<img src="/images/indicator_little01.gif"/>';var params={ad_id:adId,creative_id:creativeId};new Effect.Shake('img_'+creativeId);new Ajax.Request('/sponsors/clip',{parameters:params,method:'post'});},yarnLinkZoneLoaded:function(){var yarnLink=$$('li.yarn_buying_options').first();if(!yarnLinkZoneLoaded&&yarnLink){yarnLinkZoneLoaded=true;var container=yarnLink.up('.yarn_link_body');Event.observe(container,'touchstart',function(){sawMouseOrTouch=true;});Event.observe(container,'mouseover',function(){sawMouseOrTouch=true;});$A(container.getElementsByTagName('A')).each(function(link){link.onclick=function(){if(sawMouseOrTouch){var href=link.href;var sep=href.indexOf('?')>=0?'&':'?';window.location.href=href+sep+'moused='+(new Date().getTime());return false;}else{return true;}};});}},priceCheck:function(adId,targetableId,from){var container=$('price_check_'+adId);var link=container.down('a');if(!(link).hasClassName('yarn_price')){link.addClassName('active');if(R.swatch.isSwatching('FRONTEND12')){link.innerHTML=R.controls.tinyLoaderHTML();}else{link.innerHTML="<img src=\"/images/price-check-loader.gif\"/>";}}
var url='/yarn_prices/lookup?ad_id='+adId+"&yarn_id="+targetableId;if(from)url+="&from="+from;new Ajax.Request(url);},togglePriceCheck:function(adId,targetable){var container=$('price_check_'+adId);var link=container.down('a');if(link.hasClassName('popover_active')){R.popover.close();}else{R.ads.priceCheck(adId,targetable);}},testTargeting:function(targetableId){var row=$('targeting_'+targetableId);var input=row.down('input.target_url');input.value=input.value.trim();var url=input.value;if(R.utils.isURL(url)){window.open(url,'_blank');}else{alert(url+" is not a valid URL. Please check for mistakes.");}},advertiseHere:function(targetableId,targetableType){RedBox.open('advertise_here','/advertisers/here_group?group_id='+targetableId,{fade:true});},confirmGroup:function(groupId){var url=R.utils.prependPath('confirm_group?group_id='+groupId);RedBox.open('group_dialog_box',url,{method:'POST',draggable:true});},unapprove:function(id){var url='/manager/ads/'+id+'/unapprove';var params={ad_status_id:STATUS_REVISION,screen:'ad'};new Ajax.Request(url,{method:'get',parameters:params});},};}();window.yarnLinkGrecaptchaLoaded=R.ads.yarnLinkGrecaptchaLoaded;R.advertisers={};R.advertisers.initializer=function(){return{initialize:function(){if((Element.hasClassName(document.body,'advertisers_suggestions'))){R.advertisers.suggestions.initialize();}
if($('ad_block_warning')){R.advertisers.adBlockChecker.start();}}};}();R.advertisers.adBlockChecker=function(){var elementAdded=false;return{start:function(){var script=document.createElement('script');script.setAttribute("id","ad_block_checker");script.setAttribute("type","text/javascript");script.setAttribute("src","/javascripts/advertisement-for-ad-blocker-test.js");document.getElementsByTagName("head")[0].appendChild(script);elementAdded=true;setTimeout(R.advertisers.adBlockChecker.check,500);},check:function(){var blocked=typeof window.adBlockChecker=='undefined';if(elementAdded&&blocked){$('ad_block_warning').show();}else{setTimeout(R.advertisers.adBlockChecker.check,500);}}};}();R.advertisers.campaigns=function(){return{deleteCampaign:function(campaignId){if(confirm('Are you sure that you want to deactivate this campaign?')){var url=prependPath(campaignId);new Ajax.Request(url,{asynchronous:true,evalScripts:true,method:'delete'});}}};}();R.advertisers.suggestions=function(){return{initialize:function(){R.advertisers.suggestions.updateLinks();},updateLinks:function(){$('tabset').getElementsBySelector("a").each(function(link){var href=link.href.split('?');var base=href[0];var params=$H(href[1].parseQuery());params['selections']=$('selections').value;params['ad']=$('ad').value;link.href=base+"?"+params.toQueryString();});if($$('review_link a').first()){var reviewUrl='review_suggestions?selections='+$('selections').value+"&ad="+$('ad').value;$('review_link').down('a').href=reviewUrl;}
if($('selection_count_label')){var selections=$('selections').value.split(',');if(selections.length>0&&selections[0]!=''){var link="<a href='"+reviewUrl+"'>"+selections.length+" groups selected.</a>";$('selection_count_label').innerHTML=link;}}},addSelection:function(id){var selections=$('selections');var idList=id+"";if(selections.value&&selections.value!=''){idList+=","+selections.value;}
selections.value=$A(idList.split(',')).uniq().join(',');R.advertisers.suggestions.updateLinks();},removeSelection:function(id){var selections=$('selections');var ids=selections.value.split(',');var idString=id+"";selections.value=$A(ids).without(idString).join(',');R.advertisers.suggestions.updateLinks();}};}();R.advertisers.ads=function(){return{aboutAutoRenew:function(){RedBox.open('about_auto_renew','/advertisers/about/auto_renew');},chooseSlots:function(zoneId,geotargeted){geotargeted=geotargeted?"true":"false";document.location.replace("slots?zone_id="+zoneId+"&geotargeted="+geotargeted);},copyDialog:function(){RedBox.open('copy_ad_dialog_box',prependPath('prepare_copy'));},showZones:function(zoneType){var zoneTypeId=$F(zoneType);var parameters="zone_type_id="+zoneTypeId;new Ajax.Updater('available_zones','/zones/search',{asynchronous:true,evalScripts:true,method:'get',parameters:parameters});},availabilityRowClicked:function(e){var evt=e||window.event;var clicked=Event.element(evt);if(!clicked.hasClassName('ticky_box')){var tr=clicked.up('tr');tr.down('.ticky_box').onclick();}}};}();R.advertisers.targeted=function(){return{addGroup:function(groupId,from){var url=prependPath("add_targetable?targetable_type=Group&targetable_id="+groupId);if(from)url+="&from="+from;new Ajax.Request(url);},addYarnBrand:function(yarnCompanyId){new Ajax.Request(prependPath("add_targetable?targetable_type=YarnCompany&targetable_id="+yarnCompanyId));},addYarn:function(yarnId){new Ajax.Request(prependPath("add_targetable?targetable_type=Yarn&targetable_id="+yarnId));},addPattern:function(patternId){new Ajax.Request(prependPath("add_targetable?targetable_type=Pattern&targetable_id="+patternId));}};}();R.affiliates=function(){return{convertToAffiliateLink:function(href){var sep;if(href.indexOf('://www.amazon.com')>=0&&href.indexOf('://www.amazon.com/gp/redirect.html')<0){return['Ravelry&nbsp;Amazon&nbsp;link',"http://www.amazon.com/gp/redirect.html?ie=UTF8&tag=ravelryforums-20&linkCode=ur2&camp=1789&creative=9325&location="+encodeURIComponent(href)];}else if(href.indexOf('://www.amazon.ca')>=0&&href.indexOf('://www.amazon.ca/gp/redirect.html')<0){return['Ravelry&nbsp;Amazon.ca&nbsp;link',"http://www.amazon.ca/gp/redirect.html?ie=UTF8&tag=ravelry0f-20&linkCode=ur2&camp=15121&creative=330641"+encodeURIComponent(href)];}else if(href.indexOf('://www.amazon.co.uk')>=0&&href.indexOf('://www.amazon.co.uk/gp/redirect.html')<0){return['Ravelry&nbsp;Amazon.co.uk&nbsp;link',"http://www.amazon.co.uk/gp/redirect.html?ie=UTF8&tag=ravelry-21&linkCode=ur2&camp=1634&creative=6738&location="+encodeURIComponent(href)];}else if(href.indexOf('://www.amazon.co.jp')>=0&&href.indexOf('://www.amazon.co.jp/gp/redirect.html')<0){return['Ravelry&nbsp;Amazon.co.jp&nbsp;link',"http://www.amazon.co.jp/gp/redirect.html?ie=UTF8&tag=ravelry20-22&linkCode=ur2&camp=247&creative=1211"+encodeURIComponent(href)];}else if(href.indexOf('://www.amazon.fr')>=0&&href.indexOf('://www.amazon.fr/gp/redirect.html')<0){return['Ravelry&nbsp;Amazon.fr&nbsp;link',"http://www.amazon.fr/gp/redirect.html?ie=UTF8&tag=ravelry08-21&linkCode=ur2&camp=1642&creative=6746&location="+encodeURIComponent(href)];}else if(href.indexOf('://www.amazon.de')>=0&&href.indexOf('://www.amazon.de/gp/redirect.html')<0){return['Ravelry&nbsp;Amazon.de&nbsp;link',"http://www.amazon.de/gp/redirect.html?ie=UTF8&tag=ravelry-09-21&linkCode=ur2&camp=1836&creative=6742&location="+encodeURIComponent(href)];}else if(href.indexOf('://cgi.ebay.com')>=0||href.indexOf('://stores.ebay.com')>=0||href.indexOf('://search.ebay.com')>=0||href.indexOf('://shop.ebay.com')>=0){return['Ravelry&nbsp;eBay&nbsp;link',"http://rover.ebay.com/rover/1/711-53200-19255-0/1?type=4&campid=5335842904&toolid=10001&customid=&mpre="+encodeURIComponent(href)];}else{return['Ravelry&nbsp;link',href];}},revealAffiliateLink:function(link){if(!link)return false;if(document.body.className&&document.body.className.indexOf('topics_show')<0&&document.body.className.indexOf('groups_show'))return false;link=$(link);var converted=R.affiliates.convertToAffiliateLink(link.href);var next=link.next();var reveal=converted[1]!=link.href&&(!next||(next&&next.className!='revealed_affiliate_link'));if(reveal){var html='&nbsp;<span class="revealed_affiliate_link" style="display: none; padding-left: 5px; padding-right: 5px;background-color: #e8ffe3; border: 1px solid #ccc; font-size: .95em; padding: 1px;">';html+='<a href="'+converted[1]+'" style="text-decoration: none;" target="_new" title="Use this link to earn money for Ravelry">&nbsp;<img src="/images/silk-money.png" class="inline"/>&nbsp;'+converted[0]+'&nbsp;</a></span>';new Insertion.After(link,html);next=link.next();if(next){new Effect.Appear(next);}}
return reveal;}};}();R.analytics=function(){var outclickDomain='ravelry.com';var outclickTracker='https://stats.ravelry.com/outclick/';var outclickPause=250;var outclicked=false;var esc=function(s){return(typeof encodeURIComponent=='undefined')?escape(s):encodeURIComponent(s);};return{reportOutclick:function(ev){var url;var target=ev?ev.target:window.event.srcElement;if(!target&&window.event){target=window.event.srcElement;}
for(var i=0;target&&i<=3;i++){if(target.tagName&&target.tagName.toLowerCase()=='a'){break;}
target=target.parentNode;}
if(target&&target.tagName&&target.tagName.toLowerCase()=='a'&&target.href&&target.href.indexOf('#')<0&&target.href.charAt(0)!='/'){url=target.href;if(!url||typeof(url)!='string'||url==""){return;}
if(url.indexOf(outclickDomain)==-1){var path=outclickTracker;path+="?outclick="+esc(url);path+="&from_title="+esc(document.title);path+="&from="+esc(self.location);if(navigator.sendBeacon){navigator.sendBeacon(path);}else{var image=new Image();outclicked=false;image.onLoad=function(){outclicked=true;};image.src=path;var now=new Date();var stopTime=now.getTime()+outclickPause;while(now.getTime()<stopTime&&!outclicked){now=new Date();}}}}}}}();R.beacon=function(){var beaconEndpoint='/beacon/receive';var activeGroups=['yarn_links'];return{initialize:function(){Ajax.Responders.register({onComplete:function(){R.beacon.addEventHandlers();}});R.beacon.addEventHandlers();},addEventHandlers:function(){$$('a[data-beacon-action]').each(function(a){a.observe('click',function(){R.beacon.send(a);});});$$('button[data-beacon-action]').each(function(button){button.observe('click',function(){R.beacon.send(button);});});},send:function(trigger){if(navigator.sendBeacon&&!trigger.__beacon&&trigger.getAttribute('data-beacon-action')){trigger.__beacon=true;var action=trigger.getAttribute('data-beacon-action');var group=trigger.getAttribute('data-beacon-group');var context=trigger.getAttribute('data-beacon-context');var value=trigger.getAttribute('data-beacon-value');var referrer=encodeURIComponent(document.referrer);var url=`${beaconEndpoint}?beacon_action=${action}&beacon_group=${group}&beacon_context=${context}&beacon_value=${value}&beacon_referrer=${referrer}`;navigator.sendBeacon(url);}}};}();R.books=function(){return{}}();Browser={orientation:null,smallBreakpointWidth:479,touchListener:null,responsiveBreakpointListener:null,responsiveBreakpointTriggered:false,responsiveBreakpointCallbacks:$A(),defaultBreakpointListener:null,defaultBreakpointTriggered:false,defaultBreakpointCallbacks:$A(),touchStarted:false,updateMetaViewportOnOrientationChange:function(){var setOrientationViewport=function(){var meta=$('meta_viewport_tag');if(meta&&window.matchMedia){if(window.matchMedia("(max-width: "+Browser.smallBreakpointWidth+"px)").matches){if(meta.getAttribute('data-landscape-device-width')=='1'){meta.setAttribute('data-landscape-device-width','0');Browser.setViewportTag('width=device-width, initial-scale=1');}}else{if(meta.getAttribute('data-landscape-device-width')!='1'){meta.setAttribute('data-landscape-device-width','1');Browser.setViewportTag('width=device-width');}}}};window.addEventListener("resize",function(){setOrientationViewport();});setOrientationViewport();},onBreakpoints:function(options){if(options&&options.desktop)Browser.onDefaultBreakpointTriggered(options.desktop);if(options&&options.mobile)Browser.onResponsiveBreakpointTriggered(options.mobile);},onDefaultBreakpointTriggered:function(callback){if(!this.defaultBreakpointListener){this.defaultBreakpointListener=Event.observe(window,'resize',function(){Browser.checkResponsiveBreakpoint();});Browser.checkResponsiveBreakpoint();}
if(this.defaultBreakpointTriggered)callback();this.defaultBreakpointCallbacks.push(callback);},onResponsiveBreakpointTriggered:function(callback){if(!this.responsiveBreakpointListener){this.responsiveBreakpointListener=Event.observe(window,'resize',function(){Browser.checkResponsiveBreakpoint();});Browser.checkResponsiveBreakpoint();}
if(this.responsiveBreakpointTriggered)callback();this.responsiveBreakpointCallbacks.push(callback);},checkResponsiveBreakpoint:function(){var mobile=Browser.responsiveBreakpoint();if(!this.responsiveBreakpointTriggered&&mobile){this.defaultBreakpointTriggered=false;this.responsiveBreakpointTriggered=true;this.responsiveBreakpointCallbacks.each(function(callback){callback();});}else if(!this.defaultBreakpointTriggered&&!mobile){this.responsiveBreakpointTriggered=false;this.defaultBreakpointTriggered=true;this.defaultBreakpointCallbacks.each(function(callback){callback();});}},responsiveBreakpoint:function(){var responsiveTag=window.getComputedStyle&&window.getComputedStyle(document.body,':after');responsiveTag=responsiveTag&&responsiveTag.getPropertyValue('content');return responsiveTag.indexOf('compressed-navigation')>=0;},inspect:function(){return navigator.userAgent;},watchForTouch:function(){if(!this.touchListener){this.touchListener=Event.observe(window,'touchstart',function(){Browser.touchStarted=true;},{passive:true});Event.observe(window,'orientationchange',function(){Browser.touchStarted=true;});Event.observe(window,'gesturestart',function(){Browser.touchStarted=true;},{passive:true});}},probablyTouchScreen:function(){return Browser.hasTouchEvents()&&Browser.touchStarted;},availableWidth:function(){if(!Browser.hasTouchEvents()){return null;}
var width=screen.availWidth;var height=screen.availHeight;if(window.innerWidth>window.innerHeight){return Math.max(width,height);}else{return Math.min(width,height);}},hasTouchEvents:function(){return('ontouchstart'in window)||(window.DocumentTouch&&document instanceof DocumentTouch);},hasBrokenFixedPositioning:function(){return Browser.hasTouchEvents()&&!Browser.isSafari()&&!Browser.isChrome();},hasCommandKey:function(){return navigator.userAgent.indexOf("Macintosh")>=0;},hasCSSZoom:function(){return!Browser.isFirefox();},allowsFlash:function(){return!Browser.isChrome();},supportsOnBeforeUnload:function(){return!Browser.isIPad()&&!Browser.isIPhone()&&!Browser.isAndroid();},isSafari:function(){return navigator.userAgent.toLowerCase().indexOf("apple")>-1;},isWebkit:function(){return navigator.userAgent.indexOf("AppleWebKit")>-1;},isOldMSIE:function(){return Browser.isMSIE6()||Browser.isMSIE7();},isMSIE8:function(){return Browser.isMSIE()&&(navigator.userAgent.toLowerCase().indexOf("msie 8.")>-1);},isMSIE7:function(){return Browser.isMSIE()&&(navigator.userAgent.toLowerCase().indexOf("msie 7.")>-1);},isMSIE6:function(){return Browser.isMSIE()&&typeof(XMLHttpRequest)=='undefined';},isMSIE:function(){return(navigator.userAgent.toLowerCase().indexOf("msie")>-1)&&!this.isOpera();},isOpera:function(){return navigator.userAgent.toLowerCase().indexOf("opera")>-1;},isGecko:function(){return navigator.userAgent.indexOf("Gecko")>-1;},isIPhone:function(){return navigator.userAgent.toLowerCase().indexOf("iphone")>-1;},isIPad:function(){return navigator.userAgent.toLowerCase().indexOf("ipad")>-1;},isIOS:function(){return Browser.isIPhone()||Browser.isIPad();},isChrome:function(){return navigator.userAgent.indexOf("Chrome")>-1&&navigator.userAgent.indexOf('like Chrome')<0;},isChromeIOS:function(){return Browser.isIOS()&&navigator.userAgent.indexOf("CriOS")>-1;},getChromeVersion:function(){var version=navigator.userAgent.match(/Chrome\/([0-9]+)\./);return version?parseInt(version[1],10):false;},getSafariVersion:function(){var version=navigator.userAgent.match(/Safari\/([0-9]+)\./);return version?parseInt(version[1],10):false;},isFirefox:function(){return navigator.userAgent.indexOf("Firefox")>-1;},isAndroid:function(){return navigator.userAgent.indexOf("Android")>-1;},isEdge:function(){return navigator.userAgent.indexOf("Edge/")>-1;},bugBackForwardCacheAndAutocompleteOff:function(){return(Browser.isWebkit()&&!Browser.isChrome()&&Browser.getSafariVersion()>=600)||Browser.isIPad()||Browser.isIPhone();},getOrientation:function(){Browser.updateOrientation();return this.orientation;},updateOrientation:function(){this.orientation=window.orientation;if(this.orientation===undefined){if(document.documentElement.clientWidth>document.documentElement.clientHeight){this.orientation='landscape';}else{this.orientation='portrait';}}else if(this.orientation===0||this.orientation===180){this.orientation='portrait';}else{this.orientation='landscape';}},getScale:function(){var viewportWidth=document.documentElement.clientWidth;if(screen.width>viewportWidth){return;}
Browser.updateOrientation();var screenWidth=screen.width;if(Browser.orientation==='portrait'){if(screen.width>screen.height)screenWidth=screen.height;}else{if(screen.width<screen.height)screenWidth=screen.height;}
return this.screenWidth/window.innerWidth;},setViewportTag:function(content){var meta=$('meta_viewport_tag');var newTag=false;if(!meta){newTag=true;meta=document.createElement('meta');meta.setAttribute('name','viewport');meta.id='meta_viewport_tag';}
meta.setAttribute('content',content);if(newTag){document.getElementsByTagName('head')[0].appendChild(meta);}},removeViewportTag:function(){if($('meta_viewport_tag')){$('meta_viewport_tag').remove();}}};R.bundles=function(){var editFrameOnclick=false;return{initialize:function(login){R.upload.onUploadAsset(function(asset,params){new Ajax.Request('/bundles/'+params.attachable_id+'/update_bundle_cover',{parameters:{asset_id:asset.id},method:'post'});});R.bundles.initializeResponsive();},initializeSorting:function(login){if($('shelved_bundles')&&$('shelved_bundles').hasClassName('sortable')){var url='/bundles/update_custom_sort';var repositionable=new R.controls.RepositionableList({'container_id':'shelved_bundles','repositionableItemClass':'bundle','positionLinkClass':'bundle_position','updateUrl':url,'login':login,'itemHandleClass':'media_square'});repositionable.enableSorting();}},initializeResponsive:function(){window.mobileExperience=new R.controls.MobileExperience({lazyLoadImages:{selector:'.photo_gallery__background',src:'data-slideshow-url',loadInvisible:false},onMobileView:function(){R.controls.HoverTools.locked=true;},onDesktopView:function(){R.controls.HoverTools.locked=$(document.body).hasClassName('with_touch');this.initializeBlazy();}});$$('.ellipsis_menu').each(function(element){new R.controls.EllipsisMenu(element);});},hoverTools:function(){R.controls.HoverTools.applyWithSelector('.media_square_200','.real_photo',{tools:{edit:R.bundles.editWithFrame,confirmedDelete:R.bundles.inPlaceDelete,extra:{"icon":"silk-photo_edit.png","label":"","position":"center","callback":R.bundles.editCover}},touchTools:{edit:R.bundles.editWithFrame,confirmedDelete:R.bundles.inPlaceDelete,extra:{"icon":"silk-photo_edit.png","label":"","position":"center","callback":R.bundles.editCover}},deleteConfirmation:"Remove this item from your bundle?"});R.controls.HoverTools.applyWithSelector('.media_square_200','.fake_photo',{tools:{edit:R.bundles.editWithFrame,confirmedDelete:R.bundles.inPlaceDelete},touchTools:{edit:R.bundles.editWithFrame,confirmedDelete:R.bundles.inPlaceDelete},deleteConfirmation:"Remove this item from your bundle?"});},introWidth:function(){if(!(R.swatch&&R.swatch.isSwatching('FRONTEND12'))){Event.observe(window,'resize',R.bundles.resizeIntroAndPageBars);R.bundles.resizeIntroAndPageBars();}},resizeIntroAndPageBars:function(){if(Browser.responsiveBreakpoint()){$('b_header').style.width='auto';$$('.page_bar').each(function(pageBar){pageBar.style.width='auto';});}else{var size=$('bundled_items').getWidth();var bundleSize=230;var rowWidth=(Math.floor(size/bundleSize)*bundleSize);var headerWidth=rowWidth+'px';var pageBarWidth=(rowWidth-24)+'px';if(size<960){rowWidth=pageBarWidth=headerWidth='960px';}
$('b_header').style.width=headerWidth;$$('.page_bar').each(function(pageBar){pageBar.style.width=pageBarWidth;});}},editWithFrame:function(bundledItem){var itemId=bundledItem.getAttribute('data-item-id');var bundleId=bundledItem.getAttribute('data-bundle-id');var bookmarkId=bundledItem.getAttribute('data-bookmark-id');var bookmarkUrl=bundledItem.getAttribute('data-bookmark-url');if(bookmarkId){R.controls.applyEditFrame($('item_'+itemId),'editing_'+bookmarkId);new Ajax.Request(bookmarkUrl+'?bundled_item_id='+itemId,{method:'get'});}else{R.controls.applyEditFrame($('item_'+itemId),'editing_'+itemId);new Ajax.Request('/bundles/'+bundleId+'/edit/'+itemId,{method:'get'});}},inPlaceDelete:function(bundledItem){var itemId=bundledItem.getAttribute('data-item-id');var bundleId=bundledItem.getAttribute('data-bundle-id');new Ajax.Request('/bundles/'+bundleId+'/delete/'+itemId,{method:'delete'});},destroy:function(bundleId){new Ajax.Request('/bundles/'+bundleId,{method:'delete'});},editCover:function(bundledItem){var itemId=bundledItem.getAttribute('data-item-id');var bundleId=bundledItem.getAttribute('data-bundle-id');RedBox.open('edit_cover','/bundles/'+bundleId+'/edit_cover/'+itemId,{onComplete:function(){R.utils.makeRoom($('bundles_selector'));}});},editItemCover:function(bundleId,itemId){RedBox.open('edit_cover','/bundles/'+bundleId+'/edit_cover/'+itemId);},toggleMembership:function(target,targetType,bundle,src){var spinner=$('spinner_'+bundle);spinner.show();new Ajax.Request('/bundles/'+bundle+'/toggle',{asynchronous:true,parameters:'item_id='+target+'&item_type='+targetType+'&src='+src,evalScripts:true,method:'post',onComplete:function(){spinner.hide();}});},afterSave:function(){var form=$('popover').down('form');if(form){form.innerHTML="<div class='message' style='padding: 5px; font-size: 1.2em; text-align: center; display: none; font-weight: bold;'>Saved!</div>";new Effect.Appear(form.down('.message'));}
setTimeout(function(){R.popover.formSaved();R.popover.close(true);},1000);},pop:function(content){R.popover.close();var anchor=$('button_box').down('.bundles_button');R.popover.pop(anchor,content,{orientation:'right'});},searchPopover:function(options){var url=R.utils.prependPath('advanced_search',true);new Ajax.Request(url,{method:'GET'});},editPopover:function(){var url=R.utils.prependPath('edit_popover',true);new Ajax.Request(url,{method:'GET'});},cancelCreate:function(){R.popover.close();},addDialog:function(){RedBox.open('add_dialog',R.utils.prependPath('prepare_add'),{actionSheet:true,onComplete:function(){R.behaviors.applyBehavior('html5_autofocus');R.utils.updateAutosubmitForms('form.autosubmit');}});},showDialogSection:function(name){var sectionControls=$(name+'_section_controls');$$('.section_controls').each(function(section){section.removeClassName('section_controls_selected');section.hide();});$$('.section_results').each(function(section){section.innerHTML='';});if(!sectionControls.visible()){sectionControls.addClassName('section_controls_selected');sectionControls.show();}},searchAndAdd:function(form){var params=Form.serialize(form);var indicator=$(form).down('.inline_indicator');if(indicator){indicator.show();}
new Ajax.Request(R.utils.prependPath('search_and_add'),{parameters:params,onComplete:function(){if(indicator)indicator.hide();R.utils.makeRoom($('bundles_selector'));R.utils.observeHover($('bundles_selector'),'.hoverable');}});},selectSearchResult:function(result,e){var item=result.up('li');var itemId=item.getAttribute('data-item-id');var itemType=item.getAttribute('data-item-type');item.toggleClassName('selected');item.down('.ticky_box').toggleClassName('ticky_box_selected');new Ajax.Request(R.utils.prependPath('toggle'),{parameters:{'item_id':itemId,'item_type':itemType,'src':'Bundle'}});var evt=e?e:window.event;if(e){Event.stop(e);}},selectAllSearchResults:function(element){var changed=[];var results=$(element).up('.searchlight_results');var items=results.getElementsBySelector('li');if(items.length>10&&!confirm('Are you sure that you want to add all of the results to your bundle?')){return;}
items.each(function(li){var selected=li.hasClassName('selected');if(!selected){li.addClassName('selected');var itemId=li.getAttribute('data-item-id');var itemType=li.getAttribute('data-item-type');li.addClassName('selected');li.down('.ticky_box').addClassName('ticky_box_selected');changed.push({itemId:itemId,itemType:itemType});}});new Ajax.Request(R.utils.prependPath('toggle_bulk'),{parameters:{'item_json':Object.toJSON(changed),'src':'Bundle','selected':1}});},add:function(target,target_type){new Ajax.Request('/bundles/add?target='+target+'&target_type='+target_type);},deleteBundle:function(){if(confirm('Are you sure that you want to delete this bundle?')){var url=prependPath('');new Ajax.Request(url,{method:'delete',parameters:{'inplace':true}});}},checkListEditable:function(el){if(el.value==5){$('editable_by_listing').show();}else{$('editable_by_listing').hide();}},addEditor:function(){if($('username').value){R.utils.addValueToField($('editable_by_editors'),$('username').value);new Ajax.Request("/bundles/editable_by_list?editable_by_list="+$('editable_by_editors').value,{onComplete:function(){$('username').value="";}});}},removeEditor:function(login){R.utils.removeValueFromField($('editable_by_editors'),login);$('editable_by_'+login).remove();},editBookmarkComment:function(){$('view_notes').hide();$('notes_form').show();var notes_fields=$('edit_notes');notes_fields.parentNode.removeChild(notes_fields);},createBundledItemNotes:function(){$('view_notes').hide();$('notes_form').show();var comment_field=$('bookmark_comment');comment_field.parentNode.removeChild(comment_field);}};}();R.calendar=function(){var MONTHS=["January","February","March","April","May","June","July","August","September","October","November","December"];var target=null;var handler=false;var tips=null;var calendarClickHandler=null;return{setTarget:function(id){target=id;},selectDay:function(o){var parts=o.id.split('-');R.calendar.setDate(parts[1],parts[2],parts[3]);var actionSheet=$('date_picker')&&$('date_picker').up('.action_sheet');if(actionSheet){R.controls.hideActionSheet(actionSheet);}},selectMonth:function(y,m){R.calendar.open(target,{year:y,month:m});},selectPartial:function(year,month){R.calendar.setDate(year,month);},normalizeDate:function(input,options){options=options||{};var params={'date':input.value,'deadline':options.deadline};new Ajax.Request('/calendars/normalize_date',{parameters:params,onComplete:function(xhr){input.value=xhr.responseText;}});},open:function(target,options,ajax_options){var anchor=document.body;var actionSheet=null;var useActionSheet=R.swatch&&R.swatch.isSwatching('FRONTEND12')&&Browser.responsiveBreakpoint();if(useActionSheet){var bar=$('date_picker_bar');if(!bar){actionSheet=R.controls.buildActionSheet(null,'calendar');bar=document.createElement('DIV');bar.id='date_picker_bar';}else{actionSheet=bar.up('.action_sheet');}
var picker=$('date_picker');if(!picker){picker=document.createElement('DIV');picker.id='date_picker';}
actionSheet.innerHTML='';actionSheet.appendChild(bar);actionSheet.appendChild(picker);}else if(Browser.responsiveBreakpoint()){$(anchor).appendChild($('date_picker'));R.utils.saveScrollPosition();$(anchor).addClassName('with_date_picker');}
var visible=Element.visible('date_picker')&&$('date_picker').innerHTML!='';if(options&&options.toggle&&visible){R.calendar.close();return;}
var array=target instanceof Array;if(options&&options.relativeTop&&!useActionSheet){anchor=$(array?target[0]:target);var offset=Position.cumulativeOffset(anchor)[1]+options.relativeTop;$('date_picker').style.top=offset+"px";}
var targetList=array?target.join():target;var url='/calendars/new?target='+targetList;if(actionSheet){url+='&action_sheet=1';}
if(options){url+='&'+$H(options).toQueryString();}
if(array){url+='&tips=false';}
if(Element.visible('date_picker')&&$('calendar_closer')){$('calendar_closer').src="/images/progress.gif";}
if(R.swatch&&R.swatch.isSwatching('FRONTEND12')&&!useActionSheet){var panel=anchor.up('panel');if(panel){panel.style.position='relative';}}
savedOptions=options;new Ajax.Request(url);},show:function(){if(!calendarClickHandler){calendarClickHandler=Event.observe(document,'click',R.calendar.clickHandler);}
$('date_picker').show();var actionSheet=$('date_picker').up('.action_sheet');if(actionSheet){R.controls.actionSheet(actionSheet);}},clickHandler:function(evt){var onCalendar=$(Event.element(evt)).up('#date_picker');if(!onCalendar){R.calendar.close();}},close:function(){Event.stopObserving(document,'click',R.calendar.clickHandler);calendarClickHandler=null;$('date_picker').hide();$('date_picker').innerHTML='';var actionSheet=$('date_picker').up('.action_sheet');if(Browser.responsiveBreakpoint()){if(actionSheet){$('date_picker').remove();$('date_picker_bar').remove();R.controls.hideActionSheet(actionSheet);}
if(actionSheet&&window.event){Event.stop(window.event);}
if(!actionSheet){$(document.body).removeClassName('with_date_picker');R.utils.scrollToSavePoint();}}},setDate:function(year,month,day){R.calendar.close();var array=target instanceof Array;if(target&&(target.length==1||!array)){var s="";if(month)s+=MONTHS[month-1];if(day)s+=" "+day+",";if(year)s+=" "+year;var t=$(array?target[0]:target);t.value=s;t.select();t.__dateSelected=true;}else{R.utils.selectOption(target[0],year);R.utils.selectOption(target[1],month);if(day){R.utils.selectOption(target[2],day);}else{R.utils.selectOption(target[2],"");}}}};}();R.challenges=function(){return{changeGoal:function(challengeId){var url=R.utils.prependPath(challengeId+'/change_goal');new Ajax.Request(url,{method:'get'});},setOptOut:function(optOutValue){var value=optOutValue?1:0;R.utils.openUrlWithPost('challenge/opt_out',{'opt_out':value},true)}}}();R.chatListener=function(){return{listen:function(chatId){nchanClient=R.pushstream.nchanClient(['chat'+chatId]);nchanClient.on('message',function(msg){var json=decodeURIComponent(msg).replace('}=','}').evalJSON();R.chat.talkReceived(json.timestamp,json.chatMessageId,json.message,json.options);});nchanClient.start();}};}();R.chat=function(){var userId=0;var messageLimit=1000;var activeUsers=[];var lastMessageTimeStamp="";var lastMessageUser=null;var lastMessage=null;var subscriber=null;var baseTitle="";var away=false;var backlog=0;var paused=false;var currentChatId=null;var isConnected=false;var smLoaded=false;var sound=null;var scheduledPause=null;var scheduledAway=null;var scheduleTimeout=10000;return{initialize:function(chatId,client){R.chat.resizeWindow();baseTitle=document.title;currentChatId=chatId;new PeriodicalExecuter(function(pe){if(R.chat.online){R.chat.refreshUsers();}},60);Event.observe(window,'resize',function(){R.chat.resizeWindow();});Event.observe(window,'blur',function(){R.chat.scheduleAway();R.chat.schedulePause();});Event.observe(window,'focus',function(){R.chat.setAway(false);R.chat.resume();});if($('chat_title')){Event.observe($('chat_title'),'click',function(){if(Browser.responsiveBreakpoint()){$('chat_title').toggleClassName('chat__title--toggled');$('chat_sidebar').toggleClassName('chat__sidebar--toggled');}});}
Event.observe($('chat_message'),'click',function(){if(paused){R.chat.setAway(false);R.chat.resume();}});Event.observe($('talk_messages'),'scroll',function(){R.chat.viewportScrolled();});var passedChatId=chatId;Event.observe(document,'keydown',function(event){var element=Event.element(event);if(element.tagName=='TEXTAREA'){if(away)R.chat.setAway(false);if(paused)R.chat.setPaused(false);var key=R.utils.keyCode(event);if(key==13){Event.stop(event);R.chat.talk(passedChatId,$('chat_message').value);}}});setTimeout(function(){R.chat.connected();R.chatListener.listen(chatId);},100);},soundManagerLoaded:function(){smLoaded=true;},schedulePause:function(){if(scheduledPause){window.clearTimeout(scheduledPause);scheduledPause=null;}
scheduledPause=window.setTimeout("R.chat.setPaused(true)",scheduleTimeout);},setPaused:function(p){if(scheduledPause){window.clearTimeout(scheduledPause);}
paused=p;var indicator=$('paused');if(p){if(!Element.visible(indicator)){new Effect.Appear(indicator);}}else{Element.hide(indicator);}},scheduleAway:function(){if(scheduledAway){window.clearTimeout(scheduledAway);scheduledAway=null;}
scheduledAway=window.setTimeout("R.chat.setAway(true)",scheduleTimeout);},setAway:function(b){away=b;if(b==false){document.title=baseTitle;backlog=0;}},resume:function(){R.chat.setPaused(false);var messageWindow=$('talk_messages');messageWindow.scrollTop=messageWindow.scrollHeight-messageWindow.clientHeight;if(Element.visible($('chat_message'))&&isConnected){$('chat_message').focus();}},viewportScrolled:function(){var messageWindow=$('talk_messages');var position=messageWindow.scrollHeight-messageWindow.scrollTop-messageWindow.clientHeight;if(position<50){R.chat.setPaused(false);}else{if(!paused){R.chat.setPaused(true);}}},resizeWindow:function(){if(!Browser.responsiveBreakpoint()){var height=getViewportSize()[1];$('talk_messages').style.height=(height-215)+"px";}else{$('talk_messages').style.height='';}},online:function(){return isConnected;},leave:function(){if(isConnected){isConnected=false;new Ajax.Request('/chats/'+currentChatId+'/leave_onunload',{method:'get',asynchronous:false});}},errors:function(){$('connecting').hide();$('interactive').hide();$('errors').show();},connected:function(){isConnected=true;$('errors').hide();$('connecting').hide();$('interactive').show();R.chat.resume();},disconnected:function(){isConnected=false;$('errors').hide();$('interactive').hide();$('connecting').show();},refreshUsers:function(showEnterExit){var activeUserList=activeUsers.join(',');new Ajax.Request('/chats/'+currentChatId+'/users?compare='+activeUserList,{method:'get'});},setActiveUsers:function(userIds){activeUsers=userIds;},userEntered:function(){R.chat.refreshUsers()},userLeft:function(){R.chat.refreshUsers()},talkReceived:function(messageTimeStamp,messageId,message,options){if(messageTimeStamp==lastMessageTimeStamp){$('chat_message').value="";$('default_indicator').hide();new Effect.Opacity('chat_message',{from:0.6,to:1,duration:0.5});if(Element.visible($('chat_message'))){$('chat_message').focus();}}
var messages=$A($('talk_messages').getElementsByClassName('chat_message'));var messagesToRemove=messages.length-messageLimit;var i;for(i=0;i<messagesToRemove;i++){Element.remove(messages[i]);}
new Insertion.Bottom($('talk_messages'),message);if(options&&options.messageType==1){R.chat.refreshUsers();if(currentChatId==1){R.chat.ding();}}
if(away){if(backlog==0){R.chat.ding();}
backlog++;document.title="("+backlog+") "+baseTitle;}else if(!paused){Position.prepare();var container_y=Position.cumulativeOffset($('talk_messages'))[1];var element_y=Position.cumulativeOffset($('chat_message_'+messageId))[1];var distance=element_y-container_y;if(distance>0&&distance<1000){new Effect.Scroll('talk_messages',{x:0,y:distance});}else{var messageWindow=$('talk_messages');messageWindow.scrollTop=messageWindow.scrollHeight-messageWindow.clientHeight;}}},talk:function(chatId,msg){R.chat.setPaused(false);R.chat.setAway(false);if(msg!=""){new Effect.Opacity('chat_message',{from:1.0,to:0.6,duration:0.5});$('default_indicator').show();lastMessageTimeStamp=userId+"-"+(new Date());new Ajax.Request('/chats/'+chatId+'/talk',{parameters:{message:msg,message_ts:lastMessageTimeStamp}});}},ding:function(){if(smLoaded){try{soundManager.url='/swf/';if(!sound){sound=soundManager.createSound({id:'ding',url:'/audio/mario-ding.mp3'});}
sound.play();}catch(e){}}},chatUsers:function(chatId){RedBox.open('chat_user_dialog','/chats/'+chatId+'/chat_users');}}}();R.collections=function(){return{create:function(type){new Ajax.Request('/collections/prepare?type='+type,{method:'get'});}}}();R.comments=function(){return{addEventListeners:function(){$$('.comment_filter_box a').each(function(filterLink){filterLink.observe('click',function(e){var box=filterLink.up('.comment_filter_box');box.toggleClassName('comment_filter_box--collapsed');if(Browser.responsiveBreakpoint()){if(!box.hasClassName('comment_filter_box--collapsed'))Event.stop(e);if(filterLink.up('li').hasClassName('selected'))Event.stop(e);}});});},prepareComment:function(){$('comment_text_content').show();var textarea=$('comment_text');textarea.show();R.utils.focusTextField(textarea);},vote:function(commentId,type,vote){vote=vote?'1':'0';new Ajax.Request('/comments/'+commentId+'/vote',{method:'post',postBody:"type="+type+"&vote="+vote});},deleteComment:function(commentId){if(confirm("Are you sure that you want to delete this comment permanently?")){new Ajax.Request('/comments/'+commentId,{method:'delete'});}}};}();R.content=function(){return{contentViewer:function(key){var url='/site_content/dialog?key='+key;RedBox.open('site_content',url,{method:'get'});}};}();R.controls=function(){var registry=$H();var viewSelectorTop=null;var rawViewSelectorTop=null;var attributeMenuGroup=null;var editFrameOnclick=false;var actionSheets={};var actionSheetSliderScrollPosition=null;var ajaxIndicator='/images/circle-ball-dark-antialiased.gif';var ajaxIndicatorV2='/images/assets/icons/ui/tiny-loader.svg';return{initialize:function(classNames){$A(classNames).each(function(className){if(registry[className]){document.getElementsByClassName(className).each(function(element){registry[className].each(function(initializer){new initializer(element);});});}});},register:function(className,initializer){if(!registry[className]){registry[className]=$A([]);}
registry[className].push(initializer);},initializeClickEffects:function(){$$('a.icon_indicator').each(function(indicator){indicator.observe('click',function(){if(indicator.__clickEffectTimer){clearTimeout(indicator.__clickEffectTimer);indicator.__clickEffectTimer=null;}
indicator.addClassName('icon_indicator--clicked');indicator.__clickEffectTimer=setTimeout(function(){indicator.removeClassName('icon_indicator--clicked');},500);});});},initializeLinkMenus:function(){$$('a[data-toggle-parent-class]').each(function(a){a.observe('click',function(e){a.parentNode.toggleClassName(a.getAttribute('data-toggle-parent-class'));Event.stop(e);});$(document.body).observe('click',function(){a.parentNode.removeClassName(a.getAttribute('data-toggle-parent-class'));});});},initializeTabBars:function(){$$('.tab_bar_responsive').each(function(bar){new R.controls.TabBar(bar);});},createAjaxIndicator:function(){var img=document.createElement('IMG');if(R.swatch&&R.swatch&&R.swatch.isSwatching('FRONTEND12')){img.src=ajaxIndicatorV2;img.className='icon_16 i-icon o-icon--loading_tiny';}else{img.src=ajaxIndicator;}
return img;},insertAjaxIndicator:function(elem){if(R.swatch&&R.swatch.isSwatching('FRONTEND12')){elem.innerHTML="<img class='icon_16 i-icon o-icon--loading_tiny' src='"+ajaxIndicatorV2+"' />";}else{elem.innerHTML="<img src='"+ajaxIndicator+"' />";}},positionIndicatorsInsideFields:function(){$$('.autocomplete_indicator').each(function(indicator){var field=indicator.previous();while(field&&field.tagName!='INPUT'){field=field.previous();}
if(field&&field.tagName=='INPUT'){var indicatorWidth=indicator.getWidth();indicator.style.position='absolute';indicator.style.top=(field.offsetTop+(field.getHeight()-indicatorWidth+2)/2)+'px';indicator.style.left=(field.offsetLeft+field.getWidth()-indicatorWidth-8)+'px';}});},submitSearchForm:function(form){if(!form.searchFormInitialized){R.controls.initializeSearchForm(form);}
form.onsubmit();return false;},initializeSearchForm:function(id){var form=$(id);var submitButton=form.down("input[type='submit']")||form.down("button[type='submit']");var searchField=form.down("input[name='search']");var indicator=form.down(".indicator");var submitClicker=null;if(submitButton)submitClicker=submitButton.up('.clicker');var clearLink=null;form.getElementsBySelector('a').each(function(a){if(a.innerHTML.indexOf('clear')>=0){clearLink=a;}});if(clearLink&&!clearLink.onclick){clearLink.onclick=function(){searchField.value='';form.onsubmit();return false;};}
form.onsubmit=function(){if(indicator){indicator.down('img').setStyle({'vertical-align':'middle'});indicator.setStyle({'display':'inline'});}
new Ajax.Request(form.action,{evalScripts:true,parameters:Form.serialize(form),onComplete:function(){if(indicator){indicator.hide();}
if(clearLink){if(searchField.value.length>0){clearLink.show();}else{clearLink.hide();}}}});return false;};},initializeImageFields:function(){var imageFieldFound=false;R$$('.clearable_image_field').each(function(field){imageFieldFound=true;var f=field;var img=field.down('img');if(img&&img.src&&img.src!==''){img.style.display="block";field.addClassName('filled_image_field');}
var a=$(document.createElement('a'));a.addClassName('image_clear');a.observe('click',function(e){if(confirm(field.getAttribute('data-confirm-message')||"Remove this image?")){img.style.display="none";f.removeClassName('filled_image_field');var input=$(img.id.replace(/_img$/,"_id"));if(input){input.value="";}else{alert("Script error in R.controls. Image not found.");}}});field.appendChild(a);});if(imageFieldFound){R.upload.onUploadAsset(function(asset,params){var prefix=params.prefix||params.type;$(prefix+'_id').value=asset['id'];var uploadField=$(prefix+'_upload_id');if(uploadField){uploadField.value=asset['upload_id'];}
var img=$(prefix+'_img');if(img){img.src=asset['asset_url'];img.style.display='block';img.up('.image_field').addClassName('filled_image_field');}});}},inPlaceEdit:function(editableType,editableId,field){var url="/in_place_editor/"+editableType+"/"+editableId+"?field="+field;new Ajax.Request(url,{method:'get'});},hideEditFrames:function(){if(R.swatch&&R.swatch.isSwatching('FRONTEND12')){if(Browser.responsiveBreakpoint()){return;}}
var hidden=0;$$('.edit_frame').each(function(existingFrame){if(existingFrame.visible()){hidden++;}
document.body.removeChild(existingFrame);});$(document.body).removeClassName('edit_frame_active');if(hidden>0&&Browser.responsiveBreakpoint()){R.utils.scrollToSavePoint();}
return hidden;},applyEditFrame:function(elementToCover,idForNewContainer,options){R.controls.hideEditFrames();if(!editFrameOnclick){this.editFrameOnclick=true;Event.observe(document.body,'click',function(e){var element=Event.element(e);var clickedInside=element.hasClassName('hover_tool_edit')||element.up('.hover_tool_edit')||element.up('.edit_frame')||element.up('#RB_redbox')||element.up('.quick_navigation')||element.up('.ellipsis_menu');if(!clickedInside){if(R.controls.hideEditFrames()>0){Event.stop(e);}}});}
var enlargeBy=33;var photoFrame=elementToCover.down('.photo_frame');var usePhoto=(options||{}).photo!=false;var frame=document.createElement('DIV');frame.className='edit_frame';frame.id='edit_frame_'+idForNewContainer;if(!Browser.responsiveBreakpoint()){var sizeBasedOn=photoFrame||elementToCover;var basedOnWidth=Element.getWidth(sizeBasedOn);frame.style.width=(basedOnWidth+(enlargeBy*2))+'px';}
var titleBar="<div id='"+idForNewContainer+"_title_bar'></div>";if(usePhoto&&photoFrame&&photoFrame.down('.photo')){frame.innerHTML=titleBar+"<div class=\"media_square_200 media_square captioned_media_square\"><div class=\"photo_border framed_photo\">"+"<div class=\"photo zoomable_photo\">"+photoFrame.down('.photo').innerHTML+"</div></div></div>"+"<div class=\"edit_frame_content\" id=\""+idForNewContainer+"\"></div>";}else{frame.innerHTML=titleBar+"<div class=\"edit_frame_content\" style=\"margin: 0;\" id=\""+idForNewContainer+"\"></div>";}
if(!Browser.responsiveBreakpoint()){var pos=Position.cumulativeOffset(elementToCover);var left=(pos[0]-enlargeBy);if(left<=10)left=10;frame.style.top=(pos[1]-enlargeBy)+'px';frame.style.left=left+'px';}
if(options&&options.parentNode){options.parentNode.appendChild(frame);}else{document.body.appendChild(frame);}
if(options&&options.dimensions){$(idForNewContainer).style.minHeight=options.dimensions[1]+'px';R.utils.makeRoom($(idForNewContainer));frame.style.width=options.dimensions[0]+'px';frame.style.zIndex=200;}
var toZoom=frame.down('.media_square');if(toZoom){Element.addClassName(toZoom,'zoomed');}
if(Browser.responsiveBreakpoint()){R.utils.scrollToTop();}
if(!(options&&options.parentNode)){$(document.body).addClassName('edit_frame_active');}},initializeOptionPickers:function(){R.controls.OptionPicker.initialize();},openViewSelector:function(){if(rawViewSelectorTop==null){rawViewSelectorTop=$('view_selector').style.top;}
viewSelectorTop=parseInt(rawViewSelectorTop.replace('px',''));var itemsAboveTheSelection=0;var found=false;$('view_selector').getElementsBySelector('li').each(function(li){found=found||$(li).hasClassName('selected');if(!found){itemsAboveTheSelection++;}});if(rawViewSelectorTop==$('view_selector').style.top){$('view_selector').style.top=((itemsAboveTheSelection* -20)+viewSelectorTop)+"px";$('view_selector').addClassName('opened_view_selector');}},closeViewSelector:function(){$('view_selector').style.top=rawViewSelectorTop;$('view_selector').removeClassName('opened_view_selector');},tinyLoaderHTML:function(extraClasses){extraClasses=extraClasses||'';if(R.swatch&&R.swatch.isSwatching('FRONTEND12')){return"<img src='/images/assets/icons/ui/tiny-loader.svg' class='o-icon o-icon--loading_tiny icon_16 "+extraClasses+"' />";}else{return"<img src='/images/circle-ball-dark-antialiased.gif' class='"+extraClasses+"' />";}},toggleInformationBox:function(link){var informationBox=$(link).up('.information');var expand=informationBox.getAttribute('data-expanded')=='true'?'false':'true';informationBox.setAttribute('data-expanded',expand);},tickyBox:function(div,url,key,options){div=$(div).up('.ticky_item').down('.ticky_box');var tickyText=$(div).up('.ticky_item').down('.ticky_text');options=options||{};var selectedClass='ticky_box_selected';var textSelectedClass='ticky_text_selected';var toggledValue=Element.hasClassName(div,selectedClass)?0:1;if(toggledValue){Element.addClassName(div,selectedClass);div.setAttribute('aria-checked',true);if(tickyText)Element.addClassName(tickyText,textSelectedClass);if(options.toggle)$A(options.toggle).each(function(id){$(id).show();});if(options.reverseToggle)$A(options.reverseToggle).each(function(id){$(id).hide();});}else{Element.removeClassName(div,selectedClass);div.setAttribute('aria-checked',false);if(tickyText)Element.removeClassName(tickyText,textSelectedClass);if(options.toggle)$A(options.toggle).each(function(id){$(id).hide();});if(options.reverseToggle)$A(options.reverseToggle).each(function(id){$(id).show();});}
if(options.field){var field=$('ticky_box_field_'+options.field);field.value=toggledValue;}
if(url){if(url.charAt(0)!='/'&&url.indexOf('http://')<0&&url.indexOf('https://')<0){url=R.utils.prependPath(url);}
var ajaxOptions={};if(options.indicator){var indicator=options.indicator;ajaxOptions={onComplete:function(){new Effect.Appear(indicator,{duration:.25,afterFinish:function(){new Effect.Fade(indicator,{delay:1,duration:0});}});}};}
var sep=url.indexOf('?')>=0?'&':'?';new Ajax.Request(url+sep+key+"="+toggledValue,ajaxOptions);}
if(window.CustomEvent){try{var event=new CustomEvent('ravelry:tickyboxchanged',{detail:{key:key,selected:toggledValue},bubbles:true});div.dispatchEvent(event);}catch(e){}}},sideSelect:function(div,key,field,options){if(div.hasClassName('side_select__item-selected')){div.removeClassName('side_select__item-selected');div.siblings().each(function(x){x.removeClassName('side_select__item-selected');x.removeClassName('side_select__item-adjacentl');x.removeClassName('side_select__item-adjacentr');});$('side_select_field_'+key+'_'+field).value="";}else{div.siblings().each(function(x){x.removeClassName('side_select__item-selected');x.removeClassName('side_select__item-adjacentl');x.removeClassName('side_select__item-adjacentr');});div.addClassName('side_select__item-selected');div.removeClassName('side_select__item-adjacentl');div.removeClassName('side_select__item-adjacentr');if(div.previousSibling){div.previousSibling.addClassName('side_select__item-adjacentl');}
if(div.nextSibling){div.nextSibling.addClassName('side_select__item-adjacentr');}
$('side_select_field_'+key+'_'+field).value=div.getAttribute('data-id');}},initializeButtonBox(){if(!R.swatch.isSwatching('DOUBLETAP')){return;}
if(window.Hammer){var button=$$('#button_box .favorites_button').first();if(button&&!button.__initialized){button.__initialized=true;var onclick=button.onclick;button.onclick=function(){if(!Browser.responsiveBreakpoint()){onclick();}};var hammer=new Hammer.Manager(button);hammer.add(new Hammer.Tap({event:'doubletap',taps:2}));hammer.add(new Hammer.Tap({event:'singletap'}));hammer.get('doubletap').recognizeWith('singletap');hammer.get('singletap').requireFailure('doubletap');hammer.on('doubletap',function(event){if(Browser.responsiveBreakpoint()){button.setAttribute('data-tap','double');onclick();}}).on('singletap',function(event){if(Browser.responsiveBreakpoint()){button.setAttribute('data-tap','single');onclick();}});}}},refreshButtonBox:function(callback){var buttonBox=$('button_box');var onComplete=callback;if(buttonBox){var buttonSet=buttonBox.down('.button_set');var buttonSetName=buttonSet.id.replace("_button_set","");var url=R.utils.prependPath("refresh_button_box?button_set="+buttonSetName,true);new Ajax.Request(url,{method:'get',onComplete:function(xhr){$('button_box').innerHTML=xhr.responseText;if(onComplete)onComplete();R.controls.initializeButtonBox();}});}},refreshNotebookIndicator:function(indicatorType,modelId){modelId=modelId.toString();$$('.notebook_indicator').each(function(indicator){if(indicator.getAttribute('data-indicator-type')==indicatorType&&indicator.getAttribute('data-model-id')==modelId){var url=indicator.getAttribute('data-model-url')+'/refresh_notebook_indicator';var params={'indicator_type':indicatorType};params['count']=indicator.getAttribute('data-indicator-count');new Ajax.Request(url,{parameters:params,onComplete:function(xhr){Element.replace(indicator,xhr.responseText);}});}});},initializeAttributeMenus:function(menuOptions,input_for_results,options){var menu=$(menuOptions);if(!options)options={};var tooltips=options.tooltips||{};var updateAttribute=function(idToAdd,idToRemove,objectToAdd){var selector=$$('a.attribute_select').first();var existingAttributes=$$('a.attribute_select span.attribute');var attributeList=[];var alreadyExists=false;for(var i=0;i<existingAttributes.length;i++){var existing=existingAttributes[i];var existingId=parseInt(getId(existing),10);if(idToAdd==existingId)alreadyExists=true;if(idToRemove==existingId){selector.removeChild(existing);}else{attributeList.push(existingId);}}
if(!alreadyExists&&idToAdd){selector.innerHTML+="<span class='attribute' id='attribute_"+idToAdd+"'>"+objectToAdd.innerHTML+"</span>";attributeList.push(idToAdd);}
$(input_for_results).value=attributeList.join(' ');};var removeAttribute=function(idToRemove){updateAttribute(null,idToRemove);};var selections=$$('span.attribute').map(function(a){return getId(a);});if(!attributeMenuGroup){attributeMenuGroup=new R.controls.MenuFieldGroup({selections:selections});}
if(options.resetSelections){attributeMenuGroup.setSelections(selections);}
return $$('a.attribute_select').map(function(a){var menu=new R.controls.MenuField(a,{menuContent:menu,menuFieldGroup:attributeMenuGroup,multiple:true,retainSelections:true,afterSelect:updateAttribute,onDelete:removeAttribute,tooltips:tooltips});a.__menufield=menu;return menu;});},toggleClickerIndicator:function(clicker,indicatorOn){clicker=$(clicker);if(!clicker.hasClassName('clicker_v2')){clicker=clicker.down('.clicker_v2');}
var icon=clicker.down('img');var indicator=clicker.down('.toggle_clicker_indicator');if(!indicator){indicator=document.createElement("IMG");if(R.swatch&&R.swatch.isSwatching('FRONTEND12')){indicator.className='icon_16 i-icon o-icon--loading_tiny toggle_clicker_indicator';indicator.src=ajaxIndicatorV2;}else{indicator.className='toggle_clicker_indicator';indicator.src=ajaxIndicator;}
indicator.style.display='none';icon.parentNode.insertBefore(indicator,icon);}
if(indicatorOn){indicator.style.display='inline';icon.style.display='none';}else{indicator.style.display='none';icon.style.display='inline';}},replaceSubmitWithIndicator:function(formOrButton,indicatorClassName){var submit=formOrButton;if(formOrButton.tagName!='BUTTON')submit=formOrButton.down("button");if(!submit){return;}
var indicator=document.createElement("IMG");if(R.swatch&&R.swatch.isSwatching('FRONTEND12')){indicator.src=ajaxIndicatorV2;indicator.className='icon_16 i-icon o-icon--loading_tiny '+(indicatorClassName||'');}else{indicator.src=ajaxIndicator;indicator.className=indicatorClassName;}
var parent=submit.parentNode;parent.replaceChild(indicator,submit);if($(parent).hasClassName('clicker')){parent.style.background='none';}},showCardBack:function(link,options){R.controls.flipCard('back',link,options);},showCardFront:function(link,options){R.controls.flipCard('front',link,options);},flipCard:function(face,link,options){options=options||{};var hideSiblingCards=options.hideSiblingCards;var showSiblingCards=options.showSiblingCards;var card=$(link).up('.card');var back=card.down('.card__back');var front=card.down('.card__front');if(face=='back'){front.hide();back.show();}else{back.hide();front.show();}
card.up().getElementsBySelector('.card').each(function(node){if(node!=card){if(hideSiblingCards)node.hide();if(showSiblingCards)node.show();}});},swapContents:function(anchor,swapState){var container=$(anchor).up('.swappable_contents');R.utils.swapClassName(container,'swappable_contents--show_false','swappable_contents--show_true',swapState);},initializeActionSheet:function(elementOrId,classModifier){return $(elementOrId)||this.buildActionSheet(elementOrId,classModifier);},buildActionSheet:function(elementOrId,classModifier){classModifier=classModifier||'';var id=elementOrId||('action_sheet_'+new Date().getTime());if(elementOrId&&(typeof elementOrId==='object')){id=elementOrId.id;}
var container=document.createElement('DIV');container.className='action_sheet_container rsp_only action_sheet_container--'+classModifier;actionSheet=document.createElement('DIV');actionSheet.id=id;actionSheet.className='action_sheet action_sheet--'+classModifier;container.appendChild(actionSheet);document.body.appendChild(container);return $(actionSheet);},actionSheet:function(id,options){options=options||{};if(typeof id==='object'){id=id.id;}
var actionSheet=actionSheets[id];if(!actionSheet){actionSheet=new R.controls.ActionSheet(id);actionSheets[id]=actionSheet;}
actionSheet.show(options);},actionSheetSlider:function(content,show){var slider=$$('.action_sheet_slider').first();if(!slider){slider=document.createElement('DIV');slider.className='action_sheet_slider rsp_only';var container=document.createElement('DIV');container.className='action_sheet_slider__container';slider.appendChild(container);var sheet=$$('.action_sheet_container--active').first();if(sheet){slider.style.zIndex=sheet.style.zIndex;}}
if(content){slider.down().innerHTML=content;}
document.body.appendChild(slider);if(show){R.controls.showActionSheetSlider();}
return slider;},showActionSheetSlider:function(){var slider=$$('.action_sheet_slider').first();setTimeout(function(){requestAnimationFrame(function(){if(!$(document.body).hasClassName('with_action_sheet_slider')){actionSheetSliderScrollPosition=R.utils.saveScrollPosition();$(document.body).addClassName('with_no_scroll');$(document.body).addClassName('with_action_sheet_slider');document.body.style.top=(-1*actionSheetSliderScrollPosition)+'px';if(!slider.__hammer&&window.Hammer&&Browser.responsiveBreakpoint()){slider.__hammer=new Hammer(slider.down());slider.__hammer.on('swipe',function(ev){if(ev.direction==Hammer.DIRECTION_RIGHT){R.controls.hideActionSheetSlider();}});}}});},20);},hideActionSheetSlider:function(){if(document.body.hasClassName('with_action_sheet_slider')){$(document.body).removeClassName('with_no_scroll');window.scrollTo(0,actionSheetSliderScrollPosition);$(document.body).removeClassName('with_action_sheet_slider');return true;}else{return false;}},hideActionSheet:function(id){if(typeof id==='object'){id=id.id;}
var actionSheet=actionSheets[id];if(actionSheet){actionSheet.hide();}},closeActionSheets:function(){$H(actionSheets).each(function(pair){pair.value.hide();});},updateRatingControls:function(parentId){var prefix=parentId?'#'+parentId+' ':'';var readonly=$$(prefix+'.rateable ul.readonly_rating').size()>0;if(readonly){return;}
$$(prefix+'.rateable .rating li').each(function(element){if(element.__update_rating_controls){return;}
element.__update_rating_controls=true;var ul=element.parentNode;if(Element.hasClassName(ul,'smile_rating')){Element.observe(element,'mouseenter',function(){this.addClassName('mouseenter');}.bind(element));Element.observe(element,'mouseleave',function(){this.removeClassName('mouseenter');}.bind(element));}
Event.observe(element,'click',function(){var removeRating=false;var ul=$(element.parentNode);var ratingType=ul.id;var rating=ul.getAttribute('rating');var max=0;if(rating){var happiness=$("smile_"+(parseInt(rating)-1));if(happiness&&happiness.hasClassName('selected')){removeRating=true;}
var r=0;for(var i=0;i<ul.childNodes.length;i++){var node=ul.childNodes[i];if(node.nodeType==1){max++;r+=1;var compare=node.getAttribute('data-rating')||r;compare=parseInt(compare);if(compare<=rating){Element.addClassName(node,"filled");}else{Element.removeClassName(node,"filled");}
if(compare==rating&&!removeRating){Element.addClassName(node,"selected");if(node.id){Element.addClassName(node,node.id+'_selected');}}else{Element.removeClassName(node,"selected");if(node.id){Element.removeClassName(node,node.id+'_selected');}}}}
ul.saved_rating=rating;if(ul.className.indexOf('zero_based')>=0){rating--;}
if(ul.className.indexOf('progress')>=0){var nearestProgressPercentage=ul.up('.rateable').down('.progress_name');var name=nearestProgressPercentage||$(ul.id+"_name");if(name){name.innerHTML=rating+'%';ul.originalPercent=name.innerHTML;}
var rater=$(ul.id+"_rater");if(rater){new Effect.Highlight(name,{duration:1});Element.hide(rater);}}
var postBody='_method=put&rating='+rating;if(removeRating)postBody+="&clear=1";new Ajax.Request('/ratings/'+ratingType,{method:'post',postBody:postBody,onComplete:function(req){}});}});var mouseover=function(){var ul=element.parentNode;var progress=ul.id&&ul.className.indexOf('progress')>=0;var max=0;var rating=0;var dataRating=element.getAttribute('data-rating');var rated_element=false;for(var i=0;i<ul.childNodes.length;i++){var node=ul.childNodes[i];if(node.nodeType==1){if(!rated_element){rating++;if(progress){if(node.className=='filled'){node.className='filled hover';}else{node.className='hover';}}else{Element.addClassName(node,'hover');Element.removeClassName(node,'dim');}}else{if(progress){if(node.className=='filled'){node.className='filled dim';}else{node.className='dim';}}else{Element.addClassName(node,'dim');Element.removeClassName(node,'hover');}}
max++;}
if(node==element){rated_element=true;}}
if(ul.id.indexOf('progress')>=0){var percent=$(ul.id+"_name");if(percent){if(!ul.originalPercent){ul.originalPercent=percent.innerHTML;}
if(dataRating){percent.innerHTML=dataRating+"%";}else if(rating){percent.innerHTML=(rating*5)+"%";}}}else{var score=$(ul.id+"_score");if(score&&ul.getAttribute('rating')!=rating){percent=parseFloat(rating)/parseFloat(max);if(percent==1){score.innerHTML='impossible';}else if(percent>0.7){score.innerHTML='difficult';}else if(percent>0.3){score.innerHTML='medium';}else if(percent>0.1){score.innerHTML='easy';}else{score.innerHTML='piece of cake';}}}
ul.setAttribute("rating",dataRating||rating);};Event.observe(element,'mouseover',mouseover);if(R.swatch&&R.swatch.isSwatching('FRONTEND12')){Event.observe(element,'touchstart',mouseover);}});$$(prefix+'.rateable ul.rating').each(function(element){Event.observe(element,'mouseout',function(){var ul=element;for(var i=0;i<ul.childNodes.length;i++){if(ul.childNodes[i].nodeType==1){var li=ul.childNodes[i];Element.removeClassName(li,'hover');Element.removeClassName(li,'dim');}}
var score=$(ul.id+"_score");if(score)score.innerHTML='';var percent=$(ul.id+"_name");if(percent&&ul.originalPercent)percent.innerHTML=ul.originalPercent;});});}};}();R.touchControls=function(){var responsiveInitialized=false;return{initialize:function(){Browser.onResponsiveBreakpointTriggered(function(){R.touchControls.initializeResponsive();});},initializeResponsive:function(){if(!responsiveInitialized){responsiveInitialized=true;R.touchControls.initializePhotoGalleries();R.touchControls.initializeSwipeMessages();R.controls.initializeButtonBox();}},initializePhotoGalleries:function(){$$('.lazy_srcset').each(function(lazy){lazy.observe('load',function(){var src=lazy.currentSrc||lazy.src;if(src&&src.indexOf('_thumbnail.')<0){lazy.addClassName('lazy_srcset--loaded');}});lazy.setAttribute('srcset',lazy.getAttribute('data-lazy-srcset'));});},initializeSwipeMessages:function(){$$('.swipe_message').each(function(message){new R.controls.SwipeMessage(message);});}};}();Autocompleter.Filters=Class.create();Autocompleter.Filters.prototype=Object.extend(new Autocompleter.Base(),{initialize:function(element,update,array,options){options=options||{};if(!options.onShow){options.onShow=function(element,update){if(!update.style.position||update.style.position=='absolute'){update.style.position='absolute';Position.clone(element,update,{setHeight:false,offsetTop:element.offsetHeight});}
new Effect.Appear(update,{duration:0});};}
this.onSelect=options.onSelect;this.disableMultiToken=options.disableMultiToken;this.baseInitialize(element,update,options);if(array.length>0&&array[0]['option']){console.log("processing "+array.length+" options...")
this.autocompleteItems=$H();this.options.array=$A();for(var i=0;i<array.length;i++){var item=array[i];var key=item.option[1];this.autocompleteItems[key]=item;this.options.array.push(item.option);};}else{this.options.array=array;}},getUpdatedChoices:function(){this.updateChoices(this.options.selector(this));},selectEntry:function(){var currentEntryId=this.getCurrentEntry().id;if(currentEntryId=='suggestion_anchor'){this.hide();return false;}
this.active=false;this.element.value=this.element.value.replace(": ",":").replace(this.getToken(),'');var parts=currentEntryId.split(':');var value='';var filterId=parts[0];if(parts.length>1)value=parts[1];var data;if(this.autocompleteItems){data=this.autocompleteItems[currentEntryId];}
data=data||{};var entry={id:currentEntryId,value:value,token:this.getToken(),filterId:filterId,filterPrefix:data['filter_prefix'],filterType:data['filter_type'],filterValue:value};this.onSelect(entry);this.hide();return true;},enable:function(){this.disabled=false;},disable:function(){this.disabled=true;},onObserverEvent:function(){if(!this.disabled){this.changed=false;if(this.getToken().length>=this.options.minChars){this.startIndicator();this.getUpdatedChoices();}else{this.active=false;this.hide();}}},getTokenSingle:function(){var tokenPos=this.findLastToken();var result=this.element.value;if(tokenPos!=-1)result=this.element.value.substr(tokenPos+1).replace(/^\s+/,'').replace(/\s+$/,'');return result;},getToken:function(){if(this.disableMultiToken){return this.getTokenSingle();}
caret=R.utils.getCaretInfo(this.element).caret;var parts=this.element.value.replace(": ",":").replace(/not /i,"-").split(/\s+/);var part=parts[0];var pos=0;for(var i=0;i<parts.length;i++){for(var j=0;j<parts[i].length;j++){if(pos<caret)part=parts[i];pos++;}
pos++;}
return part.replace(/^-/,'not ');},setOptions:function(options){this.options=Object.extend({choices:10,partialSearch:true,partialChars:2,fullSearch:false,selector:function(instance){var ret=[];var partial=[];var token=instance.getToken();var count=0;ret.push("<li id='suggestion_anchor'>&nbsp;</li>");for(var i=0;i<instance.options.array.length&&ret.length<instance.options.choices;i++){var entry=token;var elem=instance.options.array[i][0];var id=instance.options.array[i][1];var prefix=null;var foundPos=null;if((elem.match(/not /i)!=null)&&entry.toLowerCase().indexOf('not ')<0){continue;}
if(id[id.length-1]==':'&&entry.indexOf(':')>0){var parts=entry.split(':');var prefix=parts[0];if(elem.toLowerCase().indexOf(prefix.toLowerCase())>=0){entry=parts[1];elem=elem+": "+entry;id=id+entry;foundPos=elem.toLowerCase().indexOf(entry.toLowerCase());}}
if(!foundPos){foundPos=elem.toLowerCase().indexOf(entry.toLowerCase());}
while(foundPos!=-1){if(startingMatch&&elem.length!=entry.length){ret.push("<li id='"+id+"'><strong>"+elem.substr(0,entry.length)+"</strong>"+
elem.substr(entry.length)+"</li>");break;}else if(entry.length>=instance.options.partialChars&&instance.options.partialSearch&&foundPos!=-1){var startingMatch=elem[foundPos-2]==':';var resultList=startingMatch?ret:partial;if(instance.options.fullSearch||/\s/.test(elem.substr(foundPos-1,1))){resultList.push("<li id='"+id+"'>"+elem.substr(0,foundPos)+"<strong>"+
elem.substr(foundPos,entry.length)+"</strong>"+elem.substr(foundPos+entry.length)+"</li>");break;}}
foundPos=elem.toLowerCase().indexOf(entry.toLowerCase(),foundPos+1);}}
if(partial.length){ret=ret.concat(partial.slice(0,instance.options.choices-ret.length));}
if(ret.length==1)ret=[];return"<ul>"+ret.join('')+"</ul>";}},options||{});}});R.controls.ActionSheets=$A();R.controls.ActionSheets.startingIndex=1000;R.controls.ActionSheets.swipeToCloseThreshold=100;R.controls.ActionSheet=function(actionSheet){R.controls.ActionSheets.push(this);this.actionSheet=$(actionSheet);this.actionSheetContainer=this.actionSheet.up();this.active=false;this.index=R.controls.ActionSheets.startingIndex++;this.linkSheet=this.actionSheet.hasClassName('action_sheet--links');this.fullscreen=this.actionSheet.hasClassName('action_sheet--fullscreen');this.onDeactivate=null;this.addEventListeners();this.trapFocus();this.setPosition();};R.controls.ActionSheet.prototype.addEventListeners=function(){if(!R.controls.ActionSheets.__addEventListeners){R.controls.ActionSheets.__addEventListeners=true;var body=$(document.body);body.observe('click',function(e){var clickedSheet=Event.element(e).up('.action_sheet');var clickedCancel=R.utils.eventTriggeredOn(e,'action_sheet__cancel');var hidden=false;R.controls.ActionSheets.sortBy(function(e){return-1*e.index;}).each(function(sheet){var linkSheet=sheet.linkSheet;var clickedSelf=clickedSheet==sheet.actionSheet;if(clickedSelf&&linkSheet){hidden=true;sheet.hide();if(clickedCancel){Event.stop(e);}}else if(clickedSelf&&clickedCancel){hidden=true;Event.stop(e);sheet.hide();}else if(!R.utils.eventTriggeredOn(e,'action_sheet')&&!R.utils.eventTriggeredOn(e,'action_sheet_slider')){if(!hidden&&sheet.active&&sheet.triggeredByEvent!=e){hidden=true;sheet.hide();}}});});body.addEventListener('touchstart',function(e){if(!body.hasClassName('with_action_sheet')){return;}
if(e.touches[0]){R.controls.ActionSheets.__touchStartY=e.touches[0].screenY;}},{passive:true})
document.body.addEventListener('touchend',function(e){if(!body.hasClassName('with_action_sheet')){return;}
if(R.controls.ActionSheets.__touchStartY&&e.changedTouches[0]){var change=e.changedTouches[0].screenY-R.controls.ActionSheets.__touchStartY;if(change<R.controls.ActionSheets.swipeToCloseThreshold){return;}
R.controls.ActionSheets.sortBy(function(e){return-1*e.index;}).each(function(sheet){var hidePerformed=false;var scrollable=sheet.actionSheet.scrollHeight!=sheet.actionSheet.clientHeight;if(!hidePerformed&&sheet.active&&sheet.linkSheet&&!scrollable){e.stopPropagation()
e.stopImmediatePropagation()
hidePerformed=true;var hideDuration=parseInt(getComputedStyle(document.documentElement).getPropertyValue('--action-sheet-slide-duration-ms'));sheet.actionSheet.addClassName('action_sheet--hiding');setTimeout(function(){sheet.hide();sheet.actionSheet.removeClassName('action_sheet--hiding');},hideDuration);}});}},{passive:true});}};R.controls.ActionSheet.prototype.appendChild=function(node){this.actionSheet.appendChild(node);};R.controls.ActionSheet.prototype.isActive=function(){return this.active;};R.controls.ActionSheet.prototype.setPosition=function(){};R.controls.ActionSheet.prototype.show=function(options){options=options||{};if(!this.active||options.activate){this.triggeredByEvent=window.event;this.onDeactivate=options.onDeactivate;if(!$(document.body).hasClassName('with_action_sheet')){this.savedScrollPosition=R.utils.saveScrollPosition();}
this.actionSheetContainer.style.zIndex=this.index;$(this.actionSheetContainer).addClassName('action_sheet_container--active');$(document.body).addClassName('with_action_sheet');$(document.body).addClassName('with_action_sheet--'+this.actionSheet.id);$(document.body).addClassName('with_no_scroll');$('content').setAttribute('aria-hidden','true');if(this.fullscreen)$(document.body).addClassName('with_action_sheet--fullscreen');if(this.savedScrollPosition){document.body.style.top=(-1*this.savedScrollPosition)+'px';}
var me=this;me.actionSheet.observe('transitionend',function(){if(me.actionSheet.down('.without_action_sheet_focus')){var focusable=me.actionSheet.down('a.clicker');if(focusable){focusable.focus();}}else{var focusable=me.actionSheet.down("input[type='text']")||me.actionSheet.down("textarea");if(focusable){R.utils.focusTextField(focusable);}}});if(options.callback){setTimeout(options.callback,550);}}
this.active=true;};R.controls.ActionSheet.prototype.deactivate=function(immediate){this.active=false;var me=this;if(document.body.hasClassName('with_action_sheet_slider')&&!immediate){setTimeout(function(){me.deactivate(true);},400);return false;}
$(document.body).removeClassName('with_action_sheet--'+this.actionSheet.id);$('content').setAttribute('aria-hidden','false');if(this.actionSheetContainer){$(this.actionSheetContainer).removeClassName('action_sheet_container--active');}
if(!$$('.action_sheet_container--active').first()){$(document.body).removeClassName('with_action_sheet');$(document.body).removeClassName('with_no_scroll');}
if(this.onDeactivate){this.onDeactivate();}};R.controls.ActionSheet.prototype.hide=function(){if(this.active){this.deactivate();if(this.actionSheet.down('#RB_redbox')){RedBox.close();}
if(this.savedScrollPosition){document.body.style.top='';window.scrollTo(0,this.savedScrollPosition);}}};R.controls.ActionSheet.prototype.trapFocus=function(){var me=this;var selectors='a[href], area[href], input:not([disabled]), select:not([disabled]), textarea:not([disabled]), button:not([disabled]), iframe, object, [tabindex="0"], [contenteditable]';var focusable=this.actionSheet.querySelectorAll(selectors);if(focusable.length>0){var firstFocusable=focusable[0];var lastFocusable=focusable[focusable.length-1];me.actionSheet.observe('keydown',function(e){if(e.keyCode===Event.KEY_TAB){if(e.shiftKey&&document.activeElement===firstFocusable){e.preventDefault();lastFocusable.focus();}else if(!e.shiftKey&&document.activeElement===lastFocusable){e.preventDefault();firstFocusable.focus();}}});}};R.controls.MenuFieldGroup=function(options){options=options||{};this.setSelections(options.selections||[]);};R.controls.MenuFieldGroup.prototype.reset=function(){this.selections=[];};R.controls.MenuFieldGroup.prototype.setSelections=function(selections){this.selections=$A(selections).map(function(id){return parseInt(id,10);});};R.controls.MenuField=function(menuField,options){options=options||{};this.menuField=menuField;this.menuContent=options.menuContent||menuField.up('.field').down('.menu_content ul');this.afterSelect=options.afterSelect;this.beforeToggle=options.beforeToggle;this.onDelete=options.onDelete;this.retainSelections=options.retainSelections;this.menuFieldGroup=options.menuFieldGroup||(new R.controls.MenuFieldGroup());this.onChange=options.onChange;this.multiple=options.multiple;this.tooltips=options.tooltips;this.autoMakeRoom=options.autoMakeRoom;this.autoWidth=options.autoWidth;this.addMenuFieldObservers();if(this.menuContent&&!this.menuContent.menuFieldSetup){this.menuContent.menuFieldSetup=true;this.addCloseOnClickObserver();this.addItemObservers();this.addFolderObservers();}
if(this.menuContent&&this.menuFieldGroup.selections){this.markInitialSelections();}
if(this.tooltips){this.enableTooltips();}};R.controls.MenuField.prototype.toggled=function(evt){if(this.beforeToggle){if(this.beforeToggle(evt)===false){Event.stop(evt);return false;}}
var clicked=Event.element(evt);if(clicked.hasClassName('delete')){if(this.onDelete){this.onDelete(clicked.getAttribute('data-id'));}
else if(this.onChange){this.menuFieldGroup.selections=this.menuFieldGroup.selections.without(clicked.getAttribute('data-id'));this.onChange(this.menuFieldGroup.selections);}
Event.stop(evt);return false;}
if(this.menuContent.openedBy!=this.menuField){this.menuContent.getElementsBySelector('ul').each(function(ul){ul.hide();});}
this.menuContent.openedBy=this.menuField;var newTop=(Position.positionedOffset(this.menuField)[1])+"px";if(this.autoWidth){console.log($(this.menuField).getWidth()+'px');this.menuContent.style.width=$(this.menuField).getWidth()+'px';}
if(newTop!=this.menuContent.style.top){this.menuContent.style.top=newTop;this.menuContent.up().show();this.menuContent.show();}else{this.menuContent.toggle();}
Event.stop(evt);};R.controls.MenuField.prototype.addCloseOnClickObserver=function(){Event.observe(document.body,'click',function(e){var parent=$(Event.element(e)).up('.menu_content');$$('.menu_content').each(function(f){if(f!=parent){f.down('ul').hide();}});});};R.controls.MenuField.prototype.addMenuFieldObservers=function(){var link=this.menuField;var me=this;Event.observe(link,'click',function(e){me.toggled.call(me,e,link);});};R.controls.MenuField.prototype.markInitialSelections=function(selections,triggerCallbacks){var menuContent=this.menuContent;var selectionsToMark=selections||$A(this.menuFieldGroup.selections);var afterSelect=this.afterSelect;menuContent.getElementsBySelector('a.item').each(function(item){var id=parseInt(getId(item));if(id&&selectionsToMark.indexOf(id)>=0){item.addClassName('selected');item.setAttribute('aria-selected','true');if(triggerCallbacks&&afterSelect){afterSelect(null,getId(item),item);}
var folder=item.up('li.folder');while(folder){var a=folder.down('a.folder');a.addClassName('selected');a.setAttribute('aria-selected','true');folder=folder.up('li.folder');}}});};R.controls.MenuField.prototype.updateFolderState=function(selectedItem){var openFolders=[];var f=selectedItem;if(!(f.tagName=='LI'&&f.hasClassName('folder'))){f=f.up('li.folder');}
while(f){var a=f.down('a.folder');openFolders.push(a);a.addClassName('open');f=f.up('li.folder');}
$A(openFolders).each(function(folder){if(folder.up('li').down('a.item.selected')){folder.addClassName('selected');folder.setAttribute('aria-selected','true');}else{folder.removeClassName('selected');folder.setAttribute('aria-selected','false');}});this.menuContent.getElementsBySelector('a.folder').each(function(folder){if(openFolders.indexOf(folder)<0){folder.removeClassName('open');}});};R.controls.MenuField.prototype.enableTooltips=function(){var menuContent=this.menuContent;var me=this;menuContent.getElementsBySelector('a.item').each(function(item){var attributeId=parseInt(getId(item),10);Event.observe(item,'mouseover',function(evt){tipText=me.tooltips[attributeId]||item.getAttribute('data-tooltip');if(!tipText||tipText===''){return;}
var tip=$("tooltip_"+item.id);if(!tip){new Insertion.Bottom($('page'),"<span class='floating_tip' id='tooltip_"+item.id+"'>"+tipText+"</span>");tip=$("tooltip_"+item.id);tip.style.position='absolute';tip.style.width='250px';tip.style.zIndex=2000;var pos=Position.page(item);tip.style.top=Math.round(Event.pointerY(evt)-Element.getHeight(tip)/2)+'px';tip.style.left=(pos[0]+Element.getWidth(item))+'px';}
tip.show();Event.observe(item,'mouseout',function(){tip.hide();});});});};R.controls.MenuField.prototype.deselectItemById=function(id){this.setItemById(id,false);};R.controls.MenuField.prototype.selectItemById=function(id){this.setItemById(id,true);};R.controls.MenuField.prototype.setItemById=function(id,state){this.menuContent.getElementsBySelector('a.item').each(function(item){var currentState=item.hasClassName('selected');if(parseInt(getId(item))==id&&currentState!=state){var evt=new MouseEvent("click");item.dispatchEvent(evt);}});};R.controls.MenuField.prototype.addItemObservers=function(){var me=this;var menuContent=this.menuContent;var afterSelect=this.afterSelect;var retainSelections=this.retainSelections;var onChange=this.onChange;var multiple=this.multiple;menuContent.getElementsBySelector('a.item').each(function(item){Event.observe(item,'click',function(e){if(!retainSelections){menuContent.getElementsBySelector('a.item').each(function(i){i.removeClassName('selected');i.setAttribute('aria-selected','false');});}
item.up('ul').getElementsBySelector('.folder ul').each(function(folder){folder.hide();});if(retainSelections&&item.hasClassName('selected')){item.removeClassName('selected');item.setAttribute('aria-selected','false');var remove=getId(item);if(multiple){me.menuFieldGroup.selections=me.menuFieldGroup.selections.without(parseInt(remove));}else{me.setSelections([]);}
if(onChange)onChange(me.selections);if(afterSelect)afterSelect(null,getId(item));}else{item.addClassName('selected');item.setAttribute('aria-selected','true');var itemToRemove=null;var openedBy=menuContent.openedBy;if(openedBy&&!Element.hasClassName(openedBy,'menu_field_chooser')){itemToRemove=getId(openedBy)||openedBy.innerHTML;}
var itemToAdd=getId(item)||item.innerHTML;if(itemToAdd!=itemToRemove){if(afterSelect)afterSelect(itemToAdd,itemToRemove,item);if(multiple){removeIndex=me.menuFieldGroup.selections.indexOf(parseInt(itemToRemove));if(removeIndex>=0){me.menuFieldGroup.selections[removeIndex]=parseInt(itemToAdd);}else{me.menuFieldGroup.selections.push(parseInt(itemToAdd));}}else{me.menuFieldGroup.selections=[parseInt(itemToAdd)];}
if(onChange)onChange(me.menuFieldGroup.selections);}
me.updateFolderState(item);}
if(!retainSelections){menuContent.hide();}
Event.stop(e);});});};R.controls.MenuField.prototype.addFolderObservers=function(){var menuContent=this.menuContent;var retainSelections=this.retainSelections;var me=this;menuContent.getElementsBySelector('a.folder').each(function(folder){Event.observe(folder,'click',function(e){menuContent.getElementsBySelector('a.folder').each(function(f){if(!retainSelections){f.removeClassName('selected');f.setAttribute('aria-selected',false);}
f.removeClassName("open");});me.updateFolderState(folder);var show=folder.next('ul');menuContent.getElementsBySelector('ul').each(function(folder){folder.hide();});var madeRoom=false;while(show){show.show();if(me.autoMakeRoom&&!madeRoom){R.utils.makeRoom(show);madeRoom=true;}
show=show.up('ul');}
Event.stop(e);});});};R.controls.FilterMenu=function(menuControlId,menuContent,options){if(!options)options={};this.usePushState=options.usePushState;this.menu=$(menuControlId);this.menuContent=$(menuContent);this.form=this.menu.up('form');this.resetLink=options.resetLink;this.updateIconSources();this.updateForm();this.updateLabel();var me=this;var autoWidth=options.autoWidth;this.menuField=new R.controls.MenuField(this.menu,{multiple:true,autoWidth:autoWidth,retainSelections:true,autoMakeRoom:options.autoMakeRoom,menuContent:this.menuContent,afterSelect:function(newValue){me.afterSelect(newValue);}});};R.controls.FilterMenu.prototype.updateIconSources=function(){if(R.swatch.isSwatching('FRONTEND12')){this.menu.next('.menu_content').getElementsBySelector('img').each(function(img){if(img.getAttribute('data-icon-svg')){img.setAttribute('src','/images/'+img.getAttribute('data-icon-svg'));}});}};R.controls.FilterMenu.prototype.afterSelect=function(newValue){this.updateForm();this.updateLabel();var indicator=$('filter_menu_indicator');if(indicator)indicator.show();$$('.menu_content').each(function(f){f.down('ul').hide();});if(this.usePushState&&history.pushState){var queryString=$H(Form.serialize(this.form)).toQueryString();var url=this.form.action+"?"+queryString;new Ajax.Request(url+"&ajax=1",{method:'GET',onComplete:function(){if(indicator)indicator.hide();window.history.pushState({},'Filtering',url);}});}else{this.form.submit();}};R.controls.FilterMenu.prototype.updateLabel=function(){var label=this.menu.down('span');var selectedItems=this.menu.next('.menu_content').getElementsBySelector('a.item.selected');if(!label.originalLabel){label.originalLabel=label.innerHTML;}
if(selectedItems.length>1){var icons="";selectedItems.each(function(item){var icon=item.down('img');if(icon)icons+=icon.outerHTML;});if(icons.length>0)icons+=" ";label.innerHTML=icons+selectedItems.length+" selections...";}else if(selectedItems.length==1){label.innerHTML=selectedItems[0].innerHTML;}else{label.innerHTML=label.originalLabel;}
var resetLink=this.resetLink;if(typeof resetLink=='undefined')resetLink=$('clear_filters');if(resetLink&&selectedItems.length===0){resetLink.hide();}else if(resetLink){resetLink.show();}};R.controls.FilterMenu.prototype.updateForm=function(){$$('input.filter_menu_input').each(function(input){input.value='';});var me=this;this.menuContent.getElementsBySelector('a.selected').each(function(selected){var folderItem=selected.up('li.folder');var name=selected.getAttribute('data-key');var value=selected.getAttribute('data-id');var multiple=folderItem||selected.getAttribute('data-multiple')=='true';var id='filter_menu_'+name;if(multiple){id='filter_menu_'+name+"_"+value;}
var existing=$(id);if(existing){existing.value=value;}else{var input=document.createElement('input');input.type='hidden';input.id=id;input.value=value;input.className='filter_menu_input';if(multiple){input.name=name+"[]";}else{input.name=name;}
me.form.appendChild(input);}});this.updateLabel();};R.controls.HoverTools=function(hoverTarget,toolContainer,options){if(!options)options={};this.deleteConfirmation=options.deleteConfirmation;this.hoverInterval=options.hoverInterval;if(this.hoverInterval==null)this.hoverInterval=50
this.imageBase='/images';this.callbacks={};this.toolNames=[];this.extraLabel=null;this.tools=[];this.initialized=false;this.locked=false;this.active=false;this.confirming=false;this.stopClickPropagation=options.stopClickPropagation;this.hoverTarget=hoverTarget;this.toolContainer=toolContainer;this.activateOnTouchStart=options.activateOnTouchStart;this.touchDevice=options.touchDevice;if(this.touchDevice==undefined){this.touchDevice=Browser.hasTouchEvents();}
this.buttonContainerMargin='3px';this.buttonSize=options.buttonSize||'24px';this.highlightColor='#AF083C';this.onDocumentMouseOver=null;this.tapRecognizer=null;this.attachEvents();R.controls.HoverTools.registered.push(this);};R.controls.HoverTools.locked=false;R.controls.HoverTools.registered=$A([]);R.controls.HoverTools.applyWithSelector=function(selector,containerSelector,options){var results=$A([]);if(!options)options={};var tools=$H(options.tools||{});var touchTools=$H(options.touchTools||{});var hoverToolsOptions={touchDevice:options.touchDevice,deleteConfirmation:options.deleteConfirmation,hoverInterval:options.hoverInterval,stopClickPropagation:options.stopClickPropagation,activateOnTouchStart:options.activateOnTouchStart,buttonSize:options.buttonSize};$$(selector).each(function(hoverable){var container=containerSelector?hoverable.down(containerSelector):hoverable;var disabled=hoverable.getAttribute('data-hovertools')=='disabled';if(container&&!disabled){var ht=new R.controls.HoverTools(hoverable,container,hoverToolsOptions);$A(tools).each(function(entry){if(entry.key=='extra'){ht.extraTagName=entry.value.tagName||'A';ht.extraIcon=entry.value.icon;ht.extraIcon2x=entry.value.icon2x;ht.extraLabel=entry.value.label;ht.extraPosition=entry.value.position;ht.addTool(entry.key,entry.value.callback);}else{ht.addTool(entry.key,entry.value);}});$A(touchTools).each(function(entry){if(entry.key=='extra'){ht.extraIcon=entry.value.icon;ht.extraIcon2x=entry.value.icon2x;ht.extraLabel=entry.value.label;ht.extraPosition=entry.value.position;ht.addTool(entry.key,entry.value.callback);}else{ht.addTouchTool(entry.key,entry.value);}});ht.initialize();results.push(ht);}});var me=this;$(document.body).observe('mousemove',function(){if(!Browser.probablyTouchScreen()&&!results.__checkedForTouchDevice){results.__checkedForTouchDevice=true;results.each(function(hoverTools){if(hoverTools.touchDevice){hoverTools.touchDevice=false;hoverTools.attachMouseEvents();}});}
return true;});return results;};R.controls.HoverTools.prototype.setLocked=function(locked){this.locked=locked;};R.controls.HoverTools.prototype.isLocked=function(){return R.controls.HoverTools.locked||this.locked;};R.controls.HoverTools.prototype.hideHoverTools=function(){if(!this.isLocked()){$A(this.tools).each(function(tool){tool.style.display='none';});this.hoverTarget.removeClassName('hover_tools_active');this.active=false;}};R.controls.HoverTools.prototype.attachEvents=function(){if(this.touchDevice){var eventName=this.activateOnTouchStart?'touchstart':'click';$(this.hoverTarget).observe(eventName,this.showHoverToolsIfHidden.bind(this));}else{this.attachMouseEvents();}};R.controls.HoverTools.prototype.attachMouseEvents=function(){if(this.mouseEventsAttached)return;var me=this;this.mouseEventsAttached=true;$(this.hoverTarget).hoverIntent({sensitivity:7,interval:this.hoverInterval,timeout:0,over:me.showHoverTools.bind(me),out:me.hideHoverTools.bind(me)});};R.controls.HoverTools.prototype.showHoverToolsIfHidden=function(e){if(!this.isLocked()&&!this.active&&!this.confirming){this.globalHideHoverTools();this.showHoverTools();if(!this.activateOnTouchStart){Event.stop(e);}}};R.controls.HoverTools.prototype.showHoverTools=function(){if(!this.isLocked()&&!this.confirming){$A(this.tools).each(function(tool){tool.style.display='block';});this.hoverTarget.addClassName('hover_tools_active');this.active=true;}};R.controls.HoverTools.prototype.globalHideHoverTools=function(){R.controls.HoverTools.registered.each(function(hoverTools){if(hoverTools!=this){hoverTools.hideHoverTools();}});};R.controls.HoverTools.prototype.addTool=function(toolName,callback){this.toolNames.push(toolName);this.callbacks[toolName]=callback;};R.controls.HoverTools.prototype.addTouchTool=function(toolName,callback){if(this.touchDevice){this.toolNames.push(toolName);this.callbacks[toolName]=callback;}};R.controls.HoverTools.prototype.initialize=function(){if(this.initialized){return;}
this.initialized=true;var toolInitializers={'edit':'initializeEditTool','confirmedDelete':'initializeConfirmedDeleteTool','prepareDelete':'initializePrepareDeleteTool','view':'initializeViewTool','extra':'initializeExtraTool'};var me=this;$A(this.toolNames).each(function(toolName){var initializer=toolInitializers[toolName];if(!me[initializer]){console.log("No initialization function for tool: "+initializer);}else{me[initializer]();}});};R.controls.HoverTools.prototype.setButtonStyle=function(button,hoverEffects){button=$(button);Element.setStyle(button,{display:'none',position:'absolute',bottom:this.buttonContainerMargin,backgroundColor:'#fff',border:'1px solid #979797',borderRadius:'5px',height:this.buttonSize,lineHeight:this.buttonSize,fontSize:'0.95em',textAlign:'center',padding:'2px',zIndex:100});if(this.stopClickPropagation){Event.observe(button,'touchstart',function(e){e.stopPropagation();});Event.observe(button,'mousedown',function(e){e.stopPropagation();});Event.observe(button,'click',function(e){e.stopPropagation();});}
if(R.swatch&&R.swatch.isSwatching('FRONTEND12')){hoverEffects=false;}
if(hoverEffects){var highlightColor=this.highlightColor;button.onmouseenter=function(){button.addClassName('hover_tool--mouseover');button.style.border=('3px solid '+highlightColor);button.style.padding='0px';};button.onmouseleave=function(){button.removeClassName('hover_tool--mouseover');button.style.border='1px solid #979797';button.style.padding='2px';};}};R.controls.HoverTools.prototype.initializeTool=function(tagName,toolName,icon,icon2x,label,position,callback){var tool=document.createElement(tagName);var srcset='';if(icon2x)srcset="srcset='"+this.imageBase+"/"+icon+" 1x, "+this.imageBase+"/"+icon2x+" 2x'";tool.innerHTML="<img src='"+this.imageBase+'/'+icon+"' "+srcset+" style='vertical-align: middle;' /> "+label;if(label==='')tool.innerHTML+='&nbsp;';tool.href='#';tool.className='hover_tool_icon hover_tool_'+toolName;this.setButtonStyle(tool,true);var toolWidth=null;var iconOnly=label==='';if(iconOnly){toolWidth=parseInt(this.buttonSize);tool.style.width=this.buttonSize;tool.className+=' hover_tool_icon--icon_only';}else{toolWidth=Math.round(this.toolContainerWidth()/3.75);tool.style.width=toolWidth+'px';}
if(position=='right'){tool.style.right=this.buttonContainerMargin;}else if(position=='left'){tool.style.left=this.buttonContainerMargin;}else if(position=='center'){tool.style.left=Math.round(this.toolContainerWidth()/2.0-toolWidth/2.0)+'px';}
var onclickCallback=callback;var callbackArg=this.hoverTarget;if(onclickCallback){var me=this;tool.onclick=function(){var result=onclickCallback(callbackArg);if(result==false){me.hideHoverTools();}
return false;};}else{var defaultLink=this.toolContainer.up('a');if(defaultLink&&defaultLink.href){tool.onclick=function(){window.location.href=defaultLink.href;};}}
this.tools.push(tool);this.toolContainer.style.position='relative';this.toolContainer.appendChild(tool);};R.controls.HoverTools.prototype.confirmDelete=function(onConfirmCallback){this.hideHoverTools();this.confirming=true;if(this.confirmBox){this.confirmBox.style.display='block';return;}
var deleteConfirmation=this.deleteConfirmation;var deleteConfirmationMessage=deleteConfirmation||'Are you sure that you want to delete this thing?';var yesButtonText='yes, delete';var noButtonText='no, cancel';if(deleteConfirmation&&((typeof deleteConfirmation)=='object')){deleteConfirmationMessage=deleteConfirmation.message||deleteConfirmationMessage;yesButtonText=deleteConfirmation.yesButton||yesButtonText;noButtonText=deleteConfirmationMessage.noButton||noButtonText;}
var confirmBox=document.createElement('DIV');this.confirmBox=confirmBox;confirmBox.observe('click',function(e){Event.stop(e);});this.setButtonStyle(confirmBox);Element.setStyle(confirmBox,{height:'90px',textAlign:'left',lineHeight:'1.3em',padding:'5px'});confirmBox.style.left=this.buttonContainerMargin;confirmBox.style.right=this.buttonContainerMargin;confirmBox.className='hover_tool_delete_confirmation';confirmBox.innerHTML="<img style='display: block; float: left; margin: 0 5px 1em 0; vertical-align: middle;' src='"+this.imageBase+"/silk-bin_closed.png' /> ";var text=document.createElement("SPAN");text.style.color='black';text.style.overflow='hidden';text.style.display='block';text.innerHTML=deleteConfirmationMessage;confirmBox.appendChild(text);confirmBox.style.display='block';var noButton=document.createElement('A');noButton.className='hover_tool_delete_confirmation__cancel';noButton.innerHTML=noButtonText;this.setButtonStyle(noButton,true);Element.setStyle(noButton,{left:this.buttonContainerMargin,display:'block'});var yesButton=document.createElement('A');yesButton.className='hover_tool_delete_confirmation__confirm';yesButton.innerHTML=yesButtonText;this.setButtonStyle(yesButton,true);Element.setStyle(yesButton,{backgroundColor:this.highlightColor,color:'#f3f3f3',right:this.buttonContainerMargin,display:'block'});noButton.style.fontSize=yesButton.style.fontSize='1.1em';noButton.style.width=yesButton.style.width=Math.round(this.toolContainerWidth()/2.5)+'px';confirmBox.appendChild(noButton);confirmBox.appendChild(yesButton);this.toolContainer.appendChild(confirmBox);noButton.onclick=function(){this.cancelConfirmDelete();return false;}.bind(this);yesButton.onclick=function(){this.cancelConfirmDelete();onConfirmCallback(this.hoverTarget);return false;}.bind(this);};R.controls.HoverTools.prototype.cancelConfirmDelete=function(){this.confirmBox.style.display='none';this.confirming=false;};R.controls.HoverTools.prototype.initializeEditTool=function(){var icon='silk-pencil.png';if(R.swatch.isSwatching('FRONTEND12')){icon='assets/icons/ui/edit.svg';}
var label='edit';var position='right';var callbackOrOptions=this.callbacks.edit;var callback=callbackOrOptions;var coalesce=function(x,y){return x==null?y:x;};if(((typeof callbackOrOptions)!='function')&&callbackOrOptions.callback){callback=callbackOrOptions.callback;icon=coalesce(callbackOrOptions.icon,icon);label=coalesce(callbackOrOptions.label,label);position=coalesce(callbackOrOptions.position,position);}
this.initializeTool('A','edit',icon,null,label,position,callback);};R.controls.HoverTools.prototype.initializeViewTool=function(){var icon='silk-magnifier.png';if(R.swatch.isSwatching('FRONTEND12')){icon='assets/icons/ui/search-label.svg';}
this.initializeTool('A','view',icon,null,'view','center',this.callbacks.view);};R.controls.HoverTools.prototype.initializePrepareDeleteTool=function(){var icon='silk-bin_closed.png';if(R.swatch.isSwatching('FRONTEND12')){icon='assets/icons/ui/delete.svg';}
this.initializeTool('A','delete',icon,null,'','left',this.callbacks.prepareDelete);};R.controls.HoverTools.prototype.initializeConfirmedDeleteTool=function(){var icon='silk-bin_closed.png';if(R.swatch.isSwatching('FRONTEND12')){icon='assets/icons/ui/delete.svg';}
this.initializeTool('A','delete',icon,null,'','left',function(){this.confirmDelete(this.callbacks.confirmedDelete);}.bind(this));};R.controls.HoverTools.prototype.initializeExtraTool=function(){this.initializeTool(this.extraTagName,'extra',this.extraIcon,this.extraIcon2x,this.extraLabel,this.extraPosition,this.callbacks.extra);};R.controls.HoverTools.prototype.toolContainerWidth=function(){this.cachedToolContainerWidth=this.cachedToolContainerWidth||Element.getWidth(this.toolContainer);return this.cachedToolContainerWidth;};Autocompleter.SelectBox=Class.create();Object.extend(Object.extend(Autocompleter.SelectBox.prototype,Object.extend(Autocompleter.Local.prototype,Autocompleter.Base.prototype)),{initialize:function(element,elementOrFunctionForSelection,update,choiceHash,options){var update=$(update);document.body.appendChild(update.parentNode.removeChild(update));if(typeof(elementOrFunctionForSelection)=="function"){this.onSelect=elementOrFunctionForSelection;}else if(elementOrFunctionForSelection){var elementForId=elementOrFunctionForSelection;this.onSelect=function(id){$(elementForId).value=id;};}
var defaults=$H({minChars:-1,choices:1000,partialChars:2,frequency:0.1,partialSearch:true,fullSearch:true,width:'',pageSize:5,beforeUpdateChoices:null});this.options=defaults.merge(options||{});var element=element;var me=this;this.options.onShow=function(element,update){me.removePlaceholder();update.style.position='absolute';Position.clone(element,update,{setHeight:false,setWidth:true,offsetTop:element.offsetHeight});var ul=update.down('ul');if(ul&&update.offsetWidth){ul.style.width=update.offsetWidth+"px";}
element.up().addClassName('has_active_select_box_autocomplete');if(!ul||ul.innerHTML!=''){Element.show(update);R.utils.makeRoom(update);}};this.options.onHide=function(element,update){element.up().removeClassName('has_active_select_box_autocomplete');Element.hide(update);};if(this.options.acceptCustomEntry){element.observe('keypress',function(e){if(e.keyCode==Event.KEY_RETURN){Event.stop(e);me.selectCustomEntry();}});}
if(this.options.handle){this.handle=options.handle;$(options.handle).observe('click',function(e){if(Element.getStyle(update,'display')=='none'){me.activate();me.show();}else{me.hide();}
Event.stop(e);})}
this.options.items=choiceHash;this.baseInitialize(element,update,this.options);this.addPlaceholder();},selectCustomEntry:function(){if(this.onSelect){this.onSelect(null,null,this);}},addPlaceholder:function(){if(this.options.placeholderText){var placeholder=document.createElement('SPAN');placeholder.style.zIndex='-1';placeholder.style.fontSize='12px';placeholder.style.color='#333';placeholder.style.display='inline-block';placeholder.style.position='relative';placeholder.style.paddingLeft='1em';placeholder.style.top=(-1*(this.element.getHeight()+$(placeholder).getHeight()))+'px';placeholder.innerText=this.options.placeholderText;this.element.parentNode.appendChild(placeholder);this.placeholder=placeholder;}},removePlaceholder:function(){if(this.placeholder){this.placeholder.parentNode.removeChild(this.placeholder);this.placeholder=null;}},setChoices:function(choiceHash){this.options.items=choiceHash;},getUpdatedChoices:function(){var selector=function(instance){var matchHtml=[];var entry=instance.getToken().toLowerCase();var count=0;var currentGroup=null;for(var i=0;i<instance.options.items.length;i++){var item=instance.options.items[i];var name=(item['name']||'').toLowerCase();var shortName=(item['short_name']||name).toLowerCase();var displayName=item['short_name']||item['name']||'';var autocompleteOnly=item['autocomplete_only'];var groupName=item['group'];var foundPos=name.indexOf(entry);var openTag="<li data-id=\""+item['id']+"\">";if(foundPos!=-1&&(currentGroup!=groupName)&&(!autocompleteOnly||entry!='')){openTag+="<span class=\"group_name informal\">"+groupName+"</span>";currentGroup=groupName;}
openTag=openTag+"<span class=\"short_name\">";var closeTag="</span></li>";if(foundPos!=-1){if(item['thumbnail']){openTag=openTag+"<img src='"+item['thumbnail']+"'/> ";}
var highlightPos=shortName.indexOf(entry);if(!autocompleteOnly||entry!=''){if(highlightPos===0&&shortName.length!=entry.length){matchHtml.push(openTag+"<strong>"+displayName.substr(0,entry.length)+"</strong>"+displayName.substr(entry.length)+closeTag);}else if(highlightPos!=-1){matchHtml.push(openTag+displayName.substr(0,highlightPos)+"<strong>"+displayName.substr(highlightPos,entry.length)+"</strong>"+shortName.substr(highlightPos+entry.length)+closeTag);}else{matchHtml.push(openTag+displayName+closeTag);}}}}
return"<ul>"+matchHtml.join('')+"</ul>";};var selected=selector(this);if(this.options.beforeUpdateChoices){this.options.beforeUpdateChoices(selected);}
this.updateChoices(selected);},updateElement:function(selectedElement){var value=Element.collectTextNodesIgnoreClass(selectedElement,'informal').replace(/^\s+|\s+$/g,'');var id=selectedElement.getAttribute('data-id');this.element.value=value;var nextInput=this.element.next('input');if(nextInput)nextInput.focus();if(this.onSelect){this.onSelect(id,selectedElement,this);}},onBlur:function(event){if(!this.handle){setTimeout(this.hide.bind(this),250);this.hasFocus=false;this.active=false;}},prependOnKeyPress:function(event){if(this.active){var pageSize=this.options.pageSize;switch(event.keyCode){case Event.KEY_TAB:return;}}
return this.onKeyPressOriginal(event);},onKeyPressOriginal:function(){throw'not implemented';},stopIndicator:function(){if(this.options.indicator)Element.hide(this.options.indicator);if(this.update)this.update.scrollTop=0;}});Autocompleter.SelectBox.prototype.onKeyPressOriginal=Autocompleter.SelectBox.prototype.onKeyPress;Autocompleter.SelectBox.prototype.onKeyPress=Autocompleter.SelectBox.prototype.prependOnKeyPress;R.controls.Highlighter=function(className,options){if(!options)options={};this.highlights={};this.className=className;this.element=$$('.'+this.className).first();this.onChange=options.onChange;this.currentData=null;this.addEventHandlers();};R.controls.Highlighter.supported=function(){return window.getSelection;};R.controls.Highlighter.prototype.fireOnChange=function(){if(this.onChange){var newData=this.toJSON();if(newData!=this.currentData){this.currentData=newData;this.onChange(this,this.element,this.currentData);}}};R.controls.Highlighter.prototype.addEventHandlers=function(){var me=this;Event.observe(this.element,'mouseup',function(){me.capture();});if(Browser.hasTouchEvents()){Event.observe(this.element,'copy',function(){me.capture();});}else{Event.observe(this.element,'click',function(e){var elem=$(Event.element(e));if(elem.hasClassName('highlight-delete')){me.removeHighlight(elem.up('.highlight-control').getAttribute('data-index'));me.fireOnChange();}});}};R.controls.Highlighter.prototype.capture=function(){var tempNode=this.tempNode;if(!tempNode){tempNode=document.createElement('div');tempNode.style.display='none';document.body.appendChild(tempNode);this.tempNode=tempNode;}
if(window.getSelection){var selection=window.getSelection();if(selection.rangeCount>0){var range=window.getSelection().getRangeAt(0);if(range)tempNode.appendChild(range.cloneContents());}}
var content=tempNode;var existing=content.getElementsBySelector('.highlight-control');for(var i=0;i<existing.length;i++){this.removeHighlight(existing[i].getAttribute('data-index'));$(existing[i]).replace(existing.innerHTML);}
if(existing.length>0&&window.getSelection){tempNode.innerHTML='';var range=window.getSelection().getRangeAt(0);if(range)tempNode.appendChild(range.cloneContents());}
content=$(tempNode).down('.'+this.className)||tempNode;var newHighlight=null;var contentParts=content.innerHTML.split(/\s*<\/?(?:li|p|ul)>\s*/);for(var i=0;i<contentParts.length;i++){var highlight=this.addHighlight(contentParts[i]);if(highlight&&!highlight.skipped)newHighlight=highlight;}
if(newHighlight){this.clearUserSelection();}
this.fireOnChange();tempNode.innerHTML='';};R.controls.Highlighter.prototype.removeHighlight=function(index){index=index.toString();if(this.highlights[index]){this.highlights[index].undo();delete this.highlights[index];}};R.controls.Highlighter.prototype.addHighlight=function(html){if(html&&html.replace(/\s/g,'')!==''){html=html.replace("class='highlight-control highlight-highlighted","class='");var highlight=new R.controls.Highlighter.Highlight(this.element,html.strip());this.highlights[highlight.index]=highlight;return highlight;}};R.controls.Highlighter.prototype.toJSON=function(){var elements=this.element.getElementsBySelector('.highlight-control');var results=[];for(var i=0;i<elements.length;i++){var element=$(elements[i]);if(!element.up('.highlight-control')){var hl=this.highlights[element.getAttribute('data-index')];if(hl){results.push({html:hl.html,start:hl.start,end:hl.end});}}}
return $A(results).toJSON();};R.controls.Highlighter.prototype.clearUserSelection=function(){if(window.getSelection){window.getSelection().removeAllRanges();}else if(document.selection){document.selection.empty();}};R.controls.Highlighter.Highlight=function(container,selectedHtml){this.skipped=false;this.container=container;this.html=selectedHtml;this.start=container.innerHTML.indexOf(selectedHtml);this.end=this.start+selectedHtml.length;this.index=(R.controls.Highlighter.currentIndex++).toString();var containerHtml=container.innerHTML;if(containerHtml.indexOf(selectedHtml)>=0){this.replaceUnlessInsideHighlight(container,selectedHtml,this.highlightHtml(selectedHtml));}else{var strippedHtml=selectedHtml.replace(/^\s*<\S+>/,'').replace(/<\/\S+>\s*$/,'');if(containerHtml.indexOf(strippedHtml)>=0){this.html=strippedHtml;this.replaceUnlessInsideHighlight(container,strippedHtml,this.highlightHtml(strippedHtml));}else{container.innerHTML+='  '+this.highlightHtml(selectedHtml,'highlight-obsolete');}}};R.controls.Highlighter.Highlight.prototype.replaceUnlessInsideHighlight=function(container,oldFragment,newFragment){var testNode=document.createElement('div');testNode.style.display='none';document.body.appendChild(testNode);var testId="highlight-test-"+this.index;var html=container.innerHTML;testNode.innerHTML=html.replace(oldFragment,"<span id=\""+testId+"\">"+oldFragment+"</span>");var insideHighlight=$(testId)&&$(testId).up(".highlight-highlighted");testNode.innerHTML='';testNode.parentNode.removeChild(testNode);if(!insideHighlight){container.innerHTML=html.replace(oldFragment,newFragment);}else{this.skipped=true;}};R.controls.Highlighter.Highlight.prototype.highlightHtml=function(html,additionalClassNames){var controlLink="&nbsp;<img src='/images/delete-button-2.png' style='vertical-align:top; cursor: pointer;' class='highlight-delete'/>";if(R.swatch.isSwatching('FRONTEND12')){controlLink="&nbsp;<img src='/images/assets/icons/ui/delete-tiny.svg' style='vertical-align:top; cursor: pointer;' class='highlight-delete'/>";}
var result="<span id='highlight-control-"+this.index+"' data-index='"+this.index+"' ";result+="class='highlight-control highlight-highlighted "+(additionalClassNames||'')+"' ";result+="style=''>"+html+controlLink+"</span>";return result;};R.controls.Highlighter.Highlight.prototype.select=function(){var hl=$("highlight-control-"+this.index);if(document.selection){var range=document.body.createTextRange();range.moveToElementText(hl);range.select();}else if(window.getSelection){var range=document.createRange();range.selectNode(hl);window.getSelection().addRange(range);}};R.controls.Highlighter.Highlight.prototype.undo=function(){var highlight=$("highlight-control-"+this.index);var me=this;highlight.replace(me.html);};R.controls.Highlighter.currentIndex=0;R.controls.RepositionableList=function(params){this.container_id=params.container_id;this.repositionableItemClass=params.repositionableItemClass;this.itemHandleClass=params.itemHandleClass;this.positionLinkClass=params.positionLinkClass;this.updateUrl=params.updateUrl;if(params.login){this.login=params.login;}};R.controls.RepositionableList.prototype.enableSorting=function(){var me=this;var positions=R$$("#"+this.container_id+" a."+this.positionLinkClass);for(var i=0;i<positions.length;i++){var position=positions[i];position.onclick=function(){me.editSortPosition(this);return false;};}
Event.observe(document,'click',function(e){if(this.currentlyEditingSort){var clickedItem=Event.element(e).up('.'+this.repositionableItemClass);var currentItem=this.currentlyEditingSort.up('.'+this.repositionableItemClass);if(clickedItem!=currentItem){this.stopEditSortPosition();}}});Sortable.create(this.container_id,{tag:'div',longPress:false,only:this.repositionableItemClass,scroll:window,constraint:null,overlap:'horizontal',handle:this.itemHandleClass});Draggables.addObserver({onStart:function(eventName,draggable){draggable.element.addClassName('dragging');},onEnd:function(eventName,draggable){draggable.element.removeClassName('dragging');me.afterItemMoved(draggable.element);}});};R.controls.RepositionableList.prototype.afterItemMoved=function(item){var nextItem=item.next('div.'+this.repositionableItemClass);var insertLast=false;if(!nextItem){nextItem=item.previous('div.'+this.repositionableItemClass);insertLast=true;}
if(nextItem){var pos=nextItem.down('.'+this.positionLinkClass);var newPosition=parseInt(pos.innerHTML.strip())||1;if(insertLast)newPosition+=1;if(newPosition>0){this.updateCustomSort(getId(item),newPosition);}}};R.controls.RepositionableList.prototype.stopEditSortPosition=function(){var me=this;if(this.currentlyEditingSort){$(this.currentlyEditingSort).update(this.currentlyEditingSort.getAttribute('original_position'));this.currentlyEditingSort.onclick=function(){me.editSortPosition(this);return false;};this.currentlyEditingSort=null;}};R.controls.RepositionableList.prototype.editSortPosition=function(positionLabel){var me=this;this.stopEditSortPosition();this.currentlyEditingSort=positionLabel;var position=parseInt(positionLabel.innerHTML.strip());if(position&&position>0){positionLabel.setAttribute('original_position',position);}
$(positionLabel).update("<form><input type='text' value='"+position+"' /></form>");positionLabel.onclick=function(){};positionLabel.down('form').onsubmit=function(){me.saveSortPosition(this);return false;};positionLabel.down('input').select();};R.controls.RepositionableList.prototype.saveSortPosition=function(form){var item=$(form).up('.'+this.repositionableItemClass);var positionLabel=$(form).up('.'+this.positionLinkClass);var position=parseInt(form.down('input').value);positionLabel.update(position+"");var me=this;positionLabel.onclick=function(){me.editSortPosition(this);return false;};this.currentlyEditingSort=null;var insertAt=null;var beforeAfter='before';var currentPositions=$$('#'+this.container_id+' a.'+this.positionLinkClass);for(var i=0;i<currentPositions.length;i++){var element=currentPositions[i];var elementPosition=parseInt(element.innerHTML);if(element==positionLabel){beforeAfter='after';}else if(elementPosition>=position){insertAt=element.up('.'+this.repositionableItemClass);break;}}
if(insertAt){this.animateMoveTo(item,insertAt,beforeAfter);}else{this.animateMoveTo(item);}
var insertionPoint=beforeAfter=='after'?position+1:position;this.updateCustomSort(getId(item),insertionPoint);};R.controls.RepositionableList.prototype.lastItem=function(){return $('bookend').previous('.'+this.repositionableItemClass);};R.controls.RepositionableList.prototype.animateMoveTo=function(fromItem,toItem,beforeAfter){var me=this;new Effect.Fade(fromItem,{to:0.8,afterFinish:function(){var moveTo=toItem;if(!moveTo){moveTo=me.lastItem();}
var currentOffset=Position.cumulativeOffset(fromItem);var newOffset=Position.cumulativeOffset(moveTo);fromItem.setStyle({position:'absolute',top:currentOffset[1]+'px',left:currentOffset[0]+'px',zIndex:100});emile(fromItem,'top: '+newOffset[1]+'px; left: '+newOffset[0]+'px;',{after:function(){new Effect.Appear(fromItem);var parent=fromItem.parentNode;parent.removeChild(fromItem);if(beforeAfter=='before'){parent.insertBefore(fromItem,toItem);}else if(beforeAfter=='after'){parent.insertBefore(fromItem,toItem.next('.'+me.repositionableItemClass));}else{parent.insertBefore(fromItem,$('bookend'));}
fromItem.setStyle({position:'',top:'',left:''});}});}});};R.controls.RepositionableList.prototype.updateCustomSort=function(itemId,insertAt){var order="";var items=R$$('#'+this.container_id+' .'+this.repositionableItemClass);for(var i=0;i<items.length;i++){if(order!='')order+='+';order+=getId(items[i]);}
var params=R.utils.currentParameterHash();params['sort_order']=order;if(itemId)params['item_id']=itemId;if(insertAt)params['insert_at']=insertAt;if(this.login)params['login']=this.login;if($$('.bundled_item_sort').length>0)params['bundle_id']=$$('.bundled_item_sort').first().id;var me=this;new Ajax.Request(this.updateUrl,{parameters:params,onComplete:function(xhr){var sort=xhr.responseText.evalJSON();if(sort){me.applyPositionLabels(sort['custom_order']);}}});};R.controls.RepositionableList.prototype.applyPositionLabels=function(order){for(var i=0;i<order.length;i++){var item=$(this.repositionableItemClass+'_'+order[i]);if(item){var container=item.down('a.'+this.positionLinkClass);if(container){container.innerHTML=i+1;}}}};R.controls.PasteableInput=function(input,options){if(window.FormData===undefined){return;}
if(!options)options={};this.input=input;this.connectEventHandlers();this.uploadPath=options.uploadPath;this.uploadParam=options.uploadParam;this.viewerId=options.viewerId;this.onFileReceived=options.onFileReceived;this.onUploadStart=options.onUploadStart;this.defaultFileExtension='png';this.contentTypes=options.contentTypes||{'image/jpeg':'jpg','image/png':'png','image/jpg':'jpg','image/gif':'gif'};};R.controls.PasteableInput.prototype.fileReceived=function(file){var valid=this.contentTypes[file.type];if(valid){if(this.onFileReceived){this.onFileReceived(file);}
if(this.uploadPath){this.upload(file);}}};R.controls.PasteableInput.prototype.upload=function(file){var progressId=R.upload.generateProgressId();var formData=new FormData();var extension=this.contentTypes[file.type]||this.defaultFileExtension;formData.append(this.uploadParam,file,"paste-"+Date.now()+"."+extension);formData.append('viewer_id',this.viewerId);formData.append('submit','paste');var xhr=new XMLHttpRequest();xhr.open('POST',this.uploadPath+"?X-Progress-ID="+progressId);xhr.onload=function(){if(xhr.status===200){R.upload.success(parseInt(xhr.responseText,10));}else{R.upload.error();}};if(this.onUploadStart){this.onUploadStart(file,progressId,function(){xhr.send(formData);});}else{xhr.send(formData);}};R.controls.PasteableInput.prototype.onDrop=function(dropEvent){if(dropEvent.dataTransfer){Event.stop(dropEvent);for(var i=0;i<dropEvent.dataTransfer.files.length;i++){var file=dropEvent.dataTransfer.files[i];this.fileReceived(file);}}};R.controls.PasteableInput.prototype.onPaste=function(pasteEvent){if(typeof pasteEvent.clipboardData=='object'){var files=pasteEvent.clipboardData.items||pasteEvent.clipboardData.files||[];var richText=false;for(var i=0;i<files.length;i++){if(files[i].type=='text/rtf'){richText=true;}}
for(var i=0;!richText&&i<files.length;i++){var file=files[i];if(file.getAsFile){file=file.getAsFile();}
if(file){this.fileReceived(file);}}}};R.controls.PasteableInput.prototype.connectEventHandlers=function(){var me=this;if(Browser.isGecko())this.input.ondragover=function(){return false;};$(this.input).observe('paste',function(e){me.onPaste(e);});$(this.input).observe('drop',function(e){me.onDrop(e);});$(this.input).observe('dragover',function(e){return false;});};R.controls.Selectables=function(elements,options){options=options||{};this.elements=elements;this.className=options.className||'selected';this.multiple=!(options.multiple===false);this.url=options.url;this.afterToggle=options.afterToggle;this.touchThreshold=300;this.eventsDisabled=false;this.afterModifierKeyToggle=options.afterModifierKeyToggle;this.afterCancelModifierKey=options.afterCancelModifierKey;this.stickyModifier=true;this.multiSelecting=false;this.clickTarget=options.clickTarget;if(options.form){this.form=$(options.form);} else{var form=document.createElement('FORM');form.style.display='none';document.body.appendChild(form);this.form=form;}
this.fieldName=options.fieldName||'selected_id_list';this.deselectedFieldName='not_'+this.fieldName;this.createSelectables();if(this.form){this.field=this.addFormField(this.fieldName);this.deselectedField=this.addFormField(this.deselectedFieldName);this.initializeStoredIds();}};R.controls.Selectables.prototype.disableEvents=function(){this.eventsDisabled=true;};R.controls.Selectables.prototype.enableEvents=function(){this.eventsDisabled=false;};R.controls.Selectables.prototype.createSelectables=function(){var me=this;$A(this.elements).each(function(element){new R.controls.Selectable(me,element);});};R.controls.Selectables.prototype.setMultiSelecting=function(state){this.multiSelecting=state;};R.controls.Selectables.prototype.addFormField=function(name){var field=this.form.down('.'+name)||$(name);if(!field){field=document.createElement('INPUT');field.type='hidden';field.name=name;field.className=name;this.form.appendChild(field);}
return field;};R.controls.Selectables.prototype.toggle=function(selectable,event){if(!selectable.lastToggle||selectable.lastToggle<((new Date()).getTime()+this.touchThreshold)){if(Browser.hasTouchEvents()){selectable.lastToggle=(new Date()).getTime();}
this.toggleElement(selectable.element,event);}};R.controls.Selectables.prototype.clearSelections=function(){var className=this.className;$A(this.elements).each(function(element){element.removeClassName(className);});if(this.field){this.field.value='';}};R.controls.Selectables.prototype.toggleElement=function(element,event){var modified=event&&(event.ctrlKey||event.metaKey);modified=modified||(this.stickyModifier&&this.multiSelecting);if(event&&this.clickTarget){var clicked=Event.element(event);if(!(clicked.match(this.clickTarget)||clicked.up(this.clickTarget))){return false;}}
Event.stop(event);if(!modified&&this.multiSelecting){this.clearSelections();if(this.multiSelecting&&this.afterCancelModifierKey){this.afterCancelModifierKey();}
this.multiSelecting=false;return false;}
var id=getId(element);var className=this.className;var toggleSelected=!element.hasClassName(this.className);var allowMultiple=this.multiple&&(!this.afterModifierKeyToggle||modified);$A(this.elements).each(function(element){if(getId(element)==id){if(toggleSelected||element.longPressed){element.longPressed=false;element.addClassName(className);}else{element.removeClassName(className);}}else if(!allowMultiple){element.removeClassName(className);}});var parameters={};parameters['bundle_id']=id;if(!allowMultiple&&this.field){this.field.value='';}
if(toggleSelected){this.addStoredId(this.field,id);this.removeStoredId(this.deselectedField,id);parameters['selected']=1;}else{this.addStoredId(this.deselectedField,id);this.removeStoredId(this.field,id);parameters['deselected']=1;}
if(this.url){new Ajax.Request(this.url,{method:'post',parameters:parameters});}
if(modified&&this.afterModifierKeyToggle){this.afterModifierKeyToggle(element);}else if(this.afterToggle){this.afterToggle(element);}
this.multiSelecting=modified;};R.controls.Selectables.prototype.selectedIds=function(){return this.parseStoredIds(this.field);};R.controls.Selectables.prototype.parseStoredIds=function(field){if(field.value===''){return[];}else{return $A(field.value.split(/\s+/)).map(function(id){return parseInt(id,10);});}};R.controls.Selectables.prototype.addStoredId=function(field,id){if(!field)return;var ids=this.parseStoredIds(field);ids.push(parseInt(id,10));field.value=ids.uniq().join(' ');};R.controls.Selectables.prototype.removeStoredId=function(field,id){if(!field)return;var ids=this.parseStoredIds(field);ids=ids.without(parseInt(id,10));field.value=ids.join(' ');};R.controls.Selectables.prototype.initializeStoredIds=function(){var me=this;var overrideSelected=this.parseStoredIds(this.field);var overrideNotSelected=this.parseStoredIds(this.deselectedField);$A(this.elements).each(function(element){var id=parseInt(getId(element),10);if(overrideSelected.indexOf(id)>=0){element.addClassName(me.className);}else if(overrideNotSelected.indexOf(id)>=0){element.removeClassName(me.className);}else if(element.hasClassName(me.className)){me.addStoredId(me.field,id);}else{me.addStoredId(me.deselectedField,id);}});};R.controls.Selectable=function(selectables,element){this.element=$(element);this.element.setAttribute('tabindex',0);this.element.setAttribute('role','button');this.selectables=selectables;this.addEventHandlers();};R.controls.Selectable.prototype.addEventHandlers=function(){var me=this;Event.observe(this.element,'click',function(event){if(me.selectables.eventsDisabled)return;me.selectables.toggle(me,event);});Event.observe(this.element,'keydown',function(event){if((e.key=='Enter'||e.key==' ')){if(me.selectables.eventsDisabled)return;me.selectables.toggle(me,event);}});Event.observe(this.element,'mouseenter',function(){me.element.addClassName('hover');});Event.observe(this.element,'mouseleave',function(){me.element.removeClassName('hover');});if(false&&Browser.hasTouchEvents()){this.hammer=new Hammer(this.element);this.hammer.get('tap').set({time:500});this.hammer.on("tap",function(hammerEvent){me.selectables.toggle(me,hammerEvent.srcEvent);});}};R.controls.SwipeMessage=function(message){this.message=message;this.addTouchEvents();if($('sent_tab').up().id=='current'){this.mailbox='sent';this.buttons=1;}else if($('saved_tab').up().id=='current'){this.mailbox='saved';this.buttons=3;}else{this.mailbox='inbox';this.buttons=3;}
this.shift=(75*this.buttons)+1;};R.controls.SwipeMessage.prototype.cancelSwipe=function(messageId){var innerStyle="left: 0px";var wrapper=$('row_wrapper_'+messageId);var inner=wrapper.down('.swipe_message__message_wrapper');var controlsStyle="right: -"+this.shift+"px;";var controls=wrapper.down('.swipe_message__controls_wrapper');emile(inner,innerStyle,{easing:function(k){return--k*k*k+1;}});emile(controls,controlsStyle,{easing:function(k){return--k*k*k+1;}});wrapper.parentNode.insertBefore(this.message,wrapper);wrapper.parentNode.removeChild(wrapper);};R.controls.SwipeMessage.prototype.addTouchEvents=function(){if(!window.Hammer){if(window.console){console.error("Hammer.js is not loaded. Skipping touch events in SwipeMessage.");}
return false;}
var message=this.message;var hammer=new Hammer(message);var me=this;hammer.on('swipe',function(ev){if(ev.direction==Hammer.DIRECTION_LEFT){var messageId=message.id.split("message_row_").last();var height=message.offsetHeight-1;var width=message.offsetWidth;var top=message.offsetTop;var controls_padding_top=Math.floor((Math.ceil(height)-23)/2);var controls_padding_bottom=Math.ceil((Math.ceil(height)-23)/2);var wrapper=document.createElement('div');wrapper.className="swipe_message__row_wrapper";wrapper.id="row_wrapper_"+messageId;wrapper.style.height=height+"px";var inner=document.createElement('div');inner.className="swipe_message__message_wrapper";inner.style.height=height+"px";inner.style.width=width+"px";inner.style.top=top+"px";var controls=document.createElement('div');controls.className="swipe_message__controls_wrapper";controls.style.height=height+"px";controls.style.width=me.shift+"px";controls.style.right="-"+me.shift+"px";controls.style.top=top+"px";if(me.mailbox=='saved'||me.mailbox=='inbox'){var reply_button=document.createElement('span');reply_button.className="swipe_message__control-reply";reply_button.onclick=function(){R.messages.replyToMessage(messageId);return false;};reply_button.style.paddingTop=controls_padding_top+"px";reply_button.style.paddingBottom=controls_padding_bottom+"px";reply_button.update("reply");controls.appendChild(reply_button);}
if(me.mailbox=='inbox'){var save_button=document.createElement('span');save_button.className="swipe_message__control-save";save_button.onclick=function(){R.messages.saveSingleMessage(messageId);return false;};save_button.style.paddingTop=controls_padding_top+"px";save_button.style.paddingBottom=controls_padding_bottom+"px";save_button.update("save");controls.appendChild(save_button);}
if(me.mailbox=='saved'){var inbox_button=document.createElement('span');inbox_button.className="swipe_message__control-save";inbox_button.onclick=function(){R.messages.unarchiveSingleMessage(messageId);return false;};inbox_button.style.paddingTop=controls_padding_top+"px";inbox_button.style.paddingBottom=controls_padding_bottom+"px";inbox_button.update("inbox");controls.appendChild(inbox_button);}
var delete_button=document.createElement('span');delete_button.className="swipe_message__control-delete";delete_button.onclick=function(){R.messages.deleteSingleMessage(messageId);return false;};delete_button.style.paddingTop=controls_padding_top+"px";delete_button.style.paddingBottom=controls_padding_bottom+"px";delete_button.update("delete");controls.appendChild(delete_button);wrapper.appendChild(inner);wrapper.appendChild(controls);message.parentNode.insertBefore(wrapper,message);inner.appendChild(message);var inner_style="left: -"+me.shift+"px;";var controls_style="right: 5px";emile(inner,inner_style,{easing:function(k){return--k*k*k+1;}});emile(controls,controls_style,{easing:function(k){return--k*k*k+1;}});Event.observe(inner,'click',function(){me.cancelSwipe(messageId);});}});};R.controls.TouchGallery=function(gallery,options){this.gallery=$(gallery);this.useTranslate=R.swatch&&R.swatch.isSwatching('FRONTEND12');options=options||{};this.debug=options.debug||false;this.variableHeight=options.variableHeight||false;this.trigger=options.trigger;this.beforeSlide=options.beforeSlide;this.afterSlide=options.afterSlide;this.controls=options.controls||[];this.clickForFullscreen=options.clickForFullscreen;this.useDots=options.useDots||false;this.navigationClassName='touch_gallery__navigation';this.dotClassName='touch_gallery__navigation__dot';this.activeDotClassName='touch_gallery__navigation__dot--active';this.dots=$A([]);this.pagination=null;this.paginationLabel=null;this.paginationClassName='touch_gallery__pagination';this.paginationNextClassName='touch_gallery__pagination__next';this.paginationPreviousClassName='touch_gallery__pagination__previous';this.paginationLabelClassName='touch_gallery__pagination__label';this.itemClassName=options.itemClassName||'touch_gallery__item';this.itemTagName='div';this.selector='.'+this.itemClassName;this.loadItemUrl=options.loadItemUrl;this.itemCount=options.itemCount||this.gallery.getElementsBySelector(this.selector).size();this.images=[];if(options.images&&typeof options.images!='function'){this.itemCount=options.images.length;this.images=options.images;}
if(!(R.swatch&&R.swatch.isSwatching('FRONTEND12'))){this.setStyle();}
if(R.swatch&&R.swatch.isSwatching('FRONTEND12')){var me=this;window.requestAnimationFrame(function(){me.setStyle();});this.addPagination();}
this.addEvents();this.addTouchEvents();this.currentIndex=0;};R.controls.TouchGallery.prototype.setStyle=function(){var me=this;this.gallery.style.left='0px';if(this.images){this.gallery.style.position='relative';this.gallery.style.width=(100*this.itemCount)+'vw';}
var existingElements=this.gallery.getElementsBySelector(this.selector);existingElements.each(function(photo){var img=photo.down('img');if(img)img.setStyle({right:0,left:0});});var navigation=null;if(this.useDots&&this.itemCount>1){if(!navigation){navigation=document.createElement('ul');navigation.className=this.navigationClassName+' rsp_only';}
var parent=this.gallery.up('.touch_gallery');if(parent){parent=parent.parentNode;}else{parent=this.gallery.parentNode;}
this.gallery.parentNode.style.position='relative';this.gallery.parentNode.appendChild(navigation);}
for(var i=0;i<this.itemCount;i++){if(!existingElements[i]){var placeholder=document.createElement('div');placeholder.className=this.itemClassName+' rsp_only';var imageAttributes=this.images[i];if(imageAttributes){var img=document.createElement('img');img.setAttribute('data-touch-gallery-src',imageAttributes.src);placeholder.id=this.itemClassName+'_'+imageAttributes.id;placeholder.appendChild(img);}
this.gallery.appendChild(placeholder);if(this.clickForFullscreen){$(placeholder).observe('click',function(e){R.photos.responsiveFullscreen(this);});}}
if(navigation){var dot=document.createElement('li');dot.className=this.dotClassName;if(i==0){dot.className+=' '+this.activeDotClassName;}
navigation.appendChild(dot);this.dots.push(dot);}}};R.controls.TouchGallery.prototype.addPagination=function(){var me=this;var pagination=document.createElement('DIV');pagination.className=this.paginationClassName;var previous=document.createElement('A');previous.className=this.paginationPreviousClassName;previous.href='#';pagination.appendChild(previous);$(previous).observe('click',function(e){me.moveRight();Event.stop(e);});var label=document.createElement('DIV');label.className=this.paginationLabelClassName;var labelText=this.itemCount+' photo';if(this.itemCount>1)labelText+='s';label.innerHTML=labelText;pagination.appendChild(label);var next=document.createElement('A');next.href='#';next.className=this.paginationNextClassName;pagination.appendChild(next);$(next).observe('click',function(e){me.moveLeft();Event.stop(e);});if(R.swatch&&R.swatch.isSwatching('FRONTEND12')&&this.gallery.nextSibling){this.gallery.parentNode.insertBefore(pagination,this.gallery.nextSibling);}else{this.gallery.parentNode.appendChild(pagination);}
this.pagination=pagination;this.paginationLabel=label;this.updatePagination(0);};R.controls.TouchGallery.prototype.updatePagination=function(index){if(R.swatch&&R.swatch.isSwatching('FRONTEND12')){Element.useClassName(this.pagination,this.paginationClassName+'--first_photo',index==0);Element.useClassName(this.pagination,this.paginationClassName+'--last_photo',index==(this.itemCount-1));if(index==0){this.paginationLabel.innerHTML=this.itemCount+(this.itemCount==1?' photo':' photos');}else{this.paginationLabel.innerHTML=(index+1)+'/'+this.itemCount+(this.itemCount==1?' photo':' photos');}}};R.controls.TouchGallery.prototype.moveDot=function(index){for(var i=0;i<this.dots.length;i++){var dot=this.dots[i];if(i==index){dot.addClassName(this.activeDotClassName);}else{dot.removeClassName(this.activeDotClassName);}}};R.controls.TouchGallery.prototype.addEvents=function(){var me=this;if(this.trigger){this.trigger.style.cursor='pointer';Event.observe(this.trigger,'click',function(){me.move();});}
$A(this.dots).each(function(dot,index){dot.observe('click',function(e){me.moveTo(index);Event.stop(e);});});$A(this.controls).each(function(control,index){control.observe('click',function(e){if(Browser.responsiveBreakpoint()){me.moveTo(index);Event.stop(e);}});});};R.controls.TouchGallery.prototype.addTouchEvents=function(){if(!window.Hammer){if(window.console){console.error("Hammer.js is not loaded. Skipping touch events in TouchGallery.");}
return false;}
var gallery=this.gallery;var hammer=new Hammer(gallery);var me=this;hammer.on('swipe',function(ev){if(me.debug)console.log("Swipe direction: "+ev.direction);if(ev.direction==Hammer.DIRECTION_LEFT){me.moveLeft();}else{me.moveRight();}});};R.controls.TouchGallery.prototype.photos=function(){return this.gallery.getElementsBySelector(this.selector);};R.controls.TouchGallery.prototype.move=function(){var index=Math.min(this.currentIndex+1,this.photos().length-1);if(index>this.currentIndex){this.moveTo(index);}else{this.moveTo(0);}};R.controls.TouchGallery.prototype.moveLeft=function(){var index=Math.min(this.currentIndex+1,this.photos().length-1);this.moveTo(index);};R.controls.TouchGallery.prototype.moveRight=function(){var index=Math.max(this.currentIndex-1,0);this.moveTo(index);};R.controls.TouchGallery.prototype.loadItemsFromUrl=function(index){if(!this.loadItemState){this.loadItemState='loading';var me=this;new Ajax.Request(this.loadItemUrl,{method:'GET',onComplete:function(xhr){me.loadItemState='complete';var fragment=document.createDocumentFragment();var responseElements=document.createElement('div');fragment.appendChild(responseElements);responseElements.innerHTML=xhr.responseText;responseElements.removeChild(responseElements.childNodes[0]);me.gallery.innerHTML+=responseElements.innerHTML;me.gallery.innerHTML=xhr.responseText;if(me.pendingMoveTo())me.pendingMoveTo();me.gallery.getElementsBySelector('*[data-lazy-load-image]').each(function(element){var image=new Image();image.onload=function(){if(element.style.backgroundImage){element.style.backgroundImage='url('+image.src+')';}else if(element.tagName=='IMG'){element.src=image.src;}
element.style.filter='';};image.src=element.getAttribute('data-lazy-load-image');});}});}};R.controls.TouchGallery.prototype.moveTo=function(index){if(this.variableHeight){var photo=this.photos()[this.currentIndex];var currentHeight=Element.getHeight(photo);this.gallery.setStyle({height:currentHeight+'px'});}
if(this.loadItemUrl&&this.loadItemState!='complete'){if(!this.pendingMoveTo){var me=this;this.pendingMoveTo=function(){me.moveTo(index);};}
this.loadItemsFromUrl();return;}
if(this.variableHeight){if(this.debug)console.log("Moving gallery with variableHeight: "+this.variableHeight);var me=this;this.gallery.getElementsBySelector(this.selector).each(function(photo,index){var img=photo.down('img');photo.style.display='inline-block';img.style.display='inline-block';var sourceToLoad=img.getAttribute('data-src')||img.getAttribute('data-touch-gallery-src');var blurUp=img.getAttribute('data-touch-gallery-blur');if(R.swatch&&R.swatch.isSwatching('FRONTEND12')&&img.width&&img.height&&img.src&&(img.src.indexOf('data:')<0)){img.setAttribute('data-touch-gallery-loaded',true);}
if(blurUp&&R.swatch&&R.swatch.isSwatching('FRONTEND12')&&index>0){img.onload=function(){img.setAttribute('data-touch-gallery-loaded',true);img.setAttribute('src',sourceToLoad);};img.src=blurUp;}else if(sourceToLoad){img.onload=function(){img.setAttribute('data-touch-gallery-loaded',true);};if(me.debug)console.log("Loading image "+img.src);img.src=sourceToLoad;}else{if(img.getAttribute('data-touch-gallery-lazy-src')){img.src=img.getAttribute('data-touch-gallery-lazy-src');}
img.setAttribute('data-touch-gallery-loaded',true);}});this.onImagesLoaded(index,function(){me.slideTo(index);});}else{this.slideTo(index);}};R.controls.TouchGallery.prototype.onImagesLoaded=function(waitForIndex,callback){var poll=10;var stillWaiting=0;this.gallery.getElementsBySelector(this.selector).each(function(photo,index){var img=photo.down('img');if(waitForIndex<=index&&!img.getAttribute('data-touch-gallery-loaded')){stillWaiting+=1;}});if(stillWaiting>0){if(this.debug)console.log("Still waiting for "+stillWaiting+" images to load, index = "+waitForIndex);var me=this;setTimeout(function(){me.onImagesLoaded(waitForIndex,callback);},poll);}else{callback();}};R.controls.TouchGallery.prototype.slideTo=function(index){this.currentIndex=index;var newLeft=0;var me=this;var slideToPhoto=null;this.photos().each(function(photo,index){if(index<me.currentIndex){var width=Element.getWidth(photo);newLeft=newLeft-width;if(R.swatch&&R.swatch.isSwatching('FRONTEND12')){}}else if(index==me.currentIndex){slideToPhoto=photo;}});if(this.beforeSlide){this.beforeSlide(slideToPhoto);}
var style="left: "+(newLeft+"px;");var newStyle={};if(this.useTranslate){newStyle.transform="translateX("+newLeft+"px)";}
if(this.variableHeight&&slideToPhoto){var img=slideToPhoto.down('img');this.gallery.style.backgroundColor='#ccc';var galleryHeight=Element.getHeight(img);style+="height:"+galleryHeight+"px;";newStyle.height=galleryHeight+"px";}
this.updatePagination(index);this.moveDot(index);if(!this.useTranslate){emile(this.gallery,style,{easing:function(k){return--k*k*k+1;}});}
if(this.afterSlide){this.afterSlide(slideToPhoto);}
if(this.useTranslate){this.gallery.style.transition='transform .2s ease, height .2s ease';this.gallery.style.transform=newStyle.transform;if(newStyle.height){this.gallery.style.height=newStyle.height;}}};R.controls.richNotes=function(){var editingNotesInline=false;var actionSheet=null;return{editNotesEntry:function(entryNode){if(editingNotesInline){return false;}
editingNotesInline=true;$('append_notes_clicker').style.visibility='hidden';entryNode.addClassName('markdown__dated_entry--editing');entryNode.removeClassName('markdown__dated_entry--hover');var entries=$$('.scope--editable .markdown__dated_entry');var params={};params['heading_id']=entryNode.down('.markdown__dated_entry__heading').id;params['entry_index']=entries.indexOf(entryNode);R.controls.richNotes.buildActionSheet();var url=prependPath('edit_notes_entry');new Ajax.Request(url,{method:'POST',parameters:params});},inlineNotesEditor:function(entryIndex,content){if(Browser.responsiveBreakpoint()&&actionSheet){actionSheet.innerHTML=content;}else{var entry=$$('.scope--editable .markdown__dated_entry')[entryIndex];entry.innerHTML=content;}},buildActionSheet:function(){if(R.swatch&&R.swatch.isSwatching('FRONTEND12')&&Browser.responsiveBreakpoint()){if(!actionSheet){actionSheet=R.controls.buildActionSheet('action_sheet--notes_editor','fullscreen');}
actionSheet.appendChild($('append_notes_container'));}
return actionSheet;},addNotesEntry:function(){if(editingNotesInline){return false;}
editingNotesInline=true;$('append_notes_clicker').style.visibility='hidden';R.controls.richNotes.buildActionSheet();var url=prependPath('append_notes_entry');new Ajax.Request(url,{method:'GET'});},cancelNotesEntry:function(){new Ajax.Request(prependPath('cancel_notes_entry'));},toggleEntryTitleMenu:function(link){$(link).up('form').down('.menu_content').toggle();},selectHeadingStyle:function(format,label,link){var form=$(link).up('form');var titleField=form.down('.markdown__inline_title');var styleField=form.down('.heading_style');R.controls.richNotes.toggleEntryTitleMenu(link);styleField.value=format;if(format=='empty'){titleField.value='';titleField.focus();}else{titleField.value=label;$('notes_entry_editor').focus();}},initializeNotesEditor:function(){if(Browser.responsiveBreakpoint()){if(actionSheet&&R.swatch&&R.swatch.isSwatching('FRONTEND12')){R.controls.actionSheet(actionSheet);}
if(!(R.swatch&&R.swatch.isSwatching('FRONTEND12'))){$('append_notes_container').scrollTo();}}else if($('heading_field').value===''){R.utils.focusTextField($('heading_field'),true);}else{R.utils.focusTextField($('notes_entry_editor'),true);}},makeNotesSectionsEditable:function(){editingNotesInline=false;if(actionSheet){R.controls.hideActionSheet(actionSheet);$$('.markdown__dated_entry').last().scrollTo();}
if($('append_notes_clicker')){$('append_notes_clicker').style.visibility='';}
$$('.scope--editable .markdown__dated_entry').each(function(entry){entry.observe('mouseover',function(){if(!editingNotesInline){entry.addClassName('markdown__dated_entry--hover');}});entry.observe('mouseout',function(){entry.removeClassName('markdown__dated_entry--hover');});entry.observe('click',function(e){if(!editingNotesInline&&Event.findElement(e,'A')==document){R.controls.richNotes.editNotesEntry(entry);}});});}};}();R.controls.SoundButton={};R.controls.SoundButton.initialize=function(){if($$('input[data-soundbutton]').first()==null){console.log("No soundbutton found");return;}
var record=null;var play=null;var formInput=null;var label=null;$$('[data-soundbutton]').each(function(element){var buttonType=element.getAttribute('data-soundbutton');if(buttonType=='record'){record=new R.controls.SoundButton.Record(element);}else if(buttonType=='play'){play=new R.controls.SoundButton.Play(element);}else if(buttonType=='input'){formInput=element;}else if(buttonType=='label'){label=element;}});if(record){if(formInput)formInput.id='soundbutton_data_id';record.setFormInput(formInput);record.setLabel(label);}
if(record&&play){new R.controls.SoundButton.ButtonSet(record,play);}};R.controls.SoundButton.ButtonSet=function(record,play){record.onStart(function(){play.hide();});record.onStop(function(){play.show();});play.onPlay(function(){if(!record.playCurrentRecording()){play.playExistingRecording();}});};R.controls.SoundButton.Record=function(clicker){this.timeLimit=15000;this.clicker=$(clicker);this.microm=new Microm();this.stopped=true;this.recordingStarted=0;this.recordTimer=null;this.mp3=null;this.recordImage='/images/farmfresh-control-record-crop.png';this.stopImage='/images/farmfresh-control_stop.png';this.onStartCallback=null;this.onStopCallback=null;this.formInput=null;this.label=null;var me=this;this.clicker.onclick=function(){me.toggle();};};R.controls.SoundButton.Record.prototype.setLabel=function(label){this.label=label;};R.controls.SoundButton.Record.prototype.setFormInput=function(formInput){this.formInput=formInput;};R.controls.SoundButton.Record.prototype.startRecordTimer=function(){this.stopRecordTimer();this.recordingStarted=(new Date()).getTime();this.recordTimer=setInterval(function(){this.label.innerHTML+='.';console.log("checking record time...");var now=(new Date()).getTime();if(now>(this.recordingStarted+this.timeLimit)){console.log("Time limit reached. Stopping...");this.stopRecordTimer();this.stop();}}.bind(this),250);};R.controls.SoundButton.Record.prototype.stopRecordTimer=function(){if(this.recordTimer){clearInterval(this.recordTimer);}};R.controls.SoundButton.Record.prototype.toggle=function(){if(!Browser.isChrome()){alert("Sorry! Sound recording is not available in this browser. Google Chrome is the only supported browser at the moment.");}
if(this.stopped){this.record();}else{this.stop();}};R.controls.SoundButton.Record.prototype.onStart=function(callback){this.onStartCallback=callback;};R.controls.SoundButton.Record.prototype.onStop=function(callback){this.onStopCallback=callback;};R.controls.SoundButton.Record.prototype.setStopped=function(stopped){this.stopped=stopped;if(this.stopped){this.stopRecordTimer();this.label.innerHTML=this.label.originalHTML;this.clicker.down('span').innerHTML='record';this.clicker.down('img').src=this.recordImage;if(this.onStopCallback)this.onStopCallback();}else{if(!this.label.originalHTML){this.label.originalHTML=this.label.innerHTML;}
this.label.innerHTML="recording";this.startRecordTimer();this.clicker.down('span').innerHTML='stop recording';this.clicker.down('img').src=this.stopImage;if(this.onStartCallback)this.onStartCallback();}};R.controls.SoundButton.Record.prototype.record=function(){var me=this;this.microm.record().then(function(){console.log('recording...');me.setStopped(false);});};R.controls.SoundButton.Record.prototype.stop=function(){var me=this;this.microm.stop().then(function(result){me.setStopped(true);me.mp3=result;me.playCurrentRecording();if(me.formInput){me.microm.getBase64().then(function(base64string){me.formInput.value=base64string;});}});};R.controls.SoundButton.Record.prototype.playCurrentRecording=function(){if(this.mp3){console.log(this.mp3.url,this.mp3.blob,this.mp3.buffer);this.microm.play();return true;}else{return false;}};R.controls.SoundButton.Play=function(clickTarget){this.clickTarget=$(clickTarget);this.onPlayCallback=null;this.playImage='/images/farmfresh-sound.png';this.previousRecording=clickTarget.getAttribute('data-sound');this.loudLink=null;var me=this;this.clickTarget.style.cursor='pointer';this.clickTarget.onclick=function(){if(me.onPlayCallback){var active=me.clickTarget.hasClassName('filled_image_field');if(active){me.onPlayCallback();}}};if(this.previousRecording){this.initializeLoudLink();this.show();}else{this.hide();}};R.controls.SoundButton.Play.prototype.initializeLoudLink=function(){this.loudLink=document.createElement('a');this.loudLink.style.display='none';this.loudLink.className='loud-link-click';this.loudLink.setAttribute('data-sound',this.previousRecording);document.body.appendChild(this.loudLink);};R.controls.SoundButton.Play.prototype.playExistingRecording=function(){this.loudLink.click();};R.controls.SoundButton.Play.prototype.hide=function(){this.clickTarget.hide();};R.controls.SoundButton.Play.prototype.show=function(){var img=this.clickTarget.down('img');if(!img){img=document.createElement('img');img.src=this.playImage;img.id='soundbutton_data_img';this.clickTarget.appendChild(img);R.controls.initializeImageFields();}else{img.style.display='block';img.src=this.playImage;this.clickTarget.addClassName('filled_image_field');}
this.img=img;this.clickTarget.show();};R.controls.SoundButton.Play.prototype.onPlay=function(callback){this.onPlayCallback=callback;};R.controls.OptionPicker=function(container,input){this.container=$(container);this.select=$(input);this.pickList=null;this.clickerIcon=this.container.getAttribute('data-option-picker-clicker')=='1';this.useSvgIcon=R.swatch.isSwatching('FRONTEND12');this.icon=this.createIcon();var me=this;Event.observe(this.select,'change',function(e){me.onOptionSelected(e);});Event.observe(this.select,'mousedown',function(e){Event.stop(e);});Event.observe(this.container,'click',function(e){me.onClick(e);});Event.observe(document.body,'click',function(e){me.cancel(e);});this.updateIcon();};R.controls.OptionPicker.initialize=function(){R$$('.control_option_picker').each(function(control){if(!control.__responsive_select){var select=$(control).down('select');control.__responsive_select=new R.controls.OptionPicker(control,select);}});};R.controls.OptionPicker.prototype.createIcon=function(){var icon=this.container.down('img.control_option_picker__icon');if(!icon){icon=$(document.createElement('img'));icon.className='control_option_picker__icon option_picker__icon';icon.style.display='none';icon.setAttribute('alt','');if(this.clickerIcon){var a=$(document.createElement('a'));a.className='clicker touch_clicker';a.appendChild(icon);this.container.insertBefore(a,this.select);var me=this;a.observe('click',function(e){me.onClick();Event.stop(e);return false;});}else{this.container.insertBefore(icon,this.select);}}
return icon;};R.controls.OptionPicker.prototype.lazyCreatePickList=function(){if(!this.pickList){this.pickList=this.createPickList();}else{this.positionPickList(this.pickList);}};R.controls.OptionPicker.prototype.getSrcSetFromOption=function(option){if(!this.useSvgIcon&&option.getAttribute('data-icon-2x')){return option.getAttribute('data-icon')+" 1x, "+option.getAttribute('data-icon-2x')+" 2x";}else{return null;}};R.controls.OptionPicker.prototype.positionPickList=function(pickList){var selectPos=Position.cumulativeOffset(this.select);var containerPos=Position.cumulativeOffset(this.container);var containerHeight=Element.getHeight(this.container);var containerWidth=Element.getWidth(this.container);if(!R.navigation.compressedNavigationEnabled()){pickList.style.width=(containerWidth-2)+'px';pickList.style.left=containerPos[0]+'px';pickList.style.top=(selectPos[1]-2)+'px';}else{pickList.style.top=(containerPos[1]+containerHeight-1)+'px';}};R.controls.OptionPicker.prototype.createPickList=function(){var me=this;var pickList=$(document.createElement('ul'));if(this.select.name)pickList.id="pick_list_for_"+this.select.name;pickList.className='control_option_picker__pick_list';pickList.style.display='none';pickList.style.position='absolute';this.positionPickList(pickList);document.body.appendChild(pickList);if(this.container.getAttribute('title')){var title=document.createElement('li');title.className='control_option_picker__pick_list_title';title.innerHTML=this.container.getAttribute('title');pickList.appendChild(title);}
for(var i=0;i<this.select.options.length;i++){var option=this.select.options[i];var optionValue=option.value;var srcsetAttribute='';var srcset=this.getSrcSetFromOption(option);if(srcset){srcsetAttribute="srcset='"+srcset+"'";}
var img="<img alt='' src='"+option.getAttribute('data-icon')+"' "+srcsetAttribute+"/>";if(this.useSvgIcon&&option.getAttribute('data-icon-svg')){img="<img alt='' src='"+option.getAttribute('data-icon-svg')+"'/>";}
var icon="<span class=\"control_option_picker__pick_list_link__icon\">"+img+"</span>";var thumbnail="";if(this.useSvgIcon&&option.getAttribute('data-thumbnail-svg')){pickList.addClassName('control_option_picker__pick_list--with_thumbnails');var thumbnailImg="<img alt='' src='"+option.getAttribute('data-thumbnail-svg')+"'/>";thumbnail="<span class=\"control_option_picker__pick_list_link__thumbnail\">"+thumbnailImg+"</span>";}
var tooltip=option.getAttribute('data-tooltip');var item=document.createElement('li');item.className='control_option_picker__pick_list_item';item.className+=' control_option_picker__pick_list_item--'+optionValue;if(i===0){item.className+=' control_option_picker__pick_list_item--default';}
item.setAttribute('data-option-index',i);var text=option.text;var description=option.getAttribute('data-description');if(description){var titleHtml='<div class="control_option_picker__pick_list_link__title">'+text+'</div>';var descriptionHtml='<div class="control_option_picker__pick_list_link__description">'+description+'</div>';text='<div class="control_option_picker__pick_list_link__text">'+titleHtml+descriptionHtml+'</div>';}
var a=document.createElement('a');a.href='#';a.className='control_option_picker__pick_list_link';a.innerHTML=thumbnail+icon+" "+text;a.setAttribute('data-option-index',i);a.setAttribute('data-option-value',optionValue);item.appendChild(a);Event.observe(a,'click',function(e){me.onPickList(e,this);});if(tooltip){var tip=document.createElement('p');tip.className='control_option_picker__tooltip';tip.innerHTML=tooltip;item.appendChild(tip);}
if(optionValue.match(/_mobile$/)){item.className+=' rsp_only';}
pickList.appendChild(item);}
if(R.swatch&&R.swatch.isSwatching('FRONTEND12')&&Browser.responsiveBreakpoint()){var id='pick_list_action_sheet';if(this.select.name)id="pick_list_"+this.select.name+'_action_sheet';var actionSheet=$(id)||R.controls.buildActionSheet(id,'picklist');actionSheet.appendChild(pickList);}
return pickList;};R.controls.OptionPicker.prototype.cancel=function(evt){var eventHappenedToMe=evt.target==this.container||Event.findElement(evt,'div')==this.container;if(!eventHappenedToMe){this.hidePickList();}};R.controls.OptionPicker.prototype.hidePickList=function(){if(this.pickList&&this.pickList.visible()){var actionSheet=this.pickList.up('.action_sheet');if(actionSheet){R.controls.hideActionSheet(actionSheet);}
this.pickList.hide();this.container.removeClassName('control_option_picker--expanded');}};R.controls.OptionPicker.prototype.showPickList=function(){this.lazyCreatePickList();if(window.hj&&this.container.up('body.search_patterns')){hj('trigger','search_patterns_sort');}
var selectedClass='control_option_picker__pick_list_item--selected';var selectedIndex=this.select.selectedIndex;this.pickList.getElementsBySelector('li').each(function(li){if(li.getAttribute('data-option-index')==selectedIndex){li.addClassName(selectedClass);}else{li.removeClassName(selectedClass);}});this.pickList.show();this.container.addClassName('control_option_picker--expanded');var actionSheet=this.pickList.up('.action_sheet');if(actionSheet){R.controls.actionSheet(actionSheet);}};R.controls.OptionPicker.prototype.onPickList=function(evt,picked){Event.stop(evt);this.hidePickList();var index=parseInt(picked.getAttribute('data-option-index'));this.select.selectedIndex=index;this.onOptionSelected();var form=this.select.up('form');if(R.swatch.isSwatching('FRONTEND12')&&this.container.getAttribute('data-href-base')){var href=this.container.getAttribute('data-href-base').parseQuery();href[this.select.name]=R.utils.selectedValue(this.select);document.location.href='?'+$H(href).toQueryString();}else if(this.select.onchange){this.select.onchange();}else if(form.onsubmit){form.onsubmit();}else if(form.hasClassName('autosubmit')||form.getAttribute('data-autosubmit')=='1'){form.submit();}};R.controls.OptionPicker.prototype.onClick=function(evt){if(this.pickList&&this.pickList.visible()){this.hidePickList();}else{this.showPickList();}};R.controls.OptionPicker.prototype.onOptionSelected=function(){this.updateIcon();this.select.blur();};R.controls.OptionPicker.prototype.updateIcon=function(){var option=this.select.options[this.select.selectedIndex];var iconSrc=option&&option.getAttribute('data-icon');if(this.useSvgIcon&&option&&option.getAttribute('data-icon-svg')){iconSrc=option.getAttribute('data-icon-svg');}
if(iconSrc){this.icon.src=iconSrc;this.icon.style.display='inline';var srcSet=this.getSrcSetFromOption(option);if(srcSet){this.icon.srcset=srcSet;}else{this.icon.srcset='';}}else{this.icon.style.display='none';}};R.controls.OptionPicker.prototype.afterSelect=function(newValue){};R.controls.markdownSuggesterEnabled=true;R.controls.markdownSuggesterBracketActivation=true;R.controls.markdownSuggesterAlternateActivation=true;R.controls.markdownSuggesterEmojiActivation=true;R.controls.applyMarkdownSuggesters=function(){setTimeout(function(){if(R.controls.markdownSuggesterEnabled){$$('textarea').each(function(textarea){if(!textarea.__markdown_suggester){new R.controls.MarkdownSuggester(textarea);}});}},100);};R.controls.MarkdownSuggester=function(textarea,options){textarea.__markdown_suggester=true;options=options||{};this.debug=false;this.onBlurTimer=null;this.suggestionsOpenedAt=null;this.cachedCaretInfo=null;this.textarea=$(textarea);this.hiddenField=null;this.hiddenFieldName='markdown_suggester_activated';this.enableBracketActivation=R.controls.markdownSuggesterBracketActivation;this.enableAlternateActivation=R.controls.markdownSuggesterAlternateActivation;this.enableEmojiActivation=R.controls.markdownSuggesterEmojiActivation;this.activateChar='[';this.activateKeyCode=219;this.shifted=false;this.altActivateChar='@';this.altActivateKeyCode=50;this.whitespaceRegex=/\s/;this.emojiActivateChar=':';this.emojiActivateKeyCode=59;this.deactivateChar=']';this.deactivateKeyCode=221;this.defaultRefreshTimeout=100;this.minQueryLength=2;this.boxClass='markdown_suggestion_container';this.boxContentClass='markdown_suggestion_box';this.createElements();this.addEventListeners();this.afterPositionSuggestionBox=function(suggestionBox){var page=$('page');var boxSpace=650;var heightNeeded=Position.cumulativeOffset(suggestionBox)[1]+boxSpace-parseInt(page.clientHeight,10);if(heightNeeded>0){var currentPadding=parseInt(Element.getStyle(page,'padding-bottom'),10);$('page').style.paddingBottom=(heightNeeded-currentPadding)+'px';}};};R.controls.MarkdownSuggester.prototype.createElements=function(){var form=this.textarea.up('form');if(form){this.hiddenField=form.up('.'+this.hiddenFieldName);if(!this.hiddenField){var field=document.createElement('input');field.type='hidden';field.name=this.hiddenFieldName;field.className=this.hiddenFieldName;form.appendChild(field);this.hiddenField=$(field);}}
var suggestionBox=document.createElement('div');suggestionBox.className=this.boxClass;suggestionBox.style.display='none';suggestionBox.style.position="absolute";var measure=document.createElement("div");measure.style.position='absolute';if(this.debug){measure.style.border="2px solid red";measure.style.left='500px';measure.style.top='500px';}else{measure.style.left='-10000px';}
measure.style.fontSize=this.textarea.getStyle('font-size');measure.style.lineHeight=this.textarea.getStyle('line-height');measure.style.wordWrap='break-word';this.textarea.parentNode.appendChild(suggestionBox);this.suggestionBox=$(suggestionBox);this.textarea.parentNode.appendChild(measure);this.measuringElement=$(measure);};R.controls.MarkdownSuggester.prototype.measureSuggestionBlockOffset=function(){var measure=this.measuringElement;measure.style.width=this.textarea.clientWidth+'px';var textUpToBlock=this.textarea.value.substring(0,this.suggestionsOpenedAt+1);var measureText=textUpToBlock.replace(/\n/g,"\n<br>").replace(/ /g,"&nbsp;");measureText=measureText+"<span class='measure-eol'></span>"+this.getSuggestionBlockContents()+"<span class='measure-eol-2'></span>&nbsp;";measure.innerHTML=measureText;var position=Position.positionedOffset(measure.down('.measure-eol'));var position2=Position.positionedOffset(measure.down('.measure-eol-2'));var height=0;var width=0;var wrapThreshold=5;if((position2[1]-position2[1])>wrapThreshold){if(this.debug)console.log("measureSuggestionBlockOffset: suggestion block has wrapped from y="+position[1]+" to y="+position2[1]);height=position2[1]-this.textarea.scrollTop;}else{height=position[1]-this.textarea.scrollTop;width=position[0];}
return[width,height];};R.controls.MarkdownSuggester.prototype.getCaretInfo=function(){var caretInfo=this.cachedCaretInfo||R.utils.getCaretInfo(this.textarea);this.cachedCaretInfo=caretInfo;return caretInfo;};R.controls.MarkdownSuggester.prototype.enterSuggestionBlock=function(openedAt,refreshImmediately){if(!openedAt&&openedAt!==0)openedAt=this.getCaretInfo().caret;if(this.debug)console.log("Entering suggestion block at "+openedAt+", caret at "+this.getCaretInfo().caret);var text=this.textarea.value;var previousCharacter=text[openedAt-1];if(this.enableAlternateActivation&&text[openedAt]==this.altActivateChar){if(previousCharacter&&!(this.whitespaceRegex.test(previousCharacter))){return false;}}
if(this.enableEmojiActivation&&text[openedAt]==this.emojiActivateChar){if(previousCharacter&&!(this.whitespaceRegex.test(previousCharacter))){return false;}}
if(previousCharacter&&/[*!+]/.test(previousCharacter)){return false;}
if(this.suggestionsActive&&(openedAt==this.suggestionsOpenedAt)){this.suggestionBlockUpdated(refreshImmediately);}else{this.suggestionsActive=true;this.suggestionsOpenedAt=openedAt;this.setSuggestionBoxLocation();}};R.controls.MarkdownSuggester.prototype.setSuggestionBoxLocation=function(){if(this.onBlurTimer){clearTimeout(this.onBlurTimer);}
if(!this.textareaOffset){this.textareaOffset=Position.positionedOffset(this.textarea);}
var measurements=this.measureSuggestionBlockOffset();if(measurements!=this.lastMeasurements){this.lastMeasurements=measurements;this.suggestionBox.style.left=(this.textareaOffset[0]+measurements[0])+'px';var top=this.textareaOffset[1]+measurements[1];this.suggestionBox.style.top=top+'px';}
if(this.afterPositionSuggestionBox)this.afterPositionSuggestionBox(this.suggestionBox);this.suggestionBox.show();},R.controls.MarkdownSuggester.prototype.exitSuggestionBlock=function(){if(this.suggestionsActive){if(this.scheduledQuery){clearTimeout(this.scheduledQuery);}
this.suggestionsActive=false;this.lastQuery=null;this.suggestionBox.hide();this.suggestionBox.innerHTML='';}};R.controls.MarkdownSuggester.prototype.suggestionBlockUpdated=function(refreshImmediately){var timeout=null;if(refreshImmediately){timeout=10;}
this.setSuggestionBoxLocation();this.refreshSuggestions(this.getSuggestionBlockContents(true),timeout);};R.controls.MarkdownSuggester.prototype.getSuggestionBlock=function(){var text=this.textarea.value;var closedAt=this.getCaretInfo().caret;var deactivateOnSpace=(this.enableAlternateActivation&&text[this.suggestionsOpenedAt]==this.altActivateChar)||(this.enableEmojiActivation&&text[this.suggestionsOpenedAt]==this.emojiActivateChar);var deactivateOnEmoji=this.enableEmojiActivation&&text[this.suggestionsOpenedAt]==this.emojiActivateChar;for(var i=closedAt;i<text.length;i++){if(text[i]==this.deactivateChar||text[i]=='\n'||(deactivateOnEmoji&&text[i]==this.emojiActivateChar)||(deactivateOnSpace&&(text[i]==null||this.whitespaceRegex.test(text[i])))){break;}
closedAt+=1;}
return[this.suggestionsOpenedAt+1,closedAt];};R.controls.MarkdownSuggester.prototype.getSuggestionBlockContents=function(includeOpeningCharacter){var text=this.textarea.value;var block=this.getSuggestionBlock();var start=block[0];if(includeOpeningCharacter)start-=1;var contents=text.substring(start,block[1]);return contents;};R.controls.MarkdownSuggester.prototype.checkForActiveSuggestions=function(){var text=this.textarea.value;if(text===''){this.exitSuggestionBlock();return;}
if((this.enableBracketActivation&&text.indexOf(this.activateChar)>=0)||(this.enableAlternateActivation&&text.indexOf(this.altActivateChar)>=0)||(this.enableEmojiActivation&&text.indexOf(this.emojiActivateChar)>=0)){var activateSuggestionsAt=-1;var caretInfo=this.getCaretInfo();var refreshImmediately=false;var pos=caretInfo.caret-1;if(pos<this.suggestionsOpenedAt){this.exitSuggestionBlock();}
if(text[pos]==this.deactivateChar){pos--;refreshImmediately=true;}
while(pos>=0){if(text[pos]==this.deactivateChar)break;var precedingCharacter=text[pos-1];var precedingWhitespace=pos===0||this.whitespaceRegex.test(precedingCharacter);if(text[pos]==this.activateChar||(text[pos]==this.altActivateChar&&precedingWhitespace)||(text[pos]==this.emojiActivateChar&&precedingWhitespace)){activateSuggestionsAt=pos;break;}
pos--;}
if(activateSuggestionsAt>=0){var altActivation=this.enableAlternateActivation&&text[pos]==this.altActivateChar;var emojiActivation=this.enableEmojiActivation&&text[pos]==this.emojiActivateChar;this.suggestionsOpenedAt=activateSuggestionsAt;var block=this.getSuggestionBlock();var blockText=text.substring(block[0],block[1]);var followingText=text.substring(block[1]);var precededByChars=null;if(block[0]>=2){precededByChars=text.substring(block[0]-2,block[0]);}
if(precededByChars==']['){this.exitSuggestionBlock();}else if(blockText[0]=='^'){this.exitSuggestionBlock();}else if(followingText.indexOf('][')===0||followingText.indexOf('](http')===0){this.exitSuggestionBlock();}else if(altActivation&&this.whitespaceRegex.test(blockText)){this.exitSuggestionBlock();}else if(emojiActivation&&this.whitespaceRegex.test(blockText)){this.exitSuggestionBlock();}else{this.enterSuggestionBlock(activateSuggestionsAt,refreshImmediately);}}else{this.exitSuggestionBlock();}}};R.controls.MarkdownSuggester.prototype.isSuggestionsShowing=function(){return this.suggestionsActive&&this.suggestionBox.down('.'+this.boxContentClass);};R.controls.MarkdownSuggester.prototype.addEventListeners=function(){var me=this;Event.observe(me.suggestionBox,'click',function(){if(me.onBlurTimer){clearTimeout(me.onBlurTimer);}});Event.observe(this.textarea,'blur',function(e){me.cachedCaretInfo=null;me.onBlurTimer=setTimeout(function(){me.exitSuggestionBlock.call(me);},250);});Event.observe(this.textarea,'click',function(e){me.cachedCaretInfo=null;setTimeout(function(){me.checkForActiveSuggestions.call(me);},100);});Event.observe(this.textarea,'keypress',function(e){me.cachedCaretInfo=null;if(me.ignoreNextKeypress){return;}
var keyCode=e.keyCode;if(me.isSuggestionsShowing()){if(keyCode==38){Event.stop(e);var selected=me.suggestionBox.down('.selected');var li=selected&&selected.previous('li');if(li){selected.removeClassName('selected');li.addClassName('selected');}}else if(keyCode==40){Event.stop(e);var selected=me.suggestionBox.down('.selected');var li=selected&&selected.next('li');if(li){selected.removeClassName('selected');li.addClassName('selected');}
Event.stop(e);}else if(keyCode==27){Event.stop(e);}else if(keyCode==13){Event.stop(e);}}else{me.checkForActiveSuggestions.call(me);}});Event.observe(this.textarea,'keydown',function(e){me.shifted=e.shiftKey;});Event.observe(this.textarea,'keydown',function(e){me.shifted=e.shiftKey;});Event.observe(this.textarea,'keyup',function(e){me.cachedCaretInfo=null;if(me.ignoreNextKeypress){me.ignoreNextKeypress=false;return;}
var keyCode=e.keyCode;var charCode=e.charCode;var shiftKey=e.shiftKey||me.shifted;if(me.enableBracketActivation&&keyCode&&(keyCode==me.activateKeyCode)){me.enterSuggestionBlock.call(me);}else if(me.enableAlternateActivation&&keyCode&&keyCode==me.altActivateKeyCode&&shiftKey){me.enterSuggestionBlock.call(me);}else if(me.enableEmojiActivation&&keyCode&&keyCode==me.emojiActivateKeyCode&&shiftKey){me.enterSuggestionBlock.call(me);}else if(keyCode&&(keyCode==me.deactivateKeyCode)){}else if(me.enableAlternateActivation&&charCode&&(String.fromCharCode(charCode)==me.altActivateChar)){me.enterSuggestionBlock.call(me);}else if(me.enableEmojiActivation&&charCode&&(String.fromCharCode(charCode)==me.emojiActivateChar)){me.enterSuggestionBlock.call(me);}else if(me.enableBracketActivation&&charCode&&(String.fromCharCode(charCode)==me.activateChar)){me.enterSuggestionBlock.call(me);}else if(charCode&&(String.fromCharCode(charCode)==me.deactivateChar)){}else if(me.isSuggestionsShowing()){if(keyCode==27){me.ignoreNextKeypress=true;me.exitSuggestionBlock.call(me);}else if(keyCode==13){me.setSuggestionBlockContents.call(me);Event.stop(e);}else if(keyCode==38){Event.stop(e);}else if(keyCode==40){Event.stop(e);}else{me.checkForActiveSuggestions.call(me);}}else{me.checkForActiveSuggestions.call(me);}});};R.controls.MarkdownSuggester.prototype.suggestionClicked=function(item){if(this.onBlurTimer){clearTimeout(this.onBlurTimer);}
this.setSuggestionBlockContents(item);};R.controls.MarkdownSuggester.prototype.refreshSuggestions=function(textWithOpener,timeout){var me=this;timeout=timeout||this.defaultRefreshTimeout;var activatedBy=textWithOpener[0];var text=textWithOpener.substring(1);if(text===''||this.lastQuery==text||text.match(/^[0-9]{1,2}$/)){return;}
this.lastQuery=text;if(this.scheduledQuery){clearTimeout(this.scheduledQuery);}
if(text.length<this.minQueryLength&&activatedBy!=this.emojiActivateChar){this.suggestionBox.innerHTML='';}else{this.scheduledQuery=setTimeout(function(){new Ajax.Request('/markdown/suggestions',{parameters:{query:text,activated_by:activatedBy},method:'get',onComplete:function(xhr){me.suggestionBox.getElementsBySelector('a').each(function(a){a.onmouseover=null;a.onclick=null;});me.suggestionBox.innerHTML=xhr.responseText;R.utils.makeRoom(me.suggestionBox);me.suggestionBox.getElementsBySelector('a').each(function(a){var listItems=a.up('ul').getElementsBySelector('li');var currentItem=a.up('li');a.onmouseover=function(){listItems.each(function(li){li.removeClassName('selected');});currentItem.addClassName('selected');};a.onclick=function(e){me.suggestionClicked.call(me,this.up('li'));Event.stop(e||window.event);};});}});},timeout);}};R.controls.MarkdownSuggester.prototype.setSuggestionBlockContents=function(item){var selection=item||this.suggestionBox.down('.selected');var selectedLink=selection.getAttribute('data-link');var selectedName=selection.getAttribute('data-title');var text=this.textarea.value;var block=this.getSuggestionBlock();var trailingText=text.substring(block[1]);var addTrailingSpace=text.length==block[1];var closer=this.deactivateChar;if(trailingText[0]==this.deactivateChar){trailingText=trailingText.substring(1);}
closer+='('+selectedLink+')';if(addTrailingSpace){closer+=' ';}
if(trailingText[0]=='('||trailingText[1]=='('){trailingText=trailingText.replace(/\(.*?\)/,'');}
var leadingText=text.substring(0,block[0]);if(leadingText[leadingText.length-1]==this.emojiActivateChar){closer=': ';}
if(this.enableAlternateActivation&&leadingText[leadingText.length-1]==this.altActivateChar){leadingText=leadingText.substring(0,leadingText.length-1)+this.activateChar;}
leadingText+=selectedName+closer;this.textarea.value=leadingText+trailingText;R.utils.setSelectionRange(this.textarea,leadingText.length,leadingText.length);if(this.hiddenField){this.hiddenField.value='1';}
this.exitSuggestionBlock();};R.controls.SearchCard=function(element){this.element=element;this.blockClass='search_card__block';this.photoBlock=this.getBlock('photo');this.currentBlock=this.photoBlock;if(this.photoBlock&&this.element.down('.touch_gallery')){this.touchGallery=this.addTouchGallery();}};R.controls.SearchCard.initialize=function(){$$('.search_card').each(function(card){if(!card.__searchCard){card.__searchCard=new R.controls.SearchCard(card);}});};R.controls.SearchCard.flip=function(blockName,clicked,selectedClass){var card=$(clicked).up('.search_card');if(!card.__searchCard){card.__searchCard=new R.controls.SearchCard(card);}
card.__searchCard.flip(blockName);card.__searchCard.updateNavigationClasses(clicked,selectedClass);};R.controls.SearchCard.prototype.addTouchGallery=function(){var gallery=this.element.down('.touch_gallery');if(gallery){return new R.controls.TouchGallery(gallery,{variableHeight:true,useDots:true});}};R.controls.SearchCard.prototype.moveTouchGallery=function(){if(this.touchGallery){this.touchGallery.move();}};R.controls.SearchCard.prototype.updateNavigationClasses=function(clicked,selectedClass){var navigationClass='flex_linkbar__link';this.element.getElementsBySelector('.'+navigationClass).each(function(e){e.removeClassName(selectedClass);});clicked.addClassName(selectedClass);};R.controls.SearchCard.prototype.getBlock=function(blockName){var selector='.'+this.blockClass+'--'+blockName;return this.element.down(selector);};R.controls.SearchCard.prototype.flip=function(blockName){var block=this.getBlock(blockName);this.element.getElementsBySelector('.'+this.blockClass).each(function(b){b.hide();});if(this.minHeight){block.style.minHeight=this.minHeight;}
var contentUrl=block.getAttribute('data-content-url');if(!block.__contentLoaded&&contentUrl){new Ajax.Updater(block,contentUrl,{onComplete:function(){block.__contentLoaded=true;}});}
block.show();if(this.currentBlock==block&&this.currentBlock==this.photoBlock){this.moveTouchGallery();}
this.currentBlock=block;};R.controls.NavigationBarMenuGroup=function(menus){this.menus=$A(menus);var me=this;this.menus.each(function(menu){menu.setNavigationMenuGroup(me);});};R.controls.NavigationBarMenuGroup.prototype.menuOpened=function(opened){this.menus.each(function(menu){if(menu!=opened){menu.hideMenu();}});};R.controls.NavigationBarMenu=function(tab,menu,options){Browser.watchForTouch();this.tab=$(tab);this.menu=$(menu);this.activeTabClassName='navigation_v2__tab--menu_active';this.activeTouchTabClassName='navigation_v2__tab--menu_active_touch';this.menuTop='42px';if(R.swatch.isSwatching('FRONTEND12')){this.menuTop='52px';}
this.navigationMenuGroup=null;this.tabTouched=false;this.mouseLeftWindow=false;this.orientation=options&&options.orientation;this.onShow=options&&options.onShow;this.onlyShowIf=options&&options.onlyShowIf;this.ignoreMobileNavigation=options&&options.ignoreMobileNavigation;if(!this.tab.id){console.log("NavigationBarMenu: tab "+tab+" does not have an id");}
this.mouseoverDetected=false;this.cancelObserver=null;this.showingMenu=false;if(tab){this.addTouchHandlers(this.tab);this.addMouseHandlers(this.tab);R.utils.observeHover(menu,'li');}};R.controls.NavigationBarMenu.prototype.getTab=function(){return this.tab;};R.controls.NavigationBarMenu.prototype.getMenu=function(){return this.menu;};R.controls.NavigationBarMenu.prototype.setNavigationMenuGroup=function(group){this.navigationMenuGroup=group;};R.controls.NavigationBarMenu.prototype.showNeeded=function(){return!this.showingMenu&&(!this.onlyShowIf||this.onlyShowIf())&&!(this.ignoreMobileNavigation&&R.navigation.compressedNavigationEnabled());};R.controls.NavigationBarMenu.prototype.showMenu=function(options){if(this.showingMenu)return;this.showingMenu=true;this.tab.addClassName(this.activeTabClassName);if((options&&options.touchMenu)){this.tab.addClassName(this.activeTouchTabClassName);this.tabTouched=true;}
var left=Position.positionedOffset(this.tab)[0];if(this.orientation=='left'){this.menu.style.visibility='hidden';this.menu.show();left=left-Element.getWidth(this.menu)+Element.getWidth(this.tab);}
var menuTop=this.menuTop;if(options&&options.touchMenu){menuTop='0px';left=left-5;}
this.menu.setStyle({left:left+'px',top:menuTop});this.menu.style.visibility='';this.menu.show();if(this.navigationMenuGroup){this.navigationMenuGroup.menuOpened(this);}
if(this.onShow){this.onShow(this);}};R.controls.NavigationBarMenu.prototype.hideMenu=function(){if(!this.showingMenu)return;$(this.tab).removeClassName(this.activeTabClassName);$(this.tab).removeClassName(this.activeTouchTabClassName);$(this.menu).hide();this.showingMenu=false;};R.controls.NavigationBarMenu.prototype.addTouchHandlers=function(element){var me=this;me.cancelObserver=function(e){if(me.showingMenu){if(!R.utils.eventTriggeredOn(e,'.notebook_menu')&&!R.utils.eventTriggeredOn(e,'.navigation_v2__tab--menu')){me.hideMenu();Event.stop(e);}}};Event.observe($('page'),'touchstart',me.cancelObserver,{passive:true});Event.observe(document,'pagehide',function(){if(me.showingMenu)me.hideMenu();});if(Browser.isChrome()){Event.observe(element,'touchstart',function(){me.tabTouched=true;},{passive:true});}
if(!Browser.isChrome()){var touchStart=function(e){if(me.showNeeded()){me.tabTouched=true;me.showMenu({touchMenu:true});Event.stop(e);}};Event.observe(element,'touchstart',touchStart,{passive:true});Event.observe(element.down('a'),'click',function(e){if(me.tabTouched){touchStart(e);}});}};R.controls.NavigationBarMenu.prototype.addMouseHandlers=function(element){var me=this;if(Browser.hasTouchEvents()&&Browser.isChrome()){Event.observe(element,'click',function(e){if(me.showNeeded()){me.showMenu({touchMenu:Browser.probablyTouchScreen()});Event.stop(e);}});Event.observe(element.down('a'),'click',function(e){if(me.showNeeded()){me.showMenu({touchMenu:Browser.probablyTouchScreen()});Event.stop(e);}});}
Event.observe(element,'mouseover',function(){me.mouseoverDetected=true;me.mouseLeftWindow=false;if(!me.tabTouched&&me.showNeeded()){me.showMenu({touchMenu:Browser.probablyTouchScreen()});}});Event.observe(element,'mouseout',function(e){if(typeof(e.relatedTarget)=='undefined'||e.relatedTarget!==null){if(!me.tabTouched&&me.showingMenu){me.hideMenu();}}else{me.mouseLeftWindow=true;}
return true;});Event.observe(document.body,'mouseover',function(e){if(me.mouseLeftWindow&&!me.tabTouched&&me.showingMenu){me.hideMenu();}
me.mouseLeftWindow=false;return true;});};R.controls.NavigationDropdownGroup=function(menus){this.menus=$A(menus);var me=this;this.menus.each(function(menu){menu.setNavigationDropdownGroup(me);});};R.controls.NavigationDropdownGroup.prototype.addDropdown=function(dropdown){this.menus.push(dropdown);};R.controls.NavigationDropdownGroup.prototype.dropdownOpened=function(opened){this.menus.each(function(menu){if(menu!=opened){menu.hideDropdown();}});};R.controls.NavigationDropdown=function(tab,options){this.activeTabClassName='navigation_v2__tab--open';this.activeTouchTabClassName='navigation_v2__tab--open_touch';this.dropdownClassName='c-navigation_dropdown';this.loadingDropdownClassName='c-navigation_dropdown--loading';this.dropdownReversedClassName='c-navigation_dropdown--reversed';this.dropdownFitClassName='c-navigation_dropdown--fit';this.dropdownSnapClassName='c-navigation_dropdown--snap';this.activityIndicatorClassName='c-navigation_indicator';this.activityIndicatorChildClassName='c-navigation_indicator__snake';this.activeDropdownClassName='is-active';Browser.watchForTouch();this.tab=$(tab);this.dropdown=tab.down('.'+this.dropdownClassName);this.activityIndicator=this.addActivityIndicator(this.tab);this.menuTop='0px';if(this.dropdown){this.menuOrientation=this.dropdown.hasClassName(this.dropdownReversedClassName)?'right':'left';this.menuFit=this.dropdown.hasClassName(this.dropdownFitClassName);this.menuSnap=this.dropdown.hasClassName(this.dropdownSnapClassName);}
this.navigationDropdownGroup=null;this.tabTouched=false;this.mouseLeftWindow=false;this.orientation=options&&options.orientation;this.onShow=options&&options.onShow;this.onlyShowIf=options&&options.onlyShowIf;this.ignoreMobileNavigation=options&&options.ignoreMobileNavigation;this.mouseoverDetected=false;this.cancelObserver=null;this.showingMenu=false;if(tab){this.link=this.tab.down('A');this.addTouchHandlers(this.tab);this.addMouseHandlers(this.tab);}};R.controls.NavigationDropdown.prototype.getTab=function(){return this.tab;};R.controls.NavigationDropdown.prototype.getMenu=function(){return this.dropdown;};R.controls.NavigationDropdown.prototype.setNavigationDropdownGroup=function(group){this.navigationDropdownGroup=group;};R.controls.NavigationDropdown.prototype.recalculateColumns=function(){var navigationHeight=50+20;var maxHeight=document.documentElement.clientHeight-navigationHeight-2;var columns=1;var maxColumns=6;var totalHeight=0;this.dropdown.getElementsBySelector('.c-navigation_dropdown__column li').each(function(item){var height=item.__computedGetHeight;if(!height){height=item.getHeight();item.__computedGetHeight=height;}
totalHeight+=height;if(totalHeight>=maxHeight){columns+=1;totalHeight=height;}});if(columns>maxColumns){columns=maxColumns;}
this.dropdown.setAttribute('data-navigation-dropdown-columns',columns);};R.controls.NavigationDropdown.prototype.addActivityIndicator=function(tab){var attach=tab.down('a')||tab;var activityIndicator=attach.down('.'+this.activityIndicatorClassName);if(!activityIndicator){activityIndicator=document.createElement('div');activityIndicator.className=this.activityIndicatorClassName;var snake=document.createElement('div');snake.className=this.activityIndicatorChildClassName;activityIndicator.appendChild(snake);attach.appendChild(activityIndicator);}
return activityIndicator;};R.controls.NavigationDropdown.prototype.showNeeded=function(){return this.dropdown&&!this.showingMenu&&(!this.onlyShowIf||this.onlyShowIf())&&!(this.ignoreMobileNavigation&&R.navigation.compressedNavigationEnabled());};R.controls.NavigationDropdown.prototype.showMenu=function(options){if(this.showingMenu)return;this.showingMenu=true;this.tab.addClassName(this.activeTabClassName);if(this.link&&this.link.getAttribute('aria-expanded')){this.link.setAttribute('aria-expanded','true');}
if(this.dropdown){this.dropdown.addClassName(this.loadingDropdownClassName);this.dropdown.addClassName(this.activeDropdownClassName);this.recalculateColumns();this.dropdown.removeClassName(this.loadingDropdownClassName);}
if((options&&options.touchMenu)){this.tab.addClassName(this.activeTouchTabClassName);this.tabTouched=true;}
var top=this.tab.getHeight();if(this.dropdown){var style={top:top+'px'};style[this.menuOrientation]='0px';var rect=this.tab.getBoundingClientRect();if(this.menuFit){var tabRight=Math.round(window.innerWidth+rect.width-rect.right);style.width=tabRight+'px';}
if(this.menuSnap){var rightOffset=Math.round(window.innerWidth-rect.right);style.right=((-1*rightOffset)+15)+'px';}
this.dropdown.setStyle(style);this.dropdown.addClassName(this.activeDropdownClassName);}
if(this.navigationDropdownGroup){this.navigationDropdownGroup.dropdownOpened(this);}
if(this.onShow){this.onShow(this);}};R.controls.NavigationDropdown.prototype.hideDropdown=function(){if(!this.showingMenu)return;if(!this.tab)return;$(this.tab).removeClassName(this.activeTabClassName);$(this.tab).removeClassName(this.activeTouchTabClassName);if(this.link&&this.link.getAttribute('aria-expanded')){this.link.setAttribute('aria-expanded','false');}
if(this.dropdown){$(this.dropdown).removeClassName(this.activeDropdownClassName);}
this.showingMenu=false;this.tabTouched=false;};R.controls.NavigationDropdown.prototype.addTouchHandlers=function(element){var me=this;me.cancelObserver=function(e){if(me.showingMenu){if(!R.utils.eventTriggeredOn(e,'.navigation_v2__tab--dropdown')&&!R.utils.eventTriggeredOn(e,'.navigation_v2__dropdown')){me.hideDropdown();Event.stop(e);}}};Event.observe(document.body,'touchstart',me.cancelObserver,{passive:true});Event.observe(document,'pagehide',function(){me.hideDropdown();});if(Browser.isChrome()){Event.observe(element,'touchstart',function(){me.tabTouched=true;},{passive:true});}};R.controls.NavigationDropdown.prototype.addMouseHandlers=function(element){var me=this;Event.observe(element,'click',function(e){if(me.showNeeded()){me.showMenu({touchMenu:Browser.probablyTouchScreen()});Event.stop(e);}});Event.observe(element.down('a'),'click',function(e){if(me.showNeeded()){me.showMenu({touchMenu:Browser.probablyTouchScreen()});Event.stop(e);}});var mouseOverElement=element;if($(document.body).hasClassName('swatch_navhover')){mouseOverElement=element.down('a');}
Event.observe(mouseOverElement,'mouseover',function(){if(Browser.probablyTouchScreen()&&(Browser.isFirefox()||navigator.userAgent.indexOf("Silk/")>=0)){return;}
me.mouseoverDetected=true;me.mouseLeftWindow=false;if(!me.tabTouched&&me.showNeeded()){me.showMenu({touchMenu:Browser.probablyTouchScreen()});}});Event.observe(element,'mouseout',function(e){var target=e.relatedTarget;if(typeof(target)=='undefined'||target!==null){if(!me.tabTouched&&me.showingMenu){var overDropDown=$(document.body).hasClassName('swatch_navhover')&&$(target).descendantOf(element);if(!overDropDown){me.hideDropdown();}}}else{var leftWindow=true;var originalTarget=Event.element(e);if(originalTarget&&originalTarget.tagName=='SELECT'&&$(originalTarget).descendantOf(element)){leftWindow=false;}
if(leftWindow){me.mouseLeftWindow=true;if(me.showingMenu){me.hideDropdown();}}}
return true;});Event.observe(document.body,'mouseover',function(e){if(me.mouseLeftWindow&&!me.tabTouched&&me.showingMenu){me.hideDropdown();}
me.mouseLeftWindow=false;return true;});};R.controls.TabBar=function(element,options){if(element.__initializedTabBar)return false;if(!options)options={};element.__initializedTabBar=true;this.tabBar=$(element);this.moreTab=element.down('.tab_bar_responsive__show_more');this.moreTabWidth=50;this.simplifiedOverflow=options.simplifiedOverflow;this.currentInOverflow=options.currentInOverflow;var me=this;Event.observe(window,'resize',function(){me.updateOverflow();});if(this.moreTab){this.initializeResponsiveMoreTab();}
if(this.moreTab){this.updateOverflow();}};R.controls.TabBar.prototype.updateOverflow=function(){tabs=this.tabBar.getElementsBySelector('.tab_bar_responsive__overflow--auto').reverse();var me=this;tabs.each(function(tab){if(tab.up('#current')||tab.id=='current'){tab.removeClassName('tab_bar_responsive__overflow');}});var currentTabWidth=0;var overflowedTabs=0;tabs.each(function(tab){if(!(tab.up('#current')||tab.id=='current')){tab.removeClassName('tab_bar_responsive__overflow');var gutter=5;if(R.swatch&&R.swatch.isSwatching('FRONTEND12')){gutter=15;}
var right=tab.offsetLeft+tab.getWidth();var moreMenuRight=window.innerWidth;if(R.swatch&&R.swatch.isSwatching('FRONTEND12')){if(overflowedTabs>0){moreMenuRight=moreMenuRight-me.moreTab.getWidth();}}else{moreMenuRight=moreMenuRight-me.moreTab.getWidth();}
if(((right+currentTabWidth)>=(moreMenuRight-gutter))||(me.overflowed&&me.simplifiedOverflow)){me.overflowed=true;overflowedTabs+=1;tab.addClassName('tab_bar_responsive__overflow');}}else{currentTabWidth=tab.getWidth();}});if(tabs.length>0){if(R.swatch&&R.swatch.isSwatching('FRONTEND12')){this.moreTab.useClassName('tab_bar_responsive__show_more--empty',this.tabBar.getElementsBySelector('.tab_bar_responsive__overflow').size>0);}else{this.moreTab.useClassName('tab_bar_responsive__show_more--empty',overflowedTabs==0);}}};R.controls.TabBar.prototype.initializeResponsiveMoreTab=function(){var largeOverflowThreshold=10;var moreMenu=this.moreMenu;var moreMenuItems=0;if(this.tabBar.down('.tabs__legacy')){moreMenuItems=this.tabBar.getElementsBySelector('.tabs__legacy li').length;}
if(!moreMenu){moreMenu=document.createElement('UL');moreMenu.className='tab_bar_responsive__more_menu';moreMenu.style.display='none';this.moreMenu=moreMenu;this.tabBar.parentNode.insertBefore(moreMenu,this.tabBar.nextSibling);}
var me=this;if(R.swatch&&R.swatch.isSwatching('FRONTEND12')){Event.observe(document.body,'click',function(e){if(moreMenu.visible()){moreMenu.hide();me.moreTab.removeClassName('tab_bar_responsive__show_more--selected');if(!R.utils.eventTriggeredOn(e,'tab_bar_responsive__overflow')){Event.stop(e);}}});moreMenu.observe('click',function(){moreMenu.hide();me.moreTab.removeClassName('tab_bar_responsive__show_more--selected');});}
this.moreTab.observe('click',function(e){if(moreMenu.visible()){moreMenu.hide();me.moreTab.removeClassName('tab_bar_responsive__show_more--selected');}else{moreMenu.innerHTML='';var selector='.tab_bar_responsive__overflow';if(me.currentInOverflow){selector='LI';}
me.tabBar.getElementsBySelector(selector).each(function(menuItem){if(menuItem.tagName!='LI'){menuItem=menuItem.up('li');}
if(!menuItem.up('.rsp_hidden')&&menuItem!=me.moreTab){var item=document.createElement('LI');var contains=menuItem.down('.static_tab');if(contains&&contains.id){item.className='tab_bar_responsive__more_menu_item--'+contains.id;}
item.innerHTML=menuItem.innerHTML;moreMenu.appendChild(item);item.getElementsBySelector('a').each(function(link){if(!link.hasClassName('rsp_hidden')){link.className='';link.observe('click',function(e){clickEvent=document.createEvent("MouseEvents");clickEvent.initMouseEvent('click',true,true,window,1,1,1,1,1,false,false,false,false,0,menuItem);menuItem.down('a').dispatchEvent(clickEvent);moreMenu.hide();Event.stop(e);});}});}});if(moreMenuItems>largeOverflowThreshold){moreMenu.addClassName('tab_bar_responsive__more_menu--large');}else{moreMenu.removeClassName('tab_bar_responsive__more_menu--large');}
moreMenu.show();me.moreTab.addClassName('tab_bar_responsive__show_more--selected');}
Event.stop(e);});};R.controls.Toast=function(options){if(!(Browser.responsiveBreakpoint()||options.desktop)){return;}
options=options||{};this.sticky=options.sticky;this.icon=options.icon;this.baseClassName='toast';this.className='toast';if(this.sticky){this.className+=' toast--sticky';}
this.activeClassName='toast--popped';this.transitionTime=1000;this.closeTime=3000;this.type=options.type||'success';this.closed=false;var content="";var message=options.message||"Success!";if(this.icon){content="<div class=\"toast__icon\"><img src='"+this.icon+"'/></div>";}else if(this.type=='success'){content="<div class=\"toast__icon\"><img src='/images/assets/icons/forms/success-circle.svg'/></div>";}else if(this.type=='neutral'){content="<div class=\"toast__icon\"><img src='/images/assets/icons/navigation/yarns.svg'/></div>";}else if(this.type=='warning'){content="<div class=\"toast__icon\"><img src='/images/assets/icons/ui/alert-circle.svg'/></div>";}else if(this.type=='error'){content="<div class=\"toast__icon\"><img src='/images/assets/icons/ui/alert-circle-red.svg'/></div>";}
content+=" <div class='toast__message'>"+message+"</div>";content+=" <div class='toast__close'><button aria-label='Close'></button></div>";this.element=this.buildToast(this.type,content);var me=this;setTimeout(function(){me.pop(content);},100);this.eventListener=$(document.body).observe('touchmove',function(){me.close();},{passive:true});if(!this.sticky){setTimeout(function(){me.close();},this.closeTime);}};R.controls.Toast.prototype.buildToast=function(type,content){className=this.className+' '+('toast--'+type);var toast=document.createElement('DIV');toast.className=className;var toastContent=document.createElement('DIV');toastContent.className=this.baseClassName+'__content';toast.appendChild(toastContent);toastContent.innerHTML=content;document.body.appendChild(toast);var me=this;toast.observe('click',function(e){me.close();if(!toast.hasClassName('toast--sticky')){Event.stop(e);}});return toast;};R.controls.Toast.prototype.pop=function(){this.element.addClassName(this.activeClassName);};R.controls.Toast.prototype.close=function(){if(this.closed){return;}
this.closed=true;this.element.removeClassName(this.activeClassName);if(this.eventListener){$(document.body).stopObserving('touchmove',this.eventListener,{passive:true});}
var me=this;setTimeout(function(){if(me.element)me.element.remove();},this.transitionTime);};R.controls.ToolbarBuilder=function(element,options){if(element.__initializedToolbar)return false;if(!options)options={};element.__initializedToolbar=true;this.toolbar=$(element);this.form=this.toolbar.up('form');this.addEventHandlers();this.legacyBrowserSupport();};R.controls.ToolbarBuilder.prototype.addEventHandlers=function(){var toggler=this.toolbar.down('.toolbar_builder__tool--toggle a');var me=this;if(toggler){toggler.observe('click',function(){me.toolbar.toggleClassName('toolbar_builder--expanded');});}
var searchLink=this.toolbar.down('.toolbar_builder__search_link');if(searchLink&&this.form){searchLink.observe('click',function(e){Event.stop(e);me.form.submit();});}
if(this.form&&this.form.getAttribute('data-autosubmit')=='1'){$(this.form).getElementsBySelector('select').each(function(select){select.observe('change',function(){me.form.submit();});});}};R.controls.ToolbarBuilder.prototype.legacyBrowserSupport=function(){if(this.toolbar.hasClassName('toolbar_builder--without_flexbox')){var currentWidth=this.toolbar.getWidth();var parentWidth=$(this.toolbar.parentNode).getWidth();var spacerWidth=parentWidth-currentWidth;if(spacerWidth>0){var spacer=this.toolbar.down('.toolbar_builder__tool--spacer');spacer.style.width=spacerWidth+'px';spacer.style.minWidth=spacerWidth+'px';spacer.innerHTML='&nbsp;';this.toolbar.style.display='block';}}};R.controls.OverflowBar=function(ul,options){this.ul=$(ul);this.ul.style.position='relative';this.selectedClass=options.activeItemClass;this.container=options.container||document.body;this.overflowClass='overflow_bar__overflowed';this.moreMenuClass='overflow_bar__more_menu';this.moreMenuActiveClass='overflow_bar__more_menu--active';this.overflowMenuClass='overflow_bar_menu';this.overflowMenuActiveClass='overflow_bar_menu--active';this.moreMenu=document.createElement('LI');if($(document.body).hasClassName('theme_hebridean')){this.moreMenu.innerHTML="<a href='#'><img src='/images/assets/icons-dark/ui/more-vertical.svg' alt='More options...'/></a>";}else{this.moreMenu.innerHTML="<a href='#'><img src='/images/assets/icons/ui/more-vertical.svg' alt='More options...'/></a>";}
this.moreMenu.className=this.moreMenuClass;this.ul.appendChild(this.moreMenu);this.overflowMenu=document.createElement('UL');this.overflowMenu.className=this.overflowMenuClass;document.body.appendChild(this.overflowMenu);var me=this;this.updateOverflow();Event.observe(window,'resize',function(){me.updateOverflow();});Event.observe(this.moreMenu,'click',function(e){var anchorPosition=Position.cumulativeOffset(me.moreMenu);me.overflowMenu.style.top=(anchorPosition[1]+28)+"px";me.overflowMenu.style.left=(anchorPosition[0]-165)+"px";me.overflowMenu.toggleClassName(me.overflowMenuActiveClass);if(me.overflowMenu.visible()){me.overflowMenu.id='quicknav';}else{me.overflowMenu.id='';}
Event.stop(e);});Event.observe(document.body,'click',function(e){me.overflowMenu.removeClassName(me.overflowMenuActiveClass);me.overflowMenu.id='';});};R.controls.OverflowBar.prototype.updateOverflow=function(){this.moreMenu.addClassName(this.moreMenuActiveClass);var containerWidth=this.container.getWidth();var listItems=this.ul.getElementsBySelector('li').reverse();var me=this;listItems.each(function(li){li.removeClassName(me.overflowClass);});var overflowedItems=$A([]);listItems.each(function(li){if(containerWidth<me.moreMenu.offsetLeft){if(!li.hasClassName(me.moreMenuClass)){li.addClassName(me.overflowClass);overflowedItems.push(li);}}});if(overflowedItems.length==0){this.moreMenu.removeClassName(this.moreMenuActiveClass);}else{this.overflowMenu.innerHTML='';overflowedItems.each(function(item,index){var li=document.createElement('li');li.innerHTML=item.innerHTML;me.overflowMenu.appendChild(li);});}};R.controls.PortholeDialog=function(parent,options){options=options||{};this.visible=false;this.parent=parent;this.onCreate=options.onCreate;this.onHide=options.onHide;this.onShow=options.onShow;this.porthole=this.addElements(parent,{openingHeight:options.opening[0],openingWidth:options.opening[1],height:options.height,margin:options.margin});this.addEventHandlers();R.controls.PortholeDialog.registered.push(this);};R.controls.PortholeDialog.registered=$A([]);R.controls.PortholeDialog.anyVisible=function(){var visible=false;R.controls.PortholeDialog.registered.each(function(porthole){if(!visible)visible=porthole.isVisible();});return visible;};R.controls.PortholeDialog.hideAll=function(){R.controls.PortholeDialog.registered.each(function(porthole){porthole.hide();});};R.controls.PortholeDialog.prototype.getParent=function(){return this.parent;};R.controls.PortholeDialog.prototype.addEventHandlers=function(){$(document.body).observe('click',function(e){if(R.controls.PortholeDialog.anyVisible()){R.controls.PortholeDialog.registered.each(function(porthole){if(porthole.isVisible()&&!R.utils.eventTriggeredOn(e,porthole.getParent().id)){porthole.hide();Event.stop(e);if(e.stopImmediatePropagation)e.stopImmediatePropagation();}});}});};R.controls.PortholeDialog.prototype.addElements=function(parent,style){var create=function(className,style){style=style||{};var e=$(document.createElement('DIV'));e.className=className;e.setStyle(style);return e;};var porthole=create('porthole_dialog',{left:(-1*style.margin)+'px',top:(-1*style.margin)+'px'});var top=create('porthole_dialog__top',{width:(style.openingWidth+(style.margin*2))+'px',height:style.margin+'px'});var center=create('porthole_dialog__center',{height:(style.openingHeight+2)+'px'});var bottom=create('porthole_dialog__bottom',{width:style.openingWidth+'px',minHeight:style.height+'px',paddingLeft:style.margin+'px',paddingRight:style.margin+'px'});center.appendChild(create('porthole_dialog__left',{width:style.margin+'px'}));center.appendChild(create('porthole_dialog__opening',{width:style.openingWidth+'px'}));center.appendChild(create('porthole_dialog__right',{width:style.margin+'px'}));porthole.appendChild(top);porthole.appendChild(center);porthole.appendChild(bottom);porthole.style.display='none';parent.insertBefore(porthole,parent.firstChild);return porthole;};R.controls.PortholeDialog.prototype.show=function(callbackKey){if(this.onShow){if(callbackKey){this.onShow[callbackKey]();}else{this.onShow();}}
this.visible=true;this.parent.style.zIndex=1000;this.parent.addClassName('porthole_dialog_active');new Effect.Appear(this.porthole,{duration:0.1});};R.controls.PortholeDialog.prototype.hide=function(){this.visible=false;this.parent.style.zIndex='';this.parent.removeClassName('porthole_dialog_active');this.porthole.hide();if(this.onHide)this.onHide();};R.controls.PortholeDialog.prototype.isVisible=function(){return this.visible;};window.mobileExperience={};mobileExperience.activatePanel=function(){console.log("MobileExperience has not been contructed and set");};R.controls.MobileExperience=function(options){options=options||{};this.onMobileView=options.onMobileView;this.onDesktopView=options.onDesktopView;this.lazyLoadImages=options.lazyLoadImages!==undefined;this.initialView=null;this.lazyLoadOptions={selector:'.blazy',loadInvisible:true};if(options.lazyLoadImages!==true){this.lazyLoadOptions=options.lazyLoadImages||{};}
if(options.manageDialogs){this.patchRedBox();}
this.blazy=null;this.panels=$H();var me=this;Browser.onBreakpoints({mobile:function(){if(me.initialView===null)me.initialView='mobile';if(me.onMobileView)me.onMobileView();me.initializeBlazy();},desktop:function(){if(me.initialView===null)me.initialView='desktop';if(me.onDesktopView)me.onDesktopView();me.teardownBlazy();}});Element.observe(document.body,'ravScrollToSavePoint',function(e){me.teardownBlazy();me.initializeBlazy();});Element.observe(window,'popstate',function(e){if(!(R.swatch&&R.swatch.isSwatching('FRONTEND12'))){var actionSheetContainer=$$('.action_sheet_container').first();if(actionSheetContainer){actionSheetContainer.hide();return;}}
var loc=R.utils.parseHref(document.location);me.panels.values().each(function(panel){if(!loc[panel.key]){me.hidePanel(panel.key);}});});if(!(R.swatch&&R.swatch.isSwatching('FRONTEND12'))){var actionSheet=$$('.action_sheet').first();if(actionSheet){this.initializeActionSheet(actionSheet);window.history.pushState({actionsheet:true},'actionsheet','#actionsheet');}}
this.useDefaultPanels();};R.controls.MobileExperience.prototype.initializeActionSheet=function(actionSheet){if(!(R.swatch&&R.swatch.isSwatching('FRONTEND12'))){var container=actionSheet.up('.action_sheet_container');container.onclick=function(){container.hide();};}};R.controls.MobileExperience.prototype.showActionSheet=function(options){if(!(R.swatch&&R.swatch.isSwatching('FRONTEND12'))){options=options||{};var attributes=options.attributes;$(document.body).addClassName('with_action_sheet');var container=$$('.action_sheet_container').first();var content=container.down('.action_sheet__content');if(content&&options.content){content.innerHTML=options.content;}
container.show();if(attributes){container.getElementsBySelector('a').each(function(a){$H(attributes).each(function(pair){a.setAttribute(pair.key,pair.value);});});}}};R.controls.MobileExperience.prototype.patchRedBox=function(){this.currentRedBox=null;var me=this;RedBox.__originalAddHiddenContent=RedBox.addHiddenContent;RedBox.__originalClose=RedBox.close;RedBox.addHiddenContent=function(boxId,callback,options){me.currentRedBox=boxId;me.usePanel(boxId,{onHide:function(){RedBox.close();}});me.activatePanel(boxId);RedBox.__originalAddHiddenContent(boxId,callback,options);};RedBox.close=function(options){RedBox.__originalClose(options);R.utils.scrollToSavePoint();};};R.controls.MobileExperience.prototype.initializeBlazy=function(){if(!this.blazy){this.blazy=new Blazy(this.lazyLoadOptions);}};R.controls.MobileExperience.prototype.teardownBlazy=function(){if(this.blazy&&this.lazyLoadOptions.selector){this.blazy.load($$(this.lazyLoadOptions.selector),true);this.blazy.destroy();this.blazy=null;}};R.controls.MobileExperience.prototype.usePanel=function(parameter,options){this.panels[parameter]={key:parameter,onShow:options.onShow,onHide:options.onHide};};R.controls.MobileExperience.prototype.activatePanel=function(parameter,value){if(Browser.responsiveBreakpoint()){window.history.pushState({key:parameter,value:value},parameter,R.utils.addQueryParameter(window.location.href,parameter,value));}};R.controls.MobileExperience.prototype.showPanel=function(parameter,value){this.activatePanel(parameter,value);var callback=(this.panels[parameter]||{}).onShow;if(callback)callback();};R.controls.MobileExperience.prototype.hidePanel=function(parameter){window.history.replaceState({},'',R.utils.removeQueryParameter(window.location.href,parameter));var callback=(this.panels[parameter]||{}).onHide;if(callback)callback();if(Browser.responsiveBreakpoint()){setTimeout(function(){R.utils.scrollToSavePoint();},50);}};R.controls.MobileExperience.prototype.useDefaultPanels=function(parameter){this.usePanel('volume_id',{onHide:function(){if(!(R.swatch&&R.swatch.isSwatching('FRONTEND12'))){R.library.closeExpandedVolumes();}}});};R.controls.PagelessGallery=function(container,options){this.container=container;options=options||{};this.itemClassNames=options.itemClass||'';this.loadPageUrl=options.loadPageUrl;this.pageSize=options.pageSize||5;this.itemTag='img';this.itemBaseClass='pageless_gallery__item';this.itemCount=parseInt(this.container.getAttribute('data-pageless-gallery-size'),0);this.items=$A([]);this.pages=$A([]);this.addEvents();};R.controls.PagelessGallery.prototype.setStyle=function(){};R.controls.PagelessGallery.prototype.addEvents=function(){var me=this;$(this.container).observe('touchstart',function(){me.initializeItems();me.loadUpcomingPages();},{passive:true});$(this.container).observe('touchmove',function(){me.loadUpcomingPages();},{passive:true});};R.controls.PagelessGallery.prototype.loadUpcomingPages=function(){var firstVisibleItem=null;var lastVisibleItem=null;$(this.items).each(function(item){if(!item.loaded&&item.inViewport()){if(!firstVisibleItem)firstVisibleItem=item;lastVisibleItem=item;}});var currentlyVisible=lastVisibleItem?lastVisibleItem.page:1;for(var i=1;i<=currentlyVisible+1;i++){var page=this.pages[i];if(page)page.load();}};R.controls.PagelessGallery.prototype.getItems=function(){return this.container.getElementsByClassName(this.itemBaseClass);};R.controls.PagelessGallery.prototype.initializeItems=function(){if(this.initializedItems)return;this.initializedItems=true;var currentItems=this.container.getElementsByClassName(this.itemBaseClass);for(var i=0;i<this.itemCount;i++){var element=currentItems[i];if(!element){element=document.createElement(this.itemTag);element.className=this.itemBaseClass+' '+(this.itemClassNames);this.container.appendChild(element);}
var pageNumber=Math.floor(i/this.pageSize)+1;var item=new R.controls.PagelessGallery.Item(element,i,pageNumber);this.items.push(item);if(!this.pages[pageNumber]){var url=this.loadPageUrl+"?page="+pageNumber+"&page_size="+this.pageSize;this.pages[pageNumber]=new R.controls.PagelessGallery.Page(pageNumber,url);}
this.pages[pageNumber].addItem(item);}};R.controls.PagelessGallery.Page=function(page,loadPageUrl){this.page=page;this.loadPageUrl=loadPageUrl;this.items=$A([]);};R.controls.PagelessGallery.Page.prototype.addItem=function(item){this.items.push(item);};R.controls.PagelessGallery.Page.prototype.items=function(){return this.items;};R.controls.PagelessGallery.Page.prototype.load=function(){if(!this.loaded){this.loaded=true;if(!this.loadPageUrl){console.log("R.controls.PagelessGallery.Page: URL for loading page content has not been set!");}
var me=this;var page=this.page;new Ajax.Request(this.loadPageUrl,{method:'GET',onComplete:function(xhr){var itemAttributes=xhr.responseText.evalJSON();$(itemAttributes).each(function(attributes,index){var item=me.items[index];if(item){item.setDomId(attributes['dom_id']);item.setImageSrc(attributes['src']);}});}});}};R.controls.PagelessGallery.Item=function(element,index,page){this.element=element;this.index=index;this.page=page;this.loaded=false;};R.controls.PagelessGallery.Item.prototype.inViewport=function(){var rect=this.element.getBoundingClientRect();return rect.x>=0&&rect.x<=window.innerWidth;};R.controls.PagelessGallery.Item.prototype.setDomId=function(id){this.element.id=id;};R.controls.PagelessGallery.Item.prototype.setImageSrc=function(src){this.loaded=true;if(src){this.element.src=src;}else{this.element.hide();}};R.controls.EllipsisMenu=function(element){if(!element||element.__ellipsisMenu){return;}
element.__ellipsisMenu=true;this.expandedClass='ellipsis_menu--expanded';this.activeConfirmationClass='ellipsis_menu__confirm--active';this.element=element;this.addEventListeners();};R.controls.EllipsisMenu.prototype.addEventListeners=function(){if(!R.controls.EllipsisMenu.outlickListener){R.controls.EllipsisMenu.outlickListener=true;R.utils.closeOnOutclick(this.expandedClass);}
var me=this;Event.observe(this.element,'click',function(e){if(Event.element(e).up('li.ellipsis_menu__close')){$(me.element).removeClassName(me.expandedClass);}else{$(me.element).getElementsBySelector('a').each(function(a){a.removeClassName(me.activeConfirmationClass);});if(R.swatch&&R.swatch.isSwatching('FRONTEND12')&&Browser.responsiveBreakpoint()){var actionSheet=R.controls.buildActionSheet(null,'links');var cancel='<a href="#" class="action_sheet__cancel"><img src="/images/assets/icons/ui/cancel.svg" class="o-icon"/> Cancel</a>';actionSheet.innerHTML='<ul>'+me.element.innerHTML+cancel+'</ul>';R.controls.actionSheet(actionSheet);}else{me.element.addClassName(me.expandedClass);}}});if(!(R.swatch&&R.swatch.isSwatching('FRONTEND12'))){$(this.element).getElementsBySelector('li a').each(function(a){var confirm=a.getAttribute('data-confirm');if(confirm){a.onclick=function(){$(confirm).addClassName(me.activeConfirmationClass);return false;};}});}};R.controls.StashCalculator=function(element){this.unitClassName='stash_adjustment__unit';this.inputClassName='stash_adjustment__input';this.unitOptions=$A(['skeins','grams','yards','meters','ounces']);this.element=$(element);this.submit=this.element.down('.stash_adjustment__submit');this.currentUnits=null;this.currentUnitsField=this.element.down('.stash_adjustment_units_field');this.initializeUnits(this.element.getAttribute('data-preferred-units')||'grams');this.fields=this.buildFieldMap();this.converters=this.buildConversionMap();this.addEventListeners();this.updateUnits();window.__stashCalculator=this;};R.controls.StashCalculator.prototype.initializeUnits=function(preferredUnits){var me=this;this.element.getElementsByClassName(this.unitClassName).each(function(unit){if(unit.getAttribute('data-units')==preferredUnits){unit.addClassName('selected');me.currentUnits=preferredUnits;me.currentUnitsField.value=me.currentUnits;}});};R.controls.StashCalculator.prototype.updateUnits=function(){var me=this;this.element.getElementsByClassName(this.unitClassName).each(function(unit){if(unit.hasClassName('selected')){me.currentUnits=unit.getAttribute('data-units');me.currentUnitsField.value=me.currentUnits;}});this.element.getElementsBySelector('[data-reveal-units]').each(function(element){if(element.getAttribute('data-reveal-units')==me.currentUnits){element.show();}else{element.hide();}});};R.controls.StashCalculator.prototype.buildConversionMap=function(){var me=this;var units=this.unitOptions;var yarnData={};units.each(function(unit){yarnData[unit]=parseFloat(me.element.getAttribute('data-yarn-'+unit));});var conversionMap={};units.each(function(fromUnit){conversionMap[fromUnit]={};units.each(function(toUnit){conversionMap[fromUnit][toUnit]=function(x){return x*(yarnData[toUnit]/yarnData[fromUnit]);};});});return conversionMap;};R.controls.StashCalculator.prototype.buildFieldMap=function(){var element=this.element;var fieldMap={};this.unitOptions.each(function(unit){var unitName=unit=='skeins'?'skeins':'total_'+unit;fieldMap[unit]={starting:$('primary_pack_'+unitName),adjustments:element.getElementsBySelector('.adjustment_pack_'+unitName),total:$('remaining_pack_'+unitName),projects:element.getElementsBySelector('.project_pack_'+unitName)};});return fieldMap;};R.controls.StashCalculator.prototype.recalculateAll=function(prioritizeTotal){var me=this;this.recalculate(this.currentUnits,prioritizeTotal);this.unitOptions.each(function(units){if(units!=me.currentUnits){var f=me.converters[me.currentUnits][units];me.convert(units,f);me.recalculate(units);}});this.submit.show();};R.controls.StashCalculator.prototype.convert=function(units,conversionFunction){var destinationConfig=this.fields[units];var destinationFields=[destinationConfig.starting].concat(destinationConfig.adjustments).concat(destinationConfig.projects);var sourceConfig=this.fields[this.currentUnits];var sourceFields=[sourceConfig.starting].concat(sourceConfig.adjustments).concat(sourceConfig.projects);$A(destinationFields).each(function(field,index){var sourceField=sourceFields[index];if(sourceField.value===''){field.value='';}else if(field.value!==''){var converted=conversionFunction(sourceField.value);if(isNaN(converted)){field.value='';}else{field.value=converted.toFixed(3);}}});};R.controls.StashCalculator.prototype.recalculate=function(units,prioritizeTotal){var inputConfig=this.fields[units];var inputFields=[inputConfig.starting].concat(inputConfig.projects);if(!prioritizeTotal){inputFields=inputFields.concat(inputConfig.adjustments);}
var totalField=inputConfig.total;var adjustmentField=$A(inputConfig.adjustments).last();var total=0;var decimalPlaces=0;var countDecimals=function(str){return((str+'').split('.')[1]||'').length;};var me=this;$A(inputFields).each(function(input,index){var val=me.parseInput(input);if(val!==null){if(index===0){total=val;}else if(total!==null){total-=val;}
decimals=countDecimals(val);decimalPlaces=Math.max(decimalPlaces,decimals);}else{total=null;}
me.highlightError(input,val===null);});if(total!==null){var totalFieldValue=this.parseInput(totalField);if(prioritizeTotal&&adjustmentField&&totalField.value!==''&&totalFieldValue){decimals=countDecimals(totalField.value);decimalPlaces=Math.max(decimalPlaces,decimals);adjustmentField.value=(total-totalFieldValue).toFixed(decimalPlaces);}else{totalField.value=total.toFixed(decimalPlaces);me.highlightError(totalField,total<0);}}};R.controls.StashCalculator.prototype.parseInput=function(input){var value=input.value.strip();var parsed=parseFloat(value);var valid=!isNaN(value-parsed);if(value===''){return 0;}if(valid){return parsed;}else{return null;}};R.controls.StashCalculator.prototype.highlightError=function(input,error){if(error){input.style.borderColor='red';}else{input.style.borderColor='';}};R.controls.StashCalculator.prototype.addEventListeners=function(){var me=this;var units=this.element.getElementsByClassName(this.unitClassName);units.each(function(unit){unit.observe('click',function(event){units.map(function(u){u.removeClassName('selected');});unit.addClassName('selected');me.updateUnits();Event.stop(event);});});this.element.getElementsByClassName(this.inputClassName).each(function(input){var prioritizeTotal=input.id=='remaining_pack_skeins';input.observe('change',function(){me.recalculateAll(prioritizeTotal);});input.observe('keyup',function(){me.recalculateAll(prioritizeTotal);});});};R.controls.HotRightNow=function(container,options){if(!options)options={};this.container=$(container);this.linkClass='dashboard__hrn__item_toggle';this.itemClass='dashboard__hrn__item';this.detailsClass='dashboard__hrn__item__details';this.itemPreviewClass='dashboard__hrn__item--flipped';this.itemDetails=this.container.getElementsByClassName(this.detailsClass);this.links=this.container.getElementsByClassName(this.linkClass);this.items=this.container.getElementsByClassName(this.itemClass);this.addEventHandlers();console.log('🔥');};R.controls.HotRightNow.prototype.showPreview=function(selectedLink){var me=this;var selectedItem=selectedLink.up('.'+this.itemClass);var slideSelectedItem=!selectedItem.__flipped;this.items.each(function(item){if(!slideSelectedItem||selectedItem!=item){item.down('.dashboard__hrn__item__image').style.marginTop='0px';if(item.__originalHeight){item.style.height=item.__originalHeight;}
item.__flipped=false;}});if(slideSelectedItem){var height=Element.getHeight(selectedItem);selectedItem.style.height=height+'px';selectedItem.style.width=Element.getWidth(selectedItem)+'px';selectedItem.addClassName(me.itemPreviewClass);var offset=30;var marginTop=((-1*Element.getHeight(selectedItem))+offset)+'px';selectedItem.down('.dashboard__hrn__item__image').style.marginTop=marginTop;var detailsHeight=selectedItem.down('.dashboard__hrn__item__details').getHeight()+offset;if(height<detailsHeight){selectedItem.__originalHeight=height+'px';selectedItem.style.height=detailsHeight+'px';}
selectedItem.__flipped=true;}};R.controls.HotRightNow.prototype.addEventHandlers=function(){var me=this;this.links.each(function(link){link.observe('click',function(e){me.showPreview(link);Event.stop(e);});});this.itemDetails.each(function(element){element.observe('click',function(e){if(!R.utils.eventTriggeredOnElement(Event.element(e),'dashboard__hrn__item__quicknav')){document.location.href=element.getAttribute('data-pattern-url');Event.stop(e);}});});};R.controls.register('js-hot_right_now',R.controls.HotRightNow);R.controls.IconBar=function(element,options){if(!options)options={};this.element=$(element);this.headingSelector=options.headingSelector||'h2';this.itemClassName=options.itemClassName||'iconbar__item';this.highlightedItemClassName=options.highlightedItemClassName||'iconbar__item--highlighted';this.items=$H();this.scheduled=null;this.scheduleTimeout=10;this.initializeItems();this.addEventListeners();this.scrollPositionChanged();};R.controls.IconBar.prototype.initializeItems=function(){var me=this;this.element.getElementsByClassName(this.itemClassName).each(function(item){var headingId=item.href.split('#')[1];me.items[headingId]=item;item.observe('click',function(e){var top=$(headingId).offsetTop-R.navigation.navigationHeight();window.scrollTo(0,top);me.selectedItemChanged(item);Event.stop(e);});});};R.controls.IconBar.prototype.selectedItemChanged=function(selectedItem){var className=this.highlightedItemClassName;this.items.values().each(function(item){item.removeClassName(className);});selectedItem.addClassName(className);};R.controls.IconBar.prototype.cancelScrollPositionChange=function(){if(this.scheduled){window.clearTimeout(this.scheduled);this.scheduled=null;}};R.controls.IconBar.prototype.scheduleScrollPositionChange=function(){this.cancelScrollPositionChange();this.scheduled=window.setTimeout(function(){this.scrollPositionChanged();}.bind(this),this.scheduleTimeout);};R.controls.IconBar.prototype.scrollPositionChanged=function(){var pageTop=(document.scrollingElement||document.documentElement).scrollTop;var threshold=pageTop+(window.innerHeight/2);var previousHeading=null;var headingInViewport=null;var items=this.items;$$(this.headingSelector).each(function(heading){if(heading.id&&items[heading.id]){if(!headingInViewport&&heading.offsetTop>pageTop&&heading.offsetTop<threshold){headingInViewport=heading;}else if(!headingInViewport&&heading.offsetTop<threshold){previousHeading=heading;}}});var currentHeading=headingInViewport||previousHeading;var me=this;if(currentHeading){var item=this.items[currentHeading.id];if(item)me.selectedItemChanged(item);}};R.controls.IconBar.prototype.addEventListeners=function(){var me=this;Event.observe(window,'resize',function(){me.scheduleScrollPositionChange();});Event.observe(window,'scroll',function(){me.scheduleScrollPositionChange();});};R.controls.register('js-icon_bar',R.controls.IconBar);R.controls.PageBar=function(element,options){options=options||{};this.pageBar=$(element);this.loadedClass='is-loaded';this.setWidth(options.container,options.childSelector);this.pageBar.addClassName(this.loadedClass);var me=this;Event.observe(window,'resize',function(){me.setWidth(options.container,options.childSelector);});};R.controls.PageBar.prototype.setWidth=function(container,selector){var rightmost=0;$A(container.children).slice(0,10).each(function(child){if(!child.hasClassName('page_bar')&&selector(child)){var right=Position.cumulativeOffset(child)[0]+Element.getWidth(child)-container.offsetLeft;if(right>rightmost){rightmost=right;}}});this.pageBar.style.width=rightmost+'px';this.pageBar.style.visibility='visible';};R.coreItems=function(){PACK_UNIT_LABEL='Convert to ';THREAD_YARN_WEIGHT_ID=9;sharingLoading=false;socialShareLoading=false;colorwayAutocompleters={};loadedSocialJavascript=false;fiberContentFormIndex=null;yarnProvenanceFormIndex=null;return{initializeCoreItemPage:function(){triggeredMarkdownEditor('comment_text',true);R.controls.updateRatingControls();R.controls.initializeTabBars();R.photos.updateZoomables();R.photos.initializeGallery();editorLoaded();R.coreItems.ieSucks();R.coreItems.chrome33Bug();R.coreItems.initializePacks();var sidebarBoxes=$$('.box--sidebar');if(sidebarBoxes[0])sidebarBoxes[0].addClassName('box--first');R.photos.initializePhotoManager();if(($('journal_tab')||$('posts_tab'))&&$('related_post_options')){var select=$('select_link');new R.controls.MenuField(select,{autoMakeRoom:true,menuContent:$('related_post_options'),tooltips:{},afterSelect:function(feedItemId){var params={};params['feed_item_id']=feedItemId;params['item_type']=select.getAttribute('data-item-type');params['item_id']=select.getAttribute('data-item-id');new Ajax.Request('/related_posts',{parameters:params,method:'POST'});}});}},threadYarnWeightId:function(){return THREAD_YARN_WEIGHT_ID;},ieSucks:function(){if(Browser.isOldMSIE()||Browser.isMSIE8()){$$('select').each(function(select){var container=select.up('.form_select');if(container){container.style.paddingLeft=0;if(container.offsetWidth)select.style.width=(container.offsetWidth-2)+"px";}});}},chrome33Bug:function(){if(navigator.userAgent.indexOf("Chrome/33")>=0){$$('.form_select').each(function(fs){fs.style.height='auto';});}},toggleEditorTools:function(link){if($(document.body).hasClassName('with_action_sheet--edit_tools_action_sheet')){R.controls.hideActionSheet('edit_tools_action_sheet');}else{R.controls.actionSheet('edit_tools_action_sheet');}},addPackUnitTips:function(select){$A(select.options).each(function(option,index){if(index!=select.selectedIndex){if(option.innerHTML.indexOf(PACK_UNIT_LABEL)<0){option.innerHTML=PACK_UNIT_LABEL+option.innerHTML;}}else{option.innerHTML=option.innerHTML.replace(PACK_UNIT_LABEL,'');}});},packChanged:function(select){R.coreItems.addPackUnitTips(select);},packWeightChanged:function(select){var threadSizeClass=select.id.replace('_personal_weight_id','_personal_thread_size');$$('.'+threadSizeClass).each(function(threadSizeField){var show=parseInt(R.utils.selectedValue(select),10)==THREAD_YARN_WEIGHT_ID;if(show){$(threadSizeField).show();$(threadSizeField).focus();}else{$(threadSizeField).hide();}});},updateYarnListType:function(){var yarnListType=$('pattern_yarn_list_type_field');if(yarnListType){if($$('.pattern_yarn_name').size()>=2){yarnListType.show();}else{yarnListType.hide();}}},afterDestroyPack:function(packIndex){new Effect.DropOut('pack_'+packIndex,{afterFinish:function(){Element.remove('pack_'+packIndex);R.coreItems.updateYarnListType();}});},initializePacks:function(){R.coreItems.updateYarnListType();$$('.core_item_select_box_autocomplete').each(Element.hide);$$('select').each(function(select){if(select.name.indexOf('skein_length_units')>=0||select.name.indexOf('skein_weight_units')>=0){R.coreItems.addPackUnitTips(select);if(!select.__initialized){select.__initialized=true;select.observe('change',function(){R.coreItems.packChanged(select);});}}});$$('.thread_size_autocomplete').each(function(autocomplete){if(!autocomplete.__initialized){var input=$(autocomplete).previous('input');var choices=input.getAttribute('data-autocomplete-sizes').split(' ');var ac=new Autocompleter.Local(input,autocomplete,choices,{partialChars:1,minChars:1});}});$$('.pack_personal_weight_id').each(function(weight){var threadSizeClass=weight.id.replace('_personal_weight_id','_personal_thread_size');$$('.'+threadSizeClass).each(Element.hide);if(weight.visible()&&weight.up('.form_select').visible()){R.coreItems.packWeightChanged(weight);}
weight.observe('change',function(){R.coreItems.packWeightChanged(weight);});});},packUnitsPrecision:function(units){if(units=='ounces'){return 2;}else if(units=='yards'||units=='meters'){return 1;}else{return 0;}},packWeightUnitsChanged:function(select,packId,updateTotals){var units=$F(select);var multiplier=(units=='ounces')?GRAMS_TO_OUNCES:OUNCES_TO_GRAMS;var field=$('packs_'+packId+'_skein_weight');if(field.value!=''){field.value=(field.value*multiplier).toFixed(R.coreItems.packUnitsPrecision(units));}
$('packs_'+packId+'_skein_weight_units').selectedIndex=select.selectedIndex;$('packs_'+packId+'_weight_units').selectedIndex=select.selectedIndex;if(updateTotals){R.coreItems.calculatePackTotals(packId);}},packLengthUnitsChanged:function(select,packId,updateTotals){var units=$F(select);var multiplier=(units=='yards')?METERS_TO_YARDS:YARDS_TO_METERS;var field=$('packs_'+packId+'_skein_length');if(field.value!=''){field.value=(field.value*multiplier).toFixed(R.coreItems.packUnitsPrecision(units));}
$('packs_'+packId+'_skein_length_units').selectedIndex=select.selectedIndex;$('packs_'+packId+'_length_units').selectedIndex=select.selectedIndex;if(updateTotals){R.coreItems.calculatePackTotals(packId);}},calculatePackTotals:function(packId){var calculatedTotals=$('packs_'+packId+'_calculated_totals');var weightUnits=$F('packs_'+packId+'_skein_weight_units');var lengthUnits=$F('packs_'+packId+'_skein_length_units');var weight=$F('packs_'+packId+'_skein_weight');var length=$F('packs_'+packId+'_skein_length');var skeins=$('packs_'+packId+'_formatted_skeins').value;var totalWeight=(weight*skeins).toFixed(R.coreItems.packUnitsPrecision(weightUnits));if(!isNaN(totalWeight)&&skeins!=''){$('packs_'+packId+'_calculated_total_weight').innerHTML=totalWeight+" "+weightUnits;$('packs_'+packId+'_total_weight').value=totalWeight;}else{$('packs_'+packId+'_calculated_total_weight').innerHTML="";$('packs_'+packId+'_total_weight').value="";}
var totalLength=(length*skeins).toFixed(R.coreItems.packUnitsPrecision(lengthUnits));if(!isNaN(totalLength)&&skeins!=''){$('packs_'+packId+'_calculated_total_length').innerHTML=totalLength+" "+lengthUnits;$('packs_'+packId+'_total_length').value=totalLength;}else{$('packs_'+packId+'_calculated_total_length').innerHTML="";$('packs_'+packId+'_total_length').value="";}
var both=!isNaN(totalLength)&&!isNaN(totalWeight)&&skeins!='';$('packs_'+packId+'_calculated_total_divider').innerHTML=both?" / ":"";if(skeins!=''&&(!isNaN(totalLength)||!isNaN(totalWeight))){if(!Element.visible(calculatedTotals)){Element.show(calculatedTotals);}}},editPackTotals:function(packId){$('packs_'+packId+'_formatted_skeins').value='';$('packs_'+packId+'_skein_priority').value='false';Element.hide('packs_'+packId+'_skein_field');Element.hide('packs_'+packId+'_units');Element.show('packs_'+packId+'_totals');},editPackSkeins:function(packId){$('packs_'+packId+'_skein_priority').value='true';Element.show('packs_'+packId+'_skein_field');Element.show('packs_'+packId+'_units');Element.hide('packs_'+packId+'_totals');},clearColorwayChoices:function(){$$('.core_item_select_box_autocomplete').each(function(update){update.remove();});colorwayAutocompleters={};},setColorwayChoices:function(packId,options){var field=null;var update=null;if(packId==null){field=$('colorway_field');packId=0;}else{field=$('packs_'+packId+'_colorway_field');}
var colorwayInput=field.down('input.colorway');var autocompleter=colorwayAutocompleters[packId];if(options.length>0){colorwayInput.addClassName('fake_form_select');update=field.down('.select_box_autocomplete');if(!update){update=document.createElement('div');update.className='core_item_select_box_autocomplete select_box_autocomplete autocomplete';field.appendChild(update);field.style.zIndex=1000;}
if(!autocompleter){autocompleter=new Autocompleter.SelectBox(colorwayInput,null,update,options);colorwayAutocompleters[packId]=autocompleter;colorwayInput.onfocus=colorwayInput.onclick=function(){autocompleter.activate();autocompleter.show();};}else{autocompleter.setChoices(options);}}else{if(autocompleter)autocompleter.setChoices([]);colorwayInput.removeClassName('fake_form_select');}
var popover=field&&field.up('.popover');if(popover&&update){update.style.zIndex=parseInt(popover.getStyle('z-index'))+1;}},updateYarnSummary:function(id){var yarnSummary=$('yarn_'+id+'_summary');if(yarnSummary){var container=yarnSummary.up();var content=yarnSummary.down('.yarn_summary_content');new Ajax.Updater(container,'/yarns/library/'+id+"/summary",{onComplete:function(){new Effect.Highlight(content,{duration:0.5});R.controls.updateRatingControls(container);}});}},updatePatternSummary:function(id){new Ajax.Updater('pattern_summary','/patterns/library/'+id+"/summary",{onComplete:function(){new Effect.Highlight('pattern_summary_content',{duration:0.5});R.controls.updateRatingControls('pattern_summary');}});},shareThis:function(){if(!sharingLoading){if($('prepare_share')){R.popover.reopen();}else{sharingLoading=true;var url=prependPath('prepare_share');new Ajax.Request(url,{method:'get'});}}},socialShare:function(e){var event=e||window.event;var existing=$('social_sharing');if(existing){R.popover.reopen();Event.stop(event);}else{new Ajax.Request(prependPath('social_share'),{method:'get'});}},showShareOptions:function(){$('share_options_links').hide();$('sharing_details').hide();$('share_options').show();},cancelShareOptions:function(){$('share_options').hide();$('share_options_links').show();$('sharing_details').show();},sharingChanged:function(){var url=prependPath('update_share');var sharing=R.utils.selectedValue('sharing');$('cancel_share').innerHTML="<img src='/images/spinner.gif' />";new Ajax.Request(url,{method:'post',postBody:"sharing="+sharing});},enableSocialSharing:function(){if(loadedSocialJavascript){if(window.FB&&FB.XFBML)FB.XFBML.parse();if(window.twttr)twttr.widgets.load();R.popover.recalculateHeight();}else{loadedSocialJavascript=true;var scripts=['//assets.pinterest.com/js/pinit.js','//platform.twitter.com/widgets.js'];if(R.preferences.userPreference('disable-facebook')!='1'){scripts.push("//connect.facebook.net/en_US/sdk.js#xfbml=1&appId=1381722238754999&version=v2.0");}
$script(scripts,function(){R.popover.recalculateHeight();});}
sharingLoading=false;},setupFiberAutocompletes:function(categoryJson,index){var noIndex=typeof index=='undefined';if(!categoryJson){categoryJson=cachedCategoryJson;}else{cachedCategoryJson=categoryJson;}
$$('.fiber_autocomplete').each(function(field,i){if(!field.__has_fiber_autocomplete&&(noIndex||index==i)){field.__has_fiber_autocomplete=true;var element=field.down('.fiber_category');var elementForId=field.down('.fiber_category_id');var update=document.createElement('div');update.className='core_item_select_box_autocomplete select_box_autocomplete autocomplete';field.appendChild(update);if(element.up('.clean_dialog')){update.style.zIndex=10000;}
var ac=new Autocompleter.SelectBox(element,elementForId,update,categoryJson);element.onfocus=element.onclick=function(){ac.activate();ac.show();};}});},addFiberContentForm:function(yarnId){if(!fiberContentFormIndex||yarnId){fiberContentFormIndex=$$('#fiber_content_forms .fiber_content_form').length;}
var url="add_fiber_content_form?index="+(++fiberContentFormIndex);if(yarnId)url="/yarns/library/"+yarnId+"/"+url;new Ajax.Request(url);},addYarnProvenanceForm:function(yarnId,options){if(!yarnProvenanceFormIndex||yarnId){yarnProvenanceFormIndex=$$('#yarn_provenance_forms .yarn_provenance_form').length;}
var url="add_yarn_provenance_form?index="+(yarnProvenanceFormIndex++);if(yarnId)url="/yarns/library/"+yarnId+"/"+url;new Ajax.Request(url,options);},deleteFiberContentForm:function(caller){var subform=$(caller).up(".fiber_autocomplete");var nameField=subform.down('.fiber_category');var percentageField=subform.down('.percentage');var idField=subform.down('.fiber_category_id');if(nameField.value==''||confirm("Are you sure that you want to delete this selection?")){nameField.value=percentageField.value=idField.value='';new Effect.DropOut(subform);if(subform.down('label').innerHTML.strip()!=''){subform.next('.fiber_autocomplete').down('label').innerHTML='Fiber content';}}},deleteYarnProvenanceForm:function(caller){var subform=$(caller).up(".yarn_provenance_form");if(confirm("Are you sure that you want to delete this item?")){subform.getElementsBySelector('input').each(function(input){input.value='';});subform.getElementsBySelector('select').each(function(select){select.options[0].selected=true;});new Effect.DropOut(subform);}},castOn:function(baseUrl,params){new Ajax.Request(baseUrl+'/cast_on',{method:'get',parameters:params});},initializeAudioAttachments:function(){R.controls.initializeImageFields();R.controls.SoundButton.initialize();if($('pending_audio_attachment')){R.coreItems.pendingAudioAttachment($('pending_audio_attachment').getAttribute('data-job-key'));}
if(window.loudlinks){loudlinks(document);}},pendingAudioAttachment:function(jobKey){new Ajax.Request('/audio_attachments/pending?key='+jobKey,{method:'get'});}};}();R.corrections=function(){return{add:function(patternSourceId){new Ajax.Request('/corrections/new?pattern_source_id='+patternSourceId);},batchEdit:function(patternSourceId,url){var url='/corrections/batch_edit?pattern_source_id='+patternSourceId+'&url='+encodeURIComponent(url);new Ajax.Request(url,{method:'get'});},cancelModify:function(patternSourceId){new Ajax.Request('/corrections/cancel_modify?pattern_source_id='+patternSourceId,{method:'get'});}}}();R.deliveries=function(){var dropboxScriptLoaded=false;return{initialize:function(){if($('save_to_dropbox')){R.deliveries.initializeDropboxSaver();}
$$('.delivery__collapse').each(function(collapser){collapser.observe('click',function(){var container=collapser.up('.delivery__collapsable');container.toggleClassName('delivery__collapsable--collapsed');});});R.controls.initializeOptionPickers();},languageChanged:function(select,anchor){var params=R.utils.currentParameterHash();params[select.name]=R.utils.selectedValue(select);document.location.href='?'+params.toQueryString()+'#'+anchor;},stow:function(link,deliveryId,token){var indicator=link.down('img.indicator');if(!indicator){link.innerHTML=R.controls.tinyLoaderHTML('indicator')+link.innerHTML;}
var url='/deliveries/'+deliveryId+'/stow?t='+token;new Ajax.Request(url);},prepareAddToLibrary:function(deliveryId,token){var url='/deliveries/'+deliveryId+'/prepare_add_to_library';if(token){url+='?t='+token;}
RedBox.open('prepare_add_to_library',url,{fade:true});},initializeDropboxSaver:function(){var url=R.utils.prependPath('dropbox_options').replace('/updates/','/');var token=document.location.search.parseQuery()['t'];var params={t:token};new Ajax.Request(url,{parameters:params,onComplete:function(xhr){var options=xhr.responseText.evalJSON();console.log(options);var script=document.createElement('script');script.type='text/javascript';script.async=true;script.id='dropboxjs';script.setAttribute('data-app-key',options['dropbox_app_key']);script.onload=function(){R.deliveries.dropboxScriptLoaded(options.files);};var firstScript=document.getElementsByTagName('script')[0];firstScript.parentNode.insertBefore(script,firstScript);script.src='https://www.dropbox.com/static/api/2/dropins.js';}});},dropboxScriptLoaded:function(fileOptions){if(Dropbox&&Dropbox.isBrowserSupported()){var options={files:fileOptions,success:function(){},progress:function(progress){},cancel:function(){},error:function(errorMessage){}};var button=Dropbox.createSaveButton(options);document.getElementById("save_to_dropbox").appendChild(button);}},inLibrarySelected:function(ticky){var item=$(ticky).up('.ticky_item');R.controls.insertAjaxIndicator(item);},confirmRemoveFromLibrary:function(deliveryId,productId,url){var params={'delivery_id':deliveryId,'product_id':productId};if(confirm('Removing this item from your library will also remove any sets, notes, or other information that you added to it. Are you sure that you want to do this?')){params['confirmed']=1;params['store_in_library']=0;}
new Ajax.Request(url,{parameters:params,method:'POST'});}};}();R.designers=function(){return{initialize:function(){R.coreItems.initializeAudioAttachments();R.designers.initializeResponsive();},initializeResponsive:function(){R.controls.initializeTabBars();R.controls.initializeOptionPickers();R.photos.setGridPhotoDimensions();Event.observe(window,'resize',R.photos.setGridPhotoDimensions);R.notebook.initializeMobileButtonBox();},changeSort:function(select){var sort=select.options[select.selectedIndex].value;var url="?sort="+sort+"#designs";document.location.replace(url);},ignoreConfirmed:function(patternAuthorPermalink){$('quicknav').hide();$$('a').each(function(link){var pattern=link.up('.pattern');if(!pattern)pattern=link.up("div[id*='pattern_']");if(pattern&&link.href.indexOf('/designers/'+patternAuthorPermalink)>=0){new Effect.DropOut(pattern);}});}};}();R.drafts=function(){var drafts=[];var interval=100;var running=false;var debug=false;var draftIdSuffix=0;return{initialize:function(){R.drafts.wmdLoaded();},wmdLoaded:function(){if(typeof(Attacklab)!='undefined'&&Attacklab&&Attacklab.textarea){R.drafts.enableDraft(Attacklab.textarea);}},setDebug:function(d){debug=d;},generateDraftId:function(){return(new Date()).getTime()+"-"+(draftIdSuffix++);},enableDraft:function(textarea){textarea=$(textarea);if(!textarea||!textarea.hasClassName('draft_support')){return;}
if(textarea.__draft_id){return;}
textarea.__draft_id=R.drafts.generateDraftId();var form=textarea.up('form');if(form){Event.observe(form,'submit',function(){R.drafts.cancelDraft(textarea);});form.getElementsBySelector('a').each(function(a){if(a.hasClassName('closer')||(a.innerHTML.indexOf('cancel')===0)){Element.observe(a,'click',function(){R.drafts.cancelDraft(textarea);});}});var actionSheet=form.up('.action_sheet');if(actionSheet){actionSheet.getElementsBySelector('.clicker_tool--cancel a').each(function(a){Element.observe(a,'click',function(){R.drafts.cancelDraft(textarea);});});}
if(textarea.value===''){R.drafts.recoverDraft(textarea);}
R.drafts.addWatch(textarea);}},recoverDraft:function(textarea){var form=textarea.up('form');var pageHref=window.location.href;var formHref=form.action;var namespace="";var namespaceField=form.down('.draft_namespace');if(namespaceField){namespace=namespaceField.value;}
var drafts=R.Storage.hgetall("drafts");drafts.sort(function(draftA,draftB){return draftB.time-draftA.time;});var matches=$A(drafts).findAll(function(draft){return draft.pageHref==pageHref&&draft.formHref==formHref&&draft.namespace==namespace;});if(matches.length>0){if(textarea.value===''){textarea.value=matches[0].content;R.utils.setSelectionRange(textarea,textarea.value.length);R.Storage.hdel("drafts",matches[0].id);}}},addWatch:function(textarea,draftId){var form=textarea.up('form');var drafted={form:form,textarea:textarea,draftId:textarea.__draft_id,content:textarea.value};drafts.push(drafted);if(!running){running=true;setInterval(R.drafts.storeDrafts,interval);}},storeDrafts:function(){$A(drafts).each(function(draft){var textarea=draft.textarea;if(textarea&&textarea.visible()&&textarea.value!==""&&textarea.value!=draft.content){R.drafts.storeDraft(draft.draftId,draft.textarea);draft.content=textarea.value;}});},storeDraft:function(id,textarea){var form=textarea.up('form');var data={id:id,pageHref:window.location.href,formHref:form.action,inputId:textarea.id,content:textarea.value,time:(new Date()).getTime(),namespace:""};var namespaceField=form.down('.draft_namespace');if(namespaceField){data.namespace=namespaceField.value;}
R.Storage.hset("drafts",id,data);R.Storage.htrim("drafts",32);},cancelDraft:function(textarea){if(textarea&&$(textarea).hasClassName('draft_support')){var newDrafts=[];var deleteDrafts=[];$A(drafts).each(function(draft){if(draft.draftId!=textarea.__draft_id){newDrafts.push(draft);}else{deleteDrafts.push(draft);}});drafts=newDrafts;deleteDrafts.each(function(draft){R.Storage.hdel("drafts",draft.draftId);});}}};}();R.editing=function(){return{popupDiff:function(form){form=$(form);R.utils.popup({url:form.action+"?"+$H(Form.serialize(form)).toQueryString(),width:850});}}}();R.events=function(){return{initialize:function(){R.groups.initialize();if($$('form.event_form').first()){R.events.initializeEventForm();}
if($('photo_browser')){editorLoaded();}
R.notebook.initializeMobileButtonBox();R.controls.initializeTabBars();R.photos.updateZoomables();R.photos.initializeGallery();R.photos.initializePhotoManager(function(){if($('event_photos')){new Ajax.Request(R.utils.prependPath('refresh_photos'));}});},initializeEventForm:function(){var checkSetting=function(){var form=$$('.event_form').first();var value=R.utils.selectedValue('event_event_setting_id');form.removeClassName('event_form--medium_1');form.removeClassName('event_form--medium_2');form.addClassName('event_form--medium_'+value);};checkSetting();$('event_event_setting_id').observe('change',checkSetting);$('event_event_setting_id').observe('click',checkSetting);$('event_event_setting_id').observe('keyup',checkSetting);$('event_start_timezone').observe('change',function(){R.utils.selectOption('event_end_timezone',R.utils.selectedValue('event_start_timezone'));});$('event_start_date').observe('blur',function(){R.calendar.normalizeDate($('event_start_date'));});$('event_end_date').observe('change',function(){R.calendar.normalizeDate($('event_end_date'));});$$('.form_select option').each(function(option,index){if(index==0&&option.value==''){option.setAttribute('disabled',true);option.setAttribute('hidden',true);}});},prepareAttend:function(){new Ajax.Request(R.utils.prependPath('prepare_attend'));},unattend:function(){new Ajax.Request(R.utils.prependPath('unattend'));},selectAttendance:function(clicker){var vote=clicker.id.split('_')[0];var url=R.utils.prependPath("attend?vote="+vote);new Ajax.Request(url);},clearAttendance:function(){var url=R.utils.prependPath("attend?vote=");new Ajax.Request(url);},smartTagHelp:function(event){RedBox.open('event_help','/help/dialog?id=help/tags/smart-tags');},connectGroup:function(){if(Element.visible('group_connector')){new Effect.SlideUp('group_connector');}else{new Effect.SlideDown('group_connector');}},setSmartTag:function(tag){},moreUpcomingEvents:function(a){$(a).hide();$$('#upcoming_events tr','#upcoming_events .resizable_table__row').each(function(tr){tr.show();});}};}();var ExclusiveAction=function(criticalSection){this.attempt=function(start){for(var j=start;j!=null;j=ExclusiveAction.next(j.id)){if(j.enter||(j.number&&(j.number<this.number||(j.number==this.number&&j.id<this.id)))){var me=this;return setTimeout(function(){me.attempt(j);},200);}}
this.criticalSection();this.number=0;ExclusiveAction.waitList[this.id]=null;}
this.id=++ExclusiveAction.commandID;this.criticalSection=criticalSection;ExclusiveAction.waitList[this.id]=this;this.enter=true;this.number=(new Date()).getTime();this.enter=false;this.attempt(ExclusiveAction.next());}
ExclusiveAction.waitList=new Object();ExclusiveAction.commandID=0;ExclusiveAction.next=function(k){for(i in ExclusiveAction.waitList){if(!k){return ExclusiveAction.waitList[i];}
if(k==i){k=null;}}
return null;}
R.favorites=function(){var ajaxIndicator='<div style="text-align: center;">'+R.controls.tinyLoaderHTML()+'</div>';var quickEditing=null;var bundleAutocompleters={};var mobileExperience=null;return{initialize:function(){var organizeMode=$('organize_tab')&&$('organize_tab').hasClassName('selected');if(R.swatch.isSwatching('FRONTEND12')){organizeMode=$('current')&&$('current').down('.organize_tab');}
if(!organizeMode&&$('combined_bookmarks')&&$('combined_bookmarks').getAttribute('data-current-user')){R.favorites.initializeHoverTools();}
if(R.swatch.isSwatching('FRONTEND12')){R.controls.initializeTabBars();$$('#filter option').each(function(option){option.setAttribute('data-value',option.value);option.value='';});if($('filter')){$('filter').onchange=function(){var option=R.utils.selectedOption($('filter'));var url=option.getAttribute('data-value');document.location.href=url;};}}
R.favorites.resizeTextField();Event.observe(window,'resize',R.favorites.resizeTextField);R.favorites.initializeResponsive();},initializeResponsive:function(){mobileExperience=new R.controls.MobileExperience({lazyLoadImages:{selector:'.photo_gallery__background',src:'data-slideshow-url',loadInvisible:false},onMobileView:function(){R.controls.HoverTools.locked=true;if(this.initialView=='desktop'){document.location.href=document.location.href;}
$('favorites_panel').removeClassName('with_tag_sidebar');$('mobile_favorites_sidebar').appendChild($('favorites_sidebar_content'));},onDesktopView:function(){R.controls.HoverTools.locked=$(document.body).hasClassName('with_touch');$('favorites_sidebar').appendChild($('favorites_sidebar_content'));if($$('.blazy').first()){this.initializeBlazy();}}});$$('.ellipsis_menu').each(function(element){new R.controls.EllipsisMenu(element);});$$('.touch_hoverable').each(function(element){Event.observe(element,'touchstart',function(e){if(!R.utils.eventTriggeredOn(e,'popover_list')){element.toggleClassName('hover');Event.stop(e);}});});if(Browser.responsiveBreakpoint()){$$('.touch_gallery').each(function(gallery){var photoCount=gallery.getAttribute('data-photo-count');if(photoCount>1){var bookmarkId=getId(gallery.up('.favorite_square'));new R.controls.TouchGallery(gallery,{itemCount:photoCount,itemClassName:'photo_border',useDots:true,loadItemUrl:'/bookmarks/'+bookmarkId+'/medium_photos'});}});}
$$('.pageless_gallery').each(function(container){var square=container.up('.bundle_square');var wishlist=square.hasClassName('bundle_square--wishlist');var bundleId=getId(square);var pageSize=wishlist?30:6;if(!wishlist){container.observe('click',function(e){var element=Event.element(e);if(element.hasClassName('pageless_gallery__item')){var itemId=getId(element);document.location.href="/bundled_items/"+itemId+"/redirect_to_item";}
Event.stop(e);});}
new R.controls.PagelessGallery(container,{itemClass:'square_thumbnail',loadPageUrl:"/bundles/"+bundleId+"/item_thumbnails",pageSize:pageSize});});var query=$('q');if(query){q.observe('focus',function(){$('favorites_search_options').show();});q.observe('blur',function(){setTimeout(function(){$('favorites_search_options').hide();},250);});}},mobileViewChanged:function(){$('favorites_form').submit();},initializeHoverTools:function(){R.controls.HoverTools.applyWithSelector('.favorite_square','.photo_frame',{tools:{edit:function(element){R.favorites.editWithFrame(getId(element));return false;},confirmedDelete:function(element){R.favorites.destroy(getId(element));}},touchTools:{view:null},deleteConfirmation:'Are you sure that you want to delete this favorite?'});R.controls.HoverTools.applyWithSelector('.bundle_square','.photo_frame',{tools:{edit:function(element){R.favorites.editBundleWithFrame(getId(element));return false;},confirmedDelete:function(element){R.bundles.destroy(getId(element));}},touchTools:{view:null},deleteConfirmation:'Are you sure that you want to delete this bundle?'});},resizeTextField:function(){var query=$('q');if(R.swatch.isSwatching('FRONTEND12')){query.style.width='';return;}
if(query){query.style.width=(Element.getWidth('combined_bookmarks')-440)+'px';query.up('form').style.visibility='visible';}},showTags:function(){$('favorites_panel').toggleClassName('with_tag_sidebar');$('show_tags').toggleClassName('selected');R.favorites.resizeTextField();if(!Browser.responsiveBreakpoint()){R.preferences.toggle('show_tag_sidebar')}},autocompleteUpdated:function(selected){var form=$('q').up('form');var text=Element.collectTextNodesIgnoreClass(selected,'informal').replace(/:\s+/,':').replace(/^\s+|\s+$/gm,'');var prefixAndTerm=text.split(/:(.+)/);if(prefixAndTerm.length>1){var node=$(prefixAndTerm[0]+"_name");}else{var node=$(prefixAndTerm[0]);prefixAndTerm[1]=1;}
if(prefixAndTerm[0]=='tag'){var delineater=" ";}else if(prefixAndTerm[0]=='bundle'){var delineater="|";}
if(node.value.length>1){node.value+=delineater;}
node.value+=prefixAndTerm[1];$('q').value='';form.submit();return true;},removeSearchTerm:function(e,type){var form=$('q').up('form');var filter=e.up('.filter_box');if(['bundle','tag'].indexOf(type)>-1){var node=$(type+"_name");node.value='';}
filter.parentNode.removeChild(filter);form.submit();return true;},bundleFromIndex:function(results){if($('popover')&&$('popover').visible()){R.popover.close();}
var url='/bundles/new_from_faves';if(results){url+="?results=true";}
RedBox.open('new_bundle_dialog',url,{fade:false,draggable:true,onClose:R.favorites.bundleFromIndexComplete,onComplete:function(){mobileExperience.activatePanel('new_bundle');R.favorites.fillItemsSearchTerms();$('bundle_form_name').focus();}});},fillItemsSearchTerms:function(){var fields=['tag_name','bundle_name','q'];for(var i=0;i<fields.length;i++){$('dialog_'+fields[i]).value=$(fields[i]).value;}
if(document.URL.search("untagged=1")>0){$('dialog_untagged').value=1;}
return true;},showDialogSpinner:function(){$('dialog_spinner').show();},bookmarkUrl:function(bookmarkId){var username=document.location.href.match(/\/people\/(.*?)\/favorites/)[1];var url="/people/"+username+"/bookmarks/"+bookmarkId;return url;},focus:function(id){var text=$('bookmark_'+id+'_comments');text.focus();if(text.value&&text.value.length>0){R.utils.setSelectionRange(text,text.value.length);}},add:function(url,options){var indicator=options&&options.indicator;var buttonBox=$('button_box');var quicknav=$('quicknav');var notebookIndicator=options&&options.notebookIndicator;if(quicknav||buttonBox||notebookIndicator){var params={};if(quicknav||notebookIndicator)params['quick_edit']=1;if(buttonBox)params['button_box']=1;if(notebookIndicator)params['notebook_indicator']=1;if(indicator)params['indicator']=1;var button=$$('.favorites_button').first();if(button&&button.getAttribute('data-tap')=='double'){params['no_dialog']=1;}
R.favorites.heartPuff();new Ajax.Request(url,{asynchronous:true,parameters:params,evalScripts:true,method:'post'});}else{R.popover.pop($('bookmark'),ajaxIndicator,{orientation:'right',promptOnUnsavedChanges:true});setTimeout(function(){new Ajax.Updater('bookmark_summary',url,{asynchronous:true,evalScripts:true,method:'post'});},500);}},afterSave:function(){try{RedBox.close();}catch(error){}
if(R.swatch.isSwatching('FRONTEND12')){if($(document.body).hasClassName('search')){R.controls.closeActionSheets();}
new R.controls.Toast({type:'success'});}},remove:function(username,bookmarkId,options){if(options&&options.bookmarkableType=='ForumPost'){return R.favorites.removeForumFavorite(options.bookmarkableId);}
var title=options.title;if(!title)title='this';var msg="Are you sure that you want to remove "+title+" from your favorites?";if(confirm(msg)){R.popover.formSaved();var url="/people/"+username+"/bookmarks/"+bookmarkId;if(options&&options.inplace){url+="?inplace=1";}
if(R.swatch&&R.swatch.isSwatching('FRONTEND12')){if($(document.body.hasClassName('notebook--favorites')&&Browser.responsiveBreakpoint())){url+=(url.indexOf('?')<0?'?':'&')+'notebook=1';}}
$('bookmark_removal').innerHTML=ajaxIndicator;setTimeout(function(){new Ajax.Request(url,{method:'delete'});},500);}},destroy:function(bookmarkId,prompt){var url=R.favorites.bookmarkUrl(bookmarkId);new Ajax.Request(url,{method:'delete'});},toggleFavorite:function(username,addUrl,caller){if(caller.up('#search_results_container')){R.utils.saveScrollPosition();}
if($(caller).hasClassName('notebook_indicator--true')){R.favorites.quickEdit(username,caller.getAttribute('data-bookmark-id'));}else{R.favorites.add(addUrl,{notebookIndicator:caller});}},editComment:function(username,bookmarkId,options){var url="/people/"+username+"/bookmarks/"+bookmarkId+"/edit_comment";new Ajax.Request(url,{method:'get'});},editBundleNotes:function(bundleId){var url="/bundles/"+bundleId+"/edit_notes";new Ajax.Request(url,{method:'get'});},refreshSidebar:function(){if($('favorites_sidebar')){var href=window.location.href.split('?');var url=href[0];var qs=href[1];if(qs==null){qs="";}
var parts=url.split('/favorites');var base=parts[0]+'/favorites/refresh_sidebar';var action=parts[1];if(action==null){action='index';}else{action=action.replace('/','');}
new Ajax.Request(base+"?for="+action+"&"+qs,{method:'get'});}},editTags:function(id,base){new Ajax.Request(base+'/'+id+'/edit_tags',{method:'get'});},heartPuff:function(){var heartpuffImage=$$('.favorites_button img.heartpuff__image').first();var heart=$$('.favorites_button img').first();if(heart&&heartpuffImage){var heartPos=Position.cumulativeOffset(heart);var img=document.createElement('IMG');img.src=heartpuffImage.src;img.style.position='absolute';img.style.width='16px';img.style.height='16px';img.style.top=heartPos[1]+'px';img.style.left=heartPos[0]+'px';document.body.appendChild(img);new R.favorites.HeartPuff(img);}},initializeBundleSelection:function(initializeFromFields){var url=$('bookmark_form').action;url=url.replace('/update_popover','/bundle_selection');new R.controls.Selectables($$('.bundle_selector li'),{form:$('bookmark_form'),fieldName:'bundle_id_list',url:url,initializeFromFields:initializeFromFields});},quickEdit:function(username,bookmarkId,location){if($('popover')&&$('popover').visible()&&$('popover').down('#inplace_tag_editor')){R.popover.close();Element.remove($('inplace_tag_editor'));}
if(quickEditing!=bookmarkId){var position=null;var button=$$('#button_box .favorites_button').first();if(button&&!$('button_box').hasClassName('left_oriented')){position={left:(button.offsetLeft-520)+'px',top:(button.offsetTop-30)+'px'};}
var url='/people/'+username+'/bookmarks/'+bookmarkId+'/dialog';if(location){url+='?location='+location;}
RedBox.open('bookmark_dialog',url,{fade:false,draggable:true,actionSheet:true,position:position,onClose:R.favorites.quickEditComplete,onComplete:function(){R.favorites.initializeBundleSelection();if(!Browser.hasTouchEvents()&&!Browser.responsiveBreakpoint()){if(!document.body.hasClassName('topics')){$('bookmark_form').down('.comments_field').focus();}}
if(R.navigation.compressedNavigationEnabled()){R.utils.scrollToTop();}
if(!R.navigation.compressedNavigationEnabled()){var dialog=$$('.clean_dialog').last();dialog.parentNode.style.width=Element.getWidth(dialog.parentNode)+'px';RedBox.makeDraggable(dialog,'drag_bar');}}});quickEditing=bookmarkId;}else{quickEditing=null;}},quickEditComplete:function(){quickEditing=null;},editWithFrame:function(bookmarkId,username){if(R.swatch&&R.swatch.isSwatching('FRONTEND12')){if(Browser.responsiveBreakpoint()&&username){R.favorites.quickEdit(username,bookmarkId,'notebook');return false;}}
R.controls.applyEditFrame($('bookmark_'+bookmarkId),'editing_'+bookmarkId);var url=R.favorites.bookmarkUrl(bookmarkId)+"/edit_with_frame";new Ajax.Request(url,{method:'get',onComplete:function(){}});},editBundleWithFrame:function(bundleId){var actionSheet=null;if(R.swatch&&R.swatch.isSwatching('FRONTEND12')&&Browser.responsiveBreakpoint()){actionSheet=R.controls.buildActionSheet(null,'fullscreen');var existing=$('edit_frame_editing_'+bundleId);if(existing)existing.remove();}
R.controls.applyEditFrame($('bundle_'+bundleId),'editing_'+bundleId,{parentNode:actionSheet});var url="/bundles/"+bundleId+"/edit_with_frame";new Ajax.Request(url,{method:'get',onComplete:function(){if(actionSheet){R.controls.actionSheet(actionSheet);}}});},updatedBundleWithFrame:function(){if(R.swatch&&R.swatch.isSwatching('FRONTEND12')&&Browser.responsiveBreakpoint()){R.controls.closeActionSheets();new R.controls.Toast({type:'success'});}},showBundlePhotoSelector:function(bundleId){var photos=$('cover_photos_'+bundleId);photos.show();R.utils.makeRoom(photos.up('.edit_frame'));new R.controls.Selectables($$('#cover_photos_'+bundleId+' img'),{form:photos.up('form'),fieldName:'cover_photo_id'});},bundlePhotoSelected:function(bundleId,content){var bundle=$('bundle_'+bundleId);var photo=bundle.down('.zoomable_photo');contentElement=document.createElement('DIV');contentElement.style.display='none';contentElement.innerHTML=content;document.body.appendChild(contentElement);photo.innerHTML=contentElement.down('.zoomable_photo').innerHTML;document.body.removeChild(contentElement);},pop:function(content,targetId){var orientation='right';var anchor=$("fave_"+targetId)||$('bookmark_'+targetId);if(!anchor&&$('button_box'))anchor=$("button_box").down('a.favorites_button');if(!anchor)anchor=$("bookmark_summary");if(anchor&&Position.positionedOffset(anchor)[0]<400){orientation='left';}
R.popover.pop(anchor,content,{orientation:orientation,'promptOnUnsavedChanges':true});},searchPopover:function(options){var url=R.utils.prependPath('advanced_search',true).replace('/bundles/','/favorites/');url+='?'+$H(options).toQueryString();new Ajax.Request(url,{method:'GET',onComplete:function(){mobileExperience.activatePanel('advanced_search');}});},addForumFavorite:function(forumPostId){var url="/forum_posts/"+forumPostId+"/bookmark";new Ajax.Request(url,{method:'post'});},editForumFavorite:function(forumPostId){var url="/forum_posts/"+forumPostId+"/edit_bookmark";new Ajax.Request(url,{method:'get'});},removeForumFavorite:function(forumPostId){if(confirm("Are you sure that you want to remove this forum post from your favorites?")){var url="/forum_posts/"+forumPostId+"/delete_bookmark";new Ajax.Request(url,{method:'post'});}},setupBundleAutocompletes:function(bundleJson,bookmarkId){var field=null;if(bookmarkId){field=$('edit_frame_editing_'+bookmarkId).down('.bundle_autocomplete');}else{field=$$('.bundle_autocomplete')[0];}
var element=field.down('.bundle_name');var bookmark_id=field.up('.edit_frame_content').id.split('_')[1];var onSelect=function(id,content,autocompleter){var item_id=field.down('.item_id').value;var item_type=field.down('.item_type').value;var spinner=$('spinner_'+bookmark_id);spinner.show();if(document.body.hasClassName('search')){var src='Search';}else{var src='Bookmark';}
var url='/bundles/'+id+'/add_item';var params={'item_id':item_id,'item_type':item_type,'src':src,'bookmark_id':bookmark_id};if(!id&&bookmark_id){url='/bundles/create_with_bookmark?bookmark_id='+bookmark_id;params.name=field.down('.bundle_name').value;}
bundleAutocompleters[bookmark_id].updateCreateClicker();new Ajax.Request(url,{method:'post',parameters:params,onComplete:function(){spinner.hide();element.value="";bundleAutocompleters[bookmark_id].addPlaceholder();}});var current_choices=autocompleter.options.items;for(var i=0;i<current_choices.length;i++){if(current_choices[i].id==id){current_choices.splice(i,1);}}};var updateCreateClicker=function(content){if(content=='<ul></ul>'){$('create_clicker').show();$('create_clicker').onclick=function(){bundleAutocompleters[bookmark_id].selectCustomEntry();}
element.addClassName('with_create_clicker');}else{$('create_clicker').hide();element.removeClassName('with_create_clicker');}};var update=document.createElement('div');update.className='select_box_autocomplete autocomplete edit_frame';field.appendChild(update);var placeholder=bundleJson.length==0?'Enter a bundle name...':'Select a bundle or enter a name...';var ac=new Autocompleter.SelectBox(element,onSelect,update,bundleJson,{acceptCustomEntry:true,beforeUpdateChoices:updateCreateClicker,placeholderText:placeholder});element.onfocus=element.onclick=function(){ac.activate();ac.show();};bundleAutocompleters[bookmark_id]=ac;bundleAutocompleters[bookmark_id].updateCreateClicker=updateCreateClicker;},updateAfterDeleteItem:function(bundledItemId,bundleId,bundleJson,bookmarkId){var item=$('bundled_item_'+bundledItemId);if(item){item.parentNode.removeChild(item);}
var bundle=$('bundle_'+bundleId+'_membership');if(bundle){bundle.parentNode.removeChild(bundle);}
R.favorites.updateBundleAutocompletes(bundleJson,bookmarkId)},updateBundleAutocompletes:function(bundleJson,bookmarkId){var ac=bundleAutocompleters[bookmarkId];ac.setChoices(ac.options.items.concat(bundleJson));var x=window.getComputedStyle($$('.bundle_autocomplete')[0]).display;if(x=='none'){R.favorites.showBundleAutocompletes();}},showBundleAutocompletes:function(){var field=$$('.bundle_autocomplete')[0];field.show();},editBundledItemNotes:function(link){$(link).up('.field').hide();$(link).up('.field').next('.field').show();}};}();R.favorites.HeartPuff=function(element){element=$(element);var oldStyle={opacity:element.getInlineOpacity(),position:element.getStyle('position'),top:element.style.top,left:element.style.left,width:element.style.width,height:element.style.height};return new Effect.Parallel([new Effect.Scale(element,800,{sync:true,scaleFromCenter:true,scaleContent:true,restoreAfterFinish:true}),new Effect.Opacity(element,{sync:true,to:0.0})],Object.extend({duration:1.0,beforeSetupInternal:function(effect){Position.absolutize(effect.effects[0].element);},afterFinishInternal:function(effect){effect.effects[0].element.hide().setStyle(oldStyle);}},arguments[1]||{}));};R.featuredPhotos=function(){return{unlink:function(id,patternName,patternPhotoCount){var message="Are you sure that you want to remove this photo from the "+patternName+" pattern page?"
message+="\n\nThis can't be undone."
if(confirm(message)){var url=R.utils.prependPath(id+"/unlink",true);new Ajax.Request(url,{method:'post'});}}}}();R.fiberStash=function(){var tooltips={};var fiberSelectorIndex=null;return{initialize:function(){R.coreItems.initializeCoreItemPage();R.notebook.initializeNotebookNavigation();if($$('body.notebook #fiber_stash_panel').first()){R.notebook.changeMobileViewUnless('thumbnail',function(){return $$('.grid_photo').first();});}
if($('edit_panel')){R.fiberStash.updateUnitLabels();R.fiberStash.attachUnitChangeEvents();if($('pattern_attribute_options')){R.controls.initializeAttributeMenus('pattern_attribute_options','fiber_attribute_list',{tooltips:tooltips});}}},setTooltips:function(tips){tooltips=$H(tips);},toggleSearchToolbar:function(){$('fiber_stash_notebook_search').toggleClassName('rsp_hidden');},deleteFiberPackForm:function(caller){var subform=$(caller).up(".fiber_pack_form");var name=subform.down('a.name');var prompt="Are you sure that you want to unlink this fiber?";if(name&&name.innerHTML!==''){prompt="Are you sure that you want to unlink \""+name.innerHTML+"\"?";}
if(confirm(prompt)){subform.getElementsBySelector('input').each(function(input){if(input.name.indexOf('[fiber_pack_id]')<0){input.value='';}});new Effect.DropOut(subform);}},selectForSpinningProject:function(id,username){var url="/people/"+username+"/fiber/prepare_select";url+="?spinning_project_id="+id;if(!fiberSelectorIndex)fiberSelectorIndex=$$('.fiber_pack_form').size();RedBox.open('fiber_selection',url,{draggable:true,onComplete:function(){$('fiber_search_field').focus();}});},refreshSelector:function(params){$('fiber_indicator').show();var searchField=$('fiber_search_field');var form=$('fiber_stash_selector').down('form');if(!params)params={};if(!params.search)params.search=searchField.value;if(!params.sort)params.sort=$('fiber_search_sort').value;if(params.page&&params.page.href){params.page=params.page.href.parseQuery()['page'];}
new Ajax.Request(form.action,{parameters:params,onComplete:function(){$('fiber_indicator').hide();searchField.focus();}});},selectFiber:function(id){fiberSelectorIndex++;var params={'fiber_stash_id':id,'index':fiberSelectorIndex};new Ajax.Request("fiber_selected",{parameters:params,onComplete:function(){new Effect.SlideDown($$('.edit_fiber_pack').last());}});RedBox.close();},attachUnitChangeEvents:function(){var select=$('fiber_stash_form_unit_label');var onchange=R.fiberStash.updateUnitLabels;select.observe('change',onchange);select.observe('click',onchange);},updateUnitLabels:function(){var unitLabel=R.utils.selectedValue($('fiber_stash_form_unit_label'));unitLabel=unitLabel.replace(/s$/,"");var options=$$('#fiber_stash_form_unit_weight_units option');options.each(function(option){option.innerHTML=option.value+' per '+unitLabel;});},toggleWeightEntry:function(){$('total_quantity').toggle();$('unit_quantity').toggle();$('unit_priority').value=$('unit_quantity').visible()?'1':'0';},deleteFiberStash:function(url,id){var prompt='Are you sure that you want to delete this fiber from your stash?';var title=$('fiber_stash_'+id+'_title');if(title)prompt=prompt.replace('this fiber',title.innerHTML.strip());if(confirm(prompt)){new Ajax.Request(url,{method:'delete'});}},makeYarn:function(fiberStashId){new Ajax.Request(fiberStashId+"/make_yarn",{method:'get'});},quickEdit:function(id){$('quicknav').hide();R.controls.applyEditFrame($('fiber_stash_thumbnail_'+id),'editing_'+id,{photo:false,dimensions:[230,280]});var url=R.utils.prependPath(id,true)+'/prepare_quick_edit';url=url.replace('/stash/','/fiber/');new Ajax.Request(url,{method:'get'});}};}();R.stickies=function(){return{prepare:function(stickableType,stickableId,flagId){var url="/stickies/prepare";url+="?stickable_type="+stickableType;url+="&stickable_id="+stickableId;if(flagId){url+="&flag_id="+flagId;}
new Ajax.Request(url,{method:'get'});},cancel:function(id){new Ajax.Request('/stickies/'+id+'/cancel',{method:'get'});}};}();R.flaggings=function(){return{prepare:function(type,id){new Ajax.Request('/flaggings/prepare?flaggable_type='+type+"&flaggable_id="+id,{method:'get'});}};}();R.form=function(){var saveRequiredOn=false;return{initializeForms:function(){var updateRadioState=function(form){form.getElementsBySelector("input[type='radio']").each(function(radio){if(radio.id){var classname='with_radio_'+radio.id;form.useClassName(classname,radio.checked);}});};$$("input[type='radio']").each(function(changedRadio){var form=changedRadio.up('form');updateRadioState(form);changedRadio.observe('change',function(){updateRadioState(form);});});var autosaves=R$$('form.autosave');for(var i=0;i<autosaves.length;i++){var form=autosaves[i];if(Element.hasClassName(form,'autosave')){Element.getElementsBySelector(form,'input','select','textarea').each(function(element){Event.observe(element,'change',R.form.setSaveRequired);Event.observe(element,'keyup',R.form.setSaveRequired);});Element.getElementsByClassName(form,'textarea_preview').each(function(element){Event.observe(element,'click',R.form.setSaveRequired);});}}
if(autosaves.length>0){R.form.addUnloadEvent();}},setSaveRequired:function(){R.form.saveRequired();},clearSaveRequired:function(){saveRequiredOn=false;},isSaveRequired:function(){return saveRequiredOn;},submitSaveRequiredForm:function(form){saveRequiredOn=false;form=$(form);form.submit();},addUnloadEvent:function(){if(Browser.supportsOnBeforeUnload()){window.onbeforeunload=function(event){if(saveRequiredOn){var msg='You have unsaved changes.';if(!event){event=window.event;}
if(event){event.returnValue=msg;}
return msg;}};}else{var confirmNavigation=function(e){if(saveRequiredOn&&!confirm("Leave this page without saving your changes? Press \"cancel\" to stay on this page.")){Event.stop(e);}};$$('.toolbar_v2__back').each(function(tab){Event.observe(tab,'click',confirmNavigation);});$$('#tabset .static_tab a').each(function(tab){Event.observe(tab,'click',confirmNavigation);});}},saveRequired:function(){if(!saveRequiredOn){$$('form.autosave').each(function(form){Element.addClassName(form,'save_required');Element.getElementsBySelector(form,'input','button').each(function(button){saveRequiredOn=true;if(button.type=='submit'){if(button.className.indexOf('save_required')<0){Element.addClassName(button,'save_required');Event.observe(button,'click',function(){saveRequiredOn=false;});}}});});}}};}();R.forums=function(){var lastRead=null;var lastReadMoved=false;var lastReadReplyMoved=false;var newestUnreadReplyId=null;var loadingNextUnread=false;var nextUnreadObserver=null;var nextUnreadTimer=null;var posting={};var radarTimer;var radarPaused=false;var lastRadarId;var radarLimit=10;var radarTimeout=5000;var tooltipInterval=700;var forumPostPosition=null;var pageSize=25;var frozen=false;var moving;var tooltipsDisabled=false;var tooltipsEnabled=false;var currentTooltip;var shiftKey=false;var delayedHover=null;var periodicalMarker=null;var unloadAttached=false;var currentMarkAsReadUrl=null;var deferredMarkAsReadFirst=false;var activeTooltips=new Array();var pushUpdateCount=0;var pushNextPostNumber=null;var pushstreamClient=null;var scrollPositionBeforeReply=null;var topicUrl=function(forum,topicId,append){var url='/discuss/'+forum+'/topics/'+topicId;if(append){url+=append;}
return url;};var forumSetsSorted=function(container){var order=Sortable.sequence('forum_sets').join(' ');new Ajax.Request('/forum_sets/sort_sets',{method:'post',parameters:{'sort_order':order}});};var forumsSorted=function(container){var sorts=new Array();Element.getElementsBySelector($('forum_sets'),'.forum_set ul').each(function(element){sorts.push('forum_set['+getId(element)+"]="+Sortable.sequence(element,{}).join(','));});new Ajax.Request('/forum_sets/sort',{method:'post',postBody:sorts.join('&')});};var topicToolsIndicator=function(){var indicator=$('topic_tool_indicator');if(indicator){Element.show(indicator);}};var lastSuggestionQuery=null;return{onload:function(){var forumSets=$('forum_sets');if(forumSets){var containers=new Array();Element.getElementsBySelector(forumSets,'.forum_set ul').each(function(element){containers.push(element);});Element.getElementsBySelector(forumSets,'.forum_set ul').each(function(element){var listItems=Element.getElementsBySelector(forumSets,'li');listItems.each(function(li){Event.observe(li,'mouseover',function(){Element.addClassName(li,'hover');});Event.observe(li,'mouseout',function(){Element.removeClassName(li,'hover');});});Sortable.create(element,{scroll:window,containment:containers,constraint:false,dropOnEmpty:true,onUpdate:forumsSorted,ghosting:false,longPress:false});});var handle='title';if(R.swatch&&R.swatch.isSwatching('FRONTEND12')){handle='drag_grip';}
Sortable.create('forum_sets',{scroll:window,tag:'div',only:'forum_set',constraint:false,overlap:'horizontal',tree:false,onUpdate:forumSetsSorted,ghosting:false,handle:handle,longPress:false});}
if(window.history&&history.replaceState&&window.location.href.indexOf('?replies=1&')>=0){window.history.replaceState({},window.title,window.location.href.replace('?replies=1&','?'));}
R.forums.initializeSearchForms();R.forums.initializeTopicTracking();R.forums.enableTooltips();R.forums.initializeActivityTab();R.forums.initializeResponsive();$$('.tab_bar_responsive').each(function(bar){new R.controls.TabBar(bar,{currentInOverflow:true,simplifiedOverflow:false});});},initializeSearchForms:function(){if(R.swatch&&R.swatch.isSwatching('FRONTEND12')){$$('.single_field_form button').each(function(button){var form=button.up('form');button.observe('mousedown',function(){form.__submitting=true;});});}
$$('.single_field_form > *').each(function(input){var form=input.up('form');input.observe('focus',function(){var advanced=form.down('.single_field_form__advanced');if(advanced){advanced.addClassName('single_field_form__advanced--active');advanced.addClassName('o-single_row_form__advanced--active');}});input.observe('blur',function(){setTimeout(function(){var advanced=form.down('.single_field_form__advanced');if(!form.__submitting&&advanced&&document.activeElement&&document.activeElement.up('form')!=form){advanced.removeClassName('single_field_form__advanced--active');advanced.removeClassName('o-single_row_form__advanced--active');}},10);});});},initializeTopicTracking:function(){var trackingInput=$('topic_tracking');if(!trackingInput){return;}
$$('table.topics').each(function(table){Event.observe(table,'click',function(e){var row=Event.element(e);if(row.tagName!='TR'){row=row.up('tr');}
if(row){var topicId=getId(row);trackingInput.value=trackingInput.value+' '+topicId;}});});R.forums.refreshTopicCounts(trackingInput.value);},refreshTopicCounts:function(topicIdList){if(topicIdList&&topicIdList!==''){new Ajax.Request('/topics/refresh_counts',{method:'POST',parameters:{'topic_id_list':topicIdList},onComplete:function(xhr){var monitorships=xhr.responseText.evalJSON();$A(monitorships).each(function(m){var topic=$("topic_row_"+m['topic_id']);if(topic){var unread=topic.down('.posts');var total=unread.next('.posts');var age=topic.down('.age');var link=topic.down('.title a');link.href=m['last_read_url'];if(total.innerHTML!=m['forum_posts_count']){total.innerHTML=m['forum_posts_count'];age.innerHTML='just now';}
if(m['unread_count']==0){unread.innerHTML='';}else if(m.reading){unread.removeClassName('new_posts');unread.innerHTML='<strong>'+m['unread_count']+'</strong>';}else{unread.addClassName('new_posts');unread.innerHTML=m['unread_count'];}}});}});}},initializeResponsive:function(){if(!Element.hasClassName(document.body,'rsp')){return;}
$$('div .help p').each(function(crappyInlineStyle){crappyInlineStyle.style.width='100%';});if(Element.hasClassName(document.body,'topics_show')){$$('abbr').each(function(time){time.onclick=function(){var text=this.up('.time');if(text)text.style.fontSize='.8em';}.bindAsEventListener(time);});}
window.__applyMarkdownEditor=window.applyMarkdownEditor;window.applyMarkdownEditor=function(textarea,preview){__applyMarkdownEditor(textarea,preview);var t=$(textarea);if(R.swatch&&R.swatch.isSwatching('FRONTEND12')){t.style.height='40vh';}else if(document.documentElement.clientHeight>600){t.style.height='380px';}else if(document.documentElement.clientHeight>400){t.style.height=(document.documentElement.clientHeight-220)+'px';}else{t.style.height='180px';}
if(!(R.swatch&&R.swatch.isSwatching('FRONTEND12')&&Browser.responsiveBreakpoint())){t.scrollIntoView();t.focus();if(R.navigation.enableNewNavigation()){window.scrollTo(0,window.scrollY-170);}}};},initializeActivityTab:function(){if(Element.hasClassName(document.body,'discussions_activity')){R.utils.observeHover($('page'),'.forum_post_container');$$('.forum_post_container').each(function(post){post.observe('click',function(e){R.forums.activityClick(post,e);});});}},initializeRelatedTopics:function(){var params=$H({});var ids=[];$$('.related_topics').each(function(loadGlance){if(!loadGlance.__loadedGlance){loadGlance.__loadedGlance=true;params["glance["+loadGlance.id+"]"]=loadGlance.getAttribute('data-related-topics');ids.push(loadGlance.id);}});if(params.size()>0){new Ajax.Request('/discuss/glance',{parameters:params,onComplete:function(){R.forums.enableTooltips();ids.each(function(id){R.utils.applyFancyTables($(id).down('table'));});}});}},reorderOnJoin:function(groupId){forum_set_id=$F('forum_sets');var params=$H();params['new_group']=groupId;new Ajax.Request("/forum_sets/"+forum_set_id+"/reorder_on_join",{parameters:params,onComplete:function(){if(R.swatch&&R.swatch.isSwatching('FRONTEND12')){var editor=$('inplace_tab_editor');editor.up('.popover_body').style.height=editor.getHeight()+'px';}}});},switchOnJoin:function(container){var sorts=new Array();$$('.forum').each(function(element){sorts+=element.getAttribute('id').split('_')[1]+",";});$$('.forum_set_order')[0].value=sorts;},reorderForum:function(source){$$('.forum_glance').each(function(f){var topic=f.down('.topic_glance');var id=getId(f);var style='top: '+Position.positionedOffset(topic)[1]+'px;';style+='height: '+topic.getHeight()+'px;';style+='width: '+topic.getWidth()+'px;';if(id==source){var title=f.down('h2').innerHTML;var content='<div class="reorder_forum_overlay reorder_forum_overlay--instructions"  id="reorder_forum_instructions" style="'+style+'">';content+='<div class="reorder_forum_overlay__dialog">Select a board OR a tab to move <b>'+title+'</b> to that location <br /></br />';content+='<a href="#">cancel</a>';content+='</div></div>';new Insertion.Before(topic,content);}else{var content='<div class="reorder_forum_overlay reorder_forum_outline" style="'+style+'">';content+='<div class="reorder_forum_overlay__select">';content+='<span class="clicker" id="select_'+id+'" style="display: none;"><button>select this location</button></span>';content+='</div></div>';new Insertion.Before(topic,content);Event.observe(f.down('.reorder_forum_overlay'),'mouseover',function(){$('select_'+id).show();});Event.observe(f.down('.reorder_forum_overlay'),'mouseout',function(){$('select_'+id).hide();});}});$(document.body).addClassName('with_forum_reorder');$$('.forum_set_tab').each(function(tab){tab.addClassName('reorder_forum_outline');});Event.observe(document.body,'click',function(e){var reorderTarget=$(Event.element(e)).up('.forum_glance');var tabTarget=$(Event.element(e)).up('.forum_set_tab');var cancelled=$(Event.element(e)).innerHTML=='cancel'||Event.element(e).id=='reorder_forum_instructions';if(tabTarget||reorderTarget||cancelled){document.body.stopObserving('click',arguments.callee);$$('.reorder_forum_overlay').each(function(e){e.remove();});$$('.forum_set_tab').each(function(e){e.removeClassName('reorder_forum_outline');});$(document.body).removeClassName('with_forum_reorder');Event.stop(e);}
if(tabTarget){var forumSetId=getId(tabTarget);new Ajax.Request("/forum_sets/move_forum?forum_id="+source+"&forum_set_id="+forumSetId);}else if(reorderTarget){new Ajax.Request("/forum_sets/reorder?source="+source+"&target="+getId(reorderTarget));}});},switchForums:function(source_id,target_id){var source=$('forum_glance_'+source_id);var parent=source.parentElement;var target=$('forum_glance_'+target_id);emile(source,'opacity: 0',{duration:500,after:function(){if(target.nextSiblings().indexOf(source)!=-1){parent.insertBefore(source,target);}else{parent.insertBefore(source,target.next());}
emile(source,'opacity: 1',{duration:500});}});},getLastRead:function(){return lastRead;},isLastReadMoved:function(){return lastReadMoved;},isLastReadReplyMoved:function(){return lastReadReplyMoved;},editPost:function(id,deferredForumPostId){var url='/forum_posts/'+id+'/edit';var useActionSheet=R.swatch.isSwatching('FRONTEND12')&&Browser.responsiveBreakpoint();url+='?action_sheet='+(useActionSheet?1:0);if(deferredForumPostId){url+="&deferred_forum_post_id="+deferredForumPostId;}
if(useActionSheet){var actionSheet=$('forum_post_action_sheet')||R.controls.buildActionSheet('forum_post_action_sheet','fullscreen');actionSheet.innerHTML="<div id='forum_post_action_sheet_contents'></div>"}
new Ajax.Request(url,{evalScripts:true,method:'get'});},deletePost:function(id){if(confirm('Are you sure that you want to delete this post?')){new Ajax.Request('/forum_posts/'+id,{evalScripts:true,method:'delete'});}},updatedPost:function(id){R.forums.initializePhotos();R.forums.initializeRelatedTopics();R.forums.initializeEmbeds();R.markdown.initializeSpecialBlocks();},setTooltipsEnabled:function(value){tooltipsEnabled=value;},enableTooltips:function(){Event.observe(document,'keydown',function(event){if(event.shiftKey){if(delayedHover){delayedHover();delayedHover=null;}}});if(!Browser.isIPad()){if(tooltipsEnabled){R.forums.hideTooltips();}
var selectedInterval=tooltipsEnabled?tooltipInterval:100;var titles=R$$('td.title');var i;for(i=0;i<titles.length;i++){var td=titles[i];var a=td.firstChild;if(!a.tagName)a=a.nextSibling;if(a&&(a.tagName=='A')){$(a).hoverIntent({sensitivity:3,interval:selectedInterval,timeout:50,over:function(evt){var tooltipsSupported=!Browser.probablyTouchScreen();if(evt.shiftKey||(tooltipsEnabled&&tooltipsSupported)){R.forums.showTooltip(evt);}else{delayedHover=function(){R.forums.showTooltip(evt);};}},out:function(evt){delayedHover=null;R.forums.hideTooltips();}});}}}},parseTooltipEvent:function(evt){var a=Event.findElement(evt,'TR').down('A');var href=a.href;var parts=href.split('/');var topicId=parts[parts.length-2];var forum=parts[parts.length-3];var anchor=Position.positionedOffset(a);return{originalEvent:evt,href:href,topicId:topicId,forum:forum,anchor:anchor};},showTooltip:function(evt){var options=R.forums.parseTooltipEvent(evt);var tooltip=$("tooltip_"+options.topicId);if(!tooltip){new Insertion.Bottom('content',"<div class='topic_tooltip' onmouseout='R.forums.hideTooltips();' style='display: none;' id='tooltip_"+options.topicId+"'></div>");tooltip=$("tooltip_"+options.topicId);}
R.forums.hideTooltips();currentTooltip=options.topicId;activeTooltips.push(tooltip);tooltip.style.top=(options.anchor[1]+30)+"px";tooltip.style.left=(options.anchor[0]+10)+"px";new Ajax.Request(topicUrl(options.forum,options.topicId,'/tooltip'),{method:'get'});},tooltipLoaded:function(topicId){if(currentTooltip==topicId){if(tooltipsEnabled){new Effect.Appear("tooltip_"+topicId,{duration:0.200});}else{$("tooltip_"+topicId).show();}}},hideTooltips:function(evt){currentTooltip=null;var oldArray=activeTooltips;activeTooltips=new Array();$A(oldArray).each(function(tip){$(tip).hide();});$A(R$$('#content > .topic_tooltip')).each(function(tip){$(tip).hide();});},customizeButtons:function(button,value){var hide=value.checked?0:1;new Ajax.Request("/discuss/customize_buttons?button="+button+"&hide="+hide);},changeMainBoards:function(forumId,value){var hide=value.checked?0:1;new Ajax.Request("/discuss/change_main_boards?forum_id="+forumId+"&hide="+hide);},showReplies:function(forumPostId){var e=$('replies_'+forumPostId);var replace="";if(Element.visible(e)){Element.hide(e);}else{var marker=$("guest_moderator_markers_"+forumPostId);if(marker==null){marker=$("reply_summary_"+forumPostId);}
if(marker){replace=marker.innerHTML;marker.innerHTML=R.controls.tinyLoaderHTML()+"&nbsp;";}
new Ajax.Request("/forum_posts/"+forumPostId+"/replies",{method:'get',onComplete:function(){marker.innerHTML=replace;}});}},post:function(form){if(!posting[form.action]){posting[form.action]=true;new Ajax.Request(form.action,{asynchronous:true,evalScripts:true,method:'post',onFailure:function(request){Element.hide('reply_form_indicator');posting[form.action]=null;},onSuccess:function(request){Element.hide('reply_form_indicator');posting[form.action]=null;R.forums.drafts.clearCurrentDraft();},onLoading:function(request){Element.show('reply_form_indicator');},parameters:Form.serialize(form)});}},cancelEdit:function(forumPostId){new Ajax.Request('/forum_posts/'+forumPostId,{method:'get',evalScripts:true});},cancelReply:function(caller,form){if(R.swatch&&R.swatch.isSwatching('FRONTEND12')){if(R.controls.hideActionSheetSlider()){if(window.event){Event.stop(window.event);}
return;}}
var textarea=(form||$(caller).up('form')).down('textarea');var blank=textarea.value=='';var confirmMessage="Are you sure that you want to cancel and clear this reply?\n\nYour post text will not be saved.";if(blank||confirm(confirmMessage)){if(R.swatch&&R.swatch.isSwatching('FRONTEND12')){R.controls.closeActionSheets();}
R.forums.drafts.clearCurrentDraft();removeMarkdownEditor('forum_post_body');$('reply_container').innerHTML='';$('post_to_thread').show();$('post_to_thread_iconbar').show();R.forums.cancelReplyInside();}},getScrollPositionBeforeReply:function(){return scrollPositionBeforeReply;},replyTo:function(forum,topicId,forumPostId,deferredForumPostId,forumPostDraftId){if(forumPostDraftId){scrollPositionBeforeReply=null;}else{scrollPositionBeforeReply=R.utils.currentScrollPosition();}
R.forums.cancelReplyInside();var url='/discuss/'+forum+'/topics/'+topicId+'/reply';var params=$H();if(forumPostId){params['reply_to']=forumPostId;}
if(deferredForumPostId){params['deferred_forum_post_id']=deferredForumPostId;}
if(forumPostDraftId){params['forum_post_draft_id']=forumPostDraftId;}
if(Browser.responsiveBreakpoint()&&R.swatch&&R.swatch.isSwatching('FRONTEND12')){params['mobile']=1;}
var clicked=window.event&&Event.element(window.event);if(clicked&&clicked.up){var parentPost=clicked.up('.parent_post');if(parentPost){var postNumber=getId(parentPost.down('.post_number'));if(!$('forum_post_'+postNumber)){var replyToPostNumber=getId(clicked.up('.forum_post_guts').down('.post_number'));params['reply_to_location']=replyToPostNumber;}}}
new Ajax.Request(url,{parameters:params,asynchronous:true,evalScripts:true});},replyFormLoaded:function(replyInside){if(!(R.swatch&&R.swatch.isSwatching('FRONTEND12')&Browser.responsiveBreakpoint())){if(!Browser.responsiveBreakpoint()){if(!replyInside){document.location.href='#reply_form';}
$('forum_post_body').focus();}}},moderatePost:function(forumPostId){var tools=$('forum_post_moderator_tools_'+forumPostId);tools.toggle();},postTools:function(forumPostId){new Ajax.Request('/forum_posts/'+forumPostId+'/post_quicknav',{method:'get',postTools:true});},tagsQuicknav:function(forumPostId,caller){R.quicknav.prepare();var quicknav=$('quicknav');quicknav.innerHTML=$('quicknav_tags_'+forumPostId).innerHTML;R.quicknav.show(caller.id,{left:1,forceOffset:true});quicknav.addClassName('quicknav--reversed');if(window.event){Event.stop(window.event);}},prepareReplyContainer:function(){if(R.swatch&&R.swatch.isSwatching('FRONTEND12')){if(Browser.responsiveBreakpoint()){var actionSheet=$('reply_container_sheet')||R.controls.buildActionSheet('reply_container_sheet','fullscreen');actionSheet.appendChild($('reply_container'));}}},positionReplyContainer:function(){var actionSheet=$('reply_container_sheet');if(actionSheet){setTimeout(function(){R.controls.actionSheet(actionSheet);},100);}},prepareReplyInside:function(forumPostNumber,replyLocation){if(!replyLocation)replyLocation=forumPostNumber;var containerId='forum_post_'+forumPostNumber+'_reply_insides';var replyInsideContainer=$(containerId);if(!replyInsideContainer){replyInsideContainer=document.createElement('div');replyInsideContainer.id=containerId;var replyContainer=document.createElement('div');replyContainer.id='reply_container_'+forumPostNumber;replyContainer.className='reply_container';replyInsideContainer.appendChild(replyContainer);var sibling=$('forum_post_'+replyLocation);sibling.parentNode.insertBefore(replyInsideContainer,sibling.nextSibling);}
replyInsideContainer.className='forum_posts__reply_inside forum_posts__reply_inside--active';},cancelReplyInside:function(){$$('.forum_posts__reply_inside').each(function(o){o.className='forum_posts__reply_inside';o.down('.reply_container').innerHTML='';});},positionReplyInside:function(){window.scrollTo(0,$('reply_form').offsetTop-$('reply_form').getHeight()+120);$('forum_post_body').focus();},changeBoardSize:function(forumSetId,selector){var size=$F(selector);var set=$('forum_set_'+forumSetId);var sizes=$A(["small","medium","large"]);sizes.each(function(s){Element.removeClassName(set,s);});Element.addClassName(set,sizes[selector.selectedIndex]);new Ajax.Request('/forum_sets/'+forumSetId+'/size',{method:'post',postBody:"size="+size});},setLastRead:function(messageNumber){if(messageNumber){lastRead=messageNumber;}},report:function(forumPostId,value){if(value==0||confirm('Are you sure that you want to report this post? Please only use this in case of emergency: Abusive or illegal posts, spam, etc. (See our community guidelines)')){R.forums.vote(forumPostId,'reported',value);}},searchTopic:function(url,link){var useActionSheet=null;if(link){useActionSheet=link.up('.action_sheet');}
if(!useActionSheet&&Element.visible($('topic_header'))){if(R.swatch&&R.swatch.isSwatching('FRONTEND12')){$$('.forum_post_header').first().style.borderBottom='';}
R.forums.hideReportButtons();Element.hide('topic_header');}else{if(useActionSheet){R.controls.initializeActionSheet('topic_search_action_sheet');url+='?action_sheet=1';}
new Ajax.Request(url,{method:'get'});}},reportTopic:function(url){if(Element.visible($('topic_header'))){R.forums.hideReportButtons();Element.hide('topic_header');}else{new Ajax.Request(url);}},hideReportButtons:function(){($('forum_posts').getElementsBySelector('a.report')).each(function(link){Element.hide(link);});},showReportButtons:function(){($('forum_posts').getElementsBySelector('a.report')).each(function(link){Element.show(link);});},toggleUnreadReplies:function(){var menuId='reply_details_menu';var useActionSheet=Browser.responsiveBreakpoint()&&R.swatch&&R.swatch.isSwatching('FRONTEND12');if(useActionSheet){if(!$('unread_replies_action_sheet')){R.controls.buildActionSheet('unread_replies_action_sheet');}
new Ajax.Request('/forum_posts/unread_replies?action_sheet=1');}else if(Element.visible(menuId)){new Effect.SlideUp(menuId,{duration:0.5});new Effect.Fade(menuId,{duration:0.75});$('reply_status').down('.clicker').hide();}else{new Ajax.Request('/forum_posts/unread_replies');}},unreadRepliesLoaded:function(newestForumPostId){newestUnreadReplyId=newestForumPostId;$$('a.forum_unread_reply').each(function(reply){reply.observe('click',function(){document.location.href=reply.getAttribute('data-href');});});if($('mark_all_as_read')){$('mark_all_as_read').removeClassName('display_none');}},markAllRepliesRead:function(){if(confirm('Are you sure that you want to mark ALL replies as read?')){var params={'latest_post_id':newestUnreadReplyId};new Ajax.Request('/forum_posts/mark_all_replies_read',{method:'post',parameters:params});}},vote:function(postId,type,vote){new Ajax.Request('/forum_posts/'+postId+'/vote',{method:'post',postBody:"type="+type+"&vote="+vote});},guestModerate:function(postId,downvote){new Ajax.Request('/forum_posts/'+postId+'/guest_moderate',{method:'post',postBody:"downvote="+downvote});},showNextUnread:function(forum,topicId){var load=!loadingNextUnread;loadingNextUnread=true;if(load){if(!nextUnreadObserver){nextUnreadObserver=$(document.body).observe('click',function(e){if(!R.utils.eventTriggeredOn(e,'next_unread')){var popup=$('next_unread');if(popup&&popup.visible()){R.forums.hideNextUnread();Event.stop(e);}}});}
nextUnreadTimer=setTimeout(function(){var popup=$('next_unread');Element.show(popup);new Ajax.Request(topicUrl(forum,topicId,'/unread'),{asynchronous:true,evalScripts:true,method:'get'});},750);}},cancelNextUnread:function(){if(nextUnreadTimer){clearTimeout(nextUnreadTimer);loadingNextUnread=false;}},hideNextUnread:function(){Element.hide('next_unread');},firstPostInViewport:function(options){var last=null;var container=$('page');if(container){var viewportTop=getViewportSize()[1];var containerTop=Position.page(container)[1];$$('.forum_post_row').each(function(element){var top=0;var inViewport=(element.offsetTop+containerTop)<viewportTop;if(!inViewport&&(Browser.isIPhone()||Browser.isIPad())){inViewport=(element.offsetTop+containerTop)<(window.pageYOffset+viewportTop);}
if(inViewport){if(element.id){newLast=parseInt(getId(element));if(!last||(newLast==last+1)){last=newLast;}else{console.log("last = "+last+", newLast = "+newLast);}}}});}
return last;},updateUnreadCount:function(topicId,unread){if(unread==0){unread="";}
var td=$$('#topic_row_'+topicId+' .posts')[0];if(td){td.innerHTML='<strong>'+unread+'</strong>';}},markVisibleRead:function(forumId){var topics=new Array();$$("#forum_glance_"+forumId+" table tr").each(function(row){var topicId=row.id.split('_')[2];if(topicId){topics.push(topicId);}});new Ajax.Request('/discuss/'+forumId+'/topics/mark_read?location=glance&topics='+$A(topics).join(','));},markReadCompleted:function(previousLastRead,newLastRead,unreadUrl){var i;for(i=previousLastRead+1;i<=newLastRead;i++){var post=$('forum_post_'+i);if(post){Element.addClassName(post,'read');if(post.getAttribute('data-reply-to-me')=='1'){lastReadReplyMoved=true;}}}
for(i=newLastRead+1;i<=previousLastRead;i++){Element.removeClassName("forum_post_"+i,'read');}
var readCount=$('read_count');if(readCount){var a=readCount.down('a');if(a){a.href=unreadUrl;}}
if($('topic_tools_container')){Element.hide('topic_tools_container');}},cancelDeferredMarkAsRead:function(options){if(periodicalMarker){clearInterval(periodicalMarker);periodicalMarker=null;lastReadMoved=false;lastReadReplyMoved=false;if(currentMarkAsReadUrl){R.forums.updateLastReadCookie(currentMarkAsReadUrl,null);}}},deferredMarkAsRead:function(options){if(!periodicalMarker){var ghostery=setInterval(function(){},1000);clearInterval(ghostery);periodicalMarker=setInterval(function(){var last=R.forums.firstPostInViewport();if(last&&last>lastRead){if(!deferredMarkAsReadFirst){deferredMarkAsReadFirst=true;last=lastRead+1;}
var previousLastRead=lastRead;lastReadMoved=true;lastRead=last;R.forums.updateLastReadCookie(options.url,last);var unreadUrl='#'+last;R.forums.markReadCompleted(previousLastRead,last,unreadUrl);}},1000);R.forums.markAsReadOnUnload(options.url);}},getLastReadCookie:function(){var serializedMarkers=getCookie('last_read_markers');markers={};if(serializedMarkers){markers=serializedMarkers.toQueryParams();}
return $H(markers);},setLastReadCookie:function(markers){var serializedMarkers=markers.toQueryString();var expires=new Date((new Date()).getTime()+(1000*60*60*24));setCookie('last_read_markers',serializedMarkers,expires,'/');},updateLastReadCookie:function(url,lastRead){try{var markers=R.forums.getLastReadCookie();var urlParts=url.split('/');var topicId=urlParts[urlParts.length-2];markers[topicId]=lastRead;R.forums.setLastReadCookie(markers);}catch(err){deleteCookie('last_read_markers','/');}},markAsReadOnUnload:function(url){if(!unloadAttached){unloadAttached=true;currentMarkAsReadUrl=url;var existingUnload=window.onbeforeunload;window.onbeforeunload=function(){if(R.forums.isLastReadMoved()){var lastRead=R.forums.getLastRead();new Ajax.Request(url,{method:'post',postBody:"last_read="+lastRead,asynchronous:false,onSuccess:function(){if(!Browser.isSafari()){R.forums.updateLastReadCookie(url,null);}}});}
if(existingUnload){result=existingUnload();if(result){return result;}}};}},markAsReadIfRepliesWereRead:function(callback){var url=currentMarkAsReadUrl;if(url&&R.forums.isLastReadReplyMoved()){lastReadReplyMoved=false;var lastRead=R.forums.getLastRead();new Ajax.Request(url,{method:'post',postBody:"last_read="+lastRead,onComplete:function(){R.forums.updateLastReadCookie(url,null);if(callback)callback();}});}},movePosts:function(howMany){var last=forumPostPosition;if(!last&&window.location.hash!=''){var jump=parseInt(window.location.hash.substring(1));if(jump!=NaN)last=jump;}
if(!last){last=R.forums.firstPostInViewport();}
if(last&&!frozen){var next=last+howMany;var post=$("forum_post_"+next);if(post){forumPostPosition=next;moving=true;y=Position.positionedOffset(post)[1];window.scrollTo(0,y);}else if($("previous_page_"+next)){frozen=true;document.location.href=(next-pageSize+1)+"-"+next+"#"+next;}else if($("next_page_"+next)){frozen=true;document.location.href=next+"-"+(next+pageSize-1)+"#"+next;}}},initializeTopic:function(){R.controls.initializeTabBars();R.people.loadFlair();R.forums.initializeRelatedTopics();R.forums.initializeEmbeds();if(R.swatch&&R.swatch.isSwatching('FRONTEND12')){R.forums.initializeJumbomoji();}
R.forums.drafts.initializeDrafts();R.forums.initializeTopicTracking();R.forums.initializeSearchForms();if(Element.hasClassName(document.body,'discussions_index')||Element.hasClassName(document.body,'topics_index')||Element.hasClassName(document.body,'groups_show')){R.forums.enableTooltips();}
if(history.replaceState&&document.location.href.indexOf('?forum_post_draft_id=')>=0){newState=document.location.pathname+window.location.hash;history.replaceState('',window.document.title,newState);}
if($('topic_selector')){Event.observe($('topic_selector'),'change',function(event){navigateWithSelect($('topic_selector'));});}
R.forums.initializePhotos();if(Element.hasClassName(document.body,'topics_show')){Event.observe(document,'scroll',function(event){frozen=false;if(moving){moving=false;}else{forumPostPosition=null;}});Event.observe(document,'keydown',function(event){var element=Event.element(event);if(element.tagName=='TEXTAREA'||element.tagName=='INPUT'||element.tagName=='SELECT')return;var key=R.utils.keyCode(event);if(key==74){R.forums.movePosts(1);}else if(key==75){R.forums.movePosts(-1);}});if(window.history&&history.pushState&&!Browser.isMSIE()){}
R.forums.initializeResponsive();}},initializePhotos:function(){$$('.forum_post_body img').each(function(img){if(!img.__initialize_photos)
img.__initialize_photos=true;var src=img.getAttribute('src');if(src.indexOf('/attached/')===0){new R.forums.LinkedPhoto(img);}else if(src.indexOf('/forum-images/')===0){new R.forums.ExtrasPhoto(img);}});},initializeJumbomoji:function(){$$('.forum_post_body img.emo').each(function(emoji){var p=emoji.up('p');if(p&&!p.__initializedJumbomoji){var jumbo=false;p.initializedJumbomoji=true;var otherContent=p.getElementsBySelector(':not(img):not(br)');if(otherContent.length==0){var textContent=$A(p.childNodes).detect(function(node){return node.nodeType==Node.TEXT_NODE&&node.textContent!=''&&node.textContent!=' ';});if(!textContent){jumbo=true;}}
if(jumbo){p.addClassName('with_jumbomoji');}}});},initializeEmbeds:function(){var enableTiktok=false;let foundTiktokEmbeds=false;if(enableTiktok){$$('.forum_post_body a.tiktok-embed').each(function(a){var videoId=a.href.split('/')[5];if(videoId){var embed=document.createElement('blockquote');embed.innerHTML=a.outerHTML;embed.className='tiktok-embed unstyled';embed.setAttribute('cite',a.getAttribute('href'));embed.setAttribute('data-video-id',videoId);a.className='';a.parentNode.replaceChild(embed,a);foundTiktokEmbeds=true;}});if(foundTiktokEmbeds){var script=document.createElement('script');script.type='text/javascript';script.async=true;script.src='https://www.tiktok.com/embed.js';var s=document.getElementsByTagName('script')[0];s.parentNode.insertBefore(script,s);}}},pjaxifyTopicPage:function(){var page;$$('.page_links a').each(function(a){a.onclick=function(){R.forums.loadTopicPage(a.href);return false;};});$$('.page_links .pagination select.hopper').each(function(select){select.onchange=function(){R.forums.loadTopicPage(R.utils.selectedValue(select));return false;};});},loadTopicPage:function(page){if(window.PushStream)PushStream.unload();new Ajax.Updater('content',page+"?_pjax=1",{method:'GET',evalScripts:true,onComplete:function(xhr){window.scrollTo(0,0);window.history.pushState({},document.title,page);R.forums.initializeTopic();if(_gaq)_gaq.push(['_trackPageview',page]);}});},initializeRadar:function(id){Event.observe(document,'keypress',function(event){if(R.utils.keyCode(event)==32){if(radarPaused){R.forums.playRadar();}else{R.forums.pauseRadar();}
Event.stop(event);}});R.forums.startRadar(id,0);},startRadar:function(id,count,timeout){if(!radarPaused){if(timeout==null){timeout=radarTimeout;}
var posts=$A($('radar_posts').getElementsByClassName('radar_post'));var postsToRemove=posts.length-radarLimit;for(var i=1;i<=postsToRemove&&postsToRemove>0;i++){Element.remove(posts[posts.size()-i]);}
lastRadarId=id;radarTimer=setTimeout(function(){Element.show('default_indicator');new Ajax.Request('/discuss/radar_sweep?id='+id+"&count="+(count+1),{onComplete:function(){Element.hide('default_indicator');}});},timeout);}},pauseRadar:function(){if(radarTimer){clearTimeout(radarTimer);radarTimer=null;}
radarPaused=true;$('radar_pause').hide();$('radar_play').show();},playRadar:function(){if(!radarTimer){radarPaused=false;R.forums.startRadar(lastRadarId,2,0);}
$('radar_play').hide();$('radar_pause').show();},watchTopic:function(forum,topicId,loc){topicToolsIndicator();new Ajax.Request(topicUrl(forum,topicId,'/watch?location='+loc),{asynchronous:true,evalScripts:true,method:'post'});},ignoreTopic:function(forum,topicId,loc){topicToolsIndicator();new Ajax.Request(topicUrl(forum,topicId,'/ignore?location='+loc),{asynchronous:true,evalScripts:true,method:'post'});},clearMonitorship:function(forum,topicId,loc){topicToolsIndicator();new Ajax.Request(topicUrl(forum,topicId,'/clear?location='+loc),{asynchronous:true,evalScripts:true,method:'post'});},markLastRead:function(forum,topicId,postNumber,loc){topicToolsIndicator();if(loc=='toolbar'||loc=='postinfo'){R.forums.cancelDeferredMarkAsRead();}
var params={force_last_read:postNumber};new Ajax.Request(topicUrl(forum,topicId,'/read?location='+loc),{asynchronous:true,evalScripts:true,method:'post',parameters:params});},suggestTopics:function(forum,query){if(query==lastSuggestionQuery){return;}
if(Element.hasClassName(document.body,'topics')){lastSuggestionQuery=query;new Ajax.Request(topicUrl(forum,'suggestions'),{parameters:{query:query,method:'get'}});}},prepareFlag:function(forumPostId,options){R.forums.showReportButtons();var url='/forum_posts/'+forumPostId+'/prepare_flag';if(options&&options.source){url+="?source="+options.source;}
new Ajax.Request(url,{method:'get'});},prepareModeratePost:function(forumPostId){new Ajax.Request('/forum_posts/'+forumPostId+"/prepare_moderate",{method:'get'});},undoModeratePost:function(forumPostId){new Ajax.Request('/forum_posts/'+forumPostId+"/undo_moderate",{method:'post'});},setupPoll:function(forumPostId,pollId,markers,options){var shuffle=options&&options.shuffle;var hideResults=options&&options.hideResults;var poll=$('forum_post_'+forumPostId+'_guts');if(poll)poll=poll.down('ol');if(poll){poll.id="poll_"+pollId;poll.className="forum_poll";var questions=$(poll).getElementsByTagName('li');$A(questions).each(function(question,index){question.className='ticky_item';question.id='poll_'+pollId+'_ticky_item_'+index;var a="<a onclick=\"R.controls.tickyBox(this, '/polls/"+pollId+"/vote', 'question["+index+"]', {}); return false;\" href=\"#\" class=\"ticky_box\">&nbsp;</a>";question.innerHTML=a+question.innerHTML;if(!hideResults){var resultContents="<div class=\"result_percent\"></div><div class=\"result_bar\"><div class=\"inner_bar\"></div></div><div class=\"result_votes\"></div>";new Insertion.After(question,"<li class=\"poll_result\" id=\"poll_"+pollId+"_result_"+index+"\">"+resultContents+"</li>");}});var image="<img src=\"/images/silk-chart_bar.png\" class=\"inline\"/>";var resultLink="<a href=\"#\" onclick=\"R.forums.pollResults("+pollId+"); return false;\">show results</a>";if(!hideResults){var showDiv="<li class=\"show_results_link\">"+image+' '+resultLink+"</li>";var hideDiv="<li class=\"hide_results_link\"><a href=\"#\" onclick=\"R.forums.hidePollResults("+pollId+"); return false;\">hide results</a></li>";poll.innerHTML+=showDiv+hideDiv;}
R.forums.updatePoll(pollId,markers);if(shuffle){var answers=poll.getElementsBySelector("li.ticky_item");var sorted=$A(answers).sortBy(Math.random);for(var i=0;i<sorted.length;i++){poll.appendChild(sorted[i]);}}}},pollResults:function(pollId){new Ajax.Request("/polls/"+pollId+"/vote?results=1");},hidePollResults:function(pollId){var poll=$('poll_'+pollId);if(poll){$(poll).removeClassName("show_poll_results");$(poll).addClassName("hide_poll_results");}},updatePoll:function(pollId,markers,resultList){var poll=$('poll_'+pollId);if(poll){if(resultList){resultList=$A(resultList);var sum=0;var max=1;resultList.each(function(r){sum+=r;if(max<r)max=r;});var multiplier=340.0/max;resultList.each(function(r,index){var result=$('poll_'+pollId+'_result_'+index);if(result){var bar=result.down('.inner_bar');var votes=result.down('.result_votes');var percent=result.down('.result_percent');bar.style.width=Math.round(r*multiplier)+"px";votes.innerHTML=r+" vote"+(r==1?"":"s");percent.innerHTML=r>0?Math.round(r/sum*100)+"%":"0%";}});}
var hasMarkers=$H(markers).keys().length>0;if(resultList){$(poll).removeClassName("hide_poll_results");$(poll).addClassName("show_poll_results");}else if(hasMarkers){R.forums.hidePollResults(pollId);}else{$(poll).addClassName("hide_poll_results");$(poll).removeClassName("show_poll_results");}
var questions=R$$('li.ticky_item',poll);$A(questions).each(function(question,index){var ticky=$(question).down('.ticky_box');if(markers&&markers[getId(question)]){ticky.addClassName('ticky_box_selected');}else{ticky.removeClassName('ticky_box_selected');}});}},appendNewPosts:function(jumpTo){$('topic_update_count').hide();$('topic_update_count').innerHTML='';$('topic_updates').hide();$('topic_updates').innerHTML='';pushUpdateCount=0;var nextPostNumber=pushNextPostNumber;pushNextPostNumber=null;var url='append_posts?post_number='+nextPostNumber;if(jumpTo){url+='&jump='+jumpTo;}
new Ajax.Request(url,{method:'get'});},showCrumbMenu:function(){$('group_breadcrumb_menu').show();},hideCrumbMenu:function(){$('group_breadcrumb_menu').hide();},liveForums:function(){if(R.pushstream.isSupported()){var channels=$A();$$('.forum_glance').each(function(board){var forumId=getId(board);if(channels.length<255){channels.push('forum'+forumId);}});nchanClient=R.pushstream.nchanClient(channels);nchanClient.on('message',function(msg){var json=decodeURIComponent(msg).replace('}=','}').evalJSON();var topic=$("topic_row_"+json['topic_id']);if(topic){var unread=topic.down('.posts');var total=unread.next('.posts');var age=topic.down('.age');new Effect.Highlight(unread);new Effect.Highlight(total);new Effect.Highlight(age);var bold=unread.down('strong');var unreadCount=parseInt((bold||unread).innerHTML||0)+1;if(bold||unreadCount==1){unreadCount="<strong>"+unreadCount+"</strong>";}
age.innerHTML='just now';unread.innerHTML=unreadCount;total.innerHTML=json['post_number'];;var trackingInput=$('topic_tracking');if(trackingInput){trackingInput.value=trackingInput.value+' '+json['topic_id'];}}});nchanClient.start();}},subscribeToNewPosts:function(topicId,currentUserId){if(R.pushstream.isSupported()){nchanClient=R.pushstream.nchanClient('topic'+topicId);nchanClient.on('message',function(msg){var json=decodeURIComponent(msg).replace('}=','}').evalJSON();if(json.post_number){R.forums.receivedForumPostMessage(json,currentUserId);}else if(json.message_type=='forum_marker'){R.forums.receivedForumMarkerMessage(json);}});nchanClient.start();}},receivedForumMarkerMessage:function(json){var markers=$('markers_'+json.forum_post_id);if(markers){var vote=markers.getElementsBySelector('a').detect(function(e){return e.innerHTML.indexOf(json.forum_marker_type)>=0;})
var voteText=json.forum_marker_type+json.forum_marker_text;vote.innerHTML=voteText;}},receivedForumPostMessage:function(json,currentUserId){if(!pushNextPostNumber){pushNextPostNumber=json.post_number;}
if(json.user.id==currentUserId){return false;}
if($$('a.next_page').first()){return false;}
pushUpdateCount+=1;$('topic_update_count').show();$('topic_updates').show();var count=new Template(['<strong>#{pushUpdateCount} post#{plural}</strong> #{plural2} been written by others since you started reading this page.  ','<a onclick="R.forums.appendNewPosts(); return false;" href="?p#{nextPostNumber}##{nextPostNumber}">Load the new posts...</a>'].join(''));vars={pushUpdateCount:pushUpdateCount,nextPostNumber:pushNextPostNumber,plural2:'has'};if(pushUpdateCount>1){vars.plural='s';vars.plural2='have';}
$('topic_update_count').innerHTML=count.evaluate(vars);new Effect.Highlight($('topic_update_count').down('strong'));var update=new Template(['<div  id="topic_update_post_#{id}" style="height: 35px; display:none;" class="topic_update_post">','<img class="inline" src="#{avatar}"/>','<span class="floating_tip">','<a onclick="R.forums.appendNewPosts(#{postNumber}); return false;" href="posts/#{postNumber}">##{postNumber}</a> ','#{abstract}#{ellipsis} &mdash; <em>#{username}</em>','</span></div>'].join(''));var abstractLength=100;vars={id:json.id,username:json.user.username,avatar:json.user.tiny_photo_url||'/empty_gif',postNumber:json.post_number,abstract:json.short_abstract_for_api.substring(0,abstractLength)};if(json.short_abstract.length>abstractLength)vars.ellipsis='...';$('topic_updates').innerHTML+=update.evaluate(vars);new Effect.Appear('topic_update_post_'+json.id);},topicTools:function(forum,topicId,loc,e){var evt=e?e:window.event;var left=0;var top=0;if(loc!='glance'){left=Event.pointerX(evt)-225;top=Event.pointerY(evt)-225;if(R.navigation.enableNewNavigation()){top=top-80;}
if(R.swatch.isSwatching('FRONTEND12')){top=top-80;}}else{left=Event.pointerX(evt)-225;top=Event.pointerY(evt)+10;var status=$('topic_'+topicId+'_status');if(status){status.previousInnerHTML=status.innerHTML;status.innerHTML=R.controls.tinyLoaderHTML();}}
var contents=$('topic_tools_contents');if(contents){contents.innerHTML='';}
var tt=$('topic_tools_container');if(!tt){var html='<div id="topic_tools_container" style="display:none; z-index:100; position: absolute;"></div>';new Insertion.Bottom(document.body,html);tt=$('topic_tools_container');}
tt.style.top=top+"px";tt.style.left=left+"px";tt.style.display='block';topicToolsIndicator();new Ajax.Request(topicUrl(forum,topicId,'/tools?location='+loc),{asynchronous:true,evalScripts:true,method:'get',onComplete:function(){var status=$('topic_'+topicId+'_status');if(loc=='glance'&&status&&status.previousInnerHTML){status.innerHTML=status.previousInnerHTML;status.previousInnerHTML='';}}});},activityClick:function(container,evt){var clicked=Event.findElement(evt,'A');if(clicked.tagName!='A'){var link=container.down('.title a');var quicknav=$('quicknav')&&$('quicknav').visible();if(link&&!quicknav){var url=link.href;var newWindow=evt.which&&(evt.which!=1||evt.metaKey||evt.ctrlKey);if(newWindow){window.open(url,'_blank');}else{document.location.href=url;}}}},openActivityControl:function(forumPostId){new Ajax.Request("/discuss/activity/edit_activity_preferences?forum_post_id="+forumPostId,{method:'GET'});},markAsHiddenInActivity:function(forumPostId,options){R.forums.saveActivityPreference({"forum_post_id":forumPostId,"scope":options.scope,"hide":options.hide?1:0});},saveActivityPreference:function(params){var visiblePosts=$$('.forum_post_container').collect(function(f){if(f.visible())return getId(f);});params=$H(params).merge({"visible_post_ids":visiblePosts.join(' ')});new Ajax.Request("/discuss/activity/save_activity_preferences",{parameters:params,method:'POST'});},deleteActivityPreference:function(id,type){if(confirm('Are you sure you want to stop hiding this '+type+'?')){new Ajax.Request("/discuss/activity/destroy_preference/"+id);}},toggleActivity:function(caller){var post=caller.up('.forum_post');post.toggleClassName('collapsed');},markAsReadInActivity:function(forumPostId){R.forums.saveActivityPreference({"forum_post_id":forumPostId,"read":1});},changeModeratorNotifications:function(moderatorship,setting,value){var val=value.checked?1:0;var params={"moderatorship":moderatorship,"setting":setting,"value":val};new Ajax.Request("/discuss/save_moderator_notifications",{parameters:params,method:'POST'});},showForumReply:function(link,id,depth){var p=$(link);var indicator;while(p&&p.getElementsByClassName('indicator').length==0){p=$(p.parentNode);}
if(p){var indicators=p.getElementsByClassName('indicator');if(indicators.length>0){indicator=indicators[0];}}
var container=link.parentNode.parentNode.parentNode;var threadContainer=$(container).getElementsByClassName('thread')[0];var bit=$(threadContainer).getElementsByClassName('parent_post');if(bit.length>0&&Element.visible(bit[0])){new Effect.BlindUp(bit[0]);}else{var url="/forum_posts/parent/"+id;if(depth){url+="?depth="+depth;}
if(indicator){Element.show(indicator);}
new Ajax.Updater(threadContainer,url,{asynchronous:true,evalScripts:true,onComplete:function(){if(indicator)Element.hide(indicator);var bit=$(threadContainer).getElementsByClassName('parent_post')[0];new Effect.Appear(bit);R.markdown.initializeSpecialBlocks();}});}}};}();R.forums.drafts=function(){var draftKeyPrefix='unsaved_draft_post_';var currentDraftKey=null;var currentDraftText=null;var pageStorage={};return{initializeDrafts:function(){$$('.forum_post_drafts__post--collapsed').each(function(draft){var container=draft.down('.forum_post_drafts__post__body');var content=draft.down('.body');if($(content).getHeight()>$(container).getHeight()){draft.addClassName('forum_post_drafts__post--overflowing');}});},getCurrentDraftText:function(){return currentDraftText;},migrateUnsavedDrafts:function(){if(window.localStorage){try{for(var i=0;i<localStorage.length;i++){var key=localStorage.key(i);if(key.indexOf(draftKeyPrefix)>=0){var migrateKey=key;var data=JSON.parse(localStorage.getItem(migrateKey));if(data['body']!=''){data['local_storage_key']=migrateKey;new Ajax.Request('/forum_post_drafts/unsaved_draft',{method:'POST',parameters:data,onComplete:function(){localStorage.removeItem(migrateKey);R.forums.drafts.refreshDraftList();}});}}}}catch(e){}}
if($('topic_show')){R.forums.drafts.migrateLegacyUnsavedDrafts();}},migrateLegacyUnsavedDrafts:function(){var legacyDraft=getCookie('draft_forum_post');if(legacyDraft&&legacyDraft!==''){var data={'topic_id':$('topic_show').getAttribute('data-topic-id'),'body':legacyDraft,'local_storage_key':'legacy'};new Ajax.Request('/forum_post_drafts/unsaved_draft',{method:'POST',parameters:data,onComplete:function(){deleteCookie('draft_forum_post');R.forums.drafts.refreshDraftList();}});}},refreshDraftList:function(){R.navigation.refreshForumsMenu();if($('forum_post_drafts')){var url='/forum_post_drafts/refresh';if($('topic_show')){url+='?topic_id='+$('topic_show').getAttribute('data-topic-id');}
new Ajax.Request(url,{method:'GET'});}},clearCurrentDraft:function(){if(window.localStorage&&currentDraftKey){try{var draftData=localStorage.getItem(currentDraftKey)||pageStorage[currentDraftKey];if(draftData){var data=JSON.parse(draftData);data['local_storage_key']=currentDraftKey;localStorage.removeItem(currentDraftKey);new Ajax.Request('/forum_post_drafts/delete_unsaved_draft',{method:'POST',parameters:data,onComplete:function(){R.forums.drafts.refreshDraftList();}});}}catch(e){}}
currentDraftKey=null;currentDraftText=null;},setCurrentDraft:function(topicId,textarea){textarea=$(textarea);var draftKey=textarea.__draftKey;if(!textarea.__draftKey){textarea.__draftKey=draftKeyPrefix+Math.random().toString(36).substr(2);draftKey=textarea.__draftKey;}
var draftData=R.forums.drafts.getDraftData(topicId).toJSON();if(window.localStorage){try{localStorage.setItem(draftKey,draftData);pageStorage[draftKey]=draftData;}catch(e){}}
currentDraftKey=draftKey;currentDraftText=textarea.value;},resumeDraft:function(forumPostDraftId,postPageUrl){var postPageUrlParts=$A(postPageUrl.split(/[#?]/));var url=postPageUrlParts.first()+'?forum_post_draft_id='+forumPostDraftId;if(postPageUrl.indexOf('#')>=0){url+='#'+postPageUrlParts.last();}
document.location.href=url;},loadDraft:function(forumPostDraftId,forum,topicId,forumPostId){R.forums.replyTo(forum,topicId,forumPostId,null,forumPostDraftId);},getDraftData:function(topicId){var firstPost=$$('.post_number').first();var startingPostNumber=null;if(firstPost){startingPostNumber=getId(firstPost);}else{var parts=document.location.href.split(/[/-]/);startingPostNumber=parts[parts.length-2];}
var attributes=Form.serialize($('reply_form'));var forumPostDraftId=attributes['forum_post_draft_id'];var localStorageKey=$('forum_post_body').__draftKey;var data={'topic_id':topicId,'body':attributes['forum_post[body]'],'magic_link':attributes['magic_link'],'parent_post_id':attributes['forum_post[parent_post_id]'],'markdown_suggester_activated':attributes['markdown_suggester_activated'],'starting_post_number':startingPostNumber,'forum_post_draft_id':forumPostDraftId,'local_storage_key':localStorageKey};return $H(data);},saveDraft:function(topicId){var params=R.forums.drafts.getDraftData(topicId);var forumPostDraftId=params['forum_post_draft_id'];var url='/forum_post_drafts';var method='POST';if(forumPostDraftId){url='/forum_post_drafts/'+forumPostDraftId;method='PUT';}
new Ajax.Request('/forum_post_drafts',{method:'POST',parameters:params,onComplete:function(){R.forums.drafts.clearCurrentDraft();if(R.forums.getScrollPositionBeforeReply()){window.scrollTo(0,R.forums.getScrollPositionBeforeReply());new Effect.Shake('forums_tab_v2');}}});},deleteDraft:function(forumPostDraftId){var draft=$('forum_post_draft_'+forumPostDraftId);draft.addClassName('confirm_delete');var params={};if($('topic_show')){params['source']='topic';params['topic_id']=$('topic_show').getAttribute('data-topic-id');}
if(confirm('Are you sure that you want to permanently delete this draft?')){new Ajax.Request('/forum_post_drafts/'+forumPostDraftId,{method:'DELETE',parameters:params});}
draft.removeClassName('confirm_delete');},draftUpdated:function(forumPostDraftId){var textarea=$('reply_form').down('textarea');textarea.value='';R.forums.cancelReply(textarea);},toggleDraft:function(forumPostDraftId){$('forum_post_draft_'+forumPostDraftId).toggleClassName('forum_post_drafts__post--collapsed');}};}();R.forums.LinkedPhoto=function(img){this.img=$(img);this.link=$(img).up('A');if(this.link){this.link.addClassName('forum_post_linked_photo');this.addEventHandlers();}};R.forums.LinkedPhoto.prototype.addEventHandlers=function(){var me=this;$(this.link).hoverIntent({sensitivity:6,interval:100,timeout:250,over:function(){if(!Browser.probablyTouchScreen()){me.showCaption();}},out:function(){if(!Browser.probablyTouchScreen()){me.hideCaption();}}});$(this.link).observe('click',function(e){if(Browser.probablyTouchScreen()){if(!me.caption||me.caption.hasClassName('forum_photo__tooltip--hidden')){me.showCaption();Event.stop(e);}}});};R.forums.LinkedPhoto.prototype.hideCaption=function(){if(this.caption)this.caption.addClassName('forum_photo__tooltip--hidden');};R.forums.LinkedPhoto.prototype.showCaption=function(){this.img.style.verticalAlign='bottom';this.link.style.position='relative';this.link.style.display='inline-block';this.link.style.overflow='hidden';if(!this.caption){if(!this.buildingCaption){this.buildingCaption=true;var caption=document.createElement('DIV');caption.className='forum_photo__tooltip--hidden forum_photo__tooltip';var url='/forum_photos/caption?href='+this.link.href;var me=this;new Ajax.Request(url,{method:'GET',on404:function(){me.link.onclick=function(){return false;};me.link.style.cursor='default';},onSuccess:function(xhr){caption.innerHTML=xhr.responseText;me.caption=caption;me.link.insertBefore(caption,me.img);setTimeout(function(){me.showCaption();},50);}});}}else{this.caption.removeClassName('forum_photo__tooltip--hidden');}};R.forums.ExtrasPhoto=function(img){this.img=img;img.style.cursor='zoom-in';this.caption=null;this.addEventHandlers();};R.forums.ExtrasPhoto.prototype.addEventHandlers=function(){var me=this;var img=this.img;img.observe('click',function(e){var url=img.getAttribute('src')+'/zoom';if(Browser.probablyTouchScreen()&&!me.caption){var container=document.createElement('DIV');container.style.display='inline-block';container.style.position='relative';me.img.parentNode.insertBefore(container,me.img);container.appendChild(me.img);var caption=document.createElement('a');caption.href=url;caption.className='forum_photo__tooltip';caption.style.textAlign='right';caption.style.display='inline-block';caption.innerHTML="<img src='/images/32x32/farmfresh-magnifier_zoom_in.png' width='24' height='24'/>";container.insertBefore(caption,img);me.caption=caption;Event.stop(e);}else if(Browser.responsiveBreakpoint()){document.location.href=url;}else{$(document.body).addClassName('with_forum_photo_zoom');RedBox.open('extras_photo_zoom',img.getAttribute('src')+'/zoom',{method:'GET',onClose:function(){$(document.body).removeClassName('with_forum_photo_zoom');}});}});};R.friends=function(){return{initialize:function(){if($('filter_menu')){new R.controls.FilterMenu('filter_menu','filter_menu_options',{usePushState:true,autoWidth:true});}
R.controls.initializeOptionPickers();if(R.swatch&&R.swatch.isSwatching('FRONTEND12')&&Browser.responsiveBreakpoint()){$$('.touch_gallery').each(function(gallery){});R.controls.initializeTabBars();R.photos.setGridPhotoDimensions();Event.observe(window,'resize',R.photos.setGridPhotoDimensions);}
if($$('.photo_gallery__background').first()){blazy=new Blazy({selector:'.photo_gallery__background[data-lazy-load-image]',src:'data-lazy-load-image'});}},initializeNotebook:function(){},remove:function(user,friendId,friendName){if(confirm("Are you sure that you want to remove "+friendName+" from your friends?")){var url="/people/"+user+"/friends/"+friendId;new Ajax.Request(url,{method:'delete'});}},selectSets:function(user,friendId){var url="/people/"+user+"/friends/"+friendId+'/select_sets';new Ajax.Request(url,{method:'get'});},friendRemoved:function(friendId,friendStatusContent){var friend=$("friend_"+friendId);if(friend){new Effect.DropOut('friend_'+friendId);}
var row=$("friend_"+friendId+"_row");if(row){row.getElementsBySelector('td').each(function(td){td.innerHTML='';});}
if($('bookmark')&&friendStatusContent){$('bookmark').replace(friendStatusContent);}
R.popover.close(true);},closeSets:function(){R.friends.changeSets();},changeSets:function(user,friendId){if(R.swatch.isSwatching('FRONTEND12')){var url='/people/'+user+'/friends/'+friendId+'/change_sets?popover=1';new Ajax.Request(url,{evalScripts:true,method:'get'});}else{var collections=$('collections_container');if(collections&&Element.visible(collections)){new Effect.SlideUp(collections,{duration:0.2});}else if(user&&friendId){var url='/people/'+user+'/friends/'+friendId+'/change_sets';new Ajax.Request(url,{evalScripts:true,method:'get'});}}}};}();R.guidedTips=function(){var scriptStack=$A([]);var tipId=null;var runningGuide=null;var currentStep=null;var mouseSound=null;var keyboardSound=null;var mouseXPos=null;var mouseYPos=null;var expandedSelect=null;soundManagerStarted=false;var easeInOutCirc=function(pos){if((pos/=0.5)<1)return-0.5*(Math.sqrt(1-pos*pos)-1);return 0.5*(Math.sqrt(1-(pos-=2)*pos)+1);};return{initialize:function(){var location=window.location+"";if(location.indexOf('?')>=0){location=location.replace('#','&');}else{location=location.replace('#','?');}
var query=location.parseQuery();if(query['_tip']){tipId=query['_tip'];currentStep=parseInt(query['_step'])||0;R.guidedTips.loadSoundManager();soundManagerStarted=true;R.guidedTips.runGuide(tipId,currentStep+1);}},loadSoundManager:function(){var script=document.createElement('script');script.type='text/javascript';script.async=true;script.src='/javascripts/soundmanager2.js';var s=document.getElementsByTagName('script')[0];s.parentNode.insertBefore(script,s);setTimeout(function(){R.guidedTips.initializeSounds();},250);},initializeSounds:function(){if(window.soundManager&&window.soundManager.supported()){soundManager.url='/swf/';keyboardSound=soundManager.createSound({id:'keyboard-click',url:'/audio/keyclick.mp3'});mouseSound=soundManager.createSound({id:'mouse-click',url:'/audio/mouseclick2.mp3'});}else{setTimeout(function(){R.guidedTips.initializeSounds();},250);}},playKeyboardSound:function(){if(keyboardSound){keyboardSound.play();}},playMouseSound:function(onfinish){if(mouseSound){mouseSound.play({onfinish:onfinish});}else{onfinish();}},showOverlay:function(options){if(!$('tip_overlay')){new Insertion.Bottom(document.body,'<div id="tip_overlay" style="display: none;"></div>');}
var yScroll=null;if(window.innerHeight&&window.scrollMaxY){yScroll=window.innerHeight+window.scrollMaxY;}else if(document.body.scrollHeight>document.body.offsetHeight){yScroll=document.body.scrollHeight;}else{yScroll=document.body.offsetHeight;}
$("tip_overlay").style.height=yScroll+"px";$("tip_overlay").style.display='block';Event.observe('tip_overlay','click',function(event){Event.stop(event);if($('guided_tip_container')){new Effect.Shake($('guided_tip_container'));}});},startGuide:function(id){if(!soundManagerStarted){R.guidedTips.loadSoundManager();soundManagerStarted=true;}
setTimeout(function(){R.guidedTips.runGuide(id,0);},500);},runGuide:function(id,step){tipId=id;currentStep=step;if(step>0){R.guidedTips.showOverlay();}
new Ajax.Request("/guided_tips/load?id="+id,{onComplete:function(xhr){var tipData=xhr.responseText.evalJSON()['tip'];runningGuide=tipData;if(step==0){R.guidedTips.queueScripts(tipData['navigate_script']);R.guidedTips.runNextScript();}else{R.guidedTips.runStep(tipData,currentStep);}}});},runStep:function(tipData,stepNumber){var stepData=tipData['steps'][stepNumber-1]['step'];R.guidedTips.queueScripts(stepData['navigate_script']);if(stepData['content']){R.guidedTips.showTip(stepData,tipData);if($('tip_overlay'))$('tip_overlay').style.cursor='';}
if(stepData['autostart']){R.guidedTips.runNextScript();}},showTip:function(stepData,tipData){var tipContainer=$('guided_tip_container');if(tipContainer){tipContainer.hide();}else{new Insertion.Bottom(document.body,"<div id='guided_tip_container'></div>");tipContainer=$('guided_tip_container');}
tipContainer.style.position='absolute';tipContainer.style.zIndex=-1000;tipContainer.style.visibility='hidden';tipContainer.style.display='block';var classes=stepData['class']||tipData['default_class'];var buttonText=stepData['button_text']||'continue &rarr;';var button="<div class='tip_button'><div class='tip_cancel'><a href='#' onclick='R.guidedTips.doFinish(); return false;'>quit this guide</a></div><button onclick='R.guidedTips.continueClicked(); return false;'>"+buttonText+"</button><br clear='all'/></div><br clear='all'/>";tipContainer.innerHTML="<div class='guided_tip "+classes+"'>"+"<div class='tip_header'></div><div class='tip_content'>"+stepData['content']+button+"</div>"+"<div class='tip_footer'></div></div>";var useAnchor=stepData['anchor'];var anchor=null;if(useAnchor){anchor=eval(useAnchor);}
if(anchor||!useAnchor){if(anchor){var scrollTo=null;if(stepData['scroll_to'])scrollTo=eval(stepData['scroll_to']);R.guidedTips.positionAtAnchor(anchor,classes,scrollTo);}
if(stepData['tip_css']){tipContainer.setStyle(eval("("+stepData['tip_css']+")"));}
tipContainer.style.zIndex=11001;tipContainer.style.display='none';tipContainer.style.visibility='visible';new Effect.Appear(tipContainer,{duration:0.25});}else{setTimeout(function(){R.guidedTips.showTip(stepData,tipData);},200);}},continueClicked:function(e){R.guidedTips.runNextScript();},positionAtAnchor:function(anchor,classes,scrollTo){var tipContainer=$('guided_tip_container');var tipHeight=Element.getHeight(tipContainer);var anchorWidth=Element.getWidth(anchor);var anchorHeight=Element.getHeight(anchor);var anchorPos=Position.cumulativeOffset(anchor);var xPos;var yPos;if(classes.indexOf('top_left')>=0){xPos=anchorPos[0]-30;yPos=anchorPos[1]+anchorHeight+5;}else if(classes.indexOf('top_right')>=0){xPos=anchorPos[0]-320;yPos=anchorPos[1]+anchorHeight+5;}else if(classes.indexOf('bottom_left')>=0){xPos=anchorPos[0]-340+Math.round(anchorWidth/2);yPos=anchorPos[1]-tipHeight+100;}
mouseXPos=xPos;mouseYPos=yPos;tipContainer.setStyle({top:yPos+"px",left:xPos+"px",right:'auto',bottom:'auto'});if(scrollTo){R.guidedTips.scrollTo(scrollTo);}},addTipToUrl:function(url){if(url.indexOf("?")>=0||url.indexOf('#')>=0){url+="&";}else{url+="?";}
url=url+"_tip="+tipId+"&_step="+currentStep;return url;},queueScripts:function(scripts){var parts=scripts.split(/\n/);for(var i=0;i<parts.length;i++){var part=parts[i];scriptStack.push(part);}},runNextScript:function(){if(scriptStack.length>0){if($('tip_overlay'))$('tip_overlay').style.cursor='wait';if($('guided_tip_container'))$('guided_tip_container').down('button').hide();var script=scriptStack.shift();if(!script||script==""){R.guidedTips.runNextScript();}else{eval(script);}}else{if($('tip_overlay'))$('tip_overlay').style.cursor='auto';}},doStep:function(number){currentStep=number;R.guidedTips.runStep(runningGuide,number);},doChangePage:function(url){document.location.href=R.guidedTips.addTipToUrl(url);},doScroll:function(element){R.guidedTips.scrollTo(element);R.guidedTips.runNextScript();},doFinish:function(){$('guided_tip_container').hide();if($('guided_tip_mouse'))$('guided_tip_mouse').hide();if($('tip_overlay'))$('tip_overlay').hide();document.location.href="/guided_tips";},scrollTo:function(element){R.utils.scrollTo(element);R.guidedTips.showOverlay();},doDelay:function(time){setTimeout(function(){R.guidedTips.runNextScript();},time);},doWait:function(func){if(func()){R.guidedTips.runNextScript();}else{setTimeout(function(){R.guidedTips.doWait(func);},100);}},doRun:function(f,runNext){f();if(runNext!==false){R.guidedTips.runNextScript();}},doMouse:function(element,options){if(!options)options={};element=$(element);if(options.unless&&options.unless()){R.guidedTips.runNextScript();return;}
var mouse=$('guided_tip_mouse');var click=options.click;var submit=options.submit;var clickUnless=options.clickUnless;var transitionTo=options.transitionTo;var soundOnly=options.soundOnly;if(!mouseXPos)mouseXPos=400;if(!mouseYPos)mouseYPos=400;if(!mouse){new Insertion.Bottom(document.body,"<img src='/images/bigpointer.png' id='guided_tip_mouse' style='display: none;'/>");mouse=$('guided_tip_mouse');mouse.style.top=mouseYPos+"px";mouse.style.left=mouseXPos+"px";}
mouse.style.position='absolute';mouse.style.zIndex=11002;new Effect.Appear(mouse);if(!transitionTo){var anchor=element;var isOption=element.tagName=='OPTION';var select=$(anchor).up('select');var newXPos=null;var newYPos=null;if(isOption&&select&&select.id&&select.id.indexOf('_guided_selector')>0){newYPos=parseInt(select.style.top);newYPos=newYPos+((element.index+1)*18);newXPos=parseInt(select.style.left);}else{var anchorPos=Position.cumulativeOffset(anchor);newXPos=anchorPos[0];newYPos=anchorPos[1]+15;}
mouseYPos=newYPos;mouseXPos=newXPos;transitionTo="top: "+newYPos+"px; left:"+newXPos+"px;";}
var clicker=element.up('.clicker');var anchor=element.tagName=='A'?element:element.down('a');var skipClick=anchor&&clickUnless&&anchor.innerHTML.indexOf(clickUnless)>=0;emile(mouse,transitionTo,{duration:1000,easing:easeInOutCirc,after:function(){if(clicker)clicker.addClassName('button-behavior-hover');if(options.hover&&anchor)anchor.addClassName('guided_hover');R.guidedTips.playMouseSound(function(){if(element.tagName=='SELECT'){var newId=element.id+"_guided_selector";var newElement=$(newId);if(!newElement){newElement=document.createElement('SELECT');document.body.appendChild(newElement);}else{newElement.show();}
if(Browser.isMSIE()){for(var i=0;i<element.options.length;i++){newElement.options[i]=new Option(element.options[i].text,element.options[i].value,element.options[i].selected,element.options[i].selected);}}else{newElement.innerHTML=element.innerHTML;}
newElement.style.position='absolute';newElement.multiple=true;newElement.size=element.options.length;newElement.id=newId;newElement.className='guided_selector_contents';var offset=Position.cumulativeOffset(element);newElement.style.top=offset[1]+"px";newElement.style.left=offset[0]+"px";newElement.style.width=Element.getWidth(element)+"px";$(newElement).setStyle({'z-index':1000});emile('guided_tip_container','top:'+(offset[1]+Element.getHeight(newElement))+'px;',{after:function(){R.guidedTips.runNextScript();}});}else if(element.up('.guided_selector_contents')){element.style.backgroundColor='#B4F2AE';setTimeout(function(){element.up('.guided_selector_contents').hide();R.guidedTips.runNextScript();},1000);}else if(soundOnly){R.guidedTips.runNextScript();}else if(click&&!skipClick){if(options.func=='click'){element.click();}else if(element.onclick){element.onclick();}else if(anchor&&anchor.onclick){anchor.onclick();}else if(submit){form=element.up('form');if(!form.down('_tip')){new Insertion.Top(form,'<input type="hidden" style="display: none;" id="_tip" name="_tip" value="'+tipId+'"/>');}
if(!form.down('_step')){new Insertion.Top(form,'<input type="hidden" style="display: none;" id="_step" name="_step" value="'+currentStep+'"/>');}
if(form.onsubmit){form.onsubmit();}else{form.submit();}}
if(clicker)clicker.removeClassName('button-behavior-hover');if(options.hover&&anchor)anchor.removeClassName('guided_hover');R.guidedTips.runNextScript();}});}});},doPrepareForm:function(form){var step=document.createElement('input');step.type='hidden';step.name='_step';step.value=currentStep;form.appendChild(step);var tip=document.createElement('input');tip.type='hidden';tip.name='_tip';tip.value=tipId;form.appendChild(tip);R.guidedTips.runNextScript();},doBackspace:function(field){if(field.value==''){$(field).removeClassName('guided_tip_input');setTimeout(function(){R.guidedTips.runNextScript();},1000);}else{$(field).addClassName('guided_tip_input');R.guidedTips.playKeyboardSound();if(field.value.length==1){field.value='';}else{field.value=field.value.substring(0,field.value.length-2);}
setTimeout(function(){R.guidedTips.doBackspace(field);},100+(Math.random()*200));}},doInput:function(field,text,options){if(!options)options={};if(options.skipInit!==true){options.skipInit=true;$(field).addClassName('guided_tip_input');if(options.clear!==false){$(field).value="";}
$(field).focus();setTimeout(function(){if($('guided_tip_mouse')){new Effect.Fade($('guided_tip_mouse'),{to:0.2});}
R.guidedTips.doInput(field,text,options);},1000);}else if(text===""){$(field).removeClassName('guided_tip_input');setTimeout(function(){R.guidedTips.runNextScript();},1000);}else{var delay=options.delay||100;R.guidedTips.playKeyboardSound();if(!field.value)field.value="";field.value+=text.charAt(0);setTimeout(function(){R.guidedTips.doInput(field,text.substring(1),options);},delay+(Math.random()*200));}}};}();R.groups=function(){var menuFieldGroup=null;return{initialize:function(){R.forums.initializeTopic();R.controls.initializeOptionPickers();if($('group_category_options')){R.groups.initializeCategoryMenuFields();}
if($('page_index')){$$('#page_index tbody tr').each(function(element){Event.observe(element,'click',function(event){navigateToFirstLink(element);});});}
if($('projects')||$('yarns')){updateZoomables();}
if($('large_calendar')){$$('#large_calendar td').each(function(element){Event.observe(element,'click',function(event){navigateToFirstLink(element);});element.onmouseover=function(){Element.addClassName(this,'hover');};element.onmouseout=function(){Element.removeClassName(this,'hover');};});}
if($('filter_menu')){new R.controls.FilterMenu('filter_menu','filter_menu_options',{usePushState:false});}
Browser.onBreakpoints({mobile:function(){if($('group_index')){$('group_index_recently_started_container_mobile').appendChild($('group_index_recently_started'));$('group_index_memberships_container_mobile').appendChild($('group_index_memberships'));}},desktop:function(){if($('group_index')){$('group_index_recently_started_container').appendChild($('group_index_recently_started'));$('group_index_memberships_container').appendChild($('group_index_memberships'));}}});if($('group_index_search')){var searchForm=$('group_index_search');var sort=searchForm.down('.group_index_search__sort');searchForm.observe('submit',function(){if(searchForm.down('.group_index_search__query').value==''){sort.value='members';}else{sort.value='best';}});}
R.controls.initializeImageFields();},initializeCategoryMenuFields:function(){var menu=$('group_category_options');if(!menuFieldGroup){var selections=$$('input.group_category_id').map(function(f){return f.value;});menuFieldGroup=new R.controls.MenuFieldGroup({selections:selections});}
$$('.category_select').each(function(a){var group_id=$('categories').readAttribute('group_id');var params={'group_id':group_id};new R.controls.MenuField(a,{menuContent:menu,multiple:true,menuFieldGroup:menuFieldGroup,beforeToggle:function(clicked){return($(clicked).target.hasClassName('menu_field_chooser')||$(clicked).target.hasClassName('delete'));},onChange:function(newIdList){if($('yarncompany_ids')){params['yarncompany_ids']=$('yarncompany_ids').value;}
if($('patternauthor_ids')){params['patternauthor_ids']=$('patternauthor_ids').value;}
if($('shop_ids')){params['shop_ids']=$('shop_ids').value;}
if($('event_ids')){params['event_ids']=$('event_ids').value;}
params['group_category_id[]']=newIdList;new Ajax.Request("/groups/categories",{parameters:params});}});});},useAdditionalCategorySelect:function(){var parentNode=$('additional_category_select');var categories=$$('a.category_select').size();parentNode.down('a.prompt').hide();parentNode.down('a.menu_field').show();$('additional_category').show();},associateByName:function(select,owner_type,owner_id){var group_name=$F(select);if(group_name!=''){group_name=encodeURIComponent(group_name);var params="owner_type="+owner_type+"&owner_id="+owner_id+"&group_name="+group_name;Element.show('group_indicator');new Ajax.Request('/groups/associate_by_name',{method:'post',postBody:params,evalScripts:true,onComplete:function(){Element.hide('group_indicator')}});}},saveGroupAssociation:function(select,owner_type,owner_id){var params="owner_type="+owner_type+"&owner_id="+owner_id;var group_id=$F(select);if(group_id!=''){Element.show('group_indicator');new Ajax.Request('/groups/'+group_id+'/associate',{method:'post',postBody:params,evalScripts:true,onComplete:function(){Element.hide('group_indicator')}});}},linkByLinkingName:function(type){var type_id=$('id_'+type.toLowerCase());R.utils.addValueToField($(type.toLowerCase()+'_ids'),type_id.value);new Ajax.Request("/groups/linking_list?linking_id_list="+$(type.toLowerCase()+'_ids').value+"&type="+type,{onComplete:function(){$('group_'+type.toLowerCase()).value="";type_id.value="";}});},fillLinkingId:function(element,value){var hidden_id=element.id.gsub("group_","id_");var open_paren=value.innerHTML.lastIndexOf("(");var close_paren=value.innerHTML.lastIndexOf(")");var value_id=value.innerHTML.substring(open_paren+1,close_paren);$(hidden_id).value=value_id;},dropLinking:function(id,type){R.utils.removeValueFromField($(type.toLowerCase()+"_ids"),id);$(type.toLowerCase()+"_linking_"+id).remove();},disassociate:function(group_id,owner_type,owner_id,src){if(confirm('Are you sure that you want to remove this '+owner_type+' from the group?')){var params="owner_type="+owner_type+"&owner_id="+owner_id+"&src="+src;new Ajax.Request('/groups/'+group_id+'/disassociate',{method:'post',postBody:params,evalScripts:true});}},removeGroupAssociation:function(group_id,owner_type,owner_id){var params="owner_type="+owner_type+"&owner_id="+owner_id;new Ajax.Request('/groups/'+group_id+'/disassociate',{method:'post',postBody:params,evalScripts:true,onComplete:function(){Element.hide('group_indicator')}});},searchDialog:function(){var url='/groups/search_dialog?q='+name;RedBox.open('group_dialog_box',url);},resort:function(sort){document.location.href="?sort="+R.utils.selectedValue(sort);},showMoreAssociations:function(showMore){$$('ul.associations li.hidden_association').each(function(li){if(showMore){li.show();}else{li.hide();}});if(showMore){$('less_group_associations').show();$('more_group_associations').hide();}else{$('less_group_associations').hide();$('more_group_associations').show();}},pop:function(content){var anchor=$('group_status').down('a.clicker');R.popover.pop(anchor,content,{orientation:'right'});}};}();Object.extend(Event,{KEY_SHIFT:16,KEY_CONTROL:17,KEY_CAPSLOCK:20,KEY_SPACE:32,keyPressed:function(event){return Browser.isMSIE()?window.event.keyCode:event.which;}});HelpBalloon=function(options){this.options=Object.extend({dataURL:null,content:'Content',duration:0.20,useEvent:['click'],imagePath:'/images/',method:'GET'},options||{});this.elements={container:null,inner:null,icon:null,content:null,button:null,arrow:null};this.properties={id:"HelpBalloon_"+Math.random().toString(36).substr(2),balloons:['help_bubble help_bubble--tl','help_bubble help_bubble--tr','help_bubble help_bubble--bl','help_bubble help_bubble--br'],balloonStyle:{position:'absolute',zIndex:1010,visibility:'hidden'},containerWidth:null,containerHeight:null,button:this.options.imagePath+'close.gif',visible:false,balloonCoords:null,pointerDims:[20,25],buttonHeight:16,drawn:false,contentLoaded:false,xOffset:35,yOffset:-30};if(R&&R.swatch&&R.swatch.isSwatching('FRONTEND12')){this.properties.button=this.options.imagePath+'assets/icons/ui/x.svg';this.properties.buttonHeight=12;}
this.elements.container=document.createElement('div');this.elements.container._HelpBalloon=this;};HelpBalloon.prototype.toggle=function(e){if(!e)e=window.event||{type:this.options.useEvent,target:this.elements.icon};var icon=Event.element(e);if(e.type==this.options.useEvent&&!this.properties.visible&&icon==this.elements.icon){this.show();}else{this.hide();}};HelpBalloon.prototype.show=function(){if(!this.properties.drawn){var me=this;this.draw(function(){me.reposition();me.hideOtherHelps();new Effect.Appear(me.elements.container,{duration:me.options.duration});setTimeout(function(){me.elements.container.style.display='block';},(me.options.duration*1000));me.properties.visible=true;Event.observe(window,'resize',function(){me.reposition();});});}};HelpBalloon.prototype.hide=function(){Effect.Fade(this.elements.container,{duration:this.options.duration});setTimeout(function(){this.elements.container.style.display='none';}.bind(this),this.options.duration*1000);this.properties.visible=false;Event.stopObserving(window,'resize',this.reposition.bindAsEventListener(this));return;};HelpBalloon.prototype.reposition=function(){this.properties.balloonCoords=this.getXY(this.elements.icon);this.properties.balloonCoords.x+=Math.round($(this.elements.icon).getWidth()/2)+this.properties.xOffset;this.properties.balloonCoords.y+=Math.round($(this.elements.icon).getHeight()/2)+this.properties.yOffset;var pos=0;var relativeToViewport=Position.page(this.elements.icon);var oh=relativeToViewport[0]+this.properties.containerWidth;var ov=relativeToViewport[1]-this.properties.containerHeight;if(ov>0)pos+=2;var ww=Browser.isMSIE()?document.body.clientWidth:window.outerWidth;if(oh>ww)
pos+=1;this.elements.container.className=this.properties.balloons[pos];var cx=0;var cy=0;var zx=0;var zy=0;switch(pos)
{case 1:cx=this.properties.pointerDims[0];cy=this.properties.pointerDims[1];zx=this.properties.balloonCoords.x-this.properties.containerWidth;zy=this.properties.balloonCoords.y;break;case 2:cx=this.properties.pointerDims[0];cy=this.properties.pointerDims[1];zx=this.properties.balloonCoords.x;zy=this.properties.balloonCoords.y-this.properties.containerHeight;break;case 3:cx=this.properties.pointerDims[0];cy=this.properties.pointerDims[1];zx=this.properties.balloonCoords.x-this.properties.containerWidth;zy=this.properties.balloonCoords.y-this.properties.containerHeight;break;default:case 0:cx=this.properties.pointerDims[0];cy=this.properties.pointerDims[1];zx=this.properties.balloonCoords.x;zy=this.properties.balloonCoords.y;break;}
this.elements.container.style.left=zx+"px";this.elements.container.style.top=zy+"px";};HelpBalloon.prototype.draw=function(callback){Element.setStyle(this.elements.container,this.properties.balloonStyle);if(this.options.dataURL&&!this.properties.contentLoaded){var me=this;new Ajax.Request(this.options.dataURL,{method:this.options.method,onComplete:function(xhr){var content=xhr.responseText;me.properties.contentLoaded=true;me.elements.inner=document.createElement('div');me.elements.inner.className='help_bubble__container';var closer=new Image(me.properties.buttonHeight,me.properties.buttonHeight);closer.src=me.properties.button;Event.observe(closer,'click',function(){me.toggle();});closer.style.cursor='pointer';closer.title='Click to close this balloon';closer.style.float='right';me.elements.inner.appendChild(closer);var contents=document.createElement('div');contents.className='help_bubble__content';contents.innerHTML=content;me.elements.inner.appendChild(contents);me.elements.arrow=document.createElement('div');me.elements.arrow.className='help_bubble__container__arrow';me.elements.inner.appendChild(me.elements.arrow);me.elements.container.appendChild(me.elements.inner);document.getElementsByTagName('body')[0].appendChild(me.elements.container);me.properties.containerWidth=$(me.elements.container).getWidth();me.properties.containerHeight=$(me.elements.container).getHeight();me.elements.container.style.display='none';me.elements.container.style.visibility='visible';me.properties.drawn=true;callback();}});return;}};HelpBalloon.prototype.getXY=function(obj){var pos=Position.cumulativeOffset(obj);var y=pos[1];var x=pos[0];var x2=x+parseInt(obj.offsetWidth,10);var y2=y+parseInt(obj.offsetHeight,10);return{'x':x,'y':y,'x2':x2,'y2':y2};};HelpBalloon.prototype.hideOtherHelps=function(e){if(!e)e=window.event;var divs=document.getElementsByTagName('div');for(var i=0;i<divs.length;i++)
{if(divs[i]._HelpBalloon&&divs[i]._HelpBalloon.properties.visible&&(divs[i]!=this.elements.container))
divs[i]._HelpBalloon.toggle(e);}};R.history=function(){var handler=null;return{initialize:function(handler){iframe=$('history-manager-iframe');if(iframe==null){new Insertion.Bottom(document.body,"<iframe id='history-manager-iframe' src='/blank.html' style='width:0;height:0;display:none;'>");iframe=$('history-manager-iframe');}
LocationHash.init(handler,iframe);},go:function(newHash){LocationHash.go(newHash);}};}();R.invitations=function(){return{initialize:function(){if($('guest')){$('guest').value='Y';}
var label=$('usability_tester_label');if(label){label.onclick=function(){label.previous('.ticky_box').onclick();};}}};}();R.issues=function(){var cancelNavigate=false;return{track:function(postId){new Ajax.Request('/issues/'+postId+'/mini',{method:'get'});},initialize:function(){triggeredMarkdownEditor('issue_description');R.utils.applyFancyTables();},quickVote:function(id){var url='/issues/'+id+'/quick_vote';new Ajax.Request(url,{method:'get'});}};}();R.library=function(){var expansionInitialized=false;var resizeTimeout=null;var usingShelfLabels=false;var expandToFitExtraHeight=50;var firstSortPosition=null;var lastSortPosition=null;var currentlyEditingSort=null;var afterUpgrade=null;return{initialize:function(){if($('shelved_books')){R.library.loadShelfLabels();Event.observe(window,'resize',function(){if(resizeTimeout){clearTimeout(resizeTimeout);}
resizeTimeout=setTimeout(function(){R.library.loadShelfLabels();},500);});if($('volumes').hasClassName('sortable')){var url=R.utils.prependPath('update_custom_sort');repositionable=new R.controls.RepositionableList({'container_id':'shelved_books','repositionableItemClass':'volume','positionLinkClass':'volume_position','updateUrl':url});repositionable.enableSorting();}else{R.library.disableSorting();}}
$$('#library_navigation li.selected a').each(function(a){a.observe('click',function(e){var fullMenuVisible=!$('new_library').hasClassName('library--with_search');var breakpoint=Browser.responsiveBreakpoint();if(!fullMenuVisible&&breakpoint){var className='library_navigation--expanded';if($('library_navigation').hasClassName(className)){$('library_navigation').removeClassName(className);}else{$('library_navigation').addClassName(className);}
e.preventDefault();}});});R.controls.initializeOptionPickers();$$('.touch_gallery').each(function(gallery){var trigger=gallery.up('.volume_cover').down('.volume_cover__heading__icon');new R.controls.TouchGallery(gallery,{variableHeight:true,trigger:trigger,useDots:true});});var openVolumeId=$H(document.location.href.parseQuery())['volume_id'];if(openVolumeId&&$('volume_'+openVolumeId)){R.library.showVolume(openVolumeId);}
R.library.addDownloadAttributes();window.mobileExperience=new R.controls.MobileExperience({lazyLoadImages:true});},addDownloadAttributes:function(){document.querySelectorAll('a[href*="ravelry.com/download/"]').forEach(function(a){if(/\/checkout$/.test(a.href)){a.setAttribute('download','');}});},disableSorting:function(){},filterChanged:function(select){select=$(select);var option=R.utils.selectedValue(select);var pair=option.split(':');var key=pair[0],value=pair[1];$('set_field').value='';$('type_field').value='';$(key+'_field').value=value;select.up('form').submit();},buttonBox:function(options){options=options||{};var refresh=options.refresh;var buttonBox=$('button_box');var anchor=buttonBox.down('.library_button');var orientation='right';if(buttonBox.hasClassName('left_oriented')){orientation='left';};if(!options.refresh){R.popover.pop(anchor,"",{orientation:orientation,promptOnUnsavedChanges:true,disableCloseEvents:true});}
if(options&&options.replace){new Ajax.Request('/volumes/'+options.replace,{method:'delete'});}
var url=R.utils.prependPath('prepare_add_to_library',true);var parameters={};if(options.url){url=options.url+'/prepare_add_to_library';}
new Ajax.Request(url,{asynchronous:true,parameters:parameters,evalScripts:true,method:'post',onComplete:function(){R.popover.enableCloseEvents();R.popover.recalculateHeight();R.controls.refreshButtonBox();setTimeout(function(){R.popover.recalculateHeight();},500);if(R.swatch&&R.swatch.isSwatching('FRONTEND12')){var actionSheet=$('popover_action_sheet');if(actionSheet){R.controls.actionSheet(actionSheet);}}}});},quickAdd:function(caller,options,e){var evt=e||window.event;if(evt)Event.stop(evt);var url=R.utils.prependPath('add_to_library');var delay=500;if(options&&options.url){url=options.url+'/add_to_library';}
if(options&&options.confirm){url+='?confirm=1';}
var ajaxIndicator='<div style="text-align: center;">'+R.controls.tinyLoaderHTML()+'</div>';caller.up().innerHTML=ajaxIndicator;setTimeout(function(){new Ajax.Request(url,{method:'post'});},delay);},initializeExpandVolumes:function(){if(!expansionInitialized){expansionInitialized=true;Element.observe(document,'click',function(e){var clicked=Event.element(e);if(!R.popover.isVisible()){$$('.expanded_volume').each(function(volume){var wtf=clicked.up('*')==undefined;if(!wtf&&!clicked.up('.volume')&&!clicked.up('.expanded_volume')&&!$('guided_tip_container')&&!clicked.up('.popover')&&!clicked.hasClassName('show_volume')&&(clicked!=volume)){new Effect.Fade(volume,{duration:0.1,afterFinish:function(){volume.remove();}});}});}});}},closeExpandedVolumes:function(){R$$('.expanded_volume').each(function(volume){volume.remove();});if(Browser.responsiveBreakpoint()){R.utils.scrollToSavePoint();}},showVolumeForPattern:function(patternId){new Ajax.Request('/volumes/find_first_volume?pattern_id='+patternId,{onComplete:function(xhr){var json=xhr.responseText.evalJSON();R.library.showVolume(json.id,{anchor:$('volume_for_pattern_'+patternId)});}});},showVolume:function(volumeId,options){R.utils.saveScrollPosition();if(!options)options={};if(!options.keepPopovers)R.popover.close();var positionOnScreen=!Browser.responsiveBreakpoint();var actionSheet=null;R.library.closeExpandedVolumes();var buttonBox=$('button_box');var expanded=$('expanded_volume_'+volumeId);if(!expanded){expanded=document.createElement('div');expanded.className='expanded_volume volume_details volume_thumbnails';expanded.id='expanded_volume_'+volumeId;if(R.swatch&&R.swatch.isSwatching('FRONTEND12')&&Browser.responsiveBreakpoint()){actionSheet=R.controls.buildActionSheet(null,'fullscreen');actionSheet.appendChild(expanded);}else if($('new_library')){$('new_library').appendChild(expanded);}else{$('content').appendChild(expanded);}}else{if(R.swatch&&R.swatch.isSwatching('FRONTEND12')&&Browser.responsiveBreakpoint()){actionSheet=expanded.up('.action_sheet');if(!actionSheet){actionSheet=R.controls.buildActionSheet(actionSheet,'fullscreen');}}}
var anchor=null;if(options.anchor){anchor=options.anchor;}else if(buttonBox){anchor=buttonBox.down('a.library_button');}else{var volume=$('volume_'+volumeId);anchor=volume.down('.cover')||volume;}
if(positionOnScreen){expanded.style.width=anchor.getWidth()+'px';expanded.style.height=anchor.getHeight()+'px';expanded.style.position='absolute';}
var position=Position.cumulativeOffset(anchor);var viewportHeight=document.viewport.getHeight();var viewportWidth=document.viewport.getWidth();var expandedWidth=720;var expandedHeight=420;if(!(R.swatch&&R.swatch.isSwatching('FRONTEND12'))){if(positionOnScreen){expanded.style.top=position[1]+'px';expanded.style.left=position[0]+'px';}}
if(R.swatch&&R.swatch.isSwatching('FRONTEND12')){expanded.style.left="calc(50vw - 400px);";}
var nudgeLeft=(position[0]-expandedWidth)*0.25;var newLeft=Math.round(nudgeLeft+(viewportWidth/2)-(expandedWidth/2));var scrollTop=window.pageYOffset||document.documentElement.scrollTop||document.body.scrollTop;var nudgeTop=(position[1]-expandedHeight-scrollTop)*0.25;var newTop=Math.round(nudgeTop+scrollTop+(viewportHeight/2)-expandedHeight+240);var style="top: "+newTop+"px; left: "+newLeft+"px; width: "+expandedWidth+"px; height: "+expandedHeight+"px;";if(R.swatch&&R.swatch.isSwatching('FRONTEND12')){style="top: "+newTop+"px; width: "+expandedWidth+"px; height: "+expandedHeight+"px;";}
var animator=emile;if(!positionOnScreen){animator=function(object,style,options){options.after();if(!(R.swatch&&R.swatch.isSwatching('FRONTEND12'))){R.utils.scrollToTop();}};}else if(options.animate===false||(R.swatch&&R.swatch.isSwatching('FRONTEND12'))){animator=function(object,style,options){object.style.top=newTop+"px";object.style.width=expandedWidth+"px";object.style.height=expandedHeight+"px";if(R.swatch&&R.swatch.isSwatching('FRONTEND12')){object.style.left="calc(50vw - 400px)";}else{object.style.left=newLeft+"px";}
options.after();};}
animator(expanded,style,{duration:200,after:function(){if(positionOnScreen){if(R.swatch&&R.swatch.isSwatching('FRONTEND12')){expanded.innerHTML="<div class='loading_indicator loading_animation'></div>";}else{expanded.innerHTML="<img class='loading_indicator' src='/images/bar-indicator-2.gif' title='Loading...'/>";}}
var url='/volumes/'+volumeId+'/expanded';if(buttonBox){url+='?button_box=1&show_library_link=1';}else if(!$('new_library')){url+='?show_library_link=1';}
new Ajax.Request(url,{method:'get',onComplete:function(){R.library.initializeExpandVolumes();new Draggable(expanded,{handle:expanded.down('.drag_bar')});R.library.volumeLoaded(volumeId);if(actionSheet){R.controls.actionSheet(actionSheet.id);}}});}});},updateCounts:function(){if(!$('new_library')){return;}
var url=R.utils.prependPath('update_counts',true);new Ajax.Request(url,{method:'get',onComplete:function(xhr){var counts=xhr.responseText.evalJSON();for(key in counts){var count=$("count_"+key);var value=counts[key];if(count&&parseInt(count.innerHTML)!=value){count.innerHTML=value;if(R.themes.isDarkMode()){new Effect.Highlight(count,{startcolor:'#3852a8',endcolor:'#2a2f41'});}else{new Effect.Highlight(count,{startcolor:'#ffffff',endcolor:'#ecfde1'});}}}
var updates=$('updates_available');var updateCount=counts['updates_available'];if(updates&&updateCount){updates=updates.down('a');if(updateCount==0){updates.hide();}else if(updateCount==1){updates.innerHTML=updateCount+'update available';}else{updates.innerHTML=updateCount+'updates available';}}}});},updateCollections:function(){var url=R.utils.prependPath('update_collections',true);new Ajax.Request(url,{method:'get'});},appendCollectionToVolumes:function(collectionId,collectionName){$$('.batch_collection_editor ul').each(function(list){R.volumes.cancelAddCollection(list);var volumeId=getId(list.up('.volume'));var onclick="R.controls.tickyBox(this, '/volume_collections/"+collectionId+"/change_membership', 'volumes["+volumeId+"]', {}); return false;";var newLink="<a class=\"ticky_box\" onclick=\""+onclick+"\"></a>";var newHTML="<li><div class=\"ticky_item\">"+newLink+collectionName+"</div></li>";new Insertion.Bottom(list,newHTML);});},autocompleteUpdateElement:function(selected){$('pattern_source_id').value='';if(!$(selected).hasClassName('instructions')){var title=selected.down('.title');if(title){$('import_titles').value=Element.collectTextNodes(title);$('pattern_source_id').value=getId(selected);}}
var form=selected.up('form');form.submit();},spellingCorrectionReceived:function(itemId,word){var item=$('library_import_item_'+itemId);if(item){var link="<a href='#'>"+word.escapeHTML()+"<a>";var correction=item.down('.correction');correction.innerHTML="Did you mean "+link+"?";correction.down('a').onclick=function(){new Ajax.Request('/library_import_items/'+itemId,{method:'put',parameters:{'library_import_item[name]':word}});return false;};}},reviewImport:function(id){var url=R.utils.prependPath('imports/'+id+'/review',true);document.location.href=url;},textAreaChanged:function(textarea){var clicker=$(textarea).up('form').down('.clicker');var lines=(textarea.value||"").split(/\n/);var lineCount=lines.size();var chunks=Math.ceil(lineCount/4);if(chunks<4){var newSize=(chunks*8)+"em";if(textarea.style.height!=newSize){textarea.style.height=newSize;window.scrollTo(0,Position.cumulativeOffset(clicker)[1]-400);}}
var nonEmpty=0;for(var i=0;i<lines.length;i++){if(!lines[i].match(/^[\s\t]*$/)){nonEmpty++;}}
var label=clicker.down('span');if(nonEmpty==0){label.innerHTML='add these items';}else if(nonEmpty==1){label.innerHTML='add this item';}else if(nonEmpty>1){label.innerHTML='add these '+nonEmpty+' items';}},editNotes:function(volumeId){new Ajax.Request('/volumes/'+volumeId+'/edit_notes',{method:'get',onComplete:function(){R.library.expandToFit(volumeId);}});},deleteVolume:function(id,name){if(confirm('Are you sure that you want to remove '+name+' from your library?')){new Ajax.Request('/volumes/'+id,{method:'delete'});}},deleteRelatedVolumes:function(id,name){if(confirm('Are you sure that you want to remove '+name+' from your library?')){new Ajax.Request('/volumes/destroy_related?id='+id,{method:'delete'});}},prepareUpgrade:function(id,options){afterUpgrade=options&&options.afterUpgrade;RedBox.open('prepare_upgrade',"/volumes/"+id+"/prepare_upgrade",{method:'get',actionSheet:'fullscreen'});},upgrade:function(id,params){if($('RB_window'))RedBox.close();if(!params)params={};var updateButton=$$('#volume_'+id+' .update_button').first();if(updateButton){updateButton.style.textAlign='center';updateButton.innerHTML='<img src="/images/arrows-indicator.gif" style="width: 16px; height: 16px;"/>';}
if($('view_selector')){var currentView=$('view_selector').down('.selected a').href.toQueryParams()['view'];params=$H(params).merge({view:currentView});}
new Ajax.Request('/volumes/'+id+'/upgrade',{parameters:params,method:'post'});},markAsUpgraded:function(volumeId,newVolumeId){var volume=$('volume_'+volumeId);setTimeout(function(){volume.down('.update_button').hide();var openLink=volume.down('.after_update a');new Effect.SlideUp(volume.down('.before_update'),{afterFinish:function(){if(newVolumeId){openLink.onclick=function(){R.library.showVolume(newVolumeId,{anchor:volume});return false;};}
new Effect.SlideDown(volume.down('.after_update'));}});},500);},upgradeComplete:function(upgradedId,removedIds,addedIds,insertHTML){var anchor=$('volume_'+upgradedId);var popover=$('popover_body');if(popover&&popover.down('.add_to_library')){R.library.buttonBox({refresh:true});}
if(afterUpgrade){afterUpgrade();}
if(!anchor){return false;}
if(!$('new_library')){R.library.upgradeCompleteLegacy(upgradedId,removedIds,addedIds,insertHTML);return;}
var anchor=$('volume_'+upgradedId);new Insertion.Before(anchor,insertHTML);var parallels=$A([]);var updateButton=$$('#volume_'+upgradedId+' .update_button').first();if(updateButton){updateButton.innerHTML='';}
$A(removedIds).each(function(id){var volume=$('volume_'+id);if(volume){parallels.push(new Effect.Fade(volume,{sync:true}));}});$A(addedIds).each(function(id){parallels.push(new Effect.Appear($('volume_'+id),{sync:true}));});new Effect.Parallel(parallels,{});},upgradeCompleteLegacy:function(upgradedId,removedIds,addedIds,insertHTML){var anchor=$('volume_'+upgradedId);new Insertion.Before(anchor,insertHTML);var parallels=$A([]);$A(removedIds).each(function(id){var volume=$('volume_'+id);if(volume){parallels.push(new Effect.Fade(volume,{sync:true}));}});$A(addedIds).each(function(id){parallels.push(new Effect.Appear($('volume_'+id),{sync:true}));});new Effect.Parallel(parallels,{});},toggleUpgradeHistory:function(caller){$(caller).up('.product_upgrade').down('.update_history').toggle();},tabDetails:function(volumeId){new Ajax.Request('/volumes/'+volumeId,{method:'get',onComplete:function(){R.library.activateTab(volumeId,'details');}});},tabReviews:function(volumeId){new Ajax.Request('/volumes/'+volumeId+"/reviews",{method:'get',onComplete:function(){R.library.activateTab(volumeId,'reviews_tab');}});},updateNotesTab:function(volumeId,hasNotes){var titleTag=$('volume_'+volumeId+'_tab_content').up('.volume_details').down('li.notes_tab a');titleTag.innerHTML=hasNotes?'notes':'no notes';},tabNotes:function(volumeId){new Ajax.Request('/volumes/'+volumeId+"/notes",{method:'get',onComplete:function(){R.library.activateTab(volumeId,'notes_tab');}});},tabNotesEdit:function(volumeId){var url='/volumes/'+volumeId+'/edit_notes';var content=$('volume_'+volumeId+'_tab_content');if(content.up('.volume_details').down('li.details').hasClassName('selected')){url+='?from=details';}
new Ajax.Request(url,{method:'get',onComplete:function(){R.library.activateTab(volumeId,'notes_tab');}});},tabPatterns:function(volumeId,type){var append=Browser.responsiveBreakpoint()?1:0;var url='/volumes/'+volumeId+'/patterns?append='+append;if(type){url+="&type="+type;}
new Ajax.Request(url,{method:'get',onComplete:function(){R.library.activateTab(volumeId,'patterns_tab');}});},volumeLoaded:function(volumeId){R.library.expandToFit(volumeId);R.library.addDownloadAttributes();if(R.swatch&&R.swatch.isSwatching('FRONTEND12')){if(Browser.responsiveBreakpoint()){$$('.photo_lazy').each(function(img){if(!img.__blurup&&img.getAttribute('data-photo-url')){img.__blurup=true;img.observe('load',function(){if(img.src==img.getAttribute('data-photo-url')){img.addClassName('photo_lazy--loaded');}});img.src=img.getAttribute('data-photo-url');}});}
if($('responsive_volume_details_personal')){if(R.swatch&&R.swatch.isSwatching('FRONTEND12')&&!Browser.responsiveBreakpoint()){}else{$('responsive_volume_details_personal').appendChild($('volume_details_personal'));}}
$$('.shelf_image__large_image').each(function(img){img.src=img.getAttribute('data-uncropped-image-src');});$$('.volume_details__download__large_thumbnail').each(function(img){img.src=img.getAttribute('data-large-thumbnail-url');});if(R.swatch&&R.swatch.isSwatching('FRONTEND12')){if(Browser.responsiveBreakpoint()){$$('.volume_details__download').each(function(element){var smallThumbnail=element.down('.volume_details__download__thumbnail');var thumbnail=element.down('.volume_details__download__large_thumbnail');if(thumbnail&&smallThumbnail){smallThumbnail.src=thumbnail.getAttribute('data-large-thumbnail-url');}});}}
if(!(R.swatch&&R.swatch.isSwatching('FRONTEND12'))||Browser.responsiveBreakpoint()){mobileExperience.activatePanel('volume_id',volumeId);R.library.tabPatterns(volumeId);}}},expandToFit:function(volumeId,animate){var volume=$('expanded_volume_'+volumeId);var containerToResize=null;if(volume){volume.style.height='auto';containerToResize=volume.down('.volume');}else{volume=$('volume_'+volumeId);containerToResize=volume.down('.volume_details');}
if(!Browser.responsiveBreakpoint()){var contentHeight=volume.down('.tab_content').getHeight();if(R.swatch.isSwatching('FRONTEND12')){expandToFitExtraHeight=100;}
var newHeight=contentHeight+expandToFitExtraHeight;if(animate===false){emile(containerToResize,'min-height: '+newHeight+'px;',{duration:750});}else{containerToResize.style.minHeight=newHeight+'px';R.utils.makeRoom(containerToResize);}}},activateTab:function(volumeId,tabClass){var volume=$('expanded_volume_'+volumeId);var expanded=volume!=null;if(!expanded)volume=$('volume_'+volumeId);volume.getElementsBySelector('.tab').each(function(tab){tab.removeClassName('selected');});volume.down('.'+tabClass).addClassName('selected');R.library.expandToFit(volumeId);},revokeVolume:function(volume_id){var url=R.utils.prependPath('revoke_volume');new Ajax.Request(url+"/"+volume_id);},reloadShelfLabels:function(){if(usingShelfLabels){R.library.loadShelfLabels();}},loadShelfLabels:function(){usingShelfLabels=true;var currentOffset=null;var shelfStarts=$A([]);var volumes=$A([]);var shelfIndex=1;if(R.swatch&&R.swatch.isSwatching('FRONTEND12')){shelfIndex=0;}
R$$('#shelved_books .volume').each(function(volume){if(volume.visible()){volume.setAttribute('data-shelf-index',null);if(currentOffset==null||(currentOffset>volume.offsetLeft)){shelfStarts.push(getId(volume));volume.setAttribute('data-shelf-index',shelfIndex);shelfIndex++;}
volumes.push(getId(volume));currentOffset=volume.offsetLeft;}});var url=R.utils.prependPath('shelf_labels',true);url+='?volumes='+volumes.join(',');url+="&shelf_starts="+shelfStarts.join(',');var sort=null;var sorter=$('volumes_header').down('a.sorted');if(sorter){sort=(sorter.href+"").toQueryParams()['sort'];}
if(sort){url+="&sort="+(sort+'_').replace('__','');}
new Ajax.Request(url,{onComplete:function(xhr){var labels=xhr.responseText.evalJSON();R.library.displayShelfLabels(labels);}});},displayShelfLabels:function(labels){var shelf=$('shelved_books');R$$('#shelved_books div.shelf_label').each(function(e){e.remove();});if(R.swatch.isSwatching('FRONTEND12')){if(labels.length>2){var previousLabel="";R$$('#shelved_books .volume').each(function(volume){var index=volume.getAttribute('data-shelf-index');if(index){var label=labels[index-1];if(label&&previousLabel!=label){var labelDiv=document.createElement('div');labelDiv.innerHTML=label;labelDiv.className='shelf_label';volume.insertBefore(labelDiv,volume.firstChild);}}});}}
if(!R.swatch.isSwatching('FRONTEND12')){var previousLabel="";$A(labels).each(function(label,index){if(previousLabel!=label){var topPosition=(6+shelf.offsetTop+(200*(index+1)))+"px";var labelDiv=document.createElement('div');labelDiv.innerHTML=label;labelDiv.className='shelf_label';labelDiv.style.top=topPosition;shelf.appendChild(labelDiv);}
previousLabel=label;});}}};}();R.libraryImport=function(){var closeExpansionOnClick=null;var BOOK_DOCUMENT_TYPE_ID=2;return{changeSearch:function(libraryItemId){if($('import_titles')){R.libraryImport.hideOtherMatches();window.scrollTo(0,0);$('import_titles').focus();}else{new Ajax.Request('/library_import_items/'+libraryItemId+"/edit",{method:'get'});}},showOtherMatches:function(listItem){$(listItem).up('ul').addClassName('expanded_match_options');if(!closeExpansionOnClick){closeExpansionOnClick=Event.observe(document.body,'click',function(e){var from=Event.element(e||window.event);if(from&&!from.match('.match_options')&&!from.up('.match_options')){R.libraryImport.hideOtherMatches();}});}},hideOtherMatches:function(listItem){R$$('ul.expanded_match_options').each(function(ul){ul.removeClassName('expanded_match_options');});},setPreferredMatch:function(libraryItemId,documentTypeId,documentId){var url='/library_import_items/'+libraryItemId+'/set_preferred_match';var params={'document_id':documentId,'document_type_id':documentTypeId};new Ajax.Request(url,{parameters:params,onComplete:function(){if($('short_import_form')){window.scrollTo(0,0);}}});},refreshLibraryItem:function(libraryItemId,documentTypeId,documentId){var url='/library_import_items/'+libraryItemId+'/refresh';var params={'document_id':documentId,'document_type_id':documentTypeId};new Ajax.Request(url,{parameters:params,method:'get'});},updateLibraryStatus:function(caller,inLibrary){var mark=caller.up('.pattern_source');if(!mark)mark=caller.up('.library_import_item');inLibrary?mark.addClassName('in_library'):mark.removeClassName('in_library');var cover=mark.down('.cover_image img');if(cover){new Effect.Appear(cover);}},removeVolume:function(caller,volumeId,libraryItemId,documentTypeId,documentId){var url='/volumes/'+volumeId+'?from=import';new Ajax.Request(url,{method:'delete',onComplete:function(){R.libraryImport.updateLibraryStatus(caller,false);R.libraryImport.refreshLibraryItem(libraryItemId,documentTypeId,documentId);R.library.updateCounts();}});},prepareCustom:function(libraryItemId,params){R.upload.onSuccess(function(id){$('file_chooser').src=$('file_chooser').src;});var url='/library_import_items/'+libraryItemId+'/prepare_custom';new Ajax.Request(url,{method:'get',parameters:params||{}});},checkForBook:function(libraryItemId,jobKey){var form=$$("#library_item_"+libraryItemId+" form").first();if(form){}
setTimeout(function(){var url='/library_import_items/'+libraryItemId+'/check_for_book';url+="?job_key="+jobKey;new Ajax.Request(url,{method:'get'});},250);},bookImportCompleted:function(libraryItemId,bookId){R.libraryImport.setPreferredMatch(libraryItemId,BOOK_DOCUMENT_TYPE_ID,bookId);},previewCoverUpload:function(photo,params){R.volumes.previewCoverUpload(photo,params);},remove:function(caller,libraryItemId,documentTypeId,documentId){var params={'document_type_id':documentTypeId,'document_id':documentId};var url='/library_import_items/'+libraryItemId+'/remove_from_library';new Ajax.Request(url,{parameters:params,onComplete:function(){R.libraryImport.updateLibraryStatus(caller,false);}});},add:function(caller,libraryItemId,documentTypeId,documentId,containerId){var item=$("library_import_item_"+libraryItemId);var partOfGroup=item.down('.pattern_sources_window')!=null;var cover=null;if(partOfGroup){cover=$(caller).up('.pattern_source').down('.cover_image img');}else{cover=item.down('.import_image img');}
var position=Position.cumulativeOffset(cover);var adderId="add_"+libraryItemId+"_"+documentId;var adder=$(adderId);if(!adder){new Insertion.Bottom(document.body,"<img id='"+adderId+"'></div>");adder=$(adderId);}
adder.style.width='auto';adder.style.height='auto';adder.style.display='block';adder.style.position='absolute';adder.style.top=position[1]+'px';adder.style.left=position[0]+'px';adder.src=cover.src;var top=Position.cumulativeOffset($(containerId||'type_pdf'))[1];new Effect.Fade(cover,{to:0.5});emile(adder,"top: "+(top+8)+"px; left: 200px; height: 16px; width: 16px;",{duration:500,easing:function(pos){if((pos/=0.5)<1)return-0.5*(Math.sqrt(1-pos*pos)-1);return 0.5*(Math.sqrt(1-(pos-=2)*pos)+1);},after:function(){new Effect.Fade(adder);var params={'document_type_id':documentTypeId,'document_id':documentId};new Ajax.Request('/library_import_items/'+libraryItemId+"/add_to_library",{parameters:params,onComplete:function(){if(partOfGroup){R.libraryImport.updateLibraryStatus(caller,true);}else{R.libraryImport.refreshLibraryItem(libraryItemId,documentTypeId,documentId);}}});}});}};}();R.logger={toggle:function(){},move:function(){},resize:function(){},clear:function(){},debug:function(){},info:function(){},warn:function(){},error:function(){},profile:function(){}};R.maps=function(){return{nearby:function(){navigator.geolocation.getCurrentPosition(function(pos,error){if(pos&&pos.coords&&!(error&&error.code)){document.location.href='/shops/search#lat='+pos.coords.latitude+"&lng="+pos.coords.longitude;}});},geocodeForm:function(form,input,options){input=$(input);options=$H({address:'address_field',latitude:'lat_field',longitude:'lng_field',accuracy:'accuracy_field',geocoded:'geo_field',submit:true}).merge(options);if(input.value===''){return true;}
if(options.geocoded&&$(options.geocoded).value!==''){return true;}
if(options.indicator){var indicator=options.indicator;if(indicator==true){Element.show('default_indicator');}else if(indicator){Element.show(indicator);}}
var form=form;R.maps.geocode(input.value,function(results){if(typeof results.Status!='undefined'){var success=results.Status.code==200&&results.Placemark.length>0;if(options.geocoded)$(options.geocoded).value=success;if(success){var placemark=results.Placemark[0];$(options.latitude).value=placemark.Point.coordinates[1];$(options.longitude).value=placemark.Point.coordinates[0];$(options.address).value=placemark.address;if(options.accuracy){$(options.accuracy).value=placemark.AddressDetails.Accuracy;}
input.setAttribute('data-geocoded-value',input.value);if(options.submit)form.submit();if(options.callback)options.callback();}}else{var result=results[0];$(options.latitude).value=result.geometry.location.lat();$(options.longitude).value=result.geometry.location.lng();$(options.address).value=result['formatted_address'];input.setAttribute('data-geocoded-value',input.value);if(options.submit)form.submit();if(options.callback)options.callback();}});return false;},geocode:function(address,callback){if(window.google&&window.google.maps&&window.google.maps.Geocoder){var geocoder=new google.maps.Geocoder();geocoder.geocode({'address':address},function(results,status){if(status==google.maps.GeocoderStatus.OK){callback(results);}});}else{var geocoder=new GClientGeocoder();geocoder.getLocations(address,callback);}},startDrivingDirections:function(){var dd=$('driving_directions_entry');if(Element.visible(dd)){new Effect.SlideUp(dd);}else{new Effect.SlideDown(dd);$('address').focus();}},finishDrivingDirections:function(form,baseUrl){var saddr=$(form).down('#address').value;var url=baseUrl+"&saddr="+saddr;window.open(url);$('driving_directions_entry').hide();}}}();R.markdownCallback=function(){};R.currentCallback=function(){};R.markdownPrompts={};R.markdownSlider=null;R.markdown=function(){var WMD_SRC="/javascripts/wmd/wmd.js";var IMAGE_PATH='/javascripts/wmd/images/';var IMAGE_PATH_PREFIX_V12='/images/assets/icons';var QUICKPIC_INTERVAL=500;var originalImagePreview=null;var cancelConfirmListener=null;var quickpicPoller=null;var currentPrompt=null;var initializeOptions={};return{initialize:function(options){if(options)initializeOptions=options;if(window.Attacklab&&window.Attacklab.textarea){R.markdown.addEditorFeatures(window.Attacklab.textarea);}else{setTimeout(function(){R.markdown.initialize(options);},50);}},initializeSpecialBlocks:function(){$$('.markdown__fenced_spoiler').each(function(spoiler){if(!spoiler.__initializedSpecialBlock){spoiler.__initializedSpecialBlock=true;Event.observe(spoiler,'click',function(){Element.toggleClassName(spoiler,'markdown__fenced_spoiler--expanded');});}});},addEditorFeatures:function(textarea){textarea=$(textarea);if(textarea.__markdownInitialized){return;}
textarea.__markdownInitialized=true;$(textarea).addClassName('c-markdown_area');if(textarea.getAttribute('data-shortcut-submit')=='true'){textarea.observe('keydown',function(e){if((e.ctrlKey||e.metaKey)&&(e.keyCode==13||e.keyCode==10)){var form=textarea.up('form');if(form&&form.onsubmit){form.onsubmit();}}});}
if(initializeOptions.pasteable){new R.controls.PasteableInput(textarea,{uploadPath:'/upload',uploadParam:'Filedata',viewerId:initializeOptions.viewerId,onUploadStart:function(file,progressId,onComplete){R.markdown.prepareUploadViaPaste(progressId,textarea,onComplete);}});}
new R.markdown.MarkdownPasteHandler(textarea);},closePreview:function(caller){if(caller.up('.action_sheet_slider')){R.controls.hideActionSheetSlider();}else{RedBox.close();}},preview:function(caller){data=$(caller).up('div').up('div').next('textarea').value;if(R.swatch&&R.swatch.isSwatching('FRONTEND12')&&caller.up('.action_sheet')){new Ajax.Request('/markdown/preview',{method:'post',parameters:"data="+encodeURIComponent(data),onComplete:function(xhr){R.controls.actionSheetSlider(xhr.responseText,true);}});}else{RedBox.open('wmd_preview','/markdown/preview',{actionSheet:'fullscreen',method:'post',postBody:"data="+encodeURIComponent(data)});}},showHelp:function(){window.open("http://www.ravelry.com/wiki/HelpUsingTheTextEditor");},getButton:function(title){var found=null;$$('img').each(function(image){if(!found&&image.src&&(image.src.indexOf(IMAGE_PATH)>=0||image.src.indexOf(IMAGE_PATH_PREFIX_V12)>=0)&&image.title&&image.title.indexOf(title)>=0){found=image;}});if(!found){$$('span').each(function(span){if(!found&&span.title&&span.title.indexOf(title)>=0){found=span;}});}
return found;},photoPageChanged:function(pager){var page=R.utils.getPagerNumber(pager);R.markdown.searchPhotos(page);},resetSearchPhotos:function(){$('photo_query').value='';R.markdown.searchPhotos();},searchPhotos:function(page){var params={};params.filter=R.utils.selectedValue('photo_filter');params.search=$('photo_query').value;if(page){params.page=page;}
new Ajax.Request('/markdown/search_photos',{method:'get',parameters:params,onComplete:function(){R.markdownSlider.pos(parseInt(page||1)-1);}});},cancelConfirmPhoto:function(){$("confirm_photo").hide();$("photo_search").show();R.popover.recalculateHeight();},showPhotoConfirmation:function(containerId){$(containerId).down('.confirmation_panel').show();R.popover.recalculateHeight(300);var img=$(containerId).down('.selected_photo');img.onload=function(){R.popover.recalculateHeight();};},selectPhoto:function(id){new Ajax.Request('/markdown/select_photo?photo_id='+id,{method:'get',onComplete:function(){$("photo_search").hide();R.markdown.showPhotoConfirmation('photo_select');}});},confirmPhoto:function(id){new Ajax.Request('/markdown/confirm_photo?photo_id='+id,{method:'post'});},photoConfirmed:function(result){R.popover.close();R.currentCallback(result.path,result.title,result.startTag,result.endTag);},showPromptPanel:function(id){$$('.markdown_prompt_section').each(function(section){$(section).removeClassName('selected');});if(id){$(id).addClassName('selected');}
R.popover.recalculateHeight();},prepareWebUpload:function(){R.markdown.showPromptPanel('image_from_web');},prepareSearchPhotos:function(){R.markdown.showPromptPanel('photo_select');new Ajax.Request('/markdown/prepare_search_photos',{method:'get',onComplete:function(){$('photo_query').focus();R.markdownSlider=new TINY.slider.slide('R.markdownSlider',{id:'photo_pages',position:0});R.markdownSlider.pos(0);}});},startExtraTrial:function(returnToPanel){new Ajax.Request('/extra_subscriptions?ravelry_extra_id=1',{onComplete:function(){R.markdown.prepareUpload(returnToPanel);}});},prepareUpload:function(type,options){var panel=type+"_upload";if(!options)options={};R.upload.cancelPollForEmailUpload();R.markdown.showPromptPanel(panel);R.upload.onSuccess(function(uploadId){if($('paste_upload_loading'))$('paste_upload_loading').hide();R.markdown.selectUpload(type,uploadId);});new Ajax.Request('/markdown/prepare_upload?type='+type,{method:'get',onComplete:function(){R.popover.recalculateHeight();if(options.onComplete)options.onComplete();}});},prepareUploadViaPaste:function(progressId,textarea,onComplete){var anchor=$(textarea).previous().down("img[title^='Image']")||textarea;R.upload.onSuccess(function(uploadId){R.markdown.selectUpload('form',uploadId);});var callback=function(imagePath){var markdown='![pasted image]('+imagePath+')';if(textarea.value==''){textarea.value=markdown;}else{R.utils.insertAtCaret(textarea,'\n\n'+markdown+'\n\n');}};R.popover.reopen();currentPrompt=null;R.markdown.prompt('image',anchor,callback,{afterPrompt:function(){R.markdown.prepareUpload('form',{onComplete:function(){$('form_upload').down('form').hide();R.upload.checkUploadProgress(progressId,{});$('form_selection_panel').innerHTML+="<img src='/images/ajax-loading-bar.gif' id='paste_upload_loading' />";onComplete();}});}});},selectUpload:function(type,uploadId){var panel=type+"_upload";if(!$(panel).visible()){R.markdown.showPromptPanel(panel);}
R.markdown.onCancelConfirmUpload(function(){$(panel).down('.confirmation_panel').hide();$(panel).down('.upload_selection_panel').show();R.markdown.prepareUpload(type);});var select_url='/markdown/select_upload?type='+type+'&upload_id='+uploadId;new Ajax.Request(select_url,{method:'get',onComplete:function(){$(panel).down('.upload_selection_panel').hide();R.markdown.showPhotoConfirmation(panel);}});},onCancelConfirmUpload:function(f){cancelConfirmListener=f;},cancelConfirmUpload:function(){cancelConfirmListener();},confirmUpload:function(uploadId){new Ajax.Request('/markdown/confirm_upload?forum_image_upload_id='+uploadId,{method:'post'});},quickpicUpload:function(continueUrl){$('quickpic_instructions').hide();$('quickpic_progress').show();var forum_posts=$$('textarea.forum_post_body');if(forum_posts.size()==0){forum_posts=$$('textarea#forum_post_body');}
if(forum_posts.size()==1){var form=forum_posts.first().up('form');var params=Form.serialize(form);params.url=window.location.href;if(form.action.indexOf('/topics/')>=0){params.topic_id=form.action.match(/\/topics\/(\d+)/)[1];}
if(form.action.indexOf('/forum_posts/')>=0){params.forum_post_id=form.action.match(/\/forum_posts\/(\d+)/)[1];}
new Ajax.Request('/markdown/defer_forum_post',{method:'post',parameters:params,onComplete:function(xhr){R.forums.drafts.clearCurrentDraft();var response=xhr.responseText.evalJSON();document.location="/markdown/quickpic_pending?deferred_forum_post_id="+response.deferredForumPostId;}});}else{R.upload.quickpic(null,null,{continueUrl:continueUrl,onTokenReceived:function(token){R.upload.pollForQuickpicUpload(token);}});}},quickpicResume:function(uploadId){var resumeUploadId=uploadId;if(typeof(Attacklab)!='undefined'&&Attacklab&&Attacklab.wmd&&Attacklab.wmd.editor){var anchor=R.markdown.getButton('Image');R.markdown.prompt('image',anchor,function(path,title){var body=null;$$('textarea').each(function(t){if(!body&&t.name=='forum_post[body]'){body=t;}});if(body)body.value+="\n\n"+"!["+title+"]("+path+")";},{afterPrompt:function(){R.markdown.showPromptPanel('quickpic_upload');R.markdown.selectUpload('quickpic',resumeUploadId);}});}else{setTimeout(function(){R.markdown.quickpicResume(resumeUploadId);},250);}},cancelEmailUpload:function(){R.upload.cancelPollForEmailUpload();R.markdown.showPromptPanel();},cancelQuickpicUpload:function(){$('quickpic_progress').hide();$('quickpic_instructions').show();if(quickpicPoller){clearTimeout(quickpicPoller);}},updateImagePreview:function(){var url=$('markdown_image').value;var preview=$('markdown_image_preview');if(!originalImagePreview){originalImagePreview=preview.getAttribute('src');}
if(url==''){preview.setAttribute('src',originalImagePreview);}else{R.markdown.rewriteIfOembed(url,function(imageSrc){preview.setAttribute('src',imageSrc);});}},cancelPrompt:function(){R.popover.close();},oembedType:function(url){if(url.match(new RegExp("https?:\/\/instagram\.com\/p\/[^/]+?\/"))){return'instagram';}else if(url.indexOf('https://www.flickr.com')===0&&url.indexOf('.jpg')<0){return'flickr';}else if(url.match(new RegExp("https?:\/\/(www\.)?etsy\.com\/listing\/"))){return'etsy';}else if(url.match(new RegExp("https?:\/\/(www\.)?ravelry\.com\/"))&&url.match(new RegExp("\/(patterns|yarns|projects|stash)\/"))){return'ravelry';}else if(url.match(new RegExp("https?:\/\/(www\.)?pinterest\.com\/pin\/"))){return'pinterest';}else{return null;}},rewriteIfOembed:function(imageSrc,callback,addCaption){var oembedType=R.markdown.oembedType(imageSrc);var instagram=imageSrc.match(new RegExp("https?:\/\/(www\.)?instagram.com\/p\/([^/]+)?\/"));if(instagram&&instagram[2]){var url="https://instagr.am/p/"+instagram[2]+"/media?size=m";callback(url,'Instagram photo',"[![","]("+url+")]("+imageSrc+")");}else if(oembedType){new Ajax.Request("/markdown/oembed",{parameters:{url:imageSrc},onComplete:function(xhr){var response=xhr.responseText.evalJSON();if(response.url){var markdownSuffix="]("+response.url+")]("+imageSrc+")";if(addCaption){markdownSuffix=markdownSuffix+"\n"+response.title;}
callback(response.url,response.title,"[![",markdownSuffix);}else{callback(imageSrc);}}});}else{callback(imageSrc);}},prompt:function(promptType,anchor,callbackFunction,options){if(currentPrompt==promptType&&R.popover.isVisible()){R.popover.close();return;}
var afterPrompt=null;if(options){afterPrompt=options.afterPrompt;}
R.currentCallback=callbackFunction;currentPrompt=promptType;R.markdownCallback=function(input){var value=$(input).value;R.popover.close();if(input=='markdown_image'){R.markdown.rewriteIfOembed(value,callbackFunction);}else if(input=='markdown_link'){value=value.strip();var oembedTicky=$('ticky_box_field_oembed_image_');var useOembed=oembedTicky&&oembedTicky.value=='1';if(useOembed&&R.markdown.oembedType(value)){R.markdown.rewriteIfOembed(value,callbackFunction,true);}else if(value[0]!='/'&&value.indexOf('/')>0&&value.indexOf('http://')!=0&&value.indexOf('https://')!=0){callbackFunction("https://"+value);}else{callbackFunction(value);}}else{callbackFunction(value);}};anchor=$(anchor);if(!(Browser.responsiveBreakpoint()&&R.swatch&&R.swatch.isSwatching('FRONTEND12'))){if(window.event)Event.stop(window.event);R.popover.disableCloseEvents();R.popover.pop(anchor,"<input type='text' value='' style='border:none; outline:none; color: white; -webkit-box-shadow: none; background-color: transparent !important;' />",{attachToLink:false,anchor:anchor,orientation:'left',animate:false});var input=$$('.popover').first().down('input');if(input){input.focus();}}
new Ajax.Request("/markdown/prompt/"+promptType,{onComplete:function(xhr){var userInput="";if(input){userInput=input.value;}
R.markdown.displayPrompt(promptType,anchor,xhr.responseText,function(){var input=$$('.popover').first().down('input');if(input){input.value=userInput;}
if(afterPrompt)afterPrompt();});}});},markdownLinkChanged:function(input,e){var evt=e||window.event;if(R.swatch&&R.swatch.isSwatching('FRONTEND12')){if(!$$('img.wmd_frame[src*="photo.svg"]').first()){return;}}else if(!$$('span img[src*="wmd/images/img"]').first()){return;}
if(evt&&evt.clipboardData&&R.markdown.oembedType(evt.clipboardData.getData('text'))){$('oembed_ticky_box').show();}else if(R.markdown.oembedType(input.value)){$('oembed_ticky_box').show();}else{$('oembed_ticky_box').hide();}
R.popover.recalculateHeight();},displayPrompt:function(promptType,anchor,content,afterPrompt){R.popover.pop(anchor,content,{attachToLink:false,anchor:anchor,orientation:'left',animate:false});if(promptType=='image'){R.popover.disableCloseEvents();}else{R.popover.enableCloseEvents();}
var popover=$$('.popover').first();var input=popover.down('input');if(popover){popover.addClassName('popover--markdown');}
if(input&&!(Browser.responsiveBreakpoint()&&R.swatch&&R.swatch.isSwatching('FRONTEND12'))){input.focus();}
if(afterPrompt){afterPrompt();}}};}();function wmdCallbacks(key,insertionFunction,anchorContainer){if(key=='webcam'){R.webcamCallback=function(json){insertionFunction(json.image);};R.webcam.snapshot('webcam');}else if(key=='link'){var anchor=R.markdown.getButton('Hyperlink');R.markdown.prompt('link',anchor,insertionFunction);}else if(key=='image'){var anchor=R.markdown.getButton('Image');R.markdown.prompt('image',anchor,insertionFunction);}else if(key=='video'){var anchor=R.markdown.getButton('Media');R.markdown.prompt('video',anchor,insertionFunction);}else if(key=='mp3'){var anchor=R.markdown.getButton('MP3');R.markdown.prompt('mp3',anchor,insertionFunction);}};R.markdown.MarkdownPasteHandler=function(input){this.input=input;this.addEventHandlers();};R.markdown.MarkdownPasteHandler.prototype.isTabDelimitedText=function(text){var lines=text.split(/\r\n|\r|\n/);var tabCounts=lines.map(function(l){return l.split("\t").length;});var linesWithMultiTabs=$A(tabCounts).select(function(c){return c>1;});return lines.length>2&&lines.length==linesWithMultiTabs.length&&$A(tabCounts).uniq().length==1;};R.markdown.MarkdownPasteHandler.prototype.addEventHandlers=function(){var me=this;$(this.input).observe('paste',function(e){var clipboardData=e.clipboardData||window.clipboardData;var pastedData=clipboardData&&clipboardData.getData&&clipboardData.getData('Text');if(pastedData&&me.isTabDelimitedText(pastedData)){var table=R.markdown.tabDelimitedToTable(pastedData);var caret=R.utils.getCaretInfo(me.input);var val=me.input.value;var textToInsert='\n'+table+'\n';me.input.value=val.substring(0,caret.start)+textToInsert+val.substring(caret.end,val.length);e.stopPropagation();e.preventDefault();}});};R.markdown.tabDelimitedToTable=function(input){var cTL,cTM,cTR;var cML,cMM,cMR;var cBL,cBM,cBR;var hdV,hdH;var spV,spH;cTL="|";cTM="|";cTR="|";cML="|";cMM="|";cMR="|";cBL="|";cBM="|";cBR="|";hdV="|";hdH="-";spV="|";spH="-";var hasHeaders=true;var separator="\t";var hasRightSide=true;var align;var rows=input.split(/[\r\n]+/);if(rows[rows.length-1]==""){rows.pop();}
var colLengths=[];var isNumberCol=[];for(var i=0;i<rows.length;i++){rows[i]=rows[i].replace(/(    )/g,"\t");var cols=rows[i].split(separator);for(var j=0;j<cols.length;j++){var data=cols[j];var isNewCol=colLengths[j]==undefined;if(isNewCol){isNumberCol[j]=true;}
if(isNewCol||colLengths[j]<data.length){colLengths[j]=data.length;}}}
var output="";for(var i=0;i<rows.length;i++){if(hasHeaders&&i==1){for(var j=0;j<=colLengths.length;j++){if(j==0){output+=cML+R.markdown._repeat(hdH,colLengths[j]+2);}else if(j<colLengths.length){output+=cMM+R.markdown._repeat(hdH,colLengths[j]+2);}else if(hasRightSide){output+=cMR+"\n";}else{output+="\n";}}}
for(var j=0;j<=colLengths.length;j++){var cols=rows[i].split(separator);var data=cols[j]||"";if(data==""){data=" ";}
if(hasHeaders&&i==0){verticalBar=hdV;}else{verticalBar=spV;}
if(j<colLengths.length){data=R.markdown._pad(data,colLengths[j]," ",align);output+=verticalBar+" "+data+" ";}else if(hasRightSide){output+=verticalBar+"\n";}else{output+="\n";}}}
return output;};R.markdown._repeat=function(str,num){return new Array(num+1).join(str);};R.markdown._pad=function(text,length,c,align){c=(typeof c==="undefined")?" ":c;align=(typeof align==="undefined")?"l":align;var additionalChars=length-text.length;var result="";switch(align){case"r":result=R.markdown._repeat(c,additionalChars)+text;break;case"l":result=text+R.markdown._repeat(c,additionalChars);break;case"c":var leftSpaces=Math.floor(additionalChars/2);var rightSpaces=additionalChars-leftSpaces;result=R.markdown._repeat(c,leftSpaces)+text+R.markdown._repeat(c,rightSpaces);break;default:assert(false);break;}
return result;};R.messages=function(){loadingRecentMessages=false;var selectedMessages=function(){var values=new Array();$$('#message_list .message_checkbox input').each(function(element){if(element.checked){values.push(getId(element));}});return values;};var showMessageIndicator=function(){Element.show('default_indicator');};var hideMessageIndicator=function(){Element.hide('default_indicator');R.messages.toggleCheckedMessageTools(false);};return{initialize:function(){if($('message_settings')){return true;}
Browser.onResponsiveBreakpointTriggered(function(){$$('.message_row___avatar__image').each(function(img){var src=img.getAttribute('data-delayed-image-src');if(src)img.src=src;});R.messages.loadMessagePreviews();$('search').setAttribute('placeholder','search messages...');});window.onpopstate=function(event){if(event&&event.state&&!event.state.messageId){R.messages.hideMessageContainer();}};Event.observe(window,'scroll',function(){var top=110;if(R.swatch&&R.swatch.isSwatching('FRONTEND12')){top=250;}
if(R.utils.scrollTop()<=top){$('checked_message_tools').removeClassName('touch_toolbar--sticky');}else{$('checked_message_tools').addClassName('touch_toolbar--sticky');}});R.messages.makeComposerDraggable();$$('#message_list .message_checkbox input').each(function(element){element.checked=false;});R.messages.initializeMessageRows();if(R.swatch&&R.swatch.isSwatching('FRONTEND12')){if(Browser.responsiveBreakpoint()&&$('message_container').visible()){R.messages.showMessageContainer();}}},initializeMessageRows:function(){$$('.message_row').each(function(element){if(!element.__initializedMessageRows){element.__initializedMessageRows=true;if(!Browser.responsiveBreakpoint()){Event.observe(element,'mouseenter',function(event){element.addClassName('hover');});Event.observe(element,'mouseleave',function(event){element.removeClassName('hover');});}
Event.observe(element,'click',function(event){if(!R.utils.eventTriggeredOn(event,'message_checkbox')){element.getElementsByTagName('a')[0].onclick();}});}});},changeNotificationSetting:function(key,selector){var enabled=selector.options[selector.selectedIndex].value;var url='update_settings';new Ajax.Request(url,{method:'post',postBody:key+'='+enabled});},composeShareMessage:function(shareableType,shareableId){new Ajax.Request('/messages/compose_share_message?shareable_type='+shareableType+"&shareable_id="+shareableId);},cancelComposeShare:function(){$('share_message_composer').hide();$('share_buttons').show();R.popover.recalculateHeight();},prepareCompose:function(){if(Browser.responsiveBreakpoint()){var url=R.utils.prependPath('prepare_compose');RedBox.open('prepare_compose',url,{actionSheet:'fullscreen',evalScripts:true});}else{$('compose_menu').toggle();$('to').focus();}},submitComposedMessage:function(form){$('compose_submit').hide();$('compose_indicator').show();new Ajax.Request(form.action,{evalScripts:true,parameters:Form.serialize(form)});},messageWindowClosed:function(){removeMarkdownEditor('message_content');R.messages.hideMessageContainer();if(!(R.swatch&&R.swatch.isSwatching('FRONTEND12'))){if(Browser.responsiveBreakpoint()){R.utils.scrollToSavePoint();}}},deleteSelectedMessages:function(){if(confirm('Are you sure that you want to delete the selected messages?')){showMessageIndicator();new Ajax.Request('/messages/destroy_collection',{asynchronous:true,evalScripts:true,onComplete:hideMessageIndicator,postBody:'message_ids='+selectedMessages().join(','),method:'delete'});}},deleteSingleMessage:function(id){if(confirm('Are you sure that you have to delete this message?')){showMessageIndicator();new Ajax.Request('/messages/'+id,{asynchronous:true,evalScripts:true,onComplete:hideMessageIndicator,method:'delete'});}},loadMessagePreviews:function(){var messageIds=$$('.message_row__content').map(function(row){return getId(row);});new Ajax.Request('/messages/load_message_previews',{method:'POST',parameters:{'message_ids':messageIds.join(' ')}});},toggleSelectedMessages:function(toggler){$$('#message_list .message_checkbox input').each(function(element){element.checked=toggler.checked;});R.messages.toggleCheckedMessageTools(toggler.checked);},checkboxClicked:function(e){var show=false;$$('.simple_message').each(function(element){if(element.checked){show=true;}});R.messages.toggleCheckedMessageTools(show);},toggleCheckedMessageTools:function(show){if(show){$('checked_message_tools').show();$(document.body).addClassName('with_messages_checked');}else{$('checked_message_tools').hide();$(document.body).removeClassName('with_messages_checked');}},saveSelectedMessages:function(){showMessageIndicator();new Ajax.Request('/messages/archive_collection',{asynchronous:true,evalScripts:true,onComplete:hideMessageIndicator,postBody:'message_ids='+selectedMessages().join(','),method:'put'});},saveSingleMessage:function(id){showMessageIndicator();new Ajax.Request('/messages/'+id+'/archive',{asynchronous:true,evalScripts:true,onComplete:hideMessageIndicator,method:'put'});},unarchiveSingleMessage:function(id){showMessageIndicator();new Ajax.Request('/messages/'+id+'/unarchive',{asynchronous:true,evalScripts:true,onComplete:hideMessageIndicator,method:'put'});},replyToMessage:function(id){R.messages.open(id,true,null,{reply:true});},cleanUpIfSwipe:function(id){if($('row_wrapper_'+id)){$('row_wrapper_'+id).parentNode.removeChild($('row_wrapper_'+id));}},messageQuarantined:function(id){alert('The message that you are trying to view was flagged as spam and has been removed');},messageNotFound:function(id){alert('This message is no longer available. Did you delete it? Try refreshing the page');var msg=$("message_row_"+id);if(msg){Element.hide(msg);}},startReply:function(){$$('.reply .clicker').each(function(icon){icon.hide();});$$('.message_contents__unread').each(function(e){e.addClassName('message_contents__unread--replying');});if(R.swatch&&R.swatch.isSwatching('FRONTEND12')){$(document.body).addClassName('composing_message');}},mark:function(id,checkbox){var action=checkbox.checked?'mark_read':'mark_unread';new Ajax.Request('/messages/'+id+'/'+action,{method:'put'});},isReplying:function(){var content=$$('textarea#message_content').first();return $('message_container')&&$('message_container').visible()&&content&&content.value.length>0;},showMessageContainer:function(){var actionSheet=null;if(Browser.responsiveBreakpoint()){if(R.swatch&&R.swatch.isSwatching('FRONTEND12')){actionSheet=R.controls.buildActionSheet(null,'fullscreen');actionSheet.appendChild($('message_container'));}}
$('message_container').show();if(actionSheet){$('message_container').removeClassName('rsp_hidden');R.controls.actionSheet(actionSheet);}},cancelReply:function(cancelDraft){var reply=$('message_reply');if(reply){reply.innerHTML='';}
removeMarkdownEditor('message_content');$$('.reply .clicker').each(function(clicker){clicker.show();});if(R.swatch&&R.swatch.isSwatching('FRONTEND12')){if(cancelDraft&&$('message_content')){R.drafts.cancelDraft($('message_content'));}
$$('.message_contents__unread').each(function(e){e.removeClassName('message_contents__unread--replying');});$(document.body).removeClassName('composing_message');}},hideMessageContainer:function(dropOut){if(R.swatch&&R.swatch.isSwatching('FRONTEND12')&&Browser.responsiveBreakpoint()){dropOut=false;}
if(dropOut&&$('message_container')){new Effect.DropOut('message_container');}
var container=$('message_container');if(R.swatch&&R.swatch.isSwatching('FRONTEND12')&&Browser.responsiveBreakpoint()){var actionSheet=($('message_content')||container).up('.action_sheet');if(actionSheet){R.controls.hideActionSheet(actionSheet);}}else if(container){container.hide();if(!(R.swatch&&R.swatch.isSwatching('FRONTEND12'))){if(Browser.responsiveBreakpoint()&&history.replaceState){var previous=parseInt($(container).getAttribute('previous-scrolltop')||0);window.scrollTo(0,previous);history.replaceState({messageId:null},'','?open=');}}}
$(document.body).removeClassName('composing_message');},closeComposerSheet:function(){if(!R.controls.hideActionSheetSlider()){R.controls.closeActionSheets();}},open:function(id,ignoreIfNewTab,e,options){var evt=e||window.event;R.messages.toggleCheckedMessageTools(false);R.utils.saveScrollPosition();if(Browser.responsiveBreakpoint()&&ignoreIfNewTab!=true){if($('row_wrapper_'+id)){return false;}}
if(ignoreIfNewTab){if(evt&&(evt.metaKey||evt.ctrlKey)){return true;}}
if(R.messages.isReplying()){return false;}
if(evt){Event.stop(evt);}
var reply=options&&options.reply==true;new Ajax.Request('/messages/'+id,{asynchronous:true,evalScripts:true,method:'get',on409:function(request){R.messages.messageQuarantined(id);},on404:function(request){R.messages.messageNotFound(id);},onComplete:function(request){if(!(R.swatch&&R.swatch.isSwatching('FRONTEND12'))){$(document.body).addClassName('composing_message');}
Element.hide('default_indicator');var message=$('current_message');if(message&&!Browser.responsiveBreakpoint()){R.utils.makeRoom($('current_message'));R.messages.makeComposerDraggable();}
if(!(R.swatch&&R.swatch.isSwatching('FRONTEND12'))){if(Browser.responsiveBreakpoint()&&history.pushState){history.pushState({messageId:id},'','?open='+id);}}
if(reply){new Ajax.Request(R.utils.prependPath('reply')+'?reply_to='+id,{method:'put'});}},onLoading:function(request){Element.show('default_indicator');}});return false;},makeComposerDraggable:function(){if(!Browser.responsiveBreakpoint()){var composer=$('message_container');if(composer&&composer.down('.top')){new Draggable(composer,{handle:composer.down('.top')});}}},loadRecentMessages:function(){var messageList=$('message_list');if(messageList&&messageList.getAttribute('data-load-recent-messages')=='1'){var maximumId=$$('.message_row').map(function(row){return parseInt(getId(row),10);}).max();if(maximumId&&!loadingRecentMessages){loadingRecentMessages=true;var url=R.utils.prependPath('recent_messages')+'?since_id='+maximumId;new Ajax.Request(url,{method:'GET',onComplete:function(){loadingRecentMessages=false;R.messages.initializeMessageRows();}});}}}};}();R.navigation=function(){var subscribeToNewMessagesTimeout=5000;var staleNotifications=false;var extraSquintyScreenWidth=700;var squintyScreenWidth=860;var browserZoomBreaksFixedHeaderAt=810;var touchZoomRequiresHeaderScalingAt=950;var touchZoomBreaksFixedHeaderAt=640;var lastTouchZoomSet=null;var lastTouchZoomWidth=null;var cancelMenuObserver=null;var eventHandlersRegistered=false;var receivingNewMessage=false;var headroom=null;var headroomStarted=false;var zoomLevelChanged=false;var namedZoomLevel=null;var mobileNavigationClickHandler=null;var mobileNavigationEscapeHandler=null;var insideMobileNavigation=false;var mobileNavigationStates={};var dropdownGroup=null;var frontendV2=false;return{initialize:function(){var flexTest=$('navigation_v2');if(flexTest&&flexTest.style['flex']==undefined&&flexTest.style['-webkit-flex']==undefined){setCookie('flexbrowser',"0",null,'/');document.location.href=href;}else{if(document.body.style&&(document.body.style['flex']!=undefined||document.body.style['-webkit-flex']!=undefined)){setCookie('flexworks',"1",null,'/');}}
if(!Browser.isMSIE6()){if($('notebook_menu')){Event.observe($('notebook_tab'),'mouseover',function(){$('notebook_tab').__mouseover_detected=true;if(!Element.visible('notebook_menu')){R.navigation.showNotebookMenu();}});Event.observe($('notebook_tab'),'mouseout',function(){R.navigation.hideNotebookMenu();return true;});}
if(R.navigation.enableNewNavigation()){Browser.watchForTouch();if(Browser.hasTouchEvents()){var squinty='with_squinty_device';var extraSquinty='with_extra_squinty_device';if($(document.body).hasClassName(extraSquinty))namedZoomLevel=extraSquinty;if($(document.body).hasClassName(squinty))namedZoomLevel=squinty;var zoomClassifier=function(){var width=Browser.availableWidth();if(width<=extraSquintyScreenWidth){if(namedZoomLevel!=extraSquinty){namedZoomLevel=extraSquinty;setCookie('named_zoom',extraSquinty,null,'/');$(document.body).removeClassName(squinty);$(document.body).addClassName(extraSquinty);}}else if(width>extraSquintyScreenWidth&&Browser.availableWidth()<squintyScreenWidth){if(namedZoomLevel!=squinty){namedZoomLevel=squinty;setCookie('named_zoom',squinty,null,'/');$(document.body).removeClassName(extraSquinty);$(document.body).addClassName(squinty);}}else{if(namedZoomLevel!==null){namedZoomLevel=null;deleteCookie('named_zoom');$(document.body).removeClassName(extraSquinty);$(document.body).removeClassName(squinty);}}};zoomClassifier();Event.observe(window,'resize',zoomClassifier);Event.observe(window,'orientationchange',zoomClassifier);}
var zoomFixer=function(){if(!Browser.probablyTouchScreen()){var contentWidth=$('content').offsetWidth;var windowWidth=window.innerWidth;var magicWidth=browserZoomBreaksFixedHeaderAt;var minWidth=Math.min(magicWidth,contentWidth);if(windowWidth<minWidth){zoomLevelChanged=true;R.navigation.setHeaderZoomLevel(windowWidth/minWidth);if(!Browser.hasCSSZoom()){$(document.body).addClassName('with_static_header');}}else if(zoomLevelChanged){zoomLevelChanged=false;R.navigation.setHeaderZoomLevel('');$(document.body).removeClassName('with_static_header');}}else if(zoomLevelChanged){R.navigation.setHeaderZoomLevel('');$(document.body).removeClassName('with_static_header');}};if(!$(document.body).hasClassName('with_static_header')){Event.observe(window,'resize',function(){zoomFixer();});if(!Browser.hasTouchEvents()){zoomFixer();}}
if(Browser.hasTouchEvents()){var oldIOS=$(document.body).hasClassName('with_old_ios');var adjustmentFunction=function(){var width=window.innerWidth;if(width==lastTouchZoomWidth)return;lastTouchZoomWidth=width;var zoomBreaksAt=touchZoomBreaksFixedHeaderAt;var zoomNormalAt=touchZoomRequiresHeaderScalingAt;if(!Browser.isIOS()||oldIOS){if(width>=zoomNormalAt){$(document.body).removeClassName('with_static_header');}else{if($(document.body).hasClassName('with_static_header--default')){$(document.body).addClassName('with_static_header');}}}else if(width<zoomBreaksAt){if($(document.body).hasClassName('with_static_header--default')){$(document.body).addClassName('with_static_header');}
lastTouchZoomSet=null;R.navigation.setHeaderZoomLevel('');}else{$(document.body).removeClassName('with_static_header');if(width>=zoomNormalAt){lastTouchZoomSet=null;R.navigation.setHeaderZoomLevel('');}else{var baseZoom=0.65;var extraZoom=(((width-zoomBreaksAt)/((zoomNormalAt-zoomBreaksAt)*1.0))*(1-baseZoom));var zoom=baseZoom+extraZoom;if(lastTouchZoomSet!=zoom){R.navigation.setHeaderZoomLevel(zoom);}}}};if(!$(document.body).hasClassName('with_static_header')){Event.observe(window,'touchstart',function(){adjustmentFunction();},{passive:true});Event.observe(window,'touchend',function(){adjustmentFunction();},{passive:true});Event.observe(window,'gesturechange',function(){adjustmentFunction();});Event.observe(window,'resize',function(){if(Browser.probablyTouchScreen()){adjustmentFunction();}});if(navigator.platform.indexOf('Mac')<0&&navigator.platform.indexOf('Win')<0&&navigator.platform.indexOf('CrOS')<0){adjustmentFunction();}}}
if($('unread_messages_count_v2')){setTimeout(function(){R.navigation.subscribeToNewMessages();},subscribeToNewMessagesTimeout);}
if(R.swatch.isSwatching('FRONTEND12')){if($(document.body).hasClassName('swatch_navhover')){var addActiveClass=function(){$('navigation_v2').addClassName('navigation_v2--active');}
$('navigation_v2').getElementsBySelector('A').each(function(link){link.observe('mouseover',addActiveClass);});$('navigation_v2').observe('mouseout',function(){$('navigation_v2').removeClassName('navigation_v2--active');});}
var dropdowns=[];$$('.navigation_v2__tab--dropdown').each(function(tab){dropdowns.push(new R.controls.NavigationDropdown(tab,{ignoreMobileNavigation:true}));});dropdownGroup=new R.controls.NavigationDropdownGroup(dropdowns);Element.observe($('searchlight_dialog_input'),'keypress',function(e){R.searchlight.keyUp(e,true);});}
var menus=[];if($('avatar_tab_v2')){menus.push(new R.controls.NavigationBarMenu('avatar_tab_v2','avatar_menu_v2',{orientation:'left'}));}
if($('notebook_tab_v2')){menus.push(new R.controls.NavigationBarMenu('notebook_tab_v2','notebook_menu_v2',{ignoreMobileNavigation:true}));}
if($('pro_tab_v2')){var options={};if(!R.swatch.isSwatching('FRONTEND12')){menus.push(new R.controls.NavigationBarMenu('pro_tab_v2','pro_menu_v2',options));}}
if($('forums_tab_v2')&&$('forums_tab_v2').getAttribute('data-menu-disabled')!='1'){menus.push(new R.controls.NavigationBarMenu('forums_tab_v2','forums_menu_v2',{ignoreMobileNavigation:true,onShow:function(){R.forums.markAsReadIfRepliesWereRead(function(){R.navigation.refreshForumsMenu();});},onlyShowIf:function(){return R.preferences.userPreference('disable-forums-menu')!='1';}}));}
if(menus.length>0){new R.controls.NavigationBarMenuGroup(menus);}}}
R.navigation.initializeSubnavigation();R.navigation.updateMobileNotificationState(false);R.navigation.initializeResponsive();R.navigation.initializeHeadroom();},initializeHeadroom:function(){var disableHeadroom=$(document.body).hasClassName('with_old_ios');if(!disableHeadroom&&R.preferences.autohideNavigation()){$(document.body).addClassName('supports_headroom');var startHeadroom=function(){$(document.body).addClassName('with_headroom');var headroomOptions={offset:20,tolerance:{up:20,down:10},onPin:function(){$(document.body).addClassName('with_headroom_pinned');$('page').addClassName('page_header--pinned');$('page').removeClassName('page_header--unpinned');R.navigation.refreshNotificationsIfNeeded();},onUnpin:function(){$(document.body).removeClassName('with_headroom_pinned');$('page').addClassName('page_header--unpinned');$('page').removeClassName('page_header--pinned');}};headroom=new Headroom($('content'),headroomOptions);headroom.init();};if(!Browser.hasTouchEvents()){startHeadroom();}else{Event.observe(window,'touchstart',function(){if(!headroomStarted){headroomStarted=true;startHeadroom();}},{passive:true});}}},initializeSubnavigation:function(){if(!$(document.body).hasClassName('with_subnavigation')){return;}
if(R.swatch&&R.swatch.isSwatching('FRONTEND12')){if(Browser.responsiveBreakpoint()){$$('.breadcrumbs--subnavigation').each(function(crumbs){window.requestAnimationFrame(function(){crumbs.scrollLeft=crumbs.scrollWidth;});});}}
if(!Browser.responsiveBreakpoint()){$$('.breadcrumbs__crumb__menu').each(function(crumbMenu){var crumb=crumbMenu.up('.breadcrumbs__crumb');if(!(R.swatch&&R.swatch.isSwatching('FRONTEND12'))){crumb.addClassName('breadcrumbs__crumb--with_menu');}
crumb.hoverIntent({sensitivity:3,interval:100,timeout:50,over:function(){if(!Browser.probablyTouchScreen()){R.navigation.toggleCrumbMenu(crumbMenu,true);}},out:function(){if(!Browser.probablyTouchScreen()){R.navigation.toggleCrumbMenu(crumbMenu,false);}}});crumb.observe('touchstart',function(e){var menu=crumbMenu.down('.breadcrumbs__menu');if(menu&&!menu.visible()){R.navigation.toggleCrumbMenu(crumbMenu,true);Event.stop(e);}},{passive:true});$(document.body).observe('touchstart',function(e){if(!R.utils.eventTriggeredOn(e,'breadcrumbs__crumb__menu')){R.navigation.toggleCrumbMenu(crumbMenu,false);}},{passive:true});});}
Browser.onBreakpoints({mobile:function(){$$('.tabs--reveal_overflow').each(function(tabs){var content=$('content');content.style.paddingTop='';});},desktop:function(){$$('.tabs--reveal_overflow').each(function(tabs){R.navigation.revealTabOverflow(tabs);});}});var checkOverflowIndicator=function(overflow){window.requestAnimationFrame(function(){var tabs=overflow.up('.tabs');if(!tabs||tabs.hasClassName('tabs--reveal_overflow')){return;}
var ul=tabs.down('ul');if(R.swatch.isSwatching('FRONTEND12')){ul=tabs.down('.tabs__sections__default');}
if(ul.scrollHeight>(ul.getHeight()+10)){overflow.addClassName('tabs__overflow_indicator--active');}else{overflow.removeClassName('tabs__overflow_indicator--active');}
var currentIsVisible=false;ul.getElementsBySelector('li').each(function(li){if(li.id=='current'&&li.offsetTop<10){currentIsVisible=true;}});if(currentIsVisible){tabs.removeClassName('tabs--current_is_overflowed');}else{tabs.addClassName('tabs--current_is_overflowed');}})};var spans=$$('.tabs--subnavigation li span').concat($$('.breadcrumbs__crumb'));spans.each(function(span){var a=span.down('a');if(a){if(!(R.swatch&&R.swatch.isSwatching('FRONTEND12'))){span.style.cursor='pointer';}
span.observe('click',function(event){if(Event.element(event).tagName=='SPAN'){a.click();}});}});$$('.tabs__overflow_indicator').each(function(overflow){Event.observe(window,'resize',function(){checkOverflowIndicator(overflow);});checkOverflowIndicator(overflow);overflow.observe('click',function(){R.navigation.toggleTabOverflow(overflow);});});if(R.swatch.isSwatching('FRONTEND12')&&false){$$('.tabs--secondary_navigation li > span').each(function(tab){var activityIndicator=document.createElement('div');activityIndicator.className='c-navigation_indicator';var snake=document.createElement('div');snake.className='c-navigation_indicator__snake';activityIndicator.appendChild(snake);tab.appendChild(activityIndicator);});}},editSubnavigationTabs:function(caller){var className='tabs--edit_overflow';var tabs=null;if(caller){tabs=caller.up('.tabs--subnavigation');}else{tabs=$$('.tabs--subnavigation').first();}
if(tabs.hasClassName(className)){tabs.removeClassName(className);return;}
if(!tabs.__editEventHandlers){tabs.__editEventHandlers=true;tabs.getElementsBySelector('li > span > a').each(function(tab){if(!tab.hasClassName('tabs__overflow_tool')){tab.observe('click',function(e){if(tab.up('.tabs--edit_overflow')){tab.up('li').toggleClassName('tabs__preferred_tab');Event.stop(e);R.navigation.saveSubnavigationTabPreferences();}});}});}
tabs.addClassName(className);},saveSubnavigationTabPreferences:function(){var tabs=$$('.tabs--subnavigation:not(.tabs--secondary_navigation)').first();var preferredTabs=tabs.getElementsBySelector('.tabs__sections__default .tabs__preferred_tab').map(function(tab){return tab.getAttribute('data-tab-identifier');}).join(' ');var tabsetOwner=tabs.getAttribute('data-tabset-owner');var tabsetId=tabs.getAttribute('data-tabset-id');var params={'tabset_owner':tabsetOwner,'tabset_id':tabsetId,'preferred_tabs':preferredTabs};new Ajax.Request('/navigation/tabset_preference',{method:'POST',parameters:params});},preserveContentMargin:function(){var content=$('content');var originalMarginTop=content.getAttribute('data-original-margin-top');if((originalMarginTop||'')===''){originalMarginTop=window.getComputedStyle(content,null).marginTop;content.setAttribute('data-original-margin-top',originalMarginTop);}
return originalMarginTop;},setHeaderZoomLevel:function(zoom){$('page_header').style.zoom=zoom;var subnav=$(document.body).hasClassName('with_subnavigation');if(subnav){var content=$('content');var originalMarginTop=R.navigation.preserveContentMargin();if((originalMarginTop||'').indexOf('px')>=0){var zoomedOut=R.swatch&&R.swatch.isSwatching('FRONTEND12')&&zoom<1;if(!zoom||zoom===''||zoom==1||zoomedOut||Browser.responsiveBreakpoint()){content.style.marginTop='';}else{content.style.marginTop="calc("+originalMarginTop+" * "+zoom+")";}}}},enableNewNavigation:function(){return $('navigation_v2')!==null;},subscribeToNewMessages:function(){if(R.pushstream.isSupported()){new Ajax.Request('/people/current_channel.json',{method:'POST',onComplete:function(xhr){var json=xhr.responseText.evalJSON();var channelId=json.channel;nchanClient=R.pushstream.nchanClient('notifications'+channelId);nchanClient.on('message',function(){R.navigation.refreshNotifications();});nchanClient.start();}});}},refreshNotificationsIfNeeded:function(){if(staleNotifications){staleNotifications=false;setTimeout(function(){R.navigation.refreshNotifications(true);},500);}},areNotificationsVisible:function(){var hidden=$('page').hasClassName('page_header--unpinned')||$(document.body).hasClassName('with_static_header');return!hidden;},refreshNotifications:function(force){if(!force&&!R.navigation.areNotificationsVisible()){staleNotifications=true;}else{staleNotifications=false;R.navigation.checkForNewMessages();R.navigation.refreshForumsMenu();}},updateMobileNotificationState:function(){var mobileNav=$('navigation_mobile');if(mobileNav&&R.swatch&&R.swatch.isSwatching('FRONTEND12')){if(mobileNav.down('.navigation_mobile__status--notify')){$(document.body).addClassName('with_mobile_notifications');}else{$(document.body).removeClassName('with_mobile_notifications');}
R.navigation.animateMobileNotifications();}},animateMobileNotifications:function(forceNotificationType){var hamburger=$$('.navigation_v2__hamburger').first();if(hamburger&&R.swatch&&R.swatch.isSwatching('FRONTEND12')){var notificationType=forceNotificationType;$$('.navigation_mobile__status').each(function(navigationItem){var currentType=navigationItem.getAttribute('data-animation-type')
var previousState=mobileNavigationStates[currentType];if(previousState&&(previousState!=navigationItem.getAttribute('data-animation-state'))){notificationType=currentType;}
mobileNavigationStates[currentType]=navigationItem.getAttribute('data-animation-state');});if(notificationType){if(headroom){headroom.pin();}
hamburger.getElementsBySelector('.navigation_v2__hamburger__label__flipside').each(function(element){if(element.getAttribute('data-animation-type')==notificationType){element.show();}else{element.hide();}});hamburger.addClassName('with_animation');setTimeout(function(){hamburger.removeClassName('with_animation');},4000);}}},refreshForumsMenu:function(){if(!$('forums_menu_v2')){return;}
new Ajax.Request('/navigation/forum_menu_items',{onComplete:function(){R.utils.observeHover($('forums_menu_v2'),'li');if($('forums_tab_notification')){$('unseen_replies_item')?$('forums_tab_notification').show():$('forums_tab_notification').hide();}
if(R.swatch&&R.swatch.isSwatching('FRONTEND12')){var hasNewUnreads=$$('.c-navigation_dropdown__icon--new_unreads').first();if(hasNewUnreads){$('forums_tab_notification').show();}else{$('forums_tab_notification').hide();}}
var tab=$$('.navigation_v2__tab--forums_access').first();if(dropdownGroup){dropdownGroup.add(new R.controls.NavigationDropdown(tab,{ignoreMobileNavigation:true}));}}});},checkForNewMessages:function(){new Ajax.Request('/people/message_count.json',{onComplete:function(xhr){var json=xhr.responseText.evalJSON();var messageCount=json['unread_messages_count'];var currentCount=$('new_unread_messages_value');if($$('.user_messages_index_panel').first()){R.messages.loadRecentMessages();}else if(currentCount&&parseInt(currentCount.innerHTML,10)>messageCount){$('unread_messages_count_v2').down('.count').innerHTML=messageCount;}else if(currentCount&&parseInt(currentCount.innerHTML,10)<messageCount){R.navigation.newMessageReceived(messageCount);}}});},newMessageReceived:function(messageCount){if(receivingNewMessage)return;receivingNewMessage=true;var unreadMessages=messageCount;if(document.title.indexOf('✉️')<0){document.title=document.title+' ✉️';}
if(R.swatch&&R.swatch.isSwatching('FRONTEND12')){new Ajax.Request('/navigation/refresh_messages_indicator_mobile?new_message_count='+messageCount);}
var easeOutCubic=function(pos){return(Math.pow((pos-1),3)+1);};var easeOutElastic=function(t){return 0.04*t/(--t)*Math.sin(25*t);};var hadNoMail=$('unread_messages_count_v2').hasClassName('navigation_v2__notification--nomail');var wobbler=$('new_unread_messages_wobbler');var offset=hadNoMail?-58:-48;var bobTime=1250;if(R.swatch&&R.swatch.isSwatching('FRONTEND12')){bobTime=2000;}
if(R.swatch&&R.swatch.isSwatching('FRONTEND12')){$('aria_live').innerHTML="You've got mail";}
var className='navigation_v2__notification__wrapper--wobbling';if(hadNoMail){className='navigation_v2__notification__wrapper--wobbling_higher'}
emile(wobbler,'margin-top:'+offset+'px;',{duration:1000,fallbackAddClassName:className,easing:easeOutElastic,after:function(){setTimeout(function(){$('unread_messages_count_v2').removeClassName('navigation_v2__notification--nomail');var count=$('unread_messages_count_v2').down('.count');var targetBackgroundColor='background-color: #fff;';count.style.backgroundColor='#C1EBB0';if(R.swatch.isSwatching('FRONTEND12')){count.style.backgroundColor='#C5F2EC';}
if(R.themes.isDarkMode()){count.style.backgroundColor='#3852a8';targetBackgroundColor='background-color: #404864;';}
emile(wobbler,'margin-top: 0px;',{duration:600,fallbackRemoveClassName:className,easing:easeOutCubic,after:function(){emile(count,targetBackgroundColor,{after:function(){if(unreadMessages)count.innerHTML=unreadMessages;receivingNewMessage=false;}});}});},bobTime);}});},expandNotebookMenu:function(){if(window.event){Event.stop(window.event);}
$$('.collapsable_option').each(function(o){o.removeClassName('collapsed');});$$('.uncollapse_option').each(function(o){o.hide();});return false;},showNotebookMenu:function(){if(!$('navigation').hasClassName('expanded')){$('notebook_tab').addClassName('hover_menu_active');$('notebook_menu').show();}},hideNotebookMenu:function(){if($('notebook_tab')){$('notebook_tab').removeClassName('hover_menu_active');$('notebook_tab').__touchstart=false;$('notebook_menu').hide();}
if(cancelMenuObserver){Event.stopObserving(document,'touchstart',cancelMenuObserver);cancelMenuObserver=null;}},navigationHeight:function(){if(R.navigation.compressedNavigationEnabled()){return 54;}else{return 70;}},wouldPreferSmallBreakpoint:function(){var touchEvents=Browser.hasTouchEvents();var compressedNavigationEnabled=R.navigation.compressedNavigationEnabled();var pref=!compressedNavigationEnabled&&touchEvents&&window.innerWidth&&window.innerWidth<479;return pref;},compressedNavigationEnabled:function(){var responsiveTag=window.getComputedStyle&&window.getComputedStyle(document.body,':after');var content=responsiveTag&&responsiveTag.getPropertyValue('content');return content!=null&&content.indexOf('compressed-navigation')>=0;},initializeResponsive:function(){if(!Element.hasClassName(document.body,'rsp')){return;}
if(!$('navigation_v2')){return;}
if(Browser.isIPhone()){Element.addClassName(document.body,'prevent_ios_input_zooming');}
var profileTrigger=$('navigation_v2_avatar_link');if(profileTrigger&&$('personal_navigation_mobile')){profileTrigger.setAttribute('aria-controls','personal_navigation_mobile');}
if(R.swatch.isSwatching('FRONTEND12')){if(R.navigation.compressedNavigationEnabled()){window.addEventListener("pagehide",function(e){$$('.navigation_mobile').each(function(nav){nav.addClassName('navigation_mobile--notransition');});if($('facets')){$('facets').addClassName('notransition');}});window.addEventListener("pageshow",function(e){$$('.navigation_mobile').each(function(nav){if(nav.hasClassName('navigation_mobile--notransition')){nav.removeClassName('navigation_mobile--expanded');Element.removeClassName(document.body,'with_expanded_mobile_navigation');setTimeout(function(){nav.removeClassName('navigation_mobile--notransition');},100);}
var facets=$('facets');if(facets&&facets.hasClassName('toggled')){facets.removeClassName('toggled');setTimeout(function(){facets.removeClassName('notransition');},100);}});});}
mobileNavigationClickHandler=function(navigationId,e){if(R.navigation.compressedNavigationEnabled()){var nav=$(navigationId);var collapsed=false;if(nav.hasClassName('navigation_mobile--expanded')){nav.setAttribute('aria-hidden','true');Element.removeClassName(document.body,'with_expanded_mobile_navigation');nav.removeClassName('navigation_mobile--expanded');collapsed=true;}else{nav.addClassName('navigation_mobile--expanded');Element.addClassName(document.body,'with_expanded_mobile_navigation');nav.setAttribute('aria-hidden','false');}
var firstLink=$(nav).down('a');$$('.navigation_v2__logo').each(function(elem){elem.setAttribute('aria-expanded','false');});if(nav.id=='navigation_mobile'&&nav.hasClassName('navigation_mobile--expanded')){$$('.navigation_v2__logo').each(function(elem){elem.setAttribute('aria-expanded','true');if(firstLink)firstLink.focus();});}
$$('.navigation_v2__avatar__link').each(function(elem){elem.setAttribute('aria-expanded','false');});if(nav.id=='personal_navigation_mobile'&&nav.hasClassName('navigation_mobile--expanded')){$$('.navigation_v2__avatar__link').each(function(elem){elem.setAttribute('aria-expanded','true');if(firstLink)firstLink.focus();});}
if(e){Event.stop(e);}}};}
if(!mobileNavigationEscapeHandler){var closeAllMobileNavigation=function(){$$('.navigation_mobile--expanded').each(function(nav){nav.removeClassName('navigation_mobile--expanded');nav.setAttribute('aria-hidden','true');});$$('.navigation_v2__avatar__link').each(function(elem){elem.setAttribute('aria-expanded','false');});$$('.navigation_v2__logo').each(function(elem){elem.setAttribute('aria-expanded','false');});Element.removeClassName(document.body,'with_expanded_mobile_navigation');};mobileNavigationEscapeHandler=$(document.body).observe('keydown',function(e){if(e.key=='Escape'&&$(document.body).hasClassName('with_expanded_mobile_navigation')){closeAllMobileNavigation();return;}});$(document.body).observe('focusin',function(e){if(document.body.hasClassName('with_expanded_mobile_navigation')&&e.target){if(R.navigation.insideMobileNavigation&&!$(e.target).up('.navigation_mobile')){closeAllMobileNavigation();}
R.navigation.insideMobileNavigation=$(e.target).up('.navigation_mobile');}});}
if(R.swatch.isSwatching('FRONTEND12')){$$('.navigation_v2__avatar__link').each(function(elem){elem.observe('click',function(e){mobileNavigationClickHandler('personal_navigation_mobile',e);});});$$('.navigation_v2__logo').each(function(elem){elem.observe('click',function(e){mobileNavigationClickHandler('navigation_mobile',e);});});$$('.navigation_mobile__window').each(function(elem){elem.observe('click',function(e){mobileNavigationClickHandler(elem.up('.navigation_mobile'),e);});});}
if(!R.swatch.isSwatching('FRONTEND12')){Event.observe($$('a.navigation_v2__logo').first(),'click',mobileNavigationClickHandler);Event.observe($('back_tab'),'click',mobileNavigationClickHandler);}},openMobileNavigation:function(){mobileNavigationClickHandler();},proTabClicked:function(){if(Browser.responsiveBreakpoint()){document.location.href='/pro';}else if(Element.visible('pro_menu')){R.navigation.closeProMenu();}else{R.navigation.openProMenu();}},openProMenu:function(){if($('search_tab'))R.searchlight.close();$('pro_tab').style.backgroundImage="url(/images/nav-tab-2-lit.png)";$('pro_menu').style.left=($('pro_tab').offsetLeft-40)+'px';Element.show($('pro_menu'));},closeProMenu:function(){$('pro_tab').removeClassName('navigation_v2__tab--active');$('pro_tab').style.backgroundImage='';$('pro_menu').hide();},updateProMenu:function(html){var fragment=$(document.createElement('DIV'));fragment.style.display='none';fragment.innerHTML=html;var contentNode=fragment.childNodes[0]
var oldContentNode=$('pro_menu_items').down('.c-navigation_dropdown__content');oldContentNode.innerHTML=contentNode.innerHTML;},prepareChangeBusiness:function(){var url='/pro/prepare_change';if(R.swatch&&R.swatch.isSwatching('FRONTEND12')){url+="?frontend12=1";}
new Ajax.Request(url,{method:'get'});},toggleCrumbMenu:function(container,show){var b=$(document.body);var menu=container.down('.breadcrumbs__menu');if(menu&&b.hasClassName('with_subnavigation')){if(show){var ajaxUrl=container.getAttribute('data-menu-content-url');if(ajaxUrl){var left=Position.cumulativeOffset(container)[0];var maxWidth='calc(80vw - '+left+'px)';menu.style.maxWidth=maxWidth;}
if(!menu.__contentLoaded&&ajaxUrl){if(!menu.__contentLoading){menu.__contentLoading=true;new Ajax.Request(ajaxUrl,{method:'GET',onComplete:function(xhr){menu.__contentLoaded=true;menu.innerHTML=xhr.responseText;menu.show();}});}}else{menu.show();}}else{menu.hide();}}},revealTabOverflow:function(tabs){var breadcrumbHeight=60;var content=$('content');tabs.addClassName('tabs--reveal_overflow');if(!$(document.body.hasClassName('notebook'))){if($$('.breadcrumbs--subnavigation').size()===0){breadcrumbHeight=0;}
if(!(R.swatch&&R.swatch.isSwatching('FRONTEND12'))){content.style.paddingTop=(tabs.getHeight()+breadcrumbHeight)+'px';}}
tabs.getElementsBySelector('.tabs__priority_tab a').each(function(link){if((link.getAttribute('title')||'')==''){link.title=link.innerText;}});},hideTabOverflow:function(tabs){var content=$('content');tabs.removeClassName('tabs--edit_overflow');tabs.removeClassName('tabs--reveal_overflow');content.style.paddingTop='';},toggleTabOverflow:function(link){var tabs=link.up('.tabs');R.preferences.toggle('tabstate_'+tabs.getAttribute('data-tabset-id'),tabs.getAttribute('data-tabset-owner'));if(tabs.hasClassName('tabs--reveal_overflow')){R.navigation.hideTabOverflow(tabs);}else{R.navigation.revealTabOverflow(tabs);}}};}();R.needles=function(){return{deleteNeedleRecord:function(id,type){if(confirm('Are you sure that you want to delete this '+type+'?')){var url=R.utils.prependPath(id+'?quicknav=true',true);new Ajax.Request(url,{method:'delete'});};},editComment:function(id){var url=R.utils.prependPath(id+'/edit_comment?quicknav=true',true);new Ajax.Request(url);}};}();R.notebook=function(){return{initialize:function(){R.notebook.initializeNotebookNavigation();$$('.needle_inventory td').each(function(element){Event.observe(element,'mouseover',function(){Element.addClassName(element,'hover');});Event.observe(element,'mouseout',function(){Element.removeClassName(element,'hover');});Event.observe(element,'mousedown',function(event){Element.hide('needle_editor');});Event.observe(element,'click',function(event){var id=getId(element);Element.addClassName(element,'lit');var loc=Position.cumulativeOffset('needle_editor');var left=Event.pointerX(event)-150;var top=Event.pointerY(event)-80;$('needle_editor').style.top=top+"px";$('needle_editor').style.left=left+"px";new Ajax.Request(R.utils.prependPath(id+'/edit',true),{asynchronous:true,evalScripts:true,method:'get'});});});var projectSearchForm=$('project_search_form');if(projectSearchForm){projectSearchForm.onsubmit=function(){R.controllers.Projects.submitProjectSearchForm(projectSearchForm);return false;};}
var stashSearchForm=$('stash_search_form');if(stashSearchForm){stashSearchForm.onsubmit=function(){return R.utils.submitRemoteForm(stashSearchForm,{indicator:'progress',method:'GET'});};}
if($('user_messages_panel')||$('message_list')){R.messages.initialize();}
if($('favorites_panel')){R.favorites.initialize();}
if($('spinning_projects_panel')){R.spinningProjects.initializeNotebook();}
if($('friends_activity_panel')){R.friends.initializeNotebook();}
if($('stash_panel')){R.stashes.initializeNotebook();}
if($('queue_panel')){R.queue.initialize();}
if($('deliveries_panel')){R.deliveries.initialize();}
R.utils.updateAutosubmitForms('#spinning_projects_panel form');R.utils.updateAutosubmitForms('#projects_panel form');R.utils.updateAutosubmitForms('#stash_search_form');R.utils.updateAutosubmitForms('#posts_panel form');if($('filter_menu')){new R.controls.FilterMenu('filter_menu','filter_menu_options',{usePushState:true,autoWidth:true});}
R.coreItems.ieSucks();R.photos.setGridPhotoDimensions();R.controls.initializeOptionPickers();R.controls.initializeTabBars();$$('.toolbar_builder').each(function(bar){new R.controls.ToolbarBuilder(bar);});Event.observe(window,'resize',R.photos.setGridPhotoDimensions);updateLibrarySortables();},initializeMobileButtonBox:function(){if($('tool_buttons')&&$('mobile_tool_buttons')){Browser.onBreakpoints({mobile:function(){$('mobile_tool_buttons').appendChild($('button_box'));},desktop:function(){$('tool_buttons').appendChild($('button_box'));}});}},initializeNotebookNavigation:function(){if($('project_menu')){R.utils.observeHover('project_menu','li');}
$$('a.link_with_dropdown').each(function(a){a.observe('click',function(){a.toggleClassName('link_with_dropdown--toggled');});});},toggleNotebookNavigation:function(){var nav=$('project_menu');if(nav){if(nav.__toggleNotebookNavigation){nav.__toggleNotebookNavigation=false;$(document.body).removeClassName('with_notebook_navigation');nav.removeClassName('notebook_navigation--expanded');}else{nav.__toggleNotebookNavigation=true;$(document.body).addClassName('with_notebook_navigation');nav.addClassName('notebook_navigation--expanded');}}else{new Ajax.Request('/notebook/navigation',{onComplete:function(xhr){var div=document.createElement('div');div.className='rsp_only';div.innerHTML=xhr.responseText;var pageTitle=$$('.page_title').first();var insertBefore=null;if(pageTitle){insertBefore=pageTitle.nextSibling;}else{insertBefore=$('content').firstChild;}
insertBefore.parentNode.insertBefore(div,insertBefore);R.notebook.toggleNotebookNavigation();}});}},changeMobileViewUnless:function(fallbackView,testFunction){var enforcer=function(){if(Browser.responsiveBreakpoint()&&!testFunction()){var view=document.location.href.parseQuery()['view'];if(view!=fallbackView){document.location.replace(R.utils.addQueryParameter(document.location.href,'view',fallbackView));}}};enforcer();Event.observe(window,'resize',enforcer);},pagelessLoaded:function(){R.photos.setGridPhotoDimensions();R.notebook.trackFilterHistory(true);},trackFilterHistory:function(replaceState){var searchForm=$('notebook_header').down('form')||$$('form.notebook_tools.autosubmit').first();if(searchForm&&history&&history.pushState){var formData=Form.serialize(searchForm);delete formData['authenticity_token'];var historyUrl="?"+$H(formData).toQueryString();if(replaceState){history.replaceState({},'',historyUrl);}else{history.pushState({},'',historyUrl);}}},editStatus:function(forParameter,evt){var e=evt||window.event;var ratingClicked=e&&Event.element(e)&&Event.element(e).up('.rating');if(!ratingClicked){var url=R.utils.prependPath('edit_status');if(forParameter)url+='?for='+forParameter;if(R.swatch&&R.swatch.isSwatching('FRONTEND12')&&forParameter=='responsive'){R.controls.buildActionSheet('action_sheet_status_edit','fullscreen',{onDeactivate:function(){R.notebook.cancelEditStatus();}});new Ajax.Request(url,{method:'get',onComplete:function(){R.controls.actionSheet('action_sheet_status_edit');}});}else{new Ajax.Request(url,{method:'get'});}}},cancelEditStatus:function(){var responsiveEdit=$('responsive_status_edit');var actionSheetEdit=$('action_sheet_status_edit');if(responsiveEdit){if(actionSheetEdit){R.controls.hideActionSheet(actionSheetEdit);}
$('responsive_status_edit').hide();$('responsive_status_view').show();}
$('status_edit').hide();$('status_view').show();},editPatternReview:function(user,patternId){R.notebook.finishedDialog(user,{'pattern_id':patternId});},editYarnReview:function(user,yarnId){R.notebook.finishedDialog(user,{'yarn_id':yarnId});},finishedDialog:function(user,parameters){parameters=parameters||{};var path;if(user){path='/projects/'+user+'/prepare_review';}else{path=R.utils.prependPath('prepare_review');}
var projectId=parameters['project_id'];var url=path+'?'+$H(parameters).toQueryString();var backButton=projectId&&window.history.pushState;RedBox.open('review_modal',url,{modal:true,fade:true,onComplete:function(){if(backButton){var url='?prepare_review=1';window.history.pushState({},'',url);}
new Vue({el:'#project_review'});},onClose:function(options){if(backButton){var url=document.location.href.replace('?prepare_review=1','');window.history.pushState({},'',url);}
if(options&&options.success){R.notebook.updateSummaryBoxes(parameters);}}});if(!window.__finishedDialogObserver){window.__finishedDialogObserver=Element.observe(window,'popstate',function(e){if($('RB_redbox')&&$(document.body).hasClassName('modal_open')){RedBox.close();}});}},insertSummaryLoadingIndicator:function(contentElement){var emptyHeight=Element.getHeight(contentElement);contentElement.style.height=emptyHeight+'px';contentElement.innerHTML='';var div=document.createElement('DIV');div.style.textAlign='center';div.style.lineHeight=emptyHeight+'px';div.appendChild(R.controls.createAjaxIndicator());contentElement.appendChild(div);},updateSummaryBoxes:function(options){options=options||{};var delay=500;var updateAll=!(options['pattern_id']||options['yarn_id']);var ps=$('pattern_summary_content');if(ps){var patternId=parseInt(ps.getAttribute('data-pattern-id'),10);if(patternId&&(updateAll||options['pattern_id']==patternId)){R.notebook.insertSummaryLoadingIndicator(ps);setTimeout(function(){ps.style.height='';R.coreItems.updatePatternSummary(patternId);},delay);}}
$$('.yarn_summary_content').each(function(ys){var yarnId=parseInt(ys.getAttribute('data-yarn-id'),10);if(yarnId&&(updateAll||options['yarn_id']==yarnId)){R.notebook.insertSummaryLoadingIndicator(ys);setTimeout(function(){ys.style.height='';R.coreItems.updateYarnSummary(yarnId);},delay);}});}};}();R.organizer=function(){var selection=null;var lastChoice=null;return{addToSet:function(collectionId,itemId,tagId,typeId){new Ajax.Request('/collections/'+collectionId+'/add?item_id='+itemId+"&tag_id="+tagId+"&collectionTypeId="+typeId,{method:'get'});},removeFromSet:function(collectionId,itemId,tagId,typeId){new Ajax.Request('/collections/'+collectionId+'/remove?item_id='+itemId+"&tag_id="+tagId+"&collectionTypeId="+typeId,{method:'get'});},choose:function(type,index,itemId){if(lastChoice==itemId&&Element.visible('chooser')){Element.hide('chooser');}else{lastChoice=itemId;new Ajax.Request('/collections/choose?collection_type_id='+type+'&index='+index+'&item_id='+itemId);}},editTags:function(type,itemId,tag){url='/collections/edit_tags?collection_type_id='+type+'&item_id='+itemId;if(tag){url+="&tag="+tag;}
new Ajax.Request(url);},reloadTags:function(type,itemId){new Ajax.Request('/collections/reload_tags?collection_type_id='+type+'&item_id='+itemId);},hideChooser:function(){Element.hide('chooser');},fullscreen:function(){Element.toggleClassName(document.body,'fullscreen');},highlightSelection:function(selectedId){var collections=$('collection_inner_list').childNodes;for(var i=0;i<collections.length;i++){if(collections[i].id==selectedId){collections[i].className='selected';}else if(collections[i].className=='selected'){collections[i].className='';}}
var tags=$('tag_list').childNodes;for(var i=0;i<tags.length;i++){if(tags[i].id==selectedId){tags[i].className='selected';}else if(tags[i].className=='selected'){tags[i].className='';}}},prepareSet:function(type){new Ajax.Request('/collections/prepare?collection_type_id='+type);},selectSet:function(id){R.organizer.hideChooser();new Ajax.Request('/collections/'+id+'/select',{method:'get'});},deleteSet:function(id){new Ajax.Request('/collections/'+id,{method:'delete'});},editSet:function(id){new Ajax.Request('/collections/'+id+'/edit',{method:'get'});},selectAll:function(type){R.organizer.hideChooser();new Ajax.Request('/collections/select_tag?collection_type_id='+type);R.organizer.highlightSelection("folder_"+type);},selectTag:function(link,tag,type){R.organizer.hideChooser();if(selection){selection.style.background='';}
selection=link;new Ajax.Request('/collections/select_tag?collection_type_id='+type+'&tag='+tag);},showChooser:function(index){var chooser=$('chooser');var anchor=$('selector_'+index);var pos=Position.page(anchor);chooser.style.top=(parseInt(pos[1])+30)+"px";chooser.style.left=(parseInt(pos[0])-12)+"px";chooser.show();}}}();R.people=function(){var autocompletes=new Object();var eventHandlersRegistered=false;var prideFlags=null;var mobileExperience=null;var seenFeaturedFavorites=$A();return{initialize:function(){if($('sortable_avatars')){if(!Browser.responsiveBreakpoint()){Sortable.destroy('sortable_avatars');Sortable.create('sortable_avatars',{tag:'div',longPress:false,onUpdate:function(){var params=Sortable.serialize('sortable_avatars',{tag:'div',name:'avatar_order'});new Ajax.Request(prependPath('../avatars/reorder',true),{method:'post',postBody:params,evalScripts:true});}});}}
if($('password_change')){$$('.password_change').each(function(element){Event.observe(element,'click',function(event){new Effect.BlindDown($('password_change'));Event.stop(event);});});}
if($('raveler_since')&&$$('.profile__about--self').first()){Event.observe($('raveler_since'),'mousedown',function(){new Ajax.Request(R.utils.prependPath('ravelry_number',true),{method:'GET'});});}
R.utils.updateAutosubmitForms('.recent_projects form');R.people.livePreferenceUpdates();R.controls.initializeLinkMenus();R.controls.initializeOptionPickers();R.people.loadFlair();R.people.initializeResponsive();R.themes.onThemeChange(function(){R.people.reflectThemeChanges();});},initializeResponsive:function(){if(Browser.responsiveBreakpoint()){$$('.profile__avatars .avatar').each(function(avatar){if(!avatar.__actionSheetEvent){avatar.__actionSheetEvent=avatar.observe('click',function(){R.people.showAvatarActionSheet(getId(avatar));});}});if(!(R.swatch&&R.swatch.isSwatching('FRONTEND12'))){var items=$$('.dashboard__activity__item');$(items).each(function(item){new R.controls.TouchGallery(item.down('.touch_gallery'),{itemClassName:'framed_photo',useDots:true,beforeSlide:function(){item.getElementsBySelector('.photo_gallery__background').each(function(bg){if(!bg.hasClassName('b-loaded')){bg.addClassName('b-loaded');console.log("Setting image for slide to "+bg.getAttribute('data-slideshow-url'));bg.style.backgroundImage='url('+bg.getAttribute('data-slideshow-url')+')';}});}});});}}
if(R.swatch&&R.swatch.isSwatching('FRONTEND12')){if($$('.media_square_scroller_wrapper').first()){blazy=new Blazy({selector:'.photo_gallery__background[data-lazy-load-image]',src:'data-lazy-load-image',container:'.media_square_scroller_wrapper'});}}
R.controls.initialize(['js-icon_bar']);if(!mobileExperience){var profileGroupsContent=$('profile_groups_content');var featuredFavorite=$('dashboard_block_featured_favorite');var mobileFeaturedFavorite=$('mobile_dashboard_block_featured_favorite');mobileExperience=new R.controls.MobileExperience({managerDialogs:true,lazyLoadImages:{selector:'.photo_gallery__background',src:'data-slideshow-url',loadInvisible:false},onMobileView:function(){if(profileGroupsContent)$('profile_groups_mobile').appendChild(profileGroupsContent);if(R.swatch&&R.swatch.isSwatching('FRONTEND12')){if(featuredFavorite&&mobileFeaturedFavorite){while(featuredFavorite.hasChildNodes())mobileFeaturedFavorite.appendChild(featuredFavorite.firstChild);}}},onDesktopView:function(){if(profileGroupsContent)$('profile_groups').appendChild(profileGroupsContent);if(R.swatch&&R.swatch.isSwatching('FRONTEND12')){if(featuredFavorite&&mobileFeaturedFavorite){while(mobileFeaturedFavorite.hasChildNodes())featuredFavorite.appendChild(mobileFeaturedFavorite.firstChild);}}
this.initializeBlazy();}});}},showAvatarActionSheet:function(avatarId){var avatar=$('avatar_'+avatarId);mobileExperience.showActionSheet({content:avatar.outerHTML,attributes:{'data-avatar-id':avatarId}});},revealChangePassword:function(){$('change_password_link').hide();$('change_password_fields').show();},livePreferenceUpdates:function(){document.addEventListener("ravelry:tickyboxchanged",function(e){var prefElement=$('user_preference_data');var attributeValue=e.detail.selected?'0':'1';if(e.detail.key=='large_font'){if(e.detail.selected){$(document.body).addClassName('with_large_font');document.documentElement.setAttribute('data-large-font','1');}else{$(document.body).removeClassName('with_large_font');document.documentElement.setAttribute('data-large-font','0');}}
if((e.detail.key=='sticky_nav'&&!Browser.probablyTouchScreen())||(e.detail.key=='sticky_nav_touch'&&Browser.probablyTouchScreen())){if(e.detail.selected){$(document.body).removeClassName('with_static_header');}else{$(document.body).addClassName('with_static_header');}}
if((e.detail.key=='autohide_nav'&&!Browser.probablyTouchScreen())||(e.detail.key=='autohide_nav_touch'&&Browser.probablyTouchScreen())){prefElement.setAttribute('data-autohide-nav',attributeValue);prefElement.setAttribute('data-autohide-nav-touch',attributeValue);}
if(e.detail.key=='forums_menu'&&prefElement){prefElement.setAttribute('data-disable-forums-menu',attributeValue);}});},siteChooser:function(){RedBox.open('chooser',R.utils.prependPath('choose_sites',true),{actionSheet:false});},zoomAvatar:function(avatarId){var url=R.utils.prependPath('avatars/'+avatarId+'/zoom');new Ajax.Request(url,{method:'GET'});},unlinkDesigner:function(login){new Ajax.Request('/people/'+login+'/unlink_designer');},unlinkYarnie:function(login){new Ajax.Request('/people/'+login+'/unlink_yarnie');},editEmail:function(login){RedBox.open('edit_email','/people/'+login+'/edit_email',{fade:true,actionSheet:false,onComplete:function(){R.behaviors.applyBehavior('toggle_select');}});},prideFlags:function(login){var url='/people/'+login+'/prepare_pride_flag';RedBox.open('prepare_pride_flag',url,{method:'GET',evalScripts:true});},retitleFlair:function(draggable,e){if(draggable&&draggable.element){$$('.flair__dragging').each(function(p){p.style.visibility='visible';p.innerHTML=draggable.element.getAttribute('alt');});}else{$$('.flair__dragging').each(function(p){p.style.visibility='hidden';});}},editFlair:function(login,avatarId){var url='/people/'+login+'/avatars/'+avatarId+'/edit_flair';RedBox.open('edit_flair',url,{method:'GET',evalScripts:true,actionSheet:'fullscreen',onComplete:function(){R.people.initializeFlair(login,avatarId);}});RedBox.onCloseCallback=function(){R.people.clearFlair();if($('RB_window')){$('RB_window').innerHTML='';}
R.people.loadFlair();};},initializeFlair:function(login,avatarId){$$('.flair_image').each(function(flair){new Draggable(flair,{'onDrag':R.people.retitleFlair,'longPress':false,'ghosting':false,'zindex':9999,'revert':false,onEnd:function(){R.people.retitleFlair();R.people.saveFlair(login,avatarId,flair);}});});},saveFlair:function(login,avatarId,flair){var url='/people/'+login+'/avatars/'+avatarId+'/update_flair';var avatar=$$('#avatars_selector .avatar_with_flair').first();var flairOffset=Position.positionedOffset(flair);var avatarOffset=Position.positionedOffset(avatar);var x=flairOffset[0]-avatarOffset[0];var y=flairOffset[1]-avatarOffset[1];var params={image:flair.src,y_offset:y,x_offset:x};new Ajax.Request(url,{parameters:params});},refreshActivity:function(view){new Ajax.Request('/people/refresh_activity',{method:'POST',parameters:{activity:view},onComplete:function(){$(document.body).removeClassName('people--large');$(document.body).removeClassName('people--small');$(document.body).addClassName('people--'+view);}});},refreshFeaturedFavorite:function(){var indicator=$('dashboard_featured_favorite_rotator');indicator.addClassName('infiniterotate');var container=$('dashboard_featured_favorite');var wrapper=$('dashboard_featured_favorite_wrapper');var lastItem=$$('.dashboard__featured_favorite__item').last();seenFeaturedFavorites.push(lastItem.getAttribute('data-project-id'));if(!container.__refreshedFeaturedFavorite){container.__refreshedFeaturedFavorite=true;container.style.height=Element.getHeight(container)+'px';container.style.overflow='hidden';wrapper.style.position='relative';wrapper.style.top='0px';}
lastItem.style.paddingBottom='3em';var params={seen:seenFeaturedFavorites.join(' ')};new Ajax.Request('/people/refresh_featured_favorite',{method:'GET',parameters:params});},refreshFeaturedFavoriteEmpty:function(){var indicator=$('dashboard_featured_favorite_rotator');indicator.removeClassName('infiniterotate');indicator.up('a').innerHTML="you've seen them all :)";},refreshFeaturedFavoriteImageLoaded:function(){var container=$('dashboard_featured_favorite');var wrapper=$('dashboard_featured_favorite_wrapper');var lastItem=$$('.dashboard__featured_favorite__item').last();var lastItemHeight=Element.getHeight(lastItem);var wrapperStyle="top:"+((-1*Element.getHeight(wrapper))+lastItemHeight)+'px;';var containerStyle="height:"+lastItemHeight+'px;';var easing=function(pos){if((pos/=0.5)<1)return-0.5*(Math.sqrt(1-pos*pos)-1);return 0.5*(Math.sqrt(1-(pos-=2)*pos)+1);};var emileDuration=350;emile(wrapper,wrapperStyle,{easing:easing,duration:emileDuration});emile(container,containerStyle,{duration:emileDuration});setTimeout(function(){var indicator=$('dashboard_featured_favorite_rotator');indicator.removeClassName('infiniterotate');},emileDuration);},clearFlair:function(){$$('.flair_image').each(function(e){e.remove();});},loadFlairSelector:function(login,avatarId){$$('.toolbar_v2--topbar .clicker').each(function(clicker){clicker.onclick=function(){RedBox.close();};});R.people.loadFlair(false,$('avatars_selector'),function(){$$('#avatars_selector .flair_image').each(function(flair){new Draggable(flair,{'onDrag':R.people.retitleFlair,'longPress':false,'ghosting':false,'zindex':9999,'revert':false,onEnd:function(){R.people.retitleFlair();R.people.saveFlair(login,avatarId,flair);}});});});},loadFlair:function(allowOutOfFrame,root,callback){if(R.preferences.userPreference('flair-week')!='1'){return;}
var baseAvatarSize=100;var baseFlairSize=48;var avatarSize=100;if(R.navigation.compressedNavigationEnabled()&&!(document.body).hasClassName('people_show')){avatarSize=50;}
if($(document.body).hasClassName('welcome_index')){avatarSize=50;}
if($$('.notebook_card__user').first()){avatarSize=50;}
if($$('.c-notebook_tallcard__photo').first()){avatarSize=42;}
var flairSize=Math.round(baseFlairSize*(avatarSize/baseAvatarSize));var offsetMultiplier=avatarSize/baseAvatarSize;var avatars=$H({});$$('.avatar_with_flair').each(function(avatar){var userId=avatar.getAttribute('data-user-id');if(userId){if(!avatars[userId])avatars[userId]=$A([]);avatars[userId].push(avatar);}});var draggableFlair=$H({});$$('.draggable_flair').each(function(df){draggableFlair[df.getAttribute('data-flair-image')]=df;});var params={'user_ids':avatars.keys().join(' ')};if(allowOutOfFrame){params['allow_out_of_frame']=1;}
new Ajax.Request('/avatars/load_flair',{parameters:params,onComplete:function(xhr){var flairs=xhr.responseText.evalJSON();avatars.each(function(pair){var userId=pair.key;var userAvatars=pair.value;var flairList=flairs[parseInt(userId)];flairList=flairList||flairs[userId+''];if(flairList){userAvatars.each(function(avatar){flairList.each(function(pieceOfFlair){var image=draggableFlair[pieceOfFlair['flair_image']];var pos=Position.positionedOffset(avatar);if(!image){image=document.createElement('IMG');image.src=pieceOfFlair['flair_image'];image.className='flair_image';image.alt='';avatar.parentNode.insertBefore(image,avatar);}
image.style.position='absolute';image.style.width=flairSize+'px';image.style.height=flairSize+'px';image.style.zIndex=9999;image.style.border='none';image.style.top=(pos[1]+(pieceOfFlair['y_offset']*offsetMultiplier))+'px';image.style.left=(pos[0]+(pieceOfFlair['x_offset']*offsetMultiplier))+'px';});$(document.body).addClassName('with_flair');});}
if(callback){callback();}});}});},addInstagramAvatar:function(login){$('instagram_indicator').show();new Ajax.Request('/people/'+login+'/avatars/from_instagram',{method:'POST',onComplete:function(){$('instagram_indicator').hide();}});},disconnectInstagram:function(){new Ajax.Request('/instagram_oauth/disconnect',{method:'POST'});},connectInstagram:function(){var form=$('edit_person_form');R.form.clearSaveRequired();new Ajax.Request(form.action,{method:'POST',parameters:Form.serialize(form),onComplete:function(){R.utils.openUrlWithPost('/instagram_oauth/connect',{from:'profile',change:1},true);}});},deleteAvatar:function(element){var avatarId=element.getAttribute('data-avatar-id');var avatar=$('avatar_'+avatarId);avatar.addClassName('confirm_delete');if(confirm('Are you sure that you want to delete this avatar?')){var url=R.utils.prependPath('avatars/'+avatarId,true);new Ajax.Request(url,{method:'delete'});}else{avatar.removeClassName('confirm_delete');}},promoteAvatar:function(element){var avatar=$('avatar_'+element.getAttribute('data-avatar-id'));var container=$('sortable_avatars');container.insertBefore(avatar,container.down('.avatar'));R.people.saveAvatarSortOrder();},saveAvatarSortOrder:function(){var params=$$('#sortable_avatars .avatar').map(function(avatar){return'avatar_order[]='+getId(avatar);}).join('&');new Ajax.Request(prependPath('../avatars/reorder',true),{method:'post',postBody:params,evalScripts:true});},reflectThemeChanges:function(){if($$('form.profile__preferences #theme_select').first()){var theme=R.preferences.userPreference('theme');var lightTheme=R.preferences.userPreference('light-theme');var automatic=R.preferences.userPreference('theme-disable-switching')!='1';if(automatic){theme='automatic';}
R.utils.selectOption($('theme_select'),theme);if("createEvent"in document){var e=document.createEvent("HTMLEvents");e.initEvent("change",false,true);$('theme_select').dispatchEvent(e);}
$('light_theme_select_'+lightTheme).checked=true;}}};}();R.pageless=function(){var loadingPage=false;var pages;var loadedPages=[];var formName;var loadingText;var notLoadingText;var lastScrollLocation=0;var configured;return{initialize:function(){var control=$('pageless_control');if(control){loadingPage=false;if($('project_search_form')){formName='project_search_form';loadingText='Loading more projects...';}
if($('stash_search_form')){formName='stash_search_form';loadingText='Loading more stash...';}
if($('pageless_form')){formName='pageless_form';loadingText='Loading more...';}
Event.observe(window,'scroll',function(e){R.pageless.onScroll(e);});var brokenBrowser=Browser.isChromeIOS();if(window.history&&history.replaceState&&!brokenBrowser){Event.observe(window,'pagehide',function(e){var currentPage=$A(loadedPages).max();var url=R.utils.addQueryParameter(document.location.href,'pageless',currentPage);history.replaceState('',window.document.title,url);});Event.observe(window,'pageshow',function(e){if(document.location.href.indexOf('pageless')>=0){var url=R.utils.addQueryParameter(document.location.href,'pageless',null);history.replaceState('',window.document.title,url);}});}
R.pageless.onScroll();}},getPages:function(){return pages;},setPages:function(pageData){pages=pageData.pages;loadedPages=[];if(pageData.current_page){loadedPages.push(pageData.current_page);}
if($('pageless_control')){if(pages.length>1){$('pageless_control').show();}else{$('pageless_control').hide();}}
R.pageless.onScroll();},getScrollLocation:function(){if(typeof pageYOffset!='undefined'){return pageYOffset;}else{return document.documentElement.clientHeight?document.documentElement.scrollTop:document.body.scrollTop;}},onScroll:function(e){var scrollLocation=R.pageless.getScrollLocation();var scrollThreshold=Math.abs(scrollLocation-lastScrollLocation)>5;if(scrollThreshold||(lastScrollLocation==0)){lastScrollLocation=scrollLocation;var viewport=getViewportSize();var threshold=viewport[1]*1.75;var endOfPage=$('pageless_control');if(endOfPage){var loadNext=Position.page(endOfPage)[1]<threshold;if(loadNext){R.pageless.loadNextPage();}}}},loadNextPage:function(){if(loadingPage||!pages)return;loadingPage=true;var pageNumber=Math.max.apply(Math,loadedPages)+1;if(pageNumber<=0){pageNumber=1;}
if(pageNumber>pages.length){loadingPage=false;$('pageless_control').hide();$$('.on_pageless_finished').each(function(e){e.show();});}else{$('pageless_control').down('.indicator').show();var text=$('pageless_control').down('span');if(!notLoadingText){notLoadingText=text.innerHTML;}
text.innerHTML=loadingText;R.pageless.loadPage(pageNumber);}},loadPage:function(page){var form=$(formName);var method=form.method||'post';var params=Form.serialize(form);params['page']=page;params['object_ids']=pages[page-1].join(',');new Ajax.Request(R.utils.prependPath(),{asynchronous:true,evalScripts:true,parameters:params,method:method,onComplete:function(){loadedPages.push(page);$('pageless_control').down('.indicator').hide();$('pageless_control').down('span').innerHTML=notLoadingText;loadingPage=false;}});}};}();R.patterns=function(){var responsiveInitialized=false;var touchGallery=null;var searchAutocomplete=null;var blazy=null;return{initialize:function(){$$('.date_select select').each(function(select){var wrapper=document.createElement('DIV');select.parentNode.insertBefore(wrapper,select);if(select.name.indexOf('(2i)]')>=0){wrapper.className='form_select xx_small';wrapper.appendChild(select);}
if(select.name.indexOf('(1i)]')>=0){wrapper.className='form_select small_60';wrapper.style.marginLeft='-1px';wrapper.appendChild(select);}});R.coreItems.initializeCoreItemPage();R.controls.initializeOptionPickers();$$('.toolbar_builder').each(function(bar){new R.controls.ToolbarBuilder(bar);});if($(document.body).hasClassName('patterns_index')){if(R.navigation.enableNewNavigation()){R.patterns.loadAutocomplete();}}
if($$('.dashboard__content').first()){R.patterns.initializePatternDashboard();}
if(R.swatch&&R.swatch.isSwatching('FRONTEND12')&&!Browser.responsiveBreakpoint()){if($$('.patterns__landing__highlights__photos').first()){blazy=new Blazy({selector:'.patterns__landing__highlights__photos .photo_gallery__background[data-lazy-load-image]',src:'data-lazy-load-image'});}}
if(window.location.hash=='#hrn'&&$('more_popular_patterns_expanded')){$('more_popular_patterns_expanded').show();R.patterns.togglePopularPatterns();}
$A(['queued_uncached','in_my_stash_uncached']).each(function(uncached){if($(uncached+'_content')){var stub=$(uncached);stub.innerHTML=$(uncached+'_content').innerHTML;stub.show();}});if($('pattern_timeline')){Event.observe(window,'resize',function(){R.photos.setGridPhotoDimensions();});R.photos.setGridPhotoDimensions();}
if($('people_panel')){new R.controls.FilterMenu('filter_menu','filter_menu_options',{usePushState:false,autoMakeRoom:true,resetLink:false});}
$$('table.pattern_list .clicker').each(function(element){Event.observe(element,'click',function(event){Event.stop(event);});});$$('table.pattern_list .sortable').each(function(element){Event.observe(element,'click',function(event){document.location.replace('/patterns/list?view=list&sort='+element.id);Event.stop(event);});});$$('#featured_projects .tall_notebook_card','#featured_projects .tall_notebook_card img').each(function(element){var card=element;if(!card.hasClassName('tall_notebook_card'))card=element.up('.tall_notebook_card');var featuredProjectId=getId(card);Event.observe(element,'click',function(event){new Ajax.Request('/featured_projects/'+featuredProjectId+'/click',{method:'POST'});});});if($('edit_pattern_form')){$A($('edit_pattern_form').getElementsBySelector('input','select','textarea')).each(function(element){Event.observe(element,'focus',function(){new Ajax.Request('/tips/for?from=edit_pattern&id='+element.id,{method:'get',onComplete:function(transport){var json=eval("("+transport.responseText+")");if(json["message_html"]){var required="";if(!json["required"]){required="<div class='tip_required'>This field is <strong>required<strong></div>"}
var t="<img src='/images/silk-pencil.png' class='inline'/> <strong>tips:</strong> "+json["name"];$('tip_container').innerHTML="<div class='tip markdown'><div class='tip_title'>"+
t+"</div>"+json["message_html"]+required+'</div>';var oldTop=Position.cumulativeOffset($("tip_container"))[1];var top=(document.documentElement.scrollTop||document.body.scrollTop)+100;if(top<600){top=600;}
new Effect.MoveBy($('tip_container'),top-oldTop,0);}else{$('tip_container').innerHTML="";}}});});});}
R.patterns.yarnHeldTogetherChanged();R.comments.addEventListeners();triggeredMarkdownEditor('comment_text',true);updateSortables();R.patterns.initializeResponsive();Browser.onResponsiveBreakpointTriggered(function(){R.patterns.initializeResponsive();});R.coreItems.initializeAudioAttachments();R.controls.SearchCard.initialize();},initializeResponsive:function(){if(responsiveInitialized)return;responsiveInitialized=true;if(R.swatch&&R.swatch.isSwatching('FRONTEND12')){if($$('.media_square_scroller_wrapper').first()){blazy=new Blazy({selector:'.photo_gallery__background[data-lazy-load-image]',src:'data-slideshow-url',container:'.media_square_scroller_wrapper'});}
var features=$('featured_enablers');var newDesigners=$('new_designers');var highlights=$('pattern_highlights');if(features){Browser.onBreakpoints({mobile:function(){$$('.patterns_landing').first().insertBefore(features,$('featured_enablers_mobile'));if($(document.body).hasClassName('swatch_debutpatterns')){$$('.patterns_landing').first().insertBefore(newDesigners,$('new_designers_mobile'));}
if(highlights)$$('.patterns_landing').first().insertBefore(highlights,$('pattern_highlights_mobile'));},desktop:function(){$$('.patterns_landing').last().insertBefore(features,$('featured_enablers_desktop'));if($(document.body).hasClassName('swatch_debutpatterns')){$$('.patterns_landing').first().insertBefore(newDesigners,$('new_designers_desktop'));}
if(highlights)$$('.patterns_landing').last().insertBefore(highlights,$('pattern_highlights_desktop'));}});}}
if(Element.hasClassName(document.body,'rsp')){var amazon=$$('.buy_box_section').first();if(amazon){var source=$('pattern_source');if(source){var copiedAmazonBox=document.createElement('DIV');copiedAmazonBox.className='rsp_break_small';copiedAmazonBox.innerHTML=amazon.innerHTML;source.parentNode.insertBefore(copiedAmazonBox,source);}}
var buyBoxes=$$('.download_plate');var downloadInformation=$$('.downloadable').first();if(buyBoxes.first()&&downloadInformation){var html="<div class='rsp_hidden'>"+downloadInformation.innerHTML+'</div>';buyBoxes.each(function(box){html+="<div class='rsp_only downloadable--buy_box'>"+box.innerHTML+"</div>";});downloadInformation.innerHTML=html;}else if(downloadInformation){downloadInformation.addClassName('downloadable--external');}
if(downloadInformation){downloadInformation.removeClassName('rsp_hidden');downloadInformation.getElementsBySelector('.buy_options .option').each(function(buyOption){buyOption.observe('click',function(e){if(Browser.responsiveBreakpoint()){buyOption.down('a').click();}});});}
R.photos.lazyLoadImages();}
if(R.swatch&&R.swatch.isSwatching('FRONTEND12')){R.notebook.initializeMobileButtonBox();}
if(R.navigation.compressedNavigationEnabled()){var stickySidebar=$('sticky_sidebar');if(stickySidebar){var editor=$$('.editor').first();editor.insertBefore(stickySidebar,editor.childNodes[0]);}}},toggleAdvancedSearchLabel:function(toggle){console.log('toggleAdvancedSearchLabel: '+toggle);var submit=$('pattern_search_submit');if(toggle){if(!submit.__originalLabel)submit.__originalLabel=submit.innerHTML;submit.innerHTML=submit.__originalLabel.replace('browse ','search ');}else{if(submit.__originalLabel)submit.innerHTML=submit.__originalLabel;}},initializePatternDashboard:function(){R.controls.initialize(['js-icon_bar','js-hot_right_now']);$('query').observe('focus',function(){R.patterns.toggleAdvancedSearchLabel(true);});$('query').observe('blur',function(){R.patterns.toggleAdvancedSearchLabel($('query').value!=='');});R.controls.initializeLinkMenus();if(Browser.responsiveBreakpoint()){$$('.grid_photo__photo').each(function(img){if(img.up('.grid_photo--1_column')){img.src=img.getAttribute('data-medium2-url');}});}
R.photos.setGridPhotoDimensions(true);},pinSavedSearch:function(savedSearchId){var url='/saved_searches/'+savedSearchId+'/pin';new Ajax.Request(url,{parameters:{toggle:1}});},loadAutocomplete:function(){new Ajax.Request('/patterns/search/load_autocomplete',{method:'get',onComplete:function(xhr){var matches=xhr.responseText.evalJSON();matches=matches.select(function(m){return m['filter_type']!='advanced';});searchAutocomplete=new Autocompleter.Filters('query','suggestions',matches,{frequency:0.1,partialSearch:true,fullSearch:true,disableMultiToken:true,onSelect:function(o){if(o.filterType=='text'||o.filterType=='field'){new Ajax.Request('/patterns/search/inline_field',{method:'GET',parameters:{'search_attribute_id':o.id}});}else{R.patterns.showSearchIndicator();$('suggestions').style.visibility='none';var params=Form.serialize($('query').up('form'));params['query']='';params[o.filterPrefix]=o.filterValue;var url='/patterns/search#'+$H(params).toQueryString();document.location.href=url;}}});}});},showAllTags:function(){R.patterns.toggleTags(true);},toggleTags:function(show){$$('ul.tag_set li').each(function(tag){if(tag.hasClassName('collapsable_tag')){tag.useClassName('collapsed_tag',!show);}
if(tag.hasClassName('more_tags')){show?tag.hide():tag.show();}
if(tag.hasClassName('more_tags--collapse')){show?tag.show():tag.hide();}});},showKeywordSearch:function(){$('keyword_search_toggle').hide();$('keyword_search_section').removeClassName('toolbar_v2__section--disabled');},enterInlineSearch:function(prefix,title){var form=$('inline').up(form);form.onsubmit=function(){R.patterns.showSearchIndicator();var inline=$('inline');if(inline.value!==''){var url='/patterns/search#'+encodeURIComponent(inline.value)+'='+encodeURIComponent($('query').value);document.location.href=url;return false;}else{return true;}};$('inline_label_text').innerHTML=title;$('inline_label').show();$('inline').value=prefix;$('query').value='';R.utils.focusTextField($('query'));searchAutocomplete.disable();},cancelInlineSearch:function(){$('inline').value='';$('inline_label').hide();R.utils.focusTextField($('query'));searchAutocomplete.enable();},showSearchIndicator:function(){if($('search_indicator'))$('search_indicator').show();},castOn:function(patternId){new Ajax.Request('/patterns/library/'+patternId+'/cast_on',{method:'get'});},togglePopularPatterns:function(pushState){var more=$('more_popular_patterns_expanded');if($('expand_popular_patterns').visible()){if(!more.visible()){Effect.SlideDown(more,{duration:.5});Effect.Appear(more,{duration:.75});}
$('expand_popular_patterns').hide();$('collapse_popular_patterns').show();if(pushState&&window.history.replaceState){window.history.replaceState({},'Top 20','#hrn');}}else{Effect.SlideUp(more,{duration:.5});Effect.Fade(more,{duration:.75});$('collapse_popular_patterns').hide();$('expand_popular_patterns').show();if(pushState&&window.history.replaceState){window.history.replaceState({},'Top 5',window.location.href.split('#')[0]);}}},initializeCategoryMenuFields:function(){$$('a.category_select').each(function(a){if(!a.getAttribute('__category_select')){a.setAttribute('__category_select',true);var menuContent=a.up('.fake_form_select').down('ul.level_0');new R.patterns.CategorySelect(a,{menuContent:menuContent});}});},previewRegisteredFeatures:function(){$$('.tab_bar_container').each(function(e){e.removeClassName('tab_bar_container--guest');});},gaugeTypeChanged:function(select){var repeatsOnly=R.utils.selectedValue(select)=='repeats';$$('.gauge_fields').each(function(element){R.utils.swapClassName(element,'gauge_fields--stitches','gauge_fields--repeats',repeatsOnly);});},yarnHeldTogetherChanged:function(){var heldTogether=$('pattern_yarn_held_together');if(heldTogether){if(R.utils.selectedValue(heldTogether)=='true'){$('component_yarns').show();$('yarn_weight_combined_label').show();$('yarn_weight_label').hide();}else{$('component_yarns').hide();$('yarn_weight_combined_label').hide();$('yarn_weight_label').show();}}},addComponentYarn:function(){var added=false;var hasMore=false;$$('.pattern_component_yarn').each(function(componentYarn){if(!componentYarn.visible()){if(!added){componentYarn.show();added=true;}else{hasMore=true;}}});if(!hasMore){$('more_component_yarns').hide();}},findByUrl:function(url,index){new Ajax.Request('/patterns/find_by_url?url='+encodeURIComponent(url)+"&index="+index,{method:'get'});},notEditable:function(permalink){RedBox.open('not_editable','/patterns/library/'+permalink+'/not_editable');},validateEditForm:function(){var comment=$('pattern_change_comment');if(comment&&comment.value==''){alert('Please describe the change that you are making - it is used for a history of revisions.');comment.focus();return false;}else{return true;}},refreshQueueStatus:function(patternId){var queue_status=$('queue_status');if(queue_status){new Ajax.Request('/patterns/library/'+patternId+'/refresh_queue_status',{onComplete:function(){if(!queue_status.visible()){new Effect.Appear(queue_status);}}});}},similarSearch:function(patternId){new Ajax.Request('/patterns/library/'+patternId+'/similar_search',{method:'GET'});},runSimilarSearch:function(form){var checkboxes=$('similar_search_form').getElementsByTagName('input');var parameters={};$A(checkboxes).each(function(checkbox){if(checkbox.value=='1'){var attributeElement=$(checkbox).up().down('span');var param=attributeElement.getAttribute('data-search-parameter');var value=attributeElement.getAttribute('data-search-value');var current=parameters[param];if(current)current+='+';current=(current||'')+value;parameters[param]=current;}});document.location.href='/patterns/search?'+$H(parameters).toQueryString();},languageSelected:function(select){R.patterns.addLanguage(R.utils.selectedValue(select));$('select_language').selectedIndex=0;},addLanguage:function(language){var current=$('language_id_list').value;var selected=(current=="")?language:current+","+language;$('language_id_list').value=selected;new Ajax.Request('languages?language_id_list='+selected);return selected;},removeLanguage:function(language){if(confirm("Are you sure that you want to remove this language?")){var current=$('language_id_list').value.split(',');var selected=$A(current).without(language).join(',');$('language_id_list').value=selected;new Effect.DropOut($("language_"+language));new Ajax.Request('languages?language_id_list='+selected);}},toggleLanguages:function(a){var caller=$(a).up('li');caller.hide();var ul=$(a).up('ul');ul.getElementsBySelector('li').each(function(li){if(li!=caller){$(li).show();}});},showStatistics:function(id){RedBox.open('pattern_statistics','/patterns/library/'+id+"/statistics");},removeFromHistory:function(id){new Ajax.Request('/patterns/history/remove/'+id,{method:'post'});},addSearchViewParameter:function(a){var href=a.href;if($('view'))href+="&view="+R.utils.selectedValue('view');document.location.href=href;},ignoreConfirmed:function(patternId){$('quicknav').hide();new Effect.DropOut($('pattern_'+patternId));},searchDialog:function(typePrefix,options){var name;if(options){name=options.name;}
if(!name&&$(typePrefix+'_name')){name=$F(typePrefix+'_name');}
if(name!=''){name=(typeof encodeURIComponent=='undefined')?escape(name):encodeURIComponent(name);}
var box=typePrefix+'_redbox';var url='/patterns/search_dialog?q='+name;if(options){if(options.contribute){url+="&contribute=true";}
if(options.linkable==false){url+="&linkable=false";}
if(options.project){url+="&project="+options.project;}
if(options.queuedProject){url+="&queued_project="+options.queuedProject;}
if(options.mine){url+="&mine="+options.mine;}
if(options.advertising){url+="&advertising=true";url+="&advertiser_id="+options.advertiserId;}
if(options.publisher){url+="&publisher="+options.publisher;}}
initializeRedbox(box);RedBox.loading();new Ajax.Updater(box,url,{asynchronous:true,onComplete:function(request){RedBox.addHiddenContent(box);},evalScripts:true});}};}();R.patterns.search=function(){var initialized=false;return{initialize:function(){if(initialized){return;};initialized=true;},onsubmit:function(){},refresh:function(){R.patterns.search.onsubmit();$('search_form').submit();},resort:function(){R.patterns.search.refresh();},reopen:function(id){R.patterns.search.initialize();},filterKeypress:function(attribute){Element.hide(attribute+"_indicator");Element.show(attribute+"_add");},filterAdded:function(attribute,value){if($(attribute+"_input")){Element.hide(attribute+"_indicator");$(attribute+"_input").value='';}},addFilter:function(attribute){R.patterns.search.refresh();},removeFilter:function(attribute,value){R.patterns.search.refresh();},changeFilter:function(attribute,value,direction){$(direction+'_attribute').value=attribute;$(direction+'_value').value=value;var params=Form.serialize('search_form');new Ajax.Request(prependPath(direction+'_filter'),{asynchronous:true,evalScripts:true,parameters:params,method:'get'});},filtersChanged:function(){$('search_filters').innerHTML='';$A(['add_attribute','add_value','remove_attribute','remove_value']).each(function(f){$(f).value='';});}};}();R.patterns.CategorySelect=function(menuField,options){this.initialize(menuField,options);};R.patterns.CategorySelect.prototype.initialize=function(menuField,options){this.menuField=menuField;this.menuContent=options.menuContent;var input=document.createElement('INPUT');input.name='pattern_category_id[]';input.type='hidden';var parent=menuField.up();parent.appendChild(input);this.input=input;var afterSelect=this.afterSelect.bind(this);this.control=new R.controls.MenuField(this.menuField,{menuContent:this.menuContent,afterSelect:afterSelect});var selectedValue=menuField.getAttribute('data-selected-id');if(selectedValue){this.control.markInitialSelections([parseInt(selectedValue)],true);this.input.value=parseInt(selectedValue);}};R.patterns.CategorySelect.prototype.afterSelect=function(itemToAdd,itemToRemove,item){if(itemToAdd===0)itemToAdd='';this.menuField.innerHTML=item.innerHTML;this.input.value=itemToAdd;};R.patternSources=function(){return{initialize:function(){if($('source_patterns_hack')){R.utils.makeRoom($('source_patterns_hack'));}
if(!$('patterns_panel')){updateZoomables();}
R.controls.initializeTabBars();$$('.toolbar_builder').each(function(bar){new R.controls.ToolbarBuilder(bar);});R.notebook.initializeMobileButtonBox();Browser.onBreakpoints({mobile:function(){R.photos.setGridPhotoDimensions();R.patternSources.loadPopularDesigns();R.patternSources.checkPatternResultsView();R.patternSources.checkProjectResultsView();R.photos.lazyLoadImages();},desktop:function(){R.patternSources.checkPatternResultsView();R.patternSources.checkProjectResultsView();}});R.photos.initializePhotoManager(function(){var gallery=$('pattern_source_photo');if(gallery){R.patternSources.refreshPhoto(gallery.getAttribute('data-pattern-source-id'));}});},checkPatternResultsView:function(){R.patternSources.checkResultsView($('pattern_results'),$('source_tools'));},checkProjectResultsView:function(){R.patternSources.checkResultsView($('project_results'),$('search_form'));},checkResultsView:function(container,form){if(!container||!form)return;var viewField=form.down('#view');if(!viewField)return;var currentView=viewField.value;var newView=null;if(Browser.responsiveBreakpoint()&&currentView!=container.getAttribute('data-mobile-view')){newView=container.getAttribute('data-mobile-view');}else if(!Browser.responsiveBreakpoint()&&currentView!=container.getAttribute('data-view')){newView=container.getAttribute('data-view');}
if(newView){viewField.value=newView;R.utils.submitRemoteForm(form);}},loadPopularDesigns:function(){var popularDesignsMobile=$('popular_designs_mobile');if(!popularDesignsMobile||popularDesignsMobile.getAttribute('data-loaded')){return;}
popularDesignsMobile.setAttribute('data-loaded',true);new Ajax.Request(R.utils.prependPath('popular_designs'),{method:'GET'});},periodicalClicked:function(checkbox){if($(checkbox).checked){$('periodical_fields').show();}else{$('periodical_fields').hide();}},refreshPhoto:function(id){new Ajax.Request('/patterns/sources/'+id+'/refresh_photo',{method:'GET'});},validateEditForm:function(){var comment=$('pattern_source_change_comment');if(comment&&comment.value==''){alert('Please describe the change that you are making - it is used for a history of revisions.');comment.focus();return false;}else{return true;}}};}();R.photos=function(){var fullscreen=false;var magicZoomLoaded=false;var magicZoomed=false;var largeFlickrs={};var currentSlide;var draggable=null;var instagramPages={};var blazy=null;var googlePageTokens=[];var setViewport=false;var easeOutCubic=function(pos){return(Math.pow((pos-1),3)+1);};return{setupWebpSupport:function(){var webpUnsupported=Browser.isChrome()&&Browser.getChromeVersion()<25;var webpSupport=getCookie('webp_support');if(webpUnsupported){setCookie('webp_support',0);webpSupport=0;}else{if(webpSupport===null||webpSupport===''){var img=new Image();var setWebpSupport=function(e){var supported=e&&e.type==='load'?img.width===1:false;webpSupport=supported?1:0;setCookie('webp_support',webpSupport);};img.onerror=function(){setCookie('webp_support',0);};img.onload=setWebpSupport;img.src='data:image/webp;base64,UklGRiQAAABXRUJQVlA4IBgAAAAwAQCdASoBAAEAAwA0JaQAA3AA/vuUAAA=';}}
if(webpSupport&&parseInt(webpSupport,10)==1){var swapImageSource=function(e){var image=e.target;if(image&&image.src.indexOf('/webp/')>=0&&image.src.indexOf('ravelrycache.com')>=0){var parts=image.src.split(/[#\?]/);var extension='';if(parts[1]){extension+='.'+parts[1];}
var jpegSrc=parts[0].replace('/webp/','/').replace('.webp',extension);image.setAttribute('src-webp',image.src);image.src=jpegSrc;}};var images=document.querySelectorAll('img[src*=webp]');for(var i=0;i<images.length;i++){var image=images[i];image.observe('contextmenu',swapImageSource);}}},initializeGallery:function(){$$('.photo_gallery .framed_photo--empty').each(function(placeholder){var gallery=placeholder.up('.photo_gallery');var photoManager=gallery.getAttribute('data-photo-manager');var type=gallery.getAttribute('data-photographable-type');if(photoManager=='1'&&(type=='Project'||type=='Stash')){placeholder.style.cursor='pointer';placeholder.onclick=function(){R.photos.startPhotoManager(gallery.getAttribute('data-photographable-id'),type);};}});var thumbnails=$$('.resizable_photo_gallery .photo_gallery__photo');if(Browser.responsiveBreakpoint()&&thumbnails.length>0&&thumbnails.length<3){R.photos.setBackgroundColorFromPhoto($$('.resizable_photo_gallery').first(),thumbnails.last().down('img'),true);}},initializePhotoManager:function(linkedGallery){$$('.static_tab a').each(function(a){if(a.getAttribute('data-photographable-id')){a.href='#';a.onclick=function(e){R.photos.startPhotoManager(a.getAttribute('data-photographable-id'),a.getAttribute('data-photographable-type'),linkedGallery);Event.stop(e);return false;};}});},setBackgroundColorFromPhoto:function(object,img,retry){var photoId=img.getAttribute('data-photo-id');var url='/photos/'+photoId+'/colors';new Ajax.Request(url,{method:'GET',onComplete:function(xhr){var json=xhr.responseText.evalJSON();if(json.colors&&json.colors.length>1){var best=json.colors[0];object.style.backgroundColor='rgb('+best.join(',')+')';}else{if(retry){setTimeout(function(){R.photos.setBackgroundColorFromPhoto(object,img);},5000);}}}});},startPhotoManager:function(photographableId,photographableType,linkedGallery,insertQuickPhotoId){if(!R.controls.PhotoManager){var js='/javascripts/R/controls/photo_manager.js?nocache='+(new Date()).getTime();$script(js,function(){R.photos.startPhotoManager(photographableId,photographableType,linkedGallery,insertQuickPhotoId);});return;}
if(insertQuickPhotoId){R.photos.insertQuickPhoto(insertQuickPhotoId,photographableType,photographableId,function(){R.photos.startPhotoManager(photographableId,photographableType,linkedGallery);});return;}
$(document.body).addClassName('with_photo_manager_dialog');var fullscreen=false;if(Browser.responsiveBreakpoint()){if(!(R.swatch&&R.swatch.isSwatching('FRONTEND12'))){$(document.body).addClassName('hide_content');}
fullscreen=true;}else if(Browser.probablyTouchScreen()&&$(document.body).hasClassName('with_squinty_device')){$(document.body).addClassName('hide_content');Browser.setViewportTag('width=650; user-scalable=no');setViewport=true;fullscreen=true;}else if(Browser.probablyTouchScreen()&&$(document.body).hasClassName('with_extra_squinty_device')){$(document.body).addClassName('hide_content');Browser.setViewportTag('width=450; user-scalable=no');setViewport=true;fullscreen=true;}
if(!linkedGallery){linkedGallery=$$('.photo_gallery_container').first();if($('pattern_gallery_contents')){linkedGallery=function(){var editing=$(document.body).hasClassName('edit_action')?'?editing=1&__framed_photo=1':'';new Ajax.Request('/patterns/library/'+photographableId+'/gallery_contents?'+editing,{method:'GET'});};}}
url='/photo_manager?photographable_type='+photographableType+'&photographable_id='+photographableId;RedBox.open('photo_manager_dialog',url,{fade:false,fullscreen:fullscreen,actionSheet:'fullscreen',onComplete:function(){new R.controls.TabBar($('photo_manager').down('.tab_bar_responsive'));new R.controls.PhotoManager($('photo_manager'),photographableId,photographableType,linkedGallery);},onClose:function(){$(document.body).removeClassName('with_photo_manager_dialog');$(document.body).removeClassName('hide_content');if(setViewport){setTimeout(function(){Browser.removeViewportTag();},50);}
if(!(R.swatch&&R.swatch.isSwatching('FRONTEND12')&&Browser.responsiveBreakpoint())){R.utils.scrollToTop();}}});},setGridPhotoDimensions:function(onResize){if(onResize){Event.observe(window,'resize',R.photos.setGridPhotoDimensions);}
$$('.grid_photo--needs_scale').each(function(photo){if(Browser.responsiveBreakpoint()||photo.hasClassName('grid_photo__scaled')){var img=photo.down('img');if(img&&img.getAttribute('data-lazy-src')&&!img.getAttribute('data-lazy-loading')){img.setAttribute('data-lazy-loading',true);img.onload=function(){R.photos.setSingleGridPhotoDimensions(photo);};img.src=img.getAttribute('data-lazy-src');}else{R.photos.setSingleGridPhotoDimensions(photo);}}});},setSingleGridPhotoDimensions:function(photo){var img=photo.down('img');if(img){var originalFrame=img.getAttribute('data-offset-relative-to')||170;var originalWidth=img.getAttribute('data-original-width')||img.getWidth();img.setAttribute('data-original-width',originalWidth);if(Browser.responsiveBreakpoint()){var newFrame=photo.down('.grid_photo__frame').getWidth();var newWidth=(originalWidth/originalFrame)*newFrame;img.style.width=newWidth+'px';}else{img.style.width=originalWidth+'px';}}
photo.addClassName('grid_photo--scaled');},lazyLoadImages:function(){if(blazy)blazy.destroy();if($$('.photo_full_width__image--blazy').first()){blazy=new Blazy({selector:'.photo_full_width__image--blazy',successClass:'photo_full_width__image photo_full_width__image--search photo_full_width__image--loaded',loadInvisible:true});}},updateZoomables:function(){var hero=$$('.photo_gallery_hero').first();if(hero){window.__newZoomableBehavior=true;var galleryPhotos=$$('.photo_gallery__section');var images=galleryPhotos.map(function(o){var img=o.down('img');return{id:img.getAttribute('data-photo-id'),src:img.getAttribute('data-slideshow-url')};});new R.controls.TouchGallery(hero,{variableHeight:true,images:images,useDots:true,controls:galleryPhotos,clickForFullscreen:true});}
$$('.zoomable_photo').each(function(element){if(!element.__update_zoomables){element.__update_zoomables=true;Event.observe(element,'click',function(e){if(Browser.responsiveBreakpoint()&&window.__newZoomableBehavior){return;}
if(R.navigation.compressedNavigationEnabled()){var img=element.down('img');var slideshowUrl=img&&img.getAttribute('data-slideshow-url');if(slideshowUrl){var replaceImage=$('slideshow_element').down('img');replaceImage.id="hero_"+element.id;replaceImage.src=img.src;replaceImage.setAttribute('srcset',slideshowUrl+" 2x");}else{R.photos.responsiveFullscreen(element);}}else{R.photos.zoom(element);}
Event.stop(e);});}});},responsiveFullscreen:function(photo){var photoId=getId(photo)||photo.getAttribute('data-photo-id');var fullscreenUrl=R.utils.prependPath('slideshow')+"?fullscreen=1&start="+photoId;document.location.href=fullscreenUrl;},changeCarousel:function(photographableType,photographableId,currentPhotoId,increment,view){var url="/photos/carousel";url+="?photographable_type="+photographableType;url+="&photographable_id="+photographableId;url+="&photo_id="+currentPhotoId;url+="&increment="+increment;url+="&view="+view;if(view!='tallcards'&&view!='tallcards_v2'){var caption=$('carousel_controls_'+photographableId).down('.caption');if(R.swatch.isSwatching('FRONTEND12')){caption.innerHTML="<img src='/images/assets/icons/ui/tiny-loader.svg' class='icon_16 o-icon o-icon--loading_xtiny' />";}else{caption.innerHTML="<img src='/images/tiny-indicator-2.gif' class='tiny_indicator' />";}}
new Ajax.Request(url);},updateCarousel:function(photographableId,carouselPage,photoCount,content,controls,view){var container=$('carousel_photo_'+photographableId)||$('carousel_controls_'+photographableId).up('.carousel_photo');var link=null;var border=container.down('.photo_border');if(border){link=border.getAttribute('href');}
var imageWidth=171;if(view=='tallcards')imageWidth=280;if(view=='tallcards_v2'&&R.swatch.isSwatching('FRONTEND12')){imageWidth=container.up('.c-notebook_tallcard__photo').getWidth();}
var carousel=container.down('.carousel');if(!carousel){var frame=container.down('.framed_photo');var html="<div class='carousel'><div class='carousel_window'>";for(var i=0;i<photoCount;i++){html+="<div class='carousel_page carousel_page_"+i+"'></div>";}
html+="</div></div>";new Insertion.Before(frame,html);carousel=container.down('.carousel');carousel.down('.carousel_page').appendChild(frame);}
var insertedPage=carousel.down(".carousel_page_"+carouselPage);insertedPage.innerHTML=content;var photo=insertedPage.down('.zoomable_photo');photo.onclick=function(e){var evt=e||window.event;if(R.swatch&&R.swatch.isSwatching('FRONTEND12')&&link){document.location.href=link;}else{R.photos.zoom(photo);}
Event.stop(evt);};var carouselWindow=carousel.down('.carousel_window');var offset=(carouselPage*(-1*imageWidth));var style='left:'+offset+'px;';if(R.swatch&&R.swatch.isSwatching('FRONTEND12')&&view=='tallcards_v2'&&Browser.responsiveBreakpoint()){var img=photo.down('img');if(img.getAttribute('data-image-height')){img.height=img.getAttribute('data-image-height');img.width=img.getAttribute('data-image-width');var aspectRatio=parseInt(img.getAttribute('data-image-width'))/parseInt(img.getAttribute('data-image-height'));var height=imageWidth/aspectRatio;style+='height: '+height+'px;';}}
setTimeout(function(){emile(carouselWindow,style,{duration:250,easing:function(pos){if((pos/=0.5)<1)return 0.5*Math.pow(pos,4);return-0.5*((pos-=2)*Math.pow(pos,3)-2);}});$('carousel_controls_'+photographableId).innerHTML=controls;},150);},zoomer:function(photo,count){photo=$(photo);var zoomerId=photo.id+"_zoomer";var zoomer=$(zoomerId);if(!zoomer){var inner="";if(count==1){inner='1 <img src="/images/silk-image.png">';}else if(count){inner=count+' <img src="/images/silk-images.png">';}else{inner='<img src="/images/silk-magnifier_zoom_in.png">';}
var html='<a href="#" id="'+zoomerId+'"class="zoomer" onclick="R.photos.zoom(\''+photo.id+'\', true); return false;">'+inner+'</a>';if(photo.tagName=='A'){photo.innerHTML=html;}else{new Insertion.After(photo,html);}}else{if(!Element.visible(zoomer)){zoomer.show();}}},hideZoomer:function(photo){photo=$(photo);var zoomer=$(photo.id+"_zoomer");if(zoomer){zoomer.hide();}},closeZoom:function(){RedBox.close();Element.removeClassName(document.body,'redbox_fullscreen');},fullscreen:function(url){var currentPhotoId=getId($('image_container').down('.photo_image'));document.location.href=url+"&start="+currentPhotoId;},zoom:function(element,generic){Event.observe(document,'keypress',function(e){if(e.keyCode==Event.KEY_ESC){R.photos.closeZoom();}});if(R.utils.isNumber(element)&&Browser.responsiveBreakpoint()){var fullscreenUrl=R.utils.prependPath('slideshow')+"?fullscreen=1&start="+element;document.location.href=fullscreenUrl;return;}
if(R.utils.isNumber(element)){element="photo_"+element;}
element=$(element);initializeRedbox(element.id+"_box");var box=$(element.id+"_box");var page=window.location.search.parseQuery()["page"];var page=!page?"":"&page="+page;var url;var photoId=element.getAttribute('data-photo-id')||getId(element);if(element.getAttribute('data-zoom-url')){url=element.getAttribute('data-zoom-url');}else if(generic){url='/photos/slideshow?start='+photoId;}else{url=prependPath('slideshow?start='+photoId+page);url=url.replace("/edit/","/");}
RedBox.loading({fade:false});new Ajax.Request(url,{method:'get',asynchronous:true,onComplete:function(xhr){box.update(xhr.responseText);RedBox.addHiddenContent(box,null,{fade:false});slideshowRedbox();},evalScripts:true});},setImageContainerSize:function(){if(fullscreen){var height=document.viewport.getHeight();}else{$('image_container').className='';}},setCaptionWidth:function(){var container=$('image_container');var photo=container.down('.photo_image');if(photo.width){var caption=$(container.parentNode).down('.slide__caption');if(caption){caption.style.width=photo.width+'px';caption.show();}}else{setTimeout(R.photos.setCaptionWidth,100);}},slideLoaded:function(photoId,checkForZoom,mobileZoomUrl){var container=$(slideshow);if(!container.__makeDraggable){container.__makeDraggable=true;RedBox.makeDraggable('slideshow','heading');}
if(draggable){draggable.destroy();}
if(container&&container.getAttribute('data-show-photographable-link')=='1'){var link=$('photographable_link');if(link)link.show();}
Element.hide('default_indicator');R.photos.setImageContainerSize();R.photos.setCaptionWidth();currentSlide=photoId;var slide=false;$$('#current_slide .slide').each(function(element){if(!slide){$(element).show();slide=true;}else{$(element).hide();}});if(checkForZoom){R.photos.checkForZoom(photoId);}
if(mobileZoomUrl&&mobileZoomUrl!==''&&document.body.clientWidth){Event.observe(window,'touchend',function(){var ratio=document.body.clientWidth/window.innerWidth;if(ratio>1.5){var image=$('photo_image_'+photoId);if(!image.__mobileZoomUrl){image.__mobileZoomUrl=true;var height=image.height;var width=image.width;image.style.height=height+'px';image.style.width=width+'px';image.src=mobileZoomUrl;}}});}},checkForZoom:function(photoId){var image=$('photo_image_'+photoId);$('image_container').className='';image.onclick=function(){};new Ajax.Request('/photos/'+photoId+'/sizes',{method:'get',onSuccess:function(xhr){var sizes=eval("("+xhr.responseText+")");var image=$('photo_image_'+photoId);if(sizes&&sizes.large&&image){$('image_container').className='zoomable';image.onclick=function(e){var evt=e?e:window.event;R.photos.magnify(photoId,sizes.large,evt,sizes.dimensions.large);};}}});},unmagnify:function(photoId){var image=$('photo_image_'+photoId);if(draggable){draggable.destroy();}
emile(image,"left: 0px; top: 0px; width: "+image.savedWidth+"px; height: "+image.savedHeight+"px;",{easing:easeOutCubic,duration:500,after:function(){image.src=image.savedSrc;image.onclick=image.savedOnclick;$('image_container').className='zoomable';}});},magnify:function(photoId,url,evt,dimensions){var image=$('photo_image_'+photoId);var passedPhotoId=photoId;var passedUrl=url;var prevWidth=image.width;if(prevWidth)image.style.width=prevWidth+"px";var prevHeight=image.height;if(prevHeight)image.style.height=prevHeight+"px";if(image){var container=$('image_container');container.className='magnified';image.savedOnclick=image.onclick;image.savedSrc=image.src;image.savedWidth=image.width;image.savedHeight=image.height;image.onload=function(){};image.onclick=function(){};var left=0;var top=0;if(evt){var x=Event.pointerX(evt);var y=Event.pointerY(evt);var pos=Position.cumulativeOffset(container);left=Math.round(((-1*(x-pos[0]))*(image.width+320)/(prevWidth*1.0)))+"px";top=Math.round(((-1*(y-pos[1]))*(image.height+320)/(prevHeight*1.0)))+"px";}
var width=dimensions[0]+"px";var height=dimensions[1]+"px";emile(image,"left:"+left+"; top:"+top+"; width: "+width+"; height: "+height+";",{easing:easeOutCubic,duration:500,after:function(){image.src=passedUrl;R.photos.makeDraggable(passedPhotoId);}});}},makeDraggable:function(photoId){draggable=new Draggable($('photo_image_'+photoId),{starteffect:null,endeffect:null});},loadSlide:function(photoId){currentSlide=photoId;new Ajax.Updater('current_slide','/photos/slide/'+photoId,{evalScripts:true,insertion:Insertion.Top,onLoading:function(){slideLoading();},parameters:{fullscreen:fullscreen}});},slurp:function(url,photographableType,photographableId,login){new Ajax.Request('/photos/slurp',{parameters:{url:url,photographable_type:photographableType,photographable_id:photographableId,copyright:login}});},scheduleProgressCheck:function(key){setTimeout(function(){new Ajax.Request('/photos/progress?key='+key,{asynchronous:true,evalScripts:true,method:'get',on500:function(){$('flickr_search').innerHTML='Slurp failed! The photo slurper may not be working properly - try again later.'}});},500);},rate:function(select,type,id){var value=select.options[select.selectedIndex].value;if($('rating_progress'))$('rating_progress').show();new Ajax.Request('/photos/rate?photographable_id='+id+"&photographable_type="+type+"&value="+value);},waitForPhoto:function(jobKey,callback){var pollInterval=150;var unfinishedCallback=function(){R.photos.waitForPhoto(jobKey,callback);};new Ajax.Request('/photos/progress.json?key='+jobKey,{onComplete:function(xhr){var result=xhr.responseText.evalJSON();if(result.finished){callback(result);}else{setTimeout(unfinishedCallback,pollInterval);}}});},instagramLogout:function(){var img=document.createElement('IMG');img.style.display='none';img.style.width='0px';img.style.height='0px';document.body.appendChild(img);img.src='https://instagram.com/accounts/logout/';},googleLogout:function(){R.utils.openUrlWithPost('/google_oauth/disconnect',{},false);},setInstagramPage:function(page,instagramIds){instagramPages[page]=instagramIds;},loadInstagramPhotos:function(photographableType,photographableId,options){var page=null;if(options&&options.pager){var pager=options.pager;page=pager.href.toQueryParams()['page'];}
new Ajax.Request('/instagram_media/photos',{method:'GET',parameters:{page:page,photographable_type:photographableType,photographable_id:photographableId}});},loadGooglePhotos:function(photographableType,photographableId,options){var page=1;var pageToken;var googleAlbumId;if($('google_album_id')){googleAlbumId=R.utils.selectedValue($('google_album_id'));}
if(options&&options.pager){var pager=options.pager;page=parseInt(pager.href.toQueryParams()['page']);var items=$$('.media_browser__item');var lastItem=items.last();if(lastItem){var currentPage=parseInt(lastItem.getAttribute('data-google-page'),10);googlePageTokens[currentPage+1]=lastItem.getAttribute('data-google-next-page-token');if(pager.hasClassName('next_page')){pageToken=googlePageTokens[currentPage+1];}else if(pager.hasClassName('previous_page')){pageToken=googlePageTokens[currentPage-1];}}}
new Ajax.Request('/google_media/photos',{method:'GET',parameters:{'page':page,'page_token':pageToken,'photographable_type':photographableType,'photographable_id':photographableId,'google_album_id':googleAlbumId}});},quickPhotoStillProcessing:function(){return $$('.photo_id_field').first().value==='';},quickPhotoPost:function(url){if(R.photos.quickPhotoStillProcessing()){setTimeout(function(){R.photos.quickPhotoPost(url);},50);}else{$('quick_photo_post').action=url;$('quick_photo_post').submit();}},quickPhotoSubmitProject:function(form){if(R.photos.quickPhotoStillProcessing()){setTimeout(function(){R.photos.quickPhotoSubmitProject(form);},50);return;}
form.submit();},quickPhotoSubmitStash:function(form){if(R.photos.quickPhotoStillProcessing()){setTimeout(function(){R.photos.quickPhotoSubmitStash(form);},50);return;}
var url=null;$('spinning_project_name').value=$('prepare_pack_form_yarn_name').value;$('spinning_project_photo_id').value=$('prepare_pack_form_photo_id').value;$(form).getElementsBySelector('input').each(function(input){if(input.checked){url=input.getAttribute('data-form-action');}});if(url)form.action=url;form.submit();},insertQuickPhoto:function(photoId,photographableType,photographableId,callback){new Ajax.Request('/photos/'+photoId+'/insert_quick_photo',{method:'POST',parameters:{'photographable_type':photographableType,'photographable_id':photographableId,},onComplete:function(){if(callback){callback(photoId);}}});}};}();R.popover=function(){var closeEventAttached=false;var popoverId='popover';var popoverParentId='content';var pageFooterId='prefooter';var pageId='page';var popoverWidth=381;var popoverWidthMargin=25;var yOffset=0;var extraContentHeight=20;var reopening=false;var closeEventsEnabled=true;var unsavedChanges=false;var popoverHTML='<div id="'+popoverId+'" class="popover popover_{orientation}"><div id="popover_pointer" class="popover_pointer"></div><div id="popover_body" class="popover_body"></div><div class="popover_footer"></div></div>';var currentAnchor=null;return{enableCloseEvents:function(){closeEventsEnabled=true;},disableCloseEvents:function(){closeEventsEnabled=false;},isCloseEventsEnabled:function(){if(R.swatch&&R.swatch.isSwatching('FRONTEND12')&&Browser.responsiveBreakpoint()){return false;}
return closeEventsEnabled;},pop:function(anchor,content,options){if(R.swatch.isSwatching('FRONTEND12')){popoverWidth=369;popoverWidthMargin=0;}
R.popover.close();if(options&&options.disableCloseEvents){R.popover.disableCloseEvents();}else{R.popover.enableCloseEvents();}
if(!options)options={};var attachToLink=true;var orientation='default';var attachToAnchor=null;var animate=true;if(options.attachToLink==false)attachToLink=false;if(options.orientation)orientation=options.orientation;if(options.anchor)attachToAnchor=options.anchor;if(options.animate==false)animate=false;anchor=$(anchor);if(attachToLink&&anchor.tagName!='A'){anchor=anchor.down('a');}
currentAnchor=anchor;currentAnchor.addClassName('popover_active');var popover=$(popoverId);var actionSheet=null;if(!popover){var parent=$(popoverParentId);if(R.swatch&&R.swatch.isSwatching('FRONTEND12')&&Browser.responsiveBreakpoint()){actionSheet=R.controls.buildActionSheet();parent.appendChild(actionSheet.up());parent=actionSheet;}
new Insertion.Bottom(parent,popoverHTML.replace('{orientation}',orientation));popover=$(popoverId);}else{if(R.swatch&&R.swatch.isSwatching('FRONTEND12')&&Browser.responsiveBreakpoint()){actionSheet=popover.up('.action_sheet');}
popover.className='popover popover_'+orientation;}
var popoverBody=popover.down('.popover_body');if(!actionSheet){R.popover.positionAtCurrentAnchor(attachToAnchor);popoverBody.setStyle({height:'0px',overflow:'hidden'});}
popoverBody.innerHTML=content;popover.show();if(!actionSheet){var finalHeight=R.popover.measureContentHeight(content)+extraContentHeight;R.popover.makeRoom(popover,finalHeight);if(animate){emile(popoverBody,"height: "+(finalHeight)+"px");}else{popoverBody.style.height=finalHeight+"px";}}
if(options.promptOnUnsavedChanges){unsavedChanges=false;$$("#"+popoverId+" input").each(function(input){Event.observe(input,'change',function(e){R.popover.formChanged();});});$$("#"+popoverId+" textarea").each(function(input){Event.observe(input,'change',function(e){R.popover.formChanged();});});}
if(!closeEventAttached){closeEventAttached=true;Event.observe(document,'keypress',function(e){if(e.keyCode==Event.KEY_ESC){R.popover.close();}});Event.observe(document,'click',function(e){var element=$(Event.element(e));if(R.popover.isCloseEventsEnabled()&&element&&!element.hasClassName('popover')&&!element.up('.popover')&&!element.up('#RB_redbox')&&!element.up('.autocomplete')){if(document.body.contains(element)){if(reopening){reopening=false;}else{R.popover.close();}}}});Event.observe(window,'resize',function(e){if(!popover.hasClassName('popover--fullscreen')){R.popover.positionAtCurrentAnchor(options.anchor);}});}
if(actionSheet){R.controls.actionSheet(actionSheet.id);}else{if(Browser.responsiveBreakpoint()){R.popover.fullscreen();}}},recalculateHeight:function(minimumHeight){var popover=$('popover');var popoverBody=popover.down('.popover_body');var content=popoverBody.innerHTML;var finalHeight=R.popover.measureContentHeight(content)+extraContentHeight;if(minimumHeight&&(finalHeight<minimumHeight)){finalHeight=minimumHeight;}
R.popover.makeRoom(popover,finalHeight);popoverBody.setStyle({height:finalHeight+"px"});},formChanged:function(){unsavedChanges=true;},formSaved:function(){unsavedChanges=false},measureContentHeight:function(content){if(!$('offscreen_container')){var style="width:"+(popoverWidth-(popoverWidthMargin*2))+"px; position: absolute; top: 0; left: 0; z-index: -1000; visibility: hidden;";new Insertion.Bottom(document.body,"<div id='offscreen_container' style='"+style+"'></div>");}
var offscreen=$('offscreen_container');offscreen.className='popover_body';offscreen.innerHTML=content;var height=Element.getHeight(offscreen);document.body.removeChild(offscreen);return height;},positionAtCurrentAnchor:function(anchorOptions){var popover=$(popoverId);var anchor=currentAnchor;var anchorWidth=Element.getWidth(anchor);var anchorHeight=Element.getHeight(anchor);var anchorPos=Position.cumulativeOffset(anchor);var pageYPos=0;if($(pageId)){pageYPos=Position.cumulativeOffset($(pageId))[1];}
var popoverX;if(popover&&popover.hasClassName('popover_right')){var extraOffset=-130;popoverX=Math.round(anchorPos[0]+(anchorWidth/2)-(popoverWidth/2)+extraOffset);}else if(popover&&popover.hasClassName('popover_left')){var extraOffset=132;popoverX=Math.round(anchorPos[0]+(anchorWidth/2)-(popoverWidth/2)+extraOffset);}else{popoverX=Math.round(anchorPos[0]+(anchorWidth/2)-(popoverWidth/2));}
var popoverY=anchorPos[1]+anchorHeight+yOffset-pageYPos;if(popover){popover.setStyle({top:popoverY+"px",left:popoverX+"px"});}},makeRoom:function(makeRoomFor,height){if(!makeRoomFor){makeRoomFor=$('popover');}
var pageFooter=$(pageFooterId);var footerHeight=Element.getHeight(pageFooter);if(!height){height=Element.getHeight(makeRoomFor);}
var pos=Position.positionedOffset(makeRoomFor);var footerPos=Position.positionedOffset(pageFooter);var room=footerPos[1]-pos[1];if(room<height){var moreRoom=height-room;pageFooter.setStyle({height:moreRoom+"px"});}},isVisible:function(){return $(popoverId)&&$(popoverId).visible();},reopen:function(){var popover=$(popoverId);if(popover){reopening=true;popover.show();if(currentAnchor){currentAnchor.addClassName('popover_active');}
var actionSheet=popover.up('.action_sheet');if(actionSheet){R.controls.actionSheet(actionSheet);}}},fullscreen:function(){$('popover').addClassName('popover--fullscreen');$('content').style.visibility='hidden';$$('.wmd_frame').each(function(w){w.style.visibility='hidden';});$('page').style.overflow='hidden';$('popover').setStyle({position:'absolute',top:'30px',right:0,left:0,bottom:0,width:'100%',backgroundImage:'none'});$('popover_body').setStyle({marginTop:'30px',paddingLeft:'5px',paddingRight:'5px'});$$('.popover div').each(function(p){p.style.backgroundImage='none';});$('page').appendChild($('popover'));R.utils.scrollToTop();},exitFullscreen:function(){$('popover').remove();$('content').style.visibility='';$('page').style.overflow='';$$('.wmd_frame').each(function(w){w.style.visibility='';});R.utils.scrollToSavePoint();},close:function(ignoreChanges){if(ignoreChanges||!unsavedChanges||confirm("Are you sure that you want to close without saving your changes?")){unsavedChanges=false;if(currentAnchor){currentAnchor.removeClassName('popover_active');}
var popover=$(popoverId);if(popover){popover.hide();if(popover.hasClassName('popover--fullscreen')){R.popover.exitFullscreen();}
var actionSheet=popover.up('.action_sheet');if(actionSheet){R.controls.hideActionSheet(actionSheet.id);}}}}};}();R.posts=function(){return{prepareRelatedPost:function(feedItemId){new Ajax.Request('posts/'+feedItemId+'/prepare_related_post',{method:'GET'});},insertRelatedPostAutocomplete:function(feedItemId,autocompletes){var controlHtml='<input id="link_control_input" placeholder="Search projects and stash by name..." style="width: 490px; padding: .25em; font-size: 1em;" />';controlHtml+='<div id="link_control_autocomplete" class="select_box_autocomplete autocomplete">';if($('link_control_input')){$('link_control_input').remove();$('link_control_autocomplete').remove();$$('li.prepare_related_post').each(function(li){li.show();});}
$('link_feed_item_'+feedItemId).innerHTML=controlHtml;$('prepare_related_post_'+feedItemId).hide();var callback=function(relatedPostKey,element,autocompleter){autocompleter.hide();R.controls.insertAjaxIndicator($('link_feed_item_'+feedItemId));var parsed=relatedPostKey.split(':');R.posts.createRelatedPost(feedItemId,parsed[0],parsed[1]);};var ac=new Autocompleter.SelectBox($('link_control_input'),callback,$('link_control_autocomplete'),autocompletes,{height:'200px'});$('link_control_input').onfocus=$('link_control_input').onclick=function(){ac.activate();ac.show();};$('link_control_input').focus();},createRelatedPost:function(feedItemId,itemType,itemId){var params={'feed_item_id':feedItemId,'item_type':itemType,'item_id':itemId,view:'postindex'};new Ajax.Request('/related_posts/create',{method:'POST',parameters:params});},refreshFeed:function(feedId,caller,onNewItems){if(caller){$(caller).hide();if(!$('refresh_feed_indicator')){new Insertion.After(caller,"<span id=\"refresh_feed_indicator\"><img src=\"/images/arrows-indicator.gif\" /></span>");}}
new Ajax.Request('/posts/refresh_feed?feed_id='+feedId,{onComplete:function(xhr){var json=xhr.responseText.evalJSON();var key=json['job_key'];var callback=onNewItems;setTimeout(function(){R.posts.checkRefreshStatus(key,callback);},250);}});},checkRefreshStatus:function(key,newItemsCallback){new Ajax.Request('/posts/refresh_status?job_key='+key,{method:'GET',onComplete:function(xhr){var json=xhr.responseText.evalJSON();if(json['completed']){var newItems=json['new_item_count'];var ind=$('refresh_feed_indicator');ind.style.display='inline-block';ind.style.padding='.5em';ind.innerHTML=(newItems||"no")+" new post"+(newItems==1?"":"s");if(newItems&&newItems>0)newItemsCallback(newItems);}else{setTimeout(function(){R.posts.checkRefreshStatus(key);},250);}}});}};}();R.preferences=function(){return{toggle:function(key,value,options){var url='/preferences/toggle?key='+key;if(value||value===0)url+="&value="+value;new Ajax.Request(url,options);},userPreference:function(key){var prefElement=$('user_preference_data');return prefElement&&prefElement.getAttribute('data-'+key);},autohideNavigation:function(){if($(document.body).hasClassName('with_static_header')){return false;}
if(Browser.hasTouchEvents()){return R.preferences.userPreference('autohide-nav-touch')=='1';}else{return R.preferences.userPreference('autohide-nav')=='1';}},modeChanged:function(select){var automatic=R.utils.selectedValue(select)=='automatic';if(automatic){$('light_theme_select_container').show();}else{$('light_theme_select_container').hide();}},previewTypeface:function(select){var value=R.utils.selectedValue(select);$(document.body).removeClassName('with_typeface_inter');$(document.body).removeClassName('with_typeface_helvetica');$(document.body).removeClassName('with_typeface_sans');if(value=='inter'){$(document.body).addClassName('with_typeface_inter');}else if(value=='helvetica'){$(document.body).addClassName('with_typeface_helvetica');}else if(value=='sans'){$(document.body).addClassName('with_typeface_sans');}}};}();R.promotions=function(){return{initialize:function(){if($('promotion_form')){R.tips.initializeTips($('promotion_form'),'promotion_form',{top:200});$$('#promotion_form input').each(function(input){Element.observe(input,'click',function(){R.promotions.formOptionsChanged();});});$$('#promotion_form select').each(function(input){Element.observe(input,'keyup',function(){R.promotions.formOptionsChanged();});Element.observe(input,'change',function(){R.promotions.formOptionsChanged();});});R.promotions.formOptionsChanged();}},selectAll:function(el,field){$$(field).each(function(input){input.checked=(el.checked==true);});},testPromotion:function(url){var form=$('promotion_test');var url=form.action+"?"+form.serialize();RedBox.open('cart_box',url,{method:'post'});},formOptionsChanged:function(){var promotionType=parseInt(R.utils.selectedValue('promotion_promotion_type_id'));if(promotionType==1){$('prefix_info').hide();$('coupon_code_fieldset').show();$('maximum_uses_field').show();}else if(promotionType==2){$('prefix_info').show();$('coupon_code_fieldset').show();$('maximum_uses_field').hide();}else{$('coupon_code_fieldset').hide();$('maximum_uses_field').hide();}
if(promotionType==2){$('offer_none').show();}else{$('offer_none').hide();}
if($('patreon_requirements')){if(promotionType==3){$('patreon_requirements').hide();}else{$('patreon_requirements').show();}}
if($('offer_type_discounted_set').checked){Form.Element.disable($('requirement_type_none'));Form.Element.disable($('requirement_type_amount'));Form.Element.disable($('requirement_type_quantity'));$('requirement_type_product').checked=true;}else{Form.Element.enable($('requirement_type_none'));Form.Element.enable($('requirement_type_amount'));Form.Element.enable($('requirement_type_quantity'));}
$$('#promotion_form input').each(function(input){if(input.type=='radio'){var subforms=$(input).up('li').getElementsBySelector('ul');for(var i=0;i<subforms.length;i++){var subform=subforms[i];input.checked?subform.show():subform.hide();}}});var perCustomerLimit=R.utils.selectedValue('promotion_per_customer_limit')==="true";var noRequirements=$('requirement_type_none').checked;var choiceOfFree=$('offer_type_free_choice').checked;if(perCustomerLimit&&noRequirements&&choiceOfFree){$('confirm_any_product_section').show();}else{$('confirm_any_product_section').hide();}
if(!perCustomerLimit&&noRequirements&&choiceOfFree&&promotionType!=2){$('confirm_dangerous_product_section').show();}else{$('confirm_dangerous_product_section').hide();}
if($('past_purchases_eligible')&&$('past_purchases_eligible').checked){$('past_purchases_include_lys_item').show();}else{$('past_purchases_include_lys_item').hide();}}}}();R.products=function(){var currencies={};return{initializeEditor:function(){Sortable.create('pdf_gallery',{tag:'div',only:'sortable_pdf',handle:'thumbnail',longPress:false,scroll:window,onUpdate:function(){R.products.updateAttachmentOrder();}});},initializeForm:function(){R.products.currencySelected('product_currency');R.products.wholesaleSelected('product_wholesale');R.products.freeSelected('product_free');},updateAttachmentOrder:function(){var ids=$$('.sortable_pdf').map(function(p){return getId(p);});new Ajax.Request('update_attachment_order',{method:'POST',parameters:{'product_attachment_ids':ids.join(' ')}});},setCurrencies:function(currencyHash){currencies=currencyHash;},freeSelected:function(checkbox){if($F(checkbox)){$A(['product_price','product_currency','product_wholesale','product_wholesale_price']).each(function(elem){if($(elem))Form.Element.disable(elem);});$('free_icon').show();}else{$A(['product_price','product_currency','product_wholesale','product_wholesale_price']).each(function(elem){if($(elem))Form.Element.enable(elem);});$('free_icon').hide();}
R.products.updateLysPrice();},wholesaleSelected:function(select){if($(select)){var value=$F(select);if(value=="false"){$('lys_price').hide();}else{$('lys_price').show();}
R.products.updateLysPrice();}},updateLysPrice:function(){if($('lys_price')){var retail=$('product_price').value;var currency=R.utils.selectedValue('product_currency');var url="recalculate_wholesale_price?retail="+retail+"&currency="+currency;new Ajax.Request(url,{method:'get'});}},refreshStatus:function(){new Ajax.Request('refresh_product_status');},showVatCut:function(link){$('vat_cut').toggle();},currencySelected:function(select){var value=$F(select);var currency=currencies[value];if(currency){var symbol=$('currency_symbol');if(symbol){symbol.innerHTML=" ("+currency.symbol+")";}}
R.products.updateLysPrice();}};}();R.projects=function(){return{expandPhotos:function(user,projectId){var base=$('square_project_'+projectId);var url='/projects/'+user+'/'+projectId+'/expand_photos';new Ajax.Request(url,{method:'get',onComplete:function(){var projects=$$('.square_project_'+projectId);projects.each(function(project,index){if(index>0){new Effect.Appear(project,{duration:0.2,queue:'end'});}
var photos=project.down('li.photos');photos.innerHTML="Photo "+(index+1)+" of "+projects.length;});}});},patternSelected:function(patternId,name){if($('project_pattern_id')){$('project_pattern_id').value=patternId;$('project_pattern_name').value=name;suggestionsClosed('project_pattern');}
if(R.swatch&&R.swatch.isSwatching('FRONTEND12')){if(patternId&&patternId!=''){$('project_classifications').hide();}else{$('project_classifications').show();}}},expandYarnList:function(tallCard,toggle){tallCard=$(tallCard);tallCard.getElementsBySelector('.tall_notebook_card__vitals__yarns__item').each(function(item){item.show();});$(toggle).up('.tall_notebook_card__vitals__yarns__item').hide();},addPack:function(options){var params={};if(options&&options.copyFrom){var copyFromPack=$('pack_'+options.copyFrom);params['copy_from']=options.copyFrom;params['copy_yarn_id']=copyFromPack.down('input.yarn_id').value;params['copy_skein_priority']=copyFromPack.down('input.skein_priority').value;}
new Ajax.Request('new_pack',{parameters:params});}};}();R.pushstream=function(){return{nchanClient:function(channelId){var channelIdList=channelId;if(Array.isArray(channelIdList)){channelIdList=channelIdList.join(',');}
var url="https://websocket2.ravelry.com/nchan/sub?id="+channelIdList;var options={subscriber:'websocket'};var subcriber=new NchanSubscriber(url,options);return subcriber;},isSupported:function(){return window.NchanSubscriber&&(window.WebSocket&&!window.MozWebSocket);}};}();R.queue=function(){var adjustmentUser;var queue={start:0};var arranger=null;return{initialize:function(){window.mobileExperience=new R.controls.MobileExperience({lazyLoadImages:{selector:'.photo_gallery__photo img',src:'data-slideshow-url',loadInvisible:false},onMobileView:function(){if($$('table#queued_projects').first()){document.location.href=R.utils.addQueryParameter(document.location.href,'view','thumblist');}}});R.queue.initializeQueuedProjects();},initializeQueuedProjects:function(){$$('.ellipsis_menu').each(function(element){new R.controls.EllipsisMenu(element);});$$('.launch_queue_arranger').each(function(link){link.observe('click',function(e){R.queue.openArranger(link.getAttribute('data-queued-project-id'));Event.stop(e);});});var sortOrderEdited=function(){R.queue.sortOrderEdited(this,this.getAttribute('data-initial-sort-order'));};$$('input.sort_field').each(function(){}