mw.loader.implement("ext.visualEditor.articleTarget@177ln",function($,jQuery,require,module){ve.init.mw.SaveErrorHandler=function(){};OO.initClass(ve.init.mw.SaveErrorHandler);ve.init.mw.SaveErrorHandler.static.matchFunction=null;ve.init.mw.SaveErrorHandler.static.process=null;ve.init.mw.saveErrorHandlerFactory=new OO.Factory();ve.init.mw.ArticleTarget=function VeInitMwArticleTarget(config){config=config||{};config.toolbarConfig=ve.extendObject({shadow:true,actions:true,floatable:true},config.toolbarConfig);ve.init.mw.ArticleTarget.super.call(this,config);if(config.register!==false){ve.init.articleTarget=this;}this.saveDialog=null;this.saveDeferred=null;this.saveFields={};this.docToSave=null;this.originalDmDocPromise=null;this.originalHtml=null;this.toolbarSaveButton=null;this.pageExists=mw.config.get('wgRelevantArticleId',0)!==0;var enableVisualSectionEditing=mw.config.get('wgVisualEditorConfig').enableVisualSectionEditing;this.enableVisualSectionEditing=enableVisualSectionEditing===
true||enableVisualSectionEditing===this.constructor.static.trackingName;this.toolbarScrollOffset=mw.config.get('wgVisualEditorToolbarScrollOffset',0);this.currentUri=new mw.Uri(location.href);this.section=null;this.visibleSection=null;this.visibleSectionOffset=null;this.sectionTitle=null;this.editSummaryValue=null;this.initialEditSummary=null;this.initialCheckboxes={};this.viewUri=new mw.Uri(mw.util.getUrl(this.getPageName()));this.isViewPage=(mw.config.get('wgAction')==='view'&&this.currentUri.query.diff===undefined);this.copyrightWarning=null;this.checkboxFields=null;this.checkboxesByName=null;this.$saveAccessKeyElements=null;this.$editableContent=this.getEditableContent();this.requestedRevId=mw.config.get('wgRevisionId')||undefined;this.currentRevisionId=mw.config.get('wgCurRevisionId')||undefined;this.revid=this.requestedRevId||this.currentRevisionId;this.edited=false;this.restoring=!!this.requestedRevId&&this.requestedRevId!==this.currentRevisionId;this.pageDeletedWarning=false;
this.submitUrl=(new mw.Uri(mw.util.getUrl(this.getPageName()))).extend({action:'submit',veswitched:1});this.events={track:function(){},trackActivationStart:function(){},trackActivationComplete:function(){}};this.preparedCacheKeyPromise=null;this.clearState();this.$element.addClass('ve-init-mw-articleTarget');};OO.inheritClass(ve.init.mw.ArticleTarget,ve.init.mw.Target);ve.init.mw.ArticleTarget.static.name='article';ve.init.mw.ArticleTarget.static.trackingName='mwTarget';ve.init.mw.ArticleTarget.static.integrationType='page';ve.init.mw.ArticleTarget.static.platformType='other';ve.init.mw.ArticleTarget.static.documentCommands=ve.init.mw.ArticleTarget.super.static.documentCommands.concat(['showSave','showChanges','showPreview','showMinoredit','showWatchthis']);ve.init.mw.ArticleTarget.static.parseDocument=function(documentString,mode,section,onlySection){if(mode==='source'&&documentString){documentString+='\n';}return ve.init.mw.ArticleTarget.super.static.parseDocument.call(this,
documentString,mode,section,onlySection);};ve.init.mw.ArticleTarget.prototype.getEditableContent=function(){return $('#mw-content-text');};ve.init.mw.ArticleTarget.static.buildRedirectSub=function(){var $subMsg=mw.message('redirectpagesub').parseDom();return $('<span>').attr('id','redirectsub').append($subMsg);};ve.init.mw.ArticleTarget.static.buildRedirectMsg=function(title){var $link=$('<a>').attr({href:mw.Title.newFromText(title).getUrl(),title:mw.msg('visualeditor-redirect-description',title)}).text(title);ve.init.platform.linkCache.styleElement(title,$link);return $('<div>').addClass('redirectMsg').addClass('mw-content-'+mw.config.get('wgVisualEditor').pageLanguageDir).append($('<p>').text(mw.msg('redirectto')),$('<ul>').addClass('redirectText').append($('<li>').append($link)));};ve.init.mw.ArticleTarget.prototype.setDefaultMode=function(){var oldDefaultMode=this.defaultMode;ve.init.mw.ArticleTarget.super.prototype.setDefaultMode.apply(this,arguments);if(this.defaultMode!==
oldDefaultMode){this.updateTabs(true);if(mw.libs.ve.setEditorPreference){mw.libs.ve.setEditorPreference(this.defaultMode==='visual'?'visualeditor':'wikitext');}}};ve.init.mw.ArticleTarget.prototype.updateTabs=function(editing){var $tab;if(editing){if(this.section==='new'){$tab=$('#ca-addsection');}else if($('#ca-ve-edit').length){if(this.getDefaultMode()==='visual'){$tab=$('#ca-ve-edit');}else{$tab=$('#ca-edit');}}else{$tab=$('#ca-edit');}}else{$tab=$('#ca-view');}$('#p-views').find('li.selected').removeClass('selected');$('#ca-edit, #ca-ve-edit, #ca-addsection').not($tab).removeClass('selected');$tab.addClass('selected');};ve.init.mw.ArticleTarget.prototype.loadSuccess=function(response){var data=response?(response.visualeditor||response.visualeditoredit):null;if(!data||typeof data.content!=='string'){this.loadFail('ve-api',{errors:[{code:'ve-api',html:mw.message('api-clientside-error-invalidresponse').parse()}]});}else if(response.veMode&&response.veMode!==this.getDefaultMode()){this
.loadFail('ve-mode',{errors:[{code:'ve-mode',html:mw.message('visualeditor-loaderror-wrongmode',response.veMode,this.getDefaultMode()).parse()}]});}else{this.track('trace.parseResponse.enter');this.originalHtml=data.content;this.etag=data.etag;this.fromEditedState=!!data.fromEditedState||!!data.preloaded;this.switched=data.switched||'wteswitched'in new mw.Uri(location.href).query;var mode=this.getDefaultMode();var section=(mode==='source'||this.enableVisualSectionEditing)?this.section:null;this.doc=this.constructor.static.parseDocument(this.originalHtml,mode,section);this.originalDmDocPromise=null;this.initialSourceRange=data.initialSourceRange;this.recovered=data.recovered;if(!this.parseMetadata(response)){return;}this.track('trace.parseResponse.exit');this.documentReady(this.doc);}if(['edit','submit'].indexOf(mw.util.getParamValue('action'))!==-1){$('#firstHeading').text(mw.Title.newFromText(this.getPageName()).getPrefixedText());}};ve.init.mw.ArticleTarget.prototype.parseMetadata=
function(response){var data=response?(response.visualeditor||response.visualeditoredit):null;if(!data){this.loadFail('ve-api',{errors:[{code:'ve-api',html:mw.message('api-clientside-error-invalidresponse').parse()}]});return false;}this.remoteNotices=ve.getObjectValues(data.notices);this.protectedClasses=data.protectedClasses;this.baseTimeStamp=data.basetimestamp;this.startTimeStamp=data.starttimestamp;this.revid=data.oldid||undefined;this.preloaded=!!data.preloaded;this.copyrightWarning=data.copyrightWarning;this.checkboxesDef=data.checkboxesDef;this.checkboxesMessages=data.checkboxesMessages;mw.messages.set(data.checkboxesMessages);this.canEdit=data.canEdit;var docRevId;var aboutDoc=this.doc.documentElement&&this.doc.documentElement.getAttribute('about');if(aboutDoc){var docRevIdMatches=aboutDoc.match(/revision\/([0-9]*)$/);if(docRevIdMatches.length>=2){docRevId=parseInt(docRevIdMatches[1]);}}if(this.getDefaultMode()==='visual'&&!(this.switched&&this.fromEditedState)&&docRevId!==this
.revid){if(this.retriedRevIdConflict){this.loadFail('ve-api',{errors:[{code:'ve-api',html:mw.message('visualeditor-loaderror-revidconflict',String(docRevId),String(this.revid)).parse()}]});}else{this.retriedRevIdConflict=true;this.loading=null;this.requestedRevId=Math.max(docRevId||0,this.revid);this.load();}return false;}else{this.retriedRevIdConflict=false;}this.$saveDialogOverlay=$('<div>').addClass('oo-ui-window-overlay');var checkboxes=mw.libs.ve.targetLoader.createCheckboxFields(this.checkboxesDef,{$overlay:this.$saveDialogOverlay});this.checkboxFields=checkboxes.checkboxFields;this.checkboxesByName=checkboxes.checkboxesByName;this.checkboxFields.forEach(function(field){ve.targetLinksToNewWindow(field.$label[0]);});return true;};ve.init.mw.ArticleTarget.prototype.documentReady=function(){this.editNotices=this.remoteNotices.concat(this.localNoticeMessages.map(function(msgKey){return'<p>'+ve.init.platform.getParsedMessage(msgKey)+'</p>';}));this.loading=null;this.edited=this.
fromEditedState;ve.init.mw.ArticleTarget.super.prototype.documentReady.apply(this,arguments);};ve.init.mw.ArticleTarget.prototype.surfaceReady=function(){var accessKeyPrefix=$.fn.updateTooltipAccessKeys.getAccessKeyPrefix().replace(/-/g,'+'),accessKeyModifiers=new ve.ui.Trigger(accessKeyPrefix+'-').modifiers,surfaceModel=this.getSurface().getModel();ve.init.platform.linkCache.setAssumeExistence(false);surfaceModel.connect(this,{history:'updateToolbarSaveButtonState'});for(var name in ve.ui.triggerRegistry.registry){var triggers=ve.ui.triggerRegistry.registry[name];for(var i=0;i<triggers.length;i++){if(ve.compare(triggers[i].modifiers,accessKeyModifiers)){this.disableAccessKey(triggers[i].primary);}}}if(!this.canEdit){this.getSurface().setReadOnly(true);}else{this.initAutosave();setTimeout(function(){mw.libs.ve.targetSaver.preloadDeflate();},500);}ve.init.mw.ArticleTarget.super.prototype.surfaceReady.apply(this,arguments);mw.hook('ve.activationComplete').fire();};ve.init.mw.
ArticleTarget.prototype.afterSurfaceReady=function(){this.restoreEditSection();};ve.init.mw.ArticleTarget.prototype.storeDocState=function(html){var mode=this.getSurface().getMode();this.getSurface().getModel().storeDocState({request:{pageName:this.getPageName(),mode:mode,section:(mode==='source'||this.enableVisualSectionEditing)?this.section:null},response:{etag:this.etag,fromEditedState:this.fromEditedState,switched:this.switched,preloaded:this.preloaded,notices:this.remoteNotices,protectedClasses:this.protectedClasses,basetimestamp:this.baseTimeStamp,starttimestamp:this.startTimeStamp,oldid:this.revid,canEdit:this.canEdit,copyrightWarning:this.copyrightWarning,checkboxesDef:this.checkboxesDef,checkboxesMessages:this.checkboxesMessages}},html);};ve.init.mw.ArticleTarget.prototype.disableAccessKey=function(key){$('[accesskey='+key+']').each(function(){var $this=$(this);$this.attr('data-old-accesskey',$this.attr('accesskey')).removeAttr('accesskey');});};ve.init.mw.ArticleTarget.
prototype.restoreAccessKeys=function(){$('[data-old-accesskey]').each(function(){var $this=$(this);$this.attr('accesskey',$this.attr('data-old-accesskey')).removeAttr('data-old-accesskey');});};ve.init.mw.ArticleTarget.prototype.loadFail=function(){this.loading=null;this.emit('loadError');};ve.init.mw.ArticleTarget.prototype.replacePageContent=null;ve.init.mw.ArticleTarget.prototype.saveComplete=function(data){this.editSummaryValue=null;this.initialEditSummary=null;this.saveDeferred.resolve();this.emit('save',data);var target=this;if(!this.pageExists||this.restoring||!this.isViewPage){this.teardown().then(function(){var newUrlParams=!this.pageExists||this.restoring?(data.newrevid===undefined?{}:{venotify:target.restoring?'restored':'created'}):{};if(data.isRedirect){newUrlParams.redirect='no';}location.href=target.viewUri.extend(newUrlParams);});}else{if(mw.loader.getState('mediawiki.page.watch.ajax')==='ready'){var watch=require('mediawiki.page.watch.ajax');watch.updatePageWatchStatus
(data.watched,data.watchlistexpiry);}this.restoring=false;this.requestedRevId=undefined;if(data.newrevid!==undefined){mw.config.set({wgCurRevisionId:data.newrevid,wgRevisionId:data.newrevid});this.revid=data.newrevid;this.currentRevisionId=data.newrevid;}mw.config.set(data.jsconfigvars);mw.loader.load(data.modules);mw.config.set({wgIsRedirect:!!data.isRedirect});if(this.saveDialog){this.saveDialog.reset();}this.replacePageContent(data.content,data.categorieshtml,data.displayTitleHtml,data.lastModified,data.contentSub);this.tryTeardown(true);}};ve.init.mw.ArticleTarget.prototype.saveFail=function(doc,saveData,wasRetry,code,data){var saveErrorHandlerFactory=ve.init.mw.saveErrorHandlerFactory,handled=false,target=this;this.pageDeletedWarning=false;if(!data){this.saveErrorEmpty();handled=true;}if(!handled&&data.errors){for(var i=0;i<data.errors.length;i++){var error=data.errors[i];if(error.code==='badtoken'){this.saveErrorBadToken();handled=true;}else if(error.code==='assertanonfailed'||
error.code==='assertuserfailed'||error.code==='assertnameduserfailed'){this.refreshUser().then(function(username){target.saveErrorNewUser(username);},function(){target.saveErrorUnknown(data);});handled=true;}else if(error.code==='editconflict'){this.editConflict();handled=true;}else if(error.code==='pagedeleted'){this.saveErrorPageDeleted();handled=true;}else if(error.code==='hookaborted'){this.saveErrorHookAborted(data);handled=true;}else if(error.code==='readonly'){this.saveErrorReadOnly(data);handled=true;}}}if(!handled){for(var name in saveErrorHandlerFactory.registry){var handler=saveErrorHandlerFactory.lookup(name);if(handler.static.matchFunction(data)){handler.static.process(data,this);handled=true;}}}if(!handled){this.saveErrorUnknown(data);handled=true;}var errorCodes;if(data.errors){errorCodes=data.errors.map(function(err){return err.code;}).join(',');}else if(ve.getProp(data,'visualeditoredit','edit','captcha')){errorCodes='captcha';}else{errorCodes='http-'+((data.xhr&&data.
xhr.status)||0);}this.emit('saveError',errorCodes);};ve.init.mw.ArticleTarget.prototype.showSaveError=function(msg,allowReapply,warning){this.saveDeferred.reject([new OO.ui.Error(msg,{recoverable:allowReapply,warning:warning})]);};ve.init.mw.ArticleTarget.prototype.extractErrorMessages=function(data){var $errorMsgs=(new mw.Api()).getErrorMessage(data);$errorMsgs.toArray().forEach(ve.targetLinksToNewWindow);return $errorMsgs;};ve.init.mw.ArticleTarget.prototype.saveErrorEmpty=function(){this.showSaveError(ve.msg('visualeditor-saveerror',ve.msg('visualeditor-error-invalidresponse')),false);};ve.init.mw.ArticleTarget.prototype.saveErrorHookAborted=function(data){this.showSaveError(this.extractErrorMessages(data));};ve.init.mw.ArticleTarget.prototype.saveErrorNewUser=function(username){var $msg=$(document.createTextNode(mw.msg('visualeditor-savedialog-error-badtoken')+' ')).add(mw.message(username===null?'visualeditor-savedialog-identify-anon':'visualeditor-savedialog-identify-user',
username).parseDom());this.showSaveError($msg);};ve.init.mw.ArticleTarget.prototype.saveErrorBadToken=function(){this.showSaveError(mw.msg('visualeditor-savedialog-error-badtoken')+' '+mw.msg('visualeditor-savedialog-identify-trylogin'));};ve.init.mw.ArticleTarget.prototype.saveErrorUnknown=function(data){this.showSaveError(this.extractErrorMessages(data),false);};ve.init.mw.ArticleTarget.prototype.saveErrorPageDeleted=function(){this.pageDeletedWarning=true;this.showSaveError(mw.msg('visualeditor-recreate',mw.msg('ooui-dialog-process-continue')),true,true);};ve.init.mw.ArticleTarget.prototype.saveErrorReadOnly=function(data){this.showSaveError(this.extractErrorMessages(data),true,true);};ve.init.mw.ArticleTarget.prototype.editConflict=function(){this.saveDialog.popPending();this.saveDialog.swapPanel('conflict');};ve.init.mw.ArticleTarget.prototype.onSaveDialogReview=function(){var target=this;if(!this.saveDialog.hasDiff){this.emit('saveReview');this.saveDialog.pushPending();if(this.
pageExists){this.showChanges(this.getDocToSave());}else{this.serialize(this.getDocToSave()).then(function(data){target.onSaveDialogReviewComplete(data.content);});}}else{this.saveDialog.swapPanel('review');}};ve.init.mw.ArticleTarget.prototype.onSaveDialogPreview=function(){var api=this.getContentApi(),target=this;if(!this.saveDialog.$previewViewer.children().length){this.emit('savePreview');this.saveDialog.pushPending();var wikitext=this.getDocToSave();if(this.sectionTitle&&this.sectionTitle.getValue()){wikitext='== '+this.sectionTitle.getValue()+' ==\n\n'+wikitext;}api.post({action:'visualeditor',paction:'parsedoc',page:this.getPageName(),wikitext:wikitext,pst:true}).then(function(response){var baseDoc=target.getSurface().getModel().getDocument().getHtmlDocument();var doc=target.constructor.static.parseDocument(response.visualeditor.content,'visual');target.saveDialog.showPreview(doc,baseDoc);},function(errorCode,details){target.saveDialog.showPreview(target.extractErrorMessages(
details));}).always(function(){target.bindSaveDialogClearDiff();});}else{this.saveDialog.swapPanel('preview');}};ve.init.mw.ArticleTarget.prototype.bindSaveDialogClearDiff=function(){this.getSurface().getModel().getDocument().once('transact',this.saveDialog.clearDiff.bind(this.saveDialog));if(this.sectionTitle){this.sectionTitle.once('change',this.saveDialog.clearDiff.bind(this.saveDialog));}};ve.init.mw.ArticleTarget.prototype.onSaveDialogReviewComplete=function(wikitext){this.bindSaveDialogClearDiff();this.saveDialog.setDiffAndReview(ve.createDeferred().resolve($('<pre>').text(wikitext)).promise(),this.getVisualDiffGeneratorPromise(),this.getSurface().getModel().getDocument().getHtmlDocument());};ve.init.mw.ArticleTarget.prototype.getVisualDiffGeneratorPromise=function(){var target=this;return mw.loader.using('ext.visualEditor.diffLoader').then(function(){var mode=target.getSurface().getMode();if(!target.originalDmDocPromise){if(mode==='source'){target.originalDmDocPromise=mw.libs.ve
.diffLoader.fetchRevision(target.revid,target.getPageName());}else{if(!target.fromEditedState){var dmDoc=target.constructor.static.createModelFromDom(target.doc,'visual');var dmDocOrNode;if(target.section!==null&&target.enableVisualSectionEditing){dmDocOrNode=dmDoc.getNodesByType('section')[0];}else{dmDocOrNode=dmDoc;}target.originalDmDocPromise=ve.createDeferred().resolve(dmDocOrNode).promise();}else{target.originalDmDocPromise=mw.libs.ve.diffLoader.fetchRevision(target.revid,target.getPageName(),target.section);}}}if(mode==='source'){var newRevPromise=target.getContentApi().post({action:'visualeditor',paction:'parse',page:target.getPageName(),wikitext:target.getSurface().getDom(),section:target.section,stash:0,pst:true}).then(function(response){return mw.libs.ve.diffLoader.getModelFromResponse(response,null);});return mw.libs.ve.diffLoader.getVisualDiffGeneratorPromise(target.originalDmDocPromise,newRevPromise);}else{return target.originalDmDocPromise.then(function(originalDmDoc){
return function(){return new ve.dm.VisualDiff(originalDmDoc,target.getSurface().getModel().getAttachedRoot());};});}});};ve.init.mw.ArticleTarget.prototype.onSaveDialogResolveConflict=function(){var fields={wpSave:1},target=this;if(this.getSurface().getMode()==='source'&&this.section!==null){fields.section=this.section;}this.serialize(this.getDocToSave()).then(function(data){target.submitWithSaveFields(fields,data.content);});};ve.init.mw.ArticleTarget.prototype.onSaveDialogRetry=function(){if(this.pageDeletedWarning){this.recreating=true;this.pageExists=false;}};ve.init.mw.ArticleTarget.prototype.onSaveDialogClose=function(){this.emit('saveWorkflowEnd');};ve.init.mw.ArticleTarget.prototype.load=function(dataPromise){if(this.loading){return this.loading;}this.events.trackActivationStart(mw.libs.ve.activationStart);mw.libs.ve.activationStart=null;dataPromise=dataPromise||mw.libs.ve.targetLoader.requestPageData(this.getDefaultMode(),this.getPageName(),{sessionStore:true,section:this.
section,oldId:this.requestedRevId,targetName:this.constructor.static.trackingName});this.loading=dataPromise;dataPromise.done(this.loadSuccess.bind(this)).fail(this.loadFail.bind(this));return dataPromise;};ve.init.mw.ArticleTarget.prototype.clearState=function(){this.restoreAccessKeys();this.clearPreparedCacheKey();this.loading=null;this.saving=null;this.clearDiff();this.serializing=false;this.submitting=false;this.baseTimeStamp=null;this.startTimeStamp=null;this.checkboxes=null;this.initialSourceRange=null;this.doc=null;this.originalDmDocPromise=null;this.originalHtml=null;this.toolbarSaveButton=null;this.section=null;this.visibleSection=null;this.visibleSectionOffset=null;this.editNotices=[];this.remoteNotices=[];this.localNoticeMessages=[];this.recovered=false;this.teardownPromise=null;};ve.init.mw.ArticleTarget.prototype.editSource=function(){var modified=this.fromEditedState||this.getSurface().getModel().hasBeenModified();this.switchToWikitextEditor(modified);};ve.init.mw.
ArticleTarget.prototype.getDocToSave=function(){if(!this.docToSave){this.docToSave=this.createDocToSave();var surface=this.getSurface();surface.getModel().getDocument().once('transact',this.clearDocToSave.bind(this));surface.once('destroy',this.clearDocToSave.bind(this));}return this.docToSave;};ve.init.mw.ArticleTarget.prototype.createDocToSave=function(){return this.getSurface().getDom();};ve.init.mw.ArticleTarget.prototype.clearDocToSave=function(){this.docToSave=null;this.clearPreparedCacheKey();};ve.init.mw.ArticleTarget.prototype.prepareCacheKey=function(doc){var aborted=false,start=ve.now(),target=this;if(this.getSurface().getMode()==='source'){return;}if(this.preparedCacheKeyPromise&&this.preparedCacheKeyPromise.doc===doc){return;}this.clearPreparedCacheKey();var xhr;this.preparedCacheKeyPromise=mw.libs.ve.targetSaver.deflateDoc(doc,this.doc).then(function(deflatedHtml){if(aborted){return ve.createDeferred().reject();}xhr=target.getContentApi().postWithToken('csrf',{action:
'visualeditoredit',paction:'serializeforcache',html:deflatedHtml,page:target.getPageName(),oldid:target.revid,etag:target.etag},{contentType:'multipart/form-data'});return xhr.then(function(response){var trackData={duration:ve.now()-start};if(response.visualeditoredit&&typeof response.visualeditoredit.cachekey==='string'){target.events.track('performance.system.serializeforcache',trackData);return{cacheKey:response.visualeditoredit.cachekey,html:deflatedHtml};}else{target.events.track('performance.system.serializeforcache.nocachekey',trackData);return ve.createDeferred().reject();}},function(){target.events.track('performance.system.serializeforcache.fail',{duration:ve.now()-start});return ve.createDeferred().reject();});}).promise({abort:function(){if(xhr){xhr.abort();}aborted=true;},doc:doc});};ve.init.mw.ArticleTarget.prototype.getPreparedCacheKey=function(doc){if(this.preparedCacheKeyPromise&&this.preparedCacheKeyPromise.doc===doc){return this.preparedCacheKeyPromise;}return ve.
createDeferred().reject().promise();};ve.init.mw.ArticleTarget.prototype.clearPreparedCacheKey=function(){if(this.preparedCacheKeyPromise){this.preparedCacheKeyPromise.abort();this.preparedCacheKeyPromise=null;}};ve.init.mw.ArticleTarget.prototype.tryWithPreparedCacheKey=function(doc,extraData,eventName){var target=this;if(this.getSurface().getMode()==='source'){var data=ve.copy(extraData);if(this.section!==null){data.section=this.section;}if(this.sectionTitle){data.sectiontitle=this.sectionTitle.getValue();data.summary=undefined;}return mw.libs.ve.targetSaver.postWikitext(doc,data,{api:this.getContentApi()});}var htmlOrCacheKeyPromise=this.getPreparedCacheKey(doc).then(null,function(){return mw.libs.ve.targetSaver.deflateDoc(doc,target.doc).then(function(html){return{html:html};});});return htmlOrCacheKeyPromise.then(function(htmlOrCacheKey){return mw.libs.ve.targetSaver.postHtml(htmlOrCacheKey.html,htmlOrCacheKey.cacheKey,extraData,{onCacheKeyFail:target.clearPreparedCacheKey.bind(
target),api:target.getContentApi(),track:target.events.track.bind(target.events),eventName:eventName,now:ve.now});});};ve.init.mw.ArticleTarget.prototype.onSaveDialogSave=function(saveDeferred){if(this.deactivating){return;}var saveOptions=this.getSaveOptions();if(+mw.user.options.get('forceeditsummary')&&(saveOptions.summary===''||saveOptions.summary===this.initialEditSummary)&&!this.saveDialog.messages.missingsummary){this.saveDialog.showMessage('missingsummary',new OO.ui.HtmlSnippet(ve.init.platform.getParsedMessage('missingsummary')));this.saveDialog.popPending();}else{this.emit('saveInitiated');this.startSave(saveOptions);this.saveDeferred=saveDeferred;}};ve.init.mw.ArticleTarget.prototype.startSave=function(saveOptions){this.save(this.getDocToSave(),saveOptions);};ve.init.mw.ArticleTarget.prototype.getSaveFields=function(){var fields={};if(this.section==='new'){fields.wpSummary=this.sectionTitle?this.sectionTitle.getValue():'';}else{fields.wpSummary=this.saveDialog?this.
saveDialog.editSummaryInput.getValue():(this.editSummaryValue||this.initialEditSummary);}var name;for(name in this.saveFields){fields[name]=this.saveFields[name]();}if(this.recreating){fields.wpRecreate=true;}for(name in this.checkboxesByName){if(!this.checkboxesByName[name].isSelected||this.checkboxesByName[name].isSelected()){fields[name]=this.checkboxesByName[name].getValue();}}return fields;};ve.init.mw.ArticleTarget.prototype.submitWithSaveFields=function(fields,wikitext){return this.submit(wikitext,ve.extendObject(this.getSaveFields(),fields));};ve.init.mw.ArticleTarget.prototype.getSaveOptions=function(){var options=this.getSaveFields(),fieldMap={wpSummary:'summary',wpMinoredit:'minor',wpWatchthis:'watchlist',wpCaptchaId:'captchaid',wpCaptchaWord:'captchaword'};for(var key in fieldMap){if(options[key]!==undefined){options[fieldMap[key]]=options[key];delete options[key];}}options.watchlist='watchlist'in options?'watch':'unwatch';return options;};ve.init.mw.ArticleTarget.prototype
.save=function(doc,options,isRetry){var target=this;if(this.saving){return this.saving;}var data=ve.extendObject({},options,{page:this.getPageName(),oldid:this.revid,basetimestamp:this.baseTimeStamp,starttimestamp:this.startTimeStamp,etag:this.etag,assert:mw.user.isAnon()?'anon':'user',assertuser:mw.user.getName()||undefined});if(mw.config.get('wgVisualEditorConfig').useChangeTagging&&!data.vetags){if(this.getSurface().getMode()==='source'){data.vetags='visualeditor-wikitext';}else{data.vetags='visualeditor';}}var promise=this.saving=this.tryWithPreparedCacheKey(doc,data,'save').done(this.saveComplete.bind(this)).fail(this.saveFail.bind(this,doc,data,!!isRetry)).always(function(){target.saving=null;});return promise;};ve.init.mw.ArticleTarget.prototype.showChanges=function(doc){var target=this;this.getSurface().getModel().getDocument().once('transact',function(){target.clearDiff();});this.saveDialog.setDiffAndReview(this.getWikitextDiffPromise(doc),this.getVisualDiffGeneratorPromise(),
this.getSurface().getModel().getDocument().getHtmlDocument());};ve.init.mw.ArticleTarget.prototype.clearDiff=function(){if(this.saveDialog){this.saveDialog.clearDiff();}this.wikitextDiffPromise=null;};ve.init.mw.ArticleTarget.prototype.getWikitextDiffPromise=function(doc){var target=this;if(!this.wikitextDiffPromise){this.wikitextDiffPromise=this.tryWithPreparedCacheKey(doc,{paction:'diff',page:this.getPageName(),oldid:this.revid,etag:this.etag},'diff').then(function(data){if(!data.diff){target.emit('noChanges');}return data.diff;});this.wikitextDiffPromise.done(this.emit.bind(this,'showChanges')).fail(this.emit.bind(this,'showChangesError'));}return this.wikitextDiffPromise;};ve.init.mw.ArticleTarget.prototype.submit=function(wikitext,fields){if(this.submitting){return false;}this.clearDocState();this.submitting=true;var $form=$('<form>').attr({method:'post',enctype:'multipart/form-data'}).addClass('oo-ui-element-hidden');var params=ve.extendObject({format:'text/x-wiki',model:
'wikitext',oldid:this.requestedRevId,wpStarttime:this.startTimeStamp,wpEdittime:this.baseTimeStamp,wpTextbox1:wikitext,wpEditToken:mw.user.tokens.get('csrfToken'),wpUnicodeCheck:'ℳ𝒲♥𝓊𝓃𝒾𝒸ℴ𝒹ℯ',wpUltimateParam:true},fields);for(var key in params){$form.append($('<input>').attr({type:'hidden',name:key,value:params[key]}));}$form.attr('action',this.submitUrl).appendTo('body').trigger('submit');return true;};ve.init.mw.ArticleTarget.prototype.serialize=function(doc,callback){var target=this;if(this.serializing){return this.serializing;}var promise=this.serializing=this.tryWithPreparedCacheKey(doc,{paction:'serialize',page:this.getPageName(),oldid:this.revid,etag:this.etag},'serialize').done(this.emit.bind(this,'serializeComplete')).fail(this.emit.bind(this,'serializeError')).always(function(){target.serializing=null;});if(callback){OO.ui.warnDeprecation('Passing a callback to ve.init.mw.ArticleTarget#serialize is deprecated. Use the returned promise instead.');
promise.then(function(data){callback.call(target,data.content);});}return promise;};ve.init.mw.ArticleTarget.prototype.getEditNotices=function(){return this.editNotices;};ve.init.mw.ArticleTarget.prototype.track=function(name){var mode=this.surface?this.surface.getMode():this.getDefaultMode();ve.track(name,{mode:mode});};ve.init.mw.ArticleTarget.prototype.createSurface=function(dmDoc,config){var sections=dmDoc.getNodesByType('section');var attachedRoot;if(sections.length&&sections.length===1){attachedRoot=sections[0];if(!attachedRoot.isSurfaceable()){throw new Error('Not a surfaceable node');}}var surface=ve.init.mw.ArticleTarget.super.prototype.createSurface.call(this,dmDoc,ve.extendObject({attachedRoot:attachedRoot},config));return surface;};ve.init.mw.ArticleTarget.prototype.getSurfaceClasses=function(){var classes=ve.init.mw.ArticleTarget.super.prototype.getSurfaceClasses.call(this);return classes.concat(['mw-body-content']);};ve.init.mw.ArticleTarget.prototype.getSurfaceConfig=
function(config){return ve.init.mw.ArticleTarget.super.prototype.getSurfaceConfig.call(this,ve.extendObject({nullSelectionOnBlur:this.section==='new',classes:this.getSurfaceClasses().concat(this.protectedClasses).filter(function(c){return c;})},config));};ve.init.mw.ArticleTarget.prototype.teardown=function(){var target=this;if(!this.teardownPromise){var surface=this.getSurface();if(this.$saveAccessKeyElements){this.$saveAccessKeyElements.attr('accesskey',ve.msg('accesskey-save'));this.$saveAccessKeyElements=null;}if(surface){surface.getModel().disconnect(this);}var saveDialogPromise=ve.createDeferred().resolve().promise();if(this.saveDialog){if(this.saveDialog.isOpened()){saveDialogPromise=this.saveDialog.close().closed;}this.saveDialog=null;}this.teardownPromise=ve.init.mw.ArticleTarget.super.prototype.teardown.call(target).then(function(){return saveDialogPromise.then(function(){mw.hook('ve.deactivationComplete').fire(target.edited);});});}return this.teardownPromise;};ve.init.mw.
ArticleTarget.prototype.tryTeardown=function(noPrompt,trackMechanism){var target=this;if(!noPrompt&&this.edited&&mw.user.options.get('useeditwarning')){return this.getSurface().dialogs.openWindow('abandonedit').closed.then(function(data){if(data&&data.action==='discard'){return target.teardown(trackMechanism);}return ve.createDeferred().reject().promise();});}else{return this.teardown(trackMechanism);}};ve.init.mw.ArticleTarget.prototype.setupToolbar=function(){ve.init.mw.ArticleTarget.super.prototype.setupToolbar.apply(this,arguments);this.setupToolbarSaveButton();this.updateToolbarSaveButtonState();if(this.saveDialog){this.editSummaryValue=this.saveDialog.editSummaryInput.getValue();this.saveDialog.disconnect(this);this.saveDialog=null;}};ve.init.mw.ArticleTarget.prototype.getSaveButtonLabel=function(startProcess){var suffix=startProcess?'-start':'';if(mw.config.get('wgEditSubmitButtonLabelPublish')){return OO.ui.deferMsg((!this.pageExists?'publishpage':'publishchanges')+suffix);}
return OO.ui.deferMsg((!this.pageExists?'savearticle':'savechanges')+suffix);};ve.init.mw.ArticleTarget.prototype.setupToolbarSaveButton=null;ve.init.mw.ArticleTarget.prototype.isSaveable=function(){var surface=this.getSurface();if(!surface){return false;}this.edited=this.fromEditedState||surface.getModel().hasBeenModified()||(!!this.sectionTitle&&this.sectionTitle.getValue()!=='');return this.edited||this.restoring;};ve.init.mw.ArticleTarget.prototype.updateToolbarSaveButtonState=function(){this.toolbarSaveButton.onUpdateState();};ve.init.mw.ArticleTarget.prototype.showSaveDialog=function(action,checkboxName){var firstLoad=false,target=this;if(!this.isSaveable()||this.saveDialogIsOpening){return;}var currentWindow=this.getSurface().getDialogs().getCurrentWindow();if(currentWindow&&currentWindow.constructor.static.name==='mwSave'&&(action==='save'||action===null)){currentWindow.executeAction('save');return;}this.saveDialogIsOpening=true;this.emit('saveWorkflowBegin');this.
prepareCacheKey(this.getDocToSave());this.getSurface().getDialogs().getWindow('mwSave').done(function(win){var windowAction=ve.ui.actionFactory.create('window',target.getSurface());if(!target.saveDialog){target.saveDialog=win;firstLoad=true;target.saveDialog.connect(target,{save:'onSaveDialogSave',review:'onSaveDialogReview',preview:'onSaveDialogPreview',resolve:'onSaveDialogResolveConflict',retry:'onSaveDialogRetry',close:'onSaveDialogClose'});target.saveDialog.$element.append(target.$saveDialogOverlay);}var data=target.getSaveDialogOpeningData();if((action==='review'&&!data.canReview)||(action==='preview'&&!data.canPreview)){target.saveDialogIsOpening=false;return;}if(firstLoad){for(var name in target.checkboxesByName){if(target.initialCheckboxes[name]!==undefined){target.checkboxesByName[name].setSelected(target.initialCheckboxes[name]);}}}var checkbox;if(checkboxName&&(checkbox=target.checkboxesByName[checkboxName])){var isSelected=!checkbox.isSelected();setTimeout(function(){
checkbox.setSelected(isSelected);});}if(action==='review'||action==='preview'){data.initialPanel=action;}var openPromise=windowAction.open('mwSave',data,action);if(openPromise){openPromise.always(function(){target.saveDialogIsOpening=false;});}});};ve.init.mw.ArticleTarget.prototype.getSaveDialogOpeningData=function(){var mode=this.getSurface().getMode();return{canPreview:mode==='source',canReview:!(mode==='source'&&this.section==='new'),sectionTitle:this.sectionTitle&&this.sectionTitle.getValue(),saveButtonLabel:this.getSaveButtonLabel(),copyrightWarning:this.copyrightWarning,checkboxFields:this.checkboxFields,checkboxesByName:this.checkboxesByName};};ve.init.mw.ArticleTarget.prototype.restoreEditSection=function(){var section=this.section!==null?this.section:this.visibleSection;var surface=this.getSurface();var mode=surface.getMode();if(mode==='source'||(this.enableVisualSectionEditing&&this.section!==null)){this.$scrollContainer.scrollTop(0);}if(section===null||section==='new'||
section==='0'||section==='T-0'){return;}var setExactScrollOffset=this.section===null&&this.visibleSection!==null&&this.visibleSectionOffset!==null,goToStartOfHeading=this.section!==null&&!this.enableVisualSectionEditing,setEditSummary=this.section!==null;var headingText;if(mode==='visual'){var dmDoc=surface.getModel().getDocument();var headingModel;dmDoc.getNodesByType('mwHeading').some(function(heading){var domElements=heading.getOriginalDomElements(dmDoc.getStore());if(domElements&&domElements[0].nodeType===Node.ELEMENT_NODE&&domElements[0].getAttribute('data-mw-section-id')===section){headingModel=heading;return true;}return false;});if(headingModel){var headingView=surface.getView().getDocument().getDocumentNode().getNodeFromOffset(headingModel.getRange().start);if(setEditSummary&&new mw.Uri().query.summary===undefined){headingText=headingView.$element.text();}if(setExactScrollOffset){this.scrollToHeading(headingView,this.visibleSectionOffset);}else if(goToStartOfHeading){this.
goToHeading(headingView);}}}else if(mode==='source'&&setEditSummary){headingText=surface.getModel().getDocument().data.getText(false,surface.getModel().getDocument().getDocumentNode().children[0].getRange()).replace(/^\s*=+\s*(.*?)\s*=+\s*$/,'$1').replace(/\[\[:?([^[|]+)\|([^[]+)\]\]/g,'$2').replace(/\[\[:?([^[]+)\|?\]\]/g,'$1').replace(new RegExp('\\[(?:'+ve.init.platform.getUnanchoredExternalLinkUrlProtocolsRegExp().source+')([^ ]+?) ([^\\[]+)\\]','ig'),'$3').replace(/<[^>]+?>/g,'');}if(headingText){this.initialEditSummary='/* '+ve.graphemeSafeSubstring(headingText,0,244)+' */ ';}};ve.init.mw.ArticleTarget.prototype.goToHeading=function(headingNode){var offsetNode=headingNode,surface=this.getSurface(),surfaceView=surface.getView(),lastHeadingLevel=-1;var nextNode;while(offsetNode instanceof ve.ce.HeadingNode&&offsetNode.getModel().getAttribute('level')>lastHeadingLevel){lastHeadingLevel=offsetNode.getModel().getAttribute('level');nextNode=offsetNode.parent.children[offsetNode.parent.
children.indexOf(offsetNode)+1];if(!nextNode){break;}offsetNode=nextNode;}var startOffset=offsetNode.getModel().getOffset();function setSelection(){surfaceView.selectRelativeSelectableContentOffset(startOffset,1);}if(surfaceView.isFocused()){setSelection();$(OO.ui.Element.static.getClosestScrollableContainer(surfaceView.$element[0])).stop(true);}else{surfaceView.once('focus',setSelection);}this.scrollToHeading(headingNode);};ve.init.mw.ArticleTarget.prototype.scrollToHeading=function(headingNode,headingOffset){this.$scrollContainer.scrollTop(headingNode.$element.offset().top-parseInt(headingNode.$element.css('margin-top'))-(this.getSurface().padding.top+(headingOffset||0)));};ve.init.mw.ArticleTarget.prototype.getSectionFragmentFromPage=function(){var $sections=this.$editableContent.find('.mw-editsection');var section;if(this.section==='new'){section=$sections.length;}else{section=this.section;}if(section>0){var $section=$sections.eq(section-1).parent().find('.mw-headline');if($section
.length&&$section.attr('id')){return $section.attr('id')||'';}}return'';};ve.init.mw.ArticleTarget.prototype.switchToWikitextEditor=function(modified){var target=this;if(modified){this.section=null;}if(this.isModeAvailable('source')){var dataPromise;if(!modified){dataPromise=mw.libs.ve.targetLoader.requestPageData('source',this.getPageName(),{sessionStore:true,section:this.section,oldId:this.requestedRevId,targetName:this.constructor.static.trackingName}).then(function(response){return response;},function(){return target.switchToFallbackWikitextEditor(modified);});}else{dataPromise=this.getWikitextDataPromiseForDoc(modified);}this.reloadSurface('source',dataPromise);}else{this.switchToFallbackWikitextEditor(modified);}};ve.init.mw.ArticleTarget.prototype.getWikitextDataPromiseForDoc=function(modified){var target=this;return this.serialize(this.getDocToSave()).then(function(data){data.etag=target.etag;data.fromEditedState=modified;data.notices=target.remoteNotices;data.protectedClasses=
target.protectedClasses;data.basetimestamp=target.baseTimeStamp;data.starttimestamp=target.startTimeStamp;data.oldid=target.revid;data.canEdit=target.canEdit;data.checkboxesDef=target.checkboxesDef;return{visualeditoredit:data};});};ve.init.mw.ArticleTarget.prototype.switchToFallbackWikitextEditor=function(){return ve.createDeferred().resolve().promise();};ve.init.mw.ArticleTarget.prototype.switchToVisualEditor=function(){var config=mw.config.get('wgVisualEditorConfig'),canSwitch=config.fullRestbaseUrl||config.allowLossySwitching,target=this;if(!this.edited){this.reloadSurface('visual');return;}if(!canSwitch){var windowManager=new OO.ui.WindowManager();var switchWindow=new mw.libs.ve.SwitchConfirmDialog();$(document.body).append(windowManager.$element);windowManager.addWindows([switchWindow]);windowManager.openWindow(switchWindow,{mode:'simple'}).closed.then(function(data){if(data&&data.action==='discard'){target.section=null;target.reloadSurface('visual');}windowManager.destroy();});}
else{var dataPromise=mw.libs.ve.targetLoader.requestParsoidData(this.getPageName(),{oldId:this.revid,targetName:this.constructor.static.trackingName,modified:this.edited,wikitext:this.getDocToSave(),section:this.section});this.reloadSurface('visual',dataPromise);}};ve.init.mw.ArticleTarget.prototype.switchToWikitextSection=function(section,noPrompt){var target=this;if(section===this.section){return;}var promise;if(!noPrompt&&this.edited&&mw.user.options.get('useeditwarning')){promise=this.getSurface().dialogs.openWindow('abandonedit').closed.then(function(data){return data&&data.action==='discard';});}else{promise=ve.createDeferred().resolve(true).promise();}promise.then(function(confirmed){if(confirmed){if(target.saveDialog){target.saveDialog.reset();}target.initialEditSummary=null;target.section=section;target.reloadSurface('source');target.updateTabs(true);}});};ve.init.mw.ArticleTarget.prototype.reloadSurface=function(newMode,dataPromise){this.setDefaultMode(newMode);this.clearDiff
();var promise=this.load(dataPromise);this.getSurface().createProgress(promise,ve.msg(newMode==='source'?'visualeditor-mweditmodesource-progress':'visualeditor-mweditmodeve-progress'),true);};ve.init.mw.ArticleTarget.prototype.updateRedirectInterface=function($sub,$msg){var target=this;var $currentSub=$('#redirectsub');if($currentSub.length){if($sub.length){$currentSub.replaceWith($sub);}else{$currentSub.prev().filter('br').remove();$currentSub.remove();}}else{var $subtitle=$('#contentSub');if($sub.length){if($subtitle.children().length){$subtitle.append($('<br>'));}$subtitle.append($sub);}}if($msg.length){$msg.addClass('ve-redirect-header').on('click',function(e){var windowAction=ve.ui.actionFactory.create('window',target.getSurface());windowAction.open('meta',{page:'settings'});e.preventDefault();});}var $currentMsg=$('.ve-redirect-header');if($currentMsg.length){$currentMsg.replaceWith($msg);}else{$('#mw-content-text').before($msg);}};ve.init.mw.ArticleTarget.prototype.
setFakeRedirectInterface=function(title){this.updateRedirectInterface(title?this.constructor.static.buildRedirectSub():$(),title?this.constructor.static.buildRedirectMsg(title):$());};ve.init.mw.ArticleTarget.prototype.setRealRedirectInterface=function(){this.updateRedirectInterface(mw.config.get('wgIsRedirect')?this.constructor.static.buildRedirectSub():$(),$());};ve.init.mw.ArticleTarget.prototype.renderCategories=function(categoryItems){var promises=[],categories={hidden:{},normal:{}};categoryItems.forEach(function(categoryItem,index){var attributes=ve.copy(ve.getProp(categoryItem,'element','attributes'));attributes.index=index;promises.push(ve.init.platform.linkCache.get(attributes.category).done(function(result){var group=result.hidden?categories.hidden:categories.normal;if(!group[attributes.category]||group[attributes.category].index>attributes.index){group[attributes.category]=attributes;}}));});return ve.promiseAll(promises).then(function(){var $output=$('<div>').addClass(
'catlinks');function renderPageLink(page){var title=mw.Title.newFromText(page),$link=$('<a>').attr('rel','mw:WikiLink').attr('href',title.getUrl()).text(title.getMainText());ve.init.platform.linkCache.styleElement(title.getPrefixedText(),$link,false);return $link;}function renderPageLinks(pages){var i,$list=$('<ul>');for(i=0;i<pages.length;i++){var $link=renderPageLink(pages[i]);$list.append($('<li>').append($link));}return $list;}function categorySort(group,a,b){return group[a].index-group[b].index;}var categoriesNormal=Object.keys(categories.normal);if(categoriesNormal.length){categoriesNormal.sort(categorySort.bind(null,categories.normal));var $normal=$('<div>').addClass('mw-normal-catlinks');var $pageLink=renderPageLink(ve.msg('pagecategorieslink')).text(ve.msg('pagecategories',categoriesNormal.length));var $pageLinks=renderPageLinks(categoriesNormal);$normal.append($pageLink,$(document.createTextNode(ve.msg('colon-separator'))),$pageLinks);$output.append($normal);}var
categoriesHidden=Object.keys(categories.hidden);if(categoriesHidden.length){categoriesHidden.sort(categorySort.bind(null,categories.hidden));var $hidden=$('<div>').addClass('mw-hidden-catlinks');if(mw.user.options.get('showhiddencats')){$hidden.addClass('mw-hidden-cats-user-shown');}else if(mw.config.get('wgNamespaceIds').category===mw.config.get('wgNamespaceNumber')){$hidden.addClass('mw-hidden-cats-ns-shown');}else{$hidden.addClass('mw-hidden-cats-hidden');}var $hiddenPageLinks=renderPageLinks(categoriesHidden);$hidden.append($(document.createTextNode(ve.msg('hidden-categories',categoriesHidden.length))),$(document.createTextNode(ve.msg('colon-separator'))),$hiddenPageLinks);$output.append($hidden);}return $output;});};ve.ui.windowFactory.register(mw.widgets.AbandonEditDialog);ve.init.mw.ArticleTargetEvents=function VeInitMwArticleTargetEvents(target){this.target=target;this.timings={saveRetries:0};this.target.connect(this,{saveWorkflowBegin:'onSaveWorkflowBegin',saveWorkflowEnd:
'onSaveWorkflowEnd',saveInitiated:'onSaveInitiated',save:'onSaveComplete',saveReview:'onSaveReview',saveError:'trackSaveError',surfaceReady:'onSurfaceReady',showChanges:'onShowChanges',showChangesError:'onShowChangesError',noChanges:'onNoChanges',serializeComplete:'onSerializeComplete',serializeError:'onSerializeError'});};ve.init.mw.ArticleTargetEvents.prototype.track=function(topic,data){ve.track(topic,ve.extendObject({mode:this.target.surface?this.target.surface.getMode():this.target.getDefaultMode()},data));};ve.init.mw.ArticleTargetEvents.prototype.trackTiming=function(topic,data){data.targetName=this.target.constructor.static.trackingName;this.track('mwtiming.'+topic,data);if(topic.indexOf('performance.system.serializeforcache')===0){this.timings.serializeForCache=data.duration;}};ve.init.mw.ArticleTargetEvents.prototype.onFirstTransaction=function(){this.track('mwedit.firstChange');this.trackTiming('behavior.firstTransaction',{duration:ve.now()-this.timings.surfaceReady,mode:
this.target.surface.getMode()});};ve.init.mw.ArticleTargetEvents.prototype.onSaveWorkflowBegin=function(){this.timings.saveWorkflowBegin=ve.now();this.trackTiming('behavior.lastTransactionTillSaveDialogOpen',{duration:this.timings.saveWorkflowBegin-this.timings.lastTransaction});this.track('mwedit.saveIntent');};ve.init.mw.ArticleTargetEvents.prototype.onSaveWorkflowEnd=function(){this.trackTiming('behavior.saveDialogClose',{duration:ve.now()-this.timings.saveWorkflowBegin});this.timings.saveWorkflowBegin=null;};ve.init.mw.ArticleTargetEvents.prototype.onSaveInitiated=function(){this.timings.saveInitiated=ve.now();this.timings.saveRetries++;this.trackTiming('behavior.saveDialogOpenTillSave',{duration:this.timings.saveInitiated-this.timings.saveWorkflowBegin});this.track('mwedit.saveAttempt');};ve.init.mw.ArticleTargetEvents.prototype.onSaveComplete=function(data){this.trackTiming('performance.user.saveComplete',{duration:ve.now()-this.timings.saveInitiated});this.timings.saveRetries=0;
this.track('mwedit.saveSuccess',{timing:ve.now()-this.timings.saveInitiated+(this.timings.serializeForCache||0),revision_id:data.newrevid});};ve.init.mw.ArticleTargetEvents.prototype.trackSaveError=function(code){var typeMap={badtoken:'userBadToken',assertanonfailed:'userNewUser',assertuserfailed:'userNewUser',assertnameduserfailed:'userNewUser','abusefilter-disallowed':'extensionAbuseFilter','abusefilter-warning':'extensionAbuseFilter',captcha:'extensionCaptcha',spamblacklist:'extensionSpamBlacklist','titleblacklist-forbidden':'extensionTitleBlacklist',pagedeleted:'editPageDeleted',editconflict:'editConflict'},specialTypes=['editconflict'];var key='performance.user.saveError';if(specialTypes.indexOf(code)!==-1){key+='.'+code;}this.trackTiming(key,{duration:ve.now()-this.timings.saveInitiated,retries:this.timings.saveRetries,type:code});var data={message:code,type:typeMap[code]||'responseUnknown',timing:ve.now()-this.timings.saveInitiated+(this.timings.serializeForCache||0)};this.track
('mwedit.saveFailure',data);};ve.init.mw.ArticleTargetEvents.prototype.trackActivationStart=function(startTime){this.timings.activationStart=startTime||ve.now();};ve.init.mw.ArticleTargetEvents.prototype.trackActivationComplete=function(){this.trackTiming('performance.system.activation',{duration:ve.now()-this.timings.activationStart});};ve.init.mw.ArticleTargetEvents.prototype.recordLastTransactionTime=function(){this.timings.lastTransaction=ve.now();};ve.init.mw.ArticleTargetEvents.prototype.onSaveReview=function(){this.timings.saveReview=ve.now();this.trackTiming('behavior.saveDialogOpenTillReview',{duration:this.timings.saveReview-this.timings.saveWorkflowBegin});};ve.init.mw.ArticleTargetEvents.prototype.onSurfaceReady=function(){this.timings.surfaceReady=ve.now();this.target.surface.getModel().getDocument().connect(this,{transact:'recordLastTransactionTime'}).once('transact',this.onFirstTransaction.bind(this));};ve.init.mw.ArticleTargetEvents.prototype.onShowChanges=function(){
this.trackTiming('performance.user.reviewComplete',{duration:ve.now()-this.timings.saveReview});};ve.init.mw.ArticleTargetEvents.prototype.onShowChangesError=function(){this.trackTiming('performance.user.reviewError',{duration:ve.now()-this.timings.saveReview});};ve.init.mw.ArticleTargetEvents.prototype.onNoChanges=function(){this.trackTiming('performance.user.reviewComplete',{duration:ve.now()-this.timings.saveReview});};ve.init.mw.ArticleTargetEvents.prototype.onSerializeComplete=function(){this.trackTiming('performance.user.reviewComplete',{duration:ve.now()-this.timings.saveReview});};ve.init.mw.ArticleTargetEvents.prototype.onSerializeError=function(){if(this.timings.saveWorkflowBegin){this.trackTiming('performance.user.reviewError',{duration:ve.now()-this.timings.saveReview});}};ve.ui.MWEditModeTool=function VeUiMWEditModeTool(){};OO.initClass(ve.ui.MWEditModeTool);ve.ui.MWEditModeTool.prototype.getMode=function(){if(!this.toolbar.getSurface()){return'source';}return this.toolbar
.getSurface().getMode();};ve.ui.MWEditModeTool.prototype.isModeAvailable=function(mode){return mode==='source'||this.toolbar.getTarget().isModeAvailable(mode);};ve.ui.MWEditModeSourceTool=function VeUiMWEditModeSourceTool(){ve.ui.MWEditModeSourceTool.super.apply(this,arguments);ve.ui.MWEditModeTool.call(this);};OO.inheritClass(ve.ui.MWEditModeSourceTool,mw.libs.ve.MWEditModeSourceTool);OO.mixinClass(ve.ui.MWEditModeSourceTool,ve.ui.MWEditModeTool);ve.ui.MWEditModeSourceTool.prototype.switch=function(){this.toolbar.getTarget().editSource();};ve.ui.toolFactory.register(ve.ui.MWEditModeSourceTool);ve.ui.MWEditModeVisualTool=function VeUiMWEditModeVisualTool(){ve.ui.MWEditModeVisualTool.super.apply(this,arguments);ve.ui.MWEditModeTool.call(this);};OO.inheritClass(ve.ui.MWEditModeVisualTool,mw.libs.ve.MWEditModeVisualTool);OO.mixinClass(ve.ui.MWEditModeVisualTool,ve.ui.MWEditModeTool);ve.ui.MWEditModeVisualTool.prototype.switch=function(){this.toolbar.getTarget().switchToVisualEditor();};ve
.ui.toolFactory.register(ve.ui.MWEditModeVisualTool);},{},{"accesskey-save":"s","colon-separator":": ","hidden-categories":"{{PLURAL:$1|Hidden category|Hidden categories}}","pagecategories":"{{PLURAL:$1|Category|Categories}}","pagecategorieslink":"Special:Categories","publishchanges":"Publish changes","publishchanges-start":"Publish changes…","publishpage":"Publish page","publishpage-start":"Publish page…","redirectpagesub":"Redirect page","redirectto":"Redirect to:","savearticle":"Save page","savearticle-start":"Save page…","savechanges":"Save changes","savechanges-start":"Save changes…","showpreview":"Show preview","visualeditor-browserwarning":"You are using a browser which is not officially supported by this editor.","visualeditor-loaderror-revidconflict":"Revision IDs returned by the server do not match (document: $1, metadata: $2).","visualeditor-loaderror-wrongmode":"Tried to load the editor in wrong mode (data type: \"$1\", editor mode: \"$2\").",
"visualeditor-mweditmodesource-progress":"Switching to source editing…","visualeditor-mweditmodeve-progress":"Switching to visual editing…","visualeditor-pagemenu-tooltip":"Page options","visualeditor-recreate":"The page has been deleted since you started editing. Press \"$1\" to recreate it.","visualeditor-redirect-description":"Redirect to $1","visualeditor-savedialog-identify-anon":"Do you want to save this page as an anonymous user instead? Your IP address will be recorded in this page's edit history.","visualeditor-savedialog-identify-trylogin":"You are no longer logged in. Please log back in from a different tab and try again.","visualeditor-savedialog-identify-user":"You are now logged in as [[User:$1|$1]]. Your edit will be associated with this account if you save this edit.","visualeditor-saveerror":"Error saving data to server: $1.","visualeditor-serializeerror":"Error loading data from server: $1."});mw.loader.implement("ext.visualEditor.base@1qpmw",function($,jQuery,require,module){ve.scrollIntoView=OO.ui.Element.static.scrollIntoView.bind(OO.ui.Element.static);ve.selectElement=function(element){var win=OO.ui.Element.static.getWindow(element),nativeRange=win.document.createRange(),nativeSelection=win.getSelection();nativeRange.setStart(element,0);nativeRange.setEnd(element,element.childNodes.length);nativeSelection.removeAllRanges();nativeSelection.addRange(nativeRange);};ve.supportsSelectionExtend=!!window.getSelection().extend;ve.translateRect=function(rect,x,y){var translatedRect={};if(rect.top!==undefined){translatedRect.top=rect.top+y;}if(rect.bottom!==undefined){translatedRect.bottom=rect.bottom+y;}if(rect.left!==undefined){translatedRect.left=rect.left+x;}if(rect.right!==undefined){translatedRect.right=rect.right+x;}if(rect.width!==undefined){translatedRect.width=rect.width;}if(rect.height!==undefined){translatedRect.height=rect.height;}return translatedRect;};ve.
getStartAndEndRects=function(rects){if(!rects||!rects.length){return null;}var startRect,endRect;for(var i=0,l=rects.length;i<l;i++){if(!startRect||rects[i].top<startRect.top){startRect=ve.extendObject({},rects[i]);}else if(rects[i].top===startRect.top){startRect.left=Math.min(startRect.left,rects[i].left);startRect.right=Math.max(startRect.right,rects[i].right);startRect.width=startRect.right-startRect.left;}if(!endRect||rects[i].bottom>endRect.bottom){endRect=ve.extendObject({},rects[i]);}else if(rects[i].bottom===endRect.bottom){endRect.left=Math.min(endRect.left,rects[i].left);endRect.right=Math.max(endRect.right,rects[i].right);endRect.width=startRect.right-startRect.left;}}return{start:startRect,end:endRect};};ve.getSystemPlatform=function(){return(ve.init.platform&&ve.init.platform.constructor||ve.init.Platform).static.getSystemPlatform();};ve.isUnmodifiedLeftClick=function(e){return e&&e.which&&e.which===OO.ui.MouseButtons.LEFT&&!(e.shiftKey||e.altKey||e.ctrlKey||e.metaKey);};
ve.isClipboardDataFormatsSupported=function(e,customTypes){var cacheKey=customTypes?'cachedCustom':'cached';if(ve.isClipboardDataFormatsSupported[cacheKey]===undefined){var profile=$.client.profile();var clipboardData=e.originalEvent.clipboardData||e.originalEvent.dataTransfer;ve.isClipboardDataFormatsSupported[cacheKey]=!!(clipboardData&&(!customTypes||profile.name!=='edge')&&(clipboardData.items||(profile.name==='firefox'&&profile.versionNumber>=48)));}return ve.isClipboardDataFormatsSupported[cacheKey];};ve.fixSelectionNodes=function(selection){var profile=$.client.profile();if(profile.layout!=='gecko'){return;}function fixNodeProperty(prop){Object.defineProperty(selection,prop,{get:function(){var node=Object.getOwnPropertyDescriptor(Selection.prototype,prop).get.call(this);try{node&&node.prop;}catch(e){ve.log('Worked around Firefox bug with getSelection().anchorNode/focusNode. See https://phabricator.wikimedia.org/T209646.');return(document.activeElement&&document.activeElement.
parentNode)||null;}return node;}});}if(!Object.getOwnPropertyDescriptor(selection,'anchorNode')){fixNodeProperty('anchorNode');fixNodeProperty('focusNode');}};ve.addPassiveEventListener=function(elem,event,handler){elem.addEventListener(event,handler,ve.isPassiveEventsSupported()?{passive:true}:false);};ve.removePassiveEventListener=function(elem,event,handler){elem.removeEventListener(event,handler,ve.isPassiveEventsSupported()?{passive:true}:false);};ve.isPassiveEventsSupported=function(){if(ve.isPassiveEventsSupported.supported===undefined){try{var opts=Object.defineProperty({},'passive',{get:function(){ve.isPassiveEventsSupported.supported=true;}});window.addEventListener('testPassive',null,opts);window.removeEventListener('testPassive',null,opts);}catch(e){}if(ve.isPassiveEventsSupported.supported!==true){ve.isPassiveEventsSupported.supported=false;}}return ve.isPassiveEventsSupported.supported;};ve.safeDecodeEntities=function(html){var textarea=document.createElement('textarea');
textarea.innerHTML=html;return textarea.textContent;};ve.init={};ve.init.SafeStorage=function(store){this.store=store;};ve.init.SafeStorage.prototype.get=null;ve.init.SafeStorage.prototype.set=null;ve.init.SafeStorage.prototype.remove=null;ve.init.SafeStorage.prototype.getObject=null;ve.init.SafeStorage.prototype.setObject=null;ve.init.ListStorage=function(storage){this.storage=storage;};ve.init.ListStorage.prototype.get=function(key){return this.storage.get(key);};ve.init.ListStorage.prototype.set=function(key,value){return this.storage.set(key,value);};ve.init.ListStorage.prototype.remove=function(key){return this.storage.remove(key);};ve.init.ListStorage.prototype.getObject=function(key){return this.storage.getObject(key);};ve.init.ListStorage.prototype.setObject=function(key,value){return this.storage.setObject(key,value);};ve.init.ListStorage.prototype.appendToList=function(key,value){var length=this.getListLength(key);if(this.set(key+'__'+length,value)){length++;return this.set(
key+'__length',length.toString());}return false;};ve.init.ListStorage.prototype.getListLength=function(key){return+this.get(key+'__length')||0;};ve.init.ListStorage.prototype.getList=function(key){var list=[],length=this.getListLength(key);for(var i=0;i<length;i++){list.push(this.get(key+'__'+i));}return list;};ve.init.ListStorage.prototype.removeList=function(key){var length=this.getListLength(key);for(var i=0;i<length;i++){this.remove(key+'__'+i);}this.remove(key+'__length');};ve.init.Platform=function VeInitPlatform(){OO.EventEmitter.call(this);this.localStorage=this.createLocalStorage();this.sessionStorage=this.createSessionStorage();ve.init.platform=this;OO.ui.getUserLanguages=this.getUserLanguages.bind(this);OO.ui.msg=this.getMessage.bind(this);setTimeout(function(){ve.init.Platform.static.deferredPlatform.resolve(ve.init.platform);});};OO.mixinClass(ve.init.Platform,OO.EventEmitter);ve.init.Platform.static.deferredPlatform=ve.createDeferred();ve.init.Platform.static.
initializedPromise=ve.init.Platform.static.deferredPlatform.promise().then(function(platform){return platform.getInitializedPromise();});ve.init.Platform.static.getSystemPlatform=function(){return $.client.profile().platform;};ve.init.Platform.static.isInternetExplorer=function(){return $.client.profile().name==='msie';};ve.init.Platform.static.isEdge=function(){return $.client.profile().name==='edge';};ve.init.Platform.static.isIos=function(){return/ipad|iphone|ipod/i.test(navigator.userAgent);};ve.init.Platform.prototype.getExternalLinkUrlProtocolsRegExp=null;ve.init.Platform.prototype.getUnanchoredExternalLinkUrlProtocolsRegExp=null;ve.init.Platform.prototype.getMetadataIdRegExp=function(){return null;};ve.init.Platform.prototype.notify=null;ve.init.Platform.prototype.getConfig=null;ve.init.Platform.prototype.getUserConfig=null;ve.init.Platform.prototype.setUserConfig=null;ve.init.Platform.prototype.createSafeStorage=null;ve.init.Platform.prototype.createListStorage=function(
safeStorage){return new ve.init.ListStorage(safeStorage);};ve.init.Platform.prototype.createLocalStorage=function(){var localStorage;try{localStorage=window.localStorage;}catch(e){}return this.createListStorage(this.createSafeStorage(localStorage));};ve.init.Platform.prototype.createSessionStorage=function(){var sessionStorage;try{sessionStorage=window.sessionStorage;}catch(e){}return this.createListStorage(this.createSafeStorage(sessionStorage));};ve.init.Platform.prototype.addMessages=null;ve.init.Platform.prototype.getMessage=null;ve.init.Platform.prototype.parseNumber=null;ve.init.Platform.prototype.formatNumber=null;ve.init.Platform.prototype.getHtmlMessage=null;ve.init.Platform.prototype.addParsedMessages=null;ve.init.Platform.prototype.getParsedMessage=null;ve.init.Platform.prototype.getUserLanguages=null;ve.init.Platform.prototype.getMediaSources=null;ve.init.Platform.prototype.getLanguageCodes=null;ve.init.Platform.prototype.getLanguageName=null;ve.init.Platform.prototype.
getLanguageAutonym=null;ve.init.Platform.prototype.getLanguageDirection=null;ve.init.Platform.prototype.initialize=function(){if(!VisualEditorSupportCheck()){return ve.createDeferred().reject().promise();}return ve.createDeferred().resolve().promise();};ve.init.Platform.prototype.getInitializedPromise=function(){if(!this.initialized){this.initialized=this.initialize();}return this.initialized;};ve.init.Platform.prototype.fetchSpecialCharList=function(){function tryParseJSON(json){try{return JSON.parse(json);}catch(err){ve.log('ve.init.Platform: Could not parse the special character list '+json);ve.log(err.message);}return{};}var charsObj={},groups=['accents','mathematical','symbols'];groups.forEach(function(group){charsObj[group]={label:ve.msg('visualeditor-specialcharacter-group-label-'+group),characters:tryParseJSON(ve.msg('visualeditor-specialcharacter-group-set-'+group))};});return ve.createDeferred().resolve(charsObj).promise();};ve.init.Platform.prototype.decodeEntities=ve.
safeDecodeEntities;ve.init.Target=function VeInitTarget(config){config=config||{};ve.init.Target.super.call(this,config);OO.EventEmitter.call(this);if(config.register!==false){ve.init.target=this;}this.surfaces=[];this.surface=null;this.toolbar=null;this.actionsToolbar=null;this.toolbarConfig=config.toolbarConfig||{};this.toolbarGroups=config.toolbarGroups||this.constructor.static.toolbarGroups;this.actionGroups=config.actionGroups||this.constructor.static.actionGroups;this.$scrollContainer=this.getScrollContainer();this.$scrollListener=this.$scrollContainer.is('html, body')?$(OO.ui.Element.static.getWindow(this.$scrollContainer[0])):this.$scrollContainer;this.toolbarScrollOffset=0;this.activeToolbars=0;this.wasSurfaceActive=null;this.teardownPromise=null;this.modes=config.modes||this.constructor.static.modes;this.setDefaultMode(config.defaultMode);this.setupTriggerListeners();this.$element.addClass('ve-init-target');var isIe=ve.init.platform.constructor.static.isInternetExplorer(),
isEdge=ve.init.platform.constructor.static.isEdge();if(isIe){this.$element.addClass('ve-init-target-ie');}if(isIe||isEdge){this.$element.addClass('ve-init-target-ie-or-edge');}if(ve.init.platform.constructor.static.isIos()){this.$element.addClass('ve-init-target-ios');}this.onDocumentKeyDownHandler=this.onDocumentKeyDown.bind(this);this.onDocumentKeyUpHandler=this.onDocumentKeyUp.bind(this);this.onDocumentVisibilityChangeHandler=this.onDocumentVisibilityChange.bind(this);this.onTargetKeyDownHandler=this.onTargetKeyDown.bind(this);this.onContainerScrollHandler=this.onContainerScroll.bind(this);this.bindHandlers();};OO.inheritClass(ve.init.Target,OO.ui.Element);OO.mixinClass(ve.init.Target,OO.EventEmitter);ve.init.Target.static.modes=['visual'];ve.init.Target.static.toolbarGroups=[{name:'history',include:['undo','redo']},{name:'format',header:OO.ui.deferMsg('visualeditor-toolbar-paragraph-format'),title:OO.ui.deferMsg('visualeditor-toolbar-format-tooltip'),type:'menu',include:[{group:
'format'}],promote:['paragraph'],demote:['preformatted','blockquote']},{name:'style',header:OO.ui.deferMsg('visualeditor-toolbar-text-style'),title:OO.ui.deferMsg('visualeditor-toolbar-style-tooltip'),include:['bold','italic','moreTextStyle']},{name:'link',include:['link']},{name:'structure',header:OO.ui.deferMsg('visualeditor-toolbar-structure'),title:OO.ui.deferMsg('visualeditor-toolbar-structure'),label:OO.ui.deferMsg('visualeditor-toolbar-structure'),invisibleLabel:true,type:'list',icon:'listBullet',include:[{group:'structure'}],demote:['outdent','indent']},{name:'insert',header:OO.ui.deferMsg('visualeditor-toolbar-insert'),title:OO.ui.deferMsg('visualeditor-toolbar-insert'),label:OO.ui.deferMsg('visualeditor-toolbar-insert'),invisibleLabel:true,type:'list',icon:'add',include:'*'},{name:'specialCharacter',include:['specialCharacter']}];ve.init.Target.static.actionGroups=[];ve.init.Target.static.documentCommands=['commandHelp'];ve.init.Target.static.targetCommands=['findAndReplace',
'findNext','findPrevious'];ve.init.Target.static.includeCommands=null;ve.init.Target.static.excludeCommands=[];ve.init.Target.static.importRules={external:{blacklist:{'textStyle/span':true,'textStyle/font':true,alienInline:true,alienBlock:true,alienTableCell:true,comment:true,div:true},htmlBlacklist:{unwrap:{fieldset:true,legend:true,main:true,nav:true,aside:true}},nodeSanitization:true},all:null};ve.init.Target.static.createModelFromDom=function(doc,mode,options){if(mode==='source'){return ve.dm.sourceConverter.getModelFromSourceText(doc,options);}else{return ve.dm.converter.getModelFromDom(doc,options);}};ve.init.Target.static.parseDocument=function(documentString,mode){if(mode==='source'){return documentString;}return ve.createDocumentFromHtml(documentString);};ve.init.Target.prototype.parseDocument=function(){return this.constructor.static.parseDocument.apply(this.constructor.static,arguments);};ve.init.Target.prototype.setDefaultMode=function(defaultMode){if(!this.isModeAvailable(
defaultMode)){if(!this.defaultMode){defaultMode=this.modes[0];}else{return;}}if(defaultMode!==this.defaultMode){if(this.defaultMode){this.$element.removeClass('ve-init-target-'+this.defaultMode);}this.$element.addClass('ve-init-target-'+defaultMode);this.defaultMode=defaultMode;}};ve.init.Target.prototype.getDefaultMode=function(){return this.defaultMode;};ve.init.Target.prototype.isModeAvailable=function(mode){return this.modes.indexOf(mode)!==-1;};ve.init.Target.prototype.bindHandlers=function(){$(this.getElementDocument()).on({keydown:this.onDocumentKeyDownHandler,keyup:this.onDocumentKeyUpHandler,visibilitychange:this.onDocumentVisibilityChangeHandler});this.$element.on('keydown',this.onTargetKeyDownHandler);ve.addPassiveEventListener(this.$scrollListener[0],'scroll',this.onContainerScrollHandler);};ve.init.Target.prototype.unbindHandlers=function(){$(this.getElementDocument()).off({keydown:this.onDocumentKeyDownHandler,keyup:this.onDocumentKeyUpHandler,visibilitychange:this.
onDocumentVisibilityChangeHandler});this.$element.off('keydown',this.onTargetKeyDownHandler);ve.removePassiveEventListener(this.$scrollListener[0],'scroll',this.onContainerScrollHandler);};ve.init.Target.prototype.teardown=function(){if(!this.teardownPromise){this.unbindHandlers();this.teardownPromise=this.teardownToolbar().then(this.clearSurfaces.bind(this));}return this.teardownPromise;};ve.init.Target.prototype.destroy=function(){var target=this;return this.teardown().then(function(){target.$element.remove();if(ve.init.target===target){ve.init.target=null;}});};ve.init.Target.prototype.setupTriggerListeners=function(){var surfaceOrSurfaceConfig=this.getSurface()||this.getSurfaceConfig();this.documentTriggerListener=new ve.TriggerListener(this.constructor.static.documentCommands,surfaceOrSurfaceConfig.commandRegistry);this.targetTriggerListener=new ve.TriggerListener(this.constructor.static.targetCommands,surfaceOrSurfaceConfig.commandRegistry);};ve.init.Target.prototype.
getScrollContainer=function(){return $(OO.ui.Element.static.getClosestScrollableContainer(document.body));};ve.init.Target.prototype.onContainerScroll=function(){var toolbar=this.toolbar;if(toolbar&&toolbar.isFloatable()){var wasFloating=toolbar.isFloating();var scrollTop=this.$scrollContainer.scrollTop();if(scrollTop+this.toolbarScrollOffset>toolbar.getElementOffset().top){toolbar.float();}else{toolbar.unfloat();}if(toolbar.isFloating()!==wasFloating){toolbar.getItems().forEach(function(toolgroup){if(toolgroup instanceof OO.ui.PopupToolGroup&&toolgroup.isActive()){toolgroup.position();}});}}};ve.init.Target.prototype.onDocumentKeyDown=function(e){var trigger=new ve.ui.Trigger(e);if(trigger.isComplete()){var command=this.documentTriggerListener.getCommandByTrigger(trigger.toString());var surface=this.getSurface();if(surface&&command&&command.execute(surface,undefined,'trigger')){e.preventDefault();}}this.$element.toggleClass('ve-init-target-ctrl-meta-down',e.ctrlKey||e.metaKey);};ve.
init.Target.prototype.onDocumentKeyUp=function(e){this.$element.toggleClass('ve-init-target-ctrl-meta-down',e.ctrlKey||e.metaKey);};ve.init.Target.prototype.onDocumentVisibilityChange=function(){this.$element.removeClass('ve-init-target-ctrl-meta-down');};ve.init.Target.prototype.onTargetKeyDown=function(e){var trigger=new ve.ui.Trigger(e);if(trigger.isComplete()){var command=this.targetTriggerListener.getCommandByTrigger(trigger.toString());var surface=this.getSurface();if(surface&&command&&command.execute(surface,undefined,'trigger')){e.preventDefault();}}};ve.init.Target.prototype.onToolbarResize=function(){this.getSurface().setPadding({top:this.getToolbar().getHeight()+this.toolbarScrollOffset});};ve.init.Target.prototype.createTargetWidget=function(config){return new ve.ui.TargetWidget(ve.extendObject({toolbarGroups:this.toolbarGroups},config));};ve.init.Target.prototype.createSurface=function(dmDocOrSurface,config){return new ve.ui.Surface(dmDocOrSurface,this.getSurfaceConfig(
config));};ve.init.Target.prototype.getSurfaceConfig=function(config){return ve.extendObject({$scrollContainer:this.$scrollContainer,$scrollListener:this.$scrollListener,commandRegistry:ve.ui.commandRegistry,sequenceRegistry:ve.ui.sequenceRegistry,dataTransferHandlerFactory:ve.ui.dataTransferHandlerFactory,includeCommands:this.constructor.static.includeCommands,excludeCommands:OO.simpleArrayUnion(this.constructor.static.excludeCommands,this.constructor.static.documentCommands,this.constructor.static.targetCommands),importRules:this.constructor.static.importRules},config);};ve.init.Target.prototype.addSurface=function(dmDocOrSurface,config){var surface=this.createSurface(dmDocOrSurface,ve.extendObject({mode:this.getDefaultMode()},config));this.surfaces.push(surface);surface.getView().connect(this,{focus:this.onSurfaceViewFocus.bind(this,surface)});return surface;};ve.init.Target.prototype.clearSurfaces=function(){this.surface=null;while(this.surfaces.length){this.surfaces.pop().destroy(
);}};ve.init.Target.prototype.onSurfaceViewFocus=function(surface){this.setSurface(surface);};ve.init.Target.prototype.setSurface=function(surface){if(OO.ui.isMobile()){this.toolbarConfig.$overlay=surface.getGlobalOverlay().$element;}if(this.surfaces.indexOf(surface)===-1){throw new Error('Active surface must have been added first');}if(surface!==this.surface){this.surface=surface;this.setupToolbar(surface);}};ve.init.Target.prototype.getSurface=function(){return this.surface;};ve.init.Target.prototype.getToolbar=function(){if(!this.toolbar){this.toolbar=new ve.ui.PositionedTargetToolbar(this,this.toolbarConfig);}return this.toolbar;};ve.init.Target.prototype.getActions=function(){if(!this.actionsToolbar){this.actionsToolbar=new ve.ui.TargetToolbar(this,{position:this.toolbarConfig.position,$overlay:this.toolbarConfig.$overlay});}return this.actionsToolbar;};ve.init.Target.prototype.setupToolbar=function(surface){var toolbar=this.getToolbar(),actions=this.getActions();toolbar.connect(
this,{resize:'onToolbarResize',active:'onToolbarActive'});actions.connect(this,{active:'onToolbarActive'});if(surface.nullSelectionOnBlur){toolbar.$element.on('focusin',function(){surface.getView().deactivate(true);}).on('focusout',function(e){var newFocusedElement=e.relatedTarget;if(!OO.ui.contains([toolbar.$element[0],toolbar.$overlay[0]],newFocusedElement,true)){if(OO.ui.contains(surface.getView().$element[0],newFocusedElement,true)){var previousSelection=surface.getModel().getSelection();surface.getView().activate();if(!previousSelection.isNull()){surface.getModel().setSelection(previousSelection);}}else{surface.getView().blur();}}});}toolbar.setup(this.toolbarGroups,surface);actions.setup(this.actionGroups,surface);toolbar.$actions.append(actions.$element);this.attachToolbar();var rAF=window.requestAnimationFrame||setTimeout;rAF(this.onContainerScrollHandler);};ve.init.Target.prototype.deactivateSurfaceForToolbar=function(){var view=this.getSurface().getView();this.
wasSurfaceActive=!view.deactivated;if(this.wasSurfaceActive){view.deactivate();}};ve.init.Target.prototype.activateSurfaceForToolbar=function(){var view=this.getSurface().getView();if(this.wasSurfaceActive&&!(OO.ui.isMobile()&&!view.getModel().getSelection().isCollapsed())){view.activate();}};ve.init.Target.prototype.onToolbarActive=function(active){if(active){this.activeToolbars++;if(this.activeToolbars===1){this.deactivateSurfaceForToolbar();}}else{this.activeToolbars--;if(!this.activeToolbars){this.activateSurfaceForToolbar();}}};ve.init.Target.prototype.teardownToolbar=function(){if(this.toolbar){this.toolbar.destroy();this.toolbar=null;}if(this.actionsToolbar){this.actionsToolbar.destroy();this.actionsToolbar=null;}return ve.createDeferred().resolve().promise();};ve.init.Target.prototype.attachToolbar=function(){var toolbar=this.getToolbar();toolbar.$element.insertBefore(toolbar.getSurface().$element);toolbar.initialize();this.getActions().initialize();};},{"css":[
".ve-activated .sidebar-toc{display:none}"]});mw.loader.implement("ext.visualEditor.core@kdpaf",function($,jQuery,require,module){ve.Range=function VeRange(from,to){this.from=arguments.length>=1?from:0;this.to=arguments.length>=2?to:this.from;this.start=this.from<this.to?this.from:this.to;this.end=this.from<this.to?this.to:this.from;};OO.initClass(ve.Range);ve.Range.static.newFromJSON=function(json){return this.newFromHash(JSON.parse(json));};ve.Range.static.newFromHash=function(hash){return new ve.Range(hash.from,hash.to);};ve.Range.static.newCoveringRange=function(ranges,backwards){if(ranges.length===0){throw new Error('newCoveringRange() requires at least one range');}var minStart=ranges[0].start;var maxEnd=ranges[0].end;for(var i=1;i<ranges.length;i++){if(ranges[i].start<minStart){minStart=ranges[i].start;}if(ranges[i].end>maxEnd){maxEnd=ranges[i].end;}}var range;if(backwards){range=new ve.Range(maxEnd,minStart);}else{range=new ve.Range(minStart,maxEnd);}return range;};ve.Range.prototype.containsOffset=function(offset){return offset
>=this.start&&offset<this.end;};ve.Range.prototype.containsRange=function(range){return range.start>=this.start&&range.end<=this.end;};ve.Range.prototype.touchesRange=function(range){return range.end>=this.start&&range.start<=this.end;};ve.Range.prototype.overlapsRange=function(range){return range.end>this.start&&range.start<this.end;};ve.Range.prototype.getLength=function(){return this.end-this.start;};ve.Range.prototype.flip=function(){return new ve.Range(this.to,this.from);};ve.Range.prototype.translate=function(distance){return new ve.Range(this.from+distance,this.to+distance);};ve.Range.prototype.equals=function(other){return other&&this.from===other.from&&this.to===other.to;};ve.Range.prototype.equalsSelection=function(other){return other&&this.end===other.end&&this.start===other.start;};ve.Range.prototype.truncate=function(limit){if(limit>=0){return new ve.Range(this.start,Math.min(this.start+limit,this.end));}else{return new ve.Range(Math.max(this.end+limit,this.start),this.end
);}};ve.Range.prototype.expand=function(other){return ve.Range.static.newCoveringRange([this,other],this.isBackwards());};ve.Range.prototype.isCollapsed=function(){return this.from===this.to;};ve.Range.prototype.isBackwards=function(){return this.from>this.to;};ve.Range.prototype.toJSON=function(){return{type:'range',from:this.from,to:this.to};};ve.SelectionState=function VeSelectionState(selection){this.anchorNode=selection.anchorNode;this.anchorOffset=selection.anchorOffset;this.focusNode=selection.focusNode;this.focusOffset=selection.focusOffset;this.isCollapsed=selection.isCollapsed;if(this.isCollapsed===undefined){this.isCollapsed=this.anchorNode===this.focusNode&&this.anchorOffset===this.focusOffset;}this.isBackwards=selection.isBackwards;if(this.isBackwards===undefined){this.isBackwards=ve.compareDocumentOrder(this.focusNode,this.focusOffset,this.anchorNode,this.anchorOffset)<0;}};OO.initClass(ve.SelectionState);ve.SelectionState.static.newNullSelection=function(){return new ve.
SelectionState({focusNode:null,focusOffset:0,anchorNode:null,anchorOffset:0});};ve.SelectionState.prototype.flip=function(){if(this.isCollapsed){return this;}return new ve.SelectionState({anchorNode:this.focusNode,anchorOffset:this.focusOffset,focusNode:this.anchorNode,focusOffset:this.anchorOffset,isCollapsed:false,isBackwards:!this.isBackwards});};ve.SelectionState.prototype.equalsSelection=function(other){return this.anchorNode===other.anchorNode&&this.anchorOffset===other.anchorOffset&&this.focusNode===other.focusNode&&this.focusOffset===other.focusOffset;};ve.SelectionState.prototype.getNativeRange=function(doc){if(this.anchorNode===null){return null;}var range=doc.createRange();try{if(this.isBackwards){range.setStart(this.focusNode,this.focusOffset);range.setEnd(this.anchorNode,this.anchorOffset);}else{range.setStart(this.anchorNode,this.anchorOffset);if(!this.isCollapsed){range.setEnd(this.focusNode,this.focusOffset);}}}catch(e){return null;}return range;};ve.Node=function VeNode
(){this.type=this.constructor.static.name;this.parent=null;this.root=null;this.doc=null;};ve.Node.prototype.getChildNodeTypes=null;ve.Node.prototype.getParentNodeTypes=null;ve.Node.prototype.isAllowedChildNodeType=function(type){var childTypes=this.getChildNodeTypes();return childTypes===null||childTypes.indexOf(type)!==-1;};ve.Node.prototype.isAllowedParentNodeType=function(type){var parentTypes=this.getParentNodeTypes();return parentTypes===null||parentTypes.indexOf(type)!==-1;};ve.Node.prototype.getSuggestedParentNodeTypes=null;ve.Node.prototype.canHaveChildren=null;ve.Node.prototype.canHaveChildrenNotContent=null;ve.Node.prototype.canContainContent=null;ve.Node.prototype.isContent=null;ve.Node.prototype.isInternal=null;ve.Node.prototype.isMetaData=null;ve.Node.prototype.isWrapped=null;ve.Node.prototype.isUnwrappable=null;ve.Node.prototype.isFocusable=null;ve.Node.prototype.isAlignable=null;ve.Node.prototype.isCellable=null;ve.Node.prototype.isCellEditable=null;ve.Node.prototype.
isDiffedAsList=null;ve.Node.prototype.isDiffedAsLeaf=null;ve.Node.prototype.isDiffedAsDocument=null;ve.Node.prototype.hasSignificantWhitespace=null;ve.Node.prototype.handlesOwnChildren=null;ve.Node.prototype.shouldIgnoreChildren=null;ve.Node.prototype.getLength=null;ve.Node.prototype.getOffset=null;ve.Node.prototype.getRange=function(backwards){var offset=this.getOffset()+(this.isWrapped()?1:0),range=new ve.Range(offset,offset+this.getLength());return backwards?range.flip():range;};ve.Node.prototype.getOuterRange=function(backwards){var range=new ve.Range(this.getOffset(),this.getOffset()+this.getOuterLength());return backwards?range.flip():range;};ve.Node.prototype.getOuterLength=function(){return this.getLength()+(this.isWrapped()?2:0);};ve.Node.prototype.getType=function(){return this.type;};ve.Node.prototype.getParent=function(){return this.parent;};ve.Node.prototype.getRoot=function(){return this.root;};ve.Node.prototype.setRoot=function(root){var oldRoot=this.root;if(root===
oldRoot){return;}if(oldRoot){this.root=null;this.emit('unroot',oldRoot);}this.root=root;if(root){this.emit('root',root);}};ve.Node.prototype.getDocument=function(){return this.doc;};ve.Node.prototype.setDocument=function(doc){var oldDoc=this.doc;if(doc===oldDoc){return;}if(oldDoc){this.doc=null;oldDoc.nodeDetached(this);}this.doc=doc;if(doc){doc.nodeAttached(this);}};ve.Node.prototype.attach=function(parent){this.parent=parent;this.setDocument(parent.getDocument());this.setRoot(parent.getRoot());this.emit('attach',parent);};ve.Node.prototype.detach=function(){var parent=this.parent;this.parent=null;this.setRoot(null);this.setDocument(null);this.emit('detach',parent);};ve.Node.prototype.traverseUpstream=function(callback){var node=this;while(node){if(callback(node)===false){return node;}node=node.getParent();}return null;};ve.Node.prototype.findParent=function(type){return this.traverseUpstream(function(node){return!(node instanceof type);});};ve.Node.prototype.collectUpstream=function(
){var nodes=[];this.traverseUpstream(function(node){nodes.push(node);});return nodes;};ve.Node.prototype.isDownstreamOf=function(upstreamNode){return this.traverseUpstream(function(node){return node!==upstreamNode;})!==null;};ve.Node.prototype.getOffsetPath=function(){var node=this,path=[];while(true){if(node.type==='document'){return path;}var parent=node.getParent();if(!parent){return null;}path.unshift(parent.indexOf(node));node=parent;}};ve.PositionStep=function VePositionStep(node,type,offset){this.node=node;this.type=type;this.offset=offset;};ve.BranchNode=function VeBranchNode(children){this.children=Array.isArray(children)?children:[];};OO.initClass(ve.BranchNode);ve.BranchNode.prototype.traverse=function(callback){var children=this.getChildren();for(var i=0,len=children.length;i<len;i++){callback.call(this,children[i]);if(children[i].hasChildren()){children[i].traverse(callback);}}};ve.BranchNode.prototype.hasChildren=function(){return true;};ve.BranchNode.prototype.
getChildren=function(){return this.children;};ve.BranchNode.prototype.indexOf=function(node){return this.children.indexOf(node);};ve.BranchNode.prototype.setRoot=function(root){var oldRoot=this.root;if(root===oldRoot){return;}var i,len;if(oldRoot){this.root=null;for(i=0,len=this.children.length;i<len;i++){this.children[i].setRoot(null);}this.emit('unroot',oldRoot);}this.root=root;if(root){for(i=0,len=this.children.length;i<len;i++){this.children[i].setRoot(root);}this.emit('root',root);}};ve.BranchNode.prototype.setDocument=function(doc){var oldDoc=this.doc;if(doc===this.doc){return;}var i,len;if(oldDoc){this.doc=null;for(i=0,len=this.children.length;i<len;i++){this.children[i].setDocument(null);}oldDoc.nodeDetached(this);}this.doc=doc;if(doc){for(i=0,len=this.children.length;i<len;i++){this.children[i].setDocument(doc);}doc.nodeAttached(this);}};ve.BranchNode.prototype.getNodeFromOffset=function(offset,shallow){var currentNode=this;if(typeof offset!=='number'){throw new Error(
'Offset must be a number');}if(offset===0){return currentNode;}if(offset<0){throw new Error('Offset out of bounds');}var nodeOffset=0;SIBLINGS:while(currentNode.children.length){for(var i=0,length=currentNode.children.length;i<length;i++){var childNode=currentNode.children[i];if(offset===nodeOffset){return currentNode;}if(childNode instanceof ve.ce.InternalListNode){break SIBLINGS;}var nodeLength=childNode.getOuterLength();if(offset>=nodeOffset&&offset<nodeOffset+nodeLength){if(!shallow&&childNode.hasChildren()&&childNode.getChildren().length){nodeOffset+=1;currentNode=childNode;continue SIBLINGS;}else{return childNode;}}nodeOffset+=nodeLength;}if(offset===nodeOffset){return currentNode;}}return null;};ve.LeafNode=function VeLeafNode(){};ve.LeafNode.prototype.hasChildren=function(){return false;};ve.Document=function VeDocument(documentNode){OO.EventEmitter.call(this);this.documentNode=documentNode;this.documentNode.setDocument(this);};OO.mixinClass(ve.Document,OO.EventEmitter);ve.
Document.prototype.getDocumentNode=function(){return this.documentNode;};ve.Document.prototype.getBranchNodeFromOffset=function(offset){var node=this.getDocumentNode().getNodeFromOffset(offset);if(node&&!node.hasChildren()){node=node.getParent();}return node;};ve.Document.prototype.selectNodes=function(range,mode){var doc=this.getDocumentNode(),retval=[],start=range.start,end=range.end,stack=[{node:doc,index:0,startOffset:0}],currentFrame=stack[0],startFound=false;mode=mode||'leaves';if(mode!=='leaves'&&mode!=='branches'&&mode!=='covered'&&mode!=='siblings'){throw new Error('Invalid mode: '+mode);}if(start<0||start>doc.getLength()){throw new Error('Invalid start offset: '+start);}if(end<0||end>doc.getLength()){throw new Error('Invalid end offset: '+end);}if(!doc.children||doc.children.length===0){var nodeRange=new ve.Range(0,doc.getLength());return[{node:doc,range:new ve.Range(start,end),index:0,nodeRange:nodeRange,nodeOuterRange:nodeRange}];}var left=doc.children[0].isWrapped()?1:0;do
{var node=currentFrame.node.children[currentFrame.index];var prevNode=currentFrame.node.children[currentFrame.index-1];var nextNode=currentFrame.node.children[currentFrame.index+1];var right=left+node.getLength();var startInside=start>=left&&start<=right;var endInside=end>=left&&end<=right;var isWrapped=node.isWrapped();var isPrevUnwrapped=prevNode?!prevNode.isWrapped():false;var isNextUnwrapped=nextNode?!nextNode.isWrapped():false;var isEmptyBranch=(node.getLength()===0||node.shouldIgnoreChildren())&&!node.isContent()&&!node.canContainContent();var startBetween=(isWrapped?start===left-1:start===left)&&!isPrevUnwrapped;var endBetween=(isWrapped?end===right+1:end===right)&&!isNextUnwrapped;var parentRange=new ve.Range(currentFrame.startOffset,currentFrame.startOffset+currentFrame.node.getLength());var parentFrame;if(isWrapped&&end===left-1&&currentFrame.index===0){isWrapped=currentFrame.node.isWrapped();retval.push({node:currentFrame.node,indexInNode:0,range:new ve.Range(end,end),
nodeRange:parentRange,nodeOuterRange:new ve.Range(parentRange.start-isWrapped,parentRange.end+isWrapped)});parentFrame=stack[stack.length-2];if(parentFrame){retval[retval.length-1].index=parentFrame.index;}return retval;}if(start===end&&(startBetween||endBetween)&&isWrapped){isWrapped=currentFrame.node.isWrapped();retval=[{node:currentFrame.node,indexInNode:currentFrame.index+(endBetween?1:0),range:new ve.Range(start,end),nodeRange:parentRange,nodeOuterRange:new ve.Range(parentRange.start-isWrapped,parentRange.end+isWrapped)}];parentFrame=stack[stack.length-2];if(parentFrame){retval[0].index=parentFrame.index;}return retval;}else if(startBetween){if((mode==='leaves'||(mode==='covered'&&endInside)||(mode==='branches'&&node.canHaveChildrenNotContent()))&&node.children&&node.children.length&&!node.shouldIgnoreChildren()){currentFrame={node:node,index:0,startOffset:left};stack.push(currentFrame);startFound=true;if(node.children[0].isWrapped()){left++;}continue;}else if(!endInside){retval.
push({node:node,index:currentFrame.index,nodeRange:new ve.Range(left,right),nodeOuterRange:new ve.Range(left-isWrapped,right+isWrapped),parentOuterRange:new ve.Range(parentRange.start-currentFrame.node.isWrapped(),parentRange.end+currentFrame.node.isWrapped())});startFound=true;}else{return[{node:node,range:new ve.Range(start,end),index:currentFrame.index,nodeRange:new ve.Range(left,right),nodeOuterRange:new ve.Range(left-isWrapped,right+isWrapped),parentOuterRange:new ve.Range(parentRange.start-currentFrame.node.isWrapped(),parentRange.end+currentFrame.node.isWrapped())}];}}else if(startInside&&endInside){if(node.children&&node.children.length&&(mode!=='branches'||node.canHaveChildrenNotContent())){currentFrame={node:node,index:0,startOffset:left};stack.push(currentFrame);if(node.children[0].isWrapped()){left++;}continue;}else{retval=[{node:node,range:new ve.Range(start,end),index:currentFrame.index,nodeRange:new ve.Range(left,right),nodeOuterRange:new ve.Range(left-isWrapped,right+
isWrapped),parentOuterRange:new ve.Range(parentRange.start-currentFrame.node.isWrapped(),parentRange.end+currentFrame.node.isWrapped())}];if(isEmptyBranch){retval[0].indexInNode=0;}return retval;}}else if(startInside){if((mode==='leaves'||mode==='covered'||(mode==='branches'&&node.canHaveChildrenNotContent()))&&node.children&&node.children.length){currentFrame={node:node,index:0,startOffset:left};stack.push(currentFrame);if(node.children[0].isWrapped()){left++;}continue;}else{retval.push({node:node,range:new ve.Range(start,right),index:currentFrame.index,nodeRange:new ve.Range(left,right),nodeOuterRange:new ve.Range(left-isWrapped,right+isWrapped),parentOuterRange:new ve.Range(parentRange.start-currentFrame.node.isWrapped(),parentRange.end+currentFrame.node.isWrapped())});startFound=true;}}else if(endBetween){if((mode==='leaves'||(mode==='branches'&&node.canHaveChildrenNotContent()))&&node.children&&node.children.length){currentFrame={node:node,index:0,startOffset:left};stack.push(
currentFrame);if(node.children[0].isWrapped()){left++;}continue;}else{retval.push({node:node,index:currentFrame.index,nodeRange:new ve.Range(left,right),nodeOuterRange:new ve.Range(left-isWrapped,right+isWrapped),parentOuterRange:new ve.Range(parentRange.start-currentFrame.node.isWrapped(),parentRange.end+currentFrame.node.isWrapped())});return retval;}}else if(endInside){if((mode==='leaves'||mode==='covered'||(mode==='branches'&&node.canHaveChildrenNotContent()))&&node.children&&node.children.length){currentFrame={node:node,index:0,startOffset:left};stack.push(currentFrame);if(node.children[0].isWrapped()){left++;}continue;}else{retval.push({node:node,range:new ve.Range(left,end),index:currentFrame.index,nodeRange:new ve.Range(left,right),nodeOuterRange:new ve.Range(left-isWrapped,right+isWrapped),parentOuterRange:new ve.Range(parentRange.start-currentFrame.node.isWrapped(),parentRange.end+currentFrame.node.isWrapped())});return retval;}}else if(startFound&&end>right){if((mode===
'leaves'||(mode==='branches'&&node.canHaveChildrenNotContent()))&&node.children&&node.children.length){currentFrame={node:node,index:0,startOffset:left};stack.push(currentFrame);if(node.children[0].isWrapped()){left++;}continue;}else{retval.push({node:node,index:currentFrame.index,nodeRange:new ve.Range(left,right),nodeOuterRange:new ve.Range(left-isWrapped,right+isWrapped),parentOuterRange:new ve.Range(parentRange.start-currentFrame.node.isWrapped(),parentRange.end+currentFrame.node.isWrapped())});}}if(nextNode){currentFrame.index++;left=right+(node.isWrapped()?1:0)+(nextNode.isWrapped()?1:0);}else{left=right+(node.isWrapped()?1:0);while(!nextNode){if(node.isWrapped()&&start===left){parentRange=new ve.Range(currentFrame.startOffset,currentFrame.startOffset+currentFrame.node.getLength());isWrapped=currentFrame.node.isWrapped();retval=[{node:currentFrame.node,indexInNode:currentFrame.index+1,range:new ve.Range(left,left),nodeRange:parentRange,nodeOuterRange:new ve.Range(parentRange.
start-isWrapped,parentRange.end+isWrapped)}];parentFrame=stack[stack.length-2];if(parentFrame){retval[0].index=parentFrame.index;}}stack.pop();if(stack.length===0){return retval;}currentFrame=stack[stack.length-1];currentFrame.index++;nextNode=currentFrame.node.children[currentFrame.index];left++;}if(nextNode.isWrapped()){left++;}}}while(end>=left-1);if(retval.length===0){throw new Error('Failed to select any nodes');}return retval;};ve.Document.prototype.getCoveredSiblingGroups=function(range){var leaves=this.selectNodes(range,'leaves'),groups=[],lastEndOffset=0;for(var i=0;i<leaves.length;i++){if(leaves[i].nodeOuterRange.end<=lastEndOffset){continue;}var node=leaves[i].node;if(node.isContent()){node=node.getParent();}var parentNode=node.getParent();if(!parentNode){break;}groups.push({parent:parentNode,grandparent:parentNode.getParent(),nodes:[]});var siblingNode=node;do{groups[groups.length-1].nodes.push(siblingNode);i++;if(leaves[i]===undefined){break;}siblingNode=leaves[i].node;if(
siblingNode.isContent()){siblingNode=siblingNode.getParent();}}while(siblingNode.getParent()===parentNode);i--;lastEndOffset=parentNode.getOuterRange().end;}return groups;};ve.Document.prototype.rangeInsideOneLeafNode=function(range){var selected=this.selectNodes(range,'leaves');return selected.length===1&&selected[0].nodeRange.containsRange(range)&&selected[0].indexInNode===undefined;};ve.Document.prototype.nodeAttached=function(node){this.emit('nodeAttached',node);};ve.Document.prototype.nodeDetached=function(node){this.emit('nodeDetached',node);};ve.EventSequencer=function VeEventSequencer(eventNames){var eventSequencer=this;this.$node=null;this.eventNames=eventNames;this.eventHandlers={};function makeEventHandler(name){return function(ev){return eventSequencer.onEvent(name,ev);};}this.pendingCalls=[];this.onListenersForEvent={};this.afterListenersForEvent={};this.afterOneListenersForEvent={};for(var i=0,len=eventNames.length;i<len;i++){var eventName=eventNames[i];this.
onListenersForEvent[eventName]=[];this.afterListenersForEvent[eventName]=[];this.afterOneListenersForEvent[eventName]=[];this.eventHandlers[eventName]=makeEventHandler(eventName);}this.onLoopListeners=[];this.afterLoopListeners=[];this.afterLoopOneListeners=[];this.doneOnLoop=false;this.afterLoopTimeoutId=null;};ve.EventSequencer.prototype.attach=function($node){this.detach();this.$node=$node.on(this.eventHandlers);return this;};ve.EventSequencer.prototype.detach=function(){if(this.$node===null){return;}this.runPendingCalls();this.$node.off(this.eventHandlers);this.$node=null;return this;};ve.EventSequencer.prototype.onLoop=function(listeners){if(!Array.isArray(listeners)){listeners=[listeners];}ve.batchPush(this.onLoopListeners,listeners);return this;};ve.EventSequencer.prototype.on=function(listeners){for(var eventName in listeners){this.onListenersForEvent[eventName].push(listeners[eventName]);}return this;};ve.EventSequencer.prototype.after=function(listeners){for(var eventName in
listeners){this.afterListenersForEvent[eventName].push(listeners[eventName]);}return this;};ve.EventSequencer.prototype.afterOne=function(listeners){for(var eventName in listeners){this.afterOneListenersForEvent[eventName].push(listeners[eventName]);}return this;};ve.EventSequencer.prototype.afterLoop=function(listeners){if(!Array.isArray(listeners)){listeners=[listeners];}ve.batchPush(this.afterLoopListeners,listeners);return this;};ve.EventSequencer.prototype.afterLoopOne=function(listeners){if(!Array.isArray(listeners)){listeners=[listeners];}ve.batchPush(this.afterLoopOneListeners,listeners);return this;};ve.EventSequencer.prototype.onEvent=function(eventName,ev){this.runPendingCalls(eventName);if(!this.doneOnLoop){this.doneOnLoop=true;this.doOnLoop();}var onListeners=(this.onListenersForEvent[eventName]||[]).slice();for(var i=0,len=onListeners.length;i<len;i++){var onListener=onListeners[i];this.callListener('on',eventName,i,onListener,ev);}var pendingCall={id:null,ev:ev,eventName
:eventName};var eventSequencer=this;var id=this.postpone(function(){if(pendingCall.id===null){return;}eventSequencer.resetAfterLoopTimeout();pendingCall.id=null;eventSequencer.afterEvent(eventName,ev);});pendingCall.id=id;this.pendingCalls.push(pendingCall);};ve.EventSequencer.prototype.afterEvent=function(eventName,ev){var afterListeners=(this.afterListenersForEvent[eventName]||[]).slice();var afterOneListeners=(this.afterOneListenersForEvent[eventName]||[]).splice(0);var i,len;for(i=0,len=afterListeners.length;i<len;i++){this.callListener('after',eventName,i,afterListeners[i],ev);}for(i=0,len=afterOneListeners.length;i<len;i++){this.callListener('afterOne',eventName,i,afterOneListeners[i],ev);}};ve.EventSequencer.prototype.doOnLoop=function(){for(var i=0,len=this.onLoopListeners.length;i<len;i++){this.callListener('onLoop',null,i,this.onLoopListeners[i],null);}};ve.EventSequencer.prototype.doAfterLoop=function(myTimeoutId){if(this.afterLoopTimeoutId!==myTimeoutId){return;}this.
afterLoopTimeoutId=null;var afterLoopListeners=this.afterLoopListeners.slice();var afterLoopOneListeners=this.afterLoopOneListeners.splice(0);var i,len;for(i=0,len=afterLoopListeners.length;i<len;i++){this.callListener('afterLoop',null,i,this.afterLoopListeners[i],null);}for(i=0,len=afterLoopOneListeners.length;i<len;i++){this.callListener('afterLoopOne',null,i,afterLoopOneListeners[i],null);}this.doneOnLoop=false;};ve.EventSequencer.prototype.resetAfterLoopTimeout=function(){if(this.afterLoopTimeoutId!==null){this.cancelPostponed(this.afterLoopTimeoutId);}var eventSequencer=this;var timeoutId=this.postpone(function(){eventSequencer.doAfterLoop(timeoutId);});this.afterLoopTimeoutId=timeoutId;};ve.EventSequencer.prototype.runPendingCalls=function(eventName){var afterKeyDownCalls=[];for(var i=0;i<this.pendingCalls.length;i++){var pendingCall=this.pendingCalls[i];if(pendingCall.id===null){continue;}if(eventName==='keypress'&&pendingCall.eventName==='keydown'){afterKeyDownCalls.push(
pendingCall);continue;}this.cancelPostponed(pendingCall.id);pendingCall.id=null;this.afterEvent(pendingCall.eventName,pendingCall.ev);}this.pendingCalls.length=0;this.pendingCalls.push.apply(this.pendingCalls,afterKeyDownCalls);};ve.EventSequencer.prototype.postpone=function(callback){return setTimeout(callback);};ve.EventSequencer.prototype.cancelPostponed=function(timeoutId){clearTimeout(timeoutId);};ve.EventSequencer.prototype.callListener=function(timing,eventName,i,listener,ev){listener(ev);};ve.Scheduler=function VeScheduler(){};OO.initClass(ve.Scheduler);ve.Scheduler.static.maxDelay=1000;ve.Scheduler.prototype.schedule=function(immediateAction,completionTest,delayHint){var deferred=ve.createDeferred(),startTime=this.now(),testThenAct=function(){var complete;try{complete=completionTest();}catch(e){deferred.reject(e);return;}if(complete){deferred.resolve();return;}if(this.now()-startTime>this.constructor.static.maxDelay){deferred.reject();return;}this.postpone(testThenAct,
delayHint);}.bind(this);immediateAction();testThenAct();return deferred.promise();};ve.Scheduler.prototype.postpone=function(callback,delay){return setTimeout(callback,delay);};ve.Scheduler.prototype.now=function(){return Date.now();};ve.scheduler=new ve.Scheduler();ve.dm={};ve.dm.Model=function VeDmModel(element){this.element=element||{type:this.constructor.static.name};this.store=null;};OO.initClass(ve.dm.Model);ve.dm.Model.static.name=null;ve.dm.Model.static.matchTagNames=null;ve.dm.Model.static.matchRdfaTypes=null;ve.dm.Model.static.allowedRdfaTypes=[];ve.dm.Model.static.matchFunction=null;ve.dm.Model.static.toDataElement=function(){return{type:this.name};};ve.dm.Model.static.toDomElements=function(dataElement,doc){if(this.matchTagNames&&this.matchTagNames.length===1){return[doc.createElement(this.matchTagNames[0])];}throw new Error('ve.dm.Model subclass must match a single tag name or implement toDomElements');};ve.dm.Model.static.enableAboutGrouping=false;ve.dm.Model.static.
preserveHtmlAttributes=true;ve.dm.Model.static.getHashObject=function(dataElement){var hash={type:dataElement.type,attributes:dataElement.attributes};if(dataElement.originalDomElementsHash!==undefined){hash.originalDomElementsHash=dataElement.originalDomElementsHash;}return hash;};ve.dm.Model.static.getMatchRdfaTypes=function(){return this.matchRdfaTypes;};ve.dm.Model.static.getAllowedRdfaTypes=function(){return this.allowedRdfaTypes;};ve.dm.Model.static.describeChanges=function(attributeChanges){var descriptions=[];for(var key in attributeChanges){var change=this.describeChange(key,attributeChanges[key]);if(change){descriptions.push(change);}}return descriptions;};ve.dm.Model.static.describeChange=function(key,change){if((typeof change.from==='object'&&change.from!==null)||(typeof change.to==='object'&&change.to!==null)){return ve.htmlMsg('visualeditor-changedesc-unknown',key);}else if(change.from===undefined||change.from===null){return ve.htmlMsg('visualeditor-changedesc-set',key,
this.wrapText('ins',change.to));}else if(change.to===undefined||change.to===null){return ve.htmlMsg('visualeditor-changedesc-unset',key,this.wrapText('del',change.from));}else if(key==='listItemDepth'){if(change.to>change.from){return ve.msg('visualeditor-changedesc-list-indent');}else if(change.to<change.from){return ve.msg('visualeditor-changedesc-list-outdent');}}else{var diff=this.getAttributeDiff(String(change.from),String(change.to));if(diff){return ve.htmlMsg('visualeditor-changedesc-changed-diff',key,diff);}else{return ve.htmlMsg('visualeditor-changedesc-changed',key,this.wrapText('del',change.from),this.wrapText('ins',change.to));}}};ve.dm.Model.static.getAttributeDiff=function(oldText,newText,allowRemoveInsert){var span=document.createElement('span'),isRemoveInsert=true,model=this,differ=new diff_match_patch();var diff=differ.diff_main(oldText,newText);differ.diff_cleanupEfficiency(diff);diff.forEach(function(part){switch(part[0]){case-1:span.appendChild(model.wrapText('del',
part[1]));break;case 1:span.appendChild(model.wrapText('ins',part[1]));break;case 0:isRemoveInsert=false;span.appendChild(document.createTextNode(part[1]));break;}});return!isRemoveInsert||allowRemoveInsert?span:null;};ve.dm.Model.static.wrapText=function(tag,text){var wrapper=document.createElement(tag);wrapper.appendChild(document.createTextNode(text));return wrapper;};ve.dm.Model.static.isDiffComparable=function(element,other){return element.type===other.type;};ve.dm.Model.prototype.isInspectable=function(){return true;};ve.dm.Model.prototype.isEditable=function(){return true;};ve.dm.Model.prototype.getElement=function(){return this.element;};ve.dm.Model.prototype.getStore=function(){return this.store;};ve.dm.Model.prototype.getType=function(){return this.constructor.static.name;};ve.dm.Model.prototype.getAttribute=function(key){return this.element&&this.element.attributes?this.element.attributes[key]:undefined;};ve.dm.Model.prototype.getAttributes=function(prefix){var attributes=
this.element&&this.element.attributes?this.element.attributes:{};if(prefix){var filtered={};for(var key in attributes){if(key.indexOf(prefix)===0){filtered[key.slice(prefix.length)]=attributes[key];}}return filtered;}return ve.extendObject({},attributes);};ve.dm.Model.prototype.getOriginalDomElementsHash=function(){return this.element?this.element.originalDomElementsHash:undefined;};ve.dm.Model.prototype.getOriginalDomElements=function(store){return store.value(this.getOriginalDomElementsHash())||[];};ve.dm.Model.prototype.getClonedElement=function(){return ve.copy(this.element);};ve.dm.Model.prototype.getHashObject=function(){return this.constructor.static.getHashObject(this.element);};ve.dm.Model.prototype.isDiffComparable=function(other){return this.constructor.static.isDiffComparable(this.element,other.element,this.getStore(),other.getStore());};(function(ve){ve.dm.ModelRegistry=function VeDmModelRegistry(){OO.Registry.call(this);this.modelsByTag=[{},{}];this.modelsByTypeAndTag=[];
this.modelsWithTypeRegExps=[[],[]];this.registrationOrder={};this.nextNumber=0;this.extSpecificTypes=[];};OO.inheritClass(ve.dm.ModelRegistry,OO.Registry);function addType(obj){var keys=Array.prototype.slice.call(arguments,1,-1),value=arguments[arguments.length-1],o=obj;var i,len;for(i=0,len=keys.length-1;i<len;i++){if(o[keys[i]]===undefined){o[keys[i]]={};}o=o[keys[i]];}o[keys[i]]=o[keys[i]]||[];o[keys[i]].unshift(value);}function removeType(obj){var keys=Array.prototype.slice.call(arguments,1,-1),value=arguments[arguments.length-1],arr=ve.getProp.apply(obj,[obj].concat(keys));if(arr){var index=arr.indexOf(value);if(index!==-1){arr.splice(index,1);}}}ve.dm.ModelRegistry.prototype.register=function(constructor){var name=constructor.static&&constructor.static.name;if(typeof name!=='string'||name===''){throw new Error('Model names must be strings and must not be empty');}if(!(constructor.prototype instanceof ve.dm.Model)){throw new Error('Models must be subclasses of ve.dm.Model');}if(
this.lookup(name)===constructor){return;}if(constructor.prototype instanceof ve.dm.Annotation){ve.dm.annotationFactory.register(constructor);}else if(constructor.prototype instanceof ve.dm.Node){ve.dm.nodeFactory.register(constructor);}else{throw new Error('No factory associated with this ve.dm.Model subclass');}ve.dm.ModelRegistry.super.prototype.register.call(this,name,constructor);var tags=constructor.static.matchTagNames===null?['']:constructor.static.matchTagNames;var types=constructor.static.getMatchRdfaTypes()===null?['']:constructor.static.getMatchRdfaTypes();var i;for(i=0;i<tags.length;i++){addType(this.modelsByTag,+!!constructor.static.matchFunction,tags[i],name);}for(i=0;i<types.length;i++){if(types[i]instanceof RegExp){addType(this.modelsWithTypeRegExps,+!!constructor.static.matchFunction,name);}else{for(var j=0;j<tags.length;j++){addType(this.modelsByTypeAndTag,+!!constructor.static.matchFunction,types[i],tags[j],name);}}}this.registrationOrder[name]=this.nextNumber++;};ve
.dm.ModelRegistry.prototype.unregister=function(constructor){var name=constructor.static&&constructor.static.name;if(typeof name!=='string'||name===''){throw new Error('Model names must be strings and must not be empty');}if(!(constructor.prototype instanceof ve.dm.Model)){throw new Error('Models must be subclasses of ve.dm.Model');}if(constructor.prototype instanceof ve.dm.Annotation){ve.dm.annotationFactory.unregister(constructor);}else if(constructor.prototype instanceof ve.dm.Node){ve.dm.nodeFactory.unregister(constructor);}else{throw new Error('No factory associated with this ve.dm.Model subclass');}ve.dm.ModelRegistry.super.prototype.unregister.call(this,name);var tags=constructor.static.matchTagNames===null?['']:constructor.static.matchTagNames;var types=constructor.static.getMatchRdfaTypes()===null?['']:constructor.static.getMatchRdfaTypes();var i;for(i=0;i<tags.length;i++){removeType(this.modelsByTag,+!!constructor.static.matchFunction,tags[i],name);}for(i=0;i<types.length;i++
){if(types[i]instanceof RegExp){removeType(this.modelsWithTypeRegExps,+!!constructor.static.matchFunction,name);}else{for(var j=0;j<tags.length;j++){removeType(this.modelsByTypeAndTag,+!!constructor.static.matchFunction,types[i],tags[j],name);}}}delete this.registrationOrder[name];};ve.dm.ModelRegistry.prototype.matchElement=function(node,forceAboutGrouping,excludeTypes){var types,nodeName=node.nodeName.toLowerCase(),reg=this;function byRegistrationOrderDesc(a,b){return reg.registrationOrder[b]-reg.registrationOrder[a];}function matchTypeRegExps(type,tag,withFunc){var matchedModels=[],models=reg.modelsWithTypeRegExps[+withFunc];for(var j=0;j<models.length;j++){if(excludeTypes&&excludeTypes.indexOf(models[j])!==-1){continue;}var matchTypes=reg.registry[models[j]].static.getMatchRdfaTypes();for(var k=0;k<matchTypes.length;k++){if(matchTypes[k]instanceof RegExp&&matchTypes[k].test(type)&&((tag===''&&reg.registry[models[j]].static.matchTagNames===null)||(reg.registry[models[j]].static.
matchTagNames||[]).indexOf(tag)!==-1)){matchedModels.push(models[j]);}}}return matchedModels;}function allTypesAllowed(model){var allowedTypes=model.static.getAllowedRdfaTypes();var matchTypes=model.static.getMatchRdfaTypes();if(allowedTypes===null){return true;}if(matchTypes!==null){allowedTypes=allowedTypes.concat(matchTypes);}function checkType(rule,type){return rule instanceof RegExp?rule.test(type):rule===type;}for(var j=0;j<types.length;j++){var typeAllowed=false;for(var k=0;k<allowedTypes.length;k++){if(checkType(allowedTypes[k],types[j])){typeAllowed=true;break;}}if(!typeAllowed){return false;}}return true;}function matchWithFunc(tag){var queue=[],queue2=[];var j;for(j=0;j<types.length;j++){queue=queue.concat(ve.getProp(reg.modelsByTypeAndTag,1,types[j],tag)||[]);if(excludeTypes){queue=OO.simpleArrayDifference(queue,excludeTypes);}queue2=queue2.concat(matchTypeRegExps(types[j],tag,true));}queue=queue.filter(function(name){return allTypesAllowed(reg.lookup(name));});queue2=
queue2.filter(function(name){return allTypesAllowed(reg.lookup(name));});if(forceAboutGrouping){queue=queue.filter(function(name){return reg.registry[name].static.enableAboutGrouping;});queue2=queue2.filter(function(name){return reg.registry[name].static.enableAboutGrouping;});}queue.sort(byRegistrationOrderDesc);queue2.sort(byRegistrationOrderDesc);queue=queue.concat(queue2);for(j=0;j<queue.length;j++){if(reg.registry[queue[j]].static.matchFunction(node)){return queue[j];}}return null;}function matchWithoutFunc(tag){var queue=[],queue2=[],winningName=null;var j;for(j=0;j<types.length;j++){queue=queue.concat(ve.getProp(reg.modelsByTypeAndTag,0,types[j],tag)||[]);if(excludeTypes){queue=OO.simpleArrayDifference(queue,excludeTypes);}queue2=queue2.concat(matchTypeRegExps(types[j],tag,false));}queue=queue.filter(function(name){return allTypesAllowed(reg.lookup(name));});queue2=queue2.filter(function(name){return allTypesAllowed(reg.lookup(name));});if(forceAboutGrouping){queue=queue.filter(
function(name){return reg.registry[name].static.enableAboutGrouping;});queue2=queue2.filter(function(name){return reg.registry[name].static.enableAboutGrouping;});}queue=queue.length>0?queue:queue2;for(j=0;j<queue.length;j++){if(winningName===null||reg.registrationOrder[winningName]<reg.registrationOrder[queue[j]]){winningName=queue[j];}}return winningName;}types=[];if(node.getAttribute){if(node.getAttribute('rel')){types=types.concat(node.getAttribute('rel').trim().split(/\s+/));}if(node.getAttribute('typeof')){types=types.concat(node.getAttribute('typeof').trim().split(/\s+/));}if(node.getAttribute('property')){types=types.concat(node.getAttribute('property').trim().split(/\s+/));}}var winner;if(types.length){winner=matchWithFunc(nodeName);if(winner!==null){return winner;}winner=matchWithFunc('');if(winner!==null){return winner;}}var matches=ve.getProp(this.modelsByTag,1,nodeName)||[];var i;var m;for(i=0;i<matches.length;i++){m=this.registry[matches[i]];if(m.static.getMatchRdfaTypes(
)===null&&m.static.matchFunction(node)&&allTypesAllowed(m)){return matches[i];}}matches=ve.getProp(this.modelsByTypeAndTag,1,'','')||[];for(i=0;i<matches.length;i++){m=this.registry[matches[i]];if(m.static.matchFunction(node)&&allTypesAllowed(m)){return matches[i];}}winner=matchWithoutFunc(nodeName);if(winner!==null){return winner;}winner=matchWithoutFunc('');if(winner!==null){return winner;}matches=ve.getProp(this.modelsByTag,0,nodeName)||[];for(i=0;i<matches.length;i++){m=this.registry[matches[i]];if(m.static.getMatchRdfaTypes()===null&&allTypesAllowed(m)){return matches[i];}}matches=ve.getProp(this.modelsByTypeAndTag,0,'','')||[];for(i=0;i<matches.length;i++){m=this.registry[matches[i]];if(allTypesAllowed(m)){return matches[i];}}return null;};ve.dm.ModelRegistry.prototype.isAnnotation=function(node){var modelClass=this.lookup(this.matchElement(node));return(modelClass&&modelClass.prototype)instanceof ve.dm.Annotation;};ve.dm.modelRegistry=new ve.dm.ModelRegistry();}(ve));ve.dm.
ModelFactory=function VeDmModelFactory(){ve.dm.ModelFactory.super.call(this);};OO.inheritClass(ve.dm.ModelFactory,OO.Factory);ve.dm.ModelFactory.prototype.createFromElement=function(element){if(element&&element.type){return this.create.apply(this,Array.prototype.concat.apply([element.type],arguments));}throw new Error('Element must have a .type property');};ve.dm.NodeFactory=function VeDmNodeFactory(){ve.dm.NodeFactory.super.call(this);};OO.inheritClass(ve.dm.NodeFactory,ve.dm.ModelFactory);ve.dm.NodeFactory.prototype.getDataElement=function(type,attributes){var element={type:type};if(Object.prototype.hasOwnProperty.call(this.registry,type)){attributes=ve.extendObject({},this.registry[type].static.defaultAttributes,attributes);if(!ve.isEmptyObject(attributes)){element.attributes=ve.copy(attributes);}return element;}throw new Error('Unknown node type: '+type);};ve.dm.NodeFactory.prototype.getChildNodeTypes=function(type){if(Object.prototype.hasOwnProperty.call(this.registry,type)){
return this.registry[type].static.childNodeTypes;}throw new Error('Unknown node type: '+type);};ve.dm.NodeFactory.prototype.getParentNodeTypes=function(type){if(Object.prototype.hasOwnProperty.call(this.registry,type)){return this.registry[type].static.parentNodeTypes;}throw new Error('Unknown node type: '+type);};ve.dm.NodeFactory.prototype.getSuggestedParentNodeTypes=function(type){if(Object.prototype.hasOwnProperty.call(this.registry,type)){return this.registry[type].static.suggestedParentNodeTypes;}throw new Error('Unknown node type: '+type);};ve.dm.NodeFactory.prototype.canNodeHaveChildren=function(type){if(Object.prototype.hasOwnProperty.call(this.registry,type)){var types=this.registry[type].static.childNodeTypes;return types===null||(Array.isArray(types)&&types.length>0);}throw new Error('Unknown node type: '+type);};ve.dm.NodeFactory.prototype.canNodeHaveChildrenNotContent=function(type){if(Object.prototype.hasOwnProperty.call(this.registry,type)){return this.
canNodeHaveChildren(type)&&!this.registry[type].static.canContainContent&&!this.registry[type].static.isContent;}throw new Error('Unknown node type: '+type);};ve.dm.NodeFactory.prototype.isNodeWrapped=function(type){if(Object.prototype.hasOwnProperty.call(this.registry,type)){return this.registry[type].static.isWrapped;}throw new Error('Unknown node type: '+type);};ve.dm.NodeFactory.prototype.isNodeUnwrappable=function(type){if(Object.prototype.hasOwnProperty.call(this.registry,type)){return this.isNodeWrapped(type)&&this.registry[type].static.isUnwrappable;}throw new Error('Unknown node type: '+type);};ve.dm.NodeFactory.prototype.isMetaData=function(type){if(Object.prototype.hasOwnProperty.call(this.registry,type)){return this.registry[type].static.isMetaData;}throw new Error('Unknown node type: '+type);};ve.dm.NodeFactory.prototype.isRemovableMetaData=function(type){if(Object.prototype.hasOwnProperty.call(this.registry,type)){return this.registry[type].static.removable;}throw new
Error('Unknown item type: '+type);};ve.dm.NodeFactory.prototype.canNodeContainContent=function(type){if(Object.prototype.hasOwnProperty.call(this.registry,type)){return this.registry[type].static.canContainContent;}throw new Error('Unknown node type: '+type);};ve.dm.NodeFactory.prototype.canNodeTakeAnnotation=function(type,annotation){if(!Object.prototype.hasOwnProperty.call(this.registry,type)){throw new Error('Unknown node type: '+type);}var disallowedList=this.registry[type].static.disallowedAnnotationTypes;for(var i=0,len=disallowedList.length;i<len;i++){if(annotation instanceof ve.dm.annotationFactory.lookup(disallowedList[i])){return false;}}return true;};ve.dm.NodeFactory.prototype.isNodeContent=function(type){if(Object.prototype.hasOwnProperty.call(this.registry,type)){return this.registry[type].static.isContent;}throw new Error('Unknown node type: '+type);};ve.dm.NodeFactory.prototype.canNodeSerializeAsContent=function(type){if(Object.prototype.hasOwnProperty.call(this.
registry,type)){return this.registry[type].static.isContent||this.registry[type].static.canSerializeAsContent;}throw new Error('Unknown node type: '+type);};ve.dm.NodeFactory.prototype.isNodeFocusable=function(type){if(Object.prototype.hasOwnProperty.call(this.registry,type)){return this.registry[type].static.isFocusable;}throw new Error('Unknown node type: '+type);};ve.dm.NodeFactory.prototype.doesNodeHaveSignificantWhitespace=function(type){if(Object.prototype.hasOwnProperty.call(this.registry,type)){return this.registry[type].static.hasSignificantWhitespace;}throw new Error('Unknown node type: '+type);};ve.dm.NodeFactory.prototype.doesNodeHandleOwnChildren=function(type){if(Object.prototype.hasOwnProperty.call(this.registry,type)){return this.registry[type].static.handlesOwnChildren;}throw new Error('Unknown node type: '+type);};ve.dm.NodeFactory.prototype.shouldIgnoreChildren=function(type){if(Object.prototype.hasOwnProperty.call(this.registry,type)){return this.registry[type].
static.ignoreChildren;}throw new Error('Unknown node type: '+type);};ve.dm.NodeFactory.prototype.isNodeInternal=function(type){if(Object.prototype.hasOwnProperty.call(this.registry,type)){return this.registry[type].static.isInternal;}throw new Error('Unknown node type: '+type);};ve.dm.NodeFactory.prototype.isNodeDeletable=function(type){if(Object.prototype.hasOwnProperty.call(this.registry,type)){return this.registry[type].static.isDeletable;}throw new Error('Unknown node type: '+type);};ve.dm.nodeFactory=new ve.dm.NodeFactory();ve.dm.AnnotationFactory=function VeDmAnnotationFactory(){ve.dm.AnnotationFactory.super.call(this);};OO.inheritClass(ve.dm.AnnotationFactory,ve.dm.ModelFactory);ve.dm.annotationFactory=new ve.dm.AnnotationFactory();ve.dm.AnnotationSet=function VeDmAnnotationSet(store,storeHashes){this.store=store;this.storeHashes=storeHashes||[];if(this.get().indexOf(undefined)!==-1){throw new Error('Annotation with hash '+this.storeHashes[this.get().indexOf(undefined)]+
' not found in store');}};ve.dm.AnnotationSet.prototype.getStore=function(){return this.store;};ve.dm.AnnotationSet.prototype.clone=function(){return new ve.dm.AnnotationSet(this.getStore(),this.storeHashes.slice());};ve.dm.AnnotationSet.prototype.getAnnotationsByName=function(name){return this.filter(function(annotation){return annotation.name===name;});};ve.dm.AnnotationSet.prototype.getComparableAnnotations=function(annotation){return this.filter(function(a){return ve.compare(annotation.getComparableObject(),a.getComparableObject());});};ve.dm.AnnotationSet.prototype.getComparableAnnotationsFromSet=function(annotations){return this.filter(function(a){return annotations.containsComparable(a);});};ve.dm.AnnotationSet.prototype.hasAnnotationWithName=function(name){return this.containsMatching(function(annotation){return annotation.name===name;});};ve.dm.AnnotationSet.prototype.get=function(offset){if(offset!==undefined){return this.getStore().value(this.getHash(offset));}else{return this
.getStore().values(this.getHashes());}};ve.dm.AnnotationSet.prototype.getHash=function(offset){return this.storeHashes[offset];};ve.dm.AnnotationSet.prototype.getHashes=function(){return this.storeHashes;};ve.dm.AnnotationSet.prototype.getLength=function(){return this.storeHashes.length;};ve.dm.AnnotationSet.prototype.isEmpty=function(){return this.getLength()===0;};ve.dm.AnnotationSet.prototype.contains=function(annotation){return this.offsetOf(annotation)!==-1;};ve.dm.AnnotationSet.prototype.containsHash=function(storeHash){return this.getHashes().indexOf(storeHash)!==-1;};ve.dm.AnnotationSet.prototype.containsAnyOf=function(set){var setHashes=set.getHashes(),thisHashes=this.getHashes();for(var i=0,length=setHashes.length;i<length;i++){if(thisHashes.indexOf(setHashes[i])!==-1){return true;}}return false;};ve.dm.AnnotationSet.prototype.containsAllOf=function(set){var setHashes=set.getHashes(),thisHashes=this.getHashes();for(var i=0,length=setHashes.length;i<length;i++){if(thisHashes.
indexOf(setHashes[i])===-1){return false;}}return true;};ve.dm.AnnotationSet.prototype.offsetOf=function(annotation){return this.offsetOfHash(this.getStore().hashOfValue(annotation));};ve.dm.AnnotationSet.prototype.offsetOfHash=function(storeHash){return this.getHashes().indexOf(storeHash);};ve.dm.AnnotationSet.prototype.filter=function(callback,returnBool){var result;if(!returnBool){result=this.clone();result.removeAll();}for(var i=0,length=this.getLength();i<length;i++){var storeHash=this.getHash(i);var annotation=this.getStore().value(storeHash);if(callback(annotation)){if(returnBool){return true;}else{result.storeHashes.push(storeHash);}}}return returnBool?false:result;};ve.dm.AnnotationSet.prototype.containsComparable=function(annotation){return this.filter(function(a){return annotation.compareTo(a);},true);};ve.dm.AnnotationSet.prototype.getComparable=function(annotation){for(var i=0,len=this.getLength();i<len;i++){var ann=this.getStore().value(this.getHash(i));if(ann.compareTo(
annotation)){return ann;}}return null;};ve.dm.AnnotationSet.prototype.containsComparableForSerialization=function(annotation){return this.filter(function(a){return annotation.compareToForSerialization(a);},true);};ve.dm.AnnotationSet.prototype.containsMatching=function(callback){return this.filter(callback,true);};ve.dm.AnnotationSet.prototype.compareTo=function(annotationSet){var length=this.getHashes().length;if(length===annotationSet.getLength()){for(var i=0;i<length;i++){if(!annotationSet.containsComparable(this.get(i))){return false;}}}else{return false;}return true;};ve.dm.AnnotationSet.prototype.withoutComparableSet=function(set){return this.filter(function(annotation){return!set.containsComparable(annotation);});};ve.dm.AnnotationSet.prototype.equalsInOrder=function(set){var ourHashes=this.getHashes(),theirHashes=set.getHashes();if(ourHashes.length!==theirHashes.length){return false;}for(var i=0,len=ourHashes.length;i<len;i++){if(ourHashes[i]!==theirHashes[i]){return false;}}
return true;};ve.dm.AnnotationSet.prototype.add=function(annotation,offset){var storeHash=this.getStore().hash(annotation);if(offset<0){offset=this.getLength()+offset;}if(offset>=this.getLength()){this.push(annotation);return;}if(!this.containsHash(storeHash)){this.storeHashes.splice(offset,0,storeHash);}};ve.dm.AnnotationSet.prototype.addSet=function(set,offset){var hashes=this.getHashes();if(offset===undefined){offset=hashes.length;}this.storeHashes=OO.simpleArrayUnion(hashes.slice(0,offset),set.getHashes(),hashes.slice(offset));};ve.dm.AnnotationSet.prototype.push=function(annotation){this.pushHash(this.getStore().hash(annotation));};ve.dm.AnnotationSet.prototype.pushHash=function(storeHash){this.storeHashes.push(storeHash);};ve.dm.AnnotationSet.prototype.removeAt=function(offset){if(offset<0){offset=this.getLength()+offset;}if(offset>=this.getLength()){throw new Error('Offset out of bounds');}this.storeHashes.splice(offset,1);};ve.dm.AnnotationSet.prototype.removeHash=function(
storeHash){var offset=this.offsetOfHash(storeHash);if(offset!==-1){this.storeHashes.splice(offset,1);}};ve.dm.AnnotationSet.prototype.remove=function(annotation){var offset=this.offsetOf(annotation);if(offset!==-1){this.storeHashes.splice(offset,1);}};ve.dm.AnnotationSet.prototype.removeAll=function(){this.storeHashes=[];};ve.dm.AnnotationSet.prototype.removeSet=function(set){this.storeHashes=OO.simpleArrayDifference(this.getHashes(),set.getHashes());};ve.dm.AnnotationSet.prototype.removeNotInSet=function(set){this.storeHashes=OO.simpleArrayIntersection(this.getHashes(),set.getHashes());};ve.dm.AnnotationSet.prototype.reversed=function(){var newSet=this.clone();newSet.storeHashes.reverse();return newSet;};ve.dm.AnnotationSet.prototype.mergeWith=function(set){var newSet=this.clone();newSet.addSet(set);return newSet;};ve.dm.AnnotationSet.prototype.diffWith=function(set){var newSet=this.clone();newSet.removeSet(set);return newSet;};ve.dm.AnnotationSet.prototype.intersectWith=function(set)
{var newSet=this.clone();newSet.removeNotInSet(set);return newSet;};ve.dm.Node=function VeDmNode(element){ve.dm.Node.super.apply(this,arguments);ve.Node.call(this);OO.EventEmitter.call(this);this.length=0;this.offset=null;this.element=element;};OO.inheritClass(ve.dm.Node,ve.dm.Model);OO.mixinClass(ve.dm.Node,ve.Node);OO.mixinClass(ve.dm.Node,OO.EventEmitter);ve.dm.Node.static.handlesOwnChildren=false;ve.dm.Node.static.ignoreChildren=false;ve.dm.Node.static.isDeletable=true;ve.dm.Node.static.isInternal=false;ve.dm.Node.static.isWrapped=true;ve.dm.Node.static.isUnwrappable=true;ve.dm.Node.static.isContent=false;ve.dm.Node.static.isMetaData=false;ve.dm.Node.static.canSerializeAsContent=false;ve.dm.Node.static.isFocusable=false;ve.dm.Node.static.isAlignable=false;ve.dm.Node.static.isCellable=false;ve.dm.Node.static.canContainContent=false;ve.dm.Node.static.isDiffedAsList=false;ve.dm.Node.static.isDiffedAsLeaf=false;ve.dm.Node.static.hasSignificantWhitespace=false;ve.dm.Node.static.
childNodeTypes=null;ve.dm.Node.static.parentNodeTypes=null;ve.dm.Node.static.suggestedParentNodeTypes=null;ve.dm.Node.static.disallowedAnnotationTypes=[];ve.dm.Node.static.defaultAttributes={};ve.dm.Node.static.sanitize=function(){};ve.dm.Node.static.remapInternalListIndexes=function(){};ve.dm.Node.static.remapInternalListKeys=function(){};ve.dm.Node.static.isHybridInline=function(domElements,converter){var allTagsInline=true;for(var i=0,length=domElements.length;i<length;i++){if(ve.isBlockElement(domElements[i])){allTagsInline=false;break;}}return(converter.isExpectingContent()&&!converter.isInWrapper())||(converter.isInWrapper()&&!converter.canCloseWrapper())||allTagsInline;};ve.dm.Node.static.cloneElement=function(element,store,preserveGenerated){var modified=false,clone=ve.copy(element);if(!preserveGenerated){ve.deleteProp(clone,'internal','generated');}var originalDomElements=store.value(clone.originalDomElementsHash);if(originalDomElements){var about='#mwt'+Math.floor(1000000000*
Math.random());var domElements=originalDomElements.map(function(el){var elClone=el.cloneNode(true);if(elClone.hasAttribute&&elClone.hasAttribute('about')){elClone.setAttribute('about',about);modified=true;}return elClone;});if(modified){clone.originalDomElementsHash=store.hash(domElements,domElements.map(ve.getNodeHtml).join(''));}}return clone;};ve.dm.Node.prototype.getStore=function(){return this.doc&&this.doc.store;};ve.dm.Node.prototype.getClonedElement=function(preserveGenerated){var store=this.getStore();if(!store){throw new Error('Node must be attached to the document to be cloned.');}return this.constructor.static.cloneElement(this.element,store,preserveGenerated);};ve.dm.Node.prototype.getChildNodeTypes=function(){return this.constructor.static.childNodeTypes;};ve.dm.Node.prototype.getParentNodeTypes=function(){return this.constructor.static.parentNodeTypes;};ve.dm.Node.prototype.getSuggestedParentNodeTypes=function(){return this.constructor.static.suggestedParentNodeTypes;};
ve.dm.Node.prototype.canHaveChildren=function(){return ve.dm.nodeFactory.canNodeHaveChildren(this.type);};ve.dm.Node.prototype.canHaveChildrenNotContent=function(){return ve.dm.nodeFactory.canNodeHaveChildrenNotContent(this.type);};ve.dm.Node.prototype.isInternal=function(){return this.constructor.static.isInternal;};ve.dm.Node.prototype.isMetaData=function(){return this.constructor.static.isMetaData;};ve.dm.Node.prototype.isWrapped=function(){return this.constructor.static.isWrapped;};ve.dm.Node.prototype.isUnwrappable=function(){return this.isWrapped()&&this.constructor.static.isUnwrappable;};ve.dm.Node.prototype.canContainContent=function(){return this.constructor.static.canContainContent;};ve.dm.Node.prototype.isContent=function(){return this.constructor.static.isContent;};ve.dm.Node.prototype.isFocusable=function(){return this.constructor.static.isFocusable;};ve.dm.Node.prototype.isAlignable=function(){return this.constructor.static.isAlignable;};ve.dm.Node.prototype.isCellable=
function(){return this.constructor.static.isCellable;};ve.dm.Node.prototype.isCellEditable=function(){return this.constructor.static.isCellEditable;};ve.dm.Node.prototype.isDiffedAsList=function(){return this.constructor.static.isDiffedAsList;};ve.dm.Node.prototype.isDiffedAsLeaf=function(){return this.constructor.static.isDiffedAsLeaf;};ve.dm.Node.prototype.isDiffedAsDocument=function(){return this.getChildNodeTypes()===null;};ve.dm.Node.prototype.canHaveSlugBefore=function(){return!this.canContainContent()&&this.getParentNodeTypes()===null;};ve.dm.Node.prototype.canHaveSlugAfter=ve.dm.Node.prototype.canHaveSlugBefore;ve.dm.Node.prototype.suppressSlugType=function(){return null;};ve.dm.Node.prototype.hasSignificantWhitespace=function(){return this.constructor.static.hasSignificantWhitespace;};ve.dm.Node.prototype.handlesOwnChildren=function(){return this.constructor.static.handlesOwnChildren;};ve.dm.Node.prototype.shouldIgnoreChildren=function(){return this.constructor.static.
ignoreChildren;};ve.dm.Node.prototype.isSurfaceable=function(){return this.hasChildren()&&!this.canContainContent()&&!this.isMetaData()&&!this.getChildNodeTypes();};ve.dm.Node.prototype.findMatchingAncestor=function(type,attributes){return this.traverseUpstream(function(node){return!node.matches(type,attributes);});};ve.dm.Node.prototype.hasMatchingAncestor=function(type,attributes){return!!this.findMatchingAncestor(type,attributes);};ve.dm.Node.prototype.matches=function(type,attributes){if(this.getType()!==type){return false;}if(attributes){return this.compareAttributes(attributes);}return true;};ve.dm.Node.prototype.compareAttributes=function(attributes){for(var key in attributes){if(this.getAttribute(key)!==attributes[key]){return false;}}return true;};ve.dm.Node.prototype.getLength=function(){return this.length;};ve.dm.Node.prototype.setLength=function(length){if(length<0){throw new Error('Length cannot be negative');}var diff=length-this.length;this.length=length;if(this.parent){
this.parent.adjustLength(diff);}this.emit('lengthChange',diff);this.emit('update');};ve.dm.Node.prototype.adjustLength=function(adjustment){this.setLength(this.length+adjustment);};ve.dm.Node.prototype.getOffset=function(){if(!this.parent){return 0;}if(this.doc.isReadOnly()&&this.offset!==null){return this.offset;}var siblings=this.parent.children;var offset=this.parent.getOffset()+(this.parent===this.root?0:1);var i,len;for(i=0,len=siblings.length;i<len;i++){if(siblings[i]===this){break;}offset+=siblings[i].getOuterLength();}if(i===len){throw new Error('Node not found in parent\'s children array');}if(this.doc.isReadOnly()){this.offset=offset;}return offset;};ve.dm.Node.prototype.canBeMergedWith=function(node){var n1=this,n2=node;if(n1.canContainContent()&&n2.isContent()){n2=n2.getParent();}else if(n2.canContainContent()&&n1.isContent()){n1=n1.getParent();}while(n1!==n2){if((n1===null||n2===null)||n1.getType()!==n2.getType()){return false;}n1=n1.getParent();n2=n2.getParent();}return true
;};ve.dm.ClassAttributeNode=function VeDmClassAttributeNode(){};OO.initClass(ve.dm.ClassAttributeNode);ve.dm.ClassAttributeNode.static.classAttributes={};ve.dm.ClassAttributeNode.static.preserveHtmlAttributes=function(attribute){return attribute!=='class';};ve.dm.ClassAttributeNode.static.setClassAttributes=function(attributes,classAttr){var classNames=classAttr?classAttr.trim().split(/\s+/):[];if(!classNames.length){return;}var unrecognizedClasses=[];for(var i=0,l=classNames.length;i<l;i++){var className=classNames[i];if(Object.prototype.hasOwnProperty.call(this.classAttributes,className)){attributes=ve.extendObject(attributes,this.classAttributes[className]);}else{unrecognizedClasses.push(className);}}attributes.originalClasses=classAttr;attributes.unrecognizedClasses=unrecognizedClasses;};ve.dm.ClassAttributeNode.static.getClassAttrFromAttributes=function(attributes){attributes=attributes||{};var classNames=[];for(var className in this.classAttributes){var classAttributeSet=this.
classAttributes[className];var hasClass=true;for(var key in classAttributeSet){if(attributes[key]!==classAttributeSet[key]){hasClass=false;break;}}if(hasClass){classNames.push(className);}}if(attributes.unrecognizedClasses){classNames=OO.simpleArrayUnion(classNames,attributes.unrecognizedClasses);}if(attributes.originalClasses&&ve.compareClassLists(attributes.originalClasses,classNames)){return attributes.originalClasses;}else if(classNames.length>0){return classNames.join(' ');}return null;};ve.dm.ClassAttributeNode.static.sanitize=function(dataElement){if(dataElement.attributes){delete dataElement.attributes.unrecognizedClasses;}};ve.dm.AlignableNode=function VeDmAlignableNode(){ve.dm.AlignableNode.super.apply(this,arguments);};OO.inheritClass(ve.dm.AlignableNode,ve.dm.ClassAttributeNode);ve.dm.AlignableNode.static.isAlignable=true;ve.dm.AlignableNode.static.classAttributes={'ve-align-left':{align:'left'},'ve-align-right':{align:'right'},'ve-align-center':{align:'center'}};ve.dm.
FocusableNode=function VeDmFocusableNode(){};OO.initClass(ve.dm.FocusableNode);ve.dm.FocusableNode.static.isFocusable=true;ve.dm.ResizableNode=function VeDmResizableNode(){this.scalable=null;this.connect(this,{attributeChange:'onResizableAttributeChange'});};OO.initClass(ve.dm.ResizableNode);ve.dm.ResizableNode.prototype.getScalable=function(){if(!this.scalable){this.scalable=this.createScalable();}return this.scalable;};ve.dm.ResizableNode.prototype.createScalable=null;ve.dm.ResizableNode.prototype.onResizableAttributeChange=function(key){if(key==='width'||key==='height'){this.getScalable().setCurrentDimensions(this.getCurrentDimensions());}};ve.dm.ResizableNode.prototype.getCurrentDimensions=function(){return{width:this.getAttribute('width'),height:this.getAttribute('height')};};ve.dm.TableCellableNode=function VeDmTableCellableNode(){this.connect(this,{attributeChange:'onCellableAttributeChange'});};OO.initClass(ve.dm.TableCellableNode);ve.dm.TableCellableNode.static.isCellable=true
;ve.dm.TableCellableNode.static.setAttributes=function(attributes,domElements){var style=domElements[0].nodeName.toLowerCase()==='th'?'header':'data',colspan=domElements[0].getAttribute('colspan'),rowspan=domElements[0].getAttribute('rowspan');attributes.style=style;if(colspan!==null){attributes.originalColspan=colspan;if(colspan!==''&&!isNaN(Number(colspan))){attributes.colspan=Number(colspan);}}if(rowspan!==null){attributes.originalRowspan=rowspan;if(rowspan!==''&&!isNaN(Number(rowspan))){attributes.rowspan=Number(rowspan);}}};ve.dm.TableCellableNode.static.applyAttributes=function(attributes,domElement){var spans={colspan:attributes.colspan,rowspan:attributes.rowspan};if(attributes.colspan===1&&Number(attributes.originalColspan)!==1){spans.colspan=null;}if(attributes.rowspan===1&&Number(attributes.originalRowspan)!==1){spans.rowspan=null;}if(attributes.colspan===undefined||attributes.colspan===Number(attributes.originalColspan)){spans.colspan=attributes.originalColspan;}if(
attributes.rowspan===undefined||attributes.rowspan===Number(attributes.originalRowspan)){spans.rowspan=attributes.originalRowspan;}ve.setDomAttributes(domElement,spans);};ve.dm.TableCellableNode.prototype.getRowspan=function(){return this.element.attributes.rowspan||1;};ve.dm.TableCellableNode.prototype.getColspan=function(){return this.element.attributes.colspan||1;};ve.dm.TableCellableNode.prototype.getSpans=function(){return{col:this.getColspan(),row:this.getRowspan()};};ve.dm.TableCellableNode.prototype.getStyle=function(){return this.element.attributes.style||'data';};ve.dm.TableCellableNode.prototype.onCellableAttributeChange=function(key){if(this.getParent()&&(key==='colspan'||key==='rowspan')){this.findParent(ve.dm.TableNode).getMatrix().invalidate();}};ve.dm.Scalable=function VeDmScalable(config){config=ve.extendObject({fixedRatio:true,enforceMin:true,enforceMax:true},config);OO.EventEmitter.call(this);this.ratio=null;this.valid=null;this.defaultSize=false;this.
currentDimensions=null;this.defaultDimensions=null;this.originalDimensions=null;this.minDimensions=null;this.maxDimensions=null;this.fixedRatio=config.fixedRatio;if(config.currentDimensions){this.setCurrentDimensions(config.currentDimensions);}if(config.originalDimensions){this.setOriginalDimensions(config.originalDimensions);}if(config.defaultDimensions){this.setDefaultDimensions(config.defaultDimensions);}if(config.isDefault){this.toggleDefault(!!config.isDefault);}if(config.minDimensions){this.setMinDimensions(config.minDimensions);}if(config.maxDimensions){this.setMaxDimensions(config.maxDimensions);}this.setEnforcedMin(config.enforceMin);this.setEnforcedMax(config.enforceMax);};OO.mixinClass(ve.dm.Scalable,OO.EventEmitter);ve.dm.Scalable.static.getDimensionsFromValue=function(dimensions,ratio){dimensions=ve.copy(dimensions);if(dimensions.width===''){dimensions.width=0;}if(dimensions.height===''){dimensions.height=0;}if(!dimensions.height&&ratio!==null&&+dimensions.width){
dimensions.height=Math.round(dimensions.width/ratio);}if(!dimensions.width&&ratio!==null&&+dimensions.height){dimensions.width=Math.round(dimensions.height*ratio);}return dimensions;};ve.dm.Scalable.static.isDimensionsObjectValid=function(dimensions){if(dimensions&&!ve.isEmptyObject(dimensions)&&(dimensions.width!==undefined||dimensions.height!==undefined)){return true;}return false;};ve.dm.Scalable.prototype.clone=function(){var currentDimensions=this.getCurrentDimensions(),originalDimensions=this.getOriginalDimensions(),defaultDimensions=this.getDefaultDimensions(),minDimensions=this.getMinDimensions(),maxDimensions=this.getMaxDimensions(),config={isDefault:!!this.isDefault(),enforceMin:!!this.isEnforcedMin(),enforceMax:!!this.isEnforcedMax()};if(currentDimensions){config.currentDimensions=ve.copy(currentDimensions);}if(originalDimensions){config.originalDimensions=ve.copy(originalDimensions);}if(defaultDimensions){config.defaultDimensions=ve.copy(defaultDimensions);}if(minDimensions
){config.minDimensions=ve.copy(minDimensions);}if(maxDimensions){config.maxDimensions=ve.copy(maxDimensions);}return new this.constructor(config);};ve.dm.Scalable.prototype.setRatioFromDimensions=function(dimensions){if(dimensions&&dimensions.width&&dimensions.height){this.ratio=dimensions.width/dimensions.height;}this.valid=null;};ve.dm.Scalable.prototype.setCurrentDimensions=function(dimensions){if(this.constructor.static.isDimensionsObjectValid(dimensions)&&!ve.compare(dimensions,this.getCurrentDimensions())){this.currentDimensions=ve.copy(dimensions);if(this.fixedRatio&&!this.ratio){this.setRatioFromDimensions(this.getCurrentDimensions());}this.valid=null;this.emit('currentSizeChange',this.getCurrentDimensions());}};ve.dm.Scalable.prototype.setOriginalDimensions=function(dimensions){if(this.constructor.static.isDimensionsObjectValid(dimensions)&&!ve.compare(dimensions,this.getOriginalDimensions())){this.originalDimensions=ve.copy(dimensions);if(this.fixedRatio){this.
setRatioFromDimensions(this.getOriginalDimensions());}this.valid=null;this.emit('originalSizeChange',this.getOriginalDimensions());}};ve.dm.Scalable.prototype.setDefaultDimensions=function(dimensions){if(this.constructor.static.isDimensionsObjectValid(dimensions)&&!ve.compare(dimensions,this.getDefaultDimensions())){this.defaultDimensions=ve.copy(dimensions);this.valid=null;this.emit('defaultSizeChange',this.isDefault());}};ve.dm.Scalable.prototype.clearDefaultDimensions=function(){if(this.defaultDimensions!==null){this.defaultDimensions=null;this.valid=null;this.emit('defaultSizeChange',this.isDefault());}};ve.dm.Scalable.prototype.clearOriginalDimensions=function(){if(this.originalDimensions!==null){this.originalDimensions=null;this.valid=null;this.emit('originalSizeChange',this.isDefault());}};ve.dm.Scalable.prototype.toggleDefault=function(isDefault){if(isDefault===undefined){isDefault=!this.isDefault();}if(this.isDefault()!==isDefault){this.defaultSize=isDefault;if(isDefault){this
.setCurrentDimensions(this.getDefaultDimensions());}this.emit('defaultSizeChange',this.isDefault());}};ve.dm.Scalable.prototype.setMinDimensions=function(dimensions){if(this.constructor.static.isDimensionsObjectValid(dimensions)&&!ve.compare(dimensions,this.getMinDimensions())){this.minDimensions=ve.copy(dimensions);this.valid=null;this.emit('minSizeChange',dimensions);}};ve.dm.Scalable.prototype.setMaxDimensions=function(dimensions){if(this.constructor.static.isDimensionsObjectValid(dimensions)&&!ve.compare(dimensions,this.getMaxDimensions())){this.maxDimensions=ve.copy(dimensions);this.emit('maxSizeChange',dimensions);this.valid=null;}};ve.dm.Scalable.prototype.clearMinDimensions=function(){if(this.minDimensions!==null){this.minDimensions=null;this.valid=null;this.emit('minSizeChange',this.minDimensions);}};ve.dm.Scalable.prototype.clearMaxDimensions=function(){if(this.maxDimensions!==null){this.maxDimensions=null;this.valid=null;this.emit('maxSizeChange',this.maxDimensions);}};ve.dm
.Scalable.prototype.getCurrentDimensions=function(){return this.currentDimensions;};ve.dm.Scalable.prototype.getOriginalDimensions=function(){return this.originalDimensions;};ve.dm.Scalable.prototype.getDefaultDimensions=function(){return this.defaultDimensions;};ve.dm.Scalable.prototype.isDefault=function(){return this.defaultSize;};ve.dm.Scalable.prototype.getMinDimensions=function(){return this.minDimensions;};ve.dm.Scalable.prototype.getMaxDimensions=function(){return this.maxDimensions;};ve.dm.Scalable.prototype.isEnforcedMin=function(){return this.enforceMin;};ve.dm.Scalable.prototype.isEnforcedMax=function(){return this.enforceMax;};ve.dm.Scalable.prototype.setEnforcedMin=function(enforceMin){this.valid=null;this.enforceMin=!!enforceMin;};ve.dm.Scalable.prototype.setEnforcedMax=function(enforceMax){this.valid=null;this.enforceMax=!!enforceMax;};ve.dm.Scalable.prototype.getRatio=function(){return this.ratio;};ve.dm.Scalable.prototype.isFixedRatio=function(){return this.fixedRatio
;};ve.dm.Scalable.prototype.getCurrentScale=function(){if(!this.isFixedRatio()||!this.getCurrentDimensions()||!this.getOriginalDimensions()){return null;}return this.getCurrentDimensions().width/this.getOriginalDimensions().width;};ve.dm.Scalable.prototype.isTooSmall=function(){return!!(this.getCurrentDimensions()&&this.getMinDimensions()&&(this.getCurrentDimensions().width<this.getMinDimensions().width||this.getCurrentDimensions().height<this.getMinDimensions().height));};ve.dm.Scalable.prototype.isTooLarge=function(){return!!(this.getCurrentDimensions()&&this.getMaxDimensions()&&(this.getCurrentDimensions().width>this.getMaxDimensions().width||this.getCurrentDimensions().height>this.getMaxDimensions().height));};ve.dm.Scalable.prototype.getBoundedDimensions=function(dimensions,grid){var minDimensions=this.isEnforcedMin()&&this.getMinDimensions(),maxDimensions=this.isEnforcedMax()&&this.getMaxDimensions();dimensions=ve.copy(dimensions);if(minDimensions){dimensions.width=Math.max(
dimensions.width,this.minDimensions.width);dimensions.height=Math.max(dimensions.height,this.minDimensions.height);}if(maxDimensions){dimensions.width=Math.min(dimensions.width,this.maxDimensions.width);dimensions.height=Math.min(dimensions.height,this.maxDimensions.height);}if(this.isFixedRatio()){var ratio=dimensions.width/dimensions.height;if(ratio<this.getRatio()){dimensions.height=Math.round(dimensions.width/this.getRatio());}else{dimensions.width=Math.round(dimensions.height*this.getRatio());}}if(grid){var snapMin=minDimensions?Math.ceil(minDimensions.width/grid):-Infinity;var snapMax=maxDimensions?Math.floor(maxDimensions.width/grid):Infinity;var snap=Math.round(dimensions.width/grid);dimensions.width=Math.max(Math.min(snap,snapMax),snapMin)*grid;if(this.isFixedRatio()){dimensions.height=Math.round(dimensions.width/this.getRatio());}else{snapMin=minDimensions?Math.ceil(minDimensions.height/grid):-Infinity;snapMax=maxDimensions?Math.floor(maxDimensions.height/grid):Infinity;snap=
Math.round(dimensions.height/grid);dimensions.height=Math.max(Math.min(snap,snapMax),snapMin)*grid;}}return dimensions;};ve.dm.Scalable.prototype.isCurrentDimensionsValid=function(){var dimensions=this.getCurrentDimensions(),minDimensions=this.isEnforcedMin()&&!ve.isEmptyObject(this.getMinDimensions())&&this.getMinDimensions(),maxDimensions=this.isEnforcedMax()&&!ve.isEmptyObject(this.getMaxDimensions())&&this.getMaxDimensions();this.valid=(!!dimensions&&+dimensions.width&&+dimensions.height&&(!minDimensions||(dimensions.width>=minDimensions.width&&dimensions.height>=minDimensions.height))&&(!maxDimensions||(dimensions.width<=maxDimensions.width&&dimensions.height<=maxDimensions.height)));return this.valid;};ve.dm.BranchNode=function VeDmBranchNode(element,children){ve.BranchNode.call(this);ve.dm.BranchNode.super.call(this,element);this.slugPositions={};if(Array.isArray(children)&&children.length){this.splice.apply(this,[0,0].concat(children));}};OO.inheritClass(ve.dm.BranchNode,ve.dm.
Node);OO.mixinClass(ve.dm.BranchNode,ve.BranchNode);ve.dm.BranchNode.prototype.push=function(childModel){this.splice(this.children.length,0,childModel);return this.children.length;};ve.dm.BranchNode.prototype.pop=function(){if(this.children.length){var childModel=this.children[this.children.length-1];this.splice(this.children.length-1,1);return childModel;}};ve.dm.BranchNode.prototype.unshift=function(childModel){this.splice(0,0,childModel);return this.children.length;};ve.dm.BranchNode.prototype.shift=function(){if(this.children.length){var childModel=this.children[0];this.splice(0,1);return childModel;}};ve.dm.BranchNode.prototype.splice=function(){var args=Array.prototype.slice.call(arguments),diff=0;var i,length;var removals=this.children.splice.apply(this.children,args);for(i=0,length=removals.length;i<length;i++){removals[i].detach();diff-=removals[i].getOuterLength();}if(args.length>=3){length=args.length;for(i=2;i<length;i++){args[i].attach(this);diff+=args[i].getOuterLength();
}}this.adjustLength(diff,true);this.setupBlockSlugs();this.emit.apply(this,['splice'].concat(args));return removals;};ve.dm.BranchNode.prototype.setupBlockSlugs=function(){var isBlock=this.canHaveChildrenNotContent();this.slugPositions={};if(isBlock&&!this.isAllowedChildNodeType('paragraph')){return;}var len=this.children.length;var i=-1;var j=0;while(i<len){while(j<len&&this.children[j].isMetaData()){j++;}var canHaveSlugAfter=i===-1||(this.children[i].canHaveSlugAfter()&&!this.children[i].isInternal());var canHaveSlugBefore=j===len||this.children[j].canHaveSlugBefore();if(canHaveSlugAfter&&canHaveSlugBefore){var suppressSlugTypeAfter=this.children[j]&&this.children[j].suppressSlugType();var suppressSlugTypeBefore=this.children[i]&&this.children[i].suppressSlugType();if(!(typeof suppressSlugTypeAfter==='string'&&suppressSlugTypeAfter===suppressSlugTypeBefore)){this.slugPositions[j]=true;}}i=j;j++;}};ve.dm.BranchNode.prototype.hasSlugAtOffset=function(offset){var startOffset=this.
getOffset()+(this.isWrapped()?1:0);if(offset===startOffset){return!!this.slugPositions[0];}for(var i=0;i<this.children.length;i++){startOffset+=this.children[i].getOuterLength();if(offset===startOffset){return!!this.slugPositions[i+1];}}return false;};ve.dm.ContentBranchNode=function VeDmContentBranchNode(){ve.dm.ContentBranchNode.super.apply(this,arguments);};OO.inheritClass(ve.dm.ContentBranchNode,ve.dm.BranchNode);ve.dm.ContentBranchNode.static.canContainContent=true;ve.dm.ContentBranchNode.static.isDiffedAsLeaf=true;ve.dm.LeafNode=function VeDmLeafNode(){ve.LeafNode.call(this);ve.dm.LeafNode.super.apply(this,arguments);};OO.inheritClass(ve.dm.LeafNode,ve.dm.Node);OO.mixinClass(ve.dm.LeafNode,ve.LeafNode);ve.dm.LeafNode.static.childNodeTypes=[];ve.dm.LeafNode.static.isDiffedAsLeaf=true;ve.dm.LeafNode.prototype.getAnnotations=function(){return this.element.annotations||[];};ve.dm.Annotation=function VeDmAnnotation(element,store){ve.dm.Annotation.super.call(this,element);this.name=
this.constructor.static.name;this.store=store;};OO.inheritClass(ve.dm.Annotation,ve.dm.Model);ve.dm.Annotation.static.enableAboutGrouping=false;ve.dm.Annotation.static.applyToAppendedContent=true;ve.dm.Annotation.static.inferFromView=false;ve.dm.Annotation.static.removes=[];ve.dm.Annotation.static.trimWhitespace=true;ve.dm.Annotation.static.toDomElements=null;ve.dm.Annotation.prototype.getComparableObject=function(){var hashObject=this.getHashObject();delete hashObject.originalDomElementsHash;return hashObject;};ve.dm.Annotation.prototype.getComparableHtmlAttributes=function(){var domElements=this.store&&this.getOriginalDomElements(this.store);if(domElements&&domElements[0]){var comparableAttributes=ve.getDomAttributes(domElements[0]);delete comparableAttributes['data-parsoid'];if(comparableAttributes.id){var metadataIdRegExp=ve.init.platform.getMetadataIdRegExp();if(metadataIdRegExp&&metadataIdRegExp.test(comparableAttributes.id)){delete comparableAttributes.id;}}return comparableAttributes
;}return{};};ve.dm.Annotation.prototype.getComparableObjectForSerialization=function(){var object=this.getComparableObject(),htmlAttributes=this.getComparableHtmlAttributes();if(!ve.isEmptyObject(htmlAttributes)){object.htmlAttributes=htmlAttributes;}return object;};ve.dm.Annotation.prototype.isGenerated=function(){return this.getOriginalDomElementsHash()!==undefined;};ve.dm.Annotation.prototype.compareTo=function(annotation){return ve.compare(this.getComparableObject(),annotation.getComparableObject());};ve.dm.Annotation.prototype.compareToForSerialization=function(annotation){if(this.isGenerated()&&annotation.isGenerated()){return ve.compare(this.getHashObject(),annotation.getHashObject());}return ve.compare(this.getComparableObjectForSerialization(),annotation.getComparableObjectForSerialization());};ve.dm.Annotation.prototype.describeAdded=function(){return[];};ve.dm.Annotation.prototype.describeRemoved=function(){return[];};ve.dm.InternalList=function VeDmInternalList(doc){OO.
EventEmitter.call(this);this.document=doc;this.itemHtmlQueue=[];this.listNode=null;this.nodes={};this.groupsChanged=[];this.keyIndexes={};this.keys=[];doc.connect(this,{transact:'onTransact'});};OO.mixinClass(ve.dm.InternalList,OO.EventEmitter);ve.dm.InternalList.prototype.queueItemHtml=function(groupName,key,html){var isNew=false,index=this.getKeyIndex(groupName,key);if(index===undefined){index=this.itemHtmlQueue.length;this.keyIndexes[groupName+'/'+key]=index;this.itemHtmlQueue.push(html);isNew=true;}else if(this.itemHtmlQueue[index]===''){this.itemHtmlQueue[index]=html;isNew=true;}return{index:index,isNew:isNew};};ve.dm.InternalList.prototype.getItemHtmlQueue=function(){return this.itemHtmlQueue;};ve.dm.InternalList.prototype.getDocument=function(){return this.document;};ve.dm.InternalList.prototype.getListNode=function(){if(!this.listNode||!this.listNode.doc){var nodes=this.getDocument().getDocumentNode().children;for(var i=nodes.length;i>=0;i--){if(nodes[i]instanceof ve.dm.
InternalListNode){this.listNode=nodes[i];break;}}}return this.listNode;};ve.dm.InternalList.prototype.getItemNodeCount=function(){return this.getListNode().children.length;};ve.dm.InternalList.prototype.getItemNode=function(index){return this.getListNode().children[index];};ve.dm.InternalList.prototype.getNodeGroups=function(){return this.nodes;};ve.dm.InternalList.prototype.getNodeGroup=function(groupName){return this.nodes[groupName];};ve.dm.InternalList.prototype.getUniqueListKey=function(groupName,oldListKey,prefix){var group=this.getNodeGroup(groupName);if(group.uniqueListKeys[oldListKey]!==undefined){return group.uniqueListKeys[oldListKey];}var num=0;while(group.keyedNodes[prefix+num]||group.uniqueListKeysInUse[prefix+num]){num++;}group.uniqueListKeys[oldListKey]=prefix+num;group.uniqueListKeysInUse[prefix+num]=true;return prefix+num;};ve.dm.InternalList.prototype.getNextUniqueNumber=function(){var doc=this.getDocument();var number=(doc.getStorage('internallist-counter')||0);doc.
setStorage('internallist-counter',number+1);return number;};ve.dm.InternalList.prototype.convertToData=function(converter,doc){var itemHtmlQueue=this.getItemHtmlQueue(),list=[];list.push({type:'internalList'});for(var i=0,length=itemHtmlQueue.length;i<length;i++){if(itemHtmlQueue[i]!==''){var div=doc.createElement('div');div.innerHTML=itemHtmlQueue[i];var itemData=[].concat([{type:'internalItem'}],converter.getDataFromDomSubtree(div),[{type:'/internalItem'}]);if(!converter.isFromClipboard()){itemData[0].attributes={originalHtml:itemHtmlQueue[i]};}list=list.concat(itemData);}else{list=list.concat([{type:'internalItem'},{type:'/internalItem'}]);}}list.push({type:'/internalList'});this.itemHtmlQueue=[];return list;};ve.dm.InternalList.prototype.getItemInsertion=function(groupName,key,data){var index=this.getKeyIndex(groupName,key);var tx;if(index===undefined){index=this.getItemNodeCount();this.keyIndexes[groupName+'/'+key]=index;var itemData=[{type:'internalItem'}].concat(data,[{type:
'/internalItem'}]);tx=ve.dm.TransactionBuilder.static.newFromInsertion(this.getDocument(),this.getListNode().getRange().end,itemData);}else{tx=null;}return{transaction:tx,index:index};};ve.dm.InternalList.prototype.getIndexPosition=function(groupName,key){return this.nodes[groupName].indexOrder.indexOf(key);};ve.dm.InternalList.prototype.getKeyIndex=function(groupName,key){return this.keyIndexes[groupName+'/'+key];};ve.dm.InternalList.prototype.addNode=function(groupName,key,index,node){var group=this.nodes[groupName];if(group===undefined){group=this.nodes[groupName]={keyedNodes:{},firstNodes:[],indexOrder:[],uniqueListKeys:{},uniqueListKeysInUse:{}};}var keyedNodes=group.keyedNodes[key];this.keys[index]=key;if(keyedNodes===undefined){keyedNodes=group.keyedNodes[key]=[];}if(node.getDocument().buildingNodeTree){keyedNodes.push(node);if(keyedNodes.length===1){group.firstNodes[index]=node;}}else{var i,len;var start=node.getRange().start;for(i=0,len=keyedNodes.length;i<len;i++){if(start<
keyedNodes[i].getRange().start){break;}}keyedNodes.splice(i,0,node);if(i===0){group.firstNodes[index]=node;}}if(group.indexOrder.indexOf(index)===-1){group.indexOrder.push(index);}this.markGroupAsChanged(groupName);};ve.dm.InternalList.prototype.markGroupAsChanged=function(groupName){if(this.groupsChanged.indexOf(groupName)===-1){this.groupsChanged.push(groupName);}};ve.dm.InternalList.prototype.onTransact=function(){if(this.groupsChanged.length>0){for(var i=0;i<this.groupsChanged.length;i++){this.sortGroupIndexes(this.nodes[this.groupsChanged[i]]);}this.emit('update',this.groupsChanged);this.groupsChanged=[];}};ve.dm.InternalList.prototype.removeNode=function(groupName,key,index,node){var group=this.nodes[groupName];var keyedNodes=group.keyedNodes[key];for(var i=0,len=keyedNodes.length;i<len;i++){if(keyedNodes[i]===node){keyedNodes.splice(i,1);if(i===0){group.firstNodes[index]=keyedNodes[0];}break;}}if(keyedNodes.length===0){delete group.keyedNodes[key];delete group.firstNodes[index];
var j=group.indexOrder.indexOf(index);group.indexOrder.splice(j,1);}this.markGroupAsChanged(groupName);};ve.dm.InternalList.prototype.sortGroupIndexes=function(group){group.indexOrder.sort(function(index1,index2){return group.firstNodes[index1].getRange().start-group.firstNodes[index2].getRange().start;});};ve.dm.InternalList.prototype.clone=function(doc){var clone=new this.constructor(doc||this.getDocument());clone.itemHtmlQueue=ve.copy(this.itemHtmlQueue);return clone;};ve.dm.InternalList.prototype.merge=function(list,commonLength){var listLen=list.getItemNodeCount(),nextIndex=this.getItemNodeCount(),newItemRanges=[],mapping={};var i;for(i=0;i<commonLength;i++){mapping[i]=i;}for(i=commonLength;i<listLen;i++){var key=null;for(var k in list.keyIndexes){if(list.keyIndexes[k]===i){key=k;break;}}if(this.keyIndexes[key]!==undefined){mapping[i]=this.keyIndexes[key];}else{mapping[i]=nextIndex;if(key!==null){this.keyIndexes[key]=nextIndex;}nextIndex++;newItemRanges.push(list.getItemNode(i).
getOuterRange());}}return{mapping:mapping,newItemRanges:newItemRanges};};ve.dm.MetaItem=function VeDmMetaItem(){ve.dm.MetaItem.super.apply(this,arguments);OO.EventEmitter.call(this);this.list=null;};OO.inheritClass(ve.dm.MetaItem,ve.dm.LeafNode);OO.mixinClass(ve.dm.MetaItem,OO.EventEmitter);ve.dm.MetaItem.static.isContent=false;ve.dm.MetaItem.static.isMetaData=true;ve.dm.MetaItem.static.canSerializeAsContent=true;ve.dm.MetaItem.static.group='misc';ve.dm.MetaItem.static.removable=false;ve.dm.MetaItem.prototype.remove=function(){if(!this.list){throw new Error('Cannot remove detached item');}this.list.removeMeta(this);};ve.dm.MetaItem.prototype.replaceWith=function(item){this.list.replaceMeta(this,item);};ve.dm.MetaItem.prototype.getGroup=function(){return this.constructor.static.group;};ve.dm.MetaItem.prototype.attachToMetaList=function(list){this.list=list;};ve.dm.MetaItem.prototype.detachFromMetaList=function(list){if(this.list===list){this.list=null;}};ve.dm.MetaItem.prototype.
isAttached=function(){return this.list!==null;};ve.dm.MetaList=function VeDmMetaList(surface){var metaList=this;OO.EventEmitter.call(this);this.surface=surface;this.document=surface.getDocument();var items=this.items=[];this.document.connect(this,{nodeAttached:'onNodeAttached',nodeDetached:'onNodeDetached'});this.document.documentNode.traverse(function(node){if(node instanceof ve.dm.MetaItem){items.push(node);node.attachToMetaList(metaList);}});};OO.mixinClass(ve.dm.MetaList,OO.EventEmitter);ve.dm.MetaList.prototype.onNodeAttached=function(node){var offsetPath=node.getOffsetPath();if(node instanceof ve.dm.MetaItem){var i=OO.binarySearch(this.items,function searchFunc(other){return ve.compareTuples(offsetPath,other.getOffsetPath());},true);this.items.splice(i,0,node);node.attachToMetaList(this);this.emit('insert',node);}};ve.dm.MetaList.prototype.onNodeDetached=function(node){if(node instanceof ve.dm.MetaItem){var i=this.items.indexOf(node);if(i!==-1){node.detachFromMetaList(this);this.
items.splice(i,1);this.emit('remove',node);}}};ve.dm.MetaList.prototype.indexOf=function(item,group){var items=group?this.getItemsInGroup(group):this.items;return items.indexOf(item);};ve.dm.MetaList.prototype.getItemsInGroup=function(group){return this.items.filter(function(item){return item.getGroup()===group;});};ve.dm.MetaList.prototype.getAllItems=function(){return this.items.slice(0);};ve.dm.MetaList.prototype.insertMeta=function(meta,offset){if(arguments[2]!==undefined){throw new Error('Old "index" argument is no longer supported');}if(meta instanceof ve.dm.MetaItem){meta=meta.getElement();}var closeMeta={type:'/'+meta.type};if(offset===undefined){offset=this.document.getDocumentRange().end;}var tx=ve.dm.TransactionBuilder.static.newFromInsertion(this.document,offset,[meta,closeMeta]);this.surface.change(tx);};ve.dm.MetaList.prototype.removeMeta=function(item){var tx=ve.dm.TransactionBuilder.static.newFromRemoval(this.document,item.getOuterRange(),true);this.surface.change(tx);}
;ve.dm.MetaList.prototype.replaceMeta=function(oldItem,meta){if(meta instanceof ve.dm.MetaItem){meta=meta.getElement();}var closeMeta={type:'/'+meta.type};var tx=ve.dm.TransactionBuilder.static.newFromReplacement(this.document,oldItem.getOuterRange(),[meta,closeMeta],true);this.surface.change(tx);};ve.dm.TableMatrix=function VeDmTableMatrix(tableNode){OO.EventEmitter.call(this);this.tableNode=tableNode;this.matrix=null;this.rowNodes=null;};OO.mixinClass(ve.dm.TableMatrix,OO.EventEmitter);ve.dm.TableMatrix.prototype.invalidate=function(){this.matrix=null;this.rowNodes=null;this.emit('structureChange');};ve.dm.TableMatrix.prototype.update=function(){var matrix=[],rowNodes=[],iterator=this.tableNode.getIterator(),row=-1,col=-1;iterator.on('newRow',function(rowNode){row++;col=-1;matrix[row]=matrix[row]||[];rowNodes.push(rowNode);});var cellNode;while((cellNode=iterator.next())!==undefined){col++;while(matrix[row][col]){col++;}if(!cellNode){matrix[row][col]=null;continue;}var cell=new ve.dm
.TableMatrixCell(cellNode,row,col);matrix[row][col]=cell;var rowSpan=cellNode.getRowspan();var colSpan=cellNode.getColspan();if(rowSpan===1&&colSpan===1){continue;}for(var i=0;i<rowSpan;i++){for(var j=0;j<colSpan;j++){if(i===0&&j===0){continue;}var r=row+i;var c=col+j;matrix[r]=matrix[r]||[];matrix[r][c]=new ve.dm.TableMatrixCell(cellNode,r,c,cell);}}}this.matrix=matrix;this.rowNodes=rowNodes;};ve.dm.TableMatrix.prototype.getCell=function(row,col){var matrix=this.getMatrix();return matrix[row]?matrix[row][col]:undefined;};ve.dm.TableMatrix.prototype.getColumn=function(col){var matrix=this.getMatrix();var cells=[];for(var row=0;row<matrix.length;row++){cells.push(matrix[row][col]);}return cells;};ve.dm.TableMatrix.prototype.getRow=function(row){var matrix=this.getMatrix();return matrix[row];};ve.dm.TableMatrix.prototype.getRowNode=function(row){var rowNodes=this.getRowNodes();return rowNodes[row];};ve.dm.TableMatrix.prototype.getMatrix=function(){if(!this.matrix){this.update();}return this
.matrix;};ve.dm.TableMatrix.prototype.getRowNodes=function(){if(!this.rowNodes){this.update();}return this.rowNodes;};ve.dm.TableMatrix.prototype.getRowCount=function(){return this.getMatrix().length;};ve.dm.TableMatrix.prototype.getColCount=function(row){var matrix=this.getMatrix();return matrix.length?matrix[row].length:0;};ve.dm.TableMatrix.prototype.getMaxColCount=function(){var colCount=0;for(var row=this.getRowCount()-1;row>=0;row--){colCount=Math.max(colCount,this.getColCount(row));}return colCount;};ve.dm.TableMatrix.prototype.lookupCell=function(cellNode){var matrix=this.getMatrix(),rowNodes=this.getRowNodes();var row=rowNodes.indexOf(cellNode.getParent());if(row<0){return null;}var rowCells=matrix[row];for(var col=0,cols=rowCells.length;col<cols;col++){if(rowCells[col]&&rowCells[col].node===cellNode){return rowCells[col];}}return null;};ve.dm.TableMatrix.prototype.findClosestCell=function(cell){var matrix=this.getMatrix();var rowCells=matrix[cell.row];var col;for(col=cell.col
;col>=0;col--){if(!rowCells[col].isPlaceholder()){return rowCells[col];}}var cols;for(col=cell.col+1,cols=rowCells.length;col<cols;col++){if(!rowCells[col].isPlaceholder()){return rowCells[col];}}return null;};ve.dm.TableMatrixCell=function VeDmTableMatrixCell(node,row,col,owner){this.node=node;this.row=row;this.col=col;this.key=row+'_'+col;this.owner=owner||this;this.data=null;};OO.initClass(ve.dm.TableMatrixCell);ve.dm.TableMatrixCell.static.sortDescending=function(a,b){if(a.row!==b.row){return b.row-a.row;}return b.col-a.col;};ve.dm.TableMatrixCell.prototype.isPlaceholder=function(){return this.owner!==this;};ve.dm.TableMatrixCell.prototype.getOwner=function(){return this.owner;};ve.dm.TableMatrixCell.prototype.equals=function(other){return this.getOwner().key===other.getOwner().key;};ve.dm.TransactionProcessor=function VeDmTransactionProcessor(doc,transaction,isStaging){this.document=doc;this.transaction=transaction;this.operations=transaction.getOperations();this.isStaging=
isStaging;this.modificationQueue=[];this.rollbackQueue=[];this.eventQueue=[];this.cursor=0;this.adjustment=0;this.replaceRemoveLevel=0;this.replaceInsertLevel=0;this.replaceMinInsertLevel=0;this.retainDepth=0;this.balanced=true;};ve.dm.TransactionProcessor.modifiers={};ve.dm.TransactionProcessor.processors={};ve.dm.TransactionProcessor.prototype.executeOperation=function(op){if(Object.prototype.hasOwnProperty.call(ve.dm.TransactionProcessor.processors,op.type)){ve.dm.TransactionProcessor.processors[op.type].call(this,op);}else{throw new Error('Invalid operation error. Operation type is not supported: '+op.type);}};ve.dm.TransactionProcessor.prototype.process=function(){this.document.getDocumentNode();for(var i=0;i<this.operations.length;i++){this.executeOperation(this.operations[i]);}if(!this.balanced){throw new Error('Unbalanced set of replace operations found');}var completed;try{completed=false;this.applyModifications();ve.dm.treeModifier.process(this.document,this.transaction);
completed=true;}finally{if(!completed){if(this.treeModifier){this.treeModifier.undoLinearSplices();}this.rollbackModifications();this.document.rebuildTree();}}this.transaction.markAsApplied();this.emitQueuedEvents();};ve.dm.TransactionProcessor.prototype.queueModification=function(modification){if(typeof ve.dm.TransactionProcessor.modifiers[modification.type]!=='function'){throw new Error('Unrecognized modification type '+modification.type);}this.modificationQueue.push(modification);};ve.dm.TransactionProcessor.prototype.queueUndoFunction=function(func){this.rollbackQueue.push(func);};ve.dm.TransactionProcessor.prototype.applyModifications=function(){var modifications=this.modificationQueue;this.modificationQueue=[];for(var i=0,len=modifications.length;i<len;i++){var modifier=ve.dm.TransactionProcessor.modifiers[modifications[i].type];modifier.apply(this,modifications[i].args||[]);}};ve.dm.TransactionProcessor.prototype.rollbackModifications=function(){var rollbacks=this.rollbackQueue;
this.rollbackQueue=[];for(var i=rollbacks.length-1;i>=0;i--){rollbacks[i]();}};ve.dm.TransactionProcessor.prototype.queueEvent=function(node){var args=Array.prototype.slice.call(arguments,1);this.eventQueue.push({node:node,args:args.concat(this.transaction)});};ve.dm.TransactionProcessor.prototype.emitQueuedEvents=function(){var queue=this.eventQueue;var event;function isDuplicate(otherEvent){return otherEvent.node===event.node&&otherEvent.args.every(function(arg,index){return arg===event.args[index];});}this.eventQueue=[];for(var i=0;i<queue.length;i++){event=queue[i];if(!queue.slice(0,i).some(isDuplicate)){event.node.emit.apply(event.node,event.args);}}};ve.dm.TransactionProcessor.prototype.advanceCursor=function(increment){this.cursor+=increment;};ve.dm.TransactionProcessor.modifiers.splice=function(splices){var lengthDiff=0,data=this.document.data;var i;this.queueUndoFunction(function(){var i2,s2;for(i2=splices.length-1;i2>=0;i2--){s2=splices[i];if(s2.removedData!==undefined){data.
batchSplice(s2.offset,s2.insert.length,s2.removedData);}}});for(i=0;i<splices.length;i++){var s=splices[i];s.treeOffset=s.offset+this.adjustment;s.offset=s.treeOffset+lengthDiff;s.removedData=data.batchSplice(s.offset,s.removeLength,s.insert);lengthDiff+=s.insert.length-s.removeLength;}this.adjustment+=lengthDiff;};ve.dm.TransactionProcessor.modifiers.setAttribute=function(offset,key,value){var data=this.document.data;offset+=this.adjustment;var oldItem=data.getData(offset);var oldValue=oldItem.attributes&&oldItem.attributes[key];data.setAttributeAtOffset(offset,key,value);this.queueUndoFunction(function(){data.setAttributeAtOffset(offset,key,oldValue);});var node=this.document.getDocumentNode().getNodeFromOffset(offset+1);node.element=data.getData(offset);this.queueEvent(node,'attributeChange',key,oldValue,value);this.queueEvent(node,'update',this.isStaging);};ve.dm.TransactionProcessor.processors.retain=function(op){if(!this.balanced){var retainedData=this.document.getData(new ve.
Range(this.cursor,this.cursor+op.length));for(var i=0;i<retainedData.length;i++){var type=retainedData[i].type;if(type!==undefined){this.retainDepth+=type.charAt(0)==='/'?-1:1;}}}this.advanceCursor(op.length);};ve.dm.TransactionProcessor.processors.attribute=function(op){if(!this.document.data.isElementData(this.cursor)){throw new Error('Invalid element error, cannot set attributes on non-element data');}this.queueModification({type:'setAttribute',args:[this.cursor,op.key,op.to]});};ve.dm.TransactionProcessor.processors.replace=function(op){var i,type;for(i=0;i<op.remove.length;i++){type=op.remove[i].type;if(type!==undefined){if(type.charAt(0)==='/'){this.replaceRemoveLevel--;}else{this.replaceRemoveLevel++;}}}for(i=0;i<op.insert.length;i++){type=op.insert[i].type;if(type!==undefined){if(type.charAt(0)==='/'){this.replaceInsertLevel--;}else{this.replaceInsertLevel++;}}}this.advanceCursor(op.remove.length);this.balanced=this.replaceRemoveLevel===0&&this.replaceInsertLevel===0&&this.
retainDepth===0;};ve.dm.Transaction=function VeDmTransaction(operations,authorId){this.operations=operations||[];this.operations.forEach(function(op){if(op.type&&/meta/i.test(op.type)){throw new Error('Metadata ops are no longer supported');}});this.applied=false;this.authorId=authorId||null;this.isReversed=false;};OO.initClass(ve.dm.Transaction);ve.dm.Transaction.static.reversers={attribute:{from:'to',to:'from'},replace:{insert:'remove',remove:'insert'}};ve.dm.Transaction.static.deserialize=function(data){function deminifyLinearData(element){if(typeof element==='string'){return element.split('');}return JSON.parse(JSON.stringify(element));}function deminify(op){if(typeof op==='number'){return{type:'retain',length:op};}if(Array.isArray(op)){return{type:'replace',remove:deminifyLinearData(op[0]),insert:deminifyLinearData(op[1])};}return JSON.parse(JSON.stringify(op));}if(Array.isArray(data)){return new ve.dm.Transaction(data.map(deminify));}else{return new ve.dm.Transaction(data.o.map(
deminify),data.a);}};ve.dm.Transaction.static.compareElementsForTranslate=function(a,b){var aPlain=a,bPlain=b;if(a===b){return true;}if(Array.isArray(a)){aPlain=a[0];}if(Array.isArray(b)){bPlain=b[0];}if(typeof aPlain==='string'&&typeof bPlain==='string'){return aPlain===bPlain;}if(typeof a!==typeof b){return false;}if(a.type!==b.type){return false;}return true;};ve.dm.Transaction.prototype.toJSON=function(){function isSingleCodePoint(x){return typeof x==='string'&&x.length===1;}function minifyLinearData(data){if(data.every(isSingleCodePoint)){return data.join('');}return data;}function minify(op){if(op.type==='retain'){return op.length;}if(op.type==='replace'&&!op.insertedDataOffset&&(op.insertedDataLength===undefined||op.insertedDataLength===op.insert.length)){return[minifyLinearData(op.remove),minifyLinearData(op.insert)];}return op;}var operations=this.operations.map(minify);if(this.authorId!==null){return{o:operations,a:this.authorId};}else{return operations;}};ve.dm.Transaction.
prototype.serialize=ve.dm.Transaction.prototype.toJSON;ve.dm.Transaction.prototype.pushRetainOp=function(length){this.operations.push({type:'retain',length:length});};ve.dm.Transaction.prototype.pushReplaceOp=function(remove,insert,insertedDataOffset,insertedDataLength){var op={type:'replace',remove:remove,insert:insert};if(insertedDataOffset!==undefined&&insertedDataLength!==undefined){op.insertedDataOffset=insertedDataOffset;op.insertedDataLength=insertedDataLength;}this.operations.push(op);};ve.dm.Transaction.prototype.pushAttributeOp=function(key,from,to){this.operations.push({type:'attribute',key:key,from:from,to:to});};ve.dm.Transaction.prototype.clone=function(){return new this.constructor(JSON.parse(JSON.stringify(this.operations)),this.authorId);};ve.dm.Transaction.prototype.reversed=function(){var tx=new this.constructor();tx.isReversed=!this.isReversed;for(var i=0,len=this.operations.length;i<len;i++){var op=this.operations[i];var newOp=ve.copy(op);var reverse=this.
constructor.static.reversers[op.type]||{};for(var prop in reverse){if(typeof reverse[prop]==='string'){newOp[prop]=op[reverse[prop]];}else{newOp[prop]=reverse[prop][op[prop]];}}tx.operations.push(newOp);}tx.authorId=this.authorId;return tx;};ve.dm.Transaction.prototype.isNoOp=function(){if(this.operations.length===0){return true;}if(this.operations.length===1){return this.operations[0].type==='retain';}return false;};ve.dm.Transaction.prototype.getOperations=function(){return this.operations;};ve.dm.Transaction.prototype.hasOperationWithType=function(type){for(var i=0,len=this.operations.length;i<len;i++){if(this.operations[i].type===type){return true;}}return false;};ve.dm.Transaction.prototype.hasContentDataOperations=function(){return this.hasOperationWithType('replace');};ve.dm.Transaction.prototype.hasElementAttributeOperations=function(){return this.hasOperationWithType('attribute');};ve.dm.Transaction.prototype.hasBeenApplied=function(){return this.applied;};ve.dm.Transaction.
prototype.markAsApplied=function(){this.applied=true;};ve.dm.Transaction.prototype.translateOffset=function(offset,excludeInsertion){var cursor=0,adjustment=0;for(var i=0;i<this.operations.length;i++){var op=this.operations[i];if(op.type==='retain'||(op.type==='replace'&&op.insert.length===op.remove.length&&op.insert.every(function(insert,j){return ve.dm.Transaction.static.compareElementsForTranslate(insert,op.remove[j]);}))){var retainLength=op.type==='retain'?op.length:op.remove.length;if(offset>=cursor&&offset<cursor+retainLength){return offset+adjustment;}cursor+=retainLength;continue;}else if(op.type==='replace'){var insertLength=op.insert.length;var removeLength=op.remove.length;var prevAdjustment=adjustment;adjustment+=insertLength-removeLength;if(offset===cursor+removeLength){if(excludeInsertion&&insertLength>removeLength){return offset+adjustment-insertLength+removeLength;}else{return offset+adjustment;}}else if(offset===cursor){if(insertLength===0){return cursor+removeLength+
adjustment;}else{return cursor+prevAdjustment;}}else if(offset>cursor&&offset<cursor+removeLength){return cursor+removeLength+adjustment;}cursor+=removeLength;}}return offset+adjustment;};ve.dm.Transaction.prototype.translateRange=function(range,excludeInsertion){var start=this.translateOffset(range.start,!excludeInsertion),end=this.translateOffset(range.end,excludeInsertion);return range.isBackwards()?new ve.Range(end,start):new ve.Range(start,end);};ve.dm.Transaction.prototype.translateRangeWithAuthor=function(range,authorId){var backward=!this.authorId||!authorId||authorId<this.authorId,start=this.translateOffset(range.start,backward),end=this.translateOffset(range.end,backward);return range.isBackwards()?new ve.Range(end,start):new ve.Range(start,end);};ve.dm.Transaction.prototype.getModifiedRange=function(doc,includeInternalList){var docEndOffset=doc.data.getLength(),oldOffset=0,offset=0;if(!includeInternalList){var internalListNode=doc.getInternalList().getListNode();if(
internalListNode){docEndOffset=internalListNode.getOuterRange().start;}}var start,end;opLoop:for(var i=0,len=this.operations.length;i<len;i++){var op=this.operations[i];switch(op.type){case'retain':if(oldOffset+op.length>docEndOffset){break opLoop;}offset+=op.length;oldOffset+=op.length;break;case'attribute':if(start===undefined){start=offset;}end=offset+1;break;default:if(start===undefined){start=offset+(op.insertedDataOffset||0);}if(op.type==='replace'){offset+=op.insert.length;oldOffset+=op.remove.length;}if(op.insertedDataLength){end=start+op.insertedDataLength;}else{end=offset;}break;}}if(start===undefined||end===undefined){return null;}return new ve.Range(start,end);};ve.dm.Transaction.prototype.getActiveRangeAndLengthDiff=function(){var offset=0,diff=0;var start,end,startOpIndex,endOpIndex;for(var i=0,len=this.operations.length;i<len;i++){var op=this.operations[i];var active=op.type!=='retain';if(active&&start===undefined){start=offset;startOpIndex=i;}if(op.type==='retain'){
offset+=op.length;}else if(op.type==='replace'){offset+=op.remove.length;diff+=op.insert.length-op.remove.length;}if(op.type==='attribute'||op.type==='replaceMetadata'){end=offset+1;endOpIndex=i+1;}else if(active){end=offset;endOpIndex=i+1;}}return{start:start,end:end,startOpIndex:startOpIndex,endOpIndex:endOpIndex,diff:diff};};ve.dm.Transaction.prototype.adjustRetain=function(place,diff){if(diff===0){return;}var start=place==='start',ops=this.operations,i=start?0:ops.length-1;if(!start&&ops[i]&&ops[i].type==='retainMetadata'){i=ops.length-2;}if(ops[i]&&ops[i].type==='retain'){ops[i].length+=diff;if(ops[i].length<0){throw new Error('Negative retain length');}else if(ops[i].length===0){ops.splice(i,1);}return;}if(diff<0){throw new Error('Negative retain length');}ops.splice(start?0:ops.length,0,{type:'retain',length:diff});};ve.dm.Transaction.prototype.trySplit=function(offset){var n=0;var i,iLen;for(i=0,iLen=this.operations.length;i<iLen;i++){var op=this.operations[i];var opLen=(op.
type==='retain'?op.length:op.type==='replace'?op.remove.length:0);if(n+opLen<=offset){n+=opLen;continue;}if(n===offset){return i;}if(op.type!=='retain'){throw new Error('Cannot split operation of type '+op.type);}op.length-=n+opLen-offset;this.operations.splice(i+1,0,{type:'retain',length:n+opLen-offset});return i+1;}if(n===offset){return iLen+1;}throw new Error('Offset beyond end of transaction');};ve.dm.Transaction.prototype.tryUnsplit=function(index){var op1=this.operations[index-1],op2=this.operations[index];if(!op1||!op2||op1.type!==op2.type){return;}if(op1.type==='retain'){op1.length+=op2.length;this.operations.splice(index,1);}else if(op1.type==='replace'){ve.batchSplice(op1.remove,op1.remove.length,0,op2.remove);ve.batchSplice(op1.insert,op1.insert.length,0,op2.insert);this.operations.splice(index,1);}};ve.dm.Transaction.prototype.insertOperations=function(offset,operations){if(operations.length===0){return;}var opIndex=this.trySplit(offset);ve.batchSplice(this.operations,
opIndex,0,ve.copy(operations));this.tryUnsplit(opIndex+operations.length);this.tryUnsplit(opIndex);};ve.dm.TransactionBuilder=function VeDmTransactionBuilder(){this.transaction=new ve.dm.Transaction();};OO.initClass(ve.dm.TransactionBuilder);ve.dm.TransactionBuilder.static.newFromReplacement=function(doc,range,data,removeMetadata){var txBuilder=new ve.dm.TransactionBuilder();var endOffset=txBuilder.pushRemoval(doc,0,range,removeMetadata);endOffset=txBuilder.pushInsertion(doc,endOffset,endOffset,data);txBuilder.pushFinalRetain(doc,endOffset);return txBuilder.getTransaction();};ve.dm.TransactionBuilder.static.newFromInsertion=function(doc,offset,data){var txBuilder=new ve.dm.TransactionBuilder(),endOffset=txBuilder.pushInsertion(doc,0,offset,data);txBuilder.pushFinalRetain(doc,endOffset);return txBuilder.getTransaction();};ve.dm.TransactionBuilder.static.newFromRemoval=function(doc,range,removeMetadata){var txBuilder=new ve.dm.TransactionBuilder(),endOffset=txBuilder.pushRemoval(doc,0,
range,removeMetadata);if(range.start===0&&range.end>=doc.getDocumentRange().end){endOffset=txBuilder.pushInsertion(doc,endOffset,endOffset,[{type:'paragraph'},{type:'/paragraph'}]);}txBuilder.pushFinalRetain(doc,endOffset);return txBuilder.getTransaction();};ve.dm.TransactionBuilder.static.newFromDocumentInsertion=function(doc,offset,newDoc,newDocRange){var listNode=doc.internalList.getListNode(),listNodeRange=listNode.getRange(),newListNode=newDoc.internalList.getListNode(),newListNodeRange=newListNode.getRange(),newListNodeOuterRange=newListNode.getOuterRange();var data;if(newDocRange){data=new ve.dm.ElementLinearData(doc.getStore(),newDoc.getData(newDocRange,true));}else{data=new ve.dm.ElementLinearData(doc.getStore(),newDoc.getData(new ve.Range(0,newListNodeOuterRange.start),true).concat(newDoc.getData(new ve.Range(newListNodeOuterRange.end,newDoc.data.getLength()),true)));}doc.getStore().merge(newDoc.getStore());var listMerge=doc.internalList.merge(newDoc.internalList,newDoc.
origInternalListLength||0);data.remapInternalListIndexes(listMerge.mapping,doc.internalList);var linearData,listData;if(newDoc.origInternalListLength!==null){var oldEndOffset,newEndOffset;if(newDoc.origInternalListLength>0){oldEndOffset=doc.internalList.getItemNode(newDoc.origInternalListLength-1).getOuterRange().end;newEndOffset=newDoc.internalList.getItemNode(newDoc.origInternalListLength-1).getOuterRange().end;}else{oldEndOffset=listNodeRange.start;newEndOffset=newListNodeRange.start;}linearData=new ve.dm.ElementLinearData(doc.getStore(),newDoc.getData(new ve.Range(newListNodeRange.start,newEndOffset),true));listData=linearData.data.concat(doc.getData(new ve.Range(oldEndOffset,listNodeRange.end),true));}else{listData=doc.getData(listNodeRange,true);}var i,len;for(i=0,len=listMerge.newItemRanges.length;i<len;i++){linearData=new ve.dm.ElementLinearData(doc.getStore(),newDoc.getData(listMerge.newItemRanges[i],true));listData=listData.concat(linearData.data);}var txBuilder=new ve.dm.
TransactionBuilder();var insertion;if(offset<=listNodeRange.start){insertion=doc.fixupInsertion(data.data,offset);txBuilder.pushRetain(insertion.offset);txBuilder.pushReplacement(doc,insertion.offset,insertion.remove,insertion.data,true);txBuilder.pushRetain(listNodeRange.start-(insertion.offset+insertion.remove));txBuilder.pushReplacement(doc,listNodeRange.start,listNodeRange.end-listNodeRange.start,listData,true);txBuilder.pushFinalRetain(doc,listNodeRange.end);}else if(offset>=listNodeRange.end){insertion=doc.fixupInsertion(data.data,offset);txBuilder.pushRetain(listNodeRange.start);txBuilder.pushReplacement(doc,listNodeRange.start,listNodeRange.end-listNodeRange.start,listData,true);txBuilder.pushRetain(insertion.offset-listNodeRange.end);txBuilder.pushReplacement(doc,insertion.offset,insertion.remove,insertion.data,true);txBuilder.pushFinalRetain(doc,insertion.offset+insertion.remove);}else if(offset>=listNodeRange.start&&offset<=listNodeRange.end){i=0;var spliceItemRange;while((
spliceItemRange=doc.internalList.getItemNode(i).getRange())&&offset>spliceItemRange.end){i++;}var spliceListNodeRange;if(newDoc.origInternalListLength!==null){spliceItemRange=newDoc.internalList.getItemNode(i).getRange();spliceListNodeRange=newListNodeRange;}else{spliceListNodeRange=listNodeRange;}ve.batchSplice(listData,spliceItemRange.start-spliceListNodeRange.start,spliceItemRange.end-spliceItemRange.start,data.data);txBuilder.pushRetain(listNodeRange.start);txBuilder.pushReplacement(doc,listNodeRange.start,listNodeRange.end-listNodeRange.start,listData,true);txBuilder.pushFinalRetain(doc,listNodeRange.end);}return txBuilder.getTransaction();};ve.dm.TransactionBuilder.static.newFromAttributeChanges=function(doc,offset,attr){var txBuilder=new ve.dm.TransactionBuilder(),data=doc.getData();if(data[offset].type===undefined){throw new Error('Cannot set attributes to non-element data');}if(data[offset].type.charAt(0)==='/'){throw new Error('Cannot set attributes on closing element');}
txBuilder.pushRetain(offset);txBuilder.pushAttributeChanges(attr,data[offset].attributes||{});txBuilder.pushFinalRetain(doc,offset);return txBuilder.getTransaction();};ve.dm.TransactionBuilder.static.newFromAnnotation=function(doc,range,method,annotation){var clear=method==='clear',run=null,runs=[],data=doc.data,hash=doc.getStore().hash(annotation),insideContentNode=false,ignoreChildrenDepth=0;var i;function findAnnotation(){return data.getAnnotationHashesFromOffset(i).lastIndexOf(hash);}function startRun(){run={start:i,end:null,data:null,spliceAt:clear?findAnnotation():null};}function endRun(){run.end=i;if(!clear){run.spliceAt=data.getCommonAnnotationArrayLength(new ve.Range(run.start,i));}run.data=doc.getData(new ve.Range(run.start,run.end));for(var j=0,jLen=run.data.length;j<jLen;j++){var item=ve.copy(run.data[j]);var anns=new ve.dm.AnnotationSet(doc.getStore(),ve.dm.ElementLinearData.static.getAnnotationHashesFromItem(item));if(clear){anns.remove(annotation);}else{anns.add(
annotation,run.spliceAt);}item=ve.dm.ElementLinearData.static.replaceAnnotationHashesForItem(item,anns.getHashes());run.data[j]=item;}runs.push(run);run=null;}var covered,arrayIndex;for(i=range.start;i<range.end;i++){if(data.isElementData(i)&&ve.dm.nodeFactory.shouldIgnoreChildren(data.getType(i))){ignoreChildrenDepth+=data.isOpenElementData(i)?1:-1;}var annotatable=!ignoreChildrenDepth&&data.canTakeAnnotationAtOffset(i,annotation);if(!annotatable||(insideContentNode&&!data.isCloseElementData(i))){if(run){endRun();}continue;}if(data.isCloseElementData(i)){insideContentNode=false;continue;}if(insideContentNode){continue;}if(data.isElementData(i)){insideContentNode=true;}if(!clear){covered=data.getAnnotationsFromOffset(i).containsComparable(annotation);}else{arrayIndex=findAnnotation();}if(run&&((clear&&arrayIndex!==run.spliceAt)||(!clear&&covered))){endRun();}if(!run&&((clear&&arrayIndex>-1)||(!clear&&!covered))){startRun();}}if(run){endRun();}var txBuilder=new ve.dm.TransactionBuilder(
);var iLen;for(i=0,iLen=runs.length;i<iLen;i++){run=runs[i];txBuilder.pushRetain(run.start-(i>0?runs[i-1].end:0));txBuilder.pushReplacement(doc,run.start,run.end-run.start,run.data,false);}txBuilder.pushFinalRetain(doc,runs.length>0?runs[runs.length-1].end:0);return txBuilder.getTransaction();};ve.dm.TransactionBuilder.static.newFromContentBranchConversion=function(doc,range,type,attr,internal){var txBuilder=new ve.dm.TransactionBuilder(),selection=doc.selectNodes(range,'leaves'),opening={type:type},closing={type:'/'+type},previousBranch,previousBranchOuterRange;if(attr){if(!ve.isEmptyObject(attr)){opening.attributes=attr;}}else{attr={};}if(internal){if(!ve.isEmptyObject(internal)){opening.internal=internal;}}else{internal={};}for(var i=0;i<selection.length;i++){var selected=selection[i];var branch=selected.node.isContent()?selected.node.getParent():selected.node;if(branch.canContainContent()){if(branch.getType()===type&&ve.compare(attr,branch.getAttributes())&&ve.compare(internal,
branch.element.internal||{})){continue;}var branchOuterRange=branch.getOuterRange();if(branch===previousBranch){continue;}txBuilder.pushRetain(branchOuterRange.start-(previousBranch?previousBranchOuterRange.end:0));if(branch.getType()===type&&ve.compare(internal,branch.element.internal||{})){txBuilder.pushAttributeChanges(attr,branch.getAttributes());txBuilder.pushRetain(branch.getOuterLength());}else{txBuilder.pushReplacement(doc,branchOuterRange.start,1,[ve.copy(opening)]);txBuilder.pushRetain(branch.getLength());txBuilder.pushReplacement(doc,branchOuterRange.end-1,1,[ve.copy(closing)]);}previousBranch=branch;previousBranchOuterRange=branchOuterRange;}}txBuilder.pushFinalRetain(doc,previousBranch?previousBranchOuterRange.end:0);return txBuilder.getTransaction();};ve.dm.TransactionBuilder.static.newFromWrap=function(doc,range,unwrapOuter,wrapOuter,unwrapEach,wrapEach){var txBuilder=new ve.dm.TransactionBuilder(),depth=0;function match(direction,offset,matchList,matchName){var start,
stop,step;if(direction==='forwards'){start=0;stop=matchList.length;step=1;offset--;}else{start=matchList.length-1;stop=-1;step=-1;}for(var j=start;j!==stop;j+=step){var item;while(true){offset+=step;item=doc.data.data[offset];if(!(ve.dm.LinearData.static.isElementData(item)&&ve.dm.nodeFactory.isMetaData(ve.dm.LinearData.static.getType(item)))){break;}}if(!item||item.type!==matchList[j].type){throw new Error('Unmatched item '+matchList[j].type+' in '+matchName+' (found '+(item&&item.type)+')');}}if(direction==='forwards'){offset++;}return offset;}function closingArray(openings){var j,jlen,closings=[];for(j=0,jlen=openings.length;j<jlen;j++){closings[closings.length]={type:'/'+openings[jlen-j-1].type};}return closings;}var closingUnwrapEach=closingArray(unwrapEach);var closingWrapEach=closingArray(wrapEach);var ptr=match('backwards',range.start,unwrapOuter,'unwrapOuter');txBuilder.pushRetain(ptr);txBuilder.pushReplacement(doc,ptr,range.start-ptr,ve.copy(wrapOuter));ptr=range.start;if(
wrapEach.length===0&&unwrapEach.length===0){txBuilder.pushRetain(range.end-range.start);ptr=range.end;}else{var startOffset;for(var i=range.start;i<range.end;i++){if(!doc.data.isElementData(i)){continue;}if(doc.data.isOpenElementData(i)){depth++;if(depth!==1||ve.dm.nodeFactory.isMetaData(ve.dm.LinearData.static.getType(doc.data.data[i]))){continue;}txBuilder.pushRetain(i-ptr);ptr=match('forwards',i,unwrapEach,'unwrapEach');txBuilder.pushReplacement(doc,i,ptr-i,ve.copy(wrapEach));startOffset=ptr;continue;}depth--;if(depth!==0||ve.dm.nodeFactory.isMetaData(ve.dm.LinearData.static.getType(doc.data.data[i]))){continue;}ptr=match('backwards',i+1,closingUnwrapEach,'closingUnwrapEach');txBuilder.pushRetain(ptr-startOffset);txBuilder.pushReplacement(doc,ptr,i+1-ptr,ve.copy(closingWrapEach));ptr=i+1;}}txBuilder.pushRetain(range.end-ptr);ptr=match('forwards',range.end,closingArray(unwrapOuter),'unwrapOuter');txBuilder.pushReplacement(doc,range.end,ptr-range.end,closingArray(wrapOuter));txBuilder
.pushFinalRetain(doc,ptr);return txBuilder.getTransaction();};ve.dm.TransactionBuilder.prototype.getTransaction=function(){return this.transaction;};ve.dm.TransactionBuilder.prototype.pushFinalRetain=function(doc,offset){if(offset<doc.data.getLength()){this.pushRetain(doc.data.getLength()-offset);}};ve.dm.TransactionBuilder.prototype.pushRetain=function(length){if(length<0){throw new Error('Invalid retain length, cannot retain backwards:'+length);}if(length){var end=this.transaction.operations.length-1;if(this.transaction.operations.length&&this.transaction.operations[end].type==='retain'){this.transaction.operations[end].length+=length;}else{this.transaction.pushRetainOp(length);}}};ve.dm.TransactionBuilder.prototype.addSafeRemoveOps=function(doc,removeStart,removeEnd,removeMetadata){var retainStart=removeStart,undeletableStackDepth=0;var queuedRetain;for(var i=removeStart;i<removeEnd;i++){if(doc.data.isElementData(i)&&!ve.dm.nodeFactory.isNodeDeletable(doc.data.getType(i))){if(!doc.
data.isCloseElementData(i)){if(undeletableStackDepth===0){if(queuedRetain){this.pushRetain(queuedRetain);}this.pushReplacement(doc,removeStart,i-removeStart,[],removeMetadata);retainStart=i;}undeletableStackDepth++;}else{undeletableStackDepth--;if(undeletableStackDepth===0){queuedRetain=i+1-retainStart;removeStart=i+1;}}}}if(removeEnd-removeStart){if(queuedRetain){this.pushRetain(queuedRetain);}this.pushReplacement(doc,removeStart,removeEnd-removeStart,[],removeMetadata);retainStart=removeEnd;}return retainStart;};ve.dm.TransactionBuilder.prototype.pushReplaceInternal=function(remove,insert,insertedDataOffset,insertedDataLength){if(remove.length===0&&insert.length===0){return;}this.transaction.pushReplaceOp(remove,insert,insertedDataOffset,insertedDataLength);};ve.dm.TransactionBuilder.prototype.pushReplacement=function(doc,offset,removeLength,insert,removeMetadata,insertedDataOffset,insertedDataLength){var remove=doc.getData(new ve.Range(offset,offset+removeLength));var collapse=
removeMetadata?[]:remove.filter(function(item){var type=ve.dm.LinearData.static.isElementData(item)&&ve.dm.LinearData.static.getType(item);return type&&ve.dm.nodeFactory.isMetaData(type)&&!ve.dm.nodeFactory.isRemovableMetaData(type);});if(removeLength===collapse.length&&insert.length===0){return;}if(collapse.length>0){this.pushMeta(doc,offset,collapse);}var lastOp=this.transaction.operations[this.transaction.operations.length-1];if(lastOp&&lastOp.type==='replace'&&!lastOp.insertedDataOffset&&!insertedDataOffset){this.transaction.operations.pop();remove=lastOp.remove.concat(remove);insert=lastOp.insert.concat(insert);}var op={type:'replace',remove:remove,insert:insert};if(insertedDataOffset!==undefined){op.insertedDataOffset=insertedDataOffset;}if(insertedDataLength!==undefined){op.insertedDataLength=insertedDataLength;}this.transaction.operations.push(op);};ve.dm.TransactionBuilder.prototype.pushReplaceElementAttribute=function(key,from,to){this.transaction.pushAttributeOp(key,from,to)
;};ve.dm.TransactionBuilder.prototype.pushAttributeChanges=function(changes,oldAttrs){for(var key in changes){if(oldAttrs[key]!==changes[key]){this.pushReplaceElementAttribute(key,ve.copy(oldAttrs[key]),ve.copy(changes[key]));}}};ve.dm.TransactionBuilder.prototype.pushInsertion=function(doc,currentOffset,insertOffset,data){var insertion=doc.fixupInsertion(data,insertOffset);this.pushRetain(insertion.offset-currentOffset);this.pushReplacement(doc,insertion.offset,insertion.remove,insertion.data,false,insertion.insertedDataOffset,insertion.insertedDataLength);return insertion.offset+insertion.remove;};ve.dm.TransactionBuilder.prototype.pushRemoval=function(doc,currentOffset,range,removeMetadata){var offset=currentOffset,removeStart=null,removeEnd=null;if(range.isCollapsed()){this.pushRetain(range.start-currentOffset);return range.start;}var selection=doc.selectNodes(range,'covered');if(selection.length===0){throw new Error('Invalid range, cannot remove from '+range.start+' to '+range.end
);}var first=selection[0];var last=selection[selection.length-1];if(first.node.canBeMergedWith(last.node)){if(!first.range&&!last.range){removeStart=first.nodeOuterRange.start;removeEnd=last.nodeOuterRange.end;}else{removeStart=(first.range||(first.node.isContent()?first.nodeOuterRange:first.nodeRange)).start;removeEnd=(last.range||(last.node.isContent()?last.nodeOuterRange:last.nodeRange)).end;}this.pushRetain(removeStart-currentOffset);removeEnd=this.addSafeRemoveOps(doc,removeStart,removeEnd,removeMetadata);return removeEnd;}for(var i=0;i<selection.length;i++){var nodeStart,nodeEnd;if(!selection[i].range){nodeStart=selection[i].nodeOuterRange.start;nodeEnd=selection[i].nodeOuterRange.end;}else{nodeStart=selection[i].range.start;nodeEnd=selection[i].range.end;}if(removeEnd===null){removeStart=nodeStart;removeEnd=nodeEnd;}else if(removeEnd===nodeStart){removeEnd=nodeEnd;}else{this.pushRetain(removeStart-offset);offset=this.addSafeRemoveOps(doc,removeStart,removeEnd,removeMetadata);
removeStart=nodeStart;removeEnd=nodeEnd;}}if(removeEnd!==null){this.pushRetain(removeStart-offset);offset=this.addSafeRemoveOps(doc,removeStart,removeEnd,removeMetadata);}return offset;};ve.dm.TransactionBuilder.prototype.pushMeta=function(doc,offset,metaItems){var position=null,ops=this.transaction.operations,relDepth=0;if(ops.length===0){ops.push({type:'replace',remove:[],insert:metaItems});return;}position={opIndex:ops.length-1,itemIndex:ops[ops.length-1].length};var op;findPositionLoop:for(var i=ops.length-1;i>=0;i--){op=ops[i];var items;if(op.type==='replace'){items=op.insert;offset-=op.remove.length;}else if(op.type==='retain'){items=doc.getData(new ve.Range(offset-op.length,offset));offset-=op.length;}else{continue;}for(var j=items.length-1;j>=0;j--){var type=items[j].type;if(!type||typeof type!=='string'){continue;}if(type.charAt(0)==='/'){relDepth++;continue;}relDepth--;if(relDepth>=0){continue;}if(!ve.dm.nodeFactory.canNodeContainContent(type)&&!ve.dm.nodeFactory.
getChildNodeTypes(type)){break findPositionLoop;}position={opIndex:i,itemIndex:j};relDepth=0;}}op=ops[position.opIndex];if(op.type==='replace'){ve.batchSplice(op.insert,position.itemIndex,0,metaItems);return;}if(position.itemIndex>0){ops.splice(position.opIndex,0,{type:'retain',length:position.itemIndex});position.opIndex++;}ops.splice(position.opIndex,0,{type:'replace',remove:[],insert:metaItems});op.length-=position.itemIndex;if(op.length===0){ops.splice(position.opIndex+1,1);}};ve.dm.Change=function VeDmChange(start,transactions,stores,selections){var change=this;this.start=start||0;this.transactions=transactions||[];this.store=new ve.dm.HashValueStore();this.storeLengthAtTransaction=[];if(stores){stores.forEach(function(store){change.store.merge(store);change.storeLengthAtTransaction.push(change.store.getLength());});}this.selections=selections||{};};ve.dm.Change.static={};ve.dm.Change.static.deserialize=function(data,preserveStoreValues,unsafe){var hasOwn=Object.prototype.
hasOwnProperty,getTransactionInfo=this.getTransactionInfo,deserializeValue=this.deserializeValue,selections={},transactions=[],stores=data.stores||data.transactions.map(function(){return null;});function annotate(items,annotations){var j,jLen;if(!annotations||!annotations.length){return;}for(j=0,jLen=items.length;j<jLen;j++){items[j]=[items[j],annotations.slice()];}}for(var authorId in data.selections){selections[authorId]=ve.dm.Selection.static.newFromJSON(data.selections[authorId]);}var deserializeStore=ve.dm.HashValueStore.static.deserialize.bind(null,preserveStoreValues?function noop(x){return x;}:function(x){return deserializeValue(x,unsafe);});var prevInfo;for(var i=0,iLen=data.transactions.length;i<iLen;i++){var txSerialized=data.transactions[i];var tx;if(typeof txSerialized==='string'){var insertion=txSerialized.split('');annotate(insertion,prevInfo.uniformInsert&&prevInfo.uniformInsert.annotations);tx=new ve.dm.Transaction([{type:'retain',length:prevInfo.end},{type:'replace',
remove:[],insert:insertion},{type:'retain',length:prevInfo.docLength-prevInfo.end}],prevInfo.authorId);if(tx.operations[2].length===0){tx.operations.pop();}}else{tx=ve.dm.Transaction.static.deserialize(txSerialized);if(prevInfo&&!hasOwn.call(txSerialized,'authorId')){tx.authorId=prevInfo.authorId;}}transactions.push(tx);prevInfo=getTransactionInfo(tx);}return new ve.dm.Change(data.start,transactions,stores.map(deserializeStore),selections);};ve.dm.Change.static.unsafeDeserialize=function(data){return this.deserialize(data,false,true);};ve.dm.Change.static.serializeValue=function(value){if(value instanceof ve.dm.Annotation){return{type:'annotation',value:value.element};}else if(Array.isArray(value)&&value[0]instanceof Node){return{type:'domNodes',value:value.map(ve.getNodeHtml).join('')};}else{return{type:'plain',value:value};}};ve.dm.Change.static.deserializeValue=function(serialized,unsafe){if(serialized.type==='annotation'){return ve.dm.annotationFactory.createFromElement(serialized.
value);}else if(serialized.type==='domNodes'){if(unsafe){return $.parseHTML(serialized.value,undefined,true);}else{return Array.prototype.slice.call(ve.sanitizeHtml(serialized.value));}}else if(serialized.type==='plain'){return serialized.value;}else{throw new Error('Unrecognized type: '+serialized.type);}};ve.dm.Change.static.rebaseTransactions=function(transactionA,transactionB){transactionA=transactionA.clone();transactionB=transactionB.clone();var infoA=transactionA.getActiveRangeAndLengthDiff();var infoB=transactionB.getActiveRangeAndLengthDiff();if(infoA.start===undefined||infoB.start===undefined){transactionA.adjustRetain('start',infoB.diff);transactionB.adjustRetain('start',infoA.diff);}else if(infoA.end<=infoB.start){transactionB.adjustRetain('start',infoA.diff);transactionA.adjustRetain('end',infoB.diff);}else if(infoB.end<=infoA.start){transactionA.adjustRetain('start',infoB.diff);transactionB.adjustRetain('end',infoA.diff);}else{return[null,null];}return[transactionA,
transactionB];};ve.dm.Change.static.rebaseUncommittedChange=function(history,uncommitted){if(history.start!==uncommitted.start){throw new Error('Different starts: '+history.start+' and '+uncommitted.start);}var transactionsA=history.transactions.slice(),transactionsB=uncommitted.transactions.slice(),storesA=history.getStores(),storesB=uncommitted.getStores(),selectionsA=OO.cloneObject(history.selections),selectionsB=OO.cloneObject(uncommitted.selections),rejected=null;bLoop:for(var i=0,iLen=transactionsB.length;i<iLen;i++){var b=transactionsB[i];var storeB=storesB[i];var rebasedTransactionsA=[];var rebasedStoresA=[];for(var j=0,jLen=transactionsA.length;j<jLen;j++){var a=transactionsA[j];var storeA=storesA[j];var rebases;if(b.authorId<a.authorId){rebases=ve.dm.Change.static.rebaseTransactions(b,a).reverse();}else{rebases=ve.dm.Change.static.rebaseTransactions(a,b);}if(rebases[0]===null){rejected=uncommitted.mostRecent(uncommitted.start+i);transactionsB.length=i;storesB.length=i;
selectionsB={};break bLoop;}rebasedTransactionsA[j]=rebases[0];rebasedStoresA[j]=storeA.difference(storeB);b=rebases[1];storeB=storeB.difference(storeA);}transactionsA=rebasedTransactionsA;storesA=rebasedStoresA;transactionsB[i]=b;storesB[i]=storeB;}var rebased=new ve.dm.Change(uncommitted.start+transactionsA.length,transactionsB,storesB,{});var transposedHistory=new ve.dm.Change(history.start+transactionsB.length,transactionsA,storesA,{});var authorId;for(authorId in selectionsB){authorId=+authorId;rebased.selections[authorId]=selectionsB[authorId].translateByChange(transposedHistory,authorId);}for(authorId in selectionsA){authorId=+authorId;transposedHistory.selections[authorId]=selectionsA[authorId].translateByChange(rebased,authorId);}return{rebased:rebased,transposedHistory:transposedHistory,rejected:rejected};};ve.dm.Change.static.getTransactionInfo=function(tx){function getAnnotations(item){if(typeof item==='string'){return[];}else if(item.annotations){return item.annotations.
slice();}else if(item[1]){return item[1].slice();}else{return[];}}function getSingleCodeUnit(item){if(typeof item==='string'&&item.length===1){return item;}if(Array.isArray(item)&&item[0].length===1){return item[0];}return null;}function getUniformText(items){var codeUnits=[];if(items.length===0){return null;}var codeUnit=getSingleCodeUnit(items[0]);if(codeUnit===null){return null;}codeUnits.push(codeUnit);var annotations=getAnnotations(items[0]);var annotationString=annotations.join(',');for(var i=1,iLen=items.length;i<iLen;i++){codeUnit=getSingleCodeUnit(items[i]);if(codeUnit===null){return null;}codeUnits.push(codeUnit);if(annotationString!==getAnnotations(items[i]).join(',')){return null;}}return{text:codeUnits.join(''),annotations:annotations,annotationString:annotationString};}var op0=tx.operations[0];var op1=tx.operations[1];var op2=tx.operations[2];var replaceOp,start,end,docLength;if(op0&&op0.type==='replace'&&(!op1||op1.type==='retain')&&!op2){replaceOp=op0;start=0;end=start+
replaceOp.insert.length;docLength=end;}else if(op0&&op0.type==='retain'&&op1&&op1.type==='replace'&&(!op2||op2.type==='retain')){replaceOp=op1;start=op0.length;end=start+replaceOp.insert.length;docLength=end+(op2?op2.length:0);}else{return null;}return{start:start,end:end,docLength:docLength,authorId:tx.authorId,uniformInsert:getUniformText(replaceOp.insert)};};ve.dm.Change.prototype.clone=function(){return this.constructor.static.unsafeDeserialize(this.toJSON());};ve.dm.Change.prototype.isEmpty=function(){return this.transactions.length===0&&Object.keys(this.selections).length===0;};ve.dm.Change.prototype.getLength=function(){return this.transactions.length;};ve.dm.Change.prototype.getStore=function(n){return this.store.slice(n>0?this.storeLengthAtTransaction[n-1]:0,this.storeLengthAtTransaction[n]);};ve.dm.Change.prototype.getStores=function(){var stores=[],start=0;for(var i=0,len=this.getLength();i<len;i++){var end=this.storeLengthAtTransaction[i];stores.push(this.store.slice(start,
end));start=end;}return stores;};ve.dm.Change.prototype.firstAuthorId=function(){if(this.transactions.length){return this.transactions[0].authorId;}var authors=Object.keys(this.selections);if(authors.length){return+authors[0];}return null;};ve.dm.Change.prototype.summarize=function(){return'{ start: '+this.start+', txs: [ '+this.transactions.map(function(tx){return tx.summarize();}).join(', ')+' ] }';};ve.dm.Change.prototype.reversed=function(){return new ve.dm.Change(this.start+this.transactions.length,this.transactions.map(function(tx){return ve.dm.Transaction.prototype.reversed.call(tx);}).reverse(),this.transactions.map(function(){return new ve.dm.HashValueStore();}),{});};ve.dm.Change.prototype.rebasedOnto=function(other){var rebases=this.constructor.static.rebaseUncommittedChange(other,this);return rebases.rejected?null:rebases.rebased;};ve.dm.Change.prototype.concat=function(other){if(other.start!==this.start+this.transactions.length){throw new Error('this ends at '+(this.start+
this.transactions.length)+' but other starts at '+other.start);}return new ve.dm.Change(this.start,this.transactions.concat(other.transactions),this.getStores().concat(other.getStores()),other.selections);};ve.dm.Change.prototype.pushTransaction=function(transaction,storeLength){if(typeof storeLength!=='number'){throw new Error('Expected numerical storeLength argument, not '+storeLength);}this.transactions.push(transaction);this.storeLengthAtTransaction.push(storeLength);};ve.dm.Change.prototype.push=function(other){var change=this;if(other.start!==this.start+this.getLength()){throw new Error('this ends at '+(this.start+this.getLength())+' but other starts at '+other.start);}var stores=other.getStores();for(var i=0,iLen=other.transactions.length;i<iLen;i++){var transaction=other.transactions[i];var store=stores[i];change.store.merge(store);this.pushTransaction(transaction,change.store.getLength());}this.selections=OO.cloneObject(other.selections);};ve.dm.Change.prototype.concatRebased=
function(other){return this.concat(other.rebasedOnto(this));};ve.dm.Change.prototype.mostRecent=function(start){if(arguments.length>1){throw new Error('storeStart is no longer needed');}return new ve.dm.Change(start,this.transactions.slice(start-this.start),this.getStores().slice(start-this.start),OO.cloneObject(this.selections));};ve.dm.Change.prototype.truncate=function(length){if(arguments.length>1){throw new Error('storeLength is no longer needed');}return new ve.dm.Change(this.start,this.transactions.slice(0,length),this.getStores().slice(0,length),{});};ve.dm.Change.prototype.applyTo=function(surface,applySelection){var doc=surface.getDocument();if(this.start!==doc.completeHistory.getLength()){throw new Error('Change starts at '+this.start+', but doc is at '+doc.completeHistory.getLength());}this.getStores().forEach(function(store){doc.store.merge(store);});surface.breakpoint();this.transactions.forEach(function(tx){surface.change(tx);tx.applied=false;if(applySelection){var range
=tx.getModifiedRange(doc);if(range){var offset=doc.getNearestCursorOffset(range.end,-1);if(offset!==-1){surface.setSelection(new ve.dm.LinearSelection(new ve.Range(offset)));}}}});surface.breakpoint();};ve.dm.Change.prototype.unapplyTo=function(surface){var doc=surface.getDocument(),historyLength=doc.completeHistory.getLength()-this.getLength();if(this.start!==historyLength){throw new Error('Invalid start: change starts at '+this.start+', but doc would be at '+historyLength);}this.transactions.slice().reverse().forEach(function(tx){surface.change(tx.reversed());});doc.completeHistory.transactions.length=historyLength;doc.completeHistory.storeLengthAtTransaction.length=historyLength;doc.store.truncate(doc.completeHistory.storeLengthAtTransaction[historyLength-1]);};ve.dm.Change.prototype.addToHistory=function(documentModel){documentModel.completeHistory.push(this);};ve.dm.Change.prototype.removeFromHistory=function(doc){if(this.start+this.getLength()!==doc.completeHistory.getLength()){
throw new Error('this ends at '+(this.start+this.getLength())+' but history ends at '+doc.completeHistory.getLength());}doc.completeHistory.transactions.length-=this.transactions.length;doc.completeHistory.storeLengthAtTransaction.length-=this.transactions.length;doc.store.truncate(doc.completeHistory.storeLengthAtTransaction[doc.completeHistory.getLength()-1]);};ve.dm.Change.prototype.serialize=function(preserveStoreValues){var getTransactionInfo=this.constructor.static.getTransactionInfo,selections={},transactions=[];for(var authorId in this.selections){selections[authorId]=this.selections[authorId].toJSON();}var serializeStoreValues=preserveStoreValues?function noop(x){return x;}:this.constructor.static.serializeValue;var serializeStore=function(store){return store.serialize(serializeStoreValues);};var prevInfo;for(var i=0,iLen=this.transactions.length;i<iLen;i++){var tx=this.transactions[i];var info=getTransactionInfo(tx);if(info&&prevInfo&&info.authorId===prevInfo.authorId&&info.
start===prevInfo.end&&info.uniformInsert&&prevInfo.uniformInsert&&info.uniformInsert.annotationString===prevInfo.uniformInsert.annotationString){transactions.push(info.uniformInsert.text);}else{var txSerialized=tx.toJSON();if(i>0&&tx.authorId===this.transactions[i-1].authorId){delete txSerialized.authorId;}transactions.push(txSerialized);}prevInfo=info;}var stores=this.getStores().map(serializeStore);var data={start:this.start,transactions:transactions};if(stores.some(function(store){return store!==null;})){data.stores=stores;}if(Object.keys(selections).length){data.selections=selections;}return data;};ve.dm.Change.prototype.toJSON=function(){return this.serialize();};ve.dm.Change.prototype.squash=function(){if(this.transactions.length<=1){return this.clone();}return new ve.dm.Change(this.start,[ve.dm.TransactionSquasher.static.squash(this.transactions)],[this.store.clone()],ve.cloneObject(this.selections));};ve.dm.TreeCursor=function VeDmTreeCursor(root,liveIgnoreNodes,linearOffset){
this.root=root;this.liveIgnoreNodes=liveIgnoreNodes;this.path=[];this.offset=0;this.nodes=[root];this.node=root;this.lastStep=null;if(linearOffset===undefined){linearOffset=0;}this.linearOffset=linearOffset;};OO.initClass(ve.dm.TreeCursor);ve.dm.TreeCursor.prototype.normalizeCursor=function(tooShort){if(!this.node){return;}if(tooShort===undefined){tooShort=-1;}if(this.node.type==='text'&&this.offset===this.node.length){this.nodes.pop();this.node=this.nodes[this.nodes.length-1];this.offset=this.path.pop()+1;}this.crossIgnoredNodes();var item;if(this.node.hasChildren()&&(item=this.node.children[this.offset])&&item.type==='text'&&item.length>tooShort){this.node=item;this.nodes.push(item);this.path.push(this.offset);this.offset=0;}};ve.dm.TreeCursor.prototype.crossIgnoredNodes=function(){var parent,nextSibling;if(this.node&&this.node.type==='text'&&this.offset===this.node.length&&(parent=this.nodes[this.nodes.length-2])&&(nextSibling=parent.children[this.path[this.path.length-1]+1])&&this.
liveIgnoreNodes.indexOf(nextSibling)!==-1){this.stepOut();}var len=(this.node&&this.node.hasChildren()&&this.node.children.length)||0;var item;while(this.offset<len&&(item=this.node.children[this.offset])&&this.liveIgnoreNodes.indexOf(item)!==-1){this.offset++;this.linearOffset+=item.getOuterLength();}};ve.dm.TreeCursor.prototype.checkLinearOffset=function(){var expected=this.node.getOffset();if(this.node.type==='text'){expected+=this.offset;}else{if(this.node!==this.root){expected+=1;}if(this.node.hasChildren()){this.node.children.slice(0,this.offset).forEach(function(child){expected+=child.getOuterLength();});}}if(expected!==this.linearOffset){throw new Error('Linear offset does not match tree position');}};ve.dm.TreeCursor.prototype.stepAtMost=function(maxLength){if(!this.node){this.lastStep=null;return null;}if(ve.test){this.checkLinearOffset();}this.normalizeCursor(maxLength);var length,step;if(this.node.type==='text'){length=Math.min(maxLength,this.node.length-this.offset);step={
type:'crosstext',length:length,path:this.path.slice(),node:this.node,offset:this.offset,offsetLength:length};this.offset+=step.length;this.lastStep=step;this.linearOffset+=length;return step;}var childLength=this.node.hasChildren()?this.node.children.length:0;if(this.offset>childLength){throw new Error('Offset '+this.offset+' > childLength '+childLength);}if(this.offset===childLength){return this.stepOut();}var item=this.node.children[this.offset];if(item.getOuterLength()>maxLength){return this.stepIn();}length=item.getOuterLength();step={type:'cross',length:length,path:this.path.slice(),node:this.node,offset:this.offset,item:item};this.offset++;this.lastStep=step;this.linearOffset+=length;return step;};ve.dm.TreeCursor.prototype.stepIn=function(){if(this.node.type==='text'||!this.node.hasChildren()||this.offset>=this.node.children.length){throw new Error('No node to step into');}var item=this.node.children[this.offset];var length=item.type==='text'?0:1;var step={type:'open',length:
length,path:this.path.slice(),node:this.node,offset:this.offset,item:item};this.path.push(this.offset);this.nodes.push(item);this.node=item;this.offset=0;this.lastStep=step;this.linearOffset+=length;return step;};ve.dm.TreeCursor.prototype.stepOut=function(){var treeCursor=this,priorOffset=this.offset;var item=this.nodes.pop();this.node=this.nodes[this.nodes.length-1];this.offset=this.path.pop();if(this.node===undefined){this.lastStep=null;return null;}if(item.type==='text'){this.linearOffset+=item.getLength()-priorOffset;}else{if(item.hasChildren()){item.children.slice(priorOffset).forEach(function(child){treeCursor.linearOffset+=child.getOuterLength();});}this.linearOffset++;}var step={type:'close',length:item.type==='text'?0:1,path:this.path.slice(),node:this.node,offset:this.offset,item:item};this.offset++;this.lastStep=step;return step;};ve.dm.TreeModifier=function VeDmTreeModifier(){this.document=null;this.insertions=null;this.data=null;this.deletions=null;this.remover=null;this.
inserter=null;this.treeOps=null;this.insertedNodes=null;this.insertedPositions=null;this.adjustmentTree=null;};OO.initClass(ve.dm.TreeModifier);ve.dm.TreeModifier.static.applyTreeOperations=function(isReversed,document,treeOps){for(var i=0,iLen=treeOps.length;i<iLen;i++){this.applyTreeOperation(isReversed,document,treeOps[i]);}};ve.dm.TreeModifier.static.checkEqualData=function(actual,expected){function replacer(name,value){if(name==='generated'||name==='changesSinceLoad'||name==='originalDomElementsHash'||name==='originalMw'||name==='originalVariantInfo'||name==='mw'||name==='contentsUsed'){return undefined;}if(name==='internal'&&JSON.stringify(value,replacer)==='{}'){return undefined;}return value;}var jActual=JSON.stringify(actual,replacer);var jExpected=JSON.stringify(expected,replacer);if(jActual!==jExpected){throw new Error('Expected '+jExpected+' but got '+jActual);}};ve.dm.TreeModifier.static.applyTreeOperation=function(isReversed,document,treeOp){var removedNodes=[],addedNodes
=[],changedBranchNodes=[];function splice(parentNode){var removed=parentNode.splice.apply(parentNode,Array.prototype.slice.call(arguments,1));ve.batchPush(removedNodes,removed);ve.batchPush(addedNodes,Array.prototype.slice.call(arguments,3));return removed;}function ensureText(position){var pre,post,newNode,node=position.node,offset=position.offset;if(node.type==='text'){return position;}pre=node.children[offset-1];post=node.children[offset];if(post&&post.type==='text'){return{node:post,offset:0};}if(pre&&pre.type==='text'){return{node:pre,offset:pre.length};}if(!node.hasChildren()){throw new Error('Cannot add a child to '+node.type+' node');}newNode=new ve.dm.TextNode(0);splice(node,offset,0,newNode);return{node:newNode,offset:0};}function ensureNotText(position){var parentNode,parentOffset,length,newNode,node=position.node,offset=position.offset;if(node.type!=='text'){return position;}parentNode=node.parent;parentOffset=node.parent.children.indexOf(node);if(offset===0){return{node:
parentNode,offset:parentOffset};}if(offset===node.length){return{node:parentNode,offset:parentOffset+1};}length=node.length-offset;node.adjustLength(-length);newNode=new ve.dm.TextNode(length);splice(parentNode,parentOffset+1,0,newNode);return{node:parentNode,offset:parentOffset+1};}function findContentPosition(node,contentOffset){var i,offset,childLength,child;if(contentOffset===0){return{node:node,offset:0};}offset=0;for(i=0;;i++){child=node.children[i];if(!child){throw new Error('Node does not reach offset');}childLength=child.getOuterLength();offset+=childLength;if(offset>=contentOffset){break;}}if(offset===contentOffset){return{node:node,offset:i+1};}return{node:child,offset:contentOffset-offset+childLength};}function prepareSplice(pathAndOffset,isContent,wantText){var i,iLen,position,path=pathAndOffset.slice(0,-1),offset=pathAndOffset[pathAndOffset.length-1],node=document.documentNode;for(i=0,iLen=path.length;i<iLen;i++){node=node.children[path[i]];}if(isContent){if(wantText){
position=ensureText(findContentPosition(node,offset));}else{position=ensureNotText(findContentPosition(node,offset));}}else{position={node:node,offset:offset};}if(position.node.type==='text'||position.offset===0){position.linearOffset=position.node.getRange().start+position.offset;}else{position.linearOffset=position.node.children[position.offset-1].getOuterRange().end;}return position;}function markBranchNodeChanged(offset){var item,newItem,adj=isReversed?-1:1,i=offset-1;while(i>=0){item=document.data.getData(i--);if(!(ve.dm.LinearData.static.isOpenElementData(item)&&ve.dm.nodeFactory.lookup(ve.dm.LinearData.static.getType(item)).prototype instanceof ve.dm.BranchNode)){continue;}if(item.internal&&item.internal.changesSinceLoad!==undefined){if(changedBranchNodes.indexOf(item)===-1){newItem=ve.copy(item);changedBranchNodes.push(newItem);newItem.internal.changesSinceLoad+=adj;document.data.splice(i+1,1,ve.deepFreeze(newItem));}}break;}}function spliceLinear(offset,remove,insert){var
content=ve.batchSplice(document.data,offset,remove,insert?ve.deepFreeze(insert,true):[]);markBranchNodeChanged(offset);return content;}function healTextNodes(node,offset){var pre=node.children[offset-1],post=node.children[offset];if(post&&post.type==='text'&&post.length===0){splice(node,offset,1);post=node.children[offset];}if(pre&&post&&pre.type==='text'&&post.type==='text'){pre.adjustLength(post.length);splice(node,offset,1);}}var isTextOp=treeOp.type.slice(-4)==='Text';var f=treeOp.from&&prepareSplice(treeOp.from,treeOp.isContent,isTextOp);var t=treeOp.to&&prepareSplice(treeOp.to,treeOp.isContent,isTextOp);var a=treeOp.at&&prepareSplice(treeOp.at,treeOp.isContent,isTextOp);var data;var adjustment;switch(treeOp.type){case'removeNode':data=spliceLinear(a.linearOffset,2);this.checkEqualData(data,[treeOp.element,{type:'/'+treeOp.element.type}]);splice(a.node,a.offset,1);healTextNodes(a.node,a.offset);break;case'insertNode':spliceLinear(a.linearOffset,0,[treeOp.element,{type:'/'+treeOp.
element.type}]);var nodeToInsert=ve.dm.nodeFactory.createFromElement(treeOp.element);if(nodeToInsert instanceof ve.dm.BranchNode){nodeToInsert.setupBlockSlugs();}splice(a.node,a.offset,0,nodeToInsert);break;case'moveNode':data=spliceLinear(f.linearOffset,f.node.children[f.offset].getOuterLength());var movedNode=f.node.splice(f.offset,1)[0];adjustment=t.linearOffset>f.linearOffset?data.length:0;spliceLinear(t.linearOffset-adjustment,0,data);t.node.splice(t.offset,0,movedNode);break;case'removeText':data=spliceLinear(a.linearOffset,treeOp.data.length);this.checkEqualData(data,treeOp.data);a.node.adjustLength(-treeOp.data.length);healTextNodes(a.node.parent,a.node.parent.children.indexOf(a.node));break;case'insertText':spliceLinear(a.linearOffset,0,treeOp.data);a.node.adjustLength(treeOp.data.length);break;case'moveText':data=spliceLinear(f.linearOffset,treeOp.length);f.node.adjustLength(-treeOp.length);healTextNodes(f.node.parent,f.node.parent.children.indexOf(f.node));adjustment=t.
linearOffset>f.linearOffset?data.length:0;spliceLinear(t.linearOffset-adjustment,0,data);t.node.adjustLength(treeOp.length);break;default:throw new Error('Unknown tree op type: '+treeOp.type);}if(addedNodes.length||removedNodes.length){document.updateNodesByType(addedNodes,removedNodes);}};ve.dm.TreeModifier.prototype.process=function(document,transaction){this.setup(document);this.calculateTreeOperations(transaction);this.constructor.static.applyTreeOperations(transaction.isReversed,document,this.treeOps);};ve.dm.TreeModifier.prototype.setup=function(document){this.document=document;this.insertions=[];this.data=document.data;this.deletions=[];this.remover=new ve.dm.TreeCursor(document.getDocumentNode(),[]);this.inserter=new ve.dm.TreeCursor(document.getDocumentNode(),this.deletions);this.treeOps=[];this.insertedNodes=[];this.insertedPositions=[];this.adjustmentTree={offsetsUsed:[]};};ve.dm.TreeModifier.prototype.calculateTreeOperations=function(transaction){var linearOps=transaction.
operations;for(var i=0,iLen=linearOps.length;i<iLen;i++){this.processLinearOperation(linearOps[i]);}this.processImplicitFinalRetain();};ve.dm.TreeModifier.prototype.processLinearOperation=function(linearOp){if(linearOp.type==='retain'){var retainLength=linearOp.length;while(retainLength>0){retainLength-=this.processRetain(retainLength);}}else if(linearOp.type==='replace'){var i,iLen,item,data;for(i=0,iLen=linearOp.remove.length;i<iLen;i++){item=linearOp.remove[i];if(item.type){this.processRemove(item);continue;}data=[item];while(++i<iLen&&!linearOp.remove[i].type){item=linearOp.remove[i];data.push(item);}i--;this.processRemove(data);}for(i=0,iLen=linearOp.insert.length;i<iLen;i++){item=linearOp.insert[i];if(item.type){this.processInsert(item);continue;}data=[item];while(++i<iLen&&!linearOp.insert[i].type){item=linearOp.insert[i];data.push(item);}i--;this.processInsert(data);}}};ve.dm.TreeModifier.prototype.processImplicitFinalRetain=function(){while(true){var node=this.remover.node;if(
!node||(node===this.remover.root&&this.remover.offset===node.children.length)){return;}var retainLength;if(node.type==='text'){retainLength=Math.max(1,node.length-this.remover.offset);}else if(!node.hasChildren()){retainLength=1;}else{var item=node.children[this.remover.offset];retainLength=item?item.getOuterLength():1;}this.processRetain(retainLength);}};ve.dm.TreeModifier.prototype.cursorsMatch=function(){if(this.insertedPositions.length>0){return false;}var rawRemoverPosition=this.getRawRemoverPosition({path:this.remover.path,offset:this.remover.offset,node:this.remover.node});var rawInserterPosition=this.getRawInserterPosition();var adjustedRemoverPosition=this.adjustRemoverPosition(rawRemoverPosition);var adjustedInserterPosition=this.adjustInserterPosition(rawInserterPosition);if(adjustedRemoverPosition.length===1&&adjustedInserterPosition.length===1&&adjustedRemoverPosition[0]===adjustedInserterPosition[0]){return true;}return JSON.stringify(adjustedRemoverPosition)===JSON.
stringify(adjustedInserterPosition);};ve.dm.TreeModifier.prototype.processRetain=function(maxLength){var remover=this.remover,inserter=this.inserter;if(this.insertedPositions.length===0){this.inserter.crossIgnoredNodes();}var removerStep,inserterStep;if(this.cursorsMatch()){removerStep=remover.stepAtMost(maxLength);inserterStep=inserter.stepAtMost(maxLength);if(!removerStep){throw new Error('Remover past end');}if(!inserterStep){throw new Error('Inserter past end');}if(!this.cursorsMatch()){throw new Error('Remover and inserter unexpectedly diverged');}return removerStep.length;}removerStep=remover.stepAtMost(maxLength);switch(removerStep.type){case'crosstext':this.pushMoveTextOp(removerStep);if(this.insertedPositions.length){this.insertedPositions[this.insertedPositions.length-1]+=removerStep.length;}break;case'cross':if(removerStep.item.type==='text'){this.pushMoveTextOp(removerStep);if(this.insertedPositions.length){this.insertedPositions[this.insertedPositions.length-1]+=
removerStep.item.length;}}else{this.deletions.push(removerStep.item);this.pushMoveNodeOp(removerStep);if(this.insertedPositions.length){this.insertedPositions[this.insertedPositions.length-1]+=this.isInsertionContent()?2:1;}}break;case'open':this.deletions.push(removerStep.item);var element=removerStep.item.getClonedElement(true);this.pushInsertNodeOp(element);this.insertedNodes.push(element);this.insertedPositions.push(0);break;case'close':if(this.insertedPositions.length){this.insertedNodes.pop();this.insertedPositions.pop();if(this.insertedPositions.length){this.insertedPositions[this.insertedPositions.length-1]+=this.isInsertionContent()?2:1;}}else{if(inserter.node.type==='text'){inserter.stepOut();}inserterStep=inserter.stepOut();if(inserterStep.item.type!==removerStep.item.type){throw new Error('Expected '+removerStep.item.type+', not '+inserterStep.item.type);}}this.pushRemoveLastIfInDeletions();break;}return removerStep.length;};ve.dm.TreeModifier.prototype.processRemove=
function(itemOrData){var cursorsMatch=this.cursorsMatch(),length=itemOrData.length||1,step=this.remover.stepAtMost(length);if(cursorsMatch&&(step.type==='cross'||step.type==='crosstext')){this.inserter.stepAtMost(length);}if(step.type==='crosstext'){this.pushRemoveTextOp(step);}else if(step.type==='cross'){this.pushRemoveLast();}else if(step.type==='open'){this.deletions.push(step.item);}else if(step.type==='close'){this.pushRemoveLastIfInDeletions();}};ve.dm.TreeModifier.prototype.processInsert=function(itemOrData){var inserter=this.inserter;var item,type,data;if(itemOrData.type){item=itemOrData;type=item.type.charAt(0)==='/'?'close':'open';}else{data=itemOrData;type='crosstext';}if(type==='open'){if(inserter.node.type==='text'){inserter.stepOut();}var element=ve.copy(item);this.pushInsertNodeOp(element);this.insertedNodes.push(element);this.insertedPositions.push(0);}else if(type==='crosstext'){this.pushInsertTextOp(ve.copy(data));if(this.insertedPositions.length){this.
insertedPositions[this.insertedPositions.length-1]+=data.length;}}else if(type==='close'){if(this.insertedPositions.length){this.insertedNodes.pop();this.insertedPositions.pop();if(this.insertedPositions.length){this.insertedPositions[this.insertedPositions.length-1]+=this.isInsertionContent()?2:1;}}else{if(inserter.node.type==='text'){inserter.stepOut();}var step=inserter.stepOut();if(step.item.type!==item.type.slice(1)){throw new Error('Expected closing for '+step.item.type+' but got closing for '+item.type.slice(1));}}}};ve.dm.TreeModifier.prototype.pushRemoveLast=function(){var step=this.remover.lastStep;if(step.item.type==='text'){this.pushRemoveTextOp(step);}else{this.pushRemoveNodeOp(step);}};ve.dm.TreeModifier.prototype.pushRemoveLastIfInDeletions=function(){var i=this.deletions.indexOf(this.remover.lastStep.item);if(i!==-1){this.pushRemoveLast();}};ve.dm.TreeModifier.prototype.pushInsertNodeOp=function(element){var isContent=this.isInsertionContent(),rawInserterPosition=this.
getRawInserterPosition();this.checkCanInsertNodeType(element.type);this.treeOps.push({type:'insertNode',isContent:isContent,at:this.adjustInserterPosition(rawInserterPosition),element:element});if(this.insertedPositions.length===0){this.modifyAdjustmentTree(rawInserterPosition,isContent?2:1,false);}};ve.dm.TreeModifier.prototype.pushInsertTextOp=function(data){var rawInserterPosition=this.getRawInserterPosition();this.checkCanInsertText();this.treeOps.push({type:'insertText',isContent:true,at:this.adjustInserterPosition(rawInserterPosition),data:data});if(this.insertedPositions.length===0){this.modifyAdjustmentTree(rawInserterPosition,data.length,false);}};ve.dm.TreeModifier.prototype.pushMoveNodeOp=function(removerStep){var rawRemoverPosition=this.getRawRemoverPosition(removerStep),rawInserterPosition=this.getRawInserterPosition(),isContent=this.doesTypeTakeContent(removerStep.node.type);this.checkCanInsertNodeType(removerStep.item.type);this.treeOps.push({type:'moveNode',isContent:
isContent,from:this.adjustRemoverPosition(rawRemoverPosition),to:this.adjustInserterPosition(rawInserterPosition)});this.modifyAdjustmentTree(rawRemoverPosition,isContent?-2:-1,true);if(this.insertedPositions.length===0){this.modifyAdjustmentTree(rawInserterPosition,isContent?2:1,false);}};ve.dm.TreeModifier.prototype.pushMoveTextOp=function(removerStep){var length=removerStep.type==='crosstext'?removerStep.length:removerStep.item.getLength(),rawRemoverPosition=this.getRawRemoverPosition(removerStep),rawInserterPosition=this.getRawInserterPosition();this.checkCanInsertText();this.treeOps.push({type:'moveText',isContent:true,from:this.adjustRemoverPosition(rawRemoverPosition),to:this.adjustInserterPosition(rawInserterPosition),length:length});this.modifyAdjustmentTree(rawRemoverPosition,-length,false);if(this.insertedPositions.length===0){this.modifyAdjustmentTree(rawInserterPosition,length,false);}};ve.dm.TreeModifier.prototype.pushRemoveNodeOp=function(removerStep){var
rawRemoverPosition=this.getRawRemoverPosition(removerStep),isContent=this.doesTypeTakeContent(removerStep.node.type);this.treeOps.push({type:'removeNode',isContent:isContent,at:this.adjustRemoverPosition(rawRemoverPosition),element:removerStep.item.getClonedElement(true)});this.modifyAdjustmentTree(rawRemoverPosition,isContent?-2:-1,true);};ve.dm.TreeModifier.prototype.pushRemoveTextOp=function(removerStep){var rawRemoverPosition=this.getRawRemoverPosition(removerStep);var start,end;if(removerStep.type==='crosstext'){start=removerStep.node.getRange().start+removerStep.offset;end=start+removerStep.length;}else{start=removerStep.item.getRange().start;end=removerStep.item.getRange().end;}this.treeOps.push({type:'removeText',isContent:true,at:this.adjustRemoverPosition(rawRemoverPosition),data:ve.copy(this.data.slice(start,end))});this.modifyAdjustmentTree(rawRemoverPosition,start-end,false);};ve.dm.TreeModifier.prototype.findOrCreateAdjustmentNode=function(position){var adjustmentNode=
this.adjustmentTree;for(var i=0,len=position.length;i<len;i++){var offset=position[i];if(!adjustmentNode[offset]){adjustmentNode[offset]={offsetsUsed:[]};adjustmentNode.offsetsUsed.push(offset);}adjustmentNode=adjustmentNode[offset];}return adjustmentNode;};ve.dm.TreeModifier.prototype.modifyAdjustmentTree=function(rawPosition,diff,deleteDescendants){var adjustmentNode=this.findOrCreateAdjustmentNode(rawPosition);if(diff>0){adjustmentNode.inserted=(adjustmentNode.inserted||0)+diff;}else{adjustmentNode.removed=(adjustmentNode.removed||0)-diff;}if(deleteDescendants){adjustmentNode.offsetsUsed.forEach(function(i){delete adjustmentNode[i];});adjustmentNode.offsetsUsed=[];}};ve.dm.TreeModifier.prototype.getRawRemoverPosition=function(step){return this.getRawPosition(step.path,step.offset,step.node);};ve.dm.TreeModifier.prototype.getRawInserterPosition=function(){return this.getRawPosition(this.inserter.path,this.inserter.offset,this.inserter.node);};ve.dm.TreeModifier.prototype.
adjustRemoverPosition=function(rawPosition){return this.getAdjustedPosition(rawPosition,false);};ve.dm.TreeModifier.prototype.adjustInserterPosition=function(rawPosition){var positions=this.getAdjustedPosition(rawPosition,true);ve.batchPush(positions,this.insertedPositions);return positions;};ve.dm.TreeModifier.prototype.getRawPosition=function(path,offset,node){var i,linearizedOffset;if(node.parent&&node.parent.canContainContent()){var numNodesBefore=path[path.length-1];linearizedOffset=offset;for(i=0;i<numNodesBefore;i++){linearizedOffset+=node.parent.children[i].getOuterLength();}path=path.slice(0,-1);}else if(node.canContainContent()&&node.hasChildren()){linearizedOffset=0;for(i=0;i<offset;i++){linearizedOffset+=node.children[i].getOuterLength();}}else{linearizedOffset=offset;}if(!path.length){return[linearizedOffset];}path=path.slice();path.push(linearizedOffset);return path;};ve.dm.TreeModifier.prototype.getAdjustedPosition=function(position,isInserter){var node=this.
adjustmentTree;position=position.slice();for(var i=0,iLen=position.length;i<iLen;i++){var positionI=position[i];var jLen=positionI+1;var offsetsUsed=node.offsetsUsed;for(var k=0,kLen=offsetsUsed.length;k<kLen;k++){var j=offsetsUsed[k];if(j>=jLen){continue;}var childNode=node[j];var inserted=childNode.inserted||0;var removed=childNode.removed||0;if(i<iLen-1||j<jLen-1){position[i]+=inserted-removed;}else{position[i]+=inserted;if(isInserter&&this.insertedNodes.length>0){position[i]--;}}}node=node[positionI];if(!node){break;}}return position;};ve.dm.TreeModifier.prototype.doesTypeTakeContent=function(type){return!!ve.dm.nodeFactory.canNodeContainContent(type);};ve.dm.TreeModifier.prototype.isInsertionContent=function(){return this.doesTypeTakeContent(this.getTypeAtInserter());};ve.dm.TreeModifier.prototype.getTypeAtInserter=function(){return this.insertedNodes.length>0?this.insertedNodes[this.insertedNodes.length-1].type:this.inserter.node.type;};ve.dm.TreeModifier.prototype.
checkCanInsertText=function(){var parentType=this.getTypeAtInserter();if(parentType==='text'){return;}if(!ve.dm.nodeFactory.canNodeContainContent(parentType)){throw new Error('Cannot insert text into a '+parentType+' node');}};ve.dm.TreeModifier.prototype.checkCanInsertNodeType=function(nodeType){var parentType=this.getTypeAtInserter(),nodeClass=ve.dm.nodeFactory.lookup(nodeType),parentClass=ve.dm.nodeFactory.lookup(parentType),childNodeTypes=parentClass.static.childNodeTypes;if(Array.isArray(childNodeTypes)&&childNodeTypes.length===0){throw new Error('Cannot add a child to '+parentType+' node');}if(nodeClass.static.isContent&&!parentClass.static.canContainContent){throw new Error('Cannot add content node ('+nodeType+') to a '+parentType+' node');}if(!nodeClass.static.isMetaData){if(!nodeClass.static.isContent&&parentClass.static.canContainContent){throw new Error('Cannot add structure node ('+nodeType+') to a '+parentType+' node');}if(Array.isArray(childNodeTypes)&&childNodeTypes.
indexOf(nodeType)===-1){throw new Error('Cannot add a '+nodeType+' node to '+parentType+' node');}}};ve.dm.treeModifier=new ve.dm.TreeModifier();ve.dm.Selection=function VeDmSelection(){};OO.initClass(ve.dm.Selection);ve.dm.Selection.static.type=null;ve.dm.Selection.static.newFromJSON=function(json){if(ve.dm.Document&&arguments[0]instanceof ve.dm.Document){throw new Error('Got obsolete ve.dm.Document argument');}var hash=typeof json==='string'?JSON.parse(json):json;var constructor=ve.dm.selectionFactory.lookup(hash.type);if(!constructor){throw new Error('Unknown selection type '+hash.name);}return constructor.static.newFromHash(hash);};ve.dm.Selection.static.newFromHash=null;ve.dm.Selection.prototype.toJSON=null;ve.dm.Selection.prototype.getDescription=null;ve.dm.Selection.prototype.collapseToStart=null;ve.dm.Selection.prototype.collapseToEnd=null;ve.dm.Selection.prototype.collapseToFrom=null;ve.dm.Selection.prototype.collapseToTo=null;ve.dm.Selection.prototype.isCollapsed=null;ve.dm.
Selection.prototype.translateByTransaction=null;ve.dm.Selection.prototype.translateByTransactionWithAuthor=null;ve.dm.Selection.prototype.translateByTransactions=function(txs,excludeInsertion){var selection=this;for(var i=0,l=txs.length;i<l;i++){selection=selection.translateByTransaction(txs[i],excludeInsertion);}return selection;};ve.dm.Selection.prototype.translateByChange=function(change,authorId){var selection=this;for(var i=0,len=change.transactions.length;i<len;i++){selection=selection.translateByTransactionWithAuthor(change.transactions[i],authorId);}return selection;};ve.dm.Selection.prototype.isNull=function(){return false;};ve.dm.Selection.prototype.getRanges=null;ve.dm.Selection.prototype.getCoveringRange=null;ve.dm.Selection.prototype.getName=function(){return this.constructor.static.name;};ve.dm.Selection.prototype.equals=null;ve.dm.selectionFactory=new OO.Factory();ve.dm.Surface=function VeDmSurface(doc,attachedRoot,config){if(!config&&ve.isPlainObject(attachedRoot)){
config=attachedRoot;attachedRoot=undefined;}attachedRoot=attachedRoot||doc.getDocumentNode();config=config||{};if(!(attachedRoot instanceof ve.dm.BranchNode)){throw new Error('Expected ve.dm.BranchNode for attachedRoot');}OO.EventEmitter.call(this);this.documentModel=doc;this.attachedRoot=attachedRoot;this.sourceMode=!!config.sourceMode;this.metaList=new ve.dm.MetaList(this);this.selection=new ve.dm.NullSelection();this.selectionBefore=this.selection;this.translatedSelection=null;this.branchNodes={};this.selectedNode=null;this.newTransactions=[];this.stagingStack=[];this.undoStack=[];this.undoIndex=0;this.undoConflict=false;this.historyTrackingInterval=null;this.insertionAnnotations=new ve.dm.AnnotationSet(this.getDocument().getStore());this.selectedAnnotations=new ve.dm.AnnotationSet(this.getDocument().getStore());this.isCollapsed=null;this.multiUser=false;this.readOnly=false;this.transacting=false;this.queueingContextChanges=false;this.contextChangeQueued=false;this.authorId=null;
this.lastStoredChange=doc.getCompleteHistoryLength();this.autosaveFailed=false;this.autosavePrefix='';this.synchronizer=null;this.storage=ve.init.platform.sessionStorage;this.documentModel.attachedRoot=this.attachedRoot;this.getDocument().connect(this,{transact:'onDocumentTransact',precommit:'onDocumentPreCommit'});this.storeChangesListener=this.storeChanges.bind(this);this.storeDocStorageListener=this.storeDocStorage.bind(this);};OO.mixinClass(ve.dm.Surface,OO.EventEmitter);ve.dm.Surface.prototype.setReadOnly=function(readOnly){if(!!readOnly!==this.readOnly){this.readOnly=!!readOnly;if(readOnly){this.stopHistoryTracking();}else{this.startHistoryTracking();}this.getDocument().setReadOnly(readOnly);this.emit('contextChange');}};ve.dm.Surface.prototype.isReadOnly=function(){return this.readOnly;};ve.dm.Surface.prototype.initialize=function(){this.startHistoryTracking();this.emit('contextChange');};ve.dm.Surface.prototype.getDom=function(){if(this.sourceMode){return ve.dm.sourceConverter.
getSourceTextFromModel(this.getDocument());}else{return ve.dm.converter.getDomFromModel(this.getDocument());}};ve.dm.Surface.prototype.getHtml=function(){return this.sourceMode?this.getDom():ve.properInnerHtml(this.getDom().body);};ve.dm.Surface.prototype.setMultiUser=function(multiUser){this.multiUser=multiUser;};ve.dm.Surface.prototype.isMultiUser=function(){return this.multiUser;};ve.dm.Surface.prototype.createSynchronizer=function(documentId,config){if(this.synchronizer){throw new Error('Synchronizer already set');}this.setNullSelection();this.setMultiUser(true);this.synchronizer=new ve.dm.SurfaceSynchronizer(this,documentId,config);};ve.dm.Surface.prototype.startHistoryTracking=function(){if(this.readOnly){return;}if(this.historyTrackingInterval===null){this.historyTrackingInterval=setInterval(this.breakpoint.bind(this),3000);}};ve.dm.Surface.prototype.stopHistoryTracking=function(){if(this.readOnly){return;}if(this.historyTrackingInterval!==null){clearInterval(this.
historyTrackingInterval);this.historyTrackingInterval=null;}};ve.dm.Surface.prototype.resetHistoryTrackingInterval=function(){this.stopHistoryTracking();this.startHistoryTracking();};ve.dm.Surface.prototype.getHistory=function(){var appliedUndoStack=this.undoStack.slice(0,this.undoStack.length-this.undoIndex);if(this.newTransactions.length>0){return appliedUndoStack.concat([{transactions:this.newTransactions.slice(0)}]);}return appliedUndoStack;};ve.dm.Surface.prototype.isStaging=function(){return this.stagingStack.length>0;};ve.dm.Surface.prototype.getStaging=function(){return this.stagingStack[this.stagingStack.length-1];};ve.dm.Surface.prototype.doesStagingAllowUndo=function(){var staging=this.getStaging();return staging&&staging.allowUndo;};ve.dm.Surface.prototype.getStagingTransactions=function(){var staging=this.getStaging();return staging&&staging.transactions;};ve.dm.Surface.prototype.pushStaging=function(allowUndo){if(!this.isStaging()){if(this.synchronizer){this.synchronizer.
pauseChanges();}this.breakpoint();this.stopHistoryTracking();this.emit('history');}this.stagingStack.push({transactions:[],selectionBefore:this.isStaging()?this.getStaging().selectionBefore:this.selectionBefore,allowUndo:!!allowUndo});};ve.dm.Surface.prototype.popStaging=function(){if(!this.isStaging()){return;}var staging=this.stagingStack.pop();var transactions=staging.transactions;var reverseTransactions=[];for(var i=transactions.length-1;i>=0;i--){var transaction=transactions[i].reversed();reverseTransactions.push(transaction);}this.changeInternal(reverseTransactions,staging.selectionBefore,true);if(!this.isStaging()){if(this.synchronizer){this.synchronizer.resumeChanges();}this.startHistoryTracking();this.emit('history');}return transactions;};ve.dm.Surface.prototype.applyStaging=function(){if(!this.isStaging()){return;}var staging=this.stagingStack.pop();if(this.isStaging()){ve.batchPush(this.getStagingTransactions(),staging.transactions);if(this.getStaging().selectionBefore.
isNull()){this.getStaging().selectionBefore=staging.selectionBefore;}}else{this.truncateUndoStack();this.newTransactions=staging.transactions;this.selectionBefore=staging.selectionBefore;this.breakpoint();}if(!this.isStaging()){if(this.synchronizer){this.synchronizer.resumeChanges();}this.startHistoryTracking();this.emit('history');}};ve.dm.Surface.prototype.popAllStaging=function(){if(!this.isStaging()){return;}var transactions=[];while(this.isStaging()){ve.batchSplice(transactions,0,0,this.popStaging());}return transactions;};ve.dm.Surface.prototype.applyAllStaging=function(){while(this.isStaging()){this.applyStaging();}};ve.dm.Surface.prototype.getInsertionAnnotations=function(){return this.insertionAnnotations.clone();};ve.dm.Surface.prototype.setInsertionAnnotations=function(annotations){if(this.readOnly){return;}this.insertionAnnotations=annotations!==null?annotations.clone():new ve.dm.AnnotationSet(this.getDocument().getStore());this.emit('insertionAnnotationsChange',this.
insertionAnnotations);this.emit('contextChange');};ve.dm.Surface.prototype.addInsertionAnnotations=function(annotations){if(this.readOnly){return;}if(annotations instanceof ve.dm.Annotation){this.insertionAnnotations.push(annotations);}else if(annotations instanceof ve.dm.AnnotationSet){this.insertionAnnotations.addSet(annotations);}else{throw new Error('Invalid annotations');}this.emit('insertionAnnotationsChange',this.insertionAnnotations);this.emit('contextChange');};ve.dm.Surface.prototype.removeInsertionAnnotations=function(annotations){if(this.readOnly){return;}if(annotations instanceof ve.dm.Annotation){this.insertionAnnotations.remove(annotations);}else if(annotations instanceof ve.dm.AnnotationSet){this.insertionAnnotations.removeSet(annotations);}else{throw new Error('Invalid annotations');}this.emit('insertionAnnotationsChange',this.insertionAnnotations);this.emit('contextChange');};ve.dm.Surface.prototype.canRedo=function(){return this.undoIndex>0&&!this.readOnly;};ve.dm.
Surface.prototype.canUndo=function(){return this.hasBeenModified()&&!this.readOnly&&(!this.isStaging()||this.doesStagingAllowUndo())&&!this.undoConflict;};ve.dm.Surface.prototype.hasBeenModified=function(){return this.undoStack.length-this.undoIndex>0||!!this.newTransactions.length;};ve.dm.Surface.prototype.getDocument=function(){return this.documentModel;};ve.dm.Surface.prototype.getAttachedRoot=function(){return this.attachedRoot;};ve.dm.Surface.prototype.getMetaList=function(){return this.metaList;};ve.dm.Surface.prototype.getSelection=function(){return this.selection;};ve.dm.Surface.prototype.getTranslatedSelection=function(){return this.translatedSelection||this.selection;};ve.dm.Surface.prototype.getFragment=function(selection,noAutoSelect,excludeInsertions){selection=selection||this.selection;return this.sourceMode?new ve.dm.SourceSurfaceFragment(this,selection,noAutoSelect,excludeInsertions):new ve.dm.SurfaceFragment(this,selection,noAutoSelect,excludeInsertions);};ve.dm.
Surface.prototype.getLinearFragment=function(range,noAutoSelect,excludeInsertions){return this.getFragment(new ve.dm.LinearSelection(range),noAutoSelect,excludeInsertions);};ve.dm.Surface.prototype.truncateUndoStack=function(){if(this.undoIndex){this.undoStack=this.undoStack.slice(0,this.undoStack.length-this.undoIndex);this.undoIndex=0;this.emit('undoStackChange');}};ve.dm.Surface.prototype.startQueueingContextChanges=function(){if(!this.queueingContextChanges){this.queueingContextChanges=true;this.contextChangeQueued=false;}};ve.dm.Surface.prototype.emitContextChange=function(){if(this.queueingContextChanges){this.contextChangeQueued=true;}else{this.emit('contextChange');}};ve.dm.Surface.prototype.stopQueueingContextChanges=function(){if(this.queueingContextChanges){this.queueingContextChanges=false;if(this.contextChangeQueued){this.contextChangeQueued=false;this.emit('contextChange');}}};ve.dm.Surface.prototype.setLinearSelection=function(range){this.setSelection(new ve.dm.
LinearSelection(range));};ve.dm.Surface.prototype.setNullSelection=function(){this.setSelection(new ve.dm.NullSelection());};ve.dm.Surface.prototype.fixupRangeForLinks=function(range){if(range.isCollapsed()){return range;}var linearData=this.getDocument().data;function getLinks(offset){return linearData.getAnnotationsFromOffset(offset).filter(function(ann){return ann.name==='link';});}var start=range.start;var end=range.end;var rangeAnnotations=linearData.getAnnotationsFromRange(range);var startLink=getLinks(start).diffWith(rangeAnnotations).getHash(0);var endLink=getLinks(end).diffWith(rangeAnnotations).getHash(0);if(startLink===undefined&&endLink===undefined){return range;}if(startLink!==undefined){while(start>0&&getLinks(start-1).containsHash(startLink)){start--;}}if(endLink!==undefined){while(end<linearData.getLength()&&getLinks(end).containsHash(endLink)){end++;}}if(range.isBackwards()){return new ve.Range(end,start);}else{return new ve.Range(start,end);}};ve.dm.Surface.prototype.
setSelection=function(selection){var oldSelection=this.selection;var maxOffset;if(selection instanceof ve.dm.LinearSelection&&(maxOffset=this.getDocument().getDocumentRange().end)&&maxOffset<selection.getRange().end){ve.error('Attempted to set an out of bounds selection: '+JSON.stringify(selection)+', adjusting');selection=new ve.dm.LinearSelection(new ve.Range(Math.min(maxOffset,selection.getRange().start),maxOffset));}this.translatedSelection=null;if(this.transacting){this.selection=selection;return;}var selectionChange=false;if(!oldSelection.equals(selection)){selectionChange=true;this.selection=selection;}function intersectRanges(rangeA,rangeB){var rangeStart=Math.max(rangeA.start,rangeB.start);var rangeEnd=Math.min(rangeA.end,rangeB.end);return new ve.Range(rangeStart,Math.max(rangeStart,rangeEnd));}var range;var selectedNode;var branchNodes={};var contextChange=false;if(selection instanceof ve.dm.LinearSelection){range=selection.getRange();branchNodes.start=this.getDocument().
getBranchNodeFromOffset(range.start);branchNodes.startRange=intersectRanges(branchNodes.start.getRange(),range);if(!range.isCollapsed()){branchNodes.end=this.getDocument().getBranchNodeFromOffset(range.end);branchNodes.endRange=intersectRanges(branchNodes.end.getRange(),range);}else{branchNodes.end=branchNodes.start;branchNodes.endRange=branchNodes.startRange;}selectedNode=this.getSelectedNodeFromSelection(selection);if(!this.sourceMode){var linearData=this.getDocument().data;var insertionAnnotations=linearData.getInsertionAnnotationsFromRange(range);if(!insertionAnnotations.equalsInOrder(this.insertionAnnotations)){this.setInsertionAnnotations(insertionAnnotations);}var selectedAnnotations;if(range.isCollapsed()){selectedAnnotations=linearData.getAnnotationsFromOffset(range.start);}else{selectedAnnotations=linearData.getAnnotationsFromRange(range,true);}if(!selectedAnnotations.compareTo(this.selectedAnnotations)){this.selectedAnnotations=selectedAnnotations;contextChange=true;}if(
selectionChange&&!range.isCollapsed()&&oldSelection instanceof ve.dm.LinearSelection){var rangeFocus=new ve.Range(range.to);var oldRangeFocus=new ve.Range(oldSelection.getRange().to);var focusRangeMovingBack=rangeFocus.to<oldRangeFocus.to;if(!linearData.getInsertionAnnotationsFromRange(rangeFocus,focusRangeMovingBack).compareTo(linearData.getInsertionAnnotationsFromRange(oldRangeFocus,focusRangeMovingBack))){contextChange=true;}}}}else if(selection instanceof ve.dm.TableSelection){selectedNode=selection.getMatrixCells(this.getDocument())[0].node;contextChange=true;}else if(selection.isNull()){contextChange=true;}if(range&&range.isCollapsed()!==this.isCollapsed){this.isCollapsed=range.isCollapsed();contextChange=true;}if(selectedNode!==this.selectedNode||branchNodes.start!==this.branchNodes.start||branchNodes.end!==this.branchNodes.end){this.branchNodes=branchNodes;this.selectedNode=selectedNode;contextChange=true;}else if(branchNodes.startRange&&this.branchNodes.startRange&&(
branchNodes.startRange.isCollapsed()!==this.branchNodes.startRange.isCollapsed()||branchNodes.endRange.isCollapsed()!==this.branchNodes.endRange.isCollapsed())){this.branchNodes=branchNodes;contextChange=true;}if(selectionChange){this.emit('select',this.selection);if(oldSelection.isNull()){this.emit('focus');}if(selection.isNull()){this.emit('blur');}}if(contextChange){this.emitContextChange();}};ve.dm.Surface.prototype.selectFirstContentOffset=function(){var firstOffset=this.getDocument().data.getNearestContentOffset(this.getAttachedRoot().getOffset(),1);if(firstOffset!==-1){this.setLinearSelection(new ve.Range(firstOffset));}else{this.setNullSelection();}};ve.dm.Surface.prototype.selectLastContentOffset=function(){var data=this.getDocument().data,documentRange=this.getDocument().getDocumentRange(),lastOffset=data.getNearestContentOffset(documentRange.end,-1);if(lastOffset!==-1){this.setLinearSelection(new ve.Range(lastOffset));}else{this.setNullSelection();}};ve.dm.Surface.prototype.
change=function(transactions,selection){this.changeInternal(transactions,selection,false);};ve.dm.Surface.prototype.changeInternal=function(transactions,selection,skipUndoStack){var selectionBefore=this.selection,contextChange=false;this.startQueueingContextChanges();if(transactions&&!this.readOnly){if(transactions instanceof ve.dm.Transaction){transactions=[transactions];}this.transacting=true;for(var i=0,len=transactions.length;i<len;i++){if(!transactions[i].isNoOp()){var committed;try{committed=false;this.getDocument().commit(transactions[i],this.isStaging());committed=true;}finally{if(!committed){this.stopQueueingContextChanges();}}if(!skipUndoStack){if(this.isStaging()){if(!this.getStagingTransactions().length){this.getStaging().selectionBefore=selectionBefore;}this.getStagingTransactions().push(transactions[i]);}else{this.truncateUndoStack();if(!this.newTransactions.length){this.selectionBefore=selectionBefore;}this.newTransactions.push(transactions[i]);}}if(transactions[i].
hasElementAttributeOperations()){contextChange=true;}}}this.transacting=false;this.undoConflict=false;this.emit('history');}var selectionAfter=this.selection;if(selection){this.setSelection(selection);}else if(transactions){this.setSelection(this.selection);}if(!selectionBefore.equals(selectionAfter)&&selectionAfter.equals(this.selection)){this.emit('select',this.selection);}if(contextChange){this.emitContextChange();}this.stopQueueingContextChanges();};ve.dm.Surface.prototype.breakpoint=function(){if(this.readOnly){return false;}var breakpointSet=false;this.resetHistoryTrackingInterval();if(this.newTransactions.length>0){this.undoStack.push({start:this.getDocument().getCompleteHistoryLength()-this.newTransactions.length,transactions:this.newTransactions,selection:this.selection,selectionBefore:this.selectionBefore});this.newTransactions=[];this.emit('undoStackChange');breakpointSet=true;}this.selectionBefore=this.selection;return breakpointSet;};ve.dm.Surface.prototype.undo=function()
{if(!this.canUndo()){return;}if(this.isStaging()){this.popAllStaging();}this.breakpoint();this.undoIndex++;var transactions=[];var item;if(!this.isMultiUser()){item=this.undoStack[this.undoStack.length-this.undoIndex];if(item){for(var i=item.transactions.length-1;i>=0;i--){var transaction=item.transactions[i].reversed();transactions.push(transaction);}this.changeInternal(transactions,item.selectionBefore,true);this.emit('undoStackChange');}}else{while(this.undoIndex<=this.undoStack.length){item=this.undoStack[this.undoStack.length-this.undoIndex];var authorId=item.transactions[0].authorId;if(authorId===null||authorId===this.getAuthorId()){break;}item=null;this.undoIndex++;}if(item){var history=this.getDocument().getChangeSince(item.start+item.transactions.length);var done=new ve.dm.Change(item.start,item.transactions,item.transactions.map(function(){return new ve.dm.HashValueStore();}),{});var result=ve.dm.Change.static.rebaseUncommittedChange(history,done.reversed());if(result.
rejected){this.undoIndex--;this.undoConflict=true;this.emit('history');}else{var selection=item.selectionBefore.translateByChange(result.transposedHistory);this.changeInternal(result.rebased.transactions,selection,true);this.emit('undoStackChange');}}else{this.emit('history');}}};ve.dm.Surface.prototype.redo=function(){if(!this.canRedo()){return;}this.breakpoint();var item=this.undoStack[this.undoStack.length-this.undoIndex];if(item){this.undoIndex--;this.changeInternal(ve.copy(item.transactions),item.selection,true);this.emit('undoStackChange');}};ve.dm.Surface.prototype.onDocumentTransact=function(tx){this.setSelection(this.getSelection().translateByTransactionWithAuthor(tx,this.authorId));this.emit('documentUpdate',tx);};ve.dm.Surface.prototype.getSelectedNode=function(){return this.selectedNode;};ve.dm.Surface.prototype.getSelectedNodeFromSelection=function(selection){selection=selection||this.getSelection();if(!(selection instanceof ve.dm.LinearSelection)){return null;}var
selectedNode=null;var range=selection.getRange();if(!range.isCollapsed()){var startNode=this.getDocument().documentNode.getNodeFromOffset(range.start+1);if(startNode&&startNode.getOuterRange().equalsSelection(range)){selectedNode=startNode;}}return selectedNode;};ve.dm.Surface.prototype.onDocumentPreCommit=function(tx){this.translatedSelection=this.selection.translateByTransaction(tx);};ve.dm.Surface.prototype.getModifiedRanges=function(includeCollapsed,includeInternalList){var doc=this.getDocument();var ranges=[];this.getHistory().forEach(function(stackItem){stackItem.transactions.forEach(function(tx){var newRange=tx.getModifiedRange(doc,includeInternalList);if(newRange){ranges.forEach(function(range,i,arr){arr[i]=tx.translateRange(range,true);});if(includeCollapsed||!newRange.isCollapsed()){ranges.push(newRange);}}});});var compactRanges=[];var lastRange=null;ranges.sort(function(a,b){return a.start-b.start;}).forEach(function(range){if(includeCollapsed||!range.isCollapsed()){if(
lastRange&&lastRange.touchesRange(range)){compactRanges.pop();range=lastRange.expand(range);}compactRanges.push(range);lastRange=range;}});return compactRanges;};ve.dm.Surface.prototype.getOffsetFromSourceOffset=function(offset){if(offset<0){throw new Error('Offset out of bounds');}var lineOffset=0,line=0,lines=this.getDocument().getDocumentNode().getChildren();while(lineOffset<offset+1){if(!lines[line]||lines[line].isInternal()){throw new Error('Offset out of bounds');}lineOffset+=lines[line].getLength()+1;line++;}return offset+line;};ve.dm.Surface.prototype.getSourceOffsetFromOffset=function(offset){if(offset<0){throw new Error('Offset out of bounds');}var lineOffset=0,line=0,lines=this.getDocument().getDocumentNode().getChildren();while(lineOffset<offset){if(!lines[line]||lines[line].isInternal()){throw new Error('Offset out of bounds');}lineOffset+=lines[line].getOuterLength();line++;}return offset-line;};ve.dm.Surface.prototype.getRangeFromSourceOffsets=function(from,to){var
fromOffset=this.getOffsetFromSourceOffset(from);return new ve.Range(fromOffset,to===undefined||to===from?fromOffset:this.getOffsetFromSourceOffset(to));};ve.dm.Surface.prototype.getAuthorId=function(){return this.authorId;};ve.dm.Surface.prototype.setAuthorId=function(authorId){this.authorId=authorId;};ve.dm.Surface.prototype.storeChanges=function(){if(this.autosaveFailed){return;}var dmDoc=this.getDocument();var change=dmDoc.getChangeSince(this.lastStoredChange);if(!change.isEmpty()){if(this.storage.appendToList(this.autosavePrefix+'ve-changes',JSON.stringify(change))){this.lastStoredChange=dmDoc.getCompleteHistoryLength();this.storage.setObject(this.autosavePrefix+'ve-selection',this.getSelection());}else{this.autosaveFailed=true;this.emit('autosaveFailed');}}};ve.dm.Surface.prototype.storeDocStorage=function(){if(this.autosaveFailed){return;}var dmDoc=this.getDocument();this.storage.setObject(this.autosavePrefix+'ve-docstorage',dmDoc.getStorage());};ve.dm.Surface.prototype.
setAutosaveDocId=function(docId){this.autosavePrefix=docId+'/';};ve.dm.Surface.prototype.startStoringChanges=function(){this.on('undoStackChange',this.storeChangesListener);this.getDocument().on('storage',this.storeDocStorageListener);};ve.dm.Surface.prototype.stopStoringChanges=function(){this.off('undoStackChange',this.storeChangesListener);this.getDocument().off('storage',this.storeDocStorageListener);};ve.dm.Surface.prototype.restoreChanges=function(){var surface=this,restored=false,changes=this.storage.getList(this.autosavePrefix+'ve-changes');try{changes.forEach(function(changeString){var data=JSON.parse(changeString),change=ve.dm.Change.static.unsafeDeserialize(data);change.applyTo(surface,true);surface.breakpoint();});restored=!!changes.length;this.getDocument().setStorage(this.storage.getObject(this.autosavePrefix+'ve-docstorage')||{});var selection;try{selection=ve.dm.Selection.static.newFromJSON(this.storage.getObject(this.autosavePrefix+'ve-selection'));}catch(e){}if(
selection){setTimeout(function(){surface.setSelection(selection);});}}catch(e){throw new Error('Failed to restore auto-saved session: '+e);}this.lastStoredChange=this.getDocument().getCompleteHistoryLength();return restored;};ve.dm.Surface.prototype.storeDocState=function(state,html){this.removeDocStateAndChanges();if(state){if(!this.updateDocState(state)){this.stopStoringChanges();return false;}}var useLatestHtml=html===undefined;if(!this.storage.set(this.autosavePrefix+'ve-dochtml',useLatestHtml?this.getHtml():html)){this.storage.remove(this.autosavePrefix+'ve-docstate');this.stopStoringChanges();return false;}if(useLatestHtml){this.lastStoredChange=this.getDocument().getCompleteHistoryLength();}return true;};ve.dm.Surface.prototype.updateDocState=function(state){return this.storage.set(this.autosavePrefix+'ve-docstate',JSON.stringify(state));};ve.dm.Surface.prototype.removeDocStateAndChanges=function(){this.storage.remove(this.autosavePrefix+'ve-docstate');this.storage.remove(this.
autosavePrefix+'ve-dochtml');this.storage.remove(this.autosavePrefix+'ve-selection');this.storage.removeList(this.autosavePrefix+'ve-changes');};ve.dm.SurfaceFragment=function VeDmSurfaceFragment(surface,selection,noAutoSelect,excludeInsertions){if(!surface){return this;}this.document=surface.getDocument();this.noAutoSelect=!!noAutoSelect;this.excludeInsertions=!!excludeInsertions;this.surface=surface;this.selection=selection||surface.getSelection();this.leafNodes=null;this.pending=[];this.historyPointer=this.document.getCompleteHistoryLength();};OO.initClass(ve.dm.SurfaceFragment);ve.dm.SurfaceFragment.prototype.getSelectedModels=function(all){if(this.isNull()){return[];}var annotations=this.getAnnotations(all);var nodes;if(all){nodes=this.getCoveredNodes();for(var i=0,len=nodes.length;i<len;i++){if(nodes[i].range&&nodes[i].range.isCollapsed()){nodes.splice(i,1);len--;i--;}else{nodes[i]=nodes[i].node;}}}else{nodes=[];var selectedNode=this.getSelectedNode();if(selectedNode){nodes.push(
selectedNode);}}return nodes.concat(!annotations.isEmpty()?annotations.get():[]);};ve.dm.SurfaceFragment.prototype.update=function(selection){if(this.isNull()){return this;}if(selection&&!selection.equals(this.selection)){this.selection=selection;this.leafNodes=null;this.historyPointer=this.document.getCompleteHistoryLength();}else if(this.historyPointer<this.document.getCompleteHistoryLength()){var txs=this.document.getCompleteHistorySince(this.historyPointer);this.selection=this.selection.translateByTransactions(txs,this.excludeInsertions);this.leafNodes=null;this.historyPointer+=txs.length;}return this;};ve.dm.SurfaceFragment.prototype.change=function(txs,selection){if(!selection&&this.isNull()){throw new Error('Cannot change null fragment without selection');}if(!Array.isArray(txs)){txs=[txs];}this.surface.change(txs,!this.noAutoSelect&&(selection||this.getSelection().translateByTransactions(txs,this.excludeInsertions)));if(selection){this.update(selection);}};ve.dm.SurfaceFragment
.prototype.getSurface=function(){return this.surface;};ve.dm.SurfaceFragment.prototype.getDocument=function(){return this.document;};ve.dm.SurfaceFragment.prototype.getSelection=function(){this.update();return this.selection;};ve.dm.SurfaceFragment.prototype.isNull=function(){return this.selection.isNull();};ve.dm.SurfaceFragment.prototype.willAutoSelect=function(){return!this.noAutoSelect;};ve.dm.SurfaceFragment.prototype.setAutoSelect=function(autoSelect){this.noAutoSelect=!autoSelect;return this;};ve.dm.SurfaceFragment.prototype.clone=function(selection){return new this.constructor(this.surface,selection||this.getSelection(),this.noAutoSelect,this.excludeInsertions);};ve.dm.SurfaceFragment.prototype.willExcludeInsertions=function(){return this.excludeInsertions;};ve.dm.SurfaceFragment.prototype.setExcludeInsertions=function(excludeInsertions){excludeInsertions=!!excludeInsertions;if(this.excludeInsertions!==excludeInsertions){this.update();this.excludeInsertions=excludeInsertions;}
return this;};ve.dm.SurfaceFragment.prototype.adjustLinearSelection=function(start,end){if(!(this.selection instanceof ve.dm.LinearSelection)){return this.clone();}var oldRange=this.getSelection().getRange();var newRange=oldRange&&new ve.Range(oldRange.start+(start||0),oldRange.end+(end||0));return this.clone(new ve.dm.LinearSelection(newRange));};ve.dm.SurfaceFragment.prototype.truncateLinearSelection=function(limit){if(!(this.selection instanceof ve.dm.LinearSelection)){return this.clone();}var range=this.getSelection().getRange();return this.clone(new ve.dm.LinearSelection(range.truncate(limit)));};ve.dm.SurfaceFragment.prototype.collapseToStart=function(){return this.clone(this.getSelection().collapseToStart());};ve.dm.SurfaceFragment.prototype.collapseToEnd=function(){return this.clone(this.getSelection().collapseToEnd());};ve.dm.SurfaceFragment.prototype.trimLinearSelection=function(){if(!(this.selection instanceof ve.dm.LinearSelection)){return this.clone();}var oldRange=this.
getSelection().getRange();var newRange;if(this.getText().trim().length===0){newRange=new ve.Range(oldRange.start);}else{newRange=this.document.data.trimOuterSpaceFromRange(oldRange);}return this.clone(new ve.dm.LinearSelection(newRange));};ve.dm.SurfaceFragment.prototype.expandLinearSelection=function(scope,type){if(!(this.selection instanceof ve.dm.LinearSelection)){return this.clone();}var oldRange=this.getSelection().getRange();var newRange;var nodes,node,parent;switch(scope||'parent'){case'word':if(!oldRange.isCollapsed()){newRange=ve.Range.static.newCoveringRange([this.document.data.getWordRange(oldRange.start),this.document.data.getWordRange(oldRange.end)],oldRange.isBackwards());}else{newRange=this.document.data.getWordRange(oldRange.start);}break;case'annotation':newRange=this.document.data.getAnnotatedRangeFromSelection(oldRange,type);if(oldRange.start>newRange.start||oldRange.end<newRange.end){if(oldRange.from>oldRange.to){newRange=newRange.flip();}}else{newRange=oldRange;}
break;case'root':newRange=this.getDocument().getDocumentRange();break;case'siblings':nodes=this.document.selectNodes(oldRange,'siblings');if(nodes.length===1){newRange=nodes[0].node.getOuterRange();}else{newRange=new ve.Range(nodes[0].node.getOuterRange().start,nodes[nodes.length-1].node.getOuterRange().end);}break;case'closest':nodes=this.document.selectNodes(oldRange,'siblings');if(nodes[0].nodeRange.equalsSelection(oldRange)&&nodes[0].node instanceof type){newRange=nodes[0].nodeOuterRange;break;}parent=nodes[0].node.getParent();while(parent&&!(parent instanceof type)){node=parent;parent=parent.getParent();}if(parent){newRange=parent.getOuterRange();}break;case'parent':node=this.document.selectNodes(oldRange,'siblings')[0].node;parent=node.getParent();if(parent){newRange=parent.getOuterRange();}break;default:throw new Error('Invalid scope argument: '+scope);}return this.clone(newRange?new ve.dm.LinearSelection(newRange):new ve.dm.NullSelection());};ve.dm.SurfaceFragment.prototype.
getData=function(deep){var range=this.getSelection().getCoveringRange();if(!range){return[];}return this.document.getData(range,deep);};ve.dm.SurfaceFragment.prototype.getText=function(maintainIndices){var range=this.getSelection().getCoveringRange();if(!range){return'';}return this.document.data.getText(maintainIndices,range);};ve.dm.SurfaceFragment.prototype.containsOnlyText=function(){var range=this.getSelection().getCoveringRange();if(!range){return true;}return this.document.data.isPlainText(range,false,false,false,true);};ve.dm.SurfaceFragment.prototype.getAnnotations=function(all){var selection=this.getSelection();if(selection.isCollapsed()){return this.surface.getInsertionAnnotations();}else{var annotations=null;var ranges=selection.getRanges(this.getDocument());for(var i=0,l=ranges.length;i<l;i++){var rangeAnnotations=this.getDocument().data.getAnnotationsFromRange(ranges[i],all,true);if(!rangeAnnotations){continue;}if(!annotations){annotations=rangeAnnotations;}else if(all){
annotations.addSet(rangeAnnotations);}else{var matchingAnnotations=rangeAnnotations.getComparableAnnotationsFromSet(annotations);if(matchingAnnotations.isEmpty()){annotations=matchingAnnotations;break;}else{annotations=annotations.getComparableAnnotationsFromSet(rangeAnnotations);annotations.addSet(matchingAnnotations);}}}return annotations||new ve.dm.AnnotationSet(this.getDocument().getStore());}};ve.dm.SurfaceFragment.prototype.hasAnnotations=function(){var ranges=this.getSelection().getRanges(this.getDocument());for(var i=0,l=ranges.length;i<l;i++){if(this.getDocument().data.hasAnnotationsInRange(ranges[i])){return true;}}return false;};ve.dm.SurfaceFragment.prototype.getLeafNodes=function(){var range=this.getSelection().getCoveringRange();if(!range){return[];}this.update();if(!this.leafNodes){this.leafNodes=this.document.selectNodes(range,'leaves');}return this.leafNodes;};ve.dm.SurfaceFragment.prototype.getSelectedLeafNodes=function(){var selectedLeafNodes=[],leafNodes=this.
getLeafNodes();for(var i=0,len=leafNodes.length;i<len;i++){if(len===1||!leafNodes[i].range||leafNodes[i].range.getLength()){selectedLeafNodes.push(leafNodes[i].node);}}return selectedLeafNodes;};ve.dm.SurfaceFragment.prototype.getSelectedNode=function(){var surface=this.getSurface();this.update();return this.selection.equals(surface.getSelection())?surface.getSelectedNode():surface.getSelectedNodeFromSelection(this.selection);};ve.dm.SurfaceFragment.prototype.getCoveredNodes=function(){var range=this.getSelection().getCoveringRange();if(!range){return[];}return this.document.selectNodes(range,'covered');};ve.dm.SurfaceFragment.prototype.getSiblingNodes=function(){var range=this.getSelection().getCoveringRange();if(!range){return[];}return this.document.selectNodes(range,'siblings');};ve.dm.SurfaceFragment.prototype.hasMatchingAncestor=function(type,attributes,matchFirstAncestorOfType){var selection=this.getSelection();var all;if(selection instanceof ve.dm.LinearSelection){var nodes=
this.getSelectedLeafNodes();all=!!nodes.length;for(var i=0,len=nodes.length;i<len;i++){if(matchFirstAncestorOfType){var node=nodes[i].findMatchingAncestor(type);if(!(node&&node.compareAttributes(attributes))){all=false;break;}}else{if(!nodes[i].hasMatchingAncestor(type,attributes)){all=false;break;}}}}else if(selection instanceof ve.dm.TableSelection){var cells=selection.getMatrixCells(this.getDocument());all=true;for(var j=cells.length-1;j>=0;j--){if(!cells[j].node.matches(type,attributes)){all=false;break;}}}return all;};ve.dm.SurfaceFragment.prototype.clearPending=function(){this.pending=[];};ve.dm.SurfaceFragment.prototype.pushPending=function(promise){this.pending.push(promise);};ve.dm.SurfaceFragment.prototype.getPending=function(){return ve.promiseAll(this.pending);};ve.dm.SurfaceFragment.prototype.select=function(){this.surface.setSelection(this.getSelection());return this;};ve.dm.SurfaceFragment.prototype.changeAttributes=function(attr,type){var txs=[],covered=this.
getCoveredNodes();for(var i=0,len=covered.length;i<len;i++){var result=covered[i];if(!result.node.isWrapped()||(type&&result.node.getType()!==type)||(result.range&&result.range.isCollapsed())){continue;}txs.push(ve.dm.TransactionBuilder.static.newFromAttributeChanges(this.document,result.nodeOuterRange.start,attr));}if(txs.length){this.change(txs);}return this;};ve.dm.SurfaceFragment.prototype.annotateContent=function(method,nameOrAnnotations,data){var i,ilen,annotations=new ve.dm.AnnotationSet(this.getDocument().getStore()),ranges=this.getSelection().getRanges(this.getDocument()),txs=[];if(nameOrAnnotations instanceof ve.dm.AnnotationSet){annotations=nameOrAnnotations;}else if(nameOrAnnotations instanceof ve.dm.Annotation){annotations.push(nameOrAnnotations);}else{var annotation=ve.dm.annotationFactory.create(nameOrAnnotations,data);if(method==='set'){annotations.push(annotation);}else if(method==='clear'){for(i=0,ilen=ranges.length;i<ilen;i++){annotations.addSet(this.document.data.
getAnnotationsFromRange(ranges[i],true).getAnnotationsByName(annotation.name));}}}for(i=0,ilen=ranges.length;i<ilen;i++){var range=ranges[i];if(!range.isCollapsed()){for(var j=0,jlen=annotations.getLength();j<jlen;j++){var tx=ve.dm.TransactionBuilder.static.newFromAnnotation(this.document,range,method,annotations.get(j));txs.push(tx);}}else{if(method==='set'){this.surface.addInsertionAnnotations(annotations);}else if(method==='clear'){this.surface.removeInsertionAnnotations(annotations);}}}this.change(txs);return this;};ve.dm.SurfaceFragment.prototype.insertContent=function(content,annotate){var range=this.getSelection().getCoveringRange(),doc=this.getDocument();if(!range){return this;}var annotations;if(!range.isCollapsed()){if(annotate){annotations=this.getAnnotations();}this.removeContent();}var offset=range.start;if(typeof content==='string'){var lines=content.split(/[\r\n]+/);if(lines.length>1){content=[];for(var i=0,l=lines.length;i<l;i++){if(lines[i].length){content.push({type:
'paragraph'});ve.batchPush(content,lines[i].split(''));content.push({type:'/paragraph'});}}}else{content=content.split('');}}if(content.length){if(annotate&&!annotations){annotations=doc.data.getAnnotationsFromOffset(offset===0?0:offset-1);}if(annotations&&annotations.getLength()>0){ve.dm.Document.static.addAnnotationsToData(content,annotations,true,doc.store);}var tx=ve.dm.TransactionBuilder.static.newFromInsertion(doc,offset,content);var newRange=tx.getModifiedRange(doc);this.change(tx,newRange?new ve.dm.LinearSelection(newRange):new ve.dm.NullSelection());}return this;};ve.dm.SurfaceFragment.prototype.insertHtml=function(html,importRules){this.insertDocument(this.getDocument().newFromHtml(html,importRules));return this;};ve.dm.SurfaceFragment.prototype.insertDocument=function(newDoc,newDocRange,annotate){var range=this.getSelection().getCoveringRange(),doc=this.getDocument();if(!range){return this;}var annotations;if(!range.isCollapsed()){if(annotate){annotations=this.getAnnotations
();}this.removeContent();}var offset=range.start;if(annotate&&!annotations){annotations=doc.data.getAnnotationsFromOffset(offset===0?0:offset-1);}var annotatedDoc;if(!annotations||annotations.getLength()===0){annotatedDoc=newDoc;}else{var annotatedData=newDoc.data.slice();ve.dm.Document.static.addAnnotationsToData(annotatedData,annotations,true,newDoc.store,true);annotatedDoc=newDoc.cloneWithData(annotatedData);}var tx=ve.dm.TransactionBuilder.static.newFromDocumentInsertion(doc,offset,annotatedDoc,newDocRange);if(!tx.isNoOp()){var newRange=tx.getModifiedRange(doc);this.change(tx,newRange?new ve.dm.LinearSelection(newRange):new ve.dm.NullSelection());}return this;};ve.dm.SurfaceFragment.prototype.removeContent=function(){var range=this.getSelection().getCoveringRange();if(!range){return this;}if(!range.isCollapsed()){this.change(ve.dm.TransactionBuilder.static.newFromRemoval(this.document,range));}return this;};ve.dm.SurfaceFragment.prototype.delete=function(directionAfterDelete){var
rangeToRemove=this.getSelection().getCoveringRange();if(!rangeToRemove||rangeToRemove.isCollapsed()){return this;}var tx=ve.dm.TransactionBuilder.static.newFromRemoval(this.document,rangeToRemove);this.change(tx);var rangeAfterRemove=tx.translateRange(rangeToRemove);var endNode;if(!rangeAfterRemove.isCollapsed()&&(endNode=this.document.getBranchNodeFromOffset(rangeAfterRemove.end,false))&&endNode.getRange().start>=rangeAfterRemove.end){var startNode=this.document.getBranchNodeFromOffset(rangeAfterRemove.start,false);if(startNode.getRange().isCollapsed()){while(true){tx=ve.dm.TransactionBuilder.static.newFromRemoval(this.document,startNode.getOuterRange());startNode=startNode.getParent();this.change(tx);if(!(startNode&&startNode.children.length===0&&(startNode.hasSlugAtOffset(startNode.getRange().start)||startNode instanceof ve.dm.DefinitionListNode||startNode instanceof ve.dm.ListNode)&&startNode.canHaveChildrenNotContent())){break;}rangeAfterRemove=tx.translateRange(rangeAfterRemove);
}}else{var endNodeData=this.document.getData(endNode.getRange());var nodeToDelete=endNode;nodeToDelete.traverseUpstream(function(node){var parent=node.getParent();if(parent.children.length===1){nodeToDelete=parent;return true;}else{return false;}});tx=ve.dm.TransactionBuilder.static.newFromRemoval(this.document,nodeToDelete.getOuterRange());if(!tx.isNoOp()){this.change(tx);this.change(ve.dm.TransactionBuilder.static.newFromInsertion(this.document,rangeAfterRemove.start,endNodeData));}}}var nearestOffset=this.document.data.getNearestContentOffset(rangeAfterRemove.start,directionAfterDelete||-1);if(nearestOffset>-1){rangeAfterRemove=new ve.Range(nearestOffset);}else{rangeAfterRemove=new ve.Range(rangeAfterRemove.start);}this.change([],new ve.dm.LinearSelection(rangeAfterRemove));return this;};ve.dm.SurfaceFragment.prototype.convertNodes=function(type,attr,internal){var range=this.getSelection().getCoveringRange();if(!range){return this;}this.change(ve.dm.TransactionBuilder.static.
newFromContentBranchConversion(this.document,range,type,attr,internal));return this;};ve.dm.SurfaceFragment.prototype.wrapNodes=function(wrapper){var range=this.getSelection().getCoveringRange();if(!range){return this;}if(!Array.isArray(wrapper)){wrapper=[wrapper];}this.change(ve.dm.TransactionBuilder.static.newFromWrap(this.document,range,[],[],[],wrapper));return this;};ve.dm.SurfaceFragment.prototype.unwrapNodes=function(outerDepth,innerDepth){var range=this.getSelection().getCoveringRange();if(!range){return this;}if(range.getLength()<innerDepth*2){throw new Error('cannot unwrap by greater depth than maximum theoretical depth of selection');}var i;var innerUnwrapper=[];var outerUnwrapper=[];for(i=0;i<innerDepth;i++){innerUnwrapper.push(this.document.data.getData(range.start+i));}for(i=outerDepth;i>0;i--){outerUnwrapper.push(this.document.data.getData(range.start-i));}this.change(ve.dm.TransactionBuilder.static.newFromWrap(this.document,range,outerUnwrapper,[],innerUnwrapper,[]));
return this;};ve.dm.SurfaceFragment.prototype.rewrapNodes=function(depth,wrapper){var range=this.getSelection().getCoveringRange();if(!range){return this;}if(!Array.isArray(wrapper)){wrapper=[wrapper];}if(range.getLength()<depth*2){throw new Error('cannot unwrap by greater depth than maximum theoretical depth of selection');}var unwrapper=[];for(var i=0;i<depth;i++){unwrapper.push(this.document.data.getData(range.start+i));}this.change(ve.dm.TransactionBuilder.static.newFromWrap(this.document,range,[],[],unwrapper,wrapper));return this;};ve.dm.SurfaceFragment.prototype.wrapAllNodes=function(wrapOuter,wrapEach){var range=this.getSelection().getCoveringRange();if(!range){return this;}if(!Array.isArray(wrapOuter)){wrapOuter=[wrapOuter];}wrapEach=wrapEach||[];if(!Array.isArray(wrapEach)){wrapEach=[wrapEach];}this.change(ve.dm.TransactionBuilder.static.newFromWrap(this.document,range,[],wrapOuter,[],wrapEach));return this;};ve.dm.SurfaceFragment.prototype.rewrapAllNodes=function(depth,
wrapper){var range=this.getSelection().getCoveringRange(),unwrapper=[];if(!range){return this;}var innerRange=new ve.Range(range.start+depth,range.end-depth);if(!Array.isArray(wrapper)){wrapper=[wrapper];}if(range.getLength()<depth*2){throw new Error('cannot unwrap by greater depth than maximum theoretical depth of selection');}for(var i=0;i<depth;i++){unwrapper.push(this.document.data.getData(range.start+i));}this.change(ve.dm.TransactionBuilder.static.newFromWrap(this.document,innerRange,unwrapper,wrapper,[],[]));return this;};ve.dm.SurfaceFragment.prototype.isolateAndUnwrap=function(isolateForType){var startOffset,endOffset,insertions=[],outerDepth=0,factory=ve.dm.nodeFactory,startSplitRequired=false,endSplitRequired=false,startSplitNodes=[],endSplitNodes=[],fragment=this;function createSplits(splitNodes,insertBefore){var i,length,adjustment=0,data=[];for(i=0,length=splitNodes.length;i<length;i++){data.unshift({type:'/'+splitNodes[i].type});data.push(splitNodes[i].getClonedElement()
);if(insertBefore){adjustment+=2;}}insertions.push({offset:insertBefore?startOffset:endOffset,data:data});startOffset+=adjustment;endOffset+=adjustment;}if(!(this.selection instanceof ve.dm.LinearSelection)){return this;}var allowedParents=factory.getSuggestedParentNodeTypes(isolateForType);var nodes=this.getSiblingNodes();var startSplitNode=nodes[0].node;startOffset=startSplitNode.getOuterRange().start;if(allowedParents!==null){while(allowedParents.indexOf(startSplitNode.getParent().type)===-1){if(startSplitNode.getParent().indexOf(startSplitNode)>0){startSplitRequired=true;}startSplitNode=startSplitNode.getParent();if(startSplitRequired){startSplitNodes.unshift(startSplitNode);}else{startOffset=startSplitNode.getOuterRange().start;}outerDepth++;}}var endSplitNode=nodes[nodes.length-1].node;endOffset=endSplitNode.getOuterRange().end;if(allowedParents!==null){while(allowedParents.indexOf(endSplitNode.getParent().type)===-1){if(endSplitNode.getParent().indexOf(endSplitNode)<endSplitNode
.getParent().getChildren().length-1){endSplitRequired=true;}endSplitNode=endSplitNode.getParent();if(endSplitRequired){endSplitNodes.unshift(endSplitNode);}else{endOffset=endSplitNode.getOuterRange().end;}}}var oldExclude=this.willExcludeInsertions();this.setExcludeInsertions(true);if(startSplitRequired){createSplits(startSplitNodes,true);}if(endSplitRequired){createSplits(endSplitNodes,false);}insertions.forEach(function(insertion){fragment.change(ve.dm.TransactionBuilder.static.newFromInsertion(fragment.getDocument(),insertion.offset,insertion.data));});this.setExcludeInsertions(oldExclude);this.unwrapNodes(outerDepth,0);return this;};ve.dm.SourceSurfaceFragment=function VeDmSourceSurfaceFragment(){ve.dm.SourceSurfaceFragment.super.apply(this,arguments);};OO.inheritClass(ve.dm.SourceSurfaceFragment,ve.dm.SurfaceFragment);ve.dm.SourceSurfaceFragment.prototype.annotateContent=function(){var args=arguments,fragment=this,text=this.getText(true);this.pushPending(this.convertFromSource(
text).then(function(selectionDocument){var tempSurfaceModel=new ve.dm.Surface(selectionDocument);var tempFragment=tempSurfaceModel.getLinearFragment(selectionDocument.getDocumentRange());tempFragment.annotateContent.apply(tempFragment,args);fragment.clearPending();fragment.insertDocument(tempFragment.getDocument());return fragment.getPending();}));return this;};ve.dm.SourceSurfaceFragment.prototype.getAnnotations=function(){return new ve.dm.AnnotationSet(this.getDocument().getStore());};ve.dm.SourceSurfaceFragment.prototype.convertNodes=function(){var args=arguments,fragment=this,text=this.getText(true);this.pushPending(this.convertFromSource(text).then(function(selectionDocument){var tempSurfaceModel=new ve.dm.Surface(selectionDocument);var tempFragment=tempSurfaceModel.getLinearFragment(selectionDocument.getDocumentRange());tempFragment.convertNodes.apply(tempFragment,args);fragment.clearPending();fragment.insertDocument(tempFragment.getDocument());return fragment.getPending();}));
return this;};ve.dm.SourceSurfaceFragment.prototype.insertContent=function(content,annotate){if(typeof content!=='string'){var data=new ve.dm.ElementLinearData(new ve.dm.HashValueStore(),content);if(!data.isPlainText(null,false,['paragraph'],annotate)){this.insertDocument(new ve.dm.Document(content.concat([{type:'internalList'},{type:'/internalList'}])));return this;}}else{content=ve.dm.sourceConverter.getDataFromSourceText(content,true);}return ve.dm.SourceSurfaceFragment.super.prototype.insertContent.call(this,content);};ve.dm.SourceSurfaceFragment.prototype.insertDocument=function(doc,newDocRange,annotate){var range=this.getSelection().getCoveringRange(),fragment=this;if(!range){return this;}if(newDocRange){doc=doc.shallowCloneFromRange(newDocRange);newDocRange=doc.originalRange;}if(doc.data.isPlainText(newDocRange,false,['paragraph'],annotate)){var data=doc.data.getDataSlice(newDocRange);for(var i=0,l=data.length;i<l;i++){if(Array.isArray(data[i])){data[i]=data[i][0];}if(data[i]===
'\r'){data.splice(i,1);i--;l--;}else if(data[i]==='\n'){data.splice(i,1,{type:'/paragraph'},{type:'paragraph'});i++;l++;}else if(data[i]==='\u00a0'){data[i]=' ';}}return ve.dm.SourceSurfaceFragment.super.prototype.insertContent.call(this,data);}this.pushPending(this.convertToSource(doc).then(function(source){fragment.insertContent(source.trim());},function(){ve.error('Failed to convert document',arguments);return ve.createDeferred().reject().promise();}));return this;};ve.dm.SourceSurfaceFragment.prototype.wrapAllNodes=function(wrapOuter,wrapEach){var content,range=this.getSelection().getCoveringRange();if(!range){return this;}function getOpening(element){element.internal={whitespace:['\n','\n','\n','\n']};return element;}function getClosing(element){return{type:'/'+element.type};}if(!Array.isArray(wrapOuter)){wrapOuter=[wrapOuter];}wrapEach=wrapEach||[];if(!Array.isArray(wrapEach)){wrapEach=[wrapEach];}var nodes=this.getSelectedLeafNodes();content=wrapOuter.map(getOpening);for(var i=0
;i<nodes.length;i++){var node=nodes[i];content=content.concat(wrapEach.map(getOpening)).concat(this.getSurface().getLinearFragment(node.getRange()).getText().split('')).concat(wrapEach.reverse().map(getClosing));}content=content.concat(wrapOuter.reverse().map(getClosing));this.insertContent(content);return this;};ve.dm.SourceSurfaceFragment.prototype.convertToSource=function(doc){if(!doc.data.hasContent()){return ve.createDeferred().resolve('').promise();}else{return ve.createDeferred().resolve(ve.properInnerHtml(ve.dm.converter.getDomFromModel(doc).body)).promise();}};ve.dm.SourceSurfaceFragment.prototype.convertFromSource=function(source){var lang=this.getDocument().getLang(),dir=this.getDocument().getDir();if(!source){return ve.createDeferred().resolve(new ve.dm.Document([{type:'paragraph',internal:{generated:'wrapper'}},{type:'/paragraph'},{type:'internalList'},{type:'/internalList'}],null,null,null,null,lang,dir)).promise();}else{return ve.createDeferred().resolve(ve.dm.converter.
getModelFromDom(ve.createDocumentFromHtml(source,{lang:lang,dir:dir}))).promise();}};ve.dm.DataString=function VeDmDataString(data){this.data=data;};OO.inheritClass(ve.dm.DataString,unicodeJS.TextString);ve.dm.DataString.prototype.read=function(position){var dataAt=this.data[position];if(dataAt!==undefined&&dataAt.type===undefined){return typeof dataAt==='string'?dataAt:dataAt[0];}else{return null;}};ve.dm.Document=function VeDmDocument(data,htmlDocument,parentDocument,internalList,innerWhitespace,lang,dir,originalDocument,sourceMode,persistentStorage){ve.dm.Document.super.call(this,new ve.dm.DocumentNode());var doc=parentDocument||this;var root=this.documentNode;this.lang=lang||'en';this.dir=dir||'ltr';this.sourceMode=!!sourceMode;this.documentNode.setRoot(root);this.documentNode.setDocument(doc);this.internalList=internalList?internalList.clone(this):new ve.dm.InternalList(this);this.innerWhitespace=innerWhitespace?ve.copy(innerWhitespace):new Array(2);this.parentDocument=
parentDocument||null;this.originalDocument=originalDocument||null;this.nodesByType={};this.origInternalListLength=null;this.readOnly=false;this.branchNodeFromOffsetCache=[];if(data instanceof ve.dm.ElementLinearData){this.data=data;}else if(data instanceof ve.dm.FlatLinearData){this.data=new ve.dm.ElementLinearData(data.getStore(),data.getData());}else{this.data=new ve.dm.ElementLinearData(new ve.dm.HashValueStore(),Array.isArray(data)?data:[]);}this.store=this.data.getStore();this.completeHistory=new ve.dm.Change();this.completeHistory.store=this.store;if(this.store.getLength()>0){this.completeHistory.transactions.push(new ve.dm.Transaction([{type:'retain',length:this.data.data.length}]));this.completeHistory.storeLengthAtTransaction.push(this.store.getLength());}this.htmlDocument=htmlDocument||ve.createDocumentFromHtml('');this.persistentStorage=persistentStorage||{};};OO.inheritClass(ve.dm.Document,ve.Document);ve.dm.Document.static.addAnnotationsToData=function(data,annotationSet,
replaceComparable,store,prepend){var ignoreChildrenDepth=0,offset=prepend?0:undefined;if(annotationSet.isEmpty()){return;}if(store){store.merge(annotationSet.getStore());}else{store=annotationSet.getStore();}if(!(data instanceof ve.dm.ElementLinearData)){data=new ve.dm.ElementLinearData(store,data);}for(var i=0,length=data.getLength();i<length;i++){if(data.isElementData(i)&&ve.dm.nodeFactory.shouldIgnoreChildren(data.getType(i))){ignoreChildrenDepth+=data.isOpenElementData(i)?1:-1;}if(ignoreChildrenDepth){continue;}var allowedAnnotations=annotationSet.filter(function(ann){return data.canTakeAnnotationAtOffset(i,ann,true);});var existingAnnotations=data.getAnnotationsFromOffset(i,true);var newAnnotationSet;if(!existingAnnotations.isEmpty()){newAnnotationSet=existingAnnotations;if(replaceComparable){newAnnotationSet=newAnnotationSet.withoutComparableSet(allowedAnnotations);}newAnnotationSet.addSet(allowedAnnotations,offset);}else{newAnnotationSet=allowedAnnotations;}data.
setAnnotationsAtOffset(i,newAnnotationSet);}};ve.dm.Document.static.newBlankDocument=function(paragraphType){var paragraph={type:'paragraph'};paragraphType=paragraphType===undefined?'empty':paragraphType;if(paragraphType){ve.setProp(paragraph,'internal','generated',paragraphType);}return new ve.dm.Document([paragraph,{type:'/paragraph'},{type:'internalList'},{type:'/internalList'}]);};ve.dm.Document.prototype.getDocumentNode=function(){if(!this.documentNode.length&&!this.documentNode.getDocument().buildingNodeTree){this.buildNodeTree();}return this.documentNode;};ve.dm.Document.prototype.getDocumentRange=function(){return new ve.Range(0,this.getInternalList().getListNode().getOuterRange().start);};ve.dm.Document.prototype.buildNodeTree=function(){var textLength=0,inTextNode=false;var currentStack=[];var parentStack=[this.documentNode];var nodeStack=[parentStack,currentStack];var currentNode=this.documentNode;var doc=this.documentNode.getDocument();for(var i=0,len=this.data.getLength();
i<len;i++){var node;if(!this.data.isElementData(i)){if(!inTextNode){node=new ve.dm.TextNode();currentStack.push(node);currentNode=node;inTextNode=true;}textLength++;}else{if(inTextNode){currentNode.setLength(textLength);currentNode=parentStack[parentStack.length-1];inTextNode=false;textLength=0;}if(this.data.isOpenElementData(i)){node=ve.dm.nodeFactory.createFromElement(this.data.getData(i));currentStack.push(node);if(ve.dm.nodeFactory.canNodeHaveChildren(node.getType())){parentStack=currentStack;currentStack=[];nodeStack.push(currentStack);currentNode=node;}else{if(!this.data.isCloseElementData(i+1)||this.data.getType(i+1)!==this.data.getType(i)){throw new Error('Opening element for node that cannot have children must be followed by closing element');}i++;}}else{if(this.data.getType(i)!==currentNode.getType()){throw new Error('Expected closing for '+currentNode.getType()+' but got closing for '+this.data.getType(i));}var children=nodeStack.pop();currentStack=parentStack;parentStack=
nodeStack[nodeStack.length-2];if(!parentStack){throw new Error('Unbalanced input passed to document');}ve.batchSplice(currentNode,0,0,children);currentNode=parentStack[parentStack.length-1];}}}if(inTextNode){currentNode.setLength(textLength);}doc.buildingNodeTree=true;if(nodeStack.length>2){throw new Error('Unbalanced input passed to document');}ve.batchSplice(this.documentNode,0,0,currentStack);this.updateNodesByType([this.documentNode],[this.documentNode]);doc.buildingNodeTree=false;};ve.dm.Document.prototype.getLength=function(){return this.data.getLength();};ve.dm.Document.prototype.setReadOnly=function(readOnly){this.readOnly=!!readOnly;if(!this.readOnly){this.getDocumentNode().traverse(function(node){node.offset=null;});}};ve.dm.Document.prototype.isReadOnly=function(){return this.readOnly;};ve.dm.Document.prototype.commit=function(transaction,isStaging){if(transaction.hasBeenApplied()){throw new Error('Cannot commit a transaction that has already been committed');}this.emit(
'precommit',transaction);this.branchNodeFromOffsetCache=[];new ve.dm.TransactionProcessor(this,transaction,isStaging).process();this.completeHistory.pushTransaction(transaction,this.store.getLength());this.emit('transact',transaction);};ve.dm.Document.prototype.getData=function(range,deep){return this.data.getDataSlice(range,deep);};ve.dm.Document.prototype.getMetadata=function(range){if(arguments.length>1){throw new Error('Argument "deep" is no longer supported');}var documentNode=this.getDocumentNode();if(!range){range=new ve.Range(0,documentNode.length);}var data=[];documentNode.traverse(function(node){var offset;if(node instanceof ve.dm.MetaItem){offset=node.getOffset();if(range.start<=offset&&offset<range.end){data[offset-range.start]=node;}}});data.length=range.end-range.start;return data;};ve.dm.Document.prototype.getHtmlDocument=function(){return this.htmlDocument;};ve.dm.Document.prototype.getOriginalDocument=function(){return this.originalDocument;};ve.dm.Document.prototype.
getStore=function(){return this.store;};ve.dm.Document.prototype.getInternalList=function(){return this.internalList;};ve.dm.Document.prototype.getInnerWhitespace=function(){return this.innerWhitespace;};ve.dm.Document.prototype.shallowCloneFromSelection=function(selection){if(selection instanceof ve.dm.LinearSelection){return this.shallowCloneFromRange(selection.getRange());}else if(selection instanceof ve.dm.TableSelection){var data=[];var ranges=selection.getTableSliceRanges(this);for(var i=0,l=ranges.length;i<l;i++){data=data.concat(this.data.slice(ranges[i].start,ranges[i].end));}var linearData=new ve.dm.ElementLinearData(this.getStore(),data);var tableRange=new ve.Range(0,data.length);ve.batchSplice(linearData.data,linearData.getLength(),0,this.getData(this.getInternalList().getListNode().getOuterRange(),true));return new ve.dm.TableSlice(linearData,this.getHtmlDocument(),undefined,this.getInternalList(),tableRange,this);}else{return this.shallowCloneFromRange(new ve.Range(0));}}
;ve.dm.Document.prototype.shallowCloneFromRange=function(range){var linearData,originalRange,balancedRange,balanceOpenings=[],balanceClosings=[],contextOpenings=[],contextClosings=[];if(!range){linearData=this.data.sliceObject();originalRange=balancedRange=this.getDocumentRange();}else{var selection=this.selectNodes(range,'siblings');var first=selection[0];var last=selection[selection.length-1];var firstNode=first.node;var lastNode=last.node;var startNode=!firstNode.hasChildren()&&!firstNode.isContent()?firstNode:this.getBranchNodeFromOffset(range.start);var endNode=!lastNode.hasChildren()&&!lastNode.isContent()?lastNode:this.getBranchNodeFromOffset(range.end);while(selection[0]&&selection[0].range&&selection[0].range.isCollapsed()&&!selection[0].node.isWrapped()){selection.shift();}var i=selection.length-1;while(selection[i]&&selection[i].range&&selection[i].range.isCollapsed()&&!selection[i].node.isWrapped()){selection.pop();i--;}var balancedNodes;if(selection.length===0||range.
isCollapsed()){linearData=new ve.dm.ElementLinearData(this.getStore(),[{type:'paragraph',internal:{generated:'empty'}},{type:'/paragraph'}]);originalRange=balancedRange=new ve.Range(1);}else if(startNode===endNode){balancedNodes=selection;}else{while(!firstNode.isWrapped()){firstNode=firstNode.getParent();}while(!lastNode.isWrapped()){lastNode=lastNode.getParent();}if(first.range){while(true){while(!startNode.isWrapped()){startNode=startNode.getParent();}balanceOpenings.push(startNode.getClonedElement());if(startNode===firstNode){break;}startNode=startNode.getParent();}}if(last!==first&&last.range){while(true){while(!endNode.isWrapped()){endNode=endNode.getParent();}balanceClosings.push({type:'/'+endNode.getType()});if(endNode===lastNode){break;}endNode=endNode.getParent();}}balancedNodes=this.selectNodes(new ve.Range(firstNode.getOuterRange().start,lastNode.getOuterRange().end),'covered');}function nodeNeedsContext(node){return node.getParentNodeTypes()!==null||node.isContent();}if(!
balancedRange){var needsContext=false;for(i=balancedNodes.length-1;i>=0;i--){if(nodeNeedsContext(balancedNodes[i].node)){needsContext=true;break;}}if(needsContext){startNode=balancedNodes[0].node;while(startNode.getParent()&&nodeNeedsContext(startNode)){var isContent=startNode.isContent();startNode=startNode.getParent();var contextElement=startNode.getClonedElement();if(isContent){ve.setProp(contextElement,'internal','generated','wrapper');}contextOpenings.push(contextElement);contextClosings.push({type:'/'+contextElement.type});}}linearData=new ve.dm.ElementLinearData(this.getStore(),contextOpenings.reverse().concat(balanceOpenings.reverse()).concat(this.data.slice(range.start,range.end)).concat(balanceClosings).concat(contextClosings));originalRange=new ve.Range(contextOpenings.length+balanceOpenings.length,contextOpenings.length+balanceOpenings.length+range.getLength());balancedRange=new ve.Range(contextOpenings.length,contextOpenings.length+balanceOpenings.length+range.getLength()+
balanceClosings.length);}ve.batchSplice(linearData.data,linearData.getLength(),0,this.getData(this.getInternalList().getListNode().getOuterRange()));}var slice=new ve.dm.DocumentSlice(linearData,this.getHtmlDocument(),undefined,this.getInternalList(),originalRange,balancedRange,this);return slice;};ve.dm.Document.prototype.cloneFromRange=function(range,detachedCopy,mode){var listRange=this.getInternalList().getListNode().getOuterRange(),data=ve.copy(this.getFullData(range,mode||'roundTrip'));if(range&&(range.start>listRange.start||range.end<listRange.end)){data=data.concat(this.getFullData(listRange));}return this.cloneWithData(data,true,detachedCopy);};ve.dm.Document.prototype.cloneWithData=function(data,copyInternalList,detachedCopy){var newDoc;if(Array.isArray(data)){data=new ve.dm.ElementLinearData(this.getStore().clone(),data);}newDoc=new this.constructor(data,this.getHtmlDocument(),undefined,copyInternalList?this.getInternalList():undefined,undefined,this.getLang(),this.getDir(),
this,this.sourceMode,this.getStorage());if(copyInternalList&&!detachedCopy){newDoc.origInternalListLength=this.internalList.getItemNodeCount();}return newDoc;};ve.dm.Document.prototype.getFullData=function(range,mode){var insertedMetaItems=[],insertions={},iLen=range?range.end:this.data.getLength(),result=[];function stripMetaLoadInfo(element){if(!element||!element.internal){return element;}element=ve.copy(element);delete element.internal.changesSinceLoad;delete element.internal.metaItems;delete element.internal.loadMetaParentHash;delete element.internal.loadMetaParentOffset;if(Object.keys(element.internal).length===0){delete element.internal;}return element;}for(var i=range?range.start:0;i<iLen;i++){var item=this.data.getData(i);if(ve.dm.LinearData.static.isOpenElementData(item)&&ve.dm.nodeFactory.isMetaData(item.type)&&(mode==='noMetadata'||mode==='roundTrip'&&(insertedMetaItems.indexOf(item.originalDomElementsHash)!==-1||ve.dm.nodeFactory.isRemovableMetaData(item.type)&&ve.getProp(
item,'internal','loadMetaParentOffset')))){i+=1;continue;}var metaItem,metaItems,internal;var j,jLen;if(mode==='roundTrip'&&(internal=item.internal)&&(metaItems=internal.metaItems)){if(!internal.changesSinceLoad){this.data.modifyData(i,function(item){metaItems=item.internal.metaItems;for(j=0,jLen=metaItems.length;j<jLen;j++){metaItem=metaItems[j];var offset=i+metaItem.internal.loadMetaParentOffset;if(!insertions[offset]){insertions[offset]=[];}delete metaItem.internal.loadBranchNodeHash;delete metaItem.internal.loadBranchNodeOffset;if(Object.keys(metaItem.internal).length===0){delete metaItem.internal;}insertions[offset].push(stripMetaLoadInfo(metaItem));insertedMetaItems.push(metaItem.originalDomElementsHash);}});}else{for(j=0,jLen=metaItems.length;j<jLen;j++){metaItem=metaItems[j];if(ve.dm.nodeFactory.isRemovableMetaData(metaItem.type)){insertedMetaItems.push(metaItem.originalDomElementsHash);}}}}result.push(stripMetaLoadInfo(item));if(mode==='roundTrip'&&insertions[i]){for(j=0,jLen=
insertions[i].length;j<jLen;j++){metaItem=insertions[i][j];result.push(metaItem);result.push({type:'/'+metaItem.type});}}}return result;};ve.dm.Document.prototype.getSiblingWordBoundary=function(offset,direction){var dataString=new ve.dm.DataString(this.getData());return unicodeJS.wordbreak.moveBreakOffset(direction,dataString,offset,true);};ve.dm.Document.prototype.getRelativeOffset=function(offset,direction,unit){var data=this.data;if(unit==='word'){var newOffset=this.getSiblingWordBoundary(offset,direction);if(offset===newOffset){newOffset=this.getRelativeOffset(offset,direction,'character');}return newOffset;}else{var adjacentDataOffset=offset+(direction>0?0:-1);if(data.isElementData(adjacentDataOffset)&&ve.dm.nodeFactory.isNodeFocusable(data.getType(adjacentDataOffset))){return offset+direction;}var relativeContentOffset=data.getRelativeContentOffset(offset,direction);var relativeStructuralOffset=data.getRelativeStructuralOffset(offset,direction,true);var isFocusable;if((
relativeStructuralOffset-offset<0?-1:1)!==direction){relativeStructuralOffset=offset;}else{isFocusable=(relativeStructuralOffset-offset<0?-1:1)===direction&&data.isElementData(relativeStructuralOffset+direction)&&ve.dm.nodeFactory.isNodeFocusable(data.getType(relativeStructuralOffset+direction));}if(isFocusable||this.hasSlugAtOffset(relativeStructuralOffset)){if(isFocusable){relativeStructuralOffset+=direction;}if(relativeContentOffset===offset||(relativeContentOffset-offset<0?-1:1)!==direction){return relativeStructuralOffset;}return direction>0?Math.min(relativeContentOffset,relativeStructuralOffset):Math.max(relativeContentOffset,relativeStructuralOffset);}else{return direction>0?Math.max(relativeContentOffset,offset):Math.min(relativeContentOffset,offset);}}};ve.dm.Document.prototype.getRelativeRange=function(range,direction,unit,expand,limit){var to=range.to;if(!range.isCollapsed()&&!expand){var newOffset=direction>0?range.end:range.start;if(this.data.isContentOffset(newOffset)||
this.hasSlugAtOffset(newOffset)){return new ve.Range(newOffset);}else{to=newOffset;}}var contentOrSlugOffset=this.getRelativeOffset(to,direction,unit);var focusableNode=this.getNearestFocusableNode(to,direction,contentOrSlugOffset);var newRange;if(focusableNode){newRange=focusableNode.getOuterRange(direction===-1);}else{newRange=new ve.Range(contentOrSlugOffset);}if(limit&&!limit.containsRange(newRange)){return range;}if(expand){return new ve.Range(range.from,newRange.to);}else{return newRange;}};ve.dm.Document.prototype.getNearestFocusableNode=function(offset,direction,limit){var coveredOffset;this.data.getRelativeOffset(offset,direction===1?0:-1,function(index,lim){if(index>=Math.max(offset,lim)||index<Math.min(offset,lim)){return true;}if(this.isOpenElementData(index)&&ve.dm.nodeFactory.isNodeFocusable(this.getType(index))){coveredOffset=index+1;return true;}if(this.isCloseElementData(index)&&ve.dm.nodeFactory.isNodeFocusable(this.getType(index))){coveredOffset=index;return true;}},
limit);if(coveredOffset){return this.getDocumentNode().getNodeFromOffset(coveredOffset);}else{return null;}};ve.dm.Document.prototype.getNearestCursorOffset=function(offset,direction){if(direction===0){var left=this.getNearestCursorOffset(offset,-1);var right=this.getNearestCursorOffset(offset,1);if(right===-1){return left;}else if(left===-1){return right;}return offset-left<right-offset?left:right;}direction=direction>0?1:-1;if(this.data.isContentOffset(offset)||this.hasSlugAtOffset(offset)){return offset;}var contentOffset=this.data.getNearestContentOffset(offset,direction);var structuralOffset=this.data.getNearestStructuralOffset(offset,direction,true);if(structuralOffset===-1||!this.hasSlugAtOffset(structuralOffset)){return contentOffset;}else if(contentOffset===-1){return structuralOffset;}if(direction===1){if(contentOffset<offset){return structuralOffset;}else{return Math.min(contentOffset,structuralOffset);}}else{if(contentOffset>offset){return structuralOffset;}else{return Math
.max(contentOffset,structuralOffset);}}};ve.dm.Document.prototype.getBranchNodeFromOffset=function(offset){if(offset<0||offset>this.data.getLength()){throw new Error('ve.dm.Document.getBranchNodeFromOffset(): offset '+offset+' is out of bounds');}if(!this.branchNodeFromOffsetCache[offset]){this.branchNodeFromOffsetCache[offset]=ve.Document.prototype.getBranchNodeFromOffset.call(this,offset);}return this.branchNodeFromOffsetCache[offset];};ve.dm.Document.prototype.hasSlugAtOffset=function(offset){var node;try{node=this.getBranchNodeFromOffset(offset);}catch(e){}return node?node.hasSlugAtOffset(offset):false;};ve.dm.Document.prototype.getDataFromNode=function(node){var offset=node.getOffset();if(offset>=0){if(node.isWrapped()){offset++;}return this.data.slice(offset,offset+node.getLength());}return null;};ve.dm.Document.prototype.rebuildTree=function(){var rootNode=this.attachedRoot||this.getDocumentNode();var range=rootNode.getRange();var data=this.data.sliceObject(range.start,range.end
);var documentFragment=new ve.dm.Document(data,this.htmlDocument,this);var addedNodes=documentFragment.getDocumentNode().getChildren();var removedNodes=ve.batchSplice(rootNode,0,rootNode.getChildren().length,addedNodes);this.updateNodesByType(addedNodes,removedNodes);};ve.dm.Document.prototype.updateNodesByType=function(addedNodes,removedNodes){var doc=this;function remove(node){var type=node.getType(),nodes=doc.nodesByType[type]||[],index=nodes.indexOf(node);if(index!==-1){nodes.splice(index,1);if(!nodes.length){delete doc.nodesByType[type];}}}function add(node){var type=node.getType(),nodes=doc.nodesByType[type]=doc.nodesByType[type]||[];nodes.push(node);}function traverse(nodes,action){nodes.forEach(function(node){if(node.hasChildren()){node.traverse(action);}action(node);});}traverse(removedNodes,remove);traverse(addedNodes,add);};ve.dm.Document.prototype.getNodesByType=function(type,sort){var nodes=[];if(!this.documentNode.length&&!this.documentNode.getDocument().buildingNodeTree)
{this.buildNodeTree();}if(type instanceof Function){for(var t in this.nodesByType){var nodeType=ve.dm.nodeFactory.lookup(t);if(nodeType===type||nodeType.prototype instanceof type){nodes=nodes.concat(this.getNodesByType(t));}}}else{nodes=this.nodesByType[type]||[];}if(sort){nodes.sort(function(a,b){return a.getOffset()-b.getOffset();});}return nodes;};ve.dm.Document.prototype.fixupInsertion=function(data,offset){var newData=[],remove=0,openingStack=[],closingStack=[],insertedDataOffset=0,insertedDataLength=data.length,doc=this,parentNode,parentType,inTextNode,isFirstChild,childType,allowedParents,allowedChildren,parentsOK,childrenOK,suggestedParents,suggestedParentsOK,openings,closings,reopenElements,popped,insertion,i,j;function writeElement(element,index){if(element.type!==undefined){if(element.type.charAt(0)!=='/'){if(openingStack.length===0&&closingStack.length>0&&closingStack[closingStack.length-1].getType()===element.type){parentNode=closingStack.pop();}else{openingStack.push(
element);}parentType=element.type;}else{var expectedType;if(openingStack.length>0){expectedType=openingStack.pop().type;}else{expectedType=parentNode.getType();closingStack.push(parentNode);parentNode=parentNode.getParent();if(!parentNode){throw new Error('Inserted data is trying to close the root node '+'(at index '+index+')');}parentType=expectedType;if(element.type!=='/'+expectedType&&(!ve.dm.nodeFactory.canNodeContainContent(element.type.slice(1))||!ve.dm.nodeFactory.canNodeContainContent(expectedType))){throw new Error('Cannot adopt content from '+element.type+' nodes into '+expectedType+' nodes (at index '+index+')');}}}}newData.push(element);}function closeElement(type){closings.push({type:'/'+parentType});if(openingStack.length>0){var element=openingStack.pop();parentType=element.type;reopenElements.push(ve.copy(element));}else{if(!parentNode.getParent()){throw new Error('Cannot insert '+type+' even after closing '+'all containing nodes (at index '+i+')');}closingStack.push(
parentNode);reopenElements.push(parentNode.getClonedElement());parentNode=parentNode.getParent();parentType=parentNode.getType();}}parentNode=this.getBranchNodeFromOffset(offset);parentType=parentNode.getType();inTextNode=false;isFirstChild=doc.data.isOpenElementData(offset-1);for(i=0;i<data.length;i++){if(inTextNode&&data[i].type!==undefined){parentType=openingStack.length>0?openingStack[openingStack.length-1].type:parentNode.getType();}if(data[i].type===undefined||data[i].type.charAt(0)!=='/'){childType=data[i].type||'text';openings=[];closings=[];reopenElements=[];if(ve.dm.nodeFactory.isNodeContent(childType)&&!ve.dm.nodeFactory.canNodeContainContent(parentType)){childType='paragraph';var wrapper=ve.dm.nodeFactory.getDataElement(childType);ve.setProp(wrapper,'internal','generated','wrapper');openings.unshift(wrapper);}do{allowedParents=ve.dm.nodeFactory.getParentNodeTypes(childType);parentsOK=allowedParents===null||allowedParents.indexOf(parentType)!==-1;if(!parentsOK){if(
allowedParents.length===0){throw new Error('Cannot insert '+childType+' because it '+' cannot have a parent (at index '+i+')');}childType=allowedParents[0];openings.unshift(ve.dm.nodeFactory.getDataElement(childType));}}while(!parentsOK);suggestedParents=ve.dm.nodeFactory.getSuggestedParentNodeTypes(childType);do{suggestedParentsOK=suggestedParents===null||suggestedParents.indexOf(parentType)!==-1;if(!suggestedParentsOK){closeElement(childType);}}while(!suggestedParentsOK);do{allowedChildren=ve.dm.nodeFactory.getChildNodeTypes(parentType);childrenOK=allowedChildren===null||allowedChildren.indexOf(childType)!==-1;childrenOK=childrenOK&&!(!ve.dm.nodeFactory.isNodeContent(childType)&&ve.dm.nodeFactory.canNodeContainContent(parentType));if(!childrenOK){if(isFirstChild){insertion=this.fixupInsertion(data,offset-1);if(doc.data.isCloseElementData(offset)&&!ve.dm.nodeFactory.isNodeInternal(parentType)){insertion.remove+=2;}return insertion;}closeElement(childType);}}while(!childrenOK);for(j=0;
j<closings.length;j++){if(i===0){insertedDataOffset++;}else{insertedDataLength++;}newData.push(closings[j]);}for(j=0;j<openings.length;j++){if(i===0){insertedDataOffset++;}else{insertedDataLength++;}writeElement(openings[j],i);}writeElement(data[i],i);if(data[i].type===undefined){inTextNode=true;if(openings.length>0){parentType=childType;}}else{parentType=data[i].type;}}else{writeElement(data[i],i);parentType=openingStack.length>0?openingStack[openingStack.length-1].type:parentNode.getType();}}if(closingStack.length>0&&doc.data.isCloseElementData(offset)){return this.fixupInsertion(data,offset+1);}if(inTextNode){parentType=openingStack.length>0?openingStack[openingStack.length-1].type:parentNode.getType();}while(openingStack.length>0){popped=openingStack[openingStack.length-1];writeElement({type:'/'+popped.type},i);}while(closingStack.length>0){popped=closingStack[closingStack.length-1];writeElement(popped.getClonedElement(),i);}return{offset:offset,data:newData,remove:remove,
insertedDataOffset:insertedDataOffset!==0?insertedDataOffset:undefined,insertedDataLength:insertedDataLength!==newData.length?insertedDataLength:undefined};};ve.dm.Document.prototype.newFromHtml=function(html,importRules){var htmlDoc=typeof html==='string'?ve.createDocumentFromHtml(html):html,doc=ve.dm.converter.getModelFromDom(htmlDoc,{targetDoc:this.getHtmlDocument(),fromClipboard:!!importRules}),data=doc.data;if(importRules){data.sanitize(importRules.external||{});data.sanitize(importRules.all||{});}data.remapInternalListKeys(this.getInternalList());doc.buildNodeTree();return doc;};ve.dm.Document.prototype.findText=function(query,options){var data=this.data,documentRange=this.getDocumentRange(),ranges=[];options=options||{};if(query instanceof RegExp){data.forEachRunOfContent(documentRange,function(off,line){query.lastIndex=0;var match;while((match=query.exec(line))!==null){var matchText=match[0];if(matchText.length===0){query.lastIndex=match.index+1;continue;}if(matchText[matchText
.length-1]==='\uFFFC'&&data.isOpenElementData(off+match.index+matchText.length-1)&&data.isCloseElementData(off+match.index+matchText.length)){matchText+='\uFFFC';query.lastIndex+=1;}if(matchText[0]==='\uFFFC'&&data.isOpenElementData(off+match.index-1)&&data.isCloseElementData(off+match.index)){query.lastIndex=match.index+1;continue;}ranges.push(new ve.Range(off+match.index,off+match.index+matchText.length));if(!options.noOverlaps){query.lastIndex=match.index+1;}}});}else{var qLen=query.length;var compare;if(ve.supportsIntl){var sensitivity;if(options.diacriticInsensitiveString){sensitivity=options.caseSensitiveString?'case':'base';}else{sensitivity=options.caseSensitiveString?'variant':'accent';}compare=new Intl.Collator(this.lang,{sensitivity:sensitivity}).compare;}else{compare=options.caseSensitiveString?function(a,b){return a===b?0:1;}:function(a,b){return a.toLowerCase()===b.toLowerCase()?0:1;};}for(var offset=0,l=documentRange.getLength()-qLen;offset<=l;offset++){var j=0;while(
compare(data.getCharacterData(offset+j),query[j])===0){j++;if(j===qLen){ranges.push(new ve.Range(offset,offset+qLen));offset+=options.noOverlaps?qLen-1:0;break;}}}}if(options.wholeWord){var dataString=new ve.dm.DataString(this.getData());ranges=ranges.filter(function(range){return unicodeJS.wordbreak.isBreak(dataString,range.start)&&unicodeJS.wordbreak.isBreak(dataString,range.end);});}return ranges;};ve.dm.Document.prototype.getCompleteHistoryLength=function(){return this.completeHistory.getLength();};ve.dm.Document.prototype.getCompleteHistorySince=function(start){return this.completeHistory.transactions.slice(start);};ve.dm.Document.prototype.getChangeSince=function(start){var change=this.completeHistory.mostRecent(start);change.selections={};return change;};ve.dm.Document.prototype.getLang=function(){return this.lang;};ve.dm.Document.prototype.getDir=function(){return this.dir;};ve.dm.Document.prototype.setStorage=function(keyOrStorage,value){if(typeof keyOrStorage==='string'){this
.persistentStorage[keyOrStorage]=value;this.emit('storage');}else{this.persistentStorage=keyOrStorage;}};ve.dm.Document.prototype.getStorage=function(key){if(key){return this.persistentStorage[key];}else{return this.persistentStorage;}};ve.dm.DocumentSlice=function VeDmDocumentSlice(data,htmlDocument,parentDocument,internalList,originalRange,balancedRange,originalDocument){ve.dm.DocumentSlice.super.call(this,data,htmlDocument,parentDocument,internalList,undefined,undefined,undefined,originalDocument);this.originalRange=originalRange;this.balancedRange=balancedRange;};OO.inheritClass(ve.dm.DocumentSlice,ve.dm.Document);ve.dm.DocumentSlice.prototype.getOriginalData=function(){return this.getData(this.originalRange);};ve.dm.DocumentSlice.prototype.getBalancedData=function(){return this.getData(this.balancedRange);};ve.dm.TableSlice=function VeDmTableSlice(data,htmlDocument,parentDocument,internalList,tableRange,originalDocument){ve.dm.TableSlice.super.call(this,data,htmlDocument,
parentDocument,internalList,tableRange,tableRange,originalDocument);};OO.inheritClass(ve.dm.TableSlice,ve.dm.DocumentSlice);ve.dm.TableSlice.prototype.getTableNode=function(){if(!this.documentNode.length){this.rebuildTree();}return this.documentNode.children[0];};ve.dm.LinearData=function VeDmLinearData(store,data){this.store=store;this.data=data?ve.deepFreeze(data,true):[];};OO.initClass(ve.dm.LinearData);ve.dm.LinearData.static.getType=function(item){return this.isCloseElementData(item)?item.type.slice(1):item.type;};ve.dm.LinearData.static.isElementData=function(item){return item!==undefined&&typeof item.type==='string';};ve.dm.LinearData.static.isOpenElementData=function(item){return this.isElementData(item)&&item.type.charAt(0)!=='/';};ve.dm.LinearData.static.isCloseElementData=function(item){return this.isElementData(item)&&item.type.charAt(0)==='/';};ve.dm.LinearData.prototype.getData=function(offset){return offset===undefined?this.data:this.data[offset];};ve.dm.LinearData.
prototype.setData=function(offset,value){this.data[offset]=typeof value==='object'?ve.deepFreeze(value):value;};ve.dm.LinearData.prototype.modifyData=function(offset,modify){var newItem=ve.copy(this.getData(offset));modify(newItem);this.setData(offset,newItem);};ve.dm.LinearData.prototype.push=function(){return Array.prototype.push.apply(this.data,arguments);};ve.dm.LinearData.prototype.getLength=function(){return this.getData().length;};ve.dm.LinearData.prototype.getStore=function(){return this.store;};ve.dm.LinearData.prototype.slice=function(){return Array.prototype.slice.apply(this.data,arguments);};ve.dm.LinearData.prototype.sliceObject=function(){return new this.constructor(this.getStore(),this.slice.apply(this,arguments));};ve.dm.LinearData.prototype.splice=function(){return Array.prototype.splice.apply(this.data,arguments);};ve.dm.LinearData.prototype.spliceObject=function(){return new this.constructor(this.getStore(),this.splice.apply(this,arguments));};ve.dm.LinearData.
prototype.batchSplice=function(offset,remove,data){return ve.batchSplice(this.getData(),offset,remove,data);};ve.dm.LinearData.prototype.batchSpliceObject=function(offset,remove,data){return new this.constructor(this.getStore(),this.batchSplice(offset,remove,data));};ve.dm.LinearData.prototype.getDataSlice=function(range,deep){var end,start=0,length=this.getLength();if(range!==undefined){start=Math.max(0,Math.min(length,range.start));end=Math.max(0,Math.min(length,range.end));}var data=end===undefined?this.slice(start):this.slice(start,end);return deep?ve.copy(data):data;};ve.dm.LinearData.prototype.clone=function(){return new this.constructor(this.getStore(),ve.copy(this.data));};ve.dm.HashValueStore=function VeDmHashValueStore(values){this.hashStore={};this.hashes=[];if(values){this.hashAll(values);}};OO.initClass(ve.dm.HashValueStore);ve.dm.HashValueStore.static.deserialize=function(deserializeValue,data){var store=new ve.dm.HashValueStore();if(!data){return store;}store.hashes=data
.hashes.slice();store.hashStore={};for(var hash in data.hashStore){store.hashStore[hash]=deserializeValue(data.hashStore[hash]);}return store;};ve.dm.HashValueStore.prototype.serialize=function(serializeValue){var serialized={};for(var hash in this.hashStore){serialized[hash]=serializeValue(this.hashStore[hash]);}return this.getLength()?{hashes:this.hashes.slice(),hashStore:serialized}:null;};ve.dm.HashValueStore.prototype.getLength=function(){return this.hashes.length;};ve.dm.HashValueStore.prototype.truncate=function(start){var removedHashes=this.hashes.splice(start);for(var i=0,len=removedHashes.length;i<len;i++){delete this.hashStore[removedHashes[i]];}};ve.dm.HashValueStore.prototype.slice=function(start,end){var sliced=new this.constructor();sliced.hashes=this.hashes.slice(start,end);for(var i=0,len=sliced.hashes.length;i<len;i++){var hash=sliced.hashes[i];sliced.hashStore[hash]=this.hashStore[hash];}return sliced;};ve.dm.HashValueStore.prototype.clone=function(){return this.
slice();};ve.dm.HashValueStore.prototype.hash=function(value,stringified){var hash=this.hashOfValue(value,stringified);if(!this.hashStore[hash]){if(Array.isArray(value)){this.hashStore[hash]=ve.copy(value);}else if(value!==null&&typeof value==='object'){this.hashStore[hash]=ve.cloneObject(value);}else{this.hashStore[hash]=value;}this.hashes.push(hash);}return hash;};ve.dm.HashValueStore.prototype.replaceHash=function(oldHash,value){var newHash=this.hashOfValue(value);if(!Object.prototype.hasOwnProperty.call(this.hashStore,oldHash)){throw new Error('Old hash not found: '+oldHash);}delete this.hashStore[oldHash];if(this.hashStore[newHash]===undefined){this.hashStore[newHash]=value;this.hashes.splice(this.hashes.indexOf(oldHash),1,newHash);}return newHash;};ve.dm.HashValueStore.prototype.hashOfValue=function(value,stringified){if(typeof stringified!=='string'){stringified=OO.getHash(value);}return'h'+SparkMD5.hash(stringified).slice(0,16);};ve.dm.HashValueStore.prototype.hashAll=function(
values){var hashes=[];for(var i=0,length=values.length;i<length;i++){hashes.push(this.hash(values[i]));}return hashes;};ve.dm.HashValueStore.prototype.value=function(hash){return this.hashStore[hash];};ve.dm.HashValueStore.prototype.values=function(hashes){var values=[];for(var i=0,length=hashes.length;i<length;i++){values.push(this.value(hashes[i]));}return values;};ve.dm.HashValueStore.prototype.merge=function(other){if(other===this){return;}for(var i=0,len=other.hashes.length;i<len;i++){var hash=other.hashes[i];if(!Object.prototype.hasOwnProperty.call(this.hashStore,hash)){this.hashStore[hash]=other.hashStore[hash];this.hashes.push(hash);}}};ve.dm.HashValueStore.prototype.difference=function(omit){var store=new this.constructor();if(omit instanceof ve.dm.HashValueStore){omit=omit.hashStore;}for(var i=0,len=this.hashes.length;i<len;i++){var hash=this.hashes[i];if(!Object.prototype.hasOwnProperty.call(omit,hash)){store.hashes.push(hash);store.hashStore[hash]=this.hashStore[hash];}}
return store;};ve.dm.Converter=function VeDmConverter(modelRegistry,nodeFactory,annotationFactory){this.modelRegistry=modelRegistry;this.nodeFactory=nodeFactory;this.annotationFactory=annotationFactory;this.doc=null;this.documentData=null;this.store=null;this.internalList=null;this.mode=null;this.fromClipboard=null;this.contextStack=null;var whitespaceList=this.constructor.static.whitespaceList;this.leadingWhitespaceRegex=new RegExp('^['+whitespaceList+']');this.leadingWhitespacesRegex=new RegExp('^['+whitespaceList+']+');this.trailingWhitespaceRegex=new RegExp('['+whitespaceList+']$');this.trailingWhitespacesRegex=new RegExp('['+whitespaceList+']+$');this.onlyWhitespaceRegex=new RegExp('^['+whitespaceList+']+$');this.trimWhitespaceRegex=new RegExp('^(['+whitespaceList+']*)([\\s\\S]*?)(['+whitespaceList+']*)$');};OO.initClass(ve.dm.Converter);ve.dm.Converter.static.computedAttributes=['href','src'];ve.dm.Converter.static.whitespaceList=' \\t\\f\\u200b\\r\\n';ve.dm.Converter.static.
PARSER_MODE=0;ve.dm.Converter.static.CLIPBOARD_MODE=1;ve.dm.Converter.static.PREVIEW_MODE=2;ve.dm.Converter.static.getDataContentFromText=function(text,annotations){var characters=text.split('');if(!annotations||annotations.isEmpty()){return characters;}for(var i=0,len=characters.length;i<len;i++){characters[i]=[characters[i],annotations.getHashes().slice()];}return characters;};ve.dm.Converter.static.openAndCloseAnnotations=function(currentSet,targetSet,open,close){var hash,i,len;if(currentSet.getLength()){var targetSetOpen=targetSet.clone();var startClosingAt;for(i=0,len=currentSet.getLength();i<len;i++){hash=currentSet.getHash(i);if(targetSetOpen.containsHash(hash)||targetSetOpen.containsComparableForSerialization(currentSet.get(i))){targetSetOpen.removeHash(hash);}else{startClosingAt=i;break;}}if(startClosingAt!==undefined){for(i=currentSet.getLength()-1;i>=startClosingAt;i--){close(currentSet.get(i));currentSet.removeAt(i);}}}if(targetSet.getLength()){var currentSetOpen=currentSet
.clone();for(i=0,len=targetSet.getLength();i<len;i++){hash=targetSet.getHash(i);if(currentSetOpen.containsHash(hash)||currentSetOpen.containsComparableForSerialization(targetSet.get(i))){currentSetOpen.removeHash(hash);}else{open(targetSet.get(i));currentSet.pushHash(hash);}}}};ve.dm.Converter.static.renderHtmlAttributeList=function(originalDomElements,targetDomElements,filter,computed,deep){if(filter===undefined){filter=true;}if(filter===false){return;}for(var i=0,ilen=originalDomElements.length;i<ilen;i++){if(!targetDomElements[i]){continue;}var attrs=originalDomElements[i].attributes;if(!attrs){continue;}for(var j=0,jlen=attrs.length;j<jlen;j++){if(targetDomElements[i].nodeType===Node.ELEMENT_NODE&&!targetDomElements[i].hasAttribute(attrs[j].name)&&(filter===true||filter(attrs[j].name))){var value;if(computed&&this.computedAttributes.indexOf(attrs[j].name)!==-1){value=originalDomElements[i][attrs[j].name];}else{value=attrs[j].value;}targetDomElements[i].setAttribute(attrs[j].name,
value);}}if(deep&&!targetDomElements[i].veFromDataElement&&originalDomElements[i].children.length>0){this.renderHtmlAttributeList(originalDomElements[i].children,targetDomElements[i].children,filter,computed,true);}}};ve.dm.Converter.static.moveInlineMetaItems=function(data){var ancestors=[],pendingMetaItems=[];function closestMetaParent(){for(var n=ancestors.length-1;n>=0;n--){var ancestor=ancestors[n];if(ancestor.isMetaParent){return ancestor;}}return null;}var metaParent;for(var i=0;i<data.length;i++){var item=data[i];if(Array.isArray(item)){item=item[0];}if(!item.type){continue;}if(item.type[0]!=='/'){if(ve.getProp(item,'internal','isInlineMeta')){delete item.internal.isInlineMeta;metaParent=closestMetaParent();if(metaParent){metaParent.item.internal.metaItems.push(item);pendingMetaItems.push({item:item,closeItem:data[i+1],metaParent:metaParent,offset:i-metaParent.offset-1});data.splice(i,2);i--;}else{i++;}}else{ancestors.push({item:item,offset:i,isMetaParent:!!ve.getProp(item,
'internal','metaItems')});}}else{metaParent=ancestors.pop();if(metaParent.isMetaParent){for(var j=0;j<pendingMetaItems.length;j++){var pending=pendingMetaItems[j];if(pending.metaParent.item!==metaParent.item){continue;}pending.item.internal.loadMetaParentHash=metaParent.item.originalDomElementsHash;pending.item.internal.loadMetaParentOffset=pending.offset;pendingMetaItems.splice(j,1);j--;data.splice(i+1,0,pending.item,pending.closeItem);i+=2;}}}}};ve.dm.Converter.prototype.isConverting=function(){return this.contextStack!==null;};ve.dm.Converter.prototype.getStore=function(){return this.store;};ve.dm.Converter.prototype.getHtmlDocument=function(){return this.doc;};ve.dm.Converter.prototype.getTargetHtmlDocument=function(){return this.targetDoc;};ve.dm.Converter.prototype.getMode=function(){return this.mode;};ve.dm.Converter.prototype.doesModeNeedRendering=function(){return this.getMode()!==this.constructor.static.PARSER_MODE;};ve.dm.Converter.prototype.isForParser=function(){return this
.getMode()===this.constructor.static.PARSER_MODE;};ve.dm.Converter.prototype.isForClipboard=function(){return this.getMode()===this.constructor.static.CLIPBOARD_MODE;};ve.dm.Converter.prototype.isForPreview=function(){return this.getMode()===this.constructor.static.PREVIEW_MODE;};ve.dm.Converter.prototype.isFromClipboard=function(){return this.fromClipboard;};ve.dm.Converter.prototype.getCurrentContext=function(){return this.contextStack===null?null:this.contextStack[this.contextStack.length-1];};ve.dm.Converter.prototype.getActiveAnnotations=function(){var context=this.getCurrentContext();return context?context.annotations:null;};ve.dm.Converter.prototype.isExpectingContent=function(){var context=this.getCurrentContext();return context?context.expectingContent:null;};ve.dm.Converter.prototype.isValidChildNodeType=function(nodeType){var context=this.getCurrentContext();if(!context){return null;}var childTypes=this.nodeFactory.getChildNodeTypes(context.branchType);return(childTypes===
null||childTypes.indexOf(nodeType)!==-1);};ve.dm.Converter.prototype.isInWrapper=function(){var context=this.getCurrentContext();return context?context.inWrapper:null;};ve.dm.Converter.prototype.canCloseWrapper=function(){var context=this.getCurrentContext();return context?context.canCloseWrapper:null;};ve.dm.Converter.prototype.getDomElementsFromDataElement=function(dataElements,doc,childDomElements){var dataElement=Array.isArray(dataElements)?dataElements[0]:dataElements,nodeClass=this.modelRegistry.lookup(dataElement.type);if(!nodeClass){throw new Error('Attempting to convert unknown data element type '+dataElement.type);}if(nodeClass.static.isInternal){return false;}var domElements=nodeClass.static.toDomElements(dataElements,doc,this,childDomElements);if(!Array.isArray(domElements)&&!(nodeClass.prototype instanceof ve.dm.Annotation)){throw new Error('toDomElements() failed to return an array when converting element of type '+dataElement.type);}var originalDomElements=this.store.
value(dataElement.originalDomElementsHash);if(originalDomElements&&!ve.isEqualDomElements(domElements,originalDomElements)){this.constructor.static.renderHtmlAttributeList(originalDomElements,domElements,nodeClass.static.preserveHtmlAttributes,false,(!this.nodeFactory.lookup(dataElement.type)||!this.nodeFactory.canNodeHaveChildren(dataElement.type)||this.nodeFactory.doesNodeHandleOwnChildren(dataElement.type)));}if(dataElement.internal&&dataElement.internal.diff){Array.prototype.forEach.call(domElements,function(domElement){for(var key in dataElement.internal.diff){if(domElement.setAttribute){domElement.setAttribute(key,dataElement.internal.diff[key]);}}});}if(this.nodeFactory.lookup(dataElement.type)&&this.nodeFactory.canNodeHaveChildren(dataElement.type)){var hasSignificantWhitespace=this.nodeFactory.doesNodeHaveSignificantWhitespace(dataElement.type);domElements.forEach(function(domElement){domElement.veFromDataElement=true;if(hasSignificantWhitespace){domElement.
veHasSignificantWhitespace=true;}});}return domElements;};ve.dm.Converter.prototype.createDataElements=function(modelClass,domElements){var dataElements=modelClass.static.toDataElement(domElements,this);if(!dataElements){return null;}if(!Array.isArray(dataElements)){dataElements=[dataElements];}if(dataElements.length){var serializer;if(modelClass.prototype instanceof ve.dm.Annotation){serializer=function(node){return node.cloneNode(false).outerHTML;};}else{serializer=ve.getNodeHtml;}dataElements[0].originalDomElementsHash=this.store.hash(domElements,domElements.map(serializer).join(''));if(modelClass.prototype instanceof ve.dm.BranchNode&&modelClass.static.childNodeTypes===null){ve.setProp(dataElements[0],'internal','metaItems',[]);ve.setProp(dataElements[0],'internal','changesSinceLoad',0);}}return dataElements;};ve.dm.Converter.prototype.getDomElementFromDataAnnotation=function(dataAnnotation,doc){var htmlData=dataAnnotation.toHtml(),domElement=doc.createElement(htmlData.tag);ve.
setDomAttributes(domElement,htmlData.attributes);return domElement;};ve.dm.Converter.prototype.getModelFromDom=function(doc,options,store){var tmpDoc=new ve.dm.Document();var internalList=new ve.dm.InternalList(tmpDoc);store=store||new ve.dm.HashValueStore();options=options||{};this.doc=doc;this.targetDoc=options.targetDoc||doc;this.fromClipboard=options.fromClipboard;this.store=store;this.internalList=internalList;this.contextStack=[];var data=this.getDataFromDomSubtree(doc.body);this.constructor.static.moveInlineMetaItems(data);var linearData=new ve.dm.ElementLinearData(store,data);var refData=this.internalList.convertToData(this,doc);linearData.batchSplice(linearData.getLength(),0,refData);var innerWhitespace=this.getInnerWhitespace(linearData);this.doc=null;this.targetDoc=null;this.fromClipboard=null;this.store=null;this.internalList=null;this.contextStack=null;return new ve.dm.Document(linearData,doc,undefined,internalList,innerWhitespace,options.lang,options.dir,null,null,tmpDoc.
getStorage());};ve.dm.Converter.prototype.getDataFromDomClean=function(domElement,wrapperElement,annotationSet){var contextStack=this.contextStack;this.contextStack=[];var result=this.getDataFromDomSubtree(domElement,wrapperElement,annotationSet);this.contextStack=contextStack;return result;};ve.dm.Converter.prototype.getDataFromDomSubtree=function(domElement,wrapperElement,annotationSet){var wrappingParagraph,converter=this,modelRegistry=this.modelRegistry,data=[],nextWhitespace='',wrappedWhitespace='',wrappedWhitespaceIndex,wrappedMetaItems=[],context={},prevContext=this.contextStack.length?this.contextStack[this.contextStack.length-1]:null;function addWhitespace(element,index,whitespace){if(!whitespace){return;}if(!element.internal){element.internal={};}if(!element.internal.whitespace){element.internal.whitespace=[];}element.internal.whitespace[index]=whitespace;}function processNextWhitespace(element){if(nextWhitespace!==''){addWhitespace(element,0,nextWhitespace);nextWhitespace=''
;}}function outputWrappedMetaItems(whitespaceTreatment){var toInsert=[],prev=wrappingParagraph;for(var j=0,len=wrappedMetaItems.length;j<len;j++){if(wrappedMetaItems[j].type&&wrappedMetaItems[j].type.charAt(0)!=='/'){if(wrappedMetaItems[j].internal&&wrappedMetaItems[j].internal.whitespace){if(whitespaceTreatment==='restore'){ve.batchPush(toInsert,converter.constructor.static.getDataContentFromText(wrappedMetaItems[j].internal.whitespace[0],context.annotations));delete wrappedMetaItems[j].internal;}else if(whitespaceTreatment==='fixup'){addWhitespace(prev,3,wrappedMetaItems[j].internal.whitespace[0]);}}prev=wrappedMetaItems[j];}toInsert.push(wrappedMetaItems[j]);}if(wrappedWhitespace!==''&&whitespaceTreatment==='restore'){ve.batchSplice(data,wrappedWhitespaceIndex,0,toInsert);}else{ve.batchPush(data,toInsert);}wrappedMetaItems=[];}function startWrapping(){wrappingParagraph={type:'paragraph',internal:{generated:'wrapper',metaItems:[]}};data.push(wrappingParagraph);context.inWrapper=true;
context.canCloseWrapper=true;context.expectingContent=true;processNextWhitespace(wrappingParagraph);}function stopWrapping(){if(wrappedWhitespace!==''){data.splice(wrappedWhitespaceIndex,wrappedWhitespace.length);addWhitespace(wrappedMetaItems.length>0?wrappedMetaItems[wrappedMetaItems.length-2]:wrappingParagraph,3,wrappedWhitespace);nextWhitespace=wrappedWhitespace;}data.push({type:'/paragraph'});outputWrappedMetaItems('fixup');wrappingParagraph=undefined;context.inWrapper=false;context.canCloseWrapper=false;context.expectingContent=context.originallyExpectingContent;}function getAboutGroup(node){var group=[node];if(node.nodeType!==Node.ELEMENT_NODE||node.getAttribute('about')===null){return group;}var about=node.getAttribute('about');while((node=node.nextSibling)!==null){if(node.nodeType===Node.ELEMENT_NODE&&node.getAttribute('about')===about){group.push(node);}else{break;}}return group;}function isAllInstanceOf(lienarData,targetClass){for(var j=lienarData.length-1;j>=0;j--){var type
=ve.dm.LinearData.static.getType(lienarData[j]);if(type){var itemClass=modelRegistry.lookup(type)||ve.dm.AlienNode;if(!(itemClass===targetClass||itemClass.prototype instanceof targetClass)){return false;}}else{return false;}}return true;}context.annotations=annotationSet||(prevContext?prevContext.annotations.clone():new ve.dm.AnnotationSet(this.store));context.branchType=wrapperElement?wrapperElement.type:(prevContext?prevContext.branchType:'document');context.branchHasContent=this.nodeFactory.canNodeContainContent(context.branchType);context.originallyExpectingContent=context.branchHasContent||!context.annotations.isEmpty();context.expectingContent=context.originallyExpectingContent;context.inWrapper=prevContext?prevContext.inWrapper:false;context.canCloseWrapper=false;this.contextStack.push(context);if(wrapperElement){data.push(wrapperElement);}function setInlineMeta(element){ve.setProp(element,'internal','isInlineMeta',true);}var prevElement;for(var i=0;i<domElement.childNodes.
length;i++){var childNode=domElement.childNodes[i];switch(childNode.nodeType){case Node.ELEMENT_NODE:case Node.COMMENT_NODE:if(childNode.getAttribute&&childNode.getAttribute('data-ve-ignore')){continue;}var aboutGroup=getAboutGroup(childNode);var modelName=this.modelRegistry.matchElement(childNode,aboutGroup.length>1);var modelClass=this.modelRegistry.lookup(modelName)||ve.dm.AlienNode;var childNodes;if(modelClass.prototype instanceof ve.dm.Annotation){childNodes=[childNode];}else{childNodes=modelClass.static.enableAboutGrouping?aboutGroup:[childNode];}var childDataElements=this.createDataElements(modelClass,childNodes);if(!childDataElements){modelClass=ve.dm.AlienNode;childNodes=modelClass.static.enableAboutGrouping?aboutGroup:[childNode];childDataElements=this.createDataElements(modelClass,childNodes);}else if(childDataElements.length){modelClass=this.modelRegistry.lookup(childDataElements[0].type);}else{continue;}if(!context.inWrapper&&!context.expectingContent&&modelClass.prototype
instanceof ve.dm.Annotation&&!this.isValidChildNodeType('paragraph')){modelClass=ve.dm.AlienBlockNode;childNodes=modelClass.static.enableAboutGrouping?aboutGroup:[childNode];childDataElements=this.createDataElements(modelClass,childNodes);}if(modelClass.prototype instanceof ve.dm.Annotation){var annotation=this.annotationFactory.createFromElement(childDataElements[0],this.store);if(!context.inWrapper&&!context.expectingContent){startWrapping();prevElement=wrappingParagraph;}var childAnnotations=context.annotations.clone();childAnnotations.push(annotation);childDataElements=this.getDataFromDomSubtree(childNode,undefined,childAnnotations);if(!childDataElements.length||isAllInstanceOf(childDataElements,ve.dm.AlienMetaItem)){if(!childDataElements.length||isAllInstanceOf(childDataElements,ve.dm.RemovableAlienMetaItem)){childDataElements=this.createDataElements(ve.dm.RemovableAlienMetaItem,childNodes);}else{childDataElements=this.createDataElements(ve.dm.AlienMetaItem,childNodes);}
childDataElements.push({type:'/'+childDataElements[0].type});if(!context.annotations.isEmpty()){childDataElements[0].annotations=context.annotations.getHashes().slice();}setInlineMeta(childDataElements[0]);}outputWrappedMetaItems('restore');ve.batchPush(data,childDataElements);wrappedWhitespace='';}else{if(modelClass.prototype instanceof ve.dm.MetaItem){if(context.expectingContent){childDataElements.forEach(setInlineMeta);}if(childDataElements.length===1){childDataElements.push({type:'/'+childDataElements[0].type});}if(!context.annotations.isEmpty()){childDataElements[0].annotations=context.annotations.getHashes().slice();}if(context.inWrapper&&context.canCloseWrapper){ve.batchPush(wrappedMetaItems,childDataElements);if(wrappedWhitespace!==''){data.splice(wrappedWhitespaceIndex,wrappedWhitespace.length);addWhitespace(childDataElements[0],0,wrappedWhitespace);nextWhitespace=wrappedWhitespace;wrappedWhitespace='';}}else{outputWrappedMetaItems('restore');ve.batchPush(data,
childDataElements);processNextWhitespace(childDataElements[0]);prevElement=childDataElements[0];}i+=childNodes.length-1;break;}var childIsContent=this.nodeFactory.canNodeSerializeAsContent(childDataElements[0].type);if(!context.expectingContent&&childIsContent){startWrapping();prevElement=wrappingParagraph;}else if(context.expectingContent&&!childIsContent){if(context.inWrapper&&context.canCloseWrapper){stopWrapping();}else{modelClass=ve.dm.AlienNode;childNodes=modelClass.static.enableAboutGrouping?aboutGroup:[childNode];childDataElements=this.createDataElements(modelClass,childNodes);childIsContent=this.nodeFactory.canNodeSerializeAsContent(childDataElements[0].type);}}if(context.inWrapper&&childIsContent){outputWrappedMetaItems('restore');wrappedWhitespace='';nextWhitespace='';}if(childIsContent&&!context.annotations.isEmpty()){childDataElements[0].annotations=context.annotations.getHashes().slice();}if(childDataElements.length===1&&childNodes.length===1&&this.nodeFactory.
canNodeHaveChildren(childDataElements[0].type)&&!this.nodeFactory.doesNodeHandleOwnChildren(childDataElements[0].type)){outputWrappedMetaItems('restore');ve.batchPush(data,this.getDataFromDomSubtree(childNode,childDataElements[0],new ve.dm.AnnotationSet(this.store)));}else{if(childDataElements.length===1){childDataElements.push({type:'/'+childDataElements[0].type});}outputWrappedMetaItems('restore');ve.batchPush(data,childDataElements);}processNextWhitespace(childDataElements[0]);prevElement=childDataElements[0];i+=childNodes.length-1;}break;case Node.TEXT_NODE:var text=childNode.data;var matches;if(text===''){break;}if(!context.originallyExpectingContent){if(this.onlyWhitespaceRegex.test(text)){if(context.inWrapper){wrappedWhitespace=text;wrappedWhitespaceIndex=data.length;ve.batchPush(data,this.constructor.static.getDataContentFromText(wrappedWhitespace,context.annotations));}else{if(!prevElement){if(wrapperElement){addWhitespace(wrapperElement,1,text);}}else{addWhitespace(
prevElement,3,text);}nextWhitespace=text;wrappedWhitespace='';outputWrappedMetaItems('restore');}break;}else{matches=text.match(this.trimWhitespaceRegex);if(!context.inWrapper){startWrapping();if(matches[1]!==''){if(!prevElement){if(wrapperElement){addWhitespace(wrapperElement,1,matches[1]);}}else{addWhitespace(prevElement,3,matches[1]);}addWhitespace(wrappingParagraph,0,matches[1]);}}else{outputWrappedMetaItems('restore');ve.batchPush(data,this.constructor.static.getDataContentFromText(matches[1],context.annotations));}ve.batchPush(data,this.constructor.static.getDataContentFromText(matches[2],context.annotations));wrappedWhitespace=matches[3];wrappedWhitespaceIndex=data.length;ve.batchPush(data,this.constructor.static.getDataContentFromText(wrappedWhitespace,context.annotations));prevElement=wrappingParagraph;break;}}if(context.annotations.isEmpty()&&i===0&&wrapperElement&&!this.nodeFactory.doesNodeHaveSignificantWhitespace(wrapperElement.type)){matches=text.match(this.
leadingWhitespacesRegex);if(matches&&matches[0]!==''){addWhitespace(wrapperElement,1,matches[0]);text=text.slice(matches[0].length);}}if(context.annotations.isEmpty()&&i===domElement.childNodes.length-1&&wrapperElement&&!this.nodeFactory.doesNodeHaveSignificantWhitespace(wrapperElement.type)){matches=text.match(this.trailingWhitespacesRegex);if(matches&&matches[0]!==''){addWhitespace(wrapperElement,2,matches[0]);text=text.slice(0,text.length-matches[0].length);}}ve.batchPush(data,this.constructor.static.getDataContentFromText(text,context.annotations));break;}}if(context.inWrapper&&context.canCloseWrapper){stopWrapping();context.inWrapper=true;}if(context.branchType!=='paragraph'&&wrapperElement&&data[data.length-1]===wrapperElement&&!context.inWrapper&&!this.nodeFactory.canNodeContainContent(context.branchType)&&!this.nodeFactory.isNodeContent(context.branchType)&&this.isValidChildNodeType('paragraph')){var wrapperParagraph={type:'paragraph',internal:{generated:'wrapper'}};
processNextWhitespace(wrapperParagraph);data.push(wrapperParagraph);data.push({type:'/paragraph'});}if(wrapperElement){if(nextWhitespace!==''&&data[data.length-1]!==wrapperElement){addWhitespace(wrapperElement,2,nextWhitespace);nextWhitespace='';}data.push({type:'/'+wrapperElement.type});}if(context.branchType==='document'&&isAllInstanceOf(data,ve.dm.MetaItem)&&!annotationSet){var emptyParagraph={type:'paragraph',internal:{generated:'empty'}};processNextWhitespace(emptyParagraph);data.push(emptyParagraph);data.push({type:'/paragraph'});}this.contextStack.pop();return data;};ve.dm.Converter.prototype.getInnerWhitespace=function(data){var innerWhitespace=new Array(2),stack=0,last=data.getLength()-1;var whitespace;if(data.isOpenElementData(0)){whitespace=ve.getProp(data.getData(0),'internal','whitespace');innerWhitespace[0]=whitespace?whitespace[0]:undefined;}if(data.isCloseElementData(last)){stack++;while(--last){if(data.isCloseElementData(last)){stack++;}else if(data.isOpenElementData(
last)){stack--;if(stack===0&&data.getType(last)!=='internalList'){break;}}}whitespace=ve.getProp(data.getData(last),'internal','whitespace');innerWhitespace[1]=whitespace?whitespace[3]:undefined;}return innerWhitespace;};ve.dm.Converter.prototype.getDomFromModel=function(model,mode){if(typeof mode==='boolean'){mode=mode?this.constructor.static.CLIPBOARD_MODE:this.constructor.static.PARSER_MODE;}mode=mode||this.constructor.static.PARSER_MODE;var doc=ve.createDocumentFromHtml('');this.getDomSubtreeFromModel(model,doc.body,mode);return doc;};ve.dm.Converter.prototype.getDomFromNode=function(node,mode){if(typeof mode==='boolean'){mode=mode?this.constructor.static.CLIPBOARD_MODE:this.constructor.static.PARSER_MODE;}mode=mode||this.constructor.static.PARSER_MODE;return this.getDomFromModel(node.getDocument().shallowCloneFromRange(node.isInternal()?node.getRange():node.getOuterRange()),mode);};ve.dm.Converter.prototype.getDomSubtreeFromModel=function(model,container,mode){if(typeof mode===
'boolean'){mode=mode?this.constructor.static.CLIPBOARD_MODE:this.constructor.static.PARSER_MODE;}mode=mode||this.constructor.static.PARSER_MODE;this.documentData=model.getFullData(undefined,'roundTrip');this.store=model.getStore();this.internalList=model.getInternalList();this.originalDocInternalList=model.getOriginalDocument()?model.getOriginalDocument().getInternalList():this.internalList;this.mode=mode;this.getDomSubtreeFromData(this.documentData,container,model.getInnerWhitespace());this.documentData=null;this.store=null;this.internalList=null;this.originalDocInternalList=null;this.mode=null;};ve.dm.Converter.prototype.getDomSubtreeFromData=function(data,container,innerWhitespace){var i,text,annotatedDomElements,annotatedDomElementStack,whitespaceHtmlChars=ve.visibleWhitespaceCharacters,isForPreview=this.isForPreview(),dataLen=data.length,converter=this,doc=container.ownerDocument,domElement=container;function openAnnotation(){if(text.length>0){annotatedDomElements.push(doc.
createTextNode(text));text='';}annotatedDomElements=[];annotatedDomElementStack.push(annotatedDomElements);}function closeAnnotation(annotation){var leading='',trailing='',originalDomElements=annotation.getOriginalDomElements(converter.store),origElementText=originalDomElements[0]&&originalDomElements[0].textContent||'';if(text.length>0){annotatedDomElements.push(doc.createTextNode(text));text='';}var annotatedChildDomElements=annotatedDomElementStack.pop();annotatedDomElements=annotatedDomElementStack[annotatedDomElementStack.length-1];if(annotation.constructor.static.trimWhitespace){var matches;var first=annotatedChildDomElements[0];while(first&&first.nodeType===Node.TEXT_NODE&&(matches=first.data.match(converter.leadingWhitespacesRegex))&&!converter.leadingWhitespaceRegex.test(origElementText)){leading+=matches[0];first.deleteData(0,matches[0].length);if(first.data.length!==0){break;}annotatedChildDomElements.shift();first=annotatedChildDomElements[0];}var last=
annotatedChildDomElements[annotatedChildDomElements.length-1];while(last&&last.nodeType===Node.TEXT_NODE&&(matches=last.data.match(converter.trailingWhitespacesRegex))&&!converter.trailingWhitespaceRegex.test(origElementText)){trailing=matches[0]+trailing;last.deleteData(last.data.length-matches[0].length,matches[0].length);if(last.data.length!==0){break;}annotatedChildDomElements.pop();last=annotatedChildDomElements[annotatedChildDomElements.length-1];}}var annotationElement;if(annotatedChildDomElements.length){annotationElement=converter.getDomElementsFromDataElement(annotation.getElement(),doc,annotatedChildDomElements)[0];}if(leading){annotatedDomElements.push(doc.createTextNode(leading));}var n,len;if(annotationElement){for(n=0,len=annotatedChildDomElements.length;n<len;n++){annotationElement.appendChild(annotatedChildDomElements[n]);}annotatedDomElements.push(annotationElement);}else{for(n=0,len=annotatedChildDomElements.length;n<len;n++){annotatedDomElements.push(
annotatedChildDomElements[n]);}}if(trailing){annotatedDomElements.push(doc.createTextNode(trailing));}}function findEndOfNode(k){var n,depth;for(n=k+1,depth=1;n<dataLen&&depth>0;n++){if(data[n].type){depth+=data[n].type.charAt(0)==='/'?-1:1;}}if(depth!==0){throw new Error('Unbalanced data: '+depth+' element(s) left open.');}return n;}function getDataElementOrSlice(){var dataSlice;if(ve.dm.nodeFactory.lookup(data[i].type)&&ve.dm.nodeFactory.doesNodeHandleOwnChildren(data[i].type)){dataSlice=data.slice(i,findEndOfNode(i));}else{dataSlice=data[i];}return dataSlice;}function getChar(char){if(isForPreview&&!domElement.veHasSignificantWhitespace&&Object.prototype.hasOwnProperty.call(whitespaceHtmlChars,char)){char=whitespaceHtmlChars[char];}return char;}var dataElementOrSlice,childDomElements,parentDomElement,j;var annotationStack=new ve.dm.AnnotationSet(this.store);for(i=0;i<dataLen;i++){if(typeof data[i]==='string'){text='';var isStart=i>0&&ve.dm.LinearData.static.isOpenElementData(data[i-
1])&&!ve.dm.nodeFactory.doesNodeHaveSignificantWhitespace(ve.dm.LinearData.static.getType(data[i-1]));while(typeof data[i]==='string'){if(!(isStart&&this.onlyWhitespaceRegex.test(data[i])&&this.isForParser())){text+=getChar(data[i]);isStart=false;}i++;}i--;if(text.length>0){domElement.appendChild(doc.createTextNode(text));}}else if(Array.isArray(data[i])||(data[i].annotations!==undefined&&this.nodeFactory.canNodeSerializeAsContent(data[i].type))){text='';annotatedDomElements=[];annotatedDomElementStack=[annotatedDomElements];while(data[i]!==undefined&&(Array.isArray(data[i])||(data[i].annotations!==undefined&&this.nodeFactory.canNodeSerializeAsContent(data[i].type)))){var annotations=new ve.dm.AnnotationSet(this.store,data[i].annotations||data[i][1]);this.constructor.static.openAndCloseAnnotations(annotationStack,annotations,openAnnotation,closeAnnotation);if(data[i].annotations===undefined){text+=getChar(data[i][0]);}else{if(text.length>0){annotatedDomElements.push(doc.createTextNode(
text));text='';}dataElementOrSlice=getDataElementOrSlice();childDomElements=this.getDomElementsFromDataElement(dataElementOrSlice,doc);for(j=0;j<childDomElements.length;j++){annotatedDomElements.push(childDomElements[j]);}if(Array.isArray(dataElementOrSlice)){i+=dataElementOrSlice.length-1;}else{i++;}}i++;}i--;if(text.length>0){annotatedDomElements.push(doc.createTextNode(text));text='';}this.constructor.static.openAndCloseAnnotations(annotationStack,new ve.dm.AnnotationSet(this.store),openAnnotation,closeAnnotation);for(j=0;j<annotatedDomElements.length;j++){domElement.appendChild(annotatedDomElements[j]);}}else if(data[i].type!==undefined){var dataElement=data[i];var isContentNode,ours,theirs,textNode;if(dataElement.type.charAt(0)==='/'){parentDomElement=domElement.parentNode;var type=data[i].type.slice(1);isContentNode=this.nodeFactory.isNodeContent(type);var oldLastOuterPost=parentDomElement.lastOuterPost;if(!isContentNode&&domElement.veInternal&&domElement.veInternal.whitespace){
var pre=domElement.veInternal.whitespace[1];if(pre){if(domElement.firstChild&&domElement.firstChild.nodeType===Node.TEXT_NODE){domElement.firstChild.insertData(0,pre);}else{textNode=doc.createTextNode(pre);textNode.veIsWhitespace=true;domElement.insertBefore(textNode,domElement.firstChild);}}var lastChild=domElement.veInternal.childDomElements?domElement.veInternal.childDomElements[domElement.veInternal.childDomElements.length-1].lastChild:domElement.lastChild;ours=domElement.veInternal.whitespace[2];if(domElement.lastOuterPost===undefined){theirs=ours;}else{theirs=domElement.lastOuterPost;}if(ours&&ours===theirs){if(lastChild&&lastChild.nodeType===Node.TEXT_NODE){domElement.lastChild.appendData(ours);}else{textNode=doc.createTextNode(ours);textNode.veIsWhitespace=true;domElement.appendChild(textNode);}}parentDomElement.lastOuterPost=domElement.veInternal.whitespace[3]||'';}else if(!isContentNode){parentDomElement.lastOuterPost='';}var doUnwrap=false;if(domElement.veInternal){switch(
domElement.veInternal.generated){case'slug':if(domElement.childNodes.length===0){doUnwrap=true;}break;case'empty':if(domElement.childNodes.length===0&&(data[i+1]===undefined||data[i+1].type.charAt(0)==='/'||(data[i+1].type&&this.nodeFactory.isNodeInternal(data[i+1].type)))){doUnwrap=true;}break;case'wrapper':doUnwrap=true;var previousSiblings=domElement.parentNode.childNodes;for(j=previousSiblings.length-2;j>=0;j--){var sibling=previousSiblings[j];if(sibling.nodeType===Node.TEXT_NODE&&!sibling.veIsWhitespace){doUnwrap=false;break;}if(ve.isBlockElement(sibling)){break;}}break;}}if(doUnwrap){if(domElement.childNodes.length){while(domElement.firstChild){parentDomElement.insertBefore(domElement.firstChild,domElement);}}else{parentDomElement.lastOuterPost=oldLastOuterPost||'';}parentDomElement.removeChild(domElement);}delete domElement.veInternal;delete domElement.lastOuterPost;if(!ve.dm.nodeFactory.lookup(type)||!ve.dm.nodeFactory.isNodeInternal(type)){domElement=parentDomElement;}}else{if
(this.nodeFactory.isNodeInternal(data[i].type)){break;}isContentNode=this.nodeFactory.isNodeContent(data[i].type);dataElementOrSlice=getDataElementOrSlice();childDomElements=this.getDomElementsFromDataElement(dataElementOrSlice,doc);if(childDomElements&&!childDomElements.length){i=findEndOfNode(i)-1;continue;}else if(childDomElements){childDomElements[0].veInternal=ve.extendObject({childDomElements:childDomElements},dataElement.internal?ve.copy(dataElement.internal):{});for(j=0;j<childDomElements.length;j++){domElement.appendChild(childDomElements[j]);}parentDomElement=domElement;domElement=childDomElements[0];if(domElement.veInternal&&domElement.veInternal.whitespace){ours=domElement.veInternal.whitespace[0];theirs=undefined;if(domElement.previousSibling){theirs=parentDomElement.lastOuterPost;}else if(parentDomElement===container){theirs=innerWhitespace?innerWhitespace[0]:ours;}else{if(parentDomElement.veInternal&&parentDomElement.veInternal.whitespace){theirs=parentDomElement.
veInternal.whitespace[1];parentDomElement.veInternal.whitespace[1]=undefined;}}if(ours&&ours===theirs){textNode=doc.createTextNode(ours);textNode.veIsWhitespace=true;parentDomElement.insertBefore(textNode,domElement);}}else if(!isContentNode&&!domElement.previousSibling&&parentDomElement.veInternal&&parentDomElement.veInternal.whitespace){parentDomElement.veInternal.whitespace[1]=undefined;}}if(Array.isArray(dataElementOrSlice)){i+=dataElementOrSlice.length-2;}else if(childDomElements&&childDomElements.length&&childDomElements[0].handledOwnChildren){i=findEndOfNode(i)-2;}}}}if(container.lastOuterPost!==undefined&&(!innerWhitespace||container.lastOuterPost===innerWhitespace[1])){if(container.lastChild&&container.lastChild.nodeType===Node.TEXT_NODE){container.lastChild.appendData(container.lastOuterPost);}else if(container.lastOuterPost.length>0){container.appendChild(doc.createTextNode(container.lastOuterPost));}delete container.lastOuterPost;}ve.normalizeNode(container);};ve.dm.
converter=new ve.dm.Converter(ve.dm.modelRegistry,ve.dm.nodeFactory,ve.dm.annotationFactory);ve.dm.SourceConverter=function VeDmSourceConverter(){};ve.dm.SourceConverter.prototype.getModelFromSourceText=function(sourceText,options){var data=this.getDataFromSourceText(sourceText);options=options||{};data.push({type:'internalList'},{type:'/internalList'});return new ve.dm.Document(data,undefined,undefined,undefined,undefined,options.lang,options.dir,undefined,true);};ve.dm.SourceConverter.prototype.getDataFromSourceText=function(sourceText,inline){var lines=sourceText.split(/\r\n|\r|\n/),content=[];for(var i=0,l=lines.length;i<l;i++){if(!(inline&&i===0)){content.push({type:'paragraph'});}ve.batchPush(content,lines[i].split(''));if(!(inline&&i===l-1)){content.push({type:'/paragraph'});}}return content;};ve.dm.SourceConverter.prototype.getSourceTextFromModel=function(model){return this.getSourceTextFromDataRange(model.data.data);};ve.dm.SourceConverter.prototype.getSourceTextFromDataRange=
function(data,range){var text='';range=range||new ve.Range(0,data.length);for(var i=range.start;i<range.end;i++){if(!data[i].type){text+=data[i];}else if(data[i].type==='/paragraph'&&(!data[i+1]||data[i+1].type==='paragraph')){text+='\n';}}return text;};ve.dm.sourceConverter=new ve.dm.SourceConverter();ve.dm.LinearSelection=function VeDmLinearSelection(range){if(ve.dm.Document&&arguments[0]instanceof ve.dm.Document){throw new Error('Got obsolete ve.dm.Document argument');}ve.dm.LinearSelection.super.call(this);this.range=range;};OO.inheritClass(ve.dm.LinearSelection,ve.dm.Selection);ve.dm.LinearSelection.static.name='linear';ve.dm.LinearSelection.static.newFromHash=function(hash){return new ve.dm.LinearSelection(ve.Range.static.newFromHash(hash.range));};ve.dm.LinearSelection.prototype.toJSON=function(){return{type:this.constructor.static.name,range:this.range};};ve.dm.LinearSelection.prototype.getDescription=function(){return'Linear: '+this.range.from+' - '+this.range.to;};ve.dm.
LinearSelection.prototype.collapseToStart=function(){return new this.constructor(new ve.Range(this.getRange().start));};ve.dm.LinearSelection.prototype.collapseToEnd=function(){return new this.constructor(new ve.Range(this.getRange().end));};ve.dm.LinearSelection.prototype.collapseToFrom=function(){return new this.constructor(new ve.Range(this.getRange().from));};ve.dm.LinearSelection.prototype.collapseToTo=function(){return new this.constructor(new ve.Range(this.getRange().to));};ve.dm.LinearSelection.prototype.isCollapsed=function(){return this.getRange().isCollapsed();};ve.dm.LinearSelection.prototype.translateByTransaction=function(tx,excludeInsertion){return new this.constructor(tx.translateRange(this.getRange(),excludeInsertion));};ve.dm.LinearSelection.prototype.translateByTransactionWithAuthor=function(tx,authorId){return new this.constructor(tx.translateRangeWithAuthor(this.getRange(),authorId));};ve.dm.LinearSelection.prototype.getRanges=function(){return[this.range];};ve.dm.
LinearSelection.prototype.getCoveringRange=function(){return this.range;};ve.dm.LinearSelection.prototype.getRange=function(){return this.range;};ve.dm.LinearSelection.prototype.equals=function(other){return this===other||(!!other&&other.constructor===this.constructor&&this.getRange().equals(other.getRange()));};ve.dm.selectionFactory.register(ve.dm.LinearSelection);ve.dm.NullSelection=function VeDmNullSelection(){ve.dm.NullSelection.super.call(this);};OO.inheritClass(ve.dm.NullSelection,ve.dm.Selection);ve.dm.NullSelection.static.name='null';ve.dm.NullSelection.static.newFromHash=function(){return new ve.dm.NullSelection();};ve.dm.NullSelection.prototype.toJSON=function(){return{type:this.constructor.static.name};};ve.dm.NullSelection.prototype.getDescription=function(){return'Null';};ve.dm.NullSelection.prototype.self=function(){return this;};ve.dm.NullSelection.prototype.collapseToStart=ve.dm.NullSelection.prototype.self;ve.dm.NullSelection.prototype.collapseToEnd=ve.dm.
NullSelection.prototype.self;ve.dm.NullSelection.prototype.collapseToFrom=ve.dm.NullSelection.prototype.self;ve.dm.NullSelection.prototype.collapseToTo=ve.dm.NullSelection.prototype.self;ve.dm.NullSelection.prototype.isCollapsed=function(){return true;};ve.dm.NullSelection.prototype.translateByTransaction=ve.dm.NullSelection.prototype.self;ve.dm.NullSelection.prototype.translateByTransactionWithAuthor=ve.dm.NullSelection.prototype.self;ve.dm.NullSelection.prototype.getRanges=function(){return[];};ve.dm.NullSelection.prototype.getCoveringRange=function(){return null;};ve.dm.NullSelection.prototype.equals=function(other){return this===other||(!!other&&other.constructor===this.constructor);};ve.dm.NullSelection.prototype.isNull=function(){return true;};ve.dm.selectionFactory.register(ve.dm.NullSelection);ve.dm.TableSelection=function VeDmTableSelection(tableRange,fromCol,fromRow,toCol,toRow){if(ve.dm.Document&&arguments[0]instanceof ve.dm.Document){throw new Error(
'Got obsolete ve.dm.Document argument');}if(arguments.length>5){throw new Error('Got obsolete argument (probably `expand`)');}ve.dm.TableSelection.super.call(this);this.tableRange=tableRange;toCol=toCol===undefined?fromCol:toCol;toRow=toRow===undefined?fromRow:toRow;this.fromCol=fromCol;this.fromRow=fromRow;this.toCol=toCol;this.toRow=toRow;this.startCol=fromCol<toCol?fromCol:toCol;this.startRow=fromRow<toRow?fromRow:toRow;this.endCol=fromCol<toCol?toCol:fromCol;this.endRow=fromRow<toRow?toRow:fromRow;this.intendedFromCol=this.fromCol;this.intendedFromRow=this.fromRow;this.intendedToCol=this.toCol;this.intendedToRow=this.toRow;};OO.inheritClass(ve.dm.TableSelection,ve.dm.Selection);ve.dm.TableSelection.static.name='table';ve.dm.TableSelection.static.newFromHash=function(hash){return new ve.dm.TableSelection(ve.Range.static.newFromHash(hash.tableRange),hash.fromCol,hash.fromRow,hash.toCol,hash.toRow);};ve.dm.TableSelection.static.getTableMatrixCells=function(matrix,selectionOffsets,
includePlaceholders){var cells=[],visited={};for(var row=selectionOffsets.startRow;row<=selectionOffsets.endRow;row++){for(var col=selectionOffsets.startCol;col<=selectionOffsets.endCol;col++){var cell=matrix.getCell(row,col);if(!cell){continue;}if(!includePlaceholders&&cell.isPlaceholder()){cell=cell.owner;}if(!visited[cell.key]){cells.push(cell);visited[cell.key]=true;}}}return cells;};ve.dm.TableSelection.prototype.expand=function(doc){var matrix=this.getTableNode(doc).getMatrix(),lastCellCount=0,startCol=Infinity,startRow=Infinity,endCol=-Infinity,endRow=-Infinity,colBackwards=this.fromCol>this.toCol,rowBackwards=this.fromRow>this.toRow,cells=this.getMatrixCells(doc);while(cells.length>lastCellCount){for(var i=0;i<cells.length;i++){var cell=cells[i];startCol=Math.min(startCol,cell.col);startRow=Math.min(startRow,cell.row);endCol=Math.max(endCol,cell.col+cell.node.getColspan()-1);endRow=Math.max(endRow,cell.row+cell.node.getRowspan()-1);}lastCellCount=cells.length;cells=this.
constructor.static.getTableMatrixCells(matrix,{startCol:startCol,startRow:startRow,endCol:endCol,endRow:endRow});}return new this.constructor(this.tableRange,colBackwards?endCol:startCol,rowBackwards?endRow:startRow,colBackwards?startCol:endCol,rowBackwards?startRow:endRow);};ve.dm.TableSelection.prototype.toJSON=function(){return{type:this.constructor.static.name,tableRange:this.tableRange,fromCol:this.fromCol,fromRow:this.fromRow,toCol:this.toCol,toRow:this.toRow};};ve.dm.TableSelection.prototype.getDescription=function(){return('Table: '+this.tableRange.from+' - '+this.tableRange.to+', '+'c'+this.fromCol+' r'+this.fromRow+' - '+'c'+this.toCol+' r'+this.toRow);};ve.dm.TableSelection.prototype.collapseToStart=function(){return new this.constructor(this.tableRange,this.startCol,this.startRow,this.startCol,this.startRow);};ve.dm.TableSelection.prototype.collapseToEnd=function(){return new this.constructor(this.tableRange,this.endCol,this.endRow,this.endCol,this.endRow);};ve.dm.
TableSelection.prototype.collapseToFrom=function(){return new this.constructor(this.tableRange,this.fromCol,this.fromRow,this.fromCol,this.fromRow);};ve.dm.TableSelection.prototype.collapseToTo=function(){return new this.constructor(this.tableRange,this.toCol,this.toRow,this.toCol,this.toRow);};ve.dm.TableSelection.prototype.getRanges=function(doc){var ranges=[],cells=this.getMatrixCells(doc);for(var i=0,l=cells.length;i<l;i++){ranges.push(cells[i].node.getRange());}return ranges;};ve.dm.TableSelection.prototype.getCoveringRange=function(){return this.tableRange;};ve.dm.TableSelection.prototype.getTableSliceRanges=function(doc){var ranges=[],matrix=this.getTableNode(doc).getMatrix();function pushNode(n){var range=n.getOuterRange();ranges[range.start]=new ve.Range(range.start,range.start+1);ranges[range.end-1]=new ve.Range(range.end-1,range.end);}for(var i=this.startRow;i<=this.endRow;i++){var node=matrix.getRowNode(i);if(!node){continue;}pushNode(node);while((node=node.getParent())&&
node){pushNode(node);if(node instanceof ve.dm.TableNode){break;}}}return ranges.filter(function(r){return r;}).concat(this.getOuterRanges(doc)).sort(function(a,b){return a.start-b.start;});};ve.dm.TableSelection.prototype.getOuterRanges=function(doc){var ranges=[],cells=this.getMatrixCells(doc);for(var i=0,l=cells.length;i<l;i++){ranges.push(cells[i].node.getOuterRange());}return ranges;};ve.dm.TableSelection.prototype.getMatrixCells=function(doc,includePlaceholders){return this.constructor.static.getTableMatrixCells(this.getTableNode(doc).getMatrix(),{startCol:this.startCol,startRow:this.startRow,endCol:this.endCol,endRow:this.endRow},includePlaceholders);};ve.dm.TableSelection.prototype.isEditable=function(doc){return this.getMatrixCells(doc).every(function(cell){return cell.node.isCellEditable();});};ve.dm.TableSelection.prototype.isCollapsed=function(){return false;};ve.dm.TableSelection.prototype.translateByTransaction=function(tx){var newRange=tx.translateRange(this.tableRange,
true);if(newRange.isCollapsed()){return new ve.dm.NullSelection();}return new this.constructor(newRange,this.fromCol,this.fromRow,this.toCol,this.toRow);};ve.dm.TableSelection.prototype.translateByTransactionWithAuthor=function(tx,authorId){var newRange=tx.translateRangeWithAuthor(this.tableRange,authorId);if(newRange.isCollapsed()){return new ve.dm.NullSelection();}return new this.constructor(newRange,this.fromCol,this.fromRow,this.toCol,this.toRow);};ve.dm.TableSelection.prototype.isSingleCell=function(doc){return(this.fromRow===this.toRow&&this.fromCol===this.toCol)||this.getMatrixCells(doc).length===1;};ve.dm.TableSelection.prototype.isMergeable=function(doc){if(!this.isEditable(doc)){return false;}if(this.getMatrixCells(doc,true).length<=1){return false;}var matrix=this.getTableNode(doc).getMatrix();var lastSectionNode;for(var r=this.endRow;r>=this.startRow;r--){var rowNode=matrix.getRowNode(r);if(!rowNode){continue;}var sectionNode=rowNode.findParent(ve.dm.TableSectionNode);if(
lastSectionNode&&sectionNode!==lastSectionNode){return false;}lastSectionNode=sectionNode;}return true;};ve.dm.TableSelection.prototype.getTableNode=function(doc){return doc.getBranchNodeFromOffset(this.tableRange.start+1);};ve.dm.TableSelection.prototype.newFromAdjustment=function(doc,fromColOffset,fromRowOffset,toColOffset,toRowOffset,wrap){if(toColOffset===undefined){toColOffset=fromColOffset;}if(toRowOffset===undefined){toRowOffset=fromRowOffset;}var matrix=this.getTableNode(doc).getMatrix();var wrapDir;function adjust(mode,cell,offset){var nextCell,col=cell.col,row=cell.row,dir=offset>0?1:-1;while(offset!==0){if(mode==='col'){col+=dir;if(col>=matrix.getColCount(row)){if(wrap&&row<matrix.getRowCount()-1){col-=matrix.getColCount(row);row++;wrapDir=1;}else{break;}}else if(col<0){if(wrap&&row>0){row--;col+=matrix.getColCount(row);wrapDir=-1;}else{break;}}}else{row+=dir;if(row>=matrix.getRowCount()||row<0){break;}}nextCell=matrix.getCell(row,col);if(!nextCell||nextCell.equals(cell)){
continue;}offset-=dir;cell=nextCell;}return cell;}var fromCell=matrix.getCell(this.intendedFromRow,this.intendedFromCol);if(fromColOffset){fromCell=adjust('col',fromCell,fromColOffset);}if(fromRowOffset){fromCell=adjust('row',fromCell,fromRowOffset);}var toCell=matrix.getCell(this.intendedToRow,this.intendedToCol);if(toColOffset){toCell=adjust('col',toCell,toColOffset);}if(toRowOffset){toCell=adjust('row',toCell,toRowOffset);}if(wrapDir>0){fromCell=toCell;}else if(wrapDir<0){toCell=fromCell;}var selection=new this.constructor(this.tableRange,fromCell.col,fromCell.row,toCell.col,toCell.row);selection=selection.expand(doc);return selection;};ve.dm.TableSelection.prototype.containsCell=function(cell){return cell.node.findParent(ve.dm.TableNode).getOuterRange().equals(this.tableRange)&&cell.col>=this.startCol&&cell.col<=this.endCol&&cell.row>=this.startRow&&cell.row<=this.endRow;};ve.dm.TableSelection.prototype.equals=function(other){return this===other||(!!other&&other.constructor===this.
constructor&&this.tableRange.equals(other.tableRange)&&this.fromCol===other.fromCol&&this.fromRow===other.fromRow&&this.toCol===other.toCol&&this.toRow===other.toRow);};ve.dm.TableSelection.prototype.getRowCount=function(){return this.endRow-this.startRow+1;};ve.dm.TableSelection.prototype.getColCount=function(){return this.endCol-this.startCol+1;};ve.dm.TableSelection.prototype.isFullRow=function(doc){var matrix=this.getTableNode(doc).getMatrix();return this.getColCount()===matrix.getMaxColCount();};ve.dm.TableSelection.prototype.isFullCol=function(doc){var matrix=this.getTableNode(doc).getMatrix();return this.getRowCount()===matrix.getRowCount();};ve.dm.selectionFactory.register(ve.dm.TableSelection);ve.dm.FlatLinearData=function VeDmFlatLinearData(){ve.dm.FlatLinearData.super.apply(this,arguments);};OO.inheritClass(ve.dm.FlatLinearData,ve.dm.LinearData);ve.dm.FlatLinearData.prototype.getType=function(offset){return ve.dm.LinearData.static.getType(this.getData(offset));};ve.dm.
FlatLinearData.prototype.isElementData=function(offset){return ve.dm.LinearData.static.isElementData(this.getData(offset));};ve.dm.FlatLinearData.prototype.containsElementData=function(){var i=this.getLength();while(i--){if(this.isElementData(i)){return true;}}return false;};ve.dm.FlatLinearData.prototype.isOpenElementData=function(offset){return ve.dm.LinearData.static.isOpenElementData(this.getData(offset));};ve.dm.FlatLinearData.prototype.isCloseElementData=function(offset){return ve.dm.LinearData.static.isCloseElementData(this.getData(offset));};ve.dm.ElementLinearData=function VeDmElementLinearData(){ve.dm.ElementLinearData.super.apply(this,arguments);};OO.inheritClass(ve.dm.ElementLinearData,ve.dm.FlatLinearData);ve.dm.ElementLinearData.static.startWordRegExp=new RegExp('^('+unicodeJS.characterclass.patterns.word+')');ve.dm.ElementLinearData.static.endWordRegExp=new RegExp('('+unicodeJS.characterclass.patterns.word+')$');ve.dm.ElementLinearData.static.compareElementsUnannotated=
function(a,b){var aPlain=a,bPlain=b;if(a===b){return true;}if(Array.isArray(a)){aPlain=a[0];}if(Array.isArray(b)){bPlain=b[0];}if(typeof aPlain==='string'&&typeof bPlain==='string'){return aPlain===bPlain;}if(typeof a!==typeof b){return false;}if(a.type!==b.type){return false;}if(ve.dm.LinearData.static.isOpenElementData(a)){aPlain=ve.dm.modelRegistry.lookup(a.type).static.getHashObject(a);delete aPlain.originalDomElementsHash;bPlain=ve.dm.modelRegistry.lookup(b.type).static.getHashObject(b);delete bPlain.originalDomElementsHash;return ve.compare(aPlain,bPlain);}else{return true;}};ve.dm.ElementLinearData.static.compareElements=function(a,b,aStore,bStore){if(a===b){return true;}var typeofA=typeof a;if(typeofA!==typeof b){return false;}if(typeofA==='string'){return false;}if(!this.compareElementsUnannotated(a,b)){return false;}var aAnnotations,bAnnotations;if(Array.isArray(a)){aAnnotations=a[1];}if(Array.isArray(b)){bAnnotations=b[1];}if(a&&a.type){aAnnotations=a.annotations;}if(b&&b.
type){bAnnotations=b.annotations;}var aSet=new ve.dm.AnnotationSet(aStore,aAnnotations||[]);var bSet=new ve.dm.AnnotationSet(bStore||aStore,bAnnotations||[]);return aSet.compareTo(bSet);};ve.dm.ElementLinearData.static.getAnnotationHashesFromItem=function(item){if(typeof item==='string'){return[];}else if(item.annotations){return item.annotations.slice();}else if(item[1]){return item[1].slice();}else{return[];}};ve.dm.ElementLinearData.static.replaceAnnotationHashesForItem=function(item,hashes){var isElement=ve.dm.LinearData.static.isElementData(item);item=ve.copy(item);hashes=hashes.slice();if(hashes.length>0){if(isElement){item.annotations=hashes;}else{var character=ve.dm.ElementLinearData.static.getCharacterDataFromItem(item);item=[character,hashes];}}else{if(isElement){delete item.annotations;}else{item=ve.dm.ElementLinearData.static.getCharacterDataFromItem(item);}}return item;};ve.dm.ElementLinearData.static.getCharacterDataFromItem=function(item){var data=Array.isArray(item)?
item[0]:item;return typeof data==='string'?data:'';};ve.dm.ElementLinearData.prototype.isContentOffset=function(offset){if(offset===0||offset===this.getLength()){return false;}var left=this.getData(offset-1);var right=this.getData(offset);var factory=ve.dm.nodeFactory;return((left!==undefined&&right!==undefined)&&((typeof left==='string'||typeof right==='string')||(Array.isArray(left)||Array.isArray(right))||((typeof left.type==='string'&&left.type.charAt(0)==='/'&&factory.isNodeContent(left.type.slice(1)))||(typeof right.type==='string'&&right.type.charAt(0)!=='/'&&factory.isNodeContent(right.type))||('/'+left.type===right.type&&factory.canNodeContainContent(left.type)))));};ve.dm.ElementLinearData.prototype.isStructuralOffset=function(offset,unrestricted){if(offset===0||offset===this.getLength()){return true;}var left=this.getData(offset-1);var right=this.getData(offset);var factory=ve.dm.nodeFactory;return((left!==undefined&&right!==undefined&&typeof left.type==='string'&&typeof
right.type==='string')&&((left.type.charAt(0)==='/'&&(factory.canNodeHaveChildren(left.type.slice(1))||!factory.isNodeContent(left.type.slice(1)))&&(!unrestricted||factory.getParentNodeTypes(left.type.slice(1))===null))||(right.type.charAt(0)!=='/'&&(factory.canNodeHaveChildren(right.type)||!factory.isNodeContent(right.type))&&(!unrestricted||factory.getParentNodeTypes(right.type)===null))||('/'+left.type===right.type&&factory.canNodeHaveChildrenNotContent(left.type)&&(!unrestricted||factory.getChildNodeTypes(left.type)===null))));};ve.dm.ElementLinearData.prototype.isContentData=function(){var i=this.getLength();while(i--){var item=this.getData(i);if(item.type!==undefined&&item.type.charAt(0)!=='/'&&!ve.dm.nodeFactory.isNodeContent(item.type)){return false;}}return true;};ve.dm.ElementLinearData.prototype.canTakeAnnotationAtOffset=function(offset,annotation,ignoreClose){if(this.isElementData(offset)){if(ignoreClose&&this.isCloseElementData(offset)){return false;}var type=this.getType(
offset);return ve.dm.nodeFactory.isNodeContent(type)&&ve.dm.nodeFactory.canNodeTakeAnnotation(type,annotation);}else{return true;}};ve.dm.ElementLinearData.prototype.getAnnotationHashesFromOffset=function(offset,ignoreClose){if(offset<0||offset>this.getLength()){throw new Error('offset '+offset+' out of bounds');}if(!ignoreClose&&this.isCloseElementData(offset)&&!ve.dm.nodeFactory.canNodeHaveChildren(this.getType(offset))){offset=this.getRelativeContentOffset(offset,-1);if(offset===-1){return[];}}var item=this.getData(offset);return this.constructor.static.getAnnotationHashesFromItem(item)||[];};ve.dm.ElementLinearData.prototype.getAnnotationsFromOffset=function(offset,ignoreClose){return new ve.dm.AnnotationSet(this.getStore(),this.getAnnotationHashesFromOffset(offset,ignoreClose));};ve.dm.ElementLinearData.prototype.setAnnotationsAtOffset=function(offset,annotations){this.setAnnotationHashesAtOffset(offset,this.getStore().hashAll(annotations.get()));};ve.dm.ElementLinearData.
prototype.setAnnotationHashesAtOffset=function(offset,hashes){var item=this.getData(offset);item=this.constructor.static.replaceAnnotationHashesForItem(item,hashes);this.setData(offset,item);};ve.dm.ElementLinearData.prototype.setAttributeAtOffset=function(offset,key,value){if(!this.isElementData(offset)){return;}this.modifyData(offset,function(item){if(value===undefined){if(item.attributes){delete item.attributes[key];}}else{if(!item.attributes){item.attributes={};}item.attributes[key]=value;}});};ve.dm.ElementLinearData.prototype.getCharacterData=function(offset){var item=this.getData(offset);return ve.dm.ElementLinearData.static.getCharacterDataFromItem(item);};ve.dm.ElementLinearData.prototype.getAnnotatedRangeFromOffset=function(offset,annotation){var start=offset,end=offset;if(this.getAnnotationsFromOffset(offset).contains(annotation)===false){return null;}while(start>0){start--;if(this.getAnnotationsFromOffset(start).contains(annotation)===false){start++;break;}}while(end<this.
getLength()){if(this.getAnnotationsFromOffset(end).contains(annotation)===false){break;}end++;}return new ve.Range(start,end);};ve.dm.ElementLinearData.prototype.getAnnotatedRangeFromSelection=function(range,annotation){var start=range.start,end=range.end;while(start>0){start--;if(this.getAnnotationsFromOffset(start).contains(annotation)===false){start++;break;}}while(end<this.getLength()){if(this.getAnnotationsFromOffset(end).contains(annotation)===false){break;}end++;}return new ve.Range(start,end);};ve.dm.ElementLinearData.prototype.getAnnotationsFromRange=function(range,all,nullIfContentEmpty){var ignoreChildrenDepth=0;var left,right;for(var i=range.start;i<range.end;i++){if(this.isElementData(i)){if(ve.dm.nodeFactory.shouldIgnoreChildren(this.getType(i))){ignoreChildrenDepth+=this.isOpenElementData(i)?1:-1;}if(!ve.dm.nodeFactory.isNodeContent(this.getType(i))){continue;}}if(ignoreChildrenDepth>0){continue;}if(!left){left=this.getAnnotationsFromOffset(i);if(range.getLength()===0||
range.getLength()===1){return left;}continue;}right=this.getAnnotationsFromOffset(i);if(all&&!right.isEmpty()){left.addSet(right);}else if(!all){if(right.isEmpty()){return new ve.dm.AnnotationSet(this.getStore());}left=left.getComparableAnnotationsFromSet(right);if(left.isEmpty()){break;}}}return left||(nullIfContentEmpty?null:new ve.dm.AnnotationSet(this.getStore()));};ve.dm.ElementLinearData.prototype.getInsertionAnnotationsFromRange=function(range,startAfterAnnotations){var start;if(range.isCollapsed()&&!startAfterAnnotations){start=Math.max(0,range.start-1);}else{start=range.start;}var startAnnotations;if(this.isContentOffset(start)){startAnnotations=this.getAnnotationsFromOffset(start);}else{startAnnotations=new ve.dm.AnnotationSet(this.getStore());}var afterAnnotations;if(this.isContentOffset(range.end)){afterAnnotations=this.getAnnotationsFromOffset(range.end);}else{afterAnnotations=new ve.dm.AnnotationSet(this.getStore());}return startAnnotations.filter(function(annotation){
return annotation.constructor.static.applyToAppendedContent||afterAnnotations.containsComparable(annotation);});};ve.dm.ElementLinearData.prototype.hasAnnotationsInRange=function(range){for(var i=range.start;i<range.end;i++){if(this.getAnnotationHashesFromOffset(i,true).length){return true;}}return false;};ve.dm.ElementLinearData.prototype.trimOuterSpaceFromRange=function(range){var start=range.start,end=range.end;while(/^\s+$/.test(this.getCharacterData(end-1))){end--;}while(start<end&&/^\s+$/.test(this.getCharacterData(start))){start++;}return range.to<range.end?new ve.Range(end,start):new ve.Range(start,end);};ve.dm.ElementLinearData.prototype.isPlainText=function(range,ignoreNonContentNodes,ignoredTypes,ignoreCoveringAnnotations,ignoreAllAnnotations){range=range||new ve.Range(0,this.getLength());var annotations;if(ignoreCoveringAnnotations){annotations=this.getAnnotationsFromRange(range);}for(var i=range.start;i<range.end;i++){if(typeof this.data[i]==='string'){continue;}else if(
Array.isArray(this.data[i])){if(ignoreAllAnnotations){continue;}if(ignoreCoveringAnnotations&&annotations.containsAllOf(this.getAnnotationsFromOffset(i))){continue;}}else if(ignoreNonContentNodes||ignoredTypes){var type=this.getType(i);if(ignoredTypes&&ignoredTypes.indexOf(type)!==-1){continue;}if(ignoreNonContentNodes&&!ve.dm.nodeFactory.isNodeContent(type)){continue;}}return false;}return true;};ve.dm.ElementLinearData.prototype.forEachRunOfContent=function(range,callback){var text='';for(var i=range.start;i<range.end;i++){if(!this.isElementData(i)){text+=this.getCharacterData(i);}else if(ve.dm.nodeFactory.isNodeContent(this.getType(i))){text+='\uFFFC';}else{if(text){callback(i-text.length,text);}text='';}}if(text){callback(range.end-text.length,text);}};ve.dm.ElementLinearData.prototype.getText=function(maintainIndices,range){range=range||new ve.Range(0,this.getLength());var text='';for(var i=range.start;i<range.end;i++){if(!this.isElementData(i)){text+=this.getCharacterData(i);}
else if(maintainIndices){text+='\n';}}return text;};ve.dm.ElementLinearData.prototype.getSourceText=function(range){return ve.dm.sourceConverter.getSourceTextFromDataRange(this.data,range);};ve.dm.ElementLinearData.prototype.getRelativeOffset=function(offset,distance,callback){var args=Array.prototype.slice.call(arguments,3);if(distance===0){if(callback.apply(this,[offset].concat(args))){return offset;}else{distance=1;}}var direction=(offset<=0?1:(offset>=this.getLength()?-1:(distance>0?1:-1)));distance=Math.abs(distance);var start=offset;var i=start+direction;offset=-1;var steps=0;var ignoreChildrenDepth=0;var turnedAround=false;while(i>=0&&i<=this.getLength()){var dataOffset=i+(direction>0?-1:0);if(this.isElementData(dataOffset)&&ve.dm.nodeFactory.shouldIgnoreChildren(this.getType(dataOffset))){var isOpen=this.isOpenElementData(dataOffset);if((direction>0&&isOpen)||(direction<0&&!isOpen)){ignoreChildrenDepth++;}else{ignoreChildrenDepth--;if(ignoreChildrenDepth<0){return-1;}}}if(
callback.apply(this,[i].concat(args))){if(!ignoreChildrenDepth){steps++;offset=i;if(distance===steps){return offset;}}}else if(!turnedAround&&steps===0&&((direction<0&&i===0)||(direction>0&&(i===this.getLength()||this.getType(i-1)==='internalList')))){if(callback.apply(this,[start].concat(args))){return start;}direction*=-1;i=start;distance=1;turnedAround=true;ignoreChildrenDepth=0;}i+=direction;}return offset;};ve.dm.ElementLinearData.prototype.getRelativeContentOffset=function(offset,distance){return this.getRelativeOffset(offset,distance,this.constructor.prototype.isContentOffset);};ve.dm.ElementLinearData.prototype.getNearestContentOffset=function(offset,direction){if(this.isContentOffset(offset)){return offset;}if(direction===undefined){var left=this.getRelativeContentOffset(offset,-1);var right=this.getRelativeContentOffset(offset,1);return offset-left<right-offset?left:right;}else{return this.getRelativeContentOffset(offset,direction>0?1:-1);}};ve.dm.ElementLinearData.prototype.
getRelativeStructuralOffset=function(offset,distance,unrestricted){if(distance===0&&(offset===0||offset===this.getLength())){return offset;}return this.getRelativeOffset(offset,distance,this.constructor.prototype.isStructuralOffset,unrestricted);};ve.dm.ElementLinearData.prototype.getNearestStructuralOffset=function(offset,direction,unrestricted){if(this.isStructuralOffset(offset,unrestricted)){return offset;}if(!direction){var left=this.getRelativeStructuralOffset(offset,-1,unrestricted);var right=this.getRelativeStructuralOffset(offset,1,unrestricted);return offset-left<right-offset?left:right;}else{return this.getRelativeStructuralOffset(offset,direction>0?1:-1,unrestricted);}};ve.dm.ElementLinearData.prototype.getWordRange=function(offset){var dataString=new ve.dm.DataString(this.getData());offset=this.getNearestContentOffset(offset);var range;if(unicodeJS.wordbreak.isBreak(dataString,offset)){if(this.constructor.static.endWordRegExp.exec((dataString.read(offset-2)||' ')+(
dataString.read(offset-1)||' '))){range=new ve.Range(unicodeJS.wordbreak.prevBreakOffset(dataString,offset),offset);}else if(this.constructor.static.startWordRegExp.exec((dataString.read(offset)||' ')+(dataString.read(offset+1)||' '))){range=new ve.Range(offset,unicodeJS.wordbreak.nextBreakOffset(dataString,offset));}else{return new ve.Range(offset);}}else{range=new ve.Range(unicodeJS.wordbreak.prevBreakOffset(dataString,offset),unicodeJS.wordbreak.nextBreakOffset(dataString,offset));}if(this.getText(false,range).trim().length===0){return new ve.Range(offset);}return range;};ve.dm.ElementLinearData.prototype.getUsedStoreValues=function(range){var store=this.getStore(),valueStore={};range=range||new ve.Range(0,this.data.length);for(var i=range.start;i<range.end;i++){var hashes=this.getAnnotationHashesFromOffset(i,true);var j=hashes.length;while(j--){var hash=hashes[j];if(!Object.prototype.hasOwnProperty.call(valueStore,hash)){valueStore[hash]=store.value(hash);}}if(this.data[i].
originalDomElementsHash!==undefined){valueStore[this.data[i].originalDomElementsHash]=store.value(this.data[i].originalDomElementsHash);}}return valueStore;};ve.dm.ElementLinearData.prototype.remapInternalListIndexes=function(mapping,internalList){for(var i=0,ilen=this.data.length;i<ilen;i++){if(this.isOpenElementData(i)){var nodeClass=ve.dm.nodeFactory.lookup(this.getType(i));this.modifyData(i,function(item){nodeClass.static.remapInternalListIndexes(item,mapping,internalList);});}}};ve.dm.ElementLinearData.prototype.remapInternalListKeys=function(internalList){for(var i=0,ilen=this.data.length;i<ilen;i++){if(this.isOpenElementData(i)){var nodeClass=ve.dm.nodeFactory.lookup(this.getType(i));this.modifyData(i,function(item){nodeClass.static.remapInternalListKeys(item,internalList);});}}};ve.dm.ElementLinearData.prototype.remapAnnotationHash=function(oldHash,newHash){function remap(annotations){var spliceAt;while((spliceAt=annotations.indexOf(oldHash))!==-1){if(annotations.indexOf(
newHash)===-1){annotations.splice(spliceAt,1,newHash);}else{annotations.splice(spliceAt,1);}}}for(var i=0,ilen=this.data.length;i<ilen;i++){if(this.data[i]===undefined||typeof this.data[i]==='string'){continue;}else{this.modifyData(i,function(item){if(Array.isArray(item)){remap(item[1]);}else if(item.annotations!==undefined){remap(item.annotations);}if(ve.getProp(item,'internal','metaItems')){var data=ve.getProp(item,'internal','metaItems');for(var j=0,jlen=data.length;j<jlen;j++){if(data[j].annotations!==undefined){remap(data[j].annotations);}}}});}}};ve.dm.ElementLinearData.prototype.sanitize=function(rules){var elementStack=[],store=this.getStore(),allAnnotations=this.getAnnotationsFromRange(new ve.Range(0,this.getLength()),true);var i,len;var emptySet,setToRemove;if(rules.plainText){emptySet=new ve.dm.AnnotationSet(store);}else{if(rules.removeOriginalDomElements){for(i=0,len=allAnnotations.getLength();i<len;i++){var ann=allAnnotations.get(i);if(ann.element.originalDomElementsHash
!==undefined){var oldHash=store.hashOfValue(ann);delete allAnnotations.get(i).element.originalDomElementsHash;var newHash=store.replaceHash(oldHash,ann);this.remapAnnotationHash(oldHash,newHash);if(allAnnotations.storeHashes.indexOf(newHash)!==-1){allAnnotations.storeHashes.splice(i,1);i--;len--;}else{allAnnotations.storeHashes.splice(i,1,newHash);}}}}setToRemove=allAnnotations.filter(function(annotation){return(rules.blacklist&&rules.blacklist[annotation.name])||(annotation.name==='textStyle/span'&&rules.removeOriginalDomElements);});}var contentElement;for(i=0,len=this.getLength();i<len;i++){if(this.isElementData(i)){var type=this.getType(i);var canContainContent=ve.dm.nodeFactory.canNodeContainContent(type);var isOpen=this.isOpenElementData(i);if(isOpen){elementStack.push(this.getData(i));}else{elementStack.pop();}if(rules.conversions&&rules.conversions[type]){type=rules.conversions[type];this.modifyData(i,function(item){item.type=(!isOpen?'/':'')+type;});}if(rules.plainText&&type
!=='paragraph'&&canContainContent){type='paragraph';this.setData(i,{type:(this.isCloseElementData(i)?'/':'')+type});}if((rules.blacklist&&rules.blacklist[type])||(rules.plainText&&type!=='paragraph'&&type!=='internalList')||(!rules.allowMetadata&&ve.dm.nodeFactory.isMetaData(type))){this.splice(i,1);len--;if(isOpen){this.modifyData(i,function(item){ve.deleteProp(item,'internal','generated');});}i--;continue;}if(!rules.allowBreaks&&type==='break'&&contentElement){if(this.isOpenElementData(i-1)&&this.isCloseElementData(i+2)){this.splice(i,2);len-=2;}else{this.splice(i,2,{type:'/'+contentElement.type},ve.copy(contentElement));}i--;continue;}if(!rules.keepEmptyContentBranches&&isOpen&&this.isCloseElementData(i+1)&&!ve.getProp(this.getData(i),'internal','generated')&&canContainContent){this.splice(i,2);len-=2;i--;continue;}if(!rules.preserveHtmlWhitespace){this.modifyData(i,function(item){ve.deleteProp(item,'internal','whitespace');});}if(canContainContent&&!isOpen&&rules.singleLine){i++;
var start=i;while(i<len&&!(this.isOpenElementData(i)&&this.getType(i)==='internalList')){i++;}this.splice(start,i-start);break;}if(canContainContent){contentElement=isOpen?this.getData(i):null;}}else{if(this.getCharacterData(i)==='\n'&&!ve.dm.nodeFactory.doesNodeHaveSignificantWhitespace(elementStack[elementStack.length-1].type)){if(/^\s+$/.test(this.getCharacterData(i+1))||/^\s+$/.test(this.getCharacterData(i-1))){this.splice(i,1);len--;i--;continue;}else{if(typeof this.getData(i)==='string'){this.setData(i,' ');}else{this.modifyData(i,function(item){item[0]=' ';});}}}if(this.getCharacterData(i)==='\u00a0'&&!ve.dm.nodeFactory.doesNodeHaveSignificantWhitespace(elementStack[elementStack.length-1].type)){if(!(this.getCharacterData(i+1)===' '||this.getCharacterData(i-1)===' ')){if(typeof this.getData(i)==='string'){this.setData(i,' ');}else{this.modifyData(i,function(item){item[0]=' ';});}}}}var annotations=this.getAnnotationsFromOffset(i,true);if(!annotations.isEmpty()){if(rules.
plainText){this.setAnnotationsAtOffset(i,emptySet);}else if(setToRemove.getLength()){annotations.removeSet(setToRemove);this.setAnnotationsAtOffset(i,annotations);}}if(this.isOpenElementData(i)){if(rules.nodeSanitization){var nodeClass=ve.dm.modelRegistry.lookup(this.getType(i));this.modifyData(i,function(item){nodeClass.static.sanitize(item,rules);});}if(rules.removeOriginalDomElements){this.modifyData(i,function(item){delete item.originalDomElementsHash;});}if(!rules.allowMetadata){this.modifyData(i,function(item){ve.deleteProp(item,'internal','metaItems');});}}}};ve.dm.ElementLinearData.prototype.cloneElements=function(preserveGenerated){var store=this.getStore();for(var i=0,len=this.getLength();i<len;i++){if(this.isOpenElementData(i)){var nodeClass=ve.dm.nodeFactory.lookup(this.getType(i));if(nodeClass){this.setData(i,nodeClass.static.cloneElement(this.getData(i),store,preserveGenerated));}}}};ve.dm.ElementLinearData.prototype.countNonInternalElements=function(limit){var
internalDepth=0,count=0;for(var i=0,l=this.getLength();i<l;i++){var type=this.getType(i);if(type&&ve.dm.nodeFactory.isNodeInternal(type)){if(this.isOpenElementData(i)){internalDepth++;}else{internalDepth--;}}else if(!internalDepth){count++;if(limit&&count>=limit){return count;}}}return count;};ve.dm.ElementLinearData.prototype.hasContent=function(){return this.countNonInternalElements(3)>2||(this.isElementData(0)&&!ve.dm.nodeFactory.canNodeContainContent(this.getType(0))&&!ve.dm.nodeFactory.isNodeInternal(this.getType(0)));};ve.dm.ElementLinearData.prototype.getCommonAnnotationArrayLength=function(range){var annotationHashesForOffset=[];for(var i=range.start;i<range.end;i++){annotationHashesForOffset.push(this.getAnnotationHashesFromOffset(i));}return ve.getCommonStartSequenceLength(annotationHashesForOffset);};ve.dm.GeneratedContentNode=function VeDmGeneratedContentNode(){};OO.initClass(ve.dm.GeneratedContentNode);ve.dm.GeneratedContentNode.static.storeGeneratedContents=function(
dataElement,generatedContents,store){var hash=OO.getHash([this.getHashObjectForRendering(dataElement),undefined]);return store.hash(generatedContents,hash);};ve.dm.GeneratedContentNode.static.getHashObjectForRendering=function(dataElement){return this.getHashObject(dataElement);};ve.dm.GeneratedContentNode.prototype.getHashObjectForRendering=function(){return this.constructor.static.getHashObjectForRendering(this.element);};ve.dm.AlienNode=function VeDmAlienNode(){ve.dm.AlienNode.super.apply(this,arguments);ve.dm.FocusableNode.call(this);};OO.inheritClass(ve.dm.AlienNode,ve.dm.LeafNode);OO.mixinClass(ve.dm.AlienNode,ve.dm.FocusableNode);ve.dm.AlienNode.static.name='alien';ve.dm.AlienNode.static.preserveHtmlAttributes=false;ve.dm.AlienNode.static.enableAboutGrouping=true;ve.dm.AlienNode.static.matchRdfaTypes=['ve:Alien'];ve.dm.AlienNode.static.matchFunction=function(){return true;};ve.dm.AlienNode.static.toDataElement=function(domElements,converter){var element;if(this.name!=='alien'){
element={type:this.name};}else if(domElements.length===1&&['td','th'].indexOf(domElements[0].nodeName.toLowerCase())!==-1){var attributes={};ve.dm.TableCellableNode.static.setAttributes(attributes,domElements);element={type:'alienTableCell',attributes:attributes};}else{var isInline=this.isHybridInline(domElements,converter);var type=isInline?'alienInline':'alienBlock';element={type:type};}return element;};ve.dm.AlienNode.static.toDomElements=function(dataElement,doc,converter){return ve.copyDomElements(converter.getStore().value(dataElement.originalDomElementsHash)||[],doc);};ve.dm.AlienNode.static.isDiffComparable=function(element,other,elementStore,otherStore){if(element.type===other.type){if(element.originalDomElementsHash===other.originalDomElementsHash){return true;}}else{return false;}function removeAboutAttributes(el){Array.prototype.forEach.call(el.querySelectorAll('[about]'),function(e){e.removeAttribute('about');});}var elementOriginalDomElements=ve.copy(elementStore.value(
element.originalDomElementsHash));var otherOriginalDomElements=ve.copy(otherStore.value(other.originalDomElementsHash));elementOriginalDomElements.forEach(removeAboutAttributes);otherOriginalDomElements.forEach(removeAboutAttributes);return ve.compare(ve.copy(elementOriginalDomElements,ve.convertDomElements),ve.copy(otherOriginalDomElements,ve.convertDomElements));};ve.dm.AlienNode.static.getHashObject=function(dataElement){return{type:dataElement.type,alienDomElementsHash:dataElement.originalDomElementsHash};};ve.dm.modelRegistry.register(ve.dm.AlienNode);ve.dm.AlienBlockNode=function VeDmAlienBlockNode(){ve.dm.AlienBlockNode.super.apply(this,arguments);};OO.inheritClass(ve.dm.AlienBlockNode,ve.dm.AlienNode);ve.dm.AlienBlockNode.static.name='alienBlock';ve.dm.AlienBlockNode.static.matchRdfaTypes=[];ve.dm.AlienBlockNode.static.matchFunction=null;ve.dm.modelRegistry.register(ve.dm.AlienBlockNode);ve.dm.AlienInlineNode=function VeDmAlienInlineNode(){ve.dm.AlienInlineNode.super.apply(this
,arguments);};OO.inheritClass(ve.dm.AlienInlineNode,ve.dm.AlienNode);ve.dm.AlienInlineNode.static.name='alienInline';ve.dm.AlienInlineNode.static.isContent=true;ve.dm.AlienInlineNode.static.matchRdfaTypes=[];ve.dm.AlienInlineNode.static.matchFunction=null;ve.dm.modelRegistry.register(ve.dm.AlienInlineNode);ve.dm.AlienTableCellNode=function VeDmAlienTableCellNode(){ve.dm.AlienTableCellNode.super.apply(this,arguments);ve.dm.TableCellableNode.call(this);};OO.inheritClass(ve.dm.AlienTableCellNode,ve.dm.AlienNode);OO.mixinClass(ve.dm.AlienTableCellNode,ve.dm.TableCellableNode);ve.dm.AlienTableCellNode.static.name='alienTableCell';ve.dm.AlienTableCellNode.static.matchFunction=null;ve.dm.modelRegistry.register(ve.dm.AlienTableCellNode);ve.dm.ArticleNode=function VeDmArticleNode(){ve.dm.ArticleNode.super.apply(this,arguments);};OO.inheritClass(ve.dm.ArticleNode,ve.dm.BranchNode);ve.dm.ArticleNode.static.name='article';ve.dm.ArticleNode.static.isUnwrappable=false;ve.dm.ArticleNode.static.
matchTagNames=['article'];ve.dm.ArticleNode.prototype.canHaveSlugBefore=function(){return false;};ve.dm.ArticleNode.prototype.canHaveSlugAfter=function(){return false;};ve.dm.modelRegistry.register(ve.dm.ArticleNode);ve.dm.BlockquoteNode=function VeDmBlockquoteNode(){ve.dm.BlockquoteNode.super.apply(this,arguments);};OO.inheritClass(ve.dm.BlockquoteNode,ve.dm.BranchNode);ve.dm.BlockquoteNode.static.name='blockquote';ve.dm.BlockquoteNode.static.matchTagNames=['blockquote'];ve.dm.modelRegistry.register(ve.dm.BlockquoteNode);ve.dm.BreakNode=function VeDmBreakNode(){ve.dm.BreakNode.super.apply(this,arguments);};OO.inheritClass(ve.dm.BreakNode,ve.dm.LeafNode);ve.dm.BreakNode.static.name='break';ve.dm.BreakNode.static.isContent=true;ve.dm.BreakNode.static.matchTagNames=['br'];ve.dm.modelRegistry.register(ve.dm.BreakNode);ve.dm.CenterNode=function VeDmCenterNode(){ve.dm.CenterNode.super.apply(this,arguments);};OO.inheritClass(ve.dm.CenterNode,ve.dm.BranchNode);ve.dm.CenterNode.static.name=
'center';ve.dm.CenterNode.static.matchTagNames=['center'];ve.dm.modelRegistry.register(ve.dm.CenterNode);ve.dm.CommentNode=function VeDmCommentNode(element){ve.dm.CommentNode.super.call(this,element);ve.dm.FocusableNode.call(this);};OO.inheritClass(ve.dm.CommentNode,ve.dm.LeafNode);OO.mixinClass(ve.dm.CommentNode,ve.dm.FocusableNode);ve.dm.CommentNode.static.isContent=true;ve.dm.CommentNode.static.preserveHtmlAttributes=false;ve.dm.CommentNode.static.toDataElement=function(domElements,converter){var text;if(domElements[0].nodeType===Node.COMMENT_NODE){text=ve.safeDecodeEntities(domElements[0].data);}else{text=domElements[0].getAttribute('data-ve-comment');}return{type:converter.isValidChildNodeType('comment')&&text!==''?'comment':'commentMeta',attributes:{text:text}};};ve.dm.CommentNode.static.toDomElements=function(dataElement,doc,converter){if(converter.isForClipboard()){var span=doc.createElement('span');span.setAttribute('rel','ve:Comment');span.setAttribute('data-ve-comment',
dataElement.attributes.text);span.appendChild(doc.createTextNode('\u00a0'));return[span];}else if(converter.isForPreview()){var modelNode=ve.dm.nodeFactory.createFromElement(dataElement);modelNode.setDocument(converter.internalList.getDocument());var viewNode=ve.ce.nodeFactory.createFromModel(modelNode);viewNode.updateInvisibleIconSync(true);viewNode.$element.attr('title',dataElement.attributes.text);var els=viewNode.$element.toArray();viewNode.destroy();return els;}else{var data=dataElement.attributes.text.replace(/[-&>]/g,function(c){return'&#x'+c.charCodeAt(0).toString(16).toUpperCase()+';';});return[doc.createComment(data)];}};ve.dm.CommentNode.static.describeChange=function(key,change){if(key==='text'){var diff=this.getAttributeDiff(change.from,change.to);if(diff){return ve.htmlMsg('visualeditor-changedesc-comment-diff',diff);}else{return ve.htmlMsg('visualeditor-changedesc-comment',this.wrapText('del',change.from),this.wrapText('ins',change.to));}}};ve.dm.FakeCommentNode=function
VeDmFakeCommentNode(){ve.dm.FakeCommentNode.super.apply(this,arguments);};OO.inheritClass(ve.dm.FakeCommentNode,ve.dm.CommentNode);ve.dm.FakeCommentNode.static.name='fakeComment';ve.dm.FakeCommentNode.static.matchRdfaTypes=['ve:Comment'];ve.dm.modelRegistry.register(ve.dm.FakeCommentNode);ve.dm.RealCommentNode=function VeDmRealCommentNode(){ve.dm.RealCommentNode.super.apply(this,arguments);};OO.inheritClass(ve.dm.RealCommentNode,ve.dm.CommentNode);ve.dm.RealCommentNode.static.name='comment';ve.dm.RealCommentNode.static.matchTagNames=['#comment'];ve.dm.modelRegistry.register(ve.dm.RealCommentNode);ve.dm.DefinitionListItemNode=function VeDmDefinitionListItemNode(){ve.dm.DefinitionListItemNode.super.apply(this,arguments);};OO.inheritClass(ve.dm.DefinitionListItemNode,ve.dm.BranchNode);ve.dm.DefinitionListItemNode.static.name='definitionListItem';ve.dm.DefinitionListItemNode.static.parentNodeTypes=['definitionList'];ve.dm.DefinitionListItemNode.static.defaultAttributes={style:'term'};ve.dm
.DefinitionListItemNode.static.matchTagNames=['dt','dd'];ve.dm.DefinitionListItemNode.static.toDataElement=function(domElements){var style=domElements[0].nodeName.toLowerCase()==='dt'?'term':'definition';return{type:this.name,attributes:{style:style}};};ve.dm.DefinitionListItemNode.static.toDomElements=function(dataElement,doc){var tag=dataElement.attributes&&dataElement.attributes.style==='term'?'dt':'dd';return[doc.createElement(tag)];};ve.dm.modelRegistry.register(ve.dm.DefinitionListItemNode);ve.dm.DefinitionListNode=function VeDmDefinitionListNode(){ve.dm.DefinitionListNode.super.apply(this,arguments);};OO.inheritClass(ve.dm.DefinitionListNode,ve.dm.BranchNode);ve.dm.DefinitionListNode.static.name='definitionList';ve.dm.DefinitionListNode.static.childNodeTypes=['definitionListItem'];ve.dm.DefinitionListNode.static.matchTagNames=['dl'];ve.dm.DefinitionListNode.static.isDiffedAsList=true;ve.dm.modelRegistry.register(ve.dm.DefinitionListNode);ve.dm.DivNode=function VeDmDivNode(){ve.
dm.DivNode.super.apply(this,arguments);};OO.inheritClass(ve.dm.DivNode,ve.dm.BranchNode);ve.dm.DivNode.static.name='div';ve.dm.DivNode.static.matchTagNames=['div'];ve.dm.modelRegistry.register(ve.dm.DivNode);ve.dm.DocumentNode=function VeDmDocumentNode(children){ve.dm.DocumentNode.super.call(this,null,children);this.root=this;};OO.inheritClass(ve.dm.DocumentNode,ve.dm.BranchNode);ve.dm.DocumentNode.static.name='document';ve.dm.DocumentNode.static.isWrapped=false;ve.dm.DocumentNode.static.parentNodeTypes=[];ve.dm.DocumentNode.static.matchTagNames=[];ve.dm.DocumentNode.prototype.getElement=ve.dm.DocumentNode.prototype.getAttribute=ve.dm.DocumentNode.prototype.getAttributes=ve.dm.DocumentNode.prototype.getOriginalDomElements=ve.dm.DocumentNode.prototype.getClonedElement=ve.dm.DocumentNode.prototype.getHashObject=function(){throw new Error('DocumentNodes do not exist in the linear model');};ve.dm.modelRegistry.register(ve.dm.DocumentNode);ve.dm.HeadingNode=function VeDmHeadingNode(){ve.dm.
HeadingNode.super.apply(this,arguments);};OO.inheritClass(ve.dm.HeadingNode,ve.dm.ContentBranchNode);ve.dm.HeadingNode.static.name='heading';ve.dm.HeadingNode.static.defaultAttributes={level:1};ve.dm.HeadingNode.static.matchTagNames=['h1','h2','h3','h4','h5','h6'];ve.dm.HeadingNode.static.toDataElement=function(domElements){var levels={h1:1,h2:2,h3:3,h4:4,h5:5,h6:6},level=levels[domElements[0].nodeName.toLowerCase()];return{type:this.name,attributes:{level:level}};};ve.dm.HeadingNode.static.toDomElements=function(dataElement,doc){var level=dataElement.attributes&&dataElement.attributes.level||1;return[doc.createElement('h'+level)];};ve.dm.HeadingNode.static.describeChange=function(key,change){if(key==='level'){return ve.htmlMsg('visualeditor-changedesc-no-key',this.wrapText('del',ve.msg('visualeditor-formatdropdown-format-heading'+change.from)),this.wrapText('ins',ve.msg('visualeditor-formatdropdown-format-heading'+change.to)));}return ve.dm.HeadingNode.parent.static.describeChange.
apply(this,arguments);};ve.dm.modelRegistry.register(ve.dm.HeadingNode);ve.dm.HorizontalRuleNode=function VeDmHorizontalRuleNode(){ve.dm.HorizontalRuleNode.super.apply(this,arguments);ve.dm.FocusableNode.call(this);};OO.inheritClass(ve.dm.HorizontalRuleNode,ve.dm.LeafNode);OO.mixinClass(ve.dm.HorizontalRuleNode,ve.dm.FocusableNode);ve.dm.HorizontalRuleNode.static.name='horizontalRule';ve.dm.HorizontalRuleNode.static.matchTagNames=['hr'];ve.dm.modelRegistry.register(ve.dm.HorizontalRuleNode);ve.dm.InternalItemNode=function VeDmInternalItemNode(){ve.dm.InternalItemNode.super.apply(this,arguments);};OO.inheritClass(ve.dm.InternalItemNode,ve.dm.BranchNode);ve.dm.InternalItemNode.static.name='internalItem';ve.dm.InternalItemNode.static.matchTagNames=[];ve.dm.InternalItemNode.static.ignoreChildren=true;ve.dm.InternalItemNode.static.isInternal=true;ve.dm.InternalItemNode.static.isDeletable=false;ve.dm.InternalItemNode.static.parentNodeTypes=['internalList'];ve.dm.InternalItemNode.static.
describeChanges=function(){return[];};ve.dm.InternalItemNode.static.getHashObject=function(dataElement){return{type:dataElement.type};};ve.dm.InternalItemNode.prototype.isDiffedAsDocument=function(){return false;};ve.dm.modelRegistry.register(ve.dm.InternalItemNode);ve.dm.InternalListNode=function VeDmInternalListNode(){ve.dm.InternalListNode.super.apply(this,arguments);};OO.inheritClass(ve.dm.InternalListNode,ve.dm.BranchNode);ve.dm.InternalListNode.static.name='internalList';ve.dm.InternalListNode.static.childNodeTypes=['internalItem'];ve.dm.InternalListNode.static.matchTagNames=[];ve.dm.InternalListNode.static.isInternal=true;ve.dm.InternalListNode.static.isDeletable=false;ve.dm.modelRegistry.register(ve.dm.InternalListNode);ve.dm.ListItemNode=function VeDmListItemNode(){ve.dm.ListItemNode.super.apply(this,arguments);};OO.inheritClass(ve.dm.ListItemNode,ve.dm.BranchNode);ve.dm.ListItemNode.static.name='listItem';ve.dm.ListItemNode.static.parentNodeTypes=['list'];ve.dm.ListItemNode.
static.matchTagNames=['li'];ve.dm.modelRegistry.register(ve.dm.ListItemNode);ve.dm.ListNode=function VeDmListNode(){ve.dm.ListNode.super.apply(this,arguments);};OO.inheritClass(ve.dm.ListNode,ve.dm.BranchNode);ve.dm.ListNode.static.name='list';ve.dm.ListNode.static.childNodeTypes=['listItem'];ve.dm.ListNode.static.defaultAttributes={style:'bullet'};ve.dm.ListNode.static.matchTagNames=['ul','ol'];ve.dm.ListNode.static.isDiffedAsList=true;ve.dm.ListNode.static.createItem=function(){return{type:'listItem'};};ve.dm.ListNode.static.toDataElement=function(domElements){var style=domElements[0].nodeName.toLowerCase()==='ol'?'number':'bullet';return{type:this.name,attributes:{style:style}};};ve.dm.ListNode.static.toDomElements=function(dataElement,doc){var tag=dataElement.attributes&&dataElement.attributes.style==='number'?'ol':'ul';return[doc.createElement(tag)];};ve.dm.ListNode.static.describeChange=function(key,change){if(key==='style'){return ve.htmlMsg('visualeditor-changedesc-no-key',this
.wrapText('del',ve.msg('visualeditor-listbutton-'+change.from+'-tooltip')),this.wrapText('ins',ve.msg('visualeditor-listbutton-'+change.to+'-tooltip')));}return ve.dm.ListNode.parent.static.describeChange.apply(this,arguments);};ve.dm.ListNode.prototype.canHaveSlugAfter=function(){return false;};ve.dm.modelRegistry.register(ve.dm.ListNode);ve.dm.ParagraphNode=function VeDmParagraphNode(){ve.dm.ParagraphNode.super.apply(this,arguments);};OO.inheritClass(ve.dm.ParagraphNode,ve.dm.ContentBranchNode);ve.dm.ParagraphNode.static.name='paragraph';ve.dm.ParagraphNode.static.matchTagNames=['p'];ve.dm.modelRegistry.register(ve.dm.ParagraphNode);ve.dm.PreformattedNode=function VeDmPreformattedNode(){ve.dm.PreformattedNode.super.apply(this,arguments);};OO.inheritClass(ve.dm.PreformattedNode,ve.dm.ContentBranchNode);ve.dm.PreformattedNode.static.name='preformatted';ve.dm.PreformattedNode.static.hasSignificantWhitespace=true;ve.dm.PreformattedNode.static.matchTagNames=['pre'];ve.dm.modelRegistry.
register(ve.dm.PreformattedNode);ve.dm.SectionNode=function VeDmSectionNode(){ve.dm.SectionNode.super.apply(this,arguments);};OO.inheritClass(ve.dm.SectionNode,ve.dm.BranchNode);ve.dm.SectionNode.static.name='section';ve.dm.SectionNode.static.isUnwrappable=false;ve.dm.SectionNode.static.defaultAttributes={style:'section'};ve.dm.SectionNode.static.matchTagNames=['header','section','footer'];ve.dm.SectionNode.static.toDataElement=function(domElements){return{type:this.name,attributes:{style:domElements[0].nodeName.toLowerCase()}};};ve.dm.SectionNode.static.toDomElements=function(dataElement,doc){var style=dataElement.attributes&&dataElement.attributes.style||'section';return[doc.createElement(style)];};ve.dm.SectionNode.prototype.canHaveSlugBefore=function(){return false;};ve.dm.SectionNode.prototype.canHaveSlugAfter=function(){return false;};ve.dm.modelRegistry.register(ve.dm.SectionNode);ve.dm.TableCaptionNode=function VeDmTableCaptionNode(){ve.dm.TableCaptionNode.super.apply(this,
arguments);};OO.inheritClass(ve.dm.TableCaptionNode,ve.dm.BranchNode);ve.dm.TableCaptionNode.static.name='tableCaption';ve.dm.TableCaptionNode.static.parentNodeTypes=['table'];ve.dm.TableCaptionNode.static.matchTagNames=['caption'];ve.dm.modelRegistry.register(ve.dm.TableCaptionNode);ve.dm.TableCellNode=function VeDmTableCellNode(){ve.dm.TableCellNode.super.apply(this,arguments);ve.dm.TableCellableNode.call(this);};OO.inheritClass(ve.dm.TableCellNode,ve.dm.BranchNode);OO.mixinClass(ve.dm.TableCellNode,ve.dm.TableCellableNode);ve.dm.TableCellNode.static.name='tableCell';ve.dm.TableCellNode.static.isUnwrappable=false;ve.dm.TableCellNode.static.parentNodeTypes=['tableRow'];ve.dm.TableCellNode.static.defaultAttributes={style:'data'};ve.dm.TableCellNode.static.matchTagNames=['td','th'];ve.dm.TableCellNode.static.isCellEditable=true;ve.dm.TableCellNode.static.preserveHtmlAttributes=function(attribute){return attribute!=='colspan'&&attribute!=='rowspan';};ve.dm.TableCellNode.static.
toDataElement=function(domElements){var attributes={};ve.dm.TableCellableNode.static.setAttributes(attributes,domElements);return{type:this.name,attributes:attributes};};ve.dm.TableCellNode.static.toDomElements=function(dataElement,doc){var tag=dataElement.attributes&&dataElement.attributes.style==='header'?'th':'td',domElement=doc.createElement(tag),attributes=dataElement.attributes;ve.dm.TableCellableNode.static.applyAttributes(attributes,domElement);return[domElement];};ve.dm.TableCellNode.static.createData=function(options){options=options||{};var opening={type:'tableCell',attributes:{style:options.style||'data',rowspan:options.rowspan||1,colspan:options.colspan||1}};var content=options.content||[{type:'paragraph',internal:{generated:'wrapper'}},{type:'/paragraph'}];return[opening].concat(content).concat([{type:'/tableCell'}]);};ve.dm.TableCellNode.static.describeChange=function(key,change){if(key==='style'){return ve.htmlMsg('visualeditor-changedesc-no-key',this.wrapText('del',ve.
msg('visualeditor-table-format-'+change.from)),this.wrapText('ins',ve.msg('visualeditor-table-format-'+change.to)));}else if(key==='colspan'||key==='rowspan'){if(change.from===1){change.from=undefined;}if(change.to===1){change.to=undefined;}if(change.from===change.to){return null;}}else if(key==='originalColspan'||key==='originalRowspan'){return null;}return ve.dm.TableCellNode.parent.static.describeChange.call(this,key,change);};ve.dm.modelRegistry.register(ve.dm.TableCellNode);ve.dm.TableNode=function VeDmTableNode(){ve.dm.TableNode.super.apply(this,arguments);this.matrix=new ve.dm.TableMatrix(this);this.connect(this,{splice:'onSplice'});};OO.inheritClass(ve.dm.TableNode,ve.dm.BranchNode);ve.dm.TableNode.static.name='table';ve.dm.TableNode.static.childNodeTypes=['tableSection','tableCaption'];ve.dm.TableNode.static.matchTagNames=['table'];ve.dm.TableNode.prototype.onSplice=function(){var nodes=Array.prototype.slice.call(arguments,2);this.getMatrix().invalidate();for(var i=0;i<nodes.
length;i++){nodes[i].connect(this,{cellAttributeChange:'onCellAttributeChange'});}};ve.dm.TableNode.prototype.onCellAttributeChange=function(cell){this.emit('cellAttributeChange',cell);};ve.dm.TableNode.prototype.getMatrix=function(){return this.matrix;};ve.dm.TableNode.prototype.getCaptionNode=function(){for(var i=0,l=this.children.length;i<l;i++){if(this.children[i]instanceof ve.dm.TableCaptionNode){return this.children[i];}}return null;};ve.dm.TableNode.prototype.getIterator=function(){return new ve.dm.TableNodeCellIterator(this);};ve.dm.modelRegistry.register(ve.dm.TableNode);ve.dm.TableNodeCellIterator=function VeDmTableNodeCellIterator(tableNode){OO.EventEmitter.call(this);this.table=tableNode;this.sectionIndex=0;this.rowIndex=0;this.cellIndex=0;this.sectionCount=this.table.children.length;this.rowCount=0;this.cellCount=0;this.sectionNode=null;this.rowNode=null;this.cellNode=null;this.finished=false;};OO.mixinClass(ve.dm.TableNodeCellIterator,OO.EventEmitter);ve.dm.
TableNodeCellIterator.prototype.isFinished=function(){return this.finished;};ve.dm.TableNodeCellIterator.prototype.next=function(){if(this.isFinished()){throw new Error('TableNodeCellIterator has no more cells left.');}this.nextCell(this);return this.cellNode;};ve.dm.TableNodeCellIterator.prototype.nextSection=function(){if(this.sectionIndex>=this.sectionCount){this.finished=true;this.sectionNode=undefined;return;}var sectionNode=this.table.children[this.sectionIndex];this.sectionIndex++;this.rowIndex=0;if(sectionNode instanceof ve.dm.TableSectionNode){this.sectionNode=sectionNode;this.rowCount=this.sectionNode.children.length;this.emit('newSection',this.sectionNode);}else{this.nextSection();return;}};ve.dm.TableNodeCellIterator.prototype.nextRow=function(){if(this.rowIndex>=this.rowCount){this.nextSection();if(this.isFinished()){this.rowNode=undefined;return;}}var rowNode=this.sectionNode.children[this.rowIndex];this.rowIndex++;this.cellIndex=0;if(rowNode instanceof ve.dm.TableRowNode
){this.rowNode=rowNode;this.cellCount=this.rowNode.children.length;this.emit('newRow',this.rowNode);}else{this.nextRow();return;}};ve.dm.TableNodeCellIterator.prototype.nextCell=function(){if(!this.sectionNode){this.nextSection();}if(!this.rowNode){this.nextRow();}if(this.cellIndex>=this.cellCount){this.nextRow();if(this.isFinished()){this.cellNode=undefined;return;}}var cellNode=this.rowNode.children[this.cellIndex];this.cellNode=cellNode&&cellNode.isCellable()?cellNode:null;this.cellIndex++;};ve.dm.TableRowNode=function VeDmTableRowNode(){ve.dm.TableRowNode.super.apply(this,arguments);this.connect(this,{splice:'onSplice'});};OO.inheritClass(ve.dm.TableRowNode,ve.dm.BranchNode);ve.dm.TableRowNode.static.name='tableRow';ve.dm.TableRowNode.static.childNodeTypes=['tableCell','alienTableCell'];ve.dm.TableRowNode.static.parentNodeTypes=['tableSection'];ve.dm.TableRowNode.static.matchTagNames=['tr'];ve.dm.TableRowNode.static.createData=function(options){options=options||{};var cellCount=
options.cellCount||1;var data=[];data.push({type:'tableRow'});for(var i=0;i<cellCount;i++){data=data.concat(ve.dm.TableCellNode.static.createData({style:Array.isArray(options.style)?options.style[i]:options.style}));}data.push({type:'/tableRow'});return data;};ve.dm.TableRowNode.prototype.onSplice=function(){if(this.getRoot()){this.getParent().getParent().getMatrix().invalidate();}var nodes=Array.prototype.slice.call(arguments,2);for(var i=0;i<nodes.length;i++){nodes[i].connect(this,{attributeChange:['onCellAttributeChange',nodes[i]]});}};ve.dm.TableRowNode.prototype.onCellAttributeChange=function(cell){this.emit('cellAttributeChange',cell);};ve.dm.modelRegistry.register(ve.dm.TableRowNode);ve.dm.TableSectionNode=function VeDmTableSectionNode(){ve.dm.TableSectionNode.super.apply(this,arguments);this.connect(this,{splice:'onSplice'});};OO.inheritClass(ve.dm.TableSectionNode,ve.dm.BranchNode);ve.dm.TableSectionNode.static.name='tableSection';ve.dm.TableSectionNode.static.childNodeTypes=[
'tableRow'];ve.dm.TableSectionNode.static.parentNodeTypes=['table'];ve.dm.TableSectionNode.static.defaultAttributes={style:'body'};ve.dm.TableSectionNode.static.matchTagNames=['thead','tbody','tfoot'];ve.dm.TableSectionNode.static.toDataElement=function(domElements){var styles={thead:'header',tbody:'body',tfoot:'footer'},style=styles[domElements[0].nodeName.toLowerCase()]||'body';return{type:this.name,attributes:{style:style}};};ve.dm.TableSectionNode.static.toDomElements=function(dataElement,doc){var tags={header:'thead',body:'tbody',footer:'tfoot'},tag=tags[dataElement.attributes&&dataElement.attributes.style||'body'];return[doc.createElement(tag)];};ve.dm.TableSectionNode.prototype.onSplice=function(){if(this.getRoot()){this.getParent().getMatrix().invalidate();}var nodes=Array.prototype.slice.call(arguments,2);for(var i=0;i<nodes.length;i++){nodes[i].connect(this,{cellAttributeChange:'onCellAttributeChange'});}};ve.dm.TableSectionNode.prototype.onCellAttributeChange=function(cell){
this.emit('cellAttributeChange',cell);};ve.dm.modelRegistry.register(ve.dm.TableSectionNode);ve.dm.TextNode=function VeDmTextNode(length){ve.dm.TextNode.super.call(this);this.length=length||0;};OO.inheritClass(ve.dm.TextNode,ve.dm.LeafNode);ve.dm.TextNode.static.name='text';ve.dm.TextNode.static.isWrapped=false;ve.dm.TextNode.static.isContent=true;ve.dm.TextNode.static.matchTagNames=[];ve.dm.TextNode.prototype.canHaveSlugBefore=function(){return false;};ve.dm.TextNode.prototype.canHaveSlugAfter=function(){return false;};ve.dm.modelRegistry.register(ve.dm.TextNode);ve.dm.ImageNode=function VeDmImageNode(){ve.dm.FocusableNode.call(this);ve.dm.ResizableNode.call(this);};OO.mixinClass(ve.dm.ImageNode,ve.dm.FocusableNode);OO.mixinClass(ve.dm.ImageNode,ve.dm.ResizableNode);ve.dm.ImageNode.static.isDiffComparable=function(element,other){return element.type===other.type&&element.attributes.src===other.attributes.src;};ve.dm.ImageNode.static.describeChanges=function(attributeChanges,attributes)
{var customKeys=['width','height'],descriptions=[];function describeSize(width,height){return width+ve.msg('visualeditor-dimensionswidget-times')+height+ve.msg('visualeditor-dimensionswidget-px');}if('width'in attributeChanges||'height'in attributeChanges){var sizeFrom=describeSize('width'in attributeChanges?attributeChanges.width.from:attributes.width,'height'in attributeChanges?attributeChanges.height.from:attributes.height);var sizeTo=describeSize('width'in attributeChanges?attributeChanges.width.to:attributes.width,'height'in attributeChanges?attributeChanges.height.to:attributes.height);descriptions.push(ve.htmlMsg('visualeditor-changedesc-image-size',this.wrapText('del',sizeFrom),this.wrapText('ins',sizeTo)));}for(var key in attributeChanges){if(customKeys.indexOf(key)===-1){var change=this.describeChange(key,attributeChanges[key]);if(change){descriptions.push(change);}}}return descriptions;};ve.dm.ImageNode.static.describeChange=function(key,change){switch(key){case'align':
return ve.htmlMsg('visualeditor-changedesc-align',this.wrapText('del',ve.msg('visualeditor-align-desc-'+change.from)),this.wrapText('ins',ve.msg('visualeditor-align-desc-'+change.to)));case'originalClasses':case'unrecognizedClasses':return;}return ve.dm.Node.static.describeChange.apply(this,arguments);};ve.dm.ImageNode.prototype.createScalable=function(){return new ve.dm.Scalable({currentDimensions:{width:this.getAttribute('width'),height:this.getAttribute('height')},minDimensions:{width:1,height:1}});};ve.dm.BlockImageNode=function VeDmBlockImageNode(){ve.dm.BlockImageNode.super.apply(this,arguments);ve.dm.ImageNode.call(this);ve.dm.AlignableNode.call(this);};OO.inheritClass(ve.dm.BlockImageNode,ve.dm.BranchNode);OO.mixinClass(ve.dm.BlockImageNode,ve.dm.ImageNode);OO.mixinClass(ve.dm.BlockImageNode,ve.dm.ClassAttributeNode);OO.mixinClass(ve.dm.BlockImageNode,ve.dm.AlignableNode);ve.dm.BlockImageNode.static.name='blockImage';ve.dm.BlockImageNode.static.preserveHtmlAttributes=function(
attribute){var attributes=['class','src','width','height'];return attributes.indexOf(attribute)===-1;};ve.dm.BlockImageNode.static.handlesOwnChildren=true;ve.dm.BlockImageNode.static.childNodeTypes=['imageCaption'];ve.dm.BlockImageNode.static.matchTagNames=['figure'];ve.dm.BlockImageNode.static.matchFunction=function(element){return element.children[0]&&element.children[0].nodeName==='IMG';};ve.dm.BlockImageNode.static.toDataElement=function(domElements,converter){var figure=domElements[0];var classAttr=figure.getAttribute('class');var img=figure.children[0];var width=img.getAttribute('width');var height=img.getAttribute('height');var caption=figure.children[1];var attributes={src:img.getAttribute('src'),width:width!==null&&width!==''?+width:null,height:height!==null&&height!==''?+height:null,alt:img.getAttribute('alt')};this.setClassAttributes(attributes,classAttr);var dataElement={type:this.name,attributes:attributes};if(!caption){return[dataElement,{type:'imageCaption'},{type:
'/imageCaption'},{type:'/'+this.name}];}else{return[dataElement].concat(converter.getDataFromDomClean(caption,{type:'imageCaption'})).concat([{type:'/'+this.name}]);}};ve.dm.BlockImageNode.static.toDomElements=function(data,doc,converter){var dataElement=data[0],figure=doc.createElement('figure'),img=doc.createElement('img');ve.setDomAttributes(img,dataElement.attributes,['alt','src','width','height']);figure.appendChild(img);var classAttr=this.getClassAttrFromAttributes(dataElement.attributes);if(classAttr){figure.className=classAttr;}var captionData=data.slice(1,-1);if(captionData.length>2){var wrapper=doc.createElement('div');converter.getDomSubtreeFromData(data.slice(1,-1),wrapper);while(wrapper.firstChild){figure.appendChild(wrapper.firstChild);}}return[figure];};ve.dm.BlockImageNode.prototype.getCaptionNode=function(){var node=this.children[0];return node instanceof ve.dm.BlockImageCaptionNode?node:null;};ve.dm.BlockImageNode.prototype.suppressSlugType=function(){return this.
getAttribute('align')!=='center'?'float':null;};ve.dm.modelRegistry.register(ve.dm.BlockImageNode);ve.dm.BlockImageCaptionNode=function VeDmBlockImageCaptionNode(){ve.dm.BlockImageCaptionNode.super.apply(this,arguments);};OO.inheritClass(ve.dm.BlockImageCaptionNode,ve.dm.BranchNode);ve.dm.BlockImageCaptionNode.static.name='imageCaption';ve.dm.BlockImageCaptionNode.static.matchTagNames=[];ve.dm.BlockImageCaptionNode.static.parentNodeTypes=['blockImage'];ve.dm.BlockImageCaptionNode.static.toDomElements=function(dataElement,doc){return[doc.createElement('figcaption')];};ve.dm.modelRegistry.register(ve.dm.BlockImageCaptionNode);ve.dm.InlineImageNode=function VeDmInlineImageNode(){ve.dm.InlineImageNode.super.apply(this,arguments);ve.dm.ImageNode.call(this);};OO.inheritClass(ve.dm.InlineImageNode,ve.dm.LeafNode);OO.mixinClass(ve.dm.InlineImageNode,ve.dm.ImageNode);ve.dm.InlineImageNode.static.name='inlineImage';ve.dm.InlineImageNode.static.isContent=true;ve.dm.InlineImageNode.static.
matchTagNames=['img'];ve.dm.InlineImageNode.static.toDataElement=function(domElements){var domElement=domElements[0],alt=domElement.getAttribute('alt'),width=domElement.getAttribute('width'),height=domElement.getAttribute('height');return{type:this.name,attributes:{src:domElement.getAttribute('src'),alt:alt,width:width!==null&&width!==''?+width:null,height:height!==null&&height!==''?+height:null}};};ve.dm.InlineImageNode.static.toDomElements=function(dataElement,doc){var domElement=doc.createElement('img');ve.setDomAttributes(domElement,dataElement.attributes,['alt','src','width','height']);return[domElement];};ve.dm.modelRegistry.register(ve.dm.InlineImageNode);ve.dm.LinkAnnotation=function VeDmLinkAnnotation(){ve.dm.LinkAnnotation.super.apply(this,arguments);};OO.inheritClass(ve.dm.LinkAnnotation,ve.dm.Annotation);ve.dm.LinkAnnotation.static.name='link';ve.dm.LinkAnnotation.static.matchTagNames=['a'];ve.dm.LinkAnnotation.static.toDataElement=function(domElements){if(!domElements[0].
hasAttribute('href')){return ve.dm.SpanAnnotation.static.toDataElement.apply(ve.dm.SpanAnnotation.static,arguments);}return{type:this.name,attributes:{href:domElements[0].getAttribute('href')}};};ve.dm.LinkAnnotation.static.toDomElements=function(dataElement,doc){var domElement=doc.createElement('a');domElement.setAttribute('href',this.getHref(dataElement));return[domElement];};ve.dm.LinkAnnotation.static.describeChange=function(key,change){if(key==='href'){var diff=this.getAttributeDiff(change.from,change.to);if(diff){return ve.htmlMsg('visualeditor-changedesc-link-href-diff',diff);}else{return ve.htmlMsg('visualeditor-changedesc-link-href',this.wrapText('del',change.from),this.wrapText('ins',change.to));}}return ve.dm.LinkAnnotation.parent.static.describeChange.apply(this,arguments);};ve.dm.LinkAnnotation.static.getHref=function(dataElement){return dataElement.attributes.href;};ve.dm.LinkAnnotation.prototype.getHref=function(){return this.constructor.static.getHref(this.element);};ve
.dm.LinkAnnotation.prototype.getDisplayTitle=function(){return this.getHref();};ve.dm.LinkAnnotation.prototype.getFragment=function(){var href=this.getHref(),hash=href.indexOf('#');if(hash===-1){return null;}return href.slice(hash+1);};ve.dm.LinkAnnotation.prototype.getComparableObject=function(){return{type:this.getType(),href:this.getAttribute('href')};};ve.dm.LinkAnnotation.prototype.getComparableHtmlAttributes=function(){var comparableAttributes=ve.dm.LinkAnnotation.super.prototype.getComparableHtmlAttributes.call(this);delete comparableAttributes.href;return comparableAttributes;};ve.dm.LinkAnnotation.prototype.describeAdded=function(){return[ve.msg('visualeditor-changedesc-link-added',this.getDisplayTitle())];};ve.dm.LinkAnnotation.prototype.describeRemoved=function(){return[ve.msg('visualeditor-changedesc-link-removed',this.getDisplayTitle())];};ve.dm.modelRegistry.register(ve.dm.LinkAnnotation);ve.dm.TextStyleAnnotation=function VeDmTextStyleAnnotation(){ve.dm.
TextStyleAnnotation.super.apply(this,arguments);};OO.inheritClass(ve.dm.TextStyleAnnotation,ve.dm.Annotation);ve.dm.TextStyleAnnotation.static.name='textStyle';ve.dm.TextStyleAnnotation.static.matchTagNames=[];ve.dm.TextStyleAnnotation.static.toDataElement=function(domElements,converter){var nodeName=converter.isFromClipboard()?this.matchTagNames[0]:domElements[0].nodeName.toLowerCase();return{type:this.name,attributes:{nodeName:nodeName}};};ve.dm.TextStyleAnnotation.static.toDomElements=function(dataElement,doc){var nodeName=ve.getProp(dataElement,'attributes','nodeName');return[doc.createElement(nodeName||this.matchTagNames[0])];};ve.dm.TextStyleAnnotation.static.description=null;ve.dm.TextStyleAnnotation.prototype.getComparableObject=function(){return{type:this.getType()};};ve.dm.TextStyleAnnotation.prototype.describeAdded=function(){if(this.constructor.static.description){return[ve.msg('visualeditor-changedesc-textstyle-added',OO.ui.resolveMsg(this.constructor.static.description))]
;}return[];};ve.dm.TextStyleAnnotation.prototype.describeRemoved=function(){if(this.constructor.static.description){return[ve.msg('visualeditor-changedesc-textstyle-removed',OO.ui.resolveMsg(this.constructor.static.description))];}return[];};ve.dm.modelRegistry.register(ve.dm.TextStyleAnnotation);ve.dm.AbbreviationAnnotation=function VeDmAbbreviationAnnotation(){ve.dm.AbbreviationAnnotation.super.apply(this,arguments);};OO.inheritClass(ve.dm.AbbreviationAnnotation,ve.dm.TextStyleAnnotation);ve.dm.AbbreviationAnnotation.static.name='textStyle/abbreviation';ve.dm.AbbreviationAnnotation.static.matchTagNames=['abbr'];ve.dm.modelRegistry.register(ve.dm.AbbreviationAnnotation);ve.dm.BidiAnnotation=function VeDmBidiAnnotation(){ve.dm.BidiAnnotation.super.apply(this,arguments);};OO.inheritClass(ve.dm.BidiAnnotation,ve.dm.TextStyleAnnotation);ve.dm.BidiAnnotation.static.name='textStyle/bidi';ve.dm.BidiAnnotation.static.matchTagNames=['bdi'];ve.dm.modelRegistry.register(ve.dm.BidiAnnotation);ve.
dm.BigAnnotation=function VeDmBigAnnotation(){ve.dm.BigAnnotation.super.apply(this,arguments);};OO.inheritClass(ve.dm.BigAnnotation,ve.dm.TextStyleAnnotation);ve.dm.BigAnnotation.static.name='textStyle/big';ve.dm.BigAnnotation.static.matchTagNames=['big'];ve.dm.BigAnnotation.static.removes=['textStyle/small'];ve.dm.BigAnnotation.static.description=OO.ui.deferMsg('visualeditor-annotationbutton-big-tooltip');ve.dm.modelRegistry.register(ve.dm.BigAnnotation);ve.dm.BoldAnnotation=function VeDmBoldAnnotation(){ve.dm.BoldAnnotation.super.apply(this,arguments);};OO.inheritClass(ve.dm.BoldAnnotation,ve.dm.TextStyleAnnotation);ve.dm.BoldAnnotation.static.name='textStyle/bold';ve.dm.BoldAnnotation.static.matchTagNames=['b','strong'];ve.dm.BoldAnnotation.static.inferFromView=true;ve.dm.BoldAnnotation.static.description=OO.ui.deferMsg('visualeditor-annotationbutton-bold-tooltip');ve.dm.modelRegistry.register(ve.dm.BoldAnnotation);ve.dm.CodeSampleAnnotation=function VeDmCodeSampleAnnotation(){ve.dm
.CodeSampleAnnotation.super.apply(this,arguments);};OO.inheritClass(ve.dm.CodeSampleAnnotation,ve.dm.TextStyleAnnotation);ve.dm.CodeSampleAnnotation.static.name='textStyle/codeSample';ve.dm.CodeSampleAnnotation.static.matchTagNames=['samp'];ve.dm.modelRegistry.register(ve.dm.CodeSampleAnnotation);ve.dm.CodeAnnotation=function VeDmCodeAnnotation(){ve.dm.CodeAnnotation.super.apply(this,arguments);};OO.inheritClass(ve.dm.CodeAnnotation,ve.dm.TextStyleAnnotation);ve.dm.CodeAnnotation.static.name='textStyle/code';ve.dm.CodeAnnotation.static.matchTagNames=['code','tt'];ve.dm.CodeAnnotation.static.description=OO.ui.deferMsg('visualeditor-annotationbutton-code-tooltip');ve.dm.modelRegistry.register(ve.dm.CodeAnnotation);ve.dm.DatetimeAnnotation=function VeDmDatetimeAnnotation(){ve.dm.DatetimeAnnotation.super.apply(this,arguments);};OO.inheritClass(ve.dm.DatetimeAnnotation,ve.dm.TextStyleAnnotation);ve.dm.DatetimeAnnotation.static.name='textStyle/datetime';ve.dm.DatetimeAnnotation.static.
matchTagNames=['time'];ve.dm.DatetimeAnnotation.static.toDataElement=function(domElements){var dataElement=ve.dm.DatetimeAnnotation.super.static.toDataElement.apply(this,arguments);dataElement.attributes.datetime=domElements[0].getAttribute('datetime');return dataElement;};ve.dm.DatetimeAnnotation.static.toDomElements=function(dataElement,doc){var domElement=doc.createElement('time');if(dataElement.attributes.datetime){domElement.setAttribute('datetime',dataElement.attributes.datetime);}return[domElement];};ve.dm.DatetimeAnnotation.prototype.getComparableObject=function(){return{type:this.getType(),datetime:this.getAttribute('datetime')};};ve.dm.modelRegistry.register(ve.dm.DatetimeAnnotation);ve.dm.DefinitionAnnotation=function VeDmDefinitionAnnotation(){ve.dm.DefinitionAnnotation.super.apply(this,arguments);};OO.inheritClass(ve.dm.DefinitionAnnotation,ve.dm.TextStyleAnnotation);ve.dm.DefinitionAnnotation.static.name='textStyle/definition';ve.dm.DefinitionAnnotation.static.
matchTagNames=['dfn'];ve.dm.modelRegistry.register(ve.dm.DefinitionAnnotation);ve.dm.DeleteAnnotation=function VeDmDeleteAnnotation(){ve.dm.DeleteAnnotation.super.apply(this,arguments);};OO.inheritClass(ve.dm.DeleteAnnotation,ve.dm.TextStyleAnnotation);ve.dm.DeleteAnnotation.static.name='textStyle/delete';ve.dm.DeleteAnnotation.static.matchTagNames=['del'];ve.dm.DeleteAnnotation.static.trimWhitespace=false;ve.dm.modelRegistry.register(ve.dm.DeleteAnnotation);ve.dm.FontAnnotation=function VeDmFontAnnotation(){ve.dm.FontAnnotation.super.apply(this,arguments);};OO.inheritClass(ve.dm.FontAnnotation,ve.dm.TextStyleAnnotation);ve.dm.FontAnnotation.static.name='textStyle/font';ve.dm.FontAnnotation.static.matchTagNames=['font'];ve.dm.modelRegistry.register(ve.dm.FontAnnotation);ve.dm.HighlightAnnotation=function VeDmHighlightAnnotation(){ve.dm.HighlightAnnotation.super.apply(this,arguments);};OO.inheritClass(ve.dm.HighlightAnnotation,ve.dm.TextStyleAnnotation);ve.dm.HighlightAnnotation.static.
name='textStyle/highlight';ve.dm.HighlightAnnotation.static.matchTagNames=['mark'];ve.dm.modelRegistry.register(ve.dm.HighlightAnnotation);ve.dm.InsertAnnotation=function VeDmInsertAnnotation(){ve.dm.InsertAnnotation.super.apply(this,arguments);};OO.inheritClass(ve.dm.InsertAnnotation,ve.dm.TextStyleAnnotation);ve.dm.InsertAnnotation.static.name='textStyle/insert';ve.dm.InsertAnnotation.static.matchTagNames=['ins'];ve.dm.InsertAnnotation.static.trimWhitespace=false;ve.dm.modelRegistry.register(ve.dm.InsertAnnotation);ve.dm.ItalicAnnotation=function VeDmItalicAnnotation(){ve.dm.ItalicAnnotation.super.apply(this,arguments);};OO.inheritClass(ve.dm.ItalicAnnotation,ve.dm.TextStyleAnnotation);ve.dm.ItalicAnnotation.static.name='textStyle/italic';ve.dm.ItalicAnnotation.static.matchTagNames=['i','em'];ve.dm.ItalicAnnotation.static.inferFromView=true;ve.dm.ItalicAnnotation.static.description=OO.ui.deferMsg('visualeditor-annotationbutton-italic-tooltip');ve.dm.modelRegistry.register(ve.dm.
ItalicAnnotation);ve.dm.QuotationAnnotation=function VeDmQuotationAnnotation(){ve.dm.QuotationAnnotation.super.apply(this,arguments);};OO.inheritClass(ve.dm.QuotationAnnotation,ve.dm.TextStyleAnnotation);ve.dm.QuotationAnnotation.static.name='textStyle/quotation';ve.dm.QuotationAnnotation.static.matchTagNames=['q'];ve.dm.modelRegistry.register(ve.dm.QuotationAnnotation);ve.dm.SmallAnnotation=function VeDmSmallAnnotation(){ve.dm.SmallAnnotation.super.apply(this,arguments);};OO.inheritClass(ve.dm.SmallAnnotation,ve.dm.TextStyleAnnotation);ve.dm.SmallAnnotation.static.name='textStyle/small';ve.dm.SmallAnnotation.static.matchTagNames=['small'];ve.dm.SmallAnnotation.static.removes=['textStyle/big'];ve.dm.SmallAnnotation.static.description=OO.ui.deferMsg('visualeditor-annotationbutton-small-tooltip');ve.dm.modelRegistry.register(ve.dm.SmallAnnotation);ve.dm.SpanAnnotation=function VeDmSpanAnnotation(){ve.dm.SpanAnnotation.super.apply(this,arguments);};OO.inheritClass(ve.dm.SpanAnnotation,ve.
dm.TextStyleAnnotation);ve.dm.SpanAnnotation.static.name='textStyle/span';ve.dm.SpanAnnotation.static.matchTagNames=['span'];ve.dm.modelRegistry.register(ve.dm.SpanAnnotation);ve.dm.StrikethroughAnnotation=function VeDmStrikethroughAnnotation(){ve.dm.StrikethroughAnnotation.super.apply(this,arguments);};OO.inheritClass(ve.dm.StrikethroughAnnotation,ve.dm.TextStyleAnnotation);ve.dm.StrikethroughAnnotation.static.name='textStyle/strikethrough';ve.dm.StrikethroughAnnotation.static.matchTagNames=['s','del'];ve.dm.StrikethroughAnnotation.static.description=OO.ui.deferMsg('visualeditor-annotationbutton-strikethrough-tooltip');ve.dm.modelRegistry.register(ve.dm.StrikethroughAnnotation);ve.dm.SubscriptAnnotation=function VeDmSubscriptAnnotation(){ve.dm.SubscriptAnnotation.super.apply(this,arguments);};OO.inheritClass(ve.dm.SubscriptAnnotation,ve.dm.TextStyleAnnotation);ve.dm.SubscriptAnnotation.static.name='textStyle/subscript';ve.dm.SubscriptAnnotation.static.matchTagNames=['sub'];ve.dm.
SubscriptAnnotation.static.removes=['textStyle/superscript'];ve.dm.SubscriptAnnotation.static.description=OO.ui.deferMsg('visualeditor-annotationbutton-subscript-tooltip');ve.dm.modelRegistry.register(ve.dm.SubscriptAnnotation);ve.dm.SuperscriptAnnotation=function VeDmSuperscriptAnnotation(){ve.dm.SuperscriptAnnotation.super.apply(this,arguments);};OO.inheritClass(ve.dm.SuperscriptAnnotation,ve.dm.TextStyleAnnotation);ve.dm.SuperscriptAnnotation.static.name='textStyle/superscript';ve.dm.SuperscriptAnnotation.static.matchTagNames=['sup'];ve.dm.SuperscriptAnnotation.static.removes=['textStyle/subscript'];ve.dm.SuperscriptAnnotation.static.description=OO.ui.deferMsg('visualeditor-annotationbutton-superscript-tooltip');ve.dm.modelRegistry.register(ve.dm.SuperscriptAnnotation);ve.dm.UnderlineAnnotation=function VeDmUnderlineAnnotation(){ve.dm.UnderlineAnnotation.super.apply(this,arguments);};OO.inheritClass(ve.dm.UnderlineAnnotation,ve.dm.TextStyleAnnotation);ve.dm.UnderlineAnnotation.
static.name='textStyle/underline';ve.dm.UnderlineAnnotation.static.matchTagNames=['u'];ve.dm.UnderlineAnnotation.static.inferFromView=true;ve.dm.UnderlineAnnotation.static.description=OO.ui.deferMsg('visualeditor-annotationbutton-underline-tooltip');ve.dm.modelRegistry.register(ve.dm.UnderlineAnnotation);ve.dm.UserInputAnnotation=function VeDmUserInputAnnotation(){ve.dm.UserInputAnnotation.super.apply(this,arguments);};OO.inheritClass(ve.dm.UserInputAnnotation,ve.dm.TextStyleAnnotation);ve.dm.UserInputAnnotation.static.name='textStyle/userInput';ve.dm.UserInputAnnotation.static.matchTagNames=['kbd'];ve.dm.modelRegistry.register(ve.dm.UserInputAnnotation);ve.dm.VariableAnnotation=function VeDmVariableAnnotation(){ve.dm.VariableAnnotation.super.apply(this,arguments);};OO.inheritClass(ve.dm.VariableAnnotation,ve.dm.TextStyleAnnotation);ve.dm.VariableAnnotation.static.name='textStyle/variable';ve.dm.VariableAnnotation.static.matchTagNames=['var'];ve.dm.modelRegistry.register(ve.dm.
VariableAnnotation);ve.dm.AlienMetaItem=function VeDmAlienMetaItem(){ve.dm.AlienMetaItem.super.apply(this,arguments);};OO.inheritClass(ve.dm.AlienMetaItem,ve.dm.MetaItem);ve.dm.AlienMetaItem.static.name='alienMeta';ve.dm.AlienMetaItem.static.matchTagNames=['meta','link'];ve.dm.AlienMetaItem.static.allowedRdfaTypes=null;ve.dm.AlienMetaItem.static.preserveHtmlAttributes=false;ve.dm.AlienMetaItem.static.toDomElements=function(dataElement,doc,converter){return ve.copyDomElements(converter.getStore().value(dataElement.originalDomElementsHash)||[],doc);};ve.dm.modelRegistry.register(ve.dm.AlienMetaItem);ve.dm.RemovableAlienMetaItem=function VeDmRemovableAlienMetaItem(){ve.dm.RemovableAlienMetaItem.super.apply(this,arguments);};OO.inheritClass(ve.dm.RemovableAlienMetaItem,ve.dm.AlienMetaItem);ve.dm.RemovableAlienMetaItem.static.name='removableAlienMeta';ve.dm.RemovableAlienMetaItem.static.matchTagNames=[];ve.dm.RemovableAlienMetaItem.static.removable=true;ve.dm.modelRegistry.register(ve.dm.
RemovableAlienMetaItem);ve.dm.CommentMetaItem=function VeDmCommentMetaItem(){ve.dm.CommentMetaItem.super.apply(this,arguments);};OO.inheritClass(ve.dm.CommentMetaItem,ve.dm.MetaItem);ve.dm.CommentMetaItem.static.name='commentMeta';ve.dm.CommentMetaItem.static.matchTagNames=[];ve.dm.CommentMetaItem.static.preserveHtmlAttributes=false;ve.dm.CommentMetaItem.static.toDomElements=function(dataElement,doc){return[doc.createComment(dataElement.attributes.text)];};ve.dm.modelRegistry.register(ve.dm.CommentMetaItem);ve.ce={};ve.ce.minImgDataUri='data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=';ve.ce.getDomText=function(element){var nodeType=element.nodeType,text='';if(nodeType===Node.ELEMENT_NODE||nodeType===Node.DOCUMENT_NODE||nodeType===Node.DOCUMENT_FRAGMENT_NODE){if(element.classList.contains('ve-ce-branchNode-blockSlug')){return'';}else if(element.classList.contains('ve-ce-cursorHolder')){return'';}else if(element.classList.contains('ve-ce-leafNode')){var viewNode=$(element).
data('view');if(viewNode&&element===viewNode.$element[0]){return new Array(viewNode.getOuterLength()+1).join('\u2603');}return'';}else{for(element=element.firstChild;element;element=element.nextSibling){text+=ve.ce.getDomText(element);}}}else if(nodeType===Node.TEXT_NODE){return element.data;}return text;};ve.ce.getDomHash=function(element){var nodeType=element.nodeType,nodeName=element.nodeName,hash='';if(nodeType===Node.TEXT_NODE||nodeType===Node.CDATA_SECTION_NODE){return'#';}else if(nodeType===Node.ELEMENT_NODE||nodeType===Node.DOCUMENT_NODE){if(!(element.classList.contains('ve-ce-branchNode-blockSlug')||element.classList.contains('ve-ce-cursorHolder')||element.classList.contains('ve-ce-nail'))){hash+='<'+nodeName+'>';for(element=element.firstChild;element;element=element.nextSibling){hash+=ve.ce.getDomHash(element);}hash+='</'+nodeName+'>';}hash=hash.replace(/##+/g,'#');}return hash;};ve.ce.nextCursorOffset=function(node){var nextNode,offset;if(node.nextSibling!==null&&node.
nextSibling.nodeType===Node.TEXT_NODE){nextNode=node.nextSibling;offset=0;}else{nextNode=node.parentNode;offset=1+ve.parentIndex(node);}return{node:nextNode,offset:offset};};ve.ce.previousCursorOffset=function(node){var previousNode,offset;if(node.previousSibling!==null&&node.previousSibling.nodeType===Node.TEXT_NODE){previousNode=node.previousSibling;offset=previousNode.data.length;}else{previousNode=node.parentNode;offset=ve.parentIndex(node);}return{node:previousNode,offset:offset};};ve.ce.getOffset=function(domNode,domOffset){if(domNode.nodeType===Node.ELEMENT_NODE&&domNode.classList.contains('ve-ce-unicorn')){if(domOffset!==0){throw new Error('Non-zero offset in unicorn');}return $(domNode).data('modelOffset');}function traverse(n){while(!n.previousSibling){n=n.parentNode;if(!n){throw new Error('domNode has no ancestor with a .data( \'view\' )');}if($(n).data('view')instanceof ve.ce.Node){return n;}}n=n.previousSibling;if($(n).data('view')instanceof ve.ce.Node){return n;}while(n.
lastChild){n=n.lastChild;if($(n).data('view')instanceof ve.ce.Node){return n;}}return n;}var maxOffset;if(domNode.nodeType===Node.ELEMENT_NODE){maxOffset=domNode.childNodes.length;}else{maxOffset=domNode.data.length;}if(domOffset<0||domOffset>maxOffset){throw new Error('domOffset is out of bounds');}var lengthSum=0;var startNode,node,view;if(domNode.nodeType===Node.ELEMENT_NODE){if(domNode.childNodes.length===0){startNode=domNode;view=$(startNode).data('view');if(view instanceof ve.ce.Node){return view.getOffset()+(view.isWrapped()?1:0);}node=startNode;}else if(domOffset===domNode.childNodes.length){startNode=domNode.lastChild;view=$(startNode).data('view');if(view instanceof ve.ce.Node){return view.getOffset()+view.getOuterLength();}while(startNode.lastChild){startNode=startNode.lastChild;view=$(startNode).data('view');if(view instanceof ve.ce.Node){return view.getOffset()+view.getOuterLength();}}node=startNode;}else{startNode=domNode.childNodes[domOffset];node=traverse(startNode);}}
else{if(!(domNode.parentNode.classList.contains('ve-ce-branchNode-blockSlug')||domNode.parentNode.classList.contains('ve-ce-cursorHolder'))){lengthSum+=domOffset;}startNode=domNode;node=traverse(startNode);}while(true){view=$(node).data('view');if(view instanceof ve.ce.Node){break;}if(node.nodeType===Node.TEXT_NODE&&!node.parentNode.classList.contains('ve-ce-branchNode-blockSlug')&&!node.parentNode.classList.contains('ve-ce-cursorHolder')){lengthSum+=node.data.length;}node=traverse(node);}var offset=view.getOffset();if($.contains(node,startNode)){if(!view.getModel().isContent()){offset+=view.getModel().isWrapped()?1:0;}if(view.getModel().canContainContent()){offset+=lengthSum;}}else if(view.parent){offset+=view.getOuterLength();if(view.isContent()){offset+=lengthSum;}}else{throw new Error('Node is not in document');}return offset;};ve.ce.getOffsetOfSlug=function(element){var $element=$(element);var model;if($element.index()===0){model=$element.parent().data('view').getModel();return model
.getOffset()+(model.isWrapped()?1:0);}else{var $prev=$element.prevAll('.ve-ce-leafNode,.ve-ce-branchNode').first();if($prev.length){model=$prev.data('view').getModel();return model.getOffset()+model.getOuterLength();}throw new Error('Incorrect slug location');}};ve.ce.isAfterAnnotationBoundary=function(node,offset){if(node.nodeType===Node.TEXT_NODE){if(offset>0){return false;}offset=ve.parentIndex(node);node=node.parentNode;}if(offset===0){return ve.dm.modelRegistry.isAnnotation(node);}var previousNode=node.childNodes[offset-1];if(previousNode.nodeType===Node.ELEMENT_NODE&&(previousNode.classList.contains('ve-ce-nail-post-close')||previousNode.classList.contains('ve-ce-nail-post-open'))){return true;}return ve.dm.modelRegistry.isAnnotation(previousNode);};ve.ce.isShortcutKey=function(e){return!!(e.ctrlKey||e.metaKey);};ve.ce.veRangeFromSelection=function(selection){try{return new ve.Range(ve.ce.getOffset(selection.anchorNode,selection.anchorOffset),ve.ce.getOffset(selection.focusNode,
selection.focusOffset));}catch(e){return null;}};ve.ce.nailedAnnotationAt=function(node){if(node&&node.nodeType===Node.TEXT_NODE){node=node.parentNode;}return $(node).closest('.ve-ce-nailedAnnotation')[0];};ve.ce.isAnnotationElement=function(element){return!(ve.isBlockElement(element)||ve.isVoidElement(element)||element.classList.contains('ve-ce-branchNode-slug'));};ve.ce.TextStateChunk=function VeCeTextStateChunk(text,elements,type){this.text=text;this.elements=elements;this.type=type;};OO.initClass(ve.ce.TextStateChunk);ve.ce.TextStateChunk.static.compareElements=function(element1,element2){return element1===element2||(element1.nodeName===element2.nodeName&&element1.getAttribute('class')===element2.getAttribute('class')&&element1.getAttribute('typeof')===element2.getAttribute('typeof')&&element1.getAttribute('property')===element2.getAttribute('property')&&element1.getAttribute('href')===element2.getAttribute('href'));};ve.ce.TextStateChunk.prototype.hasEqualElements=function(other){
if(this.elements===other.elements){return true;}if(this.elements.length!==other.elements.length){return false;}for(var i=0,len=this.elements.length;i<len;i++){if(!this.constructor.static.compareElements(this.elements[i],other.elements[i])){return false;}}return true;};ve.ce.TextStateChunk.prototype.isEqual=function(other){return this.text===other.text&&this.type===other.type&&this.hasEqualElements(other);};ve.ce.TextState=function VeCeTextState(element){this.chunks=this.constructor.static.getChunks(element);};OO.initClass(ve.ce.TextState);ve.ce.TextState.static.getChunks=function(element){var elementListStack=[[]],stackTop=0,chunks=[];function add(text,type){if(!chunks.length||chunks[chunks.length-1].elements!==elementListStack[stackTop]||chunks[chunks.length-1].type!==type){chunks.push(new ve.ce.TextStateChunk(text,elementListStack[stackTop],type||'text'));}else{chunks[chunks.length-1].text+=text;}}var view;var annotationStack=[];var node=element;while(true){if(node.nodeType===Node.
TEXT_NODE){add(node.data.replace(/\u00A0/g,' '));}else if(node.nodeType!==Node.ELEMENT_NODE||node.classList.contains('ve-ce-branchNode-blockSlug')||node.classList.contains('ve-ce-cursorHolder')){}else if((view=$(node).data('view'))&&view instanceof ve.ce.LeafNode){if(node===view.$element[0]){add(ve.repeatString('\u2603',view.getOuterLength()));}}else if(node.classList.contains('ve-ce-unicorn')){add('','unicorn');}else if(node.firstChild){if(ve.ce.isAnnotationElement(node)){elementListStack.push(elementListStack[stackTop].concat(node));annotationStack.push(node);stackTop++;}node=node.firstChild;continue;}while(true){if(node===element){break;}if(node===annotationStack[annotationStack.length-1]){annotationStack.pop();elementListStack.pop();stackTop--;}if(node.nextSibling){break;}node=node.parentNode;}if(node===element){break;}node=node.nextSibling;}return chunks;};ve.ce.TextState.prototype.isEqual=function(other){if(other===this){return true;}if(!other||this.chunks.length!==other.chunks.
length){return false;}for(var i=0,len=this.chunks.length;i<len;i++){if(!(this.chunks[i].isEqual(other.chunks[i]))){return false;}}return true;};ve.ce.TextState.prototype.getChangeTransaction=function(prev,modelDoc,modelOffset,unicornAnnotations){function countMissing(newArray,oldArray,equals){var i2,i2Len,j2,j2Len,count=0;for(i2=0,i2Len=newArray.length;i2<i2Len;i2++){for(j2=0,j2Len=oldArray.length;j2<j2Len;j2++){if(equals(newArray[i2],oldArray[j2])){break;}}if(j2===j2Len){count++;}}return count;}var oldChunks=prev.chunks,newChunks=this.chunks,modelData=modelDoc.data,newData=[];var change=ve.countEdgeMatches(oldChunks,newChunks,function(a,b){return a.isEqual(b);});if(change===null){return null;}var i,iLen;var oldChunk,newChunk;var textStart=0;var textEnd=0;if(change.start+change.end<Math.min(oldChunks.length,newChunks.length)){if(oldChunks[change.start].hasEqualElements(newChunks[change.start])){oldChunk=oldChunks[change.start];newChunk=newChunks[change.start];iLen=Math.min(oldChunk.
text.length,newChunk.text.length);for(i=0;i<iLen;i++){if(oldChunk.text[i]!==newChunk.text[i]){break;}}textStart=i;}if(oldChunks[oldChunks.length-1-change.end].hasEqualElements(newChunks[newChunks.length-1-change.end])){oldChunk=oldChunks[oldChunks.length-1-change.end];newChunk=newChunks[newChunks.length-1-change.end];iLen=Math.min(oldChunk.text.length-(change.start+change.end===oldChunks.length-1?textStart:0),newChunk.text.length-(change.start+change.end===newChunks.length-1?textStart:0));for(i=0;i<iLen;i++){if(newChunk.text[newChunk.text.length-1-i]!==oldChunk.text[oldChunk.text.length-1-i]){break;}}textEnd=i;}}var changeOffset=modelOffset+1;for(i=0,iLen=change.start;i<iLen;i++){changeOffset+=oldChunks[i].text.length;}var removed=0;for(i=change.start,iLen=oldChunks.length-change.end;i<iLen;i++){removed+=oldChunks[i].text.length;}var removeRange=new ve.Range(changeOffset+textStart,changeOffset+removed-textEnd);var j,jLen;for(i=change.start,iLen=newChunks.length-change.end;i<iLen;i++){
newChunk=newChunks[i];if(newChunk.type==='unicorn'){continue;}var data=newChunk.text.split('');if(i===change.start){data=data.slice(textStart);}if(i===iLen-1){data=data.slice(0,data.length-textEnd);}if(data.length===0){continue;}var annotations=null;var missing=null;var jStart;var matchStartOffset;if(change.start===0){jStart=0;matchStartOffset=changeOffset;}else{jStart=change.start-1;matchStartOffset=changeOffset-oldChunks[jStart].text.length;}var jEnd;if(change.end===0){jEnd=oldChunks.length;}else{jEnd=oldChunks.length-change.end+1;}var matchOffset=matchStartOffset;for(j=jStart;j<jEnd;j++){oldChunk=oldChunks[j];if(!oldChunk.hasEqualElements(newChunk)){matchOffset+=oldChunk.text.length;continue;}if(oldChunk.type==='unicorn'){if(!unicornAnnotations){throw new Error('No unicorn annotations');}annotations=unicornAnnotations;break;}annotations=modelData.getInsertionAnnotationsFromRange(new ve.Range(matchOffset),true);break;}if(annotations===null){var leastMissing=newChunk.elements.length;
var bestOffset=null;matchOffset=matchStartOffset;for(j=jStart;j<jEnd;j++){oldChunk=oldChunks[j];missing=countMissing(newChunk.elements,oldChunk.elements,ve.ce.TextStateChunk.static.compareElements);if(missing<leastMissing){leastMissing=missing;bestOffset=matchOffset;if(missing===0){break;}}matchOffset+=oldChunk.text.length;}var oldAnnotations;if(bestOffset===null){oldAnnotations=new ve.dm.AnnotationSet(modelData.getStore());}else{oldAnnotations=modelData.getInsertionAnnotationsFromRange(new ve.Range(bestOffset),true);}annotations=new ve.dm.AnnotationSet(modelData.getStore());for(j=0,jLen=newChunk.elements.length;j<jLen;j++){var element=newChunk.elements[j];var view=$(element).data('view');var ann;if(view){ann=view.getModel();}else{var modelClass=ve.dm.modelRegistry.lookup(ve.dm.modelRegistry.matchElement(element));if(!(modelClass&&modelClass.prototype instanceof ve.dm.Annotation)){continue;}ann=ve.dm.annotationFactory.createFromElement(modelClass.static.toDataElement([element],ve.dm.
converter));var oldAnn=oldAnnotations.getComparable(ann);if(oldAnn){ann=oldAnn;}else if(!ann.constructor.static.inferFromView){continue;}}annotations.add(ann,annotations.getLength());}}ve.dm.Document.static.addAnnotationsToData(data,annotations);ve.batchPush(newData,data);}return ve.dm.TransactionBuilder.static.newFromReplacement(modelDoc,removeRange,newData);};ve.ce.RangeState=function VeCeRangeState(old,root,selectionOnly){this.branchNodeChanged=false;this.selectionChanged=false;this.contentChanged=false;this.veRange=null;this.node=null;this.text=null;this.hash=null;this.textState=null;this.focusIsAfterAnnotationBoundary=null;this.misleadingSelection=null;this.saveState(old,root,selectionOnly);};OO.initClass(ve.ce.RangeState);ve.ce.RangeState.prototype.saveState=function(old,root,selectionOnly){var oldSelection=old?old.misleadingSelection:ve.SelectionState.static.newNullSelection(),nativeSelection=root.getElementDocument().getSelection();var selection;if(nativeSelection.rangeCount&&
OO.ui.contains(root.$element[0],nativeSelection.focusNode,true)){selection=new ve.SelectionState(nativeSelection);}else{selection=ve.SelectionState.static.newNullSelection();}if(selection.equalsSelection(oldSelection)){this.selectionChanged=false;this.veRange=old&&old.veRange;}else{this.selectionChanged=true;this.veRange=ve.ce.veRangeFromSelection(selection);}var focusNodeChanged=oldSelection.focusNode!==selection.focusNode;if(!focusNodeChanged){this.node=old&&old.node;}else{var $node=$(selection.focusNode).closest('.ve-ce-branchNode');if($node.length===0){this.node=null;}else{this.node=$node.data('view');if(this.node&&this.node.root!==root.root){this.node=null;this.veRange=null;}}}this.branchNodeChanged=(old&&old.node)!==this.node;if(!this.node){this.text=null;this.hash=null;this.textState=null;}else if(selectionOnly&&!focusNodeChanged){this.text=old.text;this.hash=old.hash;this.textState=old.textState;}else{this.text=ve.ce.getDomText(this.node.$element[0]);this.hash=ve.ce.getDomHash(
this.node.$element[0]);this.textState=new ve.ce.TextState(this.node.$element[0]);}this.contentChanged=!selectionOnly&&!this.branchNodeChanged&&((old&&old.hash)!==this.hash||(old&&old.text)!==this.text||(!this.textState&&old&&old.textState)||(!!this.textState&&!this.textState.isEqual(old&&old.textState)));if(old&&!this.selectionChanged&&!this.contentChanged){this.focusIsAfterAnnotationBoundary=old.focusIsAfterAnnotationBoundary;}else{this.focusIsAfterAnnotationBoundary=selection.focusNode&&ve.ce.isAfterAnnotationBoundary(selection.focusNode,selection.focusOffset);}this.misleadingSelection=selection;};ve.ce.AnnotationFactory=function VeCeAnnotationFactory(){OO.Factory.call(this);};OO.inheritClass(ve.ce.AnnotationFactory,OO.Factory);ve.ce.AnnotationFactory.prototype.getDescription=function(annotation){var type=annotation.constructor.static.name;if(Object.prototype.hasOwnProperty.call(this.registry,type)){return this.registry[type].static.getDescription(annotation);}throw new Error(
'Unknown annotation type: '+type);};ve.ce.AnnotationFactory.prototype.canAnnotationBeActive=function(type){if(Object.prototype.hasOwnProperty.call(this.registry,type)){return this.registry[type].static.canBeActive;}throw new Error('Unknown annotation type: '+type);};ve.ce.annotationFactory=new ve.ce.AnnotationFactory();ve.ce.NodeFactory=function VeCeNodeFactory(){OO.Factory.call(this);};OO.inheritClass(ve.ce.NodeFactory,OO.Factory);ve.ce.NodeFactory.prototype.getDescription=function(node){var type=node.constructor.static.name;if(Object.prototype.hasOwnProperty.call(this.registry,type)){return this.registry[type].static.getDescription(node);}throw new Error('Unknown node type: '+type);};ve.ce.NodeFactory.prototype.splitNodeOnEnter=function(type){if(Object.prototype.hasOwnProperty.call(this.registry,type)){return this.registry[type].static.splitOnEnter;}throw new Error('Unknown node type: '+type);};ve.ce.NodeFactory.prototype.createFromModel=function(model){var type=model.getType();if(ve
.dm.nodeFactory.isMetaData(type)){type='meta';}return this.create(type,model);};ve.ce.nodeFactory=new ve.ce.NodeFactory();ve.ce.Document=function VeCeDocument(model,surface){ve.ce.Document.super.call(this,new ve.ce.DocumentNode(model.getDocumentNode(),surface));this.lang=null;this.dir=null;this.setLang(model.getLang());this.setDir(model.getDir());this.model=model;};OO.inheritClass(ve.ce.Document,ve.Document);ve.ce.Document.prototype.setLang=function(lang){this.getDocumentNode().$element.prop('lang',lang);this.lang=lang;this.emit('langChange');};ve.ce.Document.prototype.setDir=function(dir){this.getDocumentNode().$element.prop('dir',dir);this.dir=dir;this.emit('langChange');};ve.ce.Document.prototype.getLang=function(){return this.lang;};ve.ce.Document.prototype.getDir=function(){return this.dir;};ve.ce.Document.prototype.getSlugAtOffset=function(offset){var node=this.getBranchNodeFromOffset(offset);return node?node.getSlugAtOffset(offset):null;};ve.ce.Document.prototype.
getNodeAndOffset=function(offset){var countedNodes=[];if(!this.model.getDocumentRange().containsRange(new ve.Range(offset))){throw new Error('Offset is out of bounds');}var branchNode=this.getBranchNodeFromOffset(offset);var count=branchNode.getOffset()+(branchNode.isWrapped()?1:0);var node;if(!(branchNode instanceof ve.ce.ContentBranchNode)){var i,ceChild;for(i=0;;i++){ceChild=branchNode.children[i];if(count===offset){break;}if(!ceChild){throw new Error('Offset lies beyond branchNode');}count+=ceChild.getOuterLength();if(count>offset){if(ceChild.getOuterLength()!==2){throw new Error('Offset lies inside child of strange size');}node=ceChild.$element[0];if(node){return{node:node,offset:0};}break;}}node=branchNode.$element[0];while(ceChild&&!ceChild.$element[0]){i++;ceChild=branchNode.children[i];}if(!ceChild||!ceChild.$element[0]){return{node:node,offset:node.childNodes.length};}return{node:node,offset:Array.prototype.indexOf.call(node.childNodes,ceChild.$element[0])};}var position={
node:branchNode.$element[0],offset:0};function noDescend(){return this.classList.contains('ve-ce-branchNode-blockSlug')||ve.rejectsCursor(this);}while(true){if(count===offset){break;}position=ve.adjacentDomPosition(position,1,{noDescend:noDescend,stop:function(){return true;}});var step=position.steps[0];node=step.node;if(node.nodeType===Node.TEXT_NODE){if(step.type==='leave'){continue;}if(offset<=count+node.data.length){position={node:node,offset:offset-count};break;}else{count+=node.data.length;position={node:node,offset:node.data.length};continue;}}if(!(node.classList.contains('ve-ce-branchNode')||node.classList.contains('ve-ce-leafNode'))){continue;}if(step.type==='leave'){count++;continue;}var model=$.data(node,'view').model;if(countedNodes.indexOf(model)!==-1){position={node:node.parentNode,offset:ve.parentIndex(node)+1};continue;}countedNodes.push(model);if(offset>=count+model.getOuterLength()){position={node:node.parentNode,offset:ve.parentIndex(node)+1};count+=model.
getOuterLength();}else if(step.type==='cross'){if(offset===count+1){position={node:node,offset:0};break;}count+=2;}else{count+=1;}}var prevNode=position.node.childNodes[position.offset-1];if(prevNode&&prevNode.nodeType===Node.ELEMENT_NODE&&(prevNode.classList.contains('ve-ce-branchNode')||prevNode.classList.contains('ve-ce-leafNode'))){var $viewNodes=$.data(prevNode,'view').$element;if($viewNodes.length>1){position.node=$viewNodes.get(-1).parentNode;position.offset=1+ve.parentIndex($viewNodes.get(-1));}}var found={};function stop(s){var m;if(s.node.nodeType===Node.TEXT_NODE){return s.type==='internal';}if(s.node.classList.contains('ve-ce-branchNode')||s.node.classList.contains('ve-ce-leafNode')){m=$.data(s.node,'view').model;if(countedNodes.indexOf(m)!==-1){return false;}countedNodes.push(m);return true;}return false;}var steps=ve.adjacentDomPosition(position,1,{stop:stop,noDescend:noDescend}).steps;steps.slice(0,-1).forEach(function(s){var hasClass=function(className){return s.node.
nodeType===Node.ELEMENT_NODE&&s.node.classList.contains(className);};found.preUnicorn=found.preUnicorn||(hasClass('ve-ce-pre-unicorn')&&s);found.postUnicorn=found.postUnicorn||(hasClass('ve-ce-post-unicorn')&&s);found.preOpenNail=found.preOpenNail||(hasClass('ve-ce-nail-pre-open')&&s);found.postOpenNail=found.postOpenNail||(hasClass('ve-ce-nail-post-open')&&s);found.preCloseNail=found.preCloseNail||(hasClass('ve-ce-nail-pre-close')&&s);found.postCloseNail=found.postCloseNail||(hasClass('ve-ce-nail-post-close')&&s);found.focusableNode=found.focusableNode||(hasClass('ve-ce-focusableNode')&&s);found.text=found.text||(s.node.nodeType===Node.TEXT_NODE&&s);});if(found.preUnicorn){return ve.ce.nextCursorOffset(found.preUnicorn.node);}if(found.postUnicorn){return ve.ce.previousCursorOffset(found.postUnicorn.node);}if(found.preOpenNail){return ve.ce.previousCursorOffset(found.preOpenNail.node);}if(found.postCloseNail){return ve.ce.nextCursorOffset(found.postCloseNail.node);}if(found.text){if(
position.node.nodeType===Node.TEXT_NODE){return position;}return{node:found.text.node,offset:0};}return position;};ve.ce.Document.prototype.getDirectionalityFromRange=function(range){var selectedNodes=this.selectNodes(range,'covered');var effectiveNode;if(selectedNodes.length>1){effectiveNode=this.selectNodes(range,'siblings')[0].node.getParent();}else{effectiveNode=selectedNodes[0].node;while(effectiveNode.isContent()){effectiveNode=effectiveNode.parent;}}return effectiveNode.$element.css('direction');};ve.ce.View=function VeCeView(model,config){this.model=model;ve.ce.View.super.call(this,config);OO.EventEmitter.call(this);this.live=false;this.connect(this,{setup:'onSetup',teardown:'onTeardown'});this.initialize();};OO.inheritClass(ve.ce.View,OO.ui.Element);OO.mixinClass(ve.ce.View,OO.EventEmitter);ve.ce.View.static.renderHtmlAttributes=function(attribute){var attributes=['abbr','about','align','alt','axis','bgcolor','border','cellpadding','cellspacing','char','charoff','cite','class'
,'clear','color','colspan','datatype','datetime','dir','face','frame','headers','height','href','id','itemid','itemprop','itemref','itemscope','itemtype','lang','noshade','nowrap','property','rbspan','rel','resource','rev','rowspan','rules','scope','size','span','src','start','style','summary','title','type','typeof','valign','value','width'];return attributes.indexOf(attribute)!==-1;};ve.ce.View.prototype.getModelHtmlDocument=function(){return null;};ve.ce.View.prototype.initialize=function(){if(this.model.element&&this.model.element.originalDomElementsHash!==undefined){ve.dm.Converter.static.renderHtmlAttributeList(this.model.getOriginalDomElements(this.model.getStore()),this.$element,this.constructor.static.renderHtmlAttributes,true,!(this.model instanceof ve.dm.Node)||!this.model.canHaveChildren()||this.model.handlesOwnChildren());}};ve.ce.View.prototype.onSetup=function(){this.$element.data('view',this);};ve.ce.View.prototype.onTeardown=function(){this.$element.removeData('view');
};ve.ce.View.prototype.getModel=function(){return this.model;};ve.ce.View.prototype.isLive=function(){return this.live;};ve.ce.View.prototype.setLive=function(live){this.live=live;if(this.live){this.emit('setup');}else{this.emit('teardown');}};ve.ce.View.prototype.getResolvedAttribute=function(key){var plainValue=this.model.getAttribute(key),doc=this.getModelHtmlDocument();return doc&&typeof plainValue==='string'?ve.resolveUrl(plainValue,doc):plainValue;};ve.ce.View.prototype.destroy=function(){this.disconnect(this);this.model.disconnect(this);this.model=null;};ve.ce.Annotation=function VeCeAnnotation(model,parentNode,config){ve.ce.Annotation.super.call(this,model,config);this.parentNode=parentNode||null;this.$element.data('view',this).addClass('ve-ce-annotation');};OO.inheritClass(ve.ce.Annotation,ve.ce.View);ve.ce.Annotation.static.tagName='span';ve.ce.Annotation.static.canBeActive=false;ve.ce.Annotation.static.getDescription=function(){return'';};ve.ce.Annotation.prototype.
getParentNode=function(){return this.parentNode;};ve.ce.Annotation.prototype.getModelHtmlDocument=function(){return this.parentNode&&this.parentNode.getModelHtmlDocument();};ve.ce.Annotation.prototype.appendChild=function(childNode){this.$element[0].appendChild(childNode);};ve.ce.Annotation.prototype.getContentContainer=function(){return this.$element[0];};ve.ce.Annotation.prototype.attachContents=function(){};ve.ce.Annotation.prototype.appendTo=function(node){node.appendChild(this.$element[0]);};ve.ce.Annotation.prototype.canBeActive=function(){return this.constructor.static.canBeActive;};ve.ce.Annotation.prototype.destroy=function(){this.parentNode=null;ve.ce.Annotation.super.prototype.destroy.call(this);};ve.ce.Node=function VeCeNode(){ve.ce.Node.super.apply(this,arguments);ve.Node.call(this);};OO.inheritClass(ve.ce.Node,ve.ce.View);OO.mixinClass(ve.ce.Node,ve.Node);ve.ce.Node.static.splitOnEnter=false;ve.ce.Node.static.removeEmptyLastChildOnEnter=false;ve.ce.Node.static.isMultiline
=null;ve.ce.Node.static.autoFocus=true;ve.ce.Node.static.trapsCursor=false;ve.ce.Node.static.getDescription=function(){return'';};ve.ce.Node.prototype.getChildNodeTypes=function(){return this.model.getChildNodeTypes();};ve.ce.Node.prototype.getParentNodeTypes=function(){return this.model.getParentNodeTypes();};ve.ce.Node.prototype.getSuggestedParentNodeTypes=function(){return this.model.getSuggestedParentNodeTypes();};ve.ce.Node.prototype.canHaveChildren=function(){return this.model.canHaveChildren();};ve.ce.Node.prototype.canHaveChildrenNotContent=function(){return this.model.canHaveChildrenNotContent();};ve.ce.Node.prototype.isInternal=function(){return this.model.isInternal();};ve.ce.Node.prototype.isMetaData=function(){return this.model.isMetaData();};ve.ce.Node.prototype.isWrapped=function(){return this.model.isWrapped();};ve.ce.Node.prototype.isUnwrappable=function(){return this.model.isUnwrappable();};ve.ce.Node.prototype.canContainContent=function(){return this.model.
canContainContent();};ve.ce.Node.prototype.isContent=function(){return this.model.isContent();};ve.ce.Node.prototype.isFocusable=function(){return this.model.isFocusable();};ve.ce.Node.prototype.isAlignable=function(){return this.model.isAlignable();};ve.ce.Node.prototype.isCellable=function(){return this.model.isCellable();};ve.ce.Node.prototype.isCellEditable=function(){return this.model.isCellEditable();};ve.ce.Node.prototype.hasSignificantWhitespace=function(){return this.model.hasSignificantWhitespace();};ve.ce.Node.prototype.handlesOwnChildren=function(){return this.model.handlesOwnChildren();};ve.ce.Node.prototype.shouldIgnoreChildren=function(){return this.model.shouldIgnoreChildren();};ve.ce.Node.prototype.getLength=function(){return this.model.getLength();};ve.ce.Node.prototype.getOuterLength=function(){return this.model.getOuterLength();};ve.ce.Node.prototype.getOffset=function(){return this.model.getOffset();};ve.ce.Node.prototype.splitOnEnter=function(){return this.
constructor.static.splitOnEnter;};ve.ce.Node.prototype.removeEmptyLastChildOnEnter=function(){return this.constructor.static.removeEmptyLastChildOnEnter;};ve.ce.Node.prototype.isMultiline=function(){var booleanNode=this.traverseUpstream(function(node){return node.constructor.static.isMultiline===null;});if(booleanNode){return booleanNode.constructor.static.isMultiline;}else{return!this.root||this.getRoot().getSurface().getSurface().isMultiline();}};ve.ce.Node.prototype.autoFocus=function(){return this.constructor.static.autoFocus;};ve.ce.Node.prototype.trapsCursor=function(){return this.constructor.static.trapsCursor;};ve.ce.Node.prototype.destroy=function(){this.parent=null;this.root=null;this.doc=null;ve.ce.Node.super.prototype.destroy.call(this);};ve.ce.Node.prototype.getModelHtmlDocument=function(){return this.model.getDocument()&&this.model.getDocument().getHtmlDocument();};ve.ce.BranchNode=function VeCeBranchNode(model){ve.BranchNode.call(this);ve.ce.BranchNode.super.apply(this,
arguments);this.tagName=this.$element.get(0).nodeName.toLowerCase();this.slugNodes=[];this.model.connect(this,{splice:'onSplice'});this.onSplice.apply(this,[0,0].concat(model.getChildren()));};OO.inheritClass(ve.ce.BranchNode,ve.ce.Node);OO.mixinClass(ve.ce.BranchNode,ve.BranchNode);ve.ce.BranchNode.inlineSlugTemplate=(function(){var profile=$.client.profile(),$img=$('<img>').attr({role:'none',alt:''}).addClass('ve-ce-chimera ve-ce-chimera-'+profile.layout),$span=$('<span>').addClass('ve-ce-branchNode-slug ve-ce-branchNode-inlineSlug').append($img);if(profile.layout==='gecko'){$img.prop('src',ve.ce.minImgDataUri);}return $span.get(0);}());ve.ce.BranchNode.inputDebugInlineSlugTemplate=$('<span>').addClass('ve-ce-branchNode-slug ve-ce-branchNode-inlineSlug').append($('<img>').addClass('ve-ce-chimera ve-ce-chimera-debug').attr({src:ve.ce.chimeraImgDataUri,role:'none',alt:''})).get(0);ve.ce.BranchNode.blockSlugTemplate=$('<div>').addClass('ve-ce-branchNode-slug ve-ce-branchNode-blockSlug')
.get(0);ve.ce.BranchNode.prototype.initialize=function(){ve.ce.BranchNode.super.prototype.initialize.call(this);this.$element.addClass('ve-ce-branchNode');};ve.ce.BranchNode.prototype.updateTagName=function(){var tagName=this.getTagName();if(tagName!==this.tagName){this.emit('teardown');var wrapper=document.createElement(tagName);wrapper.className=this.$element[0].className;wrapper.contentEditable=this.$element[0].contentEditable;while(this.$element[0].firstChild){wrapper.appendChild(this.$element[0].firstChild);}if(this.$element[0].parentNode){this.$element[0].parentNode.replaceChild(wrapper,this.$element[0]);}this.$element=$(wrapper);this.tagName=tagName;this.initialize();this.emit('setup');if(this.root instanceof ve.ce.DocumentNode){this.root.getSurface().setContentBranchNodeChanged();}}};ve.ce.BranchNode.prototype.onModelUpdate=function(transaction){this.emit('childUpdate',transaction);};ve.ce.BranchNode.prototype.onSplice=function(index){var dmDoc=this.getModel().getDocument(),
attachedRoot=dmDoc&&dmDoc.attachedRoot,isAllAttached=!attachedRoot||attachedRoot instanceof ve.dm.DocumentNode;var inAttachedRoot,upstreamOfAttachedRoot;if(!isAllAttached){inAttachedRoot=this.getModel().isDownstreamOf(attachedRoot);upstreamOfAttachedRoot=attachedRoot.collectUpstream();}var i,length;var args=[];for(i=0,length=arguments.length;i<length;i++){args.push(arguments[i]);}if(args.length>=3){for(i=2,length=args.length;i<length;i++){if(isAllAttached||inAttachedRoot||upstreamOfAttachedRoot.indexOf(args[i])!==-1||args[i].findParent(ve.dm.InternalItemNode)){args[i]=ve.ce.nodeFactory.createFromModel(args[i]);args[i].model.connect(this,{update:'onModelUpdate'});}else{args[i]=new ve.ce.UnrenderedNode(args[i]);}}}var removals=this.children.splice.apply(this.children,args);for(i=0,length=removals.length;i<length;i++){removals[i].model.disconnect(this,{update:'onModelUpdate'});removals[i].model.disconnect(removals[i]);removals[i].setLive(false);removals[i].detach();removals[i].$element.
detach();removals[i].destroy();}if(args.length>=3){var fragment=document.createDocumentFragment();for(i=args.length-1;i>=2;i--){args[i].attach(this);for(var j=args[i].$element.length-1;j>=0;j--){fragment.insertBefore(args[i].$element[j],fragment.childNodes[0]||null);}}if(fragment.childNodes.length){var position=this.getDomPosition(index);position.node.insertBefore(fragment,position.node.children[position.offset]||null);}for(i=args.length-1;i>=2;i--){if(this.live!==args[i].isLive()){args[i].setLive(this.live);}}}this.setupBlockSlugs();this.setupInlineSlugs();};ve.ce.BranchNode.prototype.setupBlockSlugs=function(){if(this.canHaveChildrenNotContent()){this.setupSlugs(true);}};ve.ce.BranchNode.prototype.setupInlineSlugs=function(){if(!this.canHaveChildrenNotContent()){this.setupSlugs(false);}};ve.ce.BranchNode.prototype.removeSlugs=function(){for(var i in this.slugNodes){if(this.slugNodes[i]!==undefined&&this.slugNodes[i].parentNode){this.slugNodes[i].parentNode.removeChild(this.slugNodes[
i]);}delete this.slugNodes[i];}};ve.ce.BranchNode.prototype.setupSlugs=function(isBlock){if(this.getModel().getDocument()&&this.getModel().getDocument().sourceMode&&isBlock){return;}var doc=this.getElementDocument();this.removeSlugs();var slugTemplate;if(isBlock){slugTemplate=ve.ce.BranchNode.blockSlugTemplate;}else if(ve.inputDebug){slugTemplate=ve.ce.BranchNode.inputDebugInlineSlugTemplate;}else{slugTemplate=ve.ce.BranchNode.inlineSlugTemplate;}for(var i in this.getModel().slugPositions){var slugNode=doc.importNode(slugTemplate,true);if(this.children[i]&&this.children[i].$element[0]){var child=this.children[i].$element[0];child.parentNode.insertBefore(slugNode,child);}else{this.$element[0].appendChild(slugNode);}this.slugNodes[i]=slugNode;if(isBlock){var slugButton=new ve.ui.NoFocusButtonWidget({tabIndex:-1,label:ve.msg('visualeditor-slug-insert'),icon:'add',framed:false}).on('click',this.onSlugClick.bind(this,slugNode));$(slugNode).append(slugButton.$element);}}};ve.ce.BranchNode.
prototype.onSlugClick=function(slugNode){this.getRoot().getSurface().createSlug(slugNode);};ve.ce.BranchNode.prototype.getSlugAtOffset=function(offset){var startOffset=this.model.getOffset()+(this.isWrapped()?1:0);if(offset===startOffset){return this.slugNodes[0]||null;}for(var i=0;i<this.children.length;i++){startOffset+=this.children[i].model.getOuterLength();if(offset===startOffset){return this.slugNodes[i+1]||null;}}return null;};ve.ce.BranchNode.prototype.setLive=function(live){ve.ce.BranchNode.super.prototype.setLive.apply(this,arguments);for(var i=0;i<this.children.length;i++){this.children[i].setLive(live);}};ve.ce.BranchNode.prototype.destroy=function(){for(var i=0,len=this.children.length;i<len;i++){this.children[i].destroy();}ve.ce.BranchNode.super.prototype.destroy.call(this);};ve.ce.BranchNode.prototype.detach=function(){for(var i=0,len=this.children.length;i<len;i++){this.children[i].detach();}ve.ce.BranchNode.super.prototype.detach.call(this);};ve.ce.BranchNode.prototype
.getDomPosition=function(offset){var domNode=this.$element.last()[0];var ceNode;var i=offset-1;while(true){ceNode=this.children[i--];if(!ceNode){return{node:domNode,offset:0};}if(ceNode.$element&&ceNode.$element.length>0){return{node:domNode,offset:Array.prototype.indexOf.call(domNode.childNodes,ceNode.$element.last()[0])+1};}if(ceNode.getType()==='text'){break;}}i=offset;while(true){ceNode=this.children[i++];if(!ceNode){return{node:domNode,offset:domNode.childNodes.length};}if(ceNode.$element&&ceNode.$element.length>0){return{node:domNode,offset:Array.prototype.indexOf.call(domNode.childNodes,ceNode.$element.first()[0])};}if(ceNode.getType()==='text'){break;}}throw new Error('Cannot calculate DOM position: adjacent text nodes');};ve.ce.ContentBranchNode=function VeCeContentBranchNode(){this.lastTransaction=null;this.rendered=false;this.unicornAnnotations=null;this.unicorns=null;ve.ce.ContentBranchNode.super.apply(this,arguments);this.onClickHandler=this.onClick.bind(this);this.connect
(this,{childUpdate:'onChildUpdate'});this.model.connect(this,{detach:'onModelDetach'});this.$element.on('click',this.onClickHandler);};OO.inheritClass(ve.ce.ContentBranchNode,ve.ce.BranchNode);ve.ce.ContentBranchNode.static.splitOnEnter=true;ve.ce.ContentBranchNode.static.autoFocus=true;ve.ce.ContentBranchNode.static.appendRenderedContents=function(container,wrapper){function resolveOriginals(domElement){for(var i=0,len=domElement.childNodes.length;i<len;i++){var child=domElement.childNodes[i];if(child.veOrigNode){domElement.replaceChild(child.veOrigNode,child);}else if(child.childNodes&&child.childNodes.length){resolveOriginals(child);}}}resolveOriginals(wrapper);while(wrapper.firstChild){container.appendChild(wrapper.firstChild);}};ve.ce.ContentBranchNode.prototype.initialize=function(){ve.ce.ContentBranchNode.super.prototype.initialize.call(this);this.$element.addClass('ve-ce-contentBranchNode');};ve.ce.ContentBranchNode.prototype.onSetup=function(){ve.ce.ContentBranchNode.super.
prototype.onSetup.apply(this,arguments);this.$element.addClass('ve-ce-contentBranchNode');};ve.ce.ContentBranchNode.prototype.onClick=function(e){if((e.target!==this.$element[0]&&e.target.nodeName.toUpperCase()==='A')&&(!e.altKey&&!e.ctrlKey&&!e.metaKey&&!e.shiftKey)){e.preventDefault();}};ve.ce.ContentBranchNode.prototype.onChildUpdate=function(transaction){if(transaction===null||transaction===this.lastTransaction){this.lastTransaction=transaction;return;}this.renderContents();};ve.ce.ContentBranchNode.prototype.onSplice=function(index,howmany){ve.ce.ContentBranchNode.super.prototype.onSplice.apply(this,arguments);if(this.root instanceof ve.ce.DocumentNode&&this.root.getSurface().isRenderingLocked){this.slugNodes.splice.apply(this.slugNodes,[index,howmany].concat(new Array(arguments.length-2)));}this.renderContents();};ve.ce.ContentBranchNode.prototype.setupBlockSlugs=function(){if(this.root instanceof ve.ce.DocumentNode&&this.root.getSurface().isRenderingLocked()){return;}ve.ce.
ContentBranchNode.super.prototype.setupBlockSlugs.apply(this,arguments);};ve.ce.ContentBranchNode.prototype.setupInlineSlugs=function(){if(this.root instanceof ve.ce.DocumentNode&&this.root.getSurface().isRenderingLocked()){return;}ve.ce.ContentBranchNode.super.prototype.setupInlineSlugs.apply(this,arguments);};ve.ce.ContentBranchNode.prototype.getRenderedContents=function(){var annotationsChanged,store=this.model.doc.getStore(),annotationSet=new ve.dm.AnnotationSet(store),annotatedHtml=[],doc=this.getElementDocument(),wrapper=doc.createElement('div'),current=wrapper,annotationStack=[],nodeStack=[],unicornInfo={hasCursor:false,annotations:null,unicorns:null},buffer='',node=this;if(this.getModel().getDocument().sourceMode){wrapper.appendChild(document.createTextNode(this.getModel().getDocument().getDataFromNode(this.getModel()).join('')));wrapper.unicornInfo=unicornInfo;return wrapper;}function openAnnotation(annotation){var ann;annotationsChanged=true;if(buffer!==''){if(current.
nodeType===Node.TEXT_NODE){current.textContent+=buffer;}else{current.appendChild(doc.createTextNode(buffer));}buffer='';}annotation.store=store;ann=ve.ce.annotationFactory.create(annotation.getType(),annotation,node);ann.appendTo(current);annotationStack.push(ann);nodeStack.push(current);current=ann.getContentContainer();}function closeAnnotation(){var ann;annotationsChanged=true;if(buffer!==''){if(current.nodeType===Node.TEXT_NODE){current.textContent+=buffer;}else{current.appendChild(doc.createTextNode(buffer));}buffer='';}ann=annotationStack.pop();ann.attachContents();current=nodeStack.pop();}var i,ilen;for(i=0,ilen=this.children.length;i<ilen;i++){annotatedHtml=annotatedHtml.concat(this.children[i].getAnnotatedHtml());}var relCursor=-1;var dmSurface;if(this.getRoot()){var ceSurface=this.getRoot().getSurface();dmSurface=ceSurface.getModel();var dmSelection=dmSurface.getTranslatedSelection();if(dmSelection instanceof ve.dm.LinearSelection&&dmSelection.isCollapsed()){relCursor=
dmSelection.getRange().start-this.getOffset()-1;}}var unicorn;if(relCursor<0||relCursor>this.getLength()){unicornInfo.hasCursor=false;}else{unicornInfo.hasCursor=true;var offset=0;for(i=0,ilen=annotatedHtml.length;i<ilen;i++){var htmlItem=annotatedHtml[i][0];var childLength=(typeof htmlItem==='string')?1:2;if(offset<=relCursor&&relCursor<offset+childLength){unicorn=[{},dmSurface.getInsertionAnnotations().storeHashes];annotatedHtml.splice(i,0,unicorn);break;}offset+=childLength;}if(i===ilen&&offset===relCursor){unicorn=[{},dmSurface.getInsertionAnnotations().storeHashes];annotatedHtml.push(unicorn);}}for(i=0,ilen=annotatedHtml.length;i<ilen;i++){var item;var itemAnnotations;if(Array.isArray(annotatedHtml[i])){item=annotatedHtml[i][0];itemAnnotations=new ve.dm.AnnotationSet(store,annotatedHtml[i][1]);}else{item=annotatedHtml[i];itemAnnotations=new ve.dm.AnnotationSet(store);}annotationsChanged=false;ve.dm.Converter.static.openAndCloseAnnotations(annotationSet,itemAnnotations,
openAnnotation,closeAnnotation);if(typeof item==='string'){buffer+=item;}else if(unicorn&&item===unicorn[0]){if(annotationsChanged){if(buffer!==''){current.appendChild(doc.createTextNode(buffer));buffer='';}var preUnicorn=doc.createElement('img');var postUnicorn=doc.createElement('img');preUnicorn.className='ve-ce-unicorn ve-ce-pre-unicorn';postUnicorn.className='ve-ce-unicorn ve-ce-post-unicorn';$(preUnicorn).data('modelOffset',(this.getOffset()+1+i));$(postUnicorn).data('modelOffset',(this.getOffset()+1+i));if(ve.inputDebug){preUnicorn.setAttribute('src',ve.ce.unicornImgDataUri);postUnicorn.setAttribute('src',ve.ce.unicornImgDataUri);preUnicorn.className+=' ve-ce-unicorn-debug';postUnicorn.className+=' ve-ce-unicorn-debug';}else{preUnicorn.setAttribute('src',ve.ce.minImgDataUri);postUnicorn.setAttribute('src',ve.ce.minImgDataUri);}current.appendChild(preUnicorn);current.appendChild(postUnicorn);unicornInfo.annotations=dmSurface.getInsertionAnnotations();unicornInfo.unicorns=[
preUnicorn,postUnicorn];}else{unicornInfo.annotations=null;unicornInfo.unicorns=null;}}else{if(buffer!==''){current.appendChild(doc.createTextNode(buffer));buffer='';}for(var j=0,jlen=item.length;j<jlen;j++){var clone=item[j].cloneNode(true);clone.veOrigNode=item[j];current.appendChild(clone);}}}if(buffer!==''){current.appendChild(doc.createTextNode(buffer));buffer='';}while(annotationStack.length>0){closeAnnotation();}wrapper.unicornInfo=unicornInfo;return wrapper;};ve.ce.ContentBranchNode.prototype.onModelDetach=function(){if(this.root instanceof ve.ce.DocumentNode){this.root.getSurface().setContentBranchNodeChanged();}};ve.ce.ContentBranchNode.prototype.renderContents=function(){var node=this;if(this.root instanceof ve.ce.DocumentNode&&this.root.getSurface().isRenderingLocked()){return false;}if(this.root instanceof ve.ce.DocumentNode){this.root.getSurface().setContentBranchNodeChanged();}var rendered=this.getRenderedContents();var unicornInfo=rendered.unicornInfo;if(this.rendered){
var oldWrapper=this.$element[0].cloneNode(true);$(oldWrapper).find('.ve-ce-annotation-active').removeClass('ve-ce-annotation-active');$(oldWrapper).find('.ve-ce-branchNode-inlineSlug').children().unwrap().filter('.ve-ce-chimera').remove();var newWrapper=this.$element[0].cloneNode(false);while(rendered.firstChild){newWrapper.appendChild(rendered.firstChild);}ve.normalizeNode(oldWrapper);ve.normalizeNode(newWrapper);if(newWrapper.isEqualNode(oldWrapper)){return false;}rendered=newWrapper;}this.rendered=true;this.unicornAnnotations=unicornInfo.annotations||null;this.unicorns=unicornInfo.unicorns||null;for(var i=0,len=this.$element.length;i<len;i++){var element=this.$element[i];while(element.firstChild){element.removeChild(element.firstChild);}}this.constructor.static.appendRenderedContents(this.$element[0],rendered);if(this.getRoot()){if(!unicornInfo.hasCursor){this.getRoot().getSurface().setNotUnicorning(this);}else if(this.unicorns){this.getRoot().getSurface().setUnicorning(this);}else{
this.getRoot().getSurface().setNotUnicorningAll(this);}}this.setupInlineSlugs();if(ve.inputDebug){this.$element.css('backgroundColor','#eee');setTimeout(function(){node.$element.css('backgroundColor','');},300);}return true;};ve.ce.ContentBranchNode.prototype.detach=function(){if(this.getRoot()){this.getRoot().getSurface().setNotUnicorning(this);}ve.ce.ContentBranchNode.super.prototype.detach.call(this);};ve.ce.ContentBranchNode.prototype.destroy=function(){this.$element.off('click',this.onClickHandler);ve.ce.ContentBranchNode.super.prototype.destroy.call(this);};ve.ce.LeafNode=function VeCeLeafNode(){ve.LeafNode.call(this);ve.ce.LeafNode.super.apply(this,arguments);};OO.inheritClass(ve.ce.LeafNode,ve.ce.Node);OO.mixinClass(ve.ce.LeafNode,ve.LeafNode);ve.ce.LeafNode.static.tagName='span';ve.ce.LeafNode.prototype.initialize=function(){ve.ce.LeafNode.super.prototype.initialize.call(this);if(this.model.isWrapped()){this.$element.addClass('ve-ce-leafNode');}};ve.ce.LeafNode.prototype.
getAnnotatedHtml=function(){return[[this.$element,this.getModel().getAnnotations()]];};ve.ce.MetaItem=function VeCeMetaItem(model,config){ve.ce.MetaItem.super.call(this,model,ve.extendObject({},config,{$element:$()}));};OO.inheritClass(ve.ce.MetaItem,ve.ce.LeafNode);ve.ce.MetaItem.static.name='meta';ve.ce.nodeFactory.register(ve.ce.MetaItem);ve.ce.ClassAttributeNode=function VeCeClassAttributeNode($classedElement){this.$classedElement=$classedElement||this.$element;this.currentAttributeClasses='';this.$classedElement.removeClass(this.getModel().getAttribute('originalClasses')).addClass(this.getModel().getAttribute('unrecognizedClasses'));this.connect(this,{setup:'updateAttributeClasses'});this.model.connect(this,{attributeChange:'updateAttributeClasses'});};OO.initClass(ve.ce.ClassAttributeNode);ve.ce.ClassAttributeNode.prototype.updateAttributeClasses=function(){this.$classedElement.removeClass(this.currentAttributeClasses);this.currentAttributeClasses=this.model.constructor.static.
getClassAttrFromAttributes(this.model.element.attributes);this.$classedElement.addClass(this.currentAttributeClasses);};ve.ce.AlignableNode=function VeCeAlignableNode(){ve.ce.AlignableNode.super.apply(this,arguments);this.align=null;};OO.inheritClass(ve.ce.AlignableNode,ve.ce.ClassAttributeNode);ve.ce.AlignableNode.prototype.updateAttributeClasses=function(){ve.ce.AlignableNode.super.prototype.updateAttributeClasses.apply(this,arguments);var align=this.model.getAttribute('align');if(align&&align!==this.align){this.emit('align',align);this.align=align;}};ve.ce.FocusableNode=function VeCeFocusableNode($focusable,config){config=config||{};this.focused=false;this.highlighted=false;this.isFocusableSetup=false;this.$highlights=$('<div>').addClass('ve-ce-focusableNode-highlights');this.$focusable=$focusable||this.$element;this.$bounding=config.$bounding||this.$focusable;this.focusableSurface=null;this.rects=null;this.boundingRect=null;this.startAndEndRects=null;this.icon=null;this.touchMoved=
false;if(Array.isArray(config.classes)){this.$highlights.addClass(config.classes.join(' '));}this.redrawHighlightsDebounced=ve.debounce(this.redrawHighlights.bind(this),100);this.$element.addClass('ve-ce-focusableNode').prop('contentEditable','false');this.connect(this,{setup:'onFocusableSetup',teardown:'onFocusableTeardown',resizeStart:'onFocusableResizeStart',resizeEnd:'onFocusableResizeEnd',rerender:'onFocusableRerender'});};OO.initClass(ve.ce.FocusableNode);ve.ce.FocusableNode.static.iconWhenInvisible=null;ve.ce.FocusableNode.static.primaryCommandName=null;ve.ce.FocusableNode.static.deleteCommandName=null;ve.ce.FocusableNode.static.getRectsForElement=function($element,relativeRect){var $set;var rects=[];function contains(rect1,rect2){return rect2.left>=rect1.left&&rect2.top>=rect1.top&&rect2.right<=rect1.right&&rect2.bottom<=rect1.bottom;}function process(el){if(el.classList.contains('ve-ce-noHighlight')){return;}var $el=$(el);var overflow=$el.css('overflow');if(overflow&&overflow
!=='visible'&&$el.css('display')!=='inline'){$set=$set.not($el.find('*'));}var clientRects=el.getClientRects();for(var j=0,jl=clientRects.length;j<jl;j++){var contained=false;for(var k=0,kl=rects.length;k<kl;k++){if(contains(rects[k],clientRects[j])){contained=true;break;}if(contains(clientRects[j],rects[k])){rects.splice(k,1);k--;kl--;}}if(!contained){rects.push(clientRects[j]);}}}$set=$element.find('*').addBack();var i,l;for(i=0;i<$set.length;i++){process($set[i]);}var filteredRects=rects.filter(function(rect){return rect.width>1&&rect.height>1;});if(filteredRects.length>0){rects=filteredRects;}var boundingRect=null;for(i=0,l=rects.length;i<l;i++){if(relativeRect){rects[i]=ve.translateRect(rects[i],-relativeRect.left,-relativeRect.top);}if(!boundingRect){boundingRect=ve.copy(rects[i]);}else{boundingRect.top=Math.min(boundingRect.top,rects[i].top);boundingRect.left=Math.min(boundingRect.left,rects[i].left);boundingRect.bottom=Math.max(boundingRect.bottom,rects[i].bottom);boundingRect.
right=Math.max(boundingRect.right,rects[i].right);}}if(boundingRect){boundingRect.width=boundingRect.right-boundingRect.left;boundingRect.height=boundingRect.bottom-boundingRect.top;}return{rects:rects,boundingRect:boundingRect};};ve.ce.FocusableNode.prototype.createHighlight=function(){var extraClasses=this.generatedContentsInvalid?' ve-ce-focusableNode-highlight-error':'';return $('<div>').addClass('ve-ce-focusableNode-highlight'+extraClasses).prop({title:this.constructor.static.getDescription(this.model),draggable:true}).on({dragstart:this.onFocusableDragStart.bind(this),dragend:this.onFocusableDragEnd.bind(this)});};ve.ce.FocusableNode.prototype.onFocusableSetup=function(){if(this.isFocusableSetup||!this.root){return;}this.focusableSurface=this.root.getSurface();if(!this.$element.hasClass('ve-ce-focusableNode')){this.$element.addClass('ve-ce-focusableNode').prop('contentEditable','false');}this.$focusable.on({'mouseenter.ve-ce-focusableNode':this.onFocusableMouseEnter.bind(this),
'touchstart.ve-ce-focusableNode':this.onFocusableTouchStart.bind(this),'touchmove.ve-ce-focusableNode':this.onFocusableTouchMove.bind(this),'mousedown.ve-ce-focusableNode touchend.ve-ce-focusableNode':this.onFocusableMouseDown.bind(this)});if(!this.$element.is(this.$focusable)){this.$element.on({'mousedown.ve-ce-focusableNode':function(e){if(!ve.isContentEditable(e.target)){e.preventDefault();}}});}this.$element.on({'click.ve-ce-focusableNode':function(e){if(!ve.isContentEditable(e.target)&&e.which===OO.ui.MouseButtons.LEFT){e.preventDefault();}}});if(this.constructor.static.iconWhenInvisible){this.$element.find('img:not([width]),img:not([height])').addBack('img:not([width]),img:not([height])').on('load',this.updateInvisibleIcon.bind(this));this.updateInvisibleIcon();}this.isFocusableSetup=true;};ve.ce.FocusableNode.prototype.updateInvisibleIcon=function(){if(!this.constructor.static.iconWhenInvisible){return;}if(this.icon){this.icon.$element.detach();}var showIcon=!this.hasRendering()
;var rAF=window.requestAnimationFrame||setTimeout;var node=this;rAF(function(){node.updateInvisibleIconSync(showIcon);});};ve.ce.FocusableNode.prototype.updateInvisibleIconSync=function(showIcon){if(!this.getModel()){return;}if(showIcon){var voidAndHiddenTypes=ve.elementTypes.void.concat('style','script');var $firstElement=this.$element.not(voidAndHiddenTypes.join(',')).first();this.createInvisibleIcon();if(document.body.contains($firstElement[0])&&!$firstElement.is(':visible')){$firstElement.empty().css('display','inline-block');}$firstElement.addClass('ve-ce-focusableNode-invisible').prepend(this.icon.$element);}else if(this.icon){this.$element.removeClass('ve-ce-focusableNode-invisible');this.icon.$element.detach();}};ve.ce.FocusableNode.prototype.createInvisibleIcon=function(){if(this.icon){return;}this.icon=new OO.ui.ButtonWidget({classes:['ve-ce-focusableNode-invisibleIcon'],framed:false,tabIndex:null,icon:this.constructor.static.iconWhenInvisible});this.updateInvisibleIconLabel(
);};ve.ce.FocusableNode.prototype.getInvisibleIconLabel=function(){return this.model?this.constructor.static.getDescription(this.model):'';};ve.ce.FocusableNode.prototype.updateInvisibleIconLabel=function(){if(this.icon){this.icon.setLabel(this.getInvisibleIconLabel()||null);}};ve.ce.FocusableNode.prototype.onFocusableTeardown=function(){if(!this.isFocusableSetup||!this.root){return;}this.$focusable.off('.ve-ce-focusableNode');this.$element.off('.ve-ce-focusableNode');this.clearHighlights();this.$element.removeClass('ve-ce-focusableNode').removeProp('contentEditable');this.focusableSurface=null;this.isFocusableSetup=false;};ve.ce.FocusableNode.prototype.onFocusableMouseDown=function(e){if(e.type==='touchend'&&this.touchMoved){return;}if(this.isInContentEditableDisabled()){return;}var node=this,surfaceModel=this.focusableSurface.getModel(),selection=surfaceModel.getSelection(),nodeRange=this.model.getOuterRange();if(e.which===OO.ui.MouseButtons.RIGHT){this.$highlights.prop(
'contentEditable','true');ve.selectElement(this.$highlights[0]);setTimeout(function(){node.$highlights.prop('contentEditable','false');node.focusableSurface.preparePasteTargetForCopy();});}setTimeout(function(){if(node.focusableSurface){var range=selection instanceof ve.dm.LinearSelection&&selection.getRange();surfaceModel.getLinearFragment(e.shiftKey&&range?ve.Range.static.newCoveringRange([range,nodeRange],range.from>nodeRange.from):nodeRange).select();node.focusableSurface.updateActiveAnnotations();node.focusableSurface.activate();}});};ve.ce.FocusableNode.prototype.onFocusableDblClick=function(){if(this.isInContentEditableDisabled()){return;}if(this.getModel().isEditable()){this.executeCommand();}};ve.ce.FocusableNode.prototype.executeCommand=function(){if(!this.model.isInspectable()){return;}var surface=this.focusableSurface.getSurface();var command=surface.commandRegistry.getCommandForNode(this);if(command){command.execute(surface);}};ve.ce.FocusableNode.prototype.
onFocusableDragStart=function(e){if(this.focusableSurface){this.focusableSurface.onDocumentDragStart(e);}};ve.ce.FocusableNode.prototype.onFocusableDragEnd=function(){if(this.focusableSurface){this.focusableSurface.endRelocation();}};ve.ce.FocusableNode.prototype.onFocusableMouseEnter=function(){if(!this.root.getSurface().dragging&&!this.root.getSurface().resizing&&!this.isInContentEditableDisabled()){this.createHighlights();}};ve.ce.FocusableNode.prototype.onFocusableTouchStart=function(){this.touchMoved=false;};ve.ce.FocusableNode.prototype.onFocusableTouchMove=function(){this.touchMoved=true;};ve.ce.FocusableNode.prototype.onSurfaceMouseMove=function(e){var $target=$(e.target);if(!$target.hasClass('ve-ce-focusableNode-highlight')&&!OO.ui.contains(this.$focusable.toArray(),$target[0],true)){this.clearHighlights();}};ve.ce.FocusableNode.prototype.onSurfaceMouseLeave=function(e){if(e.relatedTarget===null){this.clearHighlights();}};ve.ce.FocusableNode.prototype.onFocusableResizeStart=
function(){this.clearHighlights();};ve.ce.FocusableNode.prototype.onFocusableResizeEnd=function(){this.redrawHighlightsDebounced();};ve.ce.FocusableNode.prototype.onFocusableRerender=function(){if(this.focused&&this.focusableSurface){this.redrawHighlightsDebounced();this.focusableSurface.getSurface().getContext().updateDimensions(true);}};ve.ce.FocusableNode.prototype.isFocused=function(){return this.focused;};ve.ce.FocusableNode.prototype.setFocused=function(value){value=!!value;if(this.focused!==value){this.focused=value;if(this.focused){this.emit('focus');this.$element.addClass('ve-ce-focusableNode-focused');this.createHighlights();this.focusableSurface.appendHighlights(this.$highlights,this.focused);this.focusableSurface.$element.off('.ve-ce-focusableNode');}else{this.emit('blur');this.$element.removeClass('ve-ce-focusableNode-focused');this.$highlights.removeClass('ve-ce-focusableNode-highlights-deactivated');this.clearHighlights();}}};ve.ce.FocusableNode.prototype.
createHighlights=function(){if(this.highlighted){return;}this.$highlights.on({mousedown:this.onFocusableMouseDown.bind(this),dblclick:this.onFocusableDblClick.bind(this)});this.highlighted=true;this.positionHighlights();this.focusableSurface.appendHighlights(this.$highlights,this.focused);this.focusableSurface.connect(this,{position:'positionHighlights',activation:'onSurfaceActivation'});if(!this.focused){this.focusableSurface.$element.on({'mousemove.ve-ce-focusableNode':this.onSurfaceMouseMove.bind(this),'mouseleave.ve-ce-focusableNode':this.onSurfaceMouseLeave.bind(this)});}};ve.ce.FocusableNode.prototype.onSurfaceActivation=function(){this.$highlights.toggleClass('ve-ce-focusableNode-highlights-deactivated',!!this.focusableSurface.isShownAsDeactivated());};ve.ce.FocusableNode.prototype.clearHighlights=function(){if(!this.highlighted){return;}this.$highlights.remove().empty();this.focusableSurface.$element.off('.ve-ce-focusableNode');this.focusableSurface.disconnect(this);this.
highlighted=false;this.boundingRect=null;};ve.ce.FocusableNode.prototype.redrawHighlights=function(){if(this.focused){this.setFocused(false);this.setFocused(true);}};ve.ce.FocusableNode.prototype.calculateHighlights=function(){if(!this.focusableSurface){this.rects=[];this.boundingRect=null;this.startAndEndRects=null;return;}var surfaceOffset=this.focusableSurface.getSurface().getBoundingClientRect();var allRects=this.constructor.static.getRectsForElement(this.$focusable,surfaceOffset);this.rects=allRects.rects;this.boundingRect=allRects.boundingRect;this.startAndEndRects=null;};ve.ce.FocusableNode.prototype.positionHighlights=function(){if(!this.highlighted){return;}this.calculateHighlights();this.$highlights.empty().append($('<span>').addClass('ve-ce-focusableNode-highlight-selectable').text('\u00a0'));for(var i=0,l=this.rects.length;i<l;i++){var $highlight=this.createHighlight();this.$highlights.append($highlight.css({top:this.rects[i].top,left:this.rects[i].left,width:this.rects[i].
width,height:this.rects[i].height}));}};ve.ce.FocusableNode.prototype.getRects=function(){if(!this.highlighted){this.calculateHighlights();}return this.rects;};ve.ce.FocusableNode.prototype.getBoundingRect=function(){if(!this.$bounding.is(this.$focusable)){var surfaceOffset=this.focusableSurface.getSurface().getBoundingClientRect();var allRects=this.constructor.static.getRectsForElement(this.$bounding,surfaceOffset);return allRects.boundingRect;}if(!this.highlighted){this.calculateHighlights();}return this.boundingRect;};ve.ce.FocusableNode.prototype.getStartAndEndRects=function(){if(!this.highlighted){this.calculateHighlights();}if(!this.startAndEndRects){this.startAndEndRects=ve.getStartAndEndRects(this.rects);}return this.startAndEndRects;};ve.ce.FocusableNode.prototype.hasRendering=function(){var visible=false;function checkSize(width,height){return(width>=10&&height>=4)||(height>=10&&width>=4);}this.$element.each(function(){if(checkSize(this.offsetWidth,this.offsetHeight)||
checkSize(this.width,this.height)){visible=true;return false;}});return visible;};ve.ce.FocusableNode.prototype.isInContentEditableDisabled=function(){return!!this.traverseUpstream(function(node){return!(node.isContentEditable&&!node.isContentEditable());});};ve.ce.ResizableNode=function VeCeResizableNode($resizable,config){config=config||{};this.$resizable=$resizable||this.$element;this.resizing=false;this.$resizeHandles=$('<div>');this.snapToGrid=config.snapToGrid!==undefined?config.snapToGrid:10;this.outline=!!config.outline;this.showSizeLabel=config.showSizeLabel!==false;this.showScaleLabel=config.showScaleLabel!==false;this.canShowScaleLabel=false;if(this.showSizeLabel||this.showScaleLabel){this.$sizeText=$('<span>').addClass('ve-ce-resizableNode-sizeText');this.$sizeLabel=$('<div>').addClass('ve-ce-resizableNode-sizeLabel').append(this.$sizeText);}this.resizableOffset=null;this.resizableSurface=null;this.connect(this,{focus:'onResizableFocus',blur:'onResizableBlur',setup:
'onResizableSetup',teardown:'onResizableTeardown',resizing:'onResizableResizing',resizeEnd:'onResizableFocus',rerender:'onResizableFocus',align:'onResizableAlign'});this.model.connect(this,{attributeChange:'onResizableAttributeChange'});this.$resizeHandles.addClass('ve-ce-resizableNode-handles').append($('<div>').addClass('ve-ce-resizableNode-nwHandle').data('handle','nw')).append($('<div>').addClass('ve-ce-resizableNode-neHandle').data('handle','ne')).append($('<div>').addClass('ve-ce-resizableNode-seHandle').data('handle','se')).append($('<div>').addClass('ve-ce-resizableNode-swHandle').data('handle','sw'));};OO.initClass(ve.ce.ResizableNode);ve.ce.ResizableNode.prototype.isResizable=function(){return this.$resizable&&!!this.$resizable.length&&!OO.ui.isMobile()&&!(this.root&&this.root.getSurface()&&this.root.getSurface().isReadOnly());};ve.ce.ResizableNode.prototype.getResizableOffset=function(){if(!this.resizableOffset){this.resizableOffset=OO.ui.Element.static.getRelativePosition(
this.$resizable,this.resizableSurface.getSurface().$element);}return this.resizableOffset;};ve.ce.ResizableNode.prototype.setOriginalDimensions=function(dimensions){if(!this.isResizable()){return;}var scalable=this.model.getScalable();scalable.setOriginalDimensions(dimensions);this.canShowScaleLabel=this.showScaleLabel&&scalable.getOriginalDimensions().width&&scalable.getOriginalDimensions().height;};ve.ce.ResizableNode.prototype.hideSizeLabel=function(){if(!this.isResizable()){return;}var node=this;setTimeout(function(){node.$sizeLabel.removeClass('ve-ce-resizableNode-sizeLabel-resizing');});setTimeout(function(){node.$sizeLabel.addClass('oo-ui-element-hidden');},200);};ve.ce.ResizableNode.prototype.updateSizeLabel=function(){if(!this.isResizable()){return;}if(!this.showSizeLabel&&!this.canShowScaleLabel){return;}var scalable=this.model.getScalable();var dimensions=scalable.getCurrentDimensions();var offset=this.getResizableOffset();var minWidth=(this.showSizeLabel?100:0)+(this.
showScaleLabel?30:0);var top,height;if(dimensions.width<minWidth){top=offset.top+dimensions.height;height=30;}else{top=offset.top;height=dimensions.height;}this.$sizeLabel.removeClass('oo-ui-element-hidden').addClass('ve-ce-resizableNode-sizeLabel-resizing').css({top:top,left:offset.left,width:dimensions.width,height:height,lineHeight:height+'px'});this.$sizeText.empty();if(this.showSizeLabel){this.$sizeText.append($('<span>').addClass('ve-ce-resizableNode-sizeText-size').text(Math.round(dimensions.width)+' × '+Math.round(dimensions.height)));}if(this.canShowScaleLabel){this.$sizeText.append($('<span>').addClass('ve-ce-resizableNode-sizeText-scale').text(Math.round(100*scalable.getCurrentScale())+'%'));}this.$sizeText.toggleClass('ve-ce-resizableNode-sizeText-warning',scalable.isTooSmall()||scalable.isTooLarge());};ve.ce.ResizableNode.prototype.showHandles=function(handles){if(!this.isResizable()){return;}var add=[],remove=[],allDirections=['nw','ne','sw','se'];for(var i=0,len=
allDirections.length;i<len;i++){if(handles===undefined||handles.indexOf(allDirections[i])!==-1){remove.push('ve-ce-resizableNode-hide-'+allDirections[i]);}else{add.push('ve-ce-resizableNode-hide-'+allDirections[i]);}}this.$resizeHandles.addClass(add.join(' ')).removeClass(remove.join(' '));};ve.ce.ResizableNode.prototype.onResizableFocus=function(){if(!this.isResizable()||!this.isFocused()){return;}this.$resizeHandles.appendTo(this.resizableSurface.getSurface().$controls);if(this.$sizeLabel){this.$sizeLabel.appendTo(this.resizableSurface.getSurface().$controls);}this.model.getScalable();this.setResizableHandlesSizeAndPosition();this.$resizeHandles.find('.ve-ce-resizableNode-neHandle').css({marginRight:-this.$resizable.outerWidth()});this.$resizeHandles.find('.ve-ce-resizableNode-swHandle').css({marginBottom:-this.$resizable.outerHeight()});this.$resizeHandles.find('.ve-ce-resizableNode-seHandle').css({marginRight:-this.$resizable.outerWidth(),marginBottom:-this.$resizable.outerHeight()
});this.$resizeHandles.children().off('.ve-ce-resizableNode').on('mousedown.ve-ce-resizableNode',this.onResizeHandlesCornerMouseDown.bind(this));this.resizableSurface.connect(this,{position:'setResizableHandlesSizeAndPosition'});};ve.ce.ResizableNode.prototype.onResizableBlur=function(){if(!this.isResizableSetup||!this.root){return;}this.$resizeHandles.detach();if(this.$sizeLabel){this.$sizeLabel.detach();}this.resizableSurface.disconnect(this,{position:'setResizableHandlesSizeAndPosition'});};ve.ce.ResizableNode.prototype.onResizableAlign=function(align){if(!this.isResizable()){return;}this.showHandles({right:['sw'],left:['se'],center:['sw','se']}[align]);};ve.ce.ResizableNode.prototype.onResizableSetup=function(){if(this.isResizableSetup||!this.root){return;}this.resizableSurface=this.root.getSurface();this.isResizableSetup=true;};ve.ce.ResizableNode.prototype.onResizableTeardown=function(){if(!this.isResizableSetup||!this.root){return;}this.onResizableBlur();this.resizableSurface=
null;this.isResizableSetup=false;};ve.ce.ResizableNode.prototype.onResizableResizing=function(dimensions){if(!this.isResizable()){return;}this.resizableOffset=null;this.model.getScalable().setCurrentDimensions(dimensions);if(!this.outline){this.$resizable.css(this.model.getScalable().getCurrentDimensions());this.setResizableHandlesPosition();}this.updateSizeLabel();};ve.ce.ResizableNode.prototype.onResizableAttributeChange=function(){if(!this.isResizable()){return;}this.$resizable.css(this.model.getCurrentDimensions());};ve.ce.ResizableNode.prototype.onResizeHandlesCornerMouseDown=function(e){this.root.getSurface().getSurface().getContext().toggle(false);this.$resizeHandles.addClass('ve-ce-resizableNode-handles-resizing').css({width:this.$resizable.outerWidth(),height:this.$resizable.outerHeight()});this.$resizeHandles.children().css('margin',0);this.resizeInfo={mouseX:e.screenX,mouseY:e.screenY,top:this.$resizeHandles.position().top,left:this.$resizeHandles.position().left,height:this
.$resizeHandles.height(),width:this.$resizeHandles.width(),handle:$(e.target).data('handle')};this.resizing=true;this.root.getSurface().resizing=true;this.model.getScalable().setCurrentDimensions({width:this.resizeInfo.width,height:this.resizeInfo.height});this.updateSizeLabel();$(this.getElementDocument()).on({'mousemove.ve-ce-resizableNode':this.onDocumentMouseMove.bind(this),'mouseup.ve-ce-resizableNode':this.onDocumentMouseUp.bind(this)});this.emit('resizeStart');e.preventDefault();};ve.ce.ResizableNode.prototype.setResizableHandlesSizeAndPosition=function(){if(!this.isResizable()){return;}var width=this.$resizable.outerWidth();var height=this.$resizable.outerHeight();this.resizableOffset=null;this.setResizableHandlesPosition();this.$resizeHandles.css({width:0,height:0}).find('.ve-ce-resizableNode-neHandle').css({marginRight:-width});this.$resizeHandles.find('.ve-ce-resizableNode-swHandle').css({marginBottom:-height});this.$resizeHandles.find('.ve-ce-resizableNode-seHandle').css({
marginRight:-width,marginBottom:-height});};ve.ce.ResizableNode.prototype.setResizableHandlesPosition=function(){if(!this.isResizable()){return;}var offset=this.getResizableOffset();this.$resizeHandles.css({top:offset.top,left:offset.left});};ve.ce.ResizableNode.prototype.onDocumentMouseMove=function(e){var diff={},dimensions={width:0,height:0,top:this.resizeInfo.top,left:this.resizeInfo.left};if(this.resizing){switch(this.resizeInfo.handle){case'se':diff.x=e.screenX-this.resizeInfo.mouseX;diff.y=e.screenY-this.resizeInfo.mouseY;break;case'nw':diff.x=this.resizeInfo.mouseX-e.screenX;diff.y=this.resizeInfo.mouseY-e.screenY;break;case'ne':diff.x=e.screenX-this.resizeInfo.mouseX;diff.y=this.resizeInfo.mouseY-e.screenY;break;case'sw':diff.x=this.resizeInfo.mouseX-e.screenX;diff.y=e.screenY-this.resizeInfo.mouseY;break;}dimensions=this.model.getScalable().getBoundedDimensions({width:this.resizeInfo.width+diff.x,height:this.resizeInfo.height+diff.y},e.shiftKey&&this.snapToGrid);switch(this.
resizeInfo.handle){case'ne':dimensions.top=this.resizeInfo.top+(this.resizeInfo.height-dimensions.height);break;case'sw':dimensions.left=this.resizeInfo.left+(this.resizeInfo.width-dimensions.width);break;case'nw':dimensions.top=this.resizeInfo.top+(this.resizeInfo.height-dimensions.height);dimensions.left=this.resizeInfo.left+(this.resizeInfo.width-dimensions.width);break;}this.$resizeHandles.css(dimensions);this.emit('resizing',{width:dimensions.width,height:dimensions.height});}};ve.ce.ResizableNode.prototype.onDocumentMouseUp=function(){var width=this.$resizeHandles.outerWidth(),height=this.$resizeHandles.outerHeight();this.$resizeHandles.removeClass('ve-ce-resizableNode-handles-resizing');$(this.getElementDocument()).off('.ve-ce-resizableNode');this.resizing=false;this.root.getSurface().resizing=false;this.hideSizeLabel();var attrChanges=this.getAttributeChanges(width,height);if(!ve.isEmptyObject(attrChanges)){this.resizableSurface.getModel().getFragment().changeAttributes(
attrChanges);}this.root.getSurface().getSurface().getContext().updateDimensions();this.emit('resizeEnd');};ve.ce.ResizableNode.prototype.getAttributeChanges=function(width,height){var attrChanges={},currentDimensions=this.model.getCurrentDimensions();if(currentDimensions.width!==width){attrChanges.width=width;}if(currentDimensions.height!==height){attrChanges.height=height;}return attrChanges;};ve.ce.TableCellableNode=function VeCeTableCellableNode(){if(this.isCellable()&&!this.isCellEditable()){this.$element.attr('title',ve.msg('visualeditor-aliennode-tooltip'));}this.$element.addClass('ve-ce-tableCellableNode');};OO.initClass(ve.ce.TableCellableNode);ve.ce.TableCellableNode.prototype.setEditing=function(){};ve.ce.TableCellableNode.prototype.getTagName=function(){var style=this.model.getAttribute('style'),types={data:'td',header:'th'};if(!Object.prototype.hasOwnProperty.call(types,style)){throw new Error('Invalid style');}return types[style];};ve.ce.Selection=function VeCeSelection(
model,surface){this.model=model;this.surface=surface;};OO.initClass(ve.ce.Selection);ve.ce.Selection.static.type=null;ve.ce.Selection.static.newFromModel=function(model,surface){return ve.ce.selectionFactory.create(model.getName(),model,surface);};ve.ce.Selection.prototype.getSurface=function(){return this.surface;};ve.ce.Selection.prototype.getModel=function(){return this.model;};ve.ce.Selection.prototype.getSelectionRects=null;ve.ce.Selection.prototype.getSelectionStartAndEndRects=function(){return ve.getStartAndEndRects(this.getSelectionRects());};ve.ce.Selection.prototype.getSelectionFocusRect=function(){var toSelection=new this.constructor(this.getModel().collapseToTo(),this.surface);return toSelection.getSelectionBoundingRect();};ve.ce.Selection.prototype.getSelectionBoundingRect=null;ve.ce.Selection.prototype.isFocusedNode=null;ve.ce.Selection.prototype.isNativeCursor=null;ve.ce.Selection.prototype.equals=function(other){return this.getSurface()===other.getSurface()&&this.
getModel().equals(other.getModel());};ve.ce.Selection.prototype.getDirectionality=null;ve.ce.selectionFactory=new OO.Factory();ve.ce.Surface=function VeCeSurface(model,ui,config){var surface=this;ve.ce.Surface.super.call(this,config);OO.EventEmitter.call(this);this.surface=ui;this.model=model;this.documentView=new ve.ce.Document(model.getDocument(),this);this.attachedRoot=this.getDocument().getDocumentNode().getNodeFromOffset(model.getAttachedRoot().getOffset()+(model.getAttachedRoot().isWrapped()?1:0));this.selection=null;this.readOnly=false;this.surfaceObserver=new ve.ce.SurfaceObserver(this);this.$window=$(this.getElementWindow());this.$document=$(this.getElementDocument());this.$attachedRootNode=this.attachedRoot.$element.addClass('ve-ce-attachedRootNode');this.$documentNode=this.$attachedRootNode;this.root=this.attachedRoot;this.nativeSelection=this.getElementWindow().getSelection();ve.fixSelectionNodes(this.nativeSelection);this.eventSequencer=new ve.EventSequencer(['keydown',
'keypress','keyup','compositionstart','compositionend','input','mousedown']);this.clipboard=null;this.clipboardId=Math.random().toString();this.clipboardIndex=0;this.middleClickSelection=null;this.renderLocks=0;this.dragging=false;this.relocatingSelection=null;this.relocatingNode=null;this.allowedFile=null;this.resizing=false;this.focused=false;this.deactivated=false;this.showAsActivated=false;this.hideSelection=false;this.$deactivatedSelection=$('<div>');this.activeNode=null;this.contentBranchNodeChanged=false;this.selectionLink=null;this.delayedSequences=[];this.$highlightsFocused=$('<div>');this.$highlightsBlurred=$('<div>');this.$highlightsUserSelections=$('<div>');this.$highlightsUserCursors=$('<div>');this.userSelectionOverlays={};this.$highlights=$('<div>').append(this.$highlightsFocused,this.$highlightsBlurred,this.$highlightsUserSelections,this.$highlightsUserCursors);this.$findResults=$('<div>');this.$dropMarker=$('<div>').addClass(
've-ce-surface-dropMarker oo-ui-element-hidden');this.$lastDropTarget=null;this.lastDropPosition=null;this.$pasteTarget=$('<div>');this.pasting=false;this.copying=false;this.pasteSpecial=false;this.pointerEvents=null;this.focusedBlockSlug=null;this.focusedNode=null;this.activeAnnotations=[];this.contexedAnnotations=[];this.previousActiveAnnotations=[];this.newModelSelection=null;this.keyDownState={event:null,selectionState:null};this.cursorDirectionality=null;this.unicorningNode=null;this.setUnicorningRecursionGuard=false;this.cursorHolders=null;this.hasSelectionChangeEvents='onselectionchange'in this.getElementDocument();this.onPositionDebounced=ve.debounce(this.onPosition.bind(this));this.connect(this,{position:this.onPositionDebounced});this.model.connect(this,{select:'onModelSelect',documentUpdate:'onModelDocumentUpdate',insertionAnnotationsChange:'onInsertionAnnotationsChange'});if(this.model.synchronizer){this.model.synchronizer.connect(this,{authorSelect:
'onSynchronizerAuthorUpdate',authorChange:'onSynchronizerAuthorUpdate',authorDisconnect:'onSynchronizerAuthorDisconnect',wrongDoc:'onSynchronizerWrongDoc',pause:'onSynchronizerPause'});}this.onDocumentMouseUpHandler=this.onDocumentMouseUp.bind(this);this.$attachedRootNode.on({mousedown:this.onDocumentMouseDown.bind(this),cut:this.onCut.bind(this),copy:this.onCopy.bind(this)});this.onWindowResizeHandler=ve.debounce(this.onWindowResize.bind(this),50);this.$window.on('resize',this.onWindowResizeHandler);this.onDocumentFocusInOutHandler=this.onDocumentFocusInOut.bind(this);this.$document.on('focusin focusout',this.onDocumentFocusInOutHandler);this.debounceFocusChange=ve.debounce(this.onFocusChange.bind(this));this.$document.on('mousedown',this.debounceFocusChange);this.$attachedRootNode.on('mouseup',this.debounceFocusChange);this.$pasteTarget.add(this.$highlights).on({cut:this.onCut.bind(this),copy:this.onCopy.bind(this),paste:this.onPaste.bind(this)});this.$attachedRootNode.on('paste',
this.onPaste.bind(this)).on('focus','a',function(){surface.$attachedRootNode[0].focus();});this.onDocumentSelectionChangeDebounced=ve.debounce(this.onDocumentSelectionChange.bind(this));if(this.hasSelectionChangeEvents){this.$document.on('selectionchange',this.onDocumentSelectionChangeDebounced);}else{this.$attachedRootNode.on('mousemove',function(){if(surface.dragging){surface.onDocumentSelectionChangeDebounced();}});this.eventSequencer.after({mousedown:this.onDocumentSelectionChangeDebounced});}this.$element.on({dragstart:this.onDocumentDragStart.bind(this),dragover:this.onDocumentDragOver.bind(this),dragleave:this.onDocumentDragLeave.bind(this),drop:this.onDocumentDrop.bind(this)});this.eventSequencer.on({keydown:this.onDocumentKeyDown.bind(this),keyup:this.onDocumentKeyUp.bind(this),keypress:this.onDocumentKeyPress.bind(this),input:this.onDocumentInput.bind(this),compositionstart:this.onDocumentCompositionStart.bind(this)}).after({keydown:this.afterDocumentKeyDown.bind(this)});this
.$element.addClass('ve-ce-surface notranslate');this.$element.attr('translate','no');this.$highlights.addClass('ve-ce-surface-highlights');this.$highlightsFocused.addClass('ve-ce-surface-highlights-focused');this.$highlightsBlurred.addClass('ve-ce-surface-highlights-blurred');this.$deactivatedSelection.addClass('ve-ce-surface-deactivatedSelection');this.$highlightsUserSelections.addClass('ve-ce-surface-highlights-user-selections');this.$highlightsUserCursors.addClass('ve-ce-surface-highlights-user-cursors');this.$pasteTarget.addClass('ve-ce-surface-paste').attr('aria-hidden',true).prop({tabIndex:-1,contentEditable:'true'});this.$highlights.append(this.$dropMarker);this.$element.append(this.$attachedRootNode,this.$pasteTarget);this.surface.$blockers.append(this.$highlights);this.surface.$selections.append(this.$deactivatedSelection);};OO.inheritClass(ve.ce.Surface,OO.ui.Element);OO.mixinClass(ve.ce.Surface,OO.EventEmitter);ve.ce.Surface.static.unsafeAttributes=['about','content',
'datatype','property','rel','resource','rev','typeof','style'];ve.ce.Surface.static.inputTypeCommands={historyUndo:'undo',historyRedo:'redo',formatBold:'bold',formatItalic:'italic',formatUnderline:'underline',formatStrikeThrough:'strikethrough',formatSuperscript:'superscript',formatSubscript:'subscript',formatJustifyFull:null,formatJustifyCenter:null,formatJustifyRight:null,formatJustifyLeft:null,formatIndent:'indent',formatOutdent:'outdent',formatRemove:'clear',formatSetBlockTextDirection:null,formatSetInlineTextDirection:null,formatBackColor:null,formatFontColor:null,formatFontName:null};ve.ce.Surface.static.cursorHolderTemplate=$('<div>').addClass('ve-ce-cursorHolder').prop('contentEditable','true').append($('<img>').addClass('ve-ce-cursorHolder-img').attr({role:'none',alt:''})).get(0);ve.ce.Surface.static.getClipboardHash=function($elements,beforePasteData){beforePasteData=beforePasteData||{};return $elements.text().slice(beforePasteData.leftText?beforePasteData.leftText.length:0,
beforePasteData.rightText?-beforePasteData.rightText.length:undefined).replace(/\s/gm,'');};ve.ce.Surface.prototype.destroy=function(){var attachedRoot=this.attachedRoot;if(this.isFocused()){this.blur();}this.surfaceObserver.stopTimerLoop();this.surfaceObserver.detach();this.eventSequencer.detach();attachedRoot.setLive(false);this.model.disconnect(this);this.$document.off('focusin focusout',this.onDocumentFocusInOutHandler);this.$document.off('mousedown',this.debounceFocusChange);if(this.hasSelectionChangeEvents){this.$document.off('selectionchange',this.onDocumentSelectionChangeDebounced);}if(this.model.synchronizer){this.model.synchronizer.destroy();this.model.synchronizer.disconnect(this);}this.$window.off('resize',this.onWindowResizeHandler);this.$element.remove();this.$highlights.remove();};ve.ce.Surface.prototype.getOffsetFromEventCoords=function(e){return this.getOffsetFromCoords(e.pageX-this.surface.$scrollContainer.scrollLeft(),e.pageY-this.surface.$scrollContainer.scrollTop()
);};ve.ce.Surface.prototype.getOffsetFromCoords=function(x,y){var doc=this.getElementDocument();try{var offset;if(doc.caretPositionFromPoint){var caretPosition=document.caretPositionFromPoint(x,y);offset=ve.ce.getOffset(caretPosition.offsetNode,caretPosition.offset);}else if(doc.caretRangeFromPoint){var range=document.caretRangeFromPoint(x,y);offset=ve.ce.getOffset(range.startContainer,range.startOffset);}else if(document.body.createTextRange){var textRange=document.body.createTextRange();textRange.moveToPoint(x,y);textRange.pasteHTML('<span class="ve-ce-textRange-drop-marker">&nbsp;</span>');var $marker=$('.ve-ce-textRange-drop-marker');offset=ve.ce.getOffset($marker.get(0),0);$marker.remove();}return offset;}catch(e){return-1;}};ve.ce.Surface.prototype.getSelection=function(selection){if(selection){return ve.ce.Selection.static.newFromModel(selection,this);}else if(!this.selection){this.selection=ve.ce.Selection.static.newFromModel(this.getModel().getSelection(),this);}return this.
selection;};ve.ce.Surface.prototype.getSelectionDirectionality=function(){return this.getSelection().getDirectionality(this.getDocument());};ve.ce.Surface.prototype.initialize=function(){this.attachedRoot.setLive(true);if($.client.profile().layout==='gecko'){try{this.$document[0].execCommand('enableObjectResizing',false,false);this.$document[0].execCommand('enableInlineTableEditing',false,false);}catch(e){}}this.emit('position');};ve.ce.Surface.prototype.setReadOnly=function(readOnly){this.readOnly=!!readOnly;this.$element.toggleClass('ve-ce-surface-readOnly',this.readOnly);this.$element.toggleClass('ve-ce-surface-enabled',!this.readOnly);};ve.ce.Surface.prototype.isReadOnly=function(){return this.readOnly;};ve.ce.Surface.prototype.focus=function(){var surface=this;if(!this.attachedRoot.isLive()){OO.ui.warnDeprecation('Tried to focus an un-initialized surface view. Wait for the ve.ui.Surface `ready` event to fire.');return;}var selection=this.getSelection();if(selection.getModel().
isNull()){this.selectFirstVisibleStartContentOffset();selection=this.getSelection();}if(selection.isFocusedNode()){this.$pasteTarget[0].focus();}else if(selection.isNativeCursor()){var nodeAndOffset;try{nodeAndOffset=this.getDocument().getNodeAndOffset(selection.getModel().getRange().start);}catch(e){nodeAndOffset=null;}if(nodeAndOffset){$(nodeAndOffset.node).closest('[contenteditable=true]')[0].focus();}}this.onModelSelect();setTimeout(function(){if(!surface.isFocused()){surface.selectFirstVisibleStartContentOffset();}});};ve.ce.Surface.prototype.blur=function(){if(this.deactivated){this.getModel().setNullSelection();this.activate();}this.removeRangesAndBlur();this.onFocusChange();if(OO.ui.isMobile()){this.updateActiveAnnotations();this.contexedAnnotations=[];}};ve.ce.Surface.prototype.removeRangesAndBlur=function(){this.nativeSelection.removeAllRanges();if(this.getElementDocument().activeElement===this.$attachedRootNode[0]){this.getElementDocument().activeElement.blur();}};ve.ce.
Surface.prototype.onDocumentFocusInOut=function(e){if(e.target.nodeName.toLowerCase()==='iframe'){return;}this.debounceFocusChange();};ve.ce.Surface.prototype.onFocusChange=function(){var surfaceNodes=[this.$attachedRootNode[0],this.$pasteTarget[0],this.$highlights[0]];var hasFocus=OO.ui.contains(surfaceNodes,this.nativeSelection.anchorNode,true)&&OO.ui.contains(surfaceNodes,document.activeElement,true);if(this.deactivated){if(OO.ui.contains(this.$attachedRootNode[0],this.nativeSelection.anchorNode,true)){this.onDocumentFocus();}}else{if(hasFocus&&!this.isFocused()){this.onDocumentFocus();}if(!hasFocus&&this.isFocused()){this.onDocumentBlur();}}};ve.ce.Surface.prototype.isDeactivated=function(){return this.deactivated;};ve.ce.Surface.prototype.isShownAsDeactivated=function(){return this.deactivated&&!this.showAsActivated;};ve.ce.Surface.prototype.deactivate=function(showAsActivated,noSelectionChange,hideSelection){var surface=this;this.showAsActivated=showAsActivated===undefined||!!
showAsActivated;this.hideSelection=hideSelection;if(!this.deactivated){this.surfaceObserver.disable();this.deactivated=true;this.previousActiveAnnotations=this.activeAnnotations;this.findAndExecuteDelayedSequences();this.$element.addClass('ve-ce-surface-deactivated');if(!noSelectionChange){this.removeRangesAndBlur();setTimeout(function(){if(surface.nativeSelection.rangeCount){surface.removeRangesAndBlur();}});}this.updateDeactivatedSelection();this.clearKeyDownState();this.emit('activation');}};ve.ce.Surface.prototype.activate=function(){if(this.deactivated){this.deactivated=false;this.showAsActivated=false;this.hideSelection=false;this.updateDeactivatedSelection();this.surfaceObserver.enable();this.$element.removeClass('ve-ce-surface-deactivated');if(OO.ui.isMobile()){this.model.emit('contextChange');}var previousSelection=this.getModel().getSelection();if(OO.ui.contains(this.$attachedRootNode[0],this.nativeSelection.anchorNode,true)){this.surfaceObserver.clear();this.surfaceObserver.
pollOnce();}else{this.focusedNode=null;this.onModelSelect();}var newSelection=this.getModel().getSelection();if(previousSelection.getCoveringRange()&&newSelection.getCoveringRange()&&previousSelection.getCoveringRange().containsRange(newSelection.getCoveringRange())){this.getModel().setSelection(previousSelection);if(this.previousActiveAnnotations.length){var annotationClasses=this.previousActiveAnnotations.map(function(ann){return ann.constructor;});this.selectAnnotation(function(view){return ve.isInstanceOfAny(view,annotationClasses);});}}this.emit('activation');}};ve.ce.Surface.prototype.updateDeactivatedSelection=function(){var surface=this,selection=this.getSelection();this.$deactivatedSelection.empty();if(this.deactivated&&selection.isNativeCursor()&&!this.hideSelection){var textColor;var isCollapsed=selection.getModel().isCollapsed();if(isCollapsed){var currentNode=this.getDocument().getBranchNodeFromOffset(selection.getModel().getCoveringRange().start);if(currentNode){textColor
=currentNode.$element.css('color');}}var rects=selection.getSelectionRects();if(rects){rects.forEach(function(rect){var $rect=$('<div>').css({top:rect.top,left:rect.left,width:Math.max(rect.width,1),height:rect.height});if(textColor){$rect.css('background-color',textColor);}surface.$deactivatedSelection.append($rect);});this.$deactivatedSelection.toggleClass('ve-ce-surface-deactivatedSelection-showAsDeactivated',this.isShownAsDeactivated()).toggleClass('ve-ce-surface-deactivatedSelection-collapsed',isCollapsed);}}};ve.ce.Surface.prototype.onDocumentFocus=function(){if(this.getModel().getSelection().isNull()){this.selectFirstVisibleStartContentOffset();}this.eventSequencer.attach(this.$element);this.surfaceObserver.startTimerLoop();this.focused=true;this.activate();this.$element.addClass('ve-ce-surface-focused');this.emit('focus');};ve.ce.Surface.prototype.onDocumentBlur=function(){var nullSelectionOnBlur=this.surface.nullSelectionOnBlur;if(!nullSelectionOnBlur){this.deactivate(false,
true);}this.eventSequencer.detach();this.surfaceObserver.stopTimerLoop();this.surfaceObserver.pollOnce();this.surfaceObserver.clear();this.onDocumentSelectionChange();this.setDragging(false);this.focused=false;if(nullSelectionOnBlur){if(this.focusedNode){this.focusedNode.setFocused(false);this.focusedNode=null;}this.getModel().setNullSelection();}this.$element.removeClass('ve-ce-surface-focused');this.emit('blur');};ve.ce.Surface.prototype.isFocused=function(){return this.focused;};ve.ce.Surface.prototype.onDocumentMouseDown=function(e){var surface=this;if(e.which!==OO.ui.MouseButtons.LEFT){if(e.which===OO.ui.MouseButtons.MIDDLE){this.middleClickSelection=this.getModel().getSelection();this.$document.one('mouseup',function(){setTimeout(function(){surface.middleClickSelection=null;});});}return;}function isContexedNode(view){return surface.surface.context.getRelatedSourcesFromModels([view.model]).length;}var offset=this.getOffsetFromEventCoords(e);if(offset!==-1){var contexedAnnotations
=this.annotationsAtNode(e.target,isContexedNode);if(OO.ui.isMobile()&&contexedAnnotations.length&&(this.focusedNode||!(this.contexedAnnotations.length===contexedAnnotations.length&&this.contexedAnnotations.every(function(ann,i){return ann===contexedAnnotations[i];})))){var node=e.target;setTimeout(function(){surface.getModel().setLinearSelection(new ve.Range(offset));surface.activate();surface.deactivate(false,false,true);surface.updateActiveAnnotations(node);});this.contexedAnnotations=contexedAnnotations;e.preventDefault();return;}this.contexedAnnotations=contexedAnnotations;}this.setDragging(true);this.$document.on('mouseup',this.onDocumentMouseUpHandler);this.surfaceObserver.stopTimerLoop();setTimeout(this.afterDocumentMouseDown.bind(this,e,this.getSelection()));if(e.originalEvent.detail>=3&&!ve.init.platform.constructor.static.isInternetExplorer()){e.preventDefault();var newFragment=this.getModel().getFragment().collapseToStart().expandLinearSelection('closest',ve.dm.
ContentBranchNode).adjustLinearSelection(1,-1);if(!newFragment.isNull()){newFragment.select();}}};ve.ce.Surface.prototype.afterDocumentMouseDown=function(e,selectionBefore){this.surfaceObserver.pollOnce();if(e.shiftKey){this.fixShiftClickSelect(selectionBefore);}};ve.ce.Surface.prototype.onDocumentMouseUp=function(e){this.$document.off('mouseup',this.onDocumentMouseUpHandler);this.surfaceObserver.startTimerLoop();setTimeout(this.afterDocumentMouseUp.bind(this,e,this.getSelection()));};ve.ce.Surface.prototype.afterDocumentMouseUp=function(e,selectionBefore){this.surfaceObserver.pollOnce();if(e.shiftKey){this.fixShiftClickSelect(selectionBefore);}this.setDragging(false);};ve.ce.Surface.prototype.fixShiftClickSelect=function(selectionBefore){if(!selectionBefore.isNativeCursor()){return;}var newSelection=this.getSelection();if(newSelection.getModel().isCollapsed()&&!newSelection.equals(selectionBefore)){this.getModel().setLinearSelection(new ve.Range(selectionBefore.getModel().getRange().
from,newSelection.getModel().getRange().to));}};ve.ce.Surface.prototype.setDragging=function(dragging){this.dragging=!!dragging;this.$element.toggleClass('ve-ce-surface-dragging',this.dragging);};ve.ce.Surface.prototype.onDocumentSelectionChange=function(){if(!this.focused||this.deactivated){return;}this.fixupCursorPosition(0,this.dragging);this.updateActiveAnnotations();this.surfaceObserver.pollOnceSelection();};ve.ce.Surface.prototype.onDocumentDragStart=function(e){this.onCopy(e);this.startRelocation();};ve.ce.Surface.prototype.onDocumentDragOver=function(e){var dataTransferHandlerFactory=this.getSurface().dataTransferHandlerFactory,isContent=true,dataTransfer=e.originalEvent.dataTransfer;if(this.readOnly){return;}var nodeType;if(this.relocatingNode){isContent=this.relocatingNode.isContent();nodeType=this.relocatingNode.getType();}else{if(this.allowedFile===null){this.allowedFile=false;var i,l,item,fakeItem;if(dataTransfer.items){for(i=0,l=dataTransfer.items.length;i<l;i++){item=
dataTransfer.items[i];if(item.kind!=='string'){fakeItem=new ve.ui.DataTransferItem(item.kind,item.type);if(dataTransferHandlerFactory.getHandlerNameForItem(fakeItem)){this.allowedFile=true;break;}}}}else if(dataTransfer.files){for(i=0,l=dataTransfer.files.length;i<l;i++){item=dataTransfer.items[i];fakeItem=new ve.ui.DataTransferItem(item.kind,item.type);if(dataTransferHandlerFactory.getHandlerNameForItem(fakeItem)){this.allowedFile=true;break;}}}else if(Array.prototype.indexOf.call(dataTransfer.types||[],'Files')!==-1){this.allowedFile=true;}}if(this.allowedFile){isContent=false;nodeType='alienBlock';}}function getNearestDropTarget(node){while(node.parent&&!node.parent.isAllowedChildNodeType(nodeType)){node=node.parent;}if(node.parent){node.parent.traverseUpstream(function(n){if(n.shouldIgnoreChildren()){node=null;return false;}});return node;}}if(!isContent){e.preventDefault();var $target=$(e.target).closest('.ve-ce-branchNode, .ve-ce-leafNode');var $dropTarget;var dropPosition;if(
$target.length){var dropTargetNode=getNearestDropTarget($target.data('view'));if(dropTargetNode){$dropTarget=dropTargetNode.$element;dropPosition=e.originalEvent.pageY-$dropTarget.offset().top>$dropTarget.outerHeight()/2?'bottom':'top';}else{var targetOffset=this.getOffsetFromEventCoords(e.originalEvent);if(targetOffset!==-1){dropTargetNode=getNearestDropTarget(this.getDocument().getBranchNodeFromOffset(targetOffset));if(dropTargetNode){$dropTarget=dropTargetNode.$element;dropPosition='top';}}if(!$dropTarget){$dropTarget=this.$lastDropTarget;dropPosition=this.lastDropPosition;}}}if(this.$lastDropTarget&&(!this.$lastDropTarget.is($dropTarget)||dropPosition!==this.lastDropPosition)){this.$dropMarker.addClass('oo-ui-element-hidden');$dropTarget=null;}if($dropTarget&&(!$dropTarget.is(this.$lastDropTarget)||dropPosition!==this.lastDropPosition)){var targetPosition=$dropTarget.position();var top=targetPosition.top+parseFloat($dropTarget.css('margin-top'));var left=targetPosition.left+
parseFloat($dropTarget.css('margin-left'));if(dropPosition==='bottom'){top+=$dropTarget.outerHeight();}this.$dropMarker.css({top:top,left:left}).width($dropTarget.outerWidth()).removeClass('oo-ui-element-hidden');}if($dropTarget!==undefined){this.$lastDropTarget=$dropTarget;this.lastDropPosition=dropPosition;}}};ve.ce.Surface.prototype.onDocumentDragLeave=function(){this.allowedFile=null;if(this.$lastDropTarget){this.$dropMarker.addClass('oo-ui-element-hidden');this.$lastDropTarget=null;this.lastDropPosition=null;}};ve.ce.Surface.prototype.onDocumentDrop=function(e){var surfaceModel=this.getModel(),dataTransfer=e.originalEvent.dataTransfer,$dropTarget=this.$lastDropTarget,dropPosition=this.lastDropPosition,platformKey=ve.getSystemPlatform()==='mac'?'mac':'pc';e.preventDefault();if(this.readOnly){return;}var targetOffset;if($dropTarget){if($dropTarget){var targetRange=$dropTarget.data('view').getModel().getOuterRange();if(dropPosition==='top'){targetOffset=targetRange.start;}else{
targetOffset=targetRange.end;}}else{return;}}else{targetOffset=this.getOffsetFromEventCoords(e.originalEvent);if(targetOffset===-1){return;}}var targetFragment=surfaceModel.getLinearFragment(new ve.Range(targetOffset));var targetViewNode=this.getDocument().getBranchNodeFromOffset(targetFragment.getSelection().getCoveringRange().from);var isMultiline=targetViewNode.isMultiline();if(this.relocatingSelection){var originFragment=surfaceModel.getFragment(this.relocatingSelection);var originData;if(!isMultiline){var slice=this.model.documentModel.shallowCloneFromRange(originFragment.getSelection().getCoveringRange());var linearData=new ve.dm.ElementLinearData(originFragment.getDocument().getStore(),slice.getBalancedData());linearData.sanitize({singleLine:true});originData=linearData.data;if(originData[0].type&&ve.dm.nodeFactory.canNodeContainContent(originData[0].type)){originData=originData.slice(1,originData.length-1);}}else{originData=originFragment.getData();}surfaceModel.pushStaging();
if((platformKey==='pc'&&!e.ctrlKey)||(platformKey==='mac'&&!e.altKey)){originFragment.removeContent();}try{targetFragment.insertContent(originData);surfaceModel.applyStaging();}catch(error){surfaceModel.popStaging();}}else{if(isMultiline){this.handleDataTransfer(dataTransfer,false,targetFragment);}}this.endRelocation();};ve.ce.Surface.prototype.onDocumentKeyDown=function(e){var selection=this.getModel().getSelection(),updateFromModel=false;if(selection.isNull()){return;}if(e.which===229){return;}this.surfaceObserver.stopTimerLoop();this.incRenderLock();try{this.surfaceObserver.pollOnce();}finally{this.decRenderLock();}this.storeKeyDownState(e);if(ve.ce.keyDownHandlerFactory.executeHandlersForKey(e.keyCode,selection.getName(),this,e)){updateFromModel=true;}else{var trigger=new ve.ui.Trigger(e);if(trigger.isComplete()){var executed=this.surface.executeWithSource(trigger,false,'trigger');if(executed||this.isBlockedTrigger(trigger)){e.preventDefault();e.stopPropagation();updateFromModel=
true;}}}if(this.readOnly&&!(ve.ce.LinearArrowKeyDownHandler.static.keys.indexOf(e.keyCode)!==-1||e.keyCode===OO.ui.Keys.TAB||(e.keyCode>=112&&e.keyCode<=123)||e.metaKey||e.ctrlKey||e.altKey)){e.preventDefault();e.stopPropagation();return;}if(!updateFromModel){this.incRenderLock();}try{this.surfaceObserver.pollOnce();}finally{if(!updateFromModel){this.decRenderLock();}}this.surfaceObserver.startTimerLoop();};ve.ce.Surface.prototype.isBlockedTrigger=function(trigger){var triggerString=trigger.toString(),platformKey=ve.getSystemPlatform()==='mac'?'mac':'pc',blockedIfRegisteredTriggers=['tab','shift+tab'],blockedTriggers={mac:['cmd+b','cmd+i','cmd+u','cmd+z','cmd+y','cmd+shift+z','cmd+[','cmd+]'],pc:['ctrl+b','ctrl+i','ctrl+u','ctrl+z','ctrl+y','ctrl+shift+z']};if(blockedIfRegisteredTriggers.indexOf(triggerString)!==-1){return!!this.surface.triggerListener.getCommandByTrigger(triggerString);}return blockedTriggers[platformKey].indexOf(triggerString)!==-1;};ve.ce.Surface.prototype.
onDocumentKeyPress=function(e){var selection;if(e.keyCode===OO.ui.Keys.ENTER&&!this.keyDownState.event&&!((selection=this.getModel().getSelection()).isNull())){this.surfaceObserver.stopTimerLoop();if(ve.ce.keyDownHandlerFactory.executeHandlersForKey(e.keyCode,selection.getName(),this,e)){this.surfaceObserver.pollOnce();}this.surfaceObserver.startTimerLoop();return;}if(e.which===0||e.charCode===0||e.keyCode===OO.ui.Keys.TAB||e.keyCode===OO.ui.Keys.ESCAPE||ve.ce.isShortcutKey(e)){return;}this.handleInsertion();};ve.ce.Surface.prototype.afterDocumentKeyDown=function(e){var keyDownSelectionState,surface=this,documentModel=this.getModel().getDocument(),isArrow=(e.keyCode===OO.ui.Keys.UP||e.keyCode===OO.ui.Keys.DOWN||e.keyCode===OO.ui.Keys.LEFT||e.keyCode===OO.ui.Keys.RIGHT);function getSurroundingFocusableNode(node,offset,dir){var focusNode;if(node.nodeType===Node.TEXT_NODE){focusNode=node;}else if(dir>0&&offset<node.childNodes.length){focusNode=node.childNodes[offset];}else if(dir<0&&
offset>0){focusNode=node.childNodes[offset-1];}else{focusNode=node;}if(ve.isContentEditable(focusNode)){return null;}return $(focusNode).closest('.ve-ce-focusableNode, .ve-ce-tableNode').data('view')||null;}function getDirection(){return(isArrow&&keyDownSelectionState&&ve.compareDocumentOrder(surface.nativeSelection.focusNode,surface.nativeSelection.focusOffset,keyDownSelectionState.focusNode,keyDownSelectionState.focusOffset))||null;}if(e!==this.keyDownState.event){return;}keyDownSelectionState=this.keyDownState.selectionState;this.clearKeyDownState();if((e.keyCode===OO.ui.Keys.BACKSPACE||e.keyCode===OO.ui.Keys.DELETE)&&this.nativeSelection.focusNode){var inNonSlug=this.nativeSelection.focusNode.nodeType===Node.ELEMENT_NODE&&!this.nativeSelection.focusNode.classList.contains('ve-ce-branchNode-inlineSlug');if(inNonSlug){this.incRenderLock();try{this.surfaceObserver.pollOnce();}finally{this.decRenderLock();}var dmSelection=surface.model.getSelection();if(dmSelection instanceof ve.dm.
LinearSelection){var dmFocus=dmSelection.getRange().end;var ceNode=this.documentView.getBranchNodeFromOffset(dmFocus);if(ceNode&&ceNode.getModel().hasSlugAtOffset(dmFocus)){ceNode.setupBlockSlugs();}}}var ceSelection=new ve.SelectionState(this.nativeSelection);this.nativeSelection.removeAllRanges();this.showSelectionState(ceSelection);if(inNonSlug){return;}}if(isArrow&&!(surface.model.getSelection()instanceof ve.dm.LinearSelection)){return;}if(isArrow&&this.restoreActiveNodeSelection()){return;}var $focusNode=$(this.nativeSelection.focusNode);var direction;var focusableNode;var range;if($focusNode.hasClass('ve-ce-cursorHolder')){if($focusNode.hasClass('ve-ce-cursorHolder-after')){direction=-1;focusableNode=$focusNode.prev().data('view');}else{direction=1;focusableNode=$focusNode.next().data('view');}this.removeCursorHolders();}else if(isArrow&&!e.ctrlKey&&!e.altKey&&!e.metaKey&&keyDownSelectionState&&keyDownSelectionState.isCollapsed&&this.nativeSelection.isCollapsed&&(direction=
getDirection())!==null){focusableNode=getSurroundingFocusableNode(this.nativeSelection.focusNode,this.nativeSelection.focusOffset,direction);if(!focusableNode){var startOffset,endOffset,offsetDiff;try{startOffset=ve.ce.getOffset(keyDownSelectionState.focusNode,keyDownSelectionState.focusOffset);endOffset=ve.ce.getOffset(this.nativeSelection.focusNode,this.nativeSelection.focusOffset);offsetDiff=endOffset-startOffset;}catch(ex){startOffset=endOffset=offsetDiff=undefined;}if(Math.abs(offsetDiff)===2){focusableNode=documentModel.documentNode.getNodeFromOffset((startOffset+endOffset)/2);if(focusableNode.isFocusable()){range=new ve.Range(startOffset,endOffset);}else{focusableNode=undefined;}}}}if(isArrow&&direction>0&&this.getActiveNode()instanceof ve.ce.TableCaptionNode&&this.getActiveNode()!==$focusNode.closest('.ve-ce-tableCaptionNode').data('view')){var tableNode=this.getActiveNode().getParent();this.model.setSelection(new ve.dm.TableSelection(tableNode.getOuterRange(),0,0));}if(
focusableNode){if(!range){range=focusableNode.getOuterRange();if(direction<0){range=range.flip();}}if(focusableNode instanceof ve.ce.TableNode){if(direction>0){var captionNode;if((captionNode=focusableNode.getModel().getCaptionNode())){this.model.setLinearSelection(documentModel.getRelativeRange(new ve.Range(captionNode.getRange().start),1));}else{this.model.setSelection(new ve.dm.TableSelection(range,0,0));}}else{var matrix=focusableNode.getModel().getMatrix();var row=matrix.getRowCount()-1;var col=matrix.getColCount(row)-1;this.model.setSelection(new ve.dm.TableSelection(range,col,row));}}else{this.model.setLinearSelection(range);}if(e.keyCode===OO.ui.Keys.LEFT){this.cursorDirectionality=direction>0?'rtl':'ltr';}else if(e.keyCode===OO.ui.Keys.RIGHT){this.cursorDirectionality=direction<0?'rtl':'ltr';}}if(direction===undefined){direction=getDirection();}var fixupCursorForUnicorn=(!e.shiftKey&&(e.keyCode===OO.ui.Keys.LEFT||e.keyCode===OO.ui.Keys.RIGHT));var removedUnicorns=this.
cleanupUnicorns(fixupCursorForUnicorn);if(removedUnicorns){this.surfaceObserver.pollOnceNoCallback();}else{this.incRenderLock();try{this.surfaceObserver.pollOnce();}finally{this.decRenderLock();}}this.fixupCursorPosition(direction,e.shiftKey);};ve.ce.Surface.prototype.cleanupUnicorns=function(fixupCursor){if(!this.unicorningNode||!this.unicorningNode.unicorns){return false;}var preUnicorn=this.unicorningNode.unicorns[0];if(!this.$attachedRootNode[0].contains(preUnicorn)){return false;}if(this.nativeSelection.rangeCount===0){return false;}var range=this.nativeSelection.getRangeAt(0);var node=range.endContainer;if(node.nodeType===Node.ELEMENT_NODE){node=range.endOffset>0?node.childNodes[range.endOffset-1]:null;}while(node!==null&&node.nodeType===Node.TEXT_NODE){node=node.previousSibling;}if(node===preUnicorn){return false;}var fixup;if(ve.compareDocumentOrder(range.endContainer,range.endOffset,preUnicorn.parentNode,ve.parentIndex(preUnicorn))<=0){fixup=-1;}else{fixup=1;}var
contentBranchNodeBefore=this.getSelectedContentBranchNode();if(this.unicorningNode!==contentBranchNodeBefore){this.setNotUnicorningAll();return true;}var veRange=ve.ce.veRangeFromSelection(this.nativeSelection);if(veRange){this.incRenderLock();try{this.changeModel(null,new ve.dm.LinearSelection(veRange));if(fixupCursor){this.moveModelCursor(fixup);}}finally{this.decRenderLock();}}var contentBranchNodeAfter=this.getSelectedContentBranchNode();if(contentBranchNodeAfter){contentBranchNodeAfter.renderContents();}if(contentBranchNodeBefore&&contentBranchNodeBefore!==contentBranchNodeAfter){contentBranchNodeBefore.renderContents();}this.showModelSelection();return true;};ve.ce.Surface.prototype.onDocumentKeyUp=function(){this.emit('keyup');};ve.ce.Surface.prototype.onCut=function(e){var surface=this,selection=this.getModel().getSelection();if(selection.isCollapsed()){return;}this.onCopy(e);setTimeout(function(){ve.ce.keyDownHandlerFactory.executeHandlersForKey(OO.ui.Keys.BACKSPACE,selection.
getName(),surface,e);});};ve.ce.Surface.prototype.onCopy=function(e,selection){var isClipboard=e.type==='copy'||e.type==='cut',view=this,htmlDoc=this.getModel().getDocument().getHtmlDocument(),clipboardData=isClipboard?e.originalEvent.clipboardData:e.originalEvent.dataTransfer;selection=selection||this.getModel().getSelection();this.$pasteTarget.empty();if(selection.isCollapsed()){return;}var slice=this.model.documentModel.shallowCloneFromSelection(selection);slice.data.cloneElements(true);ve.dm.converter.getDomSubtreeFromModel(slice,this.$pasteTarget[0],ve.dm.Converter.static.CLIPBOARD_MODE);this.$pasteTarget.find('span').addClass('ve-pasteProtect');if(this.$pasteTarget.text()===''){this.$pasteTarget.find('*:not( :has( * ) )').text('\u00a0');}ve.resolveAttributes(this.$pasteTarget[0],htmlDoc,ve.dm.Converter.static.computedAttributes);var unsafeSelector='['+ve.ce.Surface.static.unsafeAttributes.join('],[')+']';this.$pasteTarget.find(unsafeSelector).each(function(){var i,val,attrs={},ua
=ve.ce.Surface.static.unsafeAttributes;i=ua.length;while(i--){val=this.getAttribute(ua[i]);if(val!==null){attrs[ua[i]]=val;}}this.setAttribute('data-ve-attributes',JSON.stringify(attrs));});this.clipboardIndex++;var clipboardKey=this.clipboardId+'-'+this.clipboardIndex;this.clipboard={slice:slice,hash:null};if(isClipboard&&!ve.isClipboardDataFormatsSupported(e)){this.$pasteTarget.prepend($('<span>').attr('data-ve-clipboard-key',clipboardKey).text('\u00a0'));this.clipboard.hash=this.constructor.static.getClipboardHash(this.$pasteTarget.contents());}if(clipboardData&&!ve.init.platform.constructor.static.isEdge()){if(isClipboard){e.preventDefault();}if(isClipboard&&ve.isClipboardDataFormatsSupported(e,true)){clipboardData.setData('text/xcustom',clipboardKey);}try{clipboardData.setData('text/html',this.$pasteTarget.html());clipboardData.setData('text/plain',this.$pasteTarget[0].innerText||this.$pasteTarget.text()||' ');}catch(err){}}else{if(this.getSelection().isNativeCursor()){var
originalSelection=new ve.SelectionState(this.nativeSelection);var scrollTop=this.surface.$scrollContainer.scrollTop();this.surfaceObserver.disable();ve.selectElement(this.$pasteTarget[0]);this.surface.$scrollContainer.scrollTop(scrollTop);setTimeout(function(){if(!OO.ui.contains(view.$highlights[0],originalSelection.focusNode,true)){view.$attachedRootNode[0].focus();view.showSelectionState(originalSelection);view.surface.$scrollContainer.scrollTop(scrollTop);}view.surfaceObserver.clear();view.surfaceObserver.enable();});}else{ve.selectElement(this.$pasteTarget[0]);}}ve.track('activity.clipboard',{action:e.type});};ve.ce.Surface.prototype.onPaste=function(e){var surface=this;if(this.pasting||this.readOnly){return false;}this.beforePaste(e);this.surfaceObserver.disable();this.pasting=true;setTimeout(function(){var afterPastePromise=ve.createDeferred().resolve().promise();try{if(!e.isDefaultPrevented()){afterPastePromise=surface.afterPaste(e);}}finally{afterPastePromise.always(function(){
surface.surfaceObserver.clear();surface.surfaceObserver.enable();surface.pasting=false;surface.pasteSpecial=false;surface.beforePasteData=null;ve.track('activity.clipboard',{action:'paste'});});}});};ve.ce.Surface.prototype.beforePaste=function(e){var selection=this.getModel().getSelection(),clipboardData=e.originalEvent.clipboardData,surfaceModel=this.getModel(),fragment=surfaceModel.getFragment(),documentModel=surfaceModel.getDocument();var range;if(selection instanceof ve.dm.LinearSelection){range=fragment.getSelection().getRange();}else if(selection instanceof ve.dm.TableSelection){range=new ve.Range(selection.getRanges(documentModel)[0].start);}else{e.preventDefault();return;}this.beforePasteData={};if(this.middleClickSelection){if(!this.middleClickSelection.isCollapsed()){this.clipboardIndex++;this.clipboard={slice:this.model.documentModel.shallowCloneFromSelection(this.middleClickSelection),hash:null};}if(this.clipboard){this.beforePasteData.custom=this.clipboardId+'-'+this.
clipboardIndex;}}else if(clipboardData){if(this.handleDataTransfer(clipboardData,true)){e.preventDefault();return;}this.beforePasteData.custom=clipboardData.getData('text/xcustom');this.beforePasteData.html=clipboardData.getData('text/html');if(this.beforePasteData.html){this.beforePasteData.html=this.beforePasteData.html.replace(/^[\s\S]*<!-- *StartFragment *-->/,'').replace(/<!-- *EndFragment *-->[\s\S]*$/,'');}}this.beforePasteData.scrollTop=this.surface.$scrollContainer.scrollTop();this.$pasteTarget.empty();var startNode=documentModel.getBranchNodeFromOffset(range.start);if(startNode.canContainContent()){var textStart=0,textEnd=0;var contextElement=startNode.getClonedElement();$(documentModel.getStore().value(contextElement.originalDomElementsHash)).removeAttr('id typeof rel');var context=[contextElement];var leftText,rightText;if(range.start>startNode.getRange().start){leftText='☀';context.push(leftText);textStart=textEnd=1;}var endNode=documentModel.getBranchNodeFromOffset(
range.end);if(range.end<endNode.getRange().end){rightText='☂';context.push(rightText);}if(!leftText&&!rightText){context.push('☁');textEnd=1;}context.push({type:'/'+context[0].type});delete contextElement.internal;ve.dm.converter.getDomSubtreeFromModel(documentModel.cloneWithData(context,true),this.$pasteTarget[0]);this.$pasteTarget[0].focus();var nativeRange=this.getElementDocument().createRange();var textNode=this.$pasteTarget.children().contents()[0];nativeRange.setStart(textNode,textStart);nativeRange.setEnd(textNode,textEnd);this.nativeSelection.removeAllRanges();this.nativeSelection.addRange(nativeRange);this.beforePasteData.context=context;this.beforePasteData.leftText=leftText;this.beforePasteData.rightText=rightText;}else{this.$pasteTarget[0].focus();}this.surface.$scrollContainer.scrollTop(this.beforePasteData.scrollTop);};ve.ce.Surface.prototype.afterPaste=function(){var surfaceModel=this.getModel(),documentModel=surfaceModel.getDocument(),fragment=surfaceModel.
getFragment(),targetFragment=surfaceModel.getFragment(null,true),view=this,beforePasteData=this.beforePasteData||{},done=ve.createDeferred().resolve().promise();if(!this.nativeSelection.isCollapsed){return done;}if(this.getModel().getFragment().isNull()){return done;}this.$pasteTarget.find('style').remove();var pasteData=this.afterPasteExtractClipboardData();if(fragment.getSelection()instanceof ve.dm.TableSelection){if(fragment.getSelection()instanceof ve.dm.TableSelection&&pasteData.slice instanceof ve.dm.TableSlice){var tableAction=new ve.ui.TableAction(this.getSurface());tableAction.importTable(pasteData.slice.getTableNode(documentModel));return ve.createDeferred().resolve().promise();}targetFragment=surfaceModel.getLinearFragment(fragment.getSelection().getRanges(documentModel)[0],true);}var isMultiline=this.getDocument().getBranchNodeFromOffset(targetFragment.getSelection().getCoveringRange().from).isMultiline();var pending;if(pasteData.slice){pending=this.
afterPasteAddToFragmentFromInternal(pasteData.slice,fragment,targetFragment,isMultiline);}else{pending=this.afterPasteAddToFragmentFromExternal(pasteData.clipboardKey,pasteData.$clipboardHtml,fragment,targetFragment,isMultiline);}return pending.then(function(){if(view.getSelection().isNativeCursor()){view.$attachedRootNode[0].focus();view.surface.$scrollContainer.scrollTop(beforePasteData.scrollTop);setTimeout(function(){view.surface.$scrollContainer.scrollTop(beforePasteData.scrollTop);});}if(fragment.getSelection()instanceof ve.dm.LinearSelection){targetFragment.collapseToEnd().select();view.findAndExecuteSequences(true);}});};ve.ce.Surface.prototype.afterPasteExtractClipboardData=function(){var clipboardKey,clipboardHash,$clipboardHtml,beforePasteData=this.beforePasteData||{};if(beforePasteData.custom){clipboardKey=beforePasteData.custom;}else{if(beforePasteData.html){$clipboardHtml=$(ve.sanitizeHtml(beforePasteData.html)).filter(function(){var val=this.getAttribute&&this.
getAttribute('data-ve-clipboard-key');if(val){clipboardKey=val;return false;}return true;});clipboardHash=this.constructor.static.getClipboardHash($clipboardHtml);}else{clipboardKey=this.$pasteTarget.find('span[data-ve-clipboard-key]').data('ve-clipboard-key');clipboardHash=this.constructor.static.getClipboardHash(this.$pasteTarget,beforePasteData);}}var slice;if(clipboardKey===this.clipboardId+'-'+this.clipboardIndex){if(beforePasteData.custom||clipboardHash===this.clipboard.hash){slice=this.clipboard.slice;slice.data.cloneElements(true);}}if(!slice&&!$clipboardHtml&&beforePasteData.html){$clipboardHtml=$(ve.sanitizeHtml(beforePasteData.html));}return{clipboardKey:clipboardKey,$clipboardHtml:$clipboardHtml,slice:slice};};ve.ce.Surface.prototype.afterPasteSanitize=function(linearData,isMultiline,isExternal){var importRules=this.afterPasteImportRules(isMultiline);if(isExternal){linearData.sanitize(importRules.external||{});}linearData.sanitize(importRules.all||{});};ve.ce.Surface.
prototype.afterPasteImportRules=function(isMultiline){var importRules=!this.pasteSpecial?this.getSurface().getImportRules():{all:{plainText:true,keepEmptyContentBranches:true}};if(!isMultiline){importRules={all:ve.extendObject({},importRules.all,{singleLine:true}),external:ve.extendObject({},importRules.external,{singleLine:true})};}return importRules;};ve.ce.Surface.prototype.afterPasteAddToFragmentFromInternal=function(slice,fragment,targetFragment,isMultiline){if(fragment.getSelection()instanceof ve.dm.TableSelection){targetFragment.removeContent();}var linearData,insertionPromise;if(isMultiline){linearData=new ve.dm.ElementLinearData(slice.getStore(),ve.copy(slice.getOriginalData()));if(this.pasteSpecial){this.afterPasteSanitize(linearData,isMultiline);}try{insertionPromise=this.afterPasteInsertInternalData(targetFragment,linearData.getData());}catch(e){}}if(!insertionPromise){linearData=new ve.dm.ElementLinearData(slice.getStore(),ve.copy(slice.getBalancedData()));if(this.
pasteSpecial||!isMultiline){this.afterPasteSanitize(linearData,isMultiline);}var data=linearData.getData();if(!isMultiline){if(data[0].type){data=data.slice(1,data.length-1);}}insertionPromise=this.afterPasteInsertInternalData(targetFragment,data);}return insertionPromise;};ve.ce.Surface.prototype.afterPasteInsertInternalData=function(targetFragment,data){targetFragment.insertContent(data,true);return targetFragment.getPending();};ve.ce.Surface.prototype.afterPasteAddToFragmentFromExternal=function(clipboardKey,$clipboardHtml,fragment,targetFragment,isMultiline,forceClipboardData){var importantElement='[id],[typeof],[rel],figure',items=[],surfaceModel=this.getModel(),documentModel=surfaceModel.getDocument(),beforePasteData=this.beforePasteData||{};var htmlDoc;if($clipboardHtml&&(forceClipboardData||clipboardKey==='useClipboardData-0'||$clipboardHtml.find(importantElement).addBack(importantElement).length>this.$pasteTarget.find(importantElement).length)){htmlDoc=ve.
sanitizeHtmlToDocument(beforePasteData.html);$(htmlDoc).find('span').removeClass('ve-pasteProtect').end().find('span[data-ve-clipboard-key]').remove().end().find('[data-ve-attributes]').removeAttr('data-ve-attributes');beforePasteData.context=null;}if(!htmlDoc){htmlDoc=ve.sanitizeHtmlToDocument(this.$pasteTarget.html());}var $body=$(htmlDoc.body);var $images=$body.children('img[src^=data\\:]');if($images.length&&$images.length===$body.children().length){for(var i=0;i<$images.length;i++){items.push(ve.ui.DataTransferItem.static.newFromDataUri($images.eq(i).attr('src'),$images[i].outerHTML));}if(this.handleDataTransferItems(items,true)){return ve.createDeferred().resolve().promise();}}this.afterPasteSanitizeExternal($(htmlDoc.body));$(htmlDoc.body).find('ul > ul, ul > ol, ol > ul, ol > ol').each(function(){if(this.previousElementSibling){this.previousElementSibling.appendChild(this);}else{$(this).wrap('<li>');}});$(htmlDoc.body).find('li, dd, dt').each(function(){var list,listType={li:
'ul',dd:'dl',dt:'dl'},tag=this.tagName.toLowerCase(),parentTag=this.parentNode.tagName.toLowerCase();if((tag==='li'&&(parentTag!=='ul'&&parentTag!=='ol'))||((tag==='dd'||tag==='dt')&&parentTag!=='dl')){list=htmlDoc.createElement(listType[tag]);this.parentNode.insertBefore(list,this);while(list.nextElementSibling&&listType[list.nextElementSibling.tagName.toLowerCase()]===listType[tag]){list.appendChild(list.nextElementSibling);}}});var htmlBlacklist=ve.getProp(this.afterPasteImportRules(isMultiline),'external','htmlBlacklist');if(htmlBlacklist&&!clipboardKey){if(htmlBlacklist.remove){Object.keys(htmlBlacklist.remove).forEach(function(selector){if(htmlBlacklist.remove[selector]){$(htmlDoc.body).find(selector).remove();}});}if(htmlBlacklist.unwrap){Object.keys(htmlBlacklist.unwrap).forEach(function(selector){if(htmlBlacklist.unwrap[selector]){$(htmlDoc.body).find(selector).contents().unwrap();}});}}var pastedDocumentModel=ve.dm.converter.getModelFromDom(htmlDoc,{targetDoc:documentModel.
getHtmlDocument(),fromClipboard:true});var data=pastedDocumentModel.data;data.cloneElements(true);this.afterPasteSanitize(data,isMultiline,!clipboardKey);data.remapInternalListKeys(documentModel.getInternalList());pastedDocumentModel.buildNodeTree();if(fragment.getSelection()instanceof ve.dm.TableSelection){if(pastedDocumentModel.documentNode.children.length===2&&pastedDocumentModel.documentNode.children[0]instanceof ve.dm.TableNode){var tableAction=new ve.ui.TableAction(this.getSurface());tableAction.importTable(pastedDocumentModel.documentNode.children[0],true);return ve.createDeferred().resolve().promise();}targetFragment.removeContent();}var contextRange;if(beforePasteData.context){contextRange=this.afterPasteFromExternalContextRange(pastedDocumentModel,isMultiline,forceClipboardData);if(!contextRange){return this.afterPasteAddToFragmentFromExternal(clipboardKey,$clipboardHtml,fragment,targetFragment,isMultiline,true);}}else{contextRange=pastedDocumentModel.getDocumentRange();}var
pastedNodes=pastedDocumentModel.selectNodes(contextRange,'siblings').filter(function(node){return!(node.range&&node.range.isCollapsed());});if(pastedNodes.length===1&&pastedNodes[0].node.canContainContent()){if(contextRange.containsRange(pastedNodes[0].nodeRange)){contextRange=pastedNodes[0].nodeRange;}}return this.afterPasteInsertExternalData(targetFragment,pastedDocumentModel,contextRange);};ve.ce.Surface.prototype.afterPasteInsertExternalData=function(targetFragment,pastedDocumentModel,contextRange){var handled;if(pastedDocumentModel.data.isPlainText(contextRange,true,undefined,true)){var pastedText=pastedDocumentModel.data.getText(true,contextRange);if(pastedText){handled=this.handleDataTransferItems([ve.ui.DataTransferItem.static.newFromString(pastedText)],true,targetFragment);}}if(!handled){targetFragment.insertDocument(pastedDocumentModel,contextRange,true);}return targetFragment.getPending();};ve.ce.Surface.prototype.afterPasteFromExternalContextRange=function(
pastedDocumentModel,isMultiline,forceClipboardData){var data=pastedDocumentModel.data,documentRange=pastedDocumentModel.getDocumentRange(),beforePasteData=this.beforePasteData||{},context=new ve.dm.ElementLinearData(pastedDocumentModel.getStore(),ve.copy(beforePasteData.context));this.afterPasteSanitize(context,isMultiline);var leftText=beforePasteData.leftText;var rightText=beforePasteData.rightText;var left=0;while(context.getLength()&&ve.dm.ElementLinearData.static.compareElementsUnannotated(data.getData(left),data.isElementData(left)?context.getData(0):leftText)){if(!data.isElementData(left)){leftText='';}left++;context.splice(0,1);}var right=documentRange.end;while(right>0&&context.getLength()&&ve.dm.ElementLinearData.static.compareElementsUnannotated(data.getData(right-1),data.isElementData(right-1)?context.getData(context.getLength()-1):rightText)){if(!data.isElementData(right-1)){rightText='';}right--;context.splice(context.getLength()-1,1);}if((leftText||rightText)&&!
forceClipboardData){return false;}while(right>0&&data.getType(right-1)==='break'){right--;}return new ve.Range(left,right);};ve.ce.Surface.prototype.afterPasteSanitizeExternal=function($element){var metadataIdRegExp=ve.init.platform.getMetadataIdRegExp();$element.find('span[data-ve-clipboard-key]').remove();$element.find('style').remove();$element.find('span').each(function(i,node){if(!node.style){return;}var $node=$(node);if(+node.style.fontWeight>=700||node.style.fontWeight==='bold'){$node.wrap('<b>');}if(node.style.fontStyle==='italic'){$node.wrap('<i>');}if(node.style.textDecorationLine==='underline'){$node.wrap('<u>');}if(node.style.textDecorationLine==='line-through'){$node.wrap('<s>');}if(node.style.verticalAlign==='super'){$node.wrap('<sup>');}if(node.style.verticalAlign==='sub'){$node.wrap('<sub>');}});$element.find('[style]').removeAttr('style');if(metadataIdRegExp){$element.find('[id]').each(function(){var $this=$(this);if(metadataIdRegExp.test($this.attr('id'))){$this.
removeAttr('id');}});}$element.find('span').each(function(){var $this=$(this);$this.removeClass('ve-pasteProtect');if($this.attr('class')===''){$this.removeAttr('class');}if(!this.attributes.length){$this.replaceWith(this.childNodes);}});$element.find('[data-ve-attributes]').each(function(){var attrsJSON=this.getAttribute('data-ve-attributes');this.removeAttribute('data-ve-attributes');var attrs;try{attrs=JSON.parse(attrsJSON);}catch(err){return;}$(this).attr(attrs);});};ve.ce.Surface.prototype.handleDataTransfer=function(dataTransfer,isPaste,targetFragment){var items=[],htmlStringData=dataTransfer.getData('text/html'),htmlPreParse,imgCount=0,hasContent=false;var i,l;if(!htmlStringData){if(dataTransfer.items){for(i=0,l=dataTransfer.items.length;i<l;i++){if(dataTransfer.items[i].kind!=='string'){items.push(ve.ui.DataTransferItem.static.newFromItem(dataTransfer.items[i],htmlStringData));}}}else if(dataTransfer.files){for(i=0,l=dataTransfer.files.length;i<l;i++){items.push(ve.ui.
DataTransferItem.static.newFromBlob(dataTransfer.files[i],htmlStringData));}}}else if(dataTransfer.files){htmlPreParse=$.parseHTML(htmlStringData);for(i=0;i<htmlPreParse.length;i++){if(htmlPreParse[i].nodeName==='IMG'){imgCount++;}else if((htmlPreParse[i].nodeType===1||htmlPreParse[i].nodeType===3)&&htmlPreParse[i].textContent&&htmlPreParse[i].textContent.trim()!==''){hasContent=true;}if(typeof htmlPreParse[i].querySelectorAll==='function'){imgCount+=htmlPreParse[i].querySelectorAll('img').length;}}if(!hasContent&&imgCount===dataTransfer.files.length){for(i=0,l=dataTransfer.files.length;i<l;i++){items.push(ve.ui.DataTransferItem.static.newFromBlob(dataTransfer.files[i],htmlStringData));}}}if(dataTransfer.items){for(i=0,l=dataTransfer.items.length;i<l;i++){if(dataTransfer.items[i].kind==='string'&&dataTransfer.items[i].type.slice(0,5)==='text/'){items.push(ve.ui.DataTransferItem.static.newFromString(dataTransfer.getData(dataTransfer.items[i].type),dataTransfer.items[i].type,
htmlStringData));}}}var pushItemToBack=function(array,type){var j,jlen;for(j=0,jlen=array.length;j<jlen;j++){if(array[j].type===type){return array.push(array.splice(j,1)[0]);}}};pushItemToBack(items,'text/html');pushItemToBack(items,'text/plain');return this.handleDataTransferItems(items,isPaste,targetFragment);};ve.ce.Surface.prototype.handleDataTransferItems=function(items,isPaste,targetFragment){var dataTransferHandlerFactory=this.getSurface().dataTransferHandlerFactory,handled=false;targetFragment=targetFragment||this.getModel().getFragment();function insert(docOrData){var resultFragment,rootChildren;resultFragment=!isPaste?targetFragment.collapseToEnd():targetFragment;if(docOrData instanceof ve.dm.Document){rootChildren=docOrData.getDocumentNode().children;if(rootChildren[0]&&rootChildren[0].type==='paragraph'&&(!rootChildren[1]||rootChildren[1].type==='internalList')){resultFragment.insertDocument(docOrData,rootChildren[0].getRange());}else{resultFragment.insertDocument(docOrData
);}}else{resultFragment.insertContent(docOrData);}resultFragment.collapseToEnd().select();}for(var i=0,l=items.length;i<l;i++){var item=items[i];var name=dataTransferHandlerFactory.getHandlerNameForItem(item,isPaste,this.pasteSpecial);if(name){dataTransferHandlerFactory.create(name,this.surface,item).getInsertableData().done(insert);handled=true;break;}else if(isPaste&&item.type==='text/html'){break;}}return handled;};ve.ce.Surface.prototype.selectAll=function(){var selection=this.getModel().getSelection(),dmDoc=this.getModel().getDocument();if(selection instanceof ve.dm.LinearSelection){var activeNode=this.getActiveNode();var range;if(activeNode){range=activeNode.getRange();range=new ve.Range(range.from+1,range.to-1);}else{var documentRange=this.getModel().getDocument().getDocumentRange();range=new ve.Range(dmDoc.getNearestCursorOffset(0,1),dmDoc.getNearestCursorOffset(documentRange.end,-1));}this.getModel().setLinearSelection(range);}else if(selection instanceof ve.dm.TableSelection)
{var matrix=selection.getTableNode(dmDoc).getMatrix();this.getModel().setSelection(new ve.dm.TableSelection(selection.tableRange,0,0,matrix.getMaxColCount()-1,matrix.getRowCount()-1));}};ve.ce.Surface.prototype.onDocumentInput=function(e){var surface=this,inputType=e.originalEvent?e.originalEvent.inputType:null,inputTypeCommands=this.constructor.static.inputTypeCommands;if(this.getSelection().isNativeCursor()&&(inputType==='insertText'||inputType==='insertCompositionText')&&e.originalEvent.data==='\u00a0'){setTimeout(function(){var fragment=surface.getModel().getFragment().adjustLinearSelection(-1),nbspContent='&nbsp;';if(surface.getSurface().getMode()==='visual'){nbspContent=ve.init.platform.decodeEntities(nbspContent);}if(fragment.getText()===' '){fragment.insertContent(nbspContent).collapseToEnd().select();}});}if(inputType&&Object.prototype.hasOwnProperty.call(inputTypeCommands,inputType)){if(inputTypeCommands[inputType]){this.getSurface().executeCommand(this.constructor.static.
inputTypeCommands[inputType]);}e.preventDefault();return;}this.incRenderLock();try{this.surfaceObserver.pollOnce();}finally{this.decRenderLock();}};ve.ce.Surface.prototype.onDocumentCompositionStart=function(){if(this.model.selection instanceof ve.dm.TableSelection&&$.client.profile().layout==='gecko'){return;}this.handleInsertion();};ve.ce.Surface.prototype.onModelSelect=function(){var selection=this.getModel().getSelection();setTimeout(this.findAndExecuteDelayedSequences.bind(this));this.cursorDirectionality=null;this.contentBranchNodeChanged=false;this.selection=null;if(selection.isNull()){this.removeCursorHolders();}if(selection instanceof ve.dm.LinearSelection){var blockSlug=this.findBlockSlug(selection.getRange());if(blockSlug!==this.focusedBlockSlug){if(this.focusedBlockSlug){this.focusedBlockSlug.classList.remove('ve-ce-branchNode-blockSlug-focused');this.focusedBlockSlug=null;}if(blockSlug){blockSlug.classList.add('ve-ce-branchNode-blockSlug-focused');this.focusedBlockSlug=
blockSlug;this.preparePasteTargetForCopy();}}var focusedNode=this.findFocusedNode(selection.getRange());if(this.isDeactivated()&&!this.isShownAsDeactivated()&&!blockSlug&&!focusedNode){this.activate();}if(focusedNode!==this.focusedNode){if(this.focusedNode){this.focusedNode.setFocused(false);this.focusedNode=null;}if(focusedNode){focusedNode.setFocused(true);this.focusedNode=focusedNode;if(!this.dragging){this.preparePasteTargetForCopy();this.surfaceObserver.clear();}}}}else{if(selection instanceof ve.dm.TableSelection){this.preparePasteTargetForCopy();}if(this.focusedNode){this.focusedNode.setFocused(false);}this.focusedNode=null;}if(this.isReadOnly()&&OO.ui.isMobile()){this.deactivate(false,false,true);}if(!this.isRenderingLocked()&&selection!==this.newModelSelection){this.showModelSelection();this.cleanupUnicorns(false);}this.surfaceObserver.pollOnceNoCallback();};ve.ce.Surface.prototype.preparePasteTargetForCopy=function(force){if(force||!OO.ui.isMobile()){this.$pasteTarget.text((
this.focusedNode&&this.focusedNode.$element.text().trim())||'☢');ve.selectElement(this.$pasteTarget[0]);this.$pasteTarget[0].focus();}else{this.deactivate(true);}};ve.ce.Surface.prototype.getFocusedNode=function(range){if(!range){return this.focusedNode;}var selection=this.getModel().getSelection();if(selection instanceof ve.dm.LinearSelection&&range.equalsSelection(selection.getRange())){return this.focusedNode;}return this.findFocusedNode(range);};ve.ce.Surface.prototype.findBlockSlug=function(range){if(!range.isCollapsed()){return null;}var node=this.documentView.getBranchNodeFromOffset(range.end);if(!node||!node.canHaveChildrenNotContent()){return null;}return node.getSlugAtOffset(range.end);};ve.ce.Surface.prototype.findFocusedNode=function(range){var documentNode=this.getDocument().getDocumentNode();var startNode;if(!range.isCollapsed()){startNode=documentNode.getNodeFromOffset(range.start+1);if(startNode&&startNode.isFocusable()){var endNode=documentNode.getNodeFromOffset(
range.end-1);if(startNode===endNode){return startNode;}}}else{startNode=documentNode.getNodeFromOffset(range.start);if(startNode&&startNode.isFocusable()){return startNode;}}return null;};ve.ce.Surface.prototype.onModelDocumentUpdate=function(){var surface=this;if(this.contentBranchNodeChanged){this.onModelSelect();}this.surfaceObserver.pollOnceNoCallback();setTimeout(function(){surface.emit('position');});};ve.ce.Surface.prototype.onInsertionAnnotationsChange=function(){var changed=this.renderSelectedContentBranchNode();if(!changed){return;}this.forceShowModelSelection();this.surfaceObserver.pollOnceNoCallback();};ve.ce.Surface.prototype.getSelectedContentBranchNode=function(){var selection=this.model.getSelection();if(!(selection instanceof ve.dm.LinearSelection)){return null;}var node=this.documentView.getBranchNodeFromOffset(selection.getRange().to);if(!node||!(node instanceof ve.ce.ContentBranchNode)){return null;}return node;};ve.ce.Surface.prototype.
renderSelectedContentBranchNode=function(){var node=this.getSelectedContentBranchNode();if(!node){return false;}return node.renderContents();};ve.ce.Surface.prototype.handleObservedChanges=function(oldState,newState){var surface=this,dmDoc=this.getModel().getDocument(),insertedText=false,removedText=false;if(newState.contentChanged){if(this.readOnly){newState.node.renderContents();this.showModelSelection();return;}else{var transaction=newState.textState.getChangeTransaction(oldState.textState,dmDoc,newState.node.getOffset(),newState.node.unicornAnnotations);if(transaction){this.incRenderLock();try{this.changeModel(transaction);}finally{this.decRenderLock();}insertedText=transaction.operations.some(function(op){return op.type==='replace'&&op.insert.length;});removedText=transaction.operations.some(function(op){return op.type==='replace'&&op.remove.length;});}}}if(!this.readOnly&&newState.branchNodeChanged&&oldState&&oldState.node&&oldState.node.root&&oldState.node instanceof ve.ce.
ContentBranchNode){oldState.node.renderContents();}if(newState.selectionChanged&&!(oldState&&oldState.veRange&&newState.veRange&&!newState.veRange.isCollapsed()&&oldState.veRange.equalsSelection(newState.veRange))){var newSelection;if(newState.veRange){if(newState.veRange.isCollapsed()){var offset=dmDoc.getNearestCursorOffset(newState.veRange.from,0);if(offset===-1){newSelection=new ve.dm.NullSelection();}else{newSelection=new ve.dm.LinearSelection(new ve.Range(offset));}}else{newSelection=new ve.dm.LinearSelection(newState.veRange);}}else{newSelection=new ve.dm.NullSelection();}this.incRenderLock();try{this.changeModel(null,newSelection);if(newSelection instanceof ve.dm.LinearSelection&&newSelection.isCollapsed()){var blockSlug=this.findBlockSlug(newSelection.getRange());if(blockSlug){this.preparePasteTargetForCopy();this.surfaceObserver.pollOnceNoCallback();}}}finally{this.decRenderLock();}var removedUnicorns=this.cleanupUnicorns(false);if(removedUnicorns){this.surfaceObserver.
pollOnceNoCallback();}var activeNode=this.getActiveNode();var coveringRange=newSelection.getCoveringRange();if(activeNode&&coveringRange){var nodeRange=activeNode.getRange();var containsStart=nodeRange.containsRange(new ve.Range(coveringRange.start));var containsEnd=nodeRange.containsRange(new ve.Range(coveringRange.end));if(containsStart!==containsEnd){newSelection=oldState&&oldState.veRange?new ve.dm.LinearSelection(oldState.veRange):new ve.dm.NullSelection();setTimeout(function(){surface.changeModel(null,newSelection);surface.showModelSelection();});}}while(this.nativeSelection.rangeCount>1){this.nativeSelection.removeRange(this.nativeSelection.getRangeAt(0));}}if(insertedText){surface.afterRenderLock(function(){surface.findAndExecuteSequences();surface.maybeSetBreakpoint();});}else if(removedText){surface.afterRenderLock(function(){surface.findAndExecuteSequences(false,true);surface.maybeSetBreakpoint();});}if(newState.branchNodeChanged&&newState.node){this.updateCursorHolders();
this.showModelSelection();}if(!insertedText){surface.getModel().breakpoint();}};ve.ce.Surface.prototype.createSlug=function(element){var surface=this,offset=ve.ce.getOffsetOfSlug(element),documentModel=this.getModel().getDocument();this.changeModel(ve.dm.TransactionBuilder.static.newFromInsertion(documentModel,offset,[{type:'paragraph',internal:{generated:'slug'}},{type:'/paragraph'}]),new ve.dm.LinearSelection(new ve.Range(offset+1)));var $slug=this.getDocument().getDocumentNode().getNodeFromOffset(offset+1).$element;$slug.addClass('ve-ce-branchNode-newSlug');setTimeout(function(){$slug.addClass('ve-ce-branchNode-newSlug-open');setTimeout(function(){surface.emit('position');},200);});this.onModelSelect();};ve.ce.Surface.prototype.fixupCursorPosition=function(direction,extend){direction=direction>0?1:-1;if(this.nativeSelection.rangeCount===0){return;}var node=this.nativeSelection.focusNode;var offset=this.nativeSelection.focusOffset;if(node.nodeType!==Node.ELEMENT_NODE){return;}var
previousNode=node.childNodes[offset-1];var nextNode=node.childNodes[offset];if(!(previousNode&&previousNode.nodeType===Node.ELEMENT_NODE&&(previousNode.classList.contains('ve-ce-nail-pre-open')||previousNode.classList.contains('ve-ce-nail-pre-close')))&&!(nextNode&&nextNode.nodeType===Node.ELEMENT_NODE&&(nextNode.classList.contains('ve-ce-nail-post-open')||nextNode.classList.contains('ve-ce-nail-post-close')))){return;}var fixedPosition=ve.adjacentDomPosition({node:node,offset:offset},direction,{stop:ve.isHardCursorStep});node=fixedPosition.node;offset=fixedPosition.offset;if(direction===-1){fixedPosition=ve.adjacentDomPosition(fixedPosition,direction,{stop:ve.isHardCursorStep});if(fixedPosition.node.nodeType===Node.TEXT_NODE){node=fixedPosition.node;offset=fixedPosition.node.length;}}this.showSelectionState(new ve.SelectionState({anchorNode:extend?this.nativeSelection.anchorNode:node,anchorOffset:extend?this.nativeSelection.anchorOffset:offset,focusNode:node,focusOffset:offset}));};ve
.ce.Surface.prototype.findMatchingSequences=function(isPaste,isDelete){var selection=this.getSelection();if(!selection.isNativeCursor()){return[];}return this.getSurface().sequenceRegistry.findMatching(this.getModel().getDocument().data,selection.getModel().getCoveringRange().end,isPaste,isDelete);};ve.ce.Surface.prototype.findAndExecuteSequences=function(isPaste,isDelete){this.executeSequences(this.findMatchingSequences(isPaste,isDelete));};ve.ce.Surface.prototype.checkSequences=ve.ce.Surface.prototype.findAndExecuteSequences;ve.ce.Surface.prototype.findAndExecuteDelayedSequences=function(){var sequences=[],selection=this.getSelection();var matchingSequences;if(this.deactivated||!selection.isNativeCursor()){matchingSequences=[];}else{matchingSequences=this.findMatchingSequences();}var matchingByName={};var i;for(i=0;i<matchingSequences.length;i++){matchingByName[matchingSequences[i].sequence.getName()]=matchingSequences[i];}for(i=0;i<this.delayedSequences.length;i++){var matchingSeq=
matchingByName[this.delayedSequences[i].sequence.getName()];if(!matchingSeq||matchingSeq.range.start!==this.delayedSequences[i].range.start){this.delayedSequences[i].wasDelayed=true;sequences.push(this.delayedSequences[i]);}}this.delayedSequences=[];this.executeSequences(sequences);};ve.ce.Surface.prototype.checkDelayedSequences=ve.ce.Surface.prototype.findAndExecuteDelayedSequences;ve.ce.Surface.prototype.executeSequences=function(sequences){var executed=false;for(var i=0;i<sequences.length;i++){if(sequences[i].sequence.delayed&&!sequences[i].wasDelayed){this.delayedSequences.push(sequences[i]);}else{executed=sequences[i].sequence.execute(this.surface,sequences[i].range)||executed;}}if(executed){this.delayedSequences=[];this.showModelSelection();}};ve.ce.Surface.prototype.maybeSetBreakpoint=function(){var selection=this.getSelection();if(!selection.isNativeCursor()){return;}var offset=selection.getModel().getCoveringRange().end-1;var data=this.getModel().getDocument().data;if(data.
getWordRange(offset).end===offset){this.getModel().breakpoint();}};ve.ce.Surface.prototype.onWindowResize=function(){this.emit('position');if(OO.ui.isMobile()&&!ve.init.platform.constructor.static.isIos()){this.getSurface().scrollSelectionIntoView();}};ve.ce.Surface.prototype.startRelocation=function(){this.relocatingSelection=this.getModel().getSelection();this.relocatingNode=this.getModel().getSelectedNode();this.emit('relocationStart');};ve.ce.Surface.prototype.endRelocation=function(){this.relocatingSelection=null;this.relocatingNode=null;this.onDocumentDragLeave();this.emit('relocationEnd');};ve.ce.Surface.prototype.setActiveNode=function(node){this.activeNode=node;};ve.ce.Surface.prototype.getActiveNode=function(){return this.activeNode;};ve.ce.Surface.prototype.storeKeyDownState=function(e){this.keyDownState.event=e;this.keyDownState.selectionState=null;if(this.nativeSelection.rangeCount>0&&e&&(e.keyCode===OO.ui.Keys.UP||e.keyCode===OO.ui.Keys.DOWN||e.keyCode===OO.ui.Keys.LEFT||
e.keyCode===OO.ui.Keys.RIGHT)){this.keyDownState.selectionState=new ve.SelectionState(this.nativeSelection);}};ve.ce.Surface.prototype.clearKeyDownState=function(){this.keyDownState.event=null;this.keyDownState.selectionState=null;};ve.ce.Surface.prototype.moveModelCursor=function(offset){var selection=this.model.getSelection();if(selection instanceof ve.dm.LinearSelection){this.model.setLinearSelection(this.model.getDocument().getRelativeRange(selection.getRange(),offset,'character',false));}};ve.ce.Surface.prototype.getFocusedNodeDirectionality=function(){if(this.cursorDirectionality){return this.cursorDirectionality;}var range=this.model.getSelection().getRange();var cursorNode=this.getDocument().getNodeAndOffset(range.to).node;if(cursorNode.nodeType===Node.TEXT_NODE){cursorNode=cursorNode.parentNode;}return $(cursorNode).css('direction');};ve.ce.Surface.prototype.restoreActiveNodeSelection=function(){var currentRange,activeNode=this.getActiveNode(),activeRange=activeNode&&
activeNode.getRange();if(activeRange&&(currentRange=ve.ce.veRangeFromSelection(this.nativeSelection))&&(!currentRange.isCollapsed()||activeNode.trapsCursor())&&!activeRange.containsRange(currentRange)){this.showModelSelection();return true;}else{return false;}};ve.ce.Surface.prototype.findAdjacentUneditableBranchNode=function(direction){var activeNode=this.getActiveNode(),forward=direction>0;var node=$(this.nativeSelection.focusNode).closest('.ve-ce-branchNode,.ve-ce-leafNode,.ve-ce-surface-paste')[0];if(!node||node.classList.contains('ve-ce-surface-paste')){return null;}while(true){while(!(forward?node.nextSibling:node.previousSibling)){node=node.parentNode;if(node===null){return null;}}node=forward?node.nextSibling:node.previousSibling;while(true){if($.data(node,'view')instanceof ve.ce.ContentBranchNode||node.nodeType===Node.TEXT_NODE){return null;}if($(node).is('.ve-ce-focusableNode,.ve-ce-tableNode')){if(activeNode){var viewNode=$(node).data('view');if(!activeNode.getRange().
containsRange(viewNode.getRange())){return null;}}return node;}if(!node.childNodes||node.childNodes.length===0){break;}node=forward?node.firstChild:node.lastChild;}}};ve.ce.Surface.prototype.updateCursorHolders=function(){var holderBefore=null,holderAfter=null,doc=this.getElementDocument(),nodeBefore=this.findAdjacentUneditableBranchNode(-1),nodeAfter=this.findAdjacentUneditableBranchNode(1);this.removeCursorHolders();if(nodeBefore){holderBefore=doc.importNode(this.constructor.static.cursorHolderTemplate,true);holderBefore.classList.add('ve-ce-cursorHolder-after');if(ve.inputDebug){holderBefore.classList.add('ve-ce-cursorHolder-debug');}$(nodeBefore).after(holderBefore);}if(nodeAfter){holderAfter=doc.importNode(this.constructor.static.cursorHolderTemplate,true);holderAfter.classList.add('ve-ce-cursorHolder-before');$(nodeAfter).before(holderAfter);if(ve.inputDebug){holderAfter.classList.add('ve-ce-cursorHolder-debug');}}this.cursorHolders={before:holderBefore,after:holderAfter};};ve.ce
.Surface.prototype.removeCursorHolders=function(){if(!this.cursorHolders){return;}if(this.cursorHolders.before&&this.cursorHolders.before.parentNode){this.cursorHolders.before.parentNode.removeChild(this.cursorHolders.before);}if(this.cursorHolders.after&&this.cursorHolders.after.parentNode){this.cursorHolders.after.parentNode.removeChild(this.cursorHolders.after);}this.cursorHolders=null;};ve.ce.Surface.prototype.handleInsertion=function(){var surfaceModel=this.getModel(),fragment=surfaceModel.getFragment(),selection=this.getSelection();if(selection instanceof ve.ce.TableSelection){surfaceModel.setSelection(selection.getModel().collapseToFrom());ve.ce.keyDownHandlerFactory.lookup('tableDelete').static.execute(this);this.documentView.getBranchNodeFromOffset(selection.getModel().tableRange.start+1).setEditing(true);selection=this.getSelection();}else if(selection.isFocusedNode()){return;}if(!(selection instanceof ve.ce.LinearSelection)){return;}var range=selection.getModel().getRange();
if(this.selectionSplitsNailedAnnotation()||(!range.isCollapsed()&&!this.documentView.rangeInsideOneLeafNode(range))){surfaceModel.setNullSelection();fragment.removeContent().collapseToStart().select();this.surfaceObserver.clear();this.storeKeyDownState(this.keyDownState.event);this.surfaceObserver.stopTimerLoop();this.surfaceObserver.pollOnce();}};ve.ce.Surface.prototype.getRelativeSelectableContentOffset=function(startOffset,direction,endOffset){var documentView=this.getDocument(),linearData=this.getModel().getDocument().data;var nextOffset=linearData.getRelativeOffset(startOffset,direction,function(offset){if(!linearData.isContentOffset(offset)){return false;}var branchNode=documentView.getBranchNodeFromOffset(offset);if(!branchNode){return false;}var noAutoFocusContainer=branchNode.traverseUpstream(function(node){return node.autoFocus();});if(noAutoFocusContainer){return false;}return true;});if(endOffset!==undefined&&((direction>0&&nextOffset>endOffset)||(direction<0&&nextOffset<
endOffset))){nextOffset=-1;}return nextOffset;};ve.ce.Surface.prototype.selectRelativeSelectableContentOffset=function(startOffset,direction,endOffset){var offset=this.getRelativeSelectableContentOffset(startOffset,direction,endOffset);if(offset!==-1){this.getModel().setLinearSelection(new ve.Range(offset));}else{this.getModel().setNullSelection();}};ve.ce.Surface.prototype.selectFirstSelectableContentOffset=function(){this.selectRelativeSelectableContentOffset(this.getModel().getAttachedRoot().getOffset(),1);};ve.ce.Surface.prototype.selectLastSelectableContentOffset=function(){this.selectRelativeSelectableContentOffset(this.getModel().getDocument().getDocumentRange().end,-1);};ve.ce.Surface.prototype.getViewportRange=function(covering,padding){var surface=this,documentModel=this.getModel().getDocument(),data=documentModel.data,dimensions=this.surface.getViewportDimensions();if(!dimensions){return null;}padding=padding||0;var top=Math.max(0,dimensions.top-padding);var bottom=
dimensions.bottom+(padding*2);var documentRange=this.attachedRoot===this.getDocument().getDocumentNode()?this.getModel().getDocument().getDocumentRange():this.attachedRoot.getRange();function highestIgnoreChildrenNode(childNode){var ignoreChildrenNode=null;childNode.traverseUpstream(function(node){if(node.shouldIgnoreChildren()){ignoreChildrenNode=node;}});return ignoreChildrenNode;}function binarySearch(offset,range,side,isStart){var start=range.start,end=range.end,lastLength=Infinity;while(range.getLength()<lastLength){lastLength=range.getLength();var mid=Math.round((range.start+range.end)/2);var midNode=documentModel.documentNode.getNodeFromOffset(mid);var ignoreChildrenNode=highestIgnoreChildrenNode(midNode);if(ignoreChildrenNode){var nodeRange=ignoreChildrenNode.getOuterRange();mid=side==='top'?nodeRange.end:nodeRange.start;}else{mid=data.getNearestContentOffset(mid);if(mid===-1){return isStart?start:end;}mid=Math.max(Math.min(mid,range.end),range.start);}var rect=null;while(!rect
){var contentRange;if(data.isContentOffset(mid+1)){contentRange=new ve.Range(mid,mid+1);}else if(data.isContentOffset(mid-1)){contentRange=new ve.Range(mid-1,mid);}else{contentRange=new ve.Range(mid);}rect=surface.getSelection(new ve.dm.LinearSelection(contentRange)).getSelectionBoundingRect();if(!rect){if(!midNode){throw new Error('Offset has no rendered node container');}var midNodeRange=midNode.getOuterRange();mid=side==='top'?data.getRelativeContentOffset(midNodeRange.end,1):data.getRelativeContentOffset(midNodeRange.start,-1);mid=Math.max(Math.min(mid,range.end),range.start);if(midNodeRange.containsRange(new ve.Range(mid))){return isStart?start:end;}midNode=midNode.parent;}}if(rect[side]>=offset){end=mid;range=new ve.Range(range.start,end);}else{start=mid;range=new ve.Range(start,range.end);}}return side==='bottom'?start:end;}return new ve.Range(binarySearch(top,documentRange,covering?'bottom':'top',true),binarySearch(bottom,documentRange,covering?'top':'bottom',false));};ve.ce.
Surface.prototype.selectFirstVisibleStartContentOffset=function(fallbackToFirst){var dimensions=this.surface.getViewportDimensions();var offset=dimensions&&dimensions.top?-20:0;var visibleRange=this.getViewportRange(false,offset);if(visibleRange){var model=this.getModel();var startNodeOffset=-1;var contentOffset=this.getRelativeSelectableContentOffset(Math.max(visibleRange.start-1,0),1,visibleRange.end);if(contentOffset!==-1){var branchNodeRange=model.getDocument().getBranchNodeFromOffset(contentOffset).getRange();if(contentOffset===branchNodeRange.start){startNodeOffset=contentOffset;}else{var nextContentOffset=this.getRelativeSelectableContentOffset(branchNodeRange.end,1,visibleRange.end);startNodeOffset=nextContentOffset!==-1?nextContentOffset:contentOffset;}}if(startNodeOffset!==-1){model.setLinearSelection(new ve.Range(startNodeOffset));}else{model.setNullSelection();}}if(fallbackToFirst&&this.getSelection().getModel().isNull()){this.selectFirstSelectableContentOffset();}};ve.ce.
Surface.prototype.forceShowModelSelection=function(){return this.showModelSelection(true);};ve.ce.Surface.prototype.showModelSelection=function(force){if(this.deactivated){setTimeout(this.updateDeactivatedSelection.bind(this));return false;}var selection=this.getSelection();var modelRange;if(selection.getModel().isNull()){if(!this.nativeSelection.focusNode||!this.$element[0].contains(this.nativeSelection.focusNode)){return false;}modelRange=null;}else{if(!selection.isNativeCursor()||this.focusedBlockSlug){return false;}modelRange=selection.getModel().getRange();if(!force&&this.$attachedRootNode.get(0).contains(this.nativeSelection.focusNode)){var impliedModelRange;try{impliedModelRange=new ve.Range(ve.ce.getOffset(this.nativeSelection.anchorNode,this.nativeSelection.anchorOffset),ve.ce.getOffset(this.nativeSelection.focusNode,this.nativeSelection.focusOffset));}catch(e){impliedModelRange=null;}if(modelRange.equals(impliedModelRange)){return false;}}}var changed=this.showSelectionState(
this.getSelectionState(modelRange));if(changed){this.updateCursorHolders();return true;}return false;};ve.ce.Surface.prototype.showSelectionState=function(selection){var extendedBackwards=false,sel=this.nativeSelection,newSel=selection;if(newSel.equalsSelection(sel)){this.updateActiveAnnotations();return false;}if(!newSel.getNativeRange(this.getElementDocument())){sel.removeAllRanges();return true;}if(newSel.isBackwards){if(ve.supportsSelectionExtend){var range=this.getElementDocument().createRange();range.setStart(newSel.anchorNode,newSel.anchorOffset);sel.removeAllRanges();sel.addRange(range);try{sel.extend(newSel.focusNode,newSel.focusOffset);extendedBackwards=true;}catch(e){}}if(!extendedBackwards){newSel=newSel.flip();if(newSel.equalsSelection(sel)){this.updateActiveAnnotations();return false;}}}if(!extendedBackwards){sel.removeAllRanges();sel.addRange(newSel.getNativeRange(this.getElementDocument()));}var $focusTarget=$(newSel.focusNode).closest('[contenteditable=true]');if(
$focusTarget.get(0)===this.getElementDocument().activeElement){}else if($focusTarget.length&&!OO.ui.contains($focusTarget.get(0),this.getElementDocument().activeElement)){var scrollTop=this.surface.$scrollContainer.scrollTop();$focusTarget.trigger('focus');this.surface.$scrollContainer.scrollTop(scrollTop);}else{ve.scrollIntoView($(newSel.focusNode).closest('*').get(0));}this.updateActiveAnnotations();return true;};ve.ce.Surface.prototype.updateActiveAnnotations=function(fromModelOrNode){var activeAnnotations,changed=false,surface=this,canBeActive=function(view){return view.canBeActive();};if(fromModelOrNode===true){activeAnnotations=this.annotationsAtModelSelection(canBeActive);}else if(fromModelOrNode instanceof Node){activeAnnotations=this.annotationsAtNode(fromModelOrNode,canBeActive);}else{activeAnnotations=this.annotationsAtFocus(canBeActive);}this.activeAnnotations.forEach(function(annotation){if(activeAnnotations.indexOf(annotation)===-1){annotation.$element.removeClass(
've-ce-annotation-active');changed=true;}});activeAnnotations.forEach(function(annotation){if(surface.activeAnnotations.indexOf(annotation)===-1){annotation.$element.addClass('ve-ce-annotation-active');changed=true;}});if(changed){this.activeAnnotations=activeAnnotations;this.model.emit('contextChange');}};ve.ce.Surface.prototype.selectNodeContents=function(node,collapse){if(!node){return false;}var anchor=ve.ce.nextCursorOffset(node.childNodes[0]);var focus=ve.ce.previousCursorOffset(node.childNodes[node.childNodes.length-1]);if(collapse==='start'){focus=anchor;}else if(collapse==='end'){anchor=focus;}return this.showSelectionState(new ve.SelectionState({anchorNode:anchor.node,anchorOffset:anchor.offset,focusNode:focus.node,focusOffset:focus.offset,isCollapsed:false}));};ve.ce.Surface.prototype.selectAnnotation=function(filter){var annotations=this.annotationsAtModelSelection(filter);if(annotations.length){this.selectNodeContents(annotations[0].$element[0]);}};ve.ce.Surface.prototype.
annotationsAtModelSelection=function(filter,offset){var annotations=[],documentRange=this.getModel().getDocument().getDocumentRange();if(offset===undefined){offset=this.getModel().getSelection().getCoveringRange().start;}var nodeAndOffset;if(offset>documentRange.start){try{nodeAndOffset=this.getDocument().getNodeAndOffset(offset-1);}catch(e){nodeAndOffset=null;}annotations=nodeAndOffset?this.annotationsAtNode(nodeAndOffset.node,filter):[];}if(offset<documentRange.end){try{nodeAndOffset=this.getDocument().getNodeAndOffset(offset+1);}catch(e){nodeAndOffset=null;}annotations=OO.unique(annotations.concat(nodeAndOffset?this.annotationsAtNode(nodeAndOffset.node,filter):[]));}return annotations;};ve.ce.Surface.prototype.annotationsAtFocus=function(filter){return this.annotationsAtNode(this.nativeSelection.focusNode,filter);};ve.ce.Surface.prototype.annotationsAtNode=function(node,filter){var annotations=[];$(node).parents('.ve-ce-annotation').addBack('.ve-ce-annotation').each(function(){var
view=$(this).data('view');if(view&&(!filter||filter(view))){annotations.push(view);}});return annotations;};ve.ce.Surface.prototype.getSelectionState=function(range){var dmDoc=this.getModel().getDocument();if(!range){return ve.SelectionState.static.newNullSelection();}var from=dmDoc.getNearestCursorOffset(range.from,range.isBackwards()?1:-1);if(from===-1){return ve.SelectionState.static.newNullSelection();}var anchor;try{anchor=this.documentView.getNodeAndOffset(from);}catch(e){return ve.SelectionState.static.newNullSelection();}var focus;if(range.isCollapsed()){focus=anchor;}else{var to=dmDoc.getNearestCursorOffset(range.to,range.isBackwards()?-1:1);if(to===-1){return ve.SelectionState.static.newNullSelection();}try{focus=this.documentView.getNodeAndOffset(to);}catch(e){return ve.SelectionState.static.newNullSelection();}}return new ve.SelectionState({anchorNode:anchor.node,anchorOffset:anchor.offset,focusNode:focus.node,focusOffset:focus.offset,isBackwards:range.isBackwards()});};ve.
ce.Surface.prototype.getNativeRange=function(range){var selectionState;if(!range){selectionState=new ve.SelectionState(this.nativeSelection);}else{selectionState=this.getSelectionState(range);}return selectionState.getNativeRange(this.getElementDocument());};ve.ce.Surface.prototype.appendHighlights=function($highlights,focused){this.$highlightsBlurred.children().detach();if(focused){this.$highlightsFocused.append($highlights);}else{this.$highlightsBlurred.append($highlights);}};ve.ce.Surface.prototype.getSurface=function(){return this.surface;};ve.ce.Surface.prototype.getModel=function(){return this.model;};ve.ce.Surface.prototype.getDocument=function(){return this.documentView;};ve.ce.Surface.prototype.isRenderingLocked=function(){return this.renderLocks>0&&!this.readOnly;};ve.ce.Surface.prototype.incRenderLock=function(){this.renderLocks++;};ve.ce.Surface.prototype.decRenderLock=function(){this.renderLocks--;};ve.ce.Surface.prototype.afterRenderLock=function(callback){setTimeout(
callback);};ve.ce.Surface.prototype.changeModel=function(transactions,selection){if(this.newModelSelection!==null){throw new Error('Nested change of newModelSelection');}this.newModelSelection=selection;try{this.model.change(transactions,selection);}finally{this.newModelSelection=null;}};ve.ce.Surface.prototype.setContentBranchNodeChanged=function(){this.contentBranchNodeChanged=true;this.clearKeyDownState();};ve.ce.Surface.prototype.setUnicorning=function(node){if(this.setUnicorningRecursionGuard){throw new Error('setUnicorning recursing');}if(this.unicorningNode&&this.unicorningNode!==node){this.setUnicorningRecursionGuard=true;try{this.unicorningNode.renderContents();}finally{this.setUnicorningRecursionGuard=false;}}this.unicorningNode=node;};ve.ce.Surface.prototype.setNotUnicorning=function(node){if(this.unicorningNode===node){this.unicorningNode=null;}};ve.ce.Surface.prototype.setNotUnicorningAll=function(node){if(this.unicorningNode===node){this.unicorningNode=null;}this.
setUnicorning(null);};ve.ce.Surface.prototype.getSelectedModels=function(){if(!(this.model.selection instanceof ve.dm.LinearSelection)){return[];}var models=this.model.getFragment().getSelectedModels();if(this.model.selection.isCollapsed()){var fragmentAfter=this.model.getFragment(new ve.dm.LinearSelection(new ve.Range(this.model.selection.range.start,this.model.selection.range.start+1)));models=OO.unique([].concat(models,fragmentAfter.getSelectedModels()));}var activeModels=this.activeAnnotations.map(function(view){return view.getModel();});if(this.model.sourceMode){return models;}else{return models.filter(function(annModel){if(annModel instanceof ve.dm.Annotation&&ve.ce.annotationFactory.canAnnotationBeActive(annModel.getType())){return activeModels.indexOf(annModel)!==-1;}return true;});}};ve.ce.Surface.prototype.selectionSplitsNailedAnnotation=function(){return ve.ce.nailedAnnotationAt(this.nativeSelection.anchorNode)!==ve.ce.nailedAnnotationAt(this.nativeSelection.focusNode);};ve.
ce.Surface.prototype.onSynchronizerAuthorUpdate=function(authorId){this.paintAuthor(authorId);};ve.ce.Surface.prototype.onSynchronizerAuthorDisconnect=function(authorId){var overlays=this.userSelectionOverlays[authorId];if(overlays){overlays.$cursor.detach();overlays.$selection.detach();delete this.userSelectionOverlays[authorId];}};ve.ce.Surface.prototype.onSynchronizerWrongDoc=function(){OO.ui.alert(ve.msg('visualeditor-rebase-missing-document-error'),{title:ve.msg('visualeditor-rebase-missing-document-title')});};ve.ce.Surface.prototype.onSynchronizerPause=function(){this.$element.toggleClass('ve-ce-surface-paused',!!this.model.synchronizer.paused);};ve.ce.Surface.prototype.paintAuthor=function(authorId){var synchronizer=this.model.synchronizer,authorData=synchronizer.getAuthorData(authorId),selection=synchronizer.authorSelections[authorId];if(!authorData||!selection||authorId===synchronizer.getAuthorId()){return;}var color='#'+authorData.color;var overlays;if(!this.
userSelectionOverlays[authorId]){this.userSelectionOverlays[authorId]={$cursor:$('<div>'),$selection:$('<div>'),deactivateDebounced:ve.debounce(function(){overlays.$cursor.addClass('ve-ce-surface-highlights-user-cursor-inactive');overlays.$selection.addClass('ve-ce-surface-highlights-user-selection-inactive');},5000)};}overlays=this.userSelectionOverlays[authorId];if(!selection||selection.isNull()){overlays.$cursor.detach();overlays.$selection.detach();return;}overlays.$cursor.empty().removeClass('ve-ce-surface-highlights-user-cursor-inactive');overlays.$selection.empty().removeClass('ve-ce-surface-highlights-user-selection-inactive');if(!selection.isCollapsed()){var rects=ve.ce.Selection.static.newFromModel(selection,this).getSelectionRects();for(var i=0,l=rects.length;i<l;i++){var rect=rects[i];overlays.$selection.append($('<div>').addClass('ve-ce-surface-highlights-user-selection').css({left:rect.left,top:rect.top,width:rect.width,height:rect.height,background:color}));}}var
cursorRect;try{if(selection instanceof ve.dm.LinearSelection&&this.getFocusedNode(selection.getRange())){cursorRect=ve.ce.Selection.static.newFromModel(selection,this).getSelectionBoundingRect();}else{cursorRect=ve.ce.Selection.static.newFromModel(selection.collapseToTo(),this).getSelectionRects()[0];}}catch(e){ve.error('User selection for '+authorId+' transformed out of bounds: '+JSON.stringify(selection));return;}overlays.$cursor.append($('<div>').addClass('ve-ce-surface-highlights-user-cursor').css({left:cursorRect.left,top:cursorRect.top,height:cursorRect.height,background:color}).append($('<span>').addClass('ve-ce-surface-highlights-user-cursor-label').text(authorData.name).css({background:color})));this.$highlightsUserCursors.append(overlays.$cursor);this.$highlightsUserSelections.append(overlays.$selection);overlays.deactivateDebounced();};ve.ce.Surface.prototype.onPosition=function(){var surface=this;this.updateDeactivatedSelection();if(this.model.synchronizer){setTimeout(
function(){var authorSelections=surface.model.synchronizer.authorSelections;for(var authorId in authorSelections){surface.onSynchronizerAuthorUpdate(+authorId);}});}};ve.ce.SurfaceObserver=function VeCeSurfaceObserver(surface){this.surface=surface;this.domDocument=surface.attachedRoot.getElementDocument();this.polling=false;this.disabled=false;this.timeoutId=null;this.pollInterval=250;this.rangeState=null;};OO.initClass(ve.ce.SurfaceObserver);ve.ce.SurfaceObserver.prototype.clear=function(){this.rangeState=null;};ve.ce.SurfaceObserver.prototype.detach=function(){this.surface=null;this.domDocument=null;this.rangeState=null;};ve.ce.SurfaceObserver.prototype.startTimerLoop=function(){this.polling=true;this.timerLoop(true);};ve.ce.SurfaceObserver.prototype.timerLoop=function(firstTime){if(this.timeoutId){clearTimeout(this.timeoutId);this.timeoutId=null;}if(!firstTime){this.pollOnce();}if(this.pollInterval!==null){this.timeoutId=this.setTimeout(this.timerLoop.bind(this),this.pollInterval);}
};ve.ce.SurfaceObserver.prototype.stopTimerLoop=function(){if(this.polling===true){this.polling=false;clearTimeout(this.timeoutId);this.timeoutId=null;}};ve.ce.SurfaceObserver.prototype.disable=function(){this.disabled=true;};ve.ce.SurfaceObserver.prototype.enable=function(){this.disabled=false;};ve.ce.SurfaceObserver.prototype.pollOnce=function(){this.pollOnceInternal(true);};ve.ce.SurfaceObserver.prototype.pollOnceNoCallback=function(){this.pollOnceInternal(false);};ve.ce.SurfaceObserver.prototype.pollOnceSelection=function(){this.pollOnceInternal(true,true);};ve.ce.SurfaceObserver.prototype.pollOnceInternal=function(signalChanges,selectionOnly){if(!this.domDocument||this.disabled){return;}var oldState=this.rangeState;var newState=new ve.ce.RangeState(oldState,this.surface.attachedRoot,selectionOnly);this.rangeState=newState;if(signalChanges&&(newState.contentChanged||newState.branchNodeChanged||newState.selectionChanged)){this.surface.handleObservedChanges(oldState,newState);}};ve.
ce.SurfaceObserver.prototype.setTimeout=function(callback,timeout){return setTimeout(callback,timeout);};ve.ce.SurfaceObserver.prototype.getRange=function(){if(!this.rangeState){return null;}return this.rangeState.veRange;};ve.ce.KeyDownHandlerFactory=function VeCeKeyDownHandlerFactory(){ve.ce.KeyDownHandlerFactory.super.apply(this,arguments);this.handlerNamesByKeys={};};OO.inheritClass(ve.ce.KeyDownHandlerFactory,OO.Factory);ve.ce.KeyDownHandlerFactory.prototype.register=function(constructor){ve.ce.KeyDownHandlerFactory.super.prototype.register.call(this,constructor);var keys=constructor.static.keys;var name=constructor.static.name;for(var i=0,ilen=keys.length;i<ilen;i++){this.handlerNamesByKeys[keys[i]]=this.handlerNamesByKeys[keys[i]]||[];if(this.handlerNamesByKeys[keys[i]].indexOf(name)===-1){this.handlerNamesByKeys[keys[i]].push(name);}}};ve.ce.KeyDownHandlerFactory.prototype.lookupHandlersForKey=function(key,selectionName){var constructors=[],names=this.handlerNamesByKeys[key]||[
];for(var i=0;i<names.length;i++){var constructor=this.registry[names[i]];var supportedSelections=constructor.static.supportedSelections;if(!supportedSelections||supportedSelections.indexOf(selectionName)!==-1){constructors.push(constructor);}}return constructors;};ve.ce.KeyDownHandlerFactory.prototype.executeHandlersForKey=function(key,selectionName,surface,e){var acted=false,handlers=this.lookupHandlersForKey(key,selectionName);for(var i=0;i<handlers.length;i++){if(handlers[i].static.execute(surface,e)){acted=true;}}return acted;};ve.ce.keyDownHandlerFactory=new ve.ce.KeyDownHandlerFactory();ve.ce.KeyDownHandler=function VeCeKeyDownHandler(){};OO.initClass(ve.ce.KeyDownHandler);ve.ce.KeyDownHandler.static.name=null;ve.ce.KeyDownHandler.static.keys=[];ve.ce.KeyDownHandler.static.supportedSelections=null;ve.ce.KeyDownHandler.static.execute=null;ve.ce.LinearSelection=function VeCeLinearSelection(){ve.ce.LinearSelection.super.apply(this,arguments);this.focusedNode=this.getSurface().
getFocusedNode(this.getModel().getRange());this.directionality=null;};OO.inheritClass(ve.ce.LinearSelection,ve.ce.Selection);ve.ce.LinearSelection.static.name='linear';ve.ce.LinearSelection.prototype.getSelectionRects=function(){var surface=this.getSurface(),rects=[],relativeRects=[];var range=this.getModel().getRange();var focusedNode=surface.getFocusedNode(range);if(focusedNode){return focusedNode.getRects();}var nativeRange=surface.getNativeRange(range);if(!nativeRange){return null;}try{rects=RangeFix.getClientRects(nativeRange);if(!rects.length){throw new Error('getClientRects returned empty list');}}catch(e){var rect=this.getNodeClientRectFromRange(nativeRange);if(rect){rects=[rect];}}var surfaceRect=surface.getSurface().getBoundingClientRect();if(!rects||!surfaceRect){return null;}for(var i=0,l=rects.length;i<l;i++){relativeRects.push(ve.translateRect(rects[i],-surfaceRect.left,-surfaceRect.top));}return relativeRects;};ve.ce.LinearSelection.prototype.getSelectionStartAndEndRects
=function(){var surface=this.getSurface();var range=this.getModel().getRange();var focusedNode=surface.getFocusedNode(range);if(focusedNode){return focusedNode.getStartAndEndRects();}return ve.getStartAndEndRects(this.getSelectionRects());};ve.ce.LinearSelection.prototype.getSelectionBoundingRect=function(){var surface=this.getSurface();var range=this.getModel().getRange();var focusedNode=surface.getFocusedNode(range);if(focusedNode){return focusedNode.getBoundingRect();}var nativeRange=surface.getNativeRange(range);if(!nativeRange){return null;}var boundingRect;try{boundingRect=RangeFix.getBoundingClientRect(nativeRange);}catch(e){boundingRect=null;}if(!boundingRect){boundingRect=this.getNodeClientRectFromRange(nativeRange);}var surfaceRect=surface.getSurface().getBoundingClientRect();if(!boundingRect||!surfaceRect){return null;}return ve.translateRect(boundingRect,-surfaceRect.left,-surfaceRect.top);};ve.ce.LinearSelection.prototype.getNodeClientRectFromRange=function(range){var
containerNode=range.endContainer,offset=range.endOffset;var node;var fixHeight;if(containerNode.nodeType===Node.TEXT_NODE&&(offset===0||offset===containerNode.length)){node=offset?containerNode.previousSibling:containerNode.nextSibling;}else if(containerNode.nodeType===Node.ELEMENT_NODE){node=offset===containerNode.childNodes.length?containerNode.lastChild:containerNode.childNodes[offset];if(node&&node.nodeType===Node.ELEMENT_NODE&&node.classList.contains('ve-ce-nail')){var annotationNode=offset?node.previousSibling:node.nextSibling;if(annotationNode instanceof HTMLElement){fixHeight=annotationNode.offsetHeight;}}}else{node=containerNode;}while(node&&node.nodeType!==Node.ELEMENT_NODE){node=node.parentNode;}if(!node){return null;}var rect=node.getClientRects()[0];if(!rect){return null;}var side=$(node).css('direction')==='rtl'?'right':'left';var adjacentNode=range.endContainer.childNodes[range.endOffset];var x;if(range.collapsed&&adjacentNode&&adjacentNode.classList&&adjacentNode.
classList.contains('ve-ce-unicorn')){var unicornRect=adjacentNode.getClientRects()[0];if(!unicornRect){return null;}x=unicornRect[side];}else{x=rect[side];}if(fixHeight){var middle=(rect.top+rect.bottom)/2;return{top:middle-(fixHeight/2),bottom:middle+(fixHeight/2),left:x,right:x,width:0,height:fixHeight};}else{return{top:rect.top,bottom:rect.bottom,left:x,right:x,width:0,height:rect.height};}};ve.ce.LinearSelection.prototype.getSelectionFocusRect=function(){return!this.isNativeCursor()?this.getSelectionBoundingRect():ve.ce.LinearSelection.super.prototype.getSelectionFocusRect.call(this);};ve.ce.LinearSelection.prototype.isFocusedNode=function(){return!!this.focusedNode;};ve.ce.LinearSelection.prototype.isNativeCursor=function(){return!this.focusedNode;};ve.ce.LinearSelection.prototype.getDirectionality=function(doc){if(!this.directionality){this.directionality=doc.getDirectionalityFromRange(this.getModel().getRange());}return this.directionality;};ve.ce.selectionFactory.register(ve.ce
.LinearSelection);ve.ce.NullSelection=function VeCeNullSelection(){ve.ce.NullSelection.super.apply(this,arguments);};OO.inheritClass(ve.ce.NullSelection,ve.ce.Selection);ve.ce.NullSelection.static.name='null';ve.ce.NullSelection.prototype.getSelectionRects=function(){return null;};ve.ce.NullSelection.prototype.getSelectionStartAndEndRects=function(){return null;};ve.ce.NullSelection.prototype.getSelectionBoundingRect=function(){return null;};ve.ce.NullSelection.prototype.isFocusedNode=function(){return false;};ve.ce.NullSelection.prototype.isNativeCursor=function(){return false;};ve.ce.NullSelection.prototype.getDirectionality=function(doc){return doc.getDir();};ve.ce.selectionFactory.register(ve.ce.NullSelection);ve.ce.TableSelection=function VeCeTableSelection(){ve.ce.TableSelection.super.apply(this,arguments);this.directionality=null;};OO.inheritClass(ve.ce.TableSelection,ve.ce.Selection);ve.ce.TableSelection.static.name='table';ve.ce.TableSelection.prototype.getSelectionRects=
function(){return[this.getSelectionBoundingRect()];};ve.ce.TableSelection.prototype.getSelectionBoundingRect=function(){var surface=this.getSurface(),tableNode=surface.getDocument().getBranchNodeFromOffset(this.model.tableRange.start+1),nodes=tableNode.getCellNodesFromSelection(this.getModel()),surfaceRect=surface.getSurface().getBoundingClientRect();var top=Infinity;var bottom=-Infinity;var left=Infinity;var right=-Infinity;for(var i=0,l=nodes.length;i<l;i++){var cellNode=nodes[i].$element[0];if(!cellNode){return null;}var cellOffset=cellNode.getBoundingClientRect();top=Math.min(top,cellOffset.top);bottom=Math.max(bottom,cellOffset.bottom);left=Math.min(left,cellOffset.left);right=Math.max(right,cellOffset.right);}if(!ve.test){switch($.client.profile().layout){case'webkit':right+=1;bottom+=1;break;case'gecko':left-=1;top-=1;break;}}var boundingRect={top:top,bottom:bottom,left:left,right:right,width:right-left,height:bottom-top};if(!boundingRect||!surfaceRect){return null;}return ve.
translateRect(boundingRect,-surfaceRect.left,-surfaceRect.top);};ve.ce.TableSelection.prototype.getTableBoundingRect=function(){var surface=this.getSurface(),tableNode=surface.getDocument().getBranchNodeFromOffset(this.model.tableRange.start+1);if(!tableNode){return null;}var surfaceRect=surface.getSurface().getBoundingClientRect();var boundingRect=tableNode.$element[0].getBoundingClientRect();if(!boundingRect||!surfaceRect){return null;}return ve.translateRect(boundingRect,-surfaceRect.left,-surfaceRect.top);};ve.ce.TableSelection.prototype.isFocusedNode=function(){return true;};ve.ce.TableSelection.prototype.isNativeCursor=function(){return false;};ve.ce.TableSelection.prototype.getDirectionality=function(doc){if(!this.directionality){this.directionality=doc.getDirectionalityFromRange(this.getModel().tableRange);}return this.directionality;};ve.ce.selectionFactory.register(ve.ce.TableSelection);ve.ce.LinearArrowKeyDownHandler=function VeCeLinearArrowKeyDownHandler(){};OO.inheritClass
(ve.ce.LinearArrowKeyDownHandler,ve.ce.KeyDownHandler);ve.ce.LinearArrowKeyDownHandler.static.name='linearArrow';ve.ce.LinearArrowKeyDownHandler.static.keys=[OO.ui.Keys.UP,OO.ui.Keys.DOWN,OO.ui.Keys.LEFT,OO.ui.Keys.RIGHT,OO.ui.Keys.HOME,OO.ui.Keys.END,OO.ui.Keys.PAGEUP,OO.ui.Keys.PAGEDOWN];ve.ce.LinearArrowKeyDownHandler.static.supportedSelections=['linear'];ve.ce.LinearArrowKeyDownHandler.static.execute=function(surface,e){var isBlockMove=e.keyCode===OO.ui.Keys.UP||e.keyCode===OO.ui.Keys.DOWN||e.keyCode===OO.ui.Keys.PAGEUP||e.keyCode===OO.ui.Keys.PAGEDOWN||e.keyCode===OO.ui.Keys.HOME||e.keyCode===OO.ui.Keys.END,keyBlockDirection=e.keyCode===OO.ui.Keys.DOWN||e.keyCode===OO.ui.Keys.PAGEDOWN||e.keyCode===OO.ui.Keys.END?1:-1,range=surface.model.getSelection().getRange(),activeNode=surface.getActiveNode();surface.surfaceObserver.stopTimerLoop();surface.surfaceObserver.pollOnce();var direction,directionality;if(surface.focusedBlockSlug){if(isBlockMove){direction=keyBlockDirection;}else{
directionality=$(surface.focusedBlockSlug).css('direction');if(e.keyCode===OO.ui.Keys.LEFT^directionality==='rtl'){direction=-1;}else{direction=1;}}range=surface.model.getDocument().getRelativeRange(range,direction,'character',e.shiftKey,activeNode&&(e.shiftKey||activeNode.trapsCursor())?activeNode.getRange():null);surface.model.setLinearSelection(range);e.preventDefault();return true;}if(surface.focusedNode){if(isBlockMove){direction=keyBlockDirection;}else{directionality=surface.getFocusedNodeDirectionality();if(e.keyCode===OO.ui.Keys.LEFT^directionality==='rtl'){direction=-1;}else{direction=1;}}if(!surface.focusedNode.isContent()){range=surface.model.getDocument().getRelativeRange(range,direction,'character',e.shiftKey,activeNode&&(e.shiftKey||activeNode.trapsCursor())?activeNode.getRange():null);surface.model.setLinearSelection(range);e.preventDefault();return true;}if(e.shiftKey){if(direction===-1^range.isBackwards()){range=range.flip();}surface.model.setLinearSelection(new ve.
Range(range.to));}else{range=new ve.Range(direction===1?range.end:range.start);surface.model.setLinearSelection(range);if(!isBlockMove){e.preventDefault();return true;}}}var collapseNode,collapseOffset;if(e.shiftKey&&!ve.supportsSelectionExtend&&range.isBackwards()){collapseNode=surface.nativeSelection.anchorNode;collapseOffset=surface.nativeSelection.anchorOffset;}else if(e.shiftKey&&!range.isCollapsed()&&isBlockMove){collapseNode=surface.nativeSelection.focusNode;collapseOffset=surface.nativeSelection.focusOffset;}if(collapseNode){var nativeRange=surface.getElementDocument().createRange();nativeRange.setStart(collapseNode,collapseOffset);nativeRange.setEnd(collapseNode,collapseOffset);surface.nativeSelection.removeAllRanges();surface.nativeSelection.addRange(nativeRange);}var startFocusNode=surface.nativeSelection.focusNode;var startFocusOffset=surface.nativeSelection.focusOffset;surface.eventSequencer.afterOne({keydown:function(){var viewNode=$(surface.nativeSelection.focusNode).
closest('.ve-ce-leafNode,.ve-ce-branchNode').data('view');if(!viewNode){return;}var newRange;if(viewNode.isFocusable()){var afterDirection;if(isBlockMove){afterDirection=keyBlockDirection;}else{afterDirection=ve.compareDocumentOrder(surface.nativeSelection.focusNode,surface.nativeSelection.focusOffset,startFocusNode,startFocusOffset);}newRange=(afterDirection>0?viewNode.getOuterRange():viewNode.getOuterRange().flip());}else{surface.surfaceObserver.pollOnceNoCallback();newRange=new ve.Range(surface.surfaceObserver.getRange().to);}if(e.shiftKey){newRange=new ve.Range(range.from,newRange.to);surface.getModel().setLinearSelection(newRange);}surface.updateActiveAnnotations();surface.surfaceObserver.pollOnce();}});return true;};ve.ce.keyDownHandlerFactory.register(ve.ce.LinearArrowKeyDownHandler);ve.ce.LinearDeleteKeyDownHandler=function VeCeLinearDeleteKeyDownHandler(){};OO.inheritClass(ve.ce.LinearDeleteKeyDownHandler,ve.ce.KeyDownHandler);ve.ce.LinearDeleteKeyDownHandler.static.name=
'linearDelete';ve.ce.LinearDeleteKeyDownHandler.static.keys=[OO.ui.Keys.BACKSPACE,OO.ui.Keys.DELETE];ve.ce.LinearDeleteKeyDownHandler.static.supportedSelections=['linear'];ve.ce.LinearDeleteKeyDownHandler.static.execute=function(surface,e){var direction=e.keyCode===OO.ui.Keys.DELETE?1:-1,unit=(e.altKey===true||e.ctrlKey===true)?'word':'character',offset=0,rangeToRemove=surface.getModel().getSelection().getRange(),documentModel=surface.getModel().getDocument(),focusedNode=surface.getFocusedNode(),uiSurface=surface.getSurface(),data=documentModel.data;if(surface.isReadOnly()){e.preventDefault();return true;}if(direction===1&&e.shiftKey&&ve.getSystemPlatform()!=='mac'){return false;}if(focusedNode){var command=uiSurface.commandRegistry.getDeleteCommandForNode(focusedNode);if(command){command.execute(uiSurface);e.preventDefault();return true;}}if(rangeToRemove.isCollapsed()&&!e.ctrlKey){if(surface.nativeSelection.focusNode===null){e.preventDefault();return true;}var position=ve.
adjacentDomPosition({node:surface.nativeSelection.focusNode,offset:surface.nativeSelection.focusOffset},direction,{stop:ve.isHardCursorStep});var skipNode=position.steps[position.steps.length-1].node;if(skipNode.nodeType===Node.TEXT_NODE){surface.eventSequencer.afterOne({keydown:surface.surfaceObserver.pollOnce.bind(surface.surfaceObserver)});return true;}var range;if(direction>0?skipNode.classList.contains('ve-ce-nail-pre-open'):skipNode.classList.contains('ve-ce-nail-post-close')){position=ve.adjacentDomPosition(position,direction,{stop:ve.isHardCursorStep});range=document.createRange();range.setStart(position.node,position.offset);surface.nativeSelection.removeAllRanges();surface.nativeSelection.addRange(range);surface.updateActiveAnnotations();e.preventDefault();return true;}var pairNode;if(skipNode.classList&&skipNode.classList.contains(direction>0?'ve-ce-nail-pre-close':'ve-ce-nail-post-open')&&(pairNode=(direction>0?skipNode.previousSibling:skipNode.nextSibling))&&pairNode.
classList&&pairNode.classList.contains(direction>0?'ve-ce-nail-post-open':'ve-ce-nail-pre-close')){var linkNode=skipNode.parentNode;range=document.createRange();range.setStart(linkNode.parentNode,ve.parentIndex(linkNode)-1);linkNode.parentNode.removeChild(linkNode.previousSibling);linkNode.parentNode.removeChild(linkNode.nextSibling);linkNode.parentNode.removeChild(linkNode);surface.nativeSelection.removeAllRanges();surface.nativeSelection.addRange(range);surface.updateActiveAnnotations();e.preventDefault();return true;}if(direction>0?skipNode.classList.contains('ve-ce-nail-pre-close'):skipNode.classList.contains('ve-ce-nail-post-open')){position=ve.adjacentDomPosition(position,direction,{stop:ve.isHardCursorStep});range=document.createRange();range.setStart(position.node,position.offset);surface.nativeSelection.removeAllRanges();surface.nativeSelection.addRange(range);surface.updateActiveAnnotations();e.preventDefault();return true;}offset=rangeToRemove.start;if(!e.ctrlKey&&((
direction<0&&!data.isElementData(offset-1))||(direction>0&&!data.isElementData(offset)))){surface.eventSequencer.afterOne({keydown:surface.surfaceObserver.pollOnce.bind(surface.surfaceObserver)});return true;}}if(rangeToRemove.isCollapsed()){rangeToRemove=documentModel.getRelativeRange(rangeToRemove,direction,unit,true);if(surface.getActiveNode()&&!surface.getActiveNode().getRange().containsRange(rangeToRemove)){e.preventDefault();return true;}var documentModelSelectedNodes=documentModel.selectNodes(rangeToRemove,'siblings');for(var i=0;i<documentModelSelectedNodes.length;i++){var node=documentModelSelectedNodes[i].node;var nodeOuterRange=documentModelSelectedNodes[i].nodeOuterRange;if(node instanceof ve.dm.TableNode){if(rangeToRemove.containsOffset(nodeOuterRange.start)){surface.getModel().setSelection(new ve.dm.TableSelection(nodeOuterRange,0,0));}else{var matrix=node.getMatrix();var row=matrix.getRowCount()-1;var col=matrix.getColCount(row)-1;surface.getModel().setSelection(new ve.
dm.TableSelection(nodeOuterRange,col,row));}e.preventDefault();return true;}}offset=rangeToRemove.start;var docLength=documentModel.getDocumentRange().getLength();var startNode;if(offset<docLength-1){while(offset<docLength-1&&data.isCloseElementData(offset)){offset++;}startNode=documentModel.getDocumentNode().getNodeFromOffset(offset+1);if(startNode.isFocusable()){surface.getModel().setLinearSelection(startNode.getOuterRange());e.preventDefault();return true;}}if(rangeToRemove.isCollapsed()){startNode=documentModel.getDocumentNode().getNodeFromOffset(offset-1);var nodeRange=startNode.getOuterRange();if(!startNode.isUnwrappable()||((startNode.canContainContent()||surface.attachedRoot===startNode)&&(nodeRange.start===0||nodeRange.end===docLength))){e.preventDefault();return true;}else{switch(startNode.getType()){case'list':case'listItem':uiSurface.execute('indentation','decrease');e.preventDefault();return;default:if(direction>0){rangeToRemove=new ve.Range(rangeToRemove.start,nodeRange.
end);}else{rangeToRemove=new ve.Range(nodeRange.start,rangeToRemove.start-1);}}}}}surface.getModel().getLinearFragment(rangeToRemove,true).delete(direction).select();surface.focus();surface.surfaceObserver.clear();surface.findAndExecuteSequences(false,true);e.preventDefault();return true;};ve.ce.keyDownHandlerFactory.register(ve.ce.LinearDeleteKeyDownHandler);ve.ce.LinearEnterKeyDownHandler=function VeCeLinearEnterKeyDownHandler(){};OO.inheritClass(ve.ce.LinearEnterKeyDownHandler,ve.ce.KeyDownHandler);ve.ce.LinearEnterKeyDownHandler.static.name='linearEnter';ve.ce.LinearEnterKeyDownHandler.static.keys=[OO.ui.Keys.ENTER];ve.ce.LinearEnterKeyDownHandler.static.supportedSelections=['linear'];ve.ce.LinearEnterKeyDownHandler.static.execute=function(surface,e){var range=surface.model.getSelection().getRange(),cursor=range.from,documentModel=surface.model.getDocument(),emptyParagraph=[{type:'paragraph'},{type:'/paragraph'}],advanceCursor=true,outermostNode=null,nodeModel=null,nodeModelRange=
null;e.preventDefault();if(e.ctrlKey||e.metaKey){return false;}var focusedNode=surface.getFocusedNode();if(focusedNode){if(focusedNode.getModel().isEditable()){focusedNode.executeCommand();}return true;}if(surface.isReadOnly()){return true;}var node=surface.getDocument().getBranchNodeFromOffset(range.from);if(!node.isMultiline()){return true;}if(!range.isCollapsed()){var txRemove=ve.dm.TransactionBuilder.static.newFromRemoval(documentModel,range);range=txRemove.translateRange(range);surface.model.change(txRemove,new ve.dm.LinearSelection(range));node=surface.getDocument().getBranchNodeFromOffset(range.from);}if(node!==null){nodeModel=node.getModel();nodeModelRange=nodeModel.getRange();}var txInsert;if(node===null){throw new Error('node === null');}else if(nodeModel.getType()!=='paragraph'&&(cursor===nodeModelRange.from||cursor===nodeModelRange.to)){if(cursor===nodeModelRange.to){txInsert=ve.dm.TransactionBuilder.static.newFromInsertion(documentModel,nodeModel.getOuterRange().to,
emptyParagraph);}else if(cursor===nodeModelRange.from){txInsert=ve.dm.TransactionBuilder.static.newFromInsertion(documentModel,nodeModel.getOuterRange().from,emptyParagraph);advanceCursor=false;}}else if(e.shiftKey&&nodeModel.hasSignificantWhitespace()){txInsert=ve.dm.TransactionBuilder.static.newFromInsertion(documentModel,range.from,'\n');}else if(!node.splitOnEnter()){var insertEmptyParagraph=false;var prevContentOffset;if(documentModel.hasSlugAtOffset(range.from)){insertEmptyParagraph=true;}else{prevContentOffset=documentModel.data.getNearestContentOffset(cursor,-1);if(prevContentOffset===-1){insertEmptyParagraph=true;}}if(insertEmptyParagraph){txInsert=ve.dm.TransactionBuilder.static.newFromInsertion(documentModel,cursor,emptyParagraph);}else{cursor=prevContentOffset;node=surface.documentView.getBranchNodeFromOffset(cursor);txInsert=undefined;}insertEmptyParagraph=undefined;}function getSplitData(n){var stack=[];n.traverseUpstream(function(parent){if(!parent.splitOnEnter()){return false
;}stack.splice(stack.length/2,0,{type:'/'+parent.type},parent.getModel().getClonedElement(true));outermostNode=parent;if(e.shiftKey){return false;}else{return true;}});return stack;}if(txInsert===undefined){var splitData=getSplitData(node);var outerParent=outermostNode.getParent();var outerChildrenCount=outerParent.getChildren().length;if(outerParent.removeEmptyLastChildOnEnter()&&outerParent.getChildren()[outerChildrenCount-1]===outermostNode&&((outermostNode.children.length===1&&node.getModel().length===0)||(outermostNode.canContainContent()&&outermostNode.getModel().length===0))){var container=outerParent.getParent();advanceCursor=false;if(outerChildrenCount===1){txInsert=ve.dm.TransactionBuilder.static.newFromRemoval(documentModel,outerParent.getOuterRange());}else{txInsert=ve.dm.TransactionBuilder.static.newFromRemoval(documentModel,outermostNode.getOuterRange());}surface.model.change(txInsert);range=txInsert.translateRange(range);if(container.splitOnEnter()){splitData=
getSplitData(container).concat(emptyParagraph);txInsert=ve.dm.TransactionBuilder.static.newFromInsertion(documentModel,container.getOuterRange().to-1,splitData);}else if(outerParent.getChildren().length){txInsert=ve.dm.TransactionBuilder.static.newFromInsertion(documentModel,outerParent.getOuterRange().to,emptyParagraph);}else{txInsert=null;}advanceCursor=true;}else{txInsert=ve.dm.TransactionBuilder.static.newFromInsertion(documentModel,range.from,splitData);}}if(txInsert){surface.model.change(txInsert);range=txInsert.translateRange(range);}if(advanceCursor){cursor=documentModel.data.getRelativeContentOffset(range.from,1);}else{cursor=documentModel.data.getNearestContentOffset(range.from);}if(cursor===-1){surface.model.change(ve.dm.TransactionBuilder.static.newFromInsertion(documentModel,range.from,emptyParagraph));surface.model.setLinearSelection(new ve.Range(range.from+1));}else{surface.model.setLinearSelection(new ve.Range(cursor));}surface.surfaceObserver.clear();setTimeout(
function(){surface.findAndExecuteSequences();});return true;};ve.ce.keyDownHandlerFactory.register(ve.ce.LinearEnterKeyDownHandler);ve.ce.LinearEscapeKeyDownHandler=function VeCeLinearEscapeKeyDownHandler(){};OO.inheritClass(ve.ce.LinearEscapeKeyDownHandler,ve.ce.KeyDownHandler);ve.ce.LinearEscapeKeyDownHandler.static.name='linearEscape';ve.ce.LinearEscapeKeyDownHandler.static.keys=[OO.ui.Keys.ESCAPE];ve.ce.LinearEscapeKeyDownHandler.static.supportedSelections=['linear'];ve.ce.LinearEscapeKeyDownHandler.static.execute=function(surface,e){var activeTableNode=surface.getActiveNode()&&surface.getActiveNode().findParent(ve.ce.TableNode);if(activeTableNode){e.preventDefault();e.stopPropagation();activeTableNode.setEditing(false);surface.getModel().setSelection(surface.getModel().getSelection().collapseToStart());return true;}return false;};ve.ce.keyDownHandlerFactory.register(ve.ce.LinearEscapeKeyDownHandler);ve.ce.TableArrowKeyDownHandler=function VeCeTableArrowKeyDownHandler(){};OO.
inheritClass(ve.ce.TableArrowKeyDownHandler,ve.ce.KeyDownHandler);ve.ce.TableArrowKeyDownHandler.static.name='tableArrow';ve.ce.TableArrowKeyDownHandler.static.keys=[OO.ui.Keys.UP,OO.ui.Keys.DOWN,OO.ui.Keys.LEFT,OO.ui.Keys.RIGHT,OO.ui.Keys.HOME,OO.ui.Keys.END,OO.ui.Keys.PAGEUP,OO.ui.Keys.PAGEDOWN,OO.ui.Keys.TAB];ve.ce.TableArrowKeyDownHandler.static.supportedSelections=['table'];ve.ce.TableArrowKeyDownHandler.static.execute=function(surface,e){var wrap=false,checkDir=false,colOffset=0,rowOffset=0,expand=e.shiftKey;if(e.ctrlKey||e.altKey||e.metaKey){return;}switch(e.keyCode){case OO.ui.Keys.LEFT:colOffset=-1;checkDir=true;break;case OO.ui.Keys.RIGHT:colOffset=1;checkDir=true;break;case OO.ui.Keys.UP:rowOffset=-1;break;case OO.ui.Keys.DOWN:rowOffset=1;break;case OO.ui.Keys.HOME:colOffset=-Infinity;break;case OO.ui.Keys.END:colOffset=Infinity;break;case OO.ui.Keys.PAGEUP:rowOffset=-Infinity;break;case OO.ui.Keys.PAGEDOWN:rowOffset=Infinity;break;case OO.ui.Keys.TAB:colOffset=e.shiftKey?-1
:1;expand=false;wrap=true;break;}e.preventDefault();this.moveTableSelection(surface,rowOffset,colOffset,checkDir,expand,wrap);return true;};ve.ce.TableArrowKeyDownHandler.static.moveTableSelection=function(surface,rowOffset,colOffset,checkDir,expand,wrap){var selection=surface.getModel().getSelection();if(colOffset&&checkDir){var tableNode=surface.documentView.getBranchNodeFromOffset(selection.tableRange.start+1);if(tableNode.$element.css('direction')!=='ltr'){colOffset*=-1;}}if(!expand){selection=selection.collapseToFrom();}var newSelection;function adjust(){newSelection=selection.newFromAdjustment(surface.getModel().getDocument(),expand?0:colOffset,expand?0:rowOffset,colOffset,rowOffset,wrap);}adjust();if(wrap&&colOffset>0&&selection.equals(newSelection)){surface.getSurface().execute('table','insert','row','after');selection=surface.getModel().getSelection();adjust();}if((rowOffset!==0||(rowOffset===0&&colOffset===-1&&wrap))&&selection.equals(newSelection)){var documentModel=surface.
getModel().getDocument();var captionNode;if((rowOffset===-1||(colOffset===-1&&wrap))&&(captionNode=selection.getTableNode(documentModel).getCaptionNode())){newSelection=new ve.dm.LinearSelection(documentModel.getRelativeRange(new ve.Range(captionNode.getRange().start),1));}else{newSelection=new ve.dm.LinearSelection(documentModel.getRelativeRange(selection.tableRange,rowOffset||colOffset));}}surface.getModel().setSelection(newSelection);};ve.ce.keyDownHandlerFactory.register(ve.ce.TableArrowKeyDownHandler);ve.ce.TableDeleteKeyDownHandler=function VeCeTableDeleteKeyDownHandler(){};OO.inheritClass(ve.ce.TableDeleteKeyDownHandler,ve.ce.KeyDownHandler);ve.ce.TableDeleteKeyDownHandler.static.name='tableDelete';ve.ce.TableDeleteKeyDownHandler.static.keys=[OO.ui.Keys.BACKSPACE,OO.ui.Keys.DELETE];ve.ce.TableDeleteKeyDownHandler.static.supportedSelections=['table'];ve.ce.TableDeleteKeyDownHandler.static.execute=function(surface,e){var surfaceModel=surface.getModel(),documentModel=surfaceModel.
getDocument(),fragments=[],cells=surfaceModel.getSelection().getMatrixCells(documentModel);if(e){e.preventDefault();}if(surface.isReadOnly()){return true;}var i,l;for(i=0,l=cells.length;i<l;i++){if(cells[i].node.isCellEditable()){fragments.push(surfaceModel.getLinearFragment(cells[i].node.getRange(),true));}}for(i=0,l=fragments.length;i<l;i++){fragments[i].insertContent([{type:'paragraph',internal:{generated:'wrapper'}},{type:'/paragraph'}]);}return true;};ve.ce.keyDownHandlerFactory.register(ve.ce.TableDeleteKeyDownHandler);ve.ce.LinearTabKeyDownHandler=function VeCeLinearTabKeyDownHandler(){};OO.inheritClass(ve.ce.LinearTabKeyDownHandler,ve.ce.KeyDownHandler);ve.ce.LinearTabKeyDownHandler.static.name='linearTab';ve.ce.LinearTabKeyDownHandler.static.keys=[OO.ui.Keys.TAB];ve.ce.LinearTabKeyDownHandler.static.supportedSelections=['linear'];ve.ce.LinearTabKeyDownHandler.static.execute=function(surface,e){var activeTableNode=surface.getActiveNode()&&surface.getActiveNode().findParent(ve.
ce.TableNode),activeTableCaptionNode=surface.getActiveNode()&&surface.getActiveNode().findParent(ve.ce.TableCaptionNode),documentModel=surface.getModel().getDocument();if(activeTableNode){if(e.ctrlKey||e.altKey||e.metaKey){return;}if(activeTableNode.editingFragment){e.preventDefault();e.stopPropagation();activeTableNode.setEditing(false);surface.getModel().setSelection(surface.getModel().getSelection().collapseToStart());ve.ce.TableArrowKeyDownHandler.static.moveTableSelection(surface,0,e.shiftKey?-1:1,false,false,true);if(surface.getModel().getSelection()instanceof ve.dm.TableSelection){activeTableNode.setEditing(true);}return true;}else if(activeTableCaptionNode){e.preventDefault();e.stopPropagation();if(e.shiftKey){surface.getModel().setSelection(new ve.dm.LinearSelection(documentModel.getRelativeRange(activeTableNode.getRange(),-1)));}else{surface.getModel().setSelection(new ve.dm.TableSelection(activeTableNode.getOuterRange(),0,0));}return true;}}return false;};ve.ce.
keyDownHandlerFactory.register(ve.ce.LinearTabKeyDownHandler);ve.ce.GeneratedContentNode=function VeCeGeneratedContentNode(){this.generatingPromise=null;this.generatedContentsInvalid=null;this.model.connect(this,{update:'onGeneratedContentNodeUpdate'});this.connect(this,{teardown:'abortGenerating'});this.update();};OO.initClass(ve.ce.GeneratedContentNode);ve.ce.GeneratedContentNode.static.renderHtmlAttributes=false;ve.ce.GeneratedContentNode.static.awaitGeneratedContent=function(view){var promises=[];function queueNode(node){if(typeof node.generateContents==='function'){if(node.isGenerating()){var promise=ve.createDeferred();node.once('rerender',promise.resolve);promises.push(promise);}}}if(view instanceof ve.ce.BranchNode){view.traverse(queueNode);}else{queueNode(view);}return ve.promiseAll(promises);};ve.ce.GeneratedContentNode.prototype.generateContents=null;ve.ce.GeneratedContentNode.prototype.onGeneratedContentNodeUpdate=function(staged){this.update(undefined,staged);};ve.ce.
GeneratedContentNode.prototype.getRenderedDomElements=function(domElements){var doc=this.getElementDocument();var rendering=this.filterRenderedDomElements(ve.copyDomElements(domElements,doc));if(rendering.length){rendering=rendering.map(function(node){if(node.nodeType===Node.TEXT_NODE){var span=document.createElement('span');span.appendChild(node);return span;}return node;});ve.resolveAttributes(rendering,domElements[0].ownerDocument,ve.dm.Converter.static.computedAttributes);}else{rendering=[document.createElement('span')];}return rendering;};ve.ce.GeneratedContentNode.prototype.filterRenderedDomElements=function(domElements){return ve.filterMetaElements(domElements);};ve.ce.GeneratedContentNode.prototype.render=function(generatedContents,staged){var node=this;if(this.live){this.emit('teardown');}var $newElements=$(this.getRenderedDomElements(ve.copyDomElements(generatedContents)));this.generatedContentsInvalid=!this.validateGeneratedContents($(generatedContents));if(!staged||!this.
generatedContentsInvalid){if(!this.$element[0].parentNode){this.$element=$newElements;}else{var lengthChange=this.$element.length!==$newElements.length;this.$element.first().replaceWith($newElements);this.$element.remove();this.$element=$newElements;if(lengthChange){setTimeout(function(){if(node.getRoot()&&node.getRoot().getSurface()){node.getRoot().getSurface().showModelSelection();}});}}}else{this.generatedContentsValid=false;this.model.emit('generatedContentsError',$newElements);}this.preventTabbingInside();if(this.$focusable){this.$focusable=this.getFocusableElement();this.$bounding=this.getBoundingElement();}if(this.$resizable){this.$resizable=this.getResizableElement();}this.initialize();if(this.live){this.emit('setup');}this.afterRender();};ve.ce.GeneratedContentNode.prototype.preventTabbingInside=function(){var selector='input, select, textarea, button, object, a, area, [contenteditable], [tabindex]',$focusableCandidates=this.$element.find(selector).addBack(selector);
$focusableCandidates.each(function(){var $this=$(this);if(OO.ui.isFocusableElement($this)){$this.attr('tabindex',-1);}});};ve.ce.GeneratedContentNode.prototype.afterRender=function(){this.emit('rerender');};ve.ce.GeneratedContentNode.prototype.validateGeneratedContents=function(){return true;};ve.ce.GeneratedContentNode.prototype.update=function(config,staged){var store=this.model.doc.getStore(),contents=store.value(store.hashOfValue(null,OO.getHash([this.model.getHashObjectForRendering(),config])));if(contents){this.render(contents,staged);}else{this.forceUpdate(config,staged);}};ve.ce.GeneratedContentNode.prototype.forceUpdate=function(config,staged){if(this.generatingPromise){this.abortGenerating();}else{this.startGenerating();}var node=this;var promise=this.generatingPromise=this.generateContents(config);promise.done(function(generatedContents){if(node.generatingPromise===promise){node.doneGenerating(generatedContents,config,staged);}}).fail(function(){if(node.generatingPromise===
promise){node.failGenerating();}});};ve.ce.GeneratedContentNode.prototype.startGenerating=function(){this.$element.addClass('ve-ce-generatedContentNode-generating');};ve.ce.GeneratedContentNode.prototype.abortGenerating=function(){var promise=this.generatingPromise;if(promise){this.generatingPromise=null;if(typeof promise.abort==='function'){promise.abort();}}this.$element.removeClass('ve-ce-generatedContentNode-generating');};ve.ce.GeneratedContentNode.prototype.doneGenerating=function(generatedContents,config,staged){this.$element.removeClass('ve-ce-generatedContentNode-generating');this.generatingPromise=null;if(this.model&&this.model.doc){var store=this.model.doc.getStore();var hash=OO.getHash([this.model.getHashObjectForRendering(),config]);store.hash(generatedContents,hash);this.render(generatedContents,staged);}};ve.ce.GeneratedContentNode.prototype.failGenerating=function(){this.$element.removeClass('ve-ce-generatedContentNode-generating');this.generatingPromise=null;};ve.ce.
GeneratedContentNode.prototype.isGenerating=function(){return!!this.generatingPromise;};ve.ce.GeneratedContentNode.prototype.getFocusableElement=function(){return this.$element;};ve.ce.GeneratedContentNode.prototype.getBoundingElement=function(){return this.$element;};ve.ce.GeneratedContentNode.prototype.getResizableElement=function(){return this.$element;};ve.ce.ContentEditableNode=function VeCeContentEditableNode(){this.ceSurface=null;this.setContentEditable(true);this.setReadOnly(false);this.connect(this,{setup:'onContentEditableSetup',teardown:'onContentEditableTeardown'});};OO.initClass(ve.ce.ContentEditableNode);ve.ce.ContentEditableNode.prototype.onContentEditableSetup=function(){if(this.ceSurface||!this.root){return;}this.ceSurface=this.root.getSurface().getSurface();this.ceSurface.connect(this,{readOnly:'onSurfaceReadOnly'});this.setReadOnly(this.ceSurface.isReadOnly());};ve.ce.ContentEditableNode.prototype.onContentEditableTeardown=function(){if(!this.ceSurface){return;}this.
ceSurface.disconnect(this,{readOnly:'onSurfaceReadOnly'});this.ceSurface=null;};ve.ce.ContentEditableNode.prototype.onSurfaceReadOnly=function(readOnly){this.setReadOnly(readOnly);};ve.ce.ContentEditableNode.prototype.setReadOnly=function(readOnly){this.$element.prop('spellcheck',!readOnly);};ve.ce.ContentEditableNode.prototype.setContentEditable=function(enabled){this.$element.prop('contentEditable',(!!enabled).toString());};ve.ce.ContentEditableNode.prototype.isContentEditable=function(){return this.$element.prop('contentEditable')==='true';};ve.ce.ActiveNode=function VeCeActiveNode(){ve.ce.ContentEditableNode.call(this);this.activeNodeSurface=null;this.isActiveNodeSetup=false;this.connect(this,{setup:'onActiveNodeSetup',teardown:'onActiveNodeTeardown'});this.$element.addClass('ve-ce-activeNode');};OO.mixinClass(ve.ce.ActiveNode,ve.ce.ContentEditableNode);ve.ce.ActiveNode.prototype.onActiveNodeSetup=function(){if(this.isActiveNodeSetup||!this.root){return;}this.activeNodeSurface=this
.getRoot().getSurface();this.activeNodeSurface.getModel().connect(this,{select:'onActiveNodeSurfaceModelSelect'});this.isActiveNodeSetup=true;};ve.ce.ActiveNode.prototype.onActiveNodeTeardown=function(){if(!this.isActiveNodeSetup){return;}var surface=this.activeNodeSurface;surface.getModel().disconnect(this);if(surface.getActiveNode()===this){surface.setActiveNode(null);}this.isActiveNodeSetup=false;};ve.ce.ActiveNode.prototype.onActiveNodeSurfaceModelSelect=function(selection){var coveringRange=selection.getCoveringRange(),surface=this.activeNodeSurface,activeNode=this;if(coveringRange&&this.model.getRange().containsRange(new ve.Range(coveringRange.from))){if(!surface.getActiveNode()||!surface.getActiveNode().traverseUpstream(function(node){return node!==activeNode;})){surface.setActiveNode(this);}this.$element.addClass('ve-ce-activeNode-active');}else{if(surface.getActiveNode()===this){surface.setActiveNode(null);}if(!selection.isNull()){this.$element.removeClass(
've-ce-activeNode-active');}}};ve.ce.AlienNode=function VeCeAlienNode(){ve.ce.AlienNode.super.apply(this,arguments);this.$element=$(ve.copyDomElements(this.model.getOriginalDomElements(this.model.getDocument().getStore()),document));ve.ce.FocusableNode.call(this,this.$element,{classes:['ve-ce-alienNode-highlights']});this.initialize();};OO.inheritClass(ve.ce.AlienNode,ve.ce.LeafNode);OO.mixinClass(ve.ce.AlienNode,ve.ce.FocusableNode);ve.ce.AlienNode.static.name='alien';ve.ce.AlienNode.static.iconWhenInvisible='puzzle';ve.ce.AlienNode.static.getDescription=function(){return ve.msg('visualeditor-aliennode-tooltip');};ve.ce.AlienBlockNode=function VeCeAlienBlockNode(){ve.ce.AlienBlockNode.super.apply(this,arguments);};OO.inheritClass(ve.ce.AlienBlockNode,ve.ce.AlienNode);ve.ce.AlienBlockNode.static.name='alienBlock';ve.ce.nodeFactory.register(ve.ce.AlienBlockNode);ve.ce.AlienInlineNode=function VeCeAlienInlineNode(){ve.ce.AlienInlineNode.super.apply(this,arguments);};OO.inheritClass(ve.ce
.AlienInlineNode,ve.ce.AlienNode);ve.ce.AlienInlineNode.static.name='alienInline';ve.ce.nodeFactory.register(ve.ce.AlienInlineNode);ve.ce.AlienTableCellNode=function VeCeAlienTableCellNode(){ve.ce.AlienTableCellNode.super.apply(this,arguments);ve.ce.TableCellableNode.call(this);};OO.inheritClass(ve.ce.AlienTableCellNode,ve.ce.AlienNode);OO.mixinClass(ve.ce.AlienTableCellNode,ve.ce.TableCellableNode);ve.ce.AlienTableCellNode.static.name='alienTableCell';ve.ce.nodeFactory.register(ve.ce.AlienTableCellNode);ve.ce.ArticleNode=function VeCeArticleNode(){ve.ce.ArticleNode.super.apply(this,arguments);this.$element.addClass('ve-ce-articleNode').prop('contentEditable','false');};OO.inheritClass(ve.ce.ArticleNode,ve.ce.BranchNode);ve.ce.ArticleNode.static.name='article';ve.ce.ArticleNode.static.tagName='article';ve.ce.nodeFactory.register(ve.ce.ArticleNode);ve.ce.BlockquoteNode=function VeCeBlockquoteNode(){ve.ce.BlockquoteNode.super.apply(this,arguments);};OO.inheritClass(ve.ce.BlockquoteNode,
ve.ce.BranchNode);ve.ce.BlockquoteNode.static.name='blockquote';ve.ce.BlockquoteNode.static.tagName='blockquote';ve.ce.BlockquoteNode.static.removeEmptyLastChildOnEnter=true;ve.ce.nodeFactory.register(ve.ce.BlockquoteNode);ve.ce.BreakNode=function VeCeBreakNode(){ve.ce.BreakNode.super.apply(this,arguments);this.$element.addClass('ve-ce-breakNode');};OO.inheritClass(ve.ce.BreakNode,ve.ce.LeafNode);ve.ce.BreakNode.static.name='break';ve.ce.BreakNode.static.tagName='br';ve.ce.nodeFactory.register(ve.ce.BreakNode);ve.ce.CenterNode=function VeCeCenterNode(){ve.ce.CenterNode.super.apply(this,arguments);};OO.inheritClass(ve.ce.CenterNode,ve.ce.BranchNode);ve.ce.CenterNode.static.name='center';ve.ce.CenterNode.static.tagName='center';ve.ce.nodeFactory.register(ve.ce.CenterNode);ve.ce.CommentNode=function VeCeCommentNode(model,config){ve.ce.CommentNode.super.call(this,model,config);ve.ce.FocusableNode.call(this,this.$element,config);this.model.connect(this,{attributeChange:'onAttributeChange'})
;this.$element.addClass('ve-ce-commentNode');};OO.inheritClass(ve.ce.CommentNode,ve.ce.LeafNode);OO.mixinClass(ve.ce.CommentNode,ve.ce.FocusableNode);ve.ce.CommentNode.static.name='comment';ve.ce.CommentNode.static.primaryCommandName='comment';ve.ce.CommentNode.static.iconWhenInvisible='notice';ve.ce.CommentNode.static.getDescription=function(model){return model.getAttribute('text');};ve.ce.CommentNode.prototype.onAttributeChange=function(key){if(key==='text'){this.updateInvisibleIconLabel();}};ve.ce.CommentNode.prototype.hasRendering=function(){return false;};ve.ce.nodeFactory.register(ve.ce.CommentNode);ve.ce.DefinitionListItemNode=function VeCeDefinitionListItemNode(){ve.ce.DefinitionListItemNode.super.apply(this,arguments);this.model.connect(this,{update:'onUpdate'});};OO.inheritClass(ve.ce.DefinitionListItemNode,ve.ce.BranchNode);ve.ce.DefinitionListItemNode.static.name='definitionListItem';ve.ce.DefinitionListItemNode.static.splitOnEnter=true;ve.ce.DefinitionListItemNode.
prototype.getTagName=function(){var style=this.model.getAttribute('style'),types={definition:'dd',term:'dt'};if(!Object.prototype.hasOwnProperty.call(types,style)){throw new Error('Invalid style');}return types[style];};ve.ce.DefinitionListItemNode.prototype.onUpdate=function(){this.updateTagName();};ve.ce.nodeFactory.register(ve.ce.DefinitionListItemNode);ve.ce.DefinitionListNode=function VeCeDefinitionListNode(){ve.ce.DefinitionListNode.super.apply(this,arguments);};OO.inheritClass(ve.ce.DefinitionListNode,ve.ce.BranchNode);ve.ce.DefinitionListNode.static.name='definitionList';ve.ce.DefinitionListNode.static.tagName='dl';ve.ce.DefinitionListNode.static.removeEmptyLastChildOnEnter=true;ve.ce.nodeFactory.register(ve.ce.DefinitionListNode);ve.ce.DivNode=function VeCeDivNode(){ve.ce.DivNode.super.apply(this,arguments);};OO.inheritClass(ve.ce.DivNode,ve.ce.BranchNode);ve.ce.DivNode.static.name='div';ve.ce.nodeFactory.register(ve.ce.DivNode);ve.ce.DocumentNode=function VeCeDocumentNode(
model,surface,config){this.surface=surface;ve.ce.DocumentNode.super.call(this,model,config);ve.ce.ContentEditableNode.call(this);this.setRoot(this);this.$element.addClass('ve-ce-documentNode ve-ce-attachedRootNode ve-ce-rootNode').attr('tabindex',0);this.$element.attr('data-gramm','false');this.$element.attr('role','textbox');};OO.inheritClass(ve.ce.DocumentNode,ve.ce.BranchNode);OO.mixinClass(ve.ce.DocumentNode,ve.ce.ContentEditableNode);ve.ce.DocumentNode.static.name='document';ve.ce.DocumentNode.prototype.getOuterLength=function(){return this.length;};ve.ce.DocumentNode.prototype.getSurface=function(){return this.surface;};ve.ce.nodeFactory.register(ve.ce.DocumentNode);ve.ce.HeadingNode=function VeCeHeadingNode(){ve.ce.HeadingNode.super.apply(this,arguments);this.model.connect(this,{update:'onUpdate'});};OO.inheritClass(ve.ce.HeadingNode,ve.ce.ContentBranchNode);ve.ce.HeadingNode.static.name='heading';ve.ce.HeadingNode.prototype.initialize=function(){ve.ce.HeadingNode.super.
prototype.initialize.call(this);this.$element.addClass('ve-ce-headingNode');};ve.ce.HeadingNode.prototype.getTagName=function(){var level=this.model.getAttribute('level'),types={1:'h1',2:'h2',3:'h3',4:'h4',5:'h5',6:'h6'};if(!Object.prototype.hasOwnProperty.call(types,level)){throw new Error('Invalid level');}return types[level];};ve.ce.HeadingNode.prototype.onUpdate=function(){this.updateTagName();};ve.ce.nodeFactory.register(ve.ce.HeadingNode);ve.ce.HorizontalRuleNode=function VeCeHorizontalRuleNode(){ve.ce.HorizontalRuleNode.super.apply(this,arguments);this.$element=$('<div>').append(this.$element);ve.ce.FocusableNode.call(this);this.$element.addClass('ve-ce-horizontalRuleNode');};OO.inheritClass(ve.ce.HorizontalRuleNode,ve.ce.LeafNode);OO.mixinClass(ve.ce.HorizontalRuleNode,ve.ce.FocusableNode);ve.ce.HorizontalRuleNode.static.name='horizontalRule';ve.ce.HorizontalRuleNode.static.tagName='hr';ve.ce.nodeFactory.register(ve.ce.HorizontalRuleNode);ve.ce.InternalItemNode=function
VeCeInternalItemNode(){ve.ce.InternalItemNode.super.apply(this,arguments);this.$element.addClass('ve-ce-internalItemNode');};OO.inheritClass(ve.ce.InternalItemNode,ve.ce.BranchNode);ve.ce.InternalItemNode.static.name='internalItem';ve.ce.InternalItemNode.static.tagName='span';ve.ce.nodeFactory.register(ve.ce.InternalItemNode);ve.ce.InternalListNode=function VeCeInternalListNode(){ve.ce.InternalListNode.super.apply(this,arguments);this.$element=$([]);};OO.inheritClass(ve.ce.InternalListNode,ve.ce.BranchNode);ve.ce.InternalListNode.static.name='internalList';ve.ce.InternalListNode.prototype.onSplice=function(){};ve.ce.nodeFactory.register(ve.ce.InternalListNode);ve.ce.ListItemNode=function VeCeListItemNode(){ve.ce.ListItemNode.super.apply(this,arguments);};OO.inheritClass(ve.ce.ListItemNode,ve.ce.BranchNode);ve.ce.ListItemNode.static.name='listItem';ve.ce.ListItemNode.static.tagName='li';ve.ce.ListItemNode.static.splitOnEnter=true;ve.ce.nodeFactory.register(ve.ce.ListItemNode);ve.ce.
ListNode=function VeCeListNode(){ve.ce.ListNode.super.apply(this,arguments);this.model.connect(this,{update:'onUpdate'});};OO.inheritClass(ve.ce.ListNode,ve.ce.BranchNode);ve.ce.ListNode.static.name='list';ve.ce.ListNode.static.removeEmptyLastChildOnEnter=true;ve.ce.ListNode.prototype.getTagName=function(){var style=this.model.getAttribute('style'),types={bullet:'ul',number:'ol'};if(!Object.prototype.hasOwnProperty.call(types,style)){throw new Error('Invalid style');}return types[style];};ve.ce.ListNode.prototype.onUpdate=function(){this.updateTagName();};ve.ce.nodeFactory.register(ve.ce.ListNode);ve.ce.ParagraphNode=function VeCeParagraphNode(){ve.ce.ParagraphNode.super.apply(this,arguments);if(this.model.getElement().internal&&this.model.getElement().internal.generated==='wrapper'){this.$element.addClass('ve-ce-generated-wrapper');}};OO.inheritClass(ve.ce.ParagraphNode,ve.ce.ContentBranchNode);ve.ce.ParagraphNode.static.name='paragraph';ve.ce.ParagraphNode.static.tagName='p';ve.ce.
ParagraphNode.prototype.initialize=function(){ve.ce.ParagraphNode.super.prototype.initialize.call(this);this.$element.addClass('ve-ce-paragraphNode');};ve.ce.nodeFactory.register(ve.ce.ParagraphNode);ve.ce.PreformattedNode=function VeCePreformattedNode(){ve.ce.PreformattedNode.super.apply(this,arguments);};OO.inheritClass(ve.ce.PreformattedNode,ve.ce.ContentBranchNode);ve.ce.PreformattedNode.static.name='preformatted';ve.ce.PreformattedNode.static.tagName='pre';ve.ce.nodeFactory.register(ve.ce.PreformattedNode);ve.ce.SectionNode=function VeCeSectionNode(){ve.ce.SectionNode.super.apply(this,arguments);this.model.connect(this,{update:'onUpdate'});ve.ce.ActiveNode.call(this);this.$element.addClass('ve-ce-sectionNode');};OO.inheritClass(ve.ce.SectionNode,ve.ce.BranchNode);OO.mixinClass(ve.ce.SectionNode,ve.ce.ActiveNode);ve.ce.SectionNode.static.name='section';ve.ce.SectionNode.prototype.getTagName=function(){var style=this.model.getAttribute('style');if(this.model.constructor.static.
matchTagNames.indexOf(style)===-1){throw new Error('Invalid style');}return style;};ve.ce.SectionNode.prototype.onUpdate=function(){this.updateTagName();};ve.ce.nodeFactory.register(ve.ce.SectionNode);ve.ce.TableCaptionNode=function VeCeTableCaptionNode(){ve.ce.TableCaptionNode.super.apply(this,arguments);ve.ce.ActiveNode.call(this);this.$element.addClass('ve-ce-tableCaptionNode');};OO.inheritClass(ve.ce.TableCaptionNode,ve.ce.BranchNode);OO.mixinClass(ve.ce.TableCaptionNode,ve.ce.ActiveNode);ve.ce.TableCaptionNode.static.name='tableCaption';ve.ce.TableCaptionNode.static.tagName='caption';ve.ce.nodeFactory.register(ve.ce.TableCaptionNode);ve.ce.TableCellNode=function VeCeTableCellNode(){ve.ce.TableCellNode.super.apply(this,arguments);ve.ce.TableCellableNode.call(this);ve.ce.ContentEditableNode.call(this);this.setEditing(false);this.model.connect(this,{update:'onUpdate',attributeChange:'onAttributeChange'});this.connect(this,{teardown:'onTableCellTeardown'});};OO.inheritClass(ve.ce.
TableCellNode,ve.ce.BranchNode);OO.mixinClass(ve.ce.TableCellNode,ve.ce.TableCellableNode);OO.mixinClass(ve.ce.TableCellNode,ve.ce.ContentEditableNode);ve.ce.TableCellNode.static.name='tableCell';ve.ce.TableCellNode.static.trapsCursor=true;ve.ce.TableCellNode.prototype.initialize=function(){ve.ce.TableCellNode.super.prototype.initialize.call(this);var rowspan=this.model.getRowspan();var colspan=this.model.getColspan();this.$element.addClass('ve-ce-tableCellNode ve-ce-tableCellNode-'+this.model.getAttribute('style'));if(rowspan>1){this.$element.attr('rowspan',rowspan);}if(colspan>1){this.$element.attr('colspan',colspan);}this.$element.attr('title',ve.msg('visualeditor-tablecell-tooltip'));};ve.ce.TableCellNode.prototype.setEditing=function(enable){this.editing=enable;this.$element.toggleClass('ve-ce-tableCellNode-editing',enable);this.setContentEditable();if(this.getRoot()){this.getRoot().getSurface().setActiveNode(enable?this:null);}if(enable){this.$element.removeAttr('title');}else{
this.$element.attr('title',ve.msg('visualeditor-tablecell-tooltip'));}};ve.ce.TableCellNode.prototype.onTableCellTeardown=function(){if(this.getRoot()){var surface=this.getRoot().getSurface();if(surface.getActiveNode()===this){surface.setActiveNode(null);}}};ve.ce.TableCellNode.prototype.setContentEditable=function(){return ve.ce.ContentEditableNode.prototype.setContentEditable.call(this,this.editing);};ve.ce.TableCellNode.prototype.onUpdate=function(){this.updateTagName();};ve.ce.TableCellNode.prototype.onAttributeChange=function(key,from,to){switch(key){case'colspan':case'rowspan':if(to>1){this.$element.attr(key,to);}else{this.$element.removeAttr(key);}break;case'style':this.$element.removeClass('ve-ce-tableCellNode-'+from).addClass('ve-ce-tableCellNode-'+to);this.updateTagName();break;}};ve.ce.nodeFactory.register(ve.ce.TableCellNode);ve.ce.TableNode=function VeCeTableNode(){ve.ce.TableNode.super.apply(this,arguments);this.surface=null;this.active=false;this.startCell=null;this.
endCell=null;this.editingFragment=null;this.$element.addClass('ve-ce-tableNode').prop('contentEditable','false');};OO.inheritClass(ve.ce.TableNode,ve.ce.BranchNode);ve.ce.TableNode.static.autoFocus=false;ve.ce.TableNode.prototype.onSetup=function(){ve.ce.TableNode.super.prototype.onSetup.call(this);if(this.surface||!this.root){return;}this.surface=this.getRoot().getSurface();this.$selectionBox=$('<div>').addClass('ve-ce-tableNodeOverlay-selection-box');this.$selectionBoxAnchor=$('<div>').addClass('ve-ce-tableNodeOverlay-selection-box-anchor');if(OO.ui.isMobile()){this.nodeContext=new ve.ui.TableLineContext(this,'table');}else{this.nodeContext=null;}this.colContext=new ve.ui.TableLineContext(this,'col');this.rowContext=new ve.ui.TableLineContext(this,'row');this.$overlay=$('<div>').addClass('ve-ce-tableNodeOverlay oo-ui-element-hidden').append(this.$selectionBox,this.$selectionBoxAnchor,this.nodeContext?this.nodeContext.$element:undefined,this.colContext.$element,this.rowContext.
$element,this.$rowBracket,this.$colBracket);this.surface.surface.$blockers.append(this.$overlay);this.$element.on({'mousedown.ve-ce-tableNode':this.onTableMouseDown.bind(this),'dblclick.ve-ce-tableNode':this.onTableDblClick.bind(this)});this.$overlay.on({'mousedown.ve-ce-tableNode':this.onTableMouseDown.bind(this),'dblclick.ve-ce-tableNode':this.onTableDblClick.bind(this)});this.onTableMouseUpHandler=this.onTableMouseUp.bind(this);this.onTableMouseMoveHandler=this.onTableMouseMove.bind(this);this.updateOverlayDebounced=ve.debounce(this.updateOverlay.bind(this));this.surface.getModel().connect(this,{select:'onSurfaceModelSelect'});this.surface.connect(this,{position:this.updateOverlayDebounced,activation:'onSurfaceActivation'});};ve.ce.TableNode.prototype.onTeardown=function(){ve.ce.TableNode.super.prototype.onTeardown.call(this);if(!this.surface){return;}this.$element.off('.ve-ce-tableNode');this.$overlay.off('.ve-ce-tableNode');this.surface.getModel().disconnect(this);this.surface.
disconnect(this);this.$overlay.remove();this.surface=null;};ve.ce.TableNode.prototype.onTableDblClick=function(e){if(!this.getCellNodeFromEvent(e)){return;}if(this.surface.getModel().getSelection()instanceof ve.dm.TableSelection){this.setEditing(true,true);var offset=this.surface.getOffsetFromEventCoords(e.originalEvent);if(offset!==-1){this.surface.getModel().setLinearSelection(new ve.Range(offset));}else{this.setEditing(true);}}};ve.ce.TableNode.prototype.onTableMouseDown=function(e){var node=this;var cellNode=this.getCellNodeFromEvent(e);if(!cellNode){return;}var endCell=this.getModel().getMatrix().lookupCell(cellNode.getModel());if(!endCell){e.preventDefault();return;}var selection=this.surface.getModel().getSelection();var startCell;var newSelection;if(e.shiftKey&&this.active){if(selection instanceof ve.dm.TableSelection){startCell={col:selection.fromCol,row:selection.fromRow};}else{startCell=this.getModel().getMatrix().lookupCell(this.getActiveCellNode().getModel());}}else if((e.
which===OO.ui.MouseButtons.RIGHT||this.surface.isDeactivated())&&selection instanceof ve.dm.TableSelection&&selection.containsCell(endCell)){newSelection=selection;startCell=this.startCell||endCell;}else{startCell=endCell;}if(!newSelection){newSelection=new ve.dm.TableSelection(this.getModel().getOuterRange(),startCell.col,startCell.row,endCell.col,endCell.row);newSelection=newSelection.expand(this.getModel().getDocument());}if(this.editingFragment){if(newSelection.equals(this.editingFragment.getSelection())){return;}else{this.setEditing(false,true);}}this.surface.getModel().setSelection(newSelection);this.surface.activate();if(e.which===OO.ui.MouseButtons.RIGHT&&!this.getActiveCellNode()){cellNode.$element.prop('contentEditable',true);ve.selectElement(cellNode.$element[0]);setTimeout(function(){cellNode.$element.prop('contentEditable','false');node.surface.onModelSelect();});return;}this.startCell=startCell;this.endCell=endCell;if(!(selection instanceof ve.dm.TableSelection)&&OO.ui.
isMobile()){setTimeout(function(){node.onTableDblClick(e);});}else{this.surface.$document.on({'mouseup touchend':this.onTableMouseUpHandler,'mousemove touchmove':this.onTableMouseMoveHandler});}e.preventDefault();};ve.ce.TableNode.prototype.getCellNodeFromEvent=function(e){if(e.type==='touchstart'&&e.originalEvent.touches.length>1){return null;}else if(e.type==='touchmove'){if(e.originalEvent.touches.length>1){return null;}var touch=e.originalEvent.touches[0];return this.getCellNodeFromPoint(touch.clientX,touch.clientY);}else{return this.getNearestCellNode(e.target);}};ve.ce.TableNode.prototype.getCellNodeFromPoint=function(x,y){return this.getNearestCellNode(this.surface.getElementDocument().elementFromPoint(x,y));};ve.ce.TableNode.prototype.getNearestCellNode=function(element){var $element=$(element),$table=$element.closest('table');if(!this.$element.is($table)){return null;}return $element.closest('td, th').data('view');};ve.ce.TableNode.prototype.onTableMouseMove=function(e){var
endCellNode=this.getCellNodeFromEvent(e);if(!endCellNode){return;}var endCell=this.getModel().matrix.lookupCell(endCellNode.getModel());if(!endCell||endCell===this.endCell){return;}this.endCell=endCell;var selection=new ve.dm.TableSelection(this.getModel().getOuterRange(),this.startCell.col,this.startCell.row,endCell.col,endCell.row);selection=selection.expand(this.getModel().getDocument());this.surface.getModel().setSelection(selection);};ve.ce.TableNode.prototype.onTableMouseUp=function(){this.startCell=null;this.endCell=null;this.surface.$document.off({'mouseup touchend':this.onTableMouseUpHandler,'mousemove touchmove':this.onTableMouseMoveHandler});};ve.ce.TableNode.prototype.setEditing=function(isEditing,noSelect){var surfaceModel=this.surface.getModel(),documentModel=surfaceModel.getDocument(),selection=surfaceModel.getSelection();if(isEditing){if(!selection.isSingleCell(documentModel)){selection=selection.collapseToFrom();this.surface.getModel().setSelection(selection);}var cell
=this.getCellNodesFromSelection(selection)[0];if(!cell.isCellEditable()){return;}this.editingFragment=this.surface.getModel().getFragment(selection);cell.setEditing(true);if(!noSelect){var cellRange=cell.getModel().getRange();var offset=surfaceModel.getDocument().data.getNearestContentOffset(cellRange.end,-1);if(offset>cellRange.start){surfaceModel.setLinearSelection(new ve.Range(offset));}}}else{var activeCellNode;if((activeCellNode=this.getActiveCellNode())){activeCellNode.setEditing(false);if(!noSelect){surfaceModel.setSelection(this.editingFragment.getSelection());}}this.editingFragment=null;}this.$element.toggleClass('ve-ce-tableNode-editing',isEditing);var profile=$.client.profile();if(profile.layout==='gecko'&&profile.versionBase==='39'){this.$element.prop('contentEditable',isEditing.toString());}this.$overlay.toggleClass('ve-ce-tableNodeOverlay-editing',isEditing);};ve.ce.TableNode.prototype.onSurfaceModelSelect=function(selection){var active=(this.editingFragment!==null&&
selection instanceof ve.dm.LinearSelection&&this.editingFragment.getSelection().getRanges(this.editingFragment.getDocument())[0].containsRange(selection.getRange()))||(selection instanceof ve.dm.TableSelection&&selection.tableRange.equalsSelection(this.getModel().getOuterRange()));if(active){if(!this.active){this.$overlay.removeClass('oo-ui-element-hidden');this.$element.on('touchstart.ve-ce-tableNode',this.onTableMouseDown.bind(this));}if(selection instanceof ve.dm.TableSelection){if(this.editingFragment){this.setEditing(false,true);}this.updateOverlayDebounced();}}else if(!active&&this.active){this.$overlay.addClass('oo-ui-element-hidden');if(this.editingFragment){this.setEditing(false,true);}if(this.getActiveCellNode()){this.surface.setActiveNode(null);}this.$element.off('touchstart.ve-ce-tableNode');}this.$element.toggleClass('ve-ce-tableNode-active',active);this.active=active;};ve.ce.TableNode.prototype.getActiveCellNode=function(){var activeNode=this.surface.getActiveNode(),
tableNodeOfActiveCellNode=activeNode&&activeNode instanceof ve.ce.TableCellNode&&activeNode.findParent(ve.ce.TableNode);return tableNodeOfActiveCellNode===this?activeNode:null;};ve.ce.TableNode.prototype.onSurfaceActivation=function(){this.$overlay.toggleClass('ve-ce-tableNodeOverlay-deactivated',!!this.surface.isShownAsDeactivated());};ve.ce.TableNode.prototype.updateOverlay=function(){if(!this.active||!this.root||!this.surface||!this.surface.surface.$blockers[0].parentNode){return;}var selection=this.editingFragment?this.editingFragment.getSelection():this.surface.getModel().getSelection();var documentModel=this.editingFragment?this.editingFragment.getDocument():this.surface.getModel().getDocument();var tableOffset=this.getFirstSectionNode().$element[0].getBoundingClientRect();var surfaceOffset=this.surface.getSurface().$element[0].getBoundingClientRect();if(!tableOffset){return;}var selectionRect=this.surface.getSelection(selection).getSelectionBoundingRect();if(!selectionRect){
return;}var selectionOffset=ve.translateRect(selectionRect,surfaceOffset.left-tableOffset.left,surfaceOffset.top-tableOffset.top);var anchorOffset;if(selection.isSingleCell(documentModel)){anchorOffset=selectionOffset;}else{anchorOffset=ve.translateRect(this.surface.getSelection(selection.collapseToFrom()).getSelectionBoundingRect(),surfaceOffset.left-tableOffset.left,surfaceOffset.top-tableOffset.top);}this.$selectionBox.css({top:selectionOffset.top,left:selectionOffset.left,width:selectionOffset.width,height:selectionOffset.height});this.$selectionBoxAnchor.css({top:anchorOffset.top,left:anchorOffset.left,width:anchorOffset.width,height:anchorOffset.height});this.$overlay.css({top:tableOffset.top-surfaceOffset.top,left:tableOffset.left-surfaceOffset.left,width:tableOffset.width});this.colContext.icon.$element.css({left:selectionOffset.left,width:selectionOffset.width});this.rowContext.icon.$element.css({top:selectionOffset.top,height:selectionOffset.height});if(this.nodeContext){this
.nodeContext.$element.toggleClass('oo-ui-element-hidden',this.surface.isReadOnly());}this.colContext.$element.toggleClass('oo-ui-element-hidden',this.surface.isReadOnly());this.rowContext.$element.toggleClass('oo-ui-element-hidden',this.surface.isReadOnly());this.$selectionBox.toggleClass('ve-ce-tableNodeOverlay-selection-box-notEditable',!selection.isEditable(documentModel));};ve.ce.TableNode.prototype.getFirstSectionNode=function(){var i=0;while(!(this.children[i]instanceof ve.ce.TableSectionNode)){i++;}return this.children[i];};ve.ce.TableNode.prototype.getCellNodesFromSelection=function(selection){var cells=selection.getMatrixCells(this.getModel().getDocument()),nodes=[];for(var i=0,l=cells.length;i<l;i++){var cellModel=cells[i].node;var cellView=this.getNodeFromOffset(cellModel.getOffset()-this.model.getOffset());nodes.push(cellView);}return nodes;};ve.ce.TableNode.static.name='table';ve.ce.TableNode.static.tagName='table';ve.ce.nodeFactory.register(ve.ce.TableNode);ve.ce.
TableRowNode=function VeCeTableRowNode(){ve.ce.TableRowNode.super.apply(this,arguments);this.$missingCell=null;};OO.inheritClass(ve.ce.TableRowNode,ve.ce.BranchNode);ve.ce.TableRowNode.static.name='tableRow';ve.ce.TableRowNode.static.tagName='tr';ve.ce.TableRowNode.prototype.onSetup=function(){ve.ce.TableRowNode.super.prototype.onSetup.apply(this,arguments);this.setupMissingCell();};ve.ce.TableRowNode.prototype.onSplice=function(){var node=this;ve.ce.TableRowNode.super.prototype.onSplice.apply(this,arguments);setTimeout(function(){if(node.getRoot()){node.setupMissingCell();}});};ve.ce.TableRowNode.prototype.setupMissingCell=function(){var matrix=this.findParent(ve.ce.TableNode).getModel().getMatrix(),maxColCount=matrix.getMaxColCount();var row=matrix.getRowNodes().indexOf(this.model);if(maxColCount>matrix.getColCount(row)){if(!this.$missingCell){this.$missingCell=$('<td>').prop('contentEditable','false').addClass(
've-ce-branchNode-slug ve-ce-branchNode-blockSlug ve-ce-tableNode-missingCell');var slugButton=new ve.ui.NoFocusButtonWidget({icon:'add',framed:false}).on('click',this.onMissingCellClick.bind(this));this.$missingCell.append(slugButton.$element);}this.$element.append(this.$missingCell);}else{this.removeSlugs();}};ve.ce.TableRowNode.prototype.removeSlugs=function(){if(this.$missingCell){this.$missingCell.detach();}};ve.ce.TableRowNode.prototype.onMissingCellClick=function(){var surfaceModel=this.getRoot().getSurface().getModel(),documentModel=surfaceModel.getDocument(),tableModel=this.findParent(ve.ce.TableNode).getModel(),matrix=tableModel.getMatrix();surfaceModel.change(ve.dm.TransactionBuilder.static.newFromInsertion(documentModel,this.getModel().getRange().end,ve.dm.TableCellNode.static.createData()));var row=matrix.getRowNodes().indexOf(this.model);var col=matrix.getColCount(row)-1;surfaceModel.setSelection(new ve.dm.TableSelection(tableModel.getOuterRange(),col,row));};ve.ce.
nodeFactory.register(ve.ce.TableRowNode);ve.ce.TableSectionNode=function VeCeTableSectionNode(){ve.ce.TableSectionNode.super.apply(this,arguments);this.model.connect(this,{update:'onUpdate'});};OO.inheritClass(ve.ce.TableSectionNode,ve.ce.BranchNode);ve.ce.TableSectionNode.static.name='tableSection';ve.ce.TableSectionNode.prototype.getTagName=function(){var style=this.model.getAttribute('style'),types={header:'thead',body:'tbody',footer:'tfoot'};if(!Object.prototype.hasOwnProperty.call(types,style)){throw new Error('Invalid style');}return types[style];};ve.ce.TableSectionNode.prototype.onUpdate=function(){this.updateTagName();};ve.ce.nodeFactory.register(ve.ce.TableSectionNode);ve.ce.TextNode=function VeCeTextNode(){ve.ce.TextNode.super.apply(this,arguments);this.$element=$([]);};OO.inheritClass(ve.ce.TextNode,ve.ce.LeafNode);ve.ce.TextNode.static.name='text';ve.ce.TextNode.static.splitOnEnter=true;ve.ce.TextNode.static.whitespaceHtmlCharacters=ve.visibleWhitespaceCharacters;ve.ce.
TextNode.prototype.getAnnotatedHtml=function(){var data=this.model.getDocument().getDataFromNode(this.model),whitespaceHtmlChars=ve.visibleWhitespaceCharacters,significantWhitespace=this.getModel().getParent().hasSignificantWhitespace();function setChar(chr,index){if(Array.isArray(data[index])){data[index]=data[index].slice(0);data[index][0]=chr;}else{data[index]=chr;}}function getChar(index){if(Array.isArray(data[index])){return data[index][0];}else{return data[index];}}if(!significantWhitespace){for(var i=0;i<data.length;i++){var char=getChar(i);if(Object.prototype.hasOwnProperty.call(whitespaceHtmlChars,char)){setChar(whitespaceHtmlChars[char],i);}}}return data;};ve.ce.nodeFactory.register(ve.ce.TextNode);ve.ce.UnrenderedNode=function VeCeUnrenderedNode(){ve.ce.UnrenderedNode.super.apply(this,arguments);this.$element=$([]);};OO.inheritClass(ve.ce.UnrenderedNode,ve.ce.LeafNode);ve.ce.UnrenderedNode.static.name='unrendered';ve.ce.ImageNode=function VeCeImageNode($figure,$image,config)
{config=ve.extendObject({enforceMax:false,minDimensions:{width:1,height:1},$bounding:this.$element},config);this.$figure=$figure;this.$image=$image||$figure;ve.ce.FocusableNode.call(this,this.$figure,config);ve.ce.ResizableNode.call(this,this.$image,config);this.$image.on('load',this.onLoad.bind(this));this.model.connect(this,{attributeChange:'onAttributeChange'});this.$element.addClass('ve-ce-imageNode');};OO.mixinClass(ve.ce.ImageNode,ve.ce.FocusableNode);OO.mixinClass(ve.ce.ImageNode,ve.ce.ResizableNode);ve.ce.ImageNode.static.getDescription=function(model){return model.getAttribute('src');};ve.ce.ImageNode.prototype.onAttributeChange=function(key,from,to){switch(key){case'src':this.$image.prop('src',this.getResolvedAttribute('src'));break;case'width':case'height':this.$image.css(key,to!==null?to:'');break;}};ve.ce.ImageNode.prototype.onLoad=function(){if(!this.model){return;}this.setOriginalDimensions({width:this.$image.prop('naturalWidth'),height:this.$image.prop('naturalHeight')}
);};ve.ce.BlockImageNode=function VeCeBlockImageNode(model,config){config=ve.extendObject({minDimensions:{width:1,height:1}},config);ve.ce.BlockImageNode.super.call(this,model,config);this.$image=$('<img>').prop('src',this.getResolvedAttribute('src')).prependTo(this.$element);ve.ce.ImageNode.call(this,this.$image,this.$image,config);ve.ce.AlignableNode.call(this,this.$element,config);this.$element.addClass('ve-ce-blockImageNode');this.$image.prop({alt:this.model.getAttribute('alt'),src:this.getResolvedAttribute('src')}).css({width:this.model.getAttribute('width'),height:this.model.getAttribute('height')});};OO.inheritClass(ve.ce.BlockImageNode,ve.ce.BranchNode);OO.mixinClass(ve.ce.BlockImageNode,ve.ce.ImageNode);OO.mixinClass(ve.ce.BlockImageNode,ve.ce.ClassAttributeNode);OO.mixinClass(ve.ce.BlockImageNode,ve.ce.AlignableNode);ve.ce.BlockImageNode.static.name='blockImage';ve.ce.BlockImageNode.static.tagName='figure';ve.ce.BlockImageNode.static.autoFocus=false;ve.ce.nodeFactory.register
(ve.ce.BlockImageNode);ve.ce.BlockImageCaptionNode=function VeCeBlockImageCaptionNode(){ve.ce.BlockImageCaptionNode.super.apply(this,arguments);ve.ce.ActiveNode.call(this);};OO.inheritClass(ve.ce.BlockImageCaptionNode,ve.ce.BranchNode);OO.mixinClass(ve.ce.BlockImageCaptionNode,ve.ce.ActiveNode);ve.ce.BlockImageCaptionNode.static.name='imageCaption';ve.ce.BlockImageCaptionNode.static.tagName='figcaption';ve.ce.BlockImageCaptionNode.static.isMultiline=false;ve.ce.nodeFactory.register(ve.ce.BlockImageCaptionNode);ve.ce.InlineImageNode=function VeCeInlineImageNode(model,config){config=ve.extendObject({minDimensions:{width:1,height:1}},config);ve.ce.InlineImageNode.super.call(this,model,config);ve.ce.ImageNode.call(this,this.$element,null,config);this.$element.addClass('ve-ce-inlineImageNode').prop({alt:this.model.getAttribute('alt'),src:this.getResolvedAttribute('src')}).css({width:this.model.getAttribute('width'),height:this.model.getAttribute('height')});};OO.inheritClass(ve.ce.
InlineImageNode,ve.ce.LeafNode);OO.mixinClass(ve.ce.InlineImageNode,ve.ce.ImageNode);ve.ce.InlineImageNode.static.name='inlineImage';ve.ce.InlineImageNode.static.tagName='img';ve.ce.nodeFactory.register(ve.ce.InlineImageNode);ve.ce.NailedAnnotation=function VeCeNailedAnnotation(){this.contentFragment=document.createDocumentFragment();this.$element.addClass('ve-ce-nailedAnnotation');};OO.initClass(ve.ce.NailedAnnotation);ve.ce.NailedAnnotation.static.canBeActive=true;ve.ce.NailedAnnotation.static.makeNail=function(type){var nail=document.createElement('img');if($.client.profile().layout==='gecko'||ve.inputDebug){nail.src=ve.inputDebug?ve.ce.nailImgDataUri:ve.ce.minImgDataUri;}nail.className='ve-ce-nail ve-ce-nail-'+type+(ve.inputDebug?' ve-ce-nail-debug':'');return nail;};ve.ce.NailedAnnotation.prototype.getContentContainer=function(){return this.contentFragment;};ve.ce.NailedAnnotation.prototype.attachContents=function(){var element=this.$element[0];element.appendChild(this.constructor
.static.makeNail('post-open'));element.appendChild(this.contentFragment);element.appendChild(this.constructor.static.makeNail('pre-close'));};ve.ce.NailedAnnotation.prototype.appendTo=function(node){node.appendChild(this.constructor.static.makeNail('pre-open'));node.appendChild(this.$element[0]);node.appendChild(this.constructor.static.makeNail('post-close'));};ve.ce.LinkAnnotation=function VeCeLinkAnnotation(model,parentNode,config){ve.ce.LinkAnnotation.super.call(this,model,parentNode,ve.extendObject({$element:$('<a>')},config));ve.ce.NailedAnnotation.call(this);this.$element.addClass('ve-ce-linkAnnotation').prop({href:ve.resolveUrl(this.model.getHref(),this.getModelHtmlDocument()),title:this.constructor.static.getDescription(this.model)});this.$element.on('click',this.onClick.bind(this));this.$anchor=this.$element;};OO.inheritClass(ve.ce.LinkAnnotation,ve.ce.Annotation);OO.mixinClass(ve.ce.LinkAnnotation,ve.ce.NailedAnnotation);ve.ce.LinkAnnotation.static.name='link';ve.ce.
LinkAnnotation.static.tagName='span';ve.ce.LinkAnnotation.static.getDescription=function(model){return model.getHref();};ve.ce.LinkAnnotation.prototype.onClick=function(e){if(e.which===OO.ui.MouseButtons.LEFT&&(e.ctrlKey||e.metaKey)){window.open(this.$element.prop('href'));e.preventDefault();}};ve.ce.annotationFactory.register(ve.ce.LinkAnnotation);ve.ce.TextStyleAnnotation=function VeCeTextStyleAnnotation(){ve.ce.TextStyleAnnotation.super.apply(this,arguments);this.$element.addClass('ve-ce-textStyleAnnotation');};OO.inheritClass(ve.ce.TextStyleAnnotation,ve.ce.Annotation);ve.ce.TextStyleAnnotation.static.name='textStyle';ve.ce.TextStyleAnnotation.prototype.getTagName=function(){return this.getModel().getAttribute('nodeName')||this.constructor.static.tagName;};ve.ce.annotationFactory.register(ve.ce.TextStyleAnnotation);ve.ce.AbbreviationAnnotation=function VeCeAbbreviationAnnotation(){ve.ce.AbbreviationAnnotation.super.apply(this,arguments);this.$element.addClass(
've-ce-abbreviationAnnotation');};OO.inheritClass(ve.ce.AbbreviationAnnotation,ve.ce.TextStyleAnnotation);ve.ce.AbbreviationAnnotation.static.name='textStyle/abbreviation';ve.ce.AbbreviationAnnotation.static.tagName='abbr';ve.ce.annotationFactory.register(ve.ce.AbbreviationAnnotation);ve.ce.BidiAnnotation=function VeCeBidiAnnotation(){ve.ce.BidiAnnotation.super.apply(this,arguments);this.$element.addClass('ve-ce-bidiAnnotation');};OO.inheritClass(ve.ce.BidiAnnotation,ve.ce.TextStyleAnnotation);ve.ce.BidiAnnotation.static.name='textStyle/bidi';ve.ce.BidiAnnotation.static.tagName='bdi';ve.ce.annotationFactory.register(ve.ce.BidiAnnotation);ve.ce.BigAnnotation=function VeCeBigAnnotation(){ve.ce.BigAnnotation.super.apply(this,arguments);this.$element.addClass('ve-ce-bigAnnotation');};OO.inheritClass(ve.ce.BigAnnotation,ve.ce.TextStyleAnnotation);ve.ce.BigAnnotation.static.name='textStyle/big';ve.ce.BigAnnotation.static.tagName='big';ve.ce.annotationFactory.register(ve.ce.BigAnnotation);ve.
ce.BoldAnnotation=function VeCeBoldAnnotation(){ve.ce.BoldAnnotation.super.apply(this,arguments);this.$element.addClass('ve-ce-boldAnnotation');};OO.inheritClass(ve.ce.BoldAnnotation,ve.ce.TextStyleAnnotation);ve.ce.BoldAnnotation.static.name='textStyle/bold';ve.ce.BoldAnnotation.static.tagName='b';ve.ce.annotationFactory.register(ve.ce.BoldAnnotation);ve.ce.CodeAnnotation=function VeCeCodeAnnotation(){ve.ce.CodeAnnotation.super.apply(this,arguments);this.$element.addClass('ve-ce-codeAnnotation');};OO.inheritClass(ve.ce.CodeAnnotation,ve.ce.TextStyleAnnotation);ve.ce.CodeAnnotation.static.name='textStyle/code';ve.ce.CodeAnnotation.static.tagName='code';ve.ce.annotationFactory.register(ve.ce.CodeAnnotation);ve.ce.CodeSampleAnnotation=function VeCeCodeSampleAnnotation(){ve.ce.CodeSampleAnnotation.super.apply(this,arguments);this.$element.addClass('ve-ce-codeSampleAnnotation');};OO.inheritClass(ve.ce.CodeSampleAnnotation,ve.ce.TextStyleAnnotation);ve.ce.CodeSampleAnnotation.static.name=
'textStyle/codeSample';ve.ce.CodeSampleAnnotation.static.tagName='samp';ve.ce.annotationFactory.register(ve.ce.CodeSampleAnnotation);ve.ce.DatetimeAnnotation=function VeCeDatetimeAnnotation(){ve.ce.DatetimeAnnotation.super.apply(this,arguments);this.$element.addClass('ve-ce-datetimeAnnotation');};OO.inheritClass(ve.ce.DatetimeAnnotation,ve.ce.TextStyleAnnotation);ve.ce.DatetimeAnnotation.static.name='textStyle/datetime';ve.ce.DatetimeAnnotation.static.tagName='time';ve.ce.annotationFactory.register(ve.ce.DatetimeAnnotation);ve.ce.DefinitionAnnotation=function VeCeDefinitionAnnotation(){ve.ce.DefinitionAnnotation.super.apply(this,arguments);this.$element.addClass('ve-ce-definitionAnnotation');};OO.inheritClass(ve.ce.DefinitionAnnotation,ve.ce.TextStyleAnnotation);ve.ce.DefinitionAnnotation.static.name='textStyle/definition';ve.ce.DefinitionAnnotation.static.tagName='dfn';ve.ce.annotationFactory.register(ve.ce.DefinitionAnnotation);ve.ce.DeleteAnnotation=function VeCeDeleteAnnotation(){
ve.ce.DeleteAnnotation.super.apply(this,arguments);this.$element.addClass('ve-ce-deleteAnnotation');};OO.inheritClass(ve.ce.DeleteAnnotation,ve.ce.TextStyleAnnotation);ve.ce.DeleteAnnotation.static.name='textStyle/delete';ve.ce.DeleteAnnotation.static.tagName='del';ve.ce.annotationFactory.register(ve.ce.DeleteAnnotation);ve.ce.FontAnnotation=function VeCeFontAnnotation(){ve.ce.FontAnnotation.super.apply(this,arguments);this.$element.addClass('ve-ce-fontAnnotation');};OO.inheritClass(ve.ce.FontAnnotation,ve.ce.TextStyleAnnotation);ve.ce.FontAnnotation.static.name='textStyle/font';ve.ce.FontAnnotation.static.tagName='font';ve.ce.annotationFactory.register(ve.ce.FontAnnotation);ve.ce.HighlightAnnotation=function VeCeHighlightAnnotation(){ve.ce.HighlightAnnotation.super.apply(this,arguments);this.$element.addClass('ve-ce-highlightAnnotation');};OO.inheritClass(ve.ce.HighlightAnnotation,ve.ce.TextStyleAnnotation);ve.ce.HighlightAnnotation.static.name='textStyle/highlight';ve.ce.
HighlightAnnotation.static.tagName='mark';ve.ce.annotationFactory.register(ve.ce.HighlightAnnotation);ve.ce.InsertAnnotation=function VeCeInsertAnnotation(){ve.ce.InsertAnnotation.super.apply(this,arguments);this.$element.addClass('ve-ce-insertAnnotation');};OO.inheritClass(ve.ce.InsertAnnotation,ve.ce.TextStyleAnnotation);ve.ce.InsertAnnotation.static.name='textStyle/insert';ve.ce.InsertAnnotation.static.tagName='ins';ve.ce.annotationFactory.register(ve.ce.InsertAnnotation);ve.ce.ItalicAnnotation=function VeCeItalicAnnotation(){ve.ce.ItalicAnnotation.super.apply(this,arguments);this.$element.addClass('ve-ce-italicAnnotation');};OO.inheritClass(ve.ce.ItalicAnnotation,ve.ce.TextStyleAnnotation);ve.ce.ItalicAnnotation.static.name='textStyle/italic';ve.ce.ItalicAnnotation.static.tagName='i';ve.ce.annotationFactory.register(ve.ce.ItalicAnnotation);ve.ce.QuotationAnnotation=function VeCeQuotationAnnotation(){ve.ce.QuotationAnnotation.super.apply(this,arguments);this.$element.addClass(
've-ce-quotationAnnotation');};OO.inheritClass(ve.ce.QuotationAnnotation,ve.ce.TextStyleAnnotation);ve.ce.QuotationAnnotation.static.name='textStyle/quotation';ve.ce.QuotationAnnotation.static.tagName='q';ve.ce.annotationFactory.register(ve.ce.QuotationAnnotation);ve.ce.SmallAnnotation=function VeCeSmallAnnotation(){ve.ce.SmallAnnotation.super.apply(this,arguments);this.$element.addClass('ve-ce-smallAnnotation');};OO.inheritClass(ve.ce.SmallAnnotation,ve.ce.TextStyleAnnotation);ve.ce.SmallAnnotation.static.name='textStyle/small';ve.ce.SmallAnnotation.static.tagName='small';ve.ce.annotationFactory.register(ve.ce.SmallAnnotation);ve.ce.SpanAnnotation=function VeCeSpanAnnotation(){ve.ce.SpanAnnotation.super.apply(this,arguments);this.$element.addClass('ve-ce-spanAnnotation');};OO.inheritClass(ve.ce.SpanAnnotation,ve.ce.TextStyleAnnotation);ve.ce.SpanAnnotation.static.name='textStyle/span';ve.ce.SpanAnnotation.static.tagName='span';ve.ce.annotationFactory.register(ve.ce.SpanAnnotation);ve.
ce.StrikethroughAnnotation=function VeCeStrikethroughAnnotation(){ve.ce.StrikethroughAnnotation.super.apply(this,arguments);this.$element.addClass('ve-ce-strikethroughAnnotation');};OO.inheritClass(ve.ce.StrikethroughAnnotation,ve.ce.TextStyleAnnotation);ve.ce.StrikethroughAnnotation.static.name='textStyle/strikethrough';ve.ce.StrikethroughAnnotation.static.tagName='s';ve.ce.annotationFactory.register(ve.ce.StrikethroughAnnotation);ve.ce.SubscriptAnnotation=function VeCeSubscriptAnnotation(){ve.ce.SubscriptAnnotation.super.apply(this,arguments);this.$element.addClass('ve-ce-subscriptAnnotation');};OO.inheritClass(ve.ce.SubscriptAnnotation,ve.ce.TextStyleAnnotation);ve.ce.SubscriptAnnotation.static.name='textStyle/subscript';ve.ce.SubscriptAnnotation.static.tagName='sub';ve.ce.annotationFactory.register(ve.ce.SubscriptAnnotation);ve.ce.SuperscriptAnnotation=function VeCeSuperscriptAnnotation(){ve.ce.SuperscriptAnnotation.super.apply(this,arguments);this.$element.addClass(
've-ce-superscriptAnnotation');};OO.inheritClass(ve.ce.SuperscriptAnnotation,ve.ce.TextStyleAnnotation);ve.ce.SuperscriptAnnotation.static.name='textStyle/superscript';ve.ce.SuperscriptAnnotation.static.tagName='sup';ve.ce.annotationFactory.register(ve.ce.SuperscriptAnnotation);ve.ce.UnderlineAnnotation=function VeCeUnderlineAnnotation(){ve.ce.UnderlineAnnotation.super.apply(this,arguments);this.$element.addClass('ve-ce-underlineAnnotation');};OO.inheritClass(ve.ce.UnderlineAnnotation,ve.ce.TextStyleAnnotation);ve.ce.UnderlineAnnotation.static.name='textStyle/underline';ve.ce.UnderlineAnnotation.static.tagName='u';ve.ce.annotationFactory.register(ve.ce.UnderlineAnnotation);ve.ce.UserInputAnnotation=function VeCeUserInputAnnotation(){ve.ce.UserInputAnnotation.super.apply(this,arguments);this.$element.addClass('ve-ce-userInputAnnotation');};OO.inheritClass(ve.ce.UserInputAnnotation,ve.ce.TextStyleAnnotation);ve.ce.UserInputAnnotation.static.name='textStyle/userInput';ve.ce.
UserInputAnnotation.static.tagName='kbd';ve.ce.annotationFactory.register(ve.ce.UserInputAnnotation);ve.ce.VariableAnnotation=function VeCeVariableAnnotation(){ve.ce.VariableAnnotation.super.apply(this,arguments);this.$element.addClass('ve-ce-variableAnnotation');};OO.inheritClass(ve.ce.VariableAnnotation,ve.ce.TextStyleAnnotation);ve.ce.VariableAnnotation.static.name='textStyle/variable';ve.ce.VariableAnnotation.static.tagName='var';ve.ce.annotationFactory.register(ve.ce.VariableAnnotation);ve.ui={windowFactory:new OO.Factory()};ve.ui.windowFactory.register(OO.ui.MessageDialog);ve.ui.Overlay=function VeUiOverlay(){ve.ui.Overlay.super.apply(this,arguments);this.$element.addClass('ve-ui-overlay');};OO.inheritClass(ve.ui.Overlay,OO.ui.Element);ve.ui.Surface=function VeUiSurface(dataOrDocOrSurface,config){config=config||{};ve.ui.Surface.super.call(this,config);this.$scrollContainer=config.$scrollContainer||$(this.getClosestScrollableElementContainer());this.$scrollListener=config.
$scrollListener||$(this.getElementWindow());this.inDialog=config.inDialog||'';this.inTargetWidget=!!config.inTargetWidget;this.mode=config.mode;this.globalOverlay=new ve.ui.Overlay({classes:['ve-ui-overlay-global','ve-ui-overlay-global-'+(OO.ui.isMobile()?'mobile':'desktop')]});this.localOverlay=new ve.ui.Overlay({classes:['ve-ui-overlay-local']});this.$selections=$('<div>');this.$blockers=$('<div>');this.$controls=$('<div>');this.$menus=$('<div>');this.$placeholder=$('<div>').addClass('ve-ui-surface-placeholder');this.commandRegistry=config.commandRegistry||ve.ui.commandRegistry;this.sequenceRegistry=config.sequenceRegistry||ve.ui.sequenceRegistry;this.dataTransferHandlerFactory=config.dataTransferHandlerFactory||ve.ui.dataTransferHandlerFactory;this.commands=OO.simpleArrayDifference(config.includeCommands||this.commandRegistry.getNames(),config.excludeCommands||[]);this.triggerListener=new ve.TriggerListener(this.commands,this.commandRegistry);if(dataOrDocOrSurface instanceof ve.dm.
Surface){this.model=dataOrDocOrSurface;}else{var documentModel;if(dataOrDocOrSurface instanceof ve.dm.Document){documentModel=dataOrDocOrSurface;}else if(dataOrDocOrSurface instanceof ve.dm.ElementLinearData||Array.isArray(dataOrDocOrSurface)){documentModel=new ve.dm.Document(dataOrDocOrSurface);}else{documentModel=ve.dm.converter.getModelFromDom(dataOrDocOrSurface);}this.model=this.createModel(documentModel,config.attachedRoot);}this.view=this.createView(this.model);this.dialogs=this.createDialogWindowManager();this.importRules=config.importRules||{};this.multiline=config.multiline!==false;this.context=this.createContext({$popupContainer:config.$overlayContainer,popupPadding:config.overlayPadding});this.progresses=[];this.showProgressDebounced=ve.debounce(this.showProgress.bind(this));this.scrollSelectionIntoViewDebounced=ve.debounce(this.scrollSelectionIntoView.bind(this),500);this.debugBar=null;this.placeholder=null;this.placeholderVisible=false;this.setPlaceholder(config.
placeholder);this.setReadOnly(!!config.readOnly);this.nullSelectionOnBlur=config.nullSelectionOnBlur!==false;this.completion=new ve.ui.CompletionWidget(this);this.toolbarHeight=0;this.padding={top:0,right:0,bottom:0,left:0};this.toolbarDialogs=new ve.ui.ToolbarDialogWindowManager(this,{factory:ve.ui.windowFactory,modal:false});this.getModel().connect(this,{select:'onModelSelect',blur:'onModelBlur',focus:'onModelFocus'});this.getModel().getDocument().connect(this,{transact:'onDocumentTransact'});this.getView().connect(this,{position:'onViewPosition',activation:'onViewActivation'});this.getContext().connect(this,{resize:'onContextResize'});if(OO.ui.isMobile()){this.globalOverlay.$element.append(this.context.$element);}else{this.$menus.append(this.context.$element);}this.$menus.append(this.completion.$element);this.$element.addClass('ve-ui-surface ve-ui-surface-'+this.mode).append(this.view.$element);if(this.mode==='source'){this.getView().$element.add(this.$placeholder).addClass(
've-ui-surface-source-font');}this.view.$element.after(this.localOverlay.$element);this.localOverlay.$element.append(this.$selections,this.$blockers,this.$controls,this.$menus);this.globalOverlay.$element.append(this.dialogs.$element);};OO.inheritClass(ve.ui.Surface,OO.ui.Widget);ve.ui.Surface.prototype.destroy=function(){this.context.destroy();this.dialogs.destroy();this.toolbarDialogs.destroy();this.view.destroy();if(this.debugBar){this.debugBar.destroy();}this.dialogs.disconnect(this);this.context.getInspectors().disconnect(this);this.$element.remove();this.globalOverlay.$element.remove();this.emit('destroy');return this;};ve.ui.Surface.prototype.initialize=function(){$(document.body).append(this.globalOverlay.$element);if(ve.debug){this.setupDebugBar();}this.$element.addClass('ve-ui-surface-dir-'+this.getDir());this.getView().initialize();this.getModel().initialize();this.emit('ready');return this;};ve.ui.Surface.prototype.getDom=function(){return this.getModel().getDom();};ve.ui.
Surface.prototype.getHtml=function(){return this.getModel().getHtml();};ve.ui.Surface.prototype.getMode=function(){return this.mode;};ve.ui.Surface.prototype.createContext=function(config){return OO.ui.isMobile()?new ve.ui.MobileContext(this,config):new ve.ui.DesktopContext(this,config);};ve.ui.Surface.prototype.createDialogWindowManager=function(){return OO.ui.isMobile()?new ve.ui.MobileWindowManager(this,{factory:ve.ui.windowFactory,overlay:this.globalOverlay}):new ve.ui.SurfaceWindowManager(this,{factory:ve.ui.windowFactory});};ve.ui.Surface.prototype.createModel=function(doc,attachedRoot){return new ve.dm.Surface(doc,attachedRoot,{sourceMode:this.getMode()==='source'});};ve.ui.Surface.prototype.createView=function(model){return new ve.ce.Surface(model,this);};ve.ui.Surface.prototype.setupDebugBar=function(){this.debugBar=new ve.ui.DebugBar(this);this.$element.append(this.debugBar.$element);};ve.ui.Surface.prototype.getBoundingClientRect=function(){return this.$element[0].
getClientRects()[0]||null;};ve.ui.Surface.prototype.getViewportDimensions=function(){var rect=this.getBoundingClientRect();if(!rect){return null;}var top=Math.max(this.padding.top-rect.top,0);var bottom=$(this.getElementWindow()).height()-rect.top;return{top:top,left:rect.left,bottom:bottom,height:bottom-top};};ve.ui.Surface.prototype.isEnabled=function(){return!this.isDisabled();};ve.ui.Surface.prototype.getModel=function(){return this.model;};ve.ui.Surface.prototype.getView=function(){return this.view;};ve.ui.Surface.prototype.getContext=function(){return this.context;};ve.ui.Surface.prototype.getDialogs=function(){return this.dialogs;};ve.ui.Surface.prototype.getToolbarDialogs=function(){return this.toolbarDialogs;};ve.ui.Surface.prototype.getLocalOverlay=function(){return this.localOverlay;};ve.ui.Surface.prototype.getGlobalOverlay=function(){return this.globalOverlay;};ve.ui.Surface.prototype.setDisabled=function(disabled){if(disabled){OO.ui.warnDeprecation(
'Surfaces can\'t be disabled, only set to readOnly');}};ve.ui.Surface.prototype.setReadOnly=function(readOnly){this.readOnly=!!readOnly;this.model.setReadOnly(readOnly);this.view.setReadOnly(readOnly);this.emit('readOnly',readOnly);};ve.ui.Surface.prototype.isReadOnly=function(){return this.readOnly;};ve.ui.Surface.prototype.focus=function(){this.getView().focus();};ve.ui.Surface.prototype.onDocumentTransact=function(){if(this.placeholder){this.updatePlaceholder();}};ve.ui.Surface.prototype.onModelSelect=function(){if(this.getView().dragging^OO.ui.isMobile()){return;}this.scrollSelectionIntoViewDebounced();};ve.ui.Surface.prototype.scrollSelectionIntoView=function(){var animate=true,view=this.getView(),selection=view.getSelection(),surface=this,isNative=selection.isNativeCursor();var clientRect=selection.getSelectionFocusRect();var surfaceRect=this.getBoundingClientRect();if(!clientRect||!surfaceRect){return;}clientRect=ve.translateRect(clientRect,surfaceRect.left,surfaceRect.top);var
padding=ve.copy(this.padding);if(isNative){animate=false;if(OO.ui.isMobile()&&!this.getModel().getSelection().isCollapsed()){var profile=$.client.profile();if(profile.name==='android'&&profile.versionNumber>=6){padding.top+=60;}if(profile.name==='android'||profile.name==='firefox'){padding.bottom+=30;}}clientRect.top-=5;clientRect.bottom+=5;}else{var viewportDimensions=this.getViewportDimensions();if(clientRect.height>viewportDimensions.height){return;}}ve.scrollIntoView(clientRect,{animate:animate,scrollContainer:this.$scrollContainer[0],padding:padding}).then(function(){if(isNative){surface.emit('scroll');}});};ve.ui.Surface.prototype.scrollCursorIntoView=ve.ui.Surface.prototype.scrollSelectionIntoView;ve.ui.Surface.prototype.setPlaceholder=function(placeholder){this.placeholder=placeholder;if(this.placeholder){this.$placeholder.prependTo(this.$element);this.updatePlaceholder();var documentView=this.getView().getDocument();this.$placeholder.prop({dir:documentView.getDir(),lang:
documentView.getLang()});}else{this.$placeholder.detach();this.placeholderVisible=false;this.getView().$element.css('min-height','');}this.getView().attachedRoot.$element.attr('aria-label',this.placeholder||null);};ve.ui.Surface.prototype.updatePlaceholder=function(){var hasContent=this.getModel().getDocument().data.hasContent();this.$placeholder.toggleClass('oo-ui-element-hidden',hasContent);this.placeholderVisible=!hasContent;if(!hasContent){var firstNode=this.getView().attachedRoot.children[0];var $wrapper;if(firstNode){$wrapper=firstNode.$element.clone();if(ve.debug){$wrapper.removeAttr('style');}}else{$wrapper=$('<p>');}this.$placeholder.empty().append($wrapper.text(this.placeholder));}else{this.getView().$element.css('min-height','');}};ve.ui.Surface.prototype.onViewPosition=function(){if(this.placeholderVisible){this.getView().$element.css('min-height',this.$placeholder.outerHeight());}};ve.ui.Surface.prototype.getCommands=function(){return this.commands;};ve.ui.Surface.
prototype.execute=function(triggerOrAction,method){return this.executeWithSource.apply(this,[triggerOrAction,method,false].concat(Array.prototype.slice.call(arguments,2)));};ve.ui.Surface.prototype.executeWithSource=function(triggerOrAction,method,source){if(triggerOrAction instanceof ve.ui.Trigger){var command=this.triggerListener.getCommandByTrigger(triggerOrAction.toString());if(command){return command.execute(this,false,source);}}else if(typeof triggerOrAction==='string'&&typeof method==='string'){if(ve.ui.actionFactory.doesActionSupportMethod(triggerOrAction,method)){var obj=ve.ui.actionFactory.create(triggerOrAction,this,source);var ret=obj[method].apply(obj,Array.prototype.slice.call(arguments,3));return ret===undefined||!!ret;}}return false;};ve.ui.Surface.prototype.executeCommand=function(commandName){var command=this.commandRegistry.lookup(commandName);if(command){return command.execute(this);}return false;};ve.ui.Surface.prototype.setToolbarHeight=function(toolbarHeight){
this.setPadding({top:toolbarHeight});};ve.ui.Surface.prototype.setPadding=function(padding){ve.extendObject(this.padding,padding);this.toolbarHeight=this.padding.top;};ve.ui.Surface.prototype.onContextResize=function(){this.setPadding({bottom:this.context.$element[0].clientHeight});this.adjustVisiblePadding();this.scrollSelectionIntoView();};ve.ui.Surface.prototype.onModelBlur=function(){this.adjustVisiblePadding();};ve.ui.Surface.prototype.onModelFocus=function(){this.adjustVisiblePadding();};ve.ui.Surface.prototype.onViewActivation=function(){this.adjustVisiblePadding();};ve.ui.Surface.prototype.adjustVisiblePadding=function(){if(OO.ui.isMobile()&&!this.inTargetWidget){var keyboardShown=this.getView().getSelection().isNativeCursor()&&!this.getView().isShownAsDeactivated();var bottom;if(ve.init.platform.constructor.static.isIos()&&keyboardShown){bottom=$(window).height()-this.padding.top;}else{bottom=this.padding.bottom;}this.getView().$attachedRootNode.css('padding-bottom',bottom);
this.scrollSelectionIntoView();}};ve.ui.Surface.prototype.createProgress=function(progressCompletePromise,label,nonCancellable){var progressBarDeferred=ve.createDeferred();this.progresses.push({label:label,cancellable:!nonCancellable,progressCompletePromise:progressCompletePromise,progressBarDeferred:progressBarDeferred});this.showProgressDebounced();return progressBarDeferred.promise();};ve.ui.Surface.prototype.showProgress=function(){var progresses=this.progresses;this.dialogs.openWindow('progress',{progresses:progresses,$returnFocusTo:null});this.progresses=[];};ve.ui.Surface.prototype.getImportRules=function(){return this.importRules;};ve.ui.Surface.prototype.isMultiline=function(){return this.multiline;};ve.ui.Surface.prototype.getDir=function(){return this.$element.css('direction');};ve.ui.Surface.prototype.getInDialog=function(){return this.inDialog;};ve.ui.Context=function VeUiContext(surface,config){ve.ui.Context.super.call(this,config);OO.EventEmitter.call(this);OO.ui.mixin.
GroupElement.call(this,config);this.surface=surface;this.visible=false;this.choosing=false;this.$focusTrapBefore=$('<div>').prop('tabIndex',0);this.$focusTrapAfter=$('<div>').prop('tabIndex',0);this.$focusTrapBefore.add(this.$focusTrapAfter).on('focus',function(){surface.getView().activate();});this.$group.addClass('ve-ui-context-menu');this.$element.addClass('ve-ui-context ve-ui-context-hidden').append(this.$focusTrapBefore,this.$group,this.$focusTrapAfter);};OO.inheritClass(ve.ui.Context,OO.ui.Element);OO.mixinClass(ve.ui.Context,OO.EventEmitter);OO.mixinClass(ve.ui.Context,OO.ui.mixin.GroupElement);ve.ui.Context.static.isMobile=false;ve.ui.Context.prototype.isMobile=function(){return this.constructor.static.isMobile;};ve.ui.Context.prototype.isVisible=function(){return this.visible;};ve.ui.Context.prototype.getRelatedSources=null;ve.ui.Context.prototype.getSurface=function(){return this.surface;};ve.ui.Context.prototype.toggleMenu=function(show){show=show===undefined?!this.choosing:
!!show;if(show!==this.choosing){this.choosing=show;this.$element.toggleClass('ve-ui-context-choosing',show);if(show){this.setupMenuItems();}else{this.teardownMenuItems();}}return this;};ve.ui.Context.prototype.setupMenuItems=function(){var sources=this.getRelatedSources(),items=[];var i,len;for(i=0,len=sources.length;i<len;i++){var source=sources[i];if(source.type==='item'){items.push(ve.ui.contextItemFactory.create(sources[i].name,this,sources[i].model));}else if(source.type==='tool'){items.push(new ve.ui.ToolContextItem(this,sources[i].model,ve.ui.toolFactory.lookup(sources[i].name)));}}items.sort(function(){}