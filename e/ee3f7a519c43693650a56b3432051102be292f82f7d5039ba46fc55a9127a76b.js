(self.webpackChunkpikabu=self.webpackChunkpikabu||[]).push([[143],{9684:(t,e,s)=>{"use strict";function i(t){return'<svg height="100" width="400" viewBox="0 0 400 100">\n    <rect role="presentation" x="0" y="0" width="100%" height="100%" clip-path="url(#nh03ye-diff)"\n          style="fill: url(#animation-comment);"/>\n    <defs role="presentation">\n        <clipPath id="nh03ye-diff">\n            <rect x="0" y="7" rx="3" ry="3" width="25" height="6"/>\n            <circle cx="45" cy="10" r="10"/>\n            <rect x="65" y="7" rx="3" ry="3" width="100" height="6"/>\n            <rect x="0" y="30" rx="3" ry="3" width="400" height="6"/>\n            <rect x="0" y="50" rx="3" ry="3" width="340" height="6"/>\n            <rect x="0" y="70" rx="3" ry="3" width="380" height="6"/>\n            <rect x="0" y="94" rx="3" ry="3" width="50" height="6"/>\n        </clipPath>\n        <linearGradient id="animation-comment">\n            <stop offset="-1.43361" stop-color="#a1a1a1" stop-opacity="1">\n                <animate attributeName="offset" values="-2; -2; 1" keyTimes="0; 0.25; 1" dur="2s"\n                         repeatCount="indefinite"/>\n            </stop>\n            <stop offset="-0.433612" stop-color="#ecebeb" stop-opacity="1">\n                <animate attributeName="offset" values="-1; -1; 2" keyTimes="0; 0.25; 1" dur="2s"\n                         repeatCount="indefinite"/>\n            </stop>\n            <stop offset="0.566388" stop-color="#a1a1a1" stop-opacity="1">\n                <animate attributeName="offset" values="0; 0; 3" keyTimes="0; 0.25; 1" dur="2s"\n                         repeatCount="indefinite"/>\n            </stop>\n        </linearGradient>\n    </defs>\n</svg>','<svg height="100" width="400" viewBox="0 0 400 100">\n    <rect role="presentation" x="0" y="0" width="100%" height="100%" clip-path="url(#nh03ye-diff)"\n          style="fill: url(#animation-comment);"/>\n    <defs role="presentation">\n        <clipPath id="nh03ye-diff">\n            <rect x="0" y="7" rx="3" ry="3" width="25" height="6"/>\n            <circle cx="45" cy="10" r="10"/>\n            <rect x="65" y="7" rx="3" ry="3" width="100" height="6"/>\n            <rect x="0" y="30" rx="3" ry="3" width="400" height="6"/>\n            <rect x="0" y="50" rx="3" ry="3" width="340" height="6"/>\n            <rect x="0" y="70" rx="3" ry="3" width="380" height="6"/>\n            <rect x="0" y="94" rx="3" ry="3" width="50" height="6"/>\n        </clipPath>\n        <linearGradient id="animation-comment">\n            <stop offset="-1.43361" stop-color="#a1a1a1" stop-opacity="1">\n                <animate attributeName="offset" values="-2; -2; 1" keyTimes="0; 0.25; 1" dur="2s"\n                         repeatCount="indefinite"/>\n            </stop>\n            <stop offset="-0.433612" stop-color="#ecebeb" stop-opacity="1">\n                <animate attributeName="offset" values="-1; -1; 2" keyTimes="0; 0.25; 1" dur="2s"\n                         repeatCount="indefinite"/>\n            </stop>\n            <stop offset="0.566388" stop-color="#a1a1a1" stop-opacity="1">\n                <animate attributeName="offset" values="0; 0; 3" keyTimes="0; 0.25; 1" dur="2s"\n                         repeatCount="indefinite"/>\n            </stop>\n        </linearGradient>\n    </defs>\n</svg>'}s.d(e,{Z:()=>i})},5304:(t,e,s)=>{"use strict";s.d(e,{Z:()=>n});var i=s(9050);function n(t){var e="",n=i.escape;Array.prototype.join;const o=s(381);e+='\n<div class="mt__tags-title">История редактирование тегов</div>\n<div class="mt__tags-history">\n\t';for(let s=0;s<t.length;s++){e+='\n\t\t<div class="mt__tags-history-item">\n\t\t\t<a class="user user_inline" href="/@'+n(t[s].moderator_name)+'">\n\t\t\t\t<span class="avatar avatar_small"><img src="'+n(t[s].moderator_avatar)+'"></span><span class="user__nick">'+n(t[s].moderator_name)+'</span>\n\t\t\t</a> <span class="caption">отредактировал</span> <span class="caption hint" aria-label="'+n(o(1e3*t[s].datetime).format("D MMMM YYYY [в] H:mm"))+'">'+n(o(1e3*t[s].datetime).fromNow())+'</span>\n\t\t\t<div class="mt__tags-history-list tags">\n\t\t\t\t';for(let i=0;i<t[s].oldTags.length;i++)e+='\n\t\t\t\t\t<div class="tags__tag">'+n(t[s].oldTags[i])+"</div>\n\t\t\t\t";e+="\n\t\t\t\t";for(let i=0;i<t[s].removedTags.length;i++)e+='\n\t\t\t\t\t<div class="tags__tag tags__tag_removed hint" aria-label="Тег был удалён">'+n(t[s].removedTags[i])+"</div>\n\t\t\t\t";e+="\n\t\t\t\t";for(let i=0;i<t[s].addedTags.length;i++)e+='\n\t\t\t\t\t<div class="tags__tag tags__tag_added hint" aria-label="Тег был добавлен">'+n(t[s].addedTags[i])+"</div>\n\t\t\t\t";e+="\n\n\t\t\t</div>\n\t\t</div>\n\t"}return e+="\n</div>"}},8709:(t,e,s)=>{"use strict";s.d(e,{Z:()=>n});var i=s(9050);function n(t){var e="";return e+='<div class="mt__popup-cnt mt__popup-cnt_center">\n\t'+(0,i.escape)(t)+"\n</div>"}},6542:(t,e,s)=>{"use strict";function i(t){var e,s="";return s+='<div class="auth__tlg-link-b">\n\t<a href="tg://resolve?domain=pikabu_access_code_bot&start='+(null==(e=t)?"":e)+'" target="_blank" class="auth__tlg-link">Получить код в Telegram</a>\n\t<span class="hint auth__tlg-hint" aria-label="Для получения кода, на данном устройстве должно быть установлено приложение &laquo;Телеграм&raquo;"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon--ui__info icon--ui__info_notifications"><use xlink:href="#icon--ui__info"></use></svg></span>\n</div>\n'}s.d(e,{Z:()=>i})},1253:(t,e,s)=>{"use strict";s.d(e,{D:()=>n});s(8674);const i="sendBeacon"in navigator;class n{static sendEvent(t,e){const s=`/ajax/achievements/check?code=${t}`+(e?"&"+n.parseParams(e):"");i?navigator.sendBeacon(s):fetch(s,{method:"POST"})}static parseParams(t){const e=t=>null===t||"object"!=typeof t&&"function"!=typeof t;return t&&"object"==typeof t?Object.keys(t).map((s=>e(t[s])?encodeURIComponent(s)+"="+encodeURIComponent(t[s]):Array.isArray(t[s])?t[s].map((t=>e(t)?encodeURIComponent(s)+"[]="+encodeURIComponent(t):null)).filter((t=>t)).join("&"):void 0)).filter((t=>t)).join("&"):""}}},4122:(t,e,s)=>{"use strict";s.d(e,{Q:()=>_});s(1817),s(6992),s(3948),s(4916),s(5306);var i=s(8211),n=s(4391),o=s(6218),r=s(4616),a=s(2308),l=s(2822),h=s(6572),c=s(5);class d{constructor(t){let e=(window.bidsList||[]).filter((e=>e.containerId===t));this._bids=e.map((t=>{var e;let s=0;return t.cost&&(s=c.v[t.cost.currency]||1),{cpm:t.cost?t.cost.cpm:-(null===(e=t.error)||void 0===e?void 0:e.code)||-t.errorCode,campaignId:t.campaignId,currency:s}}))}getCPM(){return this.bids.map((t=>t.cpm))}getCampaignId(){return this.bids.map((t=>t.campaignId))}getCurrencyList(){const t=this.bids.map((t=>t.currency));return 0===t.filter((t=>0!==t&&2!==t)).length?[]:t}get bids(){return this._bids}}const u="[id^=adfox]",p=Symbol();let m;class _{constructor(t){if(p!==t)throw new Error("Cannot construct singleton");this._adShowObserver=null,this._processedElements=new WeakSet,this._blockWithoutAdSendingAnalytics=new WeakSet,n.v&&(this._adShowObserver=new IntersectionObserver((t=>{t.forEach((t=>{if(t.isIntersecting){var e;const s=t.target;if(s.offsetWidth*s.offsetHeight==0)return;const i=this._getParams(s);null!==(e=window.adInfoStorage)&&void 0!==e&&e.has(i.storageAdId)?(this._adShowObserver.unobserve(s),window.adInfoStorage.delete(i.storageAdId),i.userRate=1,this._blockWithoutAdSendingAnalytics.delete(s),this._sendAnalytics("show_ad",i)):(i.userRate=0,i.createAt=Date.now(),this._blockWithoutAdSendingAnalytics.has(s)||(this._sendAnalytics("show_ad",i),this._blockWithoutAdSendingAnalytics.add(s),this._timeout(i.storageAdId,1e3,(()=>{this._checkAdRendered(i)}))))}}))}),{threshold:.5}))}watch(t,e){o.Z.isHTMLElement(t)?this._attachHandlers(t,e):t.each(((t,s)=>{this._attachHandlers(s,e)}))}_attachHandlers(t,e){this._processedElements.has(t)||(this._adShowObserver&&(t.dataset.adType=(0,r.i)(a.L,e)||a.L.FEED,this._adShowObserver.observe(t)),t.addEventListener("click",(()=>{const e=this._getParams(t);this._sendAnalytics("click_ad",e),this._processedElements.delete(t)}),{capture:!0,once:!0}),this._processedElements.add(t))}_sendAnalytics(t,e){const{adType:s,createAt:i,adId:n,userRate:o,typeI8:r,link:h,postId:c,currenciesList:d,screen:u,screenIndex:p,adBids:m,adCampaignId:_,position:g}=e,v={type:s,"create_at!empty":i,"post_id!empty":c,"screen!empty":u,"list!empty":d,ad_bids:m,ad_campaign_id:_,"screen_index!empty":p,"user_rate!empty":o||"","content_type!empty":n,"type_i8!empty":r,"link!empty":h};s===a.L.UNDER_COMMENTS_TILES&&(v["list!empty"]=g),l.c.getInstance().sendEvent(t,v)}static getScreenIndex(t){if(!t)return 0;const e=document.evaluate("//comment()",document,null,XPathResult.ANY_TYPE,null);let s=e.iterateNext(),i=[];const n=/story_\d+_end/,o=`story_ad_${t}_end`;for(;s;)(n.test(s.data)||s.data.includes(o))&&i.push(s.data),s=e.iterateNext();return i.findIndex((e=>e.includes(t)))}static get instance(){return m||(m=new _(p),m)}_checkAdRendered(t){var e;const{adWrapper:s,adElement:n,createAt:o,adId:r,storageAdId:a}=t;if(Date.now()-o>6e4)return this._cancelTimeout(a),void this._adShowObserver.unobserve(s);if(null!==(e=window.adInfoStorage)&&void 0!==e&&e.has(a)){if(!i.vE.ui.elementInViewport(n))return void this._cancelTimeout(a);this._adShowObserver.unobserve(s),this._blockWithoutAdSendingAnalytics.delete(s),this._cancelTimeout(a),window.adInfoStorage.delete(a),t.userRate=1,this._sendAnalytics("show_ad",t)}else this._timeout(a,1e3,(()=>{this._checkAdRendered(t)}))}_timeout(t,e,s,i=!0){return i&&this._cancelTimeout(t),this._timeoutList||(this._timeoutList=new Map),this._timeoutList.set(t,setTimeout(s.bind(this),e)),this}_cancelTimeout(...t){return this._timeoutList&&this._timeoutList.size?(t.length?t.forEach((t=>{this._timeoutList.has(t)&&(clearTimeout(this._timeoutList.get(t)),this._timeoutList.delete(t))})):(this._timeoutList.values().forEach((t=>clearTimeout(t))),this._timeoutList.clear()),this):this}_getParams(t){var e;const s=t.querySelector(u)||t;let n=s.id||(null===(e=s.querySelector(u))||void 0===e?void 0:e.id);const o=s.querySelector('div[id^="abp"]');let r=n;!n&&o&&(n="abp",r=o.id.replace(/^abp_/,""));const l=t.dataset.adType,c=t.dataset.storyId;let p="",m="";if(Boolean(t.querySelector('a[href^="https://ads.adfox.ru/260477/"]'))){var g;if(m=null===(g=s.querySelector("img"))||void 0===g?void 0:g.src,!m){var v;const t=s.querySelector("a");m=null==t||null===(v=t.style.backgroundImage)||void 0===v?void 0:v.split(/"/)[1]}p=1}const f=h.cQ.getStoryIdFromUrl(),y=i.vE.ui.screen,b=new d(n),w=JSON.stringify(b.getCPM()),E=JSON.stringify(b.getCampaignId());let S,C,T;return l===a.L.UNDER_COMMENTS_TILES?T=t.dataset.position:(C=_.getScreenIndex(c),C=C>0?C:"",S=b.getCurrencyList(),S=S.length>0?JSON.stringify(S):""),{adWrapper:t,adElement:s,adId:n,adType:l,articleId:c,typeI8:p,link:m,postId:f,screen:y,bids:b,currenciesList:S,screenIndex:C,adBids:w,adCampaignId:E,storageAdId:r,position:T}}}},5:(t,e,s)=>{"use strict";s.d(e,{P:()=>i,v:()=>n});const i="pkb_vk",n={RUB:2,RUR:2,USD:3,EUR:4}},2308:(t,e,s)=>{"use strict";let i;s.d(e,{L:()=>i}),function(t){t.BANNER="banner",t.FEED="feed",t.RIGHT="right",t.RIGHT_LAST="right_last",t.COMMENTS="comments",t.UNDER_COMMENTS="under_comments",t.UNDER_POST="under_post",t.VIDEO_END="video_end",t.RECOM_FEED="feed_post_add",t.UNDER_COMMENTS_TILES="under_comments_tiles"}(i||(i={}))},3680:(t,e,s)=>{"use strict";s.d(e,{o:()=>m});s(6992),s(3948),s(8674);var i=s(8211),n=s(6572),o=s(2134),r=s(5),a=s(7591),l=s(2822),h=s(8487);const c=new Set,d=new Set;function u(t){let e=n.xg.get(r.P);return e=Array.isArray(e)?e:[],!e.includes(t)&&(e.push(t),n.xg.set(r.P,e),!0)}function p(t){const e=n.xg.get(r.P);return(Array.isArray(e)?e:[]).includes(t)}class m{constructor(){throw new Error("Cannot construct singleton")}static isPlayVideo(t){return d.has(t)}static async setPlayVideo(t,e,s){if(m.isPlayVideo(e))return!0;d.add(e);const{response:i}=await o.cf.post("/ajax/save_click.php",{aid:e,sid:t,rsid:s});return i.result}static isClickReadMore(t){return c.has(t)}static async setClickReadMore(t,e,s){if(m.isClickReadMore(t))return!0;c.add(t);const{response:i}=await o.cf.post("/ajax/save_click.php",{aid:e,sid:t,t:"more",rsid:s});return i.result}static isViewed(t,e){return p(`V${t}${e}`)}static async setViewed(t,e,s){if(l.c.getInstance().yandex.goal(i.vE.applicationType===a.Zq.MOBILE?"cpm_show_mob":"cpm_show_pс"),!u(`V${t}${e}`))return!0;let n=!1;s&&(n=await i.vE.adblock.ready,void 0===window.isABPEnabled&&(window.isABPEnabled=await Boolean((0,h.pJ)())));const{response:r}=await o.cf.post("/ajax/save_view.php",{k:t,mv:i.vE.applicationType===a.Zq.MOBILE?1:void 0,rsid:e,is_abp:n&&window.isABPEnabled?1:void 0});return r.result}static isShortRead(t,e){return p(`R${t}${e}`)}static async setShortRead({adViewKey:t,referrerStoryId:e,isStoryPage:s}){if(!u(`R${t}${e}`))return!0;const n={k:t,mv:i.vE.applicationType===a.Zq.MOBILE?1:void 0,rsid:e};s&&(n.is_story_page=1);const{response:r}=await o.cf.post("/ajax/save_short_read.php",n);return r.result}}},3414:(t,e,s)=>{"use strict";s.d(e,{F:()=>r});s(6992),s(3948);var i=s(7892),n=s(6777);const o=s(6419);class r extends n.vp{constructor(){super(),this._mask=0}static getBitFromEnumProperty(t){return t instanceof i.Tf?o.isNumber(t.index)?1<<t.index:0:t}set(t){return 0===(t=r.getBitFromEnumProperty(t))?this._mask:(this._mask|=t,this.emit("update",this),this)}has(t){return 0!==(t=r.getBitFromEnumProperty(t))&&(this._mask&t)===t}hasSome(...t){return o.some(t,(t=>this.has(t)))}remove(t){return t=r.getBitFromEnumProperty(t),this._mask=this._mask&~t,this.emit("update",this),this}toggle(t,e){let s=this.has(t);return!(e=o.isBoolean(e)?e:!s)&&s?this.remove(t):e&&!s?this.set(t):this}toEnums(t){let e=[];if(!(t instanceof i.xs))return e;for(let s of t.entries())this.has(s)&&e.push(s);return e}toString(){return String(this._mask)}valueOf(){return this._mask}static create(){return new r}}},2427:(t,e,s)=>{"use strict";s.d(e,{l:()=>l});s(6992),s(3948);var i=s(6349),n=s(8924);function o(t,e){var s=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),s.push.apply(s,i)}return s}function r(t){for(var e=1;e<arguments.length;e++){var s=null!=arguments[e]?arguments[e]:{};e%2?o(Object(s),!0).forEach((function(e){a(t,e,s[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(s)):o(Object(s)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(s,e))}))}return t}function a(t,e,s){return e in t?Object.defineProperty(t,e,{value:s,enumerable:!0,configurable:!0,writable:!0}):t[e]=s,t}class l{static getInstance(){return l.instance||(l.instance=new l)}sendTagAnalytics({event:t,tag:e,proposal:s,createAt:n,story:o,extraParams:a={}}){i.cp.getInstance().sendEvent(t,r(r({tag:e,proposal:s,"create_at!empty":n},o.analyticsData),a),[i.b0.CLICKHOUSE])}sendAddedOrRemovedTagsAnalytics(t,e,s){const i=new Set(e);t.forEach(((t,e)=>{i.has(t)?i.delete(t):this.sendTagAnalytics(r(r({},s),{},{tag:t,proposal:n.a8.DELETE.value,createAt:Date.now()+50*e}))})),i.size>0&&[...i].forEach(((t,e)=>{this.sendTagAnalytics(r(r({},s),{},{tag:t,proposal:n.a8.ADD.value,createAt:Date.now()+100*e}))}))}}},9289:(t,e,s)=>{"use strict";s.d(e,{s:()=>h});var i=s(8211),n=s(8334),o=s(7591),r=s(4126),a=s(7041),l=s(4616);function h(t,e=!0){return!!i.vE.checkAccessUserActions(e)&&(i.vE.userRating<n.r7?(e&&i.vE.ui.toasts.showWarningMessage(o.ZF.NEED_MORE_RATING,n.r7),!1):t.depth>=n.BE?(e&&i.vE.ui.toasts.add("max-depth",{theme:r.K.DANGER,content:"comments.errors.max-depth"}),!1):t.ignoreType!==a.IV.COMMUNITY_IGNORES_YOU&&t.comments.commentsMeta.ignoreType!==a.IV.COMMUNITY_IGNORES_YOU||(e&&i.vE.ui.toasts.add("ignore",{theme:r.K.WARNING,content:i.vE.i18n("comments.ignore."+(0,l.S)(a.IV,t.ignoreType),t.ignoreCommunityName)}),!1))}},6917:(t,e,s)=>{"use strict";s.d(e,{B:()=>u});s(6992),s(3948),s(5827);var i=s(8211),n=s(1014),o=s(4612),r=s(3399),a=s(8334),l=s(747),h=s(4113),c=s(2822),d=s(6349);class u extends n.v{constructor(t){var e,s,i;super(),i=[],(s="items")in(e=this)?Object.defineProperty(e,s,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[s]=i,this.child=t}setInitData({isChildrenShown:t,$childrenContainer:e}){"boolean"==typeof t&&(this._isChildrenShown=t),e&&(this._$childrenContainer=e)}appendChild(t){this.items.push(t)}prependChild(t){this.items.unshift(t)}getChildHiddenGroupById(t){for(const e of this.items)if(e instanceof o.H&&e.id===t)return e}getChildCommentById(t){for(const e of this.items){if(e instanceof r.U&&e.id===t)return e;if(e instanceof o.H){const s=e.children.getChildCommentById(t);if(s)return s}}}getUnloadChildComments(t,e,s=!1){if(this.child.depth>=t)return[];const i=[];for(const n of this.items){if(n.isRendered&&s)break;if(this.isOnlyHiddenGroupChildren||n.isRendered&&n.isMounted||i.push(n),i.length>=e)break;if((!(n instanceof o.H)||n.children.isChildrenShown)&&(!(n instanceof r.U&&(n.children.isOnlyHiddenGroupChildren||n.isRendered&&!n.children.isChildrenShown))&&(i.push(...n.children.getUnloadChildComments(t,e-i.length,!1)),i.length>=e)))break}return i}mountChild(t){const e=this.items.length;let s=this.items.indexOf(t);if(-1===s||!t.el)return;if(s>0&&s!==e-1)for(;--s>=0;){const e=this.items[s];var i;if(null!=e&&e.isRendered)return void(null===(i=e.el)||void 0===i||i.insertAdjacentElement("afterend",t.el))}if(0===s)return void this.$childrenContainer.insertAdjacentElement("afterbegin",t.el);const n=this.$childrenContainer.querySelector(":scope > .comment__collapsing-area");n?n.insertAdjacentElement("beforebegin",t.el):this.$childrenContainer.insertAdjacentElement("beforeend",t.el)}updateChildrenCount(){const t=this.$toggleChildren.classList.contains("comment-toggle-children_loading"),e=this.$toggleChildren.querySelector(".comment-toggle-children__label");!t&&e&&(e.innerHTML=this.toggleChildrenLabelText),this.$toggleChildren.classList.toggle("comment-toggle-children_highlight_yellow",this.childNewCount>0),this.$toggleChildren.hidden=0===this.childTotalCount&&!t}updateChildrenShown(t){if(this.child instanceof r.U&&this.child.isRoot||!this.$childrenContainer)return;!this.$childrenContainer.isConnected&&this.child.el&&(this.child.el.append(this.$toggleChildren),this.child.el.append(this.$childrenContainer)),this.$childrenContainer.hidden=!t,this.$toggleChildren.classList.toggle("comment-toggle-children_collapse",!t);const e=this.isOnlyHiddenGroupChildren&&Boolean(this.items[0]);if(this.$toggleChildren.classList.toggle("comment-toggle-children_only-hidden",e),t&&e&&(this.items[0].render(),this.items[0].children.isChildrenShown=!0),t||this.updateChildrenCount(),this.child instanceof r.U){const[e,s]=this.child.voter.amountVotes||[];c.c.getInstance().sendEvent(t?"comment_branch_show":"comment_branch_collapse",{"comment_id!empty":this.child.id,"post_id!empty":this.child.comments.commentsMeta.storyId,"comment_author_id!empty":this.child.comments.commentsMeta.storyAuthorId,"pluses!undefined":e,"minuses!undefined":s,"rating!undefiend":this.child.voter.rating,"level!undefined":this.child.depth},[d.b0.CLICKHOUSE])}}get isOnlyHiddenGroupChildren(){return 1===this.items.length&&this.items[0]instanceof o.H}get childTotalCount(){return this.items.reduce(((t,e)=>t+e.children.childTotalCount+(e instanceof r.U?1:0)),0)}get childNewCount(){return this.items.reduce(((t,e)=>t+e.children.childNewCount+(e instanceof r.U&&e.isNewest?1:0)),0)}get toggleChildrenLabelText(){const t=this.childTotalCount,e=this.childNewCount;if(this.isOnlyHiddenGroupChildren)return i.vE.i18n("comments-next.button.toggle-hidden-children",t);const s=t&&t===e?`+ ${e}`:t-e+(e?` + ${e}`:"");return i.vE.i18n("comments-next.button.toggle-children",s)}get $childrenContainer(){var t;if(this._$childrenContainer)return this._$childrenContainer;if(this.child instanceof o.H){var e;const t=null===(e=this.child.el)||void 0===e?void 0:e.firstElementChild;return t instanceof HTMLElement&&t.classList.contains("comment-hidden-group__children")?t:this._$childrenContainer=(0,l.m)('<div class="comment-hidden-group__children"/>')}const s=null===(t=this.child.el)||void 0===t?void 0:t.lastElementChild;if(s instanceof HTMLElement&&s.classList.contains("comment__children"))return s;const i=this.child.indent===a.Iz?"comment__children_next-floor":"",n=(0,l.m)(`\n\t\t\t<div class="comment__children ${i}">\n\t\t\t\t<div class="comment__collapsing-area"></div>\n\t\t\t</div>\n\t\t`);return this.child.indent===a.Iz&&n.append((0,l.m)(`<div class="comment__close-branch">${(0,h.t)("ui__close","close-branch")}</div>`)),this._$childrenContainer=n}get $toggleChildren(){var t;if(this._$toggleChildren)return this._$toggleChildren;if(this.child instanceof o.H){var e;const t=null===(e=this.child.el)||void 0===e?void 0:e.querySelector(":scope > .comment-hidden-group__toggle");if(t instanceof HTMLElement)return t;const s=i.vE.i18n("comments-next.button.toggle-hidden-group-children",this.items.length);return this._$toggleChildren=(0,l.m)(`<div class="comment-hidden-group__toggle">${s}</div>`)}const s=null===(t=this.child.el)||void 0===t?void 0:t.querySelector(":scope > .comment-toggle-children");if(s instanceof HTMLElement)return s;const n=[this.child.indent===a.Iz?"comment-toggle-children_next-floor":"",this.childNewCount>0?"comment-toggle-children_highlight_yellow":"",this.isChildrenShown?"":"comment-toggle-children_collapse",this.isOnlyHiddenGroupChildren?" comment-toggle-children_only-hidden":""].filter(Boolean).join(" ");return this._$toggleChildren=(0,l.m)(`\n\t\t\t\t<div class="comment-toggle-children ${n}">\n\t\t\t\t\t<div class="comment-toggle-children__icon">${(0,h.t)("comments__toggle")}</div>\n\t\t\t\t\t<div class="comment-toggle-children__label">${this.toggleChildrenLabelText}</div>\n\t\t\t\t</div>\n\t\t`)}get isChildrenShown(){return this._isChildrenShown||!1}set isChildrenShown(t){if(this._isChildrenShown!==t){if(this._isChildrenShown=t,this.child instanceof o.H)return this.$childrenContainer&&(this.$childrenContainer.hidden=!t),void(this.$toggleChildren&&(this.$toggleChildren.hidden=t));t||c.c.getInstance().yandex.goal("collapse-comments-branch"),this.updateChildrenShown(t)}}}},3399:(t,e,s)=>{"use strict";s.d(e,{U:()=>ct});s(5827),s(8674),s(6992),s(3948),s(4916);var i,n,o=s(8211),r=s(2134),a=s(1014),l=s(7041),h=s(4616),c=s(8334),d=s(9755),u=s.n(d),p=s(2822),m=s(5636),_=s(1490),g=s(8245),v=s(1471),f=s(9128),y=s(6668);function b(t,e,s){return e in t?Object.defineProperty(t,e,{value:s,enumerable:!0,configurable:!0,writable:!0}):t[e]=s,t}let w=(I=1e3,i=function(t,e,s){const i=s.value;if(t instanceof y.T){var n;const e=(0,f.O)(t);e.cancelable=null!==(n=e.cancelable)&&void 0!==n?n:new Set;const o=(0,v.P)((function(...t){this.isDestroyed||i.apply(this,t)}),I,$);return s.value=function(...t){this.isDestroyed||o.apply(this,t)},e.cancelable.add(o),s}return s.value=(0,v.P)(i,I,$),s},n=class t extends a.v{constructor(){super(),b(this,"mapStory",new WeakMap),b(this,"setNotVisitedStories",new Set);const t=o.vE.isMobileApp?"-46px":"0px";this.intersectionObserver=new IntersectionObserver(this.onIntersectionObserver.bind(this),{rootMargin:t,threshold:.5})}static getInstance(){return t.instance?t.instance:t.instance=new t}checkVisited(){if(this.setNotVisitedStories.size){for(const t of this.setNotVisitedStories){let e=t.isVisited,s=t.isViewed,i=!0;!e&&t.checkVisited()&&(t.isVisited=e=!0,m.C.setVisited(t.id),i=!1),!s&&t.checkViewed()&&(t.isViewed=s=!0,_.N.setViewed(t.id,i)),e&&s&&(this.intersectionObserver.unobserve(t.el),this.setNotVisitedStories.delete(t))}this.checkVisited()}}onIntersectionObserver(t){t.forEach((t=>{const e=t.target,s=this.mapStory.get(e);s&&(s.inViewport=t.isIntersecting,s.isVisited&&s.isViewed||this.setNotVisitedStories.add(s))})),this.checkVisited()}addComstory(t){var e;const s=null===(e=t.el)||void 0===e?void 0:e.querySelector(".story");if(!s||this.mapStory.has(s))return;const i=s.getAttribute("data-story-id"),n=g.S.getInstance().get("Story");if(!n||"function"!=typeof n)throw new Error("not found Story in UIComponentsRegistry");const r=new n(i,s);this.mapStory.set(s,r);const a=u()(r.$readMore);a.on("click",(e=>{if(void 0===e.originalEvent)return;const s=r.isCollapsedLongStory;if(!s){var i,n;const e=null===(i=t.$el)||void 0===i||null===(n=i.offset())||void 0===n?void 0:n.top;e&&o.vE.ui.scrollTo(e,!0)}a.find("span:first-child").text(o.vE.i18n("comments-next.comstory."+(s?"collapse":"expand"))),r.isCollapsedLongStory=!s,a.css("display","inline-flex")})),r.isVisited&&r.isViewed||this.intersectionObserver.observe(s),this.listenTo(t,"_destroy",(()=>{this.intersectionObserver.unobserve(s),r.destroy()}))}},E=n.prototype,S="checkVisited",C=[i],T=Object.getOwnPropertyDescriptor(n.prototype,"checkVisited"),O=n.prototype,k={},Object.keys(T).forEach((function(t){k[t]=T[t]})),k.enumerable=!!k.enumerable,k.configurable=!!k.configurable,("value"in k||k.initializer)&&(k.writable=!0),k=C.slice().reverse().reduce((function(t,e){return e(E,S,t)||t}),k),O&&void 0!==k.initializer&&(k.value=k.initializer?k.initializer.call(O):void 0,k.initializer=void 0),void 0===k.initializer&&(Object.defineProperty(E,S,k),k=null),n);var E,S,C,T,O,k,I,$,A=s(381),x=s.n(A);const D=new WeakMap;function P(){return function(t,e,s){const i=s.value;return s.value=function(...t){const e=D.get(s);if(e)return e;const n=i.apply(this,t);return n instanceof Promise&&(D.set(s,n),n.then((()=>D.delete(s))).catch((()=>D.delete(s)))),n},s}}var R,M,N=s(5924),B=s(747),L=s(7591),F=s(8058),U=s(8854);function j(t,e,s){return e in t?Object.defineProperty(t,e,{value:s,enumerable:!0,configurable:!0,writable:!0}):t[e]=s,t}let V=(R=(0,F.E)(700),function(t,e,s,i,n){var o={};Object.keys(i).forEach((function(t){o[t]=i[t]})),o.enumerable=!!o.enumerable,o.configurable=!!o.configurable,("value"in o||o.initializer)&&(o.writable=!0),o=s.slice().reverse().reduce((function(s,i){return i(t,e,s)||s}),o),n&&void 0!==o.initializer&&(o.value=o.initializer?o.initializer.call(n):void 0,o.initializer=void 0),void 0===o.initializer&&(Object.defineProperty(t,e,o),o=null)}((M=class extends a.v{constructor(t){super(),j(this,"voteSync",l.OC.NONE),j(this,"_$ratingUp",null),j(this,"_$ratingDown",null),j(this,"_$ratingCount",null),j(this,"_vote",l.OC.NONE),this.comment=t}async syncVote(){if(await(0,U.g)(100),this.vote===this.voteSync)return;const{response:t}=await r.cf.post("/ajax/vote_comment.php",{comment_id:this.comment.id,vote:this.vote.valueOf()});t.result?this.voteSync=this.vote:(this.vote=this.voteSync||l.OC.NONE,o.vE.logger.error("comments","bad sync vote",this.vote,"by comment",this.comment.id))}setVoteDirection(t){p.c.getInstance().yandex.goal("vote-for-comment"),p.c.getInstance().yandex.goal(t>0?"tap-comment-plus":"tap-comment-minus"),p.c.getInstance().google.event("evaluation","comment"),(t=this.vote+t)>l.OC.UP||t<l.OC.DOWN?this.vote=l.OC.NONE:(this.vote=t,this.comment.comments.sendVoteAnalytics(t,this.comment))}setInitData({vote:t,inputAmountVotes:e,inputRating:s,amountVotesHidden:i}){this._vote=this.voteSync=t;let n=!1;if(e){const s=t===l.OC.UP,i=t===l.OC.DOWN,[o,r]=e.split(",").map(Number);n=s&&0===o||i&&0===r,this.amountVotes=n?[o,r]:[o-(s?1:0),r-(i?1:0)]}const o=Number(s);Number.isFinite(o)&&(this.rating=o-(n?0:this.vote)),this.amountVotesHidden=i}updateRating(){if(!this.$ratingUp||!this.$ratingDown||!this.$ratingCount)return;const t=this.rating,e=this.vote,s=e===l.OC.UP,i=e===l.OC.DOWN;if(this.$ratingUp.classList.toggle("comment__rating-up_active",s),this.$ratingDown.classList.toggle("comment__rating-down_active",i),void 0===t||void 0===e)return;const n=t+e;if(this.$ratingCount.textContent=(n>0?"+":"")+n,o.vE.applicationType===L.Zq.DESKTOP&&this.amountVotes){const[t,e]=this.amountVotes,n=t+(s?1:0),a=e+(i?1:0);this.$ratingCount.setAttribute("aria-label",o.vE.i18n("comments.rating-hint",n,a));try{u()(this.$ratingCount).data("hint").destroy()}catch(r){}}}get vote(){return this._vote}set vote(t){const e=this._vote;t===e||this.comment.isAuthorCurrentUser||(this._vote=t,void 0!==e?(t!==this.voteSync&&this.syncVote(),this.updateRating()):this.voteSync=t)}get $ratingUp(){return this._$ratingUp||!this.comment.$body?this._$ratingUp||null:this._$ratingUp=this.comment.$body.querySelector(".comment__rating-up")}get $ratingDown(){return this._$ratingDown||!this.comment.$body?this._$ratingDown||null:this._$ratingDown=this.comment.$body.querySelector(".comment__rating-down")}get $ratingCount(){return this._$ratingCount||!this.comment.$body?this._$ratingCount:this._$ratingCount=this.comment.$body.querySelector(".comment__rating-count")}}).prototype,"syncVote",[R],Object.getOwnPropertyDescriptor(M.prototype,"syncVote"),M.prototype),M);function H(t,e,s){return e in t?Object.defineProperty(t,e,{value:s,enumerable:!0,configurable:!0,writable:!0}):t[e]=s,t}class q extends a.v{constructor(t){super(),H(this,"_$replyWrapper",null),H(this,"_currentReplyMode",l.tT.NONE),this.comment=t,this._isReplyShown=Boolean(t.isRoot)}updateReplyPosition(){this.comment.isRoot||(this.comment.isEditable&&this.currentReplyMode===l.tT.EDIT?this.comment.controls.$controls.insertAdjacentElement("beforebegin",this.$replyWrapper):this.comment.controls.$controls.insertAdjacentElement("afterend",this.$replyWrapper))}get reply(){if(this._reply)return this._reply;const t=g.S.getInstance().get("UICommentReply");if(!t||"function"!=typeof t)throw new Error("not found UICommentReply in UIComponentsRegistry");const e=new t(this.comment);return(this._reply=e).$parent=u()(this.$replyWrapper),this._reply}set reply(t){this._reply=t}get currentReplyMode(){return this._currentReplyMode}set currentReplyMode(t){this._currentReplyMode!==t&&(this._currentReplyMode=t,this._reply&&(this._reply.destroy(),this._reply=void 0))}get isReplyShown(){return this._isReplyShown}set isReplyShown(t){if(this._isReplyShown!==t){if(this._isReplyShown=t,t?(this.updateReplyPosition(),this.reply.show()):this._reply&&this.reply.hide(),this.$replyWrapper.hidden=!t,o.vE.applicationType===L.Zq.MOBILE){var e,s,i;this.comment.highlight("current",!1,t),this.comment.$body.classList.toggle("comment__body_shifted",t);const n=(null===(e=this.comment.el)||void 0===e?void 0:e.closest(".comments-part"))||(null===(s=this.comment.el)||void 0===s?void 0:s.closest(".comments")),o=Math.abs(((null==n?void 0:n.getBoundingClientRect().left)||0)-((null===(i=this.comment.el)||void 0===i?void 0:i.getBoundingClientRect().left)||0));this.comment.$body.style.marginLeft=t?`-${o}px`:"",this.comment.controls.$controls.hidden=t}this.comment.controls.updateControls(),this.comment.$content.hidden=t&&this.comment.isEditable&&this.currentReplyMode===l.tT.EDIT}}get $replyWrapper(){if(this._$replyWrapper)return this._$replyWrapper;const t=this._$replyWrapper=document.createElement("div");return t.classList.add("comment__reply-wrapper"),t}}function W(t,e,s){return e in t?Object.defineProperty(t,e,{value:s,enumerable:!0,configurable:!0,writable:!0}):t[e]=s,t}class G extends a.v{constructor(t){super(),W(this,"_$toolBranch",null),W(this,"_$toolFromParent",null),W(this,"_$toolToggleBranch",null),this.comment=t}async toggleToolParent(t,e=!0){const s=this.comment.parentComment;if(s&&s.branchTools.$toolFromParent&&(s.branchTools.$toolFromParent.hidden=!t),!t&&e)return await this.comment.scrollTo(!0),void this.comment.highlight("green",!0,!0);t&&s&&(await s.scrollTo(!0),s.highlight("green",!0,t))}get branchIds(){const t=[];let e=this.comment;if(this.comment.children.items.length){this.comment.children.$childrenContainer.querySelectorAll(".comment").forEach((e=>t.push(e.getAttribute("data-id"))))}let s=100;for(;e&&!e.isRoot&&e.parentComment&&s--;)t.push(e.id),e=e.parentComment;return t}get $toolBranch(){return this._$toolBranch?this._$toolBranch:this._$toolBranch=this.comment.$body.querySelector('.comment__tool[data-role="branch"]')}get $toolFromParent(){return this._$toolFromParent?this._$toolFromParent:this._$toolFromParent=this.comment.$body.querySelector('.comment__tool[data-role="from-parent"]')}get $toolToggleBranch(){return this._$toolToggleBranch?this._$toolToggleBranch:this._$toolToggleBranch=this.comment.$body.querySelector('.comment__tool[data-role="branch-toggle"]')}}function Y(t,e,s){return e in t?Object.defineProperty(t,e,{value:s,enumerable:!0,configurable:!0,writable:!0}):t[e]=s,t}class z extends a.v{constructor(t){super(),Y(this,"_isSaved",!1),Y(this,"_$toolSave",null),this.comment=t}setInitData({isSaved:t}){this._isSaved=t}async syncSaved(){const{response:t}=await r.cf.post(c.WB,{action:this.isSaved?"save_comment+":"save_comment-",comment_id:this.comment.id});t.result||o.vE.logger.error("comments","bad sync saed",this.isSaved,"by comment",this.comment.id)}get isSaved(){return this._isSaved}set isSaved(t){this._isSaved!==t&&(this._isSaved=t,this.syncSaved())}get $toolSave(){return this._$toolSave?this._$toolSave:this._$toolSave=this.comment.$body.querySelector('.comment__tool[data-role="save"]')}}var Z=s(9289);const K=t=>`<button class="button_link comment__control" data-type="${t}"></button>`;class X extends a.v{constructor(t){super(),this.comment=t}updateControls(){const t=this.comment.replyEditor.isReplyShown;this.$controlCreate.hidden=t,this.$controlCreate.classList.toggle("button_disabled",!(0,Z.s)(this.comment,!1));const e=this.comment.isEditable&&!t;this.$controlEdit.hidden=!e,this.$controlCancel.hidden=!t;const s=this.comment.isEditable;this.$controlRemove.hidden=!s;const i=this.comment.isOfficial&&this.comment.canUnpin;this.$controlUnpin.hidden=!i}get $controls(){if(this._$controls)return this._$controls;const t=this.comment.$body.querySelector(":scope > .comment__controls");return t instanceof HTMLElement?this._$controls=t:this._$controls=u()('<div class="comment__controls"></div>')[0]}get $controlInner(){if(this._$controlInner)return this._$controlInner;const t=this.$controls.querySelector(":scope > .comment__controls-inner");return t instanceof HTMLElement?this._$controlInner=t:this._$controlInner=u()('<div class="comment__controls-inner"></div>').appendTo(this.$controls)[0]}get $controlCreate(){if(this._$controlCreate)return this._$controlCreate;const t=this.$controls.querySelector('.comment__control[data-type="create"]');return t instanceof HTMLElement?this._$controlCreate=t:this._$controlCreate=u()(K("create")).appendTo(this.$controlInner).get(0)}get $controlEdit(){if(this._$controlEdit)return this._$controlEdit;const t=this.$controls.querySelector('.comment__control[data-type="edit"]');return t instanceof HTMLElement?this._$controlEdit=t:this._$controlEdit=u()(K("edit")).appendTo(this.$controlInner).get(0)}get $controlCancel(){if(this._$controlCancel)return this._$controlCancel;const t=this.$controls.querySelector('.comment__control[data-type="cancel"]');return t instanceof HTMLElement?this._$controlCancel=t:this._$controlCancel=u()(K("cancel")).appendTo(this.$controlInner).get(0)}get $controlRemove(){if(this._$controlRemove)return this._$controlRemove;const t=this.$controls.querySelector('.comment__control[data-type="remove"]');return t instanceof HTMLElement?this._$controlRemove=t:this._$controlRemove=u()(K("remove")).appendTo(this.$controlInner).get(0)}get $controlUnpin(){if(this._$controlUnpin)return this._$controlUnpin;const t=this.$controls.querySelector('.comment__control[data-type="unpin"]');return t instanceof HTMLElement?this._$controlUnpin=t:this._$controlUnpin=u()(K("unpin")).appendTo(this.$controlInner).get(0)}}var Q,J,tt,et=s(6917),st=s(9684),it=s(9415),nt=s(6553),ot=s(7111);function rt(t,e){var s=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),s.push.apply(s,i)}return s}function at(t){for(var e=1;e<arguments.length;e++){var s=null!=arguments[e]?arguments[e]:{};e%2?rt(Object(s),!0).forEach((function(e){lt(t,e,s[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(s)):rt(Object(s)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(s,e))}))}return t}function lt(t,e,s){return e in t?Object.defineProperty(t,e,{value:s,enumerable:!0,configurable:!0,writable:!0}):t[e]=s,t}function ht(t,e,s,i,n){var o={};return Object.keys(i).forEach((function(t){o[t]=i[t]})),o.enumerable=!!o.enumerable,o.configurable=!!o.configurable,("value"in o||o.initializer)&&(o.writable=!0),o=s.slice().reverse().reduce((function(s,i){return i(t,e,s)||s}),o),n&&void 0!==o.initializer&&(o.value=o.initializer?o.initializer.call(n):void 0,o.initializer=void 0),void 0===o.initializer&&(Object.defineProperty(t,e,o),o=null),o}let ct=(Q=P(),J=P(),tt=class t extends a.v{get hasChildren(){var t;return Boolean((null===(t=this.children.items)||void 0===t?void 0:t.length)>0||this.hasChildrenMetaFlag||this.isFake)}constructor(t,e){super(e),lt(this,"isStoryComment",!1),this.id=t;(this.isRoot=t===c.iM)&&(this._options.depth=-1,this._isRendered=!0,this._isMounted=!0,this.children.setInitData({isChildrenShown:!0}),this.replyEditor.currentReplyMode=l.tT.CREATE),null!=e&&e.el&&(this._options.$el=u()(e.el),this._isRendered=!0,this._isMounted=!0,this.getInformationFromData()),this.sendCommentFromLocalStorage()}async sendCommentFromLocalStorage(){if(!o.vE.initParams.isConfirmed)return;const t=ot.m.get("pkb_cfc");t&&this.id===t.parent_id&&(this.replyEditor.isReplyShown=!0,await this.replyEditor.reply.loadDraft(),await this.replyEditor.reply.onSubmit())}async removeByCurrentUser(){if(!this.isEditable)return!1;const{response:t}=await r.cf.post("/ajax/comments_actions.php",{action:"delete",id:this.id});return t.result?(o.vE.initParams.isSlowModeEnabled&&o.vE.initParams.availableNumberOfCommentsForToday++,this.$el&&this.$el.addClass("comment_deleted"),this.isRemoved=!0,!0):(o.vE.ui.toasts.showError(t.message||"comments.error.400"),!1)}async restoreByCurrentUser(){if(!this.isRemoved)return!1;const{response:t}=await r.cf.post("/ajax/comments_actions.php",{action:"restore",id:this.id});return t.result?(o.vE.initParams.isSlowModeEnabled&&o.vE.initParams.availableNumberOfCommentsForToday--,this.$el&&this.$el.removeClass("comment_deleted"),this.isRemoved=!1,!0):(o.vE.ui.toasts.showError(t.message||"comments.error.400"),!1)}destroy(t=!1){var e;this.isRendered&&(null===(e=this.el)||void 0===e||e.remove());this._isRendered=!1,this._isMounted=!1,super.destroy(t)}render(){if(this.isRendered)return;if(this.el)return void(this._isRendered=!0);const t=this._options.el=(0,B.m)(`\n\t\t\t<div class="comment ${this.isLoading?" comment_placeholder":""}"\n\t\t\t\tid="comment_${this.id}"\n\t\t\t\tdata-id="${this.id}"\n\t\t\t\tdata-indent="${this.indent}"\n\t\t\t\t${this.isNewest?' data-newest="true"':""}>\n\t\t\t\t<div class="comment__body"></div>\n\t\t\t</div>\n\t\t`);this._options.$el=u()(t),this.isLoading&&t.insertAdjacentElement("afterbegin",this.$placeholder),this.isNewest&&this.highlight("yellow",!1,!0),this.children.items.length&&(t.append(this.children.$toggleChildren),t.append(this.children.$childrenContainer),this.children.updateChildrenShown(this.children.isChildrenShown)),this._isRendered=!0}renderByHtml(t){if(this.isRendered)return;if(this.el)return void(this._isRendered=!0);const e=u()(t),s=e[0];s instanceof HTMLElement&&(this._options.el=s,this._options.$el=e,s.dataset.indent=String(this.indent),this._isRendered=!0)}mount(){this.isMounted||(!this.el||!this.el.parentElement&&this.parent?(this.parent.children.mountChild(this),this._isMounted=!0,this.attachObserver()):this._isMounted=!0)}setDomElement(t){this._options.el=t,this._options.$el=u()(t),this.getInformationFromData(),this._isRendered=!0,this._isMounted=!0,this.attachObserver(),this.children.setInitData({isChildrenShown:!this.children.$toggleChildren.classList.contains("comment-toggle-children_collapse")}),this.children.updateChildrenCount()}attachObserver(){if(it.v&&this.$content){const t=new IntersectionObserver((e=>{e.forEach((e=>{e.isIntersecting&&(t.unobserve(e.target),this.isViewed=!0)}))}),{rootMargin:`-${nt.VIEWPORT_START}px 0px -${100*(1-nt.VIEWPORT_LIMIT)}% 0px`});t.observe(this.$content)}}addChildCommentByCurrentUser(e,s){if(this.hasChildren&&!this.isChildCommentsInitialized&&(this.children.$toggleChildren.click(),"dom"===this.comments.commentInitializationType))return;const i=new t(e,{parent:this,comments:this.comments,depth:this.depth+1});if(o.vE.initParams.experimentCommentsOnTop&&-1===this.depth?this.children.prependChild(i):this.isRoot?this.children.appendChild(i):this.children.prependChild(i),this.comments.add(i),i.renderByHtml(s),i.mount(),o.vE.initParams.experimentCommentsOnTop&&-1===this.depth){const t=document.querySelector('[data-id="all"]:not(.menu__item_current)');null==t||t.click(),o.vE.ui.elementInViewport(i.$body)||i.scrollTo(!0)}i.getInformationFromData(),this.comments.ui.mode!==l.lL.INCOMING&&this.comments.ui.mode!==l.lL.OUTCOMING&&i.highlight("green"),this.children.isChildrenShown=!0,o.vE.ui.player.init(i.$content),N.z.getInstance().init()}updateHtmlAfterEdit(t){this.$content.innerHTML=u()(t).find(".comment__content").html(),this.comments.ui.mode!==l.lL.INCOMING&&this.comments.ui.mode!==l.lL.OUTCOMING&&this.highlight("green"),o.vE.ui.player.init(this.$content),N.z.getInstance().init()}updateHtmlAfterLoad(t){const e=this.el,s=document.createElement("div");s.innerHTML=t;const i=s.querySelector(".comment__body")||document.createElement("div"),n=s.querySelector(".comment");if(!e||!i||!n)throw new Error("not found body | header of comment");for(;i.childNodes.length>0;)this.$body.appendChild(i.childNodes[0]);e.dataset.meta=n.dataset.meta,e.className=n.className,this.getInformationFromData(),this.isLoading=!1,e.classList.add("comment_show"),this.timeout("remove-show",200,(()=>{e.classList.remove("comment_show")}))}sendCommentPinAnalytics(){const t=this.comments.ui.story;p.c.getInstance().sendEvent("company_comment_pin",at(at({},t?{"pluses!undefined":t.analyticsData.pluses,"minuses!undefined":t.analyticsData.minuses,"rating!undefined":t.rating}:{}),{},{partner_id:o.vE.initParams.reputationClientId,comment_id:this.id,comment_author_id:this.authorId,post_id:this.comments.commentsMeta.storyId,author_id:this.comments.commentsMeta.storyAuthorId}))}async getDraft(){if(!o.vE.isUserAuthorized)return this.getCommentDraftFromLocalStorage();return(await this.comments.getDrafts(this.commentsMeta.storyId)).get(this.id)}async removeDraft(){(await this.comments.getDrafts(this.commentsMeta.storyId)).delete(this.id)}getCommentDraftFromLocalStorage(){const t=ot.m.get("pkb_reply_draft");if(t&&"string"!=typeof t)return this.id===t.key?t.value:void 0}async getSource(){const{response:t,data:e}=await r.cf.get(c.WB,{action:"get_comment_data",id:this.id},{cache:!1});return t.result?e:null}get commentsMeta(){return this.comments.ui.meta}async scrollTo(t=!1){if(!this.el)return;const{top:e}=this.el.getBoundingClientRect(),s=e+window.pageYOffset-(o.vE.applicationType===L.Zq.DESKTOP?20:50);await o.vE.ui.scrollTo(s,t)}open(){this.hasChildren&&(this.children.isChildrenShown=!0),!this.isRoot&&this.parent&&this.parent.open()}highlight(t,e=!0,s){if(!this.$body)return;const i=`comment__body_highlight_${t}`,n=this.$body.classList.contains(i),o=void 0!==s?s:!n;n!==o&&(this.$body.classList.toggle(i,o),e?(this.$body.classList.toggle("comment__body_highlight_blink",o),this.timeout(t,2e3,(()=>{this.$body&&this.$body.classList.remove(i,"comment__body_highlight_blink")}))):this.cancelTimeout(t))}checkNeedLoadingButton(){this.isRoot&&this.isRendered&&this.children.items.length&&this.children.isChildrenShown?(this.children.items.forEach((e=>e instanceof t&&e.checkNeedLoadingButton())),this.toggleMoreButton(!this.children.items[this.children.items.length-1].isRendered)):this.toggleMoreButton(!1)}toggleMoreButton(t){if(!t)return void(this.$toggleMore&&(this.$toggleMore&&this.$toggleMore.remove(),delete this.$toggleMore));if(this.$toggleMore)return;const e=o.vE.i18n("comments-next.button.toggle-more"),s=this.$toggleMore=(0,B.m)(`<button class="comment__more">${e}</button>`);this.children.$childrenContainer.append(s)}getInformationFromData(){var t;const e=this.el;if(!e)return;if(e.classList.contains("comment_fake"))return this.children.setInitData({isChildrenShown:!0}),void(this.isFake=!0);const s=e.dataset,i=new Map,n=new Set;"string"==typeof s.meta&&s.meta.split(";").forEach((t=>{const[e,s]=t.split("=");s?i.set(e,s):n.add(e)})),this.depth||(this._options.depth=this.isRoot?0:this.parent.depth+1),this.authorId=Number(i.get("aid"))||0;const o=null===(t=i.get("avh"))||void 0===t?void 0:t.split(":");this.voter.setInitData({amountVotesHidden:null==o?void 0:o.map((t=>Number(t))),vote:(0,h.i)(l.OC,Number(i.get("v")))||l.OC.NONE,inputAmountVotes:i.get("av"),inputRating:i.get("r")}),this.ignoreType=Number(i.get("ic")),this.ignoreCommunityName=i.get("cn"),this.ignoredByList=i.has("ib")?(i.get("ib")||"").split(",").filter((t=>""!==t.trim())):[],this.datetime=x()(i.get("d")||""),this.isAuthorCurrentUser=n.has("ua"),this.isModeratorAutoSelect=n.has("mau"),this._options.isEditable=n.has("e"),this.saver.setInitData({isSaved:n.has("s")}),this._options.isOfficial=n.has("io"),this._options.canUnpin=n.has("cu"),this._options.isNewest="boolean"==typeof this._options.isNewest?this._options.isNewest:"true"===s.newest,this.isStoryComment=n.has("sc"),this.hasChildrenMetaFlag=n.has("hc"),s.url&&(this._options.url=s.url),this.isComstory=e.classList.contains("comment_comstory"),this.isComstory&&w.getInstance().addComstory(this)}updateIsEditable(t){this.replyEditor.isReplyShown&&this.replyEditor.reply.emit("lockEditing"),this.controls.$controlRemove&&(this.controls.$controlRemove.hidden=!t),this.controls.updateControls()}get el(){return this._options.el}get $el(){return this._options.$el}get $body(){var t;if(this._options.$body)return this._options.$body;const e=null===(t=this.el)||void 0===t?void 0:t.querySelector(":scope > .comment__body");return e instanceof HTMLElement?e:this._options.$body=u()('<div class="comment__body"/>')[0]}get $datetime(){return this._options.$datetime?this._options.$datetime:this._options.$datetime=this.$body.querySelector(".comment__datetime")}get $content(){if(this._options.$content)return this._options.$content;let t=this.$body.querySelector(".comment__content");return t||(t=document.createElement("div"),t.classList.add("comment__content"),this.$body.insertAdjacentElement("beforeend",t)),this._options.$content=t}get $placeholder(){var t;if(this._options.$placeholder)return this._options.$placeholder;const e=null===(t=this.el)||void 0===t?void 0:t.querySelector(":scope > .comment__placeholder");if(e instanceof HTMLElement)return this._options.$placeholder=e;const s=this._options.$placeholder=(0,B.m)(`\n\t\t\t<div class="${"comment__placeholder"+(this.isNewest?" comment__body_highlight_yellow":"")}">\n\t\t\t\t${(0,st.Z)()}\n\t\t\t</div>\n\t\t`);return requestAnimationFrame((()=>{this.el&&this.el.insertAdjacentElement("afterbegin",s)})),this._options.$placeholder}get isNewest(){return Boolean(this._options.isNewest)}set isNewest(t){this._options.isNewest!==t&&(this._options.isNewest=t,this.el&&(this.highlight("yellow",!1,t),t?this.el.setAttribute("data-newest","true"):this.el.removeAttribute("data-newest")))}get isEditable(){return this._options.isEditable}set isEditable(t){this._options.isEditable!==t&&(this._options.isEditable=t,this.updateIsEditable(t))}get depth(){return this._options.depth}get indent(){const t=this.depth||0;return 0===t?0:t%c.Iz||c.Iz}get floor(){return Math.trunc(Math.abs((this.depth||0)-1)/c.Iz)}get children(){return this._children?this._children:this._children=new et.B(this)}get parent(){return this._options.parent}get parentComment(){const e=this.parent;return e?e instanceof t?e:e.parent:void 0}get comments(){return this._options.comments}get isRendered(){return!0===this._isRendered}get isMounted(){return!0===this._isMounted}get isLoading(){return this._options.isLoading}set isLoading(t){var e;this._options.isLoading!==t&&(this._options.isLoading=t,this.isRendered&&this.el&&this.$placeholder&&requestAnimationFrame((()=>{var e;null===(e=this.el)||void 0===e||e.classList.toggle("comment_placeholder",t)})),t||(null===(e=this._options.$placeholder)||void 0===e||e.remove(),this._options.$placeholder=null))}get isChildCommentsInitialized(){if(0===this.children.items.length)return!0;for(let t=this.children.items.length-1;t>=0;t--){const e=this.children.items[t];if(!e.isRendered||!e.isChildCommentsInitialized)return!1}return!0}get authorUserName(){if(this.isRoot)return this.commentsMeta.storyAuthorUserName;if(this._options.authorUserName||!this.el)return this._options.authorUserName||"";const t=this.el.querySelector(".comment__user");return t instanceof HTMLElement?this._options.authorUserName=t.dataset.name||"":""}get isOfficial(){return this._options.isOfficial}set isOfficial(t){if(this._options.isOfficial=Boolean(t),!t&&(this.canUnpin=!1,this.el)){const t=this.el.querySelector('.comment__label[data-role="official"]');t&&t.remove()}}get canUnpin(){return this._options.canUnpin}set canUnpin(t){this._options.canUnpin=Boolean(t),this.controls.updateControls()}get url(){return this._options.url?this._options.url:`${this.comments.commentsMeta.storyUrl}?cid=${this.id}`}get voter(){return this._voter?this._voter:this._voter=new V(this)}get replyEditor(){return this._replyEditor?this._replyEditor:this._replyEditor=new q(this)}get branchTools(){return this._branchTools?this._branchTools:this._branchTools=new G(this)}get saver(){return this._saver?this._saver:this._saver=new z(this)}get controls(){return this._controls?this._controls:this._controls=new X(this)}get isViewed(){return this._options.isViewed}set isViewed(t){this._options.isViewed=t}},ht(tt.prototype,"removeByCurrentUser",[Q],Object.getOwnPropertyDescriptor(tt.prototype,"removeByCurrentUser"),tt.prototype),ht(tt.prototype,"restoreByCurrentUser",[J],Object.getOwnPropertyDescriptor(tt.prototype,"restoreByCurrentUser"),tt.prototype),tt)},1973:(t,e,s)=>{"use strict";s.d(e,{g:()=>P});s(5827),s(6992),s(3948),s(8674);var i=s(2134),n=s(8211),o=(s(2707),s(1817),s(1014)),r=s(7502),a=s(9738);function l(t){const e=null===t?0:t.length;return e>0?t[e-1]:void 0}let h;function c(t,e){var s=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),s.push.apply(s,i)}return s}function d(t){for(var e=1;e<arguments.length;e++){var s=null!=arguments[e]?arguments[e]:{};e%2?c(Object(s),!0).forEach((function(e){u(t,e,s[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(s)):c(Object(s)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(s,e))}))}return t}function u(t,e,s){return e in t?Object.defineProperty(t,e,{value:s,enumerable:!0,configurable:!0,writable:!0}):t[e]=s,t}h=Symbol.iterator;class p extends o.v{constructor(t=!1,e,s="id"){super(),u(this,"items",[]),u(this,"onChangeData",((t,e)=>{this.emit("dataSetChange",this,t,e)})),this.DObject=e,this.fieldId=s,t&&(this.ids=[])}[h](){return this.items.values()}destroy(){this.isDestroyed||(this.clear(),delete this.ids,this.items=[],super.destroy())}add(t,e={}){return this.set(t,d(d({},e),{},{merge:!0}))}set(t,e={}){if(e=d({silent:!1,merge:!1,destroy:!0},e),Array.isArray(t)||(t=[t]),!t.length&&!e.merge)return this.clear();const s=this.items,i=[];let n=[];for(let h of t){if(!(0,a.K)(h))continue;if(s.includes(h)){n.push(h);continue}const t=this.getIdFromData(h);if(void 0!==t&&(this.ids&&this.ids.includes(t)||!this.ids)){const e=this.get(t);if(e){n.push(e);continue}}const o=this.prepareData(h);o&&(h=o),h instanceof r.L&&(this.listenTo(h,"dataDestroy",this.onDestroyData.bind(this)),this.listenTo(h,"dataChange",this.onChangeData)),i.push(h),n.push(h),e.silent||this.emit("dataSetAdd",this,h)}let o=s.filter((t=>!n.includes(t)));o.length&&(e.merge?(n=[...o].concat(n),o=null):this._remove(o,e)),this.items=n,this.ids&&this.updateIds();const l=this.prepareDelta(i,o);return!e.silent&&l&&this.emit("dataSetUpdate",this,l),l}prepareData(t){if(!this.DObject)return;if(t instanceof this.DObject)return t;const e=void 0===this.fieldId||this.DObject.prototype.fieldId?void 0:this.fieldId;return new this.DObject(t,!0,e)}getIdFromData(t){if(t instanceof r.L)return t.id;const e=this.DObject&&this.DObject.prototype.fieldId||this.fieldId;return e&&Object.prototype.hasOwnProperty.call(t,e)?t[e]:void 0}prepareDelta(t,e){const s={inserted:void 0,removed:void 0};let i=!1;return t&&t.length&&(s.inserted=t,i=!0),e&&e.length&&(s.removed=e,i=!0),i?s:null}remove(t,e={silent:!1,destroy:!0}){if(t===this.items)return this.clear(e);const s=Array.isArray(t)?t:[t],i=this.prepareDelta(null,this._remove(s,e));return this.emit("dataSetUpdate",this,i||{}),i}get(t){for(const e of this.items)if(e===t||this.getIdFromData(e)===t)return e}has(t){const e=this.items;let s;if("object"==typeof t){if(e.includes(t))return!0;const i=this.getIdFromData(t);if(void 0===i)return!1;s=i}return"string"!=typeof t&&"number"!=typeof t||(s=t),void 0!==s&&(this.ids?this.ids.includes(s):e.some((t=>this.getIdFromData(t)===s)))}findIndex(t){return this.items.findIndex(t)}firstId(){if(this.size)return this.ids?this.ids[0]:this.getIdFromData(this.items[0])}lastId(){if(!this.size)return;if(this.ids)return l(this.ids);const t=l(this.items);return t?this.getIdFromData(t):void 0}nextItem(t){const e=this.get(t);if(!e)return;const s=this.items.indexOf(e);return-1!==s&&s!==this.size-1?this.items[s+1]:void 0}prevItem(t){const e=this.get(t);if(!e)return;const s=this.items.indexOf(e);return-1!==s&&0!==s?this.items[s-1]:void 0}nextId(t){if(void 0===t)return;if(this.ids){let e=this.ids.indexOf(t);if(-1===e||e===this.size-1)return;return this.ids[++e]}const e=this.nextItem(t);return e?this.getIdFromData(e):void 0}prevId(t){if(void 0===t)return;if(this.ids){let e=this.ids.indexOf(t);if(-1===e||0===e)return;return this.ids[--e]}const e=this.prevItem(t);return e?this.getIdFromData(e):void 0}sort(t){this.items.sort(t),this.ids?(this.updateIds(),this.emit("dataSetSort",this)):this.emit("dataSetSort",this)}clear({silent:t=!1,destroy:e=!0}={silent:!1,destroy:!0}){const s=this.items;if(!this.size)return null;for(const n of this.items)!t&&n instanceof r.L&&n.emit("dataRemove",n,this),n instanceof o.v&&this.stopListening(n),e&&"object"==typeof n&&"function"==typeof n.destroy&&n.destroy();this.items=[],this.ids&&(this.ids=[]);const i=this.prepareDelta(null,s);return i&&this.emit("dataSetUpdate",this,i),i}updateIds(){this.ids=[],this.items.forEach((t=>{const e=this.getIdFromData(t);void 0!==e&&this.ids&&this.ids.push(e)}))}_remove(t,e={}){e=d({silent:!1,destroy:!0},e);const s=[],i=[],n=this.items;for(const a of t){let t,l=n.indexOf(a);if(-1===l){const e=this.get(a);if(!e)continue;l=n.indexOf(e),t=e}else t=a;if(-1!==l){if(n.splice(l,1),s.push(t),this.ids){const e=t instanceof r.L?t.id:this.getIdFromData(t);void 0!==e&&i.push(e)}!e.silent&&t instanceof r.L&&t.emit("dataRemove",t,this),t instanceof o.v&&this.stopListening(t),e.destroy&&"object"==typeof t&&"function"==typeof t.destroy&&t.destroy()}}return s.length?(this.ids&&(this.ids=function(t,...e){return t.filter((t=>!e.includes(t)))}(this.ids,...i)),s):null}onDestroyData(t){const e=this.prepareDelta(null,this._remove([t],{silent:!1}));e&&this.emit("dataSetUpdate",this,e)}get size(){return this.items.length}}var m=s(3399),_=s(8334),g=s(4612),v=s(8058);let f;!function(t){t[t.IS_IN_HIDDEN_GROUP=1]="IS_IN_HIDDEN_GROUP",t[t.IS_NEWEST=2]="IS_NEWEST",t[t.IS_STORY_AUTHOR=4]="IS_STORY_AUTHOR"}(f||(f={}));var y,b,w,E=s(5380),S=s(381),C=s.n(S),T=s(7041),O=s(6858),k=s(6349),I=s(9895);function $(t,e){var s=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),s.push.apply(s,i)}return s}function A(t){for(var e=1;e<arguments.length;e++){var s=null!=arguments[e]?arguments[e]:{};e%2?$(Object(s),!0).forEach((function(e){x(t,e,s[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(s)):$(Object(s)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(s,e))}))}return t}function x(t,e,s){return e in t?Object.defineProperty(t,e,{value:s,enumerable:!0,configurable:!0,writable:!0}):t[e]=s,t}function D(t,e,s,i,n){var o={};return Object.keys(i).forEach((function(t){o[t]=i[t]})),o.enumerable=!!o.enumerable,o.configurable=!!o.configurable,("value"in o||o.initializer)&&(o.writable=!0),o=s.slice().reverse().reduce((function(s,i){return i(t,e,s)||s}),o),n&&void 0!==o.initializer&&(o.value=o.initializer?o.initializer.call(n):void 0,o.initializer=void 0),void 0===o.initializer&&(Object.defineProperty(t,e,o),o=null),o}let P=(y=(0,v.E)(600),b=(0,E.H)(),w=class t extends p{constructor(t){super(!0,m.U),x(this,"commentInitializationType","tree"),this.ui=t,this.interval("updateTime",_.ly,this.updateCommentsTime.bind(this))}static createCommentsListByTree(e,s,i){const n=[],o=i.comments,r=o.getMaxCommentIdFromStorage();let a,l,h=!1;for(const[c,d,u]of s){const s=c+e,p=Boolean(d&f.IS_IN_HIDDEN_GROUP),_=Boolean(d&f.IS_NEWEST)||r?r<s:void 0,v=Boolean(d&f.IS_STORY_AUTHOR);p&&!h&&(a="number"==typeof a?a+1:0,l=new g.H(a,{parent:i,comments:o}),i.children.appendChild(l)),h=p;const y=p?l:i,b=new m.U(s,{isNewest:_,isStoryAuthor:v,parent:y,comments:o,depth:i.depth+1});n.push(b),null==y||y.children.appendChild(b),u&&n.push(...t.createCommentsListByTree(e,u,b))}return n}static createCommentsListByDom(e){const s=e.children.$childrenContainer;if(!s)return[];const i=[],n=e.comments,o=n.getMaxCommentIdFromStorage();let r=0;for(const a of Array.from(s.children)){if(!(a instanceof HTMLElement))continue;const s=a.classList.contains("comment");if(!s&&a.classList.contains("comment-hidden-group")&&e instanceof m.U){const s=new g.H(r++,{el:a,parent:e,comments:n});e.children.items.includes(s)||e.children.items.push(s),s.children.$childrenContainer&&i.push(...t.createCommentsListByDom(s));continue}if(!s)continue;const l=Number(a.dataset.id),h=o?o<l:void 0,c=new m.U(l,{el:a,isNewest:h,parent:e,comments:n,depth:e.depth+1});e.children.items.includes(c)||e.children.items.push(c),i.push(c),c.children.$childrenContainer&&i.push(...t.createCommentsListByDom(c))}return i}static getTreeFromElement(t){if(t)try{const e=JSON.parse(t.innerHTML);return e&&"number"==typeof e.min&&Array.isArray(e.tree)?e:void n.vE.logger.error("comments","bad data of JSON tree")}catch(e){n.vE.logger.error("comments","problem with JSON tree",e)}}async loadComments(t){if(!this.commentStack||!this.commentStack.length)return;const e=[...this.commentStack];delete this.commentStack;const{data:s,response:{result:n}}=await i.cf.post(_.WB,{action:"get_comments_by_ids",ids:e.join(",")});if(!n&&!s)return void this.rollbackLoadComments(t);const o=(s||[]).filter(());o.forEach((({id:t,html:e})=>{var s;return null===(s=this.get(t))||void 0===s?void 0:s.updateHtmlAfterLoad(e)})),e.filter((t=>!o.find((e=>t===e.id)))).forEach((t=>{const e=this.get(t);e&&e.destroy()})),(0,O.U)()}async getDrafts(t){const{response:e,data:s}=await i.cf.post(_.WB,{action:"get_drafts",story_id:t}),n=new Map;if(!e.result)return n;if("object"!=typeof s||Array.isArray(s)&&1!==s.length)return n;for(const[i,r]of Object.entries(s))if(r&&"object"==typeof r){try{const t=JSON.parse(r.images);r.images=t||[]}catch(o){r.images=[]}n.set(Number(i),r)}return n}updateCommentsByDom(t){const e=t.children.$childrenContainer;if(!e)return;const s=t instanceof g.H?t.parentComment.comments:t.comments,i=s.getMaxCommentIdFromStorage();let o=0;for(const r of Array.from(e.children)){if(!(r instanceof HTMLElement))continue;const e=r.classList.contains("comment");if(!e&&r.classList.contains("comment-hidden-group")&&t instanceof m.U){let e=t.children.getChildHiddenGroupById(o++);e?e.setDOM(r):(e=new g.H(o,{el:r,parent:t}),t.children.items.push(e)),e.children.$childrenContainer&&this.updateCommentsByDom(e);continue}if(!e)continue;const a=Number(r.dataset.id);let l=t.children.getChildCommentById(a);if(l)l.setDomElement(r);else{n.vE.logger.error("comments","has dom comment, but not found in tree");const e=i?i<a:void 0;l=new m.U(a,{el:r,isNewest:e,parent:t,comments:s,depth:t.depth+1}),t.children.items.includes(l)||t.children.items.push(l),this.add(l)}l.children.$childrenContainer&&this.updateCommentsByDom(l)}}loadNextPartChildrenComments(t,e=!1,s=!1){if(!t.children.items)return void(t instanceof m.U&&t.checkNeedLoadingButton());const i=t.depth+1,o=Math.ceil(Math.max(1,i)/_.Iz)*_.Iz,r=Math.min(n.vE.initParams.maxCommentsBranchDepth-1,_.Iz),a=i<=r?r:o,l=t.children.getUnloadChildComments(a,s?t.children.childTotalCount:_.Q1,e);if(!l.length)return void(t instanceof m.U&&t.checkNeedLoadingButton());const h=[];for(const n of l)n.parent.isChildCommentsInitialized||n.parent.children.isChildrenShown||(n.parent.children.isChildrenShown=!0),t.children.isOnlyHiddenGroupChildren&&(n.parent.render(),n.parent.mount()),n.render(),n.mount(),n instanceof m.U&&(n.isLoading=!0,h.push(n.id));this.commentStack=this.commentStack||[],this.commentStack.push(...h),this.loadComments(t),t instanceof m.U&&t.checkNeedLoadingButton()}addHighlightVisibleParent(t){const e="comment-toggle-children_highlight_blink";for(;t.parentComment;)if((t=t.parentComment).el&&null!==t.el.offsetParent&&t.children.$toggleChildren.offsetParent){const s=t.children.$toggleChildren;if(s.classList.contains(e))return;const i=s.classList.contains(e);s.classList.add("comment-toggle-children_highlight_yellow",e),this.timeout(`comments-highlight-${t.id}`,3e3,(()=>{i||s.classList.remove("comment-toggle-children_highlight_yellow"),s.classList.remove(e)}))}}initComments(e,s){const i=t.getTreeFromElement(s&&s.get(0));if(i)return this.commentInitializationType="tree",void this.initCommentByTree(e,i);this.commentInitializationType="dom",this.initCommentByDom(e)}initCommentByTree(e,s){const i=new m.U(_.iM,{comments:this});i.children.setInitData({$childrenContainer:e.get(0)}),this.set(i),this.add(t.createCommentsListByTree(s.min,s.tree,i)),this.updateCommentsByDom(i),this.items.find((t=>t.id!==_.iM&&t.isRendered))?i.checkNeedLoadingButton():this.loadNextPartChildrenComments(i)}sendVoteAnalytics(t,e){const i=n.eR.get("cvb")?"cvb":null,o=e.voter.amountVotesHidden||e.voter.amountVotes,{UIAllComments:r}=s(203),a=this.ui instanceof r?this.items.length:void 0,l=this.ui instanceof r?this.ui.story.subsCode:void 0;k.cp.getInstance().sendEvent("rate_content",A(A({post_id:this.commentsMeta.storyId,author_id:this.commentsMeta.storyAuthorId,comment_id:e.id,comment_author_id:e.authorId,user_rate:t},i&&{type:i}),{},{level:e.depth+1,"type_i8!empty":l,"pluses!undefined":o&&o[0],"minuses!undefined":o&&o[1]},a&&{comments:a}))}sendViewAnalytics(){let t=[];if(this.items.forEach((e=>{e.isViewed&&e.depth>=0&&(t[e.depth]||(t[e.depth]=0),t[e.depth]++)})),t=t.map((t=>t||0)),!t.length)return;const e=A(A({},this.ui.story.analyticsData),{},{create_at:I.Z.getInstance().getFirstViewTime("comments"),view_time:I.Z.getInstance().getViewTime("comments"),list:"["+t.join(", ")+"]"});k.cp.getInstance().sendEvent("show_comments",e,[k.b0.CLICKHOUSE])}getMaxCommentIdFromStorage(){return this.ui.getMaxCommentIdFromStorage()}initCommentByDom(e){const s=new m.U(_.iM,{comments:this});s.children.setInitData({$childrenContainer:e.get(0)}),this.set(s),this.add(t.createCommentsListByDom(s))}updateCommentsTime(){const t=C()();this.items.forEach((e=>{if(e.isRoot||!e.datetime)return;const s=t.diff(e.datetime);e.$datetime&&s<_.aH&&!n.vE.ui.elementInViewport(e.$el)&&(e.$datetime.textContent=e.datetime.fromNow()),e.isEditable&&s>_.KF&&(e.isEditable=!1)}))}rollbackLoadComments(t){const e=t=>{for(const s of t)s instanceof m.U&&(s.children.items.length&&e(s.children.items),s.isLoading=!1,s.destroy())};t.children.isChildrenShown=!1,e(t.children.items)}get commentsMeta(){return this.ui.meta}get availableNumberOfCommentsForToday(){return n.vE.initParams.availableNumberOfCommentsForToday}set availableNumberOfCommentsForToday(t){n.vE.initParams.availableNumberOfCommentsForToday=t,t>0||this.items.forEach((t=>{t.replyEditor.isReplyShown&&t.replyEditor.currentReplyMode!==T.tT.NONE&&t.replyEditor.reply.emit("enableSlowMode")}))}},D(w.prototype,"loadComments",[y],Object.getOwnPropertyDescriptor(w.prototype,"loadComments"),w.prototype),D(w.prototype,"getDrafts",[b],Object.getOwnPropertyDescriptor(w.prototype,"getDrafts"),w.prototype),w)},8334:(t,e,s)=>{"use strict";s.d(e,{iM:()=>o,ly:()=>r,aH:()=>a,Q1:()=>l,Iz:()=>h,BE:()=>c,r7:()=>d,KF:()=>u,Y2:()=>p,Ck:()=>m,Wk:()=>_,WB:()=>g});var i=s(8211),n=s(7591);const o=0,r=3e4,a=828e5,l=i.vE.applicationType===n.Zq.MOBILE?20:40,h=i.vE.applicationType===n.Zq.MOBILE?6:10,c=50,d=-300,u=6e5,p=/[^\wЁА-яё](вы|вас|вами|вам|ваш|вашу|ваши|ваших|вашей|вашему|вашем|вашим)(?:\s|&nbsp;)/,m="pkb_Cmi",_=400,g="/ajax/comments_actions.php"},7041:(t,e,s)=>{"use strict";let i,n,o,r,a;s.d(e,{OC:()=>i,tT:()=>n,IV:()=>o,hL:()=>r,lL:()=>a}),function(t){t[t.DOWN=-1]="DOWN",t[t.NONE=0]="NONE",t[t.UP=1]="UP"}(i||(i={})),function(t){t.NONE="none",t.CREATE="create",t.EDIT="edit"}(n||(n={})),function(t){t[t.NONE=0]="NONE",t[t.YOU_IGNORES_AUTHOR_OF_STORY=1]="YOU_IGNORES_AUTHOR_OF_STORY",t[t.AUTHOR_OF_STORY_IGNORES_YOU=2]="AUTHOR_OF_STORY_IGNORES_YOU",t[t.YOU_IGNORES_AUTHOR_OF_COMMENT=3]="YOU_IGNORES_AUTHOR_OF_COMMENT",t[t.AUTHOR_OF_COMMENT_IGNORES_YOU=4]="AUTHOR_OF_COMMENT_IGNORES_YOU",t[t.COMMUNITY_IGNORES_YOU=5]="COMMUNITY_IGNORES_YOU"}(o||(o={})),function(t){t[t.RATING=1]="RATING",t[t.TIME=2]="TIME",t[t.RELEVANCE=3]="RELEVANCE"}(r||(r={})),function(t){t[t.MAIN=0]="MAIN",t[t.INCOMING=1]="INCOMING",t[t.OUTCOMING=2]="OUTCOMING",t[t.STORY_AUTHOR=3]="STORY_AUTHOR",t[t.MODERATOR_CALLS=4]="MODERATOR_CALLS",t[t.REPUTATION=5]="REPUTATION",t[t.BEST=6]="BEST"}(a||(a={}))},2859:(t,e,s)=>{"use strict";s.d(e,{X:()=>S});s(5827),s(8674);var i,n,o,r,a,l,h,c,d=s(8211),u=s(9412),p=s(2134),m=s(1014),_=s(9755),g=s.n(_),v=s(8245),f=s(4113),y=s(8650),b=s(8246),w=s(2977);function E(t,e,s,i,n){var o={};return Object.keys(i).forEach((function(t){o[t]=i[t]})),o.enumerable=!!o.enumerable,o.configurable=!!o.configurable,("value"in o||o.initializer)&&(o.writable=!0),o=s.slice().reverse().reduce((function(s,i){return i(t,e,s)||s}),o),n&&void 0!==o.initializer&&(o.value=o.initializer?o.initializer.call(n):void 0,o.initializer=void 0),void 0===o.initializer&&(Object.defineProperty(t,e,o),o=null),o}let S=(i=(0,w.p)("click",'.comment__tool[data-role="ban"]'),n=(0,w.p)("click",'.comment__tool[data-role="remove"]'),o=(0,w.p)("click",'.comment__tool[data-role="restore"]'),r=(0,w.p)("click",'.comment__control[data-role="take"]'),a=(0,w.p)("click",'.comment__control[data-role="check"]'),l=(0,w.p)("click",'.comment__tool[data-role="branch-hide"]'),h=(0,w.p)("click",'.comment__tool[data-role="branch-show"]'),c=class t extends m.v{constructor(){super()}static getInstance(){return t.instance?t.instance:t.instance=new t}static getModeratorLoading(t){const e=t.find(".comment__moderator-loading");return e.length?e:g()(`<div class="comment__moderator-loading" data-type="loading">\n\t\t\t${(0,f.t)("ui__progress-circle","player")}\n\t\t</div>`).appendTo(t)}static getModeratorTools(){const t=v.S.getInstance().get("ModeratorTools");if(!t||"function"!=typeof t)throw new Error("not found Story in UIComponentsRegistry");return new t}onBan(e){const s=e.controls.$controls.querySelector('.comment__tool[data-role="ban"]'),i=e.authorId,n=e.id;i&&t.getModeratorTools().on("complete",(()=>{s&&s.classList.add("comment__tool_active")})).showBanUserDialog(s||e.controls.$controls,i,n,2)}onRemove(e){return new Promise((s=>{const i=e.controls.$controls.querySelector('.comment__tool[data-role="remove"]'),n=e.$content,o=e.id;o&&t.getModeratorTools().on("complete",(t=>{i instanceof HTMLElement&&(i.hidden=!0);const o=e.controls.$controls.querySelector('.comment__tool[data-role="restore"]');o instanceof HTMLElement&&(o.hidden=!1),n.insertAdjacentHTML("afterbegin",`<span class="comment__content-removed-info">\n\t\t\t\t\t\t${d.vE.i18n("comments.success.deleted")}\n\t\t\t\t\t\t${t.toLowerCase()}\n\t\t\t\t\t</span>`);new u.O({content:`${d.vE.i18n("comments.success.deleted")}${t.toLowerCase()}`}).show(),s(!0)})).on("cancel",(()=>s(!1))).showDeleteCommentDialog(i||e.controls.$controls,o)}))}onRestore(e){return new Promise((s=>{const i=e.controls.$controls.querySelector('.comment__tool[data-role="restore"]'),n=e.id;n&&t.getModeratorTools().on("complete",(()=>{var t;i instanceof HTMLElement&&(i.hidden=!0);const n=e.controls.$controls.querySelector('.comment__tool[data-role="remove"]');null===(t=e.$content.querySelector(".comment__content-removed-info"))||void 0===t||t.remove(),n instanceof HTMLElement&&(n.hidden=!1);new u.O({content:d.vE.i18n("comments.success.restored")}).show(),s(!0)})).on("cancel",(()=>s(!1))).restoreComment(n)}))}onTake(e,s){const i=g()(s.target),n=i.data("current"),o=t.getModeratorLoading(i.parent()),r=i.data("id");r&&(o.show(),t.getModeratorTools().on("cancel",(()=>{o.hide()})).on("complete",(()=>{i.data("current",n?0:1).text(n?"Берусь":"Вернуть").attr("title",n?"Взяться на проверку":"Вернуть с проверки"),o.hide()})).takeModCall(r,n))}onCheck(e,s){const i=g()(s.target).closest(".comment__control"),n=t.getModeratorLoading(i.parent()),o=i.siblings('.comment__control[data-role="take"]'),r=i.data("current"),a=i.data("id");a&&(n.show(),t.getModeratorTools().on("cancel",(()=>{n.hide()})).on("complete",(()=>{i.siblings(".comment__moderator-checked").toggle().html(d.vE.icon("ui__moderator","comments")+" "+d.vE.initParams.userName),i.data("current",r?0:1).text(r?"Проверено":"Отмена").attr("title",r?"Проверка выполнена":"Убрать отметку о проверке"),o.toggle(r),n.hide()})).approveModCall(a,r))}onBranchHide(e,s){return new Promise((i=>{t.getModeratorTools().on("complete",(async()=>{const{response:t}=await p.cf.post("/ajax/comments_actions.php",{action:"hide",comment_id:e.id});if(!t.result)return d.vE.ui.toasts.showError(t.message||"comments.error.400"),i(!1);e.$content.insertAdjacentHTML("afterend",`<div class="comment__notice">\n\t\t\t\t\t\t${String(d.vE.i18n("comments.notice.branch-hidden"))}\n\t\t\t\t\t</div>`),e.children.isChildrenShown=!1,s&&s.target&&(s.target.hidden=!0,s.target.nextElementSibling.hidden=!1),i(!0),d.vE.ui.toasts.add("hidden",{content:"comments.success.hidden"})})).on("cancel",(()=>i(!1))).showHideBranchDialog(s&&s.target,e.authorId,e.id)}))}onBranchShow(e,s){return new Promise((i=>{t.getModeratorTools().on("complete",(async()=>{const{response:t}=await p.cf.post("/ajax/comments_actions.php",{action:"reveal",comment_id:e.id});if(!t.result)return d.vE.ui.toasts.showError(t.message||"comments.error.400"),i(!1);const n=e.$body.querySelector(".comment__notice");n&&n.remove(),s&&s.target&&(s.target.hidden=!0,s.target.previousElementSibling.hidden=!1),i(!0),d.vE.ui.toasts.add("shown",{content:"comments.success.shown"})})).on("cancel",(()=>i(!1))).showRestoreBranchDialog(s&&s.target,e.authorId,e.id)}))}init(t){var e,s;const i=t.ui.$el;i&&i.length&&(null===(e=this.__meta)||void 0===e||null===(s=e.listDelegatedEvents)||void 0===s||s.forEach((({events:t,selector:e,handler:s})=>{i.on(t,e,(t=>{const e=(0,y.Y)(t.currentTarget,400);if(!(e&&e instanceof b.t))return;const i=e.getCommentByElement(t.currentTarget);i&&s.call(this,i,t)}))})))}},E(c.prototype,"onBan",[i],Object.getOwnPropertyDescriptor(c.prototype,"onBan"),c.prototype),E(c.prototype,"onRemove",[n],Object.getOwnPropertyDescriptor(c.prototype,"onRemove"),c.prototype),E(c.prototype,"onRestore",[o],Object.getOwnPropertyDescriptor(c.prototype,"onRestore"),c.prototype),E(c.prototype,"onTake",[r],Object.getOwnPropertyDescriptor(c.prototype,"onTake"),c.prototype),E(c.prototype,"onCheck",[a],Object.getOwnPropertyDescriptor(c.prototype,"onCheck"),c.prototype),E(c.prototype,"onBranchHide",[l],Object.getOwnPropertyDescriptor(c.prototype,"onBranchHide"),c.prototype),E(c.prototype,"onBranchShow",[h],Object.getOwnPropertyDescriptor(c.prototype,"onBranchShow"),c.prototype),c)},2015:(t,e,s)=>{"use strict";s.d(e,{F:()=>f});var i=s(8211),n=s(7025),o=s(1014),r=s(9717),a=s(4113),l=s(9755),h=s.n(l),c=s(5190),d=s(8650),u=s(8246),p=s(2822),m=s(8334),_=s(7041),g=s(9289);function v(t,e){for(;t;){if(t instanceof Element&&t.matches(e))return t;t=t.parentNode}return null}class f extends o.v{constructor(){var t,e,s;super(),s=0,(e="amountClick")in(t=this)?Object.defineProperty(t,e,{value:s,enumerable:!0,configurable:!0,writable:!0}):t[e]=s}static getInstance(){return f.instance?f.instance:f.instance=new f}init(){const t=(0,c.D)(this.onClickQuote.bind(this),200);h()(document).on("mousedown",(()=>{this.amountClick++,this._quotePopup&&this.quotePopup.hide()})).on("mouseup",(()=>{0==--this.amountClick&&t()}))}onClickQuote(){if(this.amountClick>0)return;const t=window.getSelection();if(!t||!t.rangeCount)return;const e=t.getRangeAt(0),s=e.cloneRange(),n=document.createElement("div"),o=v(t.anchorNode,".comment"),r=v(t.focusNode,".comment");if(!o||o!==r||v(t.anchorNode,".comment__reply-wrapper")||h()(r).hasClass("comment_comstory"))return;const a=(0,d.Y)(o);if(!(a&&a instanceof u.t))return;const l=a.getCommentByElement(o);if(!l)return;const c=e.startContainer,p=e.endContainer,m=v(c,".comment__content"),_=v(p,".comment__content");if(!m)return;const g=l.$content;if(!_&&g&&g.firstChild&&g.lastChild&&(m||s.setStart(g.firstChild,0),s.setEndAfter(g.lastChild)),t.removeAllRanges(),t.addRange(s),n.appendChild(s.cloneContents()),!n.textContent||n.textContent.length<5)return;const f=n.innerHTML;this.quote=`<blockquote>${f}</blockquote><br>`,this.quoteCommentId=l.id,this.currentComments=a;const y=s.getBoundingClientRect(),b=this.quotePopup;b.target={offset:{top:y.top+i.vE.ui.scrollTop,left:y.left+i.vE.ui.scrollLeft},height:y.height,width:y.width},b.show()}get quotePopup(){return this._quotePopup||(this._quotePopup=new n._({delay:800,content:`<div class="comment-quote">${(0,a.t)("editor__quote")}</div>`,minWidth:1,theme:r.xb.WARNING,direction:r.Lh.TOP}),this._quotePopup.content.on("mousedown",(()=>{if(!this.currentComments||!this.quoteCommentId||!this.quote)return;if(p.c.getInstance().yandex.goal("Quote_text_selection"),!i.vE.isUserAuthorized)return void i.vE.ui.authRequired();if(!this.currentComments)return;let t=this.currentComments.comments.items.find((t=>!t.isRoot&&t.replyEditor.isReplyShown));if(!t){if(t=this.currentComments.comments.get(this.quoteCommentId),!t||t.depth>=m.BE||!(0,g.s)(t,!0))return;t.replyEditor.currentReplyMode=_.tT.CREATE,t.replyEditor.isReplyShown=!0}const e=t.replyEditor.reply;e&&e.paste(this.quote),this._quotePopup.hide()}))),this._quotePopup}}},4612:(t,e,s)=>{"use strict";s.d(e,{H:()=>h});var i=s(8211),n=s(1014),o=s(747),r=s(6917),a=s(9755),l=s.n(a);class h extends n.v{constructor(t,e){var s,i,n;super(e),n=!1,(i="_isRendered")in(s=this)?Object.defineProperty(s,i,{value:n,enumerable:!0,configurable:!0,writable:!0}):s[i]=n,this.id=t,this._isRendered=Boolean(this.el),this.children.setInitData({isChildrenShown:!1})}render(){if(this.isRendered||this.el)return void(this._isRendered=!0);const t=this._options.el=l()('<div class="comment-hidden-group"/>')[0];t.appendChild(this.children.$childrenContainer),t.appendChild(this.$toggleChildren),this._isRendered=!0}mount(){this.isMounted||(!this.el||!this.el.parentElement&&this.parent?(this.parent.children.mountChild(this),this._isMounted=!0):this._isMounted=!0)}setDOM(t){this._options.el=t,this._isRendered=!0}open(){this.children.isChildrenShown=!0,this.parent&&this.parent.open()}get el(){return this._options.el}get $toggleChildren(){var t;if(this._options.$toggleChildren)return this._options.$toggleChildren;const e=null===(t=this.el)||void 0===t?void 0:t.querySelector(":scope > .comment-hidden-group__toggle");if(e instanceof HTMLElement)return e;const s=i.vE.i18n("comments-next.button.toggle-hidden-group-children",this.children.items.length);return this._options.$toggleChildren=(0,o.m)(`<div class="comment-hidden-group__toggle">${s}</div>`)}get depth(){return this.parent.depth}get parent(){return this._options.parent}get parentComment(){return this._options.parent}get children(){return this._children?this._children:this._children=new r.B(this)}get comments(){return this._options.comments}get isRendered(){return this._isRendered}get isMounted(){return!0===this._isMounted}get isChildCommentsInitialized(){if(0===this.children.items.length)return!0;for(let t=this.children.items.length-1;t>=0;t--){const e=this.children.items[t];if(!e.isRendered||!e.isChildCommentsInitialized)return!1}return!0}}},6858:(t,e,s)=>{"use strict";s.d(e,{U:()=>o});var i=s(8211),n=s(5924);function o(){n.z.getInstance().init(),i.vE.ui.player.init()}},2300:(t,e,s)=>{"use strict";s.d(e,{_W:()=>i,Kj:()=>n,U4:()=>o,Ft:()=>r,It:()=>a,w5:()=>l,xP:()=>h,hx:()=>c,VB:()=>d,Ri:()=>u,eC:()=>p,Ay:()=>m,Mb:()=>_,Uk:()=>g,aB:()=>v,E4:()=>f,wF:()=>y});const i=1e4,n=10,o=2,r=500,a=5e3,l=1e4,h=300,c=300,d="pkb_CHS",u=12096e5,p=2,m=["moderator","SupportTech","SupportCommunity","SupportTags","editors"],_="section_fixed",g="popup_hint-compost-fixed",v=138,f=121,y="Ваш аккаунт пока ещё не подтверждён. Привяжите соцсеть или номер телефона в настройках, чтобы получить возможность оставлять комментарии."},8437:(t,e,s)=>{"use strict";s.d(e,{c:()=>W});s(8674),s(6992),s(3948),s(4603),s(4916),s(7314),s(5827),s(5306);var i=s(2134),n=s(8211),o=s(7323),r=s(7025),a=s(8553),l=s(1639),h=s(3479),c=s(9412),d=s(4877),u=s(7041);var p=s(7770),m=s(8058),_=s(2300);const g=[],v=[];var f=s(7245),y=s(7111),b=s(9717);var w=s(8854),E=s(9755),S=s.n(E),C=s(381),T=s.n(C);var O=s(874),k=s(2822),I=s(8334);var $,A,x,D,P,R,M,N=s(203),B=s(5595),L=s(7591),F=s(6099),U=s(7579);function j(t,e){var s=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),s.push.apply(s,i)}return s}function V(t){for(var e=1;e<arguments.length;e++){var s=null!=arguments[e]?arguments[e]:{};e%2?j(Object(s),!0).forEach((function(e){H(t,e,s[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(s)):j(Object(s)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(s,e))}))}return t}function H(t,e,s){return e in t?Object.defineProperty(t,e,{value:s,enumerable:!0,configurable:!0,writable:!0}):t[e]=s,t}function q(t,e,s,i,n){var o={};return Object.keys(i).forEach((function(t){o[t]=i[t]})),o.enumerable=!!o.enumerable,o.configurable=!!o.configurable,("value"in o||o.initializer)&&(o.writable=!0),o=s.slice().reverse().reduce((function(s,i){return i(t,e,s)||s}),o),n&&void 0!==o.initializer&&(o.value=o.initializer?o.initializer.call(n):void 0,o.initializer=void 0),void 0===o.initializer&&(Object.defineProperty(t,e,o),o=null),o}let W=($=(0,m.E)(_.Ft),A=(0,m.E)(500),x=(0,m.E)(_.hx),D=(0,m.E)(_.w5),P=(0,m.E)(_.It),R=(0,m.E)(_.Ft),M=class t extends d.u{constructor(t){super(),H(this,"isComstoryHintEnabled",!1),H(this,"menuItems",[]),H(this,"_byModerator",!1),H(this,"offensiveMeta",{lastText:"",lastTime:0}),H(this,"_isOffensive",!1),H(this,"shownHintSpecialUsers",!0),this.comment=t,this.listenTo(this,"enableSlowMode",this.turnOff),this.isUserConfirmedBeforeUnload=!1,this.listenTo(n.vE,"success-user-confirmed",this.onSuccesUserConfirmed.bind(this)),n.vE.initParams.experimentRegOnComment&&!this.isUserConfirmedBeforeUnload&&this.addListenersForRegAuth()}async onSuccesUserConfirmed(){const t=y.m.get("pkb_reply_draft");t&&this.comment.id===t.key&&(this.isUserConfirmedBeforeUnload=!0,this.setCommentForCreate(),await this.onSubmit())}static async validateDraftImages(t){if(!t||"object"!=typeof t.images)return t;const e=[];for(const s of t.images)("object"!=typeof s||"image"!==s.type||await(0,O.h)(s.url))&&e.push(s);return V(V({},t),{},{images:e})}async detectOffensive(){if(this.isDestroyed||!this.isShown)return;if(n.vE.initParams.experimentRegOnComment)return;const t=this.editorTextContent,{lastText:e,lastTime:s}=this.offensiveMeta,o=Date.now();if(this.cancelTimeout("detectOffensive"),t.length<=_.U4)return this.offensiveMeta.lastText="",void(this.isOffensive=!1);if(s&&o-s<_._W)return;if(100*function(t,e){if(t===e)return 0;const s=t;t.length>e.length&&(t=e,e=s);let i=t.length,n=e.length;for(;i>0&&t.charCodeAt(~-i)===e.charCodeAt(~-n);)i--,n--;let o,r,a,l,h=0;for(;h<i&&t.charCodeAt(h)===e.charCodeAt(h);)h++;if(i-=h,n-=h,0===i)return n;let c=0,d=0;for(;c<i;)v[c]=t.charCodeAt(h+c),g[c]=++c;for(;d<n;)for(o=e.charCodeAt(h+d),a=d++,r=d,c=0;c<i;c++)l=o===v[c]?a:a+1,a=g[c],r=g[c]=a>r?l>r?r+1:l:l>a?a+1:l;return r||0}(e,t)/Math.max(e.length,t.length)<_.Kj)return;this.offensiveMeta.lastText=t,this.offensiveMeta.lastTime=o;const{response:r,data:a}=await i.cf.post(I.WB,{action:"is_offensive",text:t,story_id:this.storyId,parent_id:this.comment.id});this.isOffensive=r.result&&a.result;const l=Math.max(0,_._W-(Date.now()-o));this.timeout("detectOffensive",l,this.detectOffensive.bind(this))}async detectMediaUrl(){const t=await a.j.instance.extractImageVideoUrls(this.editorValue);await this.thumbs.add(t)}toggleComstoryHint(){if(!(!this.isComstoryHintEnabled||this.comstoryHintMeta.count>=_.eC||this.comstoryHintMeta.lastShown>Date.now()-_.Ri))if(this.editorTextContent.length<_.xP)this.comstoryHint.hide();else{if(this.comstoryHint.show(),this.isNeedCompostHintFixed){var t;this.comstoryHint.el.classList.add(_.Uk);const e=(null===(t=this.comstoryHint.target.$target.get(0))||void 0===t?void 0:t.getBoundingClientRect().top)-_.E4;this.comstoryHint.el.style.top=e+"px",this.listenTo(n.vE,"keyboard-is-close",(()=>{setTimeout((()=>{var t;const e=(null===(t=this.comstoryHint.target.$target.get(0))||void 0===t?void 0:t.getBoundingClientRect().top)-_.E4;this.comstoryHint.el.style.top=e+"px"}),200)}))}else this.comstoryHint.el.classList.remove(_.Uk),this.comstoryHint.notUpdatePosition=!1;this.comstoryHintMeta={count:this.comstoryHintMeta.count+1,lastShown:Date.now()}}}checkMentions(){this.feedbackOffer&&this.feedbackOffer.checkMentions(this.editorTextContent)}async saveDraft(){var t;if(n.vE.initParams.experimentRegOnComment)return;if(this.isLoading||this.replyMode!==u.tT.CREATE)return;await this.uploadImages();const e=this.serialize(!0);if(this.lastDraft&&this.lastDraft.desc===e.desc&&JSON.stringify(this.lastDraft.images)===e.images||!this.lastDraft&&this.isEditorEmpty)return;const{response:s}=await i.cf.post(I.WB,e);s.result?(this.lastDraft=V({date:(new Date).toISOString()},e),this.showSavingDraftMessage(null===(t=this.lastDraft)||void 0===t?void 0:t.date)):n.vE.logger.error("comments","problem with save comment draft")}saveLastDraftInLocalStorage(){const t=this.serialize(!0),e=V({date:(new Date).toISOString()},t);y.m.set("pkb_reply_draft",{key:Number(e.parent_id),value:e})}async saveDraftForce(){const t=this.serialize(!0);try{const{response:e}=await i.cf.post(I.WB,t);if(!e.result)return void console.error("problem with force save comment draft")}catch(e){console.error("cannot force save draft")}}detectModerators(){if(!this.shownHintSpecialUsers)return;const t=this.editorTextContent,e=_.Ay.filter((e=>new RegExp(`@${e}([^a-zA-Zа-яА-ЯёЁ0-9_]|$)`).test(t)));if(this.hideSpecialUsersHint(),!e.length)return;const s=e.length>1?"all":e[0];var i,n;this._options.$specialUsers=S()((i={user:s},n="",Array.prototype.join,n+='<div class="comment-reply__special-users">\n    <span class="comment-reply__special-users-close"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon--ui__close"><use xlink:href="#icon--ui__close"></use></svg></span>\n    ',"moderator"===i.user?n+='\n        Вы призываете модератора.\n        <br>Обратите внимание, <a href="/@moderator" target="_blank">@moderator</a> решает вопросы, связанные с нарушениями правил.\n        <br>Если проблема носит технический характер, позовите <a href="/@SupportTech" target="_blank">@SupportTech</a>.\n    ':"SupportTech"===i.user?n+='\n        Вы призываете техническую поддержку.\n        <br>Обратите внимание, <a href="/@SupportTech" target="_blank">@SupportTech</a> помогает разобраться с багами и отвечает на технические вопросы по будням.\n        <br>Если вы не уверены, что проблема носит технический характер, лучше позовите <a href="/@moderator" target="_blank">@moderator</a>.\n    ':"SupportCommunity"===i.user?n+='\n        Вы призываете аккаунт поддержки сообществ.\n        <br>Обратите внимание, <a href="/@SupportCommunity" target="_blank">@SupportCommunity</a> помогает решить вопросы, связанные с сообществами на Пикабу.\n        <br>Если ваш вопрос связан с нарушениями правил сайта, лучше позовите <a href="/@moderator" target="_blank">@moderator</a>, если с техническими проблемами, позовите <a href="/@SupportTech" target="_blank">@SupportTech</a>.\n    ':"SupportTags"===i.user||"editors"===i.user?n+='\n        Вы призываете команду редакторов тегов.\n        <br>Обратите внимание, <a href="/@editors" target="_blank">@editors</a> могут помочь в редактировании тегов, одобрении новых.\n        <br>Если ваш вопрос связан с нарушениями правил сайта, лучше позовите <a href="/@moderator" target="_blank">@moderator</a>, если с техническими проблемами, позовите <a href="/@SupportTech" target="_blank">@SupportTech</a>.\n    ':n+='\n        Кажется, вы сомневаетесь, кого лучше призвать.\n        <br><a href="/@moderator" target="_blank">@moderator</a> решает вопросы, связанные с нарушениями правил.\n        <br><a href="/@SupportTech" target="_blank">@SupportTech</a> помогает разобраться с багами и отвечает на технические вопросы.\n        <br><a href="/@SupportCommunity" target="_blank">@SupportCommunity</a> помогает решить вопросы, связанные с сообществами на Пикабу.\n        <br><a href="/@SupportTags" target="_blank">@SupportTags</a> и <a href="/@editors" target="_blank">@editors</a> могут помочь в редактировании тегов, одобрении новых.\n        <br>Пожалуйста, постарайтесь призывать одного конкретного специалиста по вопросу.\n    ',n+="\n</div>")),this._options.$specialUsersClose=this._options.$specialUsers.find(".comment-reply__special-users-close").on("click",(()=>{this.shownHintSpecialUsers=!1,this.hideSpecialUsersHint()})),this.$controls.before(this._options.$specialUsers)}mount(){return this.isMounted?this:(super.mount(),"edit"===this.replyMode||!this.hasCommentLimitBeenReached&&(n.vE.initParams.canUserComment||n.vE.initParams.experimentRegOnComment)?(this.comment.isRoot||this.focus(),n.vE.applicationType!==L.Zq.MOBILE&&this.initInputTextCorrector(),this):(this.turnOff(),this))}show(){return super.show(),this.replyMode===u.tT.EDIT&&this.loadSource(),this}paste(t){throw new Error("method `paste` not implemented")}async onSubmit(){var t;if(this.isLoading)return;if(!n.vE.initParams.isConfirmed&&!(await(new F.R).show(F.J.COMMENT))&&!n.vE.initParams.experimentRegOnComment)return;if(n.vE.initParams.experimentRegOnComment&&!this.isUserConfirmedBeforeUnload&&this.editorTextContent.length)return k.c.getInstance().sendEvent("click",{type:"unauth_leave_comment"}),this.saveLastDraftInLocalStorage(),void this.openAuthForm();k.c.getInstance().yandex.goal("tap-comment-send"),k.c.getInstance().google.event("submit","comment");const e=y.m.get("pkb_cfc");if(this.isEmpty&&!e)return void n.vE.ui.toasts.showError(n.vE.i18n("comments.errors.empty"));null===(t=this.invalidInputDetector)||void 0===t||t.destroyMessage();const s=Date.now();let o;if(this.isLoading=!0,await this.uploadImages(),e?(o=e,y.m.remove("pkb_cfc")):o=this.serialize(!1),!o)return void(this.isLoading=!1);const{response:r,data:a}=await i.cf.post(I.WB,o);if(await(0,w.g)(1e3-(Date.now()-s)),this.isLoading=!1,this.closeOffensiveMessage(),!r.result)return void n.vE.ui.toasts.showError(400===r.status?n.vE.i18n("comments.errors.400"):r.message);if(this.replyMode===u.tT.CREATE){var l,h;const t=this.comment.comments.ui instanceof N.UIAllComments?this.comment.comments.ui.story.subsCode:void 0,e=this.comment.comments.ui instanceof N.UIAllComments?this.comment.comments.items.length:void 0,s=this.comment.depth+1;k.c.getInstance().sendEvent("leave_comment",V(V({post_id:this.storyId,author_id:this.comment.comments.commentsMeta.storyAuthorId,comment_author_id:this.comment.authorId,comment_id:this.comment.id},n.vE.initParams.isReputationClient&&{type:"company"}),{},{level:s,"comments!undefined":e,"type_i8!empty":t})),U.SR.getInstance().init("comment_publish",null===(l=this.comment.comments.ui)||void 0===l||null===(h=l.story)||void 0===h?void 0:h.getShowPostAnalyticsData())}const c=a.html,d=Number(a.comment_id);if(y.m.remove("pkb_cfc"),y.m.remove("pkb_reply_draft"),n.vE.initParams.experimentRegOnComment&&(await(0,w.g)(100),window.location.href=window.location.href+`?cid=${d}`),this.replyMode===u.tT.EDIT?(this.comment.updateHtmlAfterEdit(c),n.vE.emit("comment_edit",{id:d,content:c})):n.vE.initParams.isConfirmed&&this.comment.addChildCommentByCurrentUser(d,c),this.emit("add"),n.vE.initParams.isSlowModeEnabled&&this.comment.comments.availableNumberOfCommentsForToday>0&&this.replyMode===u.tT.CREATE&&this.comment.comments.availableNumberOfCommentsForToday--,this.hideSpecialUsersHint(),this.comment.removeDraft(),this.comment.isRoot)return this.thumbs.clear(),this.editorValue="",this.editor.els.input.classList.toggle("medium-editor-placeholder"),void this.showSavingDraftMessage();this.comment.replyEditor.currentReplyMode=u.tT.NONE,this.comment.id&&n.vE.initParams.experimentCommentsOnTop&&n.vE.emit("close-not-root-comment-reply"),this.comment.replyEditor.isReplyShown=!1}openAuthForm(){if(n.vE.isMobileApp){const t=window.document.querySelector('[data-role="sign-in"]');if(!t)return;null==t||t.click()}else n.vE.ui.authModalForComment.showSignUp()}addListenersForRegAuth(){this.listenTo(n.vE,"success-signup-not-confirmed",this.handleNotConfirmedEnter),this.listenTo(n.vE,"oauth-begin",(()=>{this.setCommentForCreate()}))}async handleNotConfirmedEnter(){await this.saveDraftForce(),y.m.set("pkb_mar",{messageAfterReload:_.wF,theme:c.K.DANGER}),await(0,w.g)(500),window.location.reload()}setCommentForCreate(){const t=y.m.get("pkb_reply_draft");if(!t||"string"==typeof t)return;const e={action:"create",desc:t.value.desc,images:[],parent_id:t.key,story_id:Number(n.vE.initParams.pageRecordID)};y.m.set("pkb_cfc",e)}turnOff(){this.$el&&this.$el.addClass("comment-reply_slow-mode")}focus(){throw new Error("method `focus` not implemented")}showSavingDraftMessage(t){const e=Boolean(t),s=e?n.vE.i18n("comments.draft.saved",T()(t).format("HH:mm")):"";this.$draftDate.text(s).toggleClass("comment-reply__draft-date_show",e).toggle(e),this.cancelTimeout("draft-message"),e&&(this.$draftDate.addClass("comment-reply__draft-date_animate"),this.timeout("draft-message",300,(()=>{this.$draftDate.removeClass("comment-reply__draft-date_animate")})))}closeOffensiveMessage(){this.$offensive&&this.isOffensive&&(this.cancelDecorator(this.detectOffensive),this.cancelTimeout("detectOffensive"),this.runTimeoutImmediately(),this.$offensive.hide())}renderForm(t){const e=[this.comment.ignoreType,this.comment.comments.commentsMeta.ignoreType],s=e.includes(u.IV.COMMUNITY_IGNORES_YOU),i=e.includes(u.IV.AUTHOR_OF_COMMENT_IGNORES_YOU),o=e.includes(u.IV.AUTHOR_OF_STORY_IGNORES_YOU),r=n.vE.isUserModerator&&(this.comment.isModeratorAutoSelect||s);this._byModerator=r;let a=[];i&&a.push(this.comment.authorUserName),o&&this.comment.comments.commentsMeta.storyAuthorUserName!==this.comment.authorUserName&&a.push(this.comment.comments.commentsMeta.storyAuthorUserName),a=[...new Set(a)],this.comment.isRoot&&this.menuItems.push({action:"comstory",text:"comments.reply-menu.comstory"});const l=this.replyMode===u.tT.CREATE&&this.comment.isRoot&&this.comment.comments.commentsMeta.hasClientMentions,c=a.length?n.vE.i18n("comments-next.hidden.reply-note",a.length,(d=a,[...d].map((t=>`<b>${t}</b>`)).join(d.length>1?" и ":", "))):void 0;var d;this.$el=S()('<div class="comment-reply"/>'),this.$el.append(t({noteHidden:c,isMain:this.comment.isRoot,plainText:!1,accessImage:n.vE.initParams.isConfirmed,menu:this.menuItems.length>0,showIsOfficialCheckbox:l,isOfficial:this.comment.isOfficial,moderation:{is:n.vE.isUserModerator,autoSelect:r,changeable:!this.comment.isEditable&&!s},userName:r?"moderator":n.vE.initParams.userName,hasLinkedUsers:Boolean(n.vE.initParams.linkedUsers),slowModeText:n.vE.initParams.isSlowModeEnabled?n.vE.initParams.slowModeText:null,canUserCommentMessage:n.vE.initParams.canUserComment?null:n.vE.initParams.canUserCommentMessage})),this.feedbackOffer=new h.t({$el:this.$(".comment-reply__feedback-offer"),cssModifiers:["comments"]})}deserialize(t){if(!t)return;const e="source"in t?t.source:t.desc,s=Array.isArray(t.images)?t.images:[];setTimeout((()=>{this.isShown&&(this.editorValue=e)}),100),this.thumbs.clear(),this.thumbs.items.add(s.map((t=>"string"==typeof t?{url:t}:t)))}async uploadImages(){await Promise.allSettled([...this.thumbs.videoDataPromises,this.thumbs.upload()])}serialize(t=!1){const e=t?"save_draft":this.replyMode,s=V({action:e,images:JSON.stringify(this.thumbs.serialize(t)),story_id:this.storyId||0},this.formSerialize);(e===u.tT.CREATE||t)&&(s.parent_id=!this.comment||this.comment.isStoryComment?0:this.comment.id),e===u.tT.EDIT&&(s.id=this.comment.id);const i=this.removeImageLinks(s.desc);return s.desc=this.isEditorEmpty||""===function(t){const e=document.createElement("div");return e.innerHTML=t.replace(/<p>/g,"<p>\n").replace(/<br>/g,"<br> "),e.textContent||""}(i)?"":i,s}onEditorEvent(){n.vE.initParams.experimentRegOnComment||(this.detectMediaUrl(),this.detectModerators(),this.detectOffensive(),this.toggleComstoryHint(),this.checkMentions(),this.saveDraft())}initInputTextCorrector(){this.invalidInputDetector=new B.l({showMessage:t=>{S()(t).insertBefore(this.$controls)},setText:t=>{this.editorValue=t.trim()}}),this.listenTo(this.editor,"paste",(()=>{var t;return null===(t=this.invalidInputDetector)||void 0===t?void 0:t.processText(this.editorTextContent)})),this.listenTo(this.editor,"input",(()=>{var t;return null===(t=this.invalidInputDetector)||void 0===t?void 0:t.processText(this.editorTextContent)}))}async loadDraft(){const e=await this.comment.getDraft();e&&(this.lastDraft=e,this.deserialize(await t.validateDraftImages(e)),this.showSavingDraftMessage(e.date))}async loadSource(){this.editorValue="";const t=await this.comment.getSource();t&&this.deserialize(t)}removeImageLinks(t){return this.thumbs.items.size?this.thumbs.items.items.reduce(((t,e)=>{const s="video"===e.data.type&&e.data.url.length?e.data.url:e.data.source;if("string"!=typeof s)return t;const i=s.replace(/[$()*+.?[\\\]^{|}]/g,"\\$&").replace(/-/g,"\\x2d");return t.replace(new RegExp(i,"g"),"")}),t):t}async onSubmitMenuItemClick(t){if(this.isLoading)return;const e=t.currentTarget.getAttribute("data-action");this.submitMenu.hide(),"comstory"===e&&await l.c.create({id:this.storyId,content:this.removeImageLinks(this.editorValue),images:this._thumbs.items.items.map((t=>t.data.source)),beforeRedirect:async()=>{this.thumbs.clear(),await(0,w.g)(50)}})}hideSpecialUsersHint(){this._options.$specialUsersClose&&(this._options.$specialUsersClose.off("click"),delete this._options.$specialUsersClose),this._options.$specialUsers&&(this._options.$specialUsers.remove(),delete this._options.$specialUsers)}get thumbs(){return this._thumbs||(this._thumbs=new o.c({limit:10,limitImageBytes:n.vE.initParams.maxImageFileSize||12582912,storageId:`comment_${this.comment.id}`}),this.listenTo(this._thumbs,"update",(t=>{const e=t>=this._thumbs.limit;if(!this._thumbs.$parent)return;this._thumbs.$parent.toggleClass("comment-reply__thumbs_show",t>0);const s=this.$(".comment-reply__attach-files");if(s){if(s.toggleClass("comment-reply__attach-files_disabled",e),!e&&this.hintImageLimit)return this.hintImageLimit.destroy(),void delete this.hintImageLimit;e&&!this.hintImageLimit&&(this.hintImageLimit=new r.gR({target:s,destroyAfterHide:!1,content:S()(document.createElement("div")).addClass("popup__hint").append(n.vE.i18n("comments.reply.image-limit",this._thumbs.limit))}))}})),this.listenTo(this.thumbs,"failed-to-add",(t=>{t.map((t=>{switch(t.type){case p.O.COUNT_LIMIT:return n.vE.i18n("image-thumbs.errors.exceed-max-count",t.limits);case p.O.SIZE_LIMIT:return n.vE.i18n("image-thumbs.errors.exceed-size",t.file,Math.floor(t.limits/1048576));case p.O.MIME_LIMIT:return n.vE.i18n("image-thumbs.errors.wrong-mime",t.file,(Array.isArray(t.limits)?t.limits:[]).join(", "));default:n.vE.ui.toasts.showError("image-thumbs.errors.failed-to-add")}return"image-thumbs.errors.failed-to-add"})).forEach((t=>n.vE.ui.toasts.showError(t)))})),this.listenTo(this.thumbs,"update",(()=>this.saveDraft()))),this._thumbs}async updateIsOffensive(t){t!==this.$offensive.is(":visible")&&(await(0,f.W)(),t?this.$offensive.slideDown(300):this.$offensive.slideUp(300))}get $offensive(){return this._options.$offensive||(this._options.$offensive=S()(n.vE.i18n('<div class="comment-reply__offensive">^comments.offensive</div>')).insertBefore(this.$controls)),this._options.$offensive}get $usersHiddenMessage(){if(this._options.$usersHiddenMessage)return this._options.$usersHiddenMessage;const t=this.$(".comment-reply__note");return this._options.$usersHiddenMessage=t&&t.length?t:S()(document.createElement("div"))}get $draftDate(){if(this._options.$draftDate)return this._options.$draftDate;const t=this.$(".comment-reply__draft-date");return this._options.$draftDate=t&&t.length?t:S()('<div class="comment-reply__draft-date" />')}get $controls(){if(this._options.$controls)return this._options.$controls;const t=this.$(".comment-reply__controls");return this._options.$controls=t&&t.length?t:S()('<div class="comment-reply__controls">')}get isOffensive(){return this._isOffensive}set isOffensive(t){this._isOffensive!==t&&(this._isOffensive=t,this.updateIsOffensive(t))}get replyMode(){return this.comment.replyEditor.currentReplyMode||u.tT.NONE}get storyId(){return this.comment.comments.commentsMeta.storyId}get submitMenu(){return this._submitMenu?this._submitMenu:this._submitMenu=new r._({alignment:b.SE.END,destroyAfterHide:!1,showArrow:!1,content:S()(document.createElement("div")).addClass("menu menu_vertical menu_padding_none").on("click",".menu__item",(t=>{this.onSubmitMenuItemClick(t)})).append(S()(this.menuItems.map((t=>{const e=n.vE.i18n(t.text);return`<div class="menu__item" data-action="${t.action}">${e}</div>`})).join("")))})}get comstoryHint(){return this._comstoryHint||(this._comstoryHint=new r._({content:S()(document.createElement("div")).addClass("popup__hint").append(n.vE.i18n("comments.compost-hint")),autoCloseOutsideClick:!1,destroyAfterHide:!1,autoCorrectPosition:!0,wrapperExtraClass:"popup_hint-compost",notUpdatePosition:!0}),this._comstoryHint.addCloseButtonIntoFooter("Понятно"),this.listenTo(this,"add",(()=>this._comstoryHint.hide())),this.listenTo(n.vE,"reply-form-is-fixed",(()=>{var t;if(this.isNeedCompostHintFixed=!0,this.comstoryHint.notUpdatePosition=!0,!this.comstoryHint.el)return;this.comstoryHint.el.classList.add(_.Uk);const e=(null===(t=this.comstoryHint.target.$target.get(0))||void 0===t?void 0:t.getBoundingClientRect().top)-_.E4;this.comstoryHint.el.style.top=e+"px"})),this.listenTo(n.vE,"reply-form-is-not-fixed",(()=>{this.isNeedCompostHintFixed=!1,this.comstoryHint.notUpdatePosition=!1,this.comstoryHint.el&&this.comstoryHint.el.classList.remove(_.Uk)}))),this._comstoryHint}set comstoryHint(t){this._comstoryHint.notUpdatePosition=t}get comstoryHintMeta(){if(this._comstoryHintMeta)return this._comstoryHintMeta;const t=y.m.get(_.VB);return this._comstoryHintMeta={count:"object"==typeof t&&"number"==typeof t.count?t.count:0,lastShown:"object"==typeof t&&"number"==typeof t.lastShown?t.lastShown:0}}set comstoryHintMeta(t){this._comstoryHintMeta=t,y.m.set(_.VB,t)}get hasCommentLimitBeenReached(){return n.vE.initParams.isSlowModeEnabled&&this.comment.comments.availableNumberOfCommentsForToday<=0}get isSavedDraft(){if(n.vE.initParams.experimentRegOnComment)return!0;const t=this.serialize(!0);return Boolean(this.lastDraft&&this.lastDraft.desc===t.desc&&JSON.stringify(this.lastDraft.images)===JSON.stringify(t.images))}get isLoading(){throw new Error("method `isLoading` not implemented")}set isLoading(t){throw new Error("method `isLoading` not implemented")}get formSerialize(){throw new Error("method `formSerialize` not implemented")}get editorTextContent(){throw new Error("method `editorTextContent` not implemented")}get editorValue(){throw new Error("method `editorValue` not implemented")}set editorValue(t){throw new Error("method `editorValue` not implemented")}get isEditorEmpty(){throw new Error("method `isEditorEmpty` not implemented")}get isThumbsEmpty(){return 0===this.thumbs.items.size}get isEmpty(){return this.isEditorEmpty&&this.isThumbsEmpty}},q(M.prototype,"detectOffensive",[$],Object.getOwnPropertyDescriptor(M.prototype,"detectOffensive"),M.prototype),q(M.prototype,"detectMediaUrl",[A],Object.getOwnPropertyDescriptor(M.prototype,"detectMediaUrl"),M.prototype),q(M.prototype,"toggleComstoryHint",[x],Object.getOwnPropertyDescriptor(M.prototype,"toggleComstoryHint"),M.prototype),q(M.prototype,"checkMentions",[D],Object.getOwnPropertyDescriptor(M.prototype,"checkMentions"),M.prototype),q(M.prototype,"saveDraft",[P],Object.getOwnPropertyDescriptor(M.prototype,"saveDraft"),M.prototype),q(M.prototype,"detectModerators",[R],Object.getOwnPropertyDescriptor(M.prototype,"detectModerators"),M.prototype),M)},203:(t,e,s)=>{"use strict";s.r(e),s.d(e,{UIAllComments:()=>b});s(8674),s(6992),s(3948);var i=s(8211),n=s(2134),o=s(8246),r=s(8334),a=s(7041),l=s(8245),h=s(8437),c=s(9755),d=s.n(c),u=s(2859),p=s(2015),m=s(8854),_=s(7111),g=s(6858),v=s(4616),f=s(2300);class y{constructor(t){if(this.replySection=t.replySection,this.commentsSection=t.commentsSection,this.replySectionWidth=this.commentsSection.getBoundingClientRect().width,this.borderUp=t.borderUp,this.borderBottom=t.borderBottom,this.replySectionWrapper=this.replySection.querySelector(".comment-reply__wrapper")||this.replySection,i.vE.isMobileApp){const t=this.replySectionWrapper.querySelector(".input__input");t&&t.addEventListener("blur",(()=>i.vE.emit("keyboard-is-close")))}this.handlePosition()}isNeedToFixedReplySection(){return Boolean(!this.isReplySectionFixed()&&document.querySelector('[data-id="author"]:not(.menu__item_current)')&&this.borderBottom.getBoundingClientRect().bottom>=document.documentElement.clientHeight&&this.borderUp.getBoundingClientRect().bottom<0&&this.commentsSection.getBoundingClientRect().bottom>0)}isReplySectionFixed(){return Array.from(this.replySection.classList).includes(f.Mb)}handlePosition(){this.addObserverToBorderUp(),this.addObserverToBorderBottom()}addObserverToBorderUp(){new IntersectionObserver((t=>{t.forEach((t=>{t.isIntersecting&&this.isReplySectionFixed()&&this.attachReplySectionToUp(),!t.isIntersecting&&this.isNeedToFixedReplySection()&&this.changeReplySectionPositionToFixed("fromUp")}))}),{threshold:0}).observe(this.borderUp)}addObserverToBorderBottom(){new IntersectionObserver((t=>{t.forEach((t=>{t.isIntersecting&&this.isReplySectionFixed()&&this.attachReplySectionToBottom(),!t.isIntersecting&&this.isNeedToFixedReplySection()&&this.changeReplySectionPositionToFixed("fromBottom")}),{threshold:0})})).observe(this.borderBottom)}attachReplySectionToBottom(){this.borderBottom.style.height="0px",this.replySection.classList.remove(f.Mb),this.replySectionWrapper.style.maxHeight="",this.replySection.classList.add("section_margin-bottom"),this.borderBottom.after(this.replySection),i.vE.emit("reply-form-is-not-fixed")}attachReplySectionToUp(){this.borderUp.style.height="0px",this.replySection.classList.remove(f.Mb),this.replySectionWrapper.style.maxHeight="",this.borderUp.before(this.replySection),i.vE.emit("reply-form-is-not-fixed")}changeReplySectionPositionToFixed(t="fromUp"){this.replySection.style.width=`${this.replySectionWidth}px`,this.replySectionWrapper.style.maxHeight=(document.documentElement.clientHeight-f.aB)/2+"px","fromUp"===t?this.borderUp.style.height=`${this.replySection.offsetHeight}px`:"fromBottom"===t&&(this.borderBottom.style.height=`${this.replySection.offsetHeight}px`),this.replySection.classList.remove("section_margin-bottom"),this.replySection.classList.add(f.Mb),i.vE.emit("reply-form-is-fixed")}}class b extends o.t{render(){return this.isRendered||(super.render(),u.X.getInstance().init(this.comments),p.F.getInstance().init(),this.$el&&this.$el.is(":hidden")?this.initWithoutDom():this.initByDom(),this.enableDetectUnload()),this}initByDom(){var t;const e=null===(t=this.$els)||void 0===t?void 0:t.comments;this.$el&&e&&(this.initComments(),this.initMainReply(),this.setMaxCommentIdToStorage())}async initWithoutDom(){var t;if(!this.$el)return;this.$el.show();const e=i.vE.ui.player.createAnimation("comments-spinner",{$parent:d()('<div class="comments__spinner"></div>').appendTo(this.$el.find(".comments"))}),s=Date.now();e.play();const{data:o}=await n.cf.post(r.WB,{action:"get_story_comments",story_id:this.story.id||56});await(0,m.g)(500-(Date.now()-s)),e.stop(),e.$parent.remove(),e.destroy();const a=o.comments,l=null===(t=this.$els)||void 0===t?void 0:t.comments;l&&(a.forEach((t=>l.append(t.html))),this.comments.initCommentByTree(l,o.snapshot),(0,g.U)(),this.initMainReply(),this.setMaxCommentIdToStorage())}getMaxCommentIdFromStorage(){return this.meta.isUserInComments?0:this.getMaxCommentIdStorage().get(this.meta.storyId)||0}getDisableReplyMessage(){if(!i.vE.isUserAuthorized&&!i.vE.initParams.experimentRegOnComment)return'\n\t\t\t\tЧтобы оставить комментарий, \n\t\t\t\tнеобходимо <a href="#signup" class="to-signup">зарегистрироваться</a> \n\t\t\t\tили <a href="#signin" class="to-signin">войти</a>\n\t\t\t';if(i.vE.isUserBanned||i.vE.isFullyBanned)return i.vE.i18n("comments.reply.banned");if(i.vE.userRating<r.r7)return i.vE.i18n("comments.reply.rating");if(this.meta.ignoreType===a.IV.COMMUNITY_IGNORES_YOU&&!i.vE.isUserModerator){let t=d()('.community-info-block[data-type="about"] .community__title > a').text();return t=t&&t.length?` «${t}»`:t,i.vE.i18n("comments.ignore."+(0,v.S)(a.IV,this.meta.ignoreType),t)}}initMainReply(){let t=this.$('section[data-role="answer"]');if(i.vE.initParams.experimentCommentsOnTop&&(t=d()('section[data-role="answer"]')),!t||!t.length)return this;const e=this.getDisableReplyMessage();if(e)return t.addClass("section_gray").html(e).show(),this;const s=this.comments.get(r.iM);if(!s)return this;const n=l.S.getInstance().get("UICommentReply");if(!n||"function"!=typeof n)throw new Error("not found UICommentReply in UIComponentsRegistry");const o=new n(s);if(!(o instanceof h.c))throw new Error("UICommentReply bad type");if(this.listenToOnce(o,"add",(()=>{var t;this.el&&(null===(t=this.el.parentElement)||void 0===t||t.classList.remove("story-comments_empty"))})),o.isComstoryHintEnabled=t.data("show-hint"),o.$parent=t,o.show(),o.$el&&o.$el.addClass("comment-reply_no-border"),t.addClass("section_padding_none").show(),s.replyEditor.reply=o,i.vE.initParams.experimentCommentsOnTop){var a;if(null===(a=this.el)||void 0===a||!a.parentElement)return this;const e={replySection:t.get(0),commentsSection:this.el.parentElement,borderUp:document.querySelector(".story-comments__up"),borderBottom:document.querySelector(".story-comments__bottom")};new y(e)}return this}enableDetectUnload(){this.listenTo(i.vE.ui,"beforeunload",(t=>{this.setMaxCommentIdToStorage();const e=this.comments.items.find((t=>!t.isRoot&&t.replyEditor.isReplyShown&&t.replyEditor.currentReplyMode===a.tT.CREATE&&!t.replyEditor.reply.isSavedDraft&&!t.replyEditor.reply.isEmpty));if(!e)return;this.timeout("close-timeout",500,(()=>{const t=e.replyEditor.reply.$el;var s;(e.highlight("yellow",!0),t&&!i.vE.ui.elementInViewport(t))&&i.vE.ui.scrollTo(((null===(s=t.offset())||void 0===s?void 0:s.top)||0)-50,!0)}));const s=i.vE.i18n("comments.before-exit");return t.returnValue=s,s})),this.listenTo(i.vE.ui,"unload",(()=>{this.cancelTimeout("close-timeout")}))}getMaxCommentIdStorage(){const t=_.m.get(r.Ck);return new Map(Array.isArray(t)?t.filter((t=>Array.isArray(t)&&2===t.length)):[])}setMaxCommentIdToStorage(){if(this.meta.isUserInComments)return;const t=this.meta.storyId,e=_.m.get(r.Ck),s=new Map(Array.isArray(e)?e.filter((t=>Array.isArray(t)&&2===t.length)):[]);s.delete(t),s.set(t,Math.max(...this.comments.items.map((t=>t.id)))),s.size>r.Wk&&s.delete(s.keys().next().value),_.m.set(r.Ck,Array.from(s.entries()))}}},5388:(t,e,s)=>{"use strict";s.d(e,{C:()=>b});s(5827),s(8674);var i,n,o,r=s(2134),a=s(8211),l=s(8246),h=s(2977),c=s(3399),d=s(1973),u=s(7041),p=s(8854),m=s(9755),_=s.n(m),g=s(6858),v=s(2859),f=s(9684);function y(t,e,s,i,n){var o={};return Object.keys(i).forEach((function(t){o[t]=i[t]})),o.enumerable=!!o.enumerable,o.configurable=!!o.configurable,("value"in o||o.initializer)&&(o.writable=!0),o=s.slice().reverse().reduce((function(s,i){return i(t,e,s)||s}),o),n&&void 0!==o.initializer&&(o.value=o.initializer?o.initializer.call(n):void 0,o.initializer=void 0),void 0===o.initializer&&(Object.defineProperty(t,e,o),o=null),o}let b=(i=(0,h.p)("click",".comments__show-parent"),n=(0,h.p)("click",".comment-toggle-children_not-loaded"),y((o=class extends l.t{onShowParent(t,e){const s=t.children.items[0];s&&s instanceof c.U&&s.el&&(s.children.isChildrenShown=!0,s.el.classList.toggle("comment_hidden-body"),s.el.classList.toggle("comment_show"),e.currentTarget.classList.toggle("collapse-button_active"))}async onShowChildren(t){const e=t.children.$toggleChildren;if(!t.hasChildren||null==e||!e.classList.contains("comment-toggle-children_not-loaded"))return;e.classList.remove("comment-toggle-children_not-loaded"),e.classList.add("comment-toggle-children_loading");const s=_()(`<div class="comment__placeholder" style="display: block">\n\t\t\t${(0,f.Z)()}\n\t\t</div>`);t.children.$childrenContainer.insertAdjacentElement("afterbegin",s.get(0));const i=Date.now(),{response:n,data:o}=await r.cf.post("/ajax/comments_actions.php",{action:"get_comments_subtree",id:t.id});if(await(0,p.g)(500-(Date.now()-i)),s.remove(),e.classList.remove("comment-toggle-children_loading"),!n.result||!t.children.$childrenContainer)return a.vE.logger.error("comments","problem with `get_comments_subtree`"),void t.children.$childrenContainer.insertAdjacentHTML("afterbegin","Не удалось загрузить комментарии :(");if(t.children.$childrenContainer.insertAdjacentHTML("afterbegin",o.html),this.comments.add(d.g.createCommentsListByDom(t)),(0,g.U)(),this.mode===u.lL.INCOMING){var l;const t=o.fresh_comments_count||0,e=_()('.bell[data-role="answers"]'),s=Math.min(Math.max(0,null!==(l=Number(e.text()))&&void 0!==l?l:0)-t,99);e.text(s).toggle(s>0)}}toggleChildren(t){super.toggleChildren(t),this.onShowChildren(t)}render(){return this.isRendered||(super.render(),a.vE.on("comment_edit",this.delegateEditComment.bind(this)),v.X.getInstance().init(this.comments)),this}delegateEditComment({id:t,content:e}){if(this.$el&&this.$el.hasClass("comments_show"))return;const s=this.comments.get(t);if(!s||!s.isAuthorCurrentUser)return;const i=_()(e).find(".comment__content").html();i&&(s.$content.innerHTML=i)}}).prototype,"onShowParent",[i],Object.getOwnPropertyDescriptor(o.prototype,"onShowParent"),o.prototype),y(o.prototype,"onShowChildren",[n],Object.getOwnPropertyDescriptor(o.prototype,"onShowChildren"),o.prototype),o)},3016:(t,e,s)=>{"use strict";s.d(e,{z:()=>d});s(8674),s(6992),s(3948);var i=s(8211),n=s(2134),o=s(4877),r=s(9755),a=s.n(r),l=s(5388),h=s(6858),c=s(8650);class d extends o.u{static async markAllAsRead(){const{response:t}=await n.cf.post("/ajax/comments_actions.php",{action:"mark_readed_all"});return t.result||i.vE.ui.toasts.showError(t.message||"Извините, произошла ошибка"),t.result}static async markAsRead(t){const{response:e}=await n.cf.post("/ajax/comments_actions.php",{action:"mark_readed",ids:t});return e.result||i.vE.ui.toasts.showError(e.message||"Извините, произошла ошибка"),e.result}render(){return this.isRendered||super.render(),this}initComments(){return this.$el?([...this.$el.find(".comments")].forEach((t=>{new l.C({story:this._options.story,$el:a()(t),mode:this._options.mode}).initComments()})),(0,h.U)(),this):this}addComments(){if(!this.$el)return[];const t=[...this.$el.find(".comments")].map((t=>{if((0,c.Y)(t)instanceof l.C)return;const e=new l.C({story:this._options.story,$el:a()(t),mode:this._options.mode});return e.initComments(),e}));return(0,h.U)(),t.filter(Boolean)}}},8246:(t,e,s)=>{"use strict";s.d(e,{t:()=>K});s(6992),s(3948),s(8674),s(5827);var i=s(8211),n=s(8799),o=s(4051),r=s(7025),a=s(1973),l=s(4612),h=s(7041),c=s(4616),d=s(4877),u=s(9755),p=s.n(u),m=s(2977),_=s(2822),g=s(2859),v=s(9289),f=s(6858),y=s(9050);function b(t){var e,s="",i=y.escape;Array.prototype.join;return s+='<div class="popup-menu">\n    <div class="popup-menu__step">\n        <div class="popup-menu__item" data-role="share">\n            <div class="popup-menu__label">Поделиться</div>\n        </div>\n        <div class="popup-menu__item" data-role="link">\n            <div class="popup-menu__label">Скопировать ссылку</div>\n        </div>\n        ',t.isLinkTo&&(s+='\n        <a class="popup-menu__item" data-role="link-to" href="'+i(t.url)+'">\n            <div class="popup-menu__label">Перейти к комментарию</div>\n        </a>\n        '),s+="\n        ",t.isComstory||(s+='\n        <div class="popup-menu__item" data-role="save">\n            <div class="popup-menu__label">'+(null==(e=t.isSaved?"Убрать из сохранённого":"Сохранить")?"":e)+"</div>\n        </div>\n        "),s+="\n        ",t.hasChildren&&(s+='\n            <div class="popup-menu__item" data-role="toggle-branch">\n                <div class="popup-menu__label">'+(null==(e=t.isChildrenShown?"Свернуть":"Показать")?"":e)+" ветку</div>\n            </div>\n        "),s+='\n        <div class="popup-menu__item" data-role="complain">\n            <div class="popup-menu__label">Пожаловаться</div>\n        </div>\n    </div>\n    <div class="popup-menu__step" style="display: none">\n        <a class="popup-menu__item" data-role="twitter" href="https://twitter.com/share?url='+i(t.url+encodeURIComponent("&utm_source=twshare&utm_medium=sharing"))+'" target="_blank" rel="nofollow noopener">\n            <div class="popup-menu__label">Twitter</div>\n        </a>\n        <a class="popup-menu__item" data-role="ok" href="https://connect.ok.ru/offer?url='+i(t.url+encodeURIComponent("&utm_source=okshare&utm_medium=sharing"))+'" target="_blank" rel="nofollow noopener">\n            <div class="popup-menu__label">OK</div>\n        </a>\n        <a class="popup-menu__item" data-role="facebook" href="https://www.facebook.com/sharer.php?u='+i(t.url+encodeURIComponent("&utm_source=fshare&utm_medium=sharing"))+'" target="_blank" rel="nofollow noopener">\n            <div class="popup-menu__label">Facebook</div>\n        </a>\n        <a class="popup-menu__item" data-role="vk" href="https://vk.com/share.php?url='+i(t.url+encodeURIComponent("&utm_source=vshare&utm_medium=sharing"))+'" target="_blank" rel="nofollow noopener">\n            <div class="popup-menu__label">ВКонтакте</div>\n        </a>\n    </div>\n</div>'}var w=s(9050);function E(t){var e="",s=w.escape;Array.prototype.join;return e+='<div class="popup-menu">\n    ',t.pdsLink&&(e+='\n        <a class="popup-menu__item" href="'+s(t.pdsLink)+'" target="_blank">\n            <div class="popup-menu__icon"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon--ui__settings icon--ui__settings_comment-moderator"><use xlink:href="#icon--ui__settings"></use></svg></div>\n            <div class="popup-menu__label">PDS</div>\n        </a>\n    '),e+="\n\n    ",t.canBanByCommunity&&(e+='\n        <div class="popup-menu__item" data-role="ban-community">\n            <div class="popup-menu__icon"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon--ui__ban icon--ui__ban_comments"><use xlink:href="#icon--ui__ban"></use></svg></div>\n            <div class="popup-menu__label">Внести в игнор-лист сообщества</div>\n        </div>\n    '),e+="\n\n    ",t.canBanByModerator&&(e+='\n        <div class="popup-menu__item" data-role="ban-moderator">\n            <div class="popup-menu__icon"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon--ui__ban icon--ui__ban_comments"><use xlink:href="#icon--ui__ban"></use></svg></div>\n            <div class="popup-menu__label">Заблокировать пользователя</div>\n        </div>\n    '),e+="\n\n    ",t.canDeletedByModerator&&(e+='\n        <div class="popup-menu__item" data-role="remove-moderator">\n            <div class="popup-menu__icon"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon--ui__remove icon--ui__remove_comments"><use xlink:href="#icon--ui__remove"></use></svg></div>\n            <div class="popup-menu__label">Удалить комментарий</div>\n        </div>\n    '),e+="\n\n    ",t.canRestoreByModerator&&(e+='\n        <div class="popup-menu__item" data-role="restore-moderator">\n            <div class="popup-menu__icon"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon--ui__undo icon--ui__undo_comments"><use xlink:href="#icon--ui__undo"></use></svg></div>\n            <div class="popup-menu__label">Восстановить</div>\n        </div>\n    '),e+="\n\n    ",t.editionHistoryLink&&(e+='\n        <a class="popup-menu__item" href="'+s(t.editionHistoryLink)+'" target="_blank">\n            <div class="popup-menu__icon"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon--ui__book icon--ui__book_comments"><use xlink:href="#icon--ui__book"></use></svg></div>\n            <div class="popup-menu__label">Журнал изменений</div>\n        </a>\n    '),e+="\n    ",t.canHide&&(e+='\n        <div class="popup-menu__item" data-role="branch-hide">\n            <div class="popup-menu__icon"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon--ui__eye icon--ui__eye_comments"><use xlink:href="#icon--ui__eye"></use></svg></div>\n            <div class="popup-menu__label">Скрыть ветку</div>\n        </div>\n    '),e+="\n    ",t.canReveal&&(e+='\n        <div class="popup-menu__item" data-role="branch-show">\n            <div class="popup-menu__icon"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon--ui__eye-close icon--ui__eye-close_comments"><use xlink:href="#icon--ui__eye-close"></use></svg></div>\n            <div class="popup-menu__label">Показать ветку</div>\n        </div>\n    '),e+="\n</div>"}var S,C,T,O,k,I,$,A,x,D,P,R,M,N,B,L,F,U,j,V,H,q=s(8245),W=s(9895);function G(t,e){var s=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),s.push.apply(s,i)}return s}function Y(t,e,s){return e in t?Object.defineProperty(t,e,{value:s,enumerable:!0,configurable:!0,writable:!0}):t[e]=s,t}function z(t,e,s,i,n){var o={};return Object.keys(i).forEach((function(t){o[t]=i[t]})),o.enumerable=!!o.enumerable,o.configurable=!!o.configurable,("value"in o||o.initializer)&&(o.writable=!0),o=s.slice().reverse().reduce((function(s,i){return i(t,e,s)||s}),o),n&&void 0!==o.initializer&&(o.value=o.initializer?o.initializer.call(n):void 0,o.initializer=void 0),void 0===o.initializer&&(Object.defineProperty(t,e,o),o=null),o}const Z=".comment__collapsing-area";let K=(S=(0,m.p)("click",".comment-hidden-group__toggle"),C=(0,m.p)("click",".comment-toggle-children"),T=(0,m.p)("click",".comment__more"),O=(0,m.p)("click",".comment__close-branch"),k=(0,m.p)("click",".comment__rating-up,.comment__rating-down"),I=(0,m.p)("click",'.comment__tool[data-role="save"]'),$=(0,m.p)("click",'.comment__tool[data-role="complain"]'),A=(0,m.p)("click",'.comment__control[data-type="remove"]'),x=(0,m.p)("click",".comment__restore"),D=(0,m.p)("click",'.comment__control[data-type="create"],.comment__control[data-type="edit"]'),P=(0,m.p)("click",'.comment__control[data-type="cancel"]'),R=(0,m.p)("click",'.comment__tool[data-role="link"]'),M=(0,m.p)("click",Z),N=(0,m.p)("click",'.comment__tool[data-role="branch"]'),B=(0,m.p)("click",'.comment__tool[data-role="to-parent"]'),L=(0,m.p)("click",'.comment__tool[data-role="from-parent"]'),F=(0,m.p)("click",".comment__user"),U=(0,m.p)("click",".comment__moderator-menu"),j=(0,m.p)("click",".comment__right"),V=(0,m.p)("click",".comment__body"),H=class t extends d.u{constructor(t){super(t),Y(this,"isScrolling",!1),this.comments=new a.g(this),this.extension=this.getUICommentsExtensionClass(),this.render()}getUICommentsExtensionClass(){const t=q.S.getInstance();if(t.has("UICommentsExtension")){return new(t.get("UICommentsExtension"))(this)}}static toFakeComment(t){i.vE.ui.toasts.add("slice-mode",{content:'Родительский комментарий находится на другой стороне луны, <a href="'+i.vE.history.location.pathname+(t?"?cid="+t:"#comments")+'">вылететь за ним</a>'})}onHiddenGroupToggleClick(t,e){const s=e.currentTarget.closest(".comment-hidden-group");for(const i of t.children.items)if(i instanceof l.H&&i.el===s){const t=!i.children.isChildrenShown;if(i.children.isChildrenShown=t,!t)return;return void this.comments.loadNextPartChildrenComments(i,!1)}}onToggleChildrenClick(t){const e=!t.children.isChildrenShown;if(t.children.isChildrenShown=e,!e)return;this.comments.loadNextPartChildrenComments(t,!t.children.isOnlyHiddenGroupChildren&&t.isChildCommentsInitialized,!0);const s=t.voter.amountVotesHidden||t.voter.amountVotes;_.c.getInstance().sendEvent("click_show_comments_thread",{post_id:this.comments.commentsMeta.storyId,author_id:this.comments.commentsMeta.storyAuthorId,comment_id:t.id,comment_author_id:t.authorId,level:t.depth+1,"pluses!undefined":s&&s[0],"minuses!undefined":s&&s[1]})}onMoreButtonClick(t){this.comments.loadNextPartChildrenComments(t);const e=this.story.subsCode;_.c.getInstance().sendEvent("click_show_comments",function(t){for(var e=1;e<arguments.length;e++){var s=null!=arguments[e]?arguments[e]:{};e%2?G(Object(s),!0).forEach((function(e){Y(t,e,s[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(s)):G(Object(s)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(s,e))}))}return t}({post_id:this.meta.storyId,author_id:this.meta.storyAuthorId},e&&{type_i8:Number(e)}))}onCloseBranchClick(t){t.children.isChildrenShown=!1,t.scrollTo(!0)}onRatingToggleClick(t,e){const s=e.currentTarget.classList.contains("comment__rating-up")?h.OC.UP:h.OC.DOWN;this.vote(t,s)}vote(t,e){if(i.vE.isUserAuthorized)i.vE.isLostAccount?i.vE.ui.toasts.showWarningMessage(i.ZF.LOST_ACCOUNT):t.voter.setVoteDirection(e);else{i.vE.ui.authRequired();const s=t.voter.amountVotesHidden||t.voter.amountVotes;_.c.getInstance().sendEvent("click",{type:"comment_rate",post_id:this.meta.storyId,author_id:this.meta.storyAuthorId,user_rate:e,comment_id:t.id,comment_author_id:t.authorId,"pluses!undefined":s&&s[0],"minuses!undefined":s&&s[1]})}}onSaveClick(t){var e;if(i.vE.isComstory)return;if(!i.vE.isUserAuthorized)return void i.vE.ui.authRequired();const s=!t.saver.isSaved;t.saver.isSaved=s,null===(e=t.saver.$toolSave)||void 0===e||e.classList.toggle("comment__tool_active",s)}onComplainClick(t){if(!i.vE.isUserAuthorized)return void i.vE.ui.authRequired();const e=t.isComstory?"post":"comment";new o.n({destroyAfterHide:!0,targetId:t.id,authorId:t.authorId,targetType:e,name:"UIComplainModalPopup",closeHintShown:!0}).show()}onRemoveClick(t){t.isEditable&&t.removeByCurrentUser()}onRestoreClick(t,e){e.preventDefault(),t.restoreByCurrentUser()}onCreateOrEditClick(t,e){if(!(0,v.s)(t,!0)){const e=t.voter.amountVotesHidden||t.voter.amountVotes;return void _.c.getInstance().sendEvent("click",{post_id:this.comments.commentsMeta.storyId,author_id:this.comments.commentsMeta.storyAuthorId,type:"comment_reply",comment_id:t.id,comment_author_id:t.authorId,"pluses!undefined":e&&e[0],"minuses!undefined":e&&e[1]})}for(const n of this.comments)!n.isRoot&&n.replyEditor.isReplyShown&&(n.replyEditor.isReplyShown=!1),n.isRoot&&i.vE.initParams.experimentCommentsOnTop&&(n.replyEditor.isReplyShown=!1,this.listenTo(i.vE,"close-not-root-comment-reply",(()=>n.replyEditor.isReplyShown=!0)));const s=e.currentTarget.getAttribute("data-type");t.replyEditor.currentReplyMode="create"===s?h.tT.CREATE:h.tT.EDIT,t.replyEditor.isReplyShown=!0}onCancelClick(t){if(t.replyEditor.isReplyShown=!1,i.vE.initParams.experimentCommentsOnTop)for(const e of this.comments)e.isRoot&&(e.replyEditor.isReplyShown=!0)}async onClickLink(t,e){if(this.comments.ui.mode!==h.lL.MAIN&&this.comments.ui.mode!==h.lL.STORY_AUTHOR||e.ctrlKey||e.metaKey)return;e.preventDefault(),t.isComstory||this.comments.ui.mode!==h.lL.MAIN||i.vE.history.replaceState({},"",t.url),i.vE.ui.elementInViewport(t.el)||await t.scrollTo(),this.animationFrame("link-highlight",(()=>t.highlight("green",!0))),"clipboard"in navigator&&await navigator.clipboard.writeText(t.url);const s=p()(e.target).data("hint");s&&(s.content.find(".popup__hint").html("Скопирована!"),s.isShown||s.show(),s.updatePosition(),s.destroyAfterHide=!0);const n=t.voter.amountVotesHidden||t.voter.amountVotes;_.c.getInstance().sendEvent("share_to_social_network",{type:"link_comment",social_network:"link_comment",comment_id:t.id,"pluses!undefined":null==n?void 0:n[0],"minuses!undefined":null==n?void 0:n[1],comment_author_id:t.authorId,post_id:this.comments.commentsMeta.storyId,author_id:this.comments.commentsMeta.storyAuthorId})}async onCollapsingAreaClick(e,s){s.preventDefault(),s.stopPropagation(),e.isFake?t.toFakeComment():(i.vE.ui.elementInViewport(e.$body)||await e.scrollTo(!0),e.children.isChildrenShown=!1,e.highlight("green",!0,!0))}onBranchClick(t){this.currentBranchId=this.currentBranchId===t.id?void 0:t.id}onToParentClick(t){this.currentToParentId=this.currentToParentId===t.id?void 0:t.id}onFromParentClick(){this.currentToParentId=void 0}onUserClick(t){const e=this.story;if(!e||e.authorId!==t.authorId)return;const s=void 0!==e.adId&&e.adId,i=e.contentTypes,n=t.voter.amountVotesHidden||t.voter.amountVotes;_.c.getInstance().sendEvent("transition_to_author",{post_id:this.comments.commentsMeta.storyId,author_id:this.comments.commentsMeta.storyAuthorId,comment_id:t.id,comment_author_id:t.authorId,type:"from_comment","content_type!empty":i,"promo_id!empty":s,"pluses!undefined":n&&n[0],"minuses!undefined":n&&n[1],"type_i8!empty":e.subsCode})}onModeratorMenuClick(t,e){const s=e.currentTarget.dataset,i=new r.LD({content:p()(E({editionHistoryLink:s.ehl,pdsLink:s.pl,canBanByCommunity:"true"===s.bc,canBanByModerator:"true"===s.bm,canDeletedByModerator:"true"===s.dm,canRestoreByModerator:"true"===s.rm,canHide:s.ch,canReveal:s.cr}))});this.listenTo(i,"uiMounted",(()=>i.$el.addClass("popup_modal-menu")));const n=()=>i.hide();i.addButtonIntoFooter("закрыть",n),i.content.on("click",'.popup-menu__item[data-role="ban-community"]',(()=>g.X.getInstance().onBan(t))),i.content.on("click",'.popup-menu__item[data-role="ban-moderator"]',(()=>g.X.getInstance().onBan(t))),i.content.on("click",'.popup-menu__item[data-role="remove-moderator"]',(async()=>{await g.X.getInstance().onRemove(t)&&(delete s.dm,s.rm=!0)})),i.content.on("click",'.popup-menu__item[data-role="restore-moderator"]',(async()=>{await g.X.getInstance().onRestore(t)&&(delete s.rm,s.dm=!0)})),i.content.on("click",'.popup-menu__item[data-role="branch-hide"]',(async()=>{await g.X.getInstance().onBranchHide(t)&&(delete s.ch,s.cr=!0)})),i.content.on("click",'.popup-menu__item[data-role="branch-show"]',(async()=>{await g.X.getInstance().onBranchShow(t)&&(delete s.cr,s.ch=!0)})),i.content.on("click",".popup-menu__item",n),i.show()}onExtraButtonClick(t){const e=new r.LD({content:p()(b({url:t.url,isSaved:t.saver.isSaved,isComstory:t.isComstory,isLinkTo:this.mode!==h.lL.MAIN,hasChildren:t.hasChildren,isChildrenShown:t.children.isChildrenShown}))}),s=e=>{const s=t.voter.amountVotesHidden||t.voter.amountVotes;_.c.getInstance().sendEvent("share_to_social_network",{"type!undefined":e,"social_network!undefined":e,comment_id:t.id,"pluses!undefined":null==s?void 0:s[0],"minuses!undefined":null==s?void 0:s[1],comment_author_id:t.authorId,post_id:this.comments.commentsMeta.storyId,author_id:this.comments.commentsMeta.storyAuthorId})};this.listenTo(e,"uiMounted",(()=>e.$el.addClass("popup_modal-menu")));const n=()=>{e.hide()};e.addButtonIntoFooter("закрыть",n),e.content.on("click",'.popup-menu__item[data-role="share"]',(n=>{if("undefined"==typeof navigator||void 0===navigator.share)return n.stopImmediatePropagation(),void e.content.find(".popup-menu__step").slideToggle(300);navigator.share({title:document.title,url:t.url+"&utm_source=linkshare&utm_medium=sharing&utm_campaign=mobile_native_share"}).then((()=>s())).catch((t=>i.vE.logger.log("sharing",t)))})),e.content.on("click",'.popup-menu__item[data-role="toggle-branch"]',(()=>this.toggleChildren(t))),e.content.on("click",'.popup-menu__item[data-role="link"]',(()=>{"clipboard"in navigator&&navigator.clipboard.writeText(t.url),i.vE.ui.toasts.add("copy-link",{content:"Ссылка скопирована!"}),s("link_comment")})),e.content.on("click",'.popup-menu__item[data-role="save"]',(()=>this.onSaveClick(t))),e.content.on("click",".popup-menu__item",n),e.content.on("click",'.popup-menu__item[data-role="complain"]',(()=>this.onComplainClick(t))),e.show()}onCommentActions(t){t.isNewest=!1}getCommentIdByElement(t){if(!n.Zv.isHTMLElement(t))throw new Error("expected HTMLElement");const e=t.closest(".comment");return e instanceof HTMLElement&&Number(e.dataset.id)||0}getCommentByElement(t){const e=this.getCommentIdByElement(t);if(this.comments.has(e))return this.comments.get(e)}render(){var t;return this.isRendered||(this.$els={comments:this.$(".comments__container"),tree:this.$('script[data-entry="comments-tree"]')},this.attachTools(),super.render(),null===(t=this.extension)||void 0===t||t.render(),this.initAnalytics()),this}async scrollTo(t,e=!1){this.isScrolling=!0,await i.vE.ui.scrollTo(t,e),this.isScrolling=!1}initComments(){this.$els&&this.$els.comments&&(this.comments.initComments(this.$els.comments,this.$els.tree),(0,f.U)())}initAnalytics(){var t;const e=document.querySelector(".story-comments");if(!(null!==(t=this.story)&&void 0!==t&&t.commentsCount&&e instanceof HTMLElement))return;const s=W.Z.getInstance();s.addItems({comments:[e]}),"comments"===s.focusedElement&&this._startCollectAnalytics(),s.on("focused-element-change",(t=>{"comments"===t?this._startCollectAnalytics():this._stopCollectAnalytics()}))}_startCollectAnalytics(){this.timeout("send_comments_analytics",2e3,(()=>this._sendViewAnalytics()))}_stopCollectAnalytics(){this.cancelTimeout("send_comments_analytics"),this._sendViewAnalytics(!0)}_sendViewAnalytics(t=!1){t||this._startCollectAnalytics(),this.comments.sendViewAnalytics()}getMaxCommentIdFromStorage(){return 0}get meta(){if(this._meta)return this._meta;const t=this.$el&&this.$el.hasClass("comments")?this.$el:this.$(".comments");if(!t||!t.length)throw new Error("not found .comments");const e=t.get(0).dataset;return this._meta={storyId:Number(e.storyId),storyAuthorId:Number(e.storyAuthorId),storyAuthorUserName:e.storyUsername||"",storyUrl:e.storyUrl||"",ignoreType:(0,c.i)(h.IV,Number(e.ignoreType))||h.IV.NONE,isUserInComments:"true"===e.userInComments,sliceMode:Boolean(e.sliceMode),orderMode:(0,c.i)(h.hL,Number(e.orderMode))||h.hL.RELEVANCE,hasClientMentions:"true"===e.hasClientMentions}}attachTools(){var t,e;this.$el&&(null===(t=this.__meta)||void 0===t||null===(e=t.listDelegatedEvents)||void 0===e||e.forEach((({events:t,selector:e,handler:s})=>{this.$el&&this.$el.on(t,e,(t=>{const e=this.getCommentByElement(t.target);e&&s.call(this,e,t)}))})),this.$el.on("mouseenter",Z,(t=>{var e;const s=this.getCommentByElement(t.target);s&&(null===(e=s.el)||void 0===e||e.classList.add("comment_collapsing-area"))})),this.$el.on("mouseleave",Z,(t=>{var e;const s=this.getCommentByElement(t.target);s&&(null===(e=s.el)||void 0===e||e.classList.remove("comment_collapsing-area"))})))}toggleChildren(t){this.onToggleChildrenClick(t)}get story(){return this._options.story}get currentBranchId(){return this._options.currentBranchId}set currentBranchId(e){var s,n,o;const r=this._options.currentBranchId,a=void 0!==e&&e!==r;if(!e&&!r)return;const l=this.comments.get(e||r||0);if(!l||l.isRoot)return;if(l.parentComment&&null!==(s=l.parentComment)&&void 0!==s&&s.isFake)return void t.toFakeComment(l.parentComment.id);if(a&&r&&e!==r){const t=this.comments.get(r);var h;if(t)null===(h=t.branchTools.$toolBranch)||void 0===h||h.classList.remove("comment__tool_active"),t.highlight("green",!1,!1)}const c="comment_hidden",d="comment-hidden-group__toggle_hidden";let u="."+(a?"comment":c);const p=(null===(n=l.el)||void 0===n?void 0:n.getBoundingClientRect().top)||0;a&&(u+=l.branchTools.branchIds.reduce(((t,e)=>t+':not([data-id="'+e+'"])'),"")),this.el&&(this.el.querySelectorAll(u).forEach((t=>t.classList.toggle(c,a))),this.el.querySelectorAll(`.${a?"comment-hidden-group__toggle":d}`).forEach((t=>t.classList.toggle(d,a)))),this.animationFrame("scrollTo",(()=>{var t;a&&(i.vE.ui.sidebar._lastScrollTop=0),i.vE.ui.scrollTo(i.vE.ui.scrollTop+(null===(t=l.el)||void 0===t?void 0:t.getBoundingClientRect().top)-p)})),null===(o=l.branchTools.$toolBranch)||void 0===o||o.classList.toggle("comment__tool_active",a),l.highlight("green",!1,a),this._options.currentBranchId=e}get currentToParentId(){return this._options.currentToParentId}set currentToParentId(e){const s=this._options.currentToParentId,i=void 0!==e&&e!==s;if(s&&s!==e){const t=this.comments.get(s);t&&t.branchTools.toggleToolParent(!1,!1)}this._options.currentToParentId=e;const n=this.comments.get(e||s||0);n&&!n.isRoot&&(n.isFake?t.toFakeComment(n.parent.id):n.branchTools.toggleToolParent(i))}get mode(){return this._options.mode||h.lL.MAIN}},z(H.prototype,"onHiddenGroupToggleClick",[S],Object.getOwnPropertyDescriptor(H.prototype,"onHiddenGroupToggleClick"),H.prototype),z(H.prototype,"onToggleChildrenClick",[C],Object.getOwnPropertyDescriptor(H.prototype,"onToggleChildrenClick"),H.prototype),z(H.prototype,"onMoreButtonClick",[T],Object.getOwnPropertyDescriptor(H.prototype,"onMoreButtonClick"),H.prototype),z(H.prototype,"onCloseBranchClick",[O],Object.getOwnPropertyDescriptor(H.prototype,"onCloseBranchClick"),H.prototype),z(H.prototype,"onRatingToggleClick",[k],Object.getOwnPropertyDescriptor(H.prototype,"onRatingToggleClick"),H.prototype),z(H.prototype,"onSaveClick",[I],Object.getOwnPropertyDescriptor(H.prototype,"onSaveClick"),H.prototype),z(H.prototype,"onComplainClick",[$],Object.getOwnPropertyDescriptor(H.prototype,"onComplainClick"),H.prototype),z(H.prototype,"onRemoveClick",[A],Object.getOwnPropertyDescriptor(H.prototype,"onRemoveClick"),H.prototype),z(H.prototype,"onRestoreClick",[x],Object.getOwnPropertyDescriptor(H.prototype,"onRestoreClick"),H.prototype),z(H.prototype,"onCreateOrEditClick",[D],Object.getOwnPropertyDescriptor(H.prototype,"onCreateOrEditClick"),H.prototype),z(H.prototype,"onCancelClick",[P],Object.getOwnPropertyDescriptor(H.prototype,"onCancelClick"),H.prototype),z(H.prototype,"onClickLink",[R],Object.getOwnPropertyDescriptor(H.prototype,"onClickLink"),H.prototype),z(H.prototype,"onCollapsingAreaClick",[M],Object.getOwnPropertyDescriptor(H.prototype,"onCollapsingAreaClick"),H.prototype),z(H.prototype,"onBranchClick",[N],Object.getOwnPropertyDescriptor(H.prototype,"onBranchClick"),H.prototype),z(H.prototype,"onToParentClick",[B],Object.getOwnPropertyDescriptor(H.prototype,"onToParentClick"),H.prototype),z(H.prototype,"onFromParentClick",[L],Object.getOwnPropertyDescriptor(H.prototype,"onFromParentClick"),H.prototype),z(H.prototype,"onUserClick",[F],Object.getOwnPropertyDescriptor(H.prototype,"onUserClick"),H.prototype),z(H.prototype,"onModeratorMenuClick",[U],Object.getOwnPropertyDescriptor(H.prototype,"onModeratorMenuClick"),H.prototype),z(H.prototype,"onExtraButtonClick",[j],Object.getOwnPropertyDescriptor(H.prototype,"onExtraButtonClick"),H.prototype),z(H.prototype,"onCommentActions",[V],Object.getOwnPropertyDescriptor(H.prototype,"onCommentActions"),H.prototype),H)},2925:(t,e,s)=>{"use strict";s.d(e,{tz:()=>a,hb:()=>b,m4:()=>c,IV:()=>r,iM:()=>m,BE:()=>u,KF:()=>v,Iz:()=>d,aH:()=>g,Y2:()=>f,r7:()=>p,ly:()=>_,OC:()=>l,Cj:()=>D,K5:()=>it,HW:()=>q,OW:()=>C});s(6992),s(3948),s(8674),s(4916),s(1817);var i=s(8211),n=s(4519),o=s(7892);const r=new o.xs({NONE:0,YOU_IGNORES_AUTHOR_OF_STORY:1,AUTHOR_OF_STORY_IGNORES_YOU:2,YOU_IGNORES_AUTHOR_OF_COMMENT:3,AUTHOR_OF_COMMENT_IGNORES_YOU:4,COMMUNITY_IGNORES_YOU:5}),a=new o.xs({STORY:0,INCOMING:1,OUTCOMING:2,MODERATOR:3,SINGLE:4,AUTHORS:5}),l=new o.xs({UP:1,NONE:0,DOWN:-1}),h=new o.xs({RELEVANCE:3,RATING:1,TIME:2}),c=(new o.xs({OK:1,INVALID_DATA:2,FORBIDDEN:3,ERROR:4}),new o.xs({REPLY_SUBMIT:1})),d=10,u=50,p=-300,m=0,_=3e4,g=828e5,v=6e5,f=/[^\wА-яЁё](вы|вас|вами|вам|ваш|вашу|ваши|ваших|вашей|вашему|вашем|вашим)(?:\s|&nbsp;)/,y="pkb_Cmi",b={id:"id",pid:"parentID",aid:"authorId",d:"datetime",de:"depth",e:"isEditable",v:"vote",ic:"ignoreType",cn:"communityName",ua:"isCommenterCurrentUser",r:"rating",av:"amountVotes",avh:"amountVotesHidden",s:"isSaved",n:"isNewest",mau:"isModeratorAutoSelect",hc:"hasChildren",st:"isShowTools",hg:"isInHiddenGroup",sc:"isStoryComment",io:"isOfficial",cu:"canUnpin",sid:"storyId",said:"storyAuthorId"},w="pkb_CHS",E=["moderator","SupportTech","SupportCommunity","SupportTags","editors"];var S=s(2134);const C={comment:{item:"comment",hidden:"comment_hidden",content:"comment__content",body:"comment__body",user:"comment__user",active:"comment__body_active",history:"comment__history",deleted:"comment_deleted",deleteReason:"comment__delete-reason",collapsingArea:"comment_collapsing-area",fake:"comment_fake",comstory:"comment_comstory"},body:{shifted:"comment__body_shifted"},highlight:{blink:"comment__body_highlight_blink",item:"comment__body_highlight_"},notice:"comment__notice",children:{el:"comment__children",nextFloor:"comment__children_next-floor",toggle:{button:"comment-toggle-children",newest:"comment-toggle-children_highlight_yellow",added:"comment-toggle-children_highlight_green",collapse:"comment-toggle-children_collapse",onlyHidden:"comment-toggle-children_only-hidden",nextFloor:"comment-toggle-children_next-floor",icon:"comment-toggle-children__icon",label:"comment-toggle-children__label",text:"comment-toggle-children__text",count:"comment-toggle-children__count"},hidden:{group:"comment__hidden-group",button:"comment__hidden-toggle",buttonHidden:"comment__hidden-toggle_hidden"}},tools:{el:"comment__tools",show:"comment__tools_show",item:"comment__tool",active:"comment__tool_active"},controls:{el:"comment__controls",item:"comment__control"},rating:{up:"comment__rating-up",down:"comment__rating-down",count:"comment__rating-count",active:"_active"},header:"comment__header",datetime:"comment__datetime",authorsLike:"comment__author-like",comments:"comments__container",commentsCount:"comments__count",user:{main:"comments__main",mainIndent:"comments__main_indent",parent:"comments__parent",toggleParent:"comments__show-parent",toggleParentActive:"collapse-button_active",answers:"comments__answers",toggleAnswers:"comments__toggle-answers"},spinner:"comments__spinner",more:{button:"comments__more-button",count:"comments__more-count",prefix:"comments__more-count-prefix"},restore:"comment__restore",reply:{wrapper:"comment__reply-wrapper",border:"comment-reply_border"}};var T=s(9412),O=s(2822);function k(t,e){var s=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),s.push.apply(s,i)}return s}function I(t){for(var e=1;e<arguments.length;e++){var s=null!=arguments[e]?arguments[e]:{};e%2?k(Object(s),!0).forEach((function(e){$(t,e,s[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(s)):k(Object(s)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(s,e))}))}return t}function $(t,e,s){return e in t?Object.defineProperty(t,e,{value:s,enumerable:!0,configurable:!0,writable:!0}):t[e]=s,t}const A=s(6419),x=s(9755);class D{constructor(t,e){this._options={id:0,parentID:void 0,authorId:0,datetime:void 0,ignoreType:r.NONE,communityName:"",userAuthor:!1,indent:0,depth:0,floor:0,isNewest:!1,moderatorAutoSelect:!1,vote:l.NONE,rating:void 0,toolsShown:void 0,isEditable:void 0,isSaved:void 0,isInHiddenGroup:void 0,hasChildren:!1,hasTextContent:!1,isChildrenShown:void 0,isStoryComment:!1,comments:e,$children:void 0,$hiddenGroup:void 0,toggleButtonHidden:!1},this.$el=t,this.$el.data("id")&&(this._options.savedReplyText=""),this._timeoutList=void 0,this._voteDebounce=void 0,this.$el.find(`.${C.comment.user}`).on("click",this._onTransitionToAuthor.bind(this))}destroy(){this.$el&&(this.$el.off(),this.$el.empty().remove()),this.$els&&(this.$els=void 0),this._options.marks&&this._options.marks.clear();for(let t in this._options)this._options.hasOwnProperty(t)&&delete this._options[t];this.cancelTimeout()}setOptions(t){return A.isObject(t)?(A.forEach(t,((t,e)=>{this[e]=t})),this):this}open(){return this}scrollTo(t=!1){return this.comments.scrollTo(i.ZP.ui.offsetElement(this.el).top-20,t)}voteDirection(t){if(O.c.getInstance().yandex.goal("vote-for-comment"),O.c.getInstance().yandex.goal(t.value>0?"tap-comment-plus":"tap-comment-minus"),O.c.getInstance().google.event("evaluation","comment"),(t=this.vote+t.valueOf())>=l.DOWN&&t<=l.UP){var e,s,n,o;const r=i.eR.get("cvb")?"cvb":null;let a,h;(this.amountVotes||this.amountVotesHidden)&&([a,h]=this.amountVotesHidden?this.amountVotesHidden:this.amountVotes);const c=this.story?this.story.commentsCount:null;O.c.getInstance().sendEvent("rate_content",I(I({post_id:null===(e=this.meta)||void 0===e?void 0:e.storyId,author_id:null===(s=this.meta)||void 0===s?void 0:s.storyAuthorId,comment_id:this.id,comment_author_id:this.authorId,user_rate:t.valueOf()},r&&{type:r}),{},{level:this.depth+1,"type_i8!empty":null===(n=this.story)||void 0===n?void 0:n.subsCode,"pluses!undefined":a,"minuses!undefined":h},c&&{comments:c})),this.vote=t,Number(null===(o=this.meta)||void 0===o?void 0:o.storyAuthorId)===i.ZP.initParams.userID&&void 0!==this.rating&&this._toggleAuthorsLike(t===l.UP.valueOf())}return this}timeout(t,e,s,i=!0){return i&&this.cancelTimeout(t),this._timeoutList||(this._timeoutList=new Map),this._timeoutList.set(t,setTimeout(s.bind(this),e)),this}cancelTimeout(...t){return this._timeoutList&&this._timeoutList.size?(t.length?t.forEach((t=>{this._timeoutList.has(t)&&(clearTimeout(this._timeoutList.get(t)),this._timeoutList.delete(t))})):(this._timeoutList.values().forEach((t=>clearTimeout(t))),this._timeoutList.clear()),this):this}addChildComment(t){this.hasChildren&&this.$children&&!this.isToggleButtonHidden||(this._renderChildren(),this._options.hasChildren=!0),this.$children.insertAdjacentHTML(this.isMain?"beforeend":"afterbegin",t)}appendChildBranch(t,e){this.hasChildren&&this.$children&&!this.isToggleButtonHidden||(this._renderChildren(),this._options.hasChildren=!0),e?(this.$hiddenGroup||this._renderHiddenGroup(),this.$hiddenGroup.insertAdjacentHTML("beforeend",t)):this.$hiddenGroup&&this.comments.orderMode!==h.TIME?this.$hiddenGroup.insertAdjacentHTML("beforebegin",t):this.$children.insertAdjacentHTML("beforeend",t)}recountVotesAndRating(t,e,s){let i=!1;return{amountVotes:t?t.split(":").map(Number).map(((t,e)=>{const n=!Boolean(e);return[s===l.UP&&n,s===l.DOWN&&!n].some(Boolean)&&(t>0?t--:i=!0),t})):void 0,rating:A.isFinite(e)?i?Number(e):Number(e)-s.valueOf():void 0}}async removeSync(){let{response:t}=await S.cf.post("/ajax/comments_actions.php",{action:"delete",id:this.id});return t.result?(this.comments.totalComments--,i.ZP.initParams.isSlowModeEnabled&&i.ZP.initParams.availableNumberOfCommentsForToday++,!0):(i.ZP.ui.toasts.showError(t.message||"comments.error.400"),!1)}async restoreSync(){let{response:t}=await S.cf.post("/ajax/comments_actions.php",{action:"restore",id:this.id});return t.result?(this.comments.totalComments++,i.ZP.initParams.isSlowModeEnabled&&i.ZP.initParams.availableNumberOfCommentsForToday--,!0):(i.ZP.ui.toasts.showError(t.message||"comments.error.400"),!1)}async branchHide(){const{response:t}=await S.cf.post("/ajax/comments_actions.php",{action:"hide",comment_id:this.id});return!!t.result||(i.ZP.ui.toasts.showError(t.message||"comments.error.400"),!1)}async branchShow(){const{response:t}=await S.cf.post("/ajax/comments_actions.php",{action:"reveal",comment_id:this.id});return!!t.result||(i.ZP.ui.toasts.showError(t.message||"comments.error.400"),!1)}async getDraft(){return(await this.comments.drafts)[this.id]}detectNeedCollapse(){return i.ZP.initParams.maxCommentsBranchDepth&&this.depth===i.ZP.initParams.maxCommentsBranchDepth||this.indent===d||this.detectOnlyHiddenGroup()}highlight(t,e=!0,s){return this}detectOnlyHiddenGroup(){return Boolean(this.hasChildren&&2===this.$children.children.length&&this.$hiddenGroup)}isResponseDisabled(t=!0){let e=(...e)=>{let s=A.isFunction(e[0])?e.shift():i.ZP.ui.toasts.showWarningMessage;t&&s(...e)};return!i.ZP.checkAccessUserActions(t)||(i.ZP.userRating<p?(e(i.ZF.NEED_MORE_RATING,p),!0):this.depth>=u?(e(i.ZP.ui.toasts.add,"max-depth",{theme:T.K.DANGER,content:"comments.errors.max-depth"}),!0):this.ignoreType===r.COMMUNITY_IGNORES_YOU&&(e(this.ignoreType,this.communityName),!0))}async _syncVote(){if(this.vote===this.voteSync)return;let{response:t}=await S.cf.post("/ajax/vote_comment.php",{comment_id:this.id,vote:this.vote.valueOf()});t.result?this.voteSync=this.vote:(this.vote=this.voteSync,i.ZP.logger.error("comments","bad sync vote",this.vote,"by comment",this.id))}async _syncSaved(){let{response:t}=await S.cf.post("/ajax/comments_actions.php",{action:"save_comment"+(this.isSaved?"+":"-"),comment_id:this.id});t.result||i.ZP.logger.error("comments","bad sync vote",this.vote,"by comment",this.id)}_onTransitionToAuthor(){if(!this.isStoryAuthorComment)return;const t=this.story||{},e=void 0!==t.adId&&t.adId,s=t.contentTypes;let i,n;(this.amountVotes||this.amountVotesHidden)&&([i,n]=this.amountVotesHidden?this.amountVotesHidden:this.amountVotes),O.c.getInstance().sendEvent("transition_to_author",{post_id:this.comments.storyId,author_id:this.comments.storyAuthorId,comment_id:this.id,comment_author_id:this.authorId,type:"from_comment","content_type!empty":s,"promo_id!empty":e,"pluses!undefined":i,"minuses!undefined":n,"type_i8!empty":t.subsCode})}_toggleAuthorsLike(t){const e=this.$el.find(".comment__header:first"),s=e.find("."+C.authorsLike);var i,n;(s.length||t)&&(s.length?s[0].style.display=t?"block":"none":e.find("."+C.datetime).after(x((i={avatarSrc:this.el.dataset.authorAvatar},""+'<div class="avatar avatar_small avatar_note hint comment__author-like" aria-label="Автор поста оценил этот комментарий">\n\t<span class="avatar__inner">\n\t\t<img src="'+(null==(n=i.avatarSrc)?"":n)+'" alt="Автор поста оценил этот комментарий">\n\t\t<svg xmlns="http://www.w3.org/2000/svg" class="icon icon--ui__heart"><use xlink:href="#icon--ui__heart"></use></svg>\n\t</span>\n</div>'))))}_renderChildren(){}_renderHiddenGroup(){}_updateIsEditable(t){}_updateRating(){}_updateChildrenShown(t){}get $el(){return this._options.$el}set $el(t){this._options.$el=t=x(t).eq(0),this._options.el=t.get(0)}get el(){return this._options.el}set el(t){this.$el=x(t)}get $children(){let t=this._options.$children;return void 0===t&&(t=this._options.$children=this.el.querySelector(`:scope > .${C.children.el}`)),t}get $hiddenGroup(){let t=this._options.$hiddenGroup;return void 0===t&&(t=this.$children.querySelectorAll(`:scope > .${C.children.hidden.group}`),t=this._options.$hiddenGroup=t.length?t[t.length-1]:null),t}get id(){return this._options.id}get parentID(){return this._options.parentID}get hasChildren(){return this._options.hasChildren}get hasParent(){return this.id!==m&&void 0!==this.parentID}get datetime(){return this._options.datetime}get ignoreType(){return this._options.ignoreType}get communityName(){return this._options.communityName}get isEditable(){return this._options.isEditable}set isEditable(t){this._options.isEditable!==(t=Boolean(t))&&(this._options.isEditable=t,this._updateIsEditable(t))}get isFake(){return Boolean(this._options.isFake)}get isNewest(){return this._options.isNewest}set isNewest(t){this._options.isNewest!==(t=Boolean(t))&&(this._options.isNewest=t,this.highlight("yellow",!1,t),t?this.el.setAttribute("data-newest","true"):this.el.removeAttribute("data-newest"))}get vote(){return this._options.vote}set vote(t){let e=this._options.vote;(t=l[t]||l.NONE)&&t!==e&&!this.isCommenterCurrentUser&&(this._options.vote=t,e?(t!==this.voteSync&&(this._voteDebounce||(this._voteDebounce=A.debounce(this._syncVote.bind(this),700)),this._voteDebounce(t)),this._updateRating()):this.voteSync=t)}get rating(){return this._options.rating}get amountVotes(){return this._options.amountVotes}get amountVotesHidden(){return this._options.amountVotesHidden}get voteSync(){return this._options.voteSync}set voteSync(t){this._options.voteSync=l[t]||l.NONE}get comments(){return this._options.comments}get parent(){return void 0===this.parentID?null:this.comments.comments.get(this.parentID)}get hasTextContent(){return this._options.hasTextContent}get isCommenterCurrentUser(){return this._options.isCommenterCurrentUser}get isSaved(){return this._options.isSaved}set isSaved(t){this._options.isSaved!==(t=Boolean(t))&&(this._options.isSaved=t,this._syncSaved())}get indent(){return this._options.indent||0}get depth(){return this._options.depth}get floor(){return this._options.floor}get isMain(){return this.id===m}get isModeratorAutoSelect(){return this._options.isModeratorAutoSelect}get isInHiddenGroup(){return this._options.isInHiddenGroup}set isInHiddenGroup(t){this._options.isInHiddenGroup=Boolean(t)}get isChildrenShown(){return this._options.isChildrenShown}set isChildrenShown(t){this._options.isChildrenShown!==(t=Boolean(t))&&(this._options.isChildrenShown=t,t||O.c.getInstance().yandex.goal("collapse-comments-branch"),this._updateChildrenShown(t))}get isStoryComment(){return this._options.isStoryComment}set isStoryComment(t){this._options.isStoryComment=Boolean(t)}get authorId(){return this._options.authorId}set authorId(t){this._options.authorId=Number(t)}get isStoryAuthorComment(){return this._options.isStoryAuthorComment}get savedReplyText(){return this._options.savedReplyText}set savedReplyText(t){this._options.savedReplyText!==t&&(this._options.savedReplyText=t)}get story(){if(this.comments&&this.comments.story)return this.comments.story.feed.stories.items[0]}get isToggleButtonHidden(){return this._options.toggleButtonHidden}}var P=s(6572),R=s(9404),M=s(4391);class N{constructor(){this._images=document.querySelectorAll(R.EB),this._config={rootMargin:"200% 0px"},M.v||this._loadImagesImmediately(),this._intersectionHandler=this._intersectionHandler.bind(this),this._observer=new IntersectionObserver(this._intersectionHandler,this._config),this._images.forEach((t=>{this._observer.observe(t)}))}disconnect(){this._observer&&this._observer.disconnect()}_loadImagesImmediately(){this._images.forEach((t=>this._prepareImage(t.querySelector(`img:not(.${R.Qs})`))))}_intersectionHandler(t){t.forEach((t=>{if(t.isIntersecting){let e=t.target.querySelector(`img:not(.${R.Qs})`);this._observer.unobserve(t.target),e&&this._prepareImage(e).catch((t=>i.vE.logger.error("lazy",t)))}}))}async _prepareImage(t){if(!t)return;const e=t.dataset.src;e&&"string"==typeof e&&(await P.cQ.preloadImage(e),t.setAttribute("src","string"==typeof e?e:"_source-error"),t.classList.add(R.Qs))}}var B=s(9537),L=s(5494),F=s(2630),U=s(8799);const j=s(6419),V=s(9755),H=/#comment_(\d+)/;class q extends n.u1{constructor(t){super(t),this._commentClass=D,this._options.comments=new Map,this._options.scrolling=!1,this._options.sliceMode=!1,this._options.maxCommentId=0,this._options.currentCommentsType=this._checkCurrentCommentsType()}getMaxCommentIDFromStorage(){let t=P.mM.get(y);return t=new Map(j.isArray(t)?t.filter((t=>j.isArray(t)&&2===t.length)):[]),Number(t.get(this.storyId)||0)}setMaxCommentIDToStorage(){let t=P.mM.get(y);t=new Map(j.isArray(t)?t.filter((t=>j.isArray(t)&&2===t.length)):[]),t.delete(this.storyId),t.size>99&&t.delete(t.keys().next().value),t.set(this.storyId,this.maxCommentId),P.mM.set(y,Array.from(t.entries()))}render(){return this.isRendered||(this.$els={navPoint:V("#comments"),comments:this.$el.children(`.${C.comments}`),totalComments:this.$(`.${C.commentsCount}`),more:{button:V(`.${C.more.button}`),prefix:V(`.${C.more.prefix}`),count:V(`.${C.more.count}`)}},super.render(),i.vE.ui.header&&this.listenToOnce(i.vE.ui.header,"dynamic-branding",this.scrollToComments.bind(this))),this}async _detectNeedScrolling(){const t=q.extractCommentID(),e=this.marks.get("lastScrollingCID");if(!t||e===t)return void(await this.scrollToComments());if(this.marks.set("lastScrollingCID",t),this.type===a.STORY&&(i.vE.ui.scrollRestoration="auto"),!this.comments.has(t))return void this.emit("could-not-find-comment");this.type===a.STORY&&(i.vE.ui.scrollRestoration="manual");const s=this.comments.get(t),n=s.$el.find("> .comment__body > .comment__header");s.open(),await P.cQ.delay(500);for(let o=0;o<3;o++){await s.scrollTo(),await L.$.request(),s.highlight("green",!0),await P.cQ.delay(500);if(i.vE.ui.elementInViewport(n,0))break}}static extractCommentID(t){const e=t?P.cQ.urlToLocation(t):i.vE.history.location,s=H.test(e.hash),n=new B._(e.search).get("cid");if(e.pathname===i.vE.history.location.pathname)return s?parseInt(H.exec(e.hash)[1],10):n?parseInt(n,10):void 0}initLazyLoad(){this._lazyLoad&&this._lazyLoad.disconnect(),this._lazyLoad=new N}initComments(t=!0){const e=this.maxCommentId;let s=0;i.vE.ui.player.init(this.$el),this.isAuthorsType||this.comments.has(m)||this.comments.set(m,new this._commentClass(this.$els.comments.get(0),this)),this._options.maxCommentId=0,j.forEach(this.$els.comments.find(`.${C.comment.item}`),(t=>{let i=parseInt(t.getAttribute("data-id"),10);if(!this.isAuthorsType&&this.comments.has(i))return;let n=new this._commentClass(t,this);this.comments.set(i,n),this.isAuthorsType?this.lastViewCommentId=i:this.maxCommentId=i,n.isInitialized=!0,!this.isSliceMode&&this.type===a.STORY&&e&&e<i&&(n.isNewest=!0),s++})),e&&!this.isAuthorsType&&this.comments.has(e)&&(this.maxCommentId=e);for(let i of this.comments.values())!i.isChildrenShown&&i.hasChildren&&i.updateChildrenCount();return t&&this._detectNeedScrolling(),this._updateFloorLastComment(),s&&this.emit("update",this.comments),this.initLazyLoad(),this}_updateFloorLastComment(){V(".comment__children_floor-bottom").attr("data-depth",0).removeClass("comment__children_floor-bottom"),V(".comment__children_next-floor").each(((t,e)=>{const s=V(e).find(".comment").last();s.attr("data-depth")>0?s.attr("data-depth",Number(s.attr("data-depth"))+1):(s.addClass("comment__children_floor-bottom"),s.attr("data-depth",1))}))}async loadComments(t=!1){if(this.loadAnimation||this.marks.has("requestDelay"))return!1;let e=this.endOfComments,s=this.requestId,n=Date.now();if(this.loadAnimation=!0,this.marks.has("requestLastStart")){let t=this.marks.get("requestLastStart"),e=n-t;if(t&&e<2e3&&(this.marks.set("requestDelay",!0),await P.cQ.delay(e),this.marks.delete("requestDelay"),this.requestId!==s))return!1}this.currentCommentsType=this._checkCurrentCommentsType(),this.marks.set("requestLastStart",n);let o=Array.from(this.story.commentsAuthors)[this.story.commentsAuthors.size-1],r=t?this:this.isAuthorsType?o&&o[1].comments||this:this.story.allComments;const a={action:this.isAuthorsType?"get_story_author_comments":"get_story_comments",story_id:this.storyId};t||(this.orderMode===h.TIME?(e&&!this.isAuthorsType&&(a.last_comment_id=this.maxCommentId),a.start_comment_id=this.isAuthorsType?r.authorsCommentID:r.lastViewCommentId):(a.min_comment_id=this.loadedCommentsIDs.minId,a.exclude_ids=this.loadedCommentsIDs.list.join(",")),O.c.getInstance().yandex.goal("load-more-comments"));const{response:l,data:c}=await S.cf.post("/ajax/comments_actions.php",a);return await P.cQ.delay(1e3-(Date.now()-n)),this.requestId===s&&(l.result?j.isArray(c.comments)&&0!==c.comments.length?(t||(r.lastViewCommentId=c.last_id||r.lastViewCommentId),c.comments.forEach((e=>{const s=r.comments.has(e.id);if(s&&!t&&!this.isAuthorsType)return void i.vE.logger.warn("comments","duplication comment",e.id,"in response, story:",this.storyId);if(t||this.isAuthorsType&&!s)return void this.$container.append(e.html);if(this.isAuthorsType&&s)return;const n=this.isAuthorsType?0:Number(e.parent_id),o=r.comments.get(n);o?(o.appendChildBranch(e.html,e.is_hidden),!1===o.isChildrenShown||o.isInitialized||(o.isChildrenShown=!o.detectNeedCollapse())):i.vE.logger.warn("comments","not found",n,"at",this.storyId,"for","comment",e.id)})),this.isAuthorsType?r.story.$els.commentsAuthors.data("total",c.total):r.story.$els.comments.data("total",c.total),r.initComments(),this._updateEndOfComments(),this.loadAnimation=!1,!0):(t||(r.endOfComments=!0),this.loadAnimation=!1,!1):(i.vE.logger.error("comments","something went wrong"),this.loadAnimation=!1,!1))}async scrollToComments(){if("#comments"!==i.vE.history.location.hash)return;i.vE.ui.scrollRestoration="manual";const{top:t}=i.vE.ui.offsetElement(this.$els.navPoint);await this.scrollTo(t)}async scrollTo(t,e=!1){this.scrolling=!0,await i.vE.ui.scrollTo(t,e),this.scrolling=!1}static async getAnswers(t){const{response:e,data:s}=await S.cf.post("/ajax/comments_actions.php",{action:"get_comments_subtree",id:t});return e.result||i.vE.ui.toasts.showError(e.message||"Ошибка получения данных"),!!e.result&&{result:s.html,freshCommentsCount:s.fresh_comments_count}}async _getCommentDrafts(){const{response:t,data:e}=await S.cf.post("/ajax/comments_actions.php",{action:"get_drafts",story_id:this.storyId});if(!t.result)return i.vE.logger.error("comments","error loading comment drafts for story",this.storyId),{};if(!V.isPlainObject(e)&&!Array.isArray(e))return i.vE.logger.log("comments","no drafts available for story",this.storyId),{};for(const n in e){if(!e.hasOwnProperty(n))continue;const t=e[n];if(null!==t)try{const e=JSON.parse(t.images);t.images=e||[]}catch(s){i.vE.logger.error("comments","error parsing comment draft images",s),t.images=[]}}return e}async _handleUnpin(t){const{response:e}=await S.cf.post("/ajax/comments_actions.php",{action:"unpin_client_official",id:t.id}),{message:s,result:n}=e;return i.vE.ui.toasts.add({content:s,theme:n?T.K.DEFAULT:T.K.DANGER}),n&&(t.canUnpin=!1,t.isOfficial=!1),e.result}static async markAsRead(t){const{response:e}=await S.cf.post("/ajax/comments_actions.php",{action:"mark_readed",ids:t});return e.result||i.vE.ui.toasts.showError(e.message||"Извините, произошла ошибка"),e.result}static async markAllAsRead(){const{response:t}=await S.cf.post("/ajax/comments_actions.php",{action:"mark_readed_all"});return t.result||i.vE.ui.toasts.showError(t.message||"Извините, произошла ошибка"),t.result}_checkCurrentCommentsType(){return"author"===i.vE.history.pathname.split("/").pop()?"author":"all"}_updateEndOfComments(){}_updateTotalComments(t){}_getFirstIconLabel(t){const e=`.user__label[data-type="${t}"]`,s=this.el.querySelectorAll(".comments__container > div");for(const i of s)if(!i.hidden&&"none"!==i.style.display){const t=i.querySelector(e);if(t)return t}}async _showNewIconFeaturePopup({id:t,target:e,content:s}){if((0,F.jE)().some((e=>e.id===t)))return;if(!i.vE.ui.elementInViewport(e,50)){const t=250;i.vE.ui.scrollRestoration="manual",await this.scrollTo(i.vE.ui.offsetElement(e).top-t)}const n=await(0,F.kd)({id:t,target:e,content:s,overlapSidebars:!1,direction:U.Lh.TOP,autoCloseIfTargetNotVisible:!0});return n&&this.listenTo(i.vE.ui,"unload",n.hide.bind(n)),n}_showNewFeatureNotifications(t){const e=async(s=0)=>{if(!t[s])return;const i=await t[s](),o=s+1;t[o]&&(i?i.on(n.eM.HIDDEN,(()=>e(o))):e(o))};e()}get totalComments(){return this._options.totalComments}set totalComments(t){this._options.totalComments!==t&&(this._options.totalComments=t,this._updateTotalComments(t))}get endOfComments(){return this._options.endOfComments}set endOfComments(t){t=Boolean(t),this._options.endOfComments=t,this._updateEndOfComments()}get loadAnimation(){return this._options.loadAnimation}set loadAnimation(t){this._options.loadAnimation!==(t=Boolean(t))&&(this._options.loadAnimation=t)}get requestId(){return this._options.requestId?this._options.requestId:this._options.requestId=Symbol("commentsRequestId")}get isUserInComments(){return this._options.isUserInComments}set isUserInComments(t){this._options.isUserInComments!==(t=Boolean(t))&&(this._options.isUserInComments=t)}get $container(){return V(`.comments[data-type="${this.currentCommentsType}"] .comments__container_main`)}get $reply(){return this._options.$reply}set $reply(t){this._options.$reply=t}get comments(){return this._options.comments}get story(){return this._options.story}set story(t){this._options.story=t}get type(){return this._options.type}set type(t){this._options.type=a[t]||a.STORY}get storyId(){return this._options.storyId}get ignoreType(){return this._options.ignoreType}get scrolling(){return this._options.scrolling}set scrolling(t){this._options.scrolling=Boolean(t)}get orderMode(){return this._options.orderMode||h.TIME}set orderMode(t){let e=this._options.orderMode;(t=h[t])&&t!==e&&(this._options.orderMode=t)}get focused(){return i.vE.storage.focused===this.eid}set focused(t){this.focused!==(t=Boolean(t))&&(i.vE.storage.focused=t?this.eid:void 0)}get isSliceMode(){return this._options.sliceMode}get maxCommentId(){return this._options.maxCommentId}set maxCommentId(t){let e=this._options.maxCommentId;e===(t=Number(t))||t<e||(this._options.maxCommentId=t)}get lastViewCommentId(){return this._options.lastViewCommentId}set lastViewCommentId(t){this._options.lastViewCommentId!==(t=Number(t))&&(this._options.lastViewCommentId=t)}get currentCommentsType(){return this._options.currentCommentsType}set currentCommentsType(t){this._options.currentCommentsType!==t&&(this._options.currentCommentsType=t)}get authorsCommentID(){return this._options.authorsCommentID}set authorsCommentID(t){this._options.authorsCommentID!==t&&(this._options.authorsCommentID=t)}get isAuthorsType(){return"author"===this._options.currentCommentsType}get storyAuthorId(){return this._options.storyAuthorId}get drafts(){return this._options.drafts||(this._options.drafts=this._getCommentDrafts()),this._options.drafts}get loadedCommentsIDs(){const t=[...this.comments.keys()].filter((t=>t>0)),e=t.length>0?Math.min(...t):0;return{minId:e,list:t.map((t=>t-e))}}}s(5306),s(4603);var W=s(9698);const G=[],Y=[];var z=s(8553),Z=s(7591);s(3479);function K(t,e){var s=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),s.push.apply(s,i)}return s}function X(t){for(var e=1;e<arguments.length;e++){var s=null!=arguments[e]?arguments[e]:{};e%2?K(Object(s),!0).forEach((function(e){Q(t,e,s[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(s)):K(Object(s)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(s,e))}))}return t}function Q(t,e,s){return e in t?Object.defineProperty(t,e,{value:s,enumerable:!0,configurable:!0,writable:!0}):t[e]=s,t}const J=s(6419),tt=s(9755),et=W.o.escape(),st=[W.o.clearHTMLTags(),W.o.clearURLs()];class it extends n.u1{constructor(t,e){super(),this._options.comment=e,this._options.storyId=t,this._options.source=void 0,this._options.isOffensive=!1,this._options.isComPostHintEnabled=!1,this._options.isSaved=!0,this._options.hintDisplayMeta=X({count:0,lastShown:0},P.mM.get(w)),this._options.offensiveMeta={lastText:"",lastTime:0},this._editor=void 0,this._menuItems=[],this._draftAnalytics={draftSavedThisTime:!1,previouslySavedDraftLoaded:!1},this._hint=void 0,this._feedbackOffer=void 0,this.detectOffensive=J.debounce(this._detectOffensive.bind(this),500),this.autoSaveDraft=J.debounce(this._onSaveDraft.bind(this),5e3),this.displayComPostHint=J.debounce(this._displayComPostHint.bind(this),300),this.checkMentions=J.debounce(this._onCheckMentions.bind(this),1e4),this.listenToOnce(this,"hintShown",(()=>{const t={count:this._options.hintDisplayMeta.count+1,lastShown:Date.now()};P.mM.set(w,t)})),this.listenTo(i.vE.ui,"beforeunload",this._onPageUnload.bind(this)),this.listenTo(i.vE,c.REPLY_SUBMIT,this._onSubmitSuccess.bind(this))}async serialize(t=!1,e=!1){const s=e?"save_draft":this.replyType,n=J.extend(this._form.serialize(),{action:s.valueOf(),story_id:this.storyId});return"create"===s||e?this.comment.isStoryComment?n.story_id=this.storyId:n.parent_id=this.comment?this.comment.id:0:n.id=this.comment.id,n.desc=this._removeImageLinks(n.desc),this._editor.isEmpty&&(n.desc=""),t&&await this._thumbs.upload(),n.images=JSON.stringify(this._thumbs.serialize(e)),i.vE.isUserModerator&&this.byModerator&&(n.by_moderator=!0),n}async validateDraftImages(t){if(!t)return;const{images:e}=t,s=[];for(const o of e){if(tt.isPlainObject(o)&&"image"===o.type)try{await P.cQ.preloadImage(o.url)}catch(n){i.vE.logger.log("comments",`draft image ${o.url} not found in temp storage`);continue}s.push(o)}return X(X({},t),{},{images:s})}deserialize(t){if(!t)return;const e=t.source||t.desc,s=t.images||[];if(this._editor.value=e,this._thumbs.clear(),this.comment.parentID){const t=`comment_${this.comment.parentID}_edit`;this._thumbs.storage=z.j.getPrefixedStorage(t)}s.forEach((t=>{const e=tt.isPlainObject(t)?t:{url:t};this._thumbs.items.add(e)})),this.isSaved=!0}async getSource(){let{response:t,data:e}=await S.cf.get("/ajax/comments_actions.php",{action:"get_comment_data",id:this.comment.id});return this._options.source=!!t.result&&e}mount(){return this.isMounted?this:(super.mount(),this.hasCommentLimitBeenReached||!i.vE.initParams.canUserComment?(this._turnOff(),this):(this.isCommentEditMode?(this._setDraftSaveDate(void 0),this.getSource().then((t=>{t?this.deserialize(t):(this.comment.isEditable=!1,this.comment.isReplyShown=!1)}))):(this._thumbs.storage=z.j.getPrefixedStorage(`comment_${this.comment.id}`),this._submitButton&&this._submitButton.disabled&&(this._submitButton.disabled=!1,this._editor.value="")),this))}disableForUnsubscribed(){this._turnOff()}async _onSaveDraft(){const t=this._submitButton.disabled||this._submitButton.animation,e=this.isEmpty,s=this.isCommentEditMode,n=await this._checkDraftSaved(),o=Boolean(this.draft);if(s||t||n||e&&!o)return void i.vE.logger.log("comments","skipping comment draft save");i.vE.logger.log("comments","uploading comment draft");const r=await this.serialize(!0,!0),{response:a}=await S.cf.post("/ajax/comments_actions.php",r);a.result||i.vE.logger.error("comments","error uploading comment draft"),i.vE.logger.log("comments","comment draft successfully saved"),this.draft=X(X({},r),{},{timestamp:P.cQ.getCurrentTimestamp()}),this.isSaved=!0,this._draftAnalytics.draftUploadedThisTime=!0,this._setDraftSaveDate(e?void 0:this.draft.timestamp)}async _setDraftSaveDate(t){}_onSubmitSuccess(){this._draftAnalytics.previouslySavedDraftLoaded&&(O.c.getInstance().yandex.goal("comment-draft-send"),i.vE.isUserModerator||i.vE.initParams.userID%2==0?O.c.getInstance().yandex.goal("comment-draft-send_even"):O.c.getInstance().yandex.goal("comment-draft-send_odd")),this._draftAnalytics.draftUploadedThisTime=!1,this._draftAnalytics.previouslySavedDraftLoaded=!1}_onPageUnload(){!this.isEmpty&&this._draftAnalytics.draftUploadedThisTime&&O.c.getInstance().yandex.goal("comment-draft-save")}_removeImageLinks(t){return this._thumbs.items.size?(this._thumbs.items.items.forEach((e=>{let s="video"===e.data.type&&e.data.url.length?e.data.url:e.data.source;if(J.isString(s)){let e=P.cQ.escapeStringRegExp(et(s));t=t.replace(new RegExp(e,"g"),"")}})),t):t}async _detectOffensive(){const t=this._editor.textContent.trim(),{lastText:e,lastTime:s}=this._options.offensiveMeta,i=Date.now();if(t.length<=2)return this._options.offensiveMeta.lastText="",void(this.isOffensive=!1);if(s&&i-s<1e4)return;if(100*function(t,e){if(t===e)return 0;const s=t;t.length>e.length&&(t=e,e=s);let i=t.length,n=e.length;for(;i>0&&t.charCodeAt(~-i)===e.charCodeAt(~-n);)i--,n--;let o,r,a,l,h=0;for(;h<i&&t.charCodeAt(h)===e.charCodeAt(h);)h++;if(i-=h,n-=h,0===i)return n;let c=0,d=0;for(;c<i;)Y[c]=t.charCodeAt(h+c),G[c]=++c;for(;d<n;)for(o=e.charCodeAt(h+d),a=d++,r=d,c=0;c<i;c++)l=o===Y[c]?a:a+1,a=G[c],r=G[c]=a>r?l>r?r+1:l:l>a?a+1:l;return r}(e,t)/Math.max(e.length,t.length)<10)return;this._options.offensiveMeta.lastText=t,this._options.offensiveMeta.lastTime=i;const{response:n,data:o}=await S.cf.post("/ajax/comments_actions.php",{action:"is_offensive",text:t,story_id:this.storyId,parent_id:this.comment.id});this.isOffensive=n.result&&o.result,this.timeout("detectOffensive",Math.max(0,1e4-(Date.now()-i)),this.detectOffensive)}async _updateIsOffensive(t){this.$els.offensive||(this.$els.offensive=tt(i.vE.i18n('<div class="comment-reply__offensive">^comments.offensive</div>')).insertBefore(this.$els.controls),await L.$.request());t!==this.$els.offensive.is(":visible")&&(t?this.$els.offensive.slideDown(300):this.$els.offensive.slideUp(300))}async _checkDraftSaved(){const t=this.draft||{},e=await this.serialize(!0,!0)||{},s=t.desc===e.desc,i=JSON.stringify(t.images)===e.images;return s&&i}_turnOff(){this._editor.turnOff(),this._submitButton.disabled=!0,this.$els.menuButton.length&&(this._menuButton.disabled=!0),this.$els.draftDate.hide(),this.$el.addClass("comment-reply_disabled").find(".comment-reply__slow-mode-text").show(),this.$els.attach.addClass("comment-reply__attach-files_disabled").off("click").find("input").prop("disabled",!0),this.$el.off("dragenter dragleave drop"),this._thumbs.limit=0,this._thumbs.hide(),this.stopListening(this._form,"submit"),this.stopListening(this._editor,"input"),this.stopListening(this._editor,"paste"),this.stopListening(this._thumbs,"update"),this.stopListening(i.vE.ui,"paste-image"),this.off("change")}async getDraft(){const t=await this.comment.getDraft();return this._options.draft=t,t&&(this._draftAnalytics.previouslySavedDraftLoaded=!0),t}async renderDraft(t){this.deserialize(await this.validateDraftImages(t)),t&&t.timestamp&&this._setDraftSaveDate(t.timestamp)}_displayComPostHint(t){if(this.isComPostHintEnabled&&!(this._options.hintDisplayMeta.count>=2)&&!(this._options.hintDisplayMeta.lastShown>0&&this._options.hintDisplayMeta.lastShown+12096e5>Date.now())&&this._hint){for(let e of st)t=e(t);t.length<300?this._hint.hide():(this.emit("hintShown"),this._hint.show())}}_onCheckMentions(){const{desc:t}=this._form.serialize();this._feedbackOffer.checkMentions(t)}closeOffensiveMsg(){this.$els.offensive&&this._options.isOffensive&&this.$els.offensive.hide()}async detectModerators(){if(this._specialUsersHint)return;const t=this._editor.textContent,e=[];for(let o=0;o<E.length;o++){const s=E[o];if(new RegExp(`@${s}([^a-zA-Zа-яА-ЯёЁ0-9_]|$)`).test(t)&&e.push(s)>1)break}if(this.hideSpecialUsersHint(),!e.length)return;const s=e.length>1?"all":e[0];var i,n;this.$specialUsers=tt((i={user:s},n="",Array.prototype.join,n+='<div class="comment-reply__special-users">\n    <span class="comment-reply__special-users-close"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon--ui__close"><use xlink:href="#icon--ui__close"></use></svg></span>\n    ',"moderator"===i.user?n+='\n        Вы призываете модератора.\n        <br>Обратите внимание, <a href="/@moderator" target="_blank">@moderator</a> решает вопросы, связанные с нарушениями правил.\n        <br>Если проблема носит технический характер, позовите <a href="/@SupportTech" target="_blank">@SupportTech</a>.\n    ':"SupportTech"===i.user?n+='\n        Вы призываете техническую поддержку.\n        <br>Обратите внимание, <a href="/@SupportTech" target="_blank">@SupportTech</a> помогает разобраться с багами и отвечает на технические вопросы по будням.\n        <br>Если вы не уверены, что проблема носит технический характер, лучше позовите <a href="/@moderator" target="_blank">@moderator</a>.\n    ':"SupportCommunity"===i.user?n+='\n        Вы призываете аккаунт поддержки сообществ.\n        <br>Обратите внимание, <a href="/@SupportCommunity" target="_blank">@SupportCommunity</a> помогает решить вопросы, связанные с сообществами на Пикабу.\n        <br>Если ваш вопрос связан с нарушениями правил сайта, лучше позовите <a href="/@moderator" target="_blank">@moderator</a>, если с техническими проблемами, позовите <a href="/@SupportTech" target="_blank">@SupportTech</a>.\n    ':"SupportTags"===i.user||"editors"===i.user?n+='\n        Вы призываете команду редакторов тегов.\n        <br>Обратите внимание, <a href="/@editors" target="_blank">@editors</a> могут помочь в редактировании тегов, одобрении новых.\n        <br>Если ваш вопрос связан с нарушениями правил сайта, лучше позовите <a href="/@moderator" target="_blank">@moderator</a>, если с техническими проблемами, позовите <a href="/@SupportTech" target="_blank">@SupportTech</a>.\n    ':n+='\n        Кажется, вы сомневаетесь, кого лучше призвать.\n        <br><a href="/@moderator" target="_blank">@moderator</a> решает вопросы, связанные с нарушениями правил.\n        <br><a href="/@SupportTech" target="_blank">@SupportTech</a> помогает разобраться с багами и отвечает на технические вопросы.\n        <br><a href="/@SupportCommunity" target="_blank">@SupportCommunity</a> помогает решить вопросы, связанные с сообществами на Пикабу.\n        <br><a href="/@SupportTags" target="_blank">@SupportTags</a> и <a href="/@editors" target="_blank">@editors</a> могут помочь в редактировании тегов, одобрении новых.\n        <br>Пожалуйста, постарайтесь призывать одного конкретного специалиста по вопросу.\n    ',n+="\n</div>")),this.$specialUsersClose=this.$specialUsers.find(".comment-reply__special-users-close"),this.$specialUsersClose.on("click",(()=>{this._specialUsersHint=!0,this.hideSpecialUsersHint()})),this.$els.controls.before(this.$specialUsers)}hideSpecialUsersHint(){this.$specialUsersClose&&(this.$specialUsersClose.off("click"),this.$specialUsersClose=null),this.$specialUsers&&(this.$specialUsers.remove(),this.$specialUsers=null)}get comment(){return this._options.comment}get storyId(){return this._options.storyId}get replyType(){return i.vE.applicationType===Z.Zq.MOBILE?this.comment.isEditable&&!this.comment.isReplyCreationMode?"edit":"create":this.comment.currentReplyMode||"create"}get isOffensive(){return this._options.isOffensive}set isOffensive(t){this._options.isOffensive!==t&&(this._options.isOffensive=t,this._updateIsOffensive(t))}get isComPostHintEnabled(){return this._options.isComPostHintEnabled}set isComPostHintEnabled(t){this._options.isComPostHintEnabled!==t&&(this._options.isComPostHintEnabled=t)}get isEmpty(){if(!this._thumbs||!this._editor)return;const t=this._thumbs.items.size>0;return this._editor.isEmpty&&!t}get isSaved(){return this._options.isSaved}set isSaved(t){this._options.isSaved=Boolean(t)}get draft(){return this._options.draft}set draft(t){this._options.draft=t}get hasCommentLimitBeenReached(){return i.vE.initParams.isSlowModeEnabled&&0===i.vE.initParams.availableNumberOfCommentsForToday}}let nt,ot;!function(t){t[t.ADD=0]="ADD",t[t.UPDATE=1]="UPDATE",t[t.DELETE=2]="DELETE",t[t.RESTORE=3]="RESTORE"}(nt||(nt={})),function(t){t.ALL="all",t.AUTHOR="author"}(ot||(ot={}))},5595:(t,e,s)=>{"use strict";s.d(e,{l:()=>v});s(8674),s(6992),s(3948),s(4916);var i=s(3182);let n;!function(t){t.RU="ru",t.EN="en"}(n||(n={}));const o="valid-substrings",r="https://cs.pikabu.ru/files/assets/valid-substrings/";class a{static async loadFromAssets(){a.substrings[n.EN]=await(await fetch(r+n.EN+".json")).json(),a.substrings[n.RU]=await(await fetch(r+n.RU+".json")).json()}async load(){try{await this.loadFromIDB()}catch(t){console.error("Cannot load valid strings dictionary from IndexedDB"),console.error(t)}if(!(a.substrings[n.EN].length>0&&a.substrings[n.RU].length>0)){try{await a.loadFromAssets()}catch(t){console.error("Cannot load valid strings dictionary from assets"),console.error(t)}try{await this.saveToDb()}catch(t){console.error("Cannot save valid strings dictionary into IndexedDB"),console.error(t)}}}getSubstrings(t){return a.substrings[t]}async loadFromIDB(){const t=(await this.getDb()).transaction(o,"readonly").objectStore(o);a.substrings[n.EN]=await t.get(n.EN)||[],a.substrings[n.RU]=await t.get(n.RU)||[]}async saveToDb(){const t=(await this.getDb()).transaction(o,"readwrite").objectStore(o);await t.put(a.substrings[n.EN],n.EN),await t.put(a.substrings[n.RU],n.RU)}async getDb(){return void 0!==this.db||(this.db=await(0,i.X3)("lang-dict",2,{upgrade(t){t.objectStoreNames.contains(o)||t.createObjectStore(o)}})),this.db}}var l,h,c;l=a,h="substrings",c={[n.EN]:[],[n.RU]:[]},h in l?Object.defineProperty(l,h,{value:c,enumerable:!0,configurable:!0,writable:!0}):l[h]=c;const d={[n.RU]:'йцукенгшщзхъфывапролджэячсмитьбю.ЙЦУКЕНГШЩЗХЪФЫВАПРОЛДЖЭЯЧСМИТЬБЮ,ёЁ"№;:?',[n.EN]:"qwertyuiop[]asdfghjkl;'zxcvbnm,./QWERTYUIOP{}ASDFGHJKL:\"ZXCVBNM<>?`~@#$^&"};class u{translate(t,e,s){const i=d[s].split(""),n={};d[e].split("").forEach(((t,e)=>n[t]=i[e]));let o="";for(const r of t.split(""))o+=n[r]||r;return o}}const p=[/[a-z].*[а-яё]|[а-яё].*[a-z]/,/[а-яё]/,/https?:\/\//,/[\s.](jpe?g|png|bmp|mp4|web[mp]|exe|html|css|js)\b/,/[a-z]-?\d/,/[\u231A\u231B\u23E9-\u23EC\u23F0\u23F3\u25FD\u25FE\u2614\u2615\u2648-\u2653\u267F\u2693\u26A1\u26AA\u26AB\u26BD\u26BE\u26C4\u26C5\u26CE\u26D4\u26EA\u26F2\u26F3\u26F5\u26FA\u26FD\u2705\u270A\u270B\u2728\u274C\u274E\u2753-\u2755\u2757\u2795-\u2797\u27B0\u27BF\u2B1B\u2B1C\u2B50\u2B55\u{1F004}\u{1F0CF}\u{1F18E}\u{1F191}-\u{1F19A}\u{1F1E6}-\u{1F1FF}\u{1F201}\u{1F21A}\u{1F22F}\u{1F232}-\u{1F236}\u{1F238}-\u{1F23A}\u{1F250}\u{1F251}\u{1F300}-\u{1F320}\u{1F32D}-\u{1F335}\u{1F337}-\u{1F37C}\u{1F37E}-\u{1F393}\u{1F3A0}-\u{1F3CA}\u{1F3CF}-\u{1F3D3}\u{1F3E0}-\u{1F3F0}\u{1F3F4}\u{1F3F8}-\u{1F43E}\u{1F440}\u{1F442}-\u{1F4FC}\u{1F4FF}-\u{1F53D}\u{1F54B}-\u{1F54E}\u{1F550}-\u{1F567}\u{1F57A}\u{1F595}\u{1F596}\u{1F5A4}\u{1F5FB}-\u{1F64F}\u{1F680}-\u{1F6C5}\u{1F6CC}\u{1F6D0}-\u{1F6D2}\u{1F6D5}-\u{1F6D7}\u{1F6EB}\u{1F6EC}\u{1F6F4}-\u{1F6FC}\u{1F7E0}-\u{1F7EB}\u{1F90C}-\u{1F93A}\u{1F93C}-\u{1F945}\u{1F947}-\u{1F978}\u{1F97A}-\u{1F9CB}\u{1F9CD}-\u{1F9FF}\u{1FA70}-\u{1FA74}\u{1FA78}-\u{1FA7A}\u{1FA80}-\u{1FA86}\u{1FA90}-\u{1FAA8}\u{1FAB0}-\u{1FAB6}\u{1FAC0}-\u{1FAC2}\u{1FAD0}-\u{1FAD6}]/u],m={[n.RU]:["d","yf","ns","pf","ghj",",tp","ds","hfp","yt","yj",",kz","z","jy","jyb","jyf","nt"],[n.EN]:["ши","ащк","еру","ща","иу","шы"]},_=/^[b-df-hj-np-tv-xzбвгджзйклмнпрстфхцчшщъь]+$/i;class g{async correct(t){let e=t.trim().toLowerCase();if(e.length<6)return t;if(p.some((t=>t.test(e))))return t;let s=n.EN,i=n.RU;/[а-яё]/.test(e)&&(s=n.RU,i=n.EN);let o=this.splitTextOnChunks(e);if(0===o.length)return t;if(!(await this.detectInvalidInputByChunks(o,s)))return t;const r=(new u).translate(t,s,i);return e=r.trim().toLowerCase(),o=this.splitTextOnChunks(e),await this.detectInvalidInputByChunks(o,i)?t:r}async detectInvalidInputByChunks(t,e){if(m[e].some((e=>t.includes(`(${e})`))))return!0;const s=(await this.getValidSubstrDict()).getSubstrings(e);for(const i of t)if("("!==i[0]&&!s.includes(i))return!0;return!1}splitTextOnChunks(t){const e=[];return t.split(/\s+/).forEach((t=>{if(t.length<=3)return 3===t.length&&_.test(t)&&e.push(t),void e.push("("+t+")");for(let s=0;s<=t.length-3;s++){const i=t.substr(s,3);_.test(i)&&e.push(i)}})),e}async getValidSubstrDict(){return void 0!==this.validSubstrDict||(this.validSubstrDict=new a,await this.validSubstrDict.load()),this.validSubstrDict}}class v{constructor(t){!function(t,e,s){e in t?Object.defineProperty(t,e,{value:s,enumerable:!0,configurable:!0,writable:!0}):t[e]=s}(this,"isDestroyedByUser",!1),this.options=t,this.corrector=new g}async processText(t){if(this.isDestroyedByUser)return!1;const e=await this.corrector.correct(t);if(e===t)return this.destroyMessage(),!1;if(void 0===this.messageEl)this.createMessage(e);else{const t=this.messageEl.querySelector(".comment-reply__invalid-input-text");t&&(t.textContent=e)}return this.options.showMessage(this.messageEl),!0}destroyMessage(){this.isDestroyedByUser=!1,this.messageEl&&(this.messageEl.remove(),this.messageEl=void 0)}createMessage(t){var e,s,i,n;this.messageEl&&this.destroyMessage();const o=document.createElement("template");var r;o.innerHTML=""+'<div class="comment-reply__invalid-input">\n    <div class="comment-reply__invalid-input-message">\n        Возможно, вы имели в виду: <span class="comment-reply__invalid-input-text">'+(null==(r={text:t}.text)?"":r)+'</span>\n    </div>\n    <span class="comment-reply__invalid-input-close"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon--ui__close"><use xlink:href="#icon--ui__close"></use></svg></span>\n</div>',this.messageEl=null===(e=o.content)||void 0===e||null===(s=e.firstElementChild)||void 0===s?void 0:s.cloneNode(!0);const a=null===(i=this.messageEl)||void 0===i?void 0:i.querySelector(".comment-reply__invalid-input-close");a&&(a.onclick=()=>{this.destroyMessage(),this.isDestroyedByUser=!0});const l=null===(n=this.messageEl)||void 0===n?void 0:n.querySelector(".comment-reply__invalid-input-text");l&&(l.onclick=()=>{this.destroyMessage(),this.options.setText(l.textContent)})}}},1433:(t,e,s)=>{"use strict";s.d(e,{cP:()=>l,WV:()=>r,Av:()=>a,$z:()=>o,dO:()=>d,Zg:()=>c,Qu:()=>E,ob:()=>w,o6:()=>h,yV:()=>b,W_:()=>I,S1:()=>g});s(8674);var i=s(2134),n=s(7892);const o=new n.xs({ACTUAL:"actual",TIME:"time",SUBS:"subs"}),r=new n.xs({ALL:"all",MINE:"mine",TAG:"tag"}),a=new n.xs({ALL:"all",OPENED:"opened",CLOSED:"closed",NSFW:"nsfw"}),l=new n.xs({PARSED:1}),h=new n.xs({NO_TARGET:0,COMMENT:1,STORY:2,PERMANENT:3}),c=(new n.xs({DELETE:1,BAN:2,APPROVE:3,DISAPPROVE:4,MOVE:5,UNBAN:6,CHANGE_PINNED:7,CHANGE_SETTINGS:8,ADD_MODERATOR:9,REMOVE_MODERATOR:10,ADD_TRUSTED_USER:11,REMOVE_TRUSTED_USER:12,ADD_CHIEF:13,REMOVE_CHIEF:14,MOVE_STORY_TO_COMMUNITY:17}),new n.xs({LIMITED:0,PERMANENT:1,CANCELED:2})),d=new n.xs({APPROVED:0,REJECTED:1,MOVED_TO_COMMON_FEED:2});var u=s(2822);function p(t,e){var s=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),s.push.apply(s,i)}return s}function m(t,e,s){return e in t?Object.defineProperty(t,e,{value:s,enumerable:!0,configurable:!0,writable:!0}):t[e]=s,t}const _=s(6419);class g{constructor(t){this._id=Number(t)}async create(t){let{response:e,data:s}=await i.cf.post("/ajax/communities_actions.php",_.defaults({action:"create",id:this._id},t));if(!e.result)throw new Error(e.message);return this._id=Number(s.id)}async edit(t){const{response:e,data:s}=await i.cf.post("/ajax/communities_actions.php",_.defaults({action:"edit",id:this._id},t));if(!e.result)throw new Error(e.message);return s}async subscribe(t,e={},s=0){u.c.getInstance().sendEvent(t?"subscribe_to_community":"unsubscribe",function(t){for(var e=1;e<arguments.length;e++){var s=null!=arguments[e]?arguments[e]:{};e%2?p(Object(s),!0).forEach((function(e){m(t,e,s[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(s)):p(Object(s)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(s,e))}))}return t}({community_id:this._id},e));const{response:n,data:o}=await i.cf.post("/ajax/communities_actions.php",{action:"subs"+(t?"+":"-"),id:this._id,admoder_source:s});if(!n.result)throw new Error(n.message);return o}async ignore(t){let{response:e}=await i.cf.post("/ajax/communities_actions.php",{action:"ignore"+(t?"+":"-"),id:this._id});if(!e.result)throw new Error(e.message)}async processStoryInQueue(t,e){let s;switch(e){default:case d.APPROVED:s="allow_story_in_queue";break;case d.REJECTED:s="deny_story_in_queue";break;case d.MOVED_TO_COMMON_FEED:s="disapprove_from_queue"}const{response:n}=await i.cf.post("/ajax/communities_actions.php",{action:s,qid:t,id:this._id});if(n.result)return n.message;throw new Error(n.message)}async getComporatorResultForQueue(t){let{response:e,data:s}=await i.cf.post("/ajax/communities_actions.php",{action:"get_duplicates_in_queue",qid:t,id:this._id});if(!e.result)throw new Error(e.message);return s}async voteForCurrentAdmin(t){let{response:e,data:s}=await i.cf.post("/ajax/communities_actions.php",{action:"vote_current_admin",flag:t?"0":"1",id:this._id});if(!e.result)throw new Error(e.message);return s}async voteForNewAdmin(t,e){let{response:s,data:n}=await i.cf.post("/ajax/communities_actions.php",{action:"vote_new_admin",user_name:t,as_new:e?"1":"0",id:this._id});if(!s.result)throw new Error(s.message);return n}async cancelVotingCandidate(){let{response:t,data:e}=await i.cf.post("/ajax/communities_actions.php",{action:"cancel_candidate",id:this._id});if(!t.result)throw new Error(t.message);return e}async loadModerationHistory(t){let{response:e,data:s}=await i.cf.post("/ajax/communities_actions.php",{action:"get_history",from_time:t||0,id:this._id});if(!e.result)throw new Error(e.message);return{list:s.data,hasMore:s.has_more}}async loadBanList(t,e){let{response:s,data:n}=await i.cf.post("/ajax/communities_actions.php",{action:"get_ban_list",user_name:t,from_id:e||0,id:this._id});if(!s.result)throw new Error(s.message);return{list:n.data,hasMore:n.has_more}}async cancelBan(t){let{response:e}=await i.cf.post("/ajax/communities_actions.php",{action:"cancel_ban",user_id:t,id:this._id});if(!e.result)throw new Error(e.message)}async addModerator(t,e=!1){let{response:s,data:n}=await i.cf.post("/ajax/communities_actions.php",{action:"add_moderator",user_name:t,add_as_chief:Number(e),id:this._id});if(!s.result)throw new Error(s.message);return n}async deleteModerator(t){let{response:e}=await i.cf.post("/ajax/communities_actions.php",{action:"delete_moderator",user_id:t,id:this._id});if(!e.result)throw new Error(e.message)}async addTrustedUser(t){let{response:e,data:s}=await i.cf.post("/ajax/communities_actions.php",{action:"add_trusted_user",user_name:t,id:this._id});if(!e.result)throw new Error(e.message);return{list:s.data,hasMore:s.has_more}}async deleteTrustedUser(t){let{response:e}=await i.cf.post("/ajax/communities_actions.php",{action:"delete_trusted_user",user_id:t,id:this._id});if(!e.result)throw new Error(e.message)}async loadTrustedUsersList(t){let{response:e,data:s}=await i.cf.post("/ajax/communities_actions.php",{action:"get_trusted_users_list",from_id:t||0,id:this._id});if(!e.result)throw new Error(e.message);return{list:s.data,hasMore:s.has_more}}static async uploadAvatar(t){}async uploadBackground(t){}async dropBackground(){let{response:t}=await i.cf.post("/ajax/communities_actions.php",{action:"drop_header_bg",id:this._id});if(!t.result)throw new Error(t.message)}async getSimilarCommunities(){const t={community_id:this._id},{response:{result:e},data:s}=await i.cf.post("/ajax/recommendations/similar_communities",t);return e?s:[]}}var v=s(6572),f=s(8211);const y=s(6419);class b{static async search(t=""){const e={action:"search_communities",name:t};"story-editor"===f.vE.initParams.pageName&&(e.f="512"),f.vE.initParams.isNsfwStory&&(e.f+=", 256");let s=i.cf.post("/ajax/gtpost_actions.php",e);return s=s.then((t=>t.response.result?t.data.map((t=>y.extend(t,{id:Number(t.id)}))):[])),s}static hasSearchCache(t=""){let e=v.hG.getInstance("searchCommunities");return e.has(t)&&!(e.get(t)instanceof Promise)}static async getAfterSignUpRecommendations(t){const e={info:JSON.stringify(t)},{response:s,data:n}=await i.cf.post("/ajax.php?route=recommendations/communities_after_reg",e);if(!s.result)throw new Error(s.message);return n}}const w="pkb_Cla",E=12e4;s(1817);var S=s(8799),C=s(4519),T=s(2906);const O=s(6419),k=s(9755);class I extends C.u1{constructor(t){super(),S.Zv.isHTMLElement(t)&&(t=k(t)),t instanceof k&&(t={$el:t}),this._options.loadAnimation=!1,O.isObject(t)&&this.setOptions(O.defaults(t,{page:1})),this._loadCommunitiesThrottle=O.throttle(this.loadCommunities,100)}_updateParams(t){t.diff("get").length&&(t.save("get"),this.clear(),this.loadCommunities(!1))}parseResponse(t,e){if(!t.result)return this._removeAllLastStory(),f.vE.logger.error("feed","something went wrong"),!1;let s=!O.isArray(e.list)||0===e.list.length,i=!e.has_more;return this.emit(l.PARSED,e,s?0:e.list.length,s||i),this.endOfFeed=s||i,!s&&e.list}async loadCommunities(t=!0){if(this.endOfFeed||this.marks.has("request")||this.marks.has("requestDelay"))return!1;let e=this.requestId,s=this.page||0,n=Date.now();if(s)t&&s++;else{if(t)return!1;s=1}let o={action:"get_communities",text:this.params.data.searchText||"",filterType:this.params.data.filterType.valueOf()||"",sort:this.params.data.sortMode.valueOf(),type:this.params.data.type.valueOf(),tag:this.params.data.tag||"",page:this.page+1};if(this.loadAnimation=!0,this.marks.set("request",!0),this.marks.has("requestLastStart")){let t=this.marks.get("requestLastStart"),s=n-t;if(t&&s<5e3&&(this.marks.set("requestDelay",!0),await v.cQ.delay(s),this.marks.delete("requestDelay"),this.requestId!==e))return!1}this.marks.set("requestLastStart",n);const{response:r,data:a}=await i.cf.post("/ajax/communities_actions.php",o);if(await v.cQ.delay(1e3-(Date.now()-n)),this.requestId!==e)return!1;let l=this.parseResponse(r,a);return O.isArray(l)&&l.length&&(this.$els.container.append(S.Zv.fragment(l.join(""))),this.amount+=l.length),!1===l||!t&&1!==s||(this.page=s),this.loadAnimation=!1,this.marks.delete("request"),!0}clear(){return delete this._options.requestId,this.marks.delete("request"),this.marks.delete("requestLastStart"),this.marks.delete("requestDelay"),this.loadAnimation=!1,this.page=0,this.amount=0,this.$els.container.empty(),this.endOfFeed=!1,this}_updateEndOfFeed(t){}_updateLoadAnimation(t){}get endOfFeed(){return this._options.endOfFeed}set endOfFeed(t){this._options.endOfFeed!==(t=Boolean(t))&&(this._options.endOfFeed=t,this._updateEndOfFeed(t))}get requestId(){return this._options.requestId?this._options.requestId:this._options.requestId=Symbol("feedRequestId")}get amount(){return this._options.amount}set amount(t){let e=this._options.amount;t="number"==typeof t?t:parseInt(t,10),isNaN(t)||t<0||e===t||(this._options.amount=t)}get page(){return this._options.page}set page(t){let e=this._options.page;t="number"==typeof t?t:parseInt(t,10),isNaN(t)||t<0||e===t||(this._options.page=t)}get loadAnimation(){return this._options.loadAnimation}set loadAnimation(t){this._options.loadAnimation!==(t=Boolean(t))&&(this._options.loadAnimation=t,this._updateLoadAnimation(t))}get params(){return this._options.params}set params(t){let e=this._options.params;e!==t&&(this._options.params=t,e&&this.stopListening(e),this.listenTo(t,T.u$.CHANGE,O.debounce(this._updateParams.bind(this),100)))}}},8204:(t,e,s)=>{"use strict";s.d(e,{U:()=>r});s(6992),s(3948),s(2707),s(8559);var i=s(8211),n=s(6572);function o(t,e,s){return e in t?Object.defineProperty(t,e,{value:s,enumerable:!0,configurable:!0,writable:!0}):t[e]=s,t}class r{static init(){this.write(),this.createFunctionForQA()}static getStorage(){var t;return null!==(t=n.mM.get(this.storageKey))&&void 0!==t?t:{w:{},r:{}}}static write(){const{userID:t,pageName:e}=i.vE.initParams,s=0===t,n=["story","community"].includes(e);if(!s||!n)return;const o={story:()=>this.getCommunityId(".story .story__community-link"),community:()=>this.getCommunityId(".community-header")}[e]();o&&this.pushToStorage(o)}static createFunctionForQA(){window.__printVisitedCommunities=()=>{const{w:t,r:e}=this.getStorage(),s=t=>Object.entries(t).map((t=>{const[e,[s,i]]=t;return{"Community Id":e,Visits:s,"Last visit":new Date(i).toString()}}));console.log("Waiting Pool"),console.table(s(t)),console.log("Recommended Pool"),console.table(s(e))}}static getCommunityId(t){var e;const s=Number(null===(e=document.querySelector(t))||void 0===e?void 0:e.dataset.id);return!Number.isNaN(s)&&s>0?s:null}static pushToStorage(t){let{w:e,r:s}=this.getStorage();if(s[t]){const[e]=s[t];s[t]=[e+1,Date.now()]}else if(e[t]){const[i]=e[t];s[t]=[i+1,Date.now()],delete e[t],s=this.sliceByLimit(s)}else e[t]=[1,Date.now()],e=this.sliceByLimit(e);this.setStorage({w:e,r:s})}static sliceByLimit(t){const e=Object.entries(t);if(e.length<=this.maxCommunities)return t;const s=e.sort((([,[,t]],[,[,e]])=>e-t)).slice(0,this.maxCommunities);return Object.fromEntries(s)}static setStorage(t){n.mM.set(this.storageKey,t)}}o(r,"storageKey","pkb_cvo"),o(r,"maxCommunities",10)},1639:(t,e,s)=>{"use strict";s.d(e,{c:()=>d});s(8674);var i=s(3182),n=s(8211),o=s(6553),r=s(4437),a=s(2134),l=s(9476);const h="_comstory_db_store",c="_comstory_db_images_key";class d{static async create(t){const{id:e,content:s="",images:i=[],beforeRedirect:r=(()=>{})}=t;if(!isFinite(e)||!Array.isArray(i)||"string"!=typeof s)throw new Error("wrong arguments passed");if(await l.c.checkIsDraftsLimitReached()){if(!(await l.a.show()))return}const a=[{type:o.STORY_BLOCK_TYPE.TEXT.valueOf(),body:s}];await d._setImages(i);const h=await d._setComstoryDraft(e,a);await r(),n.vE.history.redirect(`/add?draft_id=${h}`)}static async _setComstoryDraft(t,e){return l.c.saveDraft({time:r.CI.getDraftTime(),blocks:e,parent_story_id:t,title:"",tags:"",is_adult:!1,is_authors:!1,is_community:!1},"overwrite_oldest")}static async getInheritablePropsByUrl(t){if("string"!=typeof t)return!1;let{response:e,data:s}=await a.cf.post("/ajax/gtpost_actions.php",{action:"story_by_url",url:t});return!!e.result&&s}static async _setImages(t){let e=await d._getImagesStorage();await e.put(t,c)}static async getImages(){let t=await d._getImagesStorage();return await t.get(c)||[]}static async cleanImages(){let t=await d._getImagesStorage();await t.delete(c)}static async _getImagesStorage(){return(await(0,i.X3)("_comstory_db",1,{upgrade(t){t.objectStoreNames.contains(h)||t.createObjectStore(h)}})).transaction(h,"readwrite").objectStore(h)}}},5997:(t,e,s)=>{"use strict";s.d(e,{c:()=>i.c});var i=s(1639)},6099:(t,e,s)=>{"use strict";s.d(e,{R:()=>E,J:()=>w});s(8674),s(6992),s(3948);var i=s(7025),n=s(8211),o=s(9050);function r(t){var e="";return e+='<div class="account-confirm">\n    <div>\n        Чтобы добавить '+(0,o.escape)(t.entityName)+', вам нужно подтвердить свой аккаунт. Сделать это можно, привязав одну из соцсетей или\n        при помощи номера телефона.\n    </div>\n    <div class="account-confirm__social-buttons">\n        <span class="social-icon social-icon_square" data-type="vk">\n            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon--social__vk"><use xlink:href="#icon--social__vk"></use></svg>\n        </span>\n        <span class="social-icon social-icon_square" data-type="fb">\n            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon--social__facebook"><use xlink:href="#icon--social__facebook"></use></svg>\n        </span>\n        <span class="social-icon social-icon_square" data-type="tw">\n            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon--social__twitter"><use xlink:href="#icon--social__twitter"></use></svg>\n        </span>\n        <span class="social-icon social-icon_square" data-type="google">\n            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon--social__google"><use xlink:href="#icon--social__google"></use></svg>\n        </span>\n    </div>\n    <div class="account-confirm__social-error"></div>\n    <div class="section-hr">\n        <div class="section-hr__title">или</div>\n    </div>\n    <div class="account-confirm__input input input_box input_small">\n        <div class="input__box">\n            <input type="tel" class="input__input" autocomplete="tel" placeholder="Номер телефона" name="phone"\n                   required/>\n        </div>\n    </div>\n    <div class="account-confirm__input account-confirm__input_sms input input_box input_small">\n        <div class="input__box">\n            <input type="text" class="input__input" placeholder="Код из sms" name="sms"\n                   required/>\n        </div>\n    </div>\n    <div class="account-confirm__send-telegram">\n       <i class="hint" aria-label="Для получения кода, на данном устройстве должно быть установлено приложение &laquo;Телеграм&raquo;"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon--ui__info"><use xlink:href="#icon--ui__info"></use></svg></i>\n       <a href="#" target="_blank">Отправить код в Telegram</a>\n    </div>\n    <div class="account-confirm__buttons">\n        <button class="button_success" data-role="next">Далее</button>\n        <button class="button_success" data-role="confirm">Подтвердить</button>\n        <button data-role="cancel">Отмена</button>\n    </div>\n</div>'}var a=s(3086),l=s(3363),h=s(2082),c=s(8097);const d=s(6419);class u extends h.Y{constructor(t){super(t),d.isUndefined(this.addClearButton)&&(this.addClearButton=!0),this.render()}render(){return this.isRendered||(super.render(),this._hotkeys=new c.SV(this.$els.input),this._hotkeys.on("escape",(()=>{this.suggestion&&this.suggestion.isShown?this.suggestion.hide():this.value.length>0?this.value="":this.$els.input.blur()})),this._hotkeys.on("enter",(t=>{this.emit("enter",t)}),{type:c.FM.KEYDOWN})),this}}s(1890),s(4916),s(9412),s(1916),s(4603),s(2906),s(7686),s(4706),s(7754),s(4519),s(7041),s(6777),s(2822);s(9755),s(381),s(6419);s(9755),s(6419);s(9755);var p=s(6572);s(6419),s(9755);s(8881);var m=s(9698);s(7725),s(8924),s(9050);s(425),s(6683),s(150),s(3491);s(6419),s(9755);var _=s(7892);new _.xs({COMMUNITY:"community",USER:"user",TAG:"tag"}),new _.xs({SUBSCRIBE:"subscribe",IGNORE:"ignore"}),new _.xs({SETTINGS:"settings",SUBSCRIBE:"subscribe",UNSUBSCRIBE:"unsubscribe",IGNORE_LIST:"ignore-list"});s(3414),s(1433);s(9755),s(6419);s(9755),s(6419);s(9755),s(6419);s(1712);s(8799),s(5494);s(9755);s(6419);s(7591);s(9755);s(5035);s(9755),s(6419);s(5827),s(5358),s(1398),s(8375);s(6419);var g=s(6885),v=s(9717),f=s(6151),y=s(6349);function b(t,e,s){return e in t?Object.defineProperty(t,e,{value:s,enumerable:!0,configurable:!0,writable:!0}):t[e]=s,t}let w;!function(t){t[t.STORY=0]="STORY",t[t.COMMENT=1]="COMMENT"}(w||(w={}));class E{constructor(){b(this,"smsSessionId",""),b(this,"sendInputAnalytics",(()=>{y.cp.getInstance().sendEvent("input_start",{type:"simplified_account_confirmation_phone"})}))}async show(t){if(n.vE.initParams.experimentRegOnComment)return!1;const[e,s]={[w.STORY]:["пост","post"],[w.COMMENT]:["комментарий","comment"]}[t];return y.cp.getInstance().sendEvent("form_show",{content_type:`simplified_account_confirmation_${s}`}),new Promise((t=>{this.resolver=t,this.box=new i.LD({isModalMenu:!0,width:n.vE.isDesktopApp?360:void 0,header:"Подтверждение аккаунта",isHeaderLeftAlign:!0,destroyAfterHide:!0,content:r({entityName:e})}),this.box.show();const s=this.box.content[0];this.initButtons(s),this.initPhoneElement(s),this.initSmsCodeElement(s),this.handleSocialButtons(s)}))}async submitPhone(t){var e;if(this.smsSessionId="",!this.phone)return;if(!(await this.phone.checkValidity()))return;try{this.smsSessionId=await f.n.addPhone(this.phone.value)}catch(i){return void this.phone.setCustomValidity(i.message,!0)}this.phone.disabled=!0,null===(e=t.querySelector(".account-confirm"))||void 0===e||e.classList.add("account-confirm_phone-entered");const s=t.querySelector(".account-confirm__send-telegram a");s&&(s.href=`tg://resolve?domain=pikabu_access_code_bot&start=${this.smsSessionId}`)}async submitSmsCode(){if(!this.phone||!this.smsCode||""===this.smsSessionId)return;if(!(await this.phone.checkValidity()))return;const t=this.smsCode.value;try{this.smsSessionId=await f.n.addPhoneConfirm(this.smsSessionId,t)}catch(e){return y.cp.getInstance().sendEvent("error_occurred",{type:"simplified_confirmation_wrong_code"}),void this.smsCode.setCustomValidity(e.message,!0)}y.cp.getInstance().sendEvent("approve_phone",{type:"phone_simplified"}),this.complete(!0)}initButtons(t){var e,s,i;null===(e=t.querySelector('button[data-role="next"]'))||void 0===e||e.addEventListener("click",(()=>{y.cp.getInstance().sendEvent("form_interact",{content_type:"simplified_account_confirmation",type:"next"}),this.submitPhone(t)})),null===(s=t.querySelector('button[data-role="confirm"]'))||void 0===s||s.addEventListener("click",(()=>{this.submitSmsCode()})),null===(i=t.querySelector('button[data-role="cancel"]'))||void 0===i||i.addEventListener("click",(()=>{y.cp.getInstance().sendEvent("form_interact",{content_type:"simplified_account_confirmation",type:"cancel"}),this.complete(!1)}))}initPhoneElement(t){const e=t.querySelector('button[data-role="next"]'),s=t.querySelector('input[name="phone"]'),i=null==s?void 0:s.closest(".input");s&&i&&(s.addEventListener("input",this.sendInputAnalytics,{once:!0}),e&&(e.disabled=!0,s.oninput=s.onpaste=s.onchange=s.onkeyup=()=>{e.disabled=""===s.value}),this.phone=new(n.vE.isDesktopApp?l.u3:u)({el:i,validationHint:{direction:v.Lh.RIGHT,alignment:v.SE.CENTER},sanitizerRules:[(n.vE.isDesktopApp?l.op:m.o).whitelist("0-9\\+"),p.cQ.preparePhone],validationRules:{"auth.up.errors.phone":t=>(this.phone.value=t,g.E.test(t))}}))}initSmsCodeElement(t){const e=t.querySelector('button[data-role="confirm"]'),s=t.querySelector('input[name="sms"]'),i=null==s?void 0:s.closest(".input");s&&i&&(s.addEventListener("input",this.sendInputAnalytics,{once:!0}),e&&(e.disabled=!0,s.oninput=s.onpaste=s.onchange=s.onkeyup=()=>{e.disabled=""===s.value}),this.smsCode=new(n.vE.isDesktopApp?l.u3:u)({el:i,validationHint:{direction:v.Lh.RIGHT,alignment:v.SE.CENTER},sanitizerRules:[(n.vE.isDesktopApp?l.op:m.o).whitelist("0-9")]}))}handleSocialButtons(t){const e=t.querySelector(".account-confirm__social-buttons");e&&(e.onclick=e=>{var s,i;const n=String(null===(s=e.target)||void 0===s||null===(i=s.closest(".social-icon"))||void 0===i?void 0:i.dataset.type);this.linkSocialNetwork(t,n)})}async linkSocialNetwork(t,e){y.cp.getInstance().sendEvent("simplified_account_confirmation",{type:e});const{result:s,message:i}=await(new a.S).link(e),n=t.querySelector(".account-confirm__social-error");n&&(n.textContent=s?"":i),s&&this.complete(!0)}complete(t){var e;n.vE.initParams.isConfirmed=t,t&&document.querySelectorAll('[data-role="account-confirm"]').forEach((t=>t.remove())),this.resolver&&this.resolver(t),null===(e=this.box)||void 0===e||e.hide()}showError(t){this.box&&this.box.content.find(".account-confirm__block_error").text(t)}}},8211:(t,e,s)=>{"use strict";s.d(e,{eR:()=>M.eR,ZF:()=>f.ZF,vE:()=>it,ZP:()=>it});s(8674),s(4916),s(6992),s(3948),s(1817);const i=new(s(1460).x)({LOG:7,INFO:6,WARN:4,ERROR:3});let n;const o=Symbol();class r{constructor(t){if(t!==o)throw new Error("Cannot construct singleton");this._transports=[],this._startTime=Date.now()}_sendToTransports(t,...e){let s=Date.now(),i=this._startTime-s;this._transports.forEach((n=>{t<=n.level&&n.message({date:s,afterStart:i,level:t,data:e||[]})}))}error(t,...e){this._sendToTransports(i.ERROR,t,...e)}warn(t,...e){this._sendToTransports(i.WARN,t,...e)}info(t,...e){this._sendToTransports(i.INFO,t,...e)}log(t,...e){this._sendToTransports(i.LOG,t,...e)}static get instance(){return n||(n=new r(o),n)}}class a{constructor(t=i.LOG){this._currentLevel=t}get level(){return this._currentLevel}set level(t){this._currentLevel=i[t]||this._currentLevel||i.ERROR}message(t){}}const l=s(6419),h=s(381),c=new Set(["font-weight: bold; color: #F99157;","font-weight: bold; color: #FAC863;","font-weight: bold; color: #99C794;","font-weight: bold; color: #5FB3B3;","font-weight: bold; color: #6699CC;","font-weight: bold; color: #C594C5;","font-weight: bold; color: #AB7967;"]);class d extends a{constructor(t){super(t),this._colorQueue=c.values(),this._entries=new Map}_getColorByEntry(t){return this._entries.has(t)||this._entries.set(t,this._nextColor),this._entries.get(t)}get _nextColor(){const{value:t,done:e}=this._colorQueue.next();return e&&(this._colorQueue=c.values()),t}message(t){const e=[...t.data],s=h(t.date).format("hh:mm:ss"),i=t.level.toString().toLowerCase(),n=[`%c[${s}]`,"font-weight: bold; color: #5FB3B3;"];if(t.data.length>1&&l.isString(t.data[0])){let t=e.shift();t=t.padStart(10-(10-t.length)/2).padEnd(10),n[0]+=` %c:${t}:`,n.push(this._getColorByEntry(t))}console[i].apply(console,n.concat(e))}}var u=s(5718);class p extends a{constructor(t,e){super(t),this._sendHandler=e}message(t){"api"===t.data[0]&&t.data[1]instanceof u.H?this._sendHandler(t.data[1],4):this._sendHandler(new Error(t.data.join(" ")),4)}}const m=r.instance;s(4603),s(5306);const _=s(6419);class g{constructor(t,e=!1,s=".",i=!1){this.splitCharacter=s,this._createIfNotExist=i,t&&e?this._tree=t:(this._tree={},t&&this.load(t))}index(t,e,s,i=!1){if(_.isString(e))return this.index(t,e.split(this.splitCharacter),s,i);if(e[0]&&_.isUndefined(t[e[0]])){if(_.isUndefined(s)&&!i)return;t[e[0]]={}}return 1!==e.length||_.isUndefined(s)?0===e.length?t:this.index(t[e[0]],e.slice(1),s,i):t[e[0]]=s}load(t){return this._merge(this._tree,t),this}_merge(t,e){return _.forEach(e,((s,i)=>{let n=_.isObject(s)&&!_.isFunction(s),o=_.isArray(s),r=_.isEmpty(s);if(!n||!r||o||_.isUndefined(t[i]))try{t[i]=n&&!o?this._merge(t[i],s):s}catch(a){t[i]=e[i]}})),t}set(t,e){return this.index(this._tree,t,e)}get(t,e){return t?this.index(this._tree,t,void 0,_.isBoolean(e)?e:this._createIfNotExist):this._tree}_clear(t){for(let e in t)if(t.hasOwnProperty(e)){let s=t[e],i=typeof s;if(!("object"!==i||null===s||s instanceof Array||s instanceof String||s instanceof Number)){this._clear(t[e]);continue}"string"!==i&&"number"!==i&&(t[e]=null),delete t[e]}}clear(){this._clear(this._tree)}toString(t,e){let s;try{s=JSON.stringify(this._tree,t,e)}catch(i){s=this._tree}return s}toJson(t=null,e){let s;try{s=JSON.stringify(this._tree,t,e)}catch(i){s="{}"}return s}static needPlane(t){return _.isObject(t)&&!_.isArray(t)}toPlane(t,e,s){let i={};return _.isString(s)||(s=this.splitCharacter),_.isFunction(e)||(e=g.needPlane),_.isString(t)&&t.length>0?t=this.get(t):t||(t=this._tree),!(!t||_.isEmpty(t)||_.isArray(t))&&(_.forEach(t,((t,n)=>{if(e(t))return _.forEach(this.toPlane(t,e,s),((t,e)=>{i[`${n}${s}${e}`]=t}));i[n]=t})),i)}toPlaneMap(...t){let e=new Map;return _.forEach(this.toPlane(...t),((t,s)=>{e.set(s,t)})),e}fromPlane(t,e){let s;return _.isString(e)||(e=this.splitCharacter),s=new RegExp(e+"+","g"),!_.isObject(t)||_.isArray(t)||_.forEach(t,((t,i)=>{this.splitCharacter!==e&&(i=i.replace(s,this.splitCharacter)),this.set(i,t)})),this}static create(...t){let e=new g(...t),s=function(t,s){return _.isUndefined(s)?e.get(t):e.set(t,s)};return s.load=e.load.bind(e),s.toPlane=e.toPlane.bind(e),s.toString=e.toJson.bind(e),s.toPlaneMap=e.toPlaneMap.bind(e),s.clear=e.clear.bind(e),s}}var v=s(6777),f=s(7591);const y=s(6419),b=s(5493);class w{static now(){return b.now()}static mark(t){b.mark(t)}static measure(t,e,s){b.measure(t,e,s)}static getEntry(t,e){return y.last(w.getEntriesByName(t,e?e.valueOf():void 0))}static getEntryDuration(t,e,s=!1){let i=w.getEntry(t,e);return!!i&&w.getFixedTime(i.duration,s)}static getEntryElapsed(t,e,s=!1){let i=w.getEntry(t,e),n=w.now();return!!i&&w.getFixedTime(n-i.startTime,s)}static getFixedTime(t,e=3){return y.isNumber(t)&&y.isNumber(e)?Number(t.toFixed(e)):t}static getEntries(){return b.getEntries()}static getEntriesByType(t){return b.getEntriesByType(t?t.toString():t)}static getEntriesByName(t,e){return b.getEntriesByName(t,e?e.toString():e)}static clearMarks(t){b.clearMarks(t)}static clearMeasures(t){b.clearMeasures(t)}}class E{constructor(){this._bait=null,this._detected=!1,this._body=document.body,this._ready=!1}async _detect(){w.mark("adblock.start");let t=this.detected=await this._checkElementBlocked();return this._destroyElementBait(),w.mark("adblock.end"),w.measure("adblock","adblock.start","adblock.end"),this.detected=t}_checkElementBlocked(){let t,e=Date.now();return new Promise((s=>{t=setInterval((()=>{if(this._checkElementBait())return clearInterval(t),s(!0);Date.now()-e>210&&(clearInterval(t),s(!1))}),50)}))}_destroyElementBait(){return this._bait?(this._bait.parentNode.removeChild(this._bait),this._bait=null,this):this}_renderElementBait(){return this._bait||(this._bait=document.createElement("div"),this._bait.classList.add("pub300x250","pub300x250m","pub728x90","text-ad","textAd","textad","textads","text-ads","text-ad-links"),this._bait.setAttribute("style","width:1px!important;height:1px!important;position:absolute!important;left:-10000px!important;top:-1000px!important;"),this._body.append(this._bait)),this._bait}_checkElementBait(){const t=this._renderElementBait(),e=window.getComputedStyle(t,null);return!(!this._body.getAttribute("abp")&&null!==t.offsetParent&&0!==t.offsetHeight&&0!==t.offsetLeft&&0!==t.offsetTop&&0!==t.offsetWidth&&0!==t.clientHeight&&0!==t.clientWidth)||("none"===e.display||"hidden"===e.visibility)}get ready(){return this._ready?this._ready:this._ready=this._detect()}set detected(t){return this._detected=Boolean(t)}get detected(){return this._detected}}var S=s(5983),C=s(9537),T=s(2906),O=s(9050);const k=s(9755),I=Symbol();let $;class A extends v.vp{constructor(t){if(super(!0),this._options={searchParams:void 0,url:new T.Lo({search:void 0,hash:void 0,path:void 0,pathname:void 0})},t!==I)throw new Error("Cannot construct singleton");this._addHook("popstate",k(window),"popstate.history",(t=>{this.emit("popstate",t.originalEvent.state,t)}))}_addHook(t,e,s,i){this.hook.on(t,(t=>{t===v.ZK.FIRST_ON?e.on(s,i):t===v.ZK.LAST_OFF&&e.off(s,i)}))}init(){this.listenTo(this,"popstate",this._loadUrl),this._loadUrl()}back(){A.history.back()}go(t){A.history.go(t)}redirect(t){A.location.href=t}forward(){A.history.forward()}pushUrl(t=null,e=!1){return this.pushState(void 0,"",t,e)}pushState(t,e="",s=null,i=!1){A.history.pushState(t,e,s),i?this._loadUrl():this.url.update(A.extractFromUrl(s))}replaceUrl(t=null,e=!1,s=!1){this.replaceState(void 0,"",t,e,s)}replaceState(t,e="",s=null,i=!1,n=!1){A.history.replaceState(t,e,s),i?this._loadUrl(n):this.url.update(A.extractFromUrl(s))}_loadUrl(t=!1){this.url.update(A.extractFromUrl()),t||this.url.diff("current").length?(this.url.save("current"),m.log("history","change",this.pathname,this.hash),this.emit("route",this)):m.log("history","prevent rerouting")}static extractFromUrl(t){let e=O.isString(t)?S.c.urlToLocation(t):A.location;return{hostname:e.hostname,search:e.search.replace(/^\?/,""),pathname:e.pathname,path:e.pathname+e.search,hash:e.hash.replace(/^#/,"")}}get url(){return this._options.url}get state(){return history.state}get pathname(){return this.url.data.pathname}get hash(){return this.url.data.hash}get path(){return this.url.data.path}get hostname(){return this.url.data.hostname}get searchParams(){let t=this._options.searchParams,e=this.url.data.search;return t?(e===t.lastSearch||(t=this._options.searchParams=new C._(e),t.lastSearch=e),t):this._options.searchParams=new C._(e)}get location(){return A.location}static get location(){return window.location}static get history(){return window.history}static get instance(){return $||($=new A(I),$)}}var x=s(7333),D=s(4850);class P{constructor(){this._commands=new Map,this._isReady=!1}get target(){return this._target}set target(t){this._target!==t&&(this._target=t)}processMessageEvent(t,e){const{command:s,data:i}=t.data,n=this._commands.get(s);if("function"!=typeof n)throw new Error(`not found command "${s}"`);return Boolean(e)?n(e,i):n(i)}send(t,e,s=this.target){if(!this.isReady)throw new Error("channel SW<>Client not ready");null!==this.target&&s.postMessage({command:t,data:e})}query(t,e,s=this.target){return this.isReady?new Promise(((i,n)=>{let o=new MessageChannel,r=setTimeout((()=>{o.port1.close(),o.port2.close(),n(new Error("timeout await response for query "+t))}),3e3);o.port1.addEventListener("message",(t=>{i(t.data),clearTimeout(r)})),o.port1.start(),s.postMessage({command:t,data:e},[o.port2])})):Promise.reject(new Error("channel SW<>Client not ready"))}addCommand(t,e){return this._commands.set(t,e),this}get isReady(){return this._isReady}set isReady(t){this._isReady!==t&&(this._isReady=t)}}class R extends P{constructor(t,e,s){super(),D.P?(this._currentUsedController=void 0,this._detectChangeTi=void 0,this._swUrl=t,this._sessionId=s,this._expectedSWVersion=e,this.addCommand("h",(()=>{this.isReady=!0,it.emit("sw-ready")})),this._init()):"serviceWorker"in navigator&&!x.N&&null!==navigator.serviceWorker.controller&&this._unregister()}noop(){return this}async _onMessage(t){let e=t.ports[0];try{let s=await this.processMessageEvent(t);e&&e.postMessage(s)}catch(s){m.warn("sw","incoming message",s)}}_init(){navigator.serviceWorker.addEventListener("message",this._onMessage.bind(this)),navigator.serviceWorker.addEventListener("controllerchange",(()=>{clearTimeout(this._detectChangeTi),this._onReady("controllerchange")})),this._swUrl?this._register(this._swUrl):this._unregister().catch((t=>m.error("sw",t)))}_register(t){navigator.serviceWorker.register(t,{scope:"/",updateViaCache:"none"}).then((()=>navigator.serviceWorker.ready)).then((t=>{null!==t.installing&&null!==t.active||(m.info("sw","ready but wait"),this._detectChangeTi=setTimeout((()=>{this._onReady()}),500))})).catch((t=>m.error("sw",t)))}async _unregister(){if(this.isReady=!1,!navigator.serviceWorker.controller)return;navigator.serviceWorker.controller.postMessage({command:"destroy"});(await navigator.serviceWorker.getRegistrations()).forEach((t=>t.unregister())),m.info("sw","remove sw")}_updateCurrentWorker(){this.query("version").then((t=>{t!==this._expectedSWVersion&&navigator.serviceWorker.getRegistration().then((t=>t.update()))})).catch((()=>{navigator.serviceWorker.getRegistration().then((t=>t.update()))}))}_onReady(t="ready"){let e=this._currentUsedController;e&&"redundant"!==e.state&&e!==navigator.serviceWorker.controller&&e.postMessage({command:"buy"}),this._currentUsedController=e=navigator.serviceWorker.controller,m.info("sw","worker ready to use","from Event:",t,e),this.target=e,this.isReady=!0,this.send("h",this._sessionId),this._updateCurrentWorker(),clearInterval(this._keepAliveTimer),this._keepAliveTimer=setInterval((()=>{e&&"redundant"!==e.state&&e.postMessage({command:"ping"})}),9e3)}}var M=s(6572),N=s(3589);const B=s(6419),L=/\^([\w.:-]+)(?:\(([^)\r]*)\))?/g,F=/\^([\w.:-]+)(?:\(([^)\r]*)\))?/,U=/'([^')\r]*)'/g;class j{constructor(t){B.isObject(t)&&this.load(t)}load(...t){return this.locales.load(...t),this}clear(){return this.locales.clear(),this}format(t,...e){let s=this.locales.get(t)||t;if(Array.isArray(s)&&(s=e.length>0?3===s.length?S.c.pluralNounRU(e[0],s):S.c.pluralAdjectiveRU(e[0],s):s[0]||t),"string"==typeof s)s=S.c.format(s,...e);else{if(!B.isFunction(s))return t;s=s(...e)||t}return!Array.isArray(s)&&F.test(s)?s.replace(L,((t,e,s)=>(s=s?j._clearArguments(s):[],this.format(e,...s)))):s}static _clearArguments(t){return B.map(t.match(U)||[],(t=>t.substr(1,t.length-2)))}get locales(){let t=this._locales;return this._locales||(t=this._locales=new g),t}}var V=s(2134),H=s(8504),q=s(9050);class W{constructor(t){this._observers=new Set,this._waitingCommand=new Map,this._isConnected=!1,this._isConnecting=!1,this._getConnectionUrl=t,this._lastToken=1,this._amountConnectionErrors=0,this._amountIAKErrors=0,this._isFirstMessage=!0,this._isNextConnectionToLogger=!1,this._onCloseBound=this._onClose.bind(this),this._onErrorBound=this._onError.bind(this),this._onMessageBound=this._onMessage.bind(this)}async connect(){if(this._isConnecting||this.isConnected||this._reconnectTi)return this;this._isConnecting=!0,this._stopKeepAlive();const t=this.connectionId;try{const e=await this._getConnectionUrl(this._isNextConnectionToLogger);if(this.connectionId!==t)return this;m.info("ws","connect",e);const s=this._connection=new WebSocket(e);s.addEventListener("error",this._onErrorBound),s.addEventListener("close",this._onCloseBound),s.addEventListener("message",this._onMessageBound)}catch(e){if(m.error("WebSocket, some problem with start up connection",e),this._isConnecting=!1,e instanceof Error&&e.message&&"disallow ws"===e.message)return this.reconnect(36e4),this;this.reconnect(12e4)}return this}close(){if(this._connection){const t=this._connection;delete this._connection,t.removeEventListener("error",this._onErrorBound),t.removeEventListener("close",this._onCloseBound),t.removeEventListener("message",this._onMessageBound);const e=t.readyState;e!==WebSocket.CLOSED&&e!==WebSocket.CLOSING&&t.close()}return this.stopReconnect(),this._rejectAllWaitingCommands(),this._isFirstMessage=!0,this.isConnected=!1,this._isConnecting=!1,this._stopKeepAlive(),delete this._connectionId,this}reconnect(t){return this.isConnected||(t||(t=15*Math.min(Math.max(1,++this._amountConnectionErrors),2e3)*1e3),m.info("ws","reconnect",t),this.stopReconnect(),this._reconnectTi=setTimeout((()=>{this.stopReconnect(),this.connect()}),t+Math.floor(4e3*Math.random()))),this}stopReconnect(){return clearTimeout(this._reconnectTi),delete this._reconnectTi,this}noop(){return this}_stopKeepAlive(){this._keepAliveTi&&(clearTimeout(this._keepAliveTi),delete this._keepAliveTi)}_refreshKeepAlive(){const t=async(e=!1)=>{e||await this.query("ping"),clearTimeout(this._keepAliveTi),this._keepAliveTi=setTimeout(t,55e3)};t(!0)}_rejectAllWaitingCommands(){this._waitingCommand.forEach((({reject:t})=>t(new Error("did not wait for an answer, the connection is lost")))),this._waitingCommand.clear()}_onOpen(){m.log("ws","ready"),this._lastToken=1,this._isConnecting=!1,this._isNextConnectionToLogger=!1,this.isConnected=!0,this._amountConnectionErrors=0,this._refreshKeepAlive()}_onError(t){m.error("connection",t)}_onClose(t){switch(this.close(),4002===t.code&&this._observers.forEach((t=>t.onFUSW&&t.onFUSW())),m.info("ws","close "+t.code),t.code){case 4001:this._isNextConnectionToLogger=!0,this._amountIAKErrors++,this.reconnect(this._amountIAKErrors>=10?36e5:12e4);break;case 1012:this.reconnect(5e3);break;default:this.reconnect()}}_onMessage(t){if(this._isFirstMessage)return"h;1"===t.data?(this._onOpen(),void(this._isFirstMessage=!1)):void 0;const e=t.data.split(";"),s=e[0],i=e[1],n=s+";"+i;if(this._waitingCommand.has(n)){const t=this._waitingCommand.get(n);t&&(t.resolve(e.slice(2)),this._waitingCommand.delete(n))}else this._observers.forEach((t=>t.onMessageNoOneWaiting(s,e.slice(2))))}addObserver(t){this._observers.add(t)}send(t,e){if(!this._connection||this._connection.readyState===WebSocket.CLOSED||this._connection.readyState===WebSocket.CLOSING||!this.isConnected)throw new Error(`Unable to send "${t}", connection failed`);let s=t+";"+this.generateToken;e&&e.length>0&&(s+=";"+e.join(";")),this._refreshKeepAlive(),this._connection.send(s)}async query(t,e){if(!this._connection||this._connection.readyState===WebSocket.CLOSED||this._connection.readyState===WebSocket.CLOSING||!this.isConnected)throw new Error(`Unable to send "${t}", connection failed`);const s=this.generateToken;let i=t+";"+s;return e&&e.length>0&&(i+=";"+e.map((t=>(" "+String(t)).slice(1))).join(";")),i=(" "+i).slice(1),new Promise(((e,n)=>{this._waitingCommand.set(t+"=;"+s,{resolve:e,reject:n}),this._refreshKeepAlive(),this._connection.send(i),i=""}))}get isConnected(){return this._isConnected}set isConnected(t){this._isConnected!==t&&(this._isConnected=t,this._observers.forEach((e=>e.onConnectionStateChange&&e.onConnectionStateChange(t))))}get connectionId(){return this._connectionId?this._connectionId:this._connectionId=Symbol("connectionId")}get generateToken(){return this._lastToken++}}class G extends v.vp{constructor(t=!1){if(super(!0),this._isReady=!1,this._hasListenState=void 0,this._hasListenMessage=void 0,this._commandsBuffer=null,t)return;const e=it.initParams.csrfToken;this.hook.on("ready",((t,s)=>{if(t===v.ZK.ON&&this.isReady)return void s(!0);const i=it.sw.isReady;t===v.ZK.FIRST_ON?(this._hasListenState=!0,i&&it.sw.send("ws-listen-state",{on:!0,xhrToken:e})):t===v.ZK.LAST_OFF&&(this._hasListenState=!1,i&&it.sw.send("ws-listen-state",{on:!1,xhrToken:e}))})),this.hook.on("message",(t=>{const s=it.sw.isReady;t===v.ZK.FIRST_ON?(this._hasListenMessage=!0,s&&it.sw.send("ws-listen-message",{on:!0,xhrToken:e})):t===v.ZK.LAST_OFF&&(this._hasListenMessage=!1,s&&it.sw.send("ws-listen-message",{on:!1,xhrToken:e}))})),it.sw.addCommand("ws-state",(t=>{this.isReady=Boolean(t)})),it.sw.addCommand("ws-message",(t=>{this.emit("message",t.command,...t.args)})),it.on("sw-ready",(async()=>{this.isReady=await it.sw.query("ws-is-ready"),"boolean"==typeof this._hasListenState&&it.sw.send("ws-listen-state",{on:this._hasListenState,xhrToken:e}),"boolean"==typeof this._hasListenMessage&&it.sw.send("ws-listen-message",{on:this._hasListenMessage,xhrToken:e}),this._commandsBuffer&&this._commandsBuffer.length&&this._commandsBuffer.forEach((([t,s])=>{it.ws.send("ws-send-w",{command:t,args:s,xhrToken:e})}))}))}send(t,...e){D.P&&it.sw.send("ws-send",{command:t,args:e,xhrToken:it.initParams.csrfToken})}sendW(t,...e){if(D.P)return it.sw.isReady?void it.sw.send("ws-send-w",{command:t,args:e,xhrToken:it.initParams.csrfToken}):(this._commandsBuffer||(this._commandsBuffer=[]),void this._commandsBuffer.push([t,e]))}query(t,...e){return D.P?it.sw.query("ws-query",{command:t,args:e,xhrToken:it.initParams.csrfToken}):Promise.resolve()}get isReady(){return this._isReady}set isReady(t){this._isReady!==t&&(this._isReady=t,t&&this.emit("ready"))}}var Y=s(7912);class z extends G{constructor(){super(!0),this._wsLastUsedTime=0,this.hook.on("ready",((t,e)=>{if(t===v.ZK.ON&&this.isReady)return this.ws.noop(),void e(!0);t===v.ZK.FIRST_ON?(this.ws.noop(),this._hasListenState=!0):t===v.ZK.LAST_OFF&&(this._hasListenState=!1,this._tryCloseConnection())})),this.hook.on("message",(t=>{t===v.ZK.FIRST_ON?(this.ws.noop(),this._hasListenMessage=!0):t===v.ZK.LAST_OFF&&(this._hasListenMessage=!1,this._tryCloseConnection())})),this.listenTo(it.ui,"visibilitychange",(()=>{Y.E.isShown?(this._hasListenMessage||this._hasListenState)&&this.ws.noop():this._tryCloseConnection(!0)}))}send(t,...e){this.ws.send(t,e)}sendW(t,...e){this.isReady?this.ws.send(t,e):(this._commandsBuffer||(this._commandsBuffer=[]),this._commandsBuffer.push([t,e]))}query(t,...e){return this.ws.query(t,e)}async _onWSConnectionStateChange(t){this.isReady=Boolean(t),t&&this._commandsBuffer&&this._commandsBuffer.length&&this._commandsBuffer.forEach((([t,e])=>{this.ws.send(t,e)}))}async _onWSMessageNoOneWaiting(t,e){"fcr"!==t?"fusw"!==t&&this.emit("message",t,...e):window.location.reload()}async _tryCloseConnection(t=!1){this._ws&&this._ws.isConnected&&(!t&&Date.now()-6e4<this._wsLastUsedTime||this._hasListenState||this._hasListenMessage||(this.ws.close(),clearInterval(this._tryCloseConnectionTimeout),delete this._tryCloseConnectionTimeout))}get ws(){if(this._wsLastUsedTime=Date.now(),this._tryCloseConnectionTimeout||(this._tryCloseConnectionTimeout=setInterval(this._tryCloseConnection.bind(this),5e3)),this._ws)return this._ws.connect(),this._ws;let t=this._ws=new W(this.getConnectionUrl.bind(this));return t.addObserver({onConnectionStateChange:this._onWSConnectionStateChange.bind(this),onMessageNoOneWaiting:this._onWSMessageNoOneWaiting.bind(this)}),t.connect(),t}async getConnectionUrl(t=!1){const e=`&swv=${it.initParams.swVersion}`,{response:s,data:i}=await V.cf.get(`/ajax/ws_actions.php?action=request-access${e}${t?"&l=1":""}`);if(!s.result)throw new Error("disallow ws");return`${i.host}/?pl=${i.access_key}${e}`}}var Z=s(4616);const K="BroadcastChannel"in window;class X extends P{constructor(){super(),K&&(this._isReady=!0,this._target=new BroadcastChannel("pikabu_channel"),this._target.addEventListener("message",(t=>{this.processMessageEvent(t)})))}}var Q=s(2822);const J=s(9755),tt=s(381),et=s(5470);let st,it;class nt extends v.vp{constructor(){if(st)return st;if(super(),st=this,this._uuid=Date.now(),this._initParams=void 0,this._storage={focused:void 0,activeFeedRestoreStateMode:!1},tt.locale("ru"),tt.relativeTimeThreshold("h",24),tt.updateLocale("ru",{relativeTime:{d:"1 день"}}),this._logger=m,this._consoleTransport=new d,this._consoleTransport.level=i.WARN,this._logger.addTransport(this._consoleTransport),"function"==typeof window.plog){const t=window.plog;delete window.plog,this._logger.addTransport(new p(i.ERROR,t))}this.config=g.create({applicationType:"desktop",animations:["https://cs.pikabu.ru/apps/ub/5.0.1/animations/",[""],[["comment-send",62,28,0,0],["comments-spinner",104,40,0,0],["eleventh-birthday",14,24,0],["image-upload",40,60,0,0],["signin",56,28,0,0],["signup",68,28,0,0],["stories-restore",150,150,0,0],["stories-search",126,64,0,0],["stories-spinner",132,64,0,0],["story-publish",96,28,0,0],["video-convert",114,100,0,0],["video-upload",96,250,0,0]]],freeze:{"page-quarantine":{"ring.mp3":"/apps/ub/5.0.1/desktop/page-quarantine/ring.mp3"}},grecaptchaKey:"6Lf5DUsUAAAAAGeOi2l8EpSqiAteDx5PGFMYPkQW",grecaptchaV3Key:"6Lf_BzkbAAAAALLyauQDjsAwtlRTahh8WHXbZc-E"}),this.ui=void 0,this._adblock=new E,this.performance=w,this._router=new N.F0,this._history=A.instance,this.listenTo(this._history,"route",(t=>{let e={path:t.pathname,hash:t.hash,pageName:this.initParams.pageName,pageRecordID:this.initParams.pageRecordID},s=Date.now();this.emit("route",e),m.log("router","find route",e),this.routerDispatch(e).then((()=>m.log("router","routed finish",(Date.now()-s).toFixed(3),"ms."))).catch((t=>m.error("route",t)))})),this.listenTo(this._router,"mismatch",(function(){m.log("router","not found match")})),this._i18n=new j(s(252)),this._i18n.load({icon:H.q,user:(t,e)=>function(t){var e,s="",i=q.escape;return s+'<a href="/@'+(null==(e=t.name)?"":e)+'" target="_blank" class="user user_inline"><span class="avatar avatar_small">'+(null==(e=t.avatar?'<img src="'+t.avatar+'">':'<span class="avatar__default"></span>')?"":e)+'</span><span class="user__nick">'+i(t.name)+"</span></a>"}({name:t,avatar:e})}),window.pkb=window.pkb||{},this.global=g.create(window.pkb,!0),this._refreshSession(),this._autoReloadAfterLogout(),this.ready=new Promise((t=>{J((()=>{document.querySelectorAll(".app__config").forEach((t=>{const e=t.getAttribute("data-entry")||"common";try{let s=JSON.parse(t.innerHTML||"[]");"initParams"===e?this._initParams=s:this.config("modules."+e,s)}catch(s){this.logger.error("config",e,"problem with decoding")}})),this.adblock.ready.then((t=>{const e=String(window.location.hostname).match(/pikabu\.[a-z]+/i)[0],s=String.fromCharCode(65+~~((new Date).getMinutes()/5));0===e.indexOf("pikabu")&&(M.eR.remove("bs"),M.eR.set("bs",s+(t?"1":"0"),{expires:1,domain:"."+e}))})),this.environment===f.Gv.PRODUCTION&&(this._consoleTransport.level=i.ERROR,console&&console.log("%c+",'font-size: 1px; padding: 150px 87px; line-height: 0; background: url("https://cs.pikabu.ru/assets/images/dev.png"); background-size: 175px 300px; color: transparent;')),this.sw.noop(),t()}))}))}navigate(t,e,s,i=!1){m.warn("history","use deprecated method core.navigate, please use core.history.pushState"),this.history.pushState(t,e,s,i)}replaceState(t,e,s,i=!1){m.warn("history","use deprecated method core.replaceState, please use core.history.replaceState"),this.history.replaceState(t,e,s,i)}use(t,e){return this._router.use(t,e),this}logout(){return V.cf.post("/ajax/logout.php").then((function({response:t,data:e}){Boolean(navigator.credentials)&&navigator.credentials.preventSilentAccess(),Q.c.getInstance().sendEvent("log_out"),t.result&&(window.location.href=e.url)})),!0}i18n(t,...e){return this._i18n.format(t,...e)}checkAccessUserActions(t=!0){return this.isUserAuthorized||it.initParams.experimentRegOnComment?this.isLostAccount?(t&&this.ui.toasts.showWarningMessage(f.ZF.LOST_ACCOUNT),!1):this.isUserBanned?(t&&this.ui.toasts.showWarningMessage(f.ZF.BANNED),!1):this.isFullyBanned?(t&&this.ui.toasts.showWarningMessage(f.ZF.FULLY_BANNED),!1):(!this.isUserAuthorized&&it.initParams.experimentRegOnComment,!0):(t&&this.ui.authRequired(),!1)}checkUserAuth(t=!0){return!!this.isUserAuthorized||(t&&this.ui.authRequired(),!1)}icon(t,...e){return(0,H.q)(t,...e)}_refreshSession(){setInterval((()=>{if(!Y.E.isShown)return;const t={};"/"===this.history.pathname&&(t.hot=!0),V.cf.get("/ajax/refresh_session.php",t)}),12e5)}_autoReloadAfterLogout(){this.bc.addCommand("logout",(()=>{A.instance.location.reload()}))}get ua(){return et}get history(){return this._history}get logger(){return this._logger}get storage(){return this._storage}static get instance(){return st}get initParams(){return this._initParams}get routerDispatch(){return this._routerDispatch?this._routerDispatch:this._routerDispatch=this._router.routers()}get deviceType(){return this._deviceType?this._deviceType:this._deviceType=this.ua.tablet?f.me.TABLET:this.ua.mobile?f.me.MOBILE:f.me.DESKTOP}get applicationType(){if(this._applicationType)return this._applicationType;const t=(this.config("applicationType")||"").toUpperCase();return this._applicationType=(0,Z.i)(f.Zq,t)||f.Zq.DESKTOP}get isMobileApp(){return it.applicationType===f.Zq.MOBILE}get isDesktopApp(){return it.applicationType===f.Zq.DESKTOP}get environment(){return f.Gv.hasOwnProperty(this.initParams.environment)?this.initParams.environment:f.Gv.PRODUCTION}get userRating(){return parseInt(String(this.initParams.userKarma),10)}get isUserAuthorized(){return this.initParams.userID>0&&!this.initParams.isDeleted}get isUserBanned(){return Boolean(this.initParams.isUserBanned)}get isFullyBanned(){return Boolean(this.initParams.isFullyBanned)}get isLostAccount(){return Boolean(this.initParams.isLostAccount)}get isUserModerator(){return Boolean(this.initParams.isUserModerator)}get isInternalStaff(){return Boolean(this.initParams.isInternalStaff)}get searchParams(){return m.warn("history","use deprecated method core.searchParams, please use core.history.searchParams"),this.history.searchParams}get location(){return m.warn("history","use deprecated method core.location, please use core.history.location"),A.location}get adblock(){return this._adblock}get uuid(){return this._uuid}get bc(){return this._bc?this._bc:this._bc=new X}get ws(){return this._ws?this._ws:this._ws=it.ua.ios?new z:new G}get sw(){let t=this._sw;return t||(t=this._sw=new R(this.initParams.swUrl,this.initParams.swVersion,this.initParams.csrfToken)),t}}it=new nt},2906:(t,e,s)=>{"use strict";s.d(e,{u$:()=>n,Lo:()=>r,qg:()=>l});s(6992),s(3948);var i=s(6777);s(8225);let n;!function(t){t.ADD="dataSetAdd",t.UPDATE="dataSetUpdate",t.REMOVE="dataRemove",t.CHANGE="dataChange",t.DESTROY="dataDestroy",t.SORT="dataSetSort",t.SAVE_SNAPSHOT="dataSaveSnapshot"}(n||(n={}));const o=s(6419);class r extends i.vp{constructor(t,e=!0,s){var i,n,r,a,l;super(),s&&(this.fieldId=s),this._data=this._createData(t),e&&(this._proxy=(i=this._data,n=this._onChangeData,r=this,a="",l=i,Proxy.revocable(l,{set(t,e,s){if(!(e in t))throw new TypeError("Can't add property create, object is not extensible. Use DataObject.defaults");let i=t[e];return t[e]=s,n.call(r,a+e,s,i),!0},get:(t,e)=>t[e],deleteProperty(t,e){throw new TypeError(`Cannot delete property '${e}' of #<Object>. Use \`${e} = void 0;\``)},defineProperty(){throw new TypeError("Can't add property, object is not extensible. Use DataObject.prototype.defaults")}}))),this._id=o.uniqueId("data-object"),this._marks=void 0,this._snapshots=void 0}hasSnapshot(t){return this._snapshots&&this._snapshots.has(t)}save(t){this._snapshots||(this._snapshots=new Map),this._snapshots.has(t)&&this._snapshots.delete(t);let e=Object.freeze(Object.assign({},this._data));this._snapshots.set(t,e),this.emit(n.SAVE_SNAPSHOT,t,e)}diff(t){if(!this._snapshots||!this._snapshots.has(t))return o.map(this._data,((t,e)=>({property:e,type:"add",value:t})));let e=this._data,s=this._snapshots.get(t),i=new Set(Object.keys(s)),n=[];o.forEach(e,((t,e)=>{s.hasOwnProperty(e)?t!==s[e]&&n.push({property:e,type:"set",value:t}):n.push({property:e,type:"add",value:t}),i.delete(e)}));for(let o of i)n.push({property:o,type:"remove"});return n}_onChangeData(t,e,s){e!==s&&(this.emit(n.CHANGE,this,{[t]:s}),this.emit(t,this,e,s))}_createData(t){return Object.assign(this.fieldId?{[this.fieldId]:void 0}:{},this.defaults||{},t||{})}destroy(t=!1){this.isDestroyed||(this.__destroyed=!0,t||this.emit(n.DESTROY,this),this._proxy&&(this._proxy.revoke(),delete this._proxy.proxy,delete this._proxy),delete this._data,this._marks&&(this._marks.clear(),delete this._marks),this.stopListening(),this.off())}update(t,e=!1,s=!0){let i=!1;return o.forEach(t,((t,s)=>{let n=this._data[s];n!==t&&(i||(i={}),i[s]=n,this._data[s]=t,e||this.emit(s,this,t,n))})),s||o.forEach(this._data,((s,n)=>{if(o.isUndefined(t[n])){let t=this._data[n];i||(i={}),i[n]=t,this._data[n]=void 0,e||this.emit(n,this,void 0,t)}})),i&&!e&&this.emit(n.CHANGE,this,i),i}get isDestroyed(){return this.__destroyed}get data(){return this._proxy?this._proxy.proxy:this._data}get plainData(){return this._data}get marks(){return this._marks||(this._marks=new Map),this._marks}get id(){let t=this.data[this.fieldId||"id"];return o.isUndefined(t)?this._id:t}}r.prototype.fieldId=void 0,r.prototype.defaults=void 0;s(2707);const a=s(6419);class l extends i.vp{constructor(t=!1,e){super(),this._id=a.uniqueId("dataset"),this._options={items:[],useCacheIds:t},t&&(this._options.ids=[]),e?this.DataObject=e:void 0===e&&(this.DataObject=r)}add(t,e={silent:!1}){return this.set(t,a.defaults(e,{merge:!0}))}set(t,e={silent:!1,merge:!1,destroy:!0,uniq:!1}){let s,o,r=this.items,h=[],c=[],d=this.DataObject;return a.isArray(t)||(t=[t]),t.length||e.merge?(e.uniq&&(t=a.uniq(t,!1,(t=>t&&this.getIdFromData(t)))),t.length&&t.forEach((t=>{if(!a.isObject(t))return;if(r.includes(t))return void c.push(t);let s=this.getIdFromData(t);this.hasById(s)?c.push(this.get(s)):(!d||t instanceof this.DataObject||(t=this.prepareData(t)))&&(t instanceof i.vp&&(this.listenTo(t,n.DESTROY,this._onDestroyData),this.listenTo(t,n.CHANGE,((t,e)=>this.emit(n.CHANGE,t,e)))),h.push(t),c.push(t),e.silent||this.emit(n.ADD,this,t))})),s=r.filter((t=>!c.includes(t))),s.length&&(e.merge?(c=s.concat(c),s=void 0):this._remove(s,e)),this._options.items=c,this._options.ids&&(this._options.ids=c.map((t=>this.getIdFromData(t)))),o=l.prepareDelta(h,s),e.silent||this.emit(n.UPDATE,this,o),o):this.clear()}_onDestroyData(t){this.emit(n.UPDATE,this,l.prepareDelta(null,this._removeOne(t,{silent:!1})))}prepareData(t){if(t instanceof r)return t;if(this.DataObject){let e=a.isUndefined(this.fieldId)||this.DataObject.prototype.fieldId?void 0:this.fieldId;return t=new this.DataObject(t,!0,e)}}getIdFromData(t){if(t instanceof r)return t.id;let e=this.DataObject&&this.DataObject.prototype.fieldId||this.fieldId||"id";return e&&t[e]}static prepareDelta(t,e){let s,i={};return t&&t.length&&(s=i.inserted=t),e&&e.length&&(s=i.removed=e),s?i:null}remove(t,e={silent:!1,destroy:!0}){if(t===this.items||t===this.ids)return this.clear(e);let s;return s=a.isArray(t)?l.prepareDelta(null,this._remove(t,e)):l.prepareDelta(null,this._removeOne(t)),this.emit(n.UPDATE,this,s),s}_removeOne(t,e){let s,o,r=[],l=this.items,h=l.indexOf(t);return-1===h?(s=this.get(t),h=l.indexOf(s)):s=t,h>-1&&(r=l.splice(h,1),this.useCacheIds&&(o=this.getIdFromData(s),this._options.ids=a.without(this._options.ids,o)),s instanceof i.vp&&(e&&e.silent||s.emit(n.REMOVE,s),this.stopListening(s)),e&&e.destroy&&a.isFunction(s.destroy)&&s.destroy()),r}_remove(t,e={silent:!1,destroy:!0}){let s,o=[],r=this.items,l=this.useCacheIds;l&&(s=[]);for(let h,c,d=0,u=t.length;d<u;d++)h=t[d],c=r.indexOf(h),-1===c&&(h=this.get(h),c=r.indexOf(h)),c>-1&&(l&&s.push(this.getIdFromData(h)),o.push(t),r.splice(c,1),h instanceof i.vp&&(e&&e.silent||h.emit(n.REMOVE,h),this.stopListening(h)),e&&e.destroy&&a.isFunction(h.destroy)&&h.destroy());return o.length?(l&&(this._options.ids=a.without(this._options.ids,...s)),o):null}get(t){let e=this.items;for(let s,i=0,n=e.length;i<n;i++)if(s=e[i],s===t||this.getIdFromData(s)===t)return s;return null}getMultiple(t){if(a.isArray(t))return t.map((t=>this.get(t)))}has(t){if(a.isUndefined(t))return!1;let e=this.items;if(e.includes(t))return!0;if(a.isObject(t)){let e=this.getIdFromData(t);if(a.isUndefined(e))return!1;t=e}if(this.useCacheIds&&this.ids.includes(t))return!0;for(let s,i=0,n=e.length;i<n;i++)if(s=e[i],this.getIdFromData(s)===t)return!0;return!1}hasById(t){return!a.isUndefined(t)&&(this.useCacheIds?this._options.ids.includes(t):this.has(t))}findIndex(t,e){return a.findIndex(this.items,t,e)}firstId(){if(this.size)return this._options.ids?this._options.ids[0]:this.getIdFromData(this.items[0])}lastId(){if(this.size)return this._options.ids?a.last(this._options.ids):this.getIdFromData(this.items[this.size-1])}swapIndex(t,e){let s=this.items.length;if(t<0||t>s||e<0||s<e)return!1;this.items[t]=this.items.splice(e,1,this.items[t])[0],this._options.ids&&(this.ids[t]=this.ids.splice(e,1,this.ids[t])[0])}swapItem(t,e){return t=this.items[this.get(t)],e=this.items[this.get(e)],!(!t||!e)&&this.swapIndex(this.items.indexOf(t),this.items.indexOf(e))}nextItem(t){let e=this.get(t),s=this.items.indexOf(e);if(e&&-1!==s&&s!==this.size-1)return this.items[++s]}prevItem(t){let e=this.get(t),s=this.items.indexOf(e);if(e&&-1!==s&&0!==s)return this.items[--s]}nextId(t){if(a.isUndefined(t))return;if(this._options.ids){let e=this._options.ids.indexOf(t);if(-1===e||e===this.size-1)return;return this._options.ids[++e]}let e=this.nextItem(t);return e?this.getIdFromData(e):void 0}prevId(t){if(a.isUndefined(t))return;if(this._options.ids){let e=this._options.ids.indexOf(t);if(-1===e||0===e)return;return this._options.ids[--e]}let e=this.prevItem(t);return e?this.getIdFromData(e):void 0}sort(t){this.items.sort(t),this._options.ids&&(this._options.ids=this.items.map((t=>this.getIdFromData(t)))),this.emit(n.SORT,this)}clear(t={silent:!1,destroy:!0}){let e,s=this.items;if(!this.size)return e=l.prepareDelta(),this.emit(n.UPDATE,this,e),e;for(let o,r=0,a=this.items.length;r<a;r++)o=s[r],o instanceof i.vp&&(t&&!t.silent&&o.emit(n.REMOVE,o),this.stopListening(o)),t.destroy&&"object"==typeof o&&"function"==typeof o.destroy&&o.destroy();return this._options.items=[],this._options.ids&&(this._options.ids=[]),e=l.prepareDelta(null,s),this.emit(n.UPDATE,this,e),e}get fieldId(){return this._options.fieldId}set fieldId(t){this._options.fieldId!==t&&(this._options.fieldId=t)}get size(){return this.items.length}get DataObject(){return this._options.DataObject}set DataObject(t){return this._options.DataObject=t}get items(){return this._options.items}get ids(){return this._options.ids}get useCacheIds(){return this._options.useCacheIds}}},9476:(t,e,s)=>{"use strict";s.d(e,{c:()=>a,a:()=>d});s(8674);var i=s(8211),n=s(2134);function o(t,e){var s=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),s.push.apply(s,i)}return s}function r(t,e,s){return e in t?Object.defineProperty(t,e,{value:s,enumerable:!0,configurable:!0,writable:!0}):t[e]=s,t}class a{static async getPreviewList(){const{response:t,data:e}=await n.cf.get(a.ajaxEndpoint,{route:"story-draft/get-list"});if(!t.result)throw i.vE.ui.toasts.showError(t.message),t.message;return e}static async checkIsDraftsLimitReached(){const{response:t,data:e}=await n.cf.get(a.ajaxEndpoint,{route:"story-draft/can-add-more"});if(!t.result)throw i.vE.ui.toasts.showError(t.message),t.message;return!(null!=e&&e.can_add_more)}static async getById(t){const{response:e,data:s}=await n.cf.get(a.ajaxEndpoint,{route:"story-draft/get-by-id",draft_id:t});if(!e.result)throw i.vE.ui.toasts.showError(e.message),e.message;return s}static async checkHasDraft(){var t;const{response:e,data:s}=await n.cf.post(a.draftEndpoint,{action:"load_draft"});return e.result||i.vE.ui.toasts.showError(e.message),(null===(t=s.blocks)||void 0===t?void 0:t.length)>0}static async getLastPageId(){const{response:t,data:e}=await n.cf.get(a.draftEndpoint,{action:"get_last_page_id"});return t.result?e.id:(i.vE.ui.toasts.showError(t.message),null)}static async generateLastEditorId(){const{response:t,data:e}=await n.cf.get(a.draftEndpoint,{action:"set_last_editor_id"});return t.result?e.id:(console.error(t.message),null)}static async saveDraft(t,e){const s={};"overwrite_oldest"===e?s.overwrite_oldest_draft=1:s.id=e;const{response:l,data:h}=await n.cf.post(a.ajaxEndpoint,function(t){for(var e=1;e<arguments.length;e++){var s=null!=arguments[e]?arguments[e]:{};e%2?o(Object(s),!0).forEach((function(e){r(t,e,s[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(s)):o(Object(s)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(s,e))}))}return t}({route:"story-draft/save",data:JSON.stringify(t),parent_story_id:t.parent_story_id},s));if(!l.result)throw i.vE.ui.toasts.showError(l.message),l.message;return h.draft_id}static async deleteDraft(t){const{response:e}=await n.cf.post(a.ajaxEndpoint,{route:"story-draft/delete",draft_id:t});if(!e.result)throw i.vE.ui.toasts.showError(e.message),e.message}}r(a,"draftEndpoint","/ajax/gtpost_actions.php"),r(a,"ajaxEndpoint","/ajax.php");var l=s(7025),h=s(150),c=s(6349);class d{static async show({analyticsType:t}={}){return t&&c.cp.getInstance().sendEvent("tip_show",{type:t}),await l.nk.confirmModal({content:"Вы создали максимальное количество черновиков. Самый старый из них будет удален. Продолжить?",buttons:[["modal.continue",h.j.SUCCESS,!0],["modal.cancel",h.j.DANGER,!1]]})}}},1460:(t,e,s)=>{"use strict";s.d(e,{x:()=>n});s(6992),s(3948),s(1817);var i=s(8859);class n{constructor(t){let e=0;for(let s of Object.keys(t)){let n=t[s],o=new i.T(s,n,e++);Object.defineProperty(this,s,{value:o,configurable:!1,writable:!1,enumerable:!0}),s!==n&&Object.defineProperty(this,n,{value:o,configurable:!1,writable:!1,enumerable:!1})}Object.freeze(this)}keys(){return Object.keys(this)}values(){return this.keys().map((t=>this[t].valueOf()))}entries(){return this.keys().map((t=>this[t]))}has(t,e=!1){return!(!t||"function"!=typeof t.toString)&&this.hasOwnProperty(e?t.toString().toUpperCase():t.toString())}[Symbol.iterator](){let t=this.keys().map((t=>this[t]))||[],e={next:()=>{let e=t.shift();return{done:void 0===e,value:e}}};return e[Symbol.iterator]=()=>e,e}static create(t){return new n(t)}}},7892:(t,e,s)=>{"use strict";s.d(e,{xs:()=>n.x,pt:()=>o,Tf:()=>i.T});var i=s(8859),n=s(1460);class o{static header(t){return t instanceof i.T?["span",{style:"font-weight: bold;"},t.toString()]:null}static hasBody(t){return!1}static body(t){return["span",{},t.valueOf()]}}},8859:(t,e,s)=>{"use strict";s.d(e,{T:()=>i});class i{constructor(t,e,s){Object.defineProperty(this,"_name",{value:t,configurable:!1,writable:!1,enumerable:!1}),void 0!==e&&Object.defineProperty(this,"_value",{value:e,configurable:!1,writable:!1,enumerable:!1}),void 0!==s&&Object.defineProperty(this,"_index",{value:s,configurable:!1,writable:!1,enumerable:!1}),Object.freeze(this)}get name(){return this._name}get value(){return this._value}get index(){return this._index}toString(){return this._name}valueOf(){return this._value}toJSON(){return this.toString()}}},7591:(t,e,s)=>{"use strict";let i,n,o,r,a;s.d(e,{Zq:()=>n,me:()=>o,Gv:()=>r,ZF:()=>a}),function(t){t.FRAME="frame",t.MARK="mark",t.MEASURE="measure",t.NAVIGATION="navigation",t.RESOURCE="resource",t.SERVER="server"}(i||(i={})),function(t){t.UNIVERSAL="universal",t.MOBILE="mobile",t.DESKTOP="desktop",t.APP_404="app-404",t.AMP="amp"}(n||(n={})),function(t){t[t.DESKTOP=0]="DESKTOP",t[t.MOBILE=1]="MOBILE",t[t.TABLET=2]="TABLET",t[t.SPIDER=3]="SPIDER"}(o||(o={})),function(t){t[t.PRODUCTION=225]="PRODUCTION",t[t.TESTING=226]="TESTING",t[t.LOCAL=227]="LOCAL",t[t.CI=228]="CI"}(r||(r={})),function(t){t.AUTHORIZATION_REQUIRED="AUTHORIZATION_REQUIRED",t.AUTHORIZATION_REQUIRED_NO_LINKS="AUTHORIZATION_REQUIRED_NO_LINKS",t.LOST_ACCOUNT="LOST_ACCOUNT",t.BANNED="BANNED",t.NEED_MORE_RATING="NEED_MORE_RATING",t.FULLY_BANNED="FULLY_BANNED"}(a||(a={}))},7579:(t,e,s)=>{"use strict";s.d(e,{Nx:()=>Ft,SR:()=>mt,L5:()=>At,sq:()=>Mt,JX:()=>lt});s(6992),s(3948),s(8674),s(1817);var i=s(8211),n=s(7591),o=s(1490),r=s(9050);function a(t){var e,i="",n=r.escape;Array.prototype.join;const o=s(8211).vE;return i+='\n\n<div class="evaluation__content rate-with-reasons-evaluation-step">\n\t<h3 class="evaluation__title">'+n(t.reasons.title)+'</h3>\n\t<div class="evaluation-emoji evaluation__emoji">\n\t\t<ul class="evaluation-emoji__list">\n\t\t\t',t.emojiList.forEach((function(t){i+='\n\t\t\t\t<li class="evaluation-emoji__item hint hint_top" data-type="'+n(t.type)+'" aria-label="'+n(t.title)+'">\n\t\t\t\t\t<span class="evaluation-emoji__icon evaluation-emoji__icon_sm">'+(null==(e=t.icon)?"":e)+'</span>\n\t\t\t\t\t<span class="evaluation-emoji__title evaluation-emoji__title_framed">'+n(t.title)+"</span>\n\t\t\t\t</li>\n\t\t\t"})),i+='\n\t\t</ul>\n\t</div>\n\t<div class="evaluation__btn-group evaluation__btn-group_full-width">\n\t\t<button data-role="cancel">'+n(o.i18n("evaluation.btns.close"))+"</button>\n\t</div>\n</div>\n"}var l=s(9050);function h(t){var e="",i=l.escape;Array.prototype.join;const n=s(8211).vE;return e+='\n\n<div class="evaluation__content final-thanks-evaluation-step">\n\t<div class="evaluation__thumbs-icon">\n\t\t<svg xmlns="http://www.w3.org/2000/svg" class="icon icon--ui__cookie-thumbs-up"><use xlink:href="#icon--ui__cookie-thumbs-up"></use></svg>\n\t</div>\n\t<h3 class="evaluation__title evaluation__title_center">'+i(n.i18n("evaluation.gratitude.title"))+'</h3>\n\t<div class="evaluation__btn-group evaluation__btn-group_full-width">\n\t\t<button data-role="cancel">'+i(n.i18n("evaluation.btns.close"))+"</button>\n\t</div>\n</div>\n"}var c=s(1014),d=s(8799),u=s(2822),p=s(6572);function m(t,e){var s=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),s.push.apply(s,i)}return s}function _(t){for(var e=1;e<arguments.length;e++){var s=null!=arguments[e]?arguments[e]:{};e%2?m(Object(s),!0).forEach((function(e){g(t,e,s[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(s)):m(Object(s)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(s,e))}))}return t}function g(t,e,s){return e in t?Object.defineProperty(t,e,{value:s,enumerable:!0,configurable:!0,writable:!0}):t[e]=s,t}class v{constructor(){g(this,"send",(()=>{let t=Promise.resolve();return e=>t=(async({evaluationType:e,type:s,event:i,segment:n,data:o={}})=>{await t;try{window.anl.sendEvent(i,u.c.excludeEmptyParams(_(_({},o),{},{"type!undefined":s,content_type:"survey_"+e,"level!empty":n,create_at:Date.now()})))}catch(r){console.log("Can't send analytics event, ",r)}return p.cQ.delay(50)})(e)})())}static getInstance(){return v.instance||(v.instance=new v)}}var f=s(9415);const y="evaluation",b={container:y,content:"evaluation__content",hidden:"evaluation__hidden",list:"evaluation__list",btnGroup:"evaluation__btn-group",form:"evaluation__form",formTitle:"evaluation__form-title",link:"evaluation__link",actionBtn:'button[data-role="next"]',cancelBtn:'button[data-role="cancel"]',closeBtn:"evaluation__close",closeBtnInline:"evaluation__close_inline",emoji:{container:"evaluation-emoji"}};function w(t,e,s){return e in t?Object.defineProperty(t,e,{value:s,enumerable:!0,configurable:!0,writable:!0}):t[e]=s,t}const E="cancel",S="next-step",C="hide-element",T="append-element",O="log-action";class k{constructor({getTemplate:t,asModalMenu:e=!1,autoCloseTS:s=0}){w(this,"autoCloseMS",0),w(this,"els",{}),w(this,"emitter",new c.v),w(this,"evaluation",null),w(this,"autoCloseTimer",null),this.getTemplate=t,this.asModalMenu=e,this.autoCloseMS=s}getContent(t){return this.content||(this.content=this.initTemplate(t),this.initEls(),this.initEventListeners(),this.autoCloseMS>0&&(this.autoCloseTimer=setTimeout((()=>this.emitCancel()),this.autoCloseMS))),this.content}subscribe(t,e){return this.emitter.on(t,e),this}destroy(){this.autoCloseTimer&&clearTimeout(this.autoCloseTimer),this.emitter.destroy()}onMounted(t){this.evaluation=t;const e=this.evaluation.getContainer();return f.v&&!k.intersectionObserver&&e&&(k.intersectionObserver=new IntersectionObserver((t=>{var s;t.some((t=>t.isIntersecting))&&(this.sendAnalytics("form_show"),null===(s=k.intersectionObserver)||void 0===s||s.unobserve(e))}),{rootMargin:"20px",threshold:0}),k.intersectionObserver.observe(e)),this}sendAnalytics(t,e,s={}){this.evaluation&&v.getInstance().send({event:t,evaluationType:this.evaluation.getType(),segment:this.evaluation.getSegment(),type:e,data:s})}emitCancel(){this.emitter.emit(E)}emitNextStep(t){this.emitter.emit(S,t)}emitAction(t){this.emitter.emit(O,t)}initTemplate(t){return d.Zv.fragment(this.getTemplate(t))}initEls(){this.content&&(this.els.cancelBtn=this.content.querySelector(b.cancelBtn),this.els.actionBtn=this.content.querySelector(b.actionBtn))}initEventListeners(){var t,e;null===(t=this.els.cancelBtn)||void 0===t||t.addEventListener("click",(()=>{this.emitter.emit(E)})),null===(e=this.els.actionBtn)||void 0===e||e.addEventListener("click",(()=>{this.emitter.emit(S)}))}}w(k,"intersectionObserver",null);var I=s(4877),$=s(9755),A=s.n($);function x(t,e,s){return e in t?Object.defineProperty(t,e,{value:s,enumerable:!0,configurable:!0,writable:!0}):t[e]=s,t}const D="emoji-selected";class P extends I.u{constructor(...t){super(...t),x(this,"activeEmoji",null),x(this,"listElement",null),x(this,"itemsNodeList",null)}render(){return this.isRendered||(this.initEls(),this.initEventListeners(),super.render()),this}initEls(){this.el&&(this.listElement=this.el.querySelector(".evaluation-emoji__list"),this.itemsNodeList=this.el.querySelectorAll(".evaluation-emoji__item"))}initEventListeners(){var t;null===(t=this.listElement)||void 0===t||t.addEventListener("click",(t=>{var e;t.preventDefault();const s=null===(e=t.target)||void 0===e?void 0:e.closest("li");if(s&&this.activeEmoji!==s&&(this._options.reselectable||!this.activeEmoji)){var i,n;if(this._options.activateItems)null===(i=this.activeEmoji)||void 0===i||i.classList.remove("evaluation-emoji__item_active"),this.activeEmoji=s,this.activeEmoji.classList.add("evaluation-emoji__item_active"),null===(n=this.itemsNodeList)||void 0===n||n.forEach((t=>{var e;null===(e=A()(t).data("hint"))||void 0===e||e.hide(),t.classList.remove("hint")}));this.emit(D,s.dataset.type||"")}}))}}var R=s(2134);function M(t,e){var s=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),s.push.apply(s,i)}return s}function N(t,e,s){return e in t?Object.defineProperty(t,e,{value:s,enumerable:!0,configurable:!0,writable:!0}):t[e]=s,t}const B={status:!1};class L{static async evaluate({type:t,responseType:e,storyId:s,description:i,reasons:n}){const o={survey_type:t,response_type:e};s&&(o.story_id=s),"rate"===e||"comment"===e?o.description=i:o.reasons=n;const{response:r}=await R.cf.post("/ajax.php",function(t){for(var e=1;e<arguments.length;e++){var s=null!=arguments[e]?arguments[e]:{};e%2?M(Object(s),!0).forEach((function(e){N(t,e,s[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(s)):M(Object(s)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(s,e))}))}return t}({route:"csat/log"},o));if(!r.result)throw new Error(r.message)}}N(L,"checkShowStatus",(()=>{let t=B,e=Promise.resolve(t);return s=>e=(async s=>{if(t=await e,L.evaluationShown)return Promise.resolve(B);const{data:i}=await R.cf.get("/ajax.php",{route:"csat/register",type:s});return i?(L.evaluationShown=i.status,i):B})(s)})()),N(L,"evaluationShown",!1);var F=s(7025),U=s(7111),j=s(9738),V=s(984),H=s(9377);const q=async(t,e=(()=>Promise.resolve()),s=2,i=30*V.vL)=>{var n;if(!t)return Promise.resolve();const o=null!==(n=H.x.get(t))&&void 0!==n?n:{count:0};var r;return r={count:1+o.count},H.x.set(t,r,!0),0===o.count?(async()=>{await p.cQ.delay(i),await e()})():o.count>=s?e():void 0};function W(t,e){var s=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),s.push.apply(s,i)}return s}function G(t){for(var e=1;e<arguments.length;e++){var s=null!=arguments[e]?arguments[e]:{};e%2?W(Object(s),!0).forEach((function(e){Y(t,e,s[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(s)):W(Object(s)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(s,e))}))}return t}function Y(t,e,s){return e in t?Object.defineProperty(t,e,{value:s,enumerable:!0,configurable:!0,writable:!0}):t[e]=s,t}const z="pkb_evts",Z=30*V.mf;class K extends I.u{constructor(...t){super(...t),Y(this,"type","visit"),Y(this,"state",{}),Y(this,"container",null),Y(this,"modal",null),Y(this,"segment",null),Y(this,"nextStep",(()=>{this.container&&this.containerSelector&&this.currentStep?this.setContainerContent(this.currentStep.getContent(this.state)):this.initModalStep(),this.initStepControllerSubscriptions()})),Y(this,"hanldeNextStepEvent",(t=>{const e=this.getCurrentStepIndex(),s=e+1;this.container&&this.modal&&this.modal.hide(),t&&(this.state=G(G({},this.state),t)),this.STEPS[e].destroy(),this.setCurrentStep(s),this.nextStep()})),Y(this,"handleHideElement",(t=>{var e,s;null===(e=this.container)||void 0===e||null===(s=e.querySelector(t))||void 0===s||s.classList.add(b.hidden)})),Y(this,"handleAppendElement",(t=>{var e,s;null===(e=this.container)||void 0===e||null===(s=e.querySelector("."+b.content))||void 0===s||s.append(t)})),Y(this,"handleLogAction",(({responseType:t,description:e,storyId:s,reasons:i})=>{L.evaluate({type:this.type,responseType:t,description:e,reasons:i,storyId:s})})),Y(this,"cancelEvaluation",(()=>{var t;this.modal&&this.modal.hide(),null===(t=this.currentStep)||void 0===t||t.destroy()}))}init(t){this.isRendered||(t&&(this.type=t),this.renderWhenReady())}async renderWhenReady(){await(async(t=2e3)=>{if(p.cQ.isInput(document.activeElement)){for(;await p.cQ.delay(100),p.cQ.isInput(document.activeElement););t&&await p.cQ.delay(t)}})(),this.setCurrentStep(0),this.initContainer(),this.nextStep(),this.render(),this.setLSShownTS()}getType(){return this.type}getContainer(){return this.container}getState(){return this.state}getSegment(){return this.segment}setCurrentStep(t){this.currentStep=this.STEPS[t]}getCurrentStepIndex(){return this.currentStep?this.STEPS.indexOf(this.currentStep):this.STEPS.length}initStepControllerSubscriptions(){this.currentStep&&this.currentStep.subscribe(E,this.cancelEvaluation).subscribe(S,this.hanldeNextStepEvent).subscribe(C,this.handleHideElement).subscribe(T,this.handleAppendElement).subscribe(O,this.handleLogAction)}async shouldBeShown(){const{status:t,segment:e}=await L.checkShowStatus(this.type);return void 0!==e&&(this.segment=e),t}wasAlreadyShown(){const t=this.getShownEvaluations();return!(!(0,j.K)(t)||!t[this.type])&&Date.now()-t[this.type]<Z}setLSShownTS(){U.m.set(z,G(G({},this.getShownEvaluations()),{[this.type]:Date.now()}))}getShownEvaluations(){var t;return null!==(t=U.m.get(z))&&void 0!==t?t:{}}initModalStep(){this.currentStep&&(this.modal=new F.LD({destroyAfterHide:!0,hideOverlay:!this.currentStep.asModalMenu,content:this.currentStep.getContent(this.state),isBlockOverflowTouch:!1,isModalMenu:this.currentStep.asModalMenu,isPageScrollable:!1,isBottomWidget:!this.currentStep.asModalMenu}),this.modal.show(),this.modal.content.addClass("popup__content_scrollable"),this.container=this.modal.content[0],this.currentStep.onMounted(this),i.vE.ui.isPageScrollable=!this.currentStep.asModalMenu)}initContainer(){var t;!this.container&&this.containerSelector&&(this.container=document.createElement("div"),this.container.classList.add(b.container),null===(t=document.querySelector(this.containerSelector))||void 0===t||t.append(this.container))}setContainerContent(t){var e,s,i,n;0===(null===(e=this.container)||void 0===e?void 0:e.children.length)?this.container.append(t):null===(i=this.container)||void 0===i||i.replaceChild(t,null===(n=this.container)||void 0===n?void 0:n.children[0]);null===(s=this.currentStep)||void 0===s||s.onMounted(this)}}var X=s(8245);let Q;!function(t){t[t.AWFUL=1]="AWFUL",t[t.BAD=2]="BAD",t[t.NORMAL=3]="NORMAL",t[t.GOOD=4]="GOOD",t[t.EXCELLENT=5]="EXCELLENT"}(Q||(Q={}));var J=s(9050);function tt(t,e){var s=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),s.push.apply(s,i)}return s}function et(t){for(var e=1;e<arguments.length;e++){var s=null!=arguments[e]?arguments[e]:{};e%2?tt(Object(s),!0).forEach((function(e){st(t,e,s[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(s)):tt(Object(s)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(s,e))}))}return t}function st(t,e,s){return e in t?Object.defineProperty(t,e,{value:s,enumerable:!0,configurable:!0,writable:!0}):t[e]=s,t}class it extends k{constructor(...t){super(...t),st(this,"templateData",{emojiList:[{type:Q.AWFUL,icon:i.vE.icon("ui__persevering-face"),title:"Ужасно"},{type:Q.BAD,icon:i.vE.icon("ui__sad-face"),title:"Плохо"},{type:Q.NORMAL,icon:i.vE.icon("ui__neutral-face"),title:"Нормально"},{type:Q.GOOD,icon:i.vE.icon("ui__smiley-face"),title:"Хорошо"},{type:Q.EXCELLENT,icon:i.vE.icon("ui__happy-face"),title:"Отлично"}],reasons:{title:"",options:[]},formTitle:"",showComment:!1}),st(this,"formEl",null),st(this,"onRated",(t=>{var e;if(void 0!==this.rate)return;const s=null===(e=this.evaluation)||void 0===e?void 0:e.getState();this.rate=t,this.emitAction(et({responseType:"rate",description:this.rate},null==s?void 0:s.logData)),this.sendAnalytics("form_rate",this.rate,null==s?void 0:s.analyticsData),this.templateData.reasons.options.length>0?(this.templateData.showComment=this.rate!==String(Q.EXCELLENT),this.initForm()):setTimeout((()=>{this.emitNextStep()}),500)})),st(this,"onFormChange",(()=>{var t;const e=this.form.serialize().check;var s,i,n;e?null===(s=this.els.actionBtn)||void 0===s||s.removeAttribute("disabled"):null===(i=this.els.actionBtn)||void 0===i||i.setAttribute("disabled","disabled");(null===(t=this.selectedChecboxValues)||void 0===t?void 0:t.length)!==(null==e?void 0:e.length)&&this.sendAnalytics("form_interact","click_reason",null===(n=this.evaluation)||void 0===n?void 0:n.getState().analyticsData);this.selectedChecboxValues=e})),st(this,"onFormNextClick",(()=>{var t;const{comment:e,check:s}=this.form.serialize();let i="";var n,o;e&&(this.sendAnalytics("form_interact","send_comment",null===(n=this.evaluation)||void 0===n?void 0:n.getState().analyticsData),this.emitAction(et({responseType:"comment",description:e},null===(o=this.evaluation)||void 0===o?void 0:o.getState().logData)));if(Array.isArray(s))s.forEach((t=>{var e;this.sendAnalytics("form_rate",t,null===(e=this.evaluation)||void 0===e?void 0:e.getState().analyticsData)})),i=s.join(",");else if("string"==typeof s){var r;this.sendAnalytics("form_rate",s,null===(r=this.evaluation)||void 0===r?void 0:r.getState().analyticsData),i=s}this.emitAction(et({responseType:"reason",reasons:i},null===(t=this.evaluation)||void 0===t?void 0:t.getState().logData)),this.emitNextStep()}))}setTitle(t){return this.templateData.reasons.title=t,this}setReasons(t){return this.templateData.reasons.options=t,this}setFormTitle(t){return this.templateData.formTitle=t,this}initTemplate(){const t=super.initTemplate(this.templateData);return new P({el:t.querySelector("."+b.emoji.container),activateItems:!0,reselectable:!1}).render().on(D,this.onRated),t}initEventListeners(){var t,e;null===(t=this.els.cancelBtn)||void 0===t||t.addEventListener("click",(()=>{var t;this.sendAnalytics("form_interact","close_init",null===(t=this.evaluation)||void 0===t?void 0:t.getState().analyticsData),this.emitCancel()})),null===(e=this.els.actionBtn)||void 0===e||e.addEventListener("click",(()=>{var t;this.sendAnalytics("form_interact","click_init_rate",null===(t=this.evaluation)||void 0===t?void 0:t.getState().analyticsData),this.emitNextStep()}))}initForm(){if(this.form)return;const t=X.S.getInstance().get("UIForm"),e=document.createElement("div");e.innerHTML=function(t){var e="",i=J.escape;Array.prototype.join;const n=s(8211).vE;return e+='\n\n<div class="evaluation__form">\n\t<hr>\n\t<div class="evaluation__form-title">'+i(t.formTitle)+'</div>\n\t<form>\n\t\t<div class="evaluation__form-checkboxes">\n\t\t\t',t.reasons.options.forEach((function(t){e+='\n\t\t\t\t<p><label class="evaluation__form-label"><input type="checkbox" value="'+i(t)+'" name="check"> <span>'+i(t)+"</span></label></p>\n\t\t\t"})),e+="\n\t\t</div>\n\t\t",t.showComment&&(e+='\n\t\t\t<section class="input input_editor evaluation__input evaluation__input_sm">\n\t\t\t\t<textarea\n\t\t\t\t\tclass="input__input"\n\t\t\t\t\trows="1"\n\t\t\t\t\tname="comment"\n\t\t\t\t\tmaxlength="500"\n\t\t\t\t\tplaceholder="'+i(n.i18n("evaluation.functionalComfort.form.placeholder"))+'"></textarea>\n\t\t\t</section>\n\t\t'),e+='\n\t</form>\n</div>\n<div class="evaluation__btn-group evaluation__btn-group_stretch">\n\t<button disabled="disabled" data-role="next" class="button_success">'+i(n.i18n("evaluation.btns.send"))+'</button>\n\t<button data-role="cancel">'+i(n.i18n("evaluation.btns.close"))+"</button>\n</div>"}(this.templateData),this.emitter.emit(C,"."+b.btnGroup),this.emitter.emit(T,e),this.formEl=e.querySelector("."+b.form),this.form=new t(this.formEl),this.els.actionBtn=e.querySelector(b.actionBtn),this.els.cancelBtn=e.querySelector(b.cancelBtn),this.initFormListeners(e)}initFormListeners(t){var e,s,i;this.form.on("submit",(t=>t.preventDefault())),this.form.on("change",this.onFormChange),null===(e=this.els.actionBtn)||void 0===e||e.addEventListener("click",this.onFormNextClick),null===(s=this.els.cancelBtn)||void 0===s||s.addEventListener("click",(()=>{var t;this.sendAnalytics("form_interact","close_reasons",null===(t=this.evaluation)||void 0===t?void 0:t.getState().analyticsData),this.emitCancel()})),null===(i=t.querySelector(".input__input"))||void 0===i||i.addEventListener("focus",(()=>{var t;this.sendAnalytics("form_interact","click_comment_input",null===(t=this.evaluation)||void 0===t?void 0:t.getState().analyticsData)}))}}class nt extends k{initEventListeners(){var t;null===(t=this.els.cancelBtn)||void 0===t||t.addEventListener("click",(()=>{var t;this.sendAnalytics("form_interact","close_thank",null===(t=this.evaluation)||void 0===t?void 0:t.getState().analyticsData),this.emitCancel()}))}}var ot=s(762);function rt(t,e,s){return e in t?Object.defineProperty(t,e,{value:s,enumerable:!0,configurable:!0,writable:!0}):t[e]=s,t}const at=12e4;class lt extends K{constructor(...t){super(...t),rt(this,"STEPS",[]),rt(this,"type","visit"),rt(this,"storiesViewedCount",0),rt(this,"isUserPresenceLongEnough",!1),rt(this,"initTimer",null),rt(this,"storageViewedSubscriber",ot.Z),rt(this,"onStoryViewed",(()=>{this.storiesViewedCount<3?this.storiesViewedCount++:this.shouldBeInitiated()&&(this.initializeEvaluation(),this.initTimer&&clearTimeout(this.initTimer),this.initTimer=null)}))}static getInstance(){return lt.instance||(lt.instance=new lt)}init(){this.wasAlreadyShown()||(this.checkPresenceTime(),this.storageViewedSubscriber=o.N.instance.onStoryViewed(this.onStoryViewed),this.initSteps())}checkPresenceTime(){const t=H.x.get(H.q);if(!t)return H.x.set(H.q,Date.now()),void this.initShowingTimeout(at);const e=Date.now()-t;e>=at?this.isUserPresenceLongEnough=!0:this.initShowingTimeout(e)}initShowingTimeout(t){this.initTimer=setTimeout((()=>{this.isUserPresenceLongEnough=!0,this.shouldBeInitiated()&&this.initializeEvaluation()}),t)}async initializeEvaluation(){this.storageViewedSubscriber(),await this.shouldBeShown()&&super.init()}shouldBeInitiated(){return this.isUserPresenceLongEnough&&this.storiesViewedCount>=3}initSteps(){const t=new it({getTemplate:a,asModalMenu:i.vE.applicationType===n.Zq.MOBILE});t.setTitle("Насколько оцените свой визит сегодня в Пикабу?").subscribe(O,(e=>{const s=this.getReasons(Number(e.description));t.setFormTitle(s.title).setReasons(s.options)})),this.STEPS.push(t),this.STEPS.push(new nt({getTemplate:h,asModalMenu:i.vE.applicationType===n.Zq.MOBILE}))}getReasons(t){switch(t){case Q.AWFUL:case Q.BAD:case Q.NORMAL:return{title:"Чем не понравился Пикабу сегодня?",options:["Скорость загрузки или технические проблемы","Неинтересные посты","Несправедливость","Токсичность","Много рекламы","Другое"]};case Q.GOOD:return{title:"Что могло быть лучше на Пикабу сегодня?",options:["Больше оригинальных постов","Больше полезных постов","Скорость загрузки или технические проблемы","Меньше токсичность","Меньше рекламы","Другое"]};case Q.EXCELLENT:return{title:"Чем понравился Пикабу сегодня?",options:["Развлекает","Успокаивает","Информативно","Полезно","Оригинально","Дружелюбно","Другое"]};default:return{title:"",options:[]}}}}s(4916);const ht={post_publish:5,comment_publish:4,my_saved_visit:5,responses_visit:5,my_comments_visit:5,rates_visit:3,ignore_list_visit:5,subs_feed_visit:2};var ct=s(381),dt=s.n(ct);function ut(t,e,s){return e in t?Object.defineProperty(t,e,{value:s,enumerable:!0,configurable:!0,writable:!0}):t[e]=s,t}const pt="evaluation.functionalComfort.reasons.";class mt extends K{constructor(...t){super(...t),ut(this,"STEPS",[]),ut(this,"typesWithoutDelay",new Set(["post_publish","comment_publish"])),ut(this,"reasons",{post_publish:{title:i.vE.i18n(`${pt}post_publish.title`),options:[i.vE.i18n(`${pt}post_publish.options.text`),i.vE.i18n(`${pt}post_publish.options.tags`),i.vE.i18n(`${pt}post_publish.options.bayan`),i.vE.i18n(`${pt}post_publish.options.files`),i.vE.i18n(`${pt}common.other`)]},comment_publish:{title:i.vE.i18n(`${pt}comment_publish.title`),options:[i.vE.i18n(`${pt}comment_publish.options.text`),i.vE.i18n(`${pt}comment_publish.options.navigation`),i.vE.i18n(`${pt}common.other`)]},my_saved_visit:{title:i.vE.i18n(`${pt}my_saved_visit.title`),options:[i.vE.i18n(`${pt}common.search`),i.vE.i18n(`${pt}common.filter`),i.vE.i18n(`${pt}common.control`),i.vE.i18n(`${pt}common.other`)]},responses_visit:{title:i.vE.i18n(`${pt}responses_visit.title`),options:[i.vE.i18n(`${pt}responses_visit.options.source`),i.vE.i18n(`${pt}responses_visit.options.navigation`),i.vE.i18n(`${pt}responses_visit.options.status`),i.vE.i18n(`${pt}common.other`)]},my_comments_visit:{title:i.vE.i18n(`${pt}my_comments_visit.title`),options:[i.vE.i18n(`${pt}common.search`),i.vE.i18n(`${pt}common.filter`),i.vE.i18n(`${pt}my_comments_visit.options.navigation`),i.vE.i18n(`${pt}my_comments_visit.options.status`),i.vE.i18n(`${pt}common.control`),i.vE.i18n(`${pt}common.other`)]},rates_visit:{title:i.vE.i18n(`${pt}rates_visit.title`),options:[i.vE.i18n(`${pt}common.search`),i.vE.i18n(`${pt}common.filter`),i.vE.i18n(`${pt}rates_visit.options.status`),i.vE.i18n(`${pt}common.control`),i.vE.i18n(`${pt}common.other`)]},ignore_list_visit:{title:i.vE.i18n(`${pt}ignore_list_visit.title`),options:[i.vE.i18n(`${pt}common.search`),i.vE.i18n(`${pt}common.filter`),i.vE.i18n(`${pt}common.control`),i.vE.i18n(`${pt}ignore_list_visit.options.tags`),i.vE.i18n(`${pt}common.other`)]},subs_feed_visit:{title:i.vE.i18n(`${pt}subs_feed_visit.title`),options:[i.vE.i18n(`${pt}subs_feed_visit.options.status`),i.vE.i18n(`${pt}common.search`),i.vE.i18n(`${pt}common.filter`),i.vE.i18n(`${pt}subs_feed_visit.options.control`),i.vE.i18n(`${pt}common.other`)]}})}static getInstance(){return mt.instance||(mt.instance=new mt)}init(t,e={}){this.type=t,this.state.evaluationType=this.type,this.state.analyticsData=e,i.vE.isUserAuthorized&&!this.wasAlreadyShown()&&this.isFittedInQuota()&&(this.initSteps(t),this.typesWithoutDelay.has(t)?super.init(t):q(`pkb_efc_${String(this.type)}`,(async()=>{await this.shouldBeShown()&&super.init(this.state.evaluationType)})))}initSteps(t){const e=new it({getTemplate:a,asModalMenu:i.vE.applicationType===n.Zq.MOBILE});e.setTitle(this.reasons[t].title).setReasons(this.reasons[t].options).setFormTitle("С какими трудностями вы столкнулись? Что стоит улучшить?"),this.STEPS.push(e),this.STEPS.push(new nt({getTemplate:h,asModalMenu:i.vE.applicationType===n.Zq.MOBILE,autoCloseTS:3e3}))}isFittedInQuota(){const t=dt()(new Date),e=ht[this.state.evaluationType];if(!e)return!1;return(t=>{const e="00000000 77073096 EE0E612C 990951BA 076DC419 706AF48F E963A535 9E6495A3 0EDB8832 79DCB8A4 E0D5E91E 97D2D988 09B64C2B 7EB17CBD E7B82D07 90BF1D91 1DB71064 6AB020F2 F3B97148 84BE41DE 1ADAD47D 6DDDE4EB F4D4B551 83D385C7 136C9856 646BA8C0 FD62F97A 8A65C9EC 14015C4F 63066CD9 FA0F3D63 8D080DF5 3B6E20C8 4C69105E D56041E4 A2677172 3C03E4D1 4B04D447 D20D85FD A50AB56B 35B5A8FA 42B2986C DBBBC9D6 ACBCF940 32D86CE3 45DF5C75 DCD60DCF ABD13D59 26D930AC 51DE003A C8D75180 BFD06116 21B4F4B5 56B3C423 CFBA9599 B8BDA50F 2802B89E 5F058808 C60CD9B2 B10BE924 2F6F7C87 58684C11 C1611DAB B6662D3D 76DC4190 01DB7106 98D220BC EFD5102A 71B18589 06B6B51F 9FBFE4A5 E8B8D433 7807C9A2 0F00F934 9609A88E E10E9818 7F6A0DBB 086D3D2D 91646C97 E6635C01 6B6B51F4 1C6C6162 856530D8 F262004E 6C0695ED 1B01A57B 8208F4C1 F50FC457 65B0D9C6 12B7E950 8BBEB8EA FCB9887C 62DD1DDF 15DA2D49 8CD37CF3 FBD44C65 4DB26158 3AB551CE A3BC0074 D4BB30E2 4ADFA541 3DD895D7 A4D1C46D D3D6F4FB 4369E96A 346ED9FC AD678846 DA60B8D0 44042D73 33031DE5 AA0A4C5F DD0D7CC9 5005713C 270241AA BE0B1010 C90C2086 5768B525 206F85B3 B966D409 CE61E49F 5EDEF90E 29D9C998 B0D09822 C7D7A8B4 59B33D17 2EB40D81 B7BD5C3B C0BA6CAD EDB88320 9ABFB3B6 03B6E20C 74B1D29A EAD54739 9DD277AF 04DB2615 73DC1683 E3630B12 94643B84 0D6D6A3E 7A6A5AA8 E40ECF0B 9309FF9D 0A00AE27 7D079EB1 F00F9344 8708A3D2 1E01F268 6906C2FE F762575D 806567CB 196C3671 6E6B06E7 FED41B76 89D32BE0 10DA7A5A 67DD4ACC F9B9DF6F 8EBEEFF9 17B7BE43 60B08ED5 D6D6A3E8 A1D1937E 38D8C2C4 4FDFF252 D1BB67F1 A6BC5767 3FB506DD 48B2364B D80D2BDA AF0A1B4C 36034AF6 41047A60 DF60EFC3 A867DF55 316E8EEF 4669BE79 CB61B38C BC66831A 256FD2A0 5268E236 CC0C7795 BB0B4703 220216B9 5505262F C5BA3BBE B2BD0B28 2BB45A92 5CB36A04 C2D7FFA7 B5D0CF31 2CD99E8B 5BDEAE1D 9B64C2B0 EC63F226 756AA39C 026D930A 9C0906A9 EB0E363F 72076785 05005713 95BF4A82 E2B87A14 7BB12BAE 0CB61B38 92D28E9B E5D5BE0D 7CDCEFB7 0BDBDF21 86D3D2D4 F1D4E242 68DDB3F8 1FDA836E 81BE16CD F6B9265B 6FB077E1 18B74777 88085AE6 FF0F6A70 66063BCA 11010B5C 8F659EFF F862AE69 616BFFD3 166CCF45 A00AE278 D70DD2EE 4E048354 3903B3C2 A7672661 D06016F7 4969474D 3E6E77DB AED16A4A D9D65ADC 40DF0B66 37D83BF0 A9BCAE53 DEBB9EC5 47B2CF7F 30B5FFE9 BDBDF21C CABAC28A 53B39330 24B4A3A6 BAD03605 CDD70693 54DE5729 23D967BF B3667A2E C4614AB8 5D681B02 2A6F2B94 B40BBE37 C30C8EA1 5A05DF1B 2D02EF8D".split(" ").map((t=>parseInt(t,16)));let s=-1;for(let i=0,n=t.length;i<n;i++)s=s>>>8^e[255&(s^t.charCodeAt(i))];return(-1^s)>>>0})(`${String(i.vE.initParams.userID)}_${t.format("YYYY-MM-DD")}_${String(this.state.evaluationType)}_survey_actions_20210630`)%1e3/10<=e}}let _t;!function(t){t[t.DEFINITELY=5]="DEFINITELY",t[t.YES=4]="YES",t[t.NOT_KNOW=3]="NOT_KNOW",t[t.NO=2]="NO",t[t.NEVER=1]="NEVER"}(_t||(_t={}));const gt="evaluation.recommendStories.rate.";class vt extends k{constructor(...t){var e,s,n;super(...t),e=this,s="templateData",n={emojiList:[{type:_t.NEVER,icon:i.vE.icon("ui__persevering-face"),title:i.vE.i18n(`${gt}never`)},{type:_t.NO,icon:i.vE.icon("ui__sad-face"),title:i.vE.i18n(`${gt}no`)},{type:_t.NOT_KNOW,icon:i.vE.icon("ui__neutral-face"),title:i.vE.i18n(`${gt}not_know`)},{type:_t.YES,icon:i.vE.icon("ui__smiley-face"),title:i.vE.i18n(`${gt}yes`)},{type:_t.DEFINITELY,icon:i.vE.icon("ui__happy-face"),title:i.vE.i18n(`${gt}definitely`)}]},s in e?Object.defineProperty(e,s,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[s]=n}initTemplate(){const t=super.initTemplate(this.templateData);return new P({el:t.querySelector("."+b.emoji.container)}).render().on(D,(t=>{var e;const s=null===(e=this.evaluation)||void 0===e?void 0:e.getState().story;s&&(this.emitAction({responseType:"rate",description:String(t),storyId:s.id}),this.sendAnalytics("form_rate",String(t),s.getShowPostAnalyticsData()),this.emitNextStep({initQuestionOption:t}))})),t}}function ft(t,e){var s=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),s.push.apply(s,i)}return s}function yt(t,e,s){return e in t?Object.defineProperty(t,e,{value:s,enumerable:!0,configurable:!0,writable:!0}):t[e]=s,t}const bt="evaluation.recommendStories.clarification.";class wt extends k{constructor(...t){super(...t),yt(this,"formConfigs",{positive:{title:i.vE.i18n(`${bt}titles.positive`),checkboxes:[i.vE.i18n(`${bt}options.entertains`),i.vE.i18n(`${bt}options.calm_down`),i.vE.i18n(`${bt}options.informative`),i.vE.i18n(`${bt}options.useful`),i.vE.i18n(`${bt}options.original`),i.vE.i18n(`${bt}options.other`)]},partial:{title:i.vE.i18n(`${bt}titles.partial`),checkboxes:[i.vE.i18n(`${bt}options.not_relevant`),i.vE.i18n(`${bt}options.expectations`),i.vE.i18n(`${bt}options.unusually`),i.vE.i18n(`${bt}options.nothing_special`),i.vE.i18n(`${bt}options.other`)]},negative:{title:i.vE.i18n(`${bt}titles.negative`),checkboxes:[i.vE.i18n(`${bt}options.old`),i.vE.i18n(`${bt}options.pointless`),i.vE.i18n(`${bt}options.not_interesting`),i.vE.i18n(`${bt}options.not_true`),i.vE.i18n(`${bt}options.other`)]}}),yt(this,"rates",{[_t.DEFINITELY]:this.formConfigs.positive,[_t.YES]:this.formConfigs.partial,[_t.NOT_KNOW]:this.formConfigs.negative,[_t.NO]:this.formConfigs.negative,[_t.NEVER]:this.formConfigs.negative}),yt(this,"onFormChange",(()=>{var t;const e=this.form.serialize().check;var s,i;e?null===(s=this.els.actionBtn)||void 0===s||s.removeAttribute("disabled"):null===(i=this.els.actionBtn)||void 0===i||i.setAttribute("disabled","disabled");(null===(t=this.selectedChecboxValues)||void 0===t?void 0:t.length)!==(null==e?void 0:e.length)&&this.sendAnalytics("form_interact","click_reason",this.getStoryAnalyticsData()),this.selectedChecboxValues=e}))}getContent(t){return super.getContent(function(t){for(var e=1;e<arguments.length;e++){var s=null!=arguments[e]?arguments[e]:{};e%2?ft(Object(s),!0).forEach((function(e){yt(t,e,s[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(s)):ft(Object(s)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(s,e))}))}return t}({},this.getFormChecbkoxes(t.initQuestionOption)))}onMounted(t){return super.onMounted(t),this.initForm(),this}initEventListeners(){var t;null===(t=this.els.actionBtn)||void 0===t||t.addEventListener("click",(()=>{var t;const{check:e}=this.form.serialize();let s="";Array.isArray(e)?(e.forEach((t=>{this.sendAnalytics("form_rate",t,this.getStoryAnalyticsData())})),s=e.join(",")):"string"==typeof e&&(this.sendAnalytics("form_rate",e,this.getStoryAnalyticsData()),s=e),this.emitAction({responseType:"reason",reasons:s,storyId:null===(t=this.evaluation)||void 0===t?void 0:t.getState().story.id}),this.emitNextStep()}))}getFormChecbkoxes(t){return t?this.rates[t]:{}}initForm(){var t,e;if(this.form||null===(t=this.evaluation)||void 0===t||!t.getContainer())return;const s=X.S.getInstance().get("UIForm");this.form=new s({el:null===(e=this.evaluation.getContainer())||void 0===e?void 0:e.querySelector("form")}),this.form.on("submit",(t=>t.preventDefault())),this.form.on("change",this.onFormChange)}getStoryAnalyticsData(){var t;return null===(t=this.evaluation)||void 0===t?void 0:t.getState().story.getShowPostAnalyticsData()}}var Et=s(9050);function St(t){var e,i="",n=Et.escape;Array.prototype.join;s(8211).vE;return i+='\n\n<div class="evaluation__content hot-feed-evaluation hot-feed-evaluation_init">\n\t<h3 class="evaluation__title evaluation__title_center">Хотите ли вы видеть подобные посты у&nbsp;себя в&nbsp;ленте?</h3>\n\t<div class="evaluation-emoji evaluation__emoji">\n\t\t<ul class="evaluation-emoji__list">\n\t\t\t',t.emojiList.forEach((function(t){i+='\n\t\t\t\t<li class="evaluation-emoji__item" data-type="'+n(t.type)+'">\n\t\t\t\t\t<span class="evaluation-emoji__icon">'+(null==(e=t.icon)?"":e)+'</span>\n\t\t\t\t\t<span class="evaluation-emoji__title">'+n(t.title)+"</span>\n\t\t\t\t</li>\n\t\t\t"})),i+="\n\t\t</ul>\n\t</div>\n</div>\n"}var Ct=s(9050);function Tt(t){var e="",i=Ct.escape;Array.prototype.join;const n=s(8211).vE;return e+='\n\n<div class="evaluation__content hot-feed-evaluation hot-feed-evaluation_form">\n\t<div class="evaluation__form">\n\t\t<h3 class="evaluation__title evaluation__title_mb">'+i(t.title)+'</h3>\n\t\t<form>\n\t\t\t<div class="evaluation__form-checkboxes">\n\t\t\t\t',t.checkboxes.forEach((function(t){e+='\n\t\t\t\t\t<p><label class="evaluation__form-label"><input type="checkbox" value="'+i(t)+'" name="check"> '+i(t)+"</label></p>\n\t\t\t\t"})),e+='\n\t\t\t</div>\n\t\t</form>\n\t\t<div class="evaluation__btn-group evaluation__btn-group_inline">\n\t\t\t<button disabled="disabled" data-role="next" class="button_success">'+i(n.i18n("evaluation.btns.send"))+"</button>\n\t\t</div>\n\t</div>\n</div>"}var Ot=s(9050);function kt(t){var e="",i=Ot.escape;Array.prototype.join;const n=s(8211).vE;return e+='\n\n<div class="evaluation__content hot-feed-evaluation hot-feed-evaluation_thanks">\n\t<div class="evaluation__thumbs-icon">\n\t\t<svg xmlns="http://www.w3.org/2000/svg" class="icon icon--ui__cookie-thumbs-up"><use xlink:href="#icon--ui__cookie-thumbs-up"></use></svg>\n\t</div>\n\t<h3 class="evaluation__title evaluation__title_center">'+i(n.i18n("evaluation.gratitude.title"))+"</h3>\n</div>\n"}var It=s(3227);function $t(t,e,s){return e in t?Object.defineProperty(t,e,{value:s,enumerable:!0,configurable:!0,writable:!0}):t[e]=s,t}class At extends K{constructor(...t){super(...t),$t(this,"STEPS",[new vt({getTemplate:St}),new wt({getTemplate:Tt}),new k({getTemplate:kt})]),$t(this,"type","hot_feed_post"),$t(this,"state",{initQuestionOption:null,story:null}),$t(this,"storiesViewedCount",0),$t(this,"isUserPresentsLongEnough",!1),$t(this,"initTimer",null),$t(this,"storageViewedSubscriber",ot.Z),$t(this,"onStoryViewed",(t=>{this.lastViewedStory=t,this.storiesViewedCount<5?this.storiesViewedCount++:this.shouldBeInitiated()&&(this.initializeEvaluation(),this.initTimer&&clearTimeout(this.initTimer),this.initTimer=null)}))}static getInstance(){return At.instance||(At.instance=new At)}init(t){this.wasAlreadyShown()||(this.feed=t,this.initTimer=setTimeout((()=>{this.isUserPresentsLongEnough=!0,this.shouldBeInitiated()&&this.initializeEvaluation()}),12e4),this.storageViewedSubscriber=o.N.instance.onStoryViewed(this.onStoryViewed))}async initializeEvaluation(){this.storageViewedSubscriber(),await this.shouldBeShown()&&(this.state.story=this.feed.stories.get(Number(this.lastViewedStory)),this.setContainerSelector(),super.init())}setContainerSelector(){this.lastViewedStory&&(this.containerSelector=`.${It.B.item}[data-story-id="${this.lastViewedStory}"][data-author-id] .${It.B.main}`)}shouldBeInitiated(){return this.isUserPresentsLongEnough&&this.storiesViewedCount>=5}}const xt="pkb_lst_pub_st";function Dt(t,e){var s=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),s.push.apply(s,i)}return s}function Pt(t){for(var e=1;e<arguments.length;e++){var s=null!=arguments[e]?arguments[e]:{};e%2?Dt(Object(s),!0).forEach((function(e){Rt(t,e,s[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(s)):Dt(Object(s)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(s,e))}))}return t}function Rt(t,e,s){return e in t?Object.defineProperty(t,e,{value:s,enumerable:!0,configurable:!0,writable:!0}):t[e]=s,t}class Mt extends K{constructor(...t){super(...t),Rt(this,"type","post_publish_late"),Rt(this,"STEPS",[]),Rt(this,"lastPublishedStoryId",null)}static getInstance(){return Mt.instance||(Mt.instance=new Mt)}async init(){if(this.wasAlreadyShown())return;const t=await class{static async getLastPublishedStory(){const t=H.x.get(xt);if(null!=t&&t.storyId&&null!=t&&t.storyTitle)return t;if(null===(null==t?void 0:t.storyId)||null===(null==t?void 0:t.storyTitle))return null;const{response:e,data:s}=await R.cf.post("/ajax.php",{route:"csat/last-published-story"});if(e.result||console.error(e.message),!e.result||Array.isArray(s)&&0===s.length)return H.x.set(xt,{storyId:null,storyTitle:null}),null;const i={storyId:s.id,storyTitle:s.title};return H.x.set(xt,i),i}}.getLastPublishedStory();t&&await this.shouldBeShown()&&(this.lastPublishedStoryId=t.storyId,this.state=Pt(Pt({},this.state),{},{logData:{storyId:this.lastPublishedStoryId}}),this.initSteps(t.storyTitle),super.init(this.type))}initSteps(t){const e=new it({getTemplate:a,asModalMenu:i.vE.applicationType===n.Zq.MOBILE});e.setTitle(`Насколько вы удовлетворены откликом на ваш пост ${t}?`).subscribe(O,(t=>{const s=this.getReasons(Number(t.description));e.setFormTitle(s.title).setReasons(s.options)})),this.STEPS.push(e),this.STEPS.push(new nt({getTemplate:h,asModalMenu:i.vE.applicationType===n.Zq.MOBILE}))}getReasons(t){switch(t){case Q.AWFUL:case Q.BAD:case Q.NORMAL:return{title:"Чем недовльны?",options:["Слабое обсуждение","Равнодушие","Низкий рейтинг","Токсичность","Другое"]};case Q.GOOD:return{title:"Что могло быть лучше?",options:["Активное обсуждение","Больше отзывчивости","Выше рейтинг","Меньше токсичности","Другое"]};case Q.EXCELLENT:return{title:"Что понравилось?",options:["Бурное обсуждение","Отзывчивость","Хороший рейтинг","Дружелюбность","Другое"]};default:return{title:"",options:[]}}}}function Nt(t,e){var s=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),s.push.apply(s,i)}return s}function Bt(t){for(var e=1;e<arguments.length;e++){var s=null!=arguments[e]?arguments[e]:{};e%2?Nt(Object(s),!0).forEach((function(e){Lt(t,e,s[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(s)):Nt(Object(s)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(s,e))}))}return t}function Lt(t,e,s){return e in t?Object.defineProperty(t,e,{value:s,enumerable:!0,configurable:!0,writable:!0}):t[e]=s,t}class Ft extends K{constructor(...t){super(...t),Lt(this,"type","comments_view"),Lt(this,"STEPS",[])}static getInstance(){return Ft.instance||(Ft.instance=new Ft)}initObserver(t,e){if(!t||this.wasAlreadyShown())return;this.state=Bt(Bt({},this.state),{},{logData:{storyId:e}});const s=new IntersectionObserver((e=>{e.forEach((e=>{e.isIntersecting&&(this.initSteps(),q("pkb_ecv",(async()=>{await this.shouldBeShown()&&super.init(this.type)})),s.unobserve(t))}))}),{threshold:0});s.observe(t)}initSteps(){const t=new it({getTemplate:a,asModalMenu:i.vE.isMobileApp});t.setTitle("Насколько было удобно читать комментарии?").subscribe(O,(e=>{const s=this.getReasons(Number(e.description));t.setFormTitle(s.title).setReasons(s.options)})),this.STEPS.push(t),this.STEPS.push(new nt({getTemplate:h,asModalMenu:i.vE.isMobileApp}))}getReasons(t){const e=["Скорость загрузки или технические проблемы","Расположение кнопок","Поиск по комментариям","Навигация по ветке комментариев","Токсичность","Другое"];switch(t){case Q.AWFUL:case Q.BAD:case Q.NORMAL:return{title:"С какими трудностями столкнулись?",options:e};case Q.GOOD:return{title:"Что стоит улучшить?",options:e};default:return{title:"",options:[]}}}}},2334:(t,e,s)=>{"use strict";s.d(e,{b:()=>i,X:()=>n});const i="_eventAll",n=/\s+/},6777:(t,e,s)=>{"use strict";s.d(e,{bB:()=>i.b,vp:()=>n.v,ZK:()=>n.Z});var i=s(2334),n=s(1014)},6258:()=>{var t,e;t=function(t,e,s){var i=t,n=e||0,o=0;this.getRawData=function(){return i},"string"==typeof t&&(o=s||i.length,this.getByteAt=function(t){return 255&i.charCodeAt(t+n)},this.getBytesAt=function(t,e){for(var s=[],o=0;o<e;o++)s[o]=255&i.charCodeAt(t+o+n);return s}),this.getLength=function(){return o},this.getSByteAt=function(t){return 127<(t=this.getByteAt(t))?t-256:t},this.getShortAt=function(t,e){var s=e?(this.getByteAt(t)<<8)+this.getByteAt(t+1):(this.getByteAt(t+1)<<8)+this.getByteAt(t);return 0>s&&(s+=65536),s},this.getSShortAt=function(t,e){var s=this.getShortAt(t,e);return 32767<s?s-65536:s},this.getLongAt=function(t,e){var s=this.getByteAt(t),i=this.getByteAt(t+1),n=this.getByteAt(t+2),o=this.getByteAt(t+3);return 0>(s=e?(((s<<8)+i<<8)+n<<8)+o:(((o<<8)+n<<8)+i<<8)+s)&&(s+=4294967296),s},this.getSLongAt=function(t,e){var s=this.getLongAt(t,e);return 2147483647<s?s-4294967296:s},this.getStringAt=function(t,e){for(var s=[],i=this.getBytesAt(t,e),n=0;n<e;n++)s[n]=String.fromCharCode(i[n]);return s.join("")},this.getCharAt=function(t){return String.fromCharCode(this.getByteAt(t))},this.toBase64=function(){return window.btoa(i)},this.fromBase64=function(t){i=window.atob(t)}},e={},function(){function t(t){if(255!=t.getByteAt(0)||216!=t.getByteAt(1))return!1;for(var e=2,s=t.getLength();e<s;){if(255!=t.getByteAt(e))return o&&console.log("Not a valid marker at offset "+e+", found: "+t.getByteAt(e)),!1;var i=t.getByteAt(e+1);if(22400==i||225==i)return o&&console.log("Found 0xFFE1 marker"),n(t,e+4,t.getShortAt(e+2,!0));e+=2+t.getShortAt(e+2,!0)}}function s(t,e,s,n,r){for(var a=t.getShortAt(s,r),l={},h=0;h<a;h++){var c=s+12*h+2,d=n[t.getShortAt(c,r)];!d&&o&&console.log("Unknown tag: "+t.getShortAt(c,r)),l[d]=i(t,c,e,s,r)}return l}function i(t,e,s,i,n){var o=t.getShortAt(e+2,n);switch(i=t.getLongAt(e+4,n),s=t.getLongAt(e+8,n)+s,o){case 1:case 7:if(1==i)return t.getByteAt(e+8,n);for(s=4<i?s:e+8,e=[],o=0;o<i;o++)e[o]=t.getByteAt(s+o);return e;case 2:return t.getStringAt(4<i?s:e+8,i-1);case 3:if(1==i)return t.getShortAt(e+8,n);for(s=2<i?s:e+8,e=[],o=0;o<i;o++)e[o]=t.getShortAt(s+2*o,n);return e;case 4:if(1==i)return t.getLongAt(e+8,n);for(e=[],o=0;o<i;o++)e[o]=t.getLongAt(s+4*o,n);return e;case 5:if(1==i)return t.getLongAt(s,n)/t.getLongAt(s+4,n);for(e=[],o=0;o<i;o++)e[o]=t.getLongAt(s+8*o,n)/t.getLongAt(s+4+8*o,n);return e;case 9:if(1==i)return t.getSLongAt(e+8,n);for(e=[],o=0;o<i;o++)e[o]=t.getSLongAt(s+4*o,n);return e;case 10:if(1==i)return t.getSLongAt(s,n)/t.getSLongAt(s+4,n);for(e=[],o=0;o<i;o++)e[o]=t.getSLongAt(s+8*o,n)/t.getSLongAt(s+4+8*o,n);return e}}function n(t,i){if("Exif"!=t.getStringAt(i,4))return o&&console.log("Not valid EXIF data! "+t.getStringAt(i,4)),!1;var n,r=i+6;if(18761==t.getShortAt(r))n=!1;else{if(19789!=t.getShortAt(r))return o&&console.log("Not valid TIFF data! (no 0x4949 or 0x4D4D)"),!1;n=!0}if(42!=t.getShortAt(r+2,n))return o&&console.log("Not valid TIFF data! (no 0x002A)"),!1;if(8!=t.getLongAt(r+4,n))return o&&console.log("Not valid TIFF data! (First offset not 8)",t.getShortAt(r+4,n)),!1;var a=s(t,r,r+8,e.TiffTags,n);if(a.ExifIFDPointer){var l,h=s(t,r,r+a.ExifIFDPointer,e.Tags,n);for(l in h){switch(l){case"LightSource":case"Flash":case"MeteringMode":case"ExposureProgram":case"SensingMethod":case"SceneCaptureType":case"SceneType":case"CustomRendered":case"WhiteBalance":case"GainControl":case"Contrast":case"Saturation":case"Sharpness":case"SubjectDistanceRange":case"FileSource":h[l]=e.StringValues[l][h[l]];break;case"ExifVersion":case"FlashpixVersion":h[l]=String.fromCharCode(h[l][0],h[l][1],h[l][2],h[l][3]);break;case"ComponentsConfiguration":h[l]=e.StringValues.Components[h[l][0]]+e.StringValues.Components[h[l][1]]+e.StringValues.Components[h[l][2]]+e.StringValues.Components[h[l][3]]}a[l]=h[l]}}if(a.GPSInfoIFDPointer)for(l in n=s(t,r,r+a.GPSInfoIFDPointer,e.GPSTags,n))"GPSVersionID"===l&&(n[l]=n[l][0]+"."+n[l][1]+"."+n[l][2]+"."+n[l][3]),a[l]=n[l];return a}var o=!1;e.Tags={36864:"ExifVersion",40960:"FlashpixVersion",40961:"ColorSpace",40962:"PixelXDimension",40963:"PixelYDimension",37121:"ComponentsConfiguration",37122:"CompressedBitsPerPixel",37500:"MakerNote",37510:"UserComment",40964:"RelatedSoundFile",36867:"DateTimeOriginal",36868:"DateTimeDigitized",37520:"SubsecTime",37521:"SubsecTimeOriginal",37522:"SubsecTimeDigitized",33434:"ExposureTime",33437:"FNumber",34850:"ExposureProgram",34852:"SpectralSensitivity",34855:"ISOSpeedRatings",34856:"OECF",37377:"ShutterSpeedValue",37378:"ApertureValue",37379:"BrightnessValue",37380:"ExposureBias",37381:"MaxApertureValue",37382:"SubjectDistance",37383:"MeteringMode",37384:"LightSource",37385:"Flash",37396:"SubjectArea",37386:"FocalLength",41483:"FlashEnergy",41484:"SpatialFrequencyResponse",41486:"FocalPlaneXResolution",41487:"FocalPlaneYResolution",41488:"FocalPlaneResolutionUnit",41492:"SubjectLocation",41493:"ExposureIndex",41495:"SensingMethod",41728:"FileSource",41729:"SceneType",41730:"CFAPattern",41985:"CustomRendered",41986:"ExposureMode",41987:"WhiteBalance",41988:"DigitalZoomRation",41989:"FocalLengthIn35mmFilm",41990:"SceneCaptureType",41991:"GainControl",41992:"Contrast",41993:"Saturation",41994:"Sharpness",41995:"DeviceSettingDescription",41996:"SubjectDistanceRange",40965:"InteroperabilityIFDPointer",42016:"ImageUniqueID"},e.TiffTags={256:"ImageWidth",257:"ImageHeight",34665:"ExifIFDPointer",34853:"GPSInfoIFDPointer",40965:"InteroperabilityIFDPointer",258:"BitsPerSample",259:"Compression",262:"PhotometricInterpretation",274:"Orientation",277:"SamplesPerPixel",284:"PlanarConfiguration",530:"YCbCrSubSampling",531:"YCbCrPositioning",282:"XResolution",283:"YResolution",296:"ResolutionUnit",273:"StripOffsets",278:"RowsPerStrip",279:"StripByteCounts",513:"JPEGInterchangeFormat",514:"JPEGInterchangeFormatLength",301:"TransferFunction",318:"WhitePoint",319:"PrimaryChromaticities",529:"YCbCrCoefficients",532:"ReferenceBlackWhite",306:"DateTime",270:"ImageDescription",271:"Make",272:"Model",305:"Software",315:"Artist",33432:"Copyright"},e.GPSTags={0:"GPSVersionID",1:"GPSLatitudeRef",2:"GPSLatitude",3:"GPSLongitudeRef",4:"GPSLongitude",5:"GPSAltitudeRef",6:"GPSAltitude",7:"GPSTimeStamp",8:"GPSSatellites",9:"GPSStatus",10:"GPSMeasureMode",11:"GPSDOP",12:"GPSSpeedRef",13:"GPSSpeed",14:"GPSTrackRef",15:"GPSTrack",16:"GPSImgDirectionRef",17:"GPSImgDirection",18:"GPSMapDatum",19:"GPSDestLatitudeRef",20:"GPSDestLatitude",21:"GPSDestLongitudeRef",22:"GPSDestLongitude",23:"GPSDestBearingRef",24:"GPSDestBearing",25:"GPSDestDistanceRef",26:"GPSDestDistance",27:"GPSProcessingMethod",28:"GPSAreaInformation",29:"GPSDateStamp",30:"GPSDifferential"},e.StringValues={ExposureProgram:{0:"Not defined",1:"Manual",2:"Normal program",3:"Aperture priority",4:"Shutter priority",5:"Creative program",6:"Action program",7:"Portrait mode",8:"Landscape mode"},MeteringMode:{0:"Unknown",1:"Average",2:"CenterWeightedAverage",3:"Spot",4:"MultiSpot",5:"Pattern",6:"Partial",255:"Other"},LightSource:{0:"Unknown",1:"Daylight",2:"Fluorescent",3:"Tungsten (incandescent light)",4:"Flash",9:"Fine weather",10:"Cloudy weather",11:"Shade",12:"Daylight fluorescent (D 5700 - 7100K)",13:"Day white fluorescent (N 4600 - 5400K)",14:"Cool white fluorescent (W 3900 - 4500K)",15:"White fluorescent (WW 3200 - 3700K)",17:"Standard light A",18:"Standard light B",19:"Standard light C",20:"D55",21:"D65",22:"D75",23:"D50",24:"ISO studio tungsten",255:"Other"},Flash:{0:"Flash did not fire",1:"Flash fired",5:"Strobe return light not detected",7:"Strobe return light detected",9:"Flash fired, compulsory flash mode",13:"Flash fired, compulsory flash mode, return light not detected",15:"Flash fired, compulsory flash mode, return light detected",16:"Flash did not fire, compulsory flash mode",24:"Flash did not fire, auto mode",25:"Flash fired, auto mode",29:"Flash fired, auto mode, return light not detected",31:"Flash fired, auto mode, return light detected",32:"No flash function",65:"Flash fired, red-eye reduction mode",69:"Flash fired, red-eye reduction mode, return light not detected",71:"Flash fired, red-eye reduction mode, return light detected",73:"Flash fired, compulsory flash mode, red-eye reduction mode",77:"Flash fired, compulsory flash mode, red-eye reduction mode, return light not detected",79:"Flash fired, compulsory flash mode, red-eye reduction mode, return light detected",89:"Flash fired, auto mode, red-eye reduction mode",93:"Flash fired, auto mode, return light not detected, red-eye reduction mode",95:"Flash fired, auto mode, return light detected, red-eye reduction mode"},SensingMethod:{1:"Not defined",2:"One-chip color area sensor",3:"Two-chip color area sensor",4:"Three-chip color area sensor",5:"Color sequential area sensor",7:"Trilinear sensor",8:"Color sequential linear sensor"},SceneCaptureType:{0:"Standard",1:"Landscape",2:"Portrait",3:"Night scene"},SceneType:{1:"Directly photographed"},CustomRendered:{0:"Normal process",1:"Custom process"},WhiteBalance:{0:"Auto white balance",1:"Manual white balance"},GainControl:{0:"None",1:"Low gain up",2:"High gain up",3:"Low gain down",4:"High gain down"},Contrast:{0:"Normal",1:"Soft",2:"Hard"},Saturation:{0:"Normal",1:"Low saturation",2:"High saturation"},Sharpness:{0:"Normal",1:"Soft",2:"Hard"},SubjectDistanceRange:{0:"Unknown",1:"Macro",2:"Close view",3:"Distant view"},FileSource:{3:"DSC"},Components:{0:"",1:"Y",2:"Cb",3:"Cr",4:"R",5:"G",6:"B"}},e.getData=function(e,s){return!!e.complete&&(e.exifdata?s&&s():BinaryAjax(e.src,(function(i){i=t(i.binaryResponse),e.exifdata=i||{},s&&s()})),!0)},e.getTag=function(t,e){if(t.exifdata)return t.exifdata[e]},e.getAllTags=function(t){if(!t.exifdata)return{};t=t.exifdata;var e,s={};for(e in t)t.hasOwnProperty(e)&&(s[e]=t[e]);return s},e.pretty=function(t){if(!t.exifdata)return"";t=t.exifdata;var e,s="";for(e in t)t.hasOwnProperty(e)&&(s="object"==typeof t[e]?s+(e+" : [")+t[e].length+" values]\r\n":s+(e+" : ")+t[e]+"\r\n");return s},e.readFromBinaryFile=function(e){return t(e)}}(),FileAPI.support.exif=!0,FileAPI.addInfoReader(/^image/,(function(s,i){if(!s.__exif){var n=s.__exif=FileAPI.defer(),o=s;if(o instanceof Blob&&o.size>131072)try{var r=Math.min(o.size,131072);o=(o.slice||o.mozSlice||o.webkitSlice).call(o,0,r)}catch(a){FileAPI.log("exception "+a)}FileAPI.readAsBinaryString(o,(function(s){if("load"==s.type){var i=s.result,r=new t(i,0,o.size),a=e.readFromBinaryFile(r);n.resolve(!1,{exif:a||{}})}else"error"==s.type&&n.resolve("read_as_binary_string_exif")}))}s.__exif.then(i)}))},566:(t,e,s)=>{"use strict";s.d(e,{HP:()=>o,nO:()=>r,Np:()=>a});s(6258),s(8674),s(6992),s(3824);function i(t,e,s){return e in t?Object.defineProperty(t,e,{value:s,enumerable:!0,configurable:!0,writable:!0}):t[e]=s,t}s(6641);const n=window.FileAPI,o=/image\/(png|jpeg|gif|webp)/;class r{static getImageFiles(t){return n.getFiles(t).filter((t=>t instanceof Blob&&o.test(t.type)))}static getInfo(t){return new Promise(((e,s)=>{n.getInfo(t,((t,i)=>{if(t)return s(t);e(i)}))}))}static filterFiles(t,e){return new Promise((s=>{n.filterFiles(t,e,s)}))}static isAnimatedGif(t,e){return new Promise(((s,i)=>{if("image/gif"!==t.type)return s(!1);n.readAsArrayBuffer(t,(function(t){if("load"===t.type){let e,i,n=new Uint8Array(t.result),o=n.length,r=0,a=0;if(71!==n[0]||73!==n[1]||70!==n[2]||56!==n[3])return s(!1);for(e=0,i=o-9;a<2e5;++e)0!==n[e]||33!==n[e+1]||249!==n[e+2]||4!==n[e+3]||0!==n[e+8]||44!==n[e+9]&&33!==n[e+9]?a++:r++;return s(r>1)}"progress"===t.type?e&&e(t.loaded/t.total*100):i()}))}))}static isSupportedImage(t){return t instanceof Blob&&o.test(t.type)}}i(r,"File",n),i(r,"Image",n.Image);class a extends n.Image{get(){return new Promise(((t,e)=>{super.get(((s,i)=>{if(s)return e(s);t(i)}))}))}}},7754:(t,e,s)=>{"use strict";s.d(e,{Z:()=>r,y:()=>r});s(4916),s(6992),s(3948),s(4603);var i=s(6572),n=s(8799);const o=s(6419);class r{static add(t,e,s="highlight"){if((o.isString(e)||o.isArray(e))&&!e.length)return;let i=r._prepareRegExp(e),a=function(t){let e,n,o,r,l,h,c=0;if(3===t.nodeType)e=t.data.search(i),e>=0&&t.data.length>0&&(n=t.data.match(i),o=document.createElement("span"),o.className=s,r=t.splitText(e),l=r.splitText(n[0].length),h=r.cloneNode(!0),o.appendChild(h),r.parentNode.replaceChild(o,r),c=1);else if(1===t.nodeType&&t.childNodes&&!/(script|style)/i.test(t.tagName)&&(t.className!==s||"SPAN"!==t.tagName))for(let s=0;s<t.childNodes.length;++s)s+=a(t.childNodes[s]);return c};n.Zv.isJQuery(t)?t.each(((t,e)=>a(e))):a(t)}static remove(t,e="highlight"){let s=(t=n.Zv.isJQuery(t)?t.get(0):t).querySelectorAll(`span.${e}`);if(s.length)for(let i of s){if(!i.parentNode)continue;let t=i.parentNode;t.replaceChild(i.firstChild,i),t.normalize()}}static _prepareRegExp(t){return o.isString(t)?new RegExp(i.cQ.escapeStringRegExp(t),"i"):o.isArray(t)?new RegExp(t.map(i.cQ.escapeStringRegExp).join("|"),"i"):t}}},8097:(t,e,s)=>{"use strict";s.d(e,{SV:()=>_,FM:()=>m});s(5827),s(6992),s(3948),s(4916),s(5306);var i=s(1460),n=s(6349),o=s(6572);const r=s(6419),a=s(9755),l=s(5470),h=/\s+/,c={"~":"`","!":"1","@":"2","#":"3",$:"4","%":"5","^":"6","&":"7","*":"8","(":"9",")":"0",_:"-","+":"=",":":";",'"':"'","<":",",">":".","?":"/","|":"\\"},d={option:"alt",command:"meta",cmd:l.mac?"meta":"ctrl"};let u={},p={SHIFT:[1,"shiftKey"],CTRL:[2,"ctrlKey"],ALT:[8,"altKey"],META:[16,"metaKey"]},m={KEYDOWN:"keydown",KEYPRESS:"keypress",KEYUP:"keyup"};r.each({back:8,backspace:8,tab:9,enter:13,shift:16,ctrl:17,alt:18,pause:19,capslock:20,escape:27,space:32,pageup:33,pagedown:34,end:35,home:36,left:37,up:38,right:39,down:40,insert:45,delete:46,lwin:91,win:91,rwin:92,contextmenu:93,numpad0:96,numpad1:97,numpad2:98,numpad3:99,numpad4:100,numpad5:101,numpad6:102,numpad7:103,numpad8:104,numpad9:105,multiply:106,add:107,subtract:109,decimal:110,divide:111,f1:112,f2:113,f3:114,f4:115,f5:116,f6:117,f7:118,f8:119,f9:120,f10:121,f11:122,f12:123,numlock:144,scroll:145,";":186,"=":187,",":188,"-":189,".":190,"/":191,"`":192,"[":219,"\\":220,"]":221,"'":222},(function(t,e){u[t]=e})),m=new i.x(m);class _{constructor(t){this._handleKeyEvent=this._handleKeyEvent.bind(this),this._work=!0,this._winDown=!1,this.$el=a(t),this._workInInput=_.isInput(this.$el[0]),this._handlers=void 0,this._workDebounce=r.debounce((()=>{this._stopDebounce||(this._work=!0)}),200),document.addEventListener("visibilitychange",(()=>{"visible"===document.visibilityState?(this._stopDebounce=!1,this._workDebounce()):"hidden"===document.visibilityState&&(this._work=!1,this._stopDebounce=!0)})),this._winDebounce=r.debounce((()=>{this._winDown=!1}),5e3),this._handleKeyEventBound=this._handleKeyEvent.bind(this)}_addListeners(){this.$el.on("keypress keydown keyup",this._handleKeyEventBound)}_removeListeners(){this.$el.off("keypress keydown keyup",this._handleKeyEventBound)}static isInput(t){return o.cQ.isInput(t)}_handleKeyEvent(t){if(!this._handlers||!this._handlers.size)return!0;if(_.isInput(t.target)&&!this._workInInput)return!0;let e,s,i=0,o=r.isNumber(t.which)?Number(t.which):t.keyCode,h=m[(t.type||"").toUpperCase()];if(e=h!==m.KEYPRESS&&u[o]?u[o]:String.fromCharCode(o).toLowerCase(),l.windows&&("win"!==e&&"lwin"!==e&&"rwin"!==e||(h===m.KEYDOWN?(this._winDown=!0,this._winDebounce()):h===m.KEYUP&&(this._winDown=!1)),this._winDown&&(i+=32)),!this._handlers.has(e))return!0;i=r.reduce(p,((e,s)=>e+(t[s[1]]?s[0]:0)),i);for(let r of this._handlers.get(e))if(r.type===h){if((r.type!==m.KEYDOWN||r.repeat||!r._started)&&(!0===r.always||this._work)&&(r.ignoreModifiers||i===r.modifiers||h===m.KEYPRESS)&&(r.repeat||(r._started=!0),(!r.closest||(s||(s=a(t.target)),s.closest(r.closest).length))&&(n.cp.getInstance().sendEvent("hotkey_use",{"type!empty":e},[n.b0.CLICKHOUSE]),!1===r.callback.call(r.context,t,e)))){t.preventDefault&&t.preventDefault(),t.stopPropagation&&t.stopPropagation();break}}else!r.repeat&&r._started&&(r._started=!1);return!0}on(t,e,s){if(!_.prepare(this,"on",t,e,s)||!e||!t)return this;(s=_.prepareOptions(s)).type!==m.KEYDOWN&&s.repeat&&(s.repeat=!0);let i,n=this._cleanKeys(t);return n.key?(this._handlers||(this._handlers=new Map,this._addListeners()),this._handlers.has(n.key)?i=this._handlers.get(n.key):this._handlers.set(n.key,i=[]),i.push(r.extend(n,s,{callback:e})),this):this}once(t,e,s){if(!_.prepare(this,"on",t,e,s)||!e||!t)return this;let i=this,n=function(){i.off(t,n),e.apply(this,arguments)};return n._callback=e,this.on(t,n,s)}static prepareOptions(t){if(r.isObject(t)){if(t._prepared)return t;m.has(t)&&(t={type:m[t]})}else t={};return r.defaults(t,{type:m.has(t.type)?m[t.type]:m.KEYUP,always:!1,repeat:!0,closest:!1,_prepared:!0})}static prepare(t,e,s,i,n){if(!s)return!0;if(r.isArray(s))return n=_.prepareOptions(n),s.forEach((s=>{t[e].call(t,s,i,n)})),!1;if(r.isObject(s))return n=_.prepareOptions(i),r.forEach(s,((s,n)=>{t[e].call(t,n,s,i)})),!1;if(h.test(s)){n=_.prepareOptions(n);for(let o of s.split(h))t[e].call(t,o,i,n);return!1}return!0}off(t,e,s){let i,n;if(!this._handlers||!_.prepare(this,"off",t,e,s))return this;if(n=r.isObject(s)&&s.context,!t&&!e&&!n)return this._handlers.clear(),this._handlers=void 0,this._removeListeners(),this;i=(t=this._cleanKeys(t).key)?[t]:this._handlers.keys();for(let o of i){let t,s=this._handlers.get(o);if(s){if(this._handlers.set(o,t=[]),e||n)for(let i of s)(e&&e!==i.callback&&e!==i.callback._callback||n&&n!==i.context)&&t.push(i);t.length||this._handlers.delete(o)}}return this._handlers.size||(this._handlers=void 0,this._removeListeners()),this}_cleanKeys(t){let e,s={key:!1,modifiers:0};return t&&r.isString(t)?(e=[],r.forEach(t.toLowerCase().split("+"),(function(t){t=t.replace(/\s/g,""),d[t]&&(t=d[t]),c[t]&&(t=c[t],e.push(p.SHIFT)),p[t.toUpperCase()]?e.push(p[t.toUpperCase()]):s.key=t})),s.modifiers=r.reduce(r.compact(e),((t,e)=>t+e[0]),0),s):s}}},8504:(t,e,s)=>{"use strict";s.d(e,{q:()=>i});s(5827);s(6419);function i(t,...e){return t="icon--"+t,Array.isArray(e)&&1===e.length&&Array.isArray(e[0])&&(e=e[0]),Array.isArray(e)||(e=[e]),`<svg xmlns="http://www.w3.org/2000/svg" class="icon ${e.reduce(((e,s)=>e+` ${t}_${s}`),t)}"><use xlink:href="#${t}"></use></svg>`}},6683:(t,e,s)=>{"use strict";s.d(e,{ZD:()=>o,RO:()=>n,AJ:()=>l,BF:()=>a,jj:()=>g,fv:()=>c,Hc:()=>h});var i=s(7892);const n=new i.xs({WEEK:"week",MONTH:"month",THREE_MONTHS:"3-months",FOREVER:"forever",KEEP_EXISTING:"keep-existing"}),o=new i.xs({IGNORE:"ignore",UNIGNORE:"unignore",IGNORE_COMMENTS:"ignore-comments",UNIGNORE_COMMENTS:"unignore-comments",COMPLAIN:"complain"}),r=new i.xs({TAG:"tag",USER:"user",COMMUNITY:"community"}),a=new i.xs({ALL:"all",TAGS_SIMPLE:"simple-tag",USERS_SIMPLE:"simple-user",KEYWORDS_SIMPLE:"simple-keyword",COMMUNITIES_SIMPLE:"simple-community",TAGS_CONVOLUTED:"convoluted-tag",USERS_CONVOLUTED:"convoluted-user",KEYWORDS_CONVOLUTED:"convoluted-keyword",COMMUNITIES_CONVOLUTED:"convoluted-community"}),l=new i.xs({STORIES:"ignore-changed:stories",COMMENTS:"ignore-changed:comments"}),h=3,c=25;s(6992),s(3948),s(8674);var d=s(8211),u=s(2134),p=s(2822);const m=s(6419),_="/ajax/ignore_actions.php";class g{static prepareRule(t){let e=t=>m.isUndefined(t.id)?t:t.id,s=m.chain(t).pick("id","authors","communities","tags","keywords").mapObject((t=>m.isArray(t)?t.map(e):t)).mapObject((t=>String(t))).value();return t.period!==n.KEEP_EXISTING&&(s.period=t.period instanceof i.Tf&&n.has(t.period)?t.period.valueOf():n.FOREVER.valueOf()),s}static sendIgnoreAnaylytics(t,e="",s="user"){const i=t.tags.length>0&&("string"==typeof t.tags?t.tags:t.tags.join(",")),n=t.authors.length>0&&t.authors.map((t=>t.id)).join(","),o=t.communities.length>0&&t.communities.map((t=>t.id)).join(",");p.c.getInstance().sendEvent("add_to_ignore_list",{"tag_id!empty":i,"author_id!empty":n,"community_id!empty":o,"type!empty":e,"ignore_type!empty":s})}static async addRule(t,e="",s=""){g.sendIgnoreAnaylytics(t,e,s);let{response:i,data:n}=await u.cf.post(_,m.extend(g.prepareRule(t),{action:"add_rule"}));if(!i.result)throw new Error(i.message);return n}static async updateRule(t,e,s){g.sendIgnoreAnaylytics(t,"","");let i=g.prepareRule(t);if(!i||m.isUndefined(i.id))throw d.vE.logger.error("ignore","некорректный формат правила"),new Error;let{response:n,data:o}=await u.cf.post(_,m.extend(i,{action:"update_rule"}));if(!n.result)throw new Error(n.message);return o}static async removeRule(t){if(m.isUndefined(t))throw d.vE.logger.error("ignore","нужно указать id"),new Error;let{response:e}=await u.cf.post(_,{action:"remove_rule",id:Number(t)});if(!e.result)throw new Error(e.message);return e.result}static async getIgnoreRules(t={}){let{type:e,term:s,searchById:i}=t,n=m.extend(t,{action:"filter_rules",search_by_id:Number(Boolean(i)),type:m.isUndefined(e)?a.ALL.valueOf():e.valueOf(),term:s&&s.valueOf()}),{response:o,data:r}=await u.cf.post(_,n);if(!o.result)throw new Error(o.message);return r}static async getTagIgnore(t){return g.getIgnoreRules({type:a.TAGS_SIMPLE,search:t})}static async getUserIgnore(t){return g.getIgnoreRules({term:r.USER,searchById:!0,match:t,simple_rules_only:!0})}static async getCommunityIgnore(t){return g.getIgnoreRules({term:r.COMMUNITY,searchById:!0,match:t,simple_rules_only:!0})}static async addCommentsIgnore(t,e,s){if(m.isUndefined(t))throw d.vE.logger.error("ignore","нужно указать id"),new Error;const i={authors:[{id:t}],tags:[],communities:[],keywords:[],period:n.WEEK};g.sendIgnoreAnaylytics(i,e,s);let{response:o}=await u.cf.post(_,{action:"ignore_in_comments",id:Number(t)});if(!o.result)throw new Error(o.message);return o.result}static async removeCommentsIgnore(t){if(m.isUndefined(t))throw d.vE.logger.error("ignore","нужно указать id"),new Error;let{response:e}=await u.cf.post(_,{action:"unignore_in_comments",id:Number(t)});if(!e.result)throw new Error(e.message);return e.result}static async getCommentsIgnoreRules(t={}){let{response:e,data:s}=await u.cf.post(_,m.extend(t,{action:"list_ignored_in_comments"}));if(!e.result)throw new Error(e.message);return s}static async clearAll(){let{response:t}=await u.cf.post(_,{action:"clear_all"});if(!t.result)throw new Error(t.message);return t.result}}},93:(t,e,s)=>{"use strict";s.d(e,{_:()=>i,T:()=>n});const i=2e3,n="pkb:lazy-script-init"},2323:(t,e,s)=>{"use strict";s.d(e,{Tu:()=>i.T,bi:()=>n.b});var i=s(93),n=s(6091)},6091:(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{"use strict";__webpack_require__.d(__webpack_exports__,{b:()=>LazyScriptInit});var core_js_modules_es_array_iterator_js__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(6992),core_js_modules_es_array_iterator_js__WEBPACK_IMPORTED_MODULE_0___default=__webpack_require__.n(core_js_modules_es_array_iterator_js__WEBPACK_IMPORTED_MODULE_0__),core_js_modules_web_dom_collections_iterator_js__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(3948),core_js_modules_web_dom_collections_iterator_js__WEBPACK_IMPORTED_MODULE_1___default=__webpack_require__.n(core_js_modules_web_dom_collections_iterator_js__WEBPACK_IMPORTED_MODULE_1__),common_core__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__(8211),common_events__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__(6777),common_utils_detect_intersection_observer__WEBPACK_IMPORTED_MODULE_4__=__webpack_require__(4391),common_utils__WEBPACK_IMPORTED_MODULE_5__=__webpack_require__(6572),_consts__WEBPACK_IMPORTED_MODULE_6__=__webpack_require__(93);const $=__webpack_require__(9755);class LazyScriptInit extends common_events__WEBPACK_IMPORTED_MODULE_3__.vp{constructor(){super(),common_utils_detect_intersection_observer__WEBPACK_IMPORTED_MODULE_4__.v&&(this._watchList=new WeakSet,this._targetsMap=new WeakMap,this._observersByDistance=new Map,this.listenTo(common_core__WEBPACK_IMPORTED_MODULE_2__.vE,_consts__WEBPACK_IMPORTED_MODULE_6__.T,this._searchTargets.bind(this)),this.listenTo(common_utils__WEBPACK_IMPORTED_MODULE_5__.sh.instance,location.hostname,(t=>{var e;(null===(e=t.data)||void 0===e?void 0:e.event)===_consts__WEBPACK_IMPORTED_MODULE_6__.T&&this._searchTargets()})),this._searchTargets())}_searchTargets(){$('script[type="lazy-js"], script[data-event="script-in-view"]').each(((t,e)=>{if(this._watchList.has(e))return;let s,i=parseInt(e.dataset.distance)||_consts__WEBPACK_IMPORTED_MODULE_6__._;e.hasAttribute("data-target-id")&&""!==e.dataset.targetId&&(s=document.getElementById(e.dataset.targetId)),e.hasAttribute("data-closest")&&""!==e.dataset.closest&&(s=(s||e).closest(e.dataset.closest)||s),"script-in-view"===e.dataset.event&&(s=e.parentElement,i=0),s?(this._watchList.add(e),this._targetsMap.set(s,e),this._getObserver(i).observe(s)):common_core__WEBPACK_IMPORTED_MODULE_2__.vE.logger.error("lazy-js","cannot find target element")}))}_getObserver(t){let e=this._observersByDistance.get(t);return e||(e=new IntersectionObserver(this._processIntersections.bind(this,t),{rootMargin:`${t}px 0px`}),this._observersByDistance.set(t,e)),e}_processIntersections(t,e){let s=this._observersByDistance.get(t);if(s)for(let i of e)i.isIntersecting&&(s.unobserve(i.target),this._processTarget(i.target))}_processTarget(targetEl){if(!this._targetsMap.has(targetEl))return;let scriptEl=this._targetsMap.get(targetEl);this._targetsMap.delete(targetEl),"script-in-view"===scriptEl.dataset.event?$(scriptEl).replaceWith((function(){return atob(this.textContent)})):eval(scriptEl.textContent)}}},2493:(t,e,s)=>{"use strict";s.d(e,{c:()=>o,D:()=>g});s(8674);var i=s(2134),n=s(9412);class o{static async getInfo(t,e,s="N",n=""){let o={};o.provide_reasons=s,o.dataType="json",o.action="get_info",2===t?(o.check_ban=e,o.check_story_ban=n,o.target_id=n,o.target_type=1):3===t?(o.check_ban=e,o.check_comment_ban=n,o.target_id=n,o.target_type=2):0===t?(o.target_id=e,o.target_type=1):1===t&&(o.target_id=e,o.target_type=2);let{response:r,data:a}=await i.cf.post("/ajax/moderator_actions.php",o);if(!r.result)throw new Error(r.message);return a}static async moderatorAction(t){let{response:e,data:s}=await i.cf.post("/ajax/moderator_actions.php",t);if(!e.result)throw new Error(e.message);return s}}s(4916);var r=s(8211),a=s(7025),l=s(4519);class h{static async getGroups(){let{response:t,data:e}=await i.cf.post("/ajax/smm_actions.php",{action:"get_groups_list"});if(!t.result)throw new Error(t.message);return e}static async markStoryShare(t,e){let s={action:"save_status",story_id:t,group_id:e,state:1,comment:""},{response:n,data:o}=await i.cf.post("/ajax/smm_actions.php",s);if(!n.result)throw new Error(n.message);return o}}var c=s(9050);var d=s(9050);var u=s(150),p=s(8709),m=s(5304);const _=s(9755);class g extends l.u1{constructor(){super(),this._reasons={},this._lastBox=null,this._lastTargetKey=null}showDeleteStoryDialog(t,e){this._createBox(t,0,e)}showDeleteCommentDialog(t,e){this._createBox(t,1,e)}showBanUserDialog(t,e,s,i){this._createBox(t,1===i?2:3,e,s)}moveStoryToCommonFeed(t){let e={action:"move_to_common_feed",story_id:t},s=new a.LD({content:_((0,p.Z)(r.vE.i18n("moderator-tools.modal-box.move-to-common.title")))});s.addCloseButtonIntoFooter(r.vE.i18n("moderator-tools.modal-box.move-to-common.button-cancel")),s.addButtonIntoFooter(r.vE.i18n("moderator-tools.modal-box.move-to-common.button-confirm"),(async()=>{o.moderatorAction(e).then((()=>{this.trigger("complete")}),(t=>{r.vE.ui.toasts.showError(t||r.vE.i18n("moderator-tools.errors.request"))})),s.hide()}),u.j.DANGER),s.show()}_createBox(t,e,s,i){void 0===i&&(i=0),this._lastTarget=_(t);let n=String(e)+"_"+String(s)+"_"+String(i),a=g._lastBox;if(a&&a.isShown&&g._lastTargetKey===n)return this._lastTargetKey="",void a.hide();this._closeCurrentBox(),g._lastTargetKey=n,this._processed=!1;let l={current_ban:null,ban_count_info:null,ban_for_story:0,ban_for_comment:0,message:""};if(void 0===this._reasons[e]||2===e||3===e){let n="N";void 0===this._reasons[e]&&(n="Y"),o.getInfo(e,s,n,i).then((n=>{if(void 0!==n.reasons&&(this._reasons=n.reasons),void 0!==n.ban&&(l.current_ban=n.ban),void 0!==n.ban_count_info&&(l.ban_count_info=n.ban_count_info),void 0!==n.ban_for_story&&(l.ban_for_story=n.ban_for_story),void 0!==n.ban_for_comment&&(l.ban_for_comment=n.ban_for_comment),null!==l.current_ban&&l.current_ban.status)return void this._showBanInfo(this._lastTarget,l.current_ban);if(l.ban_for_story||l.ban_for_comment){if(1===l.ban_for_story)return void r.vE.ui.toasts.showError(r.vE.i18n("moderator-tools.errors.user-post-punished"));if(2===l.ban_for_story)return void(l.message+=r.vE.i18n("moderator-tools.errors.user-post-forgiven"));if(1===l.ban_for_comment)return void r.vE.ui.toasts.showError(r.vE.i18n("moderator-tools.user-comment-punished"));2===l.ban_for_comment&&(l.message+=r.vE.i18n("moderator-tools.errors.user-comment-forgiven"))}a=this._createBalloonBox(e,(t=>{this._doAction(e,s,i,t)}),l),g._lastBox=a,this.listenTo(g._lastBox,"hide",(()=>{g._lastBox=null,g._lastBox="",this._processed||this.trigger("cancel")})),a.isShown||(a.target=t,a.show())}),(t=>{r.vE.ui.toasts.showError(t||r.vE.i18n("moderator-tools.errors.request"))}))}}setStoryAdultFlag(t,e,s){this._setStoryFlag("set_adult",t,e,s)}setStoryAuthorsFlag(t,e,s){this._setStoryFlag("set_authors",t,e,s)}setStoryVisibilityFlag(t,e,s){this._setStoryFlag("set_story_visibility",t,e,s)}restoreStory(t){let e={action:"restore_story",story_id:t};o.moderatorAction(e).then((()=>{this.emit("complete")}),(t=>{r.vE.ui.toasts.showError(t||r.vE.i18n("moderator-tools.errors.request"))}))}restoreComment(t){let e={action:"restore_comment",comment_id:t};o.moderatorAction(e).then((()=>{this.emit("complete")}),(t=>{r.vE.ui.toasts.showError(t||r.vE.i18n("moderator-tools.errors.request"))}))}getCommentRestoreHistory(t){let e={action:"get_comment_restore_history",comment_id:t};o.moderatorAction(e).then((t=>{this.emit("complete",t)}),(t=>{r.vE.ui.toasts.showError(t||r.vE.i18n("moderator-tools.errors.request"))}))}_setStoryFlag(t,e,s,i){this._lastTarget=_(e),this._processed=!1,g._lastTargetKey="",this._closeCurrentBox();let n={action:t,story_id:s,flag:i?"1":"0"};o.moderatorAction(n).then((()=>{this._closeCurrentBox(),this.emit("complete")}),(t=>{r.vE.ui.toasts.showError(t||r.vE.i18n("moderator-tools.errors.request"))}))}_doAction(t,e,s,i){let n,a=this._reasons[t],l="";switch(t){case 0:l="remove_story";break;case 1:l="remove_comment";break;case 2:l="ban_for_story";break;case 3:l="ban_for_comment";break;default:return}n={action:l,item_id:e,item_subid:s,reason_id:i},o.moderatorAction(n).then((e=>{this._processed=!0,this._closeCurrentBox(),this.emit("complete",a&&a[i]?a[i].name:""),2!==Number(t)&&3!==Number(t)||e.status&&this._showBanInfo(this._lastTarget,e)}),(t=>{r.vE.ui.toasts.showError(t||r.vE.i18n("moderator-tools.errors.request")),this._closeCurrentBox()}))}_closeCurrentBox(){let t=g._lastBox;t&&t.isShown&&(t.hide(),g._lastBox=null)}_showBanInfo(t,e){if(!t)return;let s,i={moderatorName:e.moderator_name,reason:e.reason,timeEnd:e.time_end};var n,o,r;this._closeCurrentBox(),s=_((n=i,o="",r=c.escape,Array.prototype.join,o+='<div class="mt__box">\n\t<div class="mt__text">Пользователь забанен модератором <b>'+r(n.moderatorName)+"</b></div>\n\t",n.reason&&n.timeEnd&&(o+='\n\t<div class="mt__footer">\n\t\t<div class="mt__text_sm">\n\t\t\t<b>Причина:</b> '+r(n.reason)+'\n\t\t</div>\n\t\t<div class="mt__text_sm">\n\t\t\t<b>Время:</b> до '+r(n.timeEnd)+"\n\t\t</div>\n\t</div>\n\t"),o+="\n</div>\n")),this._lastBox=new a._({target:t,content:s}),this._lastBox.show()}takeModCall(t,e){let s={call_id:t,action:"take_call",flag:e?0:1};o.moderatorAction(s).then((()=>{this.emit("complete")}),(t=>{this.emit("cancel"),r.vE.ui.toasts.add("takeError",{theme:n.K.DANGER,content:t.message||r.vE.i18n("moderator-tools.errors.request")})}))}approveModCall(t,e){let s={call_id:t,action:"check_call",flag:e?0:1};o.moderatorAction(s).then((()=>{this.emit("complete")}),(t=>{this.emit("cancel"),r.vE.ui.toasts.add("approveError",{theme:n.K.DANGER,content:t.message||r.vE.i18n("moderator-tools.errors.request")})}))}modCallCheckedList(t){let e={action:"is_checked_list",ids:t};o.moderatorAction(e).then((t=>{this.emit("complete",t)}),(t=>{this.emit("cancel"),r.vE.ui.toasts.showError(t||r.vE.i18n("moderator-tools.errors.request"))}))}markStoryShared(t){h.getGroups().then((e=>{const s=_((i={socials:e,title:r.vE.i18n("moderator-tools.modal-box.mark-shared.title")},n="",o=d.escape,Array.prototype.join,n+='<div class="mt__popup-cnt mt__popup-cnt_center">\n    <h4>'+o(i.title)+'</h4>\n        <div class="select">\n            <select data-role="listbox">\n                ',d.forEach(i.socials,(function(t){n+='\n                    <option value="'+o(t.id)+'">'+o(t.name)+"</option>\n                "})),n+='\n            </select>\n            <div class="select__icon fa fa-angle-down"></div>\n        </div>\n</div>\n'));var i,n,o;const l=s.find("select"),c=new a.LD({content:s});c.footer.addClass("popup__footer_center"),c.addCloseButtonIntoFooter(r.vE.i18n("moderator-tools.modal-box.mark-shared.button-cancel")),c.addButtonIntoFooter(r.vE.i18n("moderator-tools.modal-box.mark-shared.button-confirm"),(async()=>{const e=l.val();h.markStoryShare(t,e).then((()=>{this.emit("complete"),c.hide()}),(t=>{r.vE.ui.toasts.showError(t||r.vE.i18n("moderator-tools.errors.request"))}))}),u.j.SUCCESS),c.show()}),(t=>{r.vE.ui.toasts.showError(t||r.vE.i18n("moderator-tools.errors.request"))}))}_showTagsHistory(t,e){let s={action:"get_tags_history",story_id:t},i=e.find('[data-role="tags-history"]');o.moderatorAction(s).then((t=>{t.length&&(t.map((t=>{t.addedTags=[],t.removedTags=[],t.oldTags=[],t.tags_old=t.tags_old.split(", "),t.tags_new=t.tags_new.split(", "),t.tags_new.forEach((e=>{_.inArray(e,t.tags_old)>-1?t.oldTags.push(e):t.addedTags.push(e)})),t.tags_old.forEach((e=>{-1===_.inArray(e,t.tags_new)&&t.removedTags.push(e)}))})),i.append((0,m.Z)(t)))}),(t=>{r.vE.ui.toasts.showError(t||r.vE.i18n("moderator-tools.errors.request"))}))}}},5635:(t,e,s)=>{s(2109)({target:"Element",proto:!0},{closest:function(t){let e=this;for(;e;){if(1===e.nodeType&&e.matches(t))return e;e=e.parentNode}return null}})},1898:(t,e,s)=>{"use strict";const i=s(2109),n=Element.prototype;i({target:"Element",proto:!0},{matches:n.matchesSelector||n.webkitMatchesSelector||n.msMatchesSelector||function(t){let e=this,s=(e.parentNode||e.document).querySelectorAll(t),i=-1;for(;s[++i];)if(s[i]===e)return!0;return!1}})},500:(t,e,s)=>{"use strict";s(2109)({target:"NodeList",proto:!0},{forEach:function(t,e){e=e||window;for(let s=0;s<this.length;s++)t.call(e,this[s],s,this)}})},8225:(t,e,s)=>{"use strict";const i=s(6419);"undefined"==typeof Proxy&&(window.Proxy=function(t){let e,s=null;return e=function(t,e){if(!i.isObject(t)||!i.isObject(e))throw new TypeError("Cannot create proxy with a non-object as target or handler");let n=function(){};s=function(){n=function(t){throw new TypeError(`Cannot perform '${t}' on a proxy that has been revoked`)}};let o=e;e={get:null,set:null,apply:null,construct:null,deleteProperty:null,defineProperty:null};for(let s in o){if(!(s in e))throw new TypeError(`Proxy polyfill does not support trap '${s}'`);e[s]=o[s]}"function"==typeof o&&(e.apply=o.apply.bind(o));let r=this,a=!1,l="function"==typeof t;(e.apply||e.construct||l)&&(r=function(){let s=this&&this.constructor===r;if(n(s?"construct":"apply"),s&&e.construct)return e.construct.call(this,t,arguments);if(!s&&e.apply)return e.apply(t,this,arguments);if(l){if(s){let e,s=Array.prototype.slice.call(arguments);return s.unshift(t),e=t.bind.apply(t,s),new e}return t.apply(this,arguments)}throw new TypeError(s?"not a constructor":"not a function")},a=!0);let h=e.get?function(t){return n("get"),e.get(this,t,r)}:function(t){return n("get"),this[t]},c=e.set?function(t,s){n("set"),e.set(this,t,s,r)}:function(t,e){n("set"),this[t]=e},d=Object.getOwnPropertyNames(t),u={};d.forEach((function(e){if(a&&e in r)return;let s={enumerable:!!Object.getOwnPropertyDescriptor(t,e).enumerable,get:h.bind(t,e),set:c.bind(t,e)};Object.defineProperty(r,e,s),u[e]=!0}));let p=!0;if(Object.setPrototypeOf?Object.setPrototypeOf(r,Object.getPrototypeOf(t)):r.__proto__?r.__proto__=t.__proto__:p=!1,e.get||!p)for(let s in t)u[s]||Object.defineProperty(r,s,{get:h.bind(t,s)});return Object.seal(r),r},e.revocable=function(t,i){return{proxy:new e(t,i),revoke:s}},e}())},3678:(t,e,s)=>{let i=0;s(2109)({global:!0},{requestAnimationFrame:t=>{const e=(new Date).getTime(),s=Math.max(0,16-e-i),n=window.setTimeout((()=>t(e+s)),s);return i=e+s,n},cancelAnimationFrame:t=>window.clearTimeout(t)})},7022:(t,e,s)=>{"use strict";s.d(e,{I:()=>r});const i="undefined"==typeof window?{}:window.document,n="undefined"!=typeof Element&&"ALLOW_KEYBOARD_INPUT"in Element;let o=function(){let t={},e=[["requestFullscreen","exitFullscreen","fullscreenElement","fullscreenEnabled","fullscreenchange","fullscreenerror"],["webkitRequestFullscreen","webkitExitFullscreen","webkitFullscreenElement","webkitFullscreenEnabled","webkitfullscreenchange","webkitfullscreenerror"],["webkitRequestFullScreen","webkitCancelFullScreen","webkitCurrentFullScreenElement","webkitCancelFullScreen","webkitfullscreenchange","webkitfullscreenerror"],["mozRequestFullScreen","mozCancelFullScreen","mozFullScreenElement","mozFullScreenEnabled","mozfullscreenchange","mozfullscreenerror"],["msRequestFullscreen","msExitFullscreen","msFullscreenElement","msFullscreenEnabled","MSFullscreenChange","MSFullscreenError"]];for(let s,n=0,o=e.length;n<o;n++)if(s=e[n],s&&s[1]in i){for(n=0;n<s.length;n++)t[e[0][n]]=s[n];return t}return!1}();class r{static get isSupported(){return!1!==o}static request(t){let e=o.requestFullscreen;t=t||i.documentElement,/5\.1[.\d]* Safari/.test(navigator.userAgent)?t[e]():!0===n?t[e](Element.ALLOW_KEYBOARD_INPUT):t[e]()}static exit(){i[o.exitFullscreen]()}static toggle(t){r.isFullScreen?this.exit():this.request(t)}static get onChangeEventName(){return o.fullscreenchange}static get onErrorEventName(){return o.fullscreenerror}static get isFullScreen(){return Boolean(i[o.fullscreenElement])}static get element(){return i[o.fullscreenElement]}static get enabled(){return Boolean(i[o.fullscreenEnabled])}}},9537:(t,e,s)=>{"use strict";s.d(e,{_:()=>h});s(6992),s(3948),s(4916),s(5306);const i=s(6419),n=/[!'\(\)~]|%20|%00/g,o=/\+/g,r={"!":"%21","'":"%27","(":"%28",")":"%29","~":"%7E","%20":"+","%00":"\0"},a=t=>r[t],l={"%E0":"%D0%B0","%E1":"%D0%B1","%E2":"%D0%B2","%E3":"%D0%B3","%E4":"%D0%B4","%E5":"%D0%B5","%B8":"%D1%91","%E6":"%D0%B6","%E7":"%D0%B7","%E8":"%D0%B8","%E9":"%D0%B9","%EA":"%D0%BA","%EB":"%D0%BB","%EC":"%D0%BC","%ED":"%D0%BD","%EE":"%D0%BE","%EF":"%D0%BF","%F0":"%D1%80","%F1":"%D1%81","%F2":"%D1%82","%F3":"%D1%83","%F4":"%D1%84","%F5":"%D1%85","%F6":"%D1%86","%F7":"%D1%87","%F8":"%D1%88","%F9":"%D1%89","%FC":"%D1%8C","%FB":"%D1%8B","%FA":"%D1%8A","%FD":"%D1%8D","%FE":"%D1%8E","%FF":"%D1%8F","%C0":"%D0%90","%C1":"%D0%91","%C2":"%D0%92","%C3":"%D0%93","%C4":"%D0%94","%C5":"%D0%95","%A8":"%D0%81","%C6":"%D0%96","%C7":"%D0%97","%C8":"%D0%98","%C9":"%D0%99","%CA":"%D0%9A","%CB":"%D0%9B","%CC":"%D0%9C","%CD":"%D0%9D","%CE":"%D0%9E","%CF":"%D0%9F","%D0":"%D0%A0","%D1":"%D0%A1","%D2":"%D0%A2","%D3":"%D0%A3","%D4":"%D0%A4","%D5":"%D0%A5","%D6":"%D0%A6","%D7":"%D0%A7","%D8":"%D0%A8","%D9":"%D0%A9","%DC":"%D0%AC","%DB":"%D0%AB","%DA":"%D0%AA","%DD":"%D0%AD","%DE":"%D0%AE","%DF":"%D0%AF"};class h{constructor(t){this._params=new Map,i.isString(t)&&this.fromParamsString(t)}fromParamsString(t){"?"===t.charAt(0)&&(t=t.slice(1));for(let e,s,i=t.split("&"),n=0,o=i.length;n<o;n++)s=i[n],e=s.indexOf("="),e>-1?this.append(h.decode(s.slice(0,e)),h.decode(s.slice(e+1))):s.length&&this.append(h.decode(s),"");return this}static cp1251ToUTF8(t){let e,s="",i=t.length,n=0;for(;n<i;){e=0;for(let i in l)t.substring(n,n+3)===i&&(s+=l[i],n+=3,e=1);e||(s+=t.substring(n,n+1),n++)}return s}static decode(t){try{return decodeURIComponent(t.replace(o," "))}catch(e){}try{return t=h.cp1251ToUTF8(t),decodeURIComponent(t.replace(o," "))}catch(e){return t}}static encode(t){return encodeURIComponent(t).replace(n,a)}append(t,e){this.has(t)?this._params.get(t).push(String(e)):this.set(t,[String(e)])}has(t){return this._params.has(t)}set(t,e){this._params.set(t,[String(e)])}get(t){return this.has(t)?this._params.get(t)[0]:null}getAll(t){return this.has(t)?this._params.get(t):[]}entries(){return this._params.entries()}delete(t){this._params.delete(t)}clear(){return this._params.clear(),this}toString(){let t=[];for(let[e,s]of this.entries()){let i=h.encode(e);for(let e=0;e<s.length;e++)t.push(i+"="+h.encode(s[e]))}return t.join("&")}}},7912:(t,e,s)=>{"use strict";s.d(e,{E:()=>o});const i="undefined"==typeof window?{}:window.document;let n=function(){let t={},e=[["visibilityState","visibilitychange","hidden"],["webkitVisibilityState","webkitvisibilitychange","webkitHidden"],["msVisibilityState","msvisibilitychange","msHidden"]];for(let s,n=0,o=e.length;n<o;n++)if(s=e[n],s&&s[0]in i){for(n=0;n<s.length;n++)t[e[0][n]]=s[n];return t}return!1}();class o{static get isSupported(){return!1!==n}static get hidden(){return!!o.isSupported&&i[n.hidden]}static get isShown(){return!o.isSupported||!i[n.hidden]}static get visibilityState(){return o.isSupported?i[n.visibilityState]:"visible"}static get onChangeEventName(){return n&&n.visibilitychange}}},3432:(t,e,s)=>{"use strict";s.d(e,{Y:()=>h,b:()=>p});s(8674);var i=s(2134),n=s(8211);const o="/ajax/reputation.php";function r(t,e){var s=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),s.push.apply(s,i)}return s}function a(t){for(var e=1;e<arguments.length;e++){var s=null!=arguments[e]?arguments[e]:{};e%2?r(Object(s),!0).forEach((function(e){l(t,e,s[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(s)):r(Object(s)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(s,e))}))}return t}function l(t,e,s){return e in t?Object.defineProperty(t,e,{value:s,enumerable:!0,configurable:!0,writable:!0}):t[e]=s,t}class h{static async getMentions(t="",e,s=0,n){0!==s&&n||(n=Date.now());const{response:r,data:l}=await i.cf.post(o,{action:"get_mentions",time:n,offset:s,label_id:e,object_type:t});if(!r.result)throw new Error(r.message);return a(a({},l),{timestamp:n})}static getMentionsCSV(t="",e,s){let i=`/reputation/export-mentions?time=${s}`;t&&(i+=`&object_type=${t}`),e&&(i+=`&label_id=${e}`),window.open(i,"_blank")}static async getSidebarCounters(){const{response:t,data:e}=await i.cf.post(o,{action:"get_sidebar_counters"});if(!t.result)throw new Error(t.message);return e}static async findMentionsInText(t){if(!t)return n.vE.logger.log("reputation","empty text queried"),{clients:[]};const{response:e,data:s}=await i.cf.post(o,{action:"check_feedback_mention",text:t});if(!e.result)throw new Error(e.message);return s}static async markAsRead(t=[]){const{response:e}=await i.cf.post(o,{action:"mark_as_read",mentions:t});if(!e.result)throw new Error(e.message);return e.result}static async markAllAsRead(t=""){const{response:e}=await i.cf.post(o,{action:"mark_all_as_read",object_type:t});if(!e.result)throw new Error(e.message);return e.result}static async saveFeedback(t){const{response:e}=await i.cf.post(o,a({action:"save_feedback"},t));if(!e.result)throw new Error(e.message);return e.result}}var c=s(5538);function d(t,e){var s=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),s.push.apply(s,i)}return s}function u(t,e,s){return e in t?Object.defineProperty(t,e,{value:s,enumerable:!0,configurable:!0,writable:!0}):t[e]=s,t}class p{static get(){return m("get_labels",{},!0)}static add(t){return m("add_label",{name:t},!0).then((t=>t.label_id))}static rename(t,e){return m("rename_label",{id:t,name:e})}static delete(t){return m("delete_label",{id:t})}static stick(t,e){return m("stick_label",{object_id:t.id,object_type:t.type,id:e})}static unstick(t){return m("unstick_label",{object_id:t.id,object_type:t.type,id:t.labelId})}static clear(){return m("clear_labels")}static popup(t){return new c.D({target:t}).show().result()}}async function m(t,e={},s=!1){const{response:n,data:r}=await i.cf.post(o,function(t){for(var e=1;e<arguments.length;e++){var s=null!=arguments[e]?arguments[e]:{};e%2?d(Object(s),!0).forEach((function(e){u(t,e,s[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(s)):d(Object(s)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(s,e))}))}return t}({action:t},e));if(!n.result)throw new Error(n.message);return s?r:n.result}},2134:(t,e,s)=>{"use strict";s.d(e,{ff:()=>E,Wi:()=>d,cf:()=>f});s(6992),s(3948),s(8674);var i=s(6777);const n=s(9755),o=s(6419);class r extends i.vp{constructor(){super(),this._mocks=new Map}mock(t,...e){this.on(t,...e)}unmock(t,...e){this.off(t,...e)}findMock(t,...e){let s=this.listeners(t);if(o.isArray(s))for(let i of s.reverse()){let t=i.apply(this,e);if(t)return t}return!1}fetch(t,e){return new Promise(((s,i)=>{if(this.listeners(t)&&this.findMock(t,e.data,s,i))return!0;n.ajax(t,e).then(((t,e,n)=>{o.isObject(t)||(t={message:"Is not JSON",message_code:0}),t.result||t.status?s(t.data||t):i([n.status,t.message,t.message_code])}),((t,e)=>{i([t.status,e])}))}))}get(t,e={},s){return s=o.defaults(s||{},{type:"GET",dataType:"JSON",data:o.isObject(e)?e:{}}),this.fetch(t,s)}post(t,e={},s){return s=o.defaults(s||{},{type:"POST",dataType:"JSON",data:o.isObject(e)?e:{}}),this.fetch(t,s)}}let a=function(...t){let e,s;return 0===t.length?Promise.reject("Empty request"):(o.isObject(t[0])?(e=t[0].url,s=t[0]):(e=t[0],s=t[1]),n.ajax(e,s))},l=new r;a.get=l.get.bind(l),a.post=l.post.bind(l),a.mock=l.mock.bind(l),a.unmock=l.unmock.bind(l);s(4916),s(1817);var h=s(8211),c=s(9537);const d=200;var u=s(5718);s(6641);const p=s(9755),m=s(6419);let _=FileAPI.getXHR;FileAPI.getXHR=()=>{let t=_(),e=t.open;return t.open=(s,i,...n)=>{t.__requestURL=i,e.call(t,s,i,...n)},t};let g,v={status:d,message:"ok",messageCode:0,result:!1};class f{static mock(...t){g=g||new i.vp,g.on(...t)}static unmock(t){if(!g||!t.length)return!1;g.off(...t)}static response(t,e,s){return{response:{status:t,result:s=m.isBoolean(s)?s:!m.isUndefined(e)},data:e}}static async fetchMock(t){if(!g)return!1;let e,s=g.listeners(t.url);if(!m.isArray(s))return!1;for(let i of s)if(e=await i.callback(t),m.isObject(e))return h.vE.logger.log("request","mock",t.url),{response:m.defaults(e.response||{},{isMock:!0},v),data:e.data||{}};return!1}static fetchAJAX(t){let e,s=m.defaults({},v);return new Promise((i=>{p.ajax(t.url,t).then(((t,n,o)=>{if(s.status=o.status,s.message=n,m.isObject(t)){if("string"==typeof t.cookie_names){const e=t.cookie_names.split(",").filter((t=>void 0===h.eR.get(t)));e.length>0&&h.vE.logger.error("api",new Error(`not found cookie: ${e.join(", ")}`))}t.messageCode=t.message_code,delete t.message_code,e=t.data,delete t.data,m.extend(s,t)}else s.message=h.vE.i18n("request.500"),s.messageCode=0,s.result=!1,e=t;i({response:s,data:e})}),(n=>{switch(s.status=n.status,s.requestURL=t.url,!0){case 4===n.readyState&&200===n.status:s.message=h.vE.i18n("request.400");break;case 0===n.readyState:s.message=h.vE.i18n("request.network-error");break;case n.responseJSON&&Boolean(n.responseJSON.message):s.message=n.responseJSON.message;break;default:s.message=h.vE.i18n("request.400")}i({response:s,data:e})}))}))}static fetchFileAPI(t){let e,s=m.defaults({},v);return new Promise((i=>{m.isObject(t.xhrFields)&&t.xhrFields.withCredentials&&(FileAPI.withCredentials=!0),FileAPI.upload(m.extend({},t||{},{headers:{"X-Csrf-Token":h.vE.initParams.csrfToken},filecomplete:(t,n)=>{let o;if(s.status=n.status,n&&n.xhr&&(s.requestURL=n.xhr.__requestURL),413===n.status)s.message=h.vE.i18n("request.413");else s.message=n.statusText;if(t)return i({response:s,data:e}),!1;try{o=JSON.parse(n.response)}catch(r){h.vE.logger.error("request",r)}return o&&(m.isObject(o)?(o.messageCode=o.message_code,delete o.message_code,e=o.data,delete o.data,m.extend(s,o)):(s.message=h.vE.i18n("request.500"),s.messageCode=0,s.result=!1)),i({response:s,data:e}),!0}}))}))}static async fetch(t){let e=await f.fetchMock(t);if(e)return e;if(t&&t.useFileAPI)return await f.fetchFileAPI(t);const s=await f.fetchAJAX(t);return s.response.result||"text/csv"===t.dataType||h.vE.logger.error("api",new u.H(s.response.requestURL||s.response.message,s.response.status)),s}static convertURLSearchParams(t){let e={};for(let[s,i]of t.entries()){e[c._.encode(s)]=i.length<2?i[0]:i}return e}static _prepareOptions(t,e,s,i){return(s=s||{})instanceof c._&&(s=f.convertURLSearchParams(s)),i=m.defaults(i||{},{url:e,type:t,data:s,dataType:"JSON"}),(s instanceof FormData||"FormData"===s[Symbol.toStringTag])&&(i.processData=!1,i.contentType=!1),i.withCredentials&&(i.xhrFields=m.extend(i.xhrFields||{},{withCredentials:!0})),i}static get(t,e,s){return s=s||{},f._prepareOptions("get",t,e,s),f.fetch(s)}static post(t,e={},s){return s=s||{},f._prepareOptions("post",t,e,s),f.fetch(s)}static upload(t,e={},s,i){if(i=i||{},!s)throw new Error("not specified files to upload");if(0!==t.indexOf("http")&&h.vE.initParams.uploadServerUrl.length&&(t=h.vE.initParams.uploadServerUrl+t),m.isUndefined(i.withCredentials)&&(i.withCredentials=!0),i.useFileAPI=!!m.isUndefined(i.useFileAPI)||i.useFileAPI,i.useFileAPI){let t=(e=m.defaults(e||{},{uid:0})).uid;i.files={[t]:s}}else{i.cache=!1;let t=e;t instanceof FormData||(t=new FormData,m.forEach(e,((e,s)=>t.append(s,e))));let n=t.get("uid");(m.isNull(n)||m.isUndefined(n))&&(t.set("uid",0),n=0),s instanceof Blob?t.set(n,s,"imgae.png"):t.set(n,s),e=t}return f._prepareOptions("post",t,e,i),f.fetch(i)}}const y=s(6419),b="/ajax/upload_file.php",w=!1;class E{static async post(...t){return E._request(f.post,...t)}static async upload(...t){return E._request(f.upload,...t)}static async _request(t,...e){if(!1===w)return await t(b,...e);let s=y.uniqueId();h.vE.performance.mark(s);let i=await t(b,...e),{status:n,requestURL:o}=i.response;if(200!==n){let t=h.vE.performance.getEntryElapsed(s,void 0,0);await E.logUploadError({duration:t,requestURL:o,status:n})}return i}static async logUploadError(t){let{requestURL:e,duration:s,status:i}=t;f.post(w,{request_url:e,duration:s,status:i})}}},3589:(t,e,s)=>{"use strict";s.d(e,{T3:()=>O,F0:()=>A,GR:()=>k});s(8674);const i=s(6419);s(4916);var n=s(6572);const o=s(1068);class r{constructor(t,e){this._paramNames=[],this._stack=Array.isArray(e)?e:[e],this._path=t,"/"===this._path.charAt(0)&&(this._regexp=o.pathToRegexp(t,this._paramNames))}match(t){return this._regexp?this._regexp.test(t.path):t.pageName===this._path}params(t,e,s){let i=s||{};for(let o=e.length,r=0;r<o;r++)if(this._paramNames[r]){let t=e[r];i[this._paramNames[r].name]=t?n.cQ.safeDecodeURIComponent(t):t}return i}captures(t){return this._regexp?t.match(this._regexp).slice(1):[]}get stack(){return this._stack}}s(6992),s(3948),s(1817),s(5827);var a=s(6777),l=s(4519),h=s(8881),c=s(9377),d=s(7579),u=s(7111),p=(s(8559),s(8799)),m=s(1433),_=s(8204),g=s(6349);const v="rec-com-modal-community__btn-subscribe",f="rec-com-modal-community__btn-subscribe_on",y="rec-com-modal__btn-close",b="rec-com-modal__header-icon",w="rec-com-modal__btn-close_next";function E(t){var e,s="";Array.prototype.join;var i=!1;s+='\n<div class="rec-com-modal">\n    <div class="rec-com-modal__header">\n        <span class="rec-com-modal__header-icon"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon--ui__close"><use xlink:href="#icon--ui__close"></use></svg></span>\n        <span class="rec-com-modal__header-text">Рекомендации от Пикабу</span>\n    </div>\n    <p class="rec-com-modal__text">\n        На основе ваших посещений мы рекомендуем следующие <strong>сообщества:</strong>\n    </p>\n    <div class="rec-com-modal__content">\n        <ol class="rec-com-modal__list">\n            ';for(var n=0;n<t.length;n++)s+='\n                <li class="rec-com-modal-community">\n                    <div class="rec-com-modal-community__avatar">\n                        ',t[n].avatar?s+='\n                            <img src="'+(null==(e=t[n].avatar)?"":e)+'" alt=\'Аватар сообщества "'+(null==(e=t[n].name)?"":e)+"\"'>\n                        ":s+='\n                            <div class="community-avatar">\n                                <span class="community-avatar__default"></span>\n                            </div>\n                        ',s+='\n                    </div>\n                    <div class="rec-com-modal-community__wrapper">\n                        <div class="rec-com-modal-community__title">'+(null==(e=t[n].name)?"":e)+'</div>\n                        <div class="rec-com-modal-community__text">'+(null==(e=t[n].stories)?"":e)+' <span class="rec-com-modal-community__dot"></span> '+(null==(e=t[n].subs)?"":e)+"</div>\n                    </div>\n                    ",t[n].is_subscribed?(s+="\n                        ",i=!0,s+='\n                        <button type="button" class="button rec-com-modal-community__btn-subscribe rec-com-modal-community__btn-subscribe_on" data-id="'+(null==(e=t[n].id)?"":e)+'">\n                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon--ui__rss-delete"><use xlink:href="#icon--ui__rss-delete"></use></svg>\n                            <span class="rec-com-modal-community__btn-subscribe-text">Отписаться</span>\n                        </button>\n                    '):s+='\n                        <button type="button" class="button rec-com-modal-community__btn-subscribe" data-id="'+(null==(e=t[n].id)?"":e)+'" data-i="'+(null==(e=n+1)?"":e)+'">\n                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon--ui__rss-add"><use xlink:href="#icon--ui__rss-add"></use></svg>\n                            <span class="rec-com-modal-community__btn-subscribe-text">Подписаться</span>\n                        </button>\n                    ',s+="\n                </li>\n            ";return s+='\n        </ol>\n    </div>\n    <div class="rec-com-modal__footer">\n        <button type="button" class="button rec-com-modal__btn-close'+(null==(e=i?" rec-com-modal__btn-close_next":"")?"":e)+'">\n            '+(null==(e=i?"Продолжить":"Пропустить")?"":e)+"\n        </button>\n    </div>\n</div>"}function S(t,e,s){return e in t?Object.defineProperty(t,e,{value:s,enumerable:!0,configurable:!0,writable:!0}):t[e]=s,t}class C{constructor(){S(this,"contentType","rec_communities_after_reg"),S(this,"inProgress",!1),this.init()}async init(){if(await this.createPopup(),this.initSubscribeButtons(),this.initPopupClose(),this.popup){this.popup.show();const{content:t}=this.popup;t[0].scrollHeight>t[0].clientHeight&&t.css("height",t.css("max-height")),g.cp.getInstance().sendEvent("form_show",{content_type:this.contentType})}}async createPopup(){const{r:t,w:e}=_.U.getStorage(),s=Object.fromEntries([...Object.entries(t),...Object.entries(e)].slice(0,10)),i=await m.yV.getAfterSignUpRecommendations(s);null!=i&&i.length&&(this.popup=new p.LD({content:E(i),autoCloseOutsideClick:!1,autoClosePressEscape:!1,isFullSize:!0,isBlockOverflowTouch:!1}))}async toggleSubscribeState(t){var e,s;if(this.inProgress)return;this.inProgress=!0;const i=f,n=t.querySelector("span"),o=t.querySelector("svg use"),r=t.classList,a=r.contains(i),l=t.dataset.id,h=Number(t.dataset.i);if(!l)return;const c=new m.S1(l);await c.subscribe(!a,{type:"rec_community_after_reg",screen_index:h}),a?(n&&o&&(n.textContent="Подписаться",o.setAttribute("xlink:href","#icon--ui__rss-add")),r.remove(i)):(n&&o&&(n.textContent="Отписаться",o.setAttribute("xlink:href","#icon--ui__rss-delete")),r.add(i));const d=null!==(e=null===(s=this.$btnSubs)||void 0===s?void 0:s.filter("."+i).length)&&void 0!==e?e:0;this.updateBtnCloseState(d>0),this.inProgress=!1}initSubscribeButtons(){var t;this.popup&&(this.$btnSubs=this.popup.content.find("."+v),null===(t=this.$btnSubs)||void 0===t||t.on("click",(({currentTarget:t})=>{t instanceof HTMLButtonElement&&this.toggleSubscribeState(t)})))}initPopupClose(){var t;if(!this.popup)return;const e=this.popup.content;this.$btnClose=e.find("."+y);const s=e.find("."+b),i=()=>{var t;const e=null===(t=this.$btnClose)||void 0===t?void 0:t.hasClass(w);this.popup.hide(),g.cp.getInstance().sendEvent("form_interact",{content_type:this.contentType,type:e?"next":"skip"})};null===(t=this.$btnClose)||void 0===t||t.on("click",i),s.on("click",i)}updateBtnCloseState(t){var e;null!==(e=this.$btnClose)&&void 0!==e&&e.length&&(t?this.$btnClose.text("Продолжить").addClass(w):this.$btnClose.text("Пропустить").removeClass(w))}}var T=s(7585);class O extends l.u1{constructor(t,e){super(),this.parent=t,this.ctx=void 0}route(t,e){return this.ctx=t,this.show(),e()}show(){return this.isShown||(this.parent&&this.parent!==this&&this.parent instanceof O&&this.parent.onMatch(this.ctx,this),this._setBrowserSessionTS(),super.show(),this.$el&&this.$el.show(),this._options.isShown=!0,this._initSignUpRecommendedCommunitiesModal(),h.User.sendUserParamsOnSessionStart()),this}hide(){return this.isShown?(super.hide(),this._options.isShown=!1,this.$el&&this.$el.hide(),this):this}_setBrowserSessionTS(){c.x.get(c.q)||(c.x.set(c.q,Date.now()),d.sq.getInstance().init())}_initSignUpRecommendedCommunitiesModal(){!0===u.m.get(T.y)&&(new C,u.m.remove(T.y))}}class k extends O{constructor(t){super(t),this._currentPage=!1,this._router=new A(this),this.listenTo(this._router,"mismatch",this.onMismatch)}use(t,e){return this._router.use(t,e)}routers(){return this._router.routers()}showPage(t){this._currentPage!==t&&this.hidePage(this._currentPage),this._currentPage=t}hidePage(t){return t&&this._currentPage!==t?(t.hide(),this):this._currentPage?(this._currentPage.hide(),this._currentPage=!1,this):this}onMatch(t,e){this.ctx=t,this.isShown||this.show(),this!==e&&this.showPage(e)}onMismatch(){if(!this.isShown)return this;this.hidePage(),this.hide()}append(t){return!!this.$el&&(this.$el.append(t),this)}get router(){return this._router}}var I=s(5983);const $=s(6419);class A extends a.vp{constructor(t){super(),this.stack=[],this._pageMaster=t,this._symbols=new Map,this._symbolsInstance=new Map}use(t,e){if(e&&"string"==typeof t&&(t={[t]:e}),t instanceof A||t instanceof k||"function"==typeof t)return this.stack.push(t),this;for(let[s,i]of Object.entries(t)){i=Array.isArray(i)?i:[i];for(let[e,s]of i.entries()){if("object"!=typeof s&&"function"!=typeof s)throw new Error("router expects an object or function as a handler. look at boot.js");s.prototype instanceof O&&!(s.prototype instanceof k)&&(i[e]=this.getSymbol(s))}let t=new r(s,i);this.stack.push(t)}return this}getSymbol(t){return this._symbols.has(t)||this._symbols.set(t,Symbol()),this._symbols.get(t)}getInstance(t){if(this._symbolsInstance.has(t))return this._symbolsInstance.get(t);for(let[e,s]of this._symbols.entries())s===t&&this._symbolsInstance.set(t,new e(this._pageMaster,t));return this._symbolsInstance.get(t)}matchOnly(t){let e=$.some(this.stack,(e=>e instanceof A?e.matchOnly(t):e instanceof k?e.router.matchOnly(t):!!e.match(t)));return e||this.emit("mismatch"),e}match(t){let e=this.stack,s={route:!1};for(let i=e.length,n=0;n<i;n++){let i=e[n];i instanceof A?i.matchOnly(t)&&((s.stack=s.stack||[]).push(i),s.route=!0):i instanceof k?i.router.matchOnly(t)&&((s.stack=s.stack||[]).push(i),s.route=!0):i instanceof r?i.match(t)&&((s.stack=s.stack||[]).push(i),s.route=!0):(s.stack=s.stack||[]).push(i)}return s.route||this.emit("mismatch"),s}routers(){let t=this;return function(e,s){let n,o=e.path,a=t.match(e);return e.matched?e.matched.push.apply(e.matched,a.stack):e.matched=a.stack,a.route&&a.stack.length?(n=a.stack.reduce((function(s,i){return i instanceof A?(s.push(i.routers()),s):i instanceof k?(t.emit("match",e,i),s.push(i.router.routers()),s):i instanceof r?(s.push((function(t,e){return t.captures=i.captures(o),t.params=i.params(o,t.captures,t.params),e()})),i.stack.forEach((i=>{if(I.c.isSymbol(i)){let n=t.getInstance(i);t.emit("match",e.path,n),s.push(n)}else s.push(i)})),s):(s.push(i),s)}),[]),function(t){if(!Array.isArray(t))throw new TypeError("Middleware stack must be an array!");return function(e,s){let n=-1;return function o(r){if(r<=n)return Promise.reject(new Error("next() called multiple times"));n=r;let a=t[r]||s;if(!a)return Promise.resolve();try{return i.isObject(a)&&i.isFunction(a.route)&&(a=a.route.bind(a)),Promise.resolve(a(e,(function(){return o(r+1)})))}catch(l){return Promise.reject(l)}}(0)}}(n)(e,s)):$.isFunction(s)?s():Promise.resolve()}}}},9698:(t,e,s)=>{"use strict";s.d(e,{o:()=>_});s(4603),s(4916),s(5306);const i={amp:/&/g,lt:/</g,gt:/>/g,apos:/'/g,quot:/"/g,chars:/[&<>"']/},n=/&quot;/g,o=/&#39;/g,r=/&lt;/g,a=/&gt;/g,l=/&amp;/g,h={space:/[\s\uFEFF\xA0][\s\uFEFF\xA0]+/g,lr:/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,l:/^[\s\uFEFF\xA0]+/g,r:/[\s\uFEFF\xA0]+$/g},c=/[^0-9A-Za-zА-Яа-яЁё`’!&?:\-+_;," ()]+/g,d=/[^0-9A-Za-zА-Яа-яЁё`’!&?:\-+_;,"*]+/g,u=/(?!\*$)\*/g,p=/<[^>]*>/g,m=/(https?:\/\/)[^\s"'`\]\[{}<>^|]+/gi;class _{static blacklist(t){let e=new RegExp("["+t+"]+","g");return t=>t.replace(e,"")}static whitelist(t){let e=new RegExp("[^"+t+"]+","g");return t=>t.replace(e,"")}static toTag(){return t=>t.replace(c,"")}static toKeyword(){return t=>t.replace(d,"").replace(u,"")}static toInt(t=10){return e=>parseInt(e,t)}static toFloat(){return t=>parseFloat(t)}static toBoolean(t){return e=>t?"true"===e||"1"===e:"0"!==e&&"false"!==e&&""!==e}static toLowerCase(){return t=>t.toLowerCase()}static toUpperCase(){return t=>t.toUpperCase()}static trim(t){let e=t?new RegExp("^["+t+"]+|["+t+"]+$","g"):h.lr;return t=>t.replace(e,"")}static ltrim(t){let e=t?new RegExp("^["+t+"]+","g"):h.l;return t=>t.replace(e,"")}static rtrim(t){let e=t?new RegExp("["+t+"]+$","g"):h.r;return t=>t.replace(e,"")}static singleSpace(){return t=>t.replace(h.space," ")}static escape(){return t=>i.chars.test(t)?t.replace(i.amp,"&amp;").replace(i.lt,"&lt;").replace(i.gt,"&gt;").replace(i.apos,"&#39;").replace(i.quot,"&quot;"):t}static unescape(){return t=>t.replace(l,"&").replace(r,"<").replace(a,">").replace(o,"'").replace(n,'"')}static clearHTMLTags(){return t=>t.replace(p,"")}static clearURLs(){return t=>t.replace(m,"")}}},8941:(t,e,s)=>{"use strict";s.d(e,{n:()=>S,C:()=>f});s(8674);var i=s(4877),n=s(2630),o=s(9717);s(4916),s(5306);let r,a;!function(t){t.BLUR="blur"}(r||(r={})),function(t){t.UP_BUTTON_ACTIVE="pkb-app__up-btn_active"}(a||(a={}));var l=s(7025),h=s(4519);class c extends i.u{constructor(t){super(t),this.els={hour:this.el.querySelector(".pkb-input-time__input_hour"),minute:this.el.querySelector(".pkb-input-time__input_minute")},this.init()}get value(){return 60*Number(this.els.hour.value)+Number(this.els.minute.value)||0}set value(t){this.els.hour.value=String(Math.floor(t/60)),this.els.minute.value=String(t%60),this.fixTime()}init(){this.els.hour.addEventListener("input",(()=>{c.clearInput(this.els.hour),2===this.els.hour.value.length&&this.els.minute.select()})),this.els.minute.addEventListener("input",(()=>c.clearInput(this.els.minute))),this.els.hour.addEventListener("focus",(()=>this.els.hour.select())),this.els.minute.addEventListener("focus",(()=>this.els.minute.select())),this.els.hour.addEventListener("blur",(()=>{this.fixTime(),this.emit(r.BLUR)})),this.els.minute.addEventListener("blur",(()=>{this.fixTime(),this.emit(r.BLUR)})),this.fixTime()}fixTime(){const t=Math.min(Number(this.els.hour.value)||0,23),e=Math.min(Number(this.els.minute.value)||0,59);this.els.hour.value=String(t).padStart(2,"0"),this.els.minute.value=String(e).padStart(2,"0")}showError(t){this.errorHint||(this.errorHint=new l._({direction:o.Lh.TOP,alignment:o.SE.CENTER,theme:o.xb.DANGER,target:this.el,autoCloseOutsideClick:!1}),this.errorHint.on(h.eM.HIDDEN,(()=>this.el.classList.remove("pkb-input-time_error"))),this.els.hour.addEventListener("focus",(()=>this.hideError())),this.els.minute.addEventListener("focus",(()=>this.hideError()))),this.errorHint.content=`<div class="popup__hint">${t}</div>`,this.errorHint.show(),this.el.classList.add("pkb-input-time_error")}hideError(){var t;null===(t=this.errorHint)||void 0===t||t.hide()}static clearInput(t){t.value=t.value.slice(0,2).replace(/\D/,"")}get el(){return super.el}}var d=s(381),u=s.n(d),p=s(6349);let m,_;!function(t){t.ALERT_LINK="scheduled-story-alert__link",t.POPUP_WRAPPER="scheduled-story-popup-wrapper",t.POPUP_REMOVE="scheduled-story-popup__remove-btn",t.POPUP_EDIT="scheduled-story-popup__edit",t.SETTINGS_FIELD="scheduled-story-settings",t.SETTINGS_FIELD_DISABLED="scheduled-story-settings_disabled",t.SETTINGS_CHECKBOX="scheduled-story-settings__checkbox",t.SETTINGS_LABEL="scheduled-story-settings__label",t.SETTINGS_OPTIONS="scheduled-story-settings__options",t.SETTINGS_OPTIONS_ACTIVE="scheduled-story-settings__options_active",t.SETTINGS_DATE="scheduled-story-settings__date",t.SETTINGS_TIME="scheduled-story-settings__time",t.SETTINGS_NOTIFICATION="scheduled-story-settings__notification"}(m||(m={})),function(t){t.STORIES="modules.scheduled-stories"}(_||(_={}));var g=s(8211),v=s(9161);class f extends i.u{constructor(t){super(t),this.els={field:document.querySelector(`.${m.SETTINGS_FIELD}`),checkbox:document.querySelector(`.${m.SETTINGS_CHECKBOX} input`),label:document.querySelector(`.${m.SETTINGS_LABEL}`),options:document.querySelector(`.${m.SETTINGS_OPTIONS}`),date:document.querySelector(`.${m.SETTINGS_DATE}`),dateSelect:document.querySelector(`.${m.SETTINGS_DATE} select`),time:document.querySelector(`.${m.SETTINGS_TIME}`)},this.isDisabled||(this.init(),this.showNotification())}init(){this.els.dateSelect&&this.els.time&&(this.els.dateSelect.addEventListener("change",(()=>this.handleDateTimeChange())),this.timeField=new c({el:this.els.time}),this.timeField.on(r.BLUR,(()=>this.handleDateTimeChange())),this.els.checkbox.addEventListener("change",(()=>{this.isChecked&&!g.vE.config("modules.story-editor.schedule_id")&&p.cp.getInstance().sendEvent("mark_scheduled",{type:"scheduled_post"}),this.handleCheckboxChange(!0)})),this.handleCheckboxChange())}handleCheckboxChange(t){this.els.options&&(this.isChecked?(this.setDefaultOptions(),this.handleDateTimeChange(),this.els.options.classList.add(m.SETTINGS_OPTIONS_ACTIVE),t&&this.els.options.scrollIntoView({block:g.vE.isMobileApp?"center":"nearest",behavior:"smooth"})):(this.els.checkbox.value="",this.els.options.classList.remove(m.SETTINGS_OPTIONS_ACTIVE)))}setDefaultOptions(){if(!this.els.dateSelect||!this.timeField)return;const t=1e3*Number(this.els.checkbox.value);let e=new Date(t);t&&!isNaN(e.getTime())||(e=new Date,e.setHours(e.getHours()+1)),this.timeField.value=60*e.getHours()+e.getMinutes();const s=new Array(8).fill(null).map(((t,s)=>{const i=new Date;return i.setHours(0,0,0,0),i.setDate(i.getDate()+s),{date:i.getTime(),title:u()(i).format("DD.MM.YYYY (dd)"),selected:i.getDate()===e.getDate(),disabled:!1}}));var i,n,o;s.some((t=>t.selected))||s.unshift({date:e.getTime(),title:u()(e).format("DD.MM.YYYY (dd)"),selected:!0,disabled:!0}),this.els.dateSelect.innerHTML=(i={days:s},o="",Array.prototype.join,i.days.forEach((t=>{o+='\n<option value="'+(null==(n=t.date)?"":n)+'" '+(null==(n=t.selected?"selected":"")?"":n)+" "+(null==(n=t.disabled?"disabled":"")?"":n)+">\n    "+(null==(n=t.title)?"":n)+"\n</option>\n"})),o+="\n")}handleDateTimeChange(){if(!this.els.dateSelect||!this.timeField)return;const t=this.validateDateTime(),e=String(this.value);this.els.checkbox.value!==e&&(this.els.checkbox.value=e),t?this.timeField.hideError():this.timeField.showError("Неверное время публикации")}validateDateTime(){if(!this.els.dateSelect||!this.timeField)return!1;const t=new Date(Number(this.els.dateSelect.value));return t.setHours(0,this.timeField.value),t>new Date}async showNotification(){const t=await(0,n.kd)({id:"scheduled-story-settings",target:this.els.label,text:"\n\t\t\t\tНовая экспериментальная функция на Пикабу.\n\t\t\t\tМы надеемся, что она окажется полезной для авторов и станет постоянной. Попробуете? &#x270f;&#xfe0f;\n\t\t\t",theme:o.xb.GREEN,direction:o.Lh.TOP,alignment:o.SE.CENTER,delay:500,wrapperExtraClass:m.SETTINGS_NOTIFICATION,hideByScroll:!1});null==t||t.once(v.e.MOUNTED,(()=>{p.cp.getInstance().sendEvent("tip_show",{type:"scheduled_post"})})),null==t||t.once(v.e.HIDDEN,(()=>{p.cp.getInstance().sendEvent("tip_close",{type:"scheduled_post"})}))}get isDisabled(){var t;return Boolean(null===(t=this.els.field)||void 0===t?void 0:t.classList.contains(m.SETTINGS_FIELD_DISABLED))}get isChecked(){return this.els.checkbox.checked}get value(){if(!this.els.dateSelect||!this.timeField)return null;const t=new Date(Number(this.els.dateSelect.value));return t.setHours(0,this.timeField.value),Math.floor(t.getTime()/1e3)||null}updateSettings(t){this.els.dateSelect&&this.timeField&&(this.els.checkbox.checked=Boolean(t),this.els.checkbox.value=String(t),this.handleCheckboxChange())}}s(2707);var y=s(8799),b=s(2134);function w(t){var e,s="";Array.prototype.join;return s+='<div class="scheduled-story-popup">\n    ',t.isMobile?s+='\n        <header class="pkb-header-pop-up scheduled-story-popup__header">\n            <button type="button" class="pkb-icon-btn pkb-icon-btn_dark pkb-header-pop-up__back-btn" data-role="close">\n                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon--ui__close_20"><use xlink:href="#icon--ui__close_20"></use></svg>\n            </button>\n            <div class="pkb-header-pop-up__title">Отложенные посты</div>\n        </header>\n    ':s+='\n        <div class="pkb-block-header scheduled-story-popup__header">\n            <div class="pkb-block-header__title">Отложенные посты</div>\n            <div class="pkb-block-header__right-bar">\n                <button type="button" class="pkb-icon-btn pkb-icon-btn_dark" data-role="close">\n                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon--ui__close_16"><use xlink:href="#icon--ui__close_16"></use></svg>\n                </button>\n            </div>\n        </div>\n    ',s+='\n    <div class="scheduled-story-popup__body">\n        ',t.stories.forEach((t=>{s+='\n            <a class="pkb-story-draft scheduled-story-popup__edit" href="/edit/'+(null==(e=t.id)?"":e)+'?m=schedule">\n                <div class="pkb-story-draft__header">\n                    <h3 class="pkb-story-draft__title">\n                        '+(null==(e=t.title)?"":e)+'\n                    </h3>\n                    <time class="pkb-story-draft__date" datetime="'+(null==(e=t.date)?"":e)+'">'+(null==(e=t.dateString)?"":e)+'</time>\n                    <div class="pkb-story-draft__header-bar">\n                        <button type="button" class="pkb-icon-btn scheduled-story-popup__remove-btn" data-id="'+(null==(e=t.id)?"":e)+'">\n                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon--ui__delete_16"><use xlink:href="#icon--ui__delete_16"></use></svg>\n                        </button>\n                    </div>\n                </div>\n                ',t.text&&(s+='<div class="pkb-story-draft__text">'+(null==(e=t.text)?"":e)+"</div>"),s+="\n                ",t.mediaCount&&(s+='\n                    <div class="pkb-story-draft__media">\n                        ',t.hasImage&&(s+='<div class="pkb-story-draft__media-icon"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon--ui__photo_20"><use xlink:href="#icon--ui__photo_20"></use></svg></div>'),s+="\n                        ",t.hasVideo&&(s+='<div class="pkb-story-draft__media-icon"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon--ui__play_20"><use xlink:href="#icon--ui__play_20"></use></svg></div>'),s+='\n                        <div class="pkb-story-draft__media-count">'+(null==(e=t.mediaCount)?"":e)+"</div>\n                    </div>\n                "),s+="\n            </a>\n        "})),s+="\n    </div>\n</div>\n"}var E=s(3310);class S extends i.u{constructor(t){super(t),this.els={popupLink:document.querySelector(`.${m.ALERT_LINK}`)},this.init()}init(){var t;this.autoScrollToAlert(),null===(t=this.els.popupLink)||void 0===t||t.addEventListener("click",(t=>{t.preventDefault(),this.openStoriesPopup(),p.cp.getInstance().sendEvent("click",{type:"scheduled_list",size:g.vE.config(_.STORIES).length})}))}autoScrollToAlert(){if("scheduled-story-alert"!==g.vE.history.hash||!this.els.popupLink)return;const t=this.els.popupLink.offsetTop-window.innerHeight/2;window.scrollTo({top:t,behavior:"smooth"})}openStoriesPopup(){var t;const e=g.vE.config(_.STORIES).map((t=>{const e=t.imageCount+t.videoCount,s=new Date(1e3*t.createdAt);return{id:t.id,title:t.title,date:s.getTime(),dateString:u()(s).format("DD.MM.YYYY HH:mm"),text:t.text,hasImage:t.imageCount>0,hasVideo:t.videoCount>0,mediaCount:e}})).sort(((t,e)=>t.date-e.date)),s=new y.LD({wrapperExtraClass:m.POPUP_WRAPPER,content:w({isMobile:g.vE.isMobileApp,stories:e}),destroyAfterHide:!0,isBlockOverflowTouch:!g.vE.isMobileApp});s.show(),null===(t=s.el.querySelector('button[data-role="close"]'))||void 0===t||t.addEventListener("click",(()=>s.hide())),s.el.querySelectorAll(`.${m.POPUP_REMOVE}`).forEach(((t,e)=>{t.addEventListener("click",(t=>{t.preventDefault(),t.stopPropagation(),S.handleRemoveButtonClick(t),p.cp.getInstance().sendEvent("click",{type:"scheduled_post_delete",size:g.vE.config(_.STORIES).length,screen_index:e+1})}))})),s.el.querySelectorAll(`.${m.POPUP_EDIT}`).forEach(((t,e)=>{t.addEventListener("click",(()=>{p.cp.getInstance().sendEvent("click",{type:"scheduled_post_edit",size:g.vE.config(_.STORIES).length,screen_index:e+1})}))}))}static async handleRemoveButtonClick(t){const e=await l.nk.confirmModal({content:"Вы действительно хотите удалить отложенный пост?",buttons:[["modal.remove",E.j.DANGER,!0],["modal.cancel"]]});if(p.cp.getInstance().sendEvent("click",{type:e?"scheduled_post_delete_confirm":"scheduled_post_delete_cancel"}),!e)return;const s=t.target,{response:i}=await b.cf.post("/ajax/gtpost_actions.php",{action:"remove_schedule",schedule_id:s.dataset.id});if(!i.result)throw g.vE.ui.toasts.showError(i.message),i.message;window.location.reload()}}},3968:(t,e,s)=>{"use strict";s.d(e,{mB:()=>n,k0:()=>a,YD:()=>h,bF:()=>o});s(8674),s(8211);var i=s(2134);class n{constructor(){}static async getList(t,e,s){if(!t||"string"!=typeof t)throw new Error("Ignore list type was not specified or has an invalid type");let n,o,r;switch(t){case"users":n="get_users_ignore_list",o="from_id";break;case"tags":n="get_tags_ignore_list",o="from_tag";break;case"communities":n="get_communities_ignore_list",o="from_id"}r=s?`/ajax/users_actions.php?action=${n}&search=${e}&${o}=${s}`:`/ajax/users_actions.php?action=${n}&search=${e}`;let{response:a,data:l}=await i.cf.get(r);if(!a.result)throw new Error(a.message);return{list:l.list,total:l.total,hasMore:l.has_more,allRecordsCount:l.all_records_count}}}class o{constructor(){}static async getList(t,e,s){if(!t||"string"!=typeof t)throw new Error("Subs list type was not specified or has an invalid type");let n,o,r;switch(t){case"users":n="get_users_subs_list",o="from_id";break;case"tags":n="get_tags_subs_list",o="from_tag";break;case"communities":n="get_communities_subs_list",o="from_id"}r=s?`/ajax/users_actions.php?action=${n}&search=${e}&${o}=${s}`:`/ajax/users_actions.php?action=${n}&search=${e}`;let{response:a,data:l}=await i.cf.get(r);if(!a.result)throw new Error(a.message);return{list:l.list,total:l.total,hasMore:l.has_more,allRecordsCount:l.all_records_count}}}var r=s(9050);class a{static async getList(t,e){if("users"===e){let{response:e,data:s}=await i.cf.get("/ajax/users_actions.php",{action:"droplist",q:t});return e.result||(s=[]),s}if("tags"===e){let e,{response:s,data:n}=await i.cf.get("/ajax/tags_actions.php",{action:"tagsline",value:t});return e=s.result?n.tags.map((t=>({label:t[0],info:t[1]}))):[],e}if("communities"===e){let{response:e,data:s}=await i.cf.get("/ajax/gtpost_actions.php",{action:"search_communities",name:t});return e.result?(s=r.isArray(s)?s:[],s.forEach((t=>t.id=Number(t.id)))):s=[],s}}}var l=s(2822);class h{static async setCategoriesOrder(t){let{response:e}=await i.cf.post("/ajax/stories_actions.php",{action:"reorder_save_categories",order:t.join(","),dataType:"json"});if(!e.result)throw new Error(e.message)}static async renameCategory(t,e){let{response:s}=await i.cf.post("/ajax/stories_actions.php",{action:"rename_save_category",cat_id:e,name:t,dataType:"json"});if(!s.result)throw new Error(s.message)}static async add(t){let{response:e,data:s}=await i.cf.post("/ajax/stories_actions.php",{action:"create_save_category",name:t});if(!e.result)throw new Error(e.message);return l.c.getInstance().sendEvent("save_category_create",{folder_id:s.id,folder:t}),Number(s.id)}static async deleteCategory(t,e){let{response:s}=await i.cf.post("/ajax/stories_actions.php",{action:"delete_save_category",cat_id:t,move_to_cat_id:e,dataType:"json"});if(!s.result)throw new Error(s.message)}static async changeSettings(t){let{response:e}=await i.cf.post("/ajax/users_actions.php",{action:"change_settings",hide_save_stories_menu:t?"1":"0",dataType:"json"});if(!e.result)throw new Error(e.message)}static async addOrRemoveStory(t,e,s=0,n="",o={}){let r={action:"save_story"+(t?"+":"-"),story_id:e,dataType:"json"};t&&(r.cat_id=s,r.cat_name=n);let{response:a,data:h}=await i.cf.post("/ajax/stories_actions.php",r);if(!a.result)throw new Error(a.message);return t&&(o.folder=n,l.c.getInstance().sendEvent("save_post",o)),Number(h.cat_id)}}s(1712)},1712:(t,e,s)=>{"use strict";s.d(e,{F:()=>o});s(8674);var i=s(2134),n=s(6889);class o{static async search(t=""){const e=n.h.getInstance("searchProfessions");if(e.has(t))return e.get(t);let s=i.cf.post("/ajax/occupations_actions.php",{action:"get_by_name",name:t});return s=s.then((s=>e.set(t,s.response.result?s.data:[]))),s}static async save(t=""){let e=i.cf.post("/ajax/occupations_actions.php",{action:"assign",name:t});return e=e.then((t=>t.response.result)),e}static hasSearchCache(t=""){const e=n.h.getInstance("searchProfessions");return e.has(t)&&!(e.get(t)instanceof Promise)}}},3086:(t,e,s)=>{"use strict";s.d(e,{S:()=>n});s(8674);let i;!function(t){t.VK="vk",t.FACEBOOK="fb",t.TWITTER="tw",t.GOOGLE="google"}(i||(i={}));class n{async link(t){return new Promise((e=>{const s=screen.width/2-512,i=screen.height/2-350;window.pkbOAuthCallback=t=>{window.pkbOAuthCallback=null,e(t)},window.open(`/oauth.php?type=${t}&ref=js`,"oauth",`left=${s},top=${i},width=1024,height=700,popup=yes`)}))}}},9404:(t,e,s)=>{"use strict";s.d(e,{An:()=>i,CL:()=>n,$U:()=>o,uD:()=>r,q1:()=>a,EB:()=>l,Qs:()=>h,W5:()=>c,sC:()=>d,wE:()=>u,U5:()=>p,Oq:()=>m,Ag:()=>_,A0:()=>g,Mz:()=>v,fo:()=>f,of:()=>y,R$:()=>b,kY:()=>w,XA:()=>E,wn:()=>S,qC:()=>C,ok:()=>T,qn:()=>O});const i=15e5,n=1,o="pkb_SFs",r="pkb_ST",a=20,l=".image-lazy",h="image-loaded",c=1500,d="pkb_svce",u="pkb_ssvc",p=100,m=1200,_=120,g="vn_buff",v=3e3,f="pkb_nhvn",y="pkb_nhvh",b="pkb_sve",w="pkb_ave",E=1200,S="last-story",C="story-skeleton",T=["user-profile","profile","cedit","related","story","community-queue","adverts"],O=5e3},975:(t,e,s)=>{"use strict";s.d(e,{DV:()=>n,kc:()=>o,rg:()=>r,y$:()=>a});var i=s(7892);new i.xs({NEW:0,HOT:1,BEST:2,MOST_SAVED:3});const n=new i.xs({NEW:"new",HOT:"hot",BEST:"best",RECOMMEND:"recommend",VISITED:"visited",SUBS:"subs",MOST_SAVED:"most-saved",COMMUNITIES:"communities",DISPUTED:"disputed",COMMUNITY_SEARCH:"community-search",COMMUNITY:"community",COMPANIES:"companies"}),o=new i.xs({VISITED_STORIES_SHOW:0,VISITED_STORIES_COLLAPSE:1,VISITED_STORIES_HIDE:2}),r=new i.xs({VISITED_STORIES_SHOW:"show",VISITED_STORIES_COLLAPSE:"collapse",VISITED_STORIES_HIDE:"hide"}),a=new i.xs({TIME:"time",ACTUAL:"act"});new i.xs({ALL:0,POSITIVE:1}),new i.xs({USERS:1,TAGS:2,COMMUNITIES:4})},9626:(t,e,s)=>{"use strict";s.d(e,{kc:()=>i.kc,of:()=>n.of,fo:()=>n.fo,DV:()=>i.DV,_h:()=>x,nT:()=>ft,mC:()=>D,FG:()=>o});var i=s(975),n=s(9404);const o={item:"stories-feed",container:"stories-feed__container",spinner:"stories-feed__spinner",spinnerBefore:"stories-feed__spinner-before",loadingBefore:"stories-feed__load-before",pagination:"stories-feed-pagination",emailForm:"email-block",relatedStoriesAdv:"stories-feed__related-stories-adv",adDisclaimer:"story__sponsor_disclaimer",message:{item:"stories-feed__message",show:"stories-feed__message_show"},messageSubs:{item:"stories-feed__subs-message",show:"stories-feed__subs-message_show",innerBlock:"stories-feed__subs-message-b"},hiddenCounter:{item:"hidden-counter",shown:"hidden-counter_shown"},filter:{hideVisitedMark:"button-filter_hide-visited",fields:{hideVisited:'stories-feed-filter__field[data-role="hide-visited"]'},fieldHighlight:"stories-feed-filter__field_highlight"},subscriptionsFilter:{filterSkeleton:"subscriptions-filter_skeleton",item:"subscriptions-filter__item",itemActive:"subscription-item_active"}};s(8674),s(6992),s(3948),s(4916);var r=s(4519),a=s(8211),l=s(2906),h=s(4002),c=s(381),d=s.n(c),u=s(9755),p=s.n(u),m=s(7800),_=s(2822),g=s(4069),v=(s(5827),s(4877)),f=s(4113),y=s(1471),b=s(6349);const w=o.subscriptionsFilter;class E extends v.u{constructor(t){var e,s,i;super(t),i=!1,(s="isExpanded")in(e=this)?Object.defineProperty(e,s,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[s]=i,this.el&&(this.initEventListeners(),this.initExpandButtonHandler())}initExpandButtonHandler(){var t;const e=(0,y.P)(this.showExpandButton.bind(this),100);this.resizeObserver=new ResizeObserver(e),this.resizeObserver.observe(this.el),e(),null===(t=this.el)||void 0===t||t.classList.remove(w.filterSkeleton)}initEventListeners(){var t;null===(t=this.el)||void 0===t||t.addEventListener("click",(t=>{const e=t.target.closest("."+w.item);e&&this.onItemClick(e)}))}onItemClick(t){if(t&&!this.isActive(t)){this.setActive(t);const{l:e,t:s,i}=t.dataset;this.sendAnalytics(s,i),e&&this._options.onItemClick(e)}}sendAnalytics(t,e){let s;if(t){let i;i="tag"===t?"tag_id":"user"===t?"author_id":"community_id",s={type:"sub",[i]:e}}else s={type:"sub_all"};b.cp.getInstance().sendEvent("filter",s)}isActive(t){return t.classList.contains(w.itemActive)}setActive(t){var e,s;null===(e=this.el)||void 0===e||null===(s=e.querySelector("."+w.itemActive))||void 0===s||s.classList.remove(w.itemActive),t.classList.add(w.itemActive)}showExpandButton(){var t;if(this.isExpanded)return;let e=this.expandButton;const s=null===(t=this.el)||void 0===t?void 0:t.firstElementChild;if(s.scrollHeight>s.offsetHeight){e||(e=this.createExpandButton(),s.append(e),this.expandButton=e);const t=e.offsetWidth+20;e.style.setProperty("display","none");const i=s.getBoundingClientRect(),n=i.width/2,o=Array.from(s.children).filter((t=>t!==e&&t.offsetTop>0&&t.offsetTop<i.height));if(o.length<2)return;const r=o.reduce(((t,e)=>t+Math.max(0,e.getBoundingClientRect().width-n)),0),a=o[o.length-1],l=i.right-a.getBoundingClientRect().right+r>=t?a:o[o.length-2];e.previousElementSibling===l||l.insertAdjacentElement("afterend",e),e.style.removeProperty("display")}else{var i;null===(i=e)||void 0===i||i.remove()}}createExpandButton(){const t=document.createElement("button");return t.innerHTML=(0,f.t)("ui__dots"),t.classList.add("subscriptions-filter__show-more"),t.addEventListener("click",this.expand.bind(this)),t}expand(){var t,e,s;null===(t=this.expandButton)||void 0===t||t.remove(),null===(e=this.el)||void 0===e||e.classList.remove("subscriptions-filter_collapsed"),this.isExpanded=!0,null===(s=this.resizeObserver)||void 0===s||s.disconnect()}}var S=s(5271),C=s(2630),T=s(9717),O=s(8799),k=s(3040),I=s(9050);function $(t,e){var s=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),s.push.apply(s,i)}return s}function A(t,e,s){return e in t?Object.defineProperty(t,e,{value:s,enumerable:!0,configurable:!0,writable:!0}):t[e]=s,t}const x=["today","month","week","all"];class D extends r.u1{render(){return this.$els={target:this.$(".button-filter"),menuItems:this.$(".menu__item"),linkAll:this.$('.menu__item[type="all"]'),linkSubs:this.$('.menu__item[type="subs"]'),politicsBtn:this.$(".button-filter_politics"),calendarCustom:{el:void 0,title:void 0}},this.feedType===i.DV.SUBS&&this._initSubscriptionsFilter(),super.render(),S.V.isUserInExperiment(S.t.HIDE_POLITICS,"checkbox")&&(this.$els.politicsBtn.on("click",this._handlePoliticsBtnClick.bind(this)),this._showPoliticsFilterNotification()),this}_initSubscriptionsFilter(){const t=this.$parent[0].querySelector(".subscriptions-filter");t&&new E({el:t,onItemClick:t=>{a.ZP.history.replaceUrl(t),this._updateFeed(t)}})}_reset(){}_update(){this.filter.update({date:this.feedDateFilterParameters.defaultDate,dateCaption:""}),this._updateMenuItems(),this._updateFeed(a.ZP.history.pathname)}_updateFeed(t=a.ZP.history.pathname){if(!this.isRendered)return;const e=Boolean(this.filter.data.isSortedByTime);this._options.inlineFiltersMode||this.$els.target.toggleClass("button-filter_dot-visible","hot"===this.feedName&&e),t&&(this.feed.requestUrl=t),this.feed.clear(),this.feed.loadStories(!1)}_updateMenuItems(){const t=this.feedName;this.$els.menuItems.each(((e,s)=>{const i=p()(s);switch(i.attr("type")){case"all":i.attr("href","hot"===t?"/":"/"+t);break;case"subs":i.attr("href","/"+t+"/subs");break;case"custom":const e=i.attr("data-name");i.attr("href","/"+t+"/feed/"+e)}const n=i.attr("href")===a.ZP.history.pathname;i.toggleClass("menu__item_current",n)}))}_changeSortByTime(){if("hot"!==this.feedName)return;const t=Boolean(this.filter.data.isSortedByTime),e=t?i.y$.TIME:i.y$.ACTUAL;this.feed.searchParams.set("f",e.value),_.c.getInstance().sendEvent("filter",{filter_type:t?"new":"actual"}),this._updateFeed()}_getRange(){const t=this.calendar.selectedDates,e=(0,h.g)(t.start,t.end,this.calendar.getMinDate());return t.startDate=d()(t.start).format("DD-MM-YYYY"),t.endDate=d()(t.end).format("DD-MM-YYYY"),t.type=e||(this.calendar.isFullRangeSelected?"all":void 0),t}_onSelectRange(){var t,e;const s=this._getRange();let n=x.includes(s.type)?"Выбрать дату":s.caption;if(this.feedType===i.DV.HOT){const t=this._getUrlByDate("best",s);return a.ZP.history.redirect(t),!1}null===(t=this.$els.calendarCustom.el)||void 0===t||t.toggleClass("stories-feed-filter__field_current",!s.type),this._options.shortCalendarCustomTitle&&s.start&&s.end&&(n=this._getCalendarCustomShortTitle(s.start.toDateString(),s.end.toDateString())),null===(e=this.$els.calendarCustom.title)||void 0===e||e.text(n);const o=this._getUrlByDate(this.feedType.valueOf(),s);return a.ZP.history.replaceUrl(o),this._updateFeed(o),!0}_getCalendarCustomShortTitle(t,e){const s="DD.MM.YYYY";let i=d()(new Date(t)).format(s);return e&&t!==e&&(i+=" - "+d()(new Date(e)).format(s)),i}_getUrlByDate(t,e){const s="/"+t;return e.type===this.feedDateFilterParameters.defaultDate?s:e.type&&"random"!==e.type&&this.feedDateFilterParameters.useUrlShortcuts?s+"/"+e.type:I.isNull(e.start)&&I.isNull(e.end)?s:s+"/"+(e.startDate===e.endDate?e.startDate:e.startDate+"_"+e.endDate)}_isRange(t){return["all","month","week","today","random"].includes(t)}_isNeedShowHint(){return!m.m.get(n.fo,!1)&&this.$els.target&&this.$els.target.data("hide-visited")}_onChangeFilter(){}async _showPoliticsFilterNotification(){const t=await(0,C.kd)({id:"politics-show-filter",target:this.$els.politicsBtn,text:`\n\t\t\t\tМы отключили показ постов с тегом Политика в лентах Горячего, Лучшего и Свежего. \n\t\t\t\tВы можете включить его обратно, ${a.ZP.isMobileApp?"тапнув":"кликнув"} по этой кнопке.\n\t\t\t`,theme:T.xb.GREEN,direction:T.Lh.TOP,alignment:O.SE.CENTER,delay:500,wrapperExtraClass:"popup__politics-notification",hideByScroll:!1});null==t||t.once(r.eM.MOUNTED,(()=>{_.c.getInstance().sendEvent("tip_show",{type:"politics_filter"})})),null==t||t.once(r.eM.HIDDEN,(()=>{_.c.getInstance().sendEvent("tip_close",{type:"politics_filter"})}))}async _handlePoliticsBtnClick(){const t=!this.filter.plainData.isPoliticsVisible;this.$els.politicsBtn.toggleClass("button-filter_active",t),this.feed.politicsVisible=t,this.filter.update({isPoliticsVisible:t})}get calendar(){if(this._options.calendar)return this._options.calendar;const{datesRangeMode:t,minDate:e}=this.feedDateFilterParameters,s=this._options.calendar=new h.E({width:Math.min(550,window.innerWidth),datesRangeMode:t,showButtonsPanel:!1});e&&(s.limitStart=e);const i=this.filter.data.date;if(this._isRange(i))this.calendar.setRangeByType("all"===i?"all_time":i,t);else{const[t,e]=i.split(",");this.calendar.setDate(t,e)}return this.listenToOnce(s,r.eM.DESTROYED,(()=>delete this._options.calendar)),t||this.listenTo(s,"select",I.debounce(this._onSelectRange,10)),s}get filter(){let t=this._options.filter;if(t)return t;let e=a.ZP.config("modules.feed-filter")||{};return a.ZP.isUserAuthorized&&(this.feed.adultVisible=e.isAdultVisible),this.feed.politicsVisible=a.ZP.isUserAuthorized?e.isPoliticsVisible:(new k.U).get("isPoliticsVisible"),this.feed.displayModeViewedStories=i.kc[e.displayMode],t=this._options.filter=new l.Lo(function(t){for(var e=1;e<arguments.length;e++){var s=null!=arguments[e]?arguments[e]:{};e%2?$(Object(s),!0).forEach((function(e){A(t,e,s[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(s)):$(Object(s)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(s,e))}))}return t}({feedName:this.feedType.valueOf(),isUserAuthorized:a.ZP.isUserAuthorized},e)),this.listenTo(t,l.u$.CHANGE,I.debounce(this._onChangeFilter.bind(this),100)),t}get feed(){return this._options.feed}set feed(t){this._options.feed!==t&&(this._options.feed=t)}get feedName(){return this.feed.feedName}set feedName(t){t!==this.feed.feedName&&(this.feed.feedName=t,this._reset(),this._update())}get customFeed(){return this.feed.customFeed}set customFeed(t){t!==this.feed.customFeed&&(this.feed.customFeed=t,this._reset(),this._update())}get feedType(){return i.DV[this.feed.feedName]}get isDisableCalendar(){return this._options.isDisableCalendar}set isDisableCalendar(t){this._options.isDisableCalendar!==t&&(this._options.isDisableCalendar=t)}get isSubsMode(){return this._options.isSubsMode}set isSubsMode(t){let e=this._options.isSubsMode;if(e===t)return;if(this._options.isSubsMode=t,t&&(p()(".header-menu__subs-counter").hide(),p()('.bell[data-role="feed"]').hide()),void 0===e)return;this.feed.isSubsMode=t,this.filter.update({date:this.feedDateFilterParameters.defaultDate,dateCaption:""}),this._reset(),this._updateMenuItems();const s=this.isSubsMode?"my_feed":this.feedName,i=g.L[s];i&&_.c.getInstance().sendEvent("transition_to_tab",{level:i}),this._updateFeed(a.ZP.history.pathname)}get feedDateFilterParameters(){if(!this._options.feedDateFilterParameters){const t=this.feedType!==i.DV.NEW&&this.feedType!==i.DV.MOST_SAVED&&this.feedType!==i.DV.COMPANIES;let e,s="today",n=!0;this.feedType===i.DV.COMPANIES&&(s="all",n=!1,e="2022-03-01"),this._options.feedDateFilterParameters={datesRangeMode:t,defaultDate:s,useUrlShortcuts:n,minDate:e}}return this._options.feedDateFilterParameters}}s(5306),s(1817);var P=s(9537),R=s(7591),M=s(5494),N=s(2134),B=s(6572),L=s(5636),F=s(1490);class U{constructor(t){this._stories=t.stories,this._disabledWatch="community-queue"===t.feedName||"story-preview"===t.feedName,this._checkStoriesViewedBound=this._checkStoriesViewed.bind(this)}update(t=!1){if(!this._disabledWatch)return t?(this._stop(),void this._checkStoriesViewed()):void(this._watchIdle||(this._watchIdle=setInterval(this._checkStoriesViewedBound,n.W5)))}_checkStoriesViewed(t=!1){if(this._disabledWatch)return;let e=0;for(const s of this._stories.items){let i=s.isVisited,n=s.isViewed,o=s.isAdShortRead,r=s.isAdViewed,a=s.isBlogStoryViewed,l=s.isBlogStoryRead;if(!s||s.isDestroyed||i&&n&&r&&o&&a&&l)continue;let h=!0;!i&&s.checkVisited()&&(s.isVisited=i=!0,L.C.setVisited(s.id,t),h=!1),!n&&s.checkViewed()&&(s.isViewed=n=!0,F.N.setViewed(s.id,h)),!r&&s.checkAdViewed()&&(s.isAdViewed=r=!0),!o&&s.checkAdShortRead()&&(s.isAdShortRead=o=!0),!a&&s.checkBlogStoryViewed()&&(s.isBlogStoryViewed=a=!0),!l&&s.checkBlogStoryRead()&&(s.isBlogStoryRead=l=!0),i&&n&&r&&o&&a&&l||s.isCollapsed||e++}e||this._stop()}setVisit(t){let e=!0;t.isVisited||(t.isVisited=!0,!this._disabledWatch&&L.C.setVisited(t.id),e=!1),t.isViewed||(t.isViewed=!0,!this._disabledWatch&&F.N.setViewed(t.id,e))}_stop(){this._watchIdle&&(clearInterval(this._watchIdle),delete this._watchIdle)}forceSaveWhenGoing(){if(this._disabledWatch)return this;this._stop(),this._checkStoriesViewed()}forceSave(){if(this._disabledWatch)return this;this._stop(),this._checkStoriesViewed(!0),L.C.forceSave()}extractUnsavedIds(){return this._disabledWatch?[]:(this._stop(),this._checkStoriesViewed(!0),L.C.extractUnsavedIds())}}var j=s(4143),V=s(6553),H=s(5190),q=s(8245);class W extends r.u1{constructor(t){var e,s;super(t),this.$el=this.$el||t.$el,this.eventId=null===(e=this.$el)||void 0===e?void 0:e.data("id"),B.mM.get(`pkb_${this.eventId||""}`)||(this._showBlock(),null===(s=this.$el)||void 0===s||s.find(".announcement__close").on("click",(()=>this._hideBlock())))}_showBlock(){var t;null===(t=this.$el)||void 0===t||t.addClass("announcement_show")}_hideBlock(){var t;B.mM.set(`pkb_${this.eventId||""}`,1),null===(t=this.$el)||void 0===t||t.hide()}}var G=s(5924),Y=s(2323),z=s(8504);const Z=s(9755);let K;const X=Symbol();class Q{constructor(t){if(t!==X)throw new Error("Cannot construce singleton");this._text="⚡ У нас появилась новая лента просмотренных вами постов. Чтобы перейти в нее, нажмите на ссылку 👀",this._content=this.prepareContent()}static getInstance(){return K||(K=new Q(X)),K}prepareContent(){let t;return a.ZP.isMobileApp?(this._text="⚡ У нас появилась новая лента просмотренных вами постов. Чтобы перейти в нее, нажмите на ссылку",t=Z(`\n\t\t\t<div class="popup__content-notification popup__visited-stories">\t\t\t\t\n\t\t\t\t<p>${this._text}</p>\n\t\t\t\t<button>Понятно</button>\n\t\t\t</div>\n\t\t`)):t=Z(`\n\t\t\t<div class="popup__content-notification popup__visited-stories">\n\t\t\t\t<button data-role="close" class="button_link popup__icon-close">\n\t\t\t\t\t${(0,z.q)("ui__close","popup")}\n\t\t\t\t</button>\n\t\t\t\t<p>${this._text}</p>\n\t\t\t</div>\n\t\t`),t}async showTooltip(){const t=Z(".hidden-counter_shown > span");a.ZP.ui.elementInViewport(t)&&(this.popupAboutVisitedStoriesFeed=await(0,C.kd)({id:"visited-stories-tooltip",autoCloseIfTargetNotVisible:!0,autoCloseOutsideClick:!1,endDateString:"2021-03-31",target:t,content:this._content,overlapSidebars:!1}),_.c.getInstance().sendEvent("tooltip_popup",{type:"viewed_feed_launch"}))}}const J=Q;var tt=s(8881),et=s(4391);function st(t){var e="";Array.prototype.join;return e+='<div class="story-skeleton">\n    <div class="story-skeleton__content">\n        ',t.isMobile||(e+='\n            <div class="story-skeleton__dummy story-skeleton__dummy-text-1"></div>\n            <div class="story-skeleton__dummy story-skeleton__dummy-text-2"></div>\n            <div class="story-skeleton__dummy story-skeleton__dummy-text-3"></div>\n            <div class="story-skeleton__dummy story-skeleton__dummy-text-4"></div>\n            <div class="story-skeleton__dummy story-skeleton__dummy-text-5"></div>\n            <div class="story-skeleton__dummy story-skeleton__dummy-text-6"></div>\n        '),e+="\n        ",t.isMobile&&(e+='\n            <div class="story-skeleton__dummy story-skeleton__dummy-text-1"></div>\n            <div class="story-skeleton__dummy story-skeleton__dummy-text-2"></div>\n            <div class="story-skeleton__dummy story-skeleton__dummy-text-3"></div>\n            <div class="story-skeleton__dummy story-skeleton__dummy-text-4"></div>\n            <div class="story-skeleton__dummy story-skeleton__dummy-text-5"></div>\n            <div class="story-skeleton__dummy story-skeleton__dummy-text-6"></div>\n            <div class="story-skeleton__dummy story-skeleton__dummy-text-7"></div>\n        '),e+="\n    </div>\n</div>"}var it=s(3227),nt=s(1370),ot=s(7725);let rt;const at=Symbol();class lt{constructor(t){if(t!==at)throw new Error("Cannot construct singleton")}static getInstance(){return rt||(rt=new lt(at)),rt}setTagsRow(t){const e=t.querySelector(`.${it.B.tags.wrapper}`);if(!e)return;if(nt.v.initParams.tags_fold_mode!==ot.yX.PARTIAL.value)return void this._removeSkeletonFromTag(e);var s;if(null===(s=e.querySelector(`.${it.B.tags.moreButton}`))||void 0===s||s.remove(),!this._isNeedToHideTags(e))return void this._removeSkeletonFromTag(e);this._toolsWidth=this._getToolsWidth(e),this._tagsWrapperWidth||(this._tagsWrapperWidth=e.clientWidth);let i,n=this._tagsWrapperWidth-this._toolsWidth;this._tags=Array.from(e.querySelectorAll(`.${it.B.tags.tag}`));for(const o of this._tags)if(n-=this._getWidthWithMargin(o),n<=0){i=o,this._firstTagForHidden=o;break}i?(this._countTags=this._getVisibleTags(e).length,this._countTags<=V.DESIRED_MIN_COUNT_TAGS&&this._tags.length>V.DESIRED_MIN_COUNT_TAGS&&this._addSuitableTagInRow(e),this._transformTagToButton(i),this._removeSkeletonFromTag(e)):this._removeSkeletonFromTag(e)}_addSuitableTagInRow(t){var e;if(!this._tags||!this._countTags||!this._tagsWrapperWidth)return;const s=this._getVisibleTags(t);let i=0;s.forEach((t=>i+=this._getWidthWithMargin(t)));const n=this._tagsWrapperWidth-(null!==(e=this._toolsWidth)&&void 0!==e?e:0)-i;for(let o=this._countTags+1;o<this._tags.length;o++)if(this._getWidthWithMargin(this._tags[o])<=n){this._tags[0].after(this._tags[o]);break}}_getVisibleTags(t){const e=Array.from(t.children),s=[];for(const i of e){if("A"!==i.tagName||i===this._firstTagForHidden)return s;s.push(i)}return s}_isNeedToHideTags(t){const e=t.offsetHeight;if(!this._tagHeight){const e=t.querySelector(`.${it.B.tags.tag}`);this._tagHeight=e.offsetHeight}return Math.floor(e/this._tagHeight)>V.MAX_VISIBLE_TAGS_ROWS}_getWidthWithMargin(t){return t.offsetWidth+parseInt(window.getComputedStyle(t).getPropertyValue("margin-right"),10)+parseInt(window.getComputedStyle(t).getPropertyValue("margin-left"),10)}_getToolsWidth(t){const e=Array.from(t.querySelectorAll(`.${it.B.tags.tool}`));let s=V.MORE_BUTTON_WIDTH_WITH_MARGINS;for(const i of e)s+=i.offsetWidth+parseInt(window.getComputedStyle(i).getPropertyValue("margin-right"),10)+parseInt(window.getComputedStyle(i).getPropertyValue("margin-left"),10);return s}_transformTagToButton(t){const e=this._createMoreButton(),s=()=>{e.replaceWith(t),e.removeEventListener("click",s)};e.addEventListener("click",s),t.replaceWith(e)}_createMoreButton(){const t=document.createElement("button");return t.innerHTML=`${(0,f.t)("ui__tags-cut")}`,t.classList.add("tags-cut","tags__tag","hint"),t}_removeSkeletonFromTag(t){t.classList.remove(it.B.tags.skeleton)}}var ht=s(7111);const ct=[{content:'<p>А вы знаете, что у нас можно <a href="https://pikabu.ru/story/poznakomlyus_9080667">\n\t\t\t\t\tискать</a> вторую половинку?\n\t\t\t\t\tА некоторые уже <a href="https://pikabu.ru/story/kak_ya_poznakomilas_s_muzhem_na_pikabu_8001282">\n\t\t\t\t\tнашли</a> <span style="white-space: nowrap">\n\t\t\t\t\t(или&nbsp;<a href="https://pikabu.ru/story/pikabu_ya_zhenilsya__1521214">вот</a>)!</span></p>'},{content:'<p>Если вы нуждаетесь в помощи или хотите помочь, то присоединяйтесь к Пикабу. Здесь люди ищут и\n \t\t\t\t\t<a href="https://pikabu.ru/tag/\n \t\t\t\t\t%D0%9E%D1%82%D0%B4%D0%B0%D0%BC%20%D0%BB%D0%B5%D0%BA%D0%B0%D1%80%D1%81%D1%82%D0%B2%D0%BE">\n \t\t\t\t\tделятся лекарствами</a> с нуждающимися.</p>'},{content:'<p>А вы знаете, что на Пикабу можно\n\t\t\t\t\t<a href="https://pikabu.ru/story/spb_pvd_shepelevskiy_mayak_9116948">присоединиться</a> к походу?\n\t\t\t\t\tИли найти тех, с кем можно просто <a href="https://pikabu.ru/story/ishchu_druzey_v_kemerovo_9122791\n\t\t\t\t\t">погулять</a> в вашем городе?</p>'},{content:'<p>Пикабушники <a\n\t\t\t\t\thref="https://pikabu.ru/tag/%D0%9F%D0%BE%D0%B8%D1%81%D0%BA%20%D1%80%D0%B0%D0%B1%D0%BE%D1%82%D1%8B">\n\t\t\t\t\tпомогают друг другу в поиске работы</a>? Если вы готовы помогать или вам самим нужна помощь,\n\t\t\t\t\tто самое время присоединиться!</p>'},{content:'<p>Любите котиков? Или собак? Пикабушники нередко <a href="\n\t\t\t\t\thttps://pikabu.ru/tag/%D0%92%20%D0%B4%D0%BE%D0%B1%D1%80%D1%8B%D0%B5%20%D1%80%D1%83%D0%BA%D0%B8">\n\t\t\t\t\tпомогают пушистикам найти новый дом</a>. Зарегистрируйтесь, чтобы не пропустить такие посты,\n\t\t\t\t\t и, возможно, вы найдёте себе нового друга. </p>'}],dt="pkb_ibc";function ut(){const t=Number(ht.m.get(dt));if(t&&Date.now()-t<2592e5)return"";const e=Math.floor(Math.random()*ct.length);return function(t){var e,s="";return Array.prototype.join,s+='\n<div class="information-block">\n    <div class="information-block__wrapper">\n        <div class="information-block__image">\n            <img src="https://cs12.pikabu.ru/post_img/2022/05/19/6/1652953958162323070.png" />\n        </div>\n        <div class="information-block__content">\n            '+(null==(e=t.content)?"":e)+'\n            <div class="button button_success information-block__button">Зарегистрироваться</div>\n        </div>\n    </div>\n    <div class="information-block__close">\n        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon--ui__close icon--ui__close_size-middle"><use xlink:href="#icon--ui__close"></use></svg>\n    </div>\n</div>'}({content:ct[e].content})}var pt=s(1253);function mt(t,e){var s=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),s.push.apply(s,i)}return s}function _t(t,e,s){return e in t?Object.defineProperty(t,e,{value:s,enumerable:!0,configurable:!0,writable:!0}):t[e]=s,t}const gt=s(6419),vt=s(9755);class ft extends r.u1{constructor(t){super(),O.Zv.isHTMLElement(t)&&(t=vt(t)),t instanceof vt&&(t={$el:t});const e=a.vE.config("modules.feed-filter")||{},s=e&&e.displayMode?i.kc[e.displayMode]:i.kc.VISITED_STORIES_SHOW;if(e.feedKey?this.searchParams={key:e.feedKey}:this.searchParams={twitmode:1,of:"v2"},gt.extend(this._options,{displayModeViewedStories:s,stories:new l.qg(!0),isAjaxLoadMode:a.vE.initParams.isAjaxLoadMode,feedEngineVersion:e.feedKey?2:1,requestUrl:window.location.pathname,page:e.page||1,feedName:a.vE.initParams.filterName,feedKey:e.feedKey||"",feedRecordId:"",isExpandedMode:a.vE.applicationType===R.Zq.MOBILE||a.vE.initParams.isExpandedMode,isSubsMode:!1,hiddenStories:0}),this._analyticsInstance=_.c.getInstance(),gt.isObject(t)&&this.setOptions(t),["adverts","story","story-preview","related","community-queue"].includes(this.feedName)&&(this._options.endOfFeed=!0,this._options.isAjaxLoadMode=!1),["profile","quarantine-history","quarantine"].includes(this.feedName)&&(this._options.isAjaxLoadMode=!1),this._isUserHaveSubs=this.$el.data("has-subs"),this._showSubsStub=!1,this._viewObserver=new U(this),this._msgBtnIntersactionObserver=null,this.listenTo(a.vE.ui,"beforeunload",this._saveBeforeUnload),this.listenTo(a.vE.ui,"visibilitychange",(()=>this._windowVisibilityChange())),this.listenTo(a.vE,"anl-session-regenerate",(()=>this._sessionRegenerated())),S.V.isUserInExperiment(S.t.CONTENT_VIEWED_EVENT)&&this.listenTo(a.vE,"popup-modal-shown",(()=>{this.stories.items.forEach((t=>{t.onPopupShown()}))})),this.listenTo(a.vE,"popup-modal-hidden",(()=>{this.stories.items.forEach((t=>{t.onPopupHidden()}))})),void 0===this.loadAnimationName&&(this.loadAnimationName="stories-spinner"),this._loadingAnimation=void 0,this._loadingAnimationBefore=void 0,this._headerHeight=a.vE.ui.getHeaderHeight(),this._storiesInViewportThrottle=(0,y.P)((t=>{this._storiesInViewport(t)}),100,{leading:!1}),"visited"!==this.feedName)J.getInstance().showTooltip();else{const t=vt(".announcement");t.length&&(this._announcement=new W({$el:t}))}this.listenToOnce(a.vE.ui,"scroll",(()=>this._storiesInViewportThrottle())),this._addLastStorySkeleton()}_isLastStoryNessesary(){return this._isNeedToImitateEndOfFeed()&&this._onDocumentEnd(),!(this.isPaginationMode||this.$el.find("article").length<2||this.endOfFeed||n.ok.includes(this.feedName)||"recommend"!==this.feedName&&this.el.hasAttribute("data-page-last")&&this.page===Math.max(1,parseInt(this.el.getAttribute("data-page-last"),10)||1)||!("search"!==this.feedName&&"community-search"!==this.feedName||this.$el.find(`.${n.wn}`).length))}_isNeedToImitateEndOfFeed(){const t=this.$el.find("article").length;return this.isAjaxLoadMode&&t>0&&t<4&&!this.endOfFeed}_getLastStory(){var t,e;return(null!==(t=this.$els)&&void 0!==t&&t.container?null===(e=this.$els)||void 0===e?void 0:e.container:this.$el.find(".stories-feed__container")).children("article").last()}_addClassLastStory(t){t.find("[id^=adfox]").length||t.find('div[id^="abp"]').length||t.hasClass(n.wn)||t.addClass(n.wn)}_addSkeleton(t){const e=t.find(".story__main");if(!t.find("[id^=adfox]").length&&!t.find('div[id^="abp"]').length&&(e.children().hasClass(n.qC)||a.vE.isMobileApp||e.append(st({isMobile:!1})),!e.children().hasClass(n.qC)&&a.vE.isMobileApp)){t.find(".story__after-header").after(st({isMobile:!0}))}}_removeLastStoryClassesAndSkeleton(t){if("cedit"===this.feedName)return void this._removeAllLastStory();const e=t.find(`.${n.qC}`);(t.hasClass(n.wn)||e.length)&&(t.removeClass(n.wn),e.remove(),a.vE.isMobileApp&&lt.getInstance().setTagsRow(t.get(0)))}_removeAllLastStory(){const t=vt(`.${n.wn}`).toArray();t.length&&(t.forEach((t=>{vt(t).removeClass(n.wn),vt(t).find(`.${n.qC}`).remove(),a.vE.isMobileApp&&lt.getInstance().setTagsRow(t)})),this._lastStory=null)}_addObserverToPreloader(t){if(!et.v)return;new IntersectionObserver(((e,s)=>{e.forEach((e=>{e.isIntersecting&&(setTimeout((()=>{this._removeLastStoryClassesAndSkeleton(t)}),n.qn),s.unobserve(e.target))}))}),{threshold:1}).observe(t[0])}render(){if(this.isRendered)return this;if(a.vE.ua.ios){this._currentScrolling=!1;let t=!1,e=!1;window.document.addEventListener("touchstart",(()=>{this._currentScrolling=t=!0}));const s=()=>{t||e||(this._currentScrolling=!1,this.emit("stop-scrolling"))};window.document.addEventListener("touchend",(()=>{t=!1,s()}));const i=(0,H.D)((()=>{e=!1,s()}),500);window.document.addEventListener("scroll",(()=>{e=!0,i()}))}return this.$els.announcement=vt(".thematic-poll"),this.$els.announcement.length&&(this._announcement=new W({$el:this.$els.announcement})),super.render(),this}_sessionRegenerated(){this.stories.items.forEach((t=>{t.onSessionRegenerated()}))}_windowVisibilityChange(){const t="visible"===document.visibilityState;this.stories.items.forEach((e=>{e.onWindowFocusChanged(t)}))}_attachTools(){const{storyStyle:t}=this.useRegistry();this.$el.on("click","."+t.rating.up,this._onToolClick.bind(this,this._voteStory,[V.STORY_VOTE.UP,!0])),this.$el.on("click","."+t.rating.down,this._onToolClick.bind(this,this._voteStory,[V.STORY_VOTE.DOWN,!0])),this.$el.on("click","."+t.collapseButton.button,this._onToolClick.bind(this,this._collapseStory)),this.$el.on("click","."+t.readMore.button,this._onToolClick.bind(this,this._readMore)),this.$el.on("click","."+t.similarIndicator,this._onToolClick.bind(this,this._showSimilarStories)),this.$el.on("click","a.story__to-comments",this._onToolClick.bind(this,this._toComments)),this.$el.on("click",".b-story__show-all",(t=>{t.preventDefault(),vt(t.currentTarget).hide().prev().css("max-height","").find(".b-story-blocks__hide-wrapper").show()})),this.$el.on("click","."+t.title.el,(e=>{if(e.target.matches("a")||!e.target.classList.contains(t.title.el))return;const s=e.currentTarget.querySelector("a");s&&s.click()})),this.listenTo(a.vE,"ui-calendar-feed-popup:submit",(()=>this.$els.loadingBefore.hide()));let e=".story__emotions";return a.vE.isMobileApp&&a.vE.initParams.experimentRightVotesGrBig&&(e=".emotions__title"),this.$el.on("click",e,(t=>{const e=this.stories.get(ft.getStoryIdByElement(t.target));e&&e.emotions.popup.toggle()})),this}_toComments(t){return this.isAjaxLoadMode&&this.isRestoreStateMode&&(this.navigationStoryId=t.id,this.saveStateSnapshot()),this}_getOptionsFromData(){var t;let e,s=this.el.getAttribute("data-page-current");var i,n;s||(e=null===(i=document.querySelector(".stories-feed"))||void 0===i?void 0:i.dataset,s=(null===(n=e)||void 0===n?void 0:n.pageCurrent)||1);if(this.page=Math.max(1,parseInt(s,10)||1),this.el.hasAttribute("data-subs-sort")&&(this._options.isSubsMode=!0),"true"===this.el.getAttribute("data-pagination-mode")||"true"===(null===(t=e)||void 0===t?void 0:t.paginationMode))this._options.isAjaxLoadMode=!1,this._options.lastPage=Math.max(1,parseInt(this.el.getAttribute("data-page-last"),10)||1);else if(this.el.hasAttribute("data-page-last")){const t=Math.max(1,parseInt(this.el.getAttribute("data-page-last"),10)||1);this.page===t&&(this.endOfFeed=!0,this._sendAnalyticsOnEndOfFeed())}!this.endOfFeed&&this.$els.message.length&&this.$els.message.hasClass(o.message.show)&&(this.endOfFeed=!0,this._sendAnalyticsOnEndOfFeed())}_saveBeforeUnload(){this.viewObserver.forceSave()}_detectNeedScrolling(){let t=a.vE.history.searchParams.get("scrollto");return t?"first"===t?this.stories.firstId():this.stories.lastId():0}initLazyLoad(){a.vE.emit(Y.Tu),G.z.getInstance().init()}parseResponse(t,e){if(!t.result)return this._removeAllLastStory(),a.vE.logger.error("feed","something went wrong"),!1;const s=!gt.isArray(e.stories)||0===e.stories.length,i=e.is_feed_overflow||"cedit"!==this.feedName&&e.total>0&&this.stories.size+e.stories.length>=e.total,n=this.isPaginationMode&&!s&&this.page===this._options.lastPage-1;return this._showSubsStub=!e.stories.length,e.title&&this._updateTitle(e.title),e.hasOwnProperty("menu_caption")&&this._updateMenuCaption(e.menu_caption),e&&void 0!==e.has_subscription&&(this._isUserHaveSubs=Boolean(e.has_subscription)),e&&void 0!==e.hidden_stories_count&&e.hidden_stories_count>0&&(this.hiddenStories=e.hidden_stories_count),this.emit("loaded",e,s||i),this.endOfFeed=s||i||n,!s&&this.parseStoriesFromResponse(e)}parseStoriesFromResponse(t){const e=[],s=this.storiesViewed,n=this.displayModeViewedStories===i.kc.VISITED_STORIES_HIDE,o="visited"===this.feedName;for(let i=0,l=t.stories.length;i<l;i++){const r=t.stories[i],l=Number(r.id);!(this.stories.hasById(l)||this.storiesBefore.includes(l)||this.storiesAfter.includes(l))||o?n&&s.includes(l)&&!o&&1===this._options.feedEngineVersion?(a.vE.logger.error("feed","duplication story by localStorage",a.vE.history.path),a.vE.logger.info("feed","duplication story by localStorage",l)):e.push(r.html):(a.vE.logger.error("feed","duplication story by page",a.vE.history.path),a.vE.logger.info("feed","duplication story by page",l))}if(e.length<5||!Array.isArray(t.adverts)||!t.adverts.length)return e;const r=this.advertsViewed.reverse();for(let i=0,l=t.adverts.length;i<l;i++){const o=t.adverts[i],l=gt.isFinite(o.id)?Number(o.id):0;if(l){if(this.stories.hasById(l)||this.storiesBefore.includes(l)||this.storiesAfter.includes(l)){a.vE.logger.error("feed","duplication advert by page");continue}if(n&&s.includes(l)||r.includes(l)){a.vE.logger.error("feed","duplication advert by localStorage");continue}r.unshift(l)}"before"===o.position?e.unshift(o.html):(e.push(o.html),this.isPaginationMode||([e[e.length-1],e[e.length-2]]=[e[e.length-2],e[e.length-1]]))}return this.advertsViewed=r,e}initVoteAnnouncement(){const t=this.$(".vote");t.length&&(this._voteAnnouncement=new W({$el:t}))}_sendAnalyticsOnEndOfFeed(){const t=this._isSubsModeAndNoHiddenStories()?this.$els.messageSubs.find('[data-type="empty"]'):this.$els.message,e=t.get(0),s=a.vE.ui.getHeaderHeight(),i=a.vE.applicationType===R.Zq.MOBILE?`${s}px`:"0px";if(e&&et.v&&!this._msgBtnIntersactionObserver){const s=["read_all_posts","more_votes_advice"];this._msgBtnIntersactionObserver=new IntersectionObserver((i=>{if(i.some((t=>t.isIntersecting))){const i=t.data("type"),n=s.includes(i)?i:"read_all_posts";this._analyticsInstance.sendEvent("reach_element",{type:n}),this._msgBtnIntersactionObserver.unobserve(e),"read_all_posts"===n&&["hot","best"].includes(this.feedName)&&pt.D.sendEvent("end")}}),{rootMargin:i,threshold:0}),e&&this._msgBtnIntersactionObserver.observe(e)}}_sendAnalyticsOnLoadStoriesStarted(t){this._analyticsInstance.yandex.goal("load_more_posts",{page:t}),"related"!==this.feedName&&(this._analyticsInstance.yandex.hit(`?page=${t}`),this._analyticsInstance.google.pageView())}_sendAnalyticsOnLoadStoriesEnd(t,e){this._analyticsInstance.sendEvent("post_batch_load",function(t){for(var e=1;e<arguments.length;e++){var s=null!=arguments[e]?arguments[e]:{};e%2?mt(Object(s),!0).forEach((function(e){_t(t,e,s[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(s)):mt(Object(s)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(s,e))}))}return t}({view_time:(Date.now()-t)/1e3},e&&{screen_index:e})),this.endOfFeed&&this._sendAnalyticsOnEndOfFeed()}async loadStories(t=!0){var e;if(this.endOfFeed||this.loadAnimation||this.loadAnimationBefore||this.marks.has("requestDelay"))return!1;if(this.isSubsMode&&!a.vE.isUserAuthorized)return this._showSubsStub=!0,void(this.endOfFeed=!0);let s=this.page||1;const n=this.requestId,o=Date.now(),r=null===(e=this.stories.items.find((t=>t.inViewportForAnalytics)))||void 0===e?void 0:e.screenIndex;if(s)t&&s++;else{if(t)return!1;s=1}let l=!["search","community-search","profile-search","visited"].includes(this.feedName)||a.vE.applicationType===R.Zq.MOBILE||s>1;if(l&&(this.loadAnimation=!0),this.marks.has("requestLastStart")){let t=this.marks.get("requestLastStart"),e=o-t;if(t&&e<5e3){if(this.marks.set("requestDelay",!0),await B.cQ.delay(e),this.marks.delete("requestDelay"),this.requestId!==n)return!1;if(!a.vE.ui.elementWillSoonScrolled(this.el))return this.loadAnimation=!1,!1}}if(this.marks.set("requestLastStart",o),this._sendAnalyticsOnLoadStoriesStarted(s),this.displayModeViewedStories===i.kc.VISITED_STORIES_HIDE&&this.viewObserver){const t=this.viewObserver.extractUnsavedIds();t.length&&this.searchParams.set("vn_buff",JSON.stringify(t))}const h=new P._(window.location.search).get("f");h&&this.searchParams.set("f",h),this.searchParams.set("page",s);let c=this.requestUrl;this._options.feedEngineVersion>1&&(c="/ajax"+c);const{response:d,data:u}=await N.cf.get(c,this.searchParams,{cache:!1});if(l){let t=Date.now()-o;t<1e3&&await B.cQ.delay(1e3-t)}if(this.requestId!==n)return!1;const p=this.parseResponse(d,u);if(S.V.isUserInExperiment(S.t.REG_PROFIT)&&1===this.page&&(null==p?void 0:p.length)>1){const t=ut();p.splice(2,0,t)}if(this._options.feedEngineVersion>1&&u.key&&u.key!==this.feedKey&&(this.feedKey=u.key),Array.isArray(p)&&p.length>0){this._removeAllLastStory(),this.$els.container.append(O.Zv.fragment(p.join(""))),a.vE.logger.log("feed","loadStories"),this.initStories();const t=this.el.querySelector(".information-block");if(t&&function(t){const e=t.querySelector(".information-block__close");null==e||e.addEventListener("click",(()=>{ht.m.set(dt,Date.now()),t.remove()}),{once:!0});const s=t.querySelector(".information-block__button");null==s||s.addEventListener("click",(()=>{b.cp.getInstance().sendEvent("click_registration",{type:"from_reg_profit"}),a.vE.isMobileApp?a.vE.ui.auth.showNeedAuth(!0):a.vE.ui.authModalEmpty.showSignUp()}))}(t),this.initSubscriptionForm(),this._addLastStorySkeleton(),"cedit"!==this.feedName){await M.$.request();try{this._hideSuperfluousStories(!0)}catch(m){a.vE.logger.error("stories-feed","some problem with hide superfluous stories",m)}}this.assignScreenIndex(),await M.$.request()}else"subs"===this.feedName||this._isLastStoryNessesary()||this._removeAllLastStory();return u&&void 0!==u.paginator&&(this.$els.pagination&&this.$els.pagination.length&&this.$els.pagination.remove(),u.hidden_stories_count!==u.total&&(this.$els.pagination=vt(u.paginator).insertAfter(this.$el))),!1!==p&&(Number.isFinite(u.page)?this.page=u.page:(t||1===s)&&(this.page=s)),this.loadAnimation=!1,this._sendAnalyticsOnLoadStoriesEnd(o,r),this.displayModeViewedStories===i.kc.VISITED_STORIES_HIDE&&J.getInstance().showTooltip(),!0}assignScreenIndex(){if("story"===this.feedName)return;const t=this.storiesBefore.length;this.stories.items.forEach(((e,s)=>{e.screenIndex=t+s+1}))}async loadStoriesByIds(t,e=!0){if(this.loadAnimation||this.loadAnimationBefore||this.marks.has("requestByIdsDelay"))return!1;if(t||(t=e?this.storiesBefore.length>n.q1+10?this.storiesBefore.splice(-n.q1):this.storiesBefore.splice(0,this.storiesBefore.length):this.storiesAfter.length>n.q1+10?this.storiesAfter.splice(0,n.q1):this.storiesAfter.splice(0,this.storiesAfter.length)),!t.length)return!1;a.vE.logger.info("stories-feed","load ids",t,"append",e?"before":"after");const s=this.requestIdByIds,i=Date.now();let o=a.vE.ui.scrollTop-this.stories.get(this.navigationStoryId).offsetTop;if(e?(this.isPageScrollable=!1,this.loadAnimationBefore=!0,this.scrollTo(this.stories.get(this.navigationStoryId).offsetTop+o),this.isPageScrollable=!0):this.loadAnimation=!0,this.marks.has("requestByIdsLastStart")){let t=this.marks.get("requestByIdsLastStart"),e=i-t;if(t&&e<1e3&&(this.marks.set("requestByIdsDelay",!0),await B.cQ.delay(e),this.marks.delete("requestByIdsDelay"),this.requestIdByIds!==s))return!1}this.marks.set("requestByIdsLastStart",i);const{stories:r}=await this.loadSpecificStories(t);if(await B.cQ.delay(1e3-(Date.now()-i)),this.requestIdByIds!==s||!r.length)return!1;for(let a=0;a<r.length;a++)r[a].html=r[a].html.replace(n.wn,"");const l=this.parseStoriesFromResponse({stories:r});return gt.isArray(l)&&l.length&&(this._hideSuperfluousStories(!e),e?(this.isPageScrollable=!1,o=a.vE.ui.scrollTop-this.stories.get(this.navigationStoryId).offsetTop,this.$els.container.prepend(O.Zv.fragment(l.join(""))),this.scrollTo(this.stories.get(this.navigationStoryId).offsetTop+o),this.isPageScrollable=!0):(this._removeAllLastStory(),this.$els.container.append(O.Zv.fragment(l.join("")))),this.initStories(),this.assignScreenIndex(),this._addLastStorySkeleton()),e?this.loadAnimationBefore=!1:this.loadAnimation=!1,!0}_updateTitle(t){}_updateMenuCaption(t){}_hideSuperfluousStories(t=!0){const e=(t?this.amountStoriesBefore:this.amountStoriesAfter)-10;if(e<10)return;const s=t?0:-e,i=t?e:void 0,n=this.stories.items.slice(s,i);if(!n.length)return;const o=this._getPlayingVideoPostID();if(o>0&&n.some((t=>t.id===o)))return;const r=this.navigationStoryId,a=this.stories.items[t?e:this.stories.items.length-e-1];if(t&&a instanceof V.Story){const t=a.offsetTop-this.$els.container.get(0).offsetTop-this.$els.loadingBefore.height()-15,e=vt(`<div style="height: ${t}px"></div>`).insertAfter(a.$el),s=new IntersectionObserver((t=>{t.forEach((t=>{t.isIntersecting&&(this.scrollTo(e.offset().top),s.unobserve(e.get(0)),s.disconnect(),e.remove())}))}));s.observe(e.get(0))}const l=a.$el.get(0),h=t?"previousSibling":"nextSibling";for(;l[h];)l[h].remove();const c=n.map((e=>((t?this.storiesBefore:this.storiesAfter).push(e.id),e.id)));this.stories.remove(c),this.$els.loadingBefore.toggle(this.storiesBefore.length>0),this.navigationStoryId=r}abortLoadStories(){return this.loadAnimation=!1,this.loadAnimationBefore=!1,delete this._options.requestId,delete this._options.requestIdByIds,this.marks.delete("requestLastStart"),this.marks.delete("requestDelay"),this}async loadSpecificStories(t,e="",s){const{response:i,data:n}=await N.cf.post("/ajax/stories_actions.php",{action:"load_stories",ids:t,page:s,filterName:e,feed_mode:this.feedName});i.result||(a.vE.ui.toasts.showError(),a.vE.logger.error("feed",i.message));const{stories:o=[],adverts:r=[]}=n||{};return{stories:o,adverts:r}}clear(){return this.viewObserver.update(!0),this.abortLoadStories(),this.page=0,this.stories.clear(),this.hiddenStoriesVisibility=!1,this.$els.container.empty(),this.$els.pagination.length&&this.$els.pagination.hide(),this.$els.loadingBefore&&this.$els.loadingBefore.length&&this.$els.loadingBefore.hide(),this.feedKey="",this.navigationStoryId=0,this.endOfFeed=!1,delete this._options.storiesAfter,delete this._options.storiesBefore,this}_onDocumentEnd(t=!0){this.marks.has("scrolling")||(this._onDocumentEndThrottle||(this._onDocumentEndThrottle=gt.throttle((()=>{a.vE.ua.firefox&&a.vE.isMobileApp&&document.activeElement&&document.activeElement!==document.body&&document.activeElement.blur(),this.storiesAfter.length?this.loadStoriesByIds(null,!1):this.loadStories(t)}),100)),this._onDocumentEndThrottle())}_storiesInViewport(t){return this}_attachScroll(){return this.listenTo(a.vE.ui,"document-scroll",this._feedScrolling),this.listenTo(a.vE.ui,"orientationchange",this._onOrientationChange),this}_feedScrolling(t){return this.marks.has("scrolling")||(this._storiesInViewportThrottle(t),this.isAjaxLoadMode&&a.vE.ui.elementWillSoonScrolled(this.el)&&this._onDocumentEnd()),this}async _onOrientationChange(){if(!this.stories.size||!this.focused||a.vE.applicationType===R.Zq.DESKTOP)return;const t=this.stories.get(this.navigationStoryId);t&&(await M.$.request(),a.vE.ua.android||this.scrollTo(t.offsetTop-this._headerHeight+t.offsetHeight*t.progressReading),this._storiesInViewportThrottle())}initStories(){return this}initSubscriptionForm(){}collapsedViewedStories(t){return this.stories.items.forEach((e=>{e.isVisited&&(e.isCollapsed=t)})),this._storiesInViewport(),this}removeBoundaryAdBlocks(t){let e=this.$el.find(".story");if(t){let t=0,s=0;for(;t<10&&s<e.length;){const i=e[s],n=parseInt(i.dataset.storyId||0,10);this.stories.has(n)?t++:i.remove(),s++}return}const s=this.stories.lastId();s?this.stories.get(s).$el.nextAll(".story").remove():this.$el.find(".story").remove()}removeViewedStories(){const t=this.stories.items.filter((t=>!!t.isVisited&&(t.$el.remove(),!0)));return t.length?(this.stories.remove(t),this.stories.has(this.navigationStoryId)||(this.navigationStoryId=this.mouseStoryId=0),t.length>10&&this.isAjaxLoadMode?(this.removeBoundaryAdBlocks(!0),this.hiddenStoriesVisibility=!1,this.endOfFeed=!1,this._onDocumentEnd(!1)):(this.$els.container.children().length||(this.endOfFeed=!0),t.length>this.hiddenStories?this.hiddenStories=t.length:this.hiddenStoriesVisibility=!0),this.isPaginationMode&&!this.$els.container.children().length<40&&(this.$els.pagination.remove(),this.endOfFeed=!0),this._storiesInViewport(),this):this}async _restoreStateSnapshot(t){const e=Date.now();this.clear(),this._showRestoreMessage(!0);const s=await this.loadSpecificStories(t.ids,t.feedName,t.page),i=await this.parseStoriesFromResponse(s);i.length?(this.$els.container.append(i),a.vE.ui.scrollRestoration="manual",this.initStories(),this.page=t.page,this.navigationStoryId=this.mouseStoryId=t.sid,await this.scrollToStory(this.navigationStoryId),await B.cQ.delay(1e3-(Date.now()-e)),this._showRestoreMessage(!1)):a.vE.history.location.reload()}static getStoryIdByElement(t){const{storyStyle:e}=q.S.getInstance().get();if(!O.Zv.isHTMLElement(t))throw new Error("expected HTMLElement");const s=t.closest(`.${e.item}`);return s?parseInt(s.getAttribute("data-story-id")||0,10):null}loadStateSnapshot(){let t=B.xg.get(n.$U)||{};return gt.isObject(t)&&this.isAjaxLoadMode&&t.active&&t.feedName===this.feedName&&t.feedRecordId===this.feedRecordId&&gt.isArray(t.ids)&&t.ids.length>0&&t.ids.every((t=>gt.isFinite(t)))&&Date.now()-t.timestamp<n.An?this._restoreStateSnapshot(t):a.vE.ui.scrollRestoration="auto",B.xg.remove(n.$U),B.eR.remove(n.uD),this}saveStateSnapshot(){if(this.isAjaxLoadMode&&this.page>n.CL&&this.isRestoreStateMode){const t=new Date,e=Math.floor(Date.now()/1e3);B.xg.set(n.$U,this.stateSnapshot),B.eR.set(n.uD,e,{expires:t.setMilliseconds(t.getMilliseconds()+n.An)})}return this}_voteStory(t,e,s=!1){return a.vE.isUserAuthorized?a.vE.isLostAccount?(a.vE.ui.toasts.showWarningMessage(a.ZF.LOST_ACCOUNT),this):t?(t.voteDirection(e,s),this.viewObserver.setVisit(t),this):this:(a.vE.ui.authRequired(),_.c.getInstance().sendEvent("click",{type:"post_rate",user_rate:e.value,post_id:t.id}),this)}async _collapseStory(t,e){return t?((e="boolean"==typeof e?e:!t.isCollapsed)?(t.offsetTop-a.vE.ui.scrollTop<0&&(t.highlight("yellow",!0,!0),await this.scrollTo(t.offsetTop-10,!1)),this.isExpandedMode&&this.viewObserver.setVisit(t)):this.isExpandedMode||(this.navigationStoryId=t.id),t.isCollapsed=e,e||this.isExpandedMode||this.viewObserver.setVisit(t),this):this}changeStory(t){if(t=Number(t),!this.stories.hasById(t))return this;if(this.navigationStoryId&&this.navigationStoryId!==t){let t=this.stories.get(this.navigationStoryId);t&&(this.isExpandedMode?a.vE.ui.player.stop():t.isCollapsed=!0,t.scrollMode=!1)}const e=this.stories.get(t);e.setCurrentPlayer(),e.isCollapsed=!1,this.isExpandedMode||this.viewObserver.setVisit(e),this.navigationStoryId=this.mouseStoryId=t,this.amountStoriesAfter<4&&this.isAjaxLoadMode&&this._onDocumentEnd()}async scrollToStory(t,e=600){let s=5;const i=t instanceof V.Story?t:this.stories.get(t);if(i){this.marks.set("scrolling",!0);do{await a.vE.ui.scrollTo(i.offsetTop-20,!1),await B.cQ.delay(e);const t=a.vE.ui.scrollTop,s=i.offsetTop;if(B.cQ.equalNumbers(t,s,50))break}while(s--);this.marks.delete("scrolling")}}_showRestoreMessage(t){return t&&!this._restoreBox&&(this._restoreBox=new O.LD({indent:!0,autoCloseOutsideClick:!1,autoClosePressEscape:!1}),this._restoreAnimation=a.vE.ui.player.createAnimation("stories-restore",{$parent:this._restoreBox.content})),t?(this._restoreBox.show(),this._restoreBox.$els.container.addClass("popup__container_transparent"),this._restoreAnimation.play(),this.marks.set("scrolling",!0),this):(this._restoreAnimation.stop(),this._restoreBox.hide(),this.marks.delete("scrolling"),this)}_isSubsModeAndNoHiddenStories(){return this.isSubsMode&&this.$els.messageSubs.length&&this._showSubsStub&&!this.hiddenStories}_updateEndOfFeed(t){return this._removeAllLastStory(),this._isSubsModeAndNoHiddenStories()?(this.$els.messageSubs.toggle(t).find("."+o.messageSubs.innerBlock).hide().filter(`[data-type="${this._isUserHaveSubs?"empty":"no-subs"}"]`).show(),this.$els.message.hide(),this):(this.$els.messageSubs.hide(),this.$els.message.toggle(t),this)}_createLoadAnimation(){return this.$els.spinner.length?"cedit-feed"!==a.vE.initParams.pageName?this:this.loadAnimationName?(this._loadingAnimation&&this._loadingAnimation.destroy(),this._loadingAnimation=a.vE.ui.player.createAnimation(this.loadAnimationName,{$parent:this.$els.spinner}),this):this:this}_createLoadAnimationBefore(){const t=this.loadAnimationName;return this.$els.spinnerBefore.length&&t&&(this._loadingAnimationBefore&&this._loadingAnimationBefore.destroy(),this._loadingAnimationBefore=a.vE.ui.player.createAnimation(t,{$parent:this.$els.spinnerBefore})),this}_getPlayingVideoPostID(){let t=gt.find(vt('.player[data-type="video"]'),(t=>{let e=j.XM.getPlayerFromElement(t);return e&&e.isPlayed}));return t?Number(t.dataset.storyId):0}_initStats(){const{storyStyle:t}=q.S.getInstance().get(),e=this._mapStoryElementForStats=this._mapStoryElementForStats||new WeakMap;this.stories.items.filter((s=>!s.$viewedCount.hasClass(t.viewed.loaded)&&!e.has(s))).forEach((t=>{e.set(t.el,t),this.intersectionObserverStats.observe(t.el)}))}get intersectionObserverStats(){if(this._intersectionObserverStats)return this._intersectionObserverStats;const t=(0,y.P)((t=>{pt.D.sendEvent("read100",{ids:[t]})}),1e3),e=this._mapStoryElementForStats=this._mapStoryElementForStats||new WeakMap;return this._intersectionObserverStats=new IntersectionObserver((s=>{s.forEach((s=>{if(!s.isIntersecting)return;const i=e.get(s.target);i&&!i.isDestroyed&&(this._intersectionObserverStats.unobserve(s.target),this._loadStats(i),"subs"===this.feedName&&t(i.id))}))}))}_loadStats(t){var e;if(!t)return;const s=null===(e=t.emotions)||void 0===e?void 0:e.needLoadCounters;F.N.getViewAndEmotionsCount(t.id).then((e=>{this.isDestroyed||t.isDestroyed||(t.viewedCount=Number(e.views[0]),s&&t.emotions.updateEmotionsCounters(e.emotions))}))}_addLastStorySkeleton(){this._isLastStoryNessesary()?(this._lastStory=this._getLastStory(),this._lastStory.hasClass(n.wn)||this._addClassLastStory(this._lastStory),this._addSkeleton(this._lastStory),this._isNeedToImitateEndOfFeed()&&this._onDocumentEnd(),this._addObserverToPreloader(this._lastStory)):this._removeAllLastStory()}get stateSnapshot(){return{timestamp:Date.now(),ids:this.stories.ids,idsBefore:this.storiesBefore,idsAfter:this.storiesAfter,sid:this.navigationStoryId,page:this.page,active:this.isRestoreStateMode,feedName:this.feedName,feedRecordId:this.feedRecordId}}get requestId(){return this._options.requestId?this._options.requestId:this._options.requestId=Symbol("feedRequestId")}get requestIdByIds(){return this._options.requestIdByIds?this._options.requestIdByIds:this._options.requestIdByIds=Symbol("feedRequestIdByIds")}get navigationStoryId(){return this._options.navigationStoryId}set navigationStoryId(t){if(t="number"==typeof t?t:parseInt(t,10),this.navigationStoryId===t)return this.navigationStoryId;if(t&&this.stories.size){let e=this.stories.ids.indexOf(t);this._options.amountStoriesBefore=e,this._options.amountStoriesAfter=this.stories.ids.length-e}else this._options.amountStoriesBefore=this._options.amountStoriesAfter=0;return a.vE.logger.log("stories-feed","current navigation id",t),this._options.navigationStoryId=t}get amountStoriesBefore(){return this._options.amountStoriesBefore}get amountStoriesAfter(){return this._options.amountStoriesAfter}get mouseStoryId(){return this._options.mouseStoryId}set mouseStoryId(t){return t="number"==typeof t?t:parseInt(t,10),this.mouseStoryId===t?this.mouseStoryId:(a.vE.logger.log("stories-feed","current mouse id",t),this._options.mouseStoryId=t)}get page(){return this._options.page}set page(t){this._options.page="number"==typeof t?t:parseInt(t,10)}get feedKey(){return this._options.feedKey}set feedKey(t){this._options.feedKey=String(t),this._options.feedEngineVersion>1&&(this.searchParams.delete("twitmod"),this.searchParams.delete("of"),this.searchParams.set("key",this._options.feedKey))}get requestUrl(){return this._options.requestUrl}set requestUrl(t){this._options.requestUrl=String(t)}get searchParams(){return this._options.searchParams||(this._options.searchParams=new P._),this._options.searchParams}set searchParams(t){if(t instanceof P._)return this._options.searchParams=t;let e=this.searchParams;if("string"==typeof t)return e.fromParamsString(t);if("object"==typeof t&&!Array.isArray(t))return e.clear(),gt.forEach(t,((t,s)=>e.set(s,t))),e;throw new Error("Bad query value")}get endOfFeed(){return this._options.endOfFeed}set endOfFeed(t){this._options.endOfFeed!==(t=Boolean(t))&&(this._options.endOfFeed=t,this._updateEndOfFeed(t))}get stories(){return this._options.stories}get isAjaxLoadMode(){return this._options.isAjaxLoadMode}get isPaginationMode(){return!this._options.isAjaxLoadMode}get viewObserver(){return this._viewObserver}get loadAnimationName(){return this._options.loadAnimationName}set loadAnimationName(t){this._options.loadAnimationName!==(t=gt.isBoolean(t)?!!t&&"stories-spinner":t)&&(this._options.loadAnimationName=t,this.isRendered&&(t?this._createLoadAnimation():!t&&this._loadingAnimation&&this._loadingAnimation.destroy()))}get loadAnimation(){return this._options.loadAnimation}set loadAnimation(t){var e;const s=this._options.loadAnimation;if((t=Boolean(t))===s)return t;this._loadingAnimation&&this.loadAnimationName&&this._loadingAnimation.togglePlay(t),null===(e=document.querySelector(`.${n.qC}`))||void 0===e||e.classList.toggle("is-active",t),this._options.loadAnimation=t}get loadAnimationBefore(){return this._options.loadAnimationBefore}set loadAnimationBefore(t){this._options.loadAnimationBefore!==(t=Boolean(t))&&(this.loadAnimationName&&this._loadingAnimationBefore&&this._loadingAnimationBefore.togglePlay(t),this._options.loadAnimationBefore=t)}get storiesBefore(){return this._options.storiesBefore?this._options.storiesBefore:this._options.storiesBefore=[]}get storiesAfter(){return this._options.storiesAfter?this._options.storiesAfter:this._options.storiesAfter=[]}get storiesViewed(){const t=B.mM.get(n.R$)||[];return Array.isArray(t)&&0!==t.length?t:[]}set storiesViewed(t){B.mM.set(n.R$,[...new Set(t)].slice(0,1e3))}get advertsViewed(){const t=B.mM.get(n.kY);if(!gt.isObject(t)||"number"!=typeof t.t||!Array.isArray(t.i)||t.t+n.XA<Date.now()/1e3)return[];const e=t.i;return Array.isArray(e)&&0!==e.length?e:[]}set advertsViewed(t){B.mM.set(n.kY,{t:Date.now()/1e3,i:t.slice(0,1e3)})}get feedName(){return this._options.feedName||""}set feedName(t){this._options.feedName=t}get customFeed(){return this._options.customFeed}set customFeed(t){t&&this._analyticsInstance.yandex.goal("feed_opening",{feed:t}),this._options.customFeed=t}get isSubsMode(){return this._options.isSubsMode}set isSubsMode(t){this._options.isSubsMode=t}get feedRecordId(){return this._options.feedRecordId}set feedRecordId(t){this._options.feedRecordId!==t&&(this._options.feedRecordId=t)}get isExpandedMode(){return this._options.isExpandedMode}set isExpandedMode(t){this._options.isExpandedMode=Boolean(t)}get displayModeViewedStories(){return this._options.displayModeViewedStories||i.kc.VISITED_STORIES_SHOW}set displayModeViewedStories(t){const e=this._options.displayModeViewedStories;if(!(t=i.kc[t])||t===e)return t;this._options.displayModeViewedStories=t,void 0!==e&&(B.eR.set("autohide_news",t.valueOf(),{expires:365}),B.eR.set("set_autohide_news",t.valueOf(),{expires:365}),tt.User.sendSettingsChangeAnalytics("viewed_post",e,t),this.clear().loadStories(!1))}get adultVisible(){return this._options.adultVisible}set adultVisible(t){const e=this._options.adultVisible;t=Boolean(t),e!==t&&(this._options.adultVisible=t,void 0!==e&&tt.User.switchAdult(t).then((()=>{tt.User.sendSettingsChangeAnalytics("show_porno",e,t),this.clear().loadStories(!1)})))}get politicsVisible(){return this._options.politicsVisible}set politicsVisible(t){const e=this._options.politicsVisible;if(t=Boolean(t),e!==t&&(this._options.politicsVisible=t,void 0!==e))return a.vE.isUserAuthorized?void tt.User.switchPolitics(t).then((()=>{tt.User.sendSettingsChangeAnalytics("politics_show",e,t),this.clear().loadStories(!1)})):((new k.U).set("isPoliticsVisible",t),tt.User.sendSettingsChangeAnalytics("politics_show",e,t),void this.clear().loadStories(!1))}get focused(){return a.vE.storage.focused===this.eid}set focused(t){this.focused!==(t=Boolean(t))&&(a.vE.logger.log("feed","focus in",this.eid),a.vE.storage.focused=t?this.eid:void 0)}get isRestoreStateMode(){return this._options.isRestoreStateMode}set isRestoreStateMode(t){this._options.isRestoreStateMode!==(t=Boolean(t))&&(this._options.isRestoreStateMode=t,this.isRendered&&this.loadStateSnapshot())}get useEmptyIds(){return this._options.useEmptyIds}set useEmptyIds(t){this._options.useEmptyIds!==(t=Boolean(t))&&(this._options.useEmptyIds=t)}get isPageScrollable(){return a.vE.ui.isPageScrollable}set isPageScrollable(t){a.vE.ui.isPageScrollable=t}get hiddenStories(){return this._options.hiddenStories}set hiddenStories(t){let e=this._options.hiddenStories;if(this.displayModeViewedStories!==i.kc.VISITED_STORIES_HIDE||!t)return this.hiddenStoriesVisibility=!1,void(this._options.hiddenStories=t);if(e!==t){if(this._options.hiddenStories=t,this.$els.hiddenCounter.length){let e,s;this.$els.hiddenCounter.children().length?(e=this.$els.hiddenCounter.find("a"),s=this.$els.hiddenCounter.find("span.label-hidden"),e.length&&s.length?(e.text(a.vE.i18n("stories-feed.display-mode.hidden-detail_short",t)),s.text(a.vE.i18n("stories-feed.display-mode.hidden-short",t))):(e=this.$els.hiddenCounter.children(),e.text(a.vE.i18n("stories-feed.display-mode.hidden-detail",t)))):(e=this.$els.hiddenCounter,e.text(a.vE.i18n("stories-feed.display-mode.hidden-detail",t))),this.hiddenStoriesVisibility=!0}}else this.hiddenStoriesVisibility=!0}set hiddenStoriesVisibility(t){!this.$els.hiddenCounter.length||t&&this.$els.hiddenCounter.is(":empty")||(this._hiddenStoriesVisibility=t,this.$els.hiddenCounter.toggleClass(o.hiddenCounter.shown,t))}get referrerStoryId(){return this._options.referrerStoryId}set referrerStoryId(t){this._options.referrerStoryId=t}}},1490:(t,e,s)=>{"use strict";s.d(e,{N:()=>p});s(1817),s(6992),s(3948),s(8674);var i=s(6777),n=s(2134),o=s(6572),r=s(9404),a=s(8211);const l="story-visited";let h;const c=s(6419),d=s(9591),u=Symbol();class p{constructor(t){if(t!==u)throw new Error("Cannot construct singleton");this._emitter=new i.vp,this._syncDebounce=c.throttle(this._sync,15e3,{leading:!1}),window.addEventListener("storage",(t=>{t.key===r.sC&&t.newValue&&this._load()})),this._sync()}_sync(){let t=o.mM.get(r.wE);Array.isArray(t)&&t.length&&(t.length>r.U5?(t=t.slice(0,r.U5),o.mM.set(r.wE,t.slice(r.U5))):o.mM.remove(r.wE),o.eR.get("pcid")||a.vE.logger.error("save","id not found viewed"),n.cf.post("/ajax/save_visited_stories.php",{t:"viewed",ids:t.join(",")}))}get _currentTime(){return Math.floor(Date.now()/1e3)}_load(){const t=o.mM.get(r.sC),e=this._storage=new Map,s=this._currentTime;if("object"!=typeof t||!t)return;let i;try{i=JSON.parse(d.inflate(t,{to:"string"}))}catch(n){return void console.warn(n)}if(Array.isArray(i))for(const[o,a]of i){if("number"!=typeof o||!Array.isArray(a.views)||3!==a.views.length)continue;let[t,i,n]=a.views;(-1===t||s-i>r.Ag)&&(t=-1,i=-1),s-n>r.Oq&&(n=-1),-1===i&&-1===n&&-1===t||e.set(o,{views:[t>=0?t:-1,i||-1,n||-1],emotions:a.emotions})}}_save(){if(!this._storage)return;const t=d.deflate(JSON.stringify(Array.from(this._storage.entries())));o.mM.set(r.sC,t)}get storage(){return this._storage||this._load(),this._storage}async getViewAndEmotionsCount(t){let e=this.storage.get(t);if(e&&e.views&&e.views[0]>-1)return e;const{response:s,data:i}=await n.cf.get(a.vE.initParams.statUrl+`/stat/story/${t}`,{},{crossDomain:!0});return e=e||{views:[-1,-1,-1],emotions:{}},e.views[0]=s.result&&i&&i.v?i.v:0,e.views[1]=this._currentTime,e.emotions=s.result&&i&&i.e?i.e:{},this.storage.set(t,e),this._save(),e}isViewed(t){const e=this.storage.get(t);return Boolean(e&&e.views&&e.views[2]>-1)}setViewed(t,e=!0){if(this._emitter.emit(l,t),this.isViewed(t))return;const s=this.storage.get(t)||{views:[-1,-1,-1]};if(s.views[2]=this._currentTime,this.storage.set(t,s),this._save(),!e)return;const i=o.mM.get(r.wE)||[];-1===i.indexOf(t)&&(i.push(t),o.mM.set(r.wE,i),this._syncDebounce())}onStoryViewed(t){return this._emitter.on(l,t),()=>this._emitter.off(l,t)}static get instance(){return h||(h=new p(u),h)}static getViewAndEmotionsCount(t){return p.instance.getViewAndEmotionsCount(t)}static isViewed(t){p.instance.isViewed(t)}static setViewed(t,e=!0){p.instance.setViewed(t,e)}}},5636:(t,e,s)=>{"use strict";s.d(e,{C:()=>d});s(1817),s(6992),s(3948),s(8674);var i=s(6572),n=s(9404),o=s(8211),r=s(2134),a=s(7800);let l;const h=s(6419),c=Symbol();class d{constructor(t){if(t!==c)throw new Error("Cannot construct singleton");this._idStoriesToSync=new Set,this._syncThrottle=h.throttle(this._sync.bind(this),n.Mz,{leading:!1})}async _sync(t=!1){this._abortSync();let e=[...this._idStoriesToSync];if(!e.length)return this;if(this._idStoriesToSync.clear(),t)this._syncByCookie(e);else{this._idStoriesToSyncPending=e;try{await this._syncByAjax(e)}catch(i){var s;null===(s=this._idStoriesToSyncPending)||void 0===s||s.forEach((t=>this._idStoriesToSync.add(t)))}finally{this._idStoriesToSyncPending=null}}return this}_syncByCookie(t){Array.isArray(t)&&t.length?i.eR.set(n.A0,t,{expires:365}):i.eR.remove(n.A0)}async _syncByAjax(t){i.eR.get("pcid")||o.vE.logger.error("save","id not found visited");const{response:e}=await r.cf.post("/ajax/save_visited_stories.php",{t:"visited",ids:t.join(",")});if(!e.result)throw o.vE.logger.error("stories-feed","some trouble with update visited news",o.vE.history.path),new Error;{o.vE.logger.log("stories-feed","good save visited stories",t);const e=a.m.get(n.R$)||[];a.m.set(n.R$,[...t,...e].slice(0,1e3))}}_abortSync(){var t;this._syncThrottle.cancel(),null===(t=this._idStoriesToSyncPending)||void 0===t||t.forEach((t=>this._idStoriesToSync.add(t))),this._idStoriesToSyncPending=null}setVisited(t,e=!1){this._idStoriesToSync.add(t),e||this._syncThrottle()}forceSave(){this._sync(!0)}extractUnsavedIds(){this._abortSync();const t=[...this._idStoriesToSync];return t.length?(this._idStoriesToSync.clear(),t):[]}static get instance(){return l||(l=new d(c),l)}static setVisited(t,e=!1){this.instance.setVisited(t,e)}static forceSave(){this.instance.forceSave()}static extractUnsavedIds(){return this.instance.extractUnsavedIds()}}},4644:(t,e,s)=>{"use strict";s.d(e,{o:()=>c});s(8674);var i=s(4519),n=s(9698),o=s(2134),r=s(8211),a=s(4391),l=s(6572),h=s(2822);s(6419),s(9755);class c extends i.u1{constructor(t){super(t),l.mM.get("pkb_subscr")||l.mM.get("pkb_subscr_counter")>2?this.$el.hide():(this._formClass=this._options.formClass,this._inputClass=this._options.inputClass,this._formObserver=null,this._intersectionCounter=l.mM.get("pkb_subscr_counter"),this._isIntersection=!1,this.listenTo(new this._formClass(this.$el),"submit",this._onSubmitForm),this._emailInput=new this._inputClass({$el:this.$(".input"),sanitizerRules:[n.o.trim()],addClearButton:!1}),this._currentInputValue=this._emailInput.$el.data("email"),this.listenTo(this._emailInput,"change",(()=>{this._currentInputValue=this._emailInput.value})),this.$els={done:this.$(".email-form_done"),main:this.$(".email-form_block"),close:this.$(".email-form_close")},this._options.isFeedElement&&(this._intersectionForm(),this._formObserver&&this._formObserver.observe(this.el)),this.$els.close.on("click",(async()=>{if(r.vE.isUserAuthorized){const{response:t}=await o.cf.post("/ajax/subscription_form.php",{action:"hide"});if(!t.result)return r.vE.ui.toasts.showError(t.message),!1}else l.mM.set("pkb_subscr",!0);this.$el.hide()})))}async _onSubmitForm(t){t.preventDefault(),await this.sendEmailForm(this._currentInputValue)}async _intersectionForm(){a.v&&(this._formObserver=new IntersectionObserver((t=>{if(t.some((t=>t.isIntersecting))){if(this._isIntersection)return!1;this._isIntersection=!0,r.vE.isUserAuthorized?this.formEmailShowing():(this._intersectionCounter++,l.mM.set("pkb_subscr_counter",this._intersectionCounter))}}),{threshold:1}))}async sendEmailForm(t){const{response:e}=await o.cf.post("/ajax/subscription_form.php",{action:"add",email:t});if(!e.result)return r.vE.ui.toasts.showError(e.message),!1;this.$els.main.hide(),this.$els.done.show(),l.mM.set("pkb_subscr",!0);const{type:s}=this._options;return s&&h.c.getInstance().sendEvent("subscribe_email",{email:t,type:s}),!0}async formEmailShowing(){const{response:t}=await o.cf.post("/ajax/subscription_form.php",{action:"track"});if(!t.result)throw new Error(t.message);return!0}}},3181:(t,e,s)=>{"use strict";s.d(e,{DX:()=>a,VQ:()=>r,kc:()=>m});s(6992),s(3948),s(8674),s(2707),s(5827);var i=s(4519),n=s(2906),o=s(7892);const r=new o.xs({STORY:0,EDITOR:1,MANUAL:2}),a=new o.xs({EMPTY:0,WAIT:1,READY:2,ERROR:3});var l=s(6553),h=s(2134);var c=s(6572);const d=s(6419);class u extends n.Lo{constructor(t,e){if(super(t,!0),this._similarStories=e,this.data.block){if(this.listenTo(this.data.block,n.u$.DESTROY,(()=>{this.destroy()})),this.data.type===l.STORY_BLOCK_TYPE.IMAGE){const{url:t}=this.data.block.data;t?this._onResolveImageUrl(this.data.block,t):this.listenTo(this.data.block,"url",d.debounce(this._onResolveImageUrl.bind(this),1e3))}else this.data.type===l.STORY_BLOCK_TYPE.VIDEO_FILE?(this.listenTo(this.data.block,n.u$.CHANGE,d.debounce(this._updateFragments.bind(this),100)),this._updateFragments()):this._updateFragments();this.marks.set("isChangeable",!0)}else this.data.type!==l.STORY_BLOCK_TYPE.TEXT&&this.data.fragments?(this.data.error=!1,this.data.ready=!0):(this.listenTo(this,"body",this._onUpdateTextBody.bind(this,!1)),this._onUpdateTextBody(!0),this.marks.set("isChangeable",!0))}destroy(t=!1){return this.data.type===l.STORY_BLOCK_TYPE.IMAGE&&this._onImageSourceRemoval(this.data.block.data.url),super.destroy(t)}_onUpdateTextBody(t=!1){if(c.cQ.getTextContent(this.data.body).length<5)return this.data.fragments=[],this.data.ready=!0,void(this.data.error=!1);if(this.data.ready=!1,t)return void this._updateFragments();let e=this.marks.get("text-debounce");e||(e=d.debounce(this._updateFragments.bind(this),5e3),this.marks.set("text-debounce",e)),e()}_onResolveImageUrl(t,e){const s=this._getSameImageSources(e),i=s.filter((t=>!t.isDestroyed)).length>0;s.push(this),i?(this.marks.set("isSuspended",!0),this.data.ready=!0):this._updateFragments()}_onImageSourceRemoval(t){if(this.isSuspended)return;const e=this._getSameImageSources(t);for(const s of e)if(s.isSuspended&&!Object.is(this,s)){s.relaunchSearch();break}}_getSameImageSources(t){const{imageSources:e}=this._similarStories;return e.has(t)||e.set(t,[]),e.get(t)}_updateFragments(){this.isDestroyed||(this.isReady&&(this.data.ready=!1),this.resetPagination(),this._getDuplications())}dropErrorFlag(){this.isError&&(this.data.error=!1)}async relaunchSearch(){this.marks.set("isSuspended",!1),this.isDestroyed||(this.isReady&&(this.data.ready=!1),this.resetPagination(),await this._getDuplications())}_createData(t){return t.type=l.STORY_BLOCK_TYPE[t.type],d.isArray(t.fragments)&&t.fragments.sort(((t,e)=>e.relevance-t.relevance)).forEach((t=>t.type=l.STORY_BLOCK_TYPE[t.type])),super._createData(t)}async _getDuplications(){let t;if(this.data.block){let e=this.data.block;t=this.data.type===l.STORY_BLOCK_TYPE.VIDEO_FILE?{fid:e.data.fid,type:l.STORY_BLOCK_TYPE.VIDEO_FILE.valueOf()}:e.serialize()}else{if(this.data.type!==l.STORY_BLOCK_TYPE.TEXT||!this.data.body)return this.data.ready=!0,void(this.data.error=!1);t={type:l.STORY_BLOCK_TYPE.TEXT.valueOf(),body:this.data.body}}t.action="find_duplicates",this.data.storyId&&(t.story_id=this.data.storyId);let{response:e,data:s}=await h.cf.post("/ajax/stories_actions.php",t);if(this.isDestroyed)return;if(!e.result)return this.data.fragments=[],this.data.ready=!1,void(this.data.error=!0);let i=d.isArray(s)?s:[];this.data.fragments=i.filter(this._similarStories.filterFragments).sort(((t,e)=>e.relevance-t.relevance)).map((t=>(t.type=l.STORY_BLOCK_TYPE[t.type],t))),this.data.ready=!0,this.data.error=!1}resetPagination(){return this.marks.delete("finished"),this.marks.delete("last"),this}getPartOfFragments(t){let e,s=this.data.fragments,i=this.marks.get("last")||0,n=i+t;return s&&s.length&&!this.marks.has("finished")?(e=s.slice(i,n),this.marks.set("last",n),n>=s.length&&this.marks.set("finished",!0),e):[]}get isChangeable(){return this.marks.has("isChangeable")}get isSuspended(){return this.marks.has("isSuspended")}get isFinished(){return this.marks.has("finished")}get isEmpty(){return!d.isArray(this.data.fragments)||0===this.data.fragments.length}get isReady(){return this.data.ready}get isError(){return this.data.error}}u.prototype.defaults={type:void 0,fragments:void 0,block:void 0,storyId:void 0,ready:!1,error:!1};const p=s(6419);class m extends i.u1{constructor(t){super(t),this._currentSource=-1,this._options.imageSources=new Map,this._options.fragmentsLinePerPage=5,this._options.fragmentSize={[l.STORY_BLOCK_TYPE.VIDEO]:1,[l.STORY_BLOCK_TYPE.IMAGE]:1,[l.STORY_BLOCK_TYPE.VIDEO_FILE]:1,[l.STORY_BLOCK_TYPE.TEXT]:3},this._options.sources=new n.qg(!1,u),this.sources.prepareData=t=>t instanceof n.Lo?t:new u(t,this),this._isImageSearchDisabled=t.isImageSearchDisabled||!1,this.listenTo(this.sources,n.u$.UPDATE,this._onUpdateSources)}_onUpdateSources(t,e){e&&e.inserted&&e.inserted.filter((t=>t.isChangeable)).forEach((t=>{this.listenTo(t,"ready",this._onUpdateSourcesState),this.listenTo(t,"error",this._onUpdateSourcesState),this.listenTo(t,n.u$.DESTROY,this._onSourceRemoval.bind(this))})),this._onUpdateSourcesState()}_onUpdateBlocks(t,e){e&&e.inserted&&e.inserted.filter((t=>t.data.type===l.STORY_BLOCK_TYPE.IMAGE||t.data.type===l.STORY_BLOCK_TYPE.VIDEO||t.data.type===l.STORY_BLOCK_TYPE.VIDEO_FILE)).forEach((t=>{this._isImageSearchDisabled&&t.data.type===l.STORY_BLOCK_TYPE.IMAGE||this.sources.add({type:t.data.type,block:t})}))}async relaunchErrorSources(){let t=[];for(let e of this.sources.items)e.dropErrorFlag(),t.push(e);for(let e of t)await e.relaunchSearch()}_onSourceRemoval(){this.state=a.WAIT,this._onUpdateSourcesState()}_onUpdateSourcesState(){if(!this.sources.size)return void(this.state=a.EMPTY);if(this.sources.items.some((t=>t.isError)))this.state=a.ERROR;else if(this.sources.items.every((t=>t.isReady))){let t=this.sources.items.every((t=>t.isEmpty));this.state=t?a.EMPTY:a.READY}else this.state=a.WAIT}getPageFragments(t=!1){t&&(this.sources.items.forEach((t=>t.resetPagination())),this._currentSource=-1);let e=this._getFragments(this.fragmentsLinePerPage*this.fragmentsLineSize);return e.length>0&&(e.sort(((t,e)=>e.relevance-t.relevance)),e=p.sortBy(e,((t,e)=>t.type===l.STORY_BLOCK_TYPE.TEXT?e.type===l.STORY_BLOCK_TYPE.TEXT?0:-1:1))),e}_getFragments(t){let e,s,i,n,o,r=0,a=0,l=[],h=this.fragmentsLineSize,c=this.sources.size,d=1e3;for(;t>0&&r+a<c&&d;)if(d--,this._currentSource++,this._currentSource>=c&&(r=a=0,this._currentSource=0),n=this.sources.items[this._currentSource],n.isFinished)r++;else if(i=n.data.type,o=this.fragmentSize[i],t<o){if(a+r+1>c)break;a++}else s=Math.ceil(h/o),s*o>t&&(s=Math.floor(t/o)),e=n.getPartOfFragments(s),e&&0!==e.length&&!n.isFinished||r++,e&&e.length&&(l=l.concat(e),t-=e.length*o);return l}async getStoryDuplications(){if(!this.storyId)return;this.marks.set("get-story-duplications",this.storyId);let{response:t,data:e}=await h.cf.post("/ajax/stories_actions.php",{action:"get_duplicates",story_id:this.storyId});this.isDestroyed||this.marks.get("get-story-duplications")!==this.storyId||(t.result&&p.isObject(e)&&Object.keys(e).length?this.addSources(e):this.state=a.EMPTY)}addSources(t,e=!0){if(p.isObject(t)&&!p.isArray(t)){let e=Object.keys(t);if(!e.length)return this;if(p.isArray(t[e[0]]))t=p.map(t,(t=>t));else{if(!e.includes("type"))return this;t=[[t]]}}return p.isArray(t)&&t.length?(p.isArray(t[0])||(t=[t]),t=t.filter((t=>p.isArray(t)&&t.length)).map((t=>({type:l.STORY_BLOCK_TYPE[t[0].type||"text"],fragments:t,ready:e}))),this.sources.add(t),this):this}_updateState(t){}_updateType(t){}get filterFragments(){let t=this._options.filterFragments;return p.isFunction(t)||(t=this._options.filterFragments=()=>!0),t}set filterFragments(t){this._options.filterFragments=t}set textBlock(t){this._textSource||(this._textSource=new u({type:l.STORY_BLOCK_TYPE.TEXT,body:t},this),this.sources.add(this._textSource)),this._textSource.data.body=t}get type(){return this._options.type||r.STORY}set type(t){let e=this._options.type;(t=r[t])&&t!==e&&(this._options.type=t,this.isRendered&&this._updateType(t))}get blocks(){return this._options.blocks}set blocks(t){this._options.blocks!==t&&(this._options.blocks=t,t&&this.listenTo(t,n.u$.UPDATE,this._onUpdateBlocks),this.isRendered&&this._updateType(this.type))}get storyId(){return this._options.storyId}set storyId(t){this._options.storyId!==(t=Number(t))&&(this._options.storyId=t,this.type===r.STORY&&t&&this.isRendered&&this._updateType(this.type))}get state(){return this._options.state||a.READY}set state(t){let e=this._options.state;(t=a[t])&&t!==e&&(this._options.state=t,this._updateState(t),this.emit("state",t))}get sources(){return this._options.sources}get imageSources(){return this._options.imageSources}get fragmentsLinePerPage(){return this._options.fragmentsLinePerPage}get fragmentSize(){return this._options.fragmentSize}get fragmentsLineSize(){return p.reduce(this.fragmentSize,((t,e)=>t<e?e:t),0)}}},8044:(t,e,s)=>{"use strict";s.d(e,{s:()=>a});s(8674);var i=s(6777),n=s(9755),o=s.n(n);function r(t,e,s){return e in t?Object.defineProperty(t,e,{value:s,enumerable:!0,configurable:!0,writable:!0}):t[e]=s,t}class a extends i.vp{constructor(t){super(),r(this,"rulesOpened","community__rules_opened"),r(this,"rulesShowMoreOpened","community__rules-more_opened"),this.editor=t;const e=this.editor.el.querySelector(".story-editor__communities");if(!e)return this.blockExists=!1,this.el=null,void(this.els={inputSearch:null,realInputSearch:null,selectedCommunity:null,btnOpenStepper:null,recommended:null,communityRules:{el:null,inner:null,more:null},ownCommunities:{el:null,inner:null},recommendedCommunities:{el:null,inner:null}});this.blockExists=!0,this.el=e;const s='.section-group[data-role="communities-own"]',i='.section-group[data-role="communities-recommended"]',n=this.editor.el;this.els={inputSearch:this.el.querySelector('.input[data-role="community-search"]'),realInputSearch:this.el.querySelector('.input[data-role="community-search"] input'),selectedCommunity:this.el.querySelector('.form__field[data-role="community"]'),btnOpenStepper:this.el.querySelector(".story-editor__communities-add"),recommended:this.el.querySelector(".story-editor__communities-recommended"),communityRules:{el:this.el.querySelector('[data-role="community-rules"]'),inner:this.el.querySelector(".community__rules"),more:this.el.querySelector(".community-comments__rules-more")||this.el.querySelector(".community__rules-more")},ownCommunities:{el:n.querySelector(s),inner:n.querySelector(`${s} > section:last-child`)},recommendedCommunities:{el:n.querySelector(i),inner:n.querySelector(`${i} > section:last-child`)}},this.init(),this.handleRulesMoreClick(),this.handleDraftLoaded()}setCommunity(t,e){if(!this.blockExists)return;const{selectedCommunity:s,communityRules:i}=this.els,n=Boolean(t);if(!s||!i.el||!i.inner)return;const r=o()(s);n&&r.empty().append(e(t)),r.toggle(n);const a=n&&Boolean(t.rules.length);a&&o()(i.inner).empty().append("<div>"+t.rules+"</div>").removeClass(this.rulesOpened),o()(i.el).toggle(a),this.toggleRulesMore()}toggleRulesMore(){if(!this.blockExists)return;const{inner:t,more:e}=this.els.communityRules,s=null==t?void 0:t.firstElementChild;if(!t||!e)return;const i=s instanceof HTMLElement&&s.offsetHeight>t.offsetHeight;e.classList.toggle(this.rulesShowMoreOpened,i)}showRecommendations(t,e){if(!this.blockExists)return;if(!this.els.recommended)return;const s=o()(this.els.recommended);t.length?s.empty().append(this.renderCommunitiesList(t,e)):s.empty()}async showEmptyCommunityToast(){this.blockExists&&this.uiInput&&(await this.uiInput.scrollIfNotVisible(),this.uiInput.setCustomValidity("story-editor.errors.community-empty"))}renderCommunitiesList(t,e){if(!this.blockExists)return o()(document.createDocumentFragment());const s=o()(document.createDocumentFragment());for(let i,n=0,r=t.length;n<r;n++)i=t[n],o()(e(i)).data("community",i).appendTo(s);return s}handleRulesMoreClick(){if(!this.blockExists)return;const{inner:t,more:e}=this.els.communityRules;t&&e&&e.addEventListener("click",(()=>{e.classList.remove(this.rulesShowMoreOpened),t.classList.add(this.rulesOpened)}))}handleDraftLoaded(){this.blockExists&&this.editor._options.page&&this.listenToOnce(this.editor._options.page,"data-loaded",this.toggleRulesMore.bind(this))}get exists(){return!!this.blockExists&&Boolean(this.els.inputSearch)}}},4440:(t,e,s)=>{"use strict";s.d(e,{A:()=>a});s(4916),s(5827),s(6992),s(3948);var i=s(6777),n=s(9755),o=s.n(n),r=s(2822);class a extends i.vp{constructor(t){var e,s,i;super(),i=!1,(s="listenerExists")in(e=this)?Object.defineProperty(e,s,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[s]=i,this.editor=t;const n=document.querySelector(".story-editor__tags");if(!n)return this.blockExists=!1,this.el=null,void(this.els={inputWrapper:null,btnAdd:null,recommended:null});this.blockExists=!0,this.el=n,this.els={inputWrapper:this.el.querySelector(".input_tags"),btnAdd:this.el.querySelector(".story-editor__tags-add"),recommended:this.el.querySelector(".story-editor__tags-recommended")},this.init()}clear(){this.blockExists&&this.tagsInput&&this.tagsInput.clear()}set(t){this.blockExists&&this.tagsInput&&t&&(this.tagsInput.clear(),this.tagsInput.deserialize(t))}add(t){this.blockExists&&this.tagsInput&&t&&this.tagsInput.createItem(t)}showRecommendations(t){this.blockExists&&this.el&&this.els.recommended&&(this.recommendedTagsWrapper=o()(this.els.recommended),(t=this.removeDuplicates(t)).length&&this.length<20?this.showWrapper(t):this.hideWrapper())}toggleDisplay(t,e){this.blockExists&&t&&(t.style.display=e?"block":"none")}onTagClick({target:t}){var e,s;if(!this.blockExists)return;const i=String(t.textContent);if(this.value.split(",").includes(i))return;this.add(i),this.length>=20&&this.hideWrapper();const{score:n,index:o}=t.dataset;r.c.getInstance().sendEvent("click",{type:"recommended_extra_tag",tags:i,rec_score:null!==(e=Number(n))&&void 0!==e?e:null,screen_index:null!==(s=Number(o))&&void 0!==s?s:null})}showWrapper(t){if(!this.blockExists)return;const e=t.map((({extra_tag:t,score:e,screen_index:s})=>`<span data-score="${null!=e?e:null}" data-index="${null!=s?s:null}">${t}</span>`));this.recommendedTagsWrapper.html("<p>Рекомендованные теги:</p>"+e.join("")),this.listenerExists||(this.recommendedTagsWrapper.on("click","span",this.onTagClick.bind(this)),this.listenerExists=!0)}hideWrapper(){this.blockExists&&(this.recommendedTagsWrapper.html(""),this.listenerExists&&(this.recommendedTagsWrapper.off("click","span",this.onTagClick.bind(this)),this.listenerExists=!1))}removeDuplicates(t){if(!this.blockExists)return[];const e=[];let s=t.reduce(((t,s)=>{const i=s.extra_tag;return e.includes(i)||(e.push(i),t.push(s)),t}),[]);const i=this.value.split(",");s=s.filter((t=>!i.includes(t.extra_tag)));const n=["Политика","Негатив","Жесть"],o=[];let r;for(const a of n)for(;-1!==(r=s.findIndex((t=>t.extra_tag===a)));)o.push(s.splice(r,1)[0]);return o.concat(s)}get exists(){return!!this.blockExists&&void 0!==this.tagsInput}get value(){return this.blockExists&&this.tagsInput?this.tagsInput.value:""}get length(){return this.blockExists&&this.tagsInput?this.tagsInput.items.items.length:0}get input(){return this.tagsInput}}},5035:(t,e,s)=>{"use strict";let i,n,o;s.d(e,{oY:()=>i,Ks:()=>n,A2:()=>o,tQ:()=>r}),function(t){t.ADD_TEXT="add_text",t.ADD_IMAGE="add_picture",t.ADD_VIDEO="add_video",t.ADD_TAG="add_tag",t.MARK_MINE="mark_mine",t.MARK_NSFW="mark_nsfw",t.MARK_COMMUNITY="mark_public_for_community",t.POST_PREVIEW="post_preview"}(i||(i={})),function(t){t.BLOCKS_UPDATED="blocks-updated"}(n||(n={})),function(t){t[t.ERROR_UNKNOWN=100]="ERROR_UNKNOWN",t[t.ERROR_TITLE_RANGE=101]="ERROR_TITLE_RANGE",t[t.ERROR_TITLE_SYMBOL=102]="ERROR_TITLE_SYMBOL",t[t.ERROR_TITLE_CONTAIN_LINK=103]="ERROR_TITLE_CONTAIN_LINK",t[t.ERROR_TITLE_FORBIDDEN_DOMAIN=104]="ERROR_TITLE_FORBIDDEN_DOMAIN",t[t.ERROR_TITLE_FORBIDDEN_WORDS=105]="ERROR_TITLE_FORBIDDEN_WORDS",t[t.ERROR_TAG_NEED_MORE=106]="ERROR_TAG_NEED_MORE",t[t.ERROR_TAG_NEED_LESS=107]="ERROR_TAG_NEED_LESS",t[t.ERROR_TAG_STRING_LENGTH=108]="ERROR_TAG_STRING_LENGTH",t[t.ERROR_TAG_EXISTING_COUNT=109]="ERROR_TAG_EXISTING_COUNT",t[t.ERROR_TAG_FORBIDDEN_DOMAIN=110]="ERROR_TAG_FORBIDDEN_DOMAIN",t[t.ERROR_TAG_FORBIDDEN_WORDS=111]="ERROR_TAG_FORBIDDEN_WORDS",t[t.ERROR_IMAGE_INCORRECT=112]="ERROR_IMAGE_INCORRECT",t[t.ERROR_AUTHOR_BANNED=113]="ERROR_AUTHOR_BANNED",t[t.ERROR_LINK_MISSING=114]="ERROR_LINK_MISSING",t[t.ERROR_LINK_NOT_VALID=115]="ERROR_LINK_NOT_VALID",t[t.ERROR_TEXT_BOLD=116]="ERROR_TEXT_BOLD",t[t.ERROR_TEXT_BLOCK_LENGTH=117]="ERROR_TEXT_BLOCK_LENGTH",t[t.ERROR_TEXT_FORBIDDEN_DOMAIN=118]="ERROR_TEXT_FORBIDDEN_DOMAIN",t[t.ERROR_TEXT_LENGTH=119]="ERROR_TEXT_LENGTH",t[t.ERROR_TEXT_DESC_LENGTH=120]="ERROR_TEXT_DESC_LENGTH",t[t.ERROR_TEXT_USER_CALLS=121]="ERROR_TEXT_USER_CALLS",t[t.ERROR_TEXT_CONFLICT_WITH_COMMENT_IGNORE=122]="ERROR_TEXT_CONFLICT_WITH_COMMENT_IGNORE",t[t.ERROR_TEXT_CONFLICT_WITH_INVERT_COMMENT_IGNORE=123]="ERROR_TEXT_CONFLICT_WITH_INVERT_COMMENT_IGNORE",t[t.ERROR_VIDEO_COUB=124]="ERROR_VIDEO_COUB",t[t.ERROR_VIDEO_NOT_VALID=125]="ERROR_VIDEO_NOT_VALID",t[t.ERROR_VIDEO_FORBIDDEN_CHANNEL=126]="ERROR_VIDEO_FORBIDDEN_CHANNEL",t[t.ERROR_COMMON_NOT_USER=127]="ERROR_COMMON_NOT_USER",t[t.ERROR_COMMON_NOT_ANONYMOUS=128]="ERROR_COMMON_NOT_ANONYMOUS",t[t.ERROR_COMMON_NSFW=129]="ERROR_COMMON_NSFW",t[t.ERROR_COMMON_FORBIDDEN_ANONYMOUS=130]="ERROR_COMMON_FORBIDDEN_ANONYMOUS",t[t.ERROR_COMMON_BANNED=131]="ERROR_COMMON_BANNED",t[t.ERROR_COMMON_RAITING_LIMIT=132]="ERROR_COMMON_RAITING_LIMIT",t[t.ERROR_COMMON_DAY_LIMIT=133]="ERROR_COMMON_DAY_LIMIT",t[t.ERROR_COMMON_TIME_LIMIT=134]="ERROR_COMMON_TIME_LIMIT",t[t.ERROR_COMMON_STORY_DELETED=135]="ERROR_COMMON_STORY_DELETED",t[t.ERROR_COMMON_ANOTHER_AUTHOR=136]="ERROR_COMMON_ANOTHER_AUTHOR",t[t.ERROR_COMMON_NOT_EDITABLE=137]="ERROR_COMMON_NOT_EDITABLE",t[t.ERROR_BLOCKS_MEDIA_MAX=138]="ERROR_BLOCKS_MEDIA_MAX",t[t.ERROR_COMMON_TIME_EDITABLE=139]="ERROR_COMMON_TIME_EDITABLE",t[t.ERROR_COMMON_RATING_EDITABLE=140]="ERROR_COMMON_RATING_EDITABLE",t[t.ERROR_COMMON_REMOVED_BY_MODERATOR=141]="ERROR_COMMON_REMOVED_BY_MODERATOR",t[t.ERROR_COMMON_DELETED_FULLY=142]="ERROR_COMMON_DELETED_FULLY",t[t.ERROR_COMMON_NUMBER_EDITS=143]="ERROR_COMMON_NUMBER_EDITS",t[t.ERROR_COMMON_STORY_TRANSITED=144]="ERROR_COMMON_STORY_TRANSITED",t[t.ERROR_COMMON_STORY_ADVERT=145]="ERROR_COMMON_STORY_ADVERT",t[t.ERROR_COMMON_ADVERT_FORMAT=146]="ERROR_COMMON_ADVERT_FORMAT",t[t.ERROR_COMMON_LOCKED_COMMUNITY=147]="ERROR_COMMON_LOCKED_COMMUNITY",t[t.ERROR_COMMON_NOT_COMMUNITY=148]="ERROR_COMMON_NOT_COMMUNITY",t[t.ERROR_COMMON_SPECIAL_COMMUNITY=149]="ERROR_COMMON_SPECIAL_COMMUNITY",t[t.ERROR_COMMON_BLOCKED_COMMUNITY=150]="ERROR_COMMON_BLOCKED_COMMUNITY",t[t.ERROR_COMMON_NOT_ANONYMOUS_ADD=151]="ERROR_COMMON_NOT_ANONYMOUS_ADD",t[t.ERROR_COMMON_BLOCKED_IN_COMMUNITY=152]="ERROR_COMMON_BLOCKED_IN_COMMUNITY",t[t.ERROR_COMMON_RATING_IN_COMMUNITY=153]="ERROR_COMMON_RATING_IN_COMMUNITY",t[t.ERROR_COMMON_DISALLOW_ADD=154]="ERROR_COMMON_DISALLOW_ADD",t[t.ERROR_BLOCKS_MIN=155]="ERROR_BLOCKS_MIN",t[t.ERROR_BLOCKS_MAX=156]="ERROR_BLOCKS_MAX",t[t.ERROR_BLOCKS_CAN_NOT_ADD=157]="ERROR_BLOCKS_CAN_NOT_ADD",t[t.ERROR_BLOCKS_IMAGE_NOT_FOUND=158]="ERROR_BLOCKS_IMAGE_NOT_FOUND",t[t.ERROR_BLOCKS_IMAGE_SIZE=159]="ERROR_BLOCKS_IMAGE_SIZE",t[t.ERROR_BLOCKS_IMAGE_HEIGHT_LIMIT=160]="ERROR_BLOCKS_IMAGE_HEIGHT_LIMIT",t[t.ERROR_BLOCKS_FILE_SIZE=161]="ERROR_BLOCKS_FILE_SIZE",t[t.ERROR_BLOCKS_VIDEO_RATING=162]="ERROR_BLOCKS_VIDEO_RATING",t[t.ERROR_BLOCKS_VIDEO_INFO=163]="ERROR_BLOCKS_VIDEO_INFO",t[t.ERROR_BLOCKS_VIDEO_FORMAT=164]="ERROR_BLOCKS_VIDEO_FORMAT",t[t.ERROR_BLOCKS_VIDEO_NOT_FOUND=165]="ERROR_BLOCKS_VIDEO_NOT_FOUND",t[t.ERROR_COMMON_UNKNOWN_FORMAT=166]="ERROR_COMMON_UNKNOWN_FORMAT",t[t.ERROR_COMMON_ICON_LINK=167]="ERROR_COMMON_ICON_LINK",t[t.ERROR_COMMON_NOT_TRANSITION=168]="ERROR_COMMON_NOT_TRANSITION",t[t.ERROR_COMMON_COMMUNITY_RATING=169]="ERROR_COMMON_COMMUNITY_RATING",t[t.ERROR_IMAGE_NOT_UPLOADED=170]="ERROR_IMAGE_NOT_UPLOADED",t[t.ERROR_COMMON_BAD_NETWORK=171]="ERROR_COMMON_BAD_NETWORK",t[t.ERROR_TAG_MIN_TAG=172]="ERROR_TAG_MIN_TAG"}(o||(o={}));const r={[o.ERROR_UNKNOWN]:"error_unknown",[o.ERROR_TITLE_RANGE]:"error_title_range",[o.ERROR_TITLE_SYMBOL]:"error_title_symbol",[o.ERROR_TITLE_CONTAIN_LINK]:"error_title_contain_link",[o.ERROR_TITLE_FORBIDDEN_DOMAIN]:"error_title_forbidden_domain",[o.ERROR_TITLE_FORBIDDEN_WORDS]:"error_title_forbidden_words",[o.ERROR_TAG_NEED_MORE]:"error_tag_need_more",[o.ERROR_TAG_NEED_LESS]:"error_tag_need_less",[o.ERROR_TAG_STRING_LENGTH]:"error_tag_string_length",[o.ERROR_TAG_EXISTING_COUNT]:"error_tag_existing_count",[o.ERROR_TAG_FORBIDDEN_DOMAIN]:"error_tag_forbidden_domain",[o.ERROR_TAG_FORBIDDEN_WORDS]:"error_tag_forbidden_words",[o.ERROR_IMAGE_INCORRECT]:"error_image_incorrect",[o.ERROR_AUTHOR_BANNED]:"error_author_banned",[o.ERROR_LINK_MISSING]:"error_link_missing",[o.ERROR_LINK_NOT_VALID]:"error_link_not_valid",[o.ERROR_TEXT_BOLD]:"error_text_bold",[o.ERROR_TEXT_BLOCK_LENGTH]:"error_text_block_length",[o.ERROR_TEXT_FORBIDDEN_DOMAIN]:"error_text_forbidden_domain",[o.ERROR_TEXT_LENGTH]:"error_text_length",[o.ERROR_TEXT_DESC_LENGTH]:"error_text_desc_length",[o.ERROR_TEXT_USER_CALLS]:"error_text_user_calls",[o.ERROR_TEXT_CONFLICT_WITH_COMMENT_IGNORE]:"error_text_conflict_with_comment_ignore",[o.ERROR_TEXT_CONFLICT_WITH_INVERT_COMMENT_IGNORE]:"error_text_conflict_with_invert_comment_ignore",[o.ERROR_VIDEO_COUB]:"error_video_coub",[o.ERROR_VIDEO_NOT_VALID]:"error_video_not_valid",[o.ERROR_VIDEO_FORBIDDEN_CHANNEL]:"error_video_forbidden_channel",[o.ERROR_COMMON_NOT_USER]:"error_common_not_user",[o.ERROR_COMMON_NOT_ANONYMOUS]:"error_common_not_anonymous",[o.ERROR_COMMON_NSFW]:"error_common_not_nsfw",[o.ERROR_COMMON_FORBIDDEN_ANONYMOUS]:"error_common_forbidden_anonymous",[o.ERROR_COMMON_BANNED]:"error_common_banned",[o.ERROR_COMMON_RAITING_LIMIT]:"error_common_rating_limit",[o.ERROR_COMMON_DAY_LIMIT]:"error_common_day_limit",[o.ERROR_COMMON_TIME_LIMIT]:"error_common_time_limit",[o.ERROR_COMMON_STORY_DELETED]:"error_common_story_deleted",[o.ERROR_COMMON_ANOTHER_AUTHOR]:"error_common_another_author",[o.ERROR_COMMON_NOT_EDITABLE]:"error_common_not_editable",[o.ERROR_BLOCKS_MEDIA_MAX]:"error_blocks_media_max",[o.ERROR_COMMON_TIME_EDITABLE]:"error_common_time_editable",[o.ERROR_COMMON_RATING_EDITABLE]:"error_common_rating_editable",[o.ERROR_COMMON_REMOVED_BY_MODERATOR]:"error_common_removed_by_moderator",[o.ERROR_COMMON_DELETED_FULLY]:"error_common_deleted_fully",[o.ERROR_COMMON_NUMBER_EDITS]:"error_common_number_edits",[o.ERROR_COMMON_STORY_TRANSITED]:"error_common_story_transited",[o.ERROR_COMMON_STORY_ADVERT]:"error_common_story_advert",[o.ERROR_COMMON_ADVERT_FORMAT]:"error_common_advert_format",[o.ERROR_COMMON_LOCKED_COMMUNITY]:"error_common_locked_community",[o.ERROR_COMMON_NOT_COMMUNITY]:"error_common_not_community",[o.ERROR_COMMON_SPECIAL_COMMUNITY]:"error_common_special_community",[o.ERROR_COMMON_BLOCKED_COMMUNITY]:"error_common_blocked_community",[o.ERROR_COMMON_NOT_ANONYMOUS_ADD]:"error_common_not_anonymous_add",[o.ERROR_COMMON_BLOCKED_IN_COMMUNITY]:"error_common_blocked_in_community",[o.ERROR_COMMON_RATING_IN_COMMUNITY]:"error_common_rating_in_community",[o.ERROR_COMMON_DISALLOW_ADD]:"error_common_disalow_add",[o.ERROR_BLOCKS_MIN]:"error_blocks_min",[o.ERROR_BLOCKS_MAX]:"error_blocks_max",[o.ERROR_BLOCKS_CAN_NOT_ADD]:"error_blocks_can_not_add",[o.ERROR_BLOCKS_IMAGE_NOT_FOUND]:"error_blocks_image_not_found",[o.ERROR_BLOCKS_IMAGE_SIZE]:"error_blocks_image_size",[o.ERROR_BLOCKS_IMAGE_HEIGHT_LIMIT]:"error_blocks_image_height_limit",[o.ERROR_BLOCKS_FILE_SIZE]:"error_blocks_file_size",[o.ERROR_BLOCKS_VIDEO_RATING]:"error_blocks_video_rating",[o.ERROR_BLOCKS_VIDEO_INFO]:"error_blocks_video_info",[o.ERROR_BLOCKS_VIDEO_FORMAT]:"error_blocks_video_format",[o.ERROR_BLOCKS_VIDEO_NOT_FOUND]:"error_blocks_video_not_found",[o.ERROR_COMMON_UNKNOWN_FORMAT]:"error_common_unknown_format",[o.ERROR_COMMON_ICON_LINK]:"error_common_icon_link",[o.ERROR_COMMON_NOT_TRANSITION]:"error_common_not_transition",[o.ERROR_COMMON_COMMUNITY_RATING]:"error_common_community_rating",[o.ERROR_IMAGE_NOT_UPLOADED]:"error_image_not_uploaded",[o.ERROR_COMMON_BAD_NETWORK]:"error_common_bad_network",[o.ERROR_TAG_MIN_TAG]:"error_tag_min_tags"}},4437:(t,e,s)=>{"use strict";s.d(e,{jj:()=>at,S8:()=>g,Jc:()=>v,RI:()=>_,vr:()=>ot,k9:()=>$,dT:()=>m,p9:()=>w,uW:()=>u,oD:()=>E,R6:()=>y,_E:()=>d,ik:()=>b,CI:()=>nt});s(6992),s(3948),s(2707),s(8674),s(285),s(1637),s(4916),s(5306),s(5827),s(8559);var i=s(8211),n=s(4519),o=s(2134),r=s(5997),a=s(6726);const l="_sb_id",h=["id","type","url","body","fid","is_muted","cut_from","cut_to"],c=[...h,"url_preview","duration","ratio","host","is_animated_image","size"],d=3,u=1e3,p="pkb_SEd",m=/(?:https?:\/\/)?(?:[-a-z0-9]+\.)?pikabu\.(ru|lh|local)\/story.+_[0-9]{1,10}\?cid=/g,_=2,g=140,v=160;var f=s(7892);const y=new f.xs({MIN_RATING:0,MIN_RATING_IMAGES:1,MIN_RATING_VIDEOS:2,MAX_IMAGES:3,MAX_VIDEOS:4,MAX_MEDIA:5,MAX_BLOCKS:6}),b=new f.xs({NORMAL:"normal",CA:"ca",AB:"ab"}),w=new f.xs({OFF:0,CHOICE:1,SELECTED:2}),E=new f.xs({BACKEND_PREVIEW:1,BACKEND_PUBLISH:2,TEXT_LENGTH:3,FILE_MIME:4,FILE_SIZE:5,BLOCKS_MISSING:6,COMMUNITY_EMPTY:7,UPLOAD_NOT_ALL:8,VIDEO_FILE_SIZE:12,VIDEO_MIN_WIDTH:13,VIDEO_MIN_HEIGHT:14,VIDEO_MIN_RATIO:15,VIDEO_MAX_RATIO:16,VIDEO_MIN_DURATION:17,VIDEO_MAX_DURATION:18});var S=s(3181),C=s(5035),T=s(6553),O=s(2906),k=s(3491);const I=s(6419);class $ extends O.Lo{constructor(t,e){super(t),this._editor=e,this.el=void 0,this.elMini=void 0,this.$el=void 0,this.$elMini=void 0}destroy(t){this.$el&&(this.$el.off(),this.$el.empty().remove()),this.$els&&(this.$els=void 0),super.destroy(t)}focus(){return this}render(){return this.$el}renderMini(){return this.$elMini}serialize(t=!1){let e={},s=t?c:h;this.data.type===T.STORY_BLOCK_TYPE.VIDEO_FILE&&s.push("info");for(let i of s)this._data.hasOwnProperty(i)&&!I.isUndefined(this._data[i])&&(e[i]=this._data[i].valueOf());return e}canSerialize(){return!0}$(t){return this.$el.find(t)}get editor(){return this._editor}get isFocused(){return!1}set loading(t){if(this.$els.loading.length&&(t?this.$els.loading.show():this.$els.loading.fadeOut(200)),t)return this._progress||(this._progress=new k.j({percent:8,strokeWidth:30}),this._progress.appendTo(this.$els.loading)),void this._progress.show();this._progress&&this._progress.hide()}}$.prototype.defaults={id:void 0,at:0,type:void 0,body:void 0,url:void 0,plainBody:void 0,isDisabledDelete:!1,isDisabledDeleteConfirm:!1,isDisabledAdding:!1,isDisabledLeaveLink:!0};var A=s(3414),x=s(8553),D=s(566),P=s(6572),R=s(9476);const M=s(6419),N=s(9755);class B{constructor(t){this.isRunning=!1,this.o=M.extend({},{el:".locktime-counter",onSuccess:t=>{}},t),this.$el=N(this.o.el).first();let e=parseInt(this.$el.data("locktime"),10);this.type=this.$el.data("type")||"word",this.estimate=Math.floor(Date.now()/1e3)+e,this.timeInterval=1e3,this.run()}run(){return this.isRunning||(this.at=setInterval((()=>{let t=this.estimate-Math.floor(Date.now()/1e3);if(t<1)return"function"==typeof this.o.onSuccess&&this.o.onSuccess(this),clearInterval(this.at);this.print(t)}),this.timeInterval)),this}stop(){return this.isRunning=!1,clearInterval(this.at),this}print(t){"word"===this.type?this.$el.text(this.toWords(t)):this.$el.text(this.toHHMMSS(t))}toWords(t){let e="",s="",n=0,o=0,r="";return t>3600&&(n=Math.floor(t/3600),e=n+" "+i.vE.i18n("story-editor.hours",n)),t>60?(o=Math.ceil((t-3600*n)/60),s=0===o?"":o+" "+i.vE.i18n("story-editor.minutes",o),r=e+" "+s):r=t+" "+i.vE.i18n("story-editor.seconds",t),r}toHHMMSS(t){let e="",s="",i="",n=0,o=0,r=0;return t>3600&&(n=Math.floor(t/3600),e=n+":"),o=Math.floor((t-3600*n)/60),s=(o<10?"0"+o:o)+":",r=t-3600*n-60*o,i=r<10?"0"+r:r,e+s+i}}var L=s(4616),F=s(2822);var U=s(7025),j=s(150);function V(t,e,s){return e in t?Object.defineProperty(t,e,{value:s,enumerable:!0,configurable:!0,writable:!0}):t[e]=s,t}class H{constructor(t){V(this,"skipNextNCalls",0),V(this,"minDelay",1e3),V(this,"inProgress",!1),V(this,"wasFirstCall",!1),V(this,"lastTextCount",0),V(this,"lastTagsCount",0),this.editor=t}call(t={}){this.inProgress||(this.skipNextNCalls?this.skipNextNCalls--:(this.inProgress=!0,this.wasFirstCall&&this.needRequest(t)?this.getRecommendations():!this.wasFirstCall&&this.needFirstRequest(t)?(this.wasFirstCall=!0,this.getRecommendations()):this.inProgress=!1))}needFirstRequest({delta:t,draftLoaded:e}){return!!e||(this.getTextCount()>=100||(1===this.getTagsCount()||this.hasFilledMedia(null==t?void 0:t.inserted)))}needRequest({delta:t}){return Math.abs(this.getTextCount()-this.lastTextCount)>=100||(this.getTagsCount()!==this.lastTagsCount||(!!this.hasFilledMedia(null==t?void 0:t.inserted)||this.hasRemovedBlocks(null==t?void 0:t.removed)))}async getRecommendations(){var t,e;this.lastTextCount=this.getTextCount(),this.lastTagsCount=this.getTagsCount();const{requestData:s}=this.editor.getPublishPayload(!0),{response:{result:i},data:n}=await o.cf.post("/ajax/gtstory-actions/get_recommended_tags-and-communities",s),r={action:"get_recommended_tags",title:null===(t=this.editor._title)||void 0===t?void 0:t.value,text:this.editor.blocks.items.filter((t=>t.data.type===T.STORY_BLOCK_TYPE.TEXT)).reduce(((t,e)=>t+(e.data.plainBody||e.data.body||"")),"").replace(m,"#").trim()},{response:a,data:l}=await o.cf.post("/ajax/stories_actions.php",r);a.result&&null!=l&&null!==(e=l.tags)&&void 0!==e&&e.length&&(n.tags=[...l.tags.map((t=>({extra_tag:t}))),...n.tags]),i?this.editor.emit("recommendations-observer-response",n):F.c.getInstance().sendEvent("error_occurred",{type_i8:6}),setTimeout((()=>this.inProgress=!1),this.minDelay)}getTextCount(){return this.editor.getCurrentTextLength().length}getTagsCount(){return this.editor._editorTags.value.split(",").filter((t=>t.trim().length>0)).length}hasFilledMedia(t){const e=[T.STORY_BLOCK_TYPE.IMAGE,T.STORY_BLOCK_TYPE.VIDEO],s=null==t?void 0:t.find((({data:t})=>e.includes(t.type)));return null!=s}hasRemovedBlocks(t){const e=[T.STORY_BLOCK_TYPE.IMAGE,T.STORY_BLOCK_TYPE.VIDEO,T.STORY_BLOCK_TYPE.TEXT],s=null==t?void 0:t.find((({data:t})=>e.includes(t.type)));return null!=s}}var q=s(2630),W=s(8799),G=s(9717),Y=s(747),z=s(6596),Z=s(6099),K=s(3040),X=s(8941),Q=s(9698);function J(t,e){var s=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),s.push.apply(s,i)}return s}function tt(t){for(var e=1;e<arguments.length;e++){var s=null!=arguments[e]?arguments[e]:{};e%2?J(Object(s),!0).forEach((function(e){et(t,e,s[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(s)):J(Object(s)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(s,e))}))}return t}function et(t,e,s){return e in t?Object.defineProperty(t,e,{value:s,enumerable:!0,configurable:!0,writable:!0}):t[e]=s,t}const st=s(6419),it=s(9755);class nt extends n.u1{constructor(t){if(super(t),this.editorId&&this.type===b.NORMAL&&(P.mM.set(l,this.editorId),this._followDuplicationEditor()),this._options.blocks=new O.qg,this.listenTo(this.blocks,O.u$.UPDATE,this._onUpdateBlocks),this._autoUpload=st.debounce(this._uploadImages.bind(this),5e3),this._autoSaveDraft=st.debounce(this._onSaveDraft.bind(this),5e3),this._checkMentions=st.debounce(this._onCheckMentions.bind(this),1e4),i.vE.isUserAuthorized){let t=Boolean(this.minRatingImages)&&this.minRatingImages>i.vE.userRating,e=Boolean(this.minRatingVideo)&&this.minRatingVideo>i.vE.userRating;this.limits.toggle(y.MIN_RATING_IMAGES,t),this.limits.toggle(y.MIN_RATING_VIDEOS,e),this.limits.toggle(y.MIN_RATING,t&&e)}this._form=void 0,this._themeColorPrev=null,this.type===b.NORMAL&&this.listenTo(i.vE.ui,"beforeunload",(t=>{if(!this.isSaved&&!this.marks.has("published")){let e=i.vE.i18n("story-editor.before-exit");return t.returnValue=e,e}})),this._unescapeTitle=Q.o.unescape(),this._bindLockTimeCounter(),this.themeColorNotificationDisabled=!1,this.recommendationObserver=new H(this),this.listenTo(this,"text-changed",this.recommendationObserver.call.bind(this.recommendationObserver)),this.listenTo(this,"recommendations-observer-response",(({communities:t,tags:e})=>{this.toggleRecommendedCommunities(t),this.toggleRecommendedTags(e)})),this._shownHints=new Set}render(){return this.isRendered||(super.render(),this._options.hasBlogsAccess&&this._initBlogsPosting(),this._initCommunityHeaderClose()),this}toggleRecommendedTags(t){var e;null===(e=this._editorTags)||void 0===e||e.showRecommendations(t)}toggleRecommendedCommunities(t){var e;null===(e=this._editorCommunities)||void 0===e||e.showRecommendations(t)}_bindLockTimeCounter(){it(".locktime-counter").each(((t,e)=>{let s=it(e);new B({el:s,onSuccess:()=>{s.parent(".story-editor-message").first().hide()}})}))}_updateBlockPosition(){st.forEach(this.$els.blocksInner.children(),((t,e)=>{const s=this.getBlockFromEl(t);s&&(s.data.at=e)})),this.blocks.sort(((t,e)=>t.data.at-e.data.at))}_initCommunityHeaderClose(){const t=this.el.querySelector(".story-editor__communities-header");if(!(t instanceof HTMLElement))return;const e=this.el.querySelector(".story-editor__communities-header-close");null==e||e.addEventListener("click",(()=>{(new K.U).set("isStoryEditorComValueHidden",!0),t.remove()}))}addBlock(t,e,s,i){switch(t instanceof f.Tf&&(t={type:t}),i&&st.extend(t,{isDisabledDeleteConfirm:!0,isDisabledLeaveLink:!1}),e&&st.extend(t,{insertBetween:e,insertionDirection:s}),t.type){case T.STORY_BLOCK_TYPE.TEXT:this.handleUserAction(C.oY.ADD_TEXT);break;case T.STORY_BLOCK_TYPE.IMAGE:this.handleUserAction(C.oY.ADD_IMAGE);break;case T.STORY_BLOCK_TYPE.VIDEO:this.handleUserAction(C.oY.ADD_VIDEO)}return this.blocks.add(t),this}handleUserAction(t){this.type===b.NORMAL&&F.c.getInstance().sendEvent((0,L.i)(C.oY,t),{draft_id:this.draftId})}addBlankTextBlock(t){this.blocks.size>0&&!t||this.addBlock(T.STORY_BLOCK_TYPE.TEXT)}_onUpdateBlocks(t,e){let s=this.countBlocks;this.maxImages&&this.limits.toggle(y.MAX_IMAGES,s.images>=this.maxImages),this.maxVideos&&this.limits.toggle(y.MAX_VIDEOS,s.video>=this.maxVideos),this.maxMedia&&this.limits.toggle(y.MAX_MEDIA,s.media>=this.maxMedia),this.maxBlocks&&this.limits.toggle(y.MAX_BLOCKS,s.blocks>=this.maxBlocks),this._autoSaveDraft(),this._updateBlockPosition(),this.checkShortStory(),this.recommendationObserver.call({delta:e})}_resetEditor(t={}){const{animated:e,addBlankTextBlock:s,focusTitleInput:i}=t;if(this.toggleRecommendedTags([]),this.toggleRecommendedCommunities([]),this.recommendationObserver.skipNextNCalls++,this._editorTags.clear(),this._title.value="",this.blocks.items.length>0){for(let t of this.blocks.items)t.destroy(!0,e);this.blocks._options.items=[]}this.currentPreview=!1,this._editorExtra.uncheckAll(),this.community=!1,this.communityMode=w.OFF,this.recommendationObserver.skipNextNCalls++,s&&this.addBlankTextBlock(!0),this._similarStories.state=S.DX.EMPTY,i&&setTimeout((()=>{this._title.$els.input.focus()}),10)}addImageBlock(t,e,s,n=!1){if(this.limits.hasSome(y.MIN_RATING_IMAGES,y.MAX_IMAGES,y.MAX_MEDIA))return this;let o=this.countBlocks,r=Math.min(...st.compact([this.maxBlocks-o.blocks,this.maxImages-o.image,this.maxMedia-o.media])),a=!1,l=!1;return st.isFinite(r)&&r<1||((t=st.isArray(t)?t:[t]).filter((t=>t instanceof Blob?D.HP.test(t.type)?this.limitImageBytes&&t.size&&t.size>this.limitImageBytes?(l=!0,!1):!!this._filterDuplicateFile(t)||(i.vE.ui.toasts.showError("story-editor.errors.image-exist"),!1):(a=!0,!1):st.isString(t)?!x.j.instance.has(t):(i.vE.logger.warn("story-editor","input file is bad"),!1))).slice(0,st.isFinite(r)?r:void 0).forEach((t=>{this.addBlock({type:T.STORY_BLOCK_TYPE.IMAGE,source:t},e,s,n)})),a&&this._updateError(E.FILE_MIME),l&&this._updateError(E.FILE_SIZE)),this}addVideoBlock(t,e,s,n=!1){if(this.limits.hasSome(y.MIN_RATING_VIDEOS,y.MAX_VIDEOS,y.MAX_MEDIA))return this;let o=this.countBlocks,r=Math.min(...st.compact([this.maxBlocks-o.blocks,this.maxImages-o.image,this.maxMedia-o.media]));return st.isFinite(r)&&r<1||(t=st.isArray(t)?t:[t]).filter((t=>{if(!t.url)throw new Error("bad url in video input",t);if(!x.j.instance.has(t.url))return x.j.instance.add(t.url),!0;i.vE.ui.toasts.showError("story-editor.errors.video-exist")})).slice(0,st.isFinite(r)?r:void 0).forEach((t=>{this.addBlock({type:T.STORY_BLOCK_TYPE.VIDEO,duration:t.duration,host:t.host,ratio:t.ratio,url_preview:t.thumb,url:t.url},e,s,n)})),this}async addVideoFile(t,e,s){if(this.limits.hasSome(y.MIN_RATING_VIDEOS,y.MAX_VIDEOS,y.MAX_MEDIA)||!this.isVideoFileEnabled)return this;let i=this.countBlocks,n=Math.min(...st.compact([this.maxBlocks-i.blocks,this.maxImages-i.image,this.maxMedia-i.media]));return st.isFinite(n)&&n<1?this:this.limitVideoBytes&&t.size>this.limitVideoBytes?(this._updateError(E.VIDEO_FILE_SIZE),this):(this._addVideoFile(t,await this._getVideoFileInformationFromFile(t),e,s),this)}_addVideoFile(t,e,s,i){this.addBlock({type:T.STORY_BLOCK_TYPE.VIDEO_UPLOAD,info:e,file:t},s,i)}_getVideoFileInformationFromFile(t){return new Promise((e=>{if(window.URL&&window.URL.prototype){let s=document.createElement("video");s.src=URL.createObjectURL(t);let i=()=>{URL.revokeObjectURL(s.src),s.remove(),it(s).off()};it(s).on({error:()=>{e(void 0),i()},loadedmetadata:()=>{let t=s.videoWidth,n=s.videoHeight,o=Number(s.duration),r=t/n;return it(s).off(),o<this.limitVideoInputMinDuration?(this._updateError(E.VIDEO_MIN_DURATION),i()):o>this.limitVideoInputMaxDuration?(this._updateError(E.VIDEO_MAX_DURATION),i()):r<this.limitVideoMinRatio||r>this.limitVideoMaxRatio?(this._updateError(E.VIDEO_MIN_RATIO),i()):t<this.limitVideoMinWidth?(this._updateError(E.VIDEO_MIN_WIDTH),i()):n<this.limitVideoMinHeight?(this._updateError(E.VIDEO_MIN_HEIGHT),i()):void e({video:s,duration:o,width:t,height:n,ratio:r})}}),s.load()}else e(void 0)}))}_filterDuplicateFile(t){for(let e of this.blocks.items){if(e.data.type!==T.STORY_BLOCK_TYPE.IMAGE)continue;let s=e.data.source;if(s&&s instanceof File&&s.name===t.name&&s.size===t.size&&s.type===t.type)return!1}return!0}async _uploadImages(){let t=!0;for(let e of this.blocks.items)e.data.type!==T.STORY_BLOCK_TYPE.IMAGE||e.isUploaded||await e.upload()||(t=!1);return t}_followDuplicationEditor(){return it(window).on("storage",(t=>{let e;(t=t.originalEvent).newValue&&(e=t.newValue.replace(/['"]+/g,"")),t.key===l&&e!==this.editorId&&(this.isLocked=!0)})),this.interval("follow-duplication",15e3,(async()=>{let{response:t,data:e}=await o.cf.get("/ajax/gtpost_actions.php",{action:"get_last_page_id"});t.result&&e.id!==this.editorId&&(this.isLocked=!0)})),this}async _addComstoryImages(){try{let t=await r.c.getImages();this.addImageBlock(t)}catch(t){i.vE.logger.warn("comstory","ошибка при добавлении изображений"),i.vE.ui.toasts.showError()}finally{await r.c.cleanImages()}}async onTitleChange(t){if(this.isEditable)return;this.parentStoryId||this._title.updateTitleValidationRules(!1),t||(this.parentStoryId=void 0);const e=x.j.extractStoryURL(t).shift();if(!e)return void(await this._checkMentions());this._title.progress=!0;const s=await r.c.getInheritablePropsByUrl(e);if(!s)return void(this._title.progress=!1);s.title=this._unescapeTitle(s.title);const i=tt(tt({},this._form.serialize()),s);this.deserialize(i),this._title.updateTitleValidationRules(!0),this._title.progress=!1,this._title.setCustomValidity()}_stopFollowDuplicationEditor(){return it(window).off("storage"),this.cancelInterval("follow-duplication"),this}serializeBlocks(t=!1){return this.blocks.items.filter((t=>t.canSerialize())).map((e=>e.serialize(t)))}serialize(t=!1){let e=tt({},this._form.serialize());return["desc","video-url","community-search"].forEach((t=>delete e[t])),e.story_id=this.storyId,e.title=this._title.textContent.trim(),this.community&&(e.community=this.community.id,e.community_data=this.community,e.is_community=!0),this.parentStoryId&&(e.parent_story_id=this.parentStoryId),e.color_theme=this._isShortStory()?this._isShortStoryEnabled()?this._themeColorPrev:0:null,delete e["enable-short-story"],e.blocks=this.serializeBlocks(t),e}async deserialize(t){if(t.scheduled_time&&this._scheduledStorySettings&&this._scheduledStorySettings.updateSettings(t.scheduled_time),this._form.deserialize(t),t.community?this.community=st.isString(t.community_data)?JSON.parse(t.community_data):t.community_data:this.community=!1,t.parent_story_id&&(this.parentStoryId=t.parent_story_id),this.isEditable&&this.parentStoryId&&this._title.toggleClearButton(!1),st.isArray(t.blocks)){let e=[];for(let s of t.blocks)T.STORY_BLOCK_TYPE[s.type]===T.STORY_BLOCK_TYPE.VIDEO_FILE&&void 0===s.info&&(s.info=await a.tv.getVideoFileDetails(Number(s.fid))),e.push(Object.assign({},s));this.blocks.add(e)}this.blocks.size||this.addBlankTextBlock();const e=t.color_theme,s=null===e?1:e,i=0!==e,{colors:n,switch:o}=this.$els.themeColor;o.prop("checked",i).change(),i?n.find(`input[value="${s}"]`).prop("checked",!0).change():n.find("input:checked").prop("checked",!1).change(),this._addComstoryImages(),this._options.hasBlogsAccess&&this._setBlogPostingMode(t.is_advert_blogs)}async checkValidity(t){const e=null==t?void 0:t.returnErrorType,s=tt({scrollToElement:!0},t),i=await this._form.checkValidity(s);return i&&!1!==(null==i?void 0:i.isValid)?this.blocks.size?this.checkLengthTextBlocks()?!this.blocks.items.some((t=>t.data.type===T.STORY_BLOCK_TYPE.IMAGE&&!t.data.url))||(this._updateError(E.UPLOAD_NOT_ALL,!0),this._preparedFalseReply(e,C.tQ[C.A2.ERROR_IMAGE_INCORRECT])):this._preparedFalseReply(e,C.tQ[C.A2.ERROR_TEXT_BLOCK_LENGTH]):(this._updateError(E.BLOCKS_MISSING,!0),this._preparedFalseReply(e,C.tQ[C.A2.ERROR_BLOCKS_MIN])):i}_preparedFalseReply(t,e){return!!t&&{isValid:!1,analyticsType:e}}checkLengthTextBlocks(t){let e;if(!this.maxTextLength)return!0;if(!st.isNumber(t)){const s=this.getCurrentTextLength();e=s.blocks,t=s.length}if(!t&&e&&this.blocks.items.length===e.length)return this._updateError(E.BLOCKS_MISSING),!1;let s=t<=this.maxTextLength;return this._updateError(E.TEXT_LENGTH,!s,t),s}getCurrentTextLength(){const t=this.blocks.items.filter((t=>t.data.type===T.STORY_BLOCK_TYPE.TEXT)),e=t.reduce(((t,e)=>e.data.plainBody||e.data.body?t+(e.data.plainBody||e.data.body).length:t),0);return{blocks:t,length:e}}checkShortStory(){const t=this._isShortStory();this._updateThemeColor(t),this.toggleThemeColorNotification(t)}_isShortStory(){var t,e;const s=this.blocks.items;if(!(1===s.length&&s[0].data.type===T.STORY_BLOCK_TYPE.TEXT))return!1;const i=s.reduce((({html:t,text:e},s)=>({html:t+=s.data.body||"",text:e+=s.data.plainBody||""})),{html:"",text:""});if((null!==(t=i.html.match(/<p>|<br>/gi))&&void 0!==t?t:[]).length-1-(null!==(e=i.html.match(/<br><\/p>/gi))&&void 0!==e?e:[]).length>2)return!1;const n=i.text.replace(m,"#").replace(/\s+/g," ").trim();return n.length>0&&n.length<=320}_isShortStoryEnabled(){const{colors:t,switch:e}=this.$els.themeColor;return e.is(":checked")&&t.find("input:checked").length>0}_updateThemeColor(t){const e=t&&this._isShortStoryEnabled()?Number(this.$els.themeColor.colors.find("input:checked").val()):0,s=this._themeColorPrev;if(e!==s){if(this._themeColorPrev=e,this._themeColorHint){const t=this._themeColorHint.content.find(".story-editor__theme-notification-hint-img");s&&t.removeClass(`theme_${s}`),e&&t.addClass(`theme_${e}`)}!i.vE.isMobileApp&&this.currentPreview&&this.preview()}}toggleThemeColorNotification(t){this.$els.themeColor.notification.toggle(t)}_initThemeColor(){var t;const{switch:e,colors:s,hintInfo:n}=this.$els.themeColor;this._themeColorHint=new W.gR({target:n,content:'<div class="story-editor__theme-notification-hint">\n    <p class="story-editor__theme-notification-hint-text">Ваш текст будет отображаться поверх специального фона. Воспользуйтесь предпросмотром, чтобы увидеть пост в полном размере</p>\n    <div class="story-editor__theme-notification-hint-img">\n        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon--ui__bg-story-short"><use xlink:href="#icon--ui__bg-story-short"></use></svg>\n        <span>Вспомнил как в молодости смотрел сериал, про марс. Суть сериала была в том, что люди создали портал который мог их переправить на марс. Для создания колонии. Сначала вроде как отправили взрослых. А потом детей. Произошла какая то ошибка, и взрослые пропали в портале, а дети прибыли на марс. И пытались весь сериал вернуть родителей из портала. Сериал 90 годов</span>\n    </div>\n</div>',destroyAfterHide:!1,direction:i.vE.isMobileApp?W.Lh.TOP:W.Lh.RIGHT,delay:200}),e.on("change",(()=>{const t=e.is(":checked");s.toggleClass("story-editor__theme-notification-radio-group_opened",t),t&&!s.find("input:checked").length&&s.find('input[value="1"]').click(),this._updateThemeColor(t&&this._isShortStory())})),this.listenTo(this._form,"change",(()=>this._updateThemeColor(this._isShortStory()))),null===(t=s[0])||void 0===t||t.addEventListener("click",(t=>{const e=t.target.classList;e.contains("radio")&&e.contains("radio_checked")&&t.stopPropagation()}),!0)}async _onSaveDraft(){this.type!==b.NORMAL||this.isLocked||this.marks.has("publish")||this.isSaved||this.saveDraft()}_onCheckMentions(){const{tags:t,title:e,blocks:s}=this.serialize(),i=[t,e,...s.map((t=>t.body))].join();this._feedbackOffer.checkMentions(i)}async saveDraft(){const t=this._isEditorContentEmpty;if(t&&!this.lastDraft)return;const e=this.draftId;if(t)e&&(await R.c.deleteDraft(e),this.lastDraft=null,this.draftsCount--);else{const t=this.serialize(!0);let i;this._options.lastDraftSave=Date.now(),t.time=nt.getDraftTime();try{const s=await R.c.saveDraft(t,e);i=tt({id:s},t),P.mM.remove(p),e!==s&&this.draftsCount++}catch(s){i=tt({id:e},t),P.mM.set(p,i)}this.lastDraft=i}}async loadDraft(t){return this.lastDraft=t,this._setCheckboxMine(),await this.deserialize(this.lastDraft),this.recommendationObserver.call({draftLoaded:Boolean(t)}),this._title.updateTitleValidationRules(Boolean(this.lastDraft.parent_story_id)),this}_setCheckboxMine(){var t,e,s,i;const n=this.lastDraft&&!(null!==(t=this.lastDraft.blocks)&&void 0!==t&&t.length)&&!(null!==(e=this.lastDraft.tags)&&void 0!==e&&e.length)&&!(null!==(s=this.lastDraft.title)&&void 0!==s&&s.length)&&!this.lastDraft.is_adult&&!this.lastDraft.is_anonymous_story&&!this.lastDraft.is_community,o=null===(i=this._form.getUIElement("is_author_content"))||void 0===i?void 0:i.checked;n&&o&&(this.lastDraft.is_authors=!0)}async preview(){if(!(await this._uploadImages())||!(await this.checkValidity()))return!1;let{response:t,data:e}=await o.cf.post("/preview.php",{f:"json",type:"story",data:JSON.stringify(this.serialize())});if(t.result)this.currentPreview=e.html;else{let s=null==t?void 0:t.message;t.status||(s=i.vE.i18n("story-editor.errors.bad-network"),this.sendOnErrorAnalytics(C.tQ[[C.A2.ERROR_COMMON_BAD_NETWORK]])),this._updateError(E.BACKEND_PREVIEW,!0,s),this.currentPreview=!1,null!=e&&e.code&&t.status&&this.sendOnErrorAnalytics(C.tQ[e.code])}return!0}async publish(){if(!(await this._uploadImages()))return this.sendOnErrorAnalytics(C.tQ[C.A2.ERROR_IMAGE_NOT_UPLOADED]),!1;const t=await this.checkValidity({returnErrorType:!0});if(this._isNotValid(t))return this.sendOnErrorAnalytics(t.analyticsType),!1;const{requestData:e,serializedData:s}=this.getPublishPayload();let{response:n,data:r}=await o.cf.post("/ajax/gtpost_actions.php",e);if(!n.result){let t=st.reduce(st.isArray(n.message)?n.message:[n.message],((t,e)=>t+e+" "),"");return n.status||(t=i.vE.i18n("story-editor.errors.bad-network"),this.sendOnErrorAnalytics(C.tQ[[C.A2.ERROR_COMMON_BAD_NETWORK]])),this._updateError(E.BACKEND_PUBLISH,!0,t),null!=r&&r.code&&n.status&&this.sendOnErrorAnalytics(C.tQ[r.code]),!1}return"function"!=typeof parent.__setStoryData?r:(parent.__setStoryData(s),!0)}sendOnErrorAnalytics(t){F.c.getInstance().sendEvent("error_occurred",{type_i8:7,type:t})}_isNotValid(t){return st.isBoolean(t)&&!t||st.isBoolean(null==t?void 0:t.isValid)&&!(null!=t&&t.isValid)}static getDraftTime(){return Math.floor(Date.now()/1e3)}getPublishPayload(t=this.type!==b.NORMAL){const e=this.serialize(t),s={action:"publish",time:Date.now().toString().substring(0,10),parent_story_id:e.parent_story_id};this.type===b.AB&&(s.author_id=this._options.authorId),this.type!==b.NORMAL&&(s.save_mode=this.type.toString().toLowerCase(),s.action="validate",s.save_target_id=this.saveTargetId),s.data=JSON.stringify(e),this.storyId&&(s.story_id=this.storyId),this.draftId&&(s.draft_id=this.draftId);const n=i.vE.config("modules.story-editor.schedule_id");return n&&(s.schedule_id=n),{requestData:s,serializedData:e}}_updateLocked(t){}_updateError(t,e=!0,s){}_updateCommunityMode(t){}_updateCommunity(t){}_updatePreview(t){}_updateParentStoryIdState(t){this._title.isFixedValue=t}async _showHint(t,e=!1){if(this._shownHints.has(t.id))return;const s=tt({theme:W.xb.GREEN,overlapSidebars:!1,direction:W.Lh.TOP,alignment:W.SE.CENTER,autoCloseIfTargetNotVisible:!0,autoCloseOutsideClick:!0,delay:500,delayClose:500,hideByScroll:!1},t),i=e?await(0,q.bu)(s):await(0,q.kd)(s);return null==i||i.addCloseButtonIntoFooter("Понятно"),this._shownHints.add(t.id),i}_showAuthorContentNotification(){(0,q.kd)({id:"author-content",target:it(".author-content label .checkbox"),text:'Вы получили возможность выделить свой пост при помощи специального оформления. \n\t\t\t\t\tТакая функция доступна всего нескольким уникальным авторам на Пикабу,\n\t\t\t\t\tблагодаря чему ваш пост будет особенно заметен в ленте. Также рядом с вашим ником появится\n\t\t\t\t\t кнопка "Подписаться", что обеспечит вам дополнительный приток подписчиков на Пикабу.',theme:W.xb.GREEN,buttonType:G.JB.GRAY,label:"Понятно",overlapSidebars:!1,direction:W.Lh.TOP,alignment:W.SE.CENTER,autoCloseIfTargetNotVisible:!0,autoCloseOutsideClick:!0,delay:500,delayClose:500,hideByScroll:!1,leftPosition:i.vE.isMobileApp?"16px":"",wrapperExtraClass:"popup_feature-notification author-content"})}_initBlogsPosting(){if(!this._options.hasBlogsAccess)return;const t=this._form.getUIElement("is_advert_blogs");t&&(this._setBlogPostingMode(t.checked),this.listenTo(this._form,"change",(async(e,s)=>{if(s!==t)return;const i=(0,Y.m)('<div class="story-editor__loading-overlay">\n    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon--ui__progress-circle icon--ui__progress-circle_story-editor"><use xlink:href="#icon--ui__progress-circle"></use></svg>\n</div>\n');this.el.appendChild(i),await P.cQ.delay(200),this.el.removeChild(i),this._setBlogPostingMode(s.checked)})))}async _setBlogPostingMode(t){var e;((t=Boolean(t))&&this.community&&(this.community=!1),this.$els.community.toggle(!t),["is_donations_disabled","is_authors","is_anonymous_story","is_adult"].forEach((e=>{var s;t&&(null===(s=this._form.getUIElement(e))||void 0===s||s.setChecked(!1));this.$els.meta.find(`[data-field="${e}"]`).toggle(!t)})),this.$els.meta.find('[data-field="is_comments_disabled"]').toggle(t),t)||(null===(e=this._form.getUIElement("is_comments_disabled"))||void 0===e||e.setChecked(!1))}async _onSubmit(t){var e;if(null==t||t.preventDefault(),this._submitButton.animation)return;if(!i.vE.initParams.isConfirmed&&!(await(new Z.R).show(Z.J.STORY)))return;i.vE.isDesktopApp&&(this._forceUpdateTextBlocks(),this._editorTags.runCallbackOnBlur()),this.marks.set("publish",Date.now()),this._submitButton.animation=!0;const s=await this.publish();if(await P.cQ.delay(300-(Date.now()-this.marks.get("publish"))),this.marks.delete("publish"),this._submitButton.animation=!1,s){if(this.marks.set("published",!0),"object"==typeof s)if(null!==(e=this._scheduledStorySettings)&&void 0!==e&&e.isChecked){var n;i.vE.config("modules.story-editor.schedule_id")||F.c.getInstance().sendEvent("posting_schedule",{draft_id:this.draftId,scheduled_date:null===(n=this._scheduledStorySettings)||void 0===n?void 0:n.value}),i.vE.history.redirect(`/@${i.vE.initParams.userName}#scheduled-story-alert`)}else{if(!this.isEditable){const t=await z.K.getInstance().getScore("publish_post"),e=s.story_id;return F.c.getInstance().sendEvent("publish_post",{draft_id:this.draftId,post_id:e,rec_score:t}),i.vE.history.replaceState({storyPublishedId:e},document.title,s.redirect_url),void i.vE.location.reload()}i.vE.history.redirect(s.redirect_url)}}else this._autoSaveDraft()}_initScheduledStorySettings(){const t=this.el.querySelector(".scheduled-story-settings");t&&(this._scheduledStorySettings=new X.C({el:t}))}get currentPreview(){return this._options.currentPreview}set currentPreview(t){this._options.currentPreview!==t&&(this._options.currentPreview=t,this._updatePreview(t))}get community(){return this._options.community}set community(t){this._options.community!==t&&(this._options.community=t,this.communityMode=t?w.SELECTED:w.OFF,this._updateCommunity(t))}get type(){return this._options.type||b.NORMAL}set type(t){let e=this._options.type;(t=b[t])&&t!==e&&(this._options.type=t)}get draftsCount(){return this._options.draftsCount}set draftsCount(t){const{draftsCountValue:e,draftsCount:s}=this.$els;e&&s&&(e.textContent=t,this._options.draftsCount=t,s.classList.toggle("story-drafts-count_limit",t>=this._options.draftsLimit),0===t&&(s.style.display="none"))}initDrafts(t){if(this.type!==b.NORMAL||this.storyId)return;let e=!1;if(t)this.loadDraft(t),e=!0;else{const t=P.mM.get(p);t&&(this.deserialize(t),e=!0)}if(this.$els.draftsCount){var s;let{count:t,limit:i}=this.$els.draftsCount.dataset;t=Number(t),i=Number(i),this._options.draftsCount=t,this._options.draftsLimit=i,null===(s=this.$els.draftsCount)||void 0===s||s.addEventListener("click",(()=>this._showSelectDraftPopup())),t>=i&&!e&&this._showSelectDraftPopup(!0)}}_showSelectDraftPopup(t){var e;if(null!==(e=this._draftSelectPopup)&&void 0!==e&&e.isShown)return;const s=this._createDraftsPopup();this._draftSelectPopup=s,s.show({onDeleteDraft:async t=>{await this._showDeleteDraftConfirmation(t)&&(R.c.deleteDraft(t),t===this.draftId&&(this._resetEditor({addBlankTextBlock:!0}),this.lastDraft=null),this.draftsCount--,this.draftsCount<=0?s.close():s.deleteItem(t),F.c.getInstance().sendEvent("delete_draft_post",{draft_id:t,type:"drafts_popup"}))},onSelectDraft:async(t,e)=>{this._resetEditor();const i=this._lockEditor();s.close();try{const[{draft:e}]=await Promise.all([R.c.getById(t),P.cQ.delay(300)]);this.loadDraft(tt({id:t},e))}finally{i()}F.c.getInstance().sendEvent("draft_post_choose",{draft_id:t,size:this._options.draftsCount,screen_index:e+1})},draftsCount:this._options.draftsCount,draftsLimit:this._options.draftsLimit,isCloseLocked:t})}_showDeleteDraftConfirmation(){return U.nk.confirmModal({content:"Вы действительно хотите удалить черновик?",buttons:[["modal.remove",j.j.DANGER,!0],["modal.cancel"]]})}_createDraftsPopup(){}get lastDraft(){return this._options.lastDraft}set lastDraft(t){let e=this._options.lastDraft;st.isObject(t)&&delete t.time,st.isEqual(e,t)||(t&&(t.tags&&("string"==typeof t.tags?t.tags=t.tags.split(", ").join(","):Array.isArray(t.tags)&&(t.tags=t.tags.join(","))),t.community?st.isString(t.community_data)&&(t.community_data=JSON.parse(t.community_data)):(delete t.community,delete t.community_data)),this._options.lastDraft=t)}get draftId(){var t,e;return null!==(t=null===(e=this.lastDraft)||void 0===e?void 0:e.id)&&void 0!==t?t:0}get _isEditorContentEmpty(){return!this._title.value&&0===this.blocks.items.filter((t=>t.canSerialize())).length}get isSaved(){var t;if(this.storyId)return!0;if(this._isEditorContentEmpty)return!this.lastDraft;const e=Object.fromEntries(Object.entries(null!==(t=this.lastDraft)&&void 0!==t?t:{}).filter((([t,e])=>"id"!==t&&Boolean(e)))),s=Object.fromEntries(Object.entries(this.serialize(!0)).filter((([t,e])=>Boolean(e))));return st.isEqual(e,s)}get blocks(){return this._options.blocks}get limits(){let t=this._options.limits;return t||(t=this._options.limits=new A.F),t}get storyId(){return this._options.storyId}set storyId(t){this._options.storyId===(t="number"==typeof t?t:parseInt(t,10))||isNaN(t)||(this._options.storyId=t)}get saveTargetId(){return this._options.saveTargetId}set saveTargetId(t){this._options.saveTargetId!==(t="number"==typeof t?t:parseInt(t,10))&&(this._options.saveTargetId=t)}get parentStoryId(){return this._options.parentStoryId}set parentStoryId(t){this._options.parentStoryId!==(t="number"==typeof t?t:parseInt(t,10))&&(this._options.parentStoryId=t,this._updateParentStoryIdState(Boolean(t)))}get editorId(){return this._options.editorId}set editorId(t){this._options.editorId!==t&&(this._options.editorId=t)}get isEditable(){return this.storyId>0}get isLocked(){return this._options.isLocked}set isLocked(t){this._options.isLocked!==(t=Boolean(t))&&(this._options.isLocked=t,this._updateLocked(t),t?(i.vE.logger.log("story-editor","locked"),this._stopFollowDuplicationEditor()):this._followDuplicationEditor())}get maxImages(){return this._options.maxImages}set maxImages(t){let e=this._options.maxImages;t="number"==typeof t?t:parseInt(t,10),st.isNaN(t)||t<0||e===t||(this._options.maxImages=t)}get maxVideos(){return this._options.maxVideos}set maxVideos(t){let e=this._options.maxVideos;t="number"==typeof t?t:parseInt(t,10),st.isNaN(t)||t<0||e===t||(this._options.maxVideos=t)}get maxMedia(){return this._options.maxMedia}set maxMedia(t){let e=this._options.maxMedia;t="number"==typeof t?t:parseInt(t,10),st.isNaN(t)||t<0||e===t||(this._options.maxMedia=t)}get maxBlocks(){return this._options.maxBlocks}set maxBlocks(t){let e=this._options.maxBlocks;t="number"==typeof t?t:parseInt(t,10),st.isNaN(t)||t<0||e===t||(this._options.maxBlocks=t)}get minRatingImages(){return this._options.minRatingImages}set minRatingImages(t){let e=this._options.minRatingImages;t="number"==typeof t?t:parseInt(t,10),st.isNaN(t)||e===t||(this._options.minRatingImages=t)}get minRatingVideo(){return this._options.minRatingVideo}set minRatingVideo(t){let e=this._options.minRatingVideo;t="number"==typeof t?t:parseInt(t,10),st.isNaN(t)||e===t||(this._options.minRatingVideo=t)}get minTitleLength(){return this._options.minTitleLength}get maxTitleLength(){return this._options.maxTitleLength}get maxTextLength(){return this._options.maxTextLength}set maxTextLength(t){let e=this._options.maxTextLength;t="number"==typeof t?t:parseInt(t,10),st.isNaN(t)||t<0||e===t||(this._options.maxTextLength=t)}get limitImageBytes(){return this._options.limitImageBytes}set limitImageBytes(t){let e=this._options.limitImageBytes;t="number"==typeof t?t:parseInt(t,10),st.isNaN(t)||e===t||(this._options.limitImageBytes=t)}get isVideoFileEnabled(){return this._options.isVideoFileEnabled}get limitVideoBytes(){return this._options.limitVideoBytes}get limitVideoMinWidth(){return this._options.limitVideoMinWidth}get limitVideoMinHeight(){return this._options.limitVideoMinHeight}get limitVideoInputMinDuration(){return this._options.limitVideoInputMinDuration}get limitVideoOutputMaxDuration(){return this._options.limitVideoOutputMaxDuration}get limitVideoInputMaxDuration(){return this._options.limitVideoInputMaxDuration}get limitVideoMinRatio(){return this._options.limitVideoMinRatio}get limitVideoMaxRatio(){return this._options.limitVideoMaxRatio}get countBlocks(){return this.blocks.items.reduce(((t,e)=>(e.data.type!==T.STORY_BLOCK_TYPE.VIDEO&&e.data.type!==T.STORY_BLOCK_TYPE.IMAGE||(t[e.data.type.valueOf()]++,t.media++),t)),{video:0,image:0,media:0,blocks:this.blocks.size})}get communityMode(){return this._options.communityMode||w.OFF}set communityMode(t){let e=this._options.communityMode;(t=w[t])&&t!==e&&(this._options.communityMode=t,this._updateCommunityMode(t))}get isUserModerator(){return this._options.isUserModerator}set isUserModerator(t){this._options.isUserModerator=Boolean(t)}get tagsExist(){var t;return Boolean(null===(t=this._editorTags)||void 0===t?void 0:t.exists)}get tags(){var t;return(null===(t=this._editorTags)||void 0===t?void 0:t.value)||""}}class ot extends n.u1{constructor(t){super(t)}_updateLimits(t){}get editor(){return this._options.editor}set editor(t){this._options.editor!==t&&(this._options.editor=t,this.listenTo(this.editor.limits,"update",this._updateLimits))}get block(){return this._options.block}set block(t){this._options.block!==t&&(this._options.block=t)}}s(4440);var rt=s(6777);class at extends rt.vp{constructor(t){super(),this.editor=t;const e=this.editor.el.querySelector('[data-role="meta"]');if(!e)return this.blockExists=!1,this.el=null,void(this.els={checkboxAuthorContent:null,checkboxMine:null,checkboxNsfw:null,checkboxCommunity:null,checkboxScheduledStory:null});this.blockExists=!0,this.el=e,this.els={checkboxAuthorContent:this.el.querySelector('input[name="is_author_content"]'),checkboxMine:this.el.querySelector('input[name="is_authors"]'),checkboxNsfw:this.el.querySelector('input[name="is_adult"]'),checkboxCommunity:this.el.querySelector('input[name="is_community"]'),checkboxScheduledStory:this.el.querySelector('input[name="scheduled_time"]')};const{checkboxMine:s,checkboxNsfw:i,checkboxCommunity:n,checkboxAuthorContent:o}=this.els;null==o||o.addEventListener("change",(()=>{var t;if(!(o.checked||null!==(t=this.els.checkboxMine)&&void 0!==t&&t.checked))return;this.editor._form.getUIElement("is_authors").checked=!0})),null==s||s.addEventListener("change",(()=>{s.checked&&this.editor.handleUserAction(C.oY.MARK_MINE)})),null==i||i.addEventListener("change",(()=>{i.checked&&this.editor.handleUserAction(C.oY.MARK_NSFW)})),null==n||n.addEventListener("change",(()=>{n.checked&&this.editor.handleUserAction(C.oY.MARK_COMMUNITY)}))}isSomeChecked(){if(!this.blockExists)return!1;for(const t of Object.values(this.els))if(null!=t&&t.checked)return!0;return!1}uncheckAll(t=!1){if(!this.blockExists)return;const e=new Event("change");for(const s of Object.values(this.els))s&&"checked"in s&&(s.checked=!1,t||s.dispatchEvent(e))}listenCheckboxCommunityChange(){if(!this.blockExists)return;const t=this.editor._form.getUIElement("is_community");t&&this.listenTo(t,"change",(e=>{(this.editor.communityMode!==w.SELECTED||t.checked)&&(this.editor.communityMode=e?w.CHOICE:w.OFF)}))}toggleCommunityChecked(t,e,s){if(!this.blockExists)return;const i=this.editor._form.getUIElement("is_community");i&&i.toggleChecked(t,e,s)}}s(8044)},6553:(t,e,s)=>{"use strict";s.r(e),s.d(e,{BEST_STORY_HINT_SHOWN:()=>O,BLOG_STORY_READ_TIMEOUT:()=>g,BLOG_STORY_VIEW_TIMEOUT:()=>_,CONTENT_VIEWED_FOCUS_HEIGHT:()=>k,COOKIE_FOR_BEST_STORY_SHOWN_IDS:()=>C,DESIRED_MIN_COUNT_TAGS:()=>S,MAX_IDS_IN_BESTV_COOKIE:()=>T,MAX_VISIBLE_TAGS_ROWS:()=>w,MORE_BUTTON_WIDTH_WITH_MARGINS:()=>E,READING_LEVEL:()=>h,SHORT_CONTENT_TYPES:()=>f,STORY_AD_SHORT_VIEWED_TIMEOUT:()=>p,STORY_AD_VIEWED_TIMEOUT:()=>u,STORY_BLOCK_TYPE:()=>a,STORY_HEIGHT_DELTA:()=>c,STORY_SLICE_TYPE:()=>r,STORY_TYPE:()=>l,STORY_VIEWED_TIMEOUT:()=>d,STORY_VISITED_TIMEOUT:()=>m,STORY_VOTE:()=>o,Story:()=>tt,TAGS_MASK_MAP:()=>v,VIEWPORT_LIMIT:()=>y,VIEWPORT_START:()=>b,storyStyle:()=>A.B});s(6992),s(3948),s(8674),s(4916),s(285),s(1637);var i=s(8211),n=s(7892);const o=new n.xs({UP:1,NONE:0,DOWN:-1}),r=new n.xs({NONE:0,BY_BLOCK:1,BY_HEIGHT:2}),a=new n.xs({TEXT:"text",IMAGE:"image",VIDEO:"video",VIDEO_INPUT:"video-input",VIDEO_UPLOAD:"video-upload",VIDEO_FILE:"video_file"}),l=new n.xs({LINK:1,TEXT:2,IMAGE:4,VIDEO:8,TGP:16,CUSTOM_HTML:32}),h=new n.xs({NOT_READ:0,BEGIN_READING:1,HALF_READING:2,FULL_READING:3}),c=200,d=.1,u=1,p=3,m=.1,_=.1,g=3,v=[{name:"[моё]",value:1},{name:"NSFW",value:2},{name:"Негатив",value:4},{name:"Политика",value:8}],f={video:"v",videofile:"vf",text:"t",gif:"g",image:"i"},y=.5,b=150,w=1,E=28,S=3,C="bestv",T=10,O="bestvs",k=225;var I=s(2134),$=s(3680),A=s(3227),x=s(1490),D=s(2822),P=s(7320),R=s(6572),M=s(5661),N=s(9050);class B{constructor({observedElement:t,callback:e,observeCondition:s,percent:i,delayBetweenCheckCalls:n,delayBetweenCallbackCalls:o}){var r,a,l;l=!1,(a="inited")in(r=this)?Object.defineProperty(r,a,{value:l,enumerable:!0,configurable:!0,writable:!0}):r[a]=l,this.observedElement=t,this.callback=e,this.observeCondition=s,this.percent=null!=i?i:[50,100],this.delayBetweenCheckCalls=null!=n?n:500,this.delayBetweenCallbackCalls=null!=o?o:2e3;const h={leading:!1};this.onScrollThrottle=(0,N.throttle)(this.onScroll.bind(this),this.delayBetweenCheckCalls,h),this.onScrollMatchThrottle=(0,N.throttle)(this.onScrollMatch.bind(this),this.delayBetweenCallbackCalls,h)}observe(){this.inited||(this.inited=!0,this.onScroll(),document.addEventListener("scroll",this.onScrollThrottle))}unobserve(){this.inited&&(this.inited=!1,document.removeEventListener("scroll",this.onScrollThrottle))}onScroll(){if(!this.percent.length)return void this.unobserve();const[t,e]=this.getViewRange();this.isStoryOutViewport(t,e)||this.percent.forEach((s=>{s>=t&&s<=e&&this.onScrollMatchThrottle(s)}))}onScrollMatch(t){const[e,s]=this.getViewRange();if(this.isStoryOutViewport(e,s)||this.isNotMatchedPercent(t,e,s))return;const i=this.percent.indexOf(t);-1!==i&&this.observeCondition()&&(this.percent.splice(i,1),this.callback(t))}getViewRange(){const t=this.observedElement;if(!t)return[];const{windowHeight:e}=i.ZP.ui,{top:s,bottom:n,height:o}=t.getBoundingClientRect();if(e-s<0||n<0)return[];const r=s>0?s:0,a=n<=e?e-n:0,l=Math.round(e-r-a),h=100/o,c=s<0?-s:0,d=s>0?l:l-s;return[Math.round(h*c),Math.round(h*d)]}isNotMatchedPercent(t,e,s){return t<e||t>s}isStoryOutViewport(t,e){return null==t||!e}}var L,F=s(9895),U=s(3669),j=s(4143);function V(t,e){var s=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),s.push.apply(s,i)}return s}function H(t,e,s){return e in t?Object.defineProperty(t,e,{value:s,enumerable:!0,configurable:!0,writable:!0}):t[e]=s,t}!function(t){t.READ="r",t.VIEW="v",t.CONTENT="c"}(L||(L={}));class q{constructor(){}static getInstance(){return q._instance||(q._instance=new q),q._instance}static get instance(){return q.getInstance()}logStoryPageOpen(t){t.isStoryPage&&(this.isTransitionFromAdvertStory(t)||this.send(t,L.READ))}logViewing(t){this.isTransitionFromAdvertStory(t)||this.send(t,L.VIEW)}logReading(t){this.isTransitionFromAdvertStory(t)||t.isLongStory||t.isStoryPage||this.send(t,L.READ)}logVideoClick(t){this.send(t,L.CONTENT,{lh:"v"})}logReadMoreClick(t){t.isStoryPage||this.send(t,L.CONTENT,{lh:"sm"})}send(t,e,s){const n=function(t){for(var e=1;e<arguments.length;e++){var s=null!=arguments[e]?arguments[e]:{};e%2?V(Object(s),!0).forEach((function(e){H(t,e,s[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(s)):V(Object(s)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(s,e))}))}return t}({t:e,s:t.id,h:"hot-stories"===i.vE.initParams.pageName?1:void 0,isp:Number(t.isStoryPage),m:i.vE.isMobileApp?1:void 0},s);e===L.READ&&t.viewRatio>=50&&(n.p=100===t.viewRatio?t.viewRatio:50),I.cf.post("/ajax.php?route=advert-blogs/stat",n)}isTransitionFromAdvertStory(t){return t.isStoryPage&&Boolean(i.vE.storage.isTransitionFromAdvertStory)}}var W=s(1433),G=s(8854),Y=s(8799),z=s(5271);function Z(t,e){var s=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),s.push.apply(s,i)}return s}function K(t){for(var e=1;e<arguments.length;e++){var s=null!=arguments[e]?arguments[e]:{};e%2?Z(Object(s),!0).forEach((function(e){X(t,e,s[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(s)):Z(Object(s)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(s,e))}))}return t}function X(t,e,s){return e in t?Object.defineProperty(t,e,{value:s,enumerable:!0,configurable:!0,writable:!0}):t[e]=s,t}const Q=s(6419),J=s(9755);class tt{constructor(t,e,s){var n,o;this._options={referrerStoryId:s,id:t||0,el:e,$el:J(e),isLongStory:!1,canVote:!1,inViewport:!1,inViewportForAnalytics:!1,viewingTime:0,viewingTimeForAnalytics:0,elapsedTime:void 0,viewStarted:!1,viewStartedForAnalytics:!1,adViewKey:!1,adId:!1,authorId:0,pluses:0,minuses:0,tags:[],screenIndex:0,topViewBound:void 0,bottomViewBound:void 0,isStoryPage:!1},this._timeoutList=void 0,this._lastViewStarted=void 0,this._lastViewStartedForAnalytics=void 0,this._lastElapsed=void 0,this._unfocusedView=0,this._unfocusedViewForAnalytics=0,this._lastBlurTime=void 0,this._lastBlurTimeForAnalytics=void 0,this._totalViewTime=0,this._totalViewTimeForAnalytics=0,this._firstViewTime=0,this._firstViewTimeForAnalytics=0,this._contentBlocksCount=new Map,this._readingLevelCounter=h.NOT_READ,this._calculateContentBlocks(),z.V.isUserInExperiment(z.t.CONTENT_VIEWED_EVENT)&&this._initStoryObserver(),this._options.contentBlock=this.el.querySelector(`.${A.B.content.item}, .story__description`),this._isBestStory="true"===(null===(n=this.el.dataset)||void 0===n?void 0:n.bestStory),this._initBestStoryIconObserver(),this.$el.find(`.${A.B.blocks.text} a`).on("click",(t=>{const e=t.currentTarget.getAttribute("href");D.c.getInstance().sendEvent("click_post_link",K(K({},R.cQ.omit(this.analyticsData,"type_i8")),{},{post_link:e}))})),this.$el.find(`.${A.B.user.link}`).on("click auxclick",(t=>{if(0!==t.button&&1!==t.button)return;const e=void 0!==this.adId&&this.adId;D.c.getInstance().sendEvent("transition_to_author",{post_id:this.id,author_id:this.authorId,type:"from_post",content_type:this.contentTypes,"promo_id!empty":e,"type_i8!empty":this.subsCode})})),this.$el.find(`.${A.B.community.link}`).on("click auxclick",(t=>{if(0!==t.button&&1!==t.button)return;const e=Number(t.currentTarget.dataset.id);D.c.getInstance().sendEvent("transition_to_community",K({post_id:this.id,type:"from_post",community_id:e},this.subsCode&&{type_i8:this.subsCode}))})),this.$el.find(`.${A.B.to}`).on("click auxclick",(t=>{0!==t.button&&1!==t.button||D.c.getInstance().sendEvent("transition_to_post",K(K({},this.analyticsData),{},{transition_source:"comments_button","rec_score!undefined":this.relevanceCoefficient},this.recommendationAlgorithm>0&&{rec_algorithm:this.recommendationAlgorithm}))})),this.$el.find(`.${A.B.title.link}`).on("click auxclick",(t=>{0!==t.button&&1!==t.button||D.c.getInstance().sendEvent("transition_to_post",K(K({},this.analyticsData),{},{transition_source:"post_title","rec_score!undefined":this.relevanceCoefficient},this.recommendationAlgorithm>0&&{rec_algorithm:this.recommendationAlgorithm}))})),this.$el.find(".story__social-flag").on("click auxclick",(t=>{0!==t.button&&1!==t.button||D.c.getInstance().sendEvent("click",{type:"post_published_"+t.target.dataset.social})})),this.$el.find(".tags__tag").on("click auxclick",(t=>{if(0!==t.button&&1!==t.button)return;const e=t.currentTarget;D.c.getInstance().sendEvent("transition_to_tag",K(K({},R.cQ.omit(this.analyticsData,"type_i8")),{},{type:"from_post",tag_id:e.dataset.tag,tags:this.tags}))})),this.$el.find(`.${A.B.copy}`).on("click",(t=>{t.preventDefault();const e=t.target.dataset.url;R.cQ.copyToClipboard(decodeURIComponent(e)),i.ZP.ui.toasts.add("story-link-copy",{content:i.ZP.i18n("stories-feed.copied")}),D.c.getInstance().sendEvent("share_to_social_network",K(K({},this.analyticsData),{},{type:"link_post"}))})),this.el.querySelectorAll(".tags__tag").forEach((t=>{t.dataset.analyticsType="post_popup"})),this._initCompanyBlogBadgeAnalytics(),null===(o=this.el.querySelector(".best-story-mark"))||void 0===o||o.addEventListener("click",(async t=>{t.preventDefault(),D.c.getInstance().sendEvent("click",{type:"today_best_label"}),await(0,G.g)(500),window.location.href=t.target.href}));const r=this.el.querySelector(`.${A.B.content.item}`);var a;null==r||!r.classList.contains(A.B.content.overlayed)||null!=r&&r.classList.contains(A.B.content.horror)||(null===(a=this.el.querySelector(`.${A.B.adultOverlay.el}`))||void 0===a||a.addEventListener("click",(t=>{r.classList.remove(A.B.content.overlayed),t.currentTarget.remove()})));this._saveTagsListFromElement(),this._initParentLinkAnalytics(),this._initSubscribeToCommunityBtn(),this.emotions,this._initAnswerAnalyticsFromSpecialsPromo()}_initCompanyBlogBadgeAnalytics(){var t;const e=null===(t=this.el)||void 0===t?void 0:t.querySelector(".story__company-blog-badge");if(!e)return;const s=()=>{D.c.getInstance().sendEvent("click",{type:"company_blog_label",post_id:this.id})};e.addEventListener("click",s),e.addEventListener("auxclick",(t=>{1===t.button&&s()}))}_initStoryObserver(){this.storyObserver=new IntersectionObserver((t=>{t[0].isIntersecting||this._isInFocusForContentViewed()||this._stopKeepTrackViewingTime(),t[0].isIntersecting&&this._isInFocusForContentViewed()&&this._startKeepTrackViewingTime()}),{rootMargin:`-${k}px 0px`,threshold:0}),this.storyObserver.observe(this.el)}_getOptionsFromData(){var t;const e=this.el.dataset;this._options.isBlogStory=Boolean(e.blog),this._options.isStoryPage="true"===e.page,this._options.isLongStory="true"===e.storyLong,this._options.sliceType=r[e.sliceType]||r.NONE,this.isLongStory&&(this._options.isCollapsedLongStory=this.$readMore&&"none"!==this.$readMore.style.display);const s=e.vid?parseInt(e.vid.slice(1),10):void 0,n=e.vkey&&"sdVk"!==e.vkey?e.vkey:void 0;this._options.adId=!(!Q.isFinite(s)||s===this.id)&&s,this._options.adViewKey=n,this._options.isAdShortRead=!0,this._options.isAdViewed=!0,this._options.isBlogStoryViewed=!0,this._options.isBlogStoryRead=!0,this.isAdStory?(this._options.isAdShortRead=$.o.isShortRead(n,this.referrerStoryId),this._options.isAdViewed=$.o.isViewed(n,this.referrerStoryId)):this.isBlogStory&&(this._options.isBlogStoryViewed=!1,this._options.isBlogStoryRead=!1),this.referrerStoryId&&(this.el.dataset.rsid=String(this.referrerStoryId)),this.authorId=e.authorId||0,this.authorName=null!==(t=e.authorName)&&void 0!==t?t:"",this.commentsCount=e.comments||0,this.recommendationAlgorithm=e.recomAlgo||void 0,this.relevanceCoefficient=e.recomCoef||void 0,this.algorithm=e.recomAlgo||void 0,this.score=e.recomCoef||void 0;const a=e.metaRating;if(a&&([this._options.pluses,this._options.minuses]=a.split(":").map((t=>Number(t)))),this._options.isCollapsed=this.el.classList.contains(A.B.collapse),this._options.canVote="true"===e.canVote,this._options.isCommentsDisabled=null===this.el.querySelector("."+A.B.comments.count),this._options.isVisited="true"===e.visited,this._options.isViewed=x.N.isViewed(this.id),this._options.contextActions=e.contextActions?e.contextActions.split(","):[],this._options.contextActions.includes("report")){i.ZP.initParams.reportReasons.filter((t=>t.type===U.f0.post)).length||(this._options.contextActions=this._options.contextActions.filter((t=>"report"!==t)))}return this._options.subsCode=e.subsCode?Number(e.subsCode):void 0,this._autoCorrectCollapsed(),this.setOptions({vote:o[parseInt(e.vote,10)],rating:e.rating,isSaved:"true"===e.saved}),this._options.isStoryPage&&this._sendSaveRead(),this.isBlogStory&&this.$el.find(`.${A.B.blocks.video}`).one("click",(()=>{q.instance.logVideoClick(this)})),this._initReadingAnalytics(),this}async _sendSaveRead(){if(this.isAdStory){const e={advert_id:this._options.adId,rsid:this.relevanceCoefficient};if(document.referrer)try{e.rd=new URL(document.referrer).hostname}catch(t){}I.cf.post("/ajax/save_read.php",e)}else this.isBlogStory&&q.instance.logStoryPageOpen(this)}_saveTagsListFromElement(){const t=this.el.querySelectorAll(".tags__tag");t.length>0&&(this._options.tags=Array.from(t).map((t=>t.dataset.tag)))}_calculateContentBlocks(){const t={video:0,videofile:0,text:0,gif:0,image:0};this.$el.find(`.${A.B.block}`).each(((e,s)=>{if(s.classList.contains(A.B.blocks.video)){return J(s).children('[data-type="video"]').length>0?void this._contentBlocksCount.set("video",++t.video):void this._contentBlocksCount.set("videofile",++t.videofile)}if(s.classList.contains(A.B.blocks.image)){return J(s).children('[data-type="gifx"]').length>0?void this._contentBlocksCount.set("gif",++t.gif):void this._contentBlocksCount.set("image",++t.image)}this._contentBlocksCount.set("text",++t.text)}))}_autoCorrectCollapsed(){if(!this.isLongStory||this.sliceType===r.NONE||!this.isCollapsedLongStory)return;let t=this.el.querySelector(`.${A.B.contentInner.item}`);if(!t)return;let e=t.offsetWidth,s=t.offsetHeight,i=t.scrollHeight;this.sliceType===r.BY_BLOCK&&(i+=this.$el.find(`.${A.B.hiddenBlocksWrapper}`).height()||0,this.$el.find(`.${A.B.blocks.video}`).each(((t,s)=>{i+=s.offsetHeight<50?e/1.7777777777777777:0}))),0===s||i-c>s||(this._options.isCollapsedLongStory=!1,this._updateCollapsedLongStory(!1),this._options.sliceType=r.NONE,this._options.isLongStory=!1)}setOptions(t){return Q.isObject(t)?(Q.forEach(t,((t,e)=>{this[e]=t})),this):this}destroy(){this.__destroyed=!0,this.cancelTimeout();for(let t in this._options)this._options.hasOwnProperty(t)&&delete this._options[t];delete this._options}voteDirection(t,e=!1){D.c.getInstance().yandex.goal("vote-for-story"),D.c.getInstance().yandex.goal(t.value>0?"tap-post-plus":"tap-post-minus"),D.c.getInstance().google.event(t.value>0?"like":"dislike","post");const s=t!==this.vote?t:t===o.UP?o.DOWN:o.UP;if(t=this.vote+s.valueOf(),!e||t>=o.DOWN&&t<=o.UP){const e=i.eR.get("cvb")?"cvb":null;D.c.getInstance().sendEvent("rate_content",K(K(K(K(K({post_id:this.id,author_id:this.authorId,user_rate:t.valueOf()},e&&{type:e}),{},{pluses:this.pluses,minuses:this.minuses,comments:this.commentsCount},void 0!==this.relevanceCoefficient&&{rec_score:this.relevanceCoefficient}),this.recommendationAlgorithm>0&&{rec_algorithm:this.recommendationAlgorithm}),this.screenIndex>0&&{screen_index:this.screenIndex}),this.subsCode&&{type_i8:this.subsCode})),this.vote=t}return this}timeout(t,e,s,i=!0,...n){i&&this.cancelTimeout(t);let o=this._timeoutList;o||(this._timeoutList=o=new Map);let r=()=>{s.apply(this,n),o.delete(t)};return o.set(t,{callback:r,handler:setTimeout(r,e)}),this}cancelTimeout(...t){if(!this._timeoutList||!this._timeoutList.size)return this;if(t.length)t.forEach((t=>{this._timeoutList.has(t)&&(clearTimeout(this._timeoutList.get(t).handler),this._timeoutList.delete(t))}));else{for(let{handler:t}of this._timeoutList.values())clearTimeout(t);this._timeoutList.clear()}return this}updateViewBounds(){let t,e;this._options.contentBlock?(t=this._options.contentBlock.offsetTop,e=this._options.contentBlock.offsetHeight):(t=0,e=0);const s=this.offsetTop+t,n=Math.max(i.ZP.ui.scrollTop-s,0);(n<this._options.topViewBound||void 0===this._options.topViewBound)&&(this._options.topViewBound=n);const o=Math.min(i.ZP.ui.scrollTop+i.ZP.ui.windowHeight-s,e);(o>this._options.bottomViewBound||void 0===this._options.bottomViewBound)&&(this._options.bottomViewBound=o)}async _syncVote(){if(this.vote===this.voteSync)return;const{response:t,data:e}=await I.cf.post("/ajax/vote_story.php",{story_id:this.id,vote:this.vote.valueOf()});t.result?(this.voteSync=this.vote,e&&e.is_show_subscribe_block&&this._createSubscribeAuthorPopup()):(this.vote=this.voteSync,t.message&&i.ZP.ui.toasts.showError(t.message))}onWindowFocusChanged(t){if(!t)return this._sendShowPostEvent(!0),this._sendShowPostEventForAnalytics(!0),this._lastBlurTime=Date.now(),this._lastBlurTimeForAnalytics=Date.now(),void(z.V.isUserInExperiment(z.t.CONTENT_VIEWED_EVENT)&&this._stopKeepTrackViewingTime());this._unfocusedView+=isNaN(Date.now()-this._lastBlurTime)?0:Date.now()-this._lastBlurTime,this._unfocusedViewForAnalytics+=isNaN(Date.now()-this._lastBlurTimeForAnalytics)?0:Date.now()-this._lastBlurTimeForAnalytics,this._lastBlurTime=void 0,this._lastBlurTimeForAnalytics=void 0,z.V.isUserInExperiment(z.t.CONTENT_VIEWED_EVENT)&&this._startKeepTrackViewingTime()}onSessionRegenerated(){this._resetShowPostInfo(),this._resetShowPostInfoForAnalytics()}_resetShowPostInfo(){void 0!==this._lastViewStarted&&(this._lastViewStarted=Date.now(),0===this._firstViewTime&&this.isStoryPage&&(this._firstViewTime=this._lastViewStarted),this._unfocusedView=0,void 0!==this._lastBlurTime&&(this._lastBlurTime=this._lastViewStarted))}_resetShowPostInfoForAnalytics(){void 0!==this._lastViewStartedForAnalytics&&(this._lastViewStartedForAnalytics=Date.now(),0===this._firstViewTimeForAnalytics&&this.isStoryPage&&(this._firstViewTimeForAnalytics=this._lastViewStartedForAnalytics),this._unfocusedViewForAnalytics=0,void 0!==this._lastBlurTimeForAnalytics&&(this._lastBlurTimeForAnalytics=this._lastViewStartedForAnalytics))}_sendShowPostEvent(t=!1){this.isDestroyed||(!t&&this._options.viewStarted&&this.timeout("view-time",2e3,this._sendShowPostEvent),void 0!==this._lastViewStarted&&void 0===this._lastBlurTime&&(!i.ZP.isUserAuthorized&&this._isBestStory&&this._setCookieForBestStoryShown(),D.c.getInstance().sendEvent("show_post",this.getShowPostAnalyticsData(),[P.b.CLICKHOUSE])))}_sendShowPostEventForAnalytics(t=!1){this.isDestroyed||(!t&&this._options.viewStartedForAnalytics&&this.timeout("view-time-2",2e3,this._sendShowPostEventForAnalytics),void 0!==this._lastViewStartedForAnalytics&&void 0===this._lastBlurTimeForAnalytics&&D.c.getInstance().sendEvent("show_post_2",K(K({},this.getShowPostAnalyticsData()),{},{create_at:this.isStoryPage?this._firstViewTimeForAnalytics:this._lastViewStartedForAnalytics,view_time:(this._totalViewTimeForAnalytics+Date.now()-this._lastViewStartedForAnalytics-this._unfocusedViewForAnalytics)/1e3}),[P.b.CLICKHOUSE]))}getShowPostAnalyticsData(){const t=K(K(K(K({create_at:this.isStoryPage?this._firstViewTime:this._lastViewStarted,view_time:"story"===i.ZP.initParams.pageName?F.Z.getInstance().getViewTime(`story-${this.id}`):(this._totalViewTime+Date.now()-this._lastViewStarted-this._unfocusedView)/1e3,view_ratio:this.viewRatio},this.isLongStory&&{show_full_post:this.isCollapsedLongStory?0:1}),this.analyticsData),{},{"rec_score!undefined":this.relevanceCoefficient},this.recommendationAlgorithm>0&&{rec_algorithm:this.recommendationAlgorithm}),{},{"type!undefined":this._isBestStory?"from_best_insert":void 0});if(this._contentBlocksCount.get("videofile")>0){const e=j.FW.getVolumePercents();t.sound_on=Boolean(e),t.sound_volume=e}return t}checkVisited(){return this.isVisited||this.viewingTime>=m}checkVisitedForAnalytics(){return this.isVisited||this.viewingTimeForAnalytics>=m}checkViewed(){return this.isViewed||this.viewingTime>=d}checkViewedForAnalytics(){return this.isViewed||this.viewingTimeForAnalytics>=d}checkAdViewed(){return this.isAdViewed||this.viewingTime>=u}checkAdShortRead(){return this.isAdShortRead||this.viewingTime>=p}checkBlogStoryRead(){return this.isBlogStoryRead||this.viewingTime>=g}checkBlogStoryViewed(){return this.isBlogStoryViewed||this.viewingTime>=_}_updateRating(){}_updateCollapsed(t){}_updateCollapsedLongStory(t){}_updateViewedCount(t){const e=Intl&&Intl.NumberFormat?new Intl.NumberFormat("ru").format(t):t,s=R.cQ.reduceNumber(t);this.$viewedCount.text(s).parent().attr("aria-label",e+" "+i.ZP.i18n("plural.views",t)),this.$viewedCount.data("hint")&&this.$viewedCount.data("hint").destroy()}_updateSaved(t){}_initParentLinkAnalytics(){const t=this.$el.find(`.${A.B.parentLink}`);t.length&&t.on("click auxclick",(t=>{0!==t.button&&1!==t.button||D.c.getInstance().sendEvent("transition_to_post",{transition_source:"parent_post"})}))}_initReadingAnalytics(){!this.isDestroyed&&Boolean(this.adId)&&this.isLongStory&&(this._options.readingObserverPostCollapsed||(this._options.readingObserverPostCollapsed=new B({observedElement:this.el.querySelector(".story__content-inner"),percent:[1],callback:()=>{this._readingLevelCounter=h.BEGIN_READING},observeCondition:()=>!this.isDestroyed&&Boolean(this.adId)&&this.isLongStory&&this.isCollapsedLongStory})),this._options.readingObserverPostCollapsed.observe())}_setReadingObserverPostOpened(t){this._options.readingObserverPostOpened||t||(this._options.readingObserverPostOpened=new B({observedElement:this.el.querySelector(".story__content-inner"),percent:this._readingLevelCounter===h.BEGIN_READING?[50,100]:[1,50,100],callback:()=>{switch(this._readingLevelCounter){case h.NOT_READ:this._readingLevelCounter=h.BEGIN_READING;break;case h.BEGIN_READING:this._readingLevelCounter=h.HALF_READING,I.cf.post("/ajax/save_read.php",{advert_id:this.adId,p:50});break;case h.HALF_READING:this._readingLevelCounter=h.FULL_READING,I.cf.post("/ajax/save_read.php",{advert_id:this.adId,p:100})}},observeCondition:()=>!this.isDestroyed&&Boolean(this.adId)&&this.isLongStory&&!this.isCollapsedLongStory}),this._options.readingObserverPostOpened.observe())}_initLabelRecommendedAnalytics(){this.$el.find(".story__rec, .story__label_rec").length&&this.$el.on("click auxclick",".story__rec, .story__label_rec",(()=>{const t={level:41,type:"post_header_recommended",post_id:this.id,rec_score:this.relevanceCoefficient,rec_algorithm:this.recommendationAlgorithm,screen_index:this.screenIndex,pluses:this._options.pluses,minuses:this._options.minuses,comments:this.commentsCount,author_id:this.authorId,"type_i8!undefined":this.subsCode};D.c.getInstance().sendEvent("transition_to_tab",t)}))}_initAnswerAnalyticsFromSpecialsPromo(){this.el.querySelector('iframe[src^="https://specials.pikabu.ru"]')&&window.addEventListener("message",(function(t){var e;if("https://specials.pikabu.ru"!==t.origin)return;let s;try{s=JSON.parse(t.data)}catch(i){}"promo_quiz_click"===(null===(e=s)||void 0===e?void 0:e.event)&&D.c.getInstance().sendEvent("click",{type:"promo_quiz_click"})}))}_createSubscribeAuthorPopup(){}_initSubscribeToCommunityBtn(){const t=this.el.querySelector(".story__community-subscribe");if(!(t instanceof HTMLButtonElement))return;const e=({currentTarget:t})=>{const s=t.dataset.cid;if(t.disabled||!s)return;[...document.querySelectorAll(`.story .story__community-subscribe[data-cid="${s}"]`)].forEach((t=>{t.disabled=!0,t.lastChild.textContent="Вы подписаны"})),t.removeEventListener("click",e),new W.S1(s).subscribe(!0,{type:"post_header",post_id:this.id,author_id:this.authorId})};t.addEventListener("click",e)}async _initBestStoryIconObserver(){if(!this._isBestStory||R.mM.get(O))return;const t=this.el.querySelector(".best-story-icon ");if(!t)return;await(0,G.g)(3e3);const e=new IntersectionObserver((s=>{if(s[0].isIntersecting||i.ZP.ui.elementInViewport(t)){new Y.gR({content:'<div class="popup__hint">Лучший пост за сегодня</div>',alignment:Y.SE.CENTER,direction:Y.Lh.TOP,zIndex:201,target:t,destroyAfterHide:!0,autoCorrectPosition:!0,delayClose:2500,autoCloseOutsideClick:!0}).show(),R.mM.set(O,1),e.unobserve(t)}}),{rootMargin:"-50px",threshold:1});e.observe(t)}_setCookieForBestStoryShown(){var t,e;let s=null===(t=i.eR.get(C))||void 0===t?void 0:t.split(",",T);if(void 0===s&&(s=[]),(null===(e=s)||void 0===e?void 0:e.length)>0&&s.includes(this.id.toString()))return;let n="";n=s.length>0?`${this.id.toString()},${s.join(",")}`:`${this.id.toString()}`,i.eR.set(C,n,{expires:30})}_startKeepTrackViewingTime(){this._isInFocusForContentViewed()&&(this._contentViewPostStarted=Date.now())}_stopKeepTrackViewingTime(){this._contentViewPostStarted&&"number"==typeof this._contentViewPostStarted&&(this._contentViewResultTime=Date.now()-this._contentViewPostStarted,this._contentViewPostStarted=null,D.c.getInstance().sendEvent("content_viewed",K(K({},this.getShowPostAnalyticsData()),{},{view_time:this._contentViewResultTime})))}_isInFocusForContentViewed(){const t=this.el.getBoundingClientRect();return t.bottom>k&&t.top<i.ZP.ui.windowHeight-k}onPopupShown(){this._stopKeepTrackViewingTime()}onPopupHidden(){this._startKeepTrackViewingTime()}get isDestroyed(){return this.__destroyed}get isHidden(){return this.$el.is(":hidden")}get isCommentsDisabled(){return this._options.isCommentsDisabled}get offsetTop(){return this.el.offsetTop}get offsetHeight(){return this.el.offsetHeight}get vote(){return this._options.vote}set vote(t){let e=this._options.vote;(t=o[t]||o.NONE)&&t!==e&&this.canVote&&(this._options.vote=t,e?(t!==this.voteSync&&(this._voteDebounce||(this._lastElapsed=this.viewingTime,this._voteDebounce=Q.debounce(this._syncVote.bind(this),700)),this._voteDebounce(t)),this._updateRating()):this.voteSync=t)}get subsCode(){return this._options.subsCode}get rating(){return this._options.rating}set rating(t){const e=this._options.rating;void 0===t||isNaN(t)||e===t||(e||!this.vote?this._options.rating=t:this._options.rating=t-this.vote.valueOf())}get voteSync(){return this._options.voteSync}set voteSync(t){this._options.voteSync=o[t]||o.NONE}get isVisited(){return this._options.isVisited}set isVisited(t){const e=this._options.isVisited;e!==t&&!0!==e&&(this._options.isVisited=t)}get isViewed(){return this._options.isViewed}set isViewed(t){const e=this._options.isViewed;e!==t&&!0!==e&&(this._options.isViewed=t)}get isAdViewed(){return this._options.isAdViewed}set isAdViewed(t){const e=this._options.isAdViewed;e!==t&&!0!==e&&(this._options.isAdViewed=t,this.isAdStory&&$.o.setViewed(this.adViewKey,this.referrerStoryId,i.ZP.isDesktopApp))}get isAdShortRead(){return this._options.isAdShortRead}set isAdShortRead(t){let e=this._options.isAdShortRead;e!==t&&!0!==e&&(this._options.isAdShortRead=t,this.isAdStory&&(i.ZP.logger.log("ad","set isAdShortRead to",t,this.id,this.adViewKey),$.o.setShortRead({adViewKey:this.adViewKey,referrerStoryId:this.referrerStoryId,isStoryPage:this.isStoryPage})))}get isBlogStoryRead(){return this._options.isBlogStoryRead}set isBlogStoryRead(t){let e=this._options.isBlogStoryRead;e!==t&&!0!==e&&(this._options.isBlogStoryRead=t,this.isBlogStory&&q.instance.logReading(this))}get isBlogStoryViewed(){return this._options.isBlogStoryViewed}set isBlogStoryViewed(t){let e=this._options.isBlogStoryViewed;e!==t&&!0!==e&&(this._options.isBlogStoryViewed=t,this.isBlogStory&&q.instance.logViewing(this))}get viewedCount(){return this._options.viewedCount}set viewedCount(t){this._options.viewedCount===t||!Number.isFinite(t)||t<0||(this._options.viewedCount=t,this._updateViewedCount(t))}get emotions(){if(this._options.emotions)return this._options.emotions;const t=this.$el.find(".story__emotions");return t.length?this._options.emotions=new M.f({story:this,$el:t}):void 0}get isSaved(){return this._options.isSaved}set isSaved(t){const e=this._options.isSaved;e!==t&&(this._options.isSaved=t,void 0!==e&&this._updateSaved(t))}get id(){return this._options.id}get adId(){return this._options.adId}get adViewKey(){return this._options.adViewKey}get referrerStoryId(){return this._options.referrerStoryId}get el(){return this._options.el}get $el(){return this._options.$el}get $readMore(){return this._options.$readMore||(this._options.$readMore=this.el.querySelector("."+A.B.readMore.button)),this._options.$readMore}get isLongStory(){return this._options.isLongStory}get sliceType(){return this._options.sliceType}get canVote(){return this._options.canVote}get isCollapsed(){return this._options.isCollapsed}set isCollapsed(t){if(t=Boolean(t),this._options.isCollapsed===t)return t;this.viewStarted=!t&&this.inViewport,this.viewStartedForAnalytics=!t&&this.inViewportForAnalytics,this._updateCollapsed(t),this._options.isCollapsed=t}get isCollapsedLongStory(){return this._options.isCollapsedLongStory}set isCollapsedLongStory(t){let e=this._options.isCollapsedLongStory;t=Boolean(t),this.isLongStory&&e!==t&&(this._setReadingObserverPostOpened(t),this._options.isCollapsedLongStory=t,this._updateCollapsedLongStory(t),this._initReadingAnalytics(),t||(this.isAdStory?!this.referrerStoryId&&"story"===i.ZP.initParams.pageName||$.o.isClickReadMore(this.id)||$.o.setClickReadMore(this.id,this.adId,this.referrerStoryId):this.isBlogStory&&q.instance.logReadMoreClick(this)))}get inViewport(){return this._options.inViewport}set inViewportForAnalytics(t){t=Boolean(t),this._options.inViewportForAnalytics!==t&&(this.viewStartedForAnalytics=t&&!this.isCollapsed,this._options.inViewportForAnalytics=t)}get inViewportForAnalytics(){return this._options.inViewportForAnalytics}set inViewport(t){t=Boolean(t),this._options.inViewport!==t&&(this.viewStarted=t&&!this.isCollapsed,this._options.inViewport=t,this.$el.find('script[type="text/string"][data-event="in-view"], script[data-event="story-in-view"]').replaceWith((function(){return atob(this.textContent)})))}get viewStarted(){return this._options.viewStarted}get viewStartedForAnalytics(){return this._options.viewStartedForAnalytics}set viewStarted(t){this._options.viewStarted!==(t=Boolean(t))&&(this._options.viewStarted=t,t?(this._lastViewStarted=Date.now(),0===this._firstViewTime&&this.isStoryPage&&(this._firstViewTime=this._lastViewStarted),this._unfocusedView=0,void 0!==this._lastBlurTime&&(this._lastBlurTime=this._lastViewStarted),this.timeout("view-time",2e3,this._sendShowPostEvent)):this._lastViewStarted&&(this.cancelTimeout("view-time"),this._sendShowPostEvent(!0),this._options.viewingTime+=Math.round((Date.now()-this._lastViewStarted)/1e3),this.isStoryPage&&(this._totalViewTime+=Date.now()-this._lastViewStarted-this._unfocusedView),this._lastViewStarted=void 0))}set viewStartedForAnalytics(t){this._options.viewStartedForAnalytics!==(t=Boolean(t))&&(this._options.viewStartedForAnalytics=t,t?(this._lastViewStartedForAnalytics=Date.now(),0===this._firstViewTimeForAnalytics&&this.isStoryPage&&(this._firstViewTimeForAnalytics=this._lastViewStartedForAnalytics),this._unfocusedViewForAnalytics=0,void 0!==this._lastBlurTimeForAnalytics&&(this._lastBlurTimeForAnalytics=this._lastViewStartedForAnalytics),this.timeout("view-time-2",2e3,this._sendShowPostEventForAnalytics)):this._lastViewStartedForAnalytics&&(this.cancelTimeout("view-time-2"),this._sendShowPostEventForAnalytics(!0),this._options.viewingTimeForAnalytics+=Math.round((Date.now()-this._lastViewStartedForAnalytics)/1e3),this.isStoryPage&&(this._totalViewTimeForAnalytics+=Date.now()-this._lastViewStartedForAnalytics-this._unfocusedViewForAnalytics),this._lastViewStartedForAnalytics=void 0))}get viewingTime(){return this._lastViewStarted?this._options.viewingTime+Number(((Date.now()-this._lastViewStarted)/1e3).toFixed(1)):this._options.viewingTime}get viewingTimeForAnalytics(){return this._lastViewStartedForAnalytics?this._options.viewingTimeForAnalytics+Number(((Date.now()-this._lastViewStartedForAnalytics)/1e3).toFixed(1)):this._options.viewingTimeForAnalytics}get elapsedTime(){return this._options.elapsedTime?this._options.elapsedTime:this._lastElapsed?this._options.elapsedTime=this._lastElapsed:this._options.elapsedTime}get progressReading(){return this._options.progressReading}set progressReading(t){this._options.progressReading=t}get isMetrikaVisited(){return this._options.metrikaVisited}set isMetrikaVisited(t){this._options.metrikaVisited=Boolean(t)}get authorId(){return this._options.authorId}set authorId(t){this._options.authorId=Number(t)}get authorName(){return this._options.authorName}set authorName(t){this._options.authorName=t}get contentTypes(){let t=[];for(const[e,s]of this._contentBlocksCount.entries())s>0&&t.push(`${f[e]}:${s}`);return t.join("+")}get commentsCount(){return this._options.commentsCount}set commentsCount(t){this._options.commentsCount=Number(t)}get recommendationAlgorithm(){return this._options.recommendationAlgorithm}set recommendationAlgorithm(t){isNaN(t)||(this._options.recommendationAlgorithm=Number(t))}get relevanceCoefficient(){return this._options.relevanceCoefficient}set relevanceCoefficient(t){isNaN(t)||(this._options.relevanceCoefficient=Number(t))}get screenIndex(){return this._options.screenIndex}set screenIndex(t){this._options.screenIndex=Number(t)}get tags(){return this._options.tags.join(",")}get tagsList(){return this._options.tags||[]}get tagsMask(){let t=0;return v.forEach((e=>{this._options.tags.includes(e.name)&&(t+=e.value)})),t}get analyticsData(){const t=void 0!==this.adId&&this.adId,e=this.tagsMask;return K(K(K(K({post_id:this.id,author_id:this.authorId,pluses:this._options.pluses,minuses:this._options.minuses,algorithm:this.algorithm,score:this.score},e>0&&{tags_mask:e}),{},{comments:this.commentsCount,content_type:this.contentTypes},t&&{promo_id:t}),this.screenIndex>0&&{screen_index:this.screenIndex}),this.subsCode&&{type_i8:this.subsCode})}get viewRatio(){if(void 0===this._options.topViewBound||void 0===this._options.bottomViewBound)return 0;const t=this._options.bottomViewBound-this._options.topViewBound,e=this.sliceType===r.BY_BLOCK&&this.isCollapsedLongStory&&this.$el.find(`.${A.B.hiddenBlocksWrapper}`).height()||0,s=this.el.querySelector(".story__content-inner, .story__description"),i=(s?s.scrollHeight:0)+e;return Math.min(100,Math.max(0,Math.round(100*t/i)))}get isStoryPage(){return this._options.isStoryPage}get pluses(){return this._options.pluses}get minuses(){return this._options.minuses}get date(){if(!this._options.date){var t;const e=null===(t=this.el.querySelector(`.${A.B.datetime}`))||void 0===t?void 0:t.getAttribute("datetime");this._options.date=new Date(e)}return this._options.date}get isBlogStory(){return this._options.isBlogStory}get isAdStory(){return Boolean(this._options.adId)}}},3227:(t,e,s)=>{"use strict";s.d(e,{B:()=>i});const i={item:"story",collapse:"story_collapse",main:"story__main",tipAnchor:"story__tip-anchor",title:{el:"story__title",link:"story__title-link",visited:"story__title-link_visited"},header:"story__header",dots:{button:"story__dots",active:"story__dots_active"},datetime:"story__datetime",to:"story__to-comments",user:{info:"story__user-info",link:"story__user-link"},copy:"story__copy-link",community:{link:"story__community-link"},tags:{wrapper:"story__tags",skeleton:"story__tags_skeleton",tag:"tags__tag",moreButton:"tags-cut",tool:"tool"},comments:{count:"story__comments-link"},content:{item:"story__content",show:"story__content_show",overlayed:"story__content_overlayed",horror:"story__content_horror"},contentInner:{item:"story__content-inner",sliceByHeight:"story__content-inner_slice-by-height",sliceByBlock:"story__content-inner_slice-by-block"},cut:"story__cut",hiddenBlocksWrapper:"story__hidden-blocks",collapseButton:{button:"collapse-button",active:"collapse-button_active"},scrollTools:{item:"story__scroll",enabled:"story__scroll_enabled",disabled:"story__scroll_disabled"},highlight:{blink:"story__main_highlight_blink",item:"story__main_highlight_"},readMore:{button:"story__read-more",collapsed:"story__read-more_collapsed",label:"story__read-more-label"},block:"story-block",blocks:{image:"story-block_type_image",video:"story-block_type_video",text:"story-block_type_text"},viewed:{count:"story__views-count",loaded:"story__views-count_loaded"},moderator:{button:"story__mod",active:"story__mod_active"},parentLink:"story__parent-link",addCommentForm:{form:"story-add-comment",hidden:"story-add-comment_hidden",input:"story-add-comment__input",submit:"story-add-comment__submit",mention:"story-add-comment__mention"},adultOverlay:{el:"story__adult-overlay"}}},9895:(t,e,s)=>{"use strict";s.d(e,{Z:()=>a});s(2707),s(4944);var i=s(1014),n=s(1471),o=s(6553),r=s(8211);class a extends i.v{static getInstance(){return a._instance?a._instance:a._instance=new a}constructor(){super(),this._items={},this._focusedElement=null,this._viewTimes={},this._firstViewTimes={},this._viewStart=null;const t=(0,n.P)((()=>this._checkViewport()),100);document.addEventListener("scroll",t),document.addEventListener("visibilitychange",(()=>{"visible"===document.visibilityState?t():"hidden"===document.visibilityState&&(this.focusedElement=null)}))}addItems(t){Object.assign(this._items,t),Object.keys(t).forEach((t=>{this._viewTimes[t]=0})),this._checkViewport()}_checkViewport(){const t=Object.keys(this._items).map((t=>this._items[t].map((e=>{const s=e.getBoundingClientRect();return{element:t,rect:s}})))).flat().filter((t=>t.rect.bottom>o.VIEWPORT_START&&t.rect.top<o.VIEWPORT_LIMIT*r.vE.ui.windowHeight)).sort(((t,e)=>t.rect.bottom<=e.rect.bottom?1:-1));this.focusedElement=t.length?t[0].element:null}get focusedElement(){return this._focusedElement}set focusedElement(t){if(this._focusedElement===t)return;const e=(new Date).getTime();t&&!this._firstViewTimes[t]&&(this._firstViewTimes[t]=e),this._focusedElement&&this._viewStart&&(this._viewTimes[this._focusedElement]+=Number(((e-this._viewStart)/1e3).toFixed(3))),this._viewStart=t?e:null,this._focusedElement=t,this.emit("focused-element-change",t)}getViewTime(t){const e=this._viewStart&&this.focusedElement===t?((new Date).getTime()-this._viewStart)/1e3:0;return Number((this._viewTimes[t]+e).toFixed(3))}getFirstViewTime(t){return this._firstViewTimes[t]||(new Date).getTime()}}},8924:(t,e,s)=>{"use strict";s.d(e,{ll:()=>n,yX:()=>o,NP:()=>r,a8:()=>a});var i=s(7892);const n=new i.xs({ALL:"all",STORY:"story"}),o=new i.xs({ALL:1,PARTIAL:0,NONE:2}),r=new i.xs({[o.ALL.valueOf()]:"show_all",[o.PARTIAL.valueOf()]:"hide_part",[o.NONE.valueOf()]:"hide"}),a=new i.xs({ADD:1,DELETE:-1,CANCEL:0})},7725:(t,e,s)=>{"use strict";s.d(e,{yX:()=>o.yX,zG:()=>f,lX:()=>u,Hx:()=>h});s(8674);var i=s(2134),n=s(6889),o=s(8924);function r(t,e){var s=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),s.push.apply(s,i)}return s}function a(t,e,s){return e in t?Object.defineProperty(t,e,{value:s,enumerable:!0,configurable:!0,writable:!0}):t[e]=s,t}class l{static async _getDroplist(t,e){const s=performance.now();let n={};try{n=await i.cf.get("/ajax/tags_actions.php",function(t){for(var e=1;e<arguments.length;e++){var s=null!=arguments[e]?arguments[e]:{};e%2?r(Object(s),!0).forEach((function(e){a(t,e,s[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(s)):r(Object(s)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(s,e))}))}return t}({action:"droplist",value:t},e))}catch(l){console.error(l)}const o=Math.floor(performance.now()-s);if(o>1e3)try{i.cf.post("/ajax/slow_log.php",{t:o,value:t})}catch(l){console.error(l)}return n}static async getMarkupByName(t=""){let e="/tag?q=";""!==t&&(e+=encodeURIComponent(t));let{response:s,data:n}=await i.cf.get(e,{ajax_mode:"1"});if(!s.result)throw new Error(s.message);return n.html}static async getListByName(t="",e=0,s=0){let n={action:"search",type:"name",page:s,value:t,min_stories:e},{response:o,data:r}=await i.cf.get("/ajax/tags_merge_actions.php",n);if(!o.result)throw new Error(o.message);return{total:r.total,tags:r.result}}static async getBannedByName(t=0,e=""){const s={action:"getbadtags",fromRec:t,search:e};let{response:n,data:o}=await i.cf.post("/ajax/tags_merge_actions.php",s);if(!n.result)throw new Error(n.message);return o.result}static async searchMerge(t=""){t=t.trim().toLowerCase();let e=n.h.getInstance("searchTags");const s=l._getCacheKeyName(t);if(e.has(s))return e.get(s);const{response:i,data:o}=await l._getDroplist(t);return e.set(t,i.result?o.map((t=>({name:t[0],count:Number(t[1])}))):[])}static async searchTagsLine(t=""){let e=n.h.getInstance("searchTags");const s=l._getCacheKeyName(t);if(e.has(s))return e.get(s);let o=i.cf.get("/ajax/tags_actions.php",{action:"tagsline",value:t});return o=o.then((s=>e.set(t,s.response.result?s.data.tags.map((t=>({name:t[0],count:Number(t[1])}))):[]))),o}static async search(t="",e=o.ll.ALL){let s=n.h.getInstance("searchTags");const i=l._getCacheKeyName(t,e);if(s.has(i))return s.get(i);const{response:r,data:a}=await l._getDroplist(t,{filter:e.value});return s.set(t,r.result?a.map((t=>({name:t[0],count:Number(t[1])}))):[])}static hasSearchCache(t="",e=o.ll.ALL){let s=n.h.getInstance("searchTags");const i=l._getCacheKeyName(t,e);return s.has(i)&&!(s.get(i)instanceof Promise)}static _getCacheKeyName(t,e=o.ll.ALL){return e===o.ll.ALL?t:`${t}:${e.value}`}}const h=l;var c=s(8211),d=s(6349);const u=class{static async sendSuggestion(t,e){if(!t||!t.length||!e)throw new Error("Data is not correct");const s={action:"add",from:t.join(","),to:e};let{response:n,data:o}=await i.cf.post("/ajax/tags_merge_actions.php",s);if(!n.result)throw new Error(n.message);if(t.forEach(((t,s)=>{d.cp.getInstance().sendEvent("tags_merge_propose",{"tag_from!empty":t,"tag_to!empty":e,create_at:Date.now()+50*s},[d.b0.CLICKHOUSE])})),o)return{rules:o.result.rules,total:o.result.total}}static async validateSuggestion(t,e){if(!t||!t.length||!e)throw new Error("Data is not correct");const s={action:"validate",from:t.join(","),to:e};let{response:n,data:o}=await i.cf.post("/ajax/tags_merge_actions.php",s);if(!n.result)throw new Error(n.message);return o}static async rollbackRule(t){if(!t||"string"!=typeof t&&"number"!=typeof t)throw new Error("Rule id was not specified or has an invalid type");if(!c.ZP.config("modules.params").isModerator)throw new Error("Action available to moderators only");const e={action:"rollback",id:t};let{response:s,data:n}=await i.cf.post("/ajax/tags_merge_actions.php",e);if(!s.result)throw new Error(s.message);return!0}static async approveRule(t){if(!t||"string"!=typeof t&&"number"!=typeof t)throw new Error("Rule id was not specified or has an invalid type");if(!c.ZP.config("modules.params").isModerator)throw new Error("Action available to moderators only");const e={action:"approve",id:t};let{response:s,data:n}=await i.cf.post("/ajax/tags_merge_actions.php",e);if(!s.result)throw new Error(s.message);return n.result}static async disapproveRule(t){if(!t||"string"!=typeof t&&"number"!=typeof t)throw new Error("Rule id was not specified or has an invalid type");if(!c.ZP.config("modules.params").isModerator)throw new Error("Action available to moderators only");const e={action:"disapprove",id:t};let{response:s,data:n}=await i.cf.post("/ajax/tags_merge_actions.php",e);if(!s.result)throw new Error(s.message);return!0}static async remergeRule(t,e){if(!t||"string"!=typeof t&&"number"!=typeof t)throw new Error("Rule id was not specified or has an invalid type");if(!c.ZP.config("modules.params").isModerator)throw new Error("Action available to moderators only");const s={action:"remerge",id:t,to:e};let{response:n}=await i.cf.post("/ajax/tags_merge_actions.php",s);if(!n.result)throw new Error(n.message);return!0}static async cancelRejection(t,e){if(!t||!e)throw new Error("Data is not correct");if(!c.ZP.config("modules.params").isModerator)throw new Error("Action available to moderators only");const s={action:"cancel_disapprove",from:t,to:e};let{response:n}=await i.cf.post("/ajax/tags_merge_actions.php",s);if(!n.result)throw new Error(n.message);return!0}static async getRules(t,e=0,s=""){const n={action:"getrules",approved:t?"Y":"N",fromRec:e,search:s};let{response:o,data:r}=await i.cf.post("/ajax/tags_merge_actions.php",n);if(!o.result)throw new Error(o.message);return r.result}static async banTag(t){if(!t||"string"!=typeof t)throw new Error("Tag name was not specified or has an invalid type");let e={action:"addbadtag",tag:t},{response:s,data:n}=await i.cf.post("/ajax/tags_merge_actions.php",e);if(!s.result)throw new Error(s.message);return!0}static async unbanTag(t){if(!t||"string"!=typeof t)throw new Error("Tag name was not specified or has an invalid type");let e={action:"cancelbadtag",tag:t},{response:s,data:n}=await i.cf.post("/ajax/tags_merge_actions.php",e);if(!s.result)throw new Error(s.message);return!0}};var p=s(6572),m=s(2822);function _(t,e){var s=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),s.push.apply(s,i)}return s}function g(t,e,s){return e in t?Object.defineProperty(t,e,{value:s,enumerable:!0,configurable:!0,writable:!0}):t[e]=s,t}const v=s(9755);class f{static async ignore(t,e){let{response:s}=await i.cf.post("/ajax/tags_actions.php",{action:"ignore"+(e?"+":"-"),value:t});if(!s.result)throw new Error(s.message);return!0}static async subscribe(t,e,s={}){m.c.getInstance().sendEvent(e?"subscribe_to_tag":"unsubscribe",function(t){for(var e=1;e<arguments.length;e++){var s=null!=arguments[e]?arguments[e]:{};e%2?_(Object(s),!0).forEach((function(e){g(t,e,s[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(s)):_(Object(s)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(s,e))}))}return t}({tag_id:t},s));let{response:n}=await i.cf.post("/ajax/tags_actions.php",{action:"subs"+(e?"+":"-"),value:t});if(!n.result)throw new Error(n.message);return!0}static async info(){let{response:t,data:e}=await i.cf.post("/ajax/tags_actions.php",{action:"info"});if(!t.result)throw new Error(t.message);return e}static getListSubsIgnore(t=!1){let e=p.hG.getInstance("tags-info");if(!t&&e.has("info"))return e.get("info");let s=i.cf.get("/ajax/tags_actions.php",{action:"info"});return s=s.then((t=>e.set("info",t.response.result?t.data:{subs:[],ignore:[]}))),e.set("info",s)}static async checkTagStatus(t){let e=await this.info(),s=v.inArray(t,e.subs)>-1,i=v.inArray(t,e.ignore)>-1;return{ignore:!i,unignore:i,subscribe:!s,unsubscribe:s}}}},150:(t,e,s)=>{"use strict";s.d(e,{j:()=>i});const i=new(s(7892).xs)({DEFAULT:"",SUCCESS:"success",DANGER:"danger",WARNING:"warning",DARK:"dark"})},4002:(t,e,s)=>{"use strict";s.d(e,{E:()=>_,g:()=>f});s(4916),s(5306);var i=s(8211),n=s(4519),o=s(7591),r=s(7025),a=s(6572);const l="pkb_Cvd";var h=s(9050);var c=s(2822);const d=s(9755),u=s(6419),p=s(381);let m=new Date;class _ extends n.u1{constructor(t){super(),this._requestAnimation=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(t){window.setTimeout(t,1e3/24)},this._minDateProps={year:2010,month:8,day:0,momentDate:p("2010-09-01")},this._maxDateProps={year:m.getFullYear(),month:m.getMonth(),day:m.getDate(),momentDate:p()},this._isMobileView=i.vE.applicationType===o.Zq.MOBILE,this._useTouchEvent="ontouchstart"in document.documentElement,this._useTouchEvent||(this._useTouchEvent=i.vE.deviceType===o.me.MOBILE||i.vE.deviceType===o.me.TABLET),this._canvases=null,this._contexts=null,this._monthCache=null,this._dayCellSize=28,this._monthCacheKeys=null,this._renderCallback=this._renderCalendar.bind(this),this._interruptCallback=this._interrupt.bind(this),this._interruptTimer=null,this._displayMonth=null,this._timelineProps=null,this._timeLine=106.9,this._lastTimeLine=0,this._showButtonsPanel=!0,this._datesRangeMode=!1,this._width=450,this._calendarProps=null,this._needRedraw=!1,this._needMonthRedraw=!1,this._needTimelineRedraw=!1,this._ownEventHandlers=null,this._dayUnderPoiner=null,this._selectedRange=null,this._textWidthCache=null,this._skipRollerDrag=!1,this._gcTimer=0,this._initDates=null,this._errMsgBox=null,this._presetButtons=[],this._dateChangedCounter=0,this._initialDirection="right",this._scale=i.vE.ui.devicePixelRatio,u.isObject(t)&&this.setOptions(t)}set showButtonsPanel(t){this._showButtonsPanel=!0===t}get showButtonsPanel(){return this._showButtonsPanel}set datesRangeMode(t){this._datesRangeMode=!0===t}get datesRangeMode(){return this._datesRangeMode}set width(t){(t=Number(t))==t&&(this._width=Math.max(200,Math.min(1400,t)))}get width(){return this._width}set limitStart(t){let e=p(t);e.isValid()&&(this._minDateProps={year:Number(e.format("YYYY")),month:Number(e.format("MM"))-1,day:Number(e.format("DD")),momentDate:e})}set limitEnd(t){let e=p(t);e.isValid()&&(this._maxDateProps={year:Number(e.format("YYYY")),month:Number(e.format("MM"))-1,day:Number(e.format("DD")),momentDate:e})}set initialDirection(t){"left"!==t&&"right"!==t||(this._initialDirection=t)}setDate(t,e){let s=this._parseDate(t),i=e?this._parseDate(e):s;if(this._calendarProps)null===i&&(i=s),this._selectedRange={from:s,to:i,forceNewRange:!1},this._initDates={from:s,to:i},this.$els.date1.val(_._getFormattedDate(s)),this.$els.date2.val(_._getFormattedDate(i)),this._needRedraw=!0,this._needMonthRedraw=!0;else{if(null===s)return this._initDates=null,this;null===i&&(i=s),this._initDates={from:s,to:i}}return this}get selectedDatesCaption(){return this._getSelectionParams().caption}get selectedDates(){return this._getSelectionParams()}get isFullRangeSelected(){return this._getSelectionParams().caption===i.vE.i18n("calendar.captions.all-time")}addPresetButton(t,e,s){return this._presetButtons.push({caption:t,callback:e,pressed:!0===s}),this}getMinDate(){var t,e;let s=1970+~~((null===(t=this._timelineProps)||void 0===t?void 0:t.minTimeLine)/12),i=(null===(e=this._timelineProps)||void 0===e?void 0:e.minTimeLine)-12*(s-1970);return new Date(s,i,1,0,0,0,0)}setRangeByType(t,e=!0){let s,i,n=Date.now();if(this.$el||this._create(),c.c.getInstance().sendEvent("filter",{filter_type:"random"===t?"random_date":"date"}),e){switch(t){default:let t=1970+~~(this._timelineProps.minTimeLine/12),e=this._timelineProps.minTimeLine-12*(t-1970);s=new Date(t,e,1,0,0,0,0),i=new Date,this.$els.date1.val(_._getFormattedDate(s.getTime())).trigger("change","all_time"),this.$els.date2.val(_._getFormattedDate(n)).trigger("change","all_time");break;case"month":this.$els.date2.val(_._getFormattedDate(n)).change(),i=p().subtract(1,"months").toDate(),n=i.getTime(),this.$els.date1.val(_._getFormattedDate(n)).change();break;case"week":this.$els.date2.val(_._getFormattedDate(n)).change(),n-=6048e5,i=new Date(n),this.$els.date1.val(_._getFormattedDate(n)).change();break;case"today":i=new Date,s=_._getFormattedDate(n),this.$els.date2.val(s).change(),this.$els.date1.val(s).change();break;case"random":let o=_._generateRandomDay(this._minDateProps.momentDate.toDate());i=o,s=_._getFormattedDate(o.getTime()),this.$els.date1.val(s).trigger("change"),this.$els.date2.val(s).trigger("change")}this._easingTimeline(12*(i.getFullYear()-1970)+i.getMonth())}else{i=new Date;let e,o=this._filterDateInput(!1,!0,_._getFormattedDate(n));switch(t){default:let t=1970+~~(this._timelineProps.minTimeLine/12),i=this._timelineProps.minTimeLine-12*(t-1970),r=new Date(t,i,1,0,0,0,0);this._selectDateOneMode(r.getTime(),"from"),this._selectDateOneMode(o,"to");break;case"month":this._selectDateOneMode(o,"to");const a=p().subtract(1,"months").valueOf();e=_._getFormattedDate(a),o=this._filterDateInput(!1,!0,e),this._selectDateOneMode(o,"from");break;case"week":this._selectDateOneMode(o,"to"),e=_._getFormattedDate(n-6048e5),o=this._filterDateInput(!1,!0,e),this._selectDateOneMode(o,"from");break;case"today":s=_._getFormattedDate(Date.now()),this.$els.date1.length&&this.$els.date1.val(s).trigger("change");break;case"random":let l=_._generateRandomDay(this._minDateProps.momentDate.toDate());s=_._getFormattedDate(l.getTime()),this.$els.date1.length&&this.$els.date1.val(s).trigger("change")}}}static _formatDate(t,e){let s="0"+String(t.getDate()),n="0"+String(t.getMonth()+1),o=String(t.getFullYear());return"dd M yyyy"===e?s.substr(-2)+" "+i.vE.i18n("calendar.months."+t.getMonth())+" "+o:"yyyy-mm-dd"===e?o+"-"+n.substr(-2)+"-"+s.substr(-2):"dd-mm-yyyy"===e?s.substr(-2)+"-"+n.substr(-2)+"-"+o:""}render(){return this.$el||this._create(),super.render(),this}_create(){var t,e,s,n;this._prepareData(),this.$el=d((t={isMobile:this._isMobileView,width:this._width,isDatesRangeMode:this._datesRangeMode,showButtonsPanel:this._showButtonsPanel,presetButtons:this._presetButtons,dateFrom:this._datesRangeMode&&this._selectedRange.from?_._getFormattedDate(this._selectedRange.from):"",dateTo:this._datesRangeMode&&this._selectedRange.to?_._getFormattedDate(this._selectedRange.to):""},s="",n=h.escape,Array.prototype.join,s+='<div class="calendar '+(null==(e=t.isMobile?"calendar_mobile":"")?"":e)+'" style="width: '+(null==(e=t.width)?"":e)+'px">\n\t<div class="calendar-head">\n\t\t',t.isDatesRangeMode?(s+="\n\t\t\t",t.showButtonsPanel&&(s+='\n\t\t\t\t<div class="calendar-head__buttons">\n\t\t\t\t',t.presetButtons.length>0?(s+="\n\t\t\t\t\t",t.presetButtons.forEach((function(t,i){s+='\n\t\t\t\t\t\t<a data-type="preset"\n\t\t\t\t\t\t    data-idx="'+(null==(e=i)?"":e)+'"\n\t\t\t\t\t\t    class="calendar-head__button '+(null==(e=t.pressed?" calendar-head__button_selected":"")?"":e)+'">\n\t\t\t\t\t\t\t'+n(t.caption)+"\n\t\t\t\t\t\t</a>\n\t\t\t\t\t"})),s+="\n\t\t\t\t"):s+='\n\t\t\t\t\t<a class="calendar-head__button" data-type="all_time">всё время</a>\n\t\t\t\t\t<a class="calendar-head__button" data-type="month">месяц</a>\n\t\t\t\t\t<a class="calendar-head__button" data-type="week">неделю</a>\n\t\t\t\t',s+="\n\t\t\t\t</div>\n\t\t\t"),s+='\n\t\t\t<div class="calendar-head__form">\n\t\t\t\t<div class="input input_box input_inline">\n\t\t\t\t\t<input class="input__input" type="text" value="" maxlength="10"\n\t\t\t\t\t       value="'+n(t.dateFrom)+'"\n\t\t\t\t\t       data-type="from" placeholder="ДД/ММ/ГГГГ">\n\t\t\t\t</div>\n\t\t\t\t<span class="calendar-head__separator">&mdash;</span>\n\t\t\t\t<div class="input input_box input_inline">\n\t\t\t\t\t<input class="input__input" type="text" value="" maxlength="10"\n\t\t\t\t\t       value="'+n(t.dateTo)+'"\n\t\t\t\t\t       data-type="to" placeholder="ДД/ММ/ГГГГ">\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t'):(s+="\n\t\t\t",t.showButtonsPanel&&t.presetButtons.length>0&&(s+='\n\t\t\t\t<div class="calendar-head__buttons">\n\t\t\t\t\t',t.presetButtons.forEach((function(t,i){s+='\n\t\t\t\t\t<a data-type="preset"\n\t\t\t\t\t    data-idx="'+(null==(e=i)?"":e)+'"\n\t\t\t\t\t    class="calendar-head__button'+(null==(e=t.pressed?" calendar-head__button_selected":"")?"":e)+'">\n\t\t\t\t\t\t'+n(t.caption)+"\n\t\t\t\t\t</a>\n\t\t\t\t\t"})),s+="\n\t\t\t\t</div>\n\t\t\t"),s+='\n\t\t\t<div class="calendar-head__form">\n\t\t\t\t<div data-type="left" class="calendar-head__arrow calendar-head__arrow_left">\n\t\t\t\t\t<svg width="10" height="20">\n\t\t\t\t\t\t<path d="M8 2 L2 10 L8 18" fill="transparent" />\n\t\t\t\t\t</svg>\n\t\t\t\t</div>\n\t\t\t\t<div class="input input_box input_inline">\n\t\t\t\t\t<input class="input__input" type="text" value="" maxlength="10"\n\t\t\t\t\t       value="'+n(t.dateFrom)+'"\n\t\t\t\t\t       data-type="from" placeholder="ДД/ММ/ГГГГ">\n\t\t\t\t</div>\n\t\t\t\t<div data-type="right" class="calendar-head__arrow calendar-head__arrow_right">\n\t\t\t\t\t<svg width="10" height="20">\n\t\t\t\t\t\t<path d="M2 2 L8 10 L2 18" fill="transparent" />\n\t\t\t\t\t</svg>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t'),s+='\n\t</div>\n\t<div class="calendar-body">\n\t\t<canvas width="'+(null==(e=t.width)?"":e)+'" height="310"></canvas>\n\t</div>\n</div>\n')),this.$els={head:this.$(".calendar-head"),body:this.$(".calendar-body"),mainCanvas:this.$(".calendar-body canvas"),date1:this.$('input[data-type="from"]'),date2:this.$('input[data-type="to"]'),buttonAll:this.$('a[data-type="all_time"]'),buttonMonth:this.$('a[data-type="month"]'),buttonWeek:this.$('a[data-type="week"]')},this._createCanvas("body",this._width,310,this.$els.mainCanvas),this._setHeadEventListeners(),this._setBodyEventListeners(),this._datesRangeMode&&""===this.$els.date1.val()&&this.$el.find('a[data-type="all_time"]').addClass("calendar__button-selected"),this._interrupt(),this._renderCalendar(),this.listenTo(i.vE,"need-calendar-redraw",(()=>{this._needRedraw=!0,this._needMonthRedraw=!0,this._needTimelineRedraw=!0,this._renderCalendar()}))}_setHeadEventListeners(){let t=this.$els.head;t.find("a").on("click",(e=>{let s=d(e.target),i=s.data("type");switch(t.find("a").removeClass("calendar-head__button_selected"),i){case"all_time":case"month":case"week":case"today":this.setRangeByType(i);break;case"preset":this._presetButtons[Number(s.data("idx"))].callback();break;default:return}s.addClass("calendar-head__button_selected")})),this._datesRangeMode||t.find("div[data-type]").on("click",(t=>{let e,s=d(t.target).closest("div[data-type]"),i=this.$els.date1,n=i.val();if(""===n){let t=new Date;e=new Date(t.getFullYear(),t.getMonth(),t.getDate(),0,0,0,0).getTime(),i.val(_._getFormattedDate(e))}if(e=this._filterDateInput(i[0],!0),null!==e){switch(s.attr("data-type")){case"left":i.val(_._getFormattedDate(e-864e5));break;case"right":i.val(_._getFormattedDate(e+864e5));break;default:return}null===this._filterDateInput(i[0],!0)?i.val(n):i.change()}else i.val(n).change()})),t.find("input").on("keydown",(t=>{13===t.which&&d(t.target).blur()})).on("keypress",(t=>{t.which>=46&&t.which<58||8===t.which||0===t.which||t.preventDefault()})).on("blur change",((t,e=!1)=>{this._errMsgBox&&this._errMsgBox.isShown&&this._errMsgBox.hide();let s=this._filterDateInput(t.target);if(null!==s){let i="all_time"!==e;this._selectDate(s,d(t.target).data("type"),i),this._dateChangedCounter++}})).on("paste",(t=>{u.defer(this._filterDateInput.bind(this),t.target)}))}_filterDateInput(t,e,s=""){let n,o="";if(t&&(void 0===e&&(e=!1),""===(s=t.value.replace(/[^0-9\/]/gi,""))))return t.value="",0;if(/^[0-9]{1,2}\/[0-9]{1,2}\/[0-9]{2,4}$/.test(s)){n=s.match(/^([0-9]{1,2})\/([0-9]{1,2})\/([0-9]{2,4})$/);let e=parseInt(n[1]);if(e==e&&e>0&&e<=31){let s=Number(n[2]);if(s==s&&s>0&&s<=12){let r=Number(n[3]);if(r==r&&r<50&&(r+=2e3),r==r&&r>1970&&r<=3e3){let n=new Date(r,s-1,e,0,0,0,0);if(n.getDate()===e){let e=12*(r-1970)+(s-1);if(e>=this._timelineProps.minTimeLine&&e<=this._timelineProps.maxTimeLine){if(!(e===this._timelineProps.maxTimeLine&&n.getDate()>(new Date).getDate())){let e=n.getTime();return t&&(t.value=_._getFormattedDate(e)),e}o=i.vE.i18n("calendar.errors.overflow")}else o=i.vE.i18n("calendar.errors.overflow")}else o=i.vE.i18n("calendar.errors.invalid-date")}else o=i.vE.i18n("calendar.errors.invalid-year")}else o=i.vE.i18n("calendar.errors.invalid-month")}else o=i.vE.i18n("calendar.errors.invalid-day")}else o=i.vE.i18n("calendar.errors.invalid-format");if(""!==o&&!e){if(this._errMsgBox&&this._errMsgBox.isShown)return null;this._errMsgBox=new r._({direction:r.Lh.TOP,alignment:r.SE.START,theme:r.xb.DANGER,delayClose:200,indent:!0,target:d(t)}),this._errMsgBox.content="<span>"+o+"</span>",this._errMsgBox.show()}return null}_selectDate(t,e,s=!0){let i,n,o=_._getFormattedDate(t),r=this._selectedRange;void 0!==e?"from"===e?this._datesRangeMode?(0===t?(r.from=null,r.to=null):r.from=t,r.to||(r.to=t),this.$els.date2.val(_._getFormattedDate(r.to))):(r.from=r.to=t,o?this.$els.date1.val(o):this.$els.date1.val(_._getFormattedDate(new Date))):"to"===e&&(r.to=0===t?r.from:t,t>0&&!r.from&&(r.from=t),this.$els.date1.val(_._getFormattedDate(r.from))):this._datesRangeMode?null===r.from||r.forceNewRange?(r.forceNewRange=!1,r.from=t,r.to=t,this.$els.date1.val(o),this.$els.date2.length>0&&this.$els.date2.val(o)):r.from===r.to?(i=r.from,r.from=Math.min(i,t),r.to=Math.max(i,t),this.$els.date1.val(_._getFormattedDate(r.from)),this.$els.date2.length>0&&this.$els.date2.val(_._getFormattedDate(r.to))):(r.from=t,r.to=t,this.$els.date1.val(o),this.$els.date2.length>0&&this.$els.date2.val(o)):(r.from=r.to=t,this.$els.date1.val(o),c.c.getInstance().sendEvent("filter",{filter_type:"date"})),this._datesRangeMode&&null!==r.from&&r.from>r.to&&(i=r.from,r.from=Math.min(i,t),r.to=Math.max(i,t),this.$els.date1.val(_._getFormattedDate(r.from)),this.$els.date2.length>0&&this.$els.date2.val(_._getFormattedDate(r.to))),void 0===e||0===t||!s&&"to"!==e||(n=new Date,n.setTime(t),this._easingTimeline(12*(n.getFullYear()-1970)+n.getMonth())),this._needRedraw=!0,this._needMonthRedraw=!0,this._datesRangeMode&&this._dateChangedCounter>1&&this.$el.find(".calendar-head__button_selected").removeClass("calendar-head__button_selected"),this.emit("select",this._getSelectionParams())}_selectDateOneMode(t,e){let s,i=this._selectedRange;"from"===e?i.from=t:"to"===e&&(i.to=t,this.$els.date1.val(_._getFormattedDate(i.to))),"to"===e&&(s=new Date,s.setTime(t),this._easingTimeline(12*(s.getFullYear()-1970)+s.getMonth())),this._needRedraw=!0,this._needMonthRedraw=!0,this._datesRangeMode&&this._dateChangedCounter>1&&this.$el.find(".calendar-head__button_selected").removeClass("calendar-head__button_selected"),this.emit("select",this._getSelectionParams())}_setBodyEventListeners(){let t=this.$els.body[0],e=!1,s=!1,i=0,n=0,o=0,r=0,a=0,l=this._timelineProps;this._addEvent(t,this._useTouchEvent?"touchstart":"mousedown",(h=>{i=this._timeLine,r=n=h.realX||h.clientX||h.pageX,a=h.realY||h.clientY||h.pageY,e=!0,o=l.moveDeltaX=l.moveSpeed=0,l.easingTo=0,l.easingFrom=0,l.easingCurrent=0;let c=t.getBoundingClientRect(),d=r-c.left,u=a-c.top;if(s=!1,u>=l.y&&u<l.y+l.viewHeight){let t=l.rollerViewX+l.x;d>=t&&d<=t+l.rollerWidth&&(s=!0,this._skipRollerDrag=!1)}})),this._useTouchEvent||(this._addEvent(t,this._useTouchEvent?"touchmove":"mousemove",(s=>{let i="default";if(!e){r=s.realX||s.clientX||s.pageX,a=s.realY||s.clientY||s.pageY;let e=t.getBoundingClientRect(),n=r-e.left,o=a-e.top,h=this._getDateForPointer(n,o);if(h!==this._dayUnderPoiner&&(this._dayUnderPoiner=h,this._needRedraw=!0,h&&(i="pointer")),!h&&o>=l.y&&o<l.y+l.viewHeight){let t=l.rollerViewX+l.x;n>=t&&n<=t+l.rollerWidth&&(i="pointer")}}t.style.cursor!==i&&(t.style.cursor=i)})),this._addEvent(t,"mouseout",(()=>{this._dayUnderPoiner=null,this._needRedraw=!0}))),this._addEvent(t,this._useTouchEvent?"touchend":"click",(e=>{if(o>4)return;let s=t.getBoundingClientRect(),i=this._getDateForPointer((e.realX||e.clientX||e.pageX||r)-s.left,(e.realY||e.clientY||e.pageY||a)-s.top);i&&this._selectDate(i.date)})),this._addEvent(document,this._useTouchEvent?"touchmove":"mousemove",(t=>{if(e){r=t.realX||t.clientX||t.pageX,a=t.realY||t.clientY||t.pageY;let h=r-n;if(s){if(this._skipRollerDrag)return e=!1,void(s=!1);this._updateTimeline(i+h/l.scaleMonthStep,!0)}else l.moveDeltaX=-h/(8*this._dayCellSize),o+=Math.abs(h),this._updateTimeline(i+l.moveDeltaX,!0);t.preventDefault(),t.stopPropagation()}}),!0),this._addEvent(document,this._useTouchEvent?"touchend":"mouseup",(t=>{e&&(e=!1,s=!1,Math.abs(l.moveDeltaX)>.1&&(l.moveSpeed=l.moveDeltaX/2),t.preventDefault())}),!0)}_renderCalendar(){let t=this._requestAnimation;if(this._needRedraw){let t=this._displayMonth,e=this._contexts.body,s=this._canvases.body;e.fillStyle=i.vE.ui.css.colors.bg,e.rect(0,0,s.width,s.height),e.fill();for(let i=0,n=t.length;i<n;i++)this._drawMonth(t[i].month,e,t[i].x,0);this._drawTimeline(e),this._needRedraw=!1,this._needMonthRedraw=!1}t(this._renderCallback)}_drawTimeline(t){let e=this._timelineProps,s=e.viewWidth,n=e.viewHeight;if(!this._canvases.timeline||this._needTimelineRedraw){let t=this._createCanvas("timeline",e.fullWidth,n),s=e.from,o=e.yearStep,r=10,a=2,l=e.rollerWidth-4,h=e.rollerWidth/2;t.fillStyle=i.vE.ui.css.colors.caption,t.font="12px "+i.vE.ui.css.fontFamily;for(let i=0;i<e.years;i++)this._drawTextInCell(String(s+i),i*o,0,t,o,20);t=this._createCanvas("timeline_line",e.fullWidth,6),t.fillStyle=i.vE.ui.css.colors.border,t.beginPath(),t.moveTo(r+a,a),t.quadraticCurveTo(r,a/2,r+a,0),t.lineTo(e.viewWidth-a-r,0),t.quadraticCurveTo(e.viewWidth-r,a/2,e.viewWidth-a-r,a),t.lineTo(r+a,a),t.closePath(),t.fill(),t=this._createCanvas("timeline_roll",e.rollerWidth,e.rollerWidth+10),t.fillStyle=i.vE.ui.css.colors.green,t.beginPath(),t.arc(h,h,l/2,0,2*Math.PI),t.closePath(),t.fill(),this._needTimelineRedraw=!1}t.drawImage(this._canvases.timeline_line,e.x*this._scale,(e.y+15)*this._scale),t.drawImage(this._canvases.timeline,Math.max(0,e.timeLineViewScollX),0,Math.min(s,e.fullWidth)*this._scale,n,e.x*this._scale,(e.y+30)*this._scale,s*this._scale,n),t.drawImage(this._canvases.timeline_roll,(e.x+e.rollerViewX)*this._scale,e.y*this._scale)}_drawMonth(t,e,s,n){let o,r,a,l="month_"+t,h=this._dayCellSize,c=this._calendarProps,d=c.calWidth,u=c.calHeight,p=c.headSize,_=null,g=null,v=null,f=c.oneDayMs;if(!this._monthCache[l]||this._needMonthRedraw){let e,s,n=this._contexts[l]||this._createCanvas(l,d,u),c=1970+~~(t/12),p=t-12*(c-1970),y=new Date(c,p,1,0,0,0,0),b=0,w=1.5*h,E=null,S=null,C=this._timelineProps.minTimeLine,T=this._timelineProps.maxTimeLine,O=this._timelineProps.maxTime,k=this._timelineProps.minTime,I=y.getDay();for(n.clearRect(0,0,d,u),n.font="13px "+i.vE.ui.css.fontFamily,s=y.getTime()-(0===I?7:I)*f,m=new Date(s),this._drawWeekDays(n,0,w),w+=h,v=[],o=0;o<6;o++)for(r={startDate:null,endDate:null,startCell:0,endCell:0},v.push(r),e=0;e<7;e++)++b,a=m.setDate(m.getDate()+1),y.setTime(a),y.getMonth()===p&&t>=C&&t<=T&&a<=O&&a>=k&&a<=Date.now()?(n.fillStyle=i.vE.ui.css.colors.text,null!==this._selectedRange.from&&a>=this._selectedRange.from&&a<=this._selectedRange.to&&(n.fillStyle=i.vE.ui.css.colors.bg),null===E&&(E=b,_=a),S=b,g=a,null===r.startDate&&(r.startDate=a,r.startCell=e),r.endDate=a,r.endCell=e):n.fillStyle=i.vE.ui.css.colors.caption,this._drawTextInCell(String(y.getDate()),e*h,w+o*h,n);n.font="16px "+i.vE.ui.css.fontFamily,n.fillStyle=i.vE.ui.css.colors.green,this._drawTextInCell(i.vE.i18n("calendar.months."+p)+" "+String(c),0,0,n,7*h,2*h),this._monthCache[l]={startDate:_,endDate:g,startCell:E-1,endCell:S-1,weeks:v},this._monthCacheKeys.push(l)}else{let t=this._monthCache[l];_=t.startDate,g=t.endDate,v=t.weeks}if(null!==this._selectedRange.from){let t,a,l,c,d=this._selectedRange.from,u=this._selectedRange.to;if(d<=g&&u>=_)for(t=_<d?d:_,a=g>u?u:g,e.fillStyle=i.vE.ui.css.colors.green,o=0;o<6;o++)if(r=v[o],null!==r.startDate&&t<=r.endDate&&a>=r.startDate){if(l=~~((t-r.startDate)/f),l<0)l=r.startCell;else{if(l>6)continue;l+=r.startCell}if(c=~~((r.endDate-a)/f),c<=0)c=r.endCell;else{if(c>r.endCell)continue;c=r.endCell-c}this._drawDayHighlight(e,s+~~(l*h),n+~~(p+o*h),c-l+1),e.fill()}}this._dayUnderPoiner&&this._dayUnderPoiner.name===l&&(null!==this._selectedRange.from&&this._dayUnderPoiner.date>=this._selectedRange.from&&this._dayUnderPoiner.date<=this._selectedRange.to?(e.fillStyle=i.vE.ui.css.colors.green,e.strokeStyle=i.vE.ui.css.colors.green):(e.fillStyle=i.vE.ui.css.colors.bg,e.strokeStyle=i.vE.ui.css.colors.green),this._drawDayHighlight(e,s+this._dayUnderPoiner.cell_x*h,n+~~(p+this._dayUnderPoiner.cell_y*h),1),e.fill(),e.stroke()),e.drawImage(this._canvases[l],s*this._scale,n*this._scale)}_drawWeekDays(t,e,s){if(!this._canvases.weekdays){let t,e=this._dayCellSize,s=this._createCanvas("weekdays",7*e,e);for(s.scale(1/this._scale,1/this._scale),s.fillStyle=i.vE.ui.css.colors.caption,s.font="12px "+i.vE.ui.css.fontFamily,t=0;t<7;t++)this._drawTextInCell(i.vE.i18n("calendar.weekdays."+t),t*e,0,s,e,e)}t.drawImage(this._canvases.weekdays,e,s)}_drawTextInCell(t,e,s,i,n,o){void 0===n?o=n=this._calendarProps.cellSize2:(n/=2,o/=2);let r=n,a=o,l=this._textWidthCache[t+"_"+i.font];void 0===l&&(this._textWidthCache[t+"_"+i.font]=l=i.measureText(t).width/2),i.fillText(t,~~(e+(r-l)),~~(s+a))}_drawDayHighlight(t,e,s,i){if(e*=this._scale,s*=this._scale,1===i){let i=this._dayCellSize/2*this._scale;t.beginPath(),t.arc(e+i,s+i,i,0,2*Math.PI),t.closePath()}else{let n=this._dayCellSize*this._scale,o=n/2,r=i*n;s++,n-=2,t.beginPath(),t.moveTo(e,s+o),t.quadraticCurveTo(e,s,e+o,s),t.lineTo(e+r-o,s),t.quadraticCurveTo(e+r,s,e+r,s+o),t.lineTo(e+r,s+n-o),t.quadraticCurveTo(e+r,s+n,e+r-o,s+n),t.lineTo(e+o,s+n),t.quadraticCurveTo(e,s+n,e,s+n-o),t.lineTo(e,s+o),t.closePath()}}_createCanvas(t,e,s,n){let o=n?n[0]:document.createElement("canvas");o.width=e*this._scale,o.height=s*this._scale,o.style.height=s+"px",o.style.width=e+"px",this._canvases[t]=o;let r=o.getContext("2d");return r.font="14px "+i.vE.ui.css.fontFamily,r.textBaseline="middle",r.lineWidth=2,"body"!==t&&r.scale(this._scale,this._scale),this._contexts[t]=r,r}_addEvent(t,e,s,i){if(!t.addEventListener)return;let n=t=>{this._useTouchEvent?void 0!==t.touches&&(t.touches.length>0&&(t.realX=t.touches[0].clientX,t.realY=t.touches[0].clientY),s(t)):s(t)};t.addEventListener(e,n,{passive:!1,capture:!0===i}),this._ownEventHandlers.push({obj:t,event:e,handler:n,capture:!0===i})}_prepareData(){let t,e,s=this._dayCellSize,i=new Date,n=this._minDateProps.year,o=this._maxDateProps.year,r=this._width;this._canvases={},this._contexts={},this._monthCache={},this._monthCacheKeys=[],this._displayMonth=[],this._ownEventHandlers=[],this._textWidthCache={},this._gcTimer=40,this._selectedRange={from:null,to:null,forceNewRange:!1},e=this._calendarProps={},e.calWidth=7*s,e.calHeight=9*s,e.headSize=2.5*s,e.cellSize2=s/2,e.oneDayMs=864e5,this._initDates&&(i=new Date(this._initDates.from),this._selectedRange.from=this._initDates.from,this._selectedRange.to=this._initDates.to,this._selectedRange.forceNewRange=!0),this._timeLine=12*(i.getFullYear()-1970)+i.getMonth(),e=this._timelineProps={},e.from=n,e.to=o,e.years=o-n+1,e.yearStep=~~(2.3*s),e.fullWidth=e.yearStep*e.years,e.viewHeight=40,e.viewHeight2=e.viewHeight/2,e.viewWidth=Math.min(e.fullWidth,~~(.8*r/e.yearStep)*e.yearStep),e.x=~~((r-e.viewWidth)/2),e.y=this._calendarProps.calHeight-5,e.minTimeLine=12*(n-1970)+this._minDateProps.month,e.maxTimeLine=12*(o-1970)+(new Date).getMonth(),e.minTime=new Date(n,this._minDateProps.month,this._minDateProps.day,0,0,0,0),e.maxTime=new Date,e.viewTimeLineFrom=0,e.viewTimeLineTo=Number.MAX_VALUE,e.timeLineScrollYears=0,e.timeLineScrollYearsCurr=0,e.timeLineScrollYearsForm=0,e.timeLineScrollYearsCounter=0,e.timeLineViewScollX=0,e.timeLineViewYears=~~(e.viewWidth/e.yearStep),e.rollerWidth=30,e.rollerViewX=0,e.scaleWidth=e.fullWidth-e.rollerWidth,e.scaleMonthStep=e.scaleWidth/(this._maxDateProps.momentDate.diff(this._minDateProps.momentDate,"months")||12*e.years-1),e.easingTo=0,e.easingCurrent=0,e.easingFrom=0,e.moveSpeed=0,e.moveDeltaX=0,this._updateTimeline(this._timeLine,!0,!0),t=this._timeLine,this._timeLine=this._timeLine+("right"===this._initialDirection?-2:2),this._easingTimeline(t)}_easingTimeline(t){let e=this._timelineProps;t!==this._timeLine&&(e.easingTo=t,e.easingFrom=this._timeLine,e.easingCurrent=0,e.moveSpeed=0)}_getSelectionParams(){let t,e,s=this._selectedRange,n=this._calendarProps,o=!1;if(s||(s=this._initDates),e={caption:"",startDate:"",start:null,endDate:"",end:null},n&&null!==s.from){t=new Date;let e=1970+~~(this._timelineProps.minTimeLine/12),i=this._timelineProps.minTimeLine-12*(e-1970),n=new Date(e,i,1,0,0,0,0).getTime(),r=new Date(t.getFullYear(),t.getMonth(),t.getDate(),0,0,0,0).getTime();o=s.from===n&&s.to===r}return!s||null===s.from||o?(e.caption=i.vE.i18n("calendar.captions.all-time"),e.startDate="",e.endDate=""):s.from===s.to?0===s.from&&0===s.to?e.start=e.end=new Date:(t=new Date,t.setTime(s.from),e.caption=this._prependZeroForDay(t)+" "+i.vE.i18n("calendar.months2."+t.getMonth())+" "+t.getFullYear(),e.start=e.end=t,e.startDate=e.endDate=_._getFormattedDate(s.from,!0)):(t=new Date,t.setTime(s.from),e.caption=this._prependZeroForDay(t)+" "+i.vE.i18n("calendar.months2."+t.getMonth())+" "+t.getFullYear(),e.startDate=_._getFormattedDate(s.from,!0),e.start=new Date(t.getTime()),t.setTime(s.to),e.caption+=" - "+this._prependZeroForDay(t)+" "+i.vE.i18n("calendar.months2."+t.getMonth())+" "+t.getFullYear(),e.endDate=_._getFormattedDate(s.to,!0),e.end=t),e}_prependZeroForDay(t){return String(t.getDate()).padStart(2,"0")}_updateTimeline(t,e,s){let i=this._timelineProps;if(void 0!==t?(t=e?Math.max(Math.min(t,i.viewTimeLineTo),i.viewTimeLineFrom):Math.max(Math.min(t,i.maxTimeLine),i.minTimeLine),this._timeLine=t):t=this._timeLine,s){let e=!0;for(;e;)e=!1,i.viewTimeLineFrom=Math.max(i.minTimeLine+12*i.timeLineScrollYearsCurr,i.minTimeLine),i.viewTimeLineTo=Math.min(i.viewTimeLineFrom+12*i.timeLineViewYears,i.maxTimeLine),t<i.viewTimeLineFrom+2&&i.timeLineScrollYears>=1?(i.timeLineScrollYears=Math.max(i.timeLineScrollYears-2,0),e=!0):t>i.viewTimeLineTo-2&&i.timeLineScrollYears<=i.years-i.timeLineViewYears-1&&(i.timeLineScrollYears=Math.min(i.timeLineScrollYears+2,i.years-i.timeLineViewYears),e=!0),i.timeLineScrollYearsCurr=i.timeLineScrollYears}else 0===i.timeLineScrollYearsCounter&&(t<i.viewTimeLineFrom+2&&i.timeLineScrollYears>=1?(i.timeLineScrollYears=Math.max(i.timeLineScrollYears-2,0),i.timeLineScrollYearsForm=i.timeLineScrollYearsCurr,i.timeLineScrollYearsCounter=20,this._skipRollerDrag=!0):t>i.viewTimeLineTo-2&&i.timeLineScrollYears<=i.years-i.timeLineViewYears-1&&(i.timeLineScrollYears=Math.min(i.timeLineScrollYears+2,i.years-i.timeLineViewYears),i.timeLineScrollYearsForm=i.timeLineScrollYearsCurr,i.timeLineScrollYearsCounter=20,this._skipRollerDrag=!0));i.timeLineViewScollX=~~(i.timeLineScrollYearsCurr*i.yearStep)*this._scale,i.viewTimeLineFrom=Math.max(i.minTimeLine+12*i.timeLineScrollYearsCurr,i.minTimeLine),i.viewTimeLineTo=Math.min(i.viewTimeLineFrom+12*i.timeLineViewYears,i.maxTimeLine),i.rollerViewX=~~((t-i.minTimeLine)*i.scaleMonthStep)-i.timeLineViewScollX/this._scale}_interrupt(){let t=this._timelineProps;if(clearTimeout(this._interruptTimer),0!==t.moveDeltaX){let e=t.moveDeltaX;e>0?(e-=.3,e<0&&(e=0)):e<0&&(e+=.3,e>0&&(e=0)),t.moveDeltaX=e}if(t.easingTo>0&&t.easingTo!==this._timeLine)this._timeLine=_._easing("cubic",++t.easingCurrent,t.easingFrom,t.easingTo,20);else if(0!==t.moveSpeed){let e=t.moveSpeed;e>0?(e-=.1*e,e<.05&&(e=0)):e<0&&(e+=.1*-e,e>-.05&&(e=0)),this._timeLine+=e,t.moveSpeed=e}if(this._lastTimeLine!==this._timeLine){this._updateTimeline(this._timeLine);let t,e=this._dayCellSize,s=this._timeLine,i=~~s,n=e/2,o=8*e,r=o/2,a=this._width/2,l=4+~~(this._width/o),h=-(s-i)*o,c=new Array(l),d=i-~~(l/2);for(t=0;t<l;t++)c[t]={name:"month_"+(d+t),month:d+t,x:a-l*r+t*o+n+h};this._displayMonth=c,this._needRedraw=!0,this._lastTimeLine=this._timeLine}t.timeLineScrollYears!==t.timeLineScrollYearsCurr&&(t.timeLineScrollYearsCounter>0?t.timeLineScrollYearsCurr=_._easing("cubic",20- --t.timeLineScrollYearsCounter,t.timeLineScrollYearsForm,t.timeLineScrollYears,20):t.timeLineScrollYearsCurr=t.timeLineScrollYears,this._updateTimeline(),this._needRedraw=!0),0==--this._gcTimer&&(this._removeUnusedMonths(),this._gcTimer=40),this._interruptTimer=setTimeout(this._interruptCallback,1e3/24)}_removeUnusedMonths(){let t,e,s=this._monthCacheKeys,i=this._displayMonth;if(!(this._monthCacheKeys.length<=this._displayMonth.length))for(let n=0,o=s.length;n<o;n++){t=!1,e=s[n];for(let s=0,n=i.length;s<n;s++)if(e===i[s].name){t=!0;break}t||(delete this._monthCache[e],delete this._canvases[e],delete this._contexts[e],s.splice(n,1),n--,o--)}}_getDateForPointer(t,e){let s,i,n,o,r,a,l=this._displayMonth,h=this._dayCellSize,c=this._monthCache,d=this._calendarProps,u=d.calWidth,p=d.calHeight,m=d.headSize,_=d.oneDayMs;for(let g=0,v=l.length;g<v;g++)if(s="month_"+l[g].month,i=l[g].x,t>=i&&t<=i+u&&e<=0+p&&e>=0+m&&c[s]&&(n=~~((t-i)/h),o=~~((e-0-m)/h),r=7*o+n,a=c[s],r>=a.startCell&&r<=a.endCell))return{name:s,cell_x:n,cell_y:o,cell_no:r,date:a.startDate+_*(r-a.startCell)};return null}static _easing(t,e,s,i,n){let o=.5*Math.PI,r=2*Math.PI,a=s>i,l=s;switch(a?(l=i,i=s-i,s=l):i-=s,t){default:l=i*e/n+s;break;case"cubic":l=a?i*(e/=n)*e*e+s:i*((e=e/n-1)*e*e+1)+s;break;case"exponential":l=0===e?s:i*Math.pow(2,10*(e/n-1))+s-.001*i,e===n&&(l=i+s);break;case"sine":l=a?-i*Math.cos(e/n*o)+i+s:i*Math.sin(e/n*o)+s;break;case"bounce":l=(e/=n)<1/2.75?i*(7.5625*e*e)+s:e<2/2.75?i*(7.5625*(e-=1.5/2.75)*e+.75)+s:e<2.5/2.75?i*(7.5625*(e-=2.25/2.75)*e+.9375)+s:i*(7.5625*(e-=2.625/2.75)*e+.984375)+s;break;case"elastic":if(0===e)l=s;else if(1==(e/=n))l=s+i;else{let t=.3*n,o=t/4;l=i*Math.pow(2,-10*e)*Math.sin((e*n-o)*r/t)+i+s}}return a&&(l=s+(i+s-l)),l}_parseDate(t){let e,s,i=new Date,n=new Date(this._maxDateProps.year,this._maxDateProps.month,this._maxDateProps.day,0,0,0,0).getTime(),o=new Date(this._minDateProps.year,this._minDateProps.month-1,1,0,0,0,0).getTime();if(/^[0-9]{4}-[0-9]{2}-[0-9]{2}$/.test(t)){s=t.match(/^([0-9]{4})-([0-9]{2})-([0-9]{2})$/);let r=Math.min(i.getFullYear(),Math.max(parseInt(s[1]),this._minDateProps.year)),a=Math.min(12,Math.max(1,parseInt(s[2]))),l=Math.max(1,Math.min(31,parseInt(s[3])));if(e=new Date(r,a-1,l,0,0,0,0),e)return Math.min(n,Math.max(o,e.getTime()))}return null}static _getFormattedDate(t,e){let s,i,n,o=new Date;if(0===t||null===t)return"";for(o.setTime(t),s=String(o.getDate());s.length<2;)s="0"+s;for(i=String(o.getMonth()+1);i.length<2;)i="0"+i;for(n=String(o.getFullYear());n.length<4;)n="0"+n;return!0!==e?s+"/"+i+"/"+n:n+"-"+i+"-"+s}static _generateRandomDay(t){var e;let s,i=Date.now(),n=Math.max(new Date(2011,0,15).getTime(),null!==(e=null==t?void 0:t.getTime())&&void 0!==e?e:0),o=i-n-864e5,r=0,h=new Date,c=a.mM.get(l)||{};for(;++r<1e3&&(h.setTime(n+Math.round(Math.random()*o)),s=_._formatDate(h,"dd-mm-yyyy"),c[s]););return c[s]=!0,a.mM.set(l,c),h}}var g=s(381),v=s.n(g);function f(t,e,s){if(!t||!e)return;const i=Date.now(),n=new Date(i),o=new Date(i-6048e5),r=v()().subtract(1,"months").toDate(),a=v()(t);return v()(e).isSame(n,"day")?a.isSame(n,"day")?"today":a.isSame(o,"day")?"week":a.isSame(r,"day")?"month":a.isSame(s,"day")?"all_time":void 0:void 0}},7585:(t,e,s)=>{"use strict";s.d(e,{e:()=>i,y:()=>n});const i="pkb_tc_visited",n="pkb_surc"},4951:(t,e,s)=>{"use strict";s.d(e,{K:()=>d});var i=s(8211),n=s(4877),o=s(9161),r=s(7025),a=s(9050);function l(t){var e,i="",n=a.escape;Array.prototype.join;s(8211).vE;if(i+='\n\n<div class="popup-menu">\n\t',t.isSubMenu){i+="\n\t\t\x3c!-- ";for(let e=0;e<t.items.length;e++)i+='\n\t\t<div class="dots-meunu__item" data-community-id="'+n(t.items[e].id)+'" data-role="community">\n\t\t\t<img class="item__avatar" src="'+n(t.items[e].avatar)+'" alt="'+n(t.items[e].name)+'">\n\t\t\t<span class="item__group-name">'+n(t.items[e].name)+"</span>\n\t\t</div>\n\t\t";i+=' --\x3e\n\t\t<div data-id="'+n(item.id)+'" class="popup-menu__item">\n\t\t\t',item.template?i+="\n\t\t\t\t"+(null==(e=item.template)?"":e)+"\n\t\t\t":i+="\n\t\t\t\t"+n(item.title)+"\n\t\t\t",i+="\n\t\t</div>\n\t"}else i+="\n\t\t",t.items.forEach((function(t){i+='\n\t\t\t<div data-id="'+n(t.id)+'" class="popup-menu__item">\n\t\t\t\t',t.template?i+="\n\t\t\t\t\t"+(null==(e=t.template)?"":e)+"\n\t\t\t\t":i+="\n\t\t\t\t\t"+n(t.title)+"\n\t\t\t\t",i+="\n\t\t\t</div>\n\t\t"})),i+="\n\t";return i+="\n</div>"}var h=s(9738);function c(t,e,s){return e in t?Object.defineProperty(t,e,{value:s,enumerable:!0,configurable:!0,writable:!0}):t[e]=s,t}class d extends n.u{constructor(t){super(t),c(this,"menuStack",[]),c(this,"handleMenuItemClick",((t,e)=>{var s;const i=t.currentTarget.dataset.id,n=e.find((t=>String(t.id)===i));null!=n&&null!==(s=n.submenu)&&void 0!==s&&s.instance&&n.submenu.instance.show(),this.emit("onItemClick",n)})),this.show()}render(){return!this.isRendered&&this.el&&this._options.items.length?(this.el.addEventListener("click",(()=>{this.menu.show(),this.menuStack.push(this.menu)})),super.render(),this):this}closeAllMenus(){this.menuStack.forEach((t=>t.hide()))}updateItems(t){this._options.items=t,this.menu.content=l({items:this._options.items})}initSubmenu(t){var e;if(!t)return;if(null===(e=t.items)||void 0===e||!e.length)return;const s=this.menu.content.find(`[data-id="${t.parent.id}"`);t.instance=new r._({direction:i.vE.isMobileApp?r.Lh.BOTTOM:r.Lh.LEFT,alignment:i.vE.isMobileApp?r.SE.CENTER:r.SE.START,autoCloseOutsideClick:!0,destroyAfterHide:!1,popupNonOverflow:!0,indent:!1,target:i.vE.isMobileApp?document.body:s,useLayerForClickAway:!0,showDarkOverlay:i.vE.isMobileApp,showArrow:!1,autoCorrectPosition:!i.vE.isMobileApp,bottomPosition:i.vE.isMobileApp?"16px":"",leftPosition:i.vE.isMobileApp?"16px":"",content:l({items:t.items,isSubmenu:!0})}),this.initMenuListeners(t.instance,t.items,s)}initMenuListeners(t,e,s){this.listenTo(t,o.e.UNMOUNTED,(()=>{var t;this.menuStack.splice(this.menuStack.length-1,1),null===(t=s||this.$el)||void 0===t||t.removeClass(s?"popup-menu__item_active":"dots-menu_active")})),this.listenTo(t,o.e.MOUNTED,(()=>{var e;this.menuStack.push(t),null===(e=s||this.$el)||void 0===e||e.addClass(s?"popup-menu__item_active":"dots-menu_active")})),t.content.on("click",".popup-menu__item",(t=>{this.handleMenuItemClick(t,e)})),t.content.on("click",".button",(()=>{this.closeAllMenus()}))}get menu(){if(this._menu)return this._menu;const t={direction:r.Lh.BOTTOM,isModalMenu:!0,alignment:i.vE.isMobileApp?r.SE.CENTER:r.SE.END,autoCloseOutsideClick:!0,destroyAfterHide:!1,popupNonOverflow:!0,indent:!1,target:i.vE.isMobileApp?document.body:this.$el,useLayerForClickAway:!0,showDarkOverlay:i.vE.isMobileApp,showArrow:!i.vE.isMobileApp,autoCorrectPosition:!1,bottomPosition:i.vE.isMobileApp?"16px":"",leftPosition:i.vE.isMobileApp?"16px":"",content:l({items:this._options.items})};return i.vE.isMobileApp?(this._menu=new r.LD(t),this._menu.addButtonIntoFooter("Закрыть",(()=>this._menu.hide()))):this._menu=new r._(t),this._options.items.filter((t=>(0,h.K)(t.submenu))).forEach((t=>{t.submenu&&(t.submenu.parent=t,t.submenu.init=t=>this.initSubmenu(t))})),this.initMenuListeners(this._menu,this._options.items),this._menu}}},7686:(t,e,s)=>{"use strict";let i,n;s.d(e,{n:()=>i,$:()=>n}),function(t){t.SELECT="dropdownSelect",t.SET="dropdownSet",t.SEARCH_START="dropdownStart",t.SEARCH_END="dropdownEnd",t.CURRENT="dropdownCurrent"}(i||(i={})),function(t){t[t.PREDEFINED=0]="PREDEFINED",t[t.REQUEST=1]="REQUEST"}(n||(n={}))},1916:(t,e,s)=>{"use strict";s.d(e,{U:()=>i.U,nT:()=>n.n});s(5012);var i=s(4706),n=s(7686)},1642:(t,e,s)=>{"use strict";s.d(e,{X:()=>n});s(6992),s(3948);var i=s(2906);class n extends i.Lo{constructor(t){super(t||{}),this.el=void 0,this.els={},this.on("current",this._updateCurrent),this.on(i.u$.REMOVE,this._onRemove)}render(){if(this.el)return this.el;let t;return t=this.el=document.createElement("div"),t.classList.add("dropdown-item"),t.setAttribute("data-id",this.id),this.el}_onRemove(){this.data.current=!1,this.el&&this.el.parentNode&&this.el.parentNode.removeChild(this.el)}_updateCurrent(t,e){this.el&&this.el.parentNode&&this.el.classList.toggle("dropdown-item_current",e)}destroy(...t){this.isDestroyed||this.marks.has("isPredefined")||(this._onRemove(),super.destroy(...t))}}n.prototype.defaults={label:"",info:"",current:!1}},4706:(t,e,s)=>{"use strict";s.d(e,{U:()=>n,VV:()=>l});var i=s(1642);class n extends i.X{render(){if(this.el)return this.el;let t,e;return super.render(),t=this.els.label=document.createElement("div"),t.classList.add("dropdown-item__label"),t.textContent=this.data.name,this.el.appendChild(t),this.data.count&&(e=this.els.count=document.createElement("div"),e.classList.add("dropdown-item__info"),e.textContent=this.data.count,this.el.appendChild(e)),this.el}}n.prototype.fieldId="name",n.prototype.defaults={count:0,current:!1};var o=s(8799);class r extends i.X{render(){if(this.el)return this.el;let t=this.el=o.Zv.fragment((e=this.data,i="",Array.prototype.join,i+='<div class="community">\n\t<div class="community-avatar"><img src="'+(null==(s=e.avatar)?"":s)+'" alt=""></div>\n\t<div class="community__wrapper">\n\t\t<div class="community__title">\n\t\t\t',e.is_nsfw&&(i+='\n\t\t\t\t<span class="text-muted">[NSFW]</span>\n\t\t\t'),i+="\n\t\t\t<a>"+(null==(s=e.name)?"":s)+'</a>\n\t\t</div>\n\t\t<div class="community__information caption">\n\t\t\t<span>'+(null==(s=e.stories)?"":s)+"</span> • <span>"+(null==(s=e.subs)?"":s)+"</span>\n\t\t</div>\n\t</div>\n</div>\n")).firstChild;var e,s,i;return t.classList.add("dropdown-item"),t.setAttribute("data-id",this.id),this.el}}r.prototype.fieldId="id",r.prototype.defaults={avatar:"",name:"",current:!1,subs:"",stories:"",link:"",tags:void 0,is_nsfw:!1};var a=s(9050);class l extends i.X{render(){return this.el||(super.render(),this.el.innerHTML=function(t){var e="",i=a.escape;Array.prototype.join;const{GROUP_AVATAR_CODE:n}=s(8881),o=t.avatar80||t.avatar;return e+='\n<div class="dropdown-item__icon avatar avatar_small avatar_square '+i("string"!=typeof o?"avatar_default":"")+'">\n    ',"string"==typeof o&&(e+="\n        ",e+=o===n?'\n            <div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon--ui__group-avatar"><use xlink:href="#icon--ui__group-avatar"></use></svg></div>\n        ':'\n            <img src="'+i(o)+'" />\n        ',e+="\n    "),e+='\n</div>\n<div class="user__nick dropdown-item__label">\n    '+i(t.name)+"\n    ",(t.is_approved||t.approval)&&(e+='\n        <div class="user__label"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon--ui__approved"><use xlink:href="#icon--ui__approved"></use></svg></div>\n    '),e+="\n    ",t.role&&(e+='\n    <span class="caption dropdown-item__user-role">\n        '+i(t.role)+"\n    </span>\n    "),e+"\n</div>\n\n"}(this.data)),this.el}search(t){return t.test(this.data.name)}}l.prototype.defaults={name:"",avatar:"",avatar80:"",is_approved:!1,approval:"",current:!1};class h extends l{render(){if(this.el)return this.el;super.render();let t=document.createElement("div");return t.classList.add("dropdown-item__info"),t.textContent=this.data.is_developer?"разработчик":"модератор",this.el.appendChild(t),this.el}search(t){return t.test(this.data.name)}}h.prototype.fieldId="id",h.prototype.defaults={avatar:"",avatar80:"",name:"",is_developer:!1,current:!1};class c extends i.X{render(){return this.el||(this.el=document.createElement("hr")),this.el}}c.prototype.isSeparator=!0,c.prototype.defaults={current:!1};class d extends i.X{render(){return this.el||(this.el=document.createElement("h4"),this.el.textContent=this.data.title||"Header"),this.el}}d.prototype.isSeparator=!0,d.prototype.defaults={current:!1,title:void 0};class u extends i.X{render(){if(this.el)return this.el;let t,e,s;return super.render(),t=document.createElement("div"),t.classList.add("dropdown-item__icon","community-avatar","community-avatar_small"),"string"==typeof this.data.avatar?(s=document.createElement("img"),s.setAttribute("src",this.data.avatar),t.appendChild(s)):t.classList.add("community-avatar__default"),this.el.appendChild(t),e=document.createElement("div"),e.classList.add("community__title","dropdown-item__label"),e.textContent=this.data.name,this.el.appendChild(e),this.el}search(t){return t.test(this.data.name)}}u.prototype.fieldId="id",u.prototype.defaults={avatar:"",name:"",current:!1};class p extends i.X{render(){if(this.el)return this.el;super.render();let t=document.createElement("i");return t.classList.add("caption"),t.innerHTML="Показать все результаты",this.el.appendChild(t),this.el}}p.prototype.defaults={current:!1};s(226)},226:(t,e,s)=>{"use strict";s.d(e,{v:()=>n});var i=s(1642);class n extends i.X{render(){if(this.el)return this.el;let t,e;return super.render(),t=this.els.label=document.createElement("div"),t.classList.add("dropdown-item__label"),t.textContent=this.data.name,this.el.appendChild(t),this.el.setAttribute("data-type","profession"),this.data.users_count&&(e=this.els.count=document.createElement("div"),e.classList.add("dropdown-item__info"),e.textContent=this.data.users_count,this.el.appendChild(e)),this.el}}n.prototype.fieldId="name",n.prototype.defaults={name:"",users_count:0,current:!1}},5012:(t,e,s)=>{"use strict";s.d(e,{v:()=>l});s(8674);var i=s(8211),n=s(4519),o=s(7686),r=s(1712);s(9755);const a=s(6419);class l extends n.u1{constructor(t={}){super(t),this.show()}render(){if(this.isRendered)return this;const{UITextArea:t,UIDropDownProfessions:e}=this.useRegistry();if(this._textarea=new t(this.$el),this._dropdown=new e({closeAfterSelect:this.closeAfterSelect}),i.vE.isMobileApp)this._initMobileDropdown();else{const t=this._textarea.value;this._textarea.suggestion=this._dropdown,this.listenTo(this._dropdown,o.n.SET,(e=>{e.size||(this._textarea.value&&this._textarea.value.length>this._dropdown.minQueryLength&&this._dropdown.show(),""===this._textarea.value&&t&&(this._dropdown.hide(),this._onChangeProfession(this._textarea.value)))})),this._dropdown.$els.empty&&this._dropdown.$els.empty.button.length&&this._dropdown.$els.empty.button.on("click",(()=>{this._onChangeProfession(this._textarea.value)}))}return this.listenTo(this._dropdown,o.n.SELECT,((t,e)=>!!t&&(t.data.is_blacklisted?(this._dropdown.showBlacklist(),!1):(this._textarea.value=t.data.name,i.vE.isMobileApp&&(this._textarea.$els.input.filter(".profile-block__text").text(this._textarea.value),this._textarea.$els.clearButton.addClass("input__clear_visible")),void this._onChangeProfession(t.data.name))))),this.listenTo(this._textarea,"focus",a.debounce((t=>{try{t.target.setSelectionRange(t.target.value.length,t.target.value.length)}catch(e){}})),100),super.render(),this}_initMobileDropdown(){this._textarea.$els.clearButton=this.$(".profile-profession__clear"),this._textarea.$els.clearButton.on("click",(t=>{t.preventDefault(),t.stopPropagation(),this._textarea.clear(),this._textarea.$els.clearButton.removeClass("input__clear_visible"),this._onChangeProfession("")})),this.listenTo(this._textarea,"focus",(t=>{this._textarea.$els.input.filter("textarea").removeClass("profile-block__textarea_invisible"),this._dropdown.show(),this._dropdown.$els.empty&&this._dropdown.$els.empty.button.length&&this._dropdown.$els.empty.button.on("click",(()=>{this._textarea.value=this._dropdown._input.value,this._textarea.$els.input.filter(".profile-block__text").text(this._textarea.value),this._onChangeProfession(this._textarea.value)}))}))}async _onChangeProfession(t){r.F.save(t)?(i.vE.ui.toasts.add("settings-profession-saved",{content:i.vE.i18n("page-settings.main.save.good"),closeAfter:3e3}),this._dropdown.hide()):i.vE.ui.toasts.showError(i.vE.i18n("page-settings.main.save.bad"))}get closeAfterSelect(){return this._options.closeAfterSelect}}},1398:(t,e,s)=>{"use strict";s.d(e,{Z:()=>u});s(6992),s(3948);var i=s(6777),n=s(9161);const o="_uiElement",r="_uiElement";var a=s(6218),l=s(5494),h=s(8245);const c=s(9755),d=s(6419);class u extends i.vp{constructor(t){super(),this.$els={},this._options={$el:void 0,$parent:void 0,isShown:!1,isRendered:!1,isMounted:!1,destroyAfterRemove:!0},a.Z.isHTMLElement(t)&&(t=c(t)),t instanceof c&&(t={$el:t.eq(0)}),t&&this.setOptions(t)}static getPropertyDescriptor(t,e){return t&&(Object.getOwnPropertyDescriptor(t,e)||u.getPropertyDescriptor(Object.getPrototypeOf(t),e))}setOptions(t){return d.isObject(t)?(d.forEach(t,((t,e)=>{let s=u.getPropertyDescriptor(this,e);s&&Boolean(s.set)?this[e]=t:this._options[e]=t})),this):this}render(){return this._options.isRendered=!0,this.emit(n.e.RENDERED,this),this}toggle(t,...e){return d.isBoolean(t)||(t=!this.isShown),this.isShown===t||(t?this.show.apply(this,e):this.hide.apply(this,e)),this}show(){return this.render(),this.mount(),this._options.isShown=!0,this}hide(){return this.unmount(),this._options.isShown=!1,this}mount(){return this.isMounted||(this.$el&&this.$parent&&this.$el.parent()!==this.$parent&&this.$el.appendTo(this.$parent),this.emit(n.e.MOUNTED,this),this._options.isMounted=!0),this}unmount(){return this.isMounted?(this.$el&&this.$el.detach(),this.emit(n.e.UNMOUNTED,this),this._options.isMounted=!1,this):this}destroy(){if(!this.isDestroyed){this.__destroyed=!0,this.unmount(),this.emit(n.e.DESTROYED,this),this.$el&&(this.destroyAfterRemove&&(this.destroyAfterRemove=!1),this.$el.off(),delete this._options.el._uiElement,this.$el.removeData(r),this.$el.empty().remove()),this.$els&&(this.$els=void 0),this._options.marks&&this._options.marks.clear();for(let t in this._options)this._options.hasOwnProperty(t)&&delete this._options[t];this.cancelTimeout(),this.cancelInterval(),this.stopListening(),this.off()}}useRegistry(){const t=h.S.getInstance();return Object.assign({},t.get(),t.getLocal(this))}$(t){return this.$el.find(t)}appendTo(t){return this.$el?(this._options.isMounted=!0,this.$parent=t,this.$el.appendTo(t)):(this.$parent=t,this.render()),this}timeout(t,e,s,i=!0,...n){i&&this.cancelTimeout(t);let o=this._timeoutList;o||(this._timeoutList=o=new Map);let r=()=>{s.apply(this,n),o.delete(t)};return o.set(t,{callback:r,handler:setTimeout(r,e)}),this}runTimeoutImmediately(...t){return this._timeoutList&&this._timeoutList.size&&t.length?(t.forEach((t=>{if(!this._timeoutList.has(t))return;let{handler:e,callback:s}=this._timeoutList.get(t);s(),clearTimeout(e),this._timeoutList.delete(t)})),this):this}cancelTimeout(...t){if(!this._timeoutList||!this._timeoutList.size)return this;if(t.length)t.forEach((t=>{this._timeoutList.has(t)&&(clearTimeout(this._timeoutList.get(t).handler),this._timeoutList.delete(t))}));else{for(let{handler:t}of this._timeoutList.values())clearTimeout(t);this._timeoutList.clear()}return this}interval(t,e,s,i=!0){return i&&this.cancelInterval(t),this._intervalList||(this._intervalList=new Map),this._intervalList.set(t,setInterval(s.bind(this),e)),this}cancelInterval(...t){return this._intervalList&&this._intervalList.size?(t.length?t.forEach((t=>{this._intervalList.has(t)&&(clearInterval(this._intervalList.get(t)),this._intervalList.delete(t))})):(this._intervalList.forEach((t=>clearInterval(t))),this._intervalList.clear()),this):this}animationFrame(t,e,s=!0){return s&&this.cancelAnimationFrame(t),this._animationFrames||(this._animationFrames=new Map),this._animationFrames.set(t,l.$.request(e.bind(this))),this}cancelAnimationFrame(...t){return this._animationFrames&&this._animationFrames.size?(t.length?t.forEach((t=>{this._animationFrames.has(t)&&(l.$.cancel(this._animationFrames.get(t)),this._animationFrames.delete(t))})):(this._animationFrames.values().forEach((t=>l.$.cancel(t))),this._animationFrames.clear()),this):this}closest(t,e){return t.closest(e,this.$el)}onRemoveEvent(t){let e=this._options.destroyAfterRemoveEls;if(e||(e=this._options.destroyAfterRemoveEls=new Set),a.Z.isJQuery(t)&&(t=t.get(0)),!a.Z.isHTMLElement(t))throw new Error("destroy after expected jQuery | HTMLElement");return e.has(t)||(e.add(t),c(t).on("removed",this._destroyBound)),this}offRemoveEvent(t){let e=this._options.destroyAfterRemoveEls;return e&&e.size?d.isUndefined(t)?(e.forEach((t=>{c(t).off("removed",this._destroyBound)})),e.clear(),delete this._options.destroyAfterRemoveEls,this):(a.Z.isJQuery(t)&&(t=t.get(0)),e.has(t)?(e.delete(t),c(t).off("removed",this._destroyBound),this):this):this}get isDestroyed(){return this.__destroyed}get $el(){return this._options.$el}set $el(t){let e=this.$el,s=d.isUndefined(t)||d.isNull(t);if(!s&&!a.Z.isElement(t))throw new Error("$el attribute can [HTMLElement|jQuery] "+typeof t);if(e&&(delete this._options.el._uiElement,this.$el.removeData(r),this.offRemoveEvent(this.el)),s)return e&&e.remove(),this._options.el=void 0,this._options.$el=void 0,this._options.isMounted=!1,void(this._options.isRendered=!1);t=c(t).eq(0),this._options.el=t[0],t.parent().length&&(this._options.isMounted=!0,this.$parent=t.parent()),this.destroyAfterRemove&&this.onRemoveEvent(t),Object.defineProperty(this._options.el,o,{value:!0,configurable:!0,writable:!1,enumerable:!1}),this._options.$el=c(t).eq(0),this.$el.data(r,this)}get el(){return this._options.el}set el(t){if(!a.Z.isHTMLElement(t))throw new Error("$el attribute can [HTMLElement] "+typeof t);return this.$el=c(t),this._options.el=t}get name(){return this._options.name}set name(t){return this._options.name=String(name)}get $parent(){return this._options.$parent}set $parent(t){if(!a.Z.isElement(t))throw new Error("$el attribute can [HTMLElement|jQuery]"+typeof t);this._options.$parent=c(t).eq(0)}get isMounted(){return this._options.isMounted}get isShown(){return this._options.isShown}set isShown(t){let e=Boolean(t);this.isShown!==e&&(t?this.show():this.hide())}get isRendered(){return this._options.isRendered}get _destroyBound(){return this._options.destroyBound?this._options.destroyBound:this._options.destroyBound=()=>{this.emit(n.e.REMOVED,this),this.destroy()}}get destroyAfterRemove(){return this._options.destroyAfterRemove}set destroyAfterRemove(t){this._options.destroyAfterRemove!==(t=Boolean(t))&&(this._options.destroyAfterRemove=t,this.$el&&(t?this.onRemoveEvent(this.el):this.offRemoveEvent(this.el)))}get marks(){return this._options.marks||(this._options.marks=new Map),this._options.marks}static closestUIElement(t,e=6){let s=0;for(e=Math.max(1,e),t instanceof c&&(t=t.get(0));t&&t!==document.documentElement||s>e;){if(!t)return!1;if(!d.isUndefined(t._uiElement))return u.getUIElement(t);t=t.parentElement,s++}return!1}static getUIElement(t){if(a.Z.isHTMLElement(t)){if(!t._uiElement)return;t=c(t)}if(t instanceof c&&t.length)return t.data(r)}get eid(){return this._options.eid||(this._options.eid=d.uniqueId("e")),this._options.eid}}var p,m,_;_=!0,(m="isUIElement")in(p=u)?Object.defineProperty(p,m,{value:_,enumerable:!0,configurable:!0,writable:!0}):p[m]=_},9161:(t,e,s)=>{"use strict";let i;s.d(e,{e:()=>i}),function(t){t.UNMOUNTED="uiUnmounted",t.MOUNTED="uiMounted",t.DESTROYED="uiDestroyed",t.REMOVED="uiRemoved",t.RENDERED="uiRendered",t.HIDDEN="uiHidden"}(i||(i={}))},4519:(t,e,s)=>{"use strict";s.d(e,{u1:()=>i.Z,eM:()=>n.e});var i=s(1398),n=s(9161)},5661:(t,e,s)=>{"use strict";s.d(e,{f:()=>b});s(6992),s(3948),s(2707),s(5827),s(8674),s(4916),s(5306);var i=s(8211),n=s(2134),o=s(4519),r=s(7025);function a(t){var e,s="";Array.prototype.join;s+='<div class="emotions__popup">\n    ';for(let i in t.emotions)s+='\n        <div class="emotions__popup-item\n             '+(null==(e=t.info[Number(i)]&&t.info[Number(i)].is_active?"emotions__popup-item_active":"")?"":e)+'"\n             data-type="'+(null==(e=i)?"":e)+'"\n             data-count="'+(null==(e=t.info[Number(i)]?t.info[Number(i)].count:0)?"":e)+'\n        ">\n            <div class="emotions__popup-title">'+(null==(e=t.emotions[i].hint)?"":e)+'</div>\n            <div class="emotions__popup-icon "><svg xmlns="http://www.w3.org/2000/svg" class="icon icon--emotions__'+(null==(e=t.emotions[i].class)?"":e)+'"><use xlink:href="#icon--emotions__'+(null==(e=t.emotions[i].class)?"":e)+'"></use></svg></div>\n            <div class="emotions__popup-counter">\n                <span>\n                    '+(null==(e=t.updateCounterText(t.info[Number(i)]?t.info[Number(i)].count:0))?"":e)+"\n                </span>\n            </div>\n        </div>\n    ";return s+="\n</div>"}const l="emotions_opened",h="emotions__items",c="emotions__item",d="emotions__items_empty",u={item:"emotions__popup-item",itemActive:"emotions__popup-item_active",counter:"emotions__popup-counter span"};var p=s(4113),m=s(2822),_=s(9738);function g(t,e){var s=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),s.push.apply(s,i)}return s}function v(t,e,s){return e in t?Object.defineProperty(t,e,{value:s,enumerable:!0,configurable:!0,writable:!0}):t[e]=s,t}const f=s(9755),y=s(6419);class b extends o.u1{constructor(t){super(t),this._maxEmotionsOnButton=2,this._maxCountEmotionForShowing=2,this._storyId=this.$el.data("storyId"),this._info=this.$el.data("emotions"),this._options.needLoadCounters=!this._info.is_loaded,this._sendRequestDebounce=y.debounce(this._sendRequest,200),this.$els={items:this.$("."+h)},this._emotions=i.ZP.initParams.emotionsTypesConfig,this._addButtonEmotions()}get popup(){if(this._popup)return this._popup;let t="";return i.ZP.isMobileApp&&i.ZP.initParams.experimentRightVotesGrBig&&(t=this.$el.find(".emotions__title")),this._popup=new r._({direction:r.Lh.TOP,alignment:r.SE.CENTER,autoCloseOutsideClick:!0,popupNonOverflow:!0,indent:!1,target:t||this.$el,content:a({emotions:this._emotions,info:this._changeDataEmotionsStructure(this._info.emotions),updateCounterText:this._updateCounterText})}),this.listenTo(this._popup,o.eM.UNMOUNTED,(()=>{this.$el.removeClass(l)})),this.listenTo(this._popup,o.eM.MOUNTED,(()=>{this.$el.removeClass(l)})),this._popup.content.on("click",`.${u.item}`,this._onClickEmotion.bind(this)),this._popup}updateEmotionsCounters(t){if(!t&&!(0,_.K)(t))return;const e=this._info.emotions.length?this._changeDataEmotionsStructure(this._info.emotions):{};for(const[s,i]of Object.entries(t))e&&Boolean(e[s])?this._info.emotions[this._info.emotions.indexOf(e[s])].count=i:this._info.emotions.push({type:Number(s),count:i,is_active:!1});this._sortEmotionsByCounter(),this._addButtonEmotions(),this.popup.content=a({emotions:this._emotions,info:this._changeDataEmotionsStructure(this._info.emotions),updateCounterText:this._updateCounterText})}_sortEmotionsByCounter(){this._info.emotions.sort(((t,e)=>t.count<e.count?1:e.count<t.count?-1:0))}_addButtonEmotions(){if(!this.$els.items.hasClass(d)||this._info.emotions.length){this.$els.items.empty();for(let t=0;t<this._maxEmotionsOnButton&&!(!this._info.emotions[t]||!this._info.emotions[t].count||this._info.emotions[t].count<this._maxCountEmotionForShowing||t>0&&this._info.emotions[t].count<this._info.emotions[t-1].count/2);t++)this._addEmotionTempleToButton(this._info.emotions[t].type)}}_addEmotionTempleToButton(t){this.$els.items.append(`<span data-type="${t}" class="${c}">\n\t\t\t\t${(0,p.t)("emotions__"+this._emotions[t].class)}\n\t\t\t</span>`)}_changeDataEmotionsStructure(t){return t.reduce(((t,e)=>Object.assign(t,{[e.type]:e})),{})}_onClickEmotion(t){const e=f(t.currentTarget);if(!i.ZP.isUserAuthorized)return this.popup.hide(),i.ZP.ui.authRequired(),void m.c.getInstance().sendEvent("click",{type:"emotion_add",user_rate:e.data("type")});this._changeEmotions(e),this._sendRequestDebounce(e.data("type"),Number(!e.hasClass(u.itemActive))),e.toggleClass(u.itemActive)}async _sendRequest(t,e){let{response:s}=await n.cf.post("/ajax/save_emotion.php",{story_id:this._storyId,type:t,state:e});if(!s.result)throw new Error(s.message);m.c.getInstance().sendEvent(e?"reaction_add_post":"reaction_remove_post",function(t){for(var e=1;e<arguments.length;e++){var s=null!=arguments[e]?arguments[e]:{};e%2?g(Object(s),!0).forEach((function(e){v(t,e,s[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(s)):g(Object(s)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(s,e))}))}return t}({post_id:this.story.id,author_id:this.story.analyticsData.author_id,user_rate:t,pluses:this.story.analyticsData.pluses,minuses:this.story.analyticsData.minuses,rating:this.story.rating,screen_index:this.story.analyticsData.screen_index},this.story.subsCode&&{type_i8:this.story.subsCode}))}_changeEmotions(t){const e=t.data("type"),s=t.data("count"),i=t.hasClass(u.itemActive),n=t.find("."+u.counter),o=Number(s)+(i?-1:1);t.data("count",o),n.text(this._updateCounterText(o)),this._updateEmotionsInfo(e,o),this._addButtonEmotions()}_updateEmotionsInfo(t,e){const s=this._info.emotions.find((e=>e.type===t));s?e?this._info.emotions[this._info.emotions.indexOf(s)].count=e:this._info.emotions.splice([this._info.emotions.indexOf(s)],1):this._info.emotions.push({type:t,count:e}),this._sortEmotionsByCounter()}_updateCounterText(t){return t>1e3?(t>1e5?Math.floor(t/1e3):(t/1e3).toFixed(1).replace(".0",""))+"k":t}get story(){return this._options.story}get needLoadCounters(){return this._options.needLoadCounters}}},3479:(t,e,s)=>{"use strict";s.d(e,{t:()=>l});s(8674);var i=s(4519),n=s(3432),o=s(6572),r=(s(6992),s(3948),s(9050));var a=s(2822);class l extends i.u1{constructor(t){super(t),this._clients=[],this._disabled=!1,this._cssModifiers=t.cssModifiers||[]}render(){return this.isRendered||(this.$el.on("click",'[data-action="close"]',(()=>this._onDisableButtonClick())),this.$el.on("click auxclick","a[href]",(t=>{0!==t.button&&1!==t.button||a.c.getInstance().sendEvent("click",{type:"company_feedback_link"})}))),this}show(){return this.$el.html(function(t){var e="",s=r.escape;for(var i of(Array.prototype.join,e+='<section class="feedback-offer ',t.cssModifiers))e+=" feedback-offer_"+s(i)+" ";if(e+='">\n    <div class="feedback-offer__button" role="button" data-action="close"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon--ui__close"><use xlink:href="#icon--ui__close"></use></svg></div>\n\n    ',t.clients.length<2)e+="\n\n        Информируем, что на Пикабу есть официальный представитель поддержки компании "+s(t.clients[0].name)+', вы можете обратиться напрямую через\n        <a target="_blank" href="'+s(t.clients[0].url)+'">форму обратной связи</a>.\n\n    ';else{e+="\n\n        Информируем, что на Пикабу есть официальные представители поддержки компаний "+s(t.clients.map((t=>t.name)).join(", "))+".\n        Вы можете обратиться напрямую через форму обратной связи:\n\n        ";for(var n=0;n<t.clients.length;n++)e+='\n            <a target="_blank" href="'+s(t.clients[n].url)+'">'+s(t.clients[n].name)+"</a>"+s(n===t.clients.length-1?".":",")+"\n        ";e+="\n    "}return e+"\n</section>"}({clients:this._clients,cssModifiers:this._cssModifiers})).slideDown(400),a.c.getInstance().sendEvent("show_company_feedback_link"),super.show()}hide(){return this.$el.slideUp({duration:400,complete:()=>{this.$el.empty()}}),this}_onDisableButtonClick(){this._disabled=!0,this.hide()}async checkMentions(t){const{clients:e}=await n.Y.findMentionsInText(o.cQ.getTextContent(t));this._clients=e,e.length&&!this._disabled?this.show():this.hide()}}},125:(t,e,s)=>{"use strict";s.d(e,{x6:()=>u,BV:()=>r,hA:()=>v});var i=s(4519);s(6457);const n=s(9755),o=s(6419);class r extends i.u1{constructor(t){super(),this.setOptions(o.defaults(t||{},{aspectRatio:1}))}render(){return this.isRendered||(this.$el=n(document.createElement("div")).addClass("image-cropper"),this.file&&this.$el.append(this.file),this._cropper=new Cropper(this.file.get(0),{dragMode:"move",viewMode:1,aspectRatio:this.aspectRatio,autoCropArea:1,restore:!1,guides:!1,center:!1,highlight:!1,cropBoxMovable:!1,cropBoxResizable:!1,toggleDragModeOnDblclick:!1}),super.render()),this}getData(){return this._cropper.getData()}get file(){return this._options.file}set file(t){return t===this._options.file?this.file:(t="string"==typeof t?n(document.createElement("img")).attr("src",t):t=n(t),this._options.file=t)}get outputSize(){return this._options.outputSize}set outputSize(t){let e=this._options.outputSize;o.isArray(t)||2!==t.length||e===t||(this._options.outputSize=t,this.aspectRatio=t[0]/t[1])}get aspectRatio(){return this._options.aspectRatio}set aspectRatio(t){return this._options.aspectRatio=parseFloat(t)}}s(8674),s(6992),s(3948);var a=s(8211),l=s(7591),h=s(2025),c=s(7025),d=s(566);const u=new(s(7892).xs)({PROFILE_AVATAR:1,PROFILE_BACKGROUND:2,COMMUNITY_AVATAR:3,COMMUNITY_BACKGROUND:4});var p=s(2134),m=s(6572);s(6457);const _=s(9755),g=s(6419);class v extends c.LD{constructor(t){super(t),this._isMobileView=a.vE.applicationType===l.Zq.MOBILE,this._errorPopup=void 0}render(){return this.isRendered||(super.render(),this._uploadButton=new h.y3({title:"Загрузить",theme:h.jM.SUCCESS}),_(document.createElement("input")).attr("type","file").attr("accept","image/*").on("click",(t=>t.stopPropagation())).on("change",(t=>{let e=d.nO.getImageFiles(t);e.length&&(this.file=e[0])})),this.listenTo(this._uploadButton,"click",this._onClickUpload),this.addCustomIntoFooter(this._uploadButton.show().$el),this.addCloseButtonIntoFooter(),this.content=(t={type:this.type.toString().toLowerCase()},""+'<div class="image-cropper" data-type="'+(null==(e=t.type)?"":e)+'" data-loading="true">\n\t<div class="image-cropper__loading"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon--ui__progress-circle icon--ui__progress-circle_image-cropper"><use xlink:href="#icon--ui__progress-circle"></use></svg></div>\n\t<div class="image-cropper__content"></div>\n\t<div class="image-cropper__error" style="display: none">Сообщение о ошибке</div>\n</div>'),this.$els.cropper={el:this.$(".image-cropper"),content:this.$(".image-cropper__content"),error:this.$(".image-cropper__error")},this._initCropper()),this;var t,e}async _initCropper(){this.isLocked=!0,this.isLoading=!0;let t=await this._getImage();this._cropper&&(this._cropper.destroy(),this.$els.cropper.content.empty()),this.$els.cropper.content.append(t);let e=this.outputSize?this.outputSize[0]/this.outputSize[1]:1;this.isLoading=!1,this._cropper=await new Promise((s=>{new Cropper(t,{dragMode:"move",viewMode:1,aspectRatio:e,autoCropArea:1,responsive:!1,restore:!1,guides:!1,center:!1,highlight:!1,cropBoxMovable:!1,cropBoxResizable:!1,toggleDragModeOnDblclick:!1,ready(){s(this.cropper)}})})),this.isLocked=!1;let{width:s}=this._cropper.getContainerData();this.$els.cropper.el.css({maxWidth:s})}async _getImage(){let t=await d.nO.getInfo(this.file),e=t.exif&&t.exif.Orientation&&t.exif.Orientation>4,s=e?t.height:t.width,i=e?t.width:t.height,[n,o]=this.outputSize,[r,a]=m.cQ.getDimension(s,i,n,o,"cover"),l=new d.Np(this.file);return this.outputSize&&l.resize(r,a),l.rotate("auto"),l.get()}_hideError(){this.$els.cropper.error.hide(),this._errorPopup&&this._errorPopup.hide()}_showError(t){let e=void 0===t||"error"===t?a.vE.i18n("errors.upload"):t;this._isMobileView?this._showErrorPopup(e):this._showErrorSection(e)}_showErrorPopup(t){let e=this._errorPopup||(new c.LD).addCloseButtonIntoFooter();e.indent=!0,e.header=a.vE.i18n("errors.common"),e.content=t,e.show()}_showErrorSection(t){this.$els.cropper.error.toggleClass("caption",t.length>200).html(t).show()}_getCroppedImage(){let t;if(this.outputSize){let[e,s]=this.outputSize;t={minHeight:s,minWidth:e}}return new Promise((e=>this._cropper.getCroppedCanvas(t).toBlob((t=>e(t)))))}async _onClickUpload(){if(this._uploadButton.progress)return;let t;switch(this._uploadButton.progress=!0,this._hideError(),this.type){case u.PROFILE_AVATAR:t="user_avatar";break;case u.PROFILE_BACKGROUND:t="user_background";break;case u.COMMUNITY_BACKGROUND:t="community_header_bg";break;case u.COMMUNITY_AVATAR:t="community_avatar"}let e=await this._getCroppedImage(),{response:s,data:i}=await p.ff.upload(g.extend({type:t,save:1},this.data||{}),e,{useFileAPI:!1});s.result?(this.emit("upload",i),this.hide()):this._showError(s.message),this._uploadButton.progress=!1}destroy(){this.isDestroyed||(this._uploadButton.destroy(),delete this._uploadButton,super.destroy())}set isLocked(t){this._options.isLocked!==(t=Boolean(t))&&(this._options.isLocked=t,this._uploadButton.disabled=t)}set isLoading(t){this._options.isLocked!==(t=Boolean(t))&&(t&&this.$els.cropper.el.attr("data-loading","true"),this.$els.cropper.el.removeAttr("data-loading"))}get file(){return this._options.file}set file(t){this._options.file!==t&&(this._options.file=t,this.isRendered&&this._initCropper())}get outputSize(){return this._options.outputSize}set outputSize(t){let e=this._options.outputSize;g.isArray(t)&&2===t.length&&e!==t&&(this._options.outputSize=t)}get type(){return this._options.type||u.AVATAR}set type(t){let e=this._options.type;(t=u[t])&&t!==e&&(this._options.type=t)}get data(){return this._options.data}set data(t){this._options.data!==t&&(this._options.data=t)}}},7770:(t,e,s)=>{"use strict";let i;s.d(e,{O:()=>i}),function(t){t[t.SIZE_LIMIT=0]="SIZE_LIMIT",t[t.MIME_LIMIT=1]="MIME_LIMIT",t[t.COUNT_LIMIT=2]="COUNT_LIMIT"}(i||(i={}))},7323:(t,e,s)=>{"use strict";s.d(e,{c:()=>C});s(8674),s(6992),s(3948);var i=s(8211),n=s(4519),o=(s(4916),s(5306),s(3491)),r=s(566),a=s(2906),l=s(7580);const h=s(6419),c=s(9755);class d extends n.u1{constructor(t){super(t)}async render(){if(this.isRendered)return this;this.$el=c(document.createElement("div")).attr("data-id",this.model.id).addClass("image-thumb"),this.$els.close=c(document.createElement("button")).addClass("image-thumb__close").appendTo(this.$el).append(i.ZP.icon("ui__close","comment-reply")).on("click",this._onCloseClick.bind(this)),this.$els.information=c(document.createElement("div")).addClass("image-thumb__information").appendTo(this.$el).hide(),this.$els.error=c(document.createElement("i")).addClass("image-thumb__error fa fa-exclamation-triangle hint").appendTo(this.$els.information);let t=c(document.createElement("div")).addClass("image-thumb__preview").appendTo(this.$el);if(this.model.data.source instanceof Blob){new r.Np(this.model.data.source).preview(92).get().then((e=>{t.append(e)}))}else if("video"===this.model.data.type)t.css("background-image",`url("${this.model.data.source}")`),this.model.data.duration&&c(document.createElement("div")).addClass("image-thumb__duration").text(l.F.durationTime(Number(this.model.data.duration))).appendTo(this.$el);else{let e=(this.model.data.url||this.model.data.source).replace("big_size_comm_an","previews_gif_comm");t.css("background-image",`url("${e}")`)}return this.listenTo(this.model,"progress",this._updateProgress),this.listenTo(this.model,"url",(()=>{this.progress=!1})),this.listenTo(this.model,"error",(()=>{this._showError(this.model.data.error)})),this.listenTo(this.model,a.u$.DESTROY,this.destroy),super.render(),this}_updateProgress(t,e){i.ZP.logger.log("thumb",e),this.progress=e}_renderProgress(){return this._progress||(this._progress=new o.j({$parent:this.$els.information,strokeWidth:30})),this._progress}_onCloseClick(){this.model.destroy()}_showError(t){return this._toggleInformation(!0),this.$el.addClass("image-thumb_error"),this.$els.error.attr("aria-label",t||i.ZP.i18n("image-thumbs.errors.upload")).addClass("image-thumb__error_show"),this}_toggleInformation(t){return i.ZP.logger.log("thumbs","show information",t),this.$els.information.toggle(t),t||this.$el.removeClass("image-thumb_error"),this}get model(){return this._options.model}set model(t){return this._options.model=t}get progress(){return this._options.progress}set progress(t){t=h.isNumber(t)?t>=0&&t<=100&&t:Boolean(t);let e=!h.isBoolean(t)||t;return this._options.progress===t?t:(this._renderProgress(),e?h.isBoolean(t)?(this._progress.percent=20,this._progress.indeterminate=!0):(this._progress.indeterminate=!1,this._progress.percent=t):this._progress.stop(),this._progress.toggle(e),this.$el.toggleClass("image-thumb_progress",e),i.ZP.logger.log("thumbs",e,t),this._toggleInformation(e),this._options.progress=t)}}var u=s(2134),p=s(6572);const m=s(6419);class _ extends a.Lo{async _upload(){let t,e={type:"comment_image"};if(this.data.source instanceof Blob)e.uid=0,t=await u.ff.upload(e,this.data.source,{progress:t=>{this.data.progress=t.loaded/t.total*100}});else{e.url=this.data.source;let s=setInterval((()=>{m.isNumber(this.data.progress)||(this.data.progress=0),this.data.progress+=5,this.data.progress>=100&&clearInterval(s)}),1e3);t=await u.ff.post(e),clearInterval(s)}return t.response.result&&t.data.tmp_file_url?(this.data.url=t.data.tmp_file_url,this.data.uploadedFileName=t.data.tmp_file_name,!0):(this.data.error=t.response.message,this.marks.delete("upload"),!1)}serialize(){return this.data.uploadedFileName||this.data.url}serializeToDraft(){switch(this.data.type){case"image":return p.cQ.pick(this.data,"url","uploadedFileName","type");case"video":return p.cQ.pick(this.data,"url","source","duration","type");default:core.logger.error("comments","unhandled image thumb type")}}upload(){if(this.marks.has("upload"))return this.marks.get("upload");let t;return t="video"===this.data.type||this.data.url?Promise.resolve(!0):this._upload(),this.marks.set("upload",t),t}}_.prototype.fieldId="id",_.prototype.defaults={type:"image",source:void 0,url:void 0,uploadedFileName:void 0,progress:void 0,error:void 0,attempts:0};var g=s(8553),v=s(4143),f=s(7770);const y=s(6419),b=s(9755),w=s(9709),E=/image\/(png|jpeg|gif|webp)/,S=["PNG","JPEG","GIF","WEBP"];class C extends n.u1{constructor(t){super(t),this.items||(this.items=new a.qg,this.items.DataObject=_),this.storage=t.storageId&&t.storageId.length?g.j.getPrefixedStorage(t.storageId):g.j.instance,this.listenTo(this.items,a.u$.UPDATE,this._onUpdateItems),this.videoDataPromises=[],this.$el&&this.show()}_onUpdateItems(t,e){e&&e.inserted&&e.inserted.forEach((t=>{let e;t.marks.has("view")?e=t.marks.get("view"):(e=new d({model:t}),t.marks.set("view",e)),this.$el.append(e.show().el)})),this.emit("update",this.items.size)}render(){return this.isRendered||(this.$el||(this.$el=b(document.createElement("div"))),this.$el.addClass("image-thumbs"),this._sortable=new w(this.el,{sort:!0,animation:200,delay:10,ghostClass:"image-thumb_ghost",chosenClass:"image-thumb_chosen",dragClass:"image-thumb_drag",forceFallback:!0}),super.render()),this}async add(t){t=y.isArray(t)?t:[t];let e=!1,s=!1,n=[];return this.items.size&&this.items.size>=this.limit&&n.push({type:f.O.COUNT_LIMIT,limits:this.limit}),(t=t.filter((t=>{if(this.items.size>this.limit)return!1;if(t instanceof Blob)return E.test(t.type)?this.limitImageBytes&&t.size&&t.size>this.limitImageBytes?(s=!0,n.push({type:f.O.SIZE_LIMIT,limits:this.limitImageBytes,file:t.name}),!1):this._filterDuplicateFile(t):(e=!0,n.push({type:f.O.MIME_LIMIT,limits:S,file:t.name}),!1);if(y.isString(t))return!this.storage.has(t)&&(this.storage.add(t),!0);if(b.isPlainObject(t)&&t.hasOwnProperty("url")&&t.hasOwnProperty("type"))return!this.storage.has(t.url)&&(this.storage.add(t.url),!0);throw new Error("Bad input files")})).slice(0,this.limit>0?this.limit-this.items.size:void 0)).forEach((async t=>{if(t.type===g.v.VIDEO){let e;if(t.hasOwnProperty("source"))e=t;else{this.emit("load-video-data",!0);const s=v.tv.getVideoDetails(t.url);this.videoDataPromises.push(s);const n=await s,o=n.response;e=n.data,o.result||i.vE.ui.toasts.showError(i.vE.i18n(o.message)),this.emit("load-video-data",!1)}b.isPlainObject(e)&&e.thumb&&!e.is_nsfw&&this.items.add({type:"video",source:e.thumb,duration:e.duration,url:t.url})}else this.items.add({source:t.type===g.v.IMAGE?t.url:t})})),n.length>0&&this.emit("failed-to-add",n),this}_filterDuplicateFile(t){for(let e of this.items.items){let s=e.data.source;if(s instanceof Blob&&s.name===t.name&&s.size===t.size&&s.type===t.type)return!1}return!0}clear(){return this.storage.clear(),this.items.clear(),this}async upload(){let t=!0;for(let e of this.items.items)await e.upload()||(t=!1);return t}serialize(t=!1){return this.$el?y.map(this.$el.children(),(e=>{let s=this.items.get(e.getAttribute("data-id"));return t?s.serializeToDraft():s.serialize()})):[]}get items(){return this._options.items}set items(t){return this._options.items=t}get storage(){return this._options.storage}set storage(t){return this._options.storage=t}get limit(){return this._options.limit}set limit(t){t="number"==typeof t?t:parseInt(t,10),this._options.limit=y.isFinite(t)?Math.max(0,t):0}get limitImageBytes(){return this._options.limitImageBytes}set limitImageBytes(t){let e=this._options.limitImageBytes;t="number"==typeof t?t:parseInt(t,10),y.isNaN(t)||e===t||(this._options.limitImageBytes=t)}}},8638:(t,e,s)=>{"use strict";s.d(e,{i:()=>v});s(6992),s(3948),s(8674);var i=s(8211),n=s(4519),o=s(7591),r=s(7025);var a=s(7215);const l=new(s(7892).xs)({NONE:0,ZOOM:1,SWIPE_X:2,SWIPE_Y:3});s(4916);var h=s(2822),c=s(7320);const d=s(9755);class u{constructor(t){this._viewer=t,this._timeStartDownload=0,this._timeWhenImageViewed=0,this._beforeImageViewTime=0,this._isImageShown=!1,this._imageViewTimer=void 0,this._$story=void 0,this._$comment=void 0,this._postId=void 0,this._commentId=void 0,this._authorId=void 0,this._comments=0,this._pluses=0,this._minuses=0,this._contentLength=0,this._imageWidth=0,this._imageHeight=0,this._screenIndex=0,this._subscode=0,this._level=void 0,this._recScore=1,this._contentType=void 0,this._addListeners()}imageViewStarted(){this._isImageShown=!0,this._timeWhenImageViewed=Date.now(),this._beforeImageViewTime=(this._timeWhenImageViewed-this._timeStartDownload)/1e3,this._postId||this._commentId||this._getStaticAnalyticsParams(),this._setLevel(),this.sendImageViewEvent()}sendImageViewEvent(t=!1){const e=(Date.now()-this._timeWhenImageViewed)/1e3;Number.isNaN(e)||(!t&&this._isImageShown&&(this._imageViewTimer=setTimeout((()=>this.sendImageViewEvent()),2e3)),h.c.getInstance().sendEvent("image_view",{create_at:this._timeWhenImageViewed,"post_id!empty":this._postId,"comment_id!empty":this._commentId,"comment_author_id!empty":this._commentAuthorId,pluses:this._pluses,minuses:this._minuses,"comments!empty":this._comments,author_id:this._authorId,"screen_index!empty":this._screenIndex,"type_i8!empty":this._subscode,"level!empty":this._level,rec_score:this._recScore,view_time:e,length:this._beforeImageViewTime,size:this._contentLength,list_f32:[this._imageWidth,this._imageHeight],type:this._contentType},[c.b.CLICKHOUSE]))}viewEnded(){clearTimeout(this._imageViewTimer),this._isImageShown=!1,this.sendImageViewEvent(!0),this._timeWhenImageViewed=0}_addListeners(){window.onblur=()=>this.viewEnded(),window.onfocus=()=>{if(!this._viewer.$el)return clearTimeout(this._imageViewTimer),void(this._isImageShown=!1);clearTimeout(this._imageViewTimer),this._imageViewTimer=void 0,this._isImageShown=!0,this._timeWhenImageViewed=Date.now(),this.sendImageViewEvent()}}_getStaticAnalyticsParams(){var t,e,s;if(this._$story=this._viewer._targetImage.closest(".story[data-story-id]"),this._postId=null===(t=this._$story)||void 0===t?void 0:t.data("story-id"),this._$comment=this._viewer._targetImage.closest(".comment[data-id]"),this._commentId=null===(e=this._$comment)||void 0===e?void 0:e.data("id"),this._commentAuthorId=null===(s=this._$comment)||void 0===s?void 0:s.data("author-id"),this._subscode=this._$story.data("subs-code"),this._postId){this._comments=this._$story.data("comments");const t=this._$story.data("meta-rating");t&&([this._pluses,this._minuses]=t.split(":").map((t=>Number(t)))),this._authorId=Number(this._$story.data("author-id"));const e=d(".stories-feed__container").find(".story");e.length>0&&(this._screenIndex=d.inArray(this._$story[0],e)+1)}if(this._commentId){const t=this._$comment.data("meta").match(/av=(-?\d+):(-?\d+)/);this._postId=this._$comment.data("meta").match(/sid=(\d+)/)[1];const e=this._$comment.data("meta").match(/avh=(-?\d+):(-?\d+)/),s=e||t;s&&(this._pluses=Number(s[1]),this._minuses=Number(s[2])),this._authorId=Number(this._$comment.data("meta").match(/said=(\d+)/)[1])}}setImageParams(t,e,s){const i=new XMLHttpRequest;i.open("HEAD",t,!0),i.onload=()=>{const t=i.getResponseHeader("content-length");this._contentLength=parseFloat((t/Math.pow(1024,2)).toFixed(3));const n=i.getResponseHeader("content-type");this._contentType=null==n?void 0:n.substring(0,5),this._imageWidth=e,this._imageHeight=s},i.send(null)}setRecScore(t){t>this._recScore&&(this._recScore=t)}_setLevel(){var t;const e=(null!==(t=this._$story)&&void 0!==t&&t.length?this._$story:this._$comment).find("img");e.length>1&&(this._level=d.inArray(this._viewer._targetImage[0],e)+1)}setTimeDownloadBegin(){this._timeStartDownload=Date.now()}destroy(){window.onblur=null,window.onfocus=null}}var p=s(8977);var m=s(9050);const _=s(9755),g=500;class v extends n.u1{constructor(t={}){super(),this._prevScaleText="",this._useTouchEvent=!1,this._showImageBackground=!0===t.showImageBackground,this._showScrollArrows=!0===t.showScrollArrows,this._showLargeImageLoader=!0===t.showLargeImageLoader,this._useSwipeForClose=!1,this._useHistoryState=!0===t.useHistoryState,this._closeByClick=!0===t.closeByClick,this._clickEventName="click",this._closeMsgShowPercent=0,this._skipImageStartupAnim=!0===t.skipImageStartupAnim,this._animProps={curr:0,dur:20,method:"cubic",timer:0},this._makeAnimationStepBound=this._makeAnimationStep.bind(this),this._transform={x:0,y:0,scale:1},this._transformSaved={x:0,y:0,scale:1},this._transformApplied={x:0,y:0,scale:1},this._startupAnim={duration:t.startupAnimationDuration||500},this._initScale=1,this._minScale=.1,this._maxScale=3,this._shown=!1,this._loaded=!1,this._bigImage=null,this._imageURL="",this._imageLargeURL="",this._padding=20,this._topIndent=0,this._mouseScrollEvent="",this._helpBalloon=null,this._targetImage=null,this._nextPicAnimateDirection="",this._naturalScale=!1,this._currentGesture=l.NONE,this._init(),this._analytics=new u(this),this._analytics.setTimeDownloadBegin()}_init(){this._useTouchEvent=a.Ni,this._naturalScale=!1,a.tG?this._clickEventName="click":this._clickEventName=this._useTouchEvent&&void 0!==_.fn.touch?"touch":"click"}_create(){var t,e,s;if(this.$el=_((t={showScrollArrows:this._showScrollArrows,showImageBackground:this._showImageBackground,showScrollHint:!1,useSwipeForClose:this._useSwipeForClose,isMac:navigator.platform.indexOf("Mac")>-1,showLargeImageLoader:this._showLargeImageLoader,showZoomButtons:!1,showHelpButton:this._options.showHelpButton},s="",Array.prototype.join,s+='<div class="image-viewer">\n\t<img src="" alt="" />\n\t',t.showImageBackground&&(s+='\n\t\t<div class="image-viewer__background"></div>\n\t'),s+="\n\t",t.showScrollArrows&&(s+='\n\t\t<div class="image-viewer__arrow image-viewer__arrow_up">\n\t\t\t<svg xmlns="http://www.w3.org/2000/svg" class="icon icon--ui__arrow-up icon--ui__arrow-up_size-large"><use xlink:href="#icon--ui__arrow-up"></use></svg>\n\t\t</div>\n\t\t<div class="image-viewer__arrow image-viewer__arrow_down">\n\t\t\t<svg xmlns="http://www.w3.org/2000/svg" class="icon icon--ui__arrow-down icon--ui__arrow-down_size-large"><use xlink:href="#icon--ui__arrow-down"></use></svg>\n\t\t</div>\n\t\t',t.showScrollHint&&(s+='\n\t\t\t<div class="image-viewer__hotkeys-info">\n\t\t\t\t<i class="fa fa-long-arrow-up"></i><br><span>'+(null==(e=t.isMac?"cmd":"ctrl")?"":e)+' + scroll</span>\n\t\t\t\t<br><i class="fa fa-long-arrow-down"></i>\n\t\t\t</div>\n\t\t\t<div class="image-viewer__hotkeys-info image-viewer__hotkeys-info_shifted">\n\t\t\t\t<i class="fa fa-long-arrow-up"></i><br><span>'+(null==(e=t.isMac?"cmd":"ctrl")?"":e)+' + scroll</span>\n\t\t\t\t<br><i class="fa fa-long-arrow-down"></i>\n\t\t\t</div>\n\t\t'),s+="\n\t"),s+='\n\t<div class="image-viewer__button image-viewer__button_close">\n\t\t<svg xmlns="http://www.w3.org/2000/svg" class="icon icon--ui__close icon--ui__close_size-large"><use xlink:href="#icon--ui__close"></use></svg>\n\t</div>\n\t',t.showHelpButton&&(s+='\n\t\t<div class="image-viewer__button image-viewer__button_help">?</div>\n\t'),s+="\n\t",t.showZoomButtons&&(s+='\n\t\t<div class="image-viewer__button image-viewer__button_zoom-in">\n\t\t\t<svg xmlns="http://www.w3.org/2000/svg" class="icon icon--ui__plus icon--ui__plus_size-large"><use xlink:href="#icon--ui__plus"></use></svg>\n\t\t</div>\n\t\t<div class="image-viewer__button image-viewer__button_zoom-out">\n\t\t\t<svg xmlns="http://www.w3.org/2000/svg" class="icon icon--ui__minus icon--ui__minus_size-large"><use xlink:href="#icon--ui__minus"></use></svg>\n\t\t</div>\n\t'),s+='\n\t<div class="image-viewer__button image-viewer__button_link">\n\t\t<i class="fa fa-external-link"></i>\n\t</div>\n\t',t.showLargeImageLoader&&(s+='\n\t\t<div class="image-viewer-loader">\n\t\t\t<span class="image-viewer-loader__stage"><svg><path d="M0 0"/></svg></span>\n\t\t\t\t\x3c!--<span class="image-viewer-loader__caption">\n\t\t\t\t\tкачественная<br>картинка\n\t\t\t\t</span>--\x3e\n\t\t</div>\n\t'),s+="\n\t",t.useSwipeForClose&&(s+='\n\t\t<div class="image-viewer__close-msg">закрыть</div>\n\t'),s+="\n</div>\n")),this.$els={linkButton:this.$(".image-viewer__button_link"),closeButton:this.$(".image-viewer__button_close"),zoomInButton:this.$(".image-viewer__button_zoom-in"),zoomOutButton:this.$(".image-viewer__button_zoom-out"),helpButton:this.$(".image-viewer__button_help"),img:this.$(" > img"),imgBg:this.$(".image-viewer__background"),arrowUpButton:this.$(".image-viewer__arrow_up"),arrowDownButton:this.$(".image-viewer__arrow_down"),hotKeyInfo:this.$(".image-viewer__hotkeys-info"),closeMsg:this.$(".image-viewer__close-msg"),loader:this.$(".image-viewer-loader"),loaderDisk:this.$(".image-viewer-loader svg path")},this.$els.linkButton.on(this._clickEventName,(()=>{window.open(this._imageLargeURL||this._imageURL)})),this.$els.closeButton.on(this._clickEventName,this.hide.bind(this)),this.$els.arrowUpButton.on(this._clickEventName,this._scrollUp.bind(this)),this.$els.arrowDownButton.on(this._clickEventName,this._scrollDown.bind(this)),this.$els.helpButton.on(this._clickEventName,this._showHelp.bind(this)),this.$els.zoomInButton.on(this._clickEventName,(()=>{this._zoom(1)})),this.$els.zoomOutButton.on(this._clickEventName,(()=>{this._zoom(-1)})),this._closeByClick){let t=!1;this.$el.on("mousedown click",(e=>{"mousedown"===e.type?t=!0:t&&"click"===e.type&&e.target===this.$el[0]&&this.hide()}))}if(_(window).on("resize.imageView",this._correctPosition.bind(this)),(a.Ni||a.tG)&&this.$el.on("touchmove",(t=>{t.stopPropagation(),t.preventDefault()})),i.ZP.applicationType===o.Zq.DESKTOP){let t=this.$el[0],e=this._zoomByWheel.bind(this);t.addEventListener("MozMousePixelScroll",e,!1),t.addEventListener("mousewheel",e,!1)}this._listenImageEvents()}setTarget(t){return this._targetImage=_(t),this}show(){return this._targetImage?(this._padding=this._showImageBackground?40:20,this._topIndent=0,this._useHistoryState&&(i.ZP.history.pushState({id:"image-viewer"},document.title),this.listenTo(i.ZP.history,"popstate",(()=>{this.hide()}))),_(document).on("keyup.imageView",(t=>{switch(t.key||t.keyCode){case"Esc":case"Escape":case 27:this.hide();break;case"0":case 48:this._naturalScale=!!this._isStartupProps()&&!this._naturalScale,this._naturalScale?this._setImageNaturalProps():this._setImageStartupProps(),this._animateImgProps("cubic",10);break;case"ArrowRight":case"Right":case 39:this._openNextImage(1);break;case"ArrowLeft":case"Left":case 37:this._openNextImage(-1)}})),_(document).on("keydown.imageView",(t=>{switch(t.key||t.keyCode){case"ArrowUp":case"Up":case 38:t.preventDefault(),this._scrollUp(5);break;case"PageUp":case 33:t.preventDefault(),this._scrollUp(1);break;case"ArrowDown":case"Down":case 40:t.preventDefault(),this._scrollDown(5);break;case"PageDown":case 34:t.preventDefault(),this._scrollDown(1);break;case"Tab":case 9:this._togglePanels()}})),this.$el||this._create(),this._loadImage(),this.$el.css("opacity",0).animate({opacity:1},this._startupAnim.duration,(()=>{this._preparePage(),this._shown=!0,this._loaded&&this._prepareImage()})),_("body").append(this.$el),this):this}_loadImage(){if(!this._targetImage)return;let t=this._targetImage,e=this._targetImage.get(0),s=this.$els.img[0];this._loaded=!1,s.style.visibility="",this.$els.img.off("load").on("load",(t=>{this._loaded=!0,this._analytics.setImageParams(this._imageURL,t.target.width,t.target.height),this._shown&&this._prepareImage()})),this.$els.img.attr("src",this._imageURL=t.data("src")||e.src),this._imageLargeURL=t.data("large-image")||""}_openNextImage(t){if(!this._targetImage)return;let e=this._targetImage.closest(".story[data-story-id]"),s=this._targetImage.closest(".comment"),i=e.length>0?e.find('img[data-viewable="true"]'):s.length>0?s.find('> .comment__body img[data-viewable="true"]'):void 0,n=this._targetImage[0],o=null;if(!(i&&i.length<=1)){for(let e=0,s=i.length;e<s;e++)if(i[e]===n){o=0===e&&-1===t?i[s-1]:i[(e+t)%s];break}o&&this._loaded&&(this.$el.children("[data-watermarked]").remove(),this._analytics.viewEnded(),this._nextPicAnimateDirection=t>0?"right-to-left":"left-to-right",this.setTarget(o),this._bigImage=null,this._loadImage())}}_showHelp(){if(this._helpBalloon)return void this._helpBalloon.hide();let t=this._helpBalloon=new r._(this.$els.helpButton);t.content=_('<div class="image-viewer-help">\n\t<div><i class="fa fa-arrow-right"></i> следущее изображение</div>\n\t<div><i class="fa fa-arrow-left"></i> предыдущее изображение</div>\n\t<div><i>esc</i> закрыть просмотр</div>\n\t<div><i>tab</i> скрыть/показать кнопки</div>\n\t<div><i>ctrl</i> + <span>scroll</span> прокрутка вверх/вниз</div>\n\t<div><i class="fa fa-arrow-up"></i> слабая прокрутка вверх</div>\n\t<div><i class="fa fa-arrow-down"></i> слабая прокрутка вниз</div>\n\t<div><i>pgup</i> сильная прокрутка вверх</div>\n\t<div><i>pgdn</i> сильная прокрутка вниз</div>\n\t<div><i>0</i> оптимальный масштаб</div>\n</div>'),t.direction=r.Lh.LEFT,t.indent=!0;let e=i.ZP.ui.overlays.balloon.zIndex;i.ZP.ui.overlays.balloon.zIndex=9001,t.on("hide",(()=>{this._helpBalloon=null,i.ZP.ui.overlays.balloon.zIndex=e})),t.show()}_togglePanels(){this.$el.toggleClass("image-viewer_force-hide");let t=this.$el.hasClass("image-viewer_force-hide");this.$els.arrowUpButton.toggleClass("image-viewer__arrow_force-hide",t),this.$els.arrowDownButton.toggleClass("image-viewer__arrow_force-hide",t),this.$els.hotKeyInfo.toggleClass("image-viewer__hotkeys-info_force-hide",t),this.$els.zoomInButton.toggleClass("image-viewer__button_force-hide",t),this.$els.zoomOutButton.toggleClass("image-viewer__button_force-hide",t),this.$els.linkButton.toggleClass("image-viewer__button_force-hide",t),this.$els.closeButton.toggleClass("image-viewer__button_force-hide",t),this.$els.helpButton.toggleClass("image-viewer__button_force-hide",t),t&&this._helpBalloon&&this._helpBalloon.hide()}_setupViwer(){}_preparePage(){i.ZP.ui.isPageScrollable=!1}_restorePage(){i.ZP.ui.isPageScrollable=!0}hide(t,e=!1){var s,n,o,r;return null===(s=this._analytics)||void 0===s||s.viewEnded(),null===(n=this._analytics)||void 0===n||n.destroy(),null===(o=this._xmlHTTP)||void 0===o||o.abort(),null===(r=this.$els)||void 0===r||r.img.off("load"),this._useHistoryState&&!1!==e?(i.ZP.history.back(),this):(_(window).off("resize.imageView popstate.imageView"),_(document).off("keyup.imageView keydown.imageView"),this._restorePage(),this.$el?(this._helpBalloon&&(this._helpBalloon.hide(),this._helpBalloon=null),setTimeout((()=>{this.$els.img.remove(),this.$els.imgBg.remove(),this.$el.addClass("image-viewer_disabled").animate({opacity:0},g,(()=>{this.$el.remove(),this.$el=null}))}),10),this._closeMsgShowPercent>0&&this._setCloseMessagePosition(!0),this):this)}_listenImageEvents(){let t=0,e=0,s=0,n=0,r=0,h=0,c=this._targetImage.closest(".story[data-story-id]"),d=c.length>0?c.find('img[data-viewable="true"]'):[],u=this.$els.img[0].getBoundingClientRect().height>this.$el.height()-2*this._padding-this._topIndent,p=new Map,m=0,_=!1,g=this._useSwipeForClose,v=()=>{let t,e,s,i,n=p.size,o=0,r=0,a=0;for(let[l,h]of p){t=h.clientX,e=h.clientY,o+=t,r+=e;for(let[n,o]of p)l!==n&&(s=o.clientX,i=o.clientY,a+=Math.sqrt((t-s)*(t-s)+(e-i)*(e-i)))}return 0===a&&(a=1),{x:o/n,y:r/n,s:a/n}};const f=t=>{if(t.changedTouches)for(let e=0;e<t.changedTouches.length;e++){const s=t.changedTouches[e];p.set(s.identifier,(0,a.RI)(s))}else p.set(t.pointerId||0,(0,a.RI)(t))},y=f;i.ZP.applicationType===o.Zq.DESKTOP&&this.$els.img[0].addEventListener("mousedown",(s=>{if(1!==s.which)return;s.stopPropagation(),s.preventDefault(),t=void 0!==s.clientX?s.clientX:s.pageX,e=void 0!==s.clientY?s.clientY:s.pageY,n=this._transform.x,r=this._transform.y;let i=this.$els.img[0],o=i.offsetWidth*this._transform.scale,a=i.offsetHeight*this._transform.scale,l=this.$el.width()-2*this._padding,h=this.$el.height()-2*this._padding-this._topIndent,c=this._transform.x-o/2,d=this._transform.y-a/2,u=0,p=s=>{s.stopPropagation(),s.preventDefault();let i=(void 0!==s.clientX?s.clientX:s.pageX)-t,p=(void 0!==s.clientY?s.clientY:s.pageY)-e;u=Math.max(u,i<0?-i:i,p<0?-p:p),(c<0||c+o>l)&&(this._transform.x=n+i),(d<40||d+a>h)&&(this._transform.y=r+p),this._applyTransform()},m=t=>{t.stopPropagation(),t.preventDefault(),document.removeEventListener("mousemove",p,!0),document.removeEventListener("mouseup",m,!0),this._correctPosition(!0),u<2&&0===t.button&&this._closeByClick&&this.hide()};document.addEventListener("mousemove",p,!0),document.addEventListener("mouseup",m,!0)})),this.$els.img[0].addEventListener(a.Kg.POINTER_DOWN,(i=>{if(a.tG&&"mouse"===i.pointerType)return;a.tG&&"pen"===i.pointerType&&0!==i.buttons&&this.$els.img[0].setPointerCapture(i.pointerId),i.preventDefault(),f(i);let o=v();_=p.size>1,t=o.x,e=o.y,s=o.s,n=this._transform.x,r=this._transform.y,h=this._transform.scale,this._currentGesture=l.NONE}),!1),this.$els.img[0].addEventListener(a.Kg.POINTER_MOVE,(i=>{if(a.tG&&"mouse"===i.pointerType)return;if(i.preventDefault(),a.tG&&"pen"===i.pointerType&&0===i.buttons)return;let o,c,d,m,f,b;y(i),o=v(),c=o.x-t,d=o.y-e,m=o.s/s,(Math.abs(c)>10||Math.abs(d)>10)&&(_=!0),f=Math.min(this._maxScale,Math.max(this._minScale,h*m)),this._analytics.setRecScore(f),isFinite(f)&&(b=this._calculateZoomShift(f,h,n,r),f>this._initScale?(this._transform.x=b.x+c,this._transform.y=b.y+d):(Math.abs(c)>Math.abs(d)&&this._transform.y===r&&(this._transform.x=b.x+c,this._currentGesture=l.SWIPE_X),Math.abs(c)<Math.abs(d)&&this._transform.x===n&&(this._transform.y=b.y+d,this._currentGesture=l.SWIPE_Y,!u&&d<0&&this.$el.css("backgroundColor",`rgba(0,0,0,${.7-.0015*Math.abs(d)})`))),p.size>1&&(this._currentGesture=l.ZOOM),this._transform.scale=f,this._applyTransform(),g&&this._setCloseMessagePosition())}),!1);const b=i=>{if(a.tG&&"mouse"===i.pointerType)return;if(a.tG&&"pen"===i.pointerType&&this.$els.img[0].releasePointerCapture(i.pointerId),i.preventDefault(),(t=>{let e;if(t.changedTouches)for(let s=0;s<t.changedTouches.length;s++){const i=t.changedTouches[s];e=p.get(i.identifier),p.delete(i.identifier)}else e=p.get(t.pointerId||0),p.delete(t.pointerId||0)})(i),p.size>0){const i=v();t=i.x,e=i.y,s=i.s,n=this._transform.x,r=this._transform.y,h=this._transform.scale,_=!0}else{const s=a.tG?i:i.changedTouches[0];if(this._closeMsgShowPercent>.95)return void this.hide();if(this._closeMsgShowPercent>0&&this._setCloseMessagePosition(!0),this._transform.scale<=this._initScale){if(d.length>1&&this._currentGesture===l.SWIPE_X){if(s.clientX-t>70)return void this._openNextImage(-1);if(s.clientX-t<-70)return void this._openNextImage(1)}if(s.clientY-e<=-70&&!u&&this._currentGesture===l.SWIPE_Y)return void this.hide()}if(this._correctPosition(!0),_)_=!1;else{let t=Date.now();t-m<500?(m=0,this._transform.scale>=1.45?this._reduceImage():this._increaseImage()):m=t}this._currentGesture=l.NONE}};a.Kg.POINTER_UP.forEach((t=>{this.$els.img[0].addEventListener(t,b,!1)}))}_reduceImage(){Date.now()-(this.timeIncreaseImage||0)<50||(this.timeReduceImage=Date.now(),this._setImageStartupProps(),this._animateImgProps("cubic",10))}_increaseImage(){Date.now()-(this.timeReduceImage||0)<50||(this.timeIncreaseImage=Date.now(),this._transform.scale=1.5,this._correctPosition(!0))}_scrollUp(t){this._transform.y+=this.$el.height()/("number"==typeof t?t:2),this._correctPosition(!0)}_scrollDelta(t){this._transform.y+=t,this._correctPosition(!0)}_scrollDown(t){this._transform.y-=this.$el.height()/("number"==typeof t?t:2),this._correctPosition(!0)}_loadBigImage(){if(this._bigImage)return;if(this.$els.img[0].naturalWidth<400)return;const t=this._imageLargeURL;"string"==typeof t&&(this.$els.loader.addClass("image-viewer-loader_show"),this._bigImage=new Image,this._bigImage.onload=()=>this._onLoadBigImage(),this._bigImage.onerror=()=>this._onErrorBigImage(),this.completedPercentage=0,this.prevLoadedValue=0,this._xmlHTTP=new XMLHttpRequest,this._xmlHTTP.open("GET",t,!0),this._xmlHTTP.responseType="arraybuffer",this._xmlHTTP.onload=()=>{i.ZP.logger.log("upload","success load"),this._bigImage.src=t},this._xmlHTTP.onprogress=t=>{var e;(t.lengthComputable&&(this.completedPercentage=t.loaded/t.total),this.completedPercentage!==this.prevLoadedValue)&&(this.prevLoadedValue=this.completedPercentage,null===(e=this.$els)||void 0===e||e.loaderDisk.attr("d",v._describeArc(14,14,14,0,360*this.completedPercentage)))},this._xmlHTTP.onerror=()=>{this.$els.loader.removeClass("image-viewer-loader_show"),i.ZP.logger.log("upload","errror onload"),this._bigImage.src=t},this._xmlHTTP.onloadstart=()=>{var t;this.completedPercentage=0,null===(t=this.$els)||void 0===t||t.loaderDisk.attr("d",v._describeArc(14,14,14,0,1))},this._xmlHTTP.onloadend=()=>{var t;this.completedPercentage=1,null===(t=this.$els)||void 0===t||t.loaderDisk.attr("d",v._describeArc(14,14,14,0,360))},this._xmlHTTP.send())}async _onLoadBigImage(){let t=0;if(!this._bigImage)return;this.$els.img[0].complete||await new Promise((t=>{this.$els.img[0].addEventListener("load",(()=>{t()}))})),i.ZP.logger.log("upload","start onLoad",this._bigImage);let e=setInterval((()=>{if(i.ZP.logger.log("upload",this._bigImage.complete,this._bigImage.naturalWidth),!this._bigImage.complete||0===this._bigImage.naturalWidth)return++t>10&&(clearInterval(e),i.ZP.logger.log("upload","max try",t),i.ZP.logger.log("upload","hide loader"),this.$els.loader.removeClass("image-viewer-loader_show")),void i.ZP.logger.log("upload","try",t);i.ZP.logger.log("upload","src img loaded in try:",t,this._bigImage),clearInterval(e),this._imageURL=this._imageLargeURL;let s=this.$els.img[0].naturalWidth/this._bigImage.naturalWidth;const n=this.$els.img.clone().prependTo(this.$el).css({boxShadow:"none"});this.$els.img.replaceWith(this._bigImage),this.$els.img=_(this._bigImage),this._prepareImage(!0),this._transform.scale*=s,this._transformSaved.scale*=s,this._transformApplied.scale*=s,this._initScale=this._transformApplied.scale,this._updateImgProps(),this._listenImageEvents(),this.$els.loader.removeClass("image-viewer-loader_show"),new MutationObserver(((t,e)=>{n.remove(),e.disconnect()})).observe(this._bigImage,{attributes:!0})}),0)}_onErrorBigImage(){this._bigImage.complete=!0,this.$els.loader.removeClass("image-viewer-loader_show")}_correctPosition(t){let e=this._transform,s=this.$els.img[0],i=s.offsetWidth*e.scale,n=s.offsetHeight*e.scale,o=this.$el.width(),r=this.$el.height();if(i<o?e.x=o/2:e.x-i/2>0?e.x=i/2:e.x+i/2<o&&(e.x=o-i/2),n<r)e.y=this._topIndent+this._padding+(r-2*this._padding-this._topIndent)/2,this.$els.arrowDownButton.removeClass("image-viewer__arrow_show"),this.$els.arrowUpButton.removeClass("image-viewer__arrow_show"),this.$els.hotKeyInfo.removeClass("image-viewer__hotkeys-info_show");else{e.y-n/2>this._padding+this._topIndent?e.y=this._padding+this._topIndent+n/2:e.y+n/2<r-this._padding&&(e.y=r-n/2-this._padding);let t=e.y-n/2<this._padding+this._topIndent,s=e.y+n/2>r-this._padding;this.$els.arrowUpButton.toggleClass("image-viewer__arrow_show",t),this.$els.arrowDownButton.toggleClass("image-viewer__arrow_show",s),this.$els.hotKeyInfo.toggleClass("image-viewer__hotkeys-info_show",s||t)}t&&this._animateImgProps("cubic",5)}_setCloseMessagePosition(t=!1){if(t)return this.$els.closeMsg.css({bottom:"",opacity:""}),void(this._closeMsgShowPercent=0);let e,s=this._transform,i=this.$els.img[0].height*s.scale,n=this.$el.height();if(i<n?e=this._topIndent+this._padding+(n-2*this._padding-this._topIndent)/2:s.y-i/2>this._padding+this._topIndent?e=this._padding+this._topIndent+i/2:s.y+i/2<n-this._padding&&(e=n-i/2-this._padding),s.y<e){let t=Math.min(60,Math.max(0,(e-s.y)/3));this._closeMsgShowPercent=t/60,this.$els.closeMsg.css({bottom:2*t-60+"px",opacity:Math.max(.1,2*(this._closeMsgShowPercent-.5))})}else this._closeMsgShowPercent>0&&(this.$els.closeMsg.css({bottom:"",opacity:""}),this._closeMsgShowPercent=0)}_zoom(t){const e=this._transform,s=Math.min(this._maxScale,Math.max(this._minScale,this._transform.scale+(t>0?.24:-.24))),i=this._calculateZoomShift(s,e.scale,e.x,e.y);this._transform.scale=s,this._transform.x=i.x,this._transform.y=i.y,this._correctPosition(!0)}_zoomByWheel(t){if(t.preventDefault(),t.type!==this._mouseScrollEvent){if(""!==this._mouseScrollEvent)return;this._mouseScrollEvent=t.type}let e=t.wheelDelta||t.deltaY||-t.detail;if(t.ctrlKey||t.metaKey)return void this._scrollDelta(e);let s=this._transform,i=Math.min(this._maxScale,Math.max(this._minScale,this._transform.scale+(e>0?.12:-.12))),n=this._calculateZoomShift(i,s.scale,s.x,s.y);this._analytics.setRecScore(i),this._transform.scale=i,this._transform.x=n.x,this._transform.y=n.y,this._correctPosition(),this._applyTransform()}_calculateZoomShift(t,e,s,i){let n=this.$els.img[0].offsetWidth,o=this.$el.width()/2,r=this.$el.height()/2;return{x:o-(o-(s-n*e/2))/e*t+n*t/2,y:r-(r-(i-n*e/2))/e*t+n*t/2}}_prepareImage(t){let e=this.$els.img[0],s=e.style,i=e.naturalWidth,n=e.naturalHeight,o=this.$el.width(),r=this.$el.height();("visible"!==s.visibility||t)&&this.$els&&(s.left=String(-i/2)+"px",s.top=String(-n/2)+"px",this._minScale=Math.min(1/(i/(.3*o)),1/(n/(.6*r))),t||(this._setImageStartupProps(),i>1e3||n>800||this._skipImageStartupAnim?""!==this._nextPicAnimateDirection?("left-to-right"===this._nextPicAnimateDirection?this._transformApplied.x=this._transform.x-300:"right-to-left"===this._nextPicAnimateDirection&&(this._transformApplied.x=this._transform.x+300),this._transformApplied.scale=this._transform.scale,this._animateImgProps("cubic",5)):this._applyTransform():(this._transformApplied.x=this._transform.x,this._transformApplied.y=this._transform.y,this._transformApplied.scale=.1,this._animateImgProps("cubic",5))),s.visibility="visible",t||(this._analytics.imageViewStarted(),this._loadBigImage()),new p.D(e,{forwardEvents:!0}))}_setImageStartupProps(){let t=this.$els.img[0],e=this.$el,s=t.offsetWidth,i=t.offsetHeight,n=e.width()-2*this._padding,o=e.height()-2*this._padding-this._topIndent,r=Math.min(2,n/s,o/i);r<.9&&i>.5*o&&s*r<.5*n&&(r=Math.min(800,.8*n)/s),this._transform.scale=Math.max(r,this._minScale),this._transform.x=this._padding+n/2,this._transform.y=this._topIndent+this._padding+o/2,this._transform.y-i*r/2<this._padding&&(this._transform.y=i*r/2+this._padding+this._topIndent),i*this._transform.scale<e.height()?(this.$els.arrowDownButton.removeClass("image-viewer__arrow_show"),this.$els.arrowUpButton.removeClass("image-viewer__arrow_show"),this.$els.hotKeyInfo.removeClass("image-viewer__hotkeys-info_show")):(this.$els.arrowUpButton.removeClass("image-viewer__arrow_show"),this.$els.arrowDownButton.addClass("image-viewer__arrow_show"),this.$els.hotKeyInfo.addClass("image-viewer__hotkeys-info_show"))}_isStartupProps(){let t=this.$els.img[0],e=this.$el,s=t.offsetWidth,i=t.offsetHeight,n=e.width()-2*this._padding,o=e.height()-2*this._padding-this._topIndent,r=Math.min(2,n/s,o/i);r<.9&&i>.5*o&&s*r<.5*n&&(r=Math.min(800,.8*n)/s);let a={scale:Math.max(r,this._minScale),x:this._padding+n/2,y:this._topIndent+this._padding+o/2};return a.y-i*r/2<this._padding&&(a.y=i*r/2+this._padding+this._topIndent),m.isEqual(a,this._transform)}_setImageNaturalProps(){this._transform.scale=1;let t=this._calculateZoomShift(1,this._transform.scale,this._transform.x,this._transform.y);t.scale=1,this._transform=t,this._correctPosition()}_applyTransform(){this._animProps.timer&&clearTimeout(this._animProps.timer),this._transformApplied.x=this._transform.x,this._transformApplied.y=this._transform.y,this._transformApplied.scale=this._transform.scale,this._updateImgProps()}_animateImgProps(t,e){let s=this._animProps;s.timer&&clearTimeout(s.timer),this._transformSaved.x=this._transformApplied.x,this._transformSaved.y=this._transformApplied.y,this._transformSaved.scale=this._transformApplied.scale,this.$el.css("backgroundColor",""),s.curr=0,s.dur=e||20,s.method=t||"cubic",this._makeAnimationStep()}_makeAnimationStep(){let t=this._animProps;if(++t.curr<=t.dur){let e=v._easing(t.method,t.curr,0,1,t.dur),s=this._transformSaved,i=this._transform;this._transformApplied.x=s.x+(i.x-s.x)*e,this._transformApplied.y=s.y+(i.y-s.y)*e,this._transformApplied.scale=s.scale+(i.scale-s.scale)*e,this._updateImgProps(),t.timer=setTimeout(this._makeAnimationStepBound,41)}}_updateImgProps(){let t,e,s=this.$els.img[0].style,i=this._transformApplied;if(t="translate3d("+i.x+"px, "+i.y+"px, 0px) scale3d("+i.scale+", "+i.scale+", 1)",s.transform=t,s.MozTransform=t,s.webkitTransform=t,this.$els.imgBg.length>0){let e=this.$els.img[0],n=e.offsetWidth*i.scale,o=e.offsetHeight*i.scale;t="translate3d("+(i.x-n/2-10)+"px, "+(i.y-o/2-10)+"px, 0px)",s=this.$els.imgBg[0].style,s.width=String(n+20)+"px",s.height=String(o+20)+"px",s.transform=t,s.MozTransform=t,s.webkitTransform=t}e=Math.round(100*i.scale)+"%",this._prevScaleText!==e&&(this._prevScaleText=e)}static _easing(t,e,s,i,n){let o=2*Math.PI,r=s>i,a=s;switch(r?(a=i,i=s-i,s=a):i-=s,t){default:a=i*e/n+s;break;case"cubic":a=r?i*(e/=n)*e*e+s:i*((e=e/n-1)*e*e+1)+s;break;case"exponential":a=0===e?s:i*Math.pow(2,10*(e/n-1))+s-.001*i,e===n&&(a=i+s);break;case"bounce":a=(e/=n)<1/2.75?i*(7.5625*e*e)+s:e<2/2.75?i*(7.5625*(e-=1.5/2.75)*e+.75)+s:e<2.5/2.75?i*(7.5625*(e-=2.25/2.75)*e+.9375)+s:i*(7.5625*(e-=2.625/2.75)*e+.984375)+s;break;case"elastic":if(0===e)a=s;else if(1==(e/=n))a=s+i;else{let t=.3*n,r=t/4;a=i*Math.pow(2,-10*e)*Math.sin((e*n-r)*o/t)+i+s}}return r&&(a=s+(i+s-a)),a}static _polarToCartesian(t,e,s,i){let n=(i-90)*Math.PI/180;return{x:t+s*Math.cos(n),y:e+s*Math.sin(n)}}static _describeArc(t,e,s,i,n){let o=v._polarToCartesian(t,e,s,n),r=v._polarToCartesian(t,e,s,i),a=n-i<=180?"0":"1";return["M",o.x,o.y,"A",s,s,0,a,0,r.x,r.y,"L",t,e,"L",o.x,o.y].join(" ")}}},8799:(t,e,s)=>{"use strict";s.d(e,{SE:()=>n.SE,Lh:()=>n.Lh,xb:()=>n.xb,Zv:()=>i.C,_:()=>n._,gR:()=>n.gR,LD:()=>n.LD});var i=s(6218),n=(s(3491),s(7025));s(8638),s(5661)},6179:(t,e,s)=>{"use strict";let i;s.d(e,{m:()=>i}),function(t){t.HOT="isHotFeedClosed",t.BEST="isBestFeedClosed",t.NEW="isUpcomingFeedClosed"}(i||(i={}))},5198:(t,e,s)=>{"use strict";s.d(e,{k:()=>o,d:()=>n});var i=s(7892);let n={FOCUS:"focus",ERROR:"error",SUCCESS:"success"};const o=new i.xs({MANUAL:0,BLUR:1,KEYUP:2});n=new i.xs(n)},3023:(t,e,s)=>{"use strict";s.d(e,{S:()=>c});s(5827);var i=s(8211),n=s(4519),o=s(8799),r=s(5358),a=s(1437);const l=s(9755),h=s(6419);class c extends n.u1{constructor(t){super(),o.Zv.isHTMLElement(t)&&(t=l(t)),t instanceof l&&(t={$el:t.eq(0)}),h.defaults(this._options,{endPage:10,startPage:1,currentPage:1,numButtons:i.vE.isMobileApp?7:8}),t&&this.setOptions(t),this.classes={navigate:"pagination__to",navigation:{left:"pagination__navigation_right",right:"pagination__navigation_left",disable:"pagination__navigation"},pages:"pagination__pages",page:{item:"pagination__page",current:"pagination__page_current",more:"pagination__page_more",next:"pagination__page_next",disabled:"pagination__page_disabled"}},this._pages=[],this.$el&&this.show()}_getOptionsFromElement(){return this.$el?(this.currentPage=parseInt(this.$(`.${this.classes.page.current}`).text(),10),this.endPage=this._pages.lastId(),this):this}_getPages(){const t=this.endPage-this.startPage+1,e=(Math.min(this.numButtons,t)-1)/2;let s=this.currentPage-Math.floor(e),i=this.currentPage+Math.ceil(e);s<this.startPage?(i+=this.startPage-s,s=this.startPage):i>this.endPage&&(s-=i-this.endPage,i=this.endPage);let n=!1;s>this.startPage&&(s+=2,n=!0);let o=!1;i<this.endPage&&(i-=2,o=!0);const r=[];n&&(r.push(this.startPage),r.push(null));for(let a=s;a<=i;a++)r.push(a);return o&&(r.push(null),r.push(this.endPage)),r}render(){return this.isRendered||(this.$el?(this._getOptionsFromElement(),o.Zv.clearEmptyTextNode(this.el),this.marks.set("vnode",this._renderV())):this._render(),this.$el.on("click",`.${this.classes.page.item}`,this._onClickPage.bind(this)),this.$el.on("click",`.${this.classes.navigate}`,this._onClickNavigate.bind(this)),super.render()),this}_render(t="0",e){this._pages=this._getPages();let s=this,i=this._renderV();if(this.el){let n=r.zM.node(this.marks.get("vnode"),i,t);this.el=n.reduce(r.nq.updateElement(e,s),this.el)}else this.el=r.wK.createElement(i,t||"0",e,s);return this.marks.set("vnode",i),this.el}_renderV(){const t=this.classes.page;return r.vu.create("div",{className:"pagination","data-role":"1"},i.vE.isMobileApp&&r.vu.create("div",{className:"pagination__navigation"},this._renderNextPageLink()),r.vu.create("div",{className:"pagination__pages"},this._pages.map(((e,s)=>null===e?r.vu.create("span",{key:s,className:`${t.item} ${t.more}`},r.vu.create(a.t,{block:"ui__dots"})):this.currentPage===e?r.vu.create("span",{key:s,className:`${t.item} ${t.current}`},e):r.vu.create("a",{href:"/",key:s,"data-page":e,className:t.item,draggable:!1},e))),!i.vE.isMobileApp&&this._renderNextPageLink()))}_renderNextPageLink(){const t=this.classes.page;return this.currentPage===this.endPage?r.vu.create("span",{class:`${t.item} ${t.next} ${t.disabled}`},"Далее"):r.vu.create("a",{href:"/","data-page":this.currentPage+1,className:`${t.item} ${t.next}`,draggable:!1},"Далее")}_onClickNavigate(t){t.preventDefault(),this.currentPage+="left"===t.currentTarget.dataset.to?-1:1}_onClickPage(t){t.preventDefault();return t.target.dataset.page?(this.currentPage=t.target.dataset.page,this):this}get endPage(){return this._options.endPage}set endPage(t){return t="number"==typeof t?t:parseInt(t,10),i.vE.logger.log("pagination","end page",t),this._options.endPage=t}get startPage(){return this._options.startPage}set startPage(t){return t="number"==typeof t?t:parseInt(t,10),i.vE.logger.log("pagination","start page",t),this._options.startPage=t}get currentPage(){return this._options.currentPage}set currentPage(t){return(t=Math.max(this.startPage,Math.min(parseInt(t,10),this.endPage)))===this.currentPage?this.currentPage:(i.vE.logger.log("pagination","current page",t),!this.el||h.isUndefined(this._options.currentPage)?this._options.currentPage=t:(this._options.currentPage=t,this.emit("change",t),this._render(),t))}get numButtons(){return this._options.numButtons}set numButtons(t){return(t=Math.max(7,parseInt(t,10)))===this.numButtons?this.numButtons:(this._options.numButtons=t,this.isRendered&&this._render(),t)}}},1270:(t,e,s)=>{"use strict";s.d(e,{L:()=>p});s(6992),s(3948),s(4916),s(5827);var i=s(2822),n=s(7320),o=s(2925),r=s(2824),a=s(6471),l=s(2518),h=s(4122);function c(t,e){var s=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),s.push.apply(s,i)}return s}function d(t){for(var e=1;e<arguments.length;e++){var s=null!=arguments[e]?arguments[e]:{};e%2?c(Object(s),!0).forEach((function(e){u(t,e,s[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(s)):c(Object(s)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(s,e))}))}return t}function u(t,e,s){return e in t?Object.defineProperty(t,e,{value:s,enumerable:!0,configurable:!0,writable:!0}):t[e]=s,t}class p{constructor(t){u(this,"_postId",void 0),u(this,"_commentId",void 0),u(this,"_comments",void 0),u(this,"_commentAuthorId",void 0),u(this,"_pluses",0),u(this,"_minuses",0),u(this,"_subscode",0),u(this,"_level",void 0),u(this,"_rating",void 0),u(this,"_authorId",void 0),u(this,"_closestComment",void 0),this._$player=t,this._getStaticAnalyticsParams()}sendAnalytics(t,e){const s=a.R$[t];if(!s)return;t===l.No.TIMELINE_CLICK&&(e.view_time=void 0);const o=new Set(["view_time","time_old","time_new","length"]);for(const[i,n]of Object.entries(e))o.has(i)&&e[i]&&(e[i]=Math.floor(n));const r={"pluses!undefined":this._pluses,"minuses!undefined":this._minuses,"rating!undefined":this._rating,"post_id!empty":this._postId,"comment_id!empty":this._commentId,"comment_author_id!empty":this._commentAuthorId,"comments!empty":this._comments,"type_i8!empty":this._subscode,"author_id!empty":this._authorId};if(t===l.No.SHOW_AD||t===l.No.CLICK_AD){let t=h.Q.getScreenIndex(this._postId.toString());return t=t>0?t:"",void i.c.getInstance().sendEvent(s,d(d({"screen_index!empty":t},r),e),[n.b.CLICKHOUSE])}i.c.getInstance().sendEvent(s,d(d({"level!empty":this._level},r),e),[n.b.CLICKHOUSE])}_getStaticAnalyticsParams(){var t,e;const s=this._$player.closest(".story[data-story-id]:not(.story_comment)");if(this._postId=null==s?void 0:s.data("story-id"),this._subscode=null==s?void 0:s.data("subs-code"),this._comments=null==s?void 0:s.data("comments"),this._postId){const t=s.data("meta-rating");return t?[this._pluses,this._minuses]=t.split(":").map((t=>Number(t))):this._rating=Number(s.data("rating")),void(this._authorId=Number(s.data("author-id")))}const i=this._getCommentMeta();if(!(0,r.x)(i)){if(i.amountVotes){let t=":";t=-1!==i.amountVotes.indexOf(t)?t:",",[this._pluses,this._minuses]=i.amountVotes.split(t).map((t=>Number(t)))}else this._rating=Number(i.rating);this._level=i.depth?Number(i.depth)+1:null,this._commentId=Number(i.id)||Number(null===(t=this.closestComment)||void 0===t?void 0:t.data("id")),this._commentAuthorId=Number(i.authorId),this._authorId=Number(i.storyAuthorId),this._postId=Number(i.storyId),this._subscode=Number(this._$player.data("subs-code"))||Number(null===(e=this.closestComment)||void 0===e?void 0:e.data("story-subs-code"))}}_getCommentMeta(){var t;let e=this._$player.data("comment-meta"),s=",";var i;e||(e=null===(i=this.closestComment)||void 0===i?void 0:i.data("meta"),s=";");return null===(t=e)||void 0===t?void 0:t.split(s).reduce(((t,e)=>{const[s,i]=e.split("=");return t[o.hb[s]]=i||!0,t}),{})}get closestComment(){return this._closestComment||(this._closestComment=this._$player.closest(".comment[data-meta]")),this._closestComment}}},4720:(t,e,s)=>{"use strict";s.d(e,{L:()=>p});var i=s(1014),n=s(9161);s(6992),s(3948);function o(t,e,s){return e in t?Object.defineProperty(t,e,{value:s,enumerable:!0,configurable:!0,writable:!0}):t[e]=s,t}class r{constructor({player:t,onVideoFinished:e}){o(this,"emitter",new i.v),o(this,"onVideoFinished",(()=>null)),this.player=t,this.onVideoFinished=e}resumePlay(){}isPlayerAutoplaying(t){return this.player.eid===t}}var a=s(8211),l=s(4143);function h(t,e,s){return e in t?Object.defineProperty(t,e,{value:s,enumerable:!0,configurable:!0,writable:!0}):t[e]=s,t}class c extends r{constructor(...t){super(...t),h(this,"handleVideoFinished",(t=>{this.player.isPlaying&&this.player.pause({showIndicate:!1}),this.onVideoFinished(t)}))}static setVolumeBeforePlay(){let t=l.FW.parseVolumeBeforeMute();void 0!==t&&1!==t||(t=l.FW.parseVolume()),c.savedVolumeBeforePlay=t}play(){this.player.renderPlayer();const t=a.vE.initParams.experimentSoundAutoplay;(!l.FW.hasUserInteractedWithVolume&&t||!t)&&(c.setVolumeBeforePlay(),this.player.volume=0),this.player.marks.set("before-mute",c.savedVolumeBeforePlay),this.player.play({focusAfter:!1,showIndicate:!1,isAutoEvent:!0}),this.emitter.listenTo(this.player,"video-finished",this.handleVideoFinished)}pause(t=!1){this.player.renderPlayer(),this.emitter.stopListening(this.player,"video-finished",this.handleVideoFinished),t||this.player.pause({showIndicate:!1,isAutoEvent:!0})}resumePlay(){setTimeout((()=>{this.player.isPostrollPlaying||this.player.play({focusAfter:!1,showIndicate:!1,restoreVolume:!0})}),350)}}h(c,"savedVolumeBeforePlay",0);class d extends r{play(){const t=this.player;this.player.play(),this.emitter.listenTo(this.player,"gifx-play",(()=>{t!==this.player&&this.pause()}))}pause(){this.player.stop()}}function u(t,e,s){return e in t?Object.defineProperty(t,e,{value:s,enumerable:!0,configurable:!0,writable:!0}):t[e]=s,t}class p{static getInstance(){return p.instance||(p.instance=new p)}constructor(){u(this,"_activePlayerPlaybacks",0),u(this,"playingQueue",[]),u(this,"emitter",new i.v),u(this,"onVideoFinished",((t=!1)=>{t&&--this._activePlayerPlaybacks,++this.activePlayerPlaybacks})),this.emitter.listenTo(a.vE,"playerSpecialPlay",(t=>{var e;null!==(e=this.currentActivePlayer)&&void 0!==e&&e.isPlayerAutoplaying(t)||(this.playingQueue=[],this.stopActivePlayerAndPlayNext())}))}initPlayer({player:t}){this.currentActivePlayer||this.createActivePlayer(t),this.initObserver(t)}createActivePlayer(t){const e={player:t,onVideoFinished:this.onVideoFinished};t instanceof l.FW?this.currentActivePlayer=new c(e):t instanceof l.f7&&(this.currentActivePlayer=new d(e))}isPlayerAutoplaying(t){var e;return Boolean(null===(e=this.currentActivePlayer)||void 0===e?void 0:e.isPlayerAutoplaying(t))}initObserver(t){const e=new IntersectionObserver((e=>{var s;if(!e.length)return;const i=e[0];if(i.isIntersecting){var n;if(this.playingQueue.length&&i.intersectionRatio>.5&&i.intersectionRatio<1)this.stopActivePlayerAndPlayNext();else{if(null!==(n=this.currentActivePlayer)&&void 0!==n&&n.isPlayerAutoplaying(t.eid))return void this.playCurrentActivePlayer();this.playingQueue.push(t)}if(this.currentActivePlayer)return;this.stopActivePlayerAndPlayNext()}else null!==(s=this.currentActivePlayer)&&void 0!==s&&s.isPlayerAutoplaying(t.eid)?this.stopActivePlayerAndPlayNext():this.removePlayerFromQueue(t)}),{threshold:t instanceof l.f7?[.5,1]:.5});e.observe(t.el),this.emitter.listenTo(t,n.e.UNMOUNTED,(()=>{e.unobserve(t.el)}))}removePlayerFromQueue(t){const e=this.playingQueue.findIndex((e=>e===t));-1!==e&&this.playingQueue.splice(e,1)}playCurrentActivePlayer(){this.currentActivePlayer&&this.currentActivePlayer.play()}stopActivePlayerAndPlayNext(t=!1){var e;null===(e=this.currentActivePlayer)||void 0===e||e.pause(t),this.currentActivePlayer=void 0,this._activePlayerPlaybacks=0,this.playNextVideoInQueue()}playNextVideoInQueue(){this.playingQueue.length&&(this.createActivePlayer(this.playingQueue.shift()),this.playCurrentActivePlayer())}get activePlayerPlaybacks(){return this._activePlayerPlaybacks}set activePlayerPlaybacks(t){var e;t>=3?this.stopActivePlayerAndPlayNext(!0):(this._activePlayerPlaybacks=t,null===(e=this.currentActivePlayer)||void 0===e||e.resumePlay())}}},9625:(t,e,s)=>{"use strict";s.d(e,{y:()=>h});s(5827);var i=s(8211),n=s(2518),o=s(4519),r=s(3491);const a=s(6419),l=s(9755);class h extends o.u1{constructor(t){super(),this._options.state=n.uc.PREPARE,this.$els={player:void 0,preview:void 0,error:void 0,label:void 0,states:{},container:void 0},this.setOptions(t),this._currentPlayer=void 0,this._awaitsPlay=!1,this._playbacks=0}play(){return this._playbacks++,this}stop(){return this}destroy(){this.stop(),super.destroy()}show(){return this._options.isShown=!0,super.show(),this}hide(){return this._options.isShown=!1,super.hide(),this}togglePlay(t){return a.isUndefined(t)?this.state===n.uc.PREPARE?this:this.state===n.uc.UNSTARTED?this.play():this.stop():(t?this.play():this.stop(),this)}_prepareState(t){let e=t.toString().toLowerCase(),s=this.$(`.player__state[data-type="${e}"]`);return s.length?this.$els.states[t]=s.eq(0):this.$els.states[t]=l(document.createElement("div")).addClass("player__state player__state_hide").attr("type",e).appendTo(this.$el)}_changeState(t,e){let s=!0;return t===n.uc.PREPARE&&(t=n.uc.LOADING),e&&this.limitWidth&&this.$els&&this.$els.player&&this.$el&&this.$el.toggleClass("player_width_limit",t===n.uc.UNSTARTED||t===n.uc.PREPARE),this.$els&&this.$els.states[t]?((t===n.uc.UNSTARTED&&(!this.$els.states[n.uc.UNSTARTED]||this.$els.states[n.uc.UNSTARTED].is(":empty"))||t===n.uc.PLAYING&&this.dimension&&(this.dimension.width<=50||this.dimension.height<=50))&&(s=!1),this.$els.states[t].attr("style","").toggle(s).removeClass("player__state_show player__state_hide").addClass(e?"player__state_show":"player__state_hide"),t===n.uc.LOADING&&this._progressCircle&&(e?this._progressCircle.indeterminate=!0:this._progressCircle.stop()),this):this}progress(t){return this.showControls&&this.$els.states[n.uc.LOADING]?(this._progressCircle||(this._progressCircle=new r.j({indeterminate:!1}),this._progressCircle.appendTo(this.$els.states[n.uc.LOADING])),a.isUndefined(t)||t>=100?(this._progressCircle.indeterminate=!0,this):(this._progressCircle.indeterminate=!1,this._progressCircle.percent=t,this)):this}static durationTime(t){let e,s;return t=Math.floor(Number(t)),t-=(e=Math.floor(t/3600))&&3600*e,t-=(s=Math.floor(t/60))&&60*s,[e,s,t].reduce(((t,e,s)=>0===s&&0===e?t:t+(t.length?":"+(s>0&&e<10?"0"+e:e):e)),"")}_toggleProbeMessage(t){let e=this.marks.has("probe-isShown");return(t=a.isBoolean(t)?t:!e)===e?this:(this.$els.player.toggleClass("player__player_error_yes",t),t?this.marks.set("probe-isShown",!0):this.marks.delete("probe-isShown"),t||this.$els.probeMessage?this.$els.probeMessage?(this.$els.probeMessage.toggle(t),this):(this.$els.probeMessage=l('<div class="player__error-overlay">\n\t<div class="player__error-message">\n\t\t<p>Воспроизведение будет доступно после публикации</p>\n\t</div>\n</div>\n').appendTo(this.$el),this.$els.probeMessage.click((t=>{t.preventDefault(),t.stopPropagation(),this.stop()})),this):this)}get isProbe(){return this._options.isProbe}set isProbe(t){this._options.isProbe!==(t=Boolean(t))&&(this._options.isProbe=t)}get state(){return this._options.state}set state(t){if(t=n.uc[t]||n.uc.UNSTARTED,this._options.state===t)return this._options.state;this._options.state&&this._changeState(this._options.state,!1),this._changeState(t,!0),this._options.state=t,this.emit(t);let e=t===n.uc.UNSTARTED||t===n.uc.PREPARE;if(this.$els.play){let t=!e;this.$els.play.toggleClass("player__play_hide",t),t?this.timeout("hidePlayButton",i.ZP.ui.css.transitionTimeDefault,(()=>{this.$els.play.hide()})):(this.cancelTimeout("hidePlayButton"),this.$els.play.show())}return this.$els.preview&&this.$els.preview.toggleClass("player__preview_hide",!e),this.$els.player&&this.$els.player.toggleClass("player__player_hide",e),this._options.state}get isPlayed(){return this.state!==n.uc.UNSTARTED&&this.state!==n.uc.PREPARE}get dimension(){return this._options.dimension}set dimension(t){this._options.dimension=t}get source(){return this._options.source}set source(t){this._options.source=String(t)}get showControls(){return this._options.showControls}set showControls(t){this._options.showControls=Boolean(t)}get dimensionMode(){return this._options.dimensionMode}set dimensionMode(t){if(t=n.mW[t]||n.mW.STORY,!this.$el||t===this.dimensionMode)return this.dimensionMode;let e=t===n.mW.STORY?this.$el.closest(".story__main"):this.$parent;return e=e.is("a")?e.parent():e,this.$els.container=e.is("a")?e.parent():e,this._options.dimensionMode=t}get playbacks(){return this._playbacks}get limitWidth(){return this._options.limitWidth}set limitWidth(t){this._options.limitWidth=Boolean(t)}}},6471:(t,e,s)=>{"use strict";s.d(e,{AI:()=>n,B:()=>o,EC:()=>r,Hh:()=>a,eq:()=>l,Lh:()=>h,Az:()=>c,f6:()=>d,$A:()=>u,K$:()=>p,i3:()=>m,R$:()=>_,SD:()=>g});var i=s(2518);const n=18e7,o="0.4",r="pkb_Pt",a="pkb_WEBBAt",l="pkb_Ply_v",h=10,c="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg'%3E%3C/svg%3E",d="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAACGFjVEwAAAABAAAAAcMq2TYAAAANSURBVAiZY2BgYPgPAAEEAQB9ssjfAAAAGmZjVEwAAAAAAAAAAQAAAAEAAAAAAAAAAAD6A+gBAbNU+2sAAAARZmRBVAAAAAEImWNgYGBgAAAABQAB6MzFdgAAAABJRU5ErkJggg==",u="hide-sound-hint",p=3e3,m=1e3,_={[i.No.PLAY]:"video_play",[i.No.PAUSE]:"video_pause",[i.No.TIMELINE_CLICK]:"video_timeline_click",[i.No.FULLSCREEN_CHANGE]:"video_fullscreen",[i.No.SHOW_AD]:"show_ad",[i.No.CLICK_AD]:"click_ad",[i.No.SOUND_CHANGE]:"sound_change"},g={[i.VC.YOUTUBE]:"youtube",[i.VC.VIMEO]:"vimeo",[i.VC.VK]:"vk"}},2518:(t,e,s)=>{"use strict";s.d(e,{mW:()=>n,Zh:()=>o,Mj:()=>r,VC:()=>a,ev:()=>l,uc:()=>h,LE:()=>c,No:()=>d,OS:()=>u});var i=s(7892);const n=new i.xs({STORY:1,COMMENT:2}),o=new i.xs({READY:0,PROGRESS:1,PLAY:2,PAUSE:3,ERROR:4}),r=new i.xs({APNG:"a",VIDEO:"v",VIDEO_CANVAS:"vc",APNG_CANVAS:"ac",WEBP:"w",GIF:"g"}),a=new i.xs({YOUTUBE:0,VIMEO:1,RUTUBE:2,LIVELEAK:4,VK:5}),l=new i.xs({WEBMA:"webma",WEBM:"webm",MP4:"mp4",APNG:"png",WEBP:"webp",GIF:"gif"}),h=new i.xs({PREPARE:0,UNSTARTED:1,LOADING:2,PLAYING:3,PAUSED:4}),c=new i.xs({NONE:"none",IDLE:"idle",PLAY:"play",PAUSE:"pause",END:"end"}),d=new i.xs({READY:0,PROGRESS:1,TIMEUPDATE:2,PLAY:3,PAUSE:4,ENDED:5,SEEKED:6,ERROR:7,TIMELINE_CLICK:8,FULLSCREEN_CHANGE:9,SHOW_AD:10,CLICK_AD:11,SOUND_CHANGE:12}),u=(new i.xs({PLAY:0,TOGGLE:1}),new i.xs({PLAY:"video_start",FINISHED:"video_end"}))},4143:(t,e,s)=>{"use strict";s.d(e,{mW:()=>g.mW,ev:()=>g.ev,XM:()=>m,tv:()=>rt.tv,h7:()=>ot,S3:()=>Tt,f7:()=>pt,yw:()=>i.y,FW:()=>mt.F,i$:()=>Et});var i=s(9625),n=(s(6992),s(3948),s(6777)),o=s(8799),r=s(8211),a=s(7591);var l=s(4720),h=s(4519),c=s(9050);function d(t,e){var s=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),s.push.apply(s,i)}return s}function u(t,e,s){return e in t?Object.defineProperty(t,e,{value:s,enumerable:!0,configurable:!0,writable:!0}):t[e]=s,t}const p=s(9755);class m extends n.vp{constructor(){super(),this._providers=new rt.tv,this._tehnologies=new ot,this._currentPlayerId=void 0,this._attachedHotkey=!1}getTechnologyInstanceByType(t){return this._tehnologies.getTechnologyInstanceByType(t)}get technologies(){return this._tehnologies.technologies}getProviderInstanceByType(t){return this._providers.getProviderInstanceByType(t)}getProviderTypeBySource(t){return this._providers.getProviderTypeBySource(t)}get providers(){return this._providers.providers}init(t){(t=o.Zv.isJQuery(t)?t:o.Zv.isHTMLElement(t)?p(t):r.vE.ui.$els.body).find(".player").each(((t,e)=>{const s=p(e),i=s.data("type");let n,o,h=!1;if(s.data("player"))return!0;switch(s.closest(".story__content").length?o=g.mW.STORY:(o=g.mW.COMMENT,h=r.vE.applicationType===a.Zq.DESKTOP&&!r.vE.initParams.isCommAnimPreview),i){case"video-file":n=new mt.F({$el:s,dimensionMode:o});break;case"video":h=s.hasClass("player_viewer"),n=new Et({$el:s,dimensionMode:o,playAfterInitialization:h});break;case"gifx":n=new pt({$el:s,dimensionMode:o,playAfterInitialization:h&&void 0===r.vE.initParams.isVideoAutoplayMode})}if(!n)return!1;r.vE.initParams.isVideoAutoplayMode&&!1===s.closest(".story").data("page")&&["video-file","gifx"].includes(i)&&l.L.getInstance().initPlayer({player:n}),s.data("player",n)}))}get animationsData(){return this._animationsData?this._animationsData:this._animationsData=new Map(Object.entries(function(t){let[e,s,i]=t,n={};for(let[o,r,a,...l]of i){let t={width:r,height:a};l.forEach(((i,n)=>{let[r,a]=Array.isArray(i)?i:[i,i],l=n+1,h=1===l?"":`@${l}x`;t[l]={GIF:e+s[r]+o+h+".gif",APNG:e+s[a]+o+h+".png"}})),n[o]=t}return n}(r.vE.config("animations"))))}createAnimation(t,e){if(!this.animationsData.has(t))throw new Error("Not found animation "+t);let s=this.animationsData.get(t);return new Tt(function(t){for(var e=1;e<arguments.length;e++){var s=null!=arguments[e]?arguments[e]:{};e%2?d(Object(s),!0).forEach((function(e){u(t,e,s[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(s)):d(Object(s)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(s,e))}))}return t}({animationName:t,formats:s[Math.max(1,Math.min(2,Math.round(r.vE.ui.devicePixelRatio)))],dimension:{width:s.width,height:s.height}},e))}preloadAnimation(t){if(!this.animationsData.has(t))throw new Error("Not found animation "+t);let e=this.animationsData.get(t)[Math.max(1,Math.min(2,Math.round(r.vE.ui.devicePixelRatio)))][g.ev.APNG];document.querySelector(`link[rel="preload"][href="${e}"]`)||p("head").append(p(`<link rel="preload" href="${e}" as="image">`))}attachHotkey(){return this._attachedHotkey||(r.vE.ui.$els.document.on("mouseenter",".player",(t=>{if(!t.currentTarget)return!1;let e=h.u1.getUIElement(t.currentTarget);(e instanceof Et||e instanceof pt||e instanceof mt.F)&&(this._currentPlayerId=e.eid)})),this._attachedHotkey=!0,r.vE.ui.hotkeys.on("r",(()=>{r.vE.emit("playerSpecialToggle",this._currentPlayerId)}))),this}static getPlayerFromElement(t){const e=h.u1.getUIElement(t);if(e instanceof i.y)return e}stop(t){return void 0===t?(r.vE.emit("playerSpecialPlay",0),this):(c.forEach(t.find(".player"),(t=>this._stopPlayer(m.getPlayerFromElement(t)))),this)}_stopPlayer(t){if(t&&"function"==typeof t.stop&&t instanceof i.y)try{t.stop()}catch(e){throw new Error("player stop() throuble"+e)}return this}get currentPlayer(){return this._currentPlayerId}set currentPlayer(t){const e=this._currentPlayerId;if(t&&"string"!=typeof t){if(!(t=m.getPlayerFromElement(t)))return;t=t.eid}e!==t&&(this._currentPlayerId=t)}}s(8674);var _=s(6572),g=s(2518);class v{constructor(){this._detailsSupport={supported:!1},this._ready=void 0}serialize(){return this._detailsSupport}deserialize(t){this._detailsSupport=t,this._ready=Promise.resolve(this._detailsSupport.supported)}canPlay(t){return!0}get detailsSupport(){return this._detailsSupport}async _checkSupported(){return this._detailsSupport.supported}get supported(){return this._ready?this._ready:this._ready=this._checkSupported()}}class f extends v{constructor(){super(),this._detailsSupport.supported=!0}}class y extends h.u1{constructor(t){super(),this._player=t,this.$parent=t.$els.player}mount(){return this.$el.appendTo(this.$parent),super.mount(),this}show(){return this._options.isShown=!0,super.show(),this}hide(){return this._options.isShown=!1,super.hide(),this}play(){return this.show(),this}stop(){return this.hide(),this}destroy(){this.stop(),delete this._player,super.destroy()}}var b=s(6471);const w=s(9755);class E extends y{constructor(t){super(t),t.format=g.ev.GIF}render(){if(this.isRendered)return this;this.emit(g.Zh.PROGRESS);const t=this._player.source;return"string"==typeof t?this.$el=w(document.createElement("img")).addClass("player__gif").on("error",(()=>this.emit(g.Zh.ERROR))).on("load",(()=>this.emit(g.Zh.READY))).attr("src",t):this.emit(g.Zh.ERROR),super.render(),this}destroy(){this.isRendered&&this.$el.attr("src",b.Az),super.destroy()}}s(4916),s(5306),s(5827);const S=s(6419);class C extends v{constructor(){super(),this._videoFormatTest={[g.ev.MP4]:'video/mp4; codecs="avc1.42E01E"',[g.ev.WEBM]:'video/webm; codecs="vp8"'}}canPlay(t){return t.has(g.ev.WEBP)||t.has(g.ev.MP4)||this._detailsSupport[g.ev.WEBMA]&&t.has(g.ev.WEBMA)}_checkSupportedWebmAlpha(){let t,e=document.createElement("video");return _.mM.get(b.Hh)?(this._detailsSupport[g.ev.WEBMA]=!1,!0):(_.mM.set(b.Hh,"true"),r.vE.ua.windows&&"XP"===r.vE.ua.osversion?(this._detailsSupport[g.ev.WEBMA]=!1,!0):new Promise((s=>{let i=()=>{document.body.removeChild(e),this._detailsSupport[g.ev.WEBMA]=!1,s(!1)};e.autoplay=!1,e.loop=!1,e.style.display="none",e.addEventListener("loadeddata",(()=>{let t,n=document.createElement("canvas");document.body.removeChild(e),n.getContext&&n.getContext("2d")?(t=n.getContext("2d"),t.drawImage(e,0,0),0===t.getImageData(0,0,1,1).data[3]?(this._detailsSupport[g.ev.WEBMA]=!0,_.mM.remove(b.Hh),s(!0)):i()):i()}),!1),e.addEventListener("error",i),e.addEventListener("stalled",i),e.addEventListener("abort",i),t=document.createElement("source"),t.src="data:video/webm;base64,GkXfowEAAAAAAAAfQoaBAUL3gQFC8oEEQvOBCEKChHdlYm1Ch4ECQoWBAhhTgGcBAAAAAAACBRFNm3RALE27i1OrhBVJqWZTrIHlTbuMU6uEFlSua1OsggEjTbuMU6uEHFO7a1OsggHo7AEAAAAAAACqAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAVSalmAQAAAAAAADIq17GDD0JATYCNTGF2ZjU3LjU3LjEwMFdBjUxhdmY1Ny41Ny4xMDBEiYhARAAAAAAAABZUrmsBAAAAAAAARq4BAAAAAAAAPdeBAXPFgQGcgQAitZyDdW5khoVWX1ZQOYOBASPjg4QCYloA4AEAAAAAAAARsIFAuoFAmoECU8CBAVSygQQfQ7Z1AQAAAAAAAGfngQCgAQAAAAAAAFuhooEAAACCSYNCAAPwA/YAOCQcGFQAADBgAABnP///NXgndmB1oQEAAAAAAAAtpgEAAAAAAAAk7oEBpZ+CSYNCAAPwA/YAOCQcGFQAADBgAABnP///Vttk7swAHFO7awEAAAAAAAARu4+zgQC3iveBAfGCAXXwgQM=",t.addEventListener("error",i),e.appendChild(t),document.body.appendChild(e)})))}_checkSupportedVideo(){let t=document.createElement("video"),e=!1;return!!t.canPlayType&&(S.forEach(this._videoFormatTest,((s,i)=>{this._detailsSupport[i]=Boolean(t.canPlayType(s).replace(/^no$/,"")),e=e||this._detailsSupport[i]})),e)}_checkSupported(){return r.vE.ua.iphone&&!("playsInline"in document.createElement("video"))||r.vE.ua.android&&!r.vE.ua.check({chrome:"60.0.0"})||r.vE.ua.mobile&&r.vE.ua.opera?Promise.resolve(!1):Promise.all([this._checkSupportedVideo(),this._checkSupportedWebmAlpha()]).then((t=>this._detailsSupport.supported=S.reduce(t,((t,e)=>t||e),!1)))}}const T=s(9755),O=s(6419);class k extends y{constructor(t){super(t),this._videoError=0,this._onVideoErrorBound=this._onVideoError.bind(this),this._videoPriority=this._getVideoPriority(),this._player.format=this._videoPriority[0],this._loadingVideo=void 0,this._hasMeta=!1,this._needPlay=!1}_getVideoPriority(){let t=r.vE.ui.player.getTechnologyInstanceByType(g.Mj.VIDEO),e=[];return t.detailsSupport,[g.ev.WEBMA,g.ev.WEBM,g.ev.MP4].forEach((s=>{let i=t.detailsSupport[s.toString()];s=g.ev[s]||s,i&&g.ev.has(s)&&this._player.formats.has(s)&&e.push(s)})),e}render(){return this.isRendered?this:this._videoPriority.length?(this.emit(g.Zh.PROGRESS),this.$el=T(document.createElement("video")).addClass("player__video").prop({loop:"loop",muted:"muted",preload:"auto",playsinline:!0}).attr("playsinline","").attr("webkit-playsinline","").attr("muted","").appendTo(this._player.$els.player),this.el.loop=!0,this.$el.on({loadstart:this._onVideoLoading.bind(this),canplay:this._onVideoCanPlay.bind(this),loadedmetadata:this._onVideoLoadedMetaData.bind(this)}),this._videoPriority.forEach((t=>{T(document.createElement("source")).prop({src:this._player.getSourceByFormat(t),type:"video/"+(t===g.ev.WEBMA?g.ev.WEBM.valueOf():t.valueOf())}).on("error",this._onVideoErrorBound).appendTo(this.$el)})),super.render(),this):(this.emit(g.Zh.ERROR),this)}_onVideoError(){if(++this._videoError<this._videoPriority.length)return this;r.vE.logger.error("gifx","error loading HTML5 video"),this._stopWatchLoading(),this.emit(g.Zh.ERROR)}_onVideoLoading(){this.emit(g.Zh.PROGRESS)}_onVideoCanPlay(){this._hasMeta||this._player.state!==g.uc.LOADING||this.emit(g.Zh.PLAY),this._needPlay&&this.el.play()}_onVideoLoadedMetaData(){return this._player.state===g.uc.PLAYING||(this.emit(g.Zh.PROGRESS,0),this._hasMeta=!0,this._startWatchLoading()),!0}_startWatchLoading(){return this._loadingVideo||(this._loadingVideo=setInterval((()=>{let t,e,s=this.el.duration,i=this.el.buffered,n=i.length;for(;n--;)e=i.end(n)/s-i.start(n)/s;t=Number((100*e).toFixed()),this.emit(g.Zh.PROGRESS,t),t>=99&&(this.emit(g.Zh.PLAY),this._stopWatchLoading())}),100)),this}_stopWatchLoading(){return this._loadingVideo&&(clearInterval(this._loadingVideo),delete this._loadingVideo),this}play(){return super.play(),this.el.load(),r.vE.ua.ipad&&this.el.play(),this._needPlay=!0,this.emit(g.Zh.PROGRESS),this._startWatchLoading(),this}stop(){if(this._needPlay=!1,this.el&&O.isFunction(this.el.pause))try{this.el.pause()}catch(t){r.vE.logger.error("player","gifx video technology",t)}return this._stopWatchLoading(),super.stop(),this}}class I extends v{canPlay(t){return t.has(g.ev.MP4)}_checkSupported(){let t,e;return!r.vE.ua.iphone||Number(r.vE.ua.osversion.split(".")[0]||0)<=7?(this._detailsSupport.supported=!1,!1):(t=document.createElement("video"),e=document.createElement("canvas"),t.canPlayType&&"getContext"in e?this._detailsSupport.supported=Boolean(t.canPlayType('video/mp4; codecs="avc1.42E01E"').replace(/^no$/,"")):(this._detailsSupport.supported=!1,!1))}}const $=s(9755);class A extends y{constructor(t){super(t),this._player.format=g.ev.MP4,this.els={video:void 0},this._lastTime=0,this._needPlay=!1,this._currentPlaying=!1,this._ctxWidth=0,this._ctxHeight=0}render(){return this.isRendered||(this.emit(g.Zh.PROGRESS),this._ctxWidth=this._player.$els.player.width(),this._ctxHeight=this._player.$els.player.height(),this.$el=$(document.createElement("canvas")).appendTo(this._player.$els.player).attr("width",this._ctxWidth).attr("height",this._ctxHeight),this.els.ctx=this.el.getContext("2d"),this.$els.video=$(document.createElement("video")).addClass("player__video").prop({preload:"auto"}).attr("muted","").hide().appendTo(this._player.$els.player),this.els.video=this.$els.video.get(0),this.$els.video.on({loadstart:this._onVideoLoading.bind(this),timeupdate:this._onVideoTimeUpdate.bind(this),canplay:this._onVideoCanPlay.bind(this),loadedmetadata:this._onVideoLoadedMetaData.bind(this)}),$(document.createElement("source")).prop({src:this._player.source,type:"video/"+this._player.format.valueOf()}).on("error",this._onVideoError.bind(this)).appendTo(this.$els.video),this._loopBound=this._loop.bind(this),this.els.video.load(),super.render()),this}_loop(){let t=Date.now(),e=(t-this._lastTime)/1e3;return e>=1/b.Lh&&(this.els.video.currentTime=this.els.video.currentTime+e,this._lastTime=t),this.els.video.currentTime>=this.els.video.duration&&(this.els.video.currentTime=0),this.animationFrame("loop",this._loopBound),this}_drawFrame(){this.els.ctx.drawImage(this.els.video,0,0,this._ctxWidth,this._ctxHeight)}_onVideoError(){r.vE.logger.error("gifx","error loading HTML5 video"),this._stopWatchLoading(),this.emit(g.Zh.ERROR)}_onVideoTimeUpdate(){this._drawFrame()}_onVideoLoading(){this.emit(g.Zh.PROGRESS)}_onVideoCanPlay(){this._hasMeta||this._player.state!==g.uc.LOADING||this.emit(g.Zh.READY),this._drawFrame()}_onVideoLoadedMetaData(){return this._player.state===g.uc.PLAYING||(this.emit(g.Zh.PROGRESS,0),this._hasMeta=!0,this._startWatchLoading(),this._needPlay&&(this._currentPlaying=!0,this._loop())),!0}_startWatchLoading(){return this._loadingVideo||(this._loadingVideo=setInterval((()=>{let t,e,s=this.els.video.duration,i=this.els.video.buffered,n=i.length;for(;n--;)e=i.end(n)/s-i.start(n)/s;t=Number((100*e).toFixed()),this.emit(g.Zh.PROGRESS,t),t>=99&&(this.emit(g.Zh.PLAY),this._stopWatchLoading())}),100)),this}_stopWatchLoading(){return this._loadingVideo&&(clearInterval(this._loadingVideo),delete this._loadingVideo),this}play(){return super.play(),this._needPlay=!0,this.emit(g.Zh.PROGRESS),this._startWatchLoading(),this._loop(),this}destroy(){this.$els.video.off().remove(),delete this.els.video,delete this.els.ctx,super.destroy()}stop(){return this._currentPlaying=!1,this.cancelAnimationFrame("loop"),this._needPlay=!1,this._stopWatchLoading(),super.stop(),this}}const x=s(9755);class D extends v{constructor(){super(),this._detailsSupport.supported=!0}canPlay(t){return t.has(g.ev.APNG)}_checkSupported(){const t=document.createElement("canvas");return"getContext"in t?new Promise((e=>{const s=document.createElement("img");x(s).on("load",(()=>{const i=t.getContext("2d");i.drawImage(s,0,0);const n=0===i.getImageData(0,0,1,1).data[3];e(this._detailsSupport.supported=n)})).on("error",(function(){e(!1)})).attr("src",b.f6)})):Promise.resolve(this._detailsSupport.supported=!1)}}const P=s(9755);class R extends y{constructor(t){super(t),t.format=g.ev.APNG}render(){if(this.isRendered)return this;this.emit(g.Zh.PROGRESS);const t=this._player.source;return"string"==typeof t?this.$el=P(document.createElement("img")).addClass("player__apng").on("error",(()=>this.emit(g.Zh.ERROR))).on("load",(()=>this.emit(g.Zh.READY))).attr("src",t):this.emit(g.Zh.ERROR),super.render(),this}destroy(){this.isRendered&&this.$el.attr("src",b.Az),super.destroy()}}s(285),s(1637);s(9755);class M extends v{canPlay(t){return t.has(g.ev.APNG)}static checkSupportedABU(){return"ArrayBuffer"in window&&"URL"in window&&("http:"===location.protocol||"https:"===location.protocol)}_checkSupported(){const t=document.createElement("canvas");return this._detailsSupport.supported=!(!("getContext"in t)||!M.checkSupportedABU)}}s(3824);var N=s(5494);const B=function(){var t=this,e=0,s=0,i=null,n=!1,o=!1,r=[],a=function(t){for(;n&&e<=t;)l(t);n&&N.$.request(a)},l=function(a){var l=s++%t.frames.length,h=t.frames[l];if(!(0===t.numPlays||s/t.frames.length<=t.numPlays))return n=!1,void(o=!0);for(0===l&&(r.forEach((function(e){e.clearRect(0,0,t.width,t.height)})),i=null,2===h.disposeOp&&(h.disposeOp=1)),i&&1===i.disposeOp?r.forEach((function(t){t.clearRect(i.left,i.top,i.width,i.height)})):i&&2===i.disposeOp&&r.forEach((function(t){t.putImageData(i.iData,i.left,i.top)})),(i=h).iData=null,2===i.disposeOp&&(i.iData=r[0].getImageData(h.left,h.top,h.width,h.height)),0===h.blendOp&&r.forEach((function(t){t.clearRect(h.left,h.top,h.width,h.height)})),r.forEach((function(t){t.drawImage(h.img,h.left,h.top)})),0===e&&(e=a);a>e+t.playTime;)e+=t.playTime;e+=h.delay};this.width=0,this.height=0,this.numPlays=0,this.playTime=0,this.frames=[],this.play=function(){n||o||(this.rewind(),n=!0,N.$.request(a))},this.rewind=function(){e=0,s=0,i=null,n=!1,o=!1},this.addContext=function(t){if(r.length>0){let e=r[0].getImageData(0,0,this.width,this.height);t.putImageData(e,0,0)}r.push(t),t._apng_animation=this},this.removeContext=function(t){var e=r.indexOf(t);-1!==e&&(r.splice(e,1),0===r.length&&this.rewind(),"_apng_animation"in t&&delete t._apng_animation)},this.removeAllContext=function(){r=[]},this.isPlayed=function(){return n},this.isFinished=function(){return o}};let L;const F=new Uint8Array([137,80,78,71,13,10,26,10]);function U(t){const e=new Uint8Array(t);return new Promise((function(t,s){for(let h=0;h<F.length;h++)if(F[h]!==e[h])return void s("Not a PNG file (invalid file signature)");let i=!1;if(j(e,(function(t){return"acTL"!==t||(i=!0,!1)})),!i)return void s("Not an animated PNG");let n=[],o=[],r=null,a=null,l=new B;if(j(e,(function(t,e,s,i){switch(t){case"IHDR":r=e.subarray(s+8,s+8+i),l.width=V(e,s+8),l.height=V(e,s+12);break;case"acTL":l.numPlays=V(e,s+8+4);break;case"fcTL":a&&l.frames.push(a),a={},a.width=V(e,s+8+4),a.height=V(e,s+8+8),a.left=V(e,s+8+12),a.top=V(e,s+8+16);{let t=H(e,s+8+20),i=H(e,s+8+22)||100;a.delay=1e3*t/i}a.delay<=10&&(a.delay=100),l.playTime+=a.delay,a.disposeOp=q(e,s+8+24),a.blendOp=q(e,s+8+25),a.dataParts=[];break;case"fdAT":a&&a.dataParts.push(e.subarray(s+8+4,s+8+i));break;case"IDAT":a&&a.dataParts.push(e.subarray(s+8,s+8+i));break;case"IEND":o.push(W(e,s,12+i));break;default:n.push(W(e,s,12+i))}})),a&&l.frames.push(a),0!==l.frames.length){let e,i=0,h=new Blob(n),c=new Blob(o);for(let n=0;n<l.frames.length;n++){a=l.frames[n];let o=[];o.push(F),r.set(Y(a.width),0),r.set(Y(a.height),4),o.push(z("IHDR",r)),o.push(h);for(let t=0;t<a.dataParts.length;t++)o.push(z("IDAT",a.dataParts[t]));o.push(c),e=URL.createObjectURL(new Blob(o,{type:"image/png"})),delete a.dataParts,o=null,a.img=document.createElement("img"),a.img.onload=function(){URL.revokeObjectURL(this.src),i++,i===l.frames.length&&t(l)},a.img.onerror=function(){s("Image creation error")},a.img.src=e}}else s("Not an animated PNG")}))}const j=function(t,e){let s,i,n,o=8;do{s=V(t,o),i=G(t,o+4,4),n=e(i,t,o,s),o+=12+s}while(!1!==n&&"IEND"!==i&&o<t.length)},V=function(t,e){let s=0;s+=t[0+e]<<24>>>0;for(let i=1;i<4;i++)s+=t[i+e]<<8*(3-i);return s},H=function(t,e){let s=0;for(let i=0;i<2;i++)s+=t[i+e]<<8*(1-i);return s},q=function(t,e){return t[e]},W=function(t,e,s){const i=new Uint8Array(s);return i.set(t.subarray(e,e+s)),i},G=function(t,e,s){const i=Array.prototype.slice.call(t.subarray(e,e+s));return String.fromCharCode.apply(String,i)},Y=function(t){return[t>>>24&255,t>>>16&255,t>>>8&255,255&t]},z=function(t,e){let s=t.length+e.length,i=new Uint8Array(new ArrayBuffer(s+8));i.set(Y(e.length),0),i.set(function(t){let e=[];for(let s=0;s<t.length;s++)e.push(t.charCodeAt(s));return e}(t),4),i.set(e,8);let n=function(t,e,s){if(!L){L=new Uint32Array(256);for(let t=0;t<256;t++){let e=t;for(let t=0;t<8;t++)e=1&e?3988292384^e>>>1:e>>>1;L[t]=e}}let i=-1;for(let n=e=e||0,o=e+(s=s||t.length-e);n<o;n++)i=i>>>8^L[255&(i^t[n])];return-1^i}(i,4,s);return i.set(Y(n),s+4),i};var Z={},K={};Z.parseBuffer=function(t){return U(t)},Z.parseURL=function(t){return t in K||(K[t]=function(t){return new Promise((function(e,s){var i=new XMLHttpRequest;i.open("GET",t),i.responseType="arraybuffer",i.onload=function(){200===this.status?e(this.response):s(this)},i.send()}))}(t).then(U)),K[t]},Z.animateContext=function(t,e){return Z.parseURL(t).then((function(t){return t.addContext(e),t.play(),t}))},Z.animateImage=function(t){return t.setAttribute("data-is-apng","progress"),Z.parseURL(t.src).then((function(e){t.setAttribute("data-is-apng","yes");let s=document.createElement("canvas");s.width=e.width,s.height=e.height,Array.prototype.slice.call(t.attributes).forEach((function(t){-1===["alt","src","usemap","ismap","data-is-apng","width","height"].indexOf(t.nodeName)&&s.setAttributeNode(t.cloneNode(!1))})),s.setAttribute("data-apng-src",t.src),""!==t.alt&&s.appendChild(document.createTextNode(t.alt));{let e="",i="",n=0,o="";""!==t.style.width&&"auto"!==t.style.width?e=t.style.width:t.hasAttribute("width")&&(e=t.getAttribute("width")+"px"),""!==t.style.height&&"auto"!==t.style.height?i=t.style.height:t.hasAttribute("height")&&(i=t.getAttribute("height")+"px"),""!==e&&""===i&&(n=parseFloat(e),o=e.match(/\D+$/)[0],i=Math.round(s.height*n/s.width)+o),""!==i&&""===e&&(n=parseFloat(i),o=i.match(/\D+$/)[0],e=Math.round(s.width*n/s.height)+o),s.style.width=e,s.style.height=i}{let e=t.parentNode;e.insertBefore(s,t),e.removeChild(t)}return e.addContext(s.getContext("2d")),e.play(),e}),(function(){t.setAttribute("data-is-apng","no")}))},Z.releaseCanvas=function(t){var e=t.getContext("2d");"_apng_animation"in e&&e._apng_animation.removeContext(e)};const X=Z,Q=s(9755);class J extends y{constructor(t){super(t),t.format=g.ev.APNG}render(){if(this.isRendered)return this;this.emit(g.Zh.PROGRESS);const t=this._player.source;return this.$el=Q(document.createElement("img")).addClass("player__apng").attr("src",t),X.animateImage(this.el).then((t=>{this.emit(g.Zh.READY),this._apng=t})).catch((()=>this.emit(g.Zh.ERROR))),super.render(),this}destroy(){this._apng&&(this._apng.rewind(),this._apng.removeAllContext(),delete this._apng),super.destroy()}}const tt=s(9755);class et extends v{canPlay(t){return t.has(g.ev.WEBP)}_checkSupported(){return new Promise((t=>{let e=document.createElement("img");tt(e).on({load:()=>{2===e.width&&1===e.height?t(this._detailsSupport.supported=!0):t(!1)},error:()=>t(!1)}).attr("src","data:image/webp;base64,UklGRjIAAABXRUJQVlA4ICYAAACyAgCdASoCAAEALmk0mk0iIiIiIgBoSygABc6zbAAA/v56QAAAAA==")}))}}const st=s(9755);class it extends y{constructor(t){super(t),t.format=g.ev.WEBP}render(){return this.isRendered||(this.emit(g.Zh.PROGRESS),this.$el=st(document.createElement("img")).addClass("player__webp").on("error",(()=>{this.emit(g.Zh.ERROR)})).on("load",(()=>{this.emit(g.Zh.READY)})).attr("src",this._player.source),super.render()),this}destroy(){this.isRendered&&this.$el.attr("src",b.Az),super.destroy()}}const nt=s(6419);class ot{constructor(){this._supportTechnologies=new Map,this._ready=void 0,this._technologiesStorage=new Map}_loadSupportedTechnologiesStorage(){let t=_.mM.get(b.EC);return!(!(nt.isObject(t)&&t.v===b.B&&nt.isObject(t.l)&&nt.isNumber(t.t))||Number(t.t)+b.AI<Date.now())&&(nt.forEach(t.l,((t,e)=>{g.Mj[e]&&(nt.isBoolean(t)||nt.isObject(t))&&this._technologiesStorage.set(g.Mj[e],t)})),!0)}_saveSupportedTechnologiesStorage(){let t={l:{},v:b.B,t:Date.now()};for(let[e,s]of this._technologiesStorage)t.l[e.valueOf()]=s;_.mM.set(b.EC,t)}async _getSupportedTechnologies(){let t;if(this._ready)return this._ready;t=this._loadSupportedTechnologiesStorage();for(let e of g.Mj.entries()){let t,s=ot.getTechnologyByType(e);if(!s)throw new Error("Can't find technology "+e);t=new s,this._technologiesStorage.has(e)&&t.deserialize(this._technologiesStorage.get(e));const i=await t.supported;this._technologiesStorage.set(e,t.serialize()),i&&this._supportTechnologies.set(e,t)}return t||this._saveSupportedTechnologiesStorage(),this._supportTechnologies}static getTechnologyPlayerByType(t){switch(t){case g.Mj.APNG:return R;case g.Mj.APNG_CANVAS:return J;case g.Mj.VIDEO:return k;case g.Mj.VIDEO_CANVAS:return A;case g.Mj.WEBP:return it;case g.Mj.GIF:return E}throw new Error("Not found player technology for type "+t)}static getTechnologyByType(t){switch(t){case g.Mj.APNG:return D;case g.Mj.APNG_CANVAS:return M;case g.Mj.VIDEO:return C;case g.Mj.VIDEO_CANVAS:return I;case g.Mj.WEBP:return et;case g.Mj.GIF:return f}throw new Error("Not found playback technology for type "+t)}getTechnologyInstanceByType(t){return this._supportTechnologies.get(t)}get technologies(){return this._ready?this._ready:this._ready=this._getSupportedTechnologies()}}var rt=s(6726);var at=s(7320),lt=s(2822);function ht(t,e){var s=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),s.push.apply(s,i)}return s}function ct(t,e,s){return e in t?Object.defineProperty(t,e,{value:s,enumerable:!0,configurable:!0,writable:!0}):t[e]=s,t}const dt=s(9755),ut=s(6419);class pt extends i.y{constructor(t={}){super(function(t){for(var e=1;e<arguments.length;e++){var s=null!=arguments[e]?arguments[e]:{};e%2?ht(Object(s),!0).forEach((function(e){ct(t,e,s[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(s)):ht(Object(s)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(s,e))}))}return t}({showControls:!0},t)),this._options.formats=new Map,this._queueTechnology=void 0,this._technologiesPriority=new Set,this._timeGifStartDownload=0,this._timeGifDownloaded=0,this._analyticsSending=!1,this._toggleBound=t=>{let e=t&&dt(t.target);if(e&&(e.closest(".player__save",this.$el).length||e.hasClass("player__try-again")))return this;t&&t.preventDefault&&t.preventDefault(),this.state===g.uc.UNSTARTED&&(this._timeGifStartDownload=Date.now()),this.togglePlay()};const e=String(this.$el.data("source")||"");this.source=e.slice(0,e.indexOf("gif")),this.isProbe=Boolean(this.$el.data("probe")),this._setAvailableFormatsFromData(),this._setDimensionFromData(),this._setTechnologyPriority().then((()=>{this.show(),this.state=g.uc.UNSTARTED,this._setNextTechnology(),this.playAfterInitialization&&!this.isProbe&&this.$el.is(":visible")&&this.play()})),this.isProbe||this.listenTo(r.ZP,"playerSpecialToggle",(t=>{t===this.eid&&this.togglePlay()}))}_updateDimension(){r.ZP.applicationType===a.Zq.DESKTOP?this._updateDimensionDesktop():this._updateDimensionMobile()}_updateDimensionDesktop(){if(!this.dimension)return;let t=2*r.ZP.ui.css.paddingLeft,e=this.$el.closest(".story__main"),s=e.width(),i=this.dimension.width,n=r.ZP.ui.windowHeight/10*7,o=this.dimension.height;const[a,l]=_.cQ.calculateAspectRatioFit(i,o,s,n,!1);e.hasClass("aflm__main")||this.$el.parent().toggleClass("story-block_padding_left",a+t<=s),this.$els.stretch?this.$els.stretch.css({maxWidth:a,maxHeight:l}):this.state!==g.uc.UNSTARTED?this.$els.player.css({width:a,height:l}):this.$els.preview.css({height:l})}_updateDimensionMobile(){if(!this.dimension)return;let t=this.dimensionMode===g.mW.COMMENT?this.$els.container.width()||150:this.$el.closest(".story__main").width();if(!t)return;let e=r.ZP.ui.windowWidth<1023?30:0,s=Math.floor(r.ZP.ui.screenHeight/10*7),i=this.dimension.height/this.dimension.width,[n,o]=_.cQ.calculateAspectRatioFit(t,t*i,t,s,!1);this.dimensionMode===g.mW.STORY&&e&&(n<t?([n,o]=_.cQ.calculateAspectRatioFit(t,t*i,t-e,s,!1),this.$el.parent().toggleClass("story-block_padding_left",!0)):this.$el.parent().toggleClass("story-block_padding_left",!1)),n=parseFloat(n.toFixed(3)),o=parseFloat(o.toFixed(3)),this.$els.stretch&&((this.dimensionMode===g.mW.STORY||this.state!==g.uc.UNSTARTED&&this.state!==g.uc.PREPARE)&&this.$els.stretch.css({width:n,height:o}),this.$els.stretch.css({maxWidth:n,maxHeight:o})),this.$els.player.length&&this.$els.player.css({width:n,height:o})}render(){return this.isRendered||(this.$els.preview=this.$(".player__preview").eq(0),this.$els.player=this.$(".player__player").eq(0),this.$els.play=this.$(".player__play").eq(0),this.$els.stretch=this.$(".player__svg-stretch").eq(0),this.$els.label=this._prepareState(g.uc.UNSTARTED),this._prepareState(g.uc.LOADING).empty(),this.progress(),this.limitWidth=this.$el.hasClass("player_width_limit"),this._updateDimension(),r.ZP.applicationType===a.Zq.DESKTOP?this.dimensionMode===g.mW.STORY&&this.listenTo(r.ZP.ui,"resize",ut.throttle((()=>{this.animationFrame("resize",this._updateDimension)}),300)):this.listenTo(r.ZP.ui,"gifx-orientationchange",(()=>this._updateDimension())),this.$els.player.length||(this.$els.player=dt(document.createElement("div")).addClass("player__player player__player_hide").appendTo(this.$el)),this.$els.save=dt(document.createElement("a")).addClass("player__save").attr("href",this.getSourceByFormat(g.ev.GIF)).attr("target","_blank").html(r.ZP.icon("ui__save","player")).appendTo(this._prepareState(g.uc.PLAYING)),this.$el.click(this._toggleBound),super.render()),this}play(){return this.state!==g.uc.UNSTARTED?this:this.isProbe?(this._toggleProbeMessage(!0),this):(this.technology||this._setNextTechnology(),this._currentPlayer&&this._currentPlayer.play(),this._updateDimension(),this._timeGifStartDownload=Date.now(),super.play(),this)}_sendAnalytics(){if(this._analyticsSending)return;this._analyticsSending=!0;const t=this._prepareAnalyticsParams();lt.c.getInstance().sendEvent("image_view",t,[at.b.CLICKHOUSE]),this._analyticsSending=!1}_prepareAnalyticsParams(){let t=Number((this.formats.get(this.format)/1024).toFixed(3));if(Number.isNaN(t)){const e=this.el.dataset.source,s=new XMLHttpRequest;s.open("HEAD",e,!1),s.send(null);const i=s.getResponseHeader("content-length");t=parseFloat((i/1048576).toFixed(3))}const e=this.$el.closest(".story[data-story-id]"),s=null==e?void 0:e.data("story-id"),i=this.$el.closest(".comment[data-id]"),n=null==i?void 0:i.data("id"),o=e.data("subs-code");let r,a,l,h,c,d;if(s){r=e.data("comments"),a=Number(e.data("author-id"));const t=e.data("meta-rating");t&&([l,h]=t.split(":").map((t=>Number(t))));const s=dt(".stories-feed__container").find(".story");s.length>0&&-1!==dt.inArray(e[0],s)&&(c=dt.inArray(e[0],s)+1)}if(n){a=Number(i.data("meta").match(/aid=(\d+)/)[1]);const t=i.data("meta").match(/av=(\d+):(\d+)/);t&&(l=Number(t[1]),h=Number(t[2]))}const u=(null!=e&&e.length?e:i).find('[data-type="gifx"]');return u.length>1&&(d=dt.inArray(this.el,u)+1),{"post_id!empty":null==e?void 0:e.data("story-id"),"comment_id!empty":null==i?void 0:i.data("id"),"comments!empty":r,author_id:a,"screen_index!empty":c,"type_i8!empty":o,list_f32:[Number(this.el.dataset.width),Number(this.el.dataset.height)],type:"gif",length:(this._timeGifDownloaded-this._timeGifStartDownload)/1e3,size:t,pluses:l,minuses:h,level:d}}stop(){return this.marks.has("error-isShown")&&this._toggleErrorLoading(!1),this.marks.has("probe-isShown")&&this._toggleProbeMessage(!1),this.state===g.uc.UNSTARTED||(this.technology&&(this.technology=void 0,this._queueTechnology=void 0),this.state=g.uc.UNSTARTED,this.dimensionMode===g.mW.COMMENT&&this.$els.stretch&&this.$els.stretch.css({width:"",height:""})),this}_setDimensionFromData(){if(!this.$el)return this;let t={width:parseFloat(this.$el.data("width"))||0,height:parseFloat(this.$el.data("height"))||0};return t.width&&(this.dimension=t),this}_setAvailableFormatsFromData(){g.ev.entries().forEach((t=>{let e=this.$el.data(`size-${t.valueOf()}`);e&&this._options.formats.set(t,e)}))}_updateStateFileSize(){let t=this.formats.get(this.format)||0;return t<=0||(this.$els.label.empty(),this.$els.label.append(r.ZP.i18n("player.providers.gif")),this.$els.label.append(dt(document.createElement("span")).addClass("player__label player__label_separator").html("&#x25CF;")),this.$els.label.append(t>1e3?(t/1024).toFixed(1)+" Мб":t+" Кб"),this.$els.states[g.uc.UNSTARTED].show()),this}async _setTechnologyPriority(){return(await r.ZP.ui.player.technologies).forEach(((t,e)=>{t.canPlay(this._options.formats)&&this._technologiesPriority.add(e)})),this}_setNextTechnology(t){return this.technology=t||this._getNextTechnology(),this.technology||(this._queueTechnology=void 0,this._currentPlayer=void 0,this._toggleErrorLoading(!0)),this}_getNextTechnology(){return this._queueTechnology||(this._queueTechnology=this._technologiesPriority.values()),this._queueTechnology.next().value}_downgradeTechnology(){return r.ZP.logger.log("player","downgrade"),this.technology!==g.Mj.GIF&&this._technologiesPriority.delete(this.technology),this._setNextTechnology(),this}_toggleErrorLoading(t){let e=this.marks.has("error-isShown");return(t=ut.isBoolean(t)?t:!e)===e?this:(this.$els.player.toggleClass("player__player_error_yes",t),t?this.marks.set("error-isShown",!0):this.marks.delete("error-isShown"),t||this.$els.errorOverlay?this.$els.errorOverlay?(this.$els.errorOverlay.toggle(t),this):(this.$els.errorOverlay=dt('<div class="player__error-overlay">\n\t<div class="player__error-message">\n\t\t<p>Непредвиденная ошибка</p>\n\n\t\t<p><button class="button button player__try-again">Попробовать еще раз?</button></p>\n\t</div>\n</div>\n').appendTo(this.$el),this.$els.errorOverlay.click((t=>{t.preventDefault(),t.stopPropagation(),this.stop()})).find(".player__try-again").click((t=>{t.preventDefault(),t.stopPropagation(),this.stop().play()})),this):this)}get playAfterInitialization(){return this._options.playAfterInitialization}set playAfterInitialization(t){return this._options.playAfterInitialization=Boolean(t)}get format(){return this._options.format}set format(t){this._options.format=g.ev[t]||g.ev.GIF,this._updateStateFileSize()}get technology(){return this._options.technology}set technology(t){if(t=g.Mj[t],this._options.technology===t)return this._options.technology;if(this._currentPlayer&&(this._currentPlayer.destroy(),this._currentPlayer=void 0),!t)return this._options.technology=t;let e=ot.getTechnologyPlayerByType(t);return this._currentPlayer=new e(this),this.listenTo(this._currentPlayer,n.bB,this._playerEvent),this._options.technology=t,this.state!==g.uc.UNSTARTED&&this._currentPlayer.play(),t}_playerEvent(t,e){return g.Zh[t]?t===g.Zh.ERROR?(this._downgradeTechnology(),this):t===g.Zh.PROGRESS?(this.state=g.uc.LOADING,this.progress(e),this):(t!==g.Zh.PLAY&&t!==g.Zh.READY||(this._timeGifDownloaded=Date.now(),this._sendAnalytics(),this.emit("gifx-play")),this.state=g.uc.PLAYING,this):this}getSourceByFormat(t){return this._options.source+t.valueOf()}get source(){return this.getSourceByFormat(this.format)}set source(t){return this._options.source=String(t)}get formats(){return this._options.formats}}var mt=s(7580),_t=s(3680),gt=s(1270);function vt(t,e){var s=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),s.push.apply(s,i)}return s}function ft(t){for(var e=1;e<arguments.length;e++){var s=null!=arguments[e]?arguments[e]:{};e%2?vt(Object(s),!0).forEach((function(e){yt(t,e,s[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(s)):vt(Object(s)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(s,e))}))}return t}function yt(t,e,s){return e in t?Object.defineProperty(t,e,{value:s,enumerable:!0,configurable:!0,writable:!0}):t[e]=s,t}const bt=s(6419),wt=s(9755);class Et extends i.y{constructor(t){super(bt.defaults(t,{showControls:!0})),this._toggleBound=t=>{let e=t&&wt(t.target);if(e&&e.closest(".player__save",this.$el).length)return this;t&&t.preventDefault&&t.preventDefault(),this.togglePlay()},this._setVideoDetailFromData(),r.vE.ui.player.providers.then((()=>{if(this.isDestroyed)return;if(this._providerType=r.vE.ui.player.getProviderTypeBySource(this.source),this.provider=r.vE.ui.player.getProviderInstanceByType(this._providerType),this.show(),this.isProbe)return void(this.state=g.uc.UNSTARTED);let t=rt.tv.getProviderPlayerByType(this._providerType);this._currentPlayer=new t(this),this.listenTo(this._currentPlayer,n.bB,this._playerEvent),this.original?(this._currentPlayer.show(),this.state=g.uc.PLAYING):(this.state=g.uc.UNSTARTED,this.playAfterInitialization&&!this.isProbe&&this.$el.is(":visible")&&this.play())})),this.isProbe||(this.listenTo(r.vE,"playerSpecialPlay",(t=>{t!==this.eid&&this.isPlayed&&this.stop()})),this.listenTo(r.vE,"playerSpecialToggle",(async t=>{if(t===this.eid){if(this._currentPlayer&&this.state===g.uc.PLAYING){const t=await this._currentPlayer.getCurrentTime();this._playerAnalytics.sendAnalytics(g.No.PAUSE,ft({type:b.SD[this._providerType],length:this.duration},t&&{view_time:t}))}this.togglePlay()}})))}render(){return this.isRendered||(this.$els.preview=this.$(".player__preview").eq(0),this.$els.player=this.$(".player__player").eq(0),this.$els.play=this.$(".player__play").eq(0),this.limitWidth=this.$el.hasClass("player_width_limit"),this.$els.label=this._prepareState(g.uc.UNSTARTED),this.$els.label.append(this.provider.logo),this.$els.label.append(wt(document.createElement("span")).addClass("player__label player__label_separator").html("&#x25CF;")),this.$els.label.append(i.y.durationTime(this.duration)),this._prepareState(g.uc.LOADING).empty(),this.progress(),this.$els.player.length||(this.$els.player=wt(document.createElement("div")).addClass("player__player player__player_hide").appendTo(this.$el)),this.$els.preview&&this.$els.player.css("background-image",this.$els.preview.css("background-image")),this.$el.click(this._toggleBound),this._playerAnalytics=new gt.L(this.$el),super.render()),this}_playerEvent(t,e){if(!g.No[t])return this;if(t===g.No.PROGRESS)return this.state=g.uc.LOADING,this.progress(e),this;if(!this.adId){const s=this.marks.get("time-before-hotkey-toggle");if(t===g.No.SHOW_AD||t===g.No.CLICK_AD)return this._playerAnalytics.sendAnalytics(t,ft({content_type:b.SD[this._providerType]},e)),this;this._playerAnalytics.sendAnalytics(t,ft(ft({type:b.SD[this._providerType],length:this.duration},e),s&&{view_time:s}))}return t===g.No.PLAY&&this.adId&&!_t.o.isPlayVideo(this.adId)&&_t.o.setPlayVideo(this.storyId,this.adId,this.referrerStoryId),this.state=g.uc.PLAYING,this}_setVideoDetailFromData(){const t=this.$el.data("story-id"),e=this.$el.data("vid")||0;if(this._options.storyId=t,this._options.adId=!(!e||e===t)&&e,this._options.adId){const e=wt(`.story[data-story-id="${t}"][data-rsid]`);e.length&&e.data("rsid")&&(this._options.referrerStoryId=Number(e.data("rsid")))}return this._options.original=Boolean(this.$el.data("original")),this.setOptions({duration:parseInt(this.$el.data("duration"),10)||0,ratio:parseFloat(this.$el.data("ratio")||1.78),source:String(this.$el.data("source")),isProbe:Boolean(this.$el.data("probe"))}),this}play(){return this.isProbe?(this._toggleProbeMessage(!0),this):this.state===g.uc.UNSTARTED&&this.provider?(this._currentPlayer&&this._currentPlayer.play(),r.vE.emit("playerSpecialPlay",this.eid),super.play(),this):this}stop(){return this.marks.has("probe-isShown")&&this._toggleProbeMessage(!1),this.state===g.uc.UNSTARTED||(this._currentPlayer&&this._currentPlayer.stop(),this.original||(this.state=g.uc.UNSTARTED)),this}get adId(){return this._options.adId}get storyId(){return this._options.storyId}get referrerStoryId(){return this._options.referrerStoryId}get duration(){return this._options.duration}set duration(t){this._options.duration=Number(t)}get ratio(){return this._options.ratio}set ratio(t){this._options.ratio=parseFloat(t)||1.7777777778}get provider(){return this._options.provider}set provider(t){this._options.provider=t}get original(){return this._options.original}get playAfterInitialization(){return this._options.playAfterInitialization}set playAfterInitialization(t){return this._options.playAfterInitialization=Boolean(t)}}const St=s(9755),Ct=s(6419);class Tt extends i.y{constructor(t){super(Ct.defaults(t,{showControls:!0})),this._currentPlayer=void 0,this._queueTechnology=void 0,this._technologiesPriority=new Set,this._setTechnologyPriority().then((()=>{this.isDestroyed||(this.render(),this.state=g.uc.UNSTARTED,this._awaitsPlay&&this.play())}))}mount(){if(this.isMounted)return this;this.$el.parent().length||this.appendTo(this.$parent),super.mount()}render(){let t;return this.isRendered||(t=St(document.createElement("div")).addClass("player").attr("data-animation-name",this.animationName).attr("data-type","animation"),this.inside?(this.$el=St(document.createElement("div")).addClass("player__wrapper player__wrapper_absolute"),this.$els.inner=t.appendTo(this.$el),this.$parent=this.inside):this.$el=t,this.indent&&this.$el.addClass("player_indent"+(25===this.indent?"":"_"+this.indent)),St(document.createElement("div")).addClass("player__overlay").appendTo(this.$el),this.$els.player=St(document.createElement("div")).addClass("player__player player__player_hide").appendTo(t),super.render()),this}play(){if(this.state!==g.uc.UNSTARTED)return this._awaitsPlay=!0,this;if(this.show(),this.inside){let[t,e]=_.cQ.calculateAspectRatioFit(this.dimension.width,this.dimension.height,this.$el.innerWidth()-2*this.indent,this.$el.innerHeight()-2*this.indent);this.$els.inner.css({width:t,height:e})}else this.$el.css(this.dimension);return this.technology||this._setNextTechnology(),this._currentPlayer&&this._currentPlayer.play(),this}stop(){return this.state===g.uc.UNSTARTED?(this._awaitsPlay=!1,this):(this.technology&&(this.technology=void 0,this._queueTechnology=void 0),this.hide(),this.state=g.uc.UNSTARTED,this)}async _setTechnologyPriority(){let t=await r.vE.ui.player.technologies;return this.isDestroyed||t.forEach(((t,e)=>{t.canPlay(this._options.formats)&&this._technologiesPriority.add(e)})),this}_setNextTechnology(t){return this.technology=t||this._getNextTechnology(),this.technology||(this._queueTechnology=void 0,this._currentPlayer=void 0),this}_getNextTechnology(){return this._queueTechnology||(this._queueTechnology=this._technologiesPriority.values()),this._queueTechnology.next().value}_downgradeTechnology(){return r.vE.logger.log("player","downgrade"),this.technology!==g.Mj.GIF&&this._technologiesPriority.delete(this.technology),this._setNextTechnology(),this}get format(){return this._options.format}set format(t){return t=g.ev[t]||g.ev.GIF,this._options.format=t}get technology(){return this._options.technology}set technology(t){if(t=g.Mj[t],r.vE.logger.log("animation","technology",t),this._options.technology===t)return this._options.technology;if(this._currentPlayer&&this._currentPlayer.destroy(),!t)return this._options.technology=t;let e=ot.getTechnologyPlayerByType(t);return this._currentPlayer=new e(this),this.listenTo(this._currentPlayer,n.bB,this._playerEvent),this._options.technology=t,this.state!==g.uc.UNSTARTED&&this._currentPlayer.play(),t}_playerEvent(t){return g.Zh[t]?t===g.Zh.ERROR?(this._downgradeTechnology(),this):(this.state=g.uc.PLAYING,this):this}getSourceByFormat(t){return t=g.ev[t],this.formats.get(t)}get dimension(){return this._options.dimension}set dimension(t){return this.$els&&this.$els.player&&this.$els.player.css(t),this._options.dimension=t}get source(){return this.getSourceByFormat(this.format)}set source(t){return this._options.source=String(t)}get formats(){return this._options.formats}set formats(t){return this._options.formats||(this._options.formats=new Map),Ct.forEach(t,((t,e)=>{this._options.formats.set(g.ev[e],t)})),this._options.formats}get inside(){return this._options.inside}set inside(t){return this._options.inside===t?this.inside:this._options.inside=t}get indent(){return this._options.indent||0}set indent(t){return t=Ct.isBoolean(t)?t?25:0:parseInt(t,10)||0,this._options.indent===t?this._options.indent:(this.isRendered&&this.$el.addClass("player_indent"+(25===t?"":"_"+t)),this._options.indent=t)}get animationName(){return this._options.animationName}set animationName(t){this._options.animationName!==t&&(this._options.animationName=t)}}},6726:(t,e,s)=>{"use strict";s.d(e,{tv:()=>K});s(8674);var i=s(8211),n=s(4519),o=s(7912),r=s(4391),a=s(2518);const l=s(9755);class h extends n.u1{constructor(t){super(),this._player=t,this.$parent=t.$els.player,this._adLoader=null,this._isPostollAutoPaused=!1,this._intersectionObserver=null,this.listenTo(i.vE.ui,"visibilitychange",(()=>{const t=o.E.isShown,e=i.vE.ui.elementInViewport(this.$el);this._onVisibilityChange(t&&e)})),this.listenTo(i.vE.ui,"fullscreenchange",(async(t,e)=>{if(l(e).closest(this.$parent).length){const e={status:t?"on":"off",view_time:await this.getCurrentTime()},s=this._player.el.dataset.subtype;s&&(e.type=s),this.emit(a.No.FULLSCREEN_CHANGE,e)}}))}getCurrentTime(){return Promise.resolve(0)}set adLoader(t){this._adLoader=t}get adLoader(){return this._adLoader}initIntersectionObserver(){const t=!r.v,e=Boolean(this._intersectionObserver);if(t||e)return;const s=i.vE.ui.getHeaderHeight(),n=i.vE.isMobileApp?`-${s}px`:"0px";this._intersectionObserver=new IntersectionObserver((t=>{t.length&&this._onVisibilityChange(t[0].isIntersecting)}),{rootMargin:n,threshold:.2}),this._intersectionObserver.observe(this.$parent.parent(".player")[0])}_onVisibilityChange(t){const e=this._getPostrollState(),s=e===a.LE.PLAY,i=e===a.LE.PAUSE;t&&i&&this._isPostollAutoPaused&&(this._isPostollAutoPaused=!1,this._playPostroll()),!t&&s&&(this._isPostollAutoPaused=!0,this._pausePostroll())}_playPostroll(){this._adLoader&&(this._getPostrollState()===a.LE.PAUSE?this._adLoader.resumeAd():this._adLoader.playAd())}_pausePostroll(){this._adLoader&&this._adLoader.pauseAd()}_getPostrollState(){return this._adLoader&&a.LE[this._adLoader.getAdPlayingState().toUpperCase()]||a.LE.NONE}play(){return this.isShown||this.show(),this}stop(){return this.isShown&&this.hide(),this}destroy(){this.isDestroyed||(delete this._player,super.destroy())}_runAutoCloseTimer(t=1e3){return this.cancelTimeout("autoCloseAfterPause"),this.timeout("autoCloseAfterPause",t,(()=>{i.vE.ui.elementInViewport(this._player.$el[0])?this._runAutoCloseTimer(t):this._player.stop()})),this}static addFrame(t){return l(document.createElement("iframe")).attr("src","string"==typeof t?t:"_iframe-error").attr("width","100%").attr("height","100%").attr("frameborder","0").attr("webkitallowfullscreen",!0).attr("mozallowfullscreen",!0).attr("allowfullscreen",!0)}}var c=s(6777);class d extends c.vp{constructor(){super(),this._supported=!0,this._ready=void 0}static canPlay(t){return!0}async _checkSupported(){return this._supported}get supported(){return this._ready?this._ready:this._ready=this._checkSupported()}get logo(){return this._logo||"video"}}s(6992),s(3948);const u=s(6419),p=[/https?:\/\/www\.liveleak\.com/];class m extends d{static canPlay(t){return u.some(p,(e=>e.test(t)))}get supported(){return this._ready?this._ready:this._ready=Promise.resolve(this._supported)}}m.prototype._logo="LiveLeak";s(9755),s(6419);class _ extends h{constructor(t){super(t),this._source=this._player.source}render(){return this.isRendered||(this.emit(a.No.READY),this.$el=h.addFrame(this._source),super.render()),this}unmount(){return this.isMounted?(this.destroyAfterRemove=!1,this.$el=void 0,super.unmount(),this):this}}var g=s(6572);const v=s(6419),f=[/^https?:\/\/rutube\.ru\/tracks\/[0-9]+\.html\?v=([0-9a-z]+)/,/^https?:\/\/rutube\.ru\/video\/([0-9a-z]+)/];class y extends d{static canPlay(t){return v.some(f,(e=>e.test(t)))}get supported(){return this._ready?this._ready:(this._init(),this._ready=Promise.resolve(this._supported))}_init(){return this.listenTo(g.sh.instance,"rutube.ru",(t=>{let e;try{e=JSON.parse(t.data),window.focus()}catch(s){return!1}if("player:changeState"===e.type)switch(e.data.state){case"playing":this.emit("play",t.source);break;case"paused":this.emit("pause",t.source);break;case"stopped":this.emit("stop",t.source)}else"player:ready"===e.type&&this.emit("ready",t.source)})),this}}y.prototype._logo="Rutube";const b=s(9755);class w extends h{constructor(t){super(t),this._source=this._player.source+"?"+b.param({autostart:!0,sTitle:!1,sAuthor:!1})}render(){if(this.isRendered)return this;this.emit(a.No.PROGRESS);let t=i.ZP.ui.player.getProviderInstanceByType(a.VC.RUTUBE);return this.listenTo(t,"play",this._onPlay),this.listenTo(t,"ready",this._onReady),this.listenTo(t,"pause",this._onPause),this.listenTo(t,"stop",this._onStop),this._player.original?(this.$el=this.$parent.find("iframe").attr("id",this._id),this._options.isMounted=!1):this.$el=h.addFrame(this._source),super.render(),this}unmount(){return this.isMounted?(this.destroyAfterRemove=!1,this.$el=void 0,super.unmount(),this):this}_onPlay(t){if(t!==this.$el[0].contentWindow)return!1;this.cancelTimeout("autoCloseAfterPause"),this.emit(a.No.PLAY)}_onPause(t){"story"!==i.ZP.initParams.pageName&&this._runAutoCloseTimer(6e4)}_onStop(t){this._runAutoCloseTimer(5e3)}_onReady(t){if(t!==this.$el[0].contentWindow)return!1;this.emit(a.No.READY),this._player.original||setTimeout((()=>{g.sh.send(JSON.stringify({type:"player:play"}),"http://rutube.ru",this.el.contentWindow)}),1e3)}}const E=s(6419),S=s(9755),C=[/^https?:\/\/(player\.)?vimeo\.com\/(video\/)?([0-9]+)/];class T extends d{static canPlay(t){return E.some(C,(e=>e.test(t)))}get supported(){return this._ready?this._ready:this._ready=new Promise((t=>{if(window.Vimeo&&window.Vimeo.Player)return!0;S.getScript("//player.vimeo.com/api/player.js",(()=>{t(Boolean(Vimeo&&Vimeo.Player))}))}))}}function O(t,e){var s=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),s.push.apply(s,i)}return s}function k(t,e,s){return e in t?Object.defineProperty(t,e,{value:s,enumerable:!0,configurable:!0,writable:!0}):t[e]=s,t}T.prototype._logo="Vimeo";const I=s(9755),$=s(6419);class A extends h{constructor(t){super(t),this._source=this._player.source+"?"+I.param({api:1,autoplay:1,autohide:1,wmode:"opaque",showinfo:0,fs:1}),this._id=$.uniqueId("vi_v"),this._wasEnded=!1,this._wasSeeking=!1,this._wasStarted=!1,this._isFullscreenChanging=!1,this._isPlaying=!1,this._analyticsEventTimestamp=void 0}render(){return this.isRendered||(this.emit(a.No.PROGRESS),this._player.original?(this.$el=this.$parent.find("iframe").attr("id",this._id),this._options.isMounted=!1):this.$el=h.addFrame(this._source),super.render()),this}mount(){return this.isMounted||(super.mount(),this._vimeo=new Vimeo.Player(this.el),this._vimeo.setColor("#8ac858"),this._vimeo.getDuration().then((t=>{this.duration=Number(t)})),this._vimeo.on("play",this._onPlay.bind(this)),this._vimeo.on("pause",this._onPause.bind(this)),this._vimeo.on("ended",this._onFinish.bind(this)),this._vimeo.on("seeked",this._onSeeked.bind(this)),this.listenTo(i.vE.ui,"fullscreenchange",((t,e)=>{!this._isFullscreenChanging&&I(e).closest(this.$el).length&&(this._isFullscreenChanging=!0,setTimeout((()=>{this._isFullscreenChanging=!1}),300))})),this.emit(a.No.READY)),this}getCurrentTime(){var t;return null===(t=this._vimeo)||void 0===t?void 0:t.getCurrentTime()}unmount(){return this.isMounted?(this._vimeo&&(this._vimeo.off("play"),this._vimeo.off("pause"),this._vimeo.off("ended"),this._vimeo.off("seeked"),delete this._vimeo),this.$el=void 0,super.unmount(),this):this}_emitPlayerEvent(t,e){const s=Date.now();s-this._analyticsEventTimestamp<150||(this._analyticsEventTimestamp=s,this._vimeo.getCurrentTime().then((s=>{this.emit(t,function(t){for(var e=1;e<arguments.length;e++){var s=null!=arguments[e]?arguments[e]:{};e%2?O(Object(s),!0).forEach((function(e){k(t,e,s[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(s)):O(Object(s)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(s,e))}))}return t}({view_time:s},e))})))}_onPlay(){this.cancelTimeout("autoCloseAfterPause"),this._wasSeeking||this._isPlaying||this._isFullscreenChanging||this._emitPlayerEvent(a.No.PLAY),this._wasSeeking=!1,this._wasStarted=!0,this._isPlaying=!0}_onPause(t){!this._isFullscreenChanging&&1!==t.percent&&this._wasStarted&&this._isPlaying&&this._emitPlayerEvent(a.No.PAUSE),"story"!==i.vE.initParams.pageName&&this._runAutoCloseTimer(6e4),this._isPlaying=!1}_onSeeked(t){this._wasEnded?this._wasEnded=!1:(this._isPlaying&&(this._wasSeeking=!0),this._emitPlayerEvent(a.No.TIMELINE_CLICK,{time_new:t.seconds}))}_onFinish(){this._wasEnded=!0,this._isPlaying=!1,this._runAutoCloseTimer(15e3)}_onPlayProgress(t){}play(){return this.cancelTimeout("autoCloseAfterPause"),this._player.original?this._vimeo.play():super.play(),this}stop(){return this._player.original?this._vimeo.unload():super.stop(),this}}const x=s(6419),D=s(9755),P=[/^https?:\/\/www\.youtube\.com\/embed\/([0-9A-Za-z_\-]+)/,/^https?:\/\/(www\.)?youtube\.com\/shorts\/([0-9A-Za-z_\-]+)/,/^https?:\/\/www\.youtube\.com.*v=([0-9A-Za-z_\-]+)/,/^https?:\/\/m\.youtube\.com.*v=([0-9A-Za-z_\-]+)/,/youtu\.be\/([0-9A-Za-z_\-]+)/];class R extends d{constructor(){super(),this._readyResolve=null}static canPlay(t){return x.some(P,(e=>e.test(t)))}get supported(){return this._ready?this._ready:this._ready=new Promise(((t,e)=>{this._readyResolve=t,this._init()}))}get YT(){return window.YT}_onYoutubeReady(){if(!this._readyResolve)return this;this._readyResolve(this._supported=!0),this._readyResolve=void 0}_init(){let t=this._onYoutubeReady.bind(this);return window.YT?(window.YT.ready(t),this):(window.onYouTubeIframeAPIReady=t,D.getScript("//www.youtube.com/iframe_api",(()=>{window.YT&&window.YT.ready(t)})),this)}}R.prototype._logo="YouTube";s(4916);var M=s(4143);function N(t,e){const s=t.length,i=e.length;if(s<i)return!1;let n=i-1,o=s-1;for(;n>=0;){if(t[o]!==e[n])return!1;n--,o--}return!0}const B=new(s(7892).xs)({ENDED:0,PLAYING:1,PAUSED:2,BUFFERING:3,CUED:4});var L=s(2308);function F(t,e){var s=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),s.push.apply(s,i)}return s}function U(t,e,s){return e in t?Object.defineProperty(t,e,{value:s,enumerable:!0,configurable:!0,writable:!0}):t[e]=s,t}const j=s(9755),V=s(6419);class H extends h{constructor(t){super(t),U(this,"_eventsSequence",[]),U(this,"_eventsTimer",null),U(this,"_timeBeforeTimelineUpdate",0),U(this,"_currentTime",0),U(this,"_isFullscreenChanging",!1),U(this,"_timeLineWasUpdated",!1),U(this,"_onWebkitFullscreenChange",(()=>{this._restoreScrollPosition(),this._emitPlayerEvent(a.No.FULLSCREEN_CHANGE,{status:document.fullscreenElement?"on":"off"}),this._isFullscreenChanging=!0,setTimeout((()=>{this._isFullscreenChanging=!1}),1e3)})),U(this,"_restoreScrollPosition",(()=>{if(!document.fullscreenElement){const t=()=>window.scroll(0,this._currentPosition);t(),setTimeout(t,0)}})),U(this,"_onMessageCallback",(t=>{if(t.source===this._ytPlayer.getIframe().contentWindow)try{const{event:e,info:s}=JSON.parse(t.data);"infoDelivery"===e&&s&&void 0!==s.currentTime&&void 0===s.playerState&&void 0!==s.videoBytesLoaded&&this._currentTime!==s.currentTime&&setTimeout((()=>{this._currentTime=s.currentTime}))}catch(e){i.ZP.logger.log("youtube","error",e)}})),this._id=V.uniqueId("yt_v"),this._source=V.last(this._player.source.split("/")),this._currentPosition=null}render(){return this.isRendered||(this.emit(a.No.PROGRESS),this._player.original?(this.$el=this.$parent.find("iframe").attr("id",this._id),this._options.isMounted=!1):this.$el=j(document.createElement("div")).attr("id",this._id),super.render()),this}mount(){if(this.isMounted)return this;super.mount();let t=i.ZP.ui.player.getProviderInstanceByType(a.VC.YOUTUBE);return this._ytPlayer=new t.YT.Player(this._id,{width:"100%",height:"100%",videoId:this._source,events:{onReady:this._onYoutubePlayerReady.bind(this),onStateChange:this._onYoutubePlayerStateChange.bind(this)},playerVars:{rel:0,modestbranding:1,controls:2,showinfo:0,fs:"1",wmode:"opaque",autoplay:"1"}}),this._currentPosition=i.ZP.ui.scrollTop,window.addEventListener("webkitfullscreenchange",this._onWebkitFullscreenChange),window.addEventListener("fullscreenchange",this._restoreScrollPosition),window.addEventListener("message",this._onMessageCallback),this}unmount(){return this.isMounted?(this._ytPlayer&&(this._ytPlayer.destroy(),delete this._ytPlayer),super.unmount(),window.removeEventListener("webkitfullscreenchange",this._onWebkitFullscreenChange),window.removeEventListener("fullscreenchange",this._restoreScrollPosition),window.removeEventListener("message",this._onMessageCallback),this):this}getCurrentTime(){return Promise.resolve(this._ytPlayer.playerInfo.currentTime)}_onYoutubePlayerReady(){this._playing=!1,this.emit(a.No.READY)}_onPlayEventTriggered(){this._playing||(i.ZP.logger.log("youtube","play"),this._playing=!0,!this._timeLineWasUpdated&&this._emitPlayerEvent(a.No.PLAY)),this.cancelTimeout("autoCloseAfterPause"),this._timeLineWasUpdated=!1}_onPauseEventTriggered(){this._playing=!1,this._timeLineWasUpdated||this._isFullscreenChanging||this._emitPlayerEvent(a.No.PAUSE),this._isFullscreenChanging=!1,"story"!==i.ZP.initParams.pageName&&this._runAutoCloseTimer(6e4)}_onEndEventTriggered(){this._playing=!1,this._runAutoCloseTimer(15e3),this._player.duration>60&&this._initPostroll()}_emitPlayerEvent(t,e={}){const s=this._player.el.dataset.subtype;s&&(e.type=s),this.emit(t,function(t){for(var e=1;e<arguments.length;e++){var s=null!=arguments[e]?arguments[e]:{};e%2?F(Object(s),!0).forEach((function(e){U(t,e,s[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(s)):F(Object(s)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(s,e))}))}return t}({view_time:this._ytPlayer.playerInfo.currentTime},e))}_onYoutubePlayerStateChange(t){if(!t||V.isUndefined(t.data))return this;const e=t.data;if(this._eventsSequence=[...this._eventsSequence,e],1!==this._eventsSequence.length||e!==B.PLAYING.value&&e!==B.PAUSED.value||(this._timeBeforeTimelineUpdate=this._currentTime),!this._isFullscreenChanging&&(N(this._eventsSequence,[B.PAUSED.value,B.BUFFERING.value])||N(this._eventsSequence,[B.PAUSED.value,B.PLAYING.value])))return this._timeLineWasUpdated=!0,this._emitPlayerEvent(a.No.TIMELINE_CLICK,{time_old:this._timeBeforeTimelineUpdate||0,time_new:this._ytPlayer.playerInfo.currentTime}),void(this._eventsSequence=[]);this._isFullscreenChanging&&N(this._eventsSequence,[B.PAUSED.value,B.PLAYING.value])?this._eventsSequence=[]:(clearTimeout(this._eventsTimer),e!==B.BUFFERING.value&&(this._eventsTimer=setTimeout((()=>{switch(this._eventsSequence=[],e){case B.PLAYING.value:this._onPlayEventTriggered();break;case B.PAUSED.value:this._onPauseEventTriggered();break;case B.ENDED.value:this._onEndEventTriggered()}}),300)))}_initPostroll(){if(!window.ya)return;const t=this.$parent.parent(".player"),e=t.data("bad");if(t.length){t.find(".player__adv")[0]&&t.find(".player__adv")[0].remove(),t.append('<video class="player__adv" controls></video>');const s=t.find(".player__adv")[0];i.ZP.ua.firefox&&document.fullscreenElement&&document.exitFullscreen(),M.FW.loadPostrollVideo(s,t[0],e,!1).then((e=>{const n=e.createPlaybackController(s,t[0],{skipDelay:2,bufferFullTimeout:5e3});this.listenTo(i.ZP,"playerSpecialPlay",(()=>{this._pausePostroll()})),this.adLoader=n,n.subscribe("AdStopped",(()=>{i.ZP.logger.log("postroll","ad stopped playing"),this.$parent.removeClass("player__player_hide"),j(s).remove()})),this._subscribeToEventsForAnalytics(n),document.fullscreenElement&&document.exitFullscreen(),this.$parent.addClass("player__player_hide"),n.playAd(),n.setAdVolume(0)})).catch((t=>{i.ZP.logger.error("postroll",t)}))}}_subscribeToEventsForAnalytics(t){t.subscribe("AdStarted",(()=>{this.emit(a.No.SHOW_AD,{type:L.L.VIDEO_END})})),t.subscribe("AdClickThru",(()=>{this.emit(a.No.CLICK_AD,{type:L.L.VIDEO_END})}))}play(){return this.cancelTimeout("autoCloseAfterPause"),this._player.original?this._ytPlayer&&V.isFunction(this._ytPlayer.playVideo)&&this._ytPlayer.playVideo():super.play(),this.initIntersectionObserver(),this}stop(){return this._player.original?this._ytPlayer&&V.isFunction(this._ytPlayer.stopVideo)&&this._ytPlayer.stopVideo():super.stop(),this}}const q=s(6419),W=[/^https?:\/\/(?:m\.)?vk\.com\/video(-?\d+_\d+)/,/^https?:\/\/(?:m\.)?vk\.com\/.*\?z=video(-?\d+_\d+)/,/^https?:\/\/vk\.com\/video_ext\.php/];class G extends d{static canPlay(t){return q.some(W,(e=>e.test(t)))}get supported(){return this._ready?this._ready:this._ready=Promise.resolve(this._supported)}}G.prototype._logo="VK";const Y=s(6419);class z extends h{constructor(t){super(t),this._id=Y.uniqueId("vk_v"),this._source=this._player.source+"&autoplay=1"}render(){return this.isRendered||(this.emit(a.No.PROGRESS),this._player.original?(this.$el=this.$parent.find("iframe").attr("id",this._id),this._options.isMounted=!1):this.$el=h.addFrame(this._source),super.render()),this}mount(){return this.isMounted||(super.mount(),this.emit(a.No.READY)),this}unmount(){return this.isMounted?(this.$el=void 0,super.unmount(),this):this}}var Z=s(2134);class K{constructor(){this._supportProviders=new Map,this._ready=void 0}async _getSupportedProviders(){if(this._ready)return this._ready;for(let t of a.VC.entries()){let e,s=K.getProviderByType(t);if(!s)throw new Error("Can't find provider "+t);e=new s;await e.supported&&this._supportProviders.set(t,e)}return this._supportProviders}static getProviderPlayerByType(t){switch(t){case a.VC.LIVELEAK:return _;case a.VC.RUTUBE:return w;case a.VC.VIMEO:return A;case a.VC.YOUTUBE:return H;case a.VC.VK:return z}throw new Error("Not found player technology for type "+t)}static getProviderByType(t){switch(t){case a.VC.LIVELEAK:return m;case a.VC.RUTUBE:return y;case a.VC.VIMEO:return T;case a.VC.YOUTUBE:return R;case a.VC.VK:return G}throw new Error("Not found playback technology for type "+t)}getProviderInstanceByType(t){return this._supportProviders.get(t)}getProviderTypeBySource(t){for(let[e]of this._supportProviders){if(K.getProviderByType(e).canPlay(t))return e}}static getProviderTypeBySource(t){for(let e of a.VC.entries()){if(K.getProviderByType(e).canPlay(t))return e}}static getVideoDetails(t){return Z.cf.post("/ajax/gtpost_actions.php",{action:"get_video_info",url:t})}static getVideoFileDetails(t){let e=g.hG.getInstance("videoDetails"),s=String(t);if(e.has(s))return e.get(s);let i=Z.cf.post("/ajax/gtpost_actions.php",{action:"get_video_file_info",fid:t});return i=i.then((t=>e.set(s,t.response.status===Z.Wi?t.data:{}))),e.set(s,i)}get providers(){return this._ready?this._ready:this._ready=this._getSupportedProviders()}}},7580:(t,e,s)=>{"use strict";s.d(e,{F:()=>O});s(8674),s(6992),s(3948),s(4916);var i=s(8211),n=s(2906),o=s(7591),r=s(8097),a=s(5494),l=s(7022),h=s(6572),c=s(9625),d=s(2518),u=s(6471);var p=s(7025),m=s(2822),_=s(3680),g=s(1270),v=s(9415),f=s(7912),y=s(2308),b=s(4720),w=s(5190);function E(t,e){var s=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),s.push.apply(s,i)}return s}function S(t,e,s){return e in t?Object.defineProperty(t,e,{value:s,enumerable:!0,configurable:!0,writable:!0}):t[e]=s,t}const C=s(6419),T=s(9755);class O extends c.y{constructor(t){if(super(C.defaults(t,{showControls:!0})),S(this,"_sendAnalyticsVolumeChangedDebounced",(0,w.D)((()=>this._sendAnalytics(d.No.SOUND_CHANGE)),300)),S(this,"_togglePlay",(()=>{this.isPlayed&&this.state===d.uc.PLAYING?this.pause():this.play()})),this._setVideoDetailFromData(),this.isProbe)return this.show(),void(this.state=d.uc.UNSTARTED);this._adLoader=null,this._intersectionObserver=null,this._isIntersecting=!1,this._isPostollAutoPaused=!1,this._isMobileView=i.vE.applicationType===o.Zq.MOBILE,this._timeBeforePlayerSpecialToggle=null,this._isFullscreenChanging=!1,this.listenTo(i.vE,"playerSpecialPlay",(t=>{this.$els.player.length&&(!this.isAutoplaying||i.vE.initParams.experimentSoundAutoplay&&this.isAutoplaying)&&(this.volume=O.parseVolume()),t!==this.eid&&this.isPlayed&&!this.isAutoplaying&&this.state===d.uc.PLAYING&&this.stop()})),this.listenTo(i.vE,"playerSpecialToggle",(t=>{t===this.eid&&(this._timeBeforePlayerSpecialToggle?this._timeBeforePlayerSpecialToggle=null:this._timeBeforePlayerSpecialToggle=this.currentTime,this.togglePlay())})),this.listenTo(i.vE.ui,"fullscreenchange",((t,e)=>{T(e).closest(this.$el).length&&(this.isFullScreen=t,this._sendAnalytics(d.No.FULLSCREEN_CHANGE,{status:t?"on":"off"}),this._isFullscreenChanging=!0,setTimeout((()=>{this._isFullscreenChanging=!1}),500))})),this.listenTo(i.vE.ui,"visibilitychange",(()=>{const t=f.E.isShown,e=this._isIntersecting;this._onVisibilityChange(t&&e)})),this._showCurrentTime=!1,this.show(),this.state=d.uc.UNSTARTED}render(){return this.isRendered||(this.$els.preview=this.$(".player__preview").eq(0).on("click",this.play.bind(this)),this.$els.player=this.$(".player__player").eq(0),this.$els.play=this.$(".player__play").eq(0).on("click",(()=>this.play())),this.$els.label=this._prepareState(d.uc.UNSTARTED),this.limitWidth=this.$el.hasClass("player_width_limit"),this.$els.label.append(i.vE.i18n("player.providers.pikabu")),this.$els.label.append(T(document.createElement("span")).addClass("player__label player__label_separator").html("&#x25CF;")),this.$els.label.append(O.durationTime(this.duration)),this.$els.soundHint=this._createSoundHint(),this.$els.label.append(this.$els.soundHint),this._prepareState(d.uc.LOADING).empty(),this._playerAnalytics=new g.L(this.$el),this.state=d.uc.UNSTARTED,super.render()),this}_initIntersectionObserver(){const t=!v.v,e=Boolean(this._intersectionObserver);if(t||e)return;const s=i.vE.ui.getHeaderHeight(),n=this._isMobileView?`-${s}px`:"0px";this._intersectionObserver=new IntersectionObserver((t=>{t.length&&(this._isIntersecting=t[0].isIntersecting,this._onVisibilityChange(this._isIntersecting))}),{rootMargin:n,threshold:.2}),this._intersectionObserver.observe(this.el)}_sendAnalytics(t,e){const s=function(t){for(var e=1;e<arguments.length;e++){var s=null!=arguments[e]?arguments[e]:{};e%2?E(Object(s),!0).forEach((function(e){S(t,e,s[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(s)):E(Object(s)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(s,e))}))}return t}({type:"pikabu",view_time:this._timeBeforePlayerSpecialToggle||this.currentTime,length:this.duration},e),i=O.getVolumePercents();s.sound_on=Boolean(i),s.sound_volume=i,this._playerAnalytics.sendAnalytics(t,s)}_initPostroll(t){if(!window.ya)return;const e=this.els.video,s=this.$els.player[0],n=this.$el.data("bad");O.loadPostrollVideo(e,s,n,!0).then((n=>{const o=n.createPlaybackController(e,s,{skipDelay:2,bufferFullTimeout:5e3});this._adLoader=o,o.subscribe("AdPlayingStateChange",(()=>{const t="end"===this._adLoader.getAdPlayingState();t&&(this.marks.set("postroll-playing",!1),this.emit("video-finished",!0),this.volume=this._options.volume),(t||"idle"===this._adLoader.getAdPlayingState())&&this._adLoader.setAdVolume(this.volume)})),o.subscribe("AdStopped",(()=>{i.vE.logger.log("postroll","ad stopped playing"),this.marks.set("postroll-playing",!1),this._toggleControls(!0),this.emit("video-finished",!0),setTimeout((()=>{"idle"!==this._adLoader.getAdPlayingState()&&this._initPostroll(t),this.pause({showIndicate:!1})}),0)})),o.subscribe("AdStarted",(()=>{this._playerAnalytics.sendAnalytics(d.No.SHOW_AD,{type:y.L.VIDEO_END,content_type:"pikabu"})})),o.subscribe("AdClickThru",(()=>{this._playerAnalytics.sendAnalytics(d.No.CLICK_AD,{type:y.L.VIDEO_END,content_type:"pikabu"})}))})).catch((t=>{i.vE.logger.error("postroll",t)}))}static loadPostrollVideo(t,e,s,n){const r=ya.videoAd.loadModule("AdLoader").then((t=>t.AdLoader.create({adFoxParameters:{ownerId:"260477",params:{p1:i.vE.applicationType===o.Zq.DESKTOP?s?"cnpjv":"cnpjw":s?"cnpjz":"cnpka",p2:"grlr","target-ref":document.location.href}}}))).then((t=>(console.log("Post-roll video created"),t.loadAd())));return n&&r.then((t=>(t.preload({preloadTimeout:1e3,videoSlot:e,desiredBitrate:1e3}),new Promise((e=>{setTimeout((()=>{e(t)}),1e3)}))))),r}renderPlayer(){if(this.$els.player.length)return;this.$els.player=T(function(t){var e,s="";return s+'<div class="player__player player__player_hide">\n\t<div class="player__indicator" style="display: none"></div>\n\t<div class="player__video-loader">\n\t\t<svg xmlns="http://www.w3.org/2000/svg" class="icon icon--ui__progress-circle icon--ui__progress-circle_player-native"><use xlink:href="#icon--ui__progress-circle"></use></svg>\n\t</div>\n\t<video class="player__video" playsinline="" preload="none">\n\t\t'+(null==(e=t.webmLink?'<source src="'+t.webmLink+'" type="video/webm">':"")?"":e)+'\n\t\t<source src="'+(null==(e=t.source)?"":e)+'.mp4" type="video/mp4">\n\t</video>\n\t<div class="player__controls-wrapper">\n\t\t<div class="player__controls">\n\t\t\t<div class="player__play-button">\n\t\t\t\t<div class="player__play-arrow player__play-arrow_left"></div>\n\t\t\t\t<div class="player__play-arrow player__play-arrow_right"></div>\n\t\t\t</div>\n\n\t\t\t<div class="player-timeline">\n\t\t\t\t<div class="player-timeline__amounts">\n\t\t\t\t\t<div class="player-timeline__buffered-amount"></div>\n\t\t\t\t\t<div class="player-timeline__progress-amount"></div>\n\t\t\t\t</div>\n\t\t\t\t<div class="player-timeline__handler-wrapper">\n\t\t\t\t\t<div class="player-timeline__handler"></div>\n\t\t\t\t</div>\n\t\t\t\t<div class="player-timeline__hint"></div>\n\t\t\t</div>\n\n\t\t\t<div class="player__progress-time">'+(null==(e=t.duration)?"":e)+'</div>\n\t\t\t<div class="player__volume">\n\t\t\t\t<svg class="player__volume-icon" width="16" height="16" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg">\n\t\t\t\t\t<g fill-rule="evenodd">\n\t\t\t\t\t\t<path d="M0 5.499v5.01h3l5 4.998V.5L3 5.499z"/>\n\t\t\t\t\t\t<path d="M12 8.003c0-1.54-.817-2.862-2.003-3.506V11.5C11.183 10.865 12 9.543 12 8.003z"/>\n\t\t\t\t\t\t<path d="M9.997 0L10 2.004c2.479.785 4 3.107 4 6s-1.521 5.215-4 6l-.003 2.004C13.436 15.177 16 11.91 16 8.004 16 4.098 13.436.83 9.997 0z"/>\n\t\t\t\t\t\t<path d="M13 8.6L10.6 11l-.6-.6L12.4 8 10 5.6l.6-.6L13 7.4 15.4 5l.6.6L13.6 8l2.4 2.4-.6.6z"/>\n\t\t\t\t\t</g>\n\t\t\t\t</svg>\n\t\t\t\t<div class="player__volume-wrapper">\n\t\t\t\t\t<div class="player__volume-amounts">\n\t\t\t\t\t\t<div class="player__volume-amount"></div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t\t<div class="player__fullscreen">\n\t\t\t\t<svg xmlns="http://www.w3.org/2000/svg" class="icon icon--player__expand icon--player__expand_player"><use xlink:href="#icon--player__expand"></use></svg>\n\t\t\t</div>\n\t\t</div>\n\t</div>\n</div>\n'}({source:this.source,duration:O.durationTime(this.duration),webmLink:this.webmLink})),this.$el.append(this.$els.player),this.$els.playButton=this.$(".player__play-button").on("click",this._togglePlay),this.$els.loader=this.$(".player__video-loader"),this.$els.video=this.$(".player__video").on({dblclick:()=>this.isFullScreen=!this.isFullScreen,click:this._togglePlay,pause:()=>this._onPlayerPause(),play:()=>this._onPlayerPlay(),loadedmetadata:()=>{this.duration=this.els.video.duration},timeupdate:()=>this._onPlayerTimeupdate(),ended:()=>{this._onVideoFinished(this.els.video.duration)},progress:this._updateBufferedTime.bind(this)}),this.els={video:this.$els.video.get(0)},this._initHotkeys(),this.$els.controls=this.$(".player__controls").on({mouseenter:()=>{e=!0},mouseleave:()=>{e=!1}}),this.$els.controlsWrapper=this.$(".player__controls-wrapper"),this.$els.indicator=this.$(".player__indicator").eq(0),this.$els.fullScreen=this.$(".player__fullscreen").eq(0).on("click",(()=>{i.vE.ui.emit("fullscreen-prepare"),this.isFullScreen=!this.isFullScreen})),this._renderTimeline(),this._renderVolume();let t=!1,e=!1;const s=C.debounce((()=>{this.isFullScreen&&this.state===d.uc.PLAYING&&!e&&this._toggleControls(!1)}),3e3);this._mouseMoveThrottle=C.throttle((()=>{this.$el.removeClass("player_controls-hide"),(t||this.isFullScreen)&&this._getPostrollState()!==d.LE.PLAY&&this._toggleControls(!0),this.isFullScreen&&s()}),200),this.$el.on({mousemove:this._mouseMoveThrottle.bind(this),mouseenter:()=>t=!0,mouseleave:()=>{t=!1,this.state===d.uc.PLAYING&&this._toggleControls(!1)}})}_playPostroll(){this._adLoader&&(this.marks.set("postroll-playing",!0),this._toggleControls(!1),this._getPostrollState()===d.LE.PAUSE?this._adLoader.resumeAd():(this._adLoader.playAd(),this._adLoader.setAdVolume(0)))}_pausePostroll(){this._adLoader&&(this.marks.set("postroll-playing",!1),this._adLoader.pauseAd())}_getPostrollState(){return this._adLoader&&d.LE[this._adLoader.getAdPlayingState().toUpperCase()]||d.LE.NONE}_createSoundHint(){const t=document.createElement("span");t.classList.add("player__sound-hint");const e=document.createElement("span");if(e.classList.add("player__sound-label"),this.isVideoMuted?(t.innerHTML=i.vE.icon("player__sound-off"),e.textContent=i.vE.i18n("player.sound-mode.no-audio")):(t.innerHTML=this.settings.volume>0?i.vE.icon("player__sound-on"):i.vE.icon("player__sound-off"),e.textContent=this.settings.volume>0?i.vE.i18n("player.sound-mode.has-audio"):i.vE.i18n("player.sound-mode.muted")),i.vE.applicationType===o.Zq.DESKTOP){const s=new p.gR({target:t,destroyAfterHide:!1,direction:p.Lh.TOP,alignment:p.SE.END,distance:12,autoCloseOutsideClick:!1,delay:u.i3});s.content.append(e),t.addEventListener("click",(()=>{s.isShown||s.show()}))}else{const s=new p._({target:t,destroyAfterHide:!1,direction:p.Lh.TOP,alignment:p.SE.END,distance:12,autoCloseOutsideClick:!1});s.content.append(e),t.addEventListener("click",(()=>{s.isShown||(s.show(),s.timeout(u.$A,u.K$,(()=>{s.hide()})))}))}return t}_onPlayerPlay(){if(this.marks.has("video-playing-before-mouse-down"))this.marks.delete("video-playing-before-mouse-down");else{const t=b.L.getInstance().isPlayerAutoplaying(this.eid);this.marks.get("postroll-playing")||this._getPostrollState()===d.LE.END||t&&(!t||0!==b.L.getInstance().activePlayerPlaybacks)||this._sendAnalytics(d.No.PLAY,{mode:this._isAutoEvent?"auto":"manual"})}this.state===d.uc.PAUSED&&this.play({focusAfter:!0,showIndicate:!this.isAutoplaying})}_onPlayerPause(){this._isFullscreenChanging||this.marks.has("is-mousedown-in-timeline")||this.marks.get("postroll-playing")||Math.floor(this.currentTime)===Math.floor(this.duration)||this._getPostrollState()===d.LE.END||this._sendAnalytics(d.No.PAUSE,{mode:this._isAutoEvent?"auto":"manual"}),this.marks.set("postroll-playing",!1),this.isVideoMuted&&this.state===d.uc.PLAYING||this.marks.has("video-playing-before-mouse-down")||this.state===d.uc.PAUSED||this.pause({showIndicate:!this.isAutoplaying})}_onPlayerTimeupdate(){this.marks.has("is-mousedown-in-timeline")||(this._updateProgressTime(this.currentTime),this.isCutMode&&(this.currentTime>=this.cutTo||this.currentTime<this.cutFrom)&&(this.currentTime=this.cutFrom))}_onVideoFinished(t){this._sendMetricsGoal(d.OS.FINISHED,{video_end_duration_s:t}),this.isVideoMuted&&!this.isAutoplaying&&this.els.video.play(),this.state!==d.uc.UNSTARTED&&this._getPostrollState()!==d.LE.PLAY&&this.emit("video-finished"),this._isIntersecting&&this._getPostrollState()!==d.LE.PLAY&&setTimeout((()=>{this._playPostroll()}),0),this._getPostrollState()===d.LE.PLAY&&this._adLoader.stopAd()}_initHotkeys(){this.$el.prop("tabindex",-1);let t=new r.SV(this.$el),e=C.throttle((t=>{this.isCutMode?this.currentTime=t?Math.min(this.currentTime+5,this.cutTo):Math.max(this.currentTime-5,this.cutFrom):this.currentTime=t?Math.min(this.currentTime+5,this.duration):Math.max(this.currentTime-5,0),this._showIndicate(t?"player__forward":"player__backward"),this.isFullScreen&&this._mouseMoveThrottle()}),150,{trailing:!1}),s=C.throttle((t=>{this.volume=t?Math.min(this.volume+.1,1):Math.max(this.volume-.1,0),this._showIndicate(this.isMuted?"player__volume-mute":t?"player__volume-up":"player__volume-down"),this.isFullScreen&&this._mouseMoveThrottle(),O.hasUserInteractedWithVolume=!0}),100,{trailing:!1});return t.on({space:t=>{this._togglePlay(),t.preventDefault()},right:t=>{e(!0),t.preventDefault()},left:t=>{e(!1),t.preventDefault()},up:t=>{!this.isVideoMuted&&s(!0),t.preventDefault()},down:t=>{!this.isVideoMuted&&s(!1),t.preventDefault()},m:t=>{this.isVideoMuted||(this._toggleMute(),this.isMuted&&this._showIndicate("player__volume-mute")),t.preventDefault()},f:t=>{this._options.eid===i.vE.ui.player.currentPlayer&&(this.isFullScreen=!this.isFullScreen,t.preventDefault())}},{type:r.FM.KEYDOWN}),this}_renderTimeline(){let t=a.$.requestThrottle(this._onTimelineMouseMove.bind(this));return this.$els.timeline={el:this.$(".player-timeline"),handlerWrapper:this.$(".player-timeline__handler-wrapper"),handler:this.$(".player-timeline__handler"),bufferedAmount:this.$(".player-timeline__buffered-amount"),progressAmount:this.$(".player-timeline__progress-amount"),time:this.$(".player__progress-time"),hint:this.$(".player-timeline__hint")},i.vE.applicationType===o.Zq.MOBILE?this.$els.timeline.el.on({touchstart:this._onTimelineMouseDown.bind(this)}):this.$els.timeline.el.on({mouseenter:this._onTimelineMouseEnter.bind(this),mouseleave:this._onTimelineMouseLeave.bind(this),mousedown:this._onTimelineMouseDown.bind(this),mousemove:e=>{this.marks.has("is-mousedown-in-timeline")||t(e)}}),this.$els.timeline.time.click((()=>{this._showCurrentTime=!this._showCurrentTime,this._updateProgressTime(this.currentTime)})),this.els.timeline={el:this.$els.timeline.el.get(0)},this.marks.set("timeline-width",this.els.timeline.el.offsetWidth),this}_toggleControls(t){this.$els.controlsWrapper.toggleClass("player__controls-wrapper_hide",!t),this.$el.toggleClass("player_controls-hide",!t)}_onTimelineMouseDown(t){this.marks.set("time-before-timeline-update",this.currentTime),this.marks.set("is-mousedown-in-timeline",!0),this.listenTo(i.vE.ui,"pointer-move",this._onTimelineMouseMove),this.listenTo(i.vE.ui,"pointer-up",this._onTimelineMouseUp);let e=t.pageX||(t.touches&&t.touches.length>0?t.touches[0].clientX:t);this._onTimelineMouseMove(e,!0),this.els.video.paused||(this.marks.set("video-playing-before-mouse-down",!0),this.els.video.pause())}_onTimelineMouseMove(t,e){let s=this.marks.get("timeline-width");s||this.marks.set("timeline-width",s=this.els.timeline.el.offsetWidth);let i=t.pageX||t,n=Math.max(0,Math.min(i-this.$els.timeline.el.offset().left,s))/s,o=this.duration*n,r=O.durationTime(o);this.isCutMode&&(o=this.cutFrom+o),this._lastHintTime!==r&&(this._lastHintTime=r,this.$els.timeline.hint.text(r)),this.$els.timeline.hint.css("left",100*n+"%"),this.marks.has("is-mousedown-in-timeline")&&this._updateProgressTime(o),!0===e&&(this.currentTime=o)}_onTimelineMouseUp(t){this.marks.delete("is-mousedown-in-timeline"),this.stopListening(i.vE.ui,"pointer-move"),this.stopListening(i.vE.ui,"pointer-up");let e=t.pageX||(t.changedTouches&&t.changedTouches.length>0?t.changedTouches[0].clientX:t);this._onTimelineMouseMove(e,!0),this.marks.has("video-playing-before-mouse-down")&&this.els.video.play(),this.marks.has("is-mouse-in-timeline")||this.$els.timeline.hint.removeClass("player-timeline__hint_visible"),this._sendAnalytics(d.No.TIMELINE_CLICK,{time_old:this.marks.get("time-before-timeline-update"),time_new:this.currentTime}),this.marks.delete("timeline-width")}_onTimelineMouseEnter(){this.marks.set("is-mouse-in-timeline",!0),this.marks.set("timeline-width",this.els.timeline.el.offsetWidth),this.$els.timeline.hint.addClass("player-timeline__hint_visible")}_onTimelineMouseLeave(){this.marks.delete("is-mouse-in-timeline"),this.marks.has("is-mousedown-in-timeline")||this.$els.timeline.hint.removeClass("player-timeline__hint_visible")}_renderVolume(){return this.$els.volume={el:this.$(".player__volume-wrapper"),container:this.$(".player__volume"),amount:this.$(".player__volume-amount"),icon:this.$(".player__volume-icon")},this.els.volume={el:this.$els.volume.el.get(0)},this.marks.set("volume-width",this.els.volume.el.offsetWidth),this.isVideoMuted?(this.$el.attr("data-muted","true"),this.$els.volume.container.hide(),this.volume=0):(this.volume=this.settings.volume,i.vE.applicationType!==o.Zq.MOBILE&&this.$els.volume.el.on("mousedown",this._onVolumeMouseDown.bind(this)),this.$els.volume.icon.on("click",this._toggleMute.bind(this))),this}_toggleMute(){if(this.isMuted){let t=this.marks.get("before-mute");this.volume=t>0?t:1,this.marks.delete("before-mute")}else this.marks.set("before-mute",this.volume),this.settings.volumeBeforeMute=this.volume,this.volume=0;return O.hasUserInteractedWithVolume=!0,this}static _getVolumeSetingsFromLS(t){const e=h.mM.get(u.eq);return C.isObject(e)?Math.max(0,Math.min(Number(e[t])||0,1)):1}static parseVolume(){return O._getVolumeSetingsFromLS("vo")}static parseVolumeBeforeMute(){return O._getVolumeSetingsFromLS("vobm")}static getVolumePercents(){return Math.ceil(100*O.parseVolume().toFixed(2))}_onVolumeMouseDown(t){this.marks.set("volume-width",this.els.volume.el.offsetWidth),this.listenTo(i.vE.ui,"pointer-move",this._onVolumeMouseMove),this.listenTo(i.vE.ui,"pointer-up",this._onVolumeMouseUp),this._onVolumeMouseMove(t.pageX)}_onVolumeMouseUp(){this.stopListening(i.vE.ui,"pointer-move"),this.stopListening(i.vE.ui,"pointer-up")}_onVolumeMouseMove(t){let e=t.pageX||t,s=this.marks.get("volume-width"),i=Math.max(0,Math.min(e-this.$els.volume.el.offset().left,s));this.volume=i/s,O.hasUserInteractedWithVolume=!0}_onVisibilityChange(t){const e=this._getPostrollState(),s=e===d.LE.PLAY,i=e===d.LE.PAUSE;t&&i&&this._isPostollAutoPaused&&(this._isPostollAutoPaused=!1,this._playPostroll()),!t&&s&&(this._isPostollAutoPaused=!0,this._pausePostroll())}_setVideoDetailFromData(){const t=String(this.$el.data("source")),e=this.$el.data("webm"),s="true"===e?`${t}.webm`:e&&"false"!==e?e:void 0,i=this.$el.data("story-id"),n=this.$el.data("vid")||0;this._options.storyId=i,this._options.adId=!(!n||n===i)&&n,this.setOptions({source:t,webmLink:s,duration:parseInt(this.$el.data("duration"),10)||0,ratio:parseFloat(this.$el.data("ratio")||1.78),isProbe:Boolean(this.$el.data("probe"))}),this._options.isVideoMuted=Boolean(this.$el.data("muted"));let o=this.$el.data("cut");if(C.isString(o)&&o.includes(",")&&o.length>3){let[t,e]=o.split(",").map((t=>Number(t)));C.isFinite(t)&&C.isFinite(e)&&(this._options.isCutMode=!0,this._options.cutFrom=t,this._options.cutTo=e)}return this}_showIndicate(t){let e=this.$els.indicator;e.show().removeClass("player__indicator_hide").html(i.vE.icon(t,"player-indicator")),this.timeout("indicator-start-hide",300,(()=>{e.addClass("player__indicator_hide")})),this.timeout("indicator-hide",650,(()=>{e.hide().removeClass("player__indicator_hide")}))}_sendMetricsGoal(t,e,s=!0){const i=`goal-${t.value}`;s&&this.marks.has(i)||(this.marks.set(i,!0),m.c.getInstance().yandex.goal(t.value,e))}play({focusAfter:t,showIndicate:e,isAutoEvent:s,restoreVolume:n}={focusAfter:!0,showIndicate:!0,isAutoEvent:null,restoreVolume:!1}){if(this.isProbe)return this._toggleProbeMessage(!0),this;if(this.state===d.uc.PLAYING)return this;e&&this.state!==d.uc.UNSTARTED&&this._showIndicate("player__play"),this.renderPlayer(),this._initIntersectionObserver(),this._isAutoEvent=Boolean(s),this.state===d.uc.UNSTARTED&&setTimeout((()=>{this._sendMetricsGoal(d.OS.PLAY,{video_start_duration_s:this.els.video.duration}),this.els.video.duration>9&&this._initPostroll(this.els.video.duration-2)}),2e3),this.state=d.uc.PLAYING,this.isCutMode&&this.els.video.currentTime<this.cutFrom&&(this.els.video.currentTime=this.cutFrom),n&&(this.volume=O.parseVolume()),setTimeout((()=>{this.els.video.play().catch((t=>{!this.isAutoplaying||this.isPostrollPlaying||i.vE.isMobileApp&&i.vE.ua.ios||i.vE.ui.toasts.showError("Не удалось воспроизвести видео автоматически. Попробуйте обновить страницу")}))})),this.$els.playButton.addClass("player__play-button_active");let o=this.els.video,r=0;return this.interval("detect-buffering",50,(()=>{let t=this.isVideoBuffering,e=this.currentTime;!t&&e<r+.03&&!o.paused&&(this.isVideoBuffering=!0),t&&e>r+.03&&!o.paused&&(this.isVideoBuffering=!1),r=e})),i.vE.emit("playerSpecialPlay",this.eid),t&&this.$el.focus(),this.adId&&!_.o.isPlayVideo(this.adId)&&_.o.setPlayVideo(this.storyId,this.adId),super.play(),this}pause({showIndicate:t,isAutoEvent:e}={showIndicate:!0,isAutoEvent:null}){var s;return this.state===d.uc.PLAYING&&(this.state=d.uc.PAUSED),this._isAutoEvent=Boolean(e),this.els.video.pause(),null===(s=this.$els.playButton)||void 0===s||s.removeClass("player__play-button_active"),t&&this._showIndicate("player__pause"),this.cancelInterval("detect-buffering"),this.isVideoBuffering=!1,this}stop(){return this.marks.has("probe-isShown")&&this._toggleProbeMessage(!1),this.state===d.uc.UNSTARTED?this:this._getPostrollState()===d.LE.PLAY||this._getPostrollState()===d.LE.PAUSE?(this._pausePostroll(),this):(this.pause(),this.currentTime=this.isCutMode?this.cutFrom:0,this.$(".player__play-button").removeClass("player__play-button_active"),this.cancelInterval("detect-buffering"),this.state=d.uc.UNSTARTED,this._isPostollAutoPaused=!1,this)}_updateProgressTime(t){this.isCutMode&&(t-=this.cutFrom);let e=this.duration,s=`translateX(${(t/e*100).toFixed(2)}%`;this.$els.timeline.progressAmount.css("transform",s),this.$els.timeline.handlerWrapper.css("transform",s);let i=O.durationTime(this._showCurrentTime?t:e-t);i!==this._lastTimeBeforeEnd&&(this.$els.timeline.time.text(i),this._lastTimeBeforeEnd=i)}_updateBufferedTime(){let t=this.currentTime,e=this.els.video.buffered;for(let s=e.length;s--;)if(e.start(s)<=t){let t=this.isCutMode?Math.min(e.end(s)-this.cutFrom,this.duration)/this.duration*100:e.end(s)/this.duration*100;this.$els.timeline.bufferedAmount.css("transform",`translateX(${t}%`);break}}_updateVolume(t){this.$els.volume.amount.css("transform",`translateX(${100*t}%`),this.$els.volume.icon.attr("data-value",0===t?"mute":t<.2?"min":t<.6?"mid":"max")}get currentTime(){var t,e;return(null===(t=this.els)||void 0===t||null===(e=t.video)||void 0===e?void 0:e.currentTime)||0}set currentTime(t){this.currentTime!==t&&(this.els.video.currentTime=t,this._updateProgressTime(t))}get isVideoBuffering(){return this._options.isVideoBuffering}set isVideoBuffering(t){this._options.isVideoBuffering!==t&&(this._options.isVideoBuffering=t,this.cancelTimeout("buffering"),t&&!this.isPostrollPlaying?this.timeout("buffering",500,(()=>{this.$els.loader.show()})):this.$els.loader.hide())}get settings(){if(!this._settings){let t={volume:1,volumeBeforeMute:1};t.volume=O.parseVolume(),t.volumeBeforeMute=O.parseVolumeBeforeMute(),this._settings=new n.Lo(t),this.listenTo(this._settings,n.u$.CHANGE,(()=>{h.mM.set(u.eq,{vo:this._settings.data.volume,vobm:this._settings.data.volumeBeforeMute})}))}return this._settings.data}get isMuted(){return 0===this._options.volume}get isVideoMuted(){return this._options.isVideoMuted}get volume(){return this.els.video.volume}set volume(t){const e=0===t;this._options.volume===t&&this.els.video.volume===t&&Boolean(this.els.video.muted)===e||(this._options.volume=t,this.els.video.volume=t,this.els.video.muted=e,this._updateVolume(t),this.isVideoMuted||(this.settings.volume=t,t&&(this.settings.volumeBeforeMute=t),this._sendAnalyticsVolumeChangedDebounced()))}get isFullScreen(){return l.I.isFullScreen}set isFullScreen(t){let e=this.isFullScreen;if(i.vE.ua.ios)t?this.els.video.webkitEnterFullscreen():this.els.video.webkitExitFullScreen();else{if(this.$el.toggleClass("player_fullscreen",t),this.$els.fullScreen.html(i.vE.icon(t?"player__compress":"player__expand","player")),e===t)return;t?l.I.request(this.el):l.I.exit()}}get storyId(){return this._options.storyId}get adId(){return this._options.adId}get duration(){return this.isCutMode?this.cutTo-this.cutFrom:this._options.duration}set duration(t){this._options.duration=Number(t)}get ratio(){return this._options.ratio}set ratio(t){this._options.ratio=t||1.7777777778}get source(){return this._options.source}set source(t){this._options.source!==t&&(this._options.source=t)}get isCutMode(){return this._options.isCutMode}set isCutMode(t){this._options.isCutMode!==(t=Boolean(t))&&(this._options.isCutMode=t)}get cutFrom(){return this._options.cutFrom}get cutTo(){return this._options.cutTo}get webmLink(){return this._options.webmLink}get isPostrollPlaying(){return this.marks.get("postroll-playing")}get isPlaying(){return this.state===d.uc.PLAYING}get isAutoplaying(){return b.L.getInstance().isPlayerAutoplaying(this.eid)}}S(O,"hasUserInteractedWithVolume",!1)},4051:(t,e,s)=>{"use strict";s.d(e,{n:()=>K});s(8674),s(7207);var i=s(8211),n=s(7025),o=s(9050);var r=s(9717);const a="complain-form__note",l="input__input",h="complain-form__footer",c="complain-form__submit",d="complain-form__close",u="complain-form__reasons",p="complain-form__reasons input",m="radio-round",_="complain-form__spinner",g="complain-form__result",v="result__message",f="result__checkbox",y="checkbox",b="close-icon";var w=s(8051),E=s(4519),S=s(8799);const C=s(9755),T=s(6419);class O extends E.u1{constructor(t){super(),S.Zv.isHTMLElement(t)&&(t=C(t)),t instanceof C&&(t={$el:t.eq(0)}),t&&this.setOptions(t),this.$els={input:void 0},this.el&&this.el.parentNode&&this.show()}render(){if(this.isRendered)return this;let t;if(this.$el&&this.$el.is(this.classes.input)&&(this.$els.input=t=this.$el),!this.$el||t){let e=C(document.createElement("span")).addClass(this.classes.item).append(this._createChecked()).prop("tabindex",0).attr("unselectable","on");t&&e.insertBefore(t),this.$el=e}return this.$els.input=this.$els.input&&this.$els.input.length?this.$els.input:this.$(this.classes.input),this.$els.input&&this.$els.input.length||(this.$els.input=C(document.createElement("input")).attr("type",this.classes.type)),this.$els.input.attr("class")&&this.$el.addClass(this.$els.input.attr("class")),this.$els.input.hide().appendTo(this.$el).on({change:this._onChange.bind(this),update:this._onUpdate.bind(this)}),this.checked=this.$els.input.prop("checked"),this.disabled=this.$els.input.prop("disabled"),this.$el.parent().is("label")||this.$el.click(this.toggleChecked.bind(this,null,!0)),super.render(),this}_onChange(){this.checked=this.$els.input.prop("checked")}_onUpdate(){this._options.checked=this.$els.input.prop("checked"),this._updateToggle(this._options.checked,!0)}toggleChecked(t,e,s=!0){this.disabled||(t=T.isBoolean(t)?t:!this.checked,e&&this.$els.input.prop("checked",t),this.checked=t,s&&this.$el.focus())}setChecked(t,e=!1){return t=Boolean(t),this._options.checked===t?this._options.checked:(this.$els.input.prop("checked",t),this._updateToggle(t,!1),e||this.emit("change",t),this._options.checked=t)}_createChecked(){return this.$els.checkedIcon?this.$els.checkedIcon:this.$els.checkedIcon=C(i.ZP.icon("checkbox__icon"))}_updateToggle(t,e=!0){this.$el.toggleClass(this.classes.checked,t)}destroy(){this.$els.input.off(),delete this.$els.input,super.destroy()}get disabled(){return this._options.disabled}set disabled(t){return t=Boolean(t),this._options.disabled===t?this._options.disabled:(this.$el.toggleClass(this.classes.disabled,t),this._options.disabled=t)}get checked(){return this._options.checked}set checked(t){return this.setChecked(t)}}O.prototype.classes={item:"checkbox",checked:"checkbox_checked",disabled:"checkbox_disabled",type:"checkbox",input:'input[type="checkbox"]'};var k=s(2134),I=s(2822),$=s(6683),A=s(3669),x=s(2154);s(6992),s(3948),s(4916),s(5306);const D=s(9755);let P=function(){var t=this;this.button=document.createElement("button"),this.button.className="medium-editor-action medium-editor-action-quote",this.button.innerHTML='<i class="fa fa-quote-left"></i>',this.button.onclick=function(e){t.onClick.call(t,e)},this.up=function(t,e){do{if(1===t.nodeType&&t.nodeName.toLowerCase()===e.toLowerCase())return t}while(t=t.parentNode);return!1}};P.prototype.onClick=function(){var t=window.getSelection().getRangeAt(0),e=this.up(t.startContainer,"blockquote"),s=D(e);if(e)s.parent().append(e.innerHTML),s.remove();else{let s=t.startContainer.parentNode,i=t.endContainer.parentNode,n=this.up(t.startContainer,"p"),o=this.up(t.endContainer,"p");"#text"===t.startContainer.nodeName&&n&&(s=n),"#text"===t.endContainer.nodeName&&o&&(i=o),0===t.endOffset&&i?t.setEndBefore(t.endContainer):i&&t.setEndAfter(i),s&&t.setStartBefore(s),e=document.createElement("blockquote"),t.surroundContents(e)}},P.prototype.getButton=function(){return this.button},P.prototype.checkState=function(t){this.up(t,"blockquote")&&this.button.classList.add("medium-editor-button-active")},P.prototype.coverAll=function(t){var e,s=[];for(e=0;e<this.rangeCount;e++){let t=this.getRangeAt(e);t.setStart(t.startContainer,0),t.setEnd(t.endContainer,t.endContainer.nodeValue.length),s.push(t)}for(t.removeAllRanges(),e=0;e<s.length;e++)t.addRange(s[e])};const R={name:"bold",action:"bold",aria:i.ZP.i18n("editor.buttons.bold"),tagNames:["b"],style:{prop:"font-weight",value:"700|bold"},useQueryState:!0,contentDefault:i.ZP.icon("editor__bold")},M={name:"italic",action:"italic",aria:i.ZP.i18n("editor.buttons.italic"),tagNames:["i"],useQueryState:!1,contentDefault:i.ZP.icon("editor__italic")},N={name:"strikethrough",action:"strikethrough",aria:i.ZP.i18n("editor.buttons.strikethrough"),tagNames:["strike"],style:{prop:"text-decoration",value:"line-through"},useQueryState:!0,contentDefault:i.ZP.icon("editor__strikethrough")},B={name:"anchor",action:"createLink",aria:i.ZP.i18n("editor.buttons.anchor"),tagNames:["a"],contentDefault:i.ZP.icon("editor__anchor")},L={name:"quote",action:"append-blockquote",aria:i.ZP.i18n("editor.buttons.quote"),tagNames:["blockquote"],contentDefault:i.ZP.icon("editor__quote")};var F=s(2082),U=s(637);s(4603),s(2087);s(6419);var j=s(1471),V=s(4437),H=s(425),q=s(5035);class W extends F.Y{constructor(t){var e,s,n,o;(super(t),null!==(s=(e=this._options).canAddAnchor)&&void 0!==s||(e.canAddAnchor=!0),i.vE.ua.android)&&(null!==(o=(n=this._options).isToolbarButtonsDisabled)&&void 0!==o||(n.isToolbarButtonsDisabled=!0));this.$el&&this.render()}destroy(){this._editor.destroy(),super.destroy()}render(){return this.isRendered||(super.render(),this.els.input.defaultValue=this.value,this.validationRules=new Map,this.validationRules.set("^validation-rules.not-contain-link",{validationFunction:H.c.isNotContainLink(),analyticsType:q.tQ[q.A2.ERROR_TITLE_CONTAIN_LINK]}),this._editor=new U.t(this.$els.input[0],{disableReturn:this.disableReturn,imageDragging:!1,toolbar:{buttons:this.isToolbarButtonsDisabled?[]:this.canAddAnchor?[R,M,N,B,L]:[R,M,N,L],static:this.isToolbarButtonsDisabled},placeholder:{text:this.$els.input.data("placeholder")||i.vE.i18n("editor.placeholder.editor"),hideOnClick:!0},extensions:{bq:new P},anchor:{placeholderText:i.vE.i18n("editor.placeholder.anchor"),linkValidation:!0,targetCheckbox:!1},paste:{forcePlainText:!0},keyboardCommands:{commands:[{command:function(){},key:"U",meta:!0,shift:!1,alt:!1}]}}),this._lastHeight=this.$els.input.height(),this._editor.subscribe("editableInput",this.onChange.bind(this)),this.$els.input.on("update",this.onChange.bind(this)),this._editor.subscribe("editablePaste",(()=>{this.$els.input.focus(),this.onChange()})),this.$els.input.on("update",(()=>this.timeout("update",50,(()=>{this._editor.trigger("blur",null,this.els.input)})))),this._saveCaretPositionThrottle=(0,j.P)(this.saveCaretPosition.bind(this),400)),this}updateTitleValidationRules(t){const e=t?V.Jc:V.S8;this.validationRules.set(`^validation-rules.range-title('${V.RI}', '${V.S8}')`,{validationFunction:H.c.isLength(V.RI,e),analyticsType:q.tQ[q.A2.ERROR_TITLE_RANGE]})}searchSuggestion(t){if(this.marks.has("skipNextSearch"))return void this.marks.delete("skipNextSearch");const e=t.searchInTextSelection();return null!==e?e:void 0}replaceSuggestion(t,e){if(!e)return this;this.isFocused?this.marks.set("skipNextSearch",!0):this.restoreCaretPosition();const s=window.getSelection(),i=s.getRangeAt(0),n=i.cloneRange();n.selectNodeContents(i.startContainer);const o=n.toString(),r=o.substring(0,i.startOffset),a=o.substring(i.startOffset),[l,h]=t.replace(r,a,e.data.name);if(r===l&&a===h)return l=t.prefix+e.data.name+t.suffix,this.paste(l),this;i.selectNodeContents(i.startContainer),i.deleteContents();const c=document.createTextNode(l+h);return i.insertNode(c),i.setStart(c,l.length),i.collapse(!0),s.removeAllRanges(),s.addRange(i),this}focus(){return this.$els.input[0].focus(),this.restoreCaretPosition(),this}blur(){return this.$els.input.blur(),this._editor.trigger("blur",null,this.els.input),this}turnOff(){return this.disabled=!0,this._editor.destroy(),this._editor=new U.t(this.$els.input[0],{disableEditing:!0,disableReturn:!0,imageDragging:!1,paste:{forcePlainText:!1,cleanPastedHTML:!1},placeholder:{text:this.$els.input.data("placeholder")||i.vE.i18n("editor.placeholder.editor"),hideOnClick:!1}}),this.$els.input.html("<p><br></p>"),this}onChange(t){return this.value||(this.isFixedValue=!1),this._lastHeight!==this.$els.input.height()&&(this._lastHeight=this.$els.input.height(),this.emit("resize")),super.onChange()}saveCaretPosition(t=!1){let e=window.getSelection().getRangeAt(0).cloneRange();return t?(e.setStart(this.els.input,0),this._lastRange=e.toString().length):this._lastRange=e,this}restoreCaretPosition(){const t=window.getSelection();if(void 0===this._lastRange){const e=document.createRange();return e.selectNodeContents(this.els.input),e.collapse(!1),t.removeAllRanges(),t.addRange(e),this}if(t.removeAllRanges(),Number.isInteger(this._lastRange)){const e=W.getTextNodeAtPosition(this.els.input,this._lastRange),s=new Range;s.setStart(e.node,e.position),t.addRange(s)}else t.addRange(this._lastRange);return this}static getTextNodeAtPosition(t,e){let s=null,i=document.createTreeWalker(t,NodeFilter.SHOW_TEXT,(t=>e>t.textContent.length?(e-=t.textContent.length,s=t,NodeFilter.FILTER_REJECT):NodeFilter.FILTER_ACCEPT),void 0).nextNode();return{node:i||t,position:i?e:0}}onKeyUp(t){super.onKeyUp(t),this._saveCaretPositionThrottle()}onBlur(t){return super.onBlur(t),this}onClick(t){this.els.input.contains(t.target)?this.saveCaretPosition():this.focus()}paste(t,e){return this._editor.pasteHTML(t,e),this.saveCaretPosition(),this}get isEmpty(){return!Boolean(this.textContent.length)}get value(){return this.$els.input.html()}set value(t){this.$els.input.empty(),t&&this.focus(),this._editor.pasteHTML(t||"",{cleanPastedHTML:!1}),this.onChange()}get autoHeight(){return this._options.autoHeight}set autoHeight(t){return this._options.autoHeight=Boolean(t)}get canAddAnchor(){return this._options.canAddAnchor}set canAddAnchor(t){this._options.canAddAnchor!==(t=Boolean(t))&&(this._options.canAddAnchor=t)}get isToolbarButtonsDisabled(){return this._options.isToolbarButtonsDisabled}set isToolbarButtonsDisabled(t){this._options.isToolbarButtonsDisabled!==(t=Boolean(t))&&(this._options.isToolbarButtonsDisabled=t)}get isFixedValue(){return this._options.isFixedValue}set isFixedValue(t){t=Boolean(t),this._options.isFixedValue=t,this.$els.input.attr("contenteditable",String(!t)).toggleClass("input__input_fixed",t)}get disableReturn(){return this._options.disableReturn}set disableReturn(t){this._options.disableReturn!==(t=Boolean(t))&&(this._options.disableReturn=t)}}function G(t,e){var s=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),s.push.apply(s,i)}return s}function Y(t){for(var e=1;e<arguments.length;e++){var s=null!=arguments[e]?arguments[e]:{};e%2?G(Object(s),!0).forEach((function(e){z(t,e,s[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(s)):G(Object(s)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(s,e))}))}return t}function z(t,e,s){return e in t?Object.defineProperty(t,e,{value:s,enumerable:!0,configurable:!0,writable:!0}):t[e]=s,t}s(9755);const Z=s(6419);class K extends n.LD{constructor(t){i.ZP.isMobileApp&&(t.wrapperExtraClass="complain-mobile"),super(t),this._targetId=t.targetId,this._targetType=t.targetType,this._authorId=Number(t.authorId),this._isUserIsAuthor=this._authorId===i.ZP.initParams.userID,this._name=t.name||"",this._name=t.name||"",this._isComplainSent=!1,this._isClosing=!1;const e=this._getFilteredReasons(i.ZP.initParams.reportReasons),n={targetType:this._targetType,isReportsDisabled:i.ZP.initParams.isReportsDisabled,reasons:e},r=function(t){var e,i="",n=o.escape;Array.prototype.join;const r=s(8211).vE;if(i+='\n\n<div class="complain-form">\n        <div class="complain-form__header">\n        ',r.isMobileApp&&(i+='\n            <div class="close-icon"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon--ui__close"><use xlink:href="#icon--ui__close"></use></svg></div>\n        '),i+='\n            <div class="header__title">'+n(r.i18n(`complain.targetType.${t.targetType}`))+"</div>\n        </div>\n        ",t.isReportsDisabled)i+='\n            <p class="complain-form__message complain-form__message_disabled-send">Система отправки жалоб временно отключена для вашего профиля</p>\n            <div class="form_footer complain-form__footer_disabled-send">\n                <div class="button complain-form__close">Закрыть</div>\n            </div>\n        ';else if(t.reasons.length){i+='\n            <div class="complain-form__reasons">\n                ';for(let s=0;s<t.reasons.length;s++){i+="\n                    ";const n=t.reasons[s];i+='\n                    <div class="reason">\n                            <input\n                                    class="radio-round"\n                                    type="radio"\n                                    name="reason"\n                                    id="'+(null==(e=n.id)?"":e)+'"\n                                    value="'+(null==(e=n.id)?"":e)+'"\n                                    data-placeholder="'+(null==(e=n.notePlaceholder)?"":e)+'"\n                                    data-note_required = "'+(null==(e=n.isNoteRequired)?"":e)+'"\n                                    data-ignore_enable = "'+(null==(e=n.isIgnoreEnabled)?"":e)+'"\n                            >\n                            <label for="'+(null==(e=n.id)?"":e)+'">'+(null==(e=n.name)?"":e)+"</label>\n                    </div>\n                "}i+='\n            </div>\n            <div class="complain-form__note">\n                <div class="input_editor">\n                    <div\n                            class="input__input medium-editor-element medium-editor-placeholder"\n                            data-name="note"\n                            title=""\n                            data-placeholder="Добавить комментарий"\n                            contenteditable="true">\n                    </div>\n                </div>\n            </div>\n\n            <div class="complain-form__spinner hidden"></div>\n\n            <div class="complain-form__result result hidden">\n                <div class="result__message">Спасибо, ваша жалоба успешно отправлена модераторам.</div>\n                <div class="result__checkbox hidden">\n                    <label>\n                        <input type="checkbox" class="checkbox" data-name="ignore-checkbox" />\n                        <span>'+n(r.i18n(`complain.checkbox.${t.targetType}`))+'</span>\n                    </label>\n                </div>\n            </div>\n\n            <div class="form_footer complain-form__footer">\n                <button class="button button_success complain-form__submit" disabled>Отправить</button>\n                <div class="button complain-form__close">Отмена</div>\n            </div>\n        '}else i+='\n                <p class="complain-form__message">Жаловаться пока не на что</p>\n        ';return i+"\n</div>\n"}(n);this.setOptions(Z.defaults(t||{},{data:n,content:r})),this._getElements(),this._addListeners(),e.length&&!n.isReportsDisabled&&(i.ZP.isMobileApp?(this._checkboxIgnoreUser=new O({el:this.els.checkboxIgnoreUser}),this._editor=new W(this.els.input)):(this._checkboxIgnoreUser=new w.m({el:this.els.checkboxIgnoreUser}),this._editor=new x.Y({el:this.els.input,isToolbarButtonsDisabled:!0})))}_getFilteredReasons(t){if(!Object.keys(A.f0).includes(this._targetType))throw new Error("incorrect target type");return t.filter((t=>t.type===A.f0[`${this._targetType}`]))}_getElements(){const t=this.$els.content.get(0);this.els={content:t,note:t.querySelector("."+a),input:t.querySelector("."+l),footer:t.querySelector("."+h),submitButton:t.querySelector("."+c),closeButton:t.querySelector("."+d),reasonsBlock:t.querySelector("."+u),reasons:t.querySelectorAll("."+p),checkboxIgnoreUser:t.querySelector("."+y),result:t.querySelector("."+g),resultMessage:t.querySelector("."+v),ignoreCheckbox:t.querySelector("."+f),spinner:t.querySelector("."+_)},i.ZP.isMobileApp&&(this.els.closeIcon=t.querySelector("."+b))}_addListeners(){var t;this.els.content.addEventListener("keypress",(t=>{this.els.input.innerText.length>=A.YR&&(t.preventDefault(),this._showErrorHint("maxCharsInInput",this.els.input))})),this.els.content.addEventListener("click",(t=>{var e;t.target.className===m&&this._handleInputReason(t),t.target.className.includes(l)||!this.els.input||null!==(e=this.els.input)&&void 0!==e&&e.innerText.trim().length||this._handlePlaceholder(),!t.target.className.includes(l)&&this._validationHint&&(this._validationHint=null),t.target.className.includes(l)?this._handleClickInput(t):t.target.className.includes(c)?this._handleSubmit(t):(t.target.className.includes(d)||t.target.className.includes(b))&&(t.preventDefault(),this._handleClose())})),this.els.content.addEventListener("input",(t=>{if(t.target.className!==m)return t.target.className.includes(l)&&(t.preventDefault(),this._validationHint&&(this._validationHint.hide(),this._validationHint=null),this.els.input.innerText.length>=A.YR)?(this._showErrorHint("maxCharsInInput",this.els.input),!1):void 0;this._handleInputReason(t)}),!0),null===(t=this.els.input)||void 0===t||t.addEventListener("paste",(t=>{t.preventDefault();const e=this.els.input.innerText+t.clipboardData.getData("text/plain");this.els.input.innerText=e.substr(0,A.YR),e.length>=A.YR&&this._showErrorHint("maxCharsInInput",this.els.input)})),this.listenTo(i.ZP,"hide-complain",(()=>{this._handleClose()}))}_handleInputReason(t){this._reasonId=t.target.value,this._activeReason=t.target,!this.els.input.innerText.length&&t.target.dataset.placeholder.length&&this.els.input.setAttribute("data-placeholder",t.target.dataset.placeholder),this._noteRequired="true"===t.target.dataset.note_required,this._isIgnoreEnable="true"===t.target.dataset.ignore_enable,this._checkboxIgnoreUser.toggleChecked(this._isIgnoreEnable,!0,!1),this.els.submitButton.removeAttribute("disabled")}async _handleSubmit(t){if(t.preventDefault(),this._noteRequired&&0===this.els.input.innerText.length)return void this._showErrorHint("needNote",this.els.input);this.els.note.classList.add("hidden"),this.els.reasonsBlock.classList.add("hidden"),this.els.submitButton.classList.add("hidden"),this.els.spinner.innerHTML=i.ZP.icon("ui__progress-circle","user-hint"),this.els.spinner.classList.remove("hidden"),this.els.closeButton.innerText="Закрыть",this._editor.value=this._editor.value.replaceAll("<br>"," ");const e=await this._sendComplain();this._handleResponse(e),this.els.spinner.classList.add("hidden"),this.els.result.classList.remove("hidden"),i.ZP.isMobileApp&&(this.els.footer.style.display="block"),this._isUserIsAuthor||this.els.ignoreCheckbox.classList.remove("hidden")}_handleClickInput(t){t.preventDefault(),this.els.input.removeAttribute("data-placeholder"),this._validationHint&&(this._validationHint.hide(),this._validationHint=null)}_handlePlaceholder(){var t;null===(t=this.els.input.querySelector("p"))||void 0===t||t.remove(),this._activeReason&&this._activeReason.dataset.placeholder?this.els.input.setAttribute("data-placeholder",this._activeReason.dataset.placeholder):this.els.input.setAttribute("data-placeholder","Добавить комментарий")}_showErrorHint(t,e){if(this._validationHint)return;const s=`<div class="story__popup-bull complain-form__validation-hint">\n\t\t\t\t\t\t\t${i.ZP.i18n("complain.message."+t)}\n\t\t\t\t\t\t</div>`,o=Z.extend({direction:r.Lh.TOP,alignment:r.SE.START,theme:r.xb.DANGER,target:e,content:s,autoCloseOutsideClick:!0,destroyAfterHide:!0});this._validationHint=new n._(o),this._validationHint.show()}async _sendComplain(){try{const{response:t}=await k.cf.post(A.Jz,{action:"create",target_id:this._targetId,reason_id:this._reasonId,note:this._editor.value||""});return t}catch(t){console.log("Error sending a complaint:",t)}}_handleResponse(t){this._showResponseMessage(t),this._sendAnalytics(t)}_showResponseMessage(t){t.result?this.els.resultMessage.innerText="Спасибо, ваша жалоба успешно отправлена модераторам.":t.message.length>0?this.els.resultMessage.innerText=t.message:this.els.resultMessage.innerText="Извините, что-то пошло не так.",this._isComplainSent=!0}_sendAnalytics(t){if(!t)return;const e=i.ZP.ui.screen;console.log("report_send"),console.log(Y(Y(Y({author_id:this._authorId,type:this._targetType,reason:this._reasonId},"post"===this._targetType&&{post_id:this._targetId}),"comment"===this._targetType&&{comment_id:this._targetId}),e&&{screen:e})),I.c.getInstance().sendEvent("report_send",Y(Y(Y({author_id:this._authorId,type:this._targetType,reason:this._reasonId},"post"===this._targetType&&{post_id:this._targetId}),"comment"===this._targetType&&{comment_id:this._targetId}),e&&{screen:e}))}async _addIgnore(){let t;try{switch(this._targetType){case"post":t=await $.jj.addRule({authors:[{id:Number(this._authorId)}],communities:"",period:$.RO.WEEK,tags:"",keywords:""},"report",this._targetType);break;case"comment":t=await $.jj.addCommentsIgnore(this._authorId,"report",this._targetType);break;case"user":const e=await $.jj.addRule({authors:[{id:Number(this._authorId)}],communities:"",period:$.RO.WEEK,tags:"",keywords:""},"report",this._targetType),{users:s}=await $.jj.getCommentsIgnoreRules();if(s.some((t=>t.id===Number(this._authorId)))){t=e;break}const n=await $.jj.addCommentsIgnore(this._authorId,"report",this._targetType);n&&i.ZP.emit("successIgnoreCommentsInComplain",this),t=e&&n}}catch(e){return void i.ZP.ui.toasts.showError(e)}t&&i.ZP.ui.toasts.add({content:i.ZP.i18n("ignore.messages.success")})}_handleClose(){var t,e;this._isClosing||(this._isClosing=!0,null!==(t=this._checkboxIgnoreUser)&&void 0!==t&&t.checked&&this._isComplainSent&&!this._isUserIsAuthor&&this._addIgnore(),!this.isShown||null!==(e=this._timeoutList)&&void 0!==e&&e.size||this.hide())}}},3669:(t,e,s)=>{"use strict";s.d(e,{f0:()=>i,YR:()=>n,Jz:()=>o});const i={post:1,comment:2,user:3},n=180,o="/ajax/reports_actions.php"},7025:(t,e,s)=>{"use strict";s.d(e,{SE:()=>h,Lh:()=>l,xb:()=>a,nk:()=>U,_:()=>T,Bu:()=>O,gR:()=>$,LD:()=>M,aI:()=>V});var i=s(8211),n=s(4519),o=s(150),r=s(7892);const a=new r.xs({DEFAULT:"",GRAY:"gray",WARNING:"warning",DANGER:"danger",GREEN:"green"}),l=new r.xs({LEFT:0,RIGHT:1,TOP:2,BOTTOM:3}),h=new r.xs({START:0,CENTER:1,END:2}),c=s(9755),d=s(6419);class u extends n.u1{constructor(t={}){super(),this.$els={arrow:void 0,container:void 0,wrapper:void 0},this.setOptions(d.defaults(d.isObject(t)?t:{},{wrapperExtraClass:"",theme:a.DEFAULT}))}render(){return this.isRendered||(this.$el=c(document.createElement("div")).addClass(`popup ${this._options.wrapperExtraClass}`).hide(),this.zIndex&&this.$el.css("z-index",this.zIndex),this.$els.wrapper=c(document.createElement("div")).addClass("popup__wrapper").appendTo(this.$el),this.$els.wrapper.append(this._renderContainer().append(this._renderContent())),this.theme!==a.DEFAULT&&this.$el.addClass(`popup_${this.theme.valueOf()}`),this.$els.container.append(this._renderFooter()),super.render()),this}_renderContainer(){return this.$els.container?this.$els.container:this.$els.container=c(document.createElement("div")).addClass("popup__container")}_renderContent(){return this.$els.content||(this.$els.content=c(document.createElement("div")).addClass("popup__content")),this.$els.content}_renderFooter(){return this.$els.footer||(this.$els.footer=c(document.createElement("div")).addClass("popup__footer").hide()),this.$els.footer}addCloseButtonIntoFooter(t="Закрыть"){return this.addButtonIntoFooter(i.vE.i18n(t),this.hide.bind(this)),this}addButtonIntoFooter(t,e,s){return s=o.j[s],this._renderFooter().show().append(c(document.createElement("button")).addClass("button"+(s&&s!==o.j.DEFAULT?" button_"+s.valueOf():"")).html(i.vE.i18n(t)).on("click",e)),this}addCustomIntoFooter(t){return this._renderFooter().show().append(t),this}updateWidth(){return this}append(t){return this._renderContent().append(t)}destroy(){this.isDestroyed||(delete this.$els.container,i.vE.ui.hotkeys.off(null,null,{context:this}),super.destroy())}static toPx(t,e=!1){return e&&(t=Math.floor(t)),d.isNumber(t)?t+"px":t}static _getCurrentWidth(t,e){if(t)return d.isNumber(t)?t:Math.min(parseInt(t,10),400)*e}get indent(){return this._options.indent}set indent(t){this._options.indent!==t&&(this._renderContent().toggleClass("popup__content_indent",Boolean(t)),this._options.indent=t)}get footer(){return this._renderFooter()}set isFooterMultiline(t){let e=Boolean(t);this.footer.toggleClass("popup__footer_multiline",e)}get content(){return this._renderContent()}set content(t){t&&this._renderContent().empty().append(t)}get theme(){return this._options.theme||a.DEFAULT}set theme(t){let e=this._options.theme;(t=a[t])&&t!==e&&(this._options.theme=t,this.isRendered&&(e!==a.DEFAULT&&this.$el.removeClass(`popup_${e.valueOf()}`),t!==a.DEFAULT&&this.$el.addClass(`popup_${t.valueOf()}`)))}get width(){return this._options.width}set width(t){d.isString(t)&&t.includes("px")&&(t=Math.max(50,parseInt(t,10)||0)),this._options.width=t,this.isShown&&this.updateWidth()}get minWidth(){return this._options.minWidth}set minWidth(t){d.isString(t)&&t.includes("px")&&(t=Math.max(50,parseInt(t,10)||0)),this._options.minWidth=t,this.isShown&&this.updateWidth()}get maxWidth(){return this._options.maxWidth}set maxWidth(t){d.isString(t)&&t.includes("px")&&(t=Math.max(50,parseInt(t,10)||0)),this._options.maxWidth=t,this.isShown&&this.updateWidth()}get destroyAfterHide(){return this._options.destroyAfterHide}set destroyAfterHide(t){this._options.destroyAfterHide=d.isBoolean(t)?t:t>0&&Number(t)}get zIndex(){return this._options.zIndex}set zIndex(t){this._options.zIndex!==(t="number"==typeof t?t:parseInt(t))&&(this._options.zIndex=t,this.isRendered&&this.$el.css("z-index",t))}}s(6992),s(3948);var p=s(8799);const m=s(6419),_=s(9755);const g=class{constructor(t){this._options={},t&&this.from(t)}from(t){return p.Zv.isElement(t)?this.$target=_(t):m.isObject(t)&&!m.isArray(t)&&(this.$target=void 0,this.setOptions(t)),this}equals(t){return p.Zv.isElement(t)?!m.isUndefined(this._options.$target)&&this._options.$target.is(t):!(!m.isObject(t)||m.isArray(t))&&(m.isUndefined(this._options.$target)&&m.every(t,((t,e)=>"offset"===e?!!m.isObject(t)&&(this.offset.left===t.left&&this.offset.top===t.top):this[e]===t)))}setOptions(t){return m.isObject(t)?(m.forEach(t,((t,e)=>{this[e]=t})),this):this}get offset(){return this._options.$target?this._options.$target.offset():this._options.offset}set offset(t){m.isObject(t)&&m.isFinite(t.left)&&m.isFinite(t.top)&&(this._options.offset=t)}get width(){return this._options.$target?this._options.$target.outerWidth():this._options.width}set width(t){this._options.width="number"==typeof t?t:parseInt(t,10)}get height(){return this._options.$target?this._options.$target.outerHeight():this._options.height}set height(t){this._options.height="number"==typeof t?t:parseInt(t,10)}destroy(){this._options.$target&&delete this._options.$target}get $target(){return this._options.$target}set $target(t){this._options.$target=t}};let v,f;!function(t){t.SHOW="show",t.HIDE="hide"}(v||(v={})),function(t){t.ACTIVE="pkb-drawer_active",t.COLORS="pkb-drawer_colors"}(f||(f={}));const y=s(9755),b=s(6419);class w extends u{constructor(t){var e,s;(super(),(p.Zv.isElement(t)||t instanceof g)&&(this.target=t,t={}),this.setOptions(b.defaults(t||{},{autoCloseOutsideClick:!0,autoCloseOnMobileMenuOpen:!1,autoCloseIfTargetNotVisible:!1,useLayerForClickAway:!1,delay:300,delayClose:150,distance:2,showArrow:!0,hideByScroll:!0,popupNonOverflow:!1,autoCorrectPosition:!0,direction:l.BOTTOM,alignment:h.CENTER,bottomPosition:"",leftPosition:"",stickyPosition:!1})),this.useLayerForClickAway&&(this.autoCloseOutsideClick=!1),this._options.autoCloseOnMobileMenuOpen)&&(null===(e=i.ZP.ui.sidebar)||void 0===e||e.on("sidebar-shown",(()=>this.hide())),null===(s=i.ZP.ui.drawer)||void 0===s||s.on(v.SHOW,(()=>this.hide())));return this._pointerGlobPosition={x:0,y:0},this}render(){return this.isRendered||(super.render(),this.showArrow&&this.$els.wrapper.append(this._renderArrow())),this}updateWidth(){var t;if(!this.$el)return this;const e=(Number(null===(t=this.target)||void 0===t?void 0:t.width)||50)/100;return this.$el.css({width:u._getCurrentWidth(this.width,e),minWidth:u._getCurrentWidth(this.minWidth,e),maxWidth:u._getCurrentWidth(this.maxWidth,e)}),this}show(){return this.isShown||super.show(),this}_renderArrow(){return this.$els.arrow?this.$els.arrow:this.$els.arrow=y(document.createElement("div")).addClass("popup__arrow")}onMouseMove(t,e){return this._pointerGlobPosition.x=t,this._pointerGlobPosition.y=e,this}isPointerOverBox(t){if(this.isDestroyed)return!0;try{let e=t instanceof g,{left:s,top:n}=e?t.offset:i.ZP.ui.offsetElement(t),o=(e?t.width:t.outerWidth())+3,r=(e?t.height:t.outerHeight())+3,a=this._pointerGlobPosition.x,l=this._pointerGlobPosition.y;return a>=s-3&&a<=s+o&&l>=n-3&&l<=n+r}catch(e){return!0}}updatePosition(){if(this.isDestroyed||!this.isShown||this.stickyPosition)return this;if(this.autoCloseIfTargetNotVisible){const t=this.target.$target;if(t&&!i.ZP.ui.elementInViewport(t))return this.hide(),this}let t,e,s,n,o=this.target.offset,r=this.target.width,a=this.target.height,c=this.$el.outerWidth(),d=this.$el.outerHeight(),p=13,m=this.distance,_=10,g=o.left-c+_,v=o.left+r-_,f=o.top-d+_,y=o.top+a-_,b=Math.min(c,r),w=Math.min(d,a);this.showArrow&&(n={},m+=6.5);const E={top:i.ZP.ui.lastScrollTop,left:i.ZP.ui.lastScrollLeft,bottom:i.ZP.ui.lastScrollTop+i.ZP.ui.windowHeight,right:i.ZP.ui.lastScrollLeft+i.ZP.ui.windowWidth},S=this._options.viewPortBoundary;if(S){const t="function"==typeof S?S():S;t.left&&(E.left=Math.max(E.left,t.left)),t.right&&(E.right=Math.min(E.right,t.right)),t.top&&(E.top=Math.max(E.top,t.top)),t.bottom&&(E.bottom=Math.min(E.bottom,t.bottom))}{let i,n,h=Number.MAX_VALUE;if(this.autoCorrectPosition)switch(this.direction){case l.TOP:i=[l.TOP,l.BOTTOM,l.LEFT,l.RIGHT];break;case l.BOTTOM:i=[l.BOTTOM,l.TOP,l.LEFT,l.RIGHT];break;case l.LEFT:i=[l.LEFT,l.RIGHT,l.TOP,l.BOTTOM];break;case l.RIGHT:i=[l.RIGHT,l.LEFT,l.TOP,l.BOTTOM]}else i=[this.direction];for(let t of i){let e,s=0,i=0;switch(t){default:case l.BOTTOM:i=o.top+a+m,e=i+d-E.bottom;break;case l.TOP:i=o.top-d-m,e=E.top-i;break;case l.LEFT:s=o.left-c-m,e=E.left-s;break;case l.RIGHT:s=o.left+r+m,e=s+c-E.right}e<0&&(e=0),e<h&&(h=e,n=[t,s,i])}t=n[0]===l.BOTTOM||n[0]===l.TOP,e=n[1],s=n[2],this.arrowDirection=n[0]}switch(this.alignment){case h.START:t?(e=o.left,this.showArrow&&(n.left=Math.max(6,Math.min(6,b/2-6.5)))):(s=o.top,this.showArrow&&(n.top=Math.max(6,Math.min(6,w/2-6.5))));break;case h.END:t?(e=o.left+r-c,this.showArrow&&(n.left=Math.min(c-p-6,c-b/2-6.5))):(s=o.top+a-d,this.showArrow&&(n.top=Math.min(d-p-6,d-w/2-6.5)));break;default:case h.CENTER:if(t){let t=c/2;e=o.left+r/2-t,this.showArrow&&(n.left=Math.max(6,t-6.5))}else{let t=d/2;s=o.top+a/2-t,this.showArrow&&(n.top=Math.max(6,t-6.5))}}if(t&&(e<E.left+_||e+c>E.right-5)&&(e<E.left+_&&(e=E.left+_),e+c>E.right-_&&(e=E.right-c-_),e<g&&(e=g),e>v&&(e=v),e<_&&(e=_),this.showArrow)){const t=Math.max(o.left,e+5),s=Math.min(o.left+r,e+c-5);n.left=t-e+((s-t)/2-6.5)}if(!t&&this.autoCorrectPosition&&(s<E.top+_||s+d>E.bottom-5)&&(s<E.top+_&&(s=E.top+_),s+d>E.bottom-_&&(s=E.bottom-d-_),s<f&&(s=f),s>y&&(s=y),s<_&&(s=_),this.showArrow)){const t=Math.max(o.top,s+5),e=Math.min(o.top+a,s+d-5);n.top=t-s+((e-t)/2-6.5)}return this._options.bottomPosition?this.$el.css({top:"auto",left:Math.abs(Math.ceil(e))+"px",bottom:this._options.bottomPosition,position:"fixed"}):this._options.topPosition?this.$el.css({bottom:"auto",left:Math.abs(Math.ceil(e))+"px",top:this._options.topPosition,position:"fixed"}):this._options.leftPosition?this.$el.css({left:this._options.leftPosition,top:Math.abs(Math.ceil(s))+"px"}):this.notUpdatePosition?this.$el.css({left:Math.abs(Math.ceil(e))+"px"}):this.$el.css({left:Math.abs(Math.ceil(e))+"px",top:Math.abs(Math.ceil(s))+"px"}),this.showArrow&&(n.top=u.toPx(n.top),n.left=u.toPx(n.left),this.$els.arrow.css(n)),this}get showArrow(){return this._options.showArrow}set showArrow(t){return this._options.showArrow=Boolean(t)}get direction(){return this._options.direction||l.BOTTOM}set direction(t){let e=this._options.direction;(t=l[t])&&t!==e&&(this._options.direction=t)}get alignment(){return this._options.alignment||h.CENTER}set alignment(t){let e=this._options.alignment;(t=h[t])&&t!==e&&(this._options.alignment=t)}get autoCorrectPosition(){return this._options.autoCorrectPosition}set autoCorrectPosition(t){return this._options.autoCorrectPosition=Boolean(t)}get distance(){return this._options.distance}set distance(t){return t="number"==typeof t?t:parseInt(t,10),this._options.distance===t||(this._options.distance=t,this.isShown&&this.updatePosition()),t}get delay(){return this._options.delay}set delay(t){return this._options.delay=parseInt(t)}get delayClose(){return this._options.delayClose}set delayClose(t){return this._options.delayClose=parseInt(t)}get autoCloseOutsideClick(){return this._options.autoCloseOutsideClick}set autoCloseOutsideClick(t){return this._options.autoCloseOutsideClick=t}get useLayerForClickAway(){return this._options.useLayerForClickAway}set useLayerForClickAway(t){return this._options.useLayerForClickAway=Boolean(t)}get stickyPosition(){return this._options.stickyPosition}get notUpdatePosition(){return this._options.notUpdatePosition}set notUpdatePosition(t){this._options.notUpdatePosition=t}get arrowDirection(){return this._options.arrowDirection}set arrowDirection(t){return t=l[t],this.showArrow&&this.arrowDirection!==t?(this.$els.arrow&&this.$els.arrow.toggleClass("popup__arrow_left",t===l.LEFT).toggleClass("popup__arrow_right",t===l.RIGHT).toggleClass("popup__arrow_top",t===l.TOP).toggleClass("popup__arrow_bottom",t===l.BOTTOM),this._options.arrowDirection=t):this}get target(){return this._options.target}set target(t){if(this.target)if(t instanceof g)this.target.destroy(),this._options.target=t;else{if(this.target.equals(t))return this.target;this.target.from(t)}else this._options.target=new g(t);return this.isShown&&(this.updateWidth(),this.updatePosition()),this.emit("target"),this.target}get autoCloseIfTargetNotVisible(){return this._options.autoCloseIfTargetNotVisible}}var E=s(1033);const S=s(9755),C=s(6419);class T extends w{constructor(t){return super(t),this._skipNextClick=!1,this._hideByClickBound=this._hideByClick.bind(this),this._updatePositionBound=C.throttle(this.updatePosition.bind(this),300),this._onOverlayMouseDownBound=this._onOverlayMouseDown.bind(this),this._shouldHideImmediately=!1,this}_onOverlayMouseDown(){return this.hide(),this}render(){return this.isRendered||(super.render(),this.$el.addClass("popup_animation"),this.useLayerForClickAway&&this.$el.append(this._renderOverlay().click(this._onOverlayMouseDownBound)),this.popupNonOverflow&&this.$els.container.css({overflow:"initial"}),this._options.showDarkOverlay&&(this._renderOverlay(),this.$els.overlay.addClass("dark-overlay"))),this}_hideByClick(){if(this._skipNextClick)return this._skipNextClick=!1,this;let t=!this.isPointerOverBox(this.$el),e=!this.isPointerOverBox(this.target);return t&&e&&(this.emit("overlayClicked"),this.hide()),this}_renderOverlay(){return this.$els.overlay?this.$els.overlay:this.$els.overlay=S(document.createElement("div")).addClass("popup__balloon-overlay")}mount(){return this.isMounted||(super.mount(),this.stickyPosition?this.target.$target.append(this.$el):i.ZP.ui.overlays.balloon.appendPopup(this),this.addOverlay&&(this.$els.balloonOverlay=S(document.createElement("div")).addClass("popup-overlay").insertBefore(this.$el))),this}unmount(){return this.isMounted?(super.unmount(),i.ZP.ui.overlays.balloon.hidePopup(),this.addOverlay&&this.$els.balloonOverlay.remove(),this):this}show(){return this.isShown||this.isDestroyed||(i.ZP.ui.overlays.balloon.showPopup(),this.cancelTimeout("hide"),super.show(),this.updateWidth(),this.updatePosition(),this.$el.show().removeClass("popup_hide").addClass("popup_show"),this.listenTo(i.ZP.ui,"pointer-move",this.onMouseMove),this.listenTo(i.ZP,"close-auth",(()=>{this.shouldHideImmediately=!0,this.hide()})),this.autoCloseOutsideHandler=!0,this.listenTo(i.ZP.ui,"document-scroll",this._updatePositionBound),this.listenTo(i.ZP.ui,"orientationchange",(()=>{setTimeout((()=>{this.updatePosition()}),0)})),this._resizeObserver=new E.Z(this._updatePositionBound),this._resizeObserver.observe(document.documentElement),this.$el.on("DOMSubtreeModified",".popup__hint",(()=>{this.updateWidth(),this.updatePosition()})),this.interval("watch-visible",500,(()=>{(!this.target||this.target.$target&&this.target.$target.is(":hidden"))&&this.hide()}))),this}destroy(){delete this.$els.overlay,this._resizeObserver&&this._resizeObserver.disconnect(),super.destroy()}hide(){return!this.isShown||this.isDestroyed||(this.stopListening(i.ZP.ui),this.cancelInterval("watch-visible"),this._options.isShown=!1,this.autoCloseOutsideHandler=!1,this.isRendered&&this.$el.removeClass("popup_show").addClass("popup_hide"),this.emit("hide"),this.emit(n.eM.HIDDEN),this.timeout("hide",this.animationDelay,(()=>{i.ZP.logger.log("balloon","hide removed"),super.hide(),this.destroyAfterHide&&this.destroy()}))),this}get popupNonOverflow(){return this._options.popupNonOverflow}get animationDelay(){return this.shouldHideImmediately?0:i.ZP.ui.css.animationPopup}get addOverlay(){return this._options.addOverlay}set addOverlay(t){this._options.addOverlay!==(t=Boolean(t))&&(this._options.addOverlay=t)}get zIndex(){return this._options.zIndex}set zIndex(t){this._options.zIndex!==(t=Number(t))&&(this._options.zIndex=t)}get hideByScroll(){return this._options.hideByScroll}set hideByScroll(t){this._options.hideByScroll!==(t=Boolean(t))&&(this._options.hideByScroll=t)}set autoCloseOutsideHandler(t){if(!this.autoCloseOutsideClick)return;if(this._options.autoCloseOutsideHandler!==t){if(this._options.autoCloseOutsideHandler=t,this._skipNextClick=t,this.cancelTimeout("skipNextClick"),t&&!this.isDestroyed&&this.isShown)return this._skipNextClick=!0,this.timeout("skipNextClick",100,(()=>{this._skipNextClick=!1})),S(document).on("click",this._hideByClickBound),void(this.hideByScroll&&S(document).on("scroll",this._hideByClickBound));S(document).off("click",this._hideByClickBound).off("scroll",this._hideByClickBound)}}set shouldHideImmediately(t){this._shouldHideImmediately=t}get shouldHideImmediately(){return this._shouldHideImmediately}}class O extends T{constructor(t){return super(t),this.els||(this.els={}),this.els.highlighter=void 0,this}show(){return this.isShown||this.isDestroyed||(super.show(),this._options.lockScroll&&document.body.style.setProperty("overflow","hidden"),this._options.highlightTarget&&(document.body.style.setProperty("overflow","hidden"),this.els.highlighter=document.createElement("div"),this.els.highlighter.classList.add("popup-highlighter"),this.els.highlighter.style.setProperty("z-index",this.zIndex),this.el.parentElement.insertBefore(this.els.highlighter,this.el),this.updateHighlighter())),this}hide(){var t;return!this.isShown||this.isDestroyed||(super.hide(),this._options.lockScroll&&document.body.style.removeProperty("overflow"),null===(t=this.els.highlighter)||void 0===t||t.remove()),this}updatePosition(){return this.updateHighlighter(),super.updatePosition()}updateHighlighter(){var t;if(!this.els.highlighter)return;const[e,s,i,n]=null!==(t=this._options.highlightOffset)&&void 0!==t?t:[0,0,0,0];this.els.highlighter.style.setProperty("width",`${this.target.width+n+s}px`),this.els.highlighter.style.setProperty("height",`${this.target.height+e+i}px`),this.els.highlighter.style.setProperty("left",this.target.offset.left-n+"px"),this.els.highlighter.style.setProperty("top",this.target.offset.top-e+"px")}}var k=s(1471);const I=s(6419);class $ extends w{constructor(t){super(),this._checkMouseOutThrottle=I.throttle(this._checkMouseOut.bind(this),150),this._updatePositionBound=I.throttle(this.updatePosition.bind(this),300),this._onMouseEnterBound=this.onMouseEnter.bind(this),this._isDisabled=!1,this._lastScrollPosition={x:0,y:0},(p.Zv.isElement(t)||t instanceof g)&&(this.target=t,t={}),this.setOptions(I.defaults(t||{},{delay:800,destroyAfterHide:!0,interactive:!1}))}onMouseEnter(){return this.mouseInTarget=!0,this}onMouseMove(t,e){return super.onMouseMove(t,e),this._checkMouseOutThrottle(),this}_checkMouseOut(){return this._isMouseOut()?(this.mouseInTarget=!1,this):this}_isMouseOut(){return!(this.interactive&&this.$el&&this.isPointerOverBox(this.$el)||this.isPointerOverBox(this.target))}destroy(){this.isDestroyed||(this.target&&(this.target.$target&&this.target.$target.removeData("hint"),this.target.destroy()),super.destroy())}render(){return this.isRendered||(super.render(),this.$el.addClass("popup_animation"),this.interactive?this.$el.on("mouseenter",this._onMouseEnterBound):this.$el.css("pointer-events","none")),this}show(){if(this.isShown||this.isDestroyed||this._isDisabled)return this;const t=this.targetEl;if(t&&!document.body.contains(t))return this.destroy(),this;i.ZP.logger.log("hint","show()"),this.cancelTimeout("hide","destroy"),super.show(),i.ZP.ui.overlays.hint.showPopup(),this.updateWidth(),this.updatePosition(),this._lastScrollPosition={x:i.ZP.ui.lastScrollLeft,y:i.ZP.ui.lastScrollTop};const e=(0,k.P)((()=>{this.updatePosition(),this.onScrollMove(),this._checkMouseOut()}),300);return this.listenTo(i.ZP.ui,"document-scroll",e),this.listenTo(i.ZP.ui,"resize",e),this.$el.show().removeClass("popup_hide").addClass("popup_show"),this.listenToOnce(i.ZP,"ignore-actions-complain",(()=>{this.hide()})),this}onScrollMove(){let t=this._lastScrollPosition.y-i.ZP.ui.lastScrollTop,e=this._lastScrollPosition.x-i.ZP.ui.lastScrollLeft,s=this._pointerGlobPosition.x-e,n=this._pointerGlobPosition.y-t;return super.onMouseMove(s,n),this._lastScrollPosition.x=i.ZP.ui.lastScrollLeft,this._lastScrollPosition.y=i.ZP.ui.lastScrollTop,this}hide(){return!this.isShown||this.isDestroyed||(i.ZP.logger.log("hint","hide()"),this._options.isShown=!1,this.$el.removeClass("popup_show").addClass("popup_hide"),this.emit(n.eM.HIDDEN,this),this.timeout("hide",i.ZP.ui.css.animationPopup,(()=>{i.ZP.logger.log("hint","super.hide()",this.destroyAfterHide),super.hide();let t=this.destroyAfterHide;t&&(!0===t?this.destroy():this.timeout("destroy",I.isNumber(t)?t:200,(()=>{this.isShown||this.destroy()})))}))),this}mount(){return this.isMounted||(super.mount(),i.ZP.ui.overlays.hint.appendPopup(this)),this}unmount(){return this.isMounted?(super.unmount(),i.ZP.ui.overlays.hint.hidePopup(),this):this}get interactive(){return this._options.interactive}set interactive(t){this._options.interactive=Boolean(t)}get targetEl(){const t=this._options.target;return t instanceof g?t.$target[0]:p.Zv.isJQuery(t)?t[0]:void 0}get target(){return this._options.target}set target(t){if(this.target)if(t instanceof g)this.target.$target&&this.target.$target.off(this._onMouseEnterBound),this.target.destroy(),this._options.target=t;else{if(this.target.equals(t))return this.target;this.target.$target&&this.target.$target.off(this._onMouseEnterBound),this.target.from(t)}else this._options.target=new g(t);return this.isShown&&(this.updateWidth(),this.updatePosition()),this.target.$target&&this.target.$target.on("mouseenter",this._onMouseEnterBound),this.target}get mouseInTarget(){return this._options.mouseInTarget}set mouseInTarget(t){return(t=Boolean(t))!==this.mouseInTarget&&(t&&!this._isListenerForCloseHintExist&&(this._isListenerForCloseHintExist=!0,this.listenTo(i.ZP.ui,"close-hint-shown",(()=>{this._options.mouseInTarget=!1,this.isShown=!1,this._isListenerForCloseHintExist=!1,this.stopListening(i.ZP.ui,"close-hint-shown")}))),this._options.mouseInTarget=t,this.stopListening(i.ZP.ui,"pointer-move"),t&&this.listenTo(i.ZP.ui,"pointer-move",((t,e)=>{this.onMouseMove(t,e)})),this.timeout("toggleDelay",t?this.delay:this.delayClose,(()=>{this.isShown=this.mouseInTarget})),i.ZP.logger.log("hint","mouse",t?"in":"out"),t)}set disabled(t){return this._isDisabled=Boolean(t),this._isDisabled}}var A=s(7591),x=s(5494),D=s(5271);const P=s(9755),R=s(6419);class M extends u{constructor(t){return super(),this.setOptions(R.extend({autoClosePressEscape:!0,autoCloseOutsideClick:!0,isBlockOverflowTouch:!0,isModalMenu:!1,hideOverlay:!1,isBottomWidget:!1,isHeaderLeftAlign:!1,closeHintShown:!1},t||{})),this._onOverlayMouseDownBound=this._onOverlayMouseDown.bind(this),this}_onOverlayMouseDown(){this.hide()}render(){if(this.isRendered)return this;if(super.render(),i.ZP.logger.log("modal","render modal"),this.$el.prop("tabindex",0).addClass("popup_modal"),this._options.hideOverlay||this.$el.append(this._renderOverlay()),i.ZP.applicationType===A.Zq.MOBILE&&this.isBlockOverflowTouch){this._options.hideOverlay||this.$els.overlay.on("touchmove",(t=>{t.preventDefault(),t.stopPropagation()}));let t=0;const e=t=>(t.preventDefault&&t.preventDefault(),!1),s=t=>!!t&&t.scrollHeight-t.scrollTop<=t.clientHeight,i=this.$els.wrapper[0];this.$els.wrapper.css("max-height",window.innerHeight),this.$els.wrapper.on({touchstart:e=>{1===e.targetTouches.length&&(t=e.targetTouches[0].clientY)},touchmove:n=>{if(1===n.targetTouches.length){const o=n.targetTouches[0].clientY-t;return i&&0===i.scrollTop&&o>0||s(i)&&o<0?e(n):(n.stopPropagation(),!0)}}})}return this._options.isModalMenu&&this.$el.addClass("popup_modal-menu"),this._options.isBottomWidget&&this.$el.addClass("popup_bottom-widget"),this.$el.addClass("popup_animation"),this._options.header&&this.$els.container.prepend(this._renderHeader()),this._options.isFullSize&&this.$el.addClass("popup_full-size"),this}_renderOverlay(){return this.$els.overlay?this.$els.overlay:this.$els.overlay=P(document.createElement("div")).addClass("popup__overlay")}_renderHeader(){return this.$els.header||(this.$els.header=P(document.createElement("div")).addClass("popup__header").hide(),this._options.isHeaderLeftAlign&&this.$els.header.addClass("popup__header_align-left")),this.$els.header}show(){return this.isShown||(super.show(),this.cancelTimeout("hide"),i.ZP.ui.overlays.modal.showPopup(),this.$el.removeClass("popup_hide").show(),x.$.request((()=>{this.$el.addClass("popup_show")})),this.updatePosition(),this.autoCloseOutsideClick&&!this._options.hideOverlay&&this._setAutoCloseOutsideClickHandler(!0),this.autoClosePressEscape&&this._setAutoClosePressEscapeHandler(!0),this.closeHintShown&&i.ZP.ui.emit("close-hint-shown"),D.V.isUserInExperiment(D.t.CONTENT_VIEWED_EVENT)&&i.ZP.emit("popup-modal-shown"),this.$el.focus()),this}mount(){return this.isMounted||(super.mount(),i.ZP.ui.overlays.modal.appendPopup(this)),this}unmount(){return this.isMounted?(super.unmount(),i.ZP.ui.overlays.modal.hidePopup(),this):this}hide(){return this.isShown?(this.$el.prev().focus(),this.autoClosePressEscape&&this._setAutoClosePressEscapeHandler(!1),this.autoCloseOutsideClick&&!this._options.hideOverlay&&this._setAutoCloseOutsideClickHandler(!1),(this.autoClosePressEscape||this.autoCloseOutsideClick)&&"UIComplainModalPopup"===this._name&&i.ZP.emit("hide-complain"),this.$el.removeClass("popup_show").addClass("popup_hide"),this.timeout("hide",i.ZP.ui.css.animationPopup,(()=>{super.hide(),this.destroyAfterHide&&this.destroy()})),D.V.isUserInExperiment(D.t.CONTENT_VIEWED_EVENT)&&i.ZP.emit("popup-modal-hidden"),this):this}updatePosition(){i.ZP.ui.windowWidth,i.ZP.ui.windowHeight,this._renderFooter().outerHeight(),this._renderHeader().outerHeight();this.updateSize()}updateWidth(){return this}updateSize(){if(!this.$el)return this;let t=this._renderFooter().outerHeight()+this._renderHeader().outerHeight(),e=i.ZP.ui.windowWidth-t-40,s=i.ZP.ui.windowHeight-t-40;return this._renderContent().css({width:this.width?Math.min(this.width,e):void 0,minWidth:this.minWidth?Math.min(this.minWidth,e):void 0,maxWidth:this.maxWidth?Math.min(this.maxWidth,e):void 0,maxHeight:s}),this}get isBlockOverflowTouch(){return this._options.isBlockOverflowTouch}set isBlockOverflowTouch(t){this._options.isBlockOverflowTouch!==t&&(this._options.isBlockOverflowTouch=t)}get header(){return this._renderHeader()}set header(t){return this._options.header=t=!!(R.isString(t)&&t.length>0)&&String(t),t?this._renderHeader().show().html(t):this.$els.header?this._renderHeader().hide():void 0}get autoCloseOutsideClick(){return this._options.autoCloseOutsideClick}set autoCloseOutsideClick(t){t=Boolean(t);return this._options.autoCloseOutsideClick!==t&&this.isShown&&this._setAutoCloseOutsideClickHandler(t),this._options.autoCloseOutsideClick=t}_setAutoCloseOutsideClickHandler(t){var e,s;t?null===(e=this.$els.overlay)||void 0===e||e.click(this._onOverlayMouseDownBound):null===(s=this.$els.overlay)||void 0===s||s.off("click")}get closeHintShown(){return this._options.closeHintShown}set closeHintShown(t){this._options.closeHintShown=Boolean(t)}get autoClosePressEscape(){return this._options.autoClosePressEscape}set autoClosePressEscape(t){t=Boolean(t);return this._options.autoClosePressEscape!==t&&this.isShown&&this._setAutoClosePressEscapeHandler(t),this._options.autoClosePressEscape=t}_setAutoClosePressEscapeHandler(t){t?i.ZP.ui.hotkeys.on("escape",this._onOverlayMouseDown,{closest:this.$el,context:this}):i.ZP.ui.hotkeys.off("escape",!1,{context:this})}}s(8674);var N=s(8097);const B=s(6419),L=["modal.yes","green",!0],F=["modal.cancel"];class U{static confirmModal({header:t,content:e="Сделать это?",buttons:s=[],minWidth:o,buttonsAlign:r="left",callback:a,isHeaderLeftAlign:l=!1,wrapperExtraClass:h="",zIndex:c}={}){return new Promise((d=>{let u=!0,p=new M({destroyAfterHide:!0,indent:!0,minWidth:o||450,isHeaderLeftAlign:l,wrapperExtraClass:h});"center"===r&&p.footer.addClass(`popup__footer_${r}`),c&&(p.zIndex=c),t&&(p.header=i.vE.i18n(t)),e&&(p.content=i.vE.i18n(e)),B.isArray(s)&&s.length||(s=[L,F]),s.forEach(((t,e)=>{let[s,i,n]=t;0===e&&(u=!B.isBoolean(n)||n),p.addButtonIntoFooter(s||"modal.yes",(()=>{d(n),p.hide()}),i)})),p.on(n.eM.UNMOUNTED,(()=>{d(!1)})),i.vE.ui.hotkeys.once("enter",(()=>{d(u),p.hide()}),{closest:p.$el,context:p,type:N.FM.KEYDOWN}),p.show(),a&&a()}))}static confirmBalloon({target:t,header:e,content:s,buttons:o=[],maxWidth:r}={}){return new Promise((l=>{let h=!0,c=new T({target:t,destroyAfterHide:!0,indent:!0,width:400,theme:a.WARNING,maxWidth:r});e&&(c.header=i.vE.i18n(e)),s&&(c.content=i.vE.i18n(s)),B.isArray(o)&&o.length||(o=[L,F]),o.forEach(((t,e)=>{let[s,i,n]=t;0===e&&(h=!B.isBoolean(n)||n),c.addButtonIntoFooter(s||"modal.yes",(()=>{l(n),c.hide()}),i)})),c.on(n.eM.UNMOUNTED,(()=>{l(!1)})),i.vE.ui.hotkeys.once("enter",(()=>{l(h),c.hide()}),{closest:c.$el,context:c,type:N.FM.KEYDOWN}),i.vE.ui.hotkeys.once("escape",(()=>{c.hide()}),{closest:c.$el,context:c,type:N.FM.KEYDOWN}),c.show()}))}}const j=s(9755);class V extends n.u1{constructor(t){super(t),this._openedPopups=0}appendPopup(t){return this.render(),t.zIndex||(t.zIndex=++this.zIndex),t.appendTo(this.$el),this}render(){return this.isRendered||(this.$el=j(document.createElement("div")).addClass("overlay").css("z-index",this.zIndex),super.render()),this}showPopup(){return this._openedPopups++,i.ZP.logger.log("overlay","show",this.isShown),this.isShown||(this.emit("show"),this.show()),this}hidePopup(){return this._openedPopups--,i.ZP.logger.log("overlay",this._openedPopups),this._openedPopups>0||(this.emit("hide"),this.zIndex=6e3,this.hide()),this}get zIndex(){return this._options.zIndex||6e3}set zIndex(t){return this._options.zIndex=t}}},2630:(t,e,s)=>{"use strict";s.d(e,{bu:()=>g,kd:()=>v,aM:()=>f,jE:()=>m,Ri:()=>_});s(6992),s(3948),s(8674);var i=s(7025),n=s(6572);var o=s(9161),r=s(3040),a=s(8211);const l=["id","endDateString","title","text","colorTheme","setShownStateOnHidden","showOnce","shownCheckStrategy","btnConfig","extraBtnConfig","cssModificators","overlapSidebars","buttonType","showManually"];function h(t,e){if(null==t)return{};var s,i,n=function(t,e){if(null==t)return{};var s,i,n={},o=Object.keys(t);for(i=0;i<o.length;i++)s=o[i],e.indexOf(s)>=0||(n[s]=t[s]);return n}(t,e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(t);for(i=0;i<o.length;i++)s=o[i],e.indexOf(s)>=0||Object.prototype.propertyIsEnumerable.call(t,s)&&(n[s]=t[s])}return n}function c(t,e){var s=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),s.push.apply(s,i)}return s}function d(t){for(var e=1;e<arguments.length;e++){var s=null!=arguments[e]?arguments[e]:{};e%2?c(Object(s),!0).forEach((function(e){u(t,e,s[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(s)):c(Object(s)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(s,e))}))}return t}function u(t,e,s){return e in t?Object.defineProperty(t,e,{value:s,enumerable:!0,configurable:!0,writable:!0}):t[e]=s,t}const p="pkb_notifs";function m(){const t=n.mM.get(p);return Array.isArray(t)?t:[]}function _(t){const e=m();n.mM.set(p,[...e,{id:t}])}function g(t){const e=new r.U;return f(d(d({},t),{},{shownCheckStrategy:{getIsShown:t=>Promise.resolve(Boolean(e.get(t))),setIsShown:(t,s)=>(e.set(t,s),Promise.resolve())}}))}function v(t){return f(d(d({},t),{},{shownCheckStrategy:{getIsShown:t=>Promise.resolve(m().some((e=>e.id===t))),setIsShown:t=>(_(t),Promise.resolve())}}))}async function f(t){var e;const s=d({autoCloseOnMobileMenuOpen:!1,autoCloseOutsideClick:!1,indent:0},t),{id:n,endDateString:r,title:c,text:u,colorTheme:p="default",setShownStateOnHidden:m=!0,showOnce:_=!1,shownCheckStrategy:g,btnConfig:v,extraBtnConfig:f,cssModificators:y=[],overlapSidebars:b,buttonType:w,showManually:E}=s,S=h(s,l),C=S.target instanceof HTMLElement?S.target:S.target.get(0);if(!C)return;let T=!1;if(g&&n)try{T=await g.getIsShown(n)}catch(x){console.error(x)}if(T||!function(t){const e=new Date;return!t||new Date(t)>e}(r))return;var O,k,I;S.content||(S.content=(O={customStyle:y.map((t=>`popup__content-notification_${t}`)).join(" "),title:c,text:u,buttonType:w,btnText:(null==v?void 0:v.label)||"Понятно",extraBtnLabel:null==f?void 0:f.label},I="",Array.prototype.join,I+='<div class="popup__content-notification '+(null==(k=O.customStyle?O.customStyle:"")?"":k)+'">\n\t',O.title&&(I+='\n\t<h4 class="popup__title">'+(null==(k=O.title)?"":k)+"</h4>\n\t"),I+="\n\t<p>"+(null==(k=O.text)?"":k)+'</p>\n\t<footer>\n\t\t<button class="button_main '+(null==(k=O.buttonType?`button_${O.buttonType}`:"button_success")?"":k)+'">'+(null==(k=O.btnText)?"":k)+"</button>\n\t\t",O.extraBtnLabel&&(I+='\n\t\t<button class="popup__content-notification-extra-btn">'+(null==(k=O.extraBtnLabel)?"":k)+"</button>\n\t\t"),I+="\n\t</footer>\n</div>")),"default"!==p&&(S.wrapperExtraClass+=` popup_${p}`);const $=new i.Bu(S);if(b||($.zIndex=5e3),!E){const t=()=>{setTimeout((()=>{$.show(),_&&n&&(null==g||g.setIsShown(n,!0))}),500)};if(a.vE.ui.elementInViewport(C))t();else{new IntersectionObserver(((e,s)=>{e.forEach((e=>{e.isIntersecting&&(t(),s.unobserve(e.target))}))}),{threshold:1}).observe(C)}}const A=null!==(e=null==v?void 0:v.handler)&&void 0!==e?e:$.hide.bind($);return $.content.on("click",".button_main",A),$.content.on("click",'[data-role="close"]',$.hide.bind($)),f&&$.content.on("click",".popup__content-notification-extra-btn",f.handler),$.on(o.e.HIDDEN,(()=>{if(m)try{n&&(null==g||g.setIsShown(n,!0))}catch(x){console.error(x)}})),$}},3491:(t,e,s)=>{"use strict";s.d(e,{j:()=>h});var i=s(8211),n=s(4519),o=s(6572);const r=s(9755),a=s(6419);class l extends n.u1{constructor(t){super(),this._width=100,this._radius=this._width/2,this._length=Math.PI*(2*this._radius),super.setOptions(a.defaults(t||{},{percent:0,indeterminate:!0}))}mount(){return this.isMounted||(super.mount(),this.strokeWidth=this.strokeWidth||parseInt(this.$els.svg.css("stroke-width")||15,10)),this}render(){return this.isRendered||(this.$el=r(document.createElement("div")).addClass("progress-circle"),this.$els.svg=r(i.ZP.icon("ui__progress-circle")).toggleClass("icon--ui__progress-circle_determinate",!this.indeterminate).appendTo(this.$el),this.inside&&this.$el.addClass("progress-circle_absolute"),this.$els.svg.css({"stroke-dasharray":this._length,"stroke-dashoffset":this._length}),super.render()),this}stop(){this._stopIndeterminate(),this._stopSimulation()}_stopSimulation(){return this.marks.has("simulationInterval")&&(clearInterval(this.marks.get("simulationInterval")),this.marks.delete("simulationInterval")),this}_stopIndeterminate(){return this.indeterminate=!1,this}destroy(){this.stop(),super.destroy()}get inside(){return this._options.inside}set inside(t){return this._options.inside===t?this.inside:(this.$parent=t,this._options.inside=t)}get percent(){return this._options.percent||0}set percent(t){return(t=Math.min(Math.max(0,parseInt(t,10)||0),100))===this._options.percent?t:(this.render(),this.$els.svg.css({strokeDashoffset:(100-t)/100*this._length}),t>99&&this.stop(),this._options.percent=t)}get indeterminate(){return this._options.indeterminate}set indeterminate(t){return t=Boolean(t),this._options.indeterminate===t?this._options.indeterminate:(t&&0===this.percent&&(this.percent=20),this.$els.svg&&this.$els.svg.toggleClass("icon--ui__progress-circle_determinate",!t),this._options.indeterminate=Boolean(t))}get simulation(){return this._options.simulation}set simulation(t){let e=a.isBoolean(t)?t:Boolean(t);if((t=a.isBoolean(t)?3500:t)===this._options.simulation)return this._options.simulation;if(this._stopSimulation(),e){let e=300/t*100;this.marks.set("simulationInterval",setInterval((()=>{this.percent=this.percent+(e+o.cQ.random(6))}),350))}return this._options.simulation=e}get strokeWidth(){return this._options.strokeWidth}set strokeWidth(t){return t=Math.min(Math.max(1,parseInt(t,10)),this._width),this.$els.svg&&this.$els.svg.css({"stroke-width":t}),this._options.strokeWidth=t}}const h=l},5538:(t,e,s)=>{"use strict";s.d(e,{Y:()=>u,D:()=>w});s(6992),s(3948),s(8674),s(5827);var i=s(4519),n=s(3432),o=s(9698),r=s(8211),a=s(150);var l=s(9050);function h(t){var e="",s=l.escape;return e+='<div class="input input_box input_flat reputation-label" data-id="'+s(t.id)+'" data-name="'+s(t.name)+'">\n    <span class="input__icon reputation-label__edit" data-role="edit"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon--ui__pencil icon--ui__pencil_size-large"><use xlink:href="#icon--ui__pencil"></use></svg></span>\n    <span class="input__box">\n\t\t<input class="input__input reputation-label__input" placeholder="Введите название" maxlength="25" autocomplete="off" value="'+s(t.name)+'" data-role="name" data-id="'+s(t.id)+'">\n\t</span>\n    <span data-role="count" class="reputation-label__count">'+s(t.count)+'</span>\n    <button data-role="remove" class="button_link reputation-label__remove"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon--ui__close icon--ui__close_size-middle"><use xlink:href="#icon--ui__close"></use></svg></button>\n</div>'}var c=s(9050);const d=s(9755);class u extends i.u1{constructor(...t){var e,s,i;super(...t),i=[],(s="_labels")in(e=this)?Object.defineProperty(e,s,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[s]=i}render(){return this.isRendered?this:(this.$el=d('<section class="reputation-labels-list">\n    <main class="reputation-labels-list__main">\n        <div class="reputation-labels-list__container"></div>\n        <div class="reputation-labels-list__empty">\n            Вы пока не добавили ни одной метки\n        </div>\n    </main>\n\n    <footer class="reputation-labels-list__footer">\n        <div class="input input_box input_section input_gray reputation-labels-list__add-input" data-role="find">\n            <button class="input__icon reputation-labels-list__add-btn button_link">\n                <span class="reputation-labels-list__plus"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon--ui__plus icon--ui__plus_size-middle"><use xlink:href="#icon--ui__plus"></use></svg></span>\n                <span class="reputation-labels-list__check"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon--ui__check-mark icon--ui__check-mark_size-middle"><use xlink:href="#icon--ui__check-mark"></use></svg></span>\n            </button>\n            <span class="input__box">\n                <input class="input__input" maxlength="25" data-action="add" placeholder="Новая метка" name="create_new_cat" value="" autocomplete="off">\n            </span>\n        </div>\n    </footer>\n</section>').hide(),this.$els={container:this.$(".reputation-labels-list__container"),addInput:this.$(".reputation-labels-list__add-input"),addBtn:this.$(".reputation-labels-list__add-btn"),main:this.$(".reputation-labels-list__main"),empty:this.$(".reputation-labels-list__empty").hide()},this._initAddLabelInput(),this._attachEvents(),this._fetchLabels().then((()=>this._renderLabels())),super.render())}_attachEvents(){this.$el.on("click",".reputation-label__remove",(t=>this._onRemoveClick(t))).on("click",".reputation-label__edit",(t=>this._onEditClick(t))).on("click",".reputation-labels-list__add-btn",(()=>this._onAddClick())).on("change",".reputation-label",c.debounce((t=>this._onNameChange(t)),500))}async _fetchLabels(){this._labels=await n.b.get()}_renderLabels(){const t=this._labels.reduce(((t,e)=>t+h(e)),"");this.$els.container.html(t),this._updateEmpty(),this.$el.show()}_initAddLabelInput(){const{UIInput:t}=this.useRegistry();this._addLabelInput=new t({$el:this.$els.addInput,addClearButton:!1});const e=t=>this.$els.addBtn.toggleClass("reputation-labels-list__add-btn_active",Boolean(t.length));this._addLabelInput.on("input",e),this._addLabelInput.on("blur",(t=>e(t.currentTarget.value)))}_updateEmpty(){this.$els.empty.toggle(!this._labels.length)}_onNameChange(t){const e=d(t.currentTarget),s=e.find("input").get(0),i=e.data("id"),n=e.data("name");if(!s)return;const o=s.value.trim();o.length?this._renameLabel(i,o):s.value=n}_onEditClick(t){const e=d(t.currentTarget).closest(".reputation-label").find("input").get(0);if(!e)return;const s=e.value.length;e.focus(),e.setSelectionRange(s,s)}async _onRemoveClick(t){const{PopupMaster:e}=this.useRegistry(),s=o.o.escape(),i=d(t.currentTarget).closest(".reputation-label"),n=i.data("id"),l=i.data("name");await e.confirmModal({content:r.vE.i18n("reputation-labels-list.removeModal.content",s(l)),buttons:[["Удалить",a.j.DANGER,!0],["Отмена"]]})&&this._removeLabel(n)}_onAddClick(){const t=this._addLabelInput.value;t.length&&this._addLabel(t.trim())}async _renameLabel(t,e){try{const s=this.$(`.reputation-label[data-id="${t}"] .reputation-label__edit`);await n.b.rename(t,e),this._labels.find((e=>e.id===t)),s.removeClass("reputation-label__edit_error").addClass("reputation-label__edit_success"),setTimeout((()=>s.removeClass("reputation-label__edit_success")),800)}catch(s){r.vE.ui.toasts.showError(s)}}async _removeLabel(t){await n.b.delete(t),this._labels.splice(c.findIndex(this._labels,(e=>e.id===t)),1),this.$els.container.find(`.reputation-label[data-id="${t}"]`).remove(),this._updateEmpty()}async _addLabel(t){try{const e={id:await n.b.add(t),name:t,count:0};this._labels.push(e),this.$els.container.append(h(e)),this._addLabelInput.els.input.value="",this._addLabelInput.els.input.blur(),this._updateEmpty()}catch(e){r.vE.ui.toasts.showError(e)}}}var p=s(7025),m=s(7754);var _=s(9050);function g(t){var e="",s=_.escape;return e+='<div class="reputation-label reputation-label_dropdown" data-id="'+s(t.id)+'" data-name="'+s(t.name)+'">\n    <div class="reputation-label__name" data-role="name">'+s(t.name)+'</div>\n    <div class="reputation-label__count" data-role="count" >'+s(t.count)+"</div>\n</div>"}function v(t,e){var s=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),s.push.apply(s,i)}return s}function f(t){for(var e=1;e<arguments.length;e++){var s=null!=arguments[e]?arguments[e]:{};e%2?v(Object(s),!0).forEach((function(e){y(t,e,s[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(s)):v(Object(s)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(s,e))}))}return t}function y(t,e,s){return e in t?Object.defineProperty(t,e,{value:s,enumerable:!0,configurable:!0,writable:!0}):t[e]=s,t}const b=s(9755);class w extends p._{constructor(t={}){super(t=f({showArrow:!1,addOverlay:!1,autoCorrectPosition:!0,destroyAfterHide:!0,indent:!1,alignment:p.SE.START,distance:0,width:320},t)),y(this,"_labels",[]),y(this,"_query",""),this._result=new Promise((t=>{this._resolve=t}))}render(){if(this.isRendered)return this;const{UIInput:t}=this.useRegistry();return this.content='<section class="reputation-labels-list reputation-labels-list_dropdown">\n    <div class="reputation-labels-list__spinner">\n        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon--ui__progress-circle icon--ui__progress-circle_story-editor"><use xlink:href="#icon--ui__progress-circle"></use></svg>\n    </div>\n\n    <main class="reputation-labels-list__main">\n        <div class="reputation-labels-list__search input input_section" data-role="search">\n            <span class="input__icon"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon--ui__search icon--ui__search_input"><use xlink:href="#icon--ui__search"></use></svg></span>\n            <span class="input__box">\n                <input class="input__input" placeholder="Поиск метки" autocomplete="off" name="label">\n            </span>\n        </div>\n\n        <div class="reputation-labels-list__container"></div>\n    </main>\n\n    <footer class="reputation-labels-list__footer">\n        <div class="input input_box input_section input_gray reputation-labels-list__add-input" data-role="find">\n            <button class="input__icon reputation-labels-list__add-btn button_link">\n                <span class="reputation-labels-list__plus"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon--ui__plus icon--ui__plus_size-middle"><use xlink:href="#icon--ui__plus"></use></svg></span>\n                <span class="reputation-labels-list__check"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon--ui__check-mark icon--ui__check-mark_size-middle"><use xlink:href="#icon--ui__check-mark"></use></svg></span>\n            </button>\n            <span class="input__box">\n                <input class="input__input" maxlength="25" data-action="add" placeholder="Новая метка" name="create_new_cat" value="" autocomplete="off">\n            </span>\n        </div>\n    </footer>\n</section>',super.render(),this.$els=f(f({},this.$els),{},{queryInput:this.$(".reputation-labels-list__search"),addInput:this.$(".reputation-labels-list__add-input"),addBtn:this.$(".reputation-labels-list__add-btn"),spinner:this.$(".reputation-labels-list__spinner"),main:this.$(".reputation-labels-list__main").hide(),footer:this.$(".reputation-labels-list__footer").hide(),container:this.$(".reputation-labels-list__container")}),this._queryInput=new t({$el:this.$els.queryInput,addClearButton:!1}),this._attachEvents(),this._initAddLabelInput(),this._fetchLabels().then((()=>{this._renderLabels(),this.$els.spinner.hide(),this.$els.main.show(),this.$els.footer.show()})),this}hide(){return this._resolve(!1),super.hide(),this}result(){return this._result}async _fetchLabels(){this._labels=await n.b.get()}_renderLabels(){const t=this._labels.reduce(((t,e)=>""!==this._query&&-1===e.name.toLocaleLowerCase().indexOf(this._query)?t:t+g(e)),"");this.$els.container.html(t),this._updateEmpty(),""!==this._query&&m.Z.add(this.$els.container,this._query)}_attachEvents(){this.$el.on("input",'input[name="label"]',(()=>this._onInput())).on("click",".reputation-labels-list__add-btn",(()=>this._onAddClick())).on("click",".reputation-label",(t=>this._onLabelClick(t)))}_updateEmpty(){const t=0!==this._labels.length,e=""!==this.$els.container.html();this.$els.queryInput.toggleClass("reputation-labels-list__search_empty",!t||!e)}_initAddLabelInput(){const{UIInput:t}=this.useRegistry();this._addLabelInput=new t({$el:this.$els.addInput,addClearButton:!1});const e=t=>this.$els.addBtn.toggleClass("reputation-labels-list__add-btn_active",Boolean(t.length));this._addLabelInput.on("input",e),this._addLabelInput.on("blur",(t=>e(t.currentTarget.value)))}_onInput(){this._query=this._queryInput.value.trim().toLocaleLowerCase(),this._renderLabels()}_onLabelClick(t){const e=b(t.currentTarget).data("id"),s=this._labels.find((t=>t.id===e));this._resolve(s),this.hide()}_onAddClick(){const t=this._addLabelInput.value;t.length&&this._addLabel(t.trim())}async _addLabel(t){const e={id:await n.b.add(t),name:t,count:0};this._labels.push(e),this.$els.container.append(g(e)),this._addLabelInput.els.input.value="",this._addLabelInput.els.input.blur(),this._updateEmpty()}}},1778:(t,e,s)=>{"use strict";s.d(e,{v:()=>d,T:()=>g});s(8674),s(6992),s(3948),s(4916);var i=s(8211),n=s(4877),o=s(8245),r=s(4951),a=s(6349);function l(t,e){var s=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),s.push.apply(s,i)}return s}function h(t){for(var e=1;e<arguments.length;e++){var s=null!=arguments[e]?arguments[e]:{};e%2?l(Object(s),!0).forEach((function(e){c(t,e,s[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(s)):l(Object(s)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(s,e))}))}return t}function c(t,e,s){return e in t?Object.defineProperty(t,e,{value:s,enumerable:!0,configurable:!0,writable:!0}):t[e]=s,t}class d extends n.u{constructor(t){super(t),c(this,"els",{}),c(this,"handleCarouselClick",(t=>{const e=t.target;if("mousedown"===t.type)return i.ZP.ua.firefox&&t.preventDefault(),this.eventTarget=e,void(this.mouseDownTimestamp=Date.now());if("click"===t.type&&this.eventTarget===e&&this.mouseDownTimestamp&&Date.now()-this.mouseDownTimestamp>400)return this.eventTarget=void 0,void(this.mouseDownTimestamp=void 0);if(i.ZP.ua.firefox&&"mousedown"===t.type)return void t.preventDefault();if(!(this.shortStories&&e instanceof HTMLElement))return;const s=e.classList,n=s.contains("short-story__read-more");if(!s.contains("short-story__preview")&&!s.contains("short-story__name")&&!n)return;const o=e.closest(".short-story"),r=null==o?void 0:o.getAttribute("data-story-id"),l=Array.from(this.shortStories).findIndex((t=>t.dataset.storyId===r));var c;(a.cp.getInstance().sendEvent(this._options.analyticsParams.onStoryClickEvent,h({type:this._options.analyticsParams.onStoryClickType,screen_index:l+1,"level!empty":this._options.analyticsParams.level},this.getStoryAnalyticsData(l)),[a.b0.CLICKHOUSE]),n)||(null==o||null===(c=o.querySelector(".short-story__read-more"))||void 0===c||c.dispatchEvent(new MouseEvent("click")))})),this.el&&(this.els={followBtn:this.el.querySelector(".carousel__follow")},this.shortStories=this.el.querySelectorAll(".short-story"),this.show())}render(){return this.isRendered||!this.els||(this.initCarousel(),this.initDotsMenu(),this.initListeners()),this}initDotsMenu(){var t;this.dotsMenu=new r.K({el:null===(t=this.el)||void 0===t?void 0:t.querySelector(".dots-menu"),items:[{id:0,title:"Это не интересно"}]}),this.listenTo(this.dotsMenu,"onItemClick",(async()=>{this.dotsMenu.closeAllMenus();try{if(!(await this._options.getHideBlockPromise()))return;this.hide(),a.cp.getInstance().sendEvent("form_interact",h({content_type:this._options.analyticsParams.contentType,type:"click_not_interested"},this.getStoryAnalyticsData()),[a.b0.CLICKHOUSE])}catch(t){i.ZP.ui.toasts.showError(t)}}))}initCarousel(){var t,e,s,n,r;const l=o.S.getInstance().get("UICarousel");this.carousel=new l({el:this.el,scrollRatio:i.ZP.isDesktopApp?2:null}),null===(t=this.carousel)||void 0===t||t.els.content.addEventListener("click",this.handleCarouselClick),null===(e=this.carousel)||void 0===e||e.els.content.addEventListener("auxclick",this.handleCarouselClick),null===(s=this.carousel)||void 0===s||s.els.content.addEventListener("mousedown",this.handleCarouselClick),null===(n=this.carousel)||void 0===n||n.els.content.addEventListener("dragstart",this.handleCarouselClick),null===(r=this.carousel)||void 0===r||r.els.content.addEventListener("drag",this.handleCarouselClick),this.listenToOnce(this.carousel,"carouselShown",(()=>{a.cp.getInstance().sendEvent("form_show",h({type:this._options.analyticsParams.contentType},this.getStoryAnalyticsData()),[a.b0.CLICKHOUSE])}))}initListeners(){this.els.followBtn.addEventListener("click",(()=>{a.cp.getInstance().sendEvent("transition_to_tab",h({type:this._options.analyticsParams.followBtnClickType},this.getStoryAnalyticsData()),[a.b0.CLICKHOUSE])}))}getStoryAnalyticsData(t=0){if(!this.shortStories||!this.shortStories[t])return{};const{storyId:e,authorId:s,metaRating:i,comments:n,subsCode:o}=this.shortStories[t].dataset;let{pluses:r,minuses:a}=this.shortStories[t].dataset;var l;r||a||!i||([r,a]=null!==(l=null==i?void 0:i.split(":"))&&void 0!==l?l:[]);return{"post_id!empty":e,"author_id!empty":s,"pluses!undefined":r,"minuses!undefined":a,"comments!undefined":n,"type_i8!empty":o}}}var u=s(4122),p=s(2308);function m(t,e){var s=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),s.push.apply(s,i)}return s}function _(t,e,s){return e in t?Object.defineProperty(t,e,{value:s,enumerable:!0,configurable:!0,writable:!0}):t[e]=s,t}class g extends n.u{get el(){return this._options.el}constructor(t){super(t),_(this,"handleStoryClick",(t=>{if(0!==t.button&&1!==t.button)return;const e=t.target;if(!(e instanceof HTMLElement))return;const s=e.closest(".short-story");if(!s)return;const i=e.classList;let n;if(i.contains("short-story__read-more"))n="post_read_more";else if(i.contains("short-story__preview"))n="post_preview";else{if(!i.contains("short-story__name"))return;n="post_title"}a.cp.getInstance().sendEvent("transition_to_post",function(t){for(var e=1;e<arguments.length;e++){var s=null!=arguments[e]?arguments[e]:{};e%2?m(Object(s),!0).forEach((function(e){_(t,e,s[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(s)):m(Object(s)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(s,e))}))}return t}({transition_source:n,type:"under_comments_tiles"},this.getStoryAnalyticsData(s)),[a.b0.CLICKHOUSE])}));const e=Array.from(this.el.children),s=[],i=[];e.forEach((t=>{t.classList.contains("short-story")?s.push(t):i.push(t)})),this.els={tiles:e,shortStories:s,ads:i},this.show()}render(){return this.isRendered||(this.initListeners(),this.initObserver()),this}initListeners(){this.el.addEventListener("click",this.handleStoryClick),this.el.addEventListener("auxclick",this.handleStoryClick),this.els.ads.forEach((t=>{const{row:e,col:s}=this.getTilePosition(t),i=`[${e},${s}]`;t.dataset.position=i,u.Q.instance.watch(t,p.L.UNDER_COMMENTS_TILES)}))}initObserver(){const t=new IntersectionObserver((e=>{const s=e.filter((t=>t.isIntersecting)).map((t=>t.target));s.forEach((e=>t.unobserve(e))),this.sendStoriesShowAnalyticsData(s)}),{threshold:0,rootMargin:"-50% 0% -50% 0%"});this.els.shortStories.forEach((e=>{t.observe(e)}))}sendStoriesShowAnalyticsData(t){const e=t.filter((t=>t.dataset.storyId));if(0===e.length)return;const{row:s}=this.getTilePosition(e[0]);a.cp.getInstance().sendEvent("show_post_lite",{type:"under_comments",screen_index:s,list_f32:`[${e.map((t=>t.dataset.storyId)).join(",")}]`},[a.b0.CLICKHOUSE])}getStoryAnalyticsData(t){var e;const{storyId:s,authorId:i,comments:n,subsCode:o,metaRating:r}=t.dataset,[a,l]=null!==(e=null==r?void 0:r.split(":"))&&void 0!==e?e:[],{row:h,col:c}=this.getTilePosition(t);return{"post_id!empty":s,"author_id!empty":i,"pluses!undefined":a,"minuses!undefined":l,"comments!undefined":n,"type_i8!empty":o,"list!undefined":`[${h},${c}]`}}getTilePosition(t){const e=this.els.tiles.indexOf(t);return{row:Math.ceil((e+1)/2),col:e%2+1}}}},8041:(t,e,s)=>{"use strict";s.d(e,{F:()=>l});s(6992),s(3948);var i=s(5494),n=s(4519);const o=s(9755),r=s(6419);class a extends n.u1{constructor(t){super(t),this._init()}_init(){let t;return r.forEach(this.$(".tabs__tab"),(e=>{let s=o(e),i=a.getTabId(s);this.$tabs.set(i,s),this.tabsPriority.push(i),s.hasClass("tabs__tab_visible")&&(t?s.removeClass("tabs__tab_visible"):t=i),t!==i&&s.hide()})),t&&(this._options.currentTab=t),this}static getTabId(t){return String(t.data("id")||r.uniqueId("tabs"))}prev(){return this.currentTab=this._getSiblingsTab(!1),this}next(){return this.currentTab=this._getSiblingsTab(!0),this}_getSiblingsTab(t=!0){let e,s=this.tabsPriority.length;return s&&1!==s?(e=this.tabsPriority.indexOf(this.currentTab),!e&&!t||e===s-1&&t?this.currentTab:this.tabsPriority[e+(t?1:-1)]):this.currentTab}get $tabs(){return this._options.$tabs?this._options.$tabs:this._options.$tabs=new Map}get tabsPriority(){return this._options.tabsPriority?this._options.tabsPriority:this._options.tabsPriority=[]}get currentTab(){return this._options.currentTab}set currentTab(t){if(r.isNumber(t)&&(t=this.tabsPriority[t]),t&&this.currentTab===t||!this.$tabs.has(t))return this.currentTab;this.currentTab&&this.$tabs.get(this.currentTab).hide().toggleClass("tabs__tab_visible",!1);let e=this.$tabs.get(t);return i.$.request((()=>{e.toggleClass("tabs__tab_visible",!0).fadeIn(300),this.emit("change",t)})),this._options.currentTab=t}}const l=a},1305:(t,e,s)=>{"use strict";s.d(e,{f:()=>n,P:()=>o});var i=s(7892);const n=new i.xs({DEFAULT:"default",PURPLE:"purple",BLUE:"blue",ORANGE:"orange",SKY:"sky",CUSTOM:"custom"}),o=new i.xs({DARK:"dark",LIGHT:"light"})},6815:(t,e,s)=>{"use strict";s.d(e,{f0:()=>i.f,PH:()=>i.P,fM:()=>n.f});var i=s(1305),n=s(7370)},7370:(t,e,s)=>{"use strict";s.d(e,{f:()=>d});s(5827),s(4916);var i=s(2906),n=s(6777),o=s(6572);const r="pkb_theme",a=1440;var l=s(1305);const h=s(6419),c=s(9755);class d extends n.vp{constructor(){if(super(),this._data=new i.Lo(d.loadFromStorage(),!0),this.listenTo(this._data,i.u$.CHANGE,h.throttle(this._updateData,10)),this._updateData(),window.matchMedia){const t=window.matchMedia("(prefers-color-scheme: dark)");t.addEventListener&&t.addEventListener("change",this._onChangePrefersColors.bind(this))}c(window).on("storage",(t=>{t.key===r&&(this._data.update(d.loadFromStorage()),this.emit("external-change",this.currentTheme,this.isDarkTheme))}))}_onChangePrefersColors(t){this.data.dark=t.matches,this.emit("external-change",this.currentTheme,this.isDarkTheme)}_updateData(){this.emit("change",this.currentTheme,this.isDarkTheme);let t=this.data.from,e=this.data.to;if(this._timeIdle&&clearTimeout(this._timeIdle),this.data.dark&&this.data.schedule&&null!==t&&null!==e&&t!==e){const s=d.seconds;let i;i=this.isDarkTheme?t>e&&s/60>e?86400-s+60*t:60*e-s:t<e&&s/60>e?86400-s+60*t:60*t-s,i>2&&(this._timeIdle=setTimeout(this._updateData.bind(this),1e3*i))}d.saveToStorage(this._data.plainData)}get currentTheme(){return this.data.theme}get isDarkTheme(){let t=null!==this.data.from&&null!==this.data.to&&(e=this.data.from,s=this.data.to,i=d.minutes,e===s||e>s&&(i>=e&&i<a||i>=0&&i<s)||e<s&&i>=e&&i<s);var e,s,i;return Boolean(this.data.dark&&(!this.data.schedule||t))}static defaultSettings(){return{theme:l.f.DEFAULT,dark:Boolean(window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches),schedule:!1,from:1080,to:360}}static loadFromStorage(){const t=d.defaultSettings(),e=o.mM.get(r);return h.isObject(e)?(t.theme=l.f[e.t]||l.f.DEFAULT,t.dark=Boolean(e.d),t.schedule=Boolean(e.s),t.from=Number.isInteger(e.f)&&e.f>=0&&e.f<=a?e.f:null,t.to=Number.isInteger(e.to)&&e.to>=0&&e.to<=a?e.to:null,t):t}static saveToStorage(t){JSON.stringify(t)!==JSON.stringify(d.defaultSettings())?o.mM.set(r,{t:t.theme.valueOf(),d:t.dark,s:t.schedule,f:t.from,to:t.to,v:1}):o.mM.remove(r)}get data(){return this._data.data}static get minutes(){let t=new Date;return 60*t.getHours()+t.getMinutes()}static get seconds(){let t=new Date;return 3600*t.getHours()+60*t.getMinutes()+t.getSeconds()}static convertTimeToString(t){let e=Math.floor(t/60),s=t-60*e;return(e<10?"0"+e:e)+":"+(s<10?"0"+s:s)}static convertStringToTime(t){return t.split(":").map((t=>Number(t))).reduce(((t,e)=>60*t+e))}}},4126:(t,e,s)=>{"use strict";let i;s.d(e,{K:()=>i}),function(t){t.DEFAULT="",t.WARNING="warning",t.DANGER="danger"}(i||(i={}))},9412:(t,e,s)=>{"use strict";s.d(e,{K:()=>i.K,O:()=>h});var i=s(4126),n=s(8211),o=s(4519),r=s(5494);const a=s(9755),l=s(6419);class h extends o.u1{constructor(t={}){super(),this._autoHideTimeout=void 0,this._hover=!1,this.$els={content:void 0,closeButton:void 0},this.$parent=t.$parent||n.vE.ui.toasts.$el,this.setOptions(l.defaults(t,{closeAfter:4e3,addCloseButton:!0,theme:i.K.DEFAULT})),this._hideBound=this.hide.bind(this)}_onMouseHover(t){this._hover="mouseenter"===t.type,this.stopAutoClose(),this._hover||this.startAutoClose()}_renderContent(){return this.$els.content?this.$els.content:this.$els.content=a(document.createElement("div")).addClass("toast__content")}_renderCloseButton(){return this.$els.closeButton?this.$els.content:a(document.createElement("div")).addClass("toast__close").append(n.vE.icon("ui__close")).on("click",this.hide.bind(this))}render(){return this.isRendered||(this.$el=a(document.createElement("div")).addClass("toast"),this.theme!==i.K.DEFAULT&&this.$el.addClass(`toast_${this.theme}`),this.$el.append(this._renderContent()),this.addCloseButton&&this.$el.append(this._renderCloseButton()),this.$el.hover(this._onMouseHover.bind(this)),super.render()),this}show(){return this.isShown?(this.stopAutoClose(),this.startAutoClose(),this):(this.cancelTimeout("hide"),this.stopAutoClose(),super.show(),this.startAutoClose(),r.$.request((()=>{this.$el.css("max-height",this.el.scrollHeight)})),this)}hide(){return!this.isShown||this.isDestroyed||(this.stopAutoClose(),this.$el.css("max-height",""),this.timeout("hide",600,(()=>{if(this.isShown)return this;super.hide(),this.destroyAfterHide&&this.destroy()})),this._options.isShown=!1),this}stopAutoClose(){return this._autoHideTimeout&&(clearTimeout(this._autoHideTimeout),this._autoHideTimeout=void 0),this}startAutoClose(){return this.closeAfter?(this.stopAutoClose(),this._autoHideTimeout=setTimeout(this._hideBound,this.closeAfter),this):this}destroy(){delete this.$els.container,super.destroy()}append(t){return this._renderContent().append(t)}get closeAfter(){return this._options.closeAfter}set closeAfter(t){this._options.closeAfter!==(t=l.isBoolean(t)?!!t&&4e3:parseInt(t,10)||1e3)&&(this._options.closeAfter=t,this.isShown&&this.startAutoClose())}get addCloseButton(){return this._options.addCloseButton}set addCloseButton(t){this._options.addCloseButton=Boolean(t)}get theme(){return this._options.theme||i.K.DEFAULT}set theme(t){let e=this._options.theme;t!==e&&(this._options.theme=t,this.isRendered&&(e!==i.K.DEFAULT&&this.$el.removeClass(`toast_${e.valueOf()}`),t!==i.K.DEFAULT&&this.$el.addClass(`toast_${t.valueOf()}`)))}get content(){return this._renderContent()}set content(t){this._renderContent().empty().append(t)}get destroyAfterHide(){return this._options.destroyAfterHide}set destroyAfterHide(t){this._options.destroyAfterHide=Boolean(t),this.isRendered&&!this.isShown&&this.destroy()}}},8245:(t,e,s)=>{"use strict";function i(t,e,s){return e in t?Object.defineProperty(t,e,{value:s,enumerable:!0,configurable:!0,writable:!0}):t[e]=s,t}s.d(e,{S:()=>n});class n{constructor(){i(this,"localUiRegistryKey","__localUiRegistry"),i(this,"components",{})}static getInstance(){return n.instance?n.instance:n.instance=new n}fill(t){return this._fillStorage(this.components,t),this}get(t){return this._getFromStorage(this.components,t)}has(t){return this._hasInStorage(this.components,t)}fillLocal(t,e){if(!t||!t.prototype)throw new Error("Wrong context passed!");return t.prototype[this.localUiRegistryKey]||(t.prototype[this.localUiRegistryKey]={}),this._fillStorage(t.prototype[this.localUiRegistryKey],e),this}getLocal(t,e){const s=t[this.localUiRegistryKey];return s?this._getFromStorage(s,e):{}}_fillStorage(t,e){for(const s in e)Object.prototype.hasOwnProperty.call(e,s)&&(t[s]=e[s])}_hasInStorage(t,e){return e in t}_getFromStorage(t,e){if(!e)return t;const s=t[e];if(!s)throw new Error("Requested item not found in registry");return s}}},6218:(t,e,s)=>{"use strict";s.d(e,{Z:()=>B,C:()=>B});s(5844),s(6992),s(3948),s(8674),s(4916);var i=s(6777),n=s(7892);let o,r={PORTRAIT_PRIMARY:"portrait-primary",PORTRAIT_SECONDARY:"portrait-secondary",LANDSCAPE_PRIMARY:"landscape-primary",LANDSCAPE_SECONDARY:"landscape-secondary"};r=new n.xs(r);const a=window.screen,l="function"==typeof window.ScreenOrientation&&a&&a.orientation instanceof window.ScreenOrientation&&"string"==typeof a.orientation.type,h=["orientationchange","mozorientationchange","msorientationchange"];class c{static get type(){if(l)return r[a.orientation.type];if(a&&(a.msOrientation||a.mozOrientation))return r[(a.msOrientation||a.mozOrientation).type];if(window.orientation)switch(window.orientation){case 180:return r.PORTRAIT_SECONDARY;case 90:return r.LANDSCAPE_PRIMARY;case-90:return r.LANDSCAPE_SECONDARY;default:return r.PORTRAIT_PRIMARY}return c.getMql().matches?r.LANDSCAPE_PRIMARY:r.PORTRAIT_PRIMARY}static get isLandscape(){let t=c.type;return t===r.LANDSCAPE_PRIMARY||t===r.LANDSCAPE_SECONDARY}static get isPortait(){let t=c.type;return t===r.PORTRAIT_PRIMARY||t===r.PORTRAIT_SECONDARY}static get angle(){return l?a.orientation.angle:0}static get supportedOrientationEvent(){return void 0!==c.findDelegation().delegate}static findDelegation(){if(o)return o;for(let t=0;t<h.length;t++)if(null===a["on"+h[t]])return o={delegate:a,event:h[t]};return o=null===window.onorientationchange?{delegate:window,event:"orientationchange"}:{}}static getMql(){return"function"!=typeof window.matchMedia?{}:window.matchMedia("(orientation: landscape)")}}var d=s(7912),u=s(5924),p=s(8211),m=s(7022),_=s(6815),g=s(1605),v=s(2323),f=(s(7320),s(2822)),y=s(9922),b=s(2134),w=s(7111);function E(t,e,s){return e in t?Object.defineProperty(t,e,{value:s,enumerable:!0,configurable:!0,writable:!0}):t[e]=s,t}const S="pkb_rud";class C{constructor(){E(this,"timerId",0),E(this,"storageValue",""),E(this,"handleLocalStorageChange",(t=>{if(t.key===S&&t.newValue){if(t.newValue===`"${this.storageValue}"`)return;console.log("[QA]: restart RUD"),this.runReUpdateCookieTimer()}})),C.checkCookie()?this.runReUpdateCookieTimer():this.runUpdateCookieTimer(1e4),window.addEventListener("storage",this.handleLocalStorageChange)}static checkCookie(){return void 0!==y.e.get("abccv")}runReUpdateCookieTimer(){this.runUpdateCookieTimer(6e5+2*Math.random()*60*1e3)}runUpdateCookieTimer(t){window.clearTimeout(this.timerId),this.timerId=window.setTimeout((()=>{this.updateCookie()}),t)}async updateCookie(){window.clearTimeout(this.timerId),this.storageValue=String(Date.now()),w.m.set(S,this.storageValue),await b.cf.get("/ajax.php?route=register_long_view"),this.runReUpdateCookieTimer()}}var T=s(7585),O=s(9537),k=s(5271);s(5827);function I(t,e,s){return e in t?Object.defineProperty(t,e,{value:s,enumerable:!0,configurable:!0,writable:!0}):t[e]=s,t}const $=["пикабу","pikabu","helloirainbow"],A=["comment__content","story-block_type_text","profile__nick"],x=["#ef5350","#ec407a","#ab47bc","#7e57c2","#5c6bc0","#42a5f5","#29b6f6","#26c6da","#26a69a","#66bb6a","#9ccc65","#d4e157","#ffee58","#ffca28","#ffa726","#ff7043"];class D{constructor(){I(this,"word",""),I(this,"timerId",0),I(this,"handleClick",(()=>{this.processClickedDomNode()&&(this.splitWordToElements(),this.highlightWord())}))}init(){document.addEventListener("click",this.handleClick)}reset(){if(""===this.word||!this.wordCont)return;this.timerId>0&&(clearInterval(this.timerId),this.timerId=0);const t=this.wordCont.parentNode;null==t||t.replaceChild(new Text(this.word),this.wordCont),null==t||t.normalize(),this.word="",this.wordCont=void 0,this.charElements=void 0}processClickedDomNode(){var t,e;if(""!==this.word)return!1;const s=window.getSelection();if(!s||s.rangeCount<1)return!1;const i=s.getRangeAt(0),n=s.anchorNode;if(!n||n.nodeType!==Node.TEXT_NODE||i.startOffset!==i.endOffset||i.startContainer!==i.endContainer||null!==(t=n.parentElement)&&void 0!==t&&t.closest("[contenteditable], A, SVG")||null===(e=n.parentElement)||void 0===e||!e.closest("."+A.join(", .")))return!1;const o=n.nodeValue;if(!o||!$.some((t=>o.toLowerCase().includes(t))))return!1;const r=$.reduce(((t,e)=>Math.max(t,e.length)),0),a=Math.max(0,i.startOffset-r),l=/[\s!"'(),.:;?-]/,h=o.substr(a,i.startOffset-a).split(l).pop()||"",c=h+(o.substr(i.startOffset,r).split(l).shift()||"");return!!$.includes(c.toLowerCase())&&(this.word=c,this.wordCont=document.createElement("span"),this.wordCont.style.cssText="margin: 0; padding: 0;",this.wordCont.setAttribute("data-fancy-text","1"),i.setStart(i.startContainer,i.startOffset-h.length),i.setEnd(i.startContainer,i.startOffset+this.word.length),i.surroundContents(this.wordCont),i.collapse(),!0)}splitWordToElements(){this.word&&this.wordCont&&(this.wordCont.innerHTML="",this.charElements=this.word.split("").map((t=>{var e;const s=document.createElement("span");return s.style.cssText="margin: 0; padding: 0;",s.textContent=t,null===(e=this.wordCont)||void 0===e||e.appendChild(s),s})))}highlightWord(){let t=0;this.timerId=window.setInterval((()=>{if(this.charElements)if(t++>10)this.reset();else for(const t of this.charElements)t.style.color=x[Math.floor(Math.random()*x.length)]}),100)}}const P=s(9755),R=s(6419),M=/\S/,N="scrollRestoration"in history;class B extends i.vp{constructor(){super(!0),this._isMobileSafari=(p.vE.ua.ios||navigator.maxTouchPoints>1)&&p.vE.ua.safari,this._options={marks:void 0,beforeEndFactor:p.vE.initParams.isAdsDisabled?3:1.5,viewportHeightEnd:0,isPageScrollable:!0},this.els={body:document.body,scrollRoot:B.getScrollRoot()},this.$els={scrollRoot:P(this.els.scrollRoot),body:P(this.els.body),html:P("html"),scrollAnimation:P("html, body"),window:P(window),document:P(document)},this._lastWindowWidth=0,this._lastWindowHeight=0,this.lastScrollTop=0,this.lastScrollLeft=0,this._screen=void 0,this._onWindowResize(!0),this._onDocumentScroll(!1,!0),this.$els.window.on("resize",R.throttle(this._onWindowResize.bind(this,!1),10)),this.addHook("orientationchange",P(window.matchMedia("(orientation: portrait)")),"change",(()=>this._onOrientationChange())),this.addHook("pointer-move",this.$els.document,this._onPointerMove.bind(this)),this.addHook("pointer-up",this.$els.document,this._onPointerUp.bind(this)),this.addHook("fullscreenchange",this.$els.document,m.I.onChangeEventName,this._onFullScreenChange.bind(this)),this.addHook("paste-image",this.$els.document,"paste",this._onPasteImage.bind(this)),this._dndEnd=R.debounce((()=>{this.dragState=!1}),100),this.addHook("dnd",this.$els.document,"dragenter dragleave dragover",this._onDnD.bind(this)),this.addHook("dnd-drop",this.$els.document,"drop",this._onDnDDrop.bind(this)),this.addHook("beforeunload",this.$els.window,"beforeunload",this._onBeforeEnd.bind(this)),this.addHook("unload",this.$els.window,"unload",this._onPageUnload.bind(this)),this.addHook("blur",this.$els.window,"blur",this._onWindowBlur.bind(this)),this.addHook("focus",this.$els.window,"focus",this._onWindowFocus.bind(this)),d.E.isSupported&&this.addHook("visibilitychange",this.$els.document,d.E.onChangeEventName,this._onVisibilityChange.bind(this)),this.addHook("document-scroll",this.$els.document,"scroll",this._onDocumentScroll.bind(this)),this.addHook("document-end",this.$els.document,"scroll",R.throttle(this._onDetectDocumentEnd.bind(this),200)),this._updateJQuery(),g.x&&P('meta[name="theme-color"]').attr("content",this.css.colors.headerBackground),u.z.getInstance().init(),this._initLogoLink(),this._initNotificationsLinkAnalytics(),(new D).init(),queueMicrotask((()=>this._checkAuthUrl()))}init(){this.themeSettings.emit("noop"),new v.bi,new C,this._initPromoButtonAnalytics()}get marks(){return this._options.marks||(this._options.marks=new Map),this._options.marks}_updateJQuery(){let t=P.cleanData;P.cleanData=function(e){for(let t,s=0;void 0!==(t=e[s]);s++)P(t).triggerHandler("removed");t(e)}}get isPositionSticky(){if(this.marks.has("isPositionSticky"))return this.marks.get("isPositionSticky");let t="position:",e="sticky",s=document.createElement("a").style;return s.cssText=t+["-webkit-","-moz-","-ms-","-o-",""].join("sticky;"+t)+e+";",this.marks.set("isPositionSticky",-1!==s.position.indexOf(e)),this.marks.get("isPositionSticky")}addHook(t,e,s,n){if(!n&&R.isFunction(s)&&(n=s,s=t),!R.isFunction(n))return this;let o="pointer-move"===t;if("document-scroll"===t)return this.hook.on(t,(t=>{t!==i.ZK.FIRST_ON&&t!==i.ZK.LAST_OFF||this._scrollHookHandler(t,n)})),this;if("paste-image"===t)return this.hook.on(t,(t=>{t===i.ZK.FIRST_ON?window.document.addEventListener("paste",n,!0):t===i.ZK.LAST_OFF&&window.document.removeEventListener("paste",n)})),this;if(o||"pointer-up"===t)this.hook.on(t,(t=>{if(t===i.ZK.FIRST_ON){try{window.document.addEventListener(o?"touchmove":"touchend",n)}catch(e){}window.document.addEventListener(o?"mousemove":"mouseup",n)}else if(t===i.ZK.LAST_OFF){try{window.document.removeEventListener(o?"touchmove":"touchend",n)}catch(e){}window.document.removeEventListener(o?"mousemove":"mouseup",n)}}));else if("blur"===t||"focus"===t)return this.hook.on(t,(e=>{e===i.ZK.FIRST_ON?window.addEventListener(t,n):e===i.ZK.LAST_OFF&&window.removeEventListener(t,n)})),this;return this.hook.on(t,(t=>{t===i.ZK.FIRST_ON?e.on(s,n):t===i.ZK.LAST_OFF&&e.off(s,n)})),this}_initPromoButtonAnalytics(){p.vE.isMobileApp&&P(".promo-banner, .promo-button").on("click auxclick",(t=>{0!==t.button&&1!==t.button||f.c.getInstance().sendEvent("click",{type:t.target.getAttribute("data-type")})}))}_initNotificationsLinkAnalytics(){P(".notification a").on("click auxclick",(t=>{0!==t.button&&1!==t.button||(0===t.button&&t.preventDefault(),f.c.getInstance().sendEvent("click",{type:"notification_link",link:t.currentTarget.href}),0===t.button&&(window.location.href=t.currentTarget.href))}))}_scrollHookHandler(){}_onVisibilityChange(){return this.emit("visibilitychange",d.E.hidden),this}_onDnD(t){let e=this._options.dragState;if("dragleave"!==t.type){if("dragover"===t.type){if(!e)return;return t.preventDefault(),t.stopPropagation(),void this._dndEnd()}if("dragenter"===t.type){if(this._options.dragState||!t.originalEvent||!t.originalEvent.dataTransfer)return;let e=t.originalEvent.dataTransfer.types,s=e&&e.length;for(;s--;)if(e[s].indexOf("File")>-1){t.stopPropagation(),t.preventDefault(),this.dragState=!0;break}}}else{if(!e)return;this._dndEnd()}}_onDnDDrop(t){this.emit("dnd-drop",t)}_onBeforeEnd(t){return this.emitResult("beforeunload",t)}_onPageUnload(t){this.emit("unload",t)}_onWindowBlur(t){this.emit("blur",t)}_onWindowFocus(t){this.emit("focus",t)}_onDetectDocumentEnd(){let t=this.scrollTop,e=document.body.clientHeight-t;e<this._options.viewportHeightEnd&&this.emit("document-end",e,t)}_onPasteImage(t){if(!t||!t.clipboardData)return;let e=t.clipboardData.items;if(!e)return;if(3===e.length&&e[2].getAsFile()&&"image.png"===e[2].getAsFile().name&&"text/html"===e[1].type&&"text/plain"===e[0].type)return;let s=[];for(let i=0;i<e.length;i++)-1!==e[i].type.indexOf("image")&&s.push(e[i].getAsFile());s.length>0&&this.emit("paste-image",s,t)}elementWillSoonScrolled(t){return t.offsetHeight+t.offsetTop-this.scrollTop<this._options.viewportHeightEnd}elementInViewport(t,e=50){const s=B.isHTMLElement(t)?P(t):t;if(!s||!s.length)return!1;const i=s.offset(),n=this.windowHeight,o=i.top,r=s.height(),a=Math.floor(o-this.scrollTop),l=a+r;let h=a>=e&&a<=n||l<=n&&l>=e;return h||(h=a>=e&&a<=n||l<=n&&l>=e),h}_onPointerMove(t){return this.useTouchEvent&&t.touches&&t.touches.length>0?(this.emit("pointer-move",t.touches[0].clientX,t.touches[0].clientY,t),!0):(this.emit("pointer-move",t.pageX||t.clientX,t.pageY||t.clientY,t),!0)}_onPointerUp(t){return this.emit("pointer-up",t),!0}_onOrientationChange(){this.emit("orientationchange"),this.emit("gifx-orientationchange")}_onFullScreenChange(t){this.emit("fullscreenchange",m.I.isFullScreen,t.target)}_onWindowResize(t=!1){let e=this._isMobileSafari?window.innerWidth:document.documentElement.clientWidth,s=this._isMobileSafari?window.innerHeight:document.documentElement.clientHeight,i=!1;s===this._lastWindowHeight&&e===this._lastWindowWidth||(this._lastWindowHeight=s,this._lastWindowWidth=e,i=!0,this._options.viewportHeightEnd=s*this._options.beforeEndFactor),i&&!1===t&&this.emit("resize",e,s)}_attachRouteLinks(){return this.$els.document.on("click","a.link-route",(t=>{const e=t.currentTarget.getAttribute("href");t.preventDefault(),p.vE.history.pushUrl(e,!0)})),this.listenTo(p.vE,"route",(t=>{const e=t.path,s=document.querySelectorAll(`.menu__item_route[href="${e}"], .menu__item_route[data-route="${e}"]`);if(s&&s.length)for(let i of s){let t=i.parentNode.querySelectorAll(".menu__item_current");if(t.length)for(let e,s=t.length;s--;)e=t[s],e.classList.remove("menu__item_current");i.classList.add("menu__item_current")}})),this.$els.document.on("click",".menu__item_route",(t=>{const e=t.currentTarget,s=e.getAttribute("href")||e.getAttribute("data-route");t.preventDefault(),t.target.classList.contains("menu__item_current")||s&&p.vE.history.replaceUrl(s,!0)})),this}_attachTagsCut(){this.$els.document.on("click",".tags-cut",(t=>{const e=P(t.currentTarget),s=e.data("hint")||{};e.remove(),R.isFunction(s.destroy)&&s.destroy(),f.c.getInstance().yandex.goal(p.vE.isMobileApp?"show_all_tags_mob":"show_all_tags_pc")}))}_onDocumentScroll(t,e=!1){return this.lastScrollTop=this.scrollTop,this.lastScrollLeft=this.scrollLeft,!1===e&&this.emit("document-scroll"+(R.isNumber(t)?":"+t:""),this.lastScrollTop,this.lastScrollLeft),this}scrollTo(t,e=!1,s){if(p.vE.emit("manualScrollStart"),t instanceof P&&!t.length&&(t=t[0]),t instanceof HTMLElement&&(t=this.scrollTop+t.getBoundingClientRect().top),t=Number(t)||0,!e){return(s||this.els.scrollRoot).scrollTop=t,new Promise((t=>{t(),setTimeout((()=>p.vE.emit("manualScrollEnd")))}))}return new Promise((i=>{let n="number"==typeof e?e:200;(s?P(s):this.$els.scrollAnimation).stop().animate({scrollTop:t},n),setTimeout((()=>{i(),setTimeout((()=>p.vE.emit("manualScrollEnd")))}),n)}))}offsetElement(t){if(t instanceof P){if(!t.length)return!1;t=t[0]}if(!t)return!1;let{left:e,top:s}=t.getBoundingClientRect();return{top:s+this.scrollTop,left:e+this.scrollLeft}}getHeaderHeight(){var t;let e=".header";return k.V.isUserInExperiment(k.t.WEBM_REDESIGN)&&p.vE.isMobileApp&&(e=".pkb-app__header"),(null===(t=document.querySelector(e))||void 0===t?void 0:t.offsetHeight)||0}_getColor(t,e){let s=this._bodyComputedStyle;return s||(s=this._bodyComputedStyle=getComputedStyle(document.body)),(s.getPropertyValue(t)||e||"").trim()}_clearCSS(){delete this._css,delete this._bodyComputedStyle,this.emit("update-css")}get dragState(){return this._options.dragState}set dragState(t){this._options.dragState!==(t=Boolean(t))&&(this._options.dragState=t,this.emit("dnd",t))}get windowWidth(){return this._lastWindowWidth||(this._isMobileSafari?window.innerWidth:document.documentElement.clientWidth)}get windowHeight(){return this._lastWindowHeight||(this._isMobileSafari?screen.innerHeight:document.documentElement.clientHeight)}get screenHeight(){if(window.screen){if(navigator.userAgent.match(/iphone|ipod|ipad/i)){let t=c.type;return t===r.PORTRAIT_PRIMARY||t===r.PORTRAIT_SECONDARY?screen.height:screen.width}return screen.height}return window.innerHeight}get scrollTop(){return window.pageYOffset||this.els.scrollRoot.scrollTop}get scrollLeft(){return window.pageXOffset||this.els.scrollRoot.scrollLeft}get useTouchEvent(){return R.isUndefined(this._useTouchEvent)?this._useTouchEvent=Boolean("ontouchstart"in document.documentElement):this._useTouchEvent}get devicePixelRatio(){return window.devicePixelRatio}get scrollRestoration(){return N&&history.scrollRestoration||"auto"}set scrollRestoration(t){N&&(history.scrollRestoration=t)}get css(){return this._css||(this._css={margin:15,transitionTimeDefault:200,paddingLeft:25,animationPopup:250,fontFamily:'"Roboto", "Open Sans", Helvetica, Arial, sans-serif',colors:{bg:this._getColor("--color-bright-800","#fff"),green:this._getColor("--color-primary-700","#8ac858"),headerBackground:this._getColor("--color-primary-600","#8ac858"),caption:this._getColor("--color-black-700","#757575"),border:this._getColor("--color-black-440","#e9e9e9"),text:this._getColor("--color-black-940","#212121"),textGreen:this._getColor("--color-primary-900","#6c9b45")}}),this._css}get themeSettings(){if(this._themeSettings)return this._themeSettings;const t=this._themeSettings=new _.fM;return this.listenTo(t,"change",((t,e)=>{t===_.f0.DEFAULT?this.$els.html.removeAttr("data-theme"):this.$els.html.attr("data-theme",t.valueOf()),e?this.$els.html.attr("data-theme-dark",!0):this.$els.html.removeAttr("data-theme-dark"),this._clearCSS(),P('meta[name="theme-color"]').attr("content",p.vE.ui.css.colors.headerBackground)})),t}static isHTMLElement(t){return t instanceof HTMLElement||t instanceof Element}static isJQuery(t){return t instanceof P&&t.length>0}static isElement(t){return B.isJQuery(t)||B.isHTMLElement(t)}static clearEmptyTextNode(t){if(t&&t.childNodes&&t.childNodes.length)for(let e=t.childNodes.length-1;e>=0;--e){let s=t.childNodes[e];8===s.nodeType||3===s.nodeType&&!M.test(s.nodeValue)?t.removeChild(s):1===s.nodeType&&B.clearEmptyTextNode(s)}}static fragment(t){let e,s,i=document.createElement("template");if(i.innerHTML=t,"content"in i)return i.content;for(s=document.createDocumentFragment(),e=i.childNodes;e[0];)s.appendChild(e[0]);return s}static reloadScripts(){P('script[data-type="reload-js"]').each(((t,e)=>{const s=P(e).attr("src"),i=e.textContent;P(e).remove(),s?P('<script data-type="reload-js">').attr("src",s).appendTo("head"):P('<script data-type="reload-js">').text(i).appendTo("head")}))}static removeOldAds(){P("#adfox_300x600_1, #adfox_300x600_2").each(((t,e)=>{P(e).children("div, iframe").remove()}))}static getScrollRoot(){let t,e=document.documentElement,s=e.scrollTop;return e.scrollTop=s+5,t=e.scrollTop,e.scrollTop=s,t>s?e:document.body}get isEmbedded(){return this.$els.app.hasClass("app_iframe")||this.$els.app.hasClass("app_iframe-fw")}get screen(){return this._screen}set screen(t){this._screen!==t&&(this._screen=t)}_initLogoLink(){const t=k.V.isUserInExperiment(k.t.WEBM_REDESIGN)?".pkb-app__header .pkb-header-mobile__logo":".header__logo",e=document.querySelector(p.vE.isMobileApp?t:".header__logo a");if(!e)return;const{tcId:s,tcLink:i}=e.dataset;s&&i&&w.m.get(T.e)!==s&&e.addEventListener("click",(t=>{t.preventDefault(),w.m.set(T.e,s),window.open(i,"_blank")}),{once:!0})}_checkAuthUrl(){if(p.vE.isUserAuthorized)return;new O._(window.location.search).has("authRedirect")&&p.vE.ui.authRequired()}_initMiniProfileAnalytics(t,e){let s=null,i=null,n=null,o=t;for(;o;)o.classList.contains("story__user-link")&&(s={source:"from_post_mini",show:"user_profile_mini_post"},i=Number(o.dataset.id)),o.classList.contains("comment__user")&&(s={source:"from_comments_mini",show:"user_profile_mini_comments"},i=Number(o.dataset.id)),o.classList.contains("sidebar-comment-day")&&(s={source:"mini_profile_best_comment_daily",show:"user_profile_mini_best_comment_daily"},n=Number(o.dataset.id)),o.classList.contains("comment")&&(n=Number(o.dataset.id)),o=o.parentElement;s&&i&&(f.c.getInstance().sendEvent("form_show",{type:s.show,author_id:i,"comment_id!empty":n}),e.find(".profile__nick a").on("click auxclick",(t=>{0!==t.button&&1!==t.button||f.c.getInstance().sendEvent("transition_to_author",{type:s.source,author_id:i})})),e.get(0).querySelectorAll('[data-role="subscribe"], [data-role="ignore"], .profile__user-notification-bell').forEach((t=>{t.dataset.analyticsType=s.source})))}}},8553:(t,e,s)=>{"use strict";s.d(e,{v:()=>n,j:()=>p});s(4916),s(5306),s(6992),s(3948),s(8674);var i=s(8211);const n=new(s(7892).xs)({IMAGE:"image",VIDEO:"video"});var o=s(4143),r=s(5983);let a;s(6419);const l=s(9755),h=/(https?:\/\/)[^\s"'`\]\[{}<>^|]+/gi,c=/pikabu\.(ru|lh|dev)\/story\/[^\s"'`\]\[{}<>^|]+/gi,d=/^https?:\/\//,u=/&nbsp;$/;class p{constructor(t="main"){if(this._prefix=t,"main"===this.prefix&&a)return a}add(t){Array.isArray(t)?t.forEach((t=>this.storage.add(t))):this.storage.add(t)}clear(){this.hasStorage()&&this.storage.clear()}remove(t){this.hasStorage()&&this.storage.delete(t)}has(t){return!!this.hasStorage()&&(!!this.storage.has(t)||(t=t.replace(d,""),[...this.storage].some((e=>e.replace(d,"")===t))))}hasStorage(t){const e=t&&t.length?t:this.prefix;return Boolean(i.vE.storage.urlsExtracted&&i.vE.storage.urlsExtracted[e])}static extract(t,e=h){let s,i=[];for(t=r.c.getTextContent(t);null!==(s=e.exec(t));)i.push(s[0].replace(u,""));return i}static extractStoryURL(t){return p.extract(t,c)}async extractImageURLs(t,e=[]){const s=[],i=p.extract(t).filter((t=>!this.has(t)&&-1===e.indexOf(t)));for(const n of i)"string"==typeof n&&(await this.isImageURL(n)?s.push(n):this.add(n));return s}async extractImageVideoUrls(t,e=[]){let s=[],i=p.extract(t);i=i.filter((t=>!this.has(t)&&-1===e.indexOf(t)));for(const o of i)"string"==typeof o&&(this.isVideoURL(o)?s.push({url:o,type:n.VIDEO}):await this.isImageURL(o)?s.push({url:o,type:n.IMAGE}):this.add(o));return s}isImageURL(t){return new Promise((e=>{l(document.createElement("img")).on("error",(()=>e(!1))).on("load",(()=>e(!0))).attr("src",t)[0].complete&&e(!0)}))}isVideoURL(t){return Boolean(o.tv.getProviderTypeBySource(t))}static getPrefixedStorage(t){return i.vE.storage.urlsExtracted||(i.vE.storage.urlsExtracted=[]),i.vE.storage.urlsExtracted[t]||(i.vE.storage.urlsExtracted[t]=new Set),i.vE.storage.urlsExtracted[t]}static get instance(){return a||(a=new p),a}get storage(){return i.vE.storage.urlsExtracted||(i.vE.storage.urlsExtracted=[]),i.vE.storage.urlsExtracted[this.prefix]||(i.vE.storage.urlsExtracted[this.prefix]=new Set),i.vE.storage.urlsExtracted[this.prefix]}get prefix(){return this._prefix}}},4277:(t,e,s)=>{"use strict";s.d(e,{oN:()=>i,_y:()=>n,j$:()=>o,V:()=>r,$$:()=>a});const i="_nuser",n=12e4,o="group",r=Object.freeze({about:"about",gender:"sex",newst:"post_rating_from_show",commentst:"comment_rating_from_show",is_twitmode:"page_view",is_scrollmode:"post_content_hide",is_full_story_view:"long_post_show_full",show_porno:"nsfw_show",is_horror:"tag_nasty_post_show",is_tags_at_top_dv:"tags_on_top_show",is_video_autoplay_mode:"autoplay_gif_and_video",show_related_stories:"similar_posts_under_comments_show",max_comments_branch_depth:"comments_level_from_collapse",hide_gifs:"gif_comments_pause",default_com_view:"comments_sort",scroll_top:"back_to_top_show",is_ads_disabled:"ad_turn_off",viewed_post:"viewed_post",tags_fold_mode:"tags_display",color_theme:"color_theme",site_color:"site_color",politics_show:"politics_show",nickname:"nickname"}),a=1383332},9019:(t,e,s)=>{"use strict";let i;s.d(e,{D:()=>i}),function(t){t.STORY="story",t.COMMENT="comment"}(i||(i={}))},8881:(t,e,s)=>{"use strict";s.r(e),s.d(e,{GROUP_AVATAR_CODE:()=>l.j$,PREDEFINED_USERS_TYPE:()=>r.D,SETTINGS_TIMEOUTE:()=>l._y,SUPPORT_TECH_USER_ID:()=>l.$$,USER_SETTINGS_ANALYTICS_MAP:()=>l.V,USER_SIGNUP_COOKIE_KEY:()=>l.oN,User:()=>i.n,Users:()=>a});var i=s(6151),n=(s(8674),s(2134)),o=s(6889),r=(s(7892),s(9019));s(6419);class a{static async search(t=""){let e=o.h.getInstance("droplistUsers");if(e.has(t))return e.get(t);let s=n.cf.get("/ajax/users_actions.php",{action:"droplist",q:t});return s=s.then((s=>e.set(t,s.response.result?s.data:[]))),e.set(t,s)}static async predefinedInStory(t,e){let s=o.h.getInstance("droplistPredefinedUsers"),i=String(t);if(s.has(i))return s.get(i);let r=n.cf.get("/ajax/users_actions.php",{type:e&&e.valueOf(),q:"",action:"droplist",story_id:t});return r=r.then((t=>s.set(i,t.response.result?t.data:[]))),s.set(i,r)}static hasSearchCache(t=""){let e=o.h.getInstance("droplistUsers");return e.has(t)&&!(e.get(t)instanceof Promise)}}var l=s(4277)},6151:(t,e,s)=>{"use strict";s.d(e,{n:()=>S});s(8674),s(4916),s(5306),s(4603);var i=s(2134);const n=s(6419);class o{static set(t,e,s){if("number"==typeof(s=n.extend({path:"/"},s)).expires){let t=new Date;t.setMilliseconds(t.getMilliseconds()+864e5*s.expires),s.expires=t}if(!n.isString(e)&&!n.isNumber(e))try{let t=JSON.stringify(e);/^[{\[]/.test(t)&&(e=t)}catch(i){e=e.toString()}return e=encodeURIComponent(String(e)).replace(/'/g,"%27").replace(/%(23|24|26|2B|3A|3C|3E|3D|2F|3F|40|5B|5D|5E|60|7B|7D|7C)/g,decodeURIComponent),t=encodeURIComponent(String(t)).replace(/'/g,"%27").replace(/%(23|24|26|2B|5E|60|7C)/g,decodeURIComponent).replace(/[()]/g,escape),document.cookie=[t,"=",e,s.expires?"; expires="+s.expires.toUTCString():"",s.path?"; path="+s.path:"",s.domain?"; domain="+s.domain:"",s.secure?"; secure":""].join("")}static get(t,e=!1){let s,i=document.cookie?document.cookie.split("; "):[],n=/(%[0-9A-Z]{2})+/g,o=0;for(t||(s={});o<i.length;o++){let a=i[o].split("="),l=a.slice(1).join("=");'"'===l.charAt(0)&&(l=l.slice(1,-1));try{let i=a[0].replace(n,decodeURIComponent);if(l=l.replace(n,decodeURIComponent),e)try{l=JSON.parse(l)}catch(r){l=void 0}if(t===i){s=l;break}t||(s[i]=l)}catch(r){}}return s}static remove(t,e){return o.set(t,"",n.extend(e||{},{expires:-1}))}}function r(t,e){this.constructor.prototype.__proto__=Error.prototype,Error.captureStackTrace&&Error.captureStackTrace(this,this.constructor),this.name=this.constructor.name,this.param=t,this.message=e}var a=s(4277),l=s(6572),h=s(8211),c=s(9698),d=s(2822),u=s(4758),p=s(975),m=s(8924),_=s(7320),g=s(6815),v=s(9050);function f(t,e){var s=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),s.push.apply(s,i)}return s}function y(t){for(var e=1;e<arguments.length;e++){var s=null!=arguments[e]?arguments[e]:{};e%2?f(Object(s),!0).forEach((function(e){b(t,e,s[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(s)):f(Object(s)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(s,e))}))}return t}function b(t,e,s){return e in t?Object.defineProperty(t,e,{value:s,enumerable:!0,configurable:!0,writable:!0}):t[e]=s,t}const w=c.o.escape(),E={default:t=>t,nsfw_show:t=>1===Number(t)?1:0,politics_show:t=>1===Number(t)?1:0,viewed_post:t=>p.rg[t.toString()].valueOf(),tags_display:t=>m.NP[Number(t)].valueOf(),comments_level_from_collapse:t=>0===t?10:t,site_color:t=>g.f0[t.toString()].valueOf(),color_theme:t=>g.PH[t.toString()].valueOf()};class S{constructor(t){this._id=Number(t)}static sendUserParamsOnSessionStart(){var t;if(null===(t=window.PkbAnalytics)||void 0===t||!t.newSessionStarted||this._onSessionStartEventWasSend)return;this._onSessionStartEventWasSend=!0;const e={},s=h.vE.initParams;(null==s?void 0:s.userID)>0&&(e.rating=s.userKarma,e.nsfw=s.isAdultVisible?1:0,e.hide_visited=2===s.storiesDisplayMode?1:0,e.color_theme=h.vE.ui.themeSettings.data.dark?g.PH.DARK.valueOf():g.PH.LIGHT.valueOf(),e.site_color=h.vE.ui.themeSettings.data.theme.valueOf()),h.vE.adblock.ready.then((t=>{e.adblock=t?1:0,d.c.getInstance().sendEvent("user_params",e,[_.b.CLICKHOUSE])}))}static sendSettingsChangeAnalytics(t,e,s){const i=a.V[t],n=E[i]||E.default;i&&d.c.getInstance().sendEvent("user_setting_change",y(y({type:i},void 0!==e&&{value_old:n(e)}),void 0!==s&&{value_new:n(s)}))}static _postUserAction(t){return i.cf.post("/ajax/users_actions.php",t)}async subscribe(t,e={}){d.c.getInstance().sendEvent(t?"subscribe_to_author":"unsubscribe",y({author_id:this._id},e));let{response:s}=await i.cf.post("/ajax/user_sub.php",{state:Number(!t),user_id:this._id});if(!s.result)throw new Error(s.message)}async notificationSubscribe(t){let{response:e}=await i.cf.post("/ajax.php",{route:"user-notification-subs",user_id:this._id,is_notify:t?1:0});if(!e.result)throw new Error(e.message)}async ignore(t){const{response:e}=await this._postUserAction({action:"ignore"+(t?"+":"-"),id:this._id});if(!e.result)throw new Error(e.message)}async block(t){let{response:e}=await i.cf.post("/ajax/moderator_actions.php",{action:"block_new_user",user_id:this._id,reason_id:t});if(!e.result)throw new Error(e.message)}async note(t){const{response:e}=await S._postUserAction({action:t?"note+":"note-",message:t,id:this._id});if(!e.result)throw new Error(e.message);return!0}async about(t){const{response:e}=await S._postUserAction({action:"update_about",about:t});if(!e.result)throw new Error(e.message);return!0}static async switchAdult(t){return this._postUserAction({action:"switch_adult",mode:t?"on":"off"})}static async switchPolitics(t){return this._postUserAction({action:"switch_politics",mode:t?"on":"off"})}static async register(t){let e=await i.cf.post("/ajax/register.php",t);return e.response.result&&S._processSuccessfulSignup(),e}static async registerOAuth(t,e){const{response:s,data:n}=await i.cf.post("/ajax/register_actions.php",{action:"oauth",username:t,"g-recaptcha-response":e});if(!s.result){const t=s.message||h.vE.i18n("errors.response");throw n&&n.param?new r(n.param,t):new Error(t)}return!0}static registerInit(t){return i.cf.post("/ajax/register_actions.php",v.defaults(t,{action:"init"}))}static async registerSubmit(t){let e=await i.cf.post("/ajax.php?route=signup",t);return e.response.result&&S._processSuccessfulSignup(),e}static async registerSubmitBySmsCode(t,e){let s=await i.cf.post("/ajax/register_actions.php",{action:"code",register_id:t,code:e});return s.response.result&&S._processSuccessfulSignup(),s}static async restorePasswordConfirm(t,e,s){return await i.cf.post("/ajax/restore_passwd.php",{action:"set_password",session_id:t,confirm_code:e,p:s})}static async authorizeSpecAccount(t,e,s){const{data:n}=await i.cf.get("/ajax/get_nonce.php"),o=Math.random(),r=u.V.hashStr(String(n.nonce+o+t.password));return await i.cf.post("/ajax/auth.php",y(y({},"oauth"===t.mode&&{mode:"oauth"}),{},{username:t.username,password:t.password,session_id:e,confirmation_code:s,cnonce:o,hash:r}))}static async authorize(t){const{data:e}=await i.cf.get("/ajax/get_nonce.php"),s=Math.random(),n=u.V.hashStr(String(e.nonce+s+t.password));return await i.cf.post("/ajax/auth.php",v.defaults(t,{mode:"login",cnonce:s,hash:n}))}static async logout(t=!1){let{response:e,data:s}=await i.cf.post("/ajax/logout.php",!0===t?{type:"global"}:void 0);return!!e.result&&(d.c.getInstance().sendEvent("log_out",{type:"log_out"}),h.vE.ua.safari||(Boolean(navigator.credentials)&&await navigator.credentials.preventSilentAccess(),h.vE.bc.send("logout")),window.location.href=s.url,!0)}static async saveSettings(t){return(await this._postUserAction(t)).response.result}static async addPhone(t){const e=await this._postUserAction({action:"add_phone",phone:t});if(!e.response.result){let t=e.response.message||h.vE.i18n("errors.response");throw e.data&&e.data.param?new r(e.data.param,t):new Error(t)}return e.data.session_id}static async addPhoneConfirm(t,e){const s=await this._postUserAction({action:"add_phone_confirm",session_id:t,confirm_code:e});if(!s.response.result)throw new Error(s.response.message||h.vE.i18n("errors.response"));return!0}static async changePhone(t,e){const s=await this._postUserAction({action:"change_phone",password:e,new_phone:t});if(!s.response.result){const t=s.response.message||h.vE.i18n("errors.response");throw s.data&&s.data.param?new r(s.data.param,t):new Error(t)}return s.data.session_id}static async changePhoneConfirm(t,e){const s=await this._postUserAction({action:"change_phone_confirm",session_id:t,confirm_code:e});if(!s.response.result)throw new Error(s.response.message||h.vE.i18n("errors.response"));return!0}static async cancelChangePhone(t){const e=await this._postUserAction({action:"cancel_phone_change",password:t});if(!e.response.result){const t=e.response.message||h.vE.i18n("errors.response");throw e.data&&e.data.param?new r(e.data.param,t):new Error(t)}return e.data.session_id}static async cancelChangePhoneConfirm(t,e){const s=await this._postUserAction({action:"cancel_phone_change_confirm",session_id:t,confirm_code:e});if(!s.response.result)throw new Error(s.response.message||h.vE.i18n("errors.response"));return!0}static async changeEmail(t,e){const s=await this._postUserAction({action:"change_email",password:e,email:t});if(!s.response.result){const t=s.response.message||h.vE.i18n("errors.response");throw s.data&&s.data.param?new r(s.data.param,t):new Error(t)}return!0}static async changeNickname(t,e){const s=await this._postUserAction({action:"change_nickname",password:e,nickname:t});if(!s.response.result){const t=s.response.message||h.vE.i18n("errors.response"),e=s.data.analytics_code;throw e&&d.c.getInstance().sendEvent("error_occurred",{type:e}),s.data&&s.data.param?new r(s.data.param,t):new Error(t)}return!0}static async changePassword(t,e){const s=await this._postUserAction({action:"change_password",password_current:e,password_new:t});if(!s.response.result){const t=s.response.message||h.vE.i18n("errors.response");throw s.data&&s.data.param?new r(s.data.param,t):new Error(t)}return!s.data.session_id||s.data.session_id}static async changePasswordConfirm(t,e){const s=await this._postUserAction({action:"change_password_confirm",session_id:t,confirm_code:e});if(!s.response.result)throw new Error(s.response.message||h.vE.i18n("errors.response"));return!0}static async removeOAuth(t){return(await i.cf.get("/oauth.php",{type:t.valueOf(),remove:1})).response.result}static async isUserAvailable(t){t=t.trim();let e=l.hG.getInstance("availableUserNames");if(e.has(t))return e.get(t);let s=i.cf.post("/ajax/username_check.php",{username:t});return s=s.then((s=>{const n=s.data.available_usernames||[];return e.set(t,{message:s.response.status===i.Wi&&s.response.message,availableUserNames:n})})),e.set(t,s)}static getMiniProfile(t){t=t.trim();let e=l.hG.getInstance("profileUser");if(e.has(t))return e.get(t);let s=i.cf.post("/ajax/user_info.php",{action:"get_short_profile",user_name:t});return s=s.then((s=>s.response.status===i.Wi?s.response.result?e.set(t,s.data.html):"&nbsp;"+s.response.message+"&nbsp;":e.set(t,!1))),e.set(t,s)}static flushMiniProfilesCache(t){let e="profileUser";if(t){l.hG.getInstance(e).remove(t)}else l.hG.remove(e)}static changeMiniProfileNote(t,e){t=t.trim();let s=l.hG.getInstance("profileUser");if(s.has(t)){let i=document.createElement("div");i.innerHTML=s.get(t).trim(),i.querySelectorAll(".profile__note-inner")[0].innerHTML=e,s.set(t,i.innerHTML)}}static async restorePassword(t){const{response:e,data:s}=await i.cf.post("/ajax/restore_passwd.php",t);if(e.result)return s;throw new Error(e.message)}static async dropBackground(){const{response:t}=await this._postUserAction({action:"drop_background"});if(!t.result)throw new Error(t.message)}static async getNotifications(t=1){const{response:e,data:s}=await this._postUserAction({action:"get_notifications",limit:t});if(!e.result)throw new Error(e.message);return s}static async removeNotifications(){const{response:t}=await this._postUserAction({action:"remove_notifications"});if(!t.result)throw new Error(t.message)}static noteValueToHtml(t,e={}){if(!t||""===t.trim())return"";e=v.extend({newLineToBr:!0,commentLinks:!1,cropLinks:!1,noFollow:!1},e);let s=t.trim();return s=w(s),e.newLineToBr&&(s=s.replace(/([^>\r\n]?)(\r\n|\n\r|\r|\n)/g,"$1<br/>$2")),this.parselinks(s,e)}static parselinks(t,e={}){let s=t,i=t.match(/(https?:\/\/)?([-.a-zA-Z0-9]+)(\.[a-z]{2,5})(\/)?([-\/@\w+]*)?\??([-\/\w=%&.;+]*)?#?\/?([\/\w\-]*)?\??([-\/\w=%&.;+]*)?/gm);if(!i)return s;i=v.uniq(i);for(let n=0;n<i.length;n++){const t=/^https?:\/\//.test(i[n])?i[n]:`http://${i[n]}`;let o=0,r='target="_blank"';e.commentLinks&&(o=i[n].match(/(cid=([0-9]+))/),o=null!==o?Number(o[2]):0);let a=o>0?`#comment_${o}`:i[n];e.cropLinks&&a.length>62&&(a=a.slice(0,59)+"…"),e.noFollow&&(r+=' rel="nofollow"'),i[n]=l.cQ.escapeRegExp(i[n]);const h=new RegExp(`(^|[\\s{[(,;])(${i[n]})($|[\\s}\\])<,;])`,"gm");let c=0;for(;h.test(s)&&++c<50;)s=s.replace(h,`$1<a href="${t}" ${r}>${a}</a>$3`)}return s}static _processSuccessfulSignup(){o.set(a.oN,1,{expires:365})}get id(){return this._id}}b(S,"_onSessionStartEventWasSend",!1)},6889:(t,e,s)=>{"use strict";s.d(e,{h:()=>n});s(6992),s(3948),s(8674);const i=new Map;class n{constructor(){this._lastAction=Date.now(),this._cacheData=new Map}get(t){return this._lastAction=Date.now(),this._cacheData.get(t)}set(t,e){return this._lastAction=Date.now(),this._cacheData.set(t,e),e}has(t){return this._lastAction=Date.now(),this._cacheData.has(t)}remove(t){return this._lastAction=Date.now(),this._cacheData.delete(t)}removeUnused(){this._cacheData.forEach(((t,e)=>{t instanceof Promise||this._cacheData.delete(e)}))}get lastAction(){return this._lastAction}get size(){return this._cacheData.size}static getInstance(t="main"){if(i.has(t))return i.get(t);let e=new n;return i.set(t,e),e}static remove(t){return i.delete(t)}static removeUnused(t){i.forEach(((e,s)=>{t&&e.lastAction<t||(e.removeUnused(),e.size||i.delete(s))}))}}},4391:(t,e,s)=>{"use strict";s.d(e,{v:()=>i});const i="IntersectionObserver"in window},4850:(t,e,s)=>{"use strict";s.d(e,{P:()=>n});var i=s(7333);const n="serviceWorker"in navigator&&i.N},1078:(t,e,s)=>{"use strict";s.d(e,{k:()=>m});s(1817),s(8674);var i=s(8211),n=s(6572),o=s(2822),r=s(9050);function a(t,e){var s=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),s.push.apply(s,i)}return s}function l(t){for(var e=1;e<arguments.length;e++){var s=null!=arguments[e]?arguments[e]:{};e%2?a(Object(s),!0).forEach((function(e){h(t,e,s[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(s)):a(Object(s)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(s,e))}))}return t}function h(t,e,s){return e in t?Object.defineProperty(t,e,{value:s,enumerable:!0,configurable:!0,writable:!0}):t[e]=s,t}let c,d=null;const u=s(9755),p=Symbol();class m{constructor(t){if(t!==p)throw new Error("Cannot construct singleton");this._prepare=void 0,this._options={isRendered:!1,siteKey:void 0,wrapper:void 0,lastToken:void 0,grecaptcha:void 0},this._isAnalyticsSend=!1}async render(t={}){return this._options.isRendered?this:(await m.initScript(),this._options.grecaptcha=grecaptcha,this.grecaptcha?(window.onCaptchaCallback||(window.onCaptchaCallback=t=>{this._options.lastToken=t}),this.grecaptcha.ready((()=>{this._grecaptchaID=this.grecaptcha.render(this.wrapper,l(l({},t),{},{sitekey:this.siteKey,size:"invisible",callback:"onCaptchaCallback",badge:"bottomleft"}))})),this._options.isRendered=!0,this):(i.vE.logger.error("GReCaptcha","cant init"),this))}reset(){return this.grecaptcha.reset(),this}async getToken(t="undefined_place"){var e;let s=480;for(this._options.lastToken=void 0,this.wrapper.classList.remove("footer__captcha_static"),this.wrapper.style.display="none",this.grecaptcha.execute(this._grecaptchaID),null===(e=this.reCaptchaContainer)||void 0===e||e.classList.add("grecaptcha__container");!this.lastToken&&--s>0;)this._getTokenWithPicture||await this._checkPictureForToken(t),await n.cQ.delay(500);return await this._sendCaptchaAnalytics(t),this.wrapper.classList.add("footer__captcha_static"),this.wrapper.style.display="block",Boolean(this.lastToken)}async _checkPictureForToken(t){var e;"visible"===(null===(e=this.reCaptchaContainer)||void 0===e?void 0:e.style.visibility)&&(this._pictureTokenTimeStart=new Date,this._getTokenWithPicture=!0,o.c.getInstance().sendEvent("captcha_manual_show",{type:t}))}async _sendCaptchaAnalytics(t){if(!this._isAnalyticsSend&&this._getTokenWithPicture&&this.lastToken){const e=new Date-this._pictureTokenTimeStart;o.c.getInstance().sendEvent("captcha_manual_pass",{type:t,viewTime:e}),this._isAnalyticsSend=!0}}get grecaptcha(){return this._options.grecaptcha}setOptions(t){return r.isObject(t)?(r.forEach(t,((t,e)=>{this[e]=t})),this):this}get siteKey(){return this._options.siteKey}set siteKey(t){this._options.siteKey=String(t)}get wrapper(){let t=this._options.wrapper;return t||(t=this._options.wrapper=document.createElement("div"),t.classList.add("captcha"),document.querySelector("body").appendChild(t)),t}set wrapper(t){let e=this._options.wrapper;t instanceof u&&(t=t[0]),t&&e!==t&&(this._options.wrapper=t)}get lastToken(){return this._options.lastToken}get reCaptchaContainer(){var t,e;return null===(t=document.querySelector('iframe[src*="google.com/recaptcha/api2/bframe"]'))||void 0===t||null===(e=t.parentNode)||void 0===e?void 0:e.parentNode}static get instance(){return c||(c=new m(p),c)}static initScript(){return d||(d=new Promise(((t,e)=>{const s=document.createElement("script");s.src="https://www.google.com/recaptcha/api.js?render=explicit",s.setAttribute("async","async"),s.setAttribute("defer","defer"),s.addEventListener("load",(()=>{grecaptcha.ready(t)})),s.addEventListener("error",e),document.body.appendChild(s)})),d)}}},6596:(t,e,s)=>{"use strict";s.d(e,{K:()=>h});s(1817),s(8674);var i=s(8211),n=s(2134),o=s(1078);const r=i.vE.config("grecaptchaV3Key");let a;const l=Symbol();class h{constructor(t){if(t!==l)throw new Error("Cannot construct singleton");this._prepare=void 0,this._options={isRendered:!1,lastTokenV3:void 0,grecaptcha:void 0}}async render(){return this._options.isRendered?this:(this._options.isRendered=!0,await o.k.initScript(),grecaptcha?(grecaptcha.ready((()=>{const t=this._getWrapper();this._captchaID=grecaptcha.render(t,{sitekey:r,size:"invisible",badge:"bottomleft"})})),this._options.grecaptcha=grecaptcha,this):(i.vE.logger.error("GReCaptchaV3","cant init"),this))}_getWrapper(){let t=document.querySelector(".footer__captcha_v3");if(t||(t=document.querySelector(".sidebar-block__captcha"),t&&(t.style.display="block")),t||(t=document.querySelector(".auth__captcha_v3")),t||(t=document.querySelector(".story-editor__captcha"),t&&(t.style.display="none")),!t){const e=document.createElement("div");e.setAttribute("class","footer__captcha_v3 footer__captcha_nofooter"),e.setAttribute("style","visibility: hidden"),document.querySelector(".app").append(e),t=e}return t}reset(){return this.grecaptcha.reset(),this}async getTokenV3(t="undefined_action"){return this._options.isRendered||await this.render(),this.lastTokenV3&&!this._isTokenExpired()?new Promise((t=>{t(this.lastTokenV3)})):new Promise((e=>{this.grecaptcha.ready((async()=>{let s;try{s=await this.grecaptcha.execute(this._captchaID,{action:t})}catch(i){console.error(null==i?void 0:i.message)}this._options.lastTokenV3=s,this._options.timeLastTokenV3=Date.now(),e(s)}))}))}async getScore(t="undefined_action"){if(this._lastScoreV3&&!this._isTokenExpired())return this._lastScoreV3;this.lastTokenV3&&!this._isTokenExpired()||await this.getTokenV3(t);const{response:e,data:s}=await n.cf.get("/ajax.php?route=captcha/get_score",{token:this.lastTokenV3});return e.result&&s?(this._lastScoreV3=s.score,this._lastScoreV3):(console.error("There is a problem with getting response from server with grecaptchaV3 score"),-1)}_isTokenExpired(){return Date.now()-this.timeLastTokenV3>11e4}get grecaptcha(){return this._options.grecaptcha}get lastTokenV3(){return this._options.lastTokenV3}get timeLastTokenV3(){return this._options.timeLastTokenV3}static getInstance(){return a||(a=new h(l),a)}}},8977:(t,e,s)=>{"use strict";s.d(e,{g:()=>r,D:()=>h});s(4916),s(6992),s(3948),s(5306),s(285),s(1637);var i=s(8211),n=s(9415),o=s(7215);const r=150,a="image/jpeg",l=new Date(2015,10,30);class h{constructor(t,e={}){if(!t.dataset.watermarkInit&&this._checkNeed(t.src)){var s,o,r;if(this._originalImage=t,this._options={},Object.keys(e).forEach((t=>{this._options[t]=e[t]})),t.crossOrigin="anonymous",i.vE.ua.chrome||i.vE.ua.opera)null===(s=t.parentElement)||void 0===s||s.addEventListener("contextmenu",(()=>{this._handleContextMenu()}));if(i.vE.isDesktopApp)null===(o=t.parentElement)||void 0===o||o.addEventListener("mouseenter",(()=>{t.complete?this._handleMouseEnter():t.addEventListener("load",(()=>this._handleMouseEnter()))})),null===(r=t.parentElement)||void 0===r||r.addEventListener("mouseleave",(t=>{t.relatedTarget&&this._removeFakeImage(t)}));if(n.v&&i.vE.isMobileApp&&(i.vE.ua.firefox||i.vE.ua.safari)){let e=!1;new IntersectionObserver((t=>{t.forEach((t=>{t.isIntersecting?(e=!0,setTimeout((()=>{e&&this._handleMouseEnter()}),3e3)):(e=!1,this._removeFakeImage())}))})).observe(t)}t.dataset.watermarkInit="1",h._watermark||h._createWatermark()}}_checkNeed(t){if(t.match(/\.gif$/))return!1;if(t.match(/\/(big_size|previews)_comm\//))return!0;const e=t.match(/\/(\d{4})\/(\d{2})\/(\d{2})\//);if(!e)return!1;return new Date(Number(e[1]),Number(e[2])-1,Number(e[3]))>=l}static _createWatermark(){const t=new Image;t.src="data:image/svg+xml,"+encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="48" height="16" fill="none" opacity=".5" xmlns:v="https://vecta.io/nano"><rect width="48" height="16" rx="8" fill="#fff"/><path d="M6.062 6.328v.137c.211-.264.431-.457.658-.579a1.58 1.58 0 0 1 .774-.187 1.77 1.77 0 0 1 .955.271c.291.181.52.444.687.791s.255.758.255 1.233a3.02 3.02 0 0 1-.148.966 2.17 2.17 0 0 1-.399.737 1.78 1.78 0 0 1-.605.458 1.76 1.76 0 0 1-.745.158c-.321 0-.591-.065-.811-.196s-.424-.322-.621-.575v1.707c0 .5-.18.75-.539.75-.211 0-.351-.065-.42-.196S5 11.489 5 11.242V6.336c0-.217.047-.378.14-.483s.221-.162.383-.162a.49.49 0 0 1 .387.167c.099.111.152.265.152.471zm2.201 1.653c0-.3-.045-.557-.136-.77s-.217-.382-.379-.496a.9.9 0 0 0-.531-.175 1 1 0 0 0-.786.371c-.211.247-.317.611-.317 1.091 0 .453.106.805.317 1.058a.98.98 0 0 0 .786.375.9.9 0 0 0 .518-.162c.159-.108.287-.276.383-.496s.144-.484.144-.795zm3.236-1.645v3.286c0 .228-.053.4-.16.516a.53.53 0 0 1-.407.175.51.51 0 0 1-.403-.179c-.101-.119-.152-.29-.152-.512V6.37c0-.225.051-.394.152-.508a.52.52 0 0 1 .403-.171c.165 0 .3.057.407.171s.16.272.16.475zm-.556-1.174c-.156 0-.291-.049-.403-.146s-.165-.235-.165-.412a.51.51 0 0 1 .169-.396.57.57 0 0 1 .399-.158c.145 0 .274.047.387.142s.169.232.169.412-.055.312-.165.412a.57.57 0 0 1-.391.146zm4.603 4.631l-.992-1.649-.609.583v.904c0 .219-.058.389-.173.508s-.243.175-.391.175c-.173 0-.309-.058-.407-.175s-.148-.289-.148-.516V4.775c0-.253.048-.444.144-.575s.233-.2.412-.2c.173 0 .31.06.412.179s.152.296.152.529v2.757l1.263-1.341c.156-.167.276-.28.358-.341a.49.49 0 0 1 .3-.092.48.48 0 0 1 .35.137c.093.089.14.201.14.337 0 .167-.152.389-.457.666l-.597.554 1.152 1.832.181.312c.038.069.058.136.058.2 0 .18-.049.323-.148.429a.5.5 0 0 1-.383.154c-.137 0-.243-.037-.317-.112a2.71 2.71 0 0 1-.3-.408zm4.636-.121c-.272.214-.535.375-.79.483a2.19 2.19 0 0 1-.852.158 1.63 1.63 0 0 1-.761-.171 1.27 1.27 0 0 1-.502-.471 1.23 1.23 0 0 1-.177-.641c0-.311.097-.576.292-.795s.462-.366.802-.441l.531-.112.724-.158.658-.179c-.014-.3-.074-.519-.181-.658s-.322-.212-.654-.212c-.285 0-.501.04-.646.121s-.266.201-.37.362l-.218.321c-.041.05-.132.075-.272.075-.126 0-.236-.04-.329-.121a.41.41 0 0 1-.136-.317c0-.2.07-.394.21-.583s.358-.344.654-.466.665-.183 1.107-.183c.494 0 .882.06 1.165.179a1.07 1.07 0 0 1 .597.558c.118.255.177.594.177 1.016l-.004.679-.004.621c0 .214.034.437.103.67s.107.379.107.446c0 .117-.055.223-.165.321s-.229.142-.366.142c-.115 0-.229-.054-.341-.162s-.232-.271-.358-.479zm-.074-1.645a5.76 5.76 0 0 1-.72.196l-.65.15a.85.85 0 0 0-.346.187c-.11.092-.165.221-.165.387 0 .172.064.319.193.441s.298.179.506.179c.222 0 .427-.049.613-.146a.99.99 0 0 0 .416-.383c.101-.172.152-.455.152-.85v-.162zM23.36 4.65v1.737c.211-.222.427-.391.646-.508s.491-.179.815-.179c.373 0 .699.09.979.271s.501.437.654.779.235.741.235 1.208a3.25 3.25 0 0 1-.132.95 2.25 2.25 0 0 1-.375.745 1.72 1.72 0 0 1-.601.491 1.74 1.74 0 0 1-.774.171 1.86 1.86 0 0 1-.49-.062c-.151-.042-.28-.096-.387-.162s-.199-.14-.276-.212-.173-.18-.296-.325v.112c0 .214-.051.376-.152.487s-.23.162-.387.162a.49.49 0 0 1-.383-.162c-.096-.108-.14-.274-.14-.487V4.7c0-.23.045-.404.136-.521S22.657 4 22.821 4c.173 0 .306.057.399.171s.14.271.14.479zm.053 3.377c0 .453.102.801.305 1.045s.475.362.806.362c.283 0 .525-.124.728-.371s.309-.607.309-1.07a2.1 2.1 0 0 0-.128-.775 1.11 1.11 0 0 0-.362-.5c-.156-.119-.339-.179-.547-.179a.96.96 0 0 0-.572.179 1.16 1.16 0 0 0-.395.512c-.096.225-.144.487-.144.795zm7.064 1.645v-.146c-.134.172-.276.317-.424.433a1.52 1.52 0 0 1-.486.258c-.176.058-.376.087-.601.087a1.55 1.55 0 0 1-.732-.171 1.24 1.24 0 0 1-.498-.471c-.14-.242-.21-.589-.21-1.041V6.37c0-.228.051-.397.152-.508s.236-.171.403-.171a.53.53 0 0 1 .411.171c.104.114.156.283.156.508v1.82c0 .264.022.486.066.666s.122.318.235.421.27.15.465.15c.189 0 .368-.057.535-.171s.289-.262.366-.446c.063-.161.095-.514.095-1.058V6.37c0-.225.052-.394.156-.508s.24-.171.407-.171.302.057.403.171.152.28.152.508v3.294c0 .217-.049.379-.148.487a.48.48 0 0 1-.375.162c-.154 0-.281-.056-.383-.167s-.148-.272-.148-.475zm3.006.641c-.17 0-.317-.056-.44-.167s-.185-.267-.185-.466c0-.169.059-.315.177-.437a.58.58 0 0 1 .436-.183c.173 0 .32.061.44.183a.6.6 0 0 1 .185.437c0 .197-.062.353-.185.466a.61.61 0 0 1-.428.167zm3.096-1.64v.95c0 .23-.053.404-.16.521s-.243.171-.407.171a.51.51 0 0 1-.399-.175c-.104-.117-.156-.289-.156-.516V6.457c0-.511.182-.766.547-.766.187 0 .321.06.403.179s.128.296.136.529c.134-.233.272-.41.411-.529s.332-.179.568-.179.465.06.687.179.333.278.333.475a.46.46 0 0 1-.144.346c-.096.092-.195.133-.304.133-.041 0-.141-.025-.3-.075a1.32 1.32 0 0 0-.416-.079.6.6 0 0 0-.403.133c-.104.086-.185.215-.243.387a2.75 2.75 0 0 0-.119.616c-.022.236-.033.525-.033.866zm5.368.999v-.146c-.134.172-.276.317-.424.433a1.52 1.52 0 0 1-.486.258c-.176.058-.376.087-.601.087a1.55 1.55 0 0 1-.732-.171 1.24 1.24 0 0 1-.498-.471c-.14-.242-.21-.589-.21-1.041V6.37c0-.228.051-.397.152-.508s.236-.171.403-.171a.53.53 0 0 1 .411.171c.104.114.156.283.156.508v1.82c0 .264.022.486.066.666s.122.318.235.421.27.15.465.15c.189 0 .368-.057.535-.171s.289-.262.366-.446c.063-.161.095-.514.095-1.058V6.37c0-.225.052-.394.156-.508s.24-.171.407-.171.302.057.403.171.152.28.152.508v3.294c0 .217-.049.379-.148.487a.48.48 0 0 1-.374.162.5.5 0 0 1-.383-.167c-.102-.111-.148-.272-.148-.475z" fill="#212121"/></svg>'),h._watermark=t}_handleContextMenu(){this._fakeImage||(this._createFakeImage(!1),setTimeout((()=>{var t;this._listener=t=>this._removeFakeImage(t),null===(t=document.activeElement)||void 0===t||t.addEventListener("blur",this._listener)})))}_handleMouseEnter(){this._fakeImage||this._createFakeImage(!0)}_createFakeImage(t){if(!h._watermark||!this._originalImage)return;const e=document.createElement("canvas");e.width=this._originalImage.naturalWidth,e.height=this._originalImage.naturalHeight;const s=e.getContext("2d");if(!s)return;const n=Math.round(3),r=n*Math.ceil(48*Math.max(0,e.width-700)/(700*n)),l=48+r,c=16+Math.round(r/n),d=Math.ceil(c/2);s.drawImage(this._originalImage,0,0),s.drawImage(h._watermark,e.width-l-d,e.height-c-d,l,c);const u=new Image;u.crossOrigin="anonymous",u.alt=String(this._originalImage.src.split("/").pop());for(const i in this._originalImage.dataset)"viewable"!==i&&(u.dataset[i]=this._originalImage.dataset[i]);u.dataset.watermarked="1";const p=()=>{u.style.position="absolute",u.style.zIndex="3",u.style.opacity="0",u.style.left=this._originalImage.style.left?this._originalImage.style.left:"0px",u.style.top=this._originalImage.style.top?this._originalImage.style.top:"0px",u.style.transition="none",u.style.visibility="visible",u.style.transform=this._originalImage.style.transform,u.width=this._originalImage.offsetWidth,u.height=this._originalImage.offsetHeight};p();let m=["click"];this._options.forwardEvents&&(m=[...m,"mousedown","mousewheel"],i.vE.isMobileApp&&(m=[...m,o.Kg.POINTER_DOWN,o.Kg.POINTER_MOVE,...o.Kg.POINTER_UP])),m.forEach((t=>{u.addEventListener(t,(t=>{var e;t.stopPropagation(),t.preventDefault();const s=new t.constructor(t.type,t);null===(e=this._originalImage)||void 0===e||e.dispatchEvent(s)}))})),this._styleObserver=new MutationObserver((e=>{e.forEach((e=>{"src"===e.attributeName&&this._fakeImage&&(this._removeFakeImage(),this._originalImage.addEventListener("load",(()=>this._createFakeImage(t)),{once:!0})),"style"===e.attributeName&&p()}))})),this._styleObserver.observe(this._originalImage,{attributeFilter:["style","src"]});const _=()=>{this._originalImage&&(this._originalImage.style.zIndex="2",this._originalImage.insertAdjacentElement("afterend",u),this._fakeImage=u)};t?e.toBlob((t=>{if(!t)return;const e=new File([t],u.alt.replace(/\.[\da-z]+$/,".jpg"),{type:a});u.src=this._objectURL=URL.createObjectURL(e),_()}),a,.95):(u.src=e.toDataURL(a,.95),_())}_removeFakeImage(t){var e;(this._fakeImage&&(this._fakeImage.remove(),this._fakeImage=void 0,this._originalImage&&(this._originalImage.style.zIndex="")),this._listener&&t)&&(null===(e=t.target)||void 0===e||e.removeEventListener("blur",this._listener),this._listener=void 0);this._objectURL&&URL.revokeObjectURL(this._objectURL),this._styleObserver&&(this._styleObserver.disconnect(),this._styleObserver=void 0)}}},6572:(t,e,s)=>{"use strict";s.d(e,{eR:()=>v.e,mM:()=>_.m,hG:()=>f.h,eU:()=>i,YV:()=>h,sh:()=>m,xg:()=>g.x,cQ:()=>n.c});const i=new(s(7892).xs)({INVALID:0,WEEK:1,GOOD:2,STRONG:3});var n=s(5983);s(4916);const o=/\d.*?\d.*?\d/,r=/[!@#$%^&*?_~].*?[!@#$%^&*?_~]/,a=/([a-z].*[A-Z])|([A-Z].*[a-z])/,l=/[!@#$%^&*?_~]/;class h{static test(t,e){let s=0;return this.status=i.INVALID,s=t.length<6?-100:4*t.length,t.match(o)&&(s+=5),t.match(r)&&(s+=5),t.match(a)&&(s+=10),t.match(/[a-z]/i)&&t.match(/[0-9]/)&&(s+=15),t.match(/[0-9]/)&&t.match(l)&&(s+=15),t.match(/[a-z]/i)&&t.match(l)&&(s+=15),t.match(/^[a-z]+$/i)&&(s+=-15),t.match(/^\d+$/i)&&(s+=-15),t===e?s+=-100:-1!==t.indexOf(e)&&(s+=-15),s+=-15*h.sequences(t),s+=-15*h.sequences(h.reversed(t)),s+=-4*h.repetitions(t,2),s+=-3*h.repetitions(t,3),s+=-2*h.repetitions(t,4),s<0&&(s=0),s>100&&(s=100),s<15&&(this.status=i.WEEK),s>=15&&s<60&&(this.status=i.GOOD),s>=60&&(this.status=i.STRONG),this.status}static sequences(t){let e,s,i=0,n=0,o=[],r=t.length;for(let a=0;a<r;a++)s=t.charCodeAt(a),e=o[o.length-1],o.push(s),e&&(s===e+1||e===s?n+=1:n=0),2===n&&(i+=1);return i}static repetitions(t,e){let s,i,n,o=0,r={},a=t.length;for(let l=0;l<a;l++)if(s=t.substr(l,e),i=0,n=t,!(r[s]||s.length<e)){for(r[s]=!0;-1!==(l=n.indexOf(s));)i+=1,n=n.substr(l+1);i>1&&(o+=1)}return o}static reversed(t){let e="";for(let s=t.length-1;s>=0;s--)e+=t.charAt(s);return e}}s(5306);var c=s(6777);let d;const u=s(9755),p=/^https?:\/\//;class m{static get instance(){return d||(d=new c.vp,u(window).on("message",(t=>{let e=t.originalEvent;d.emit((e.origin||"").replace(p,""),e)})),d)}static send(t,e,s){e&&(t="string"==typeof t?t:u.param(t),(s=s||window.parent).postMessage(t,e.replace(/([^:]+:\/\/[^\/]+).*/,"$1")))}}var _=s(7111),g=s(9377),v=s(9922),f=s(6889)},7800:(t,e,s)=>{"use strict";s.d(e,{m:()=>i.m});var i=s(7111)},5494:(t,e,s)=>{"use strict";s.d(e,{$:()=>i});s(8674);class i{static request(t){return t?requestAnimationFrame(t):new Promise((t=>requestAnimationFrame(t)))}static requestThrottle(t){let e=!1;return function(){e||(e=!0,requestAnimationFrame((()=>{e=!1,t.apply(this,arguments)})))}}static cancel(t){cancelAnimationFrame(t)}}},7215:(t,e,s)=>{"use strict";s.d(e,{Ni:()=>i,tG:()=>n,Kg:()=>o,RI:()=>r});s(4916);const i=(()=>{if("ontouchstart"in window||window.DocumentTouch&&document instanceof DocumentTouch)return!0;const t=["webkit","moz","o","ms"].map((t=>`(-${t}-touch-enabled)`));t.unshift("(touch-enabled)");const e=t.join(",");return s=e,window.matchMedia(s).matches;var s})(),n="PointerEvent"in window,o={POINTER_DOWN:n?"pointerdown":"touchstart",POINTER_MOVE:n?"pointermove":"touchmove",POINTER_UP:(n?"pointerup pointercancel":"touchend").split(" ")},r=t=>({clientX:t.clientX,clientY:t.clientY,type:t.pointerType||"touch"})},5983:(t,e,s)=>{"use strict";s.d(e,{c:()=>_});s(4916),s(5306),s(8674),s(6992),s(3948),s(2707),s(5827),s(1817);var n=s(9537),o=s(9698),r=s(8211);function a(t,e){if(null==t)return{};var s,i,n=function(t,e){if(null==t)return{};var s,i,n={},o=Object.keys(t);for(i=0;i<o.length;i++)s=o[i],e.indexOf(s)>=0||(n[s]=t[s]);return n}(t,e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(t);for(i=0;i<o.length;i++)s=o[i],e.indexOf(s)>=0||Object.prototype.propertyIsEnumerable.call(t,s)&&(n[s]=t[s])}return n}function l(t){var e=function(t,e){if("object"!=typeof t||null===t)return t;var s=t[Symbol.toPrimitive];if(void 0!==s){var i=s.call(t,e||"default");if("object"!=typeof i)return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(t)}(t,"string");return"symbol"==typeof e?e:String(e)}const h=s(6419),c=s(381),d=s(5470),u=/%(\d+)/g,p=[2,0,1,1,1,2],m=["Бит","КБ","МБ","ГБ","ТБ","ПБ","ЭБ","ЗБ","ИБ"];class _{static getTextContent(t){let e=document.createElement("div");return e.innerHTML=String(t).replace(/<p>/g,"<p>\n").replace(/<br>/g,"<br> "),e.textContent}static formatBytes(t,e=2,s=!0){let i=s?1e3:1024;if("number"!=typeof t&&(t=1024*i*10),0===t)return"0 "+m[0];let n=Math.floor(Math.log(t)/Math.log(i));return parseFloat((t/Math.pow(i,n)).toFixed(e))+" "+m[n]}static formatUsernamesList(t){let e=t.length>2?", ":" и ",s=o.o.escape();return t.map((t=>`<strong>${s(t)}</strong>`)).join(e)}static safeDecodeURIComponent(t){return n._.decode(t)}static random(t,e,s=!0){"boolean"!=typeof e&&Number.isFinite(e)||(s=e,e=t,t=0);let i=Number.isFinite(t)?t:0,n=Number.isFinite(e)?e:1,o=Math.random()*(n-i);return!0===s&&(i=Math.ceil(i),n=Math.floor(n)),i+(!0===s?Math.floor(o):o)}static randomOption(t){return t[this.random(0,t.length)]}static randomArray(t,e){return h.shuffle(t).slice(0,e)}static delay(t,e){return t<0?e:new Promise((s=>{setTimeout(s,t,e)}))}static equalNumbers(t,e,s=0){return t===e||t-s<=e&&t+s>=e}static pluralNounRU(t,e){return t=Math.abs(parseInt(t,10)),!h.isArray(e)||e.length,e[t%100>4&&t%100<20?2:p[t%10<5?t%10:5]]}static preparePhone(t){if(!t.length)return t;let e=Number(t.charAt(0));return 11!==t.length||7!==e&&8!==e||(t="+7"+t.slice(1)),10===t.length&&"+"!==t.charAt(0)&&(t="+7"+t),"+"!==t.charAt(0)&&(t="+"+t),t}static maskPhone(t){if(!h.isString(t)||!t.length)return"";let e=t.length,s=e>12?3:2,i=e-2-s;return t.slice(0,s)+"*".repeat(i)+t.slice(-2)}static maskEmail(t){if(!h.isString(t)||!t.length)return"";let e=t.lastIndexOf("@"),s=Math.round(e/3);return e<0?t:(1===e?"*":t.slice(0,s)+"*".repeat(e-s))+t.slice(e)}static reduceNumber(t,e,s=""){return t>1e3?(t>1e5?Math.floor(t/1e3):(t/1e3).toFixed())+"K "+s:`${t}${e?" "+r.vE.i18n(e,t):""}`}static pluralAdjectiveRU(t,e){return e[(t=Math.abs(parseInt(t,10)))%10==1&&t%100!=11?0:1]}static format(t,...e){return t.replace(u,(function(t,s){return void 0!==e[s]?`${e[s]}`:t}))}static urlToLocation(t){let e=document.createElement("a");return e.href=t,e}static getQueryParams(t){let e={};return t.replace(/^\?/g,"").replace(/\+/g," ").split("&").forEach((t=>{t=n._.decode(t);let[s,i]=t.split("=");return s&&(e[s]=i||!0),!0})),e}static toEven(t){return t?2*Math.floor(Math.ceil(t)/2):t}static calculateAspectRatioFit(t,e,s,i,n){let o=Math.min(1,s/t,i/e);return[(n=!!h.isUndefined(n)||n)?_.toEven(t*o):t*o,n?_.toEven(e*o):e*o]}static getDimension(t,e,s,i,n="contain",o=!1,r=!0){let a,l,h="contain"===n;if("cover"===n||h){let n=s/t,o=i/e,r=h?Math.min(n,o):Math.max(n,o);a=t*r,l=e*r}return[a,l].map((t=>(r&&(t=_.toEven(t)),o&&(t=Math.round(t)),t)))}static isOverflowed(t){const e=t.offsetHeight<t.scrollHeight,s=t.offsetWidth<t.scrollWidth;return e||s}static watchHeightStable(t,e=300,s=1e4,i=10){return new Promise((n=>{const o=[],r=setInterval((()=>{const e=t.height();if(h.isNumber(e)&&(o.push(e),!(o.length<15)&&(o.shift(),e>0))){const t=o.sort(((t,e)=>Number(t)-Number(e)));Math.abs(t[0]-t[t.length-1])<i&&(clearInterval(r),n(!0))}}),e);setTimeout((()=>{clearInterval(r),n(!1)}),s)}))}static isSymbol(t){return!!t&&("symbol"==typeof t||!!t.constructor&&("Symbol"===t.constructor.name&&"Symbol"===t[t.constructor.toStringTag]))}static closestNumber(t,e){let s=null,n=null,o=e[0];for(i=0;i<e.length;i++)s=Math.abs(t-o),n=Math.abs(t-e[i]),n<s&&(o=e[i]);return o}static escapeStringRegExp(t){return t.replace(/[\-\[\]\/{}()*+?.\\^$|]/g,"\\$&")}static copyToClipboard(t){if(!t.length)return;const e=()=>{const e=document.createElement("textarea");if(e.value=t,e.setAttribute("readonly",""),e.style.position="absolute",e.style.left="-9999px",document.body.appendChild(e),d.ios&&parseInt(d.osversion,10)<13){const t=document.createRange();t.selectNodeContents(e);const s=window.getSelection();s.removeAllRanges(),s.addRange(t),e.setSelectionRange(0,999999)}else e.select();document.execCommand("copy"),document.body.removeChild(e)};"clipboard"in navigator?navigator.clipboard.writeText(t).catch(e):e()}static timestampToDaysUntil(t,e="D MMMM, H:mm"){let s={};if(t){let i=c.unix(t);s.dateEnds=i.format(e),s.daysUntil=Math.ceil(i.diff(c(),"days",!0))}return s}static getCurrentTimestamp(){return Math.round((new Date).getTime()/1e3)}static allSettled(t){return Promise.all(t.map((t=>{t.then&&t.then((t=>({status:"fulfilled",value:t}))).catch((t=>({status:"rejected",reason:t})))})))}static preloadImage(t){return"string"!=typeof t?Promise.reject(new Error("problem with loading image, not found url")):new Promise(((e,s)=>{const i=new Image;i.src=t,i.onload=e,i.onerror=()=>s(new Error(`problem with loading image '${t}'`))}))}static preloadImageSet(t){return new Promise(((e,s)=>{const i=t.join(","),n=new Image;n.crossOrigin="anonymous",n.srcset=i,n.onload=e,n.onerror=()=>s(new Error(`problem with loading image-set '${i}'`))}))}static pick(t,...e){return Object.assign({},...e.map((e=>({[e]:t[e]}))))}static omit(t,...e){return e.reduce(((t,e)=>{const{[e]:s}=t;return a(t,[e].map(l))}),t)}static download(t,e,s="text/plain"){const i=document.createElement("a");i.setAttribute("href",`data:${s};charset=utf-8,`+encodeURIComponent(e)),i.setAttribute("download",t),i.style.display="none",document.body.appendChild(i),i.click(),document.body.removeChild(i)}static getStoryIdFromUrl(){const t=r.vE.history.pathname.match(/^\/story\/\w*_(\d+)/);return t?parseInt(t[1],10):void 0}static escapeRegExp(t){return t.replace(/[.*+?^${}()|[\]\\\/]/g,"\\$&")}static isInput(t){if(!t||!t.tagName)return!1;const e=t.tagName.toLowerCase();return"textarea"===e||"input"===e||"select"===e||t.isContentEditable}}},425:(t,e,s)=>{"use strict";s.d(e,{c:()=>o});s(4916),s(4603),s(6992),s(3948);const i=/^([\w\!\#$\%\&\'\*\+\-\/\=\?\^\`{\|\}\~]+\.)*[\w\!\#$\%\&\'\*\+\-\/\=\?\^\`{\|\}\~]+@((((([a-z0-9]{1}[a-z0-9\-]{0,62}[a-z0-9]{1})|[a-z])\.)+[a-z]{2,6})|(\d{1,3}\.){3}\d{1,3}(\:\d{1,5})?)$/i,n=["текст","длиннопост","видео","гифка","coub","мат","ответ на пост"];class o{static required(){return t=>Boolean(t)}static min(t,e=!1){return s=>!s.length&&e||Number(s)>=Number(t)}static max(t,e=!1){return s=>!s.length&&e||Number(s)<=Number(t)}static filterBuiltInTags(){return t=>-1===n.indexOf(t.toLowerCase())}static minTags(t){return e=>String(e).split(",").filter(o.filterBuiltInTags()).length>=t}static maxTags(t){return e=>String(e).split(",").filter(o.filterBuiltInTags()).length<=t}static matches(t,e,s){return t instanceof RegExp||(t=new RegExp(t,s)),s=>e?!t.test(s):t.test(s)}static email(t){return o.patternMatch(i,!t)}static patternMatch(t,e){if(!(t instanceof RegExp))throw new Error("pattern for Validation.patternMatch to be RegExp, but "+typeof t);return s=>!s.length&&e||t.test(s)}static patternMismatch(t,e){if(!(t instanceof RegExp))throw new Error("pattern for Validation.patternMatch to be RegExp, but "+typeof t);return s=>!s.length&&e||!t.test(s)}static isLength(t,e){return(s,i)=>(i||s).length>=t&&(!e||s.length<=e)}static isNotContainLink(){return(t,e)=>{const s=(e||t).match(/(https?|ftp):\/\/|([a-z0-9\-]{2,})\.([a-z]{2,4})/gi);return!s||s.length<2}}static keywordAsterisk(){return t=>{let e=t.match(/\*/g)||[];return!e.length||1===e.length&&"*"===t.slice(-1)}}static not(t){return(...e)=>!t(...e)}}},5358:(t,e,s)=>{"use strict";s.d(e,{zM:()=>S,wK:()=>b,nq:()=>T,vu:()=>l});s(6992),s(3948),s(5827);var i=s(7892);const n=new i.xs({SET_ATTRIBUTE:0,REMOVE_ATTRIBUTE:1,INSERT_CHILD:2,REMOVE_CHILD:3,UPDATE_CHILD:4,UPDATE_CHILDREN:5,INSERT_BEFORE:6,REPLACE_NODE:7,REMOVE_NODE:8,SAME_NODE:9,UPDATE_THUNK:10,UPDATE_UI_ELEMENT:11}),o=new i.xs({EMPTY:1,TEXT:2,NATIVE:3,UI_ELEMENT:4,THUNK:5}),r=s(6419);const a=s(6419);class l{static create(t,e,...s){if(!t)throw new TypeError("element() needs a type.");e=e||{},s=a.reduce(s||[],l.reduceChildren,[]);let i=a.isString(e.key)||a.isNumber(e.key)?e.key:null;if(delete e.key,a.isString(e.className)&&(e.class=e.className,delete e.className),"object"==typeof t)return l.createThunkElement(t.render,i,e,s,t);if("function"==typeof t&&"isUIElement"in t){let{props:n,events:o}=class{static plainProps(t){let e={props:t,events:{}};if(r.isObject(t)&&t.uiOptions){let s=t.uiOptions;delete t.uiOptions,r.forEach(s,((t,s)=>{e.props[s]=t}))}return r.forEach(t,((t,s)=>{let i=s.charAt(2);i&&0===s.indexOf("on")&&i===i.toUpperCase()&&(e.events[i.toLowerCase()+s.slice(3)]=t)})),r.isObject(t.events)&&(e.events=r.extend(e.events,t.events)),e}}.plainProps(e);return l.createUIElement(t,i,n,o,s,t)}return"function"==typeof t?l.createThunkElement(t,i,e,s,t):{type:o.NATIVE,tagName:t,attributes:e,children:s,key:i}}static reduceChildren(t,e){if(a.isString(e)||a.isNumber(e))t.push(l.createTextElement(e));else if(null===e||!1===e)t.push(l.createEmptyElement());else if(Array.isArray(e))t=[...t,...e.reduce(l.reduceChildren,[])];else{if(a.isUndefined(e))throw new Error("vnode can't be undefined. Did you mean to use null?");t.push(e)}return t}static createTextElement(t){return{type:o.TEXT,nodeValue:t}}static createEmptyElement(){return{type:o.EMPTY}}static createUIElement(t,e,s,i,n,r){return{type:o.UI_ELEMENT,Fn:t,children:n,props:s,events:i,options:r,key:e}}static createThunkElement(t,e,s,i,n){return{type:o.THUNK,fn:t,children:i,props:s,options:n,key:e}}static isThunk(t){return t.type===o.THUNK}static isUIElement(t){return t.type===o.UI_ELEMENT}static isSameUIElement(t,e){return l.isUIElement(t)&&l.isUIElement(e)&&t.Fn===e.Fn}static isText(t){return t.type===o.TEXT}static isEmpty(t){return t.type===o.EMPTY}static isNative(t){return t.type===o.NATIVE}static isSameThunk(t,e){return l.isThunk(t)&&l.isThunk(e)&&t.fn===e.fn}static groupByKey(t){return a.reduce(t,((t,e,s)=>{if(!a.isUndefined(e)&&!1!==e){let i=a.isNull(e)?"_"+s:e.key||"_"+s;t.push({key:String(i),item:e,index:s})}return t}),[])}static createPath(...t){return t.join(".")}}const h={onAbort:"abort",onAnimationStart:"animationstart",onAnimationIteration:"animationiteration",onAnimationEnd:"animationend",onBlur:"blur",onCanPlay:"canplay",onCanPlayThrough:"canplaythrough",onChange:"change",onClick:"click",onContextMenu:"contextmenu",onCopy:"copy",onCut:"cut",onDoubleClick:"dblclick",onDrag:"drag",onDragEnd:"dragend",onDragEnter:"dragenter",onDragExit:"dragexit",onDragLeave:"dragleave",onDragOver:"dragover",onDragStart:"dragstart",onDrop:"drop",onDurationChange:"durationchange",onEmptied:"emptied",onEncrypted:"encrypted",onEnded:"ended",onError:"error",onFocus:"focus",onInput:"input",onInvalid:"invalid",onKeyDown:"keydown",onKeyPress:"keypress",onKeyUp:"keyup",onLoad:"load",onLoadedData:"loadeddata",onLoadedMetadata:"loadedmetadata",onLoadStart:"loadstart",onPause:"pause",onPlay:"play",onPlaying:"playing",onProgress:"progress",onMouseDown:"mousedown",onMouseEnter:"mouseenter",onMouseLeave:"mouseleave",onMouseMove:"mousemove",onMouseOut:"mouseout",onMouseOver:"mouseover",onMouseUp:"mouseup",onPaste:"paste",onRateChange:"ratechange",onReset:"reset",onScroll:"scroll",onSeeked:"seeked",onSeeking:"seeking",onSubmit:"submit",onStalled:"stalled",onSuspend:"suspend",onTimeUpdate:"timeupdate",onTransitionEnd:"transitionend",onTouchCancel:"touchcancel",onTouchEnd:"touchend",onTouchMove:"touchmove",onTouchStart:"touchstart",onVolumeChange:"volumechange",onWaiting:"waiting",onWheel:"wheel"},c="http://www.w3.org/2000/svg",d="http://www.w3.org/1999/xlink",u=["animate","circle","clipPath","defs","ellipse","g","line","linearGradient","mask","path","pattern","polygon","polyline","radialGradient","rect","stop","svg","text","tspan","use"],p={xlinkHref:"xlink:href"},m=["cx","cy","d","dx","dy","fill","fillOpacity","fontFamily","fontSize","fx","fy","gradientTransform","gradientUnits","markerEnd","markerMid","markerStart","offset","opacity","patternContentUnits","patternUnits","points","preserveAspectRatio","r","rx","ry","spreadMethod","stopColor","stopOpacity","stroke","strokeDasharray","strokeLinecap","strokeOpacity","strokeWidth","textAnchor","transform","version","viewBox","x1","x2","x","y1","y2","y","xlink:href"],_=["text","search","tel","url","password"],g=s(6419);class v{static removeAttribute(t,e,s){let i=h[e];if(i&&g.isFunction(s))t.removeEventListener(i,s);else switch(e){case"checked":case"disabled":case"selected":t[e]=!1;break;case"innerHTML":case"nodeValue":case"value":t[e]="";break;default:t.removeAttribute(e)}}static setAttribute(t,e,s,i){let n=h[e];if(s!==i){if(n)return g.isFunction(i)&&t.removeEventListener(n,i),void t.addEventListener(n,s);if(v.isValidAttribute(s))switch(e){case"checked":case"disabled":case"innerHTML":case"nodeValue":t[e]=s;break;case"selected":if(t.selected=s,"OPTION"===t.tagName&&t.parentNode){let e=t.parentNode;e.selectedIndex=g.indexOf(e.options,t)}break;case"value":v.setValue(t,s);break;default:v.setNativeAttribute(t,e,s)}else v.removeAttribute(t,e,i)}}static naturalSelection(t){return Boolean(t.setSelectionRange&&_.includes(t.type))}static setValue(t,e){if(v.naturalSelection(t)&&t===document.activeElement){let s=t.selectionStart,i=t.selectionEnd;t.value=e,t.setSelectionRange(s,i)}else t.value=e}static setNativeAttribute(t,e,s){p.hasOwnProperty(e)&&(e=p[e]),m.includes(e)?t.setAttributeNS("xlink:href"===e?d:"SVG",e,s):t.setAttribute(e,s)}static isValidAttribute(t){switch(typeof t){case"string":case"number":return!0;case"boolean":return t;default:return!1}}static createNativeElement(t){return u.includes(t)?document.createElementNS(c,t):document.createElement(t)}}const f=s(6419);let y={};class b{static createElement(t,e,s,i){switch(t.type){case o.TEXT:return b.createTextNode(t);case o.EMPTY:return document.createComment("VPik "+e);case o.UI_ELEMENT:return b.createUI(t,e,s,i);case o.THUNK:return b.createThunk(t,e,s,i);case o.NATIVE:return b.createHTMLElement(t,e,s,i)}}static getCachedElement(t){let e=y[t];return f.isUndefined(e)&&(e=y[t]=v.createNativeElement(t)),e.cloneNode(!1)}static createTextNode(t){return document.createTextNode(f.isString(t.nodeValue)||f.isNumber(t.nodeValue)?t.nodeValue:"")}static createUI(t,e,s,i){if(f.isNull(t.key))throw new Error("need key for UIElement");let n;return i.ui&&i.ui instanceof Map||(i.ui=new Map),i.ui.has(t.key)?(n=i.ui.get(t.key),n.setOptions(t.props)):(n=new t.Fn(f.extend({},t.props)),i.ui.set(t.key,n),t.events&&f.forEach(t.events,((t,e)=>{i.listenTo(n,e,t)}))),t.state={ui:n},n.render().el}static createThunk(t,e,s,i){let{props:n,children:o}=t,{onCreate:r}=t.options,a={children:o,props:n,path:e,dispatch:s,context:i},h=t.fn(a),c=l.createPath(e,h.key||"0"),d=b.createElement(h,c,s,i);return r&&s(r(a)),t.state={vnode:h,model:a},d}static createHTMLElement(t,e,s,i){let{tagName:n,attributes:o,children:r}=t,a=b.getCachedElement(n);for(let l in o)v.setAttribute(a,l,o[l]);return r.forEach(((t,n)=>{if(f.isNull(t)||f.isUndefined(t))return;let o=l.createPath(e,t.key||"_"+n),r=b.createElement(t,o,s,i);a.appendChild(r)})),a}}var w=s(7050);const E=s(6419);class S{static node(t,e,s){if(E.isUndefined(t))throw new Error("Left node must not be null or undefined");if(t===e)return[[n.SAME_NODE]];if(!E.isUndefined(t)&&E.isUndefined(e))return[[n.REMOVE_NODE,t]];if(!E.isNull(t)&&E.isNull(e)||E.isNull(t)&&!E.isNull(e))return[[n.REPLACE_NODE,t,e,s]];if(t.type!==e.type)return[[n.REPLACE_NODE,t,e,s]];if(l.isNative(e)){if(t.tagName!==e.tagName)return[[n.REPLACE_NODE,t,e,s]];let i=S.attributes(t,e),o=S.children(t,e,s);return o.length&&i.push(o),i}if(l.isText(e)){let s=[];return t.nodeValue!==e.nodeValue&&s.push([n.SET_ATTRIBUTE,"nodeValue",e.nodeValue,t.nodeValue]),s}if(l.isUIElement(e)){let i=[];return l.isSameUIElement(t,e)?i.push([n.UPDATE_UI_ELEMENT,t,e,s]):i.push([n.REPLACE_NODE,t,e,s]),i}if(l.isThunk(e)){let i=[];return l.isSameThunk(t,e)?t.options&&t.options.notUpdate||i.push([n.UPDATE_THUNK,t,e,s]):i.push([n.REPLACE_NODE,t,e,s]),i}return l.isEmpty(e),[]}static children(t,e,s){let{CREATE:i,UPDATE:o,MOVE:r,REMOVE:a}=w,h=l.groupByKey(t.children),c=l.groupByKey(e.children),d=[];return(0,w.default)(h,c,((t,e,h,c)=>{let u=h?l.createPath(s,null===h.key?h.index:h.key):null;switch(t){case i:d.push([n.INSERT_CHILD,h.item,c,u]);break;case o:{let t=S.node(e.item,h.item,u);t.length>0&&d.push([n.UPDATE_CHILD,e.index,t]);break}case r:{let t=S.node(e.item,h.item,u);t.push([n.INSERT_BEFORE,c]),d.push([n.UPDATE_CHILD,e.index,t]);break}case a:d.push([n.REMOVE_CHILD,e.index])}}),(t=>t.key)),d.length?[n.UPDATE_CHILDREN,d]:d}static attributes(t,e){let s=[],i=t.attributes,o=e.attributes;for(let r in o)o[r]!==i[r]&&s.push([n.SET_ATTRIBUTE,r,o[r],i[r]]);for(let r in i)r in o||s.push([n.REMOVE_ATTRIBUTE,r,i[r]]);return s}static props(t,e){let s={},i=t.props,n=e.props;for(let o in n)n[o]!==i[o]&&(s[o]=n[o]);for(let o in i)o in n||(s[o]=void 0);return s}}s(8211);const C=s(6419);class T{static updateElement(t,e){return(s,i)=>{let o=i.slice(1);switch(i=i[0]){case n.SAME_NODE:return noop();case n.SET_ATTRIBUTE:v.setAttribute(s,...o);break;case n.REMOVE_ATTRIBUTE:v.removeAttribute(s,...o);break;case n.INSERT_BEFORE:T.insertAtIndex(s.parentNode,...o,s);break;case n.UPDATE_CHILDREN:T.updateChildren(s,...o,t,e);break;case n.UPDATE_THUNK:break;case n.UPDATE_UI_ELEMENT:s=T.updateUIElement(s,...o,t,e);break;case n.REPLACE_NODE:{const[i,n,r]=o;let a,l=s.parentNode;a=b.createElement(n,r,t,e),T.removeUIElement(i,n,t),l&&l.replaceChild(a,s),s=a,T.removeThunks(i,t);break}case n.REMOVE_NODE:T.removeUIElement(...o),T.removeThunks(...o),s.parentNode.removeChild(s),s=null}return s}}static updateChildren(t,e,s,i){let o=C.toArray(t.childNodes);e.forEach((e=>{let r=e[0],a=e.slice(1);switch(r){case n.INSERT_CHILD:{const[e,n,o]=a;T.insertAtIndex(t,n,b.createElement(e,o,s,i));break}case n.REMOVE_CHILD:{const[e]=a;t.removeChild(o[e]);break}case n.UPDATE_CHILD:{const[t,e]=a;let n=T.updateElement(s,i);e.forEach((e=>n(o[t],e)));break}}}))}static updateUIElement(t,e,s,i,n,o){let r=S.props(e,s);return e.state.ui.setOptions(r),s.state=e.state,t}static updateThunk(t,e,s,i,n,o){let{props:r,children:a}=s,{onUpdate:h}=s.options,c=e.state.vnode,d={children:a,props:r,path:i,dispatch:n,context:o},u=s.fn(d),p=S.node(c,u,l.createPath(i,"0"));return t=C.reduce(p,T.updateElement(n,o),t),h&&n(h(d)),s.state={vnode:u,model:d},t}static removeUIElement(t,e){l.isUIElement(t)&&(t.state.ui.unmount(),delete t.state.ui)}static removeThunks(t,e){for(;l.isThunk(t);){let s=t.options.onRemove,{model:i}=t.state;s&&e(s(i)),t=t.state.vnode}t.children&&C.forEach(t.children,(t=>T.removeThunks(t,e)))}static insertAtIndex(t,e,s){let i=t.childNodes[e];i?t.insertBefore(s,i):t.appendChild(s)}}},1437:(t,e,s)=>{"use strict";s.d(e,{t:()=>o});s(4916),s(6992),s(3948);var i=s(5358);const n=s(6419);let o={render:({props:t})=>{let e="icon--"+t.block,s=e,o=n.isString(t.modifiers)?t.modifiers.split(" "):t.modifiers||[];return 1===o.length&&n.isArray(o[0])&&(o=o[0]),o.length&&(o=o.map((t=>(s=s+"_"+t,e+"_"+t)))),o=n.compact([e,...o,o.length>1?s:""]).join(" "),i.vu.create("svg",{xmlns:"http://www.w3.org/2000/svg",className:"icon "+o},i.vu.create("use",{xlinkHref:"#"+e}))},notUpdate:!0}},8375:(t,e,s)=>{"use strict";s.d(e,{t:()=>o.t,N:()=>n});var i=s(5358);let n={render:({props:t})=>i.vu.create("a",{href:"/@"+t.name,className:"user user_inline"},i.vu.create("span",{className:"avatar avatar_small"},t.avatar?i.vu.create("img",{src:t.avatar}):i.vu.create("span",{className:"avatar__default"})),!0!==t.short&&i.vu.create("span",{className:"user__nick"},t.name)),notUpdate:!0};var o=s(1437)},5763:(t,e,s)=>{"use strict";s(6992),s(8674),s(3948);var i=s(8211),n=s(4519),o=s(6815),r=s(8799),a=s(9569);function l(t){var e,s="";Array.prototype.join;return s+='<div class="theme-picker__popup">\n\t<form>\n\t\t<div class="theme-picker__buttons">\n\t\t\t',t.themes.forEach((function(i){s+='\n\t\t\t<div class="theme-picker__button'+(null==(e=i===t.currentTheme?" theme-picker__button_current":"")?"":e)+'" data-type="'+(null==(e=i.valueOf())?"":e)+'"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon--ui__check-mark"><use xlink:href="#icon--ui__check-mark"></use></svg></div>\n\t\t\t'})),s+='\n\t\t</div>\n\t\t<div class="theme-picker__dark">\n\t\t\t<label><h4>Ночная тема</h4><input class="checkbox_switch" name="dark" type="checkbox" '+(null==(e=t.dark?"checked":"")?"":e)+' value="true"></label>\n\t\t</div>\n\t\t<div class="theme-picker__settings'+(null==(e=t.dark?" theme-picker__settings_visible":"")?"":e)+'">\n\t\t\t<div class="theme-picker__schedule"><label><input name="schedule" type="checkbox" value="true" '+(null==(e=t.schedule?"checked":"")?"":e)+'> Применять автоматически</label></div>\n\t\t\t<div class="theme-picker__schedule-times'+(null==(e=!t.dark||t.schedule?" theme-picker__schedule-times_visible":"")?"":e)+'">\n\t\t\t\t<span class="theme-picker__schedule-caption">с</span>\n\t\t\t\t<span class="input input_inline">\n\t\t\t\t\t<input class="input__input" type="time" name="from" value="'+(null==(e=t.from)?"":e)+'">\n\t\t\t\t</span>\n\t\t\t\t<span class="theme-picker__schedule-caption">до</span>\n\t\t\t\t<span class="input input_inline">\n\t\t\t\t\t<input class="input__input" type="time" name="to" value="'+(null==(e=t.to)?"":e)+'">\n\t\t\t\t</span>\n\t\t\t</div>\n\t\t</div>\n\t</form>\n</div>'}var h=s(7370),c=s(6572),d=s(2822),u=s(8881);class p extends n.u1{_onChangeForm(t){const e=t.serialize(),s=1===e.dark,n=1===e.schedule;if(s!==i.vE.ui.themeSettings.data.dark){const t=i.vE.ui.themeSettings.data.dark?o.PH.DARK:o.PH.LIGHT,e=s?o.PH.DARK:o.PH.LIGHT;u.User.sendSettingsChangeAnalytics("color_theme",t,e),d.c.getInstance().yandex.goal(s?"color-theme_dark_on":"color-theme_dark_off")}n!==i.vE.ui.themeSettings.data.schedule&&d.c.getInstance().yandex.goal(n?"color-theme_dark-schedule_on":"color-theme_dark-schedule_off"),this.$els.settings.toggleClass("theme-picker__settings_visible",s),this.$els.times.toggleClass("theme-picker__schedule-times_visible",!s||n),i.vE.ui.themeSettings.data.dark=s,i.vE.ui.themeSettings.data.schedule=n,i.vE.ui.themeSettings.data.from=h.f.convertStringToTime(e.from),i.vE.ui.themeSettings.data.to=h.f.convertStringToTime(e.to),i.vE.emit("need-calendar-redraw"),c.xg.get("pkb_set_theme")||(c.xg.set("pkb-set-theme",!0),d.c.getInstance().yandex.goal(i.vE.isUserAuthorized?"color-theme_auth":"color-theme_guest"))}}var m=s(9050);const _=s(9755);class g extends p{render(){if(this.isRendered)return this;this.$el=_(document.createElement("div")),this.$el.addClass("theme-picker").append(i.vE.icon("ui__fill"));const t=i.vE.ui.themeSettings.data;this._popup=new r.gR({delay:300,delayClose:300,destroyAfterHide:!1,interactive:!0,indent:!0,target:this.$el,direction:r.Lh.TOP,alignment:r.SE.END,content:l({themes:[o.f0.DEFAULT,o.f0.SKY,o.f0.BLUE,o.f0.PURPLE,o.f0.ORANGE],currentTheme:t.theme,dark:t.dark,schedule:t.schedule,from:o.fM.convertTimeToString(t.from),to:o.fM.convertTimeToString(t.to)})}),this.listenTo(this._popup,n.eM.MOUNTED,(()=>this.$el.addClass("theme-picker_shown"))),this.listenTo(this._popup,n.eM.UNMOUNTED,(()=>{this.$el.removeClass("theme-picker_shown"),this.previewTheme=i.vE.ui.themeSettings.currentTheme})),this.$els={html:_("html"),body:_("body"),settings:this._popup.content.find(".theme-picker__settings"),buttons:this._popup.content.find(".theme-picker__buttons"),times:this._popup.content.find(".theme-picker__schedule-times")};const e=new a.x(this._popup.content.find("form"));return this.listenTo(e,"change",this._onChangeForm),this._popup.content.on("click",".theme-picker__button",(t=>{const e=i.vE.ui.themeSettings.data.theme.value;i.vE.ui.themeSettings.data.theme=o.f0[t.currentTarget.dataset.type],i.vE.emit("need-calendar-redraw"),u.User.sendSettingsChangeAnalytics("site_color",e,i.vE.ui.themeSettings.data.theme),d.c.getInstance().yandex.goal("color-theme_"+i.vE.ui.themeSettings.data.theme.valueOf()),this._popup.content.find(".theme-picker__button_current").removeClass("theme-picker__button_current"),t.currentTarget.classList.add("theme-picker__button_current")})),this._popup.content.on("mouseenter",".theme-picker__button",m.throttle((t=>{t&&t.currentTarget instanceof HTMLElement&&(this.previewTheme=o.f0[t.currentTarget.dataset.type]||o.f0)}),150,{leading:!1})),this._popup.content.on("mouseleave",".theme-picker__buttons",(()=>{this.previewTheme=i.vE.ui.themeSettings.currentTheme})),super.render(),this}destroy(){this.isDestroyed||(this._popup.destroy(),super.destroy())}get previewTheme(){return this._options.previewTheme||o.f0.DEFAULT}set previewTheme(t){let e=this._options.previewTheme;(t=o.f0[t])&&t!==e&&(t===o.f0.DEFAULT?this.$els.html.removeAttr("data-theme"):this.$els.html.attr("data-theme",String(t.valueOf())),this._options.previewTheme=t)}}var v=s(9412),f=s(7041);const y=s(9755),b=s(381),w=s(6419);class E{constructor(){this._needSignin=void 0,this._warningToastList=new Map,this._namedToastList=new Map,this.$el=y(".header__messages")}add(t,e){let s,o=t;return e&&!w.isObject(t)||(e=t,o=void 0),o&&(s=this._namedToastList.get(o),s&&s.isDestroyed&&(s=void 0)),s||((e=e||{}).content=i.vE.i18n(e.content||""),e=w.defaults(e,{destroyAfterHide:!0}),s=new v.O(e),o&&(this._namedToastList.set(o,s),s.on(n.eM.DESTROYED,(()=>{this._namedToastList.delete(o)})))),s.show(),s}showError(t){let e;return e=t instanceof Error?t.message:w.isString(t)?i.vE.i18n(t):"Упс! Возникла внутреняя ошибка",this.add({content:e,theme:v.K.DANGER})}showWarningMessage(t,...e){let s,n,o;t!==i.ZF.AUTHORIZATION_REQUIRED||i.vE.ui.auth||(t=i.ZF.AUTHORIZATION_REQUIRED_NO_LINKS),s=this._warningToastList.get(t),n=("string"!=typeof t?"comments.ignore.":"warning-message.")+t.toString(),s||(o=v.K.DANGER,(t===i.ZF.AUTHORIZATION_REQUIRED||i.ZF.AUTHORIZATION_REQUIRED_NO_LINKS)&&(o=v.K.WARNING),t===i.ZF.BANNED&&(e=[b(i.vE.initParams.userEndDateOfBan||Date.now()).fromNow()]),s=new v.O({theme:o,content:i.vE.i18n(n,...e)}),this._warningToastList.set(t,s),s.content.on("click","a",(()=>{s.hide()}))),t===i.ZF.NEED_MORE_RATING&&(s.content=i.vE.i18n(n,Math.abs(i.vE.userRating-(e[0]||0)))),t===f.IV.COMMUNITY_IGNORES_YOU&&(s.content=i.vE.i18n(n,...e)),s.show(),t===i.ZF.AUTHORIZATION_REQUIRED&&d.c.getInstance().sendEvent("tip_show",{type:"unauth_is_trying_auth_activity"})}needSignin(){return this._needSignin||(this._needSignin=new v.O,this._needSignin.content=y(`\n\t\t\t\t<span>\n\t\t\t\t\t${i.vE.icon("ui__user-message")} пожалуйста, \n\t\t\t\t\t<a href="#signin" class="to-signin">войдите в аккаунт</a> или \n\t\t\t\t\t<a href="#signin" class="to-signup">зарегистрируйтесь</a>\n\t\t\t\t</span>\n\t\t\t`),this._needSignin.content.find("a").click((()=>{this._needSignin.hide()}))),this._needSignin.show()}}s(4916),s(5827);var S=s(2134),C=s(7422),T=s(3363),O=s(6777),k=s(7025),I=s(7892);const $=new I.xs({INFO:1,DELETED_STORY:2,BAN:3,AWARD:4,NEWS:5});var A=s(3414),x=s(5494);const D=new I.xs({MAIN:1,PROFILE:2,SEARCH_HOVER:3,SEARCH_FOCUS:4,NOTIFICATIONS:5,EXTRA_MENU:6,OUT:7});var P=s(6151),R=s(9404),M=s(9050);function N(t){var e,s="",i=M.escape;Array.prototype.join;const n=t.from?`?from=${t.from}`:"";return s+='\n<div class="menu menu_vertical">\n\t<a class="menu__item" data-role="add-story" href="/add'+i(n)+'">Добавить пост</a>\n\t<a class="menu__item" href="/settings'+i(n)+'">Настройки</a>\n\t<a class="menu__item" href="/answers'+i(n)+'">Ответы '+(null==(e=t.answersBell||"")?"":e)+'</a>\n\t<a class="menu__item" href="/comments'+i(n)+'">Комментарии</a>\n\t<a class="menu__item" href="/liked'+i(n)+'">Оценки</a>\n\t<a class="menu__item" href="/saved-stories'+i(n)+'">Сохраненные</a>\n\t<a class="menu__item" href="/subs-list'+i(n)+'">Подписки</a>\n\t<a class="menu__item" href="/ignore-list'+i(n)+'">Игнор-лист</a>\n\t<a class="menu__item" href="/notes'+i(n)+'">Заметки</a>\n\t<span class="menu__item" data-role="logout">Выйти</span>\n</div>\n'}var B=s(9050);function L(t){var e,s="";return s+='<div class="notifications-hint">\n    <div class="notifications-hint__body notifications-hint__body_visible" data-is-new="'+(null==(e=t.isNew)?"":e)+'">\n        <div class="notification">\n            <div class="notification__main">\n                <div class="notification__header">\n                    <div class="notification__icon notification__icon_inline">\n                        <i class="fa fa-envelope-o" aria-hidden="true"></i>\n                    </div>\n                    <time class="notification__datetime" datetime="'+(null==(e=t.datetime)?"":e)+'">'+(null==(e=t.dateFormat)?"":e)+'</time>\n                </div>\n                Приветствуем на Пикабу!\n                <br>\n                <br>\n                <a href="#signup" class="to-signup" data-type="welcome">Зарегистрируйтесь</a>, чтобы получить возможность:\n                <br>– скрывать просмотренные посты\n                <br>– общаться в комментариях\n                <br>– голосовать за лучший контент\n                <br>– делать собственные посты\n                <br>– подписываться на интересные темы\n                <br>– и ещё много всего интересного\n            </div>\n        </div>\n    </div>\n    <div class="notifications-hint__more">\n        <a href="/information/welcome" class="notifications-hint__more-link">Показать уведомление</a>\n    </div>\n</div>'}var F=s(4069),U=s(2630),j=s(8504),V=s(4122),H=s(2308),q=s(5271);const W=[-100,0,25,100,250,500,1e3,2500,5e3,1e4];function G(t,e){var s=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),s.push.apply(s,i)}return s}function Y(t,e,s){return e in t?Object.defineProperty(t,e,{value:s,enumerable:!0,configurable:!0,writable:!0}):t[e]=s,t}const z="pkb_ssess";class Z{static convertSearchParams(t){var e,s,i,n;const o={},r={};t.rating&&(o.rating=W[t.rating-1]),null!==(e=t.user)&&void 0!==e&&e.id&&(o.author_id=t.user.id),null!==(s=t.community)&&void 0!==s&&s.id&&(o.community_id=t.community.id),null!==(i=t.tags)&&void 0!==i&&i.length&&(o.tags=Array.isArray(t.tags)?t.tags.join(","):t.tags),null!==(n=t.excludeTags)&&void 0!==n&&n.length&&(o.no_tags=Array.isArray(t.excludeTags)?t.excludeTags.join(","):t.excludeTags);const a=[t.dateFrom,t.dateTo].filter(Boolean);if(a.length&&(1===a.length&&a.push(a[0]),r.period=`${a[0]} - ${a[1]}`),t.type){const e=t.type,s=[];Object.entries(Z.postTypes).forEach((([t,i])=>{e&i&&s.push(t)})),s.length&&(r.post_type=s.join(","))}return Object.keys(r).length>0&&(o.search_filters_list=JSON.stringify(r)),o}static createSearchSession(){const t=Z.createSearchKey();return c.xg.set(z,t),new Z(t)}static retrieveSearchSession(){let t=parseInt(c.xg.get(z),10);return t?c.xg.remove(z):t=Z.createSearchKey(),new Z(t)}static createSearchKey(){return Math.trunc(Date.now()/1e3)}constructor(t){this.key=t}sendSearchEvent(t,e){const s=e?Z.convertSearchParams(e):void 0;d.c.getInstance().sendEvent("search",function(t){for(var e=1;e<arguments.length;e++){var s=null!=arguments[e]?arguments[e]:{};e%2?G(Object(s),!0).forEach((function(e){Y(t,e,s[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(s)):G(Object(s)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(s,e))}))}return t}({search_input:t,screen_search:this.key},s))}}Y(Z,"postTypes",{text:2,image:4,video:8,mine:16,nsfw:32});const K=s(9755),X=s(6419),Q=s(381),J={[$.DELETED_STORY]:"fa-trash-o",[$.NEWS]:"fa-newspaper-o",[$.BAN]:"fa-ban"};class tt extends O.vp{constructor(t){if(super(),this.ui=t,this._options={},this.$el=K(".header"),!this.$el.length)return;if(this.$els={app:K(".app__inner"),inner:this.$(".header__inner"),main:this.$(".header__main"),wrapper:this.$(".header__wrapper"),menu:this.$(".header-menu"),menuItems:this.$(".header-menu__item"),extra:this.$(".header-menu__extra"),extraWrapper:this.$(".header-menu__extra-wrapper"),branding:this.$("a > div"),avatar:this.$(".header-right-menu__item.avatar"),notifications:this.$(".header-right-menu__notification"),notificationsBell:this.$(".header-right-menu__notification .bell"),search:{el:this.$(".header-right-menu__search"),form:this.$(".header-right-menu__search > form"),btn:this.$('.header-right-menu__search button[type="submit"]')},messages:this.$(".header__messages"),logo:this.$(".logo")},q.V.isUserInExperiment(q.t.LOGIN_ICONS,"gr1")&&(this.$els.login=this.$(".header-right-menu__login")),this._headerHeight=this.$el.height()-2,this._heightFixed=0,this._heightFixedHover=0,this._initValue(),this.hideNext=!1,this._isBranding=this.$el.get(0).firstElementChild!==this.$els.main.get(0)&&!this.$el.find(".external_branding").length,this._activeElements=new A.F,this.listenTo(this._activeElements,"update",this._onUpdateElements),this.$el.addClass("header_absolute"),this.$els.app.css("padding-top",this.$el.height()),i.vE.isUserAuthorized)this._initProfileMenu(),this._initNotifications();else{i.vE.initParams.isDeleted||this._initWelcomeNotification();const t=q.V.isUserInExperiment(q.t.LOGIN_ICONS,"gr1")?"login":"avatar";this.$els[t].click((()=>{this.isFixedShown=!1,this.ui.auth?this.ui.auth.scrollToAuth():i.vE.ui.authRequired(),d.c.getInstance().sendEvent("click",{type:"login"===t?"authorization_button":"avatar"})}))}this.ui.on("document-scroll",(t=>{this.hideNext&&(this.isFixedShown=!1,this.hideNext=!1),this.isFixed=t>this._headerHeight})),K(document).on("mouseout",(t=>{if(!this.isFixed)return;let e=t.clientX,s=t.clientY,i=document.elementFromPoint(e,s),n=this._votingArea&&this._votingArea.x1<e&&this._votingArea.x2>e;i&&i.closest(".header__main")?n||this._activeElements.toggle(D.MAIN,!0):(this._activeElements.toggle(D.MAIN,!1),s<5&&!n?this._activeElements.toggle(D.OUT,!0):this._activeElements.toggle(D.OUT,!1))}));let e=document.querySelector(".story__left");if(e){let{x:t,width:s}=e.getBoundingClientRect();this._votingArea={x1:t,x2:t+s}}this.isFixed=this.ui.scrollTop>this._headerHeight,this._searchInput=void 0,this._searchShown=!1,this._searchTimerId=0,this._searchBtnEnabled=!1,this._notificationsTimerId=0,this._notificationsWasTimerEvent=!1,this._extraMenu=null,this._initSearch(),this._initExtraMenu(),this.listenTo(i.vE.ui,"resize",X.throttle(this._toggleExtraMenu.bind(this),400)),this.$els.menuItems.on("click",(t=>{const e=t.currentTarget.dataset.feedKey||"my_lent",s=F.L[e];s&&d.c.getInstance().sendEvent("transition_to_tab",{level:s}),c.xg.remove(R.$U)})),this.$els.logo.click((()=>{c.xg.remove(R.$U)})),this._initBranding(),this._initCompaniesFeedHint()}get visibilityState(){return this.isFixedShown?"fixed-shown":this.isFixed?"fixed-hidden":"static"}async _initCompaniesFeedHint(){const t="companies-feed-hint";if((0,U.jE)().some((({id:e})=>e===t)))return;const e=document.getElementById("menu-companies");let s,i;const o=async()=>{var o;i||(i=await(0,U.kd)({id:t,autoCloseOutsideClick:!1,endDateString:"2022-06-01",target:e,text:"Встречайте «Блоги компаний» 👋 Новую ленту<br/> на Пикабу, где бренды делятся интересным и общаются с пользователями",theme:k.xb.GREEN,setShownStateOnHidden:!1,wrapperExtraClass:"companies-feed-hint",showManually:!0,btnConfig:{handler:()=>{i.destroy(),(0,U.Ri)(t),d.c.getInstance().sendEvent("tip_close",{type:"companies_feed"})}}}),null===(o=i)||void 0===o||o.on(n.eM.RENDERED,(()=>{d.c.getInstance().sendEvent("tip_show",{type:"companies_feed"}),r()})));const r=()=>{var t;if(!i)return;const s=e.offsetTop>0;i.setOptions({target:s?this.$els.extraWrapper.get(0):e}),null===(t=i.el)||void 0===t||t.classList.toggle("companies-feed-hint_collapsed",s)};new ResizeObserver(r).observe(this.$els.menu.get(0)),e.addEventListener("click",(()=>{(0,U.Ri)(t)})),s&&clearTimeout(s),s=setTimeout((()=>{var t;"static"!==this.visibilityState&&"fixed-shown"!==this.visibilityState||(null===(t=i)||void 0===t||t.show());s=null}),300)};"static"===this.visibilityState&&o(),this.on("header-visibility-change",(async t=>{var e;"fixed-hidden"===t?(s&&(clearTimeout(s),s=null),null===(e=i)||void 0===e||e.hide()):"static"===t&&o()}))}_initValue(){let t=this.$els.main[0].offsetTop,e=this.$els.inner.height();this._headerHeight=this.$el.height()-2,this._heightFixed=-(t+e-2),this._heightFixedHover=-t}_onUpdateElements(t){this.isFixedShown=0!==t.valueOf();let e=t.has(D.SEARCH_HOVER),s=t.has(D.SEARCH_FOCUS),i=this._searchInput.isEmpty,n=e||s&&!i;this._searchShown!==n&&(this._searchShown=n,this.$els.search.el.toggleClass("header-right-menu__search_focus",n),setTimeout((()=>{this._searchBtnEnabled=n}),200),n&&!s?this._searchInput.focus():!n&&s&&this._searchInput.blur())}_toggleExtraMenu(){const t=()=>X.filter(this.$els.menuItems,(t=>t.offsetTop>0)),e=0===t().length;if(this.$els.extra.hide(),e)return this;this.$els.menuItems.eq(this.$els.menuItems.length-t().length).before(this.$els.extraWrapper),this.$els.extra.show();const s=t();return this._extraMenu.content=K(document.createElement("div")).addClass("menu menu_vertical menu_multiline").append(X.map(s,(t=>{const e=K(t);return e.children().clone().addClass("menu__item").data("feed-key",e.data("feed-key")).click((t=>{const e=K(t.currentTarget).data("feed-key")||"my_lent",s=F.L[e];s&&d.c.getInstance().sendEvent("transition_to_tab",{level:s})})).toggleClass("menu__item_current",e.hasClass("header-menu__item_current"))}))),this}_initExtraMenu(){return this._extraMenu||(this._extraMenu=new k.gR({delay:100,target:this.$els.extra,direction:k.Lh.BOTTOM,width:180,interactive:!0,destroyAfterHide:!1}),this.listenTo(this._extraMenu,"_eventAll",this._onElementEvent.bind(this,D.EXTRA_MENU)),this.listenTo(i.vE.ui,"visibilitychange",(t=>{t?(this._clearSearchTimer(),this._toggleSearch(!1)):this._toggleExtraMenu()})),this._toggleExtraMenu()),this}_onElementEvent(t,e){e===n.eM.MOUNTED&&this._activeElements.set(t),e===n.eM.UNMOUNTED&&this._activeElements.remove(t)}async _toggleSearch(t){!t&&this._extraMenu&&this._extraMenu.isShown||(this._activeElements.toggle(D.SEARCH_HOVER,t),await c.cQ.delay(200),this._toggleExtraMenu())}_clearSearchTimer(){this._searchTimerId&&(clearTimeout(this._searchTimerId),this._searchTimerId=0)}_initSearch(){this._searchInput=new T.u3({$el:this.$els.search.el,suggestion:new C.DC({maxHeight:500})}),this.listenTo(this._searchInput.suggestion,C.nT.SELECT,(t=>{if(!t)return;let e;switch(t.data.type){case"user":e=`/@${t.data.name}`;break;case"community":e=`/community/${t.data.link}`;break;case"tag":const s=t.data.name;Z.createSearchSession().sendSearchEvent("",{tags:[s]}),e=`/tag/${encodeURIComponent(s)}`}e?i.vE.history.location.href=e:this.$els.search.form.trigger("submit")})),this.listenTo(this._searchInput,"focus",(()=>{this._activeElements.set(D.SEARCH_FOCUS)})),this.listenTo(this._searchInput,"blur",(()=>{this._activeElements.remove(D.SEARCH_FOCUS)})),this.$els.search.form.on("submit",(()=>{Z.createSearchSession().sendSearchEvent(this._searchInput.value)}));let t=!1;this.$els.search.btn.click((t=>{this._searchBtnEnabled||t.preventDefault()}));const e=e=>{const s="mouseenter"===e.type;if(this._clearSearchTimer(),s===t&&e.target!==this.$els.extra[0])return!1;t=s,this._toggleExtraMenu(),this._searchTimerId=setTimeout(this._toggleSearch.bind(this),s?200:2e3,s)};return this.$els.search.el.hover(e),this.$els.extra.mouseleave(e),this}_initProfileMenu(){const t=new k.gR({target:this.$els.avatar,direction:k.Lh.BOTTOM,alignment:k.SE.END,interactive:!0,destroyAfterHide:!1,content:N({from:"avatar-menu",userName:i.vE.initParams.userName,answersBell:K('.menu__item[href="/answers"] > .bell').clone().prop("outerHTML")})});return t.content.find('.menu__item[data-role="logout"]').click(P.n.logout),this.listenTo(t,"_eventAll",this._onElementEvent.bind(this,D.PROFILE)),this.listenTo(t,n.eM.MOUNTED,(()=>{d.c.getInstance().yandex.goal("avatar-menu-open")})),this}_initWelcomeNotification(){if(!this.$els.notifications.length)return;const t="header-welcome";let e=(0,U.jE)().filter((({id:e})=>e===t)).length>0;e||(this.$els.notificationsBell=K('<span class="bell">1</span>'),this.$els.notifications.append(this.$els.notificationsBell).addClass("header-right-menu__notification_active"));const s={};s.isNew=!e,s.datetime=new Date(Date.now()).toISOString(),s.dateFormat=Q(s.datetime).format("DD MMMM YYYY, HH:mm");const i=new k.gR({target:this.$els.notifications,content:L(s),destroyAfterHide:!1,showArrow:!1,width:350,distance:5,interactive:!0}),o=()=>{e||((0,U.Ri)(t),e=!0)};this.$els.notifications.click(o),i.content.on("click",(({target:t})=>{t.classList.contains("to-signup")&&i.hide(),t.classList.contains("notifications-hint__more-link")&&o()}));let r=0,a=!1;this.listenTo(i,n.eM.MOUNTED,(()=>{if(!this.$els.notificationsBell.length||a)return;r=setTimeout((()=>{o(),this.$els.notificationsBell.remove(),i.content.find(".notifications-hint__body").attr("data-is-new","false"),r=0,a=!0}),2e3)})),this.listenTo(i,n.eM.UNMOUNTED,(()=>{r&&(clearTimeout(r),r=0)}))}get _notificationBellCount(){return this.$els.notificationsBell.is(":visible")?Number(this.$els.notificationsBell.data("count")):0}_initNotifications(){let t=new k.gR({target:this.$els.notifications,content:(i.vE.initParams.userName,'<div class="notifications-hint">\n\t<div class="notifications-hint__loading">\n\t\t<svg xmlns="http://www.w3.org/2000/svg" class="icon icon--ui__progress-circle icon--ui__progress-circle_notifications"><use xlink:href="#icon--ui__progress-circle"></use></svg>\n\t</div>\n\t<div class="notifications-hint__body"></div>\n\t<div class="notifications-hint__more">\n\t\t<a href="/notifications">Показать все уведомления</a>\n\t</div>\n</div>'),destroyAfterHide:!1,showArrow:!1,width:350,distance:5,interactive:!0});this.listenTo(t,"_eventAll",this._onElementEvent.bind(this,D.NOTIFICATIONS));let e=!1,s=[];return this.listenTo(t,n.eM.MOUNTED,(async()=>{if(d.c.getInstance().yandex.goal("notification_popup_view"),d.c.getInstance().sendEvent("reach_element",{type:"notification_popup",comments:this._notificationBellCount}),e)return void this._startNotificationsTimerEvent(t,s);let n=Date.now(),o=!1;try{s=await P.n.getNotifications(1)}catch(a){i.vE.ui.toasts.showError(a)}await c.cQ.delay(500-(Date.now()-n));let r=s.slice(0,1).reduce(((t,e)=>{let s=Q(e.datetime);return e.dateFormat=s.format("DD MMMM YYYY, HH:mm"),e.icon?e.fa=e.icon:e.fa=J[e.type]||"fa-envelope-o",e.is_new&&(o=!0),t+function(t){var e,s="",i=B.escape;return Array.prototype.join,s+='<div class="notification"> ',s+='\n\t<div class="notification__main">\n\t\t<div class="notification__header">\n\t\t\t<div class="notification__icon notification__icon_inline">\n\t\t\t\t',t.icon&&t.icon!==t.fa?s+='\n\t\t\t\t<img width="34" height="34" src="'+i(t.icon)+'">\n\t\t\t\t':s+='\n\t\t\t\t<i class="fa '+(null==(e=t.fa)?"":e)+'" aria-hidden="true"></i>\n\t\t\t\t',s+='\n\t\t\t</div>\n\t\t\t<time class="notification__datetime" datetime="'+(null==(e=t.datetime)?"":e)+'">'+(null==(e=t.dateFormat)?"":e)+"</time>\n\t\t</div>\n\t\t"+(null==(e=t.text)?"":e)+"\n\t</div>\n</div>"}(e)}),"");t.content.find(".notifications-hint__loading").hide(),t.content.find(".notifications-hint__body").html(r.length?r:i.vE.i18n("notifications.message")).attr("data-is-new",o).show(),t.updatePosition(),e=!0,this._startNotificationsTimerEvent(t,s)})),this.listenTo(t,n.eM.UNMOUNTED,this._stopNotificationsTimerEvent.bind(this)),this}_startNotificationsTimerEvent(t,e){if(!this.$els.notificationsBell.length||this._notificationsWasTimerEvent)return;i.vE.logger.log("header","notifications","timer event start");this._notificationsTimerId=setTimeout((async()=>{i.vE.logger.log("header","notifications","timer event execute");const s=e.map((({id:t})=>t)).join(","),{response:n}=await S.cf.post("/ajax/notifications_actions.php?action=mark_read",{ids:s});if(200===n.status){let e=this._notificationBellCount;if(1===e)this.$els.notificationsBell.data("count",0),this.$els.notificationsBell.remove();else{e--;const t=e>99?"99+":e;this.$els.notificationsBell.text(t),this.$els.notificationsBell.data("count",t)}t.content.find(".notifications-hint__body").attr("data-is-new","false")}this._notificationsTimerId=0,this._notificationsWasTimerEvent=!0}),2e3)}_stopNotificationsTimerEvent(){this._notificationsTimerId&&(i.vE.logger.log("header","notifications","timer event clear"),clearTimeout(this._notificationsTimerId),this._notificationsTimerId=0)}_initBranding(){if(window.Ya)try{let t="adfox_156570562144159249",e=264,s={p1:"cnpjm",p2:"gmxe"},n=!0;const o=64;q.V.isUserInExperiment(q.t.PROGRAMMATIC_BRANDING,"gr1")&&(t="adfox_164509879945613354",e=200,s={p1:"csmll",p2:"gmxe"},n=!1);const r=n?e:e+o,a=this;window.yaContextCb.push((()=>{Ya.adfoxCode.create({ownerId:260477,containerId:t,params:s,onLoad:t=>{i.vE.logger.log("adfox banner onLoad",t);const e=t.bundleParams;e&&(a.$el.removeClass("header_animation"),K(".external_branding").css({height:r,backgroundColor:e.bodyBackgroundColor,marginBottom:n?-1*o+"px":void 0}),a.$els.app.css("padding-top",r),a._initValue(),a._isBranding=!0,a.isFixed?(a.$el.removeClass("header_animation"),a.$el.css({transform:a.isFixed?`translateY(${a.isFixedShown?a._heightFixedHover:a._heightFixed}px)`:""}),setTimeout((()=>{a.$el.addClass("header_animation")}),1500)):a.$el.addClass("header_dark"),a.emit("dynamic-branding"))},onRender:()=>{window.adInfoStorage=(window.adInfoStorage||new Set).add(t),V.Q.instance.watch(K(".external_branding"),H.L.BANNER)},onError:t=>i.vE.logger.log("adfox banner onError",t),onStub:()=>i.vE.logger.log("adfox banner onStub")})}))}catch(t){i.vE.logger.log("adfox",t)}}get isFixed(){return this._options.isFixed}set isFixed(t){this._options.isFixed!==t&&(this._options.isFixed=t,t?setTimeout((()=>{x.$.request((()=>{this.$el.addClass("header_animation")}))}),50):(this.isFixedShown=!1,this.$el.removeClass("header_animation")),this._isBranding&&this.$el.toggleClass("header_dark",!t),this.$el.toggleClass("header_fixed",t).css("transform",t?`translateY(${this.isFixedShown?this._heightFixedHover:this._heightFixed}px)`:""),this.emit("header-visibility-change",this.visibilityState))}get isFixedShown(){return this._options.isFixedShown}set isFixedShown(t){this._options.isFixedShown!==t&&(this._options.isFixedShown=t,t||(this.isFixed=this.ui.scrollTop>this._headerHeight),this.isFixed&&this.$el.css("transform",`translateY(${t?this._heightFixedHover:this._heightFixed}px)`),t?this.$el.addClass("header_shown"):setTimeout((()=>{this.$el.removeClass("header_shown")}),50),this.emit("header-visibility-change",this.visibilityState))}get hideNext(){return this._options.hideNext}set hideNext(t){this._options.hideNext!==t&&(this._options.hideNext=t)}$(t){return this.$el.find(t)}}s(5844);var et=s(8041),st=(s(5306),s(2025)),it=s(8097),nt=s(1078);const ot={username:{"too-short":"nickname_short","too-long":"nickname_long",required:"nickname_empty","username-busy":"nickname_occupied","username-first-dot":"nickname_wrong_symbol","username-last-dot":"nickname_wrong_symbol","username-whitelist":"nickname_wrong_symbol","username-short":"nickname_short","username-long":"nickname_long","Логин занят":"nickname_occupied","Использование слова moderator в никнейме запрещено":"nickname_occupied"},phone:{required:"phone_empty",phone:"phone_wrong"," Отвяжите его или обратитесь в поддержку":"phone_occupied"},email:{email:"email_wrong",required:"email_empty","Email используется":"email_occupied"},password:{"too-short":"password_short","password-week":"password_weak",required:"password_empty","password-short":"password_short","password-wrong":"password_wrong"},username_socials:{"too-short":"nickname_short","too-long":"nickname_long",required:"nickname_empty","username-busy":"nickname_occupied","username-first-dot":"nickname_wrong_symbol","username-last-dot":"nickname_wrong_symbol","username-whitelist":"nickname_wrong_symbol","username-short":"nickname_short","username-long":"nickname_long"},phone_socials:{required:"phone_empty"},contact:{format:"email_or_phone_wrong",required:"email_or_phone_empty"},login:{required:"login_empty","too-short":"login_short"},restore_passwd1:{"password-week":"password_weak","password-mismatch":"password_differ",required:"password_empty","too-short":"password_short"},restore_passwd2:{"password-mismatch":"password_differ",required:"password_empty"},"password-repeat":{"too-short":"password_short",required:"password_empty","password-mismatch":"password_differ"}};var rt=s(6542),at=s(9050);var lt=s(7320),ht=s(6596);class ct{constructor(){if(this.els={container:document.getElementById("google-one-tap-container"),header:document.querySelector(".header"),headerMain:document.querySelector(".header__main")},!this.els.container)return;const t=document.createElement("script");t.src="https://accounts.google.com/gsi/client",document.body.append(t),t.onload=()=>{var t,e;if(null===(t=google)||void 0===t||null===(e=t.accounts)||void 0===e||!e.id)return;google.accounts.id.initialize({client_id:this.els.container.dataset.clientId,prompt_parent_id:this.els.container.id,itp_support:i.vE.ua.ios||i.vE.ua.safari,callback:async t=>{d.c.getInstance().sendEvent("authorization",{type:"google"});try{const{response:e}=await S.cf.post("/ajax/auth/1tap",t);e&&Boolean(e.result)?window.location.reload():i.vE.ui.toasts.showError((null==e?void 0:e.message)||"comments.errors.400")}catch(e){i.vE.ui.toasts.showError(e)}}});const s=new MutationObserver(this.adjustPosition.bind(this));google.accounts.id.prompt((t=>{i.vE.isDesktopApp&&(t.isDisplayed()&&(s.observe(this.els.header,{attributes:!0,attributeFilter:["class"]}),this.adjustPosition()),t.isSkippedMoment()&&s.disconnect())}))}}adjustPosition(){if(this.els.header.classList.contains("header_fixed"))this.els.container.classList.add("google-one-tap-container_fixed"),this.els.container.style.transform=null;else{this.els.container.classList.remove("google-one-tap-container_fixed");const t=Math.max(0,this.els.headerMain.offsetTop);this.els.container.style.transform="translateY("+t+"px)"}}}const dt=s(9755);class ut extends n.u1{constructor(t){super(t),this._username=void 0,this.show(),this._prevSending={}}render(){return this.isRendered||(this.$els={form:this.$("form"),error:this.$(".auth__error")},this._form=new a.x(this.$els.form),new ct),this}focus(t=!1){return this._username&&(t&&this._username.highlightFocus(),this._username.focus()),this}setErrorMessage(t){let e=Boolean(t);this.$els.error.length?this.$els.error.toggle(e).html(t||""):e&&(i.vE.emit("error-auth-toast"),i.vE.ui.toasts.showError(t))}storePassCredentials(t,e,s){if(Boolean(navigator.credentials)&&Boolean(window.PasswordCredential)){let i=new PasswordCredential({id:t,name:t,password:e,iconURL:s||void 0});navigator.credentials.store(i)}}async _inputConfirmation(t){const e=await ht.K.getInstance().getScore("registration_code_request");d.c.getInstance().sendEvent("registration_code_request",{type:"phone",login:this._username.value,email:this._email.value,phone:this._phone.value,rec_score:e});let s=3;return new Promise((e=>{const o=new k.LD({destroyAfterHide:!0,indent:!0,minWidth:475,header:i.vE.i18n("auth.up.confirm.header"),content:'<form method="POST" action="javascript: void(0);" novalidate>\n\t<div class="input input_section">\n\t\t<div class="input__box">\n\t\t\t<input class="input__input" type="text" autocomplete="off" name="confirm" required minlength="4" maxlength="4" placeholder="Код из SMS">\n\t\t</div>\n\t</div>\n</form>',autoClosePressEscape:!1,autoCloseOutsideClick:!1}),r=o.content.find("form"),a=new T.u3({$el:o.content.find(".input"),validationEvent:T.km.MANUAL,validationHint:{direction:k.Lh.LEFT,alignment:k.SE.CENTER},sanitizerRules:[T.op.trim(),T.op.whitelist("0-9")],addSuccessState:!0});o.on(n.eM.UNMOUNTED,(()=>{e(!1)}));const l=new st.y3({title:i.vE.i18n("auth.up.confirm.button"),theme:st.jM.SUCCESS}),h=async()=>{if(l.progress)return;if(l.progress||!(await a.checkValidity()))return;l.progress=!0;let n=Date.now(),r=await u.User.registerSubmitBySmsCode(t||"",a.value);await c.cQ.delay(1e3-(Date.now()-n)),r.response.result?e(!0):--s?(a.value="",a.setCustomValidity(r.response.message)):(this.setErrorMessage(i.vE.i18n("auth.up.errors.confirm-limit",60)),this.isLockForm=!0,e(!1),o.hide()),l.progress=!1};r.on("submit",(t=>{t.preventDefault(),h()})),this.listenTo(l,"click",h),o.addCustomIntoFooter(l.show().$el),o.addCloseButtonIntoFooter(),o.addCustomIntoFooter(dt((0,rt.Z)(t))),i.vE.ui.hotkeys.once("enter",(()=>{h()}),{closest:o.$el,context:o,type:it.FM.KEYDOWN}),o.show(),setTimeout((()=>{a.focus()}),100)}))}get captcha(){if(!this.marks.has("captcha")){let t=dt(".footer__captcha");t.length||(t=dt(".sidebar-block__captcha").show()),this.marks.set("captcha",nt.k.instance.setOptions({siteKey:i.vE.config("grecaptchaKey"),wrapper:t}))}return this.marks.get("captcha")}async _checkUserAvailable(t){if(!t)return!1;return!!(await u.User.isUserAvailable(t).then((e=>e.message?(e.availableUserNames&&e.availableUserNames.length>0?this._availableNames=e.availableUserNames:this._availableNames=[],!1):(this._availableNames&&!this._availableNames.includes(t)&&(this._availableNames=[]),!0))))}_showAvailableUserNames(){this.$els.availableNames&&this.$els.availableNames.remove();const t=this._username.$el;let e=dt(function(t){var e="",i=at.escape;Array.prototype.join;const n=s(8211).vE;e+='\n\n<div class="available-names">\n    <div class="available-names__title">\n        ',e+="\n        ",n.initParams.experimentAuthRegDesign?e+="\n                Свободные логины:\n            ":e+="\n                Свободные никнеймы:\n            ",e+='\n    </div>\n    <div class="available-names__names">\n        ';for(let s=0;s<t.names.length;s++)e+='\n            <p class="name" data-name="'+i(t.names[s])+'">'+i(t.names[s])+"</p>\n        ";return e+"\n    </div>\n</div>"}({names:this._availableNames}));t.after(e),this.$els.availableNames=e,this.$els.availableNames.on("click",(t=>{if(!t.target.dataset.name)return;d.c.getInstance().sendEvent("click",{type:"reg_nick_advice"});const e=t.target.dataset.name;this.$els.form.find('[name="username"]').val(e),this._username.setCustomValidity()}))}_sendAnalytics(t,{input:e}){var s,i;if(t===this._prevSending.message&&Date.now()-this._prevSending.time<200)return this._prevSending.message=t,void(this._prevSending.time=Date.now());this._prevSending.message=t,this._prevSending.time=Date.now();const n=t.match(/^.+\.(.+?)(?:\(.*)?$/i),o=e.attr("name"),r=n&&n[1]?n[1]:t;let a;(e.closest('[data-id="signup"]').length>0||e.closest('[data-id="oauth"]').length>0)&&(a=3),(e.closest('[data-id="forget"]').length>0||e.closest('[data-role="new_password"]').length>0)&&(a=4);const l=ot[o][r]||"unknown_error";d.c.getInstance().sendEvent("error_occurred",{type_i8:a,type:l,"login!empty":this._username.value,"phone!empty":null===(s=this._phone)||void 0===s?void 0:s.value,"email!empty":null===(i=this._email)||void 0===i?void 0:i.value},[lt.b.CLICKHOUSE])}}var pt=s(3274),mt=s(9698),_t=s(2300);const gt=s(6419),vt=s(9755);class ft extends ut{render(){if(this.isRendered)return this;super.render();let t={validationEvent:T.km.MANUAL,validationHint:{direction:k.Lh.LEFT,alignment:k.SE.CENTER},sanitizerRules:[mt.o.trim()]};return this._username=new T.u3(gt.defaults({$el:this.$('input[name="username"]').parent()},t)),this._username.sanitizerRules.add((t=>t.replace(/\s/g,""))),this._username.sanitizerRules.add((t=>0===t.indexOf("+")?t.replace(/[^+0-9]+/g,""):t)),this._password=new T.u3(gt.defaults({$el:this.$('input[name="password"]').parent()},t)),Boolean(navigator.credentials)&&this.$el.on("click.auto-signin",(()=>{this.$el.off(".auto-signin"),setTimeout(this.autoSignIn.bind(this),160)})),this._submit=new st.y3({$el:this.$('button[type="submit"]'),animationName:"signin"}),this._form.add(this._username),this._form.add(this._password),this.captcha.render(),ht.K.getInstance().render(),this._usernameHint=new k.gR({target:this._username.$el,content:vt(document.createElement("div")).addClass("popup__hint").append(i.vE.i18n("auth.username-info")),direction:k.Lh.LEFT,destroyAfterHide:!1}),this.listenTo(this._username,"focus",(()=>{this._usernameHint.show()})),this.listenTo(this._username,"blur",(()=>{this._usernameHint.hide()})),this.listenTo(this._form,"submit",this._onSubmit),this}async autoSignIn(){if(!Boolean(navigator.credentials))return!1;let t=await navigator.credentials.get({password:!0,mediation:"optional"});if(t&&(this._username.blur(),this._password.blur(),await c.cQ.delay(100),"password"===t.type))if(this._username.value=t.id,this._password.value=t.password,await this._signIn(this._form))return!0;return!1}async _onSubmit(t,e){t&&gt.isFunction(t.preventDefault)&&t.preventDefault(),this._signIn(e)}async _signIn(t){if(this._username.value&&this._username.isFocused&&!this._password.value.length)return this._password.highlightFocus(),!1;if(this._submit.animation)return!1;if(this.marks.has("last-submit")&&Date.now()-this.marks.get("last-submit")<1500)return!1;let e=Date.now();this.marks.set("last-submit",e);const s=!i.vE.initParams.withoutCaptcha;if(this.setErrorMessage(),s&&(!(await t.checkValidity())||!(await this.captcha.getToken("authorization"))))return!1;let n=this._form.serialize();if(s&&(n["g-recaptcha-response"]=this.captcha.lastToken,!n["g-recaptcha-response"]))return this.setErrorMessage(i.vE.i18n("auth.up.errors.captcha")),!1;this._submit.animation=!0;const{response:o,data:r}=await u.User.authorize(n);if(await c.cQ.delay(1e3-(Date.now()-e)),o.result){if(r.session_id)await pt.g.confirmSMS({attempts:3,id:r.session_id,header:"Введите код из SMS сообщения",callback:async(t,e)=>{let s=await u.User.authorizeSpecAccount(n,r.session_id,t);if(s&&!s.response.result)throw e.value="",new Error(s.response.message);return s}}).then((async t=>{t&&t.response.result&&this.storePassCredentials(n.username,n.password,r.avatar),d.c.getInstance().sendEvent("authorization",{type:"phone"}),i.vE.initParams.experimentRegOnComment?i.vE.emit("success-user-confirmed"):(await c.cQ.delay(500),window.location.reload())}));else{if(this.storePassCredentials(n.username,n.password,r.avatar),d.c.getInstance().sendEvent("authorization",{type:"password"}),i.vE.initParams.experimentRegOnComment&&"story"===i.vE.initParams.pageName){if(r.is_confirmed)return void i.vE.emit("success-user-confirmed");c.mM.set("pkb_mar",{messageAfterReload:_t.wF,theme:v.K.DANGER})}await c.cQ.delay(500),window.location.reload()}return!0}return this.setErrorMessage(o.message),this.captcha.reset(),this._submit.animation=!1,!1}}const yt=/[^\d.a-z]/gi;var bt=s(9050);var wt=s(4113);function Et(t,e){var s=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),s.push.apply(s,i)}return s}function St(t){for(var e=1;e<arguments.length;e++){var s=null!=arguments[e]?arguments[e]:{};e%2?Et(Object(s),!0).forEach((function(e){Ct(t,e,s[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(s)):Et(Object(s)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(s,e))}))}return t}function Ct(t,e,s){return e in t?Object.defineProperty(t,e,{value:s,enumerable:!0,configurable:!0,writable:!0}):t[e]=s,t}const Tt=s(9755);var Ot=s(7585);function kt(t,e){var s=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),s.push.apply(s,i)}return s}function It(t){for(var e=1;e<arguments.length;e++){var s=null!=arguments[e]?arguments[e]:{};e%2?kt(Object(s),!0).forEach((function(e){$t(t,e,s[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(s)):kt(Object(s)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(s,e))}))}return t}function $t(t,e,s){return e in t?Object.defineProperty(t,e,{value:s,enumerable:!0,configurable:!0,writable:!0}):t[e]=s,t}const At=s(6419),xt=function(t){return class extends t{constructor(t){super(St(St({},t),{},{validationRules:St(St({},t.validationRules),t.requirements),addClearButton:!1})),Ct(this,"_showRequirementsErrors",!1),this._initialValidationHint=this._options.validationHint,this._renderHint()}render(){return super.render(),this._renderToggleMaskButton(),this}get _isFulfilled(){return Object.values(this._options.requirements).every((t=>t(this.value)))}_renderHint(){this._hint=document.createElement("div"),this.el.parentElement.insertBefore(this._hint,this.el.nextSibling),this._updateHint(),this.listenTo(this,"focus",(()=>{this._showRequirementsErrors=!1,this.validationHint=!1,this._updateHint()})),this.listenTo(this,"input",(()=>{this._updateHint()})),this.listenTo(this,"blur",(()=>{this._showRequirementsErrors=!0,this.validationHint=!!this._isFulfilled&&this._initialValidationHint,this._updateHint()}))}_renderToggleMaskButton(){this.$els.toggleMaskButton=Tt(`\n\t\t\t\t<span class="input__toggle-mask">\n\t\t\t\t\t${(0,wt.t)("auth__eye")}\n\t\t\t\t</span>\n\t\t\t`).appendTo(this.$el).click((t=>{t.stopPropagation();const e="password"===this.$els.input.attr("type");this.$els.input.attr("type",e?"text":"password"),this.$els.toggleMaskButton.html((0,wt.t)(e?"auth__eye-crossed":"auth__eye")),this.focused&&this.focus()}))}_updateHint(){const t=this._checkRequirements();this._hint.innerHTML=function(t){var e="",s=bt.escape;return Array.prototype.join,e+='<div class="requirements-hint">\n    <h4 class="requirements-hint__title">Требования к паролю:</h4>\n    <div class="requirements-hint__rules">\n        ',t.requirements.forEach((i=>{e+='\n            <div class="requirements-hint__rule">\n                <div class="requirements-hint__rule__icon">\n                    ',i.fulfilled?e+='\n                        <svg class="icon icon--auth__success" xmlns="http://www.w3.org/2000/svg" width="20" height="20">\n                            <use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="#icon--auth__success"></use>\n                        </svg>\n                    ':t.showErrors&&(e+='\n                        <svg class="icon icon--auth__error" xmlns="http://www.w3.org/2000/svg" width="20" height="20">\n                            <use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="#icon--auth__error"></use>\n                        </svg>\n                    '),e+='\n                </div>\n                <span class="requirements-hint__rule__text">'+s(i.message)+"</span>\n            </div>\n        "})),e+="\n    </div>\n</div>\n"}({requirements:t,showErrors:this._showRequirementsErrors})}_checkRequirements(){return Object.entries(this._options.requirements).map((([t,e])=>({message:i.vE.i18n(t),fulfilled:e(this.value)})))}}}(T.u3);class Dt extends ut{constructor(t){super(t)}render(){if(this.isRendered)return this;super.render();const t={validationEvent:T.km.BLUR,validationHint:{direction:k.Lh.LEFT,alignment:k.SE.CENTER},sanitizerRules:[T.op.trim()],addSuccessState:!0,onValidityErrorMessage:(t,{input:e})=>{this._sendAnalytics(t,{input:e})}};return this.$els.complexity=this.$(".input__complexity"),this._username=new T.u3(At.defaults({$el:this.$('input[name="username"]').parent()},t)),this._username.validationRules={"auth.up.errors.username-short":T.cX.isLength(3),"auth.up.errors.username-long":[T.cX.isLength(0,16)],"auth.up.errors.username-whitelist":T.cX.patternMatch(/^([A-Za-z0-9.]*)$/),"auth.up.errors.username-last-dot":T.cX.patternMatch(/[^.]$/),"auth.up.errors.username-first-dot":T.cX.patternMatch(/^[^.]/),"auth.up.errors.username-many-dot":t=>(t.match(/\./g)||[]).length<2,"auth.up.errors.username-busy":async t=>{const e=await this._checkUserAvailable(t);return!e&&this._availableNames&&Array.isArray(this._availableNames)&&this._availableNames.length>0?(this._showAvailableUserNames(),!1):(this._availableNames&&0===this._availableNames.length&&this.$els.availableNames&&this.$els.availableNames.remove(),e)}},this._username.preventInvalidInput({"auth.up.errors.username-whitelist":yt}),this._email=new T.u3(At.defaults({$el:this.$('input[name="email"]').parent()},t)),this.listenTo(this._email,"blur",this._fillUsernameWithEmail.bind(this)),this._password=new xt(It(It({},t),{},{$el:this.$('input[data-role="password"]').parent().parent(),requirements:{"^validation-rules.at-least-x-characters('6')":T.cX.isLength(6),"^validation-rules.at-least-x-letters('1')":T.cX.patternMatch(/[A-Za-z\xAA\xB5\xBA\xC0-\xD6\xD8-\xF6\xF8-\u02C1\u02C6-\u02D1\u02E0-\u02E4\u02EC\u02EE\u0370-\u0374\u0376\u0377\u037A-\u037D\u037F\u0386\u0388-\u038A\u038C\u038E-\u03A1\u03A3-\u03F5\u03F7-\u0481\u048A-\u052F\u0531-\u0556\u0559\u0560-\u0588\u05D0-\u05EA\u05EF-\u05F2\u0620-\u064A\u066E\u066F\u0671-\u06D3\u06D5\u06E5\u06E6\u06EE\u06EF\u06FA-\u06FC\u06FF\u0710\u0712-\u072F\u074D-\u07A5\u07B1\u07CA-\u07EA\u07F4\u07F5\u07FA\u0800-\u0815\u081A\u0824\u0828\u0840-\u0858\u0860-\u086A\u08A0-\u08B4\u08B6-\u08C7\u0904-\u0939\u093D\u0950\u0958-\u0961\u0971-\u0980\u0985-\u098C\u098F\u0990\u0993-\u09A8\u09AA-\u09B0\u09B2\u09B6-\u09B9\u09BD\u09CE\u09DC\u09DD\u09DF-\u09E1\u09F0\u09F1\u09FC\u0A05-\u0A0A\u0A0F\u0A10\u0A13-\u0A28\u0A2A-\u0A30\u0A32\u0A33\u0A35\u0A36\u0A38\u0A39\u0A59-\u0A5C\u0A5E\u0A72-\u0A74\u0A85-\u0A8D\u0A8F-\u0A91\u0A93-\u0AA8\u0AAA-\u0AB0\u0AB2\u0AB3\u0AB5-\u0AB9\u0ABD\u0AD0\u0AE0\u0AE1\u0AF9\u0B05-\u0B0C\u0B0F\u0B10\u0B13-\u0B28\u0B2A-\u0B30\u0B32\u0B33\u0B35-\u0B39\u0B3D\u0B5C\u0B5D\u0B5F-\u0B61\u0B71\u0B83\u0B85-\u0B8A\u0B8E-\u0B90\u0B92-\u0B95\u0B99\u0B9A\u0B9C\u0B9E\u0B9F\u0BA3\u0BA4\u0BA8-\u0BAA\u0BAE-\u0BB9\u0BD0\u0C05-\u0C0C\u0C0E-\u0C10\u0C12-\u0C28\u0C2A-\u0C39\u0C3D\u0C58-\u0C5A\u0C60\u0C61\u0C80\u0C85-\u0C8C\u0C8E-\u0C90\u0C92-\u0CA8\u0CAA-\u0CB3\u0CB5-\u0CB9\u0CBD\u0CDE\u0CE0\u0CE1\u0CF1\u0CF2\u0D04-\u0D0C\u0D0E-\u0D10\u0D12-\u0D3A\u0D3D\u0D4E\u0D54-\u0D56\u0D5F-\u0D61\u0D7A-\u0D7F\u0D85-\u0D96\u0D9A-\u0DB1\u0DB3-\u0DBB\u0DBD\u0DC0-\u0DC6\u0E01-\u0E30\u0E32\u0E33\u0E40-\u0E46\u0E81\u0E82\u0E84\u0E86-\u0E8A\u0E8C-\u0EA3\u0EA5\u0EA7-\u0EB0\u0EB2\u0EB3\u0EBD\u0EC0-\u0EC4\u0EC6\u0EDC-\u0EDF\u0F00\u0F40-\u0F47\u0F49-\u0F6C\u0F88-\u0F8C\u1000-\u102A\u103F\u1050-\u1055\u105A-\u105D\u1061\u1065\u1066\u106E-\u1070\u1075-\u1081\u108E\u10A0-\u10C5\u10C7\u10CD\u10D0-\u10FA\u10FC-\u1248\u124A-\u124D\u1250-\u1256\u1258\u125A-\u125D\u1260-\u1288\u128A-\u128D\u1290-\u12B0\u12B2-\u12B5\u12B8-\u12BE\u12C0\u12C2-\u12C5\u12C8-\u12D6\u12D8-\u1310\u1312-\u1315\u1318-\u135A\u1380-\u138F\u13A0-\u13F5\u13F8-\u13FD\u1401-\u166C\u166F-\u167F\u1681-\u169A\u16A0-\u16EA\u16F1-\u16F8\u1700-\u170C\u170E-\u1711\u1720-\u1731\u1740-\u1751\u1760-\u176C\u176E-\u1770\u1780-\u17B3\u17D7\u17DC\u1820-\u1878\u1880-\u1884\u1887-\u18A8\u18AA\u18B0-\u18F5\u1900-\u191E\u1950-\u196D\u1970-\u1974\u1980-\u19AB\u19B0-\u19C9\u1A00-\u1A16\u1A20-\u1A54\u1AA7\u1B05-\u1B33\u1B45-\u1B4B\u1B83-\u1BA0\u1BAE\u1BAF\u1BBA-\u1BE5\u1C00-\u1C23\u1C4D-\u1C4F\u1C5A-\u1C7D\u1C80-\u1C88\u1C90-\u1CBA\u1CBD-\u1CBF\u1CE9-\u1CEC\u1CEE-\u1CF3\u1CF5\u1CF6\u1CFA\u1D00-\u1DBF\u1E00-\u1F15\u1F18-\u1F1D\u1F20-\u1F45\u1F48-\u1F4D\u1F50-\u1F57\u1F59\u1F5B\u1F5D\u1F5F-\u1F7D\u1F80-\u1FB4\u1FB6-\u1FBC\u1FBE\u1FC2-\u1FC4\u1FC6-\u1FCC\u1FD0-\u1FD3\u1FD6-\u1FDB\u1FE0-\u1FEC\u1FF2-\u1FF4\u1FF6-\u1FFC\u2071\u207F\u2090-\u209C\u2102\u2107\u210A-\u2113\u2115\u2119-\u211D\u2124\u2126\u2128\u212A-\u212D\u212F-\u2139\u213C-\u213F\u2145-\u2149\u214E\u2183\u2184\u2C00-\u2C2E\u2C30-\u2C5E\u2C60-\u2CE4\u2CEB-\u2CEE\u2CF2\u2CF3\u2D00-\u2D25\u2D27\u2D2D\u2D30-\u2D67\u2D6F\u2D80-\u2D96\u2DA0-\u2DA6\u2DA8-\u2DAE\u2DB0-\u2DB6\u2DB8-\u2DBE\u2DC0-\u2DC6\u2DC8-\u2DCE\u2DD0-\u2DD6\u2DD8-\u2DDE\u2E2F\u3005\u3006\u3031-\u3035\u303B\u303C\u3041-\u3096\u309D-\u309F\u30A1-\u30FA\u30FC-\u30FF\u3105-\u312F\u3131-\u318E\u31A0-\u31BF\u31F0-\u31FF\u3400-\u4DBF\u4E00-\u9FFC\uA000-\uA48C\uA4D0-\uA4FD\uA500-\uA60C\uA610-\uA61F\uA62A\uA62B\uA640-\uA66E\uA67F-\uA69D\uA6A0-\uA6E5\uA717-\uA71F\uA722-\uA788\uA78B-\uA7BF\uA7C2-\uA7CA\uA7F5-\uA801\uA803-\uA805\uA807-\uA80A\uA80C-\uA822\uA840-\uA873\uA882-\uA8B3\uA8F2-\uA8F7\uA8FB\uA8FD\uA8FE\uA90A-\uA925\uA930-\uA946\uA960-\uA97C\uA984-\uA9B2\uA9CF\uA9E0-\uA9E4\uA9E6-\uA9EF\uA9FA-\uA9FE\uAA00-\uAA28\uAA40-\uAA42\uAA44-\uAA4B\uAA60-\uAA76\uAA7A\uAA7E-\uAAAF\uAAB1\uAAB5\uAAB6\uAAB9-\uAABD\uAAC0\uAAC2\uAADB-\uAADD\uAAE0-\uAAEA\uAAF2-\uAAF4\uAB01-\uAB06\uAB09-\uAB0E\uAB11-\uAB16\uAB20-\uAB26\uAB28-\uAB2E\uAB30-\uAB5A\uAB5C-\uAB69\uAB70-\uABE2\uAC00-\uD7A3\uD7B0-\uD7C6\uD7CB-\uD7FB\uF900-\uFA6D\uFA70-\uFAD9\uFB00-\uFB06\uFB13-\uFB17\uFB1D\uFB1F-\uFB28\uFB2A-\uFB36\uFB38-\uFB3C\uFB3E\uFB40\uFB41\uFB43\uFB44\uFB46-\uFBB1\uFBD3-\uFD3D\uFD50-\uFD8F\uFD92-\uFDC7\uFDF0-\uFDFB\uFE70-\uFE74\uFE76-\uFEFC\uFF21-\uFF3A\uFF41-\uFF5A\uFF66-\uFFBE\uFFC2-\uFFC7\uFFCA-\uFFCF\uFFD2-\uFFD7\uFFDA-\uFFDC\u{10000}-\u{1000B}\u{1000D}-\u{10026}\u{10028}-\u{1003A}\u{1003C}\u{1003D}\u{1003F}-\u{1004D}\u{10050}-\u{1005D}\u{10080}-\u{100FA}\u{10280}-\u{1029C}\u{102A0}-\u{102D0}\u{10300}-\u{1031F}\u{1032D}-\u{10340}\u{10342}-\u{10349}\u{10350}-\u{10375}\u{10380}-\u{1039D}\u{103A0}-\u{103C3}\u{103C8}-\u{103CF}\u{10400}-\u{1049D}\u{104B0}-\u{104D3}\u{104D8}-\u{104FB}\u{10500}-\u{10527}\u{10530}-\u{10563}\u{10600}-\u{10736}\u{10740}-\u{10755}\u{10760}-\u{10767}\u{10800}-\u{10805}\u{10808}\u{1080A}-\u{10835}\u{10837}\u{10838}\u{1083C}\u{1083F}-\u{10855}\u{10860}-\u{10876}\u{10880}-\u{1089E}\u{108E0}-\u{108F2}\u{108F4}\u{108F5}\u{10900}-\u{10915}\u{10920}-\u{10939}\u{10980}-\u{109B7}\u{109BE}\u{109BF}\u{10A00}\u{10A10}-\u{10A13}\u{10A15}-\u{10A17}\u{10A19}-\u{10A35}\u{10A60}-\u{10A7C}\u{10A80}-\u{10A9C}\u{10AC0}-\u{10AC7}\u{10AC9}-\u{10AE4}\u{10B00}-\u{10B35}\u{10B40}-\u{10B55}\u{10B60}-\u{10B72}\u{10B80}-\u{10B91}\u{10C00}-\u{10C48}\u{10C80}-\u{10CB2}\u{10CC0}-\u{10CF2}\u{10D00}-\u{10D23}\u{10E80}-\u{10EA9}\u{10EB0}\u{10EB1}\u{10F00}-\u{10F1C}\u{10F27}\u{10F30}-\u{10F45}\u{10FB0}-\u{10FC4}\u{10FE0}-\u{10FF6}\u{11003}-\u{11037}\u{11083}-\u{110AF}\u{110D0}-\u{110E8}\u{11103}-\u{11126}\u{11144}\u{11147}\u{11150}-\u{11172}\u{11176}\u{11183}-\u{111B2}\u{111C1}-\u{111C4}\u{111DA}\u{111DC}\u{11200}-\u{11211}\u{11213}-\u{1122B}\u{11280}-\u{11286}\u{11288}\u{1128A}-\u{1128D}\u{1128F}-\u{1129D}\u{1129F}-\u{112A8}\u{112B0}-\u{112DE}\u{11305}-\u{1130C}\u{1130F}\u{11310}\u{11313}-\u{11328}\u{1132A}-\u{11330}\u{11332}\u{11333}\u{11335}-\u{11339}\u{1133D}\u{11350}\u{1135D}-\u{11361}\u{11400}-\u{11434}\u{11447}-\u{1144A}\u{1145F}-\u{11461}\u{11480}-\u{114AF}\u{114C4}\u{114C5}\u{114C7}\u{11580}-\u{115AE}\u{115D8}-\u{115DB}\u{11600}-\u{1162F}\u{11644}\u{11680}-\u{116AA}\u{116B8}\u{11700}-\u{1171A}\u{11800}-\u{1182B}\u{118A0}-\u{118DF}\u{118FF}-\u{11906}\u{11909}\u{1190C}-\u{11913}\u{11915}\u{11916}\u{11918}-\u{1192F}\u{1193F}\u{11941}\u{119A0}-\u{119A7}\u{119AA}-\u{119D0}\u{119E1}\u{119E3}\u{11A00}\u{11A0B}-\u{11A32}\u{11A3A}\u{11A50}\u{11A5C}-\u{11A89}\u{11A9D}\u{11AC0}-\u{11AF8}\u{11C00}-\u{11C08}\u{11C0A}-\u{11C2E}\u{11C40}\u{11C72}-\u{11C8F}\u{11D00}-\u{11D06}\u{11D08}\u{11D09}\u{11D0B}-\u{11D30}\u{11D46}\u{11D60}-\u{11D65}\u{11D67}\u{11D68}\u{11D6A}-\u{11D89}\u{11D98}\u{11EE0}-\u{11EF2}\u{11FB0}\u{12000}-\u{12399}\u{12480}-\u{12543}\u{13000}-\u{1342E}\u{14400}-\u{14646}\u{16800}-\u{16A38}\u{16A40}-\u{16A5E}\u{16AD0}-\u{16AED}\u{16B00}-\u{16B2F}\u{16B40}-\u{16B43}\u{16B63}-\u{16B77}\u{16B7D}-\u{16B8F}\u{16E40}-\u{16E7F}\u{16F00}-\u{16F4A}\u{16F50}\u{16F93}-\u{16F9F}\u{16FE0}\u{16FE1}\u{16FE3}\u{17000}-\u{187F7}\u{18800}-\u{18CD5}\u{18D00}-\u{18D08}\u{1B000}-\u{1B11E}\u{1B150}-\u{1B152}\u{1B164}-\u{1B167}\u{1B170}-\u{1B2FB}\u{1BC00}-\u{1BC6A}\u{1BC70}-\u{1BC7C}\u{1BC80}-\u{1BC88}\u{1BC90}-\u{1BC99}\u{1D400}-\u{1D454}\u{1D456}-\u{1D49C}\u{1D49E}\u{1D49F}\u{1D4A2}\u{1D4A5}\u{1D4A6}\u{1D4A9}-\u{1D4AC}\u{1D4AE}-\u{1D4B9}\u{1D4BB}\u{1D4BD}-\u{1D4C3}\u{1D4C5}-\u{1D505}\u{1D507}-\u{1D50A}\u{1D50D}-\u{1D514}\u{1D516}-\u{1D51C}\u{1D51E}-\u{1D539}\u{1D53B}-\u{1D53E}\u{1D540}-\u{1D544}\u{1D546}\u{1D54A}-\u{1D550}\u{1D552}-\u{1D6A5}\u{1D6A8}-\u{1D6C0}\u{1D6C2}-\u{1D6DA}\u{1D6DC}-\u{1D6FA}\u{1D6FC}-\u{1D714}\u{1D716}-\u{1D734}\u{1D736}-\u{1D74E}\u{1D750}-\u{1D76E}\u{1D770}-\u{1D788}\u{1D78A}-\u{1D7A8}\u{1D7AA}-\u{1D7C2}\u{1D7C4}-\u{1D7CB}\u{1E100}-\u{1E12C}\u{1E137}-\u{1E13D}\u{1E14E}\u{1E2C0}-\u{1E2EB}\u{1E800}-\u{1E8C4}\u{1E900}-\u{1E943}\u{1E94B}\u{1EE00}-\u{1EE03}\u{1EE05}-\u{1EE1F}\u{1EE21}\u{1EE22}\u{1EE24}\u{1EE27}\u{1EE29}-\u{1EE32}\u{1EE34}-\u{1EE37}\u{1EE39}\u{1EE3B}\u{1EE42}\u{1EE47}\u{1EE49}\u{1EE4B}\u{1EE4D}-\u{1EE4F}\u{1EE51}\u{1EE52}\u{1EE54}\u{1EE57}\u{1EE59}\u{1EE5B}\u{1EE5D}\u{1EE5F}\u{1EE61}\u{1EE62}\u{1EE64}\u{1EE67}-\u{1EE6A}\u{1EE6C}-\u{1EE72}\u{1EE74}-\u{1EE77}\u{1EE79}-\u{1EE7C}\u{1EE7E}\u{1EE80}-\u{1EE89}\u{1EE8B}-\u{1EE9B}\u{1EEA1}-\u{1EEA3}\u{1EEA5}-\u{1EEA9}\u{1EEAB}-\u{1EEBB}\u{20000}-\u{2A6DD}\u{2A700}-\u{2B734}\u{2B740}-\u{2B81D}\u{2B820}-\u{2CEA1}\u{2CEB0}-\u{2EBE0}\u{2F800}-\u{2FA1D}\u{30000}-\u{3134A}]/u),"^validation-rules.at-least-x-digits('1')":T.cX.patternMatch(/\d/)},validationRules:{"validation-rules.required":T.cX.required()}})),this._submit=new st.y3({$el:this.$('button[type="submit"]'),animationName:"signup"}),this.listenToOnce(this._username,"input",(()=>d.c.getInstance().sendEvent("create_login",{type:"phone"}))),this.listenToOnce(this._email,"input",(()=>d.c.getInstance().sendEvent("create_email",{type:"phone"}))),this.listenToOnce(this._password,"input",(()=>d.c.getInstance().sendEvent("create_password",{type:"phone"}))),this._form.add(this._email),this._form.add(this._username),this._form.add(this._password),this.listenTo(this._form,"submit",this._onSubmit),this.captcha.render(),this._grecaptchaV3=ht.K.getInstance(),this._grecaptchaV3.render(),this}focus(t=!1){const e=this._email;return e&&(t&&e.highlightFocus(),e.focus()),this}_fillUsernameWithEmail(){if(!this._username.isEmpty)return;const t=(e=this._email.value,(null!==(s=null===(i=/^[^@]*/.exec(e))||void 0===i?void 0:i[0])&&void 0!==s?s:"").replace(yt,".").replace(/\.+/g,".").replace(/^\./,"").replace(/\.$/,""));var e,s,i;t&&(this._username.value=t,this._username.checkValidity())}async _onSubmit(t,e){var s,n;if(t&&At.isFunction(t.preventDefault)&&t.preventDefault(),this.isLockForm||this._submit.animation)return;if(this.marks.has("last-submit")&&Date.now()-this.marks.get("last-submit")<1500)return;let o=Date.now();if(this.marks.set("last-submit",o),this.setErrorMessage(),!(await e.checkValidity()))return;if(!(await this.captcha.getToken("registration")))return;let r,a=this._form.serialize();if(a["g-recaptcha-response"]=this.captcha.lastToken,!a["g-recaptcha-response"])return void this.setErrorMessage(i.vE.i18n("auth.up.errors.captcha"));this._grecaptchaV3.lastTokenV3||await this._grecaptchaV3.getTokenV3(),a["g-recaptcha-response-v3"]=this._grecaptchaV3.lastTokenV3,this._submit.animation=!0,r=this._phone?u.User.registerInit(a):u.User.registerSubmit(a);const{response:l,data:h}=await r,p=void 0===(null==h?void 0:h.score)?-1:h.score;if(d.c.getInstance().sendEvent("create_account",{type:"phone",login:this._username.value,email:this._email.value,phone:(null===(s=this._phone)||void 0===s?void 0:s.value)||"",rec_score:p},[lt.b.CLICKHOUSE]),d.c.getInstance().google.event("submit","register"),d.c.getInstance().yandex.goal("create_account",{type:"phone"}),await c.cQ.delay(1e3-(Date.now()-o)),l.result){if(!this._phone)return void(await this._finishSignup(a,p));if(h.register_id&&await this._inputConfirmation(h.register_id))return void(await this._finishSignup(a,p))}switch(h&&h.param||""){case"username":this._username.setCustomValidity(l.message);break;case"password":this._password.setCustomValidity(l.message);break;case"phone":null===(n=this._phone)||void 0===n||n.setCustomValidity(l.message);break;case"email":this._email.setCustomValidity(l.message);break;default:l.message&&this.setErrorMessage(l.message)}this.captcha.reset(),this._submit.animation=!1}get isLockForm(){return this._options.isLockForm}set isLockForm(t){if(this._options.isLockForm!==(t=Boolean(t)))if(this._options.isLockForm=t,this.cancelInterval("lock-form"),t){let t=60;this._submit.disabled=!0,this.interval("lock-form",1e3,(()=>{--t?this.setErrorMessage(i.vE.i18n("auth.up.errors.confirm-limit",t)):this.isLockForm=!1}))}else this.setErrorMessage(!1),this._submit.disabled=!1}async _finishSignup(t,e){var s;d.c.getInstance().sendEvent("approve_phone",{type:"phone",email:this._email.value,login:this._username.value,phone:(null===(s=this._phone)||void 0===s?void 0:s.value)||"",rec_score:e},[lt.b.CLICKHOUSE]),d.c.getInstance().yandex.goal("approve_phone",{type:"phone"}),this.storePassCredentials(t.username,t.password),i.vE.initParams.experimentRegOnComment&&"story"===i.vE.initParams.pageName?i.vE.emit("success-signup-not-confirmed"):(c.mM.set(Ot.y,!0),c.cQ.delay(1e3).then((()=>{window.location.reload()})))}}var Pt=s(6885),Rt=s(425);function Mt(t,e){var s=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),s.push.apply(s,i)}return s}function Nt(t){for(var e=1;e<arguments.length;e++){var s=null!=arguments[e]?arguments[e]:{};e%2?Mt(Object(s),!0).forEach((function(e){Bt(t,e,s[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(s)):Mt(Object(s)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(s,e))}))}return t}function Bt(t,e,s){return e in t?Object.defineProperty(t,e,{value:s,enumerable:!0,configurable:!0,writable:!0}):t[e]=s,t}const Lt=s(6419),Ft=s(9755);class Ut extends ut{render(){if(this.isRendered)return this;super.render();const t={validationEvent:T.km.MANUAL,validationHint:{direction:k.Lh.LEFT,alignment:k.SE.CENTER},sanitizerRules:[mt.o.trim()],addSuccessState:!0},e={onValidityErrorMessage:(t,{input:e})=>{this._sendAnalytics(t,{input:e})}};return this._passwordComplexity=void 0,this._contact=new T.u3(Lt.defaults({$el:this.$('input[name="contact"]').parent()},Nt(Nt({},t),e))),this._submit=new st.y3(this.$('button[type="submit"]')),this._contact.validationRules.set("auth.up.errors.format",(t=>{const e=this._preparePhone(t);return Pt.E.test(e)||Rt.c.email(!0)(t)})),this._form=new a.x(this.$els.form),this._form.add(this._contact),this.listenTo(this._form,"submit",this._onSubmit),this.listenToOnce(this._contact,"input",this._onInputContact),this.captcha.render(),this}_preparePhone(t){let e=String(t).replace(/[\s()-]/g,"");return Pt.E.test(e)?c.cQ.preparePhone(e):t}_inputConfirmation(t){let e=3;return new Promise((s=>{let o=new k.LD({destroyAfterHide:!0,indent:!0,minWidth:500,header:i.vE.i18n("auth.up.confirm.header"),content:'<form method="POST" action="javascript: void(0);" novalidate>\n\t<div class="auth__field">\n\t\t<div class="input input_box" data-type="confirm">\n\t\t\t<div class="input__box">\n\t\t\t\t<input class="input__input" type="text" autocomplete="off" name="confirm" required minlength="4" maxlength="4" placeholder="Код из SMS">\n\t\t\t</div>\n\t\t</div>\n\t</div>\n\t<div class="auth__field">\n\t\t<div class="input input_box" data-type="password">\n\t\t<span class="input__box">\n\t\t\t<input class="input__input" type="password" data-role="password" name="password" autocomplete="new-password" required minlength="\' . UserAuth::LIMIT_MIN_PASSWORD_LENGTH . \'" maxlength="160" placeholder="Пароль">\n\t\t</span>\n\t\t\t<span class="input__complexity"></span>\n\t\t</div>\n\t</div>\n\t<div class="auth__field">\n\t\t<div class="input input_box" data-type="password2">\n\t\t<span class="input__box">\n\t\t\t<input class="input__input" type="password" data-role="password" name="password2" autocomplete="new-password" required minlength="\' . UserAuth::LIMIT_MIN_PASSWORD_LENGTH . \'" maxlength="160" placeholder="Пароль еще раз">\n\t\t</span>\n\t\t</div>\n\t</div>\n\t<div class="auth__field"><span class="auth__error"></span></div>\n</form>',autoClosePressEscape:!1,autoCloseOutsideClick:!1}),r={validationEvent:T.km.BLUR,validationHint:{direction:k.Lh.LEFT,alignment:k.SE.CENTER},sanitizerRules:[mt.o.trim()],addSuccessState:!0},l=new T.u3(Lt.defaults({$el:o.content.find('.input_box[data-type="confirm"]')},r));l.sanitizerRules=[mt.o.trim(),mt.o.whitelist("0-9")];let h=new T.u3(Lt.defaults({$el:o.content.find('.input_box[data-type="password"]')},r));h.$els.complexity=h.$els.box.next(".input__complexity"),h.validationRules={"auth.up.errors.password-short":Rt.c.isLength(4),"auth.up.errors.password-week":()=>c.YV.test(h.value)>c.eU.WEEK},this.listenTo(h,"input",Lt.throttle((()=>{const t=c.YV.test(h.value);t!==this._passwordComplexity&&(this._passwordComplexity&&h.$els.complexity.removeClass("input__complexity_"+this._passwordComplexity.toString().toLowerCase()),this._passwordComplexity=t,h.$els.complexity.addClass("input__complexity_"+this._passwordComplexity.toString().toLowerCase()))}),200));let d=new T.u3(Lt.defaults({$el:o.content.find('.input_box[data-type="password2"]')},r));d.validationRules.set("auth.up.errors.password-mismatch",(t=>h.value.trim()===t.trim()));let p=new a.x(o.content.find("form"));p.$els.error=p.$el.find(".auth__error"),p.add(l),p.add(h),p.add(d),this.listenTo(p,"submit",this._onSubmit),o.on(n.eM.UNMOUNTED,(()=>{s(!1)}));let m=t=>{let e=Boolean(t);p.$els.error?p.$els.error.toggle(e).html(t||""):e&&(i.vE.emit("error-auth-toast"),i.vE.ui.toasts.showError(t))},_=new st.y3({title:i.vE.i18n("auth.up.confirm.button"),theme:st.jM.SUCCESS}),g=async()=>{if(_.progress)return;if(_.progress||!(await p.checkValidity()))return;_.progress=!0;let n=Date.now(),r=await u.User.restorePasswordConfirm(t||"",l.value,h.value);await c.cQ.delay(1e3-(Date.now()-n)),r.response.result?(o.hide(),s(!0)):--e?r.data&&"code"===r.data.type?(l.value="",l.setCustomValidity(r.response.message)):r.data&&"password"===r.data.type?(h.value="",d.value="",h.setCustomValidity(r.response.message)):m(r.response.message):(m(i.vE.i18n("auth.up.errors.confirm-limit",60)),this.isLockForm=!0,s(!1),o.hide()),_.progress=!1};o.content.find("form").on("submit",(t=>{t.preventDefault(),g()})),this.listenTo(_,"click",g),o.addCustomIntoFooter(_.show().$el),o.addCloseButtonIntoFooter(),o.addCustomIntoFooter(Ft((0,rt.Z)(t))),i.vE.ui.hotkeys.once("enter",(()=>{g()}),{closest:o.$el,context:o,type:it.FM.KEYDOWN}),o.show(),setTimeout((()=>{l.focus()}),100)}))}async _onSubmit(t,e){if(t&&Lt.isFunction(t.preventDefault)&&t.preventDefault(),this.setErrorMessage(),!(await e.checkValidity()))return;if(!(await this.captcha.getToken("restore")))return;this._submit.progress=!0,this._submit.disabled=!0;const s=e.serialize();if(s.contact=this._preparePhone(s.contact),d.c.getInstance().sendEvent("click",{type:"account_recovery_send",email:this._contact.value}),s["g-recaptcha-response"]=this.captcha.lastToken,s["g-recaptcha-response"]){try{const t=await u.User.restorePassword(s);"phone"===t.type&&t.session_id?await this._inputConfirmation(t.session_id)&&(i.vE.emit("success-auth-toast"),i.vE.ui.toasts.add({content:i.vE.i18n("auth.forget.changed")})):(i.vE.emit("error-auth-toast"),i.vE.ui.toasts.add({content:i.vE.i18n("auth.forget.success-email")})),i.vE.ui.auth&&i.vE.ui.auth.changeTab("signin"),this._submit.progress=!1}catch(n){this.setErrorMessage(n.message||i.vE.i18n("auth.forget.failure")),d.c.getInstance().sendEvent("error_occurred",{type_i8:4,type:"no_user"}),this._submit.progress=!1,this._submit.disabled=!1}this.captcha.reset()}else this.setErrorMessage(i.vE.i18n("auth.up.errors.captcha"))}_onInputContact(){d.c.getInstance().sendEvent("input_start",{type:"account_recovery_email_or_phone"})}}const jt=s(6419);class Vt extends ut{render(){if(this.isRendered)return this;super.render();let t={validationEvent:T.km.BLUR,validationHint:{direction:k.Lh.LEFT,alignment:k.SE.CENTER},sanitizerRules:[T.op.trim()],addSuccessState:!0,onValidityErrorMessage:(t,{input:e})=>{this._sendAnalytics(t,{input:e})}};return this._username=new T.u3(jt.defaults({$el:this.$('input[name="username"]').parent()},t)),this._username.validationRules={"auth.up.errors.username-short":T.cX.isLength(3),"auth.up.errors.username-long":[T.cX.isLength(0,16)],"auth.up.errors.username-whitelist":T.cX.patternMatch(/^([A-Za-z0-9.]*)$/),"auth.up.errors.username-last-dot":T.cX.patternMatch(/[^.]$/),"auth.up.errors.username-first-dot":T.cX.patternMatch(/^[^.]/),"auth.up.errors.username-many-dot":t=>(t.match(/\./g)||[]).length<2,"auth.up.errors.username-busy":async t=>{const e=await this._checkUserAvailable(t);return!e&&this._availableNames&&Array.isArray(this._availableNames)&&this._availableNames.length>0?(this._showAvailableUserNames(),!1):(this._availableNames&&0===this._availableNames.length&&this.$els.availableNames&&this.$els.availableNames.remove(),e)}},this._username.preventInvalidInput({"auth.up.errors.username-whitelist":/[^a-z0-9.]/gi}),this._submit=new st.y3({$el:this.$('button[type="submit"]'),animationName:"signup"}),this._type=this.$(".social-icon").data("type"),this._form=new a.x(this.$els.form),this._form.add(this._username),this.captcha.render(),ht.K.getInstance().render(),this.listenTo(this._form,"submit",this._onSubmit),this}async _onSubmit(t,e){t&&jt.isFunction(t.preventDefault)&&t.preventDefault(),d.c.getInstance().google.event("submit","register");const s=await ht.K.getInstance().getScore("create_account");if(d.c.getInstance().sendEvent("create_account",{type:this._type,login:this._username.value,rec_score:s},[lt.b.CLICKHOUSE]),d.c.getInstance().yandex.goal("create_account",{type:this._type}),this._submit.animation)return;if(this.marks.has("last-submit")&&Date.now()-this.marks.get("last-submit")<1500)return;let n=Date.now();if(this.marks.set("last-submit",n),this.setErrorMessage(),!(await e.checkValidity()))return;if(!(await this.captcha.getToken("registration")))return;const o=e.serialize();this._submit.animation=!0;let r=!1;try{const t=this.captcha.lastToken;if(!t)return void this.setErrorMessage(i.vE.i18n("auth.up.errors.captcha"));if(r=await u.User.registerOAuth(this._username.value,t),r){const t=await ht.K.getInstance().getScore("approve_phone");if(d.c.getInstance().sendEvent("approve_phone",{type:"phone",email:o.email,login:o.username,phone:o.phone,rec_score:t},[lt.b.CLICKHOUSE]),d.c.getInstance().yandex.goal("approve_phone",{type:"phone"}),c.eR.set(u.USER_SIGNUP_COOKIE_KEY,1,{expires:365}),i.vE.initParams.experimentRegOnComment&&"story"===i.vE.initParams.pageName)return void i.vE.emit("success-user-confirmed");c.cQ.delay(1e3).then((()=>{window.location.reload()}))}}catch(a){if("username"===a.param)this._username.setCustomValidity(a.message);else this.setErrorMessage(a.message)}this._submit.animation=!1}}const Ht=s(9755);class qt extends n.u1{render(){return this.isRendered||(this.$els={signup:this.$('.tabs__tab[data-id="signup"]'),signin:this.$('.tabs__tab[data-id="signin"]'),forget:this.$('.tabs__tab[data-id="forget"]'),oauth:this.$('.tabs__tab[data-id="oauth"]'),hintForget:this.$('div[data-hint-for="forget"]')},this.$els.oauth.length?this._oauth=new Vt(this.$els.oauth):this.$els.signin.length&&(this._signin=new ft(this.$els.signin)),this._tabs=new et.F(this.$el),this.listenTo(this._tabs,"change",this._onChangeTab),this.$el.on("click",'.auth__action[data-role="route"], .auth__forget',this._onClickRoute.bind(this)),this.$('.auth__action[data-role="cancel"]').on("click",u.User.logout),i.vE.ui.$els.document.on("click",".to-signin",(async t=>{t.preventDefault(),d.c.getInstance().sendEvent("click",{type:"auth_reg_form_authorize"}),await this._signin.autoSignIn()&&Boolean(navigator.credentials)||this.scrollToAuth()})),i.vE.ui.$els.document.on("click",".to-signup",(t=>{t.preventDefault(),"welcome"===t.target.dataset.type&&d.c.getInstance().sendEvent("reg_notification_click",{type:"welcome"}),this.scrollToAuth(!0),d.c.getInstance().sendEvent("click",{type:"auth_reg_form_register"})})),this.$el.on("click",'.auth__action[data-to="signup"]',(async()=>{d.c.getInstance().sendEvent("click_registration",{type:"phone"})})),this.$el.on("click",".auth__footer > .social-icon",(async t=>{t.preventDefault();const e=t.currentTarget,s=e.dataset.type,n="signin"===this._tabs.currentTab?"authorization":"click_registration",o=await ht.K.getInstance().getScore(n);if(d.c.getInstance().sendEvent(n,{type:s,rec_score:o}),i.vE.initParams.experimentRegOnComment&&i.vE.emit("oauth-begin"),await c.cQ.delay(500),i.vE.initParams.experimentRegOnComment){const t=c.mM.get("pkb_cfc");t&&i.vE.history.replaceState({},"",i.vE.history.location.origin+i.vE.history.location.pathname+`?cid=${t.parent_id}`,!1)}window.location.href=e.getAttribute("href")})),super.render()),this}scrollToAuth(t=!1){return i.vE.isUserAuthorized||(this._tabs.currentTab=t?"signup":"signin",queueMicrotask((()=>{i.vE.ui.scrollTo(i.vE.ui.sidebar.$el.offset().top,!0)})),this.timeout("focus",300,(()=>{t?this._signup.focus(!0):this._signin.focus(!0)}))),this}_onChangeTab(t){switch(t){case"signup":this.$els.signup.length&&!this._signup&&(this._signup=new Dt(this.$els.signup)),this._signup.focus();break;case"forget":this.$els.forget.length&&!this._forget&&(d.c.getInstance().sendEvent("click",{type:"account_recovery_start"}),this._forget=new Ut(this.$els.forget)),this._forget.focus();break;case"oauth":this.$els.oauth.length&&!this._oauth&&(this._oauth=new Vt(this.$els.oauth)),this._oauth.focus();break;case"signin":this.$els.signin.length&&!this._signin&&(this._signin=new ft(this.$els.signin)),this._signin.focus()}return this.$els.hintForget.toggle("forget"===t),this}_onClickRoute(t){let e=Ht(t.target).closest(".auth__action, .auth__forget");return this._tabs.currentTab=e.data("to"),this}changeTab(t){this._tabs.currentTab=t}}const Wt=s(6419);class Gt extends ut{constructor(t){super(t),this._passwordComplexity=void 0}render(){if(this.isRendered)return this;i.vE.ui.screen=lt.d.RESTORE,super.render();let t={validationEvent:T.km.BLUR,validationHint:{direction:k.Lh.LEFT,alignment:k.SE.CENTER},sanitizerRules:[mt.o.trim()],addSuccessState:!0,onValidityErrorMessage:(t,{input:e})=>{this._sendAnalytics(t,{input:e})}};return this.$els.complexity=this.$(".input__complexity"),this._password=new T.u3(Wt.defaults({$el:this.$('input[data-role="password"]').parent().parent()},t)),this._password.validationRules={"auth.up.errors.password-short":Rt.c.isLength(4),"auth.up.errors.password-week":()=>c.YV.test(this._password.value)>c.eU.WEEK},this._passwordRepeat=new T.u3(Wt.defaults({$el:this.$('input[data-role="password-repeat"]').parent()},t)),this._passwordRepeat.validationRules={"auth.up.errors.password-mismatch":()=>this._passwordRepeat.value===this._password.value},this.listenTo(this._password,"blur",(()=>{document.activeElement!==this._passwordRepeat.els.input&&Boolean(this._passwordRepeat.value)&&this._passwordRepeat.checkValidity()})),this.listenTo(this._password,"input",Wt.debounce((()=>{Boolean(this._passwordRepeat.value)&&this._passwordRepeat.checkValidity({showValidationHint:!1})}),200)),this.listenTo(this._password,"input",Wt.throttle((()=>{this._setPasswordComplexity(c.YV.test(this._password.value))}),200)),this._submit=new st.y3({$el:this.$('button[type="submit"]')}),this._form.add(this._passwordRepeat),this._form.add(this._password),this.listenTo(this._form,"submit",this._onSubmit),this.listenToOnce(this._password,"input",this._onPasswordInput),this.listenToOnce(this._passwordRepeat,"input",this._onPasswordRepeatInput),this}_setPasswordComplexity(t){t!==this._passwordComplexity&&(this._passwordComplexity&&this.$els.complexity.removeClass("input__complexity_"+this._passwordComplexity.toString().toLowerCase()),this._passwordComplexity=t,this.$els.complexity.addClass("input__complexity_"+this._passwordComplexity.toString().toLowerCase()))}async _onSubmit(t,e){if(t&&Wt.isFunction(t.preventDefault)&&t.preventDefault(),this._submit.progress)return;if(this.setErrorMessage(),!(await e.checkValidity()))return;d.c.getInstance().sendEvent("click",{type:"account_recovery_password_update",login:this._login}),this._submit.progress=!0,this._submit.disabled=!0;let s=this._form.serialize(),n=this.$el.data("params");n=Wt.isEmpty(n)?{}:n,n.action="set_password",n.p=s.restore_passwd1;try{await u.User.restorePassword(n),i.vE.ui.toasts.add({content:i.vE.i18n("auth.forget.changed")}),this._submit.progress=!1,setTimeout((()=>{window.location.href="/"}),2e3)}catch(o){this.setErrorMessage(o.message||i.vE.i18n("auth.forget.failure")),this._submit.progress=!1,this._submit.disabled=!1}}_onPasswordInput(){this._login=this.$el.find('[data-role="user-name"]').text(),d.c.getInstance().sendEvent("input_start",{type:"account_recovery_password_1",login:this._login})}_onPasswordRepeatInput(){this._login||(this._login=this.$el.find('[data-role="user-name"]').text()),d.c.getInstance().sendEvent("input_start",{type:"account_recovery_password_2",login:this._login})}}var Yt=s(8638);class zt extends Yt.i{constructor(){super({startupAnimationDuration:100,skipImageStartupAnim:!0,showImageBackground:!0,showScrollArrows:!0,closeByClick:!0,useHistoryState:!1,showLargeImageLoader:!0,showHelpButton:!0})}}let Zt,Kt;!function(t){t.STUCK_TO_TOP="stuckToTop",t.STUCK_TO_BOTTOM="stuckToBottom",t.STATIC="static"}(Zt||(Zt={})),function(t){t.UP="up",t.DOWN="down"}(Kt||(Kt={}));var Xt=s(7591);var Qt=s(4644),Jt=s(4877),te=s(9755),ee=s.n(te);function se(t,e,s){return e in t?Object.defineProperty(t,e,{value:s,enumerable:!0,configurable:!0,writable:!0}):t[e]=s,t}class ie extends Jt.u{constructor(t){super(t),se(this,"mentionsCountsMap",{comment:0,comment_reply:0,feedback:0,story:0}),se(this,"$els",{}),se(this,"totalUnreadMentionsCount",0),this.init(),this.render()}reduceAllCountByType(t){if(""===t)return Object.keys(this.mentionsCountsMap).forEach((t=>{this.mentionsCountsMap[t]=0})),void this.reduceCountBy(this.totalUnreadMentionsCount);const e=this.mentionsCountsMap[t];void 0!==e&&(this.reduceCountBy(e),this.mentionsCountsMap[t]=0)}getTotalUnreadMentionsCount(){return this.totalUnreadMentionsCount}getMentionsCountsMap(){return this.mentionsCountsMap}decrementMentionsByType(t){if(""===t)return;const e=this.mentionsCountsMap[t];void 0!==e&&(this.mentionsCountsMap[t]=e-1,this.reduceCountBy(1))}reduceCountBy(t){if(0===this.totalUnreadMentionsCount)return;const e=this.totalUnreadMentionsCount-t;if(e<=0)return this.$els.bell.hide(),void(this.totalUnreadMentionsCount=0);e<=99&&this.$els.bell.text(e),this.totalUnreadMentionsCount=e}init(){const t=i.vE.config("modules.new-reputation-mentions")||this.mentionsCountsMap;for(const[e,s]of Object.entries(t))this.mentionsCountsMap[e]=Number(s);this.initTotalUnreadMentions()}initTotalUnreadMentions(){this.totalUnreadMentionsCount=Object.values(this.mentionsCountsMap).reduce(((t,e)=>t+e),0),this.$els.bell=ee()(".bell_profile-menu")}}var ne=s(1033),oe=s(6349);class re{constructor(){document.querySelectorAll('[data-role="account-confirm"] .hint').forEach((t=>{t.onmouseenter=t.onclick=()=>{oe.cp.getInstance().sendEvent("tooltip_popup",{type:"simplified_account_info"})}}))}}const ae=s(9755),le=(s(6419),"adfox_300x600_fix");class he{constructor(t){var e,s,n;n=!1,(s="_isStickyAdScrolled")in(e=this)?Object.defineProperty(e,s,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[s]=n,this.ui=t,this._sidebarMarginTop=i.vE.ui.css.margin,this._options={},this.$el=ae(".sidebar"),this.el=this.$el.get(0),this.$els={pageMain:ae(".main"),inner:this.$(".sidebar__inner"),accounts:this.$(".sidebar-block__account"),emailForm:this.$(".email-block"),reputationMenuItem:this.$('.menu__item[data-role="reputation"]'),top50Comments:this.$('a[data-type="top-comments"]'),dailyTopComment:this.$(".sidebar-comment-day"),hotCommunities:this.$(".communities-list"),hotTags:this.$('.sidebar-block[data-type="popular-tags"]'),messengersLinks:this.$(".messengers-widget"),footerLinks:this.$(".sidebar-block-links > .sidebar-block__content"),footerSocials:this.$(".sidebar-block-links > .sidebar-block-links__footer"),recommendedCommunity:this.$('.sidebar-block[data-type="recommended"]')},this.els={pageMain:this.$els.pageMain.get(0),inner:this.$els.inner.get(0),footer:this.$(".sidebar-footer").get(0),stickyAd:this.$(`#${le}`).get(0),stickyAdWrapper:this.$(".sidebar-sticky-wrapper").get(0),recommendedCommunity:this.$els.recommendedCommunity.get(0)},this.$els.emailForm.length&&(this._subscriptionForm=new Qt.o({$el:this.$els.emailForm,formClass:a.x,inputClass:T.u3,type:"sidebar_right"})),this.ui.on("resize",this._resizeSidebar.bind(this)),this._resizeSidebar(),i.vE.deviceType===Xt.me.DESKTOP&&(this._onScroll(),this.ui.on("document-scroll",(()=>this._onScroll())),this._resizeObserver=new ne.Z((()=>this._onScroll(!0))),this._resizeObserver.observe(this.el));let o=i.vE.config("modules.sidebar-cookie");o&&(this.$els.cookie=ae(function(t){var e,s="";return s+'<a class="sidebar-cookie hint" href="'+(null==(e=t.story_url)?"":e)+'" aria-label="'+(null==(e=t.hint)?"":e)+'" data-direction="top">\n\t<img src="'+(null==(e=t.image_url)?"":e)+'" alt="'+(null==(e=t.hint)?"":e)+'">\n</a>'}(o)).appendTo(this.$el)),this.$el.find('.social-icon[data-type="telegram"]').on("click",(()=>{d.c.getInstance().yandex.goal("tap_telegram_pk")})),this.$el.find(".sidebar-block_humor").on("click",(()=>{d.c.getInstance().sendEvent("click",{type:"humor_feed"})})),this.$el.find(".button_create-community").on("click",(t=>{if(!i.vE.isUserAuthorized)return t.preventDefault(),void i.vE.ui.authRequired();d.c.getInstance().sendEvent("click",{type:"community_create"})})),this.$el.find('.sidebar-block[data-type="recommended"] a[data-role="link"]').on("click",(t=>{const e=t.currentTarget.dataset.id;d.c.getInstance().sendEvent("recommended_community_interaction",{community_id:e})})),this.$el.find('.sidebar-block[data-type="recommended"] .button-group[data-role="subscribe"]').one("click",(t=>{const e=t.currentTarget.dataset.id;d.c.getInstance().sendEvent("recommended_community_interaction",{community_id:e})})),this.$el.find(".communities-links__community").on("mousedown",(t=>{const e=t.currentTarget,s=e.classList.contains("communities-links__community"),i=s?"transition_to_community":"transition_to_author",n=s?"community_id!empty":"author_id!empty";d.c.getInstance().sendEvent(i,{type:"sidebar_subs",screen_index:ae(t.currentTarget).index()+1,[n]:e.dataset.id})})),this.$el.find(".sidebar-block__achievements a").on("click",(()=>{d.c.getInstance().sendEvent("click",{type:"sidebar_gamification"})})),this._initDiscussed(),this._initReputationMonitoringMenuItem(),this.$els.accounts.length&&this._initAccountButtons(),this._initReadMoreButtons(),this._initAnalytics()}_initReadMoreButtons(){const t=this.el.querySelectorAll(".community-info-block-long");t.length&&t.forEach((t=>{const e=t.parentElement.querySelector(".community-info-block__read-more");e.addEventListener("click",(()=>{t.classList.remove("community-info-block-long"),e.remove()}),{once:!0})}))}_initAnalytics(){const{top50Comments:t,dailyTopComment:e}=this.$els,s="click auxclick",i=d.c.getInstance(),n=(t,e)=>i.sendEvent(t,e);if(t.on(s,n.bind(null,"click",{type:"top_comment"})),e.length){const t="sidebar_top_comment",i=e.find(".comment__user");i.on(s,n.bind(null,"transition_to_author",{type:t,author_id:Number(i.data("id"))})),e.find(".comment__link a").on(s,n.bind(null,"transition_to_post",{type:t})),e.find('.comment__tool[data-role="link"]').on(s,n.bind(null,"share_to_social_network",{type:t}))}this.$els.hotCommunities.on(s,".community__title",(({target:t})=>{const e=t.dataset.id;e&&i.sendEvent("transition_to_community",{type:"sidebar_active",community_id:e})})),this.$els.hotTags.on(s,".tags__tag",(({target:t})=>{var e;const s=null===(e=t.firstChild.textContent)||void 0===e?void 0:e.trim();s&&i.sendEvent("transition_to_tag",{type:"sidebar_tranding",tag_id:s})})),this.$els.footerLinks.on(s,"a",(({target:t})=>{const e=t.dataset.name;e&&i.sendEvent("click",{type:"sidebar_"+e})})),this.$els.footerSocials.on(s,"a",(({target:t})=>{const e=t.href;e&&i.sendEvent("click_external_link",{type:"sidebar_socials",link:e})})),this.$els.messengersLinks.on(s,"a",(({target:t})=>{const e=t.href;e&&i.sendEvent("click_external_link",{type:"sidebar_messengers",link:e})})),this.$els.recommendedCommunity.on(s,'a[data-role="link"]',(({target:t})=>{const e=t.dataset.id;e&&i.sendEvent("transition_to_community",{type:"sidebar_recommend",community_id:e})})),new re}_initReputationMonitoringMenuItem(){this.$els.reputationMenuItem.length&&(this.reputationMonitoringMenuItem=new ie({$el:this.$els.reputationMenuItem}))}_initDiscussed(){i.vE.ui.$els.document.on("click",'.sidebar-block-discussed button[data-role="remove"]',(async t=>{let e=t.currentTarget.getAttribute("data-story-id"),s=ae(t.currentTarget.closest(".sidebar-block-discussed")),{response:i}=await S.cf.post("/ajax/stories_actions.php",{action:"hide_discussed_story",story_id:e});i.result&&s.fadeOut((()=>{s.parent().find(".sidebar-block-discussed:visible").length||s.closest(".sidebar-block").remove()}))}))}_initAccountButtons(){this.$els.accounts.on("click",(async t=>{let e=ae(t.currentTarget);if(e.hasClass("sidebar-block__account_active"))return;let s=e.data("id"),{response:n}=await S.cf.post("/ajax/login_actions.php",{action:"login_as",user_id:s});n.result?window.location.reload():i.vE.ui.toasts.showError(n.message)}))}refresh(){return this._resizeSidebar(),this}empty(){this.$els.inner.empty()}append(t){this.$els.inner.append(t)}_resizeSidebar(){this.$els.inner.css("width",this.$el.width()),this._onScroll(!0)}_onScroll(t=!1){this._onScrollStart();if(this._scrollState!==this._lastScrollState||t)switch(this._scrollState){case Zt.STUCK_TO_TOP:this.el.style.position="sticky",this.el.style.top="0";break;case Zt.STUCK_TO_BOTTOM:this.el.style.position="sticky",this.el.style.top=`calc(100vh - ${this.el.offsetHeight+this._getOffset()}px)`;break;case Zt.STATIC:const t=this.$els.pageMain.get(0),e=Math.min(this.el.offsetTop,this._scrollTop)-t.offsetTop,s=Math.max(e,0);this.el.style.position="relative",this.el.style.top=`${s}px`}this._updateStickyAdPosition(),this._onScrollEnd()}_onScrollStart(){this._scrollTop=this.ui.scrollTop,this._scrollDirection=this._lastScrollTop>this._scrollTop?Kt.UP:Kt.DOWN,this._scrollState=this._getScrollState()}_onScrollEnd(){this._lastScrollTop=this._scrollTop,this._lastScrollDirection=this._scrollDirection,this._lastScrollState=this._scrollState}_getScrollState(){const t=this.el.offsetTop+this.el.offsetHeight+this._getOffset(),e=this.el.offsetTop>=this._scrollTop,s=t<=this._scrollTop+this.ui.windowHeight;return e&&s||this._scrollDirection===Kt.UP&&e?Zt.STUCK_TO_TOP:this._scrollDirection===Kt.DOWN&&s?Zt.STUCK_TO_BOTTOM:this._scrollDirection!==this._lastScrollDirection?Zt.STATIC:this._lastScrollState}_getOffset(){var t,e;if(null===(t=this.els.footer)||void 0===t||!t.isConnected)return 0;const s=this.els.footer.offsetHeight+this._sidebarMarginTop;if(null!==(e=this.els.stickyAd)&&void 0!==e&&e.isConnected){const t=this.els.stickyAd.offsetHeight+this._sidebarMarginTop;return this.ui.windowHeight-s-t}return this.ui.windowHeight-s}_updateStickyAdPosition(){var t;if(null===(t=this.els.stickyAd)||void 0===t||!t.isConnected)return;const e=this.els.inner.getBoundingClientRect(),s=this.els.stickyAd.offsetHeight||0,i=this._scrollTop+e.bottom,n=i-s,o=this.ui.windowHeight;let r=0;const a=this._getFeedAdsBlocks();if(!a.length)return this.els.stickyAdWrapper.style.setProperty("--shift",r+"px"),void this.els.stickyAdWrapper.style.setProperty("--height",s+"px");let l=0,h=document.body.scrollHeight;for(let g=0;g<a.length;g++){const t=a[g],e=t.offsetTop,s=e+t.offsetHeight;if(s<n){l=s;break}h=e}const c=h-i,d=n-l,u=Math.max(o-c,0),p=Math.max(o-d,0);u&&(r=u),p&&(r=-p),this.els.stickyAdWrapper.style.setProperty("--shift",r+"px"),this.els.stickyAdWrapper.style.setProperty("--height",s+"px");const m=r>i-this._scrollTop,_=m&&!this._isStickyAdScrolled;this._isStickyAdScrolled=m,_&&this._reloadStickyAd()}_getFeedAdsBlocks(){return[...this.els.pageMain.querySelectorAll("[id^=adfox_feed]")].map((t=>t.closest(".story"))).filter(Boolean).reverse()}_reloadStickyAd(){var t,e;null===(t=window.Ya)||void 0===t||null===(e=t.adfoxCode)||void 0===e||e.reload(le),V.Q.instance.watch(this.els.stickyAdWrapper.querySelector(".sidebar-block_sticky"),H.L.RIGHT_LAST)}$(t){return this.$el.find(t)}get maxWidth(){return this._options.width}set maxWidth(t){this._options.width!==(t=Number(t))&&(this._options.width=t,this.$el.css("max-width",t||""),this._resizeSidebar())}}var ce=s(4143),de=s(9050);const ue=s(9755);class pe extends n.u1{constructor(t){super(t),this.listenTo(i.vE.ui,"document-scroll",this._scrollHandler)}render(){return this.isRendered||(this.$el=ue(document.createElement("div")).addClass("scroll-up-button").on("click",de.debounce(this._onClick.bind(this),250,!0)).append(i.vE.icon("scroll-up-button__arrow")),this.listenTo(i.vE,"scroll-up-button:reset",(()=>{this.isPossibleBack=!1,this._scrollHandler(i.vE.ui.scrollTop)})),super.render()),this}async _onClick(){this.marks.set("scrolling",!0),this.isPossibleBack?(await i.vE.ui.scrollTo(this.marks.get("last-scroll-top"),!0),this.isPossibleBack=!1):(this.isPossibleBack=!0,await i.vE.ui.scrollTo(0,!0)),this._scrollHandler(i.vE.ui.scrollTop),this.marks.delete("scrolling")}_scrollHandler(t){if(this.marks.has("scrolling"))return;let e=this.isPossibleBack,s=this.isShown;t>80?s||this.show():e||this.hide(),this.isRendered&&this.$el.toggleClass("scroll-up-button_contrast",t<70)}get isPossibleBack(){return this._options.isPossibleBack}set isPossibleBack(t){this._options.isPossibleBack!==(t=Boolean(t))&&(this._options.isPossibleBack=t,this.$el.toggleClass("scroll-up-button_active",t),t?this.marks.set("last-scroll-top",i.vE.ui.scrollTop):this.marks.delete("last-scroll-top"))}}var me=s(1433),_e=s(125),ge=s(566);const ve=s(9755);class fe extends O.vp{constructor(t){return super(),this.$el=r.Zv.isHTMLElement(t)?ve(t):t,this.$els={controls:ve('<div class="background__upload">\n\t<span class="attach">изменить фон</span>\n\t<span>убрать фон</span>\n</div>')},this._forbidden=this.$el.data("forbidden"),this._communityId=this.$el.data("community-id")||0,this._isCommunity=this.$el.data("is-community"),this.render(),this}render(){this.$el.attr("data-inited",!0),this.$els.controls.appendTo(this.$el),this.$els.controls.find("span:first-child").click((()=>{this._createModal(),this._modal.show()})),this.$els.controls.find("span:last-child").on("click",(async()=>{try{this._communityId?await new me.S1(this._communityId).dropBackground():this._isCommunity||await u.User.dropBackground(),this.$el.attr("data-default","true").find(".background__placeholder").css("background-image","")}catch(t){i.vE.ui.toasts.showError(t)}}))}_openCropper(t){let e=i.vE.ui.backgroundCropper;e.file=t,this._modal.hide(),e.show(),this._communityId||this._isCommunity?(e.data={community_id:this._communityId},e.type=_e.x6.COMMUNITY_BACKGROUND):(e.type=_e.x6.PROFILE_BACKGROUND,e.data=!1),this.stopListening(e),this.listenTo(e,"upload",(t=>{this.$el.removeAttr("data-default").find(".background__placeholder").css("background-image","url("+t.small.file_url+")")}))}_createModal(){if(this._modal)return this._modal;this._modal=new k.LD({header:i.vE.i18n("background-attach.popup.header")});let t=ve('<div class="background-select">\n\t<div class="background-select__upload">\n\t\t<span class="button button_success attach background-select__btn" data-role="attach">\n\t\t\tВыбрать изображение<input type="file" accept="image/*">\n\t\t</span>\n\t\t<button class="button" data-role="hide">Отмена</button>\n\t</div>\n\t<div class="background-select__note">Оптимальный размер: 1400 х 280</div>\n</div>\n'),e=t.find("input");return this.$els.dragEnterBlock=t.find(".background-select__upload"),t.find(".button").click((t=>{"attach"===ve(t.target).data("role")?e.click():this._modal.hide()})),e.on("click",(t=>this._checkForbidden(t))),e.on("drop",(t=>this._checkForbidden(t))),e.on("change",(t=>{this._modal.hide();let e=ge.nO.getImageFiles(t);e.length&&(t.target.value="",this._openCropper(e[0]))})),this.listenTo(i.vE.ui,"dnd",(t=>{this.$els.dragEnterBlock.toggleClass("background-select__upload_drag",t),t?this.$els.dragEnterBlock.on({"dragenter dragleave":this._drag.bind(this),drop:this._drop.bind(this)}):this.$els.dragEnterBlock.off("dragenter dragleave drop")})),this._modal.content=t,this._modal}_checkForbidden(t){if(t&&t.stopPropagation(),this._forbidden)return t&&t.preventDefault(),pt.g.confirmModal({content:i.vE.i18n("page-settings.background-blocked.content"),header:i.vE.i18n("page-settings.background-blocked.header"),buttonsAlign:"center",buttons:[["Закрыть"]]}),!0}_drag(t){this.$els.dragEnterBlock.toggleClass("background-select__upload_drop","dragenter"===t.type)}_drop(t){if(t.preventDefault(),t.stopPropagation(),this.$els.dragEnterBlock.toggleClass("background-select__upload_drop",!1),this._checkForbidden(t))return;if(!t.originalEvent.dataTransfer||!t.originalEvent.dataTransfer.files)return;let e=t.originalEvent.dataTransfer.files,s=[];for(let i=0;i<e.length;i++)-1!==e[i].type.indexOf("image")&&s.push(e[i]);s.length&&this._openCropper(s[0])}}var ye=s(8223);const be=s(9755);var we=s(6683);var Ee=s(9050);const Se=s(9755);class Ce extends n.u1{constructor(t={}){super(),this._clickEventName="click",this._showSourceButton=!0,this._videoData={},this._targetImage=null,this._useHistoryState=!0===t.useHistoryState}setTarget(t){return this._targetImage=Se(t),this}show(){if(!this._targetImage.length&&!this.$el)return;if(this._videoData=this._targetImage.data(),Se.isEmptyObject(this._videoData))return;const t=this._targetImage.closest(".comment[data-id]");return this.$el=Se(function(t){var e,s="";return Array.prototype.join,s+='<div class="external-video-viewer">\n\t<div class="external-video-viewer__overlay"></div>\n\t<div class="external-video-viewer__wrapper">\n\t\t<div class="player player_viewer"\n\t\t\t data-type="video"\n\t\t\t data-id="'+(null==(e=t.info.id)?"":e)+'"\n\t\t\t data-size-type="story"\n\t\t\t data-source="'+(null==(e=t.info.embedUrl)?"":e)+'"\n\t\t\t data-ratio="'+(null==(e=t.info.ratio)?"":e)+'"\n\t\t\t data-duration="'+(null==(e=t.info.duration)?"":e)+'"\n\t\t\t data-comment-meta="'+(null==(e=t.info.commentMeta)?"":e)+'"\n\t\t\t data-subs-code="'+(null==(e=t.info.subsCode)?"":e)+'">\n\t\t\t<div class="player__stretch" style="padding-bottom: '+(null==(e=t.info.ratio&&"youtube"!==t.info.host?100/t.info.ratio:56.25)?"":e)+'%"></div>\n\t\t\t<div class="player__logo"></div>\n\t\t\t<div class="player__play player__play_hidden"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon--player__play icon--player__play_player"><use xlink:href="#icon--player__play"></use></svg></div>\n\t\t\t<div class="player__preview" style="background-image: url('+(null==(e=t.info.thumb)?"":e)+');"></div>\n\t\t\t<div class="player__state player__state_large" data-type="loading"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon--ui__progress-circle icon--ui__progress-circle_player"><use xlink:href="#icon--ui__progress-circle"></use></svg></div>\n\t\t</div>\n\t</div>\n\t<div class="external-video-viewer__button external-video-viewer__button_close">\n\t\t<svg xmlns="http://www.w3.org/2000/svg" class="icon icon--ui__close icon--ui__close_size-large"><use xlink:href="#icon--ui__close"></use></svg>\n\t</div>\n\t',t.options.showSourceButton&&(s+='\n\t<a href="'+(null==(e=t.info.originalLink)?"":e)+'" target="_blank" class="external-video-viewer__button external-video-viewer__button_link">\n\t\t<i class="fa fa-external-link"></i>\n\t</a>\n\t'),s+="\n</div>\n"}({info:{id:this._videoData.id,embedUrl:this._videoData.url,host:this._videoData.host,ratio:this._videoData.ratio,thumb:this._videoData.thumb,originalLink:this._videoData.externalLink,duration:this._videoData.duration,commentMeta:t.data("meta"),subsCode:t.data("story-subs-code")},options:{showSourceButton:this._showSourceButton&&this._videoData.externalLink.length}})),this.$els={player:this.$(".player"),playerBlock:this.$(".external-video-viewer__wrapper"),overlay:this.$(".external-video-viewer__overlay"),closeButton:this.$(".external-video-viewer__button_close"),linkButton:this.$(".external-video-viewer__link")},Se("body").append(this.$el),i.ZP.ui.isPageScrollable=!1,this.$el.addClass("external-video-viewer_show"),this._useHistoryState&&(i.ZP.history.pushState({id:"external-video-viewer"},document.title),this.listenTo(i.ZP.history,"popstate",(()=>{this.hide()}))),this.$els.closeButton.on(this._clickEventName,this.hide.bind(this)),this.$els.overlay.on(this._clickEventName,this.hide.bind(this)),Se(document).on("keyup.externalVideoView",(t=>{switch(t.key||t.keyCode){case"Esc":case"Escape":case 27:this.hide()}})),this._updateWidth(),this.listenTo(i.ZP.ui,"resize",Ee.throttle(this._updateWidth.bind(this,!1),400)),i.ZP.ui.player.init(this.$el),this}hide(){return Se(document).off("keyup.externalVideoView"),this.$el?(this.$el.removeClass("external-video-viewer_show"),this.timeout("hide",i.ZP.ui.css.animationPopup,(()=>{this.destroy()})),i.ZP.ui.isPageScrollable=!0,this):this}_updateWidth(){let t=i.ZP.ui.windowWidth>800?800:i.ZP.ui.windowWidth,e=i.ZP.ui.windowHeight-40,s=t/this._videoData.ratio;i.ZP.applicationType===Xt.Zq.DESKTOP&&(e-=40),s>e&&(t=e*this._videoData.ratio,this.$els.playerBlock.css("max-width",t))}}class Te extends Ce{constructor(t={}){super({useHistoryState:!0})}}var Oe=s(1605);const ke=s(9755),Ie=s(381);s(7314);var $e=s(1014),Ae=s(9476),xe=s(7111);class De{constructor(){var t,e,s;t=this,e="emitter",s=new $e.v,e in t?Object.defineProperty(t,e,{value:s,enumerable:!0,configurable:!0,writable:!0}):t[e]=s}async loadImages(t){if(!t.length)return;if(t.every((t=>!this.isSupportedImage(t))))return this.showWrongFormatToast(),void this.emitter.emit("loading",!1);this.emitter.emit("loading",!0),this.emitter.emit("draftChecking",!0);const e=await Ae.c.checkIsDraftsLimitReached();if(this.emitter.emit("loading",!1),e){if(!(await Ae.a.show({analyticsType:"drafts_limit"})))return oe.cp.getInstance().sendEvent("tip_close",{type:"drafts_limit"}),void this.emitter.emit("draftChecking",!1)}this.emitter.emit("draftChecking",!1),this.emitter.emit("loading",!0);const{imageFiles:s,unsupportedFiles:n,limitExceeded:o}=this.getImageFiles(t),r=[];if(0===s.length)return void this.showWrongFormatToast();o&&s.length<t.length&&r.push({messageAfterReload:this.getImageLoadErorrMessage(i.vE.i18n("story-editor.limits.max-images",i.vE.initParams.LIMIT_MAX_MEDIA_BLOCKS_COUNT)),theme:v.K.DANGER}),n.length>0&&r.push({messageAfterReload:this.getImageLoadErorrMessage("формат файла не поддерживается"),theme:v.K.DANGER});const a=await Promise.allSettled(s.map((t=>S.ff.upload({type:"story_image",save:1,uid:0},t,{}))));this.onImagesLoaded(a,e,r)}onImagesLoaded(t,e,s){const n=[],o=[];if(t.forEach((t=>{var e,s;"fulfilled"===t.status&&null!=t&&null!==(e=t.value)&&void 0!==e&&null!==(s=e.response)&&void 0!==s&&s.result?n.push(t):o.push(t)})),o.length&&s.push({messageAfterReload:i.vE.i18n("story-editor.errors.upload"),theme:v.K.DANGER}),!n.length)return s.forEach((t=>{i.vE.ui.toasts.showError(t.messageAfterReload)})),void this.emitter.emit("loading",!1);s.length&&xe.m.set("pkb_msar",s),this.saveDraft(n,e)}async saveDraft(t,e){const s=t.map((({value:{data:{small:t}}})=>({id:Date.now(),type:"image",url:t.file_url,size:t.image_size,is_animated_image:!1})));try{const t=await Ae.c.saveDraft({color_theme:0,is_adult:!1,is_authors:!1,is_donations_disabled:!1,story_id:0,tags:"",title:"",blocks:s},e?"overwrite_oldest":void 0);i.vE.history.redirect(`/add?draft_id=${t}&from=drag-and-drop`)}catch(n){this.emitter.emit("loading",!1),console.error(n)}}getImageFiles(t){const e=[],s=[],n=t.some((t=>(this.isSupportedImage(t)?e.push(t):s.push(t),e.length>=i.vE.initParams.LIMIT_MAX_MEDIA_BLOCKS_COUNT)));return{imageFiles:e,unsupportedFiles:s,limitExceeded:n}}isSupportedImage(t){return t&&ge.nO.isSupportedImage(t)&&t.size<=i.vE.initParams.LIMIT_IMAGES_BYTES}getImageLoadErorrMessage(t){return`Некоторые изображения не удалось загрузить. Причина: ${t}`}showWrongFormatToast(){const t=Math.floor(i.vE.initParams.LIMIT_IMAGES_BYTES/1e3/1e3);i.vE.ui.toasts.showError(`Недопустимый формат файла. Требования к изображению: png, jpg, jpeg или gif не более ${t} МБ`),oe.cp.getInstance().sendEvent("error_occured",{type:"post_create_drag_and_drop_bad_image"})}}function Pe(t,e,s){return e in t?Object.defineProperty(t,e,{value:s,enumerable:!0,configurable:!0,writable:!0}):t[e]=s,t}class Re extends Jt.u{constructor(){super(),Pe(this,"overlayEl",null),Pe(this,"_isLoading",!1),Pe(this,"storyImageDndService",new De),Pe(this,"isDndDisabled",!1),Pe(this,"isDraggingLocalFiles",!1),Pe(this,"toggleIsDndDisabled",(t=>{this.isDndDisabled=t})),Pe(this,"handleDrag",(t=>{t.preventDefault(),t.stopImmediatePropagation()})),Pe(this,"handleDrop",(t=>{t.preventDefault(),t.stopPropagation(),this.storyImageDndService.loadImages(ge.nO.File.getFiles(t))})),i.vE.isUserAuthorized&&"story-editor"!==i.vE.initParams.pageName&&this.init()}init(){this.listenTo(i.vE.ui,"dnd-drop",(t=>t.preventDefault())),this.listenTo(i.vE.ui,"dnd",(t=>{this.isDndDisabled||this.isDraggingLocalFiles||(this.setOverlayVisibility(t||this.isLoading),this.isLoading||(t?(this.overlay.addEventListener("dragenter",this.handleDrag,!1),this.overlay.addEventListener("dragleave",this.handleDrag,!1),this.overlay.addEventListener("drop",this.handleDrop,!1)):(this.overlay.removeEventListener("dragenter",this.handleDrag),this.overlay.removeEventListener("dragleave",this.handleDrag),this.overlay.removeEventListener("drop",this.handleDrop))))})),this.listenTo(this.storyImageDndService.emitter,"loading",(t=>{t?(this.setOverlayVisibility(!0),this.isLoading=!0):this.setOverlayVisibility(!1)})),this.listenTo(this.storyImageDndService.emitter,"draftChecking",this.toggleIsDndDisabled),this.listenTo(i.vE.ui,"disable-story-image-dnd",this.toggleIsDndDisabled),document.addEventListener("dragstart",(()=>{this.isDraggingLocalFiles=!0})),document.addEventListener("dragend",(()=>{this.isDraggingLocalFiles=!1}))}setOverlayVisibility(t){this.overlay.hidden=!t,t||(this.isLoading=!1)}set isLoading(t){t!==this._isLoading&&(this.overlay.classList.toggle("dnd-overlay_loading",t),this._isLoading=t,t&&oe.cp.getInstance().sendEvent("reach_element",{type:"drag_and_drop"}))}get isLoading(){return this._isLoading}get overlay(){return this.overlayEl||(this.overlayEl=document.createElement("div"),this.overlayEl.classList.add("dnd-overlay"),this.overlayEl.innerHTML=`\n\t\t\t<div class="dnd-overlay__container">\n\t\t\t\t<div class="dnd-overlay__content">\n\t\t\t\t\t<div class="dnd-overlay__call-to-action">\n\t\t\t\t\t\t<p>\n\t\t\t\t\t\t\tПеретащите сюда изображение для быстрой публикации поста\n\t\t\t\t\t\t</p>\n\t\t\t\t\t\t${i.vE.icon("ui__drag-and-drop")}\n\t\t\t\t\t</div>\n\t\t\t\t\t<p class="dnd-overlay__loading">${i.vE.icon("ui__preloader")} Загружаем изображение…</p>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t`,document.body.append(this.overlayEl)),this.overlayEl}}var Me=s(9161),Ne=s(9738);function Be(t,e){var s=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),s.push.apply(s,i)}return s}function Le(t){for(var e=1;e<arguments.length;e++){var s=null!=arguments[e]?arguments[e]:{};e%2?Be(Object(s),!0).forEach((function(e){Fe(t,e,s[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(s)):Be(Object(s)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(s,e))}))}return t}function Fe(t,e,s){return e in t?Object.defineProperty(t,e,{value:s,enumerable:!0,configurable:!0,writable:!0}):t[e]=s,t}const Ue="pkb_prf_ntf";class je{static getInstance(){return je.instance||(je.instance=new je)}getConfig(){const t=xe.m.get(Ue),e=t||{hintShownCount:0,wasAlreadyShown:!1};return(0,Ne.K)(t)||xe.m.set(Ue,e),e}setValue(t,e){xe.m.set(Ue,Le(Le({},this.getConfig()),{},{[t]:e}))}get hintShownCount(){return this.getConfig().hintShownCount}set hintShownCount(t){this.setValue("hintShownCount",t)}get wasAlreadyShown(){return this.getConfig().wasAlreadyShown}set wasAlreadyShown(t){this.setValue("wasAlreadyShown",t)}}const Ve=new(s(7502).L)({}),He=t=>{const e=Ve.data[t];return e||(Ve.update({[t]:{}}),Ve.data[t])},qe=(t,e)=>{Ve.update({[t]:e})},We=(t,e)=>{const s=(s,i,n)=>{i===t&&e(n)};return Ve.listenTo(Ve,"dataChangeProperty",s),()=>{Ve.stopListening(Ve,"dataChangeProperty",s)}};function Ge(t,e,s){return e in t?Object.defineProperty(t,e,{value:s,enumerable:!0,configurable:!0,writable:!0}):t[e]=s,t}const Ye="data-notification-subs";class ze extends Jt.u{constructor(t){super(t),Ge(this,"_loading",!1),Ge(this,"userId",""),Ge(this,"hintAlignment",i.ZP.isMobileApp?k.SE.END:k.SE.CENTER),Ge(this,"handleBellClick",(async()=>{var t,e;null===(t=this._balloon)||void 0===t||t.hide(),this.loading||(this.loading=!0,this.emit("subscribing"),He(this.userId).isSubscribedOnUser?await this.toggleNotificationSubscription():await this.subscribeOnUserAndNotification(),this.loading=!1,null===(e=this._hint)||void 0===e||e.hide(),this.emit("subscribingEnds"))})),this.render()}render(){if(this.isRendered||!this.el)return this;this.el.addEventListener("click",(()=>{this.handleBellClick()})),this.userId=String(this._options.user.id);const t=He(this.userId);void 0===t.isSubscribedOnUserNotification?qe(this.userId,{isSubscribedOnUser:t.isSubscribedOnUser,isSubscribedOnUserNotification:"1"===this.el.getAttribute(Ye)}):this.el.setAttribute(Ye,t.isSubscribedOnUserNotification?"1":"0"),this.initHint(),this.showBalloonOnRender();const e=We(this.userId,(t=>{this.isSubscribedOnNotification=Boolean(t.isSubscribedOnUserNotification)}));return this.listenToOnce(this,Me.e.UNMOUNTED,(()=>{e()})),super.render(),this}async showBalloon(){var t;null===(t=await this.getBalloon())||void 0===t||t.show(),this._hint&&(this._hint.disabled=!0)}async showBalloonOnRender(){this._options.showBalloonOnRender&&(je.getInstance().wasAlreadyShown||this.isSubscribedOnNotification||(await this.showBalloon(),je.getInstance().wasAlreadyShown=!0))}showBalloonCertainTimes(){const t=je.getInstance().hintShownCount;t<2&&(this.showBalloon(),je.getInstance().hintShownCount=t+1)}async subscribeOnUserAndNotification(){try{var t;await this._options.user.subscribe(!0,{type:(null===(t=this.el)||void 0===t?void 0:t.dataset.analyticsType)||""}),await this._options.user.notificationSubscribe(!0),i.ZP.ui.toasts.add({content:i.ZP.i18n("profile.success-msg"),closeAfter:4e3}),qe(this.userId,{isSubscribedOnUser:!0,isSubscribedOnUserNotification:!0}),await c.cQ.delay(50),d.c.getInstance().sendEvent("subscribe_to_notification",{"author_id!empty":this.userId,"type!empty":this._options.profileType,create_at:Date.now()})}catch(e){this.handleSubscriptionError(e)}}async toggleNotificationSubscription(){try{const t=!He(this.userId).isSubscribedOnUserNotification;await this._options.user.notificationSubscribe(t),t&&i.ZP.ui.toasts.add({content:i.ZP.i18n("profile.success-msg"),closeAfter:4e3}),d.c.getInstance().sendEvent(t?"subscribe_to_notification":"unsubscribe_from_notification",{"author_id!empty":this.userId,"type!empty":this._options.profileType});const e=He(this.userId);qe(this.userId,{isSubscribedOnUser:e.isSubscribedOnUser,isSubscribedOnUserNotification:t})}catch(t){this.handleSubscriptionError(t)}}handleSubscriptionError(t){i.ZP.ui.toasts.add({theme:v.K.RED,content:(null==t?void 0:t.message)||t})}initHint(){!this._hint&&this._options.showHint&&(this._hint=new k.gR({target:this.el,content:this.getBalloonContent(!1),destroyAfterHide:!1,direction:k.Lh.TOP,alignment:this.hintAlignment,autoCloseOutsideClick:!1}),this.isSubscribedOnNotification&&(this._hint.disabled=!0))}getBalloonContent(t=!0){return`\n\t\t\t<div class="popup__hint popup__hint_profile-notification">\n\t\t\t\t${t?`<button data-role="close" class="button_link popup__icon-close">\n\t\t\t\t\t\t${(0,j.q)("ui__close","popup")}\n\t\t\t\t</button>`:""}\n\t\t\t\t<p>${i.ZP.i18n("profile.hint")}</p>\n\t\t\t</div>\n\t\t`}async getBalloon(){return this._balloon||(this._balloon=await(0,U.aM)({target:this.el,id:"author-notification-subscribe",text:i.ZP.i18n("profile.hint"),direction:k.Lh.TOP,alignment:this.hintAlignment,autoCloseOutsideClick:!0,colorTheme:"primary",wrapperExtraClass:"popup_feature-notification",shownCheckStrategy:{getIsShown:()=>Promise.resolve(!1),setIsShown:()=>Promise.resolve()},btnConfig:{label:"Понятно",handler:()=>{this._balloon.hide()}},overlapSidebars:!0}),this.listenToOnce(this._balloon,Me.e.DESTROYED,(()=>{this._hint&&(this._hint.disabled=!1)}))),this._balloon}get isSubscribedOnNotification(){return Boolean(He(this.userId).isSubscribedOnUserNotification)}set isSubscribedOnNotification(t){this.el&&this.el.setAttribute(Ye,t?"1":"0"),this._hint&&(this._hint.disabled=Boolean(t))}get loading(){return this._loading}set loading(t){this._loading!==t&&(this._loading=t)}}var Ze=s(8245);function Ke(t,e){var s=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),s.push.apply(s,i)}return s}function Xe(t){for(var e=1;e<arguments.length;e++){var s=null!=arguments[e]?arguments[e]:{};e%2?Ke(Object(s),!0).forEach((function(e){Qe(t,e,s[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(s)):Ke(Object(s)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(s,e))}))}return t}function Qe(t,e,s){return e in t?Object.defineProperty(t,e,{value:s,enumerable:!0,configurable:!0,writable:!0}):t[e]=s,t}class Je extends Jt.u{constructor(t){super(t),Qe(this,"userId",""),Qe(this,"subscribingHandler",(()=>{this.subscribeBtn.preventActions=!0})),Qe(this,"subsribeEndedHandler",(t=>{const e=Xe({},He(this.userId));t?this.notificationBell.showBalloonCertainTimes():e.isSubscribedOnUserNotification=!1,e.isSubscribedOnUser=t,qe(this.userId,e)})),this.initSubscriptionNotificationBell()}initSubscriptionNotificationBell(){const{notificationBellOptions:t,subscribeBtnEl:e}=this._options;if(!t.el||!e)return;this.userId=String(this._options.notificationBellOptions.user.id),this.initSubscribeBtn(),this.notificationBell=new ze(Xe({},t));const s=We(this.userId,(t=>{this.subscribeBtn.preventActions=!1,this.subscribeBtn.isSubscribed=Boolean(t.isSubscribedOnUser)}));this.listenTo(this.notificationBell,"subscribing",this.subscribingHandler),this.listenTo(this.subscribeBtn,"subscribeEnded",this.subsribeEndedHandler),this.listenToOnce(this.emitter,Me.e.DESTROYED,(()=>{s(),this.stopListening(this.notificationBell,"subscribing",this.subscribingHandler),this.stopListening(this.subscribeBtn,"subscribeEnded",this.subsribeEndedHandler)}))}destroy(){super.destroy(),this.notificationBell.destroy()}initSubscribeBtn(){const{subscribeBtnEl:t,uiSubscribeBtnComponet:e}=this._options;if(this.subscribeBtn=n.u1.getUIElement(t),!this.subscribeBtn&&t){const s=Ze.S.getInstance().get(e);this.subscribeBtn=new s(t)}const s=He(this.userId);void 0!==s.isSubscribedOnUser?this.subscribeBtn.isSubscribed=s.isSubscribedOnUser:qe(this.userId,{isSubscribedOnUser:this.subscribeBtn.isSubscribed,isSubscribedOnUserNotification:s.isSubscribedOnUserNotification})}}class ts extends Jt.u{constructor(t){var e,s,n;super({el:t}),n=t=>{var e;if(!(t.target instanceof HTMLElement))return;const s=t.target.closest(".fast-links__item");if(!s)return;const n=s.classList.contains("fast-links__item_community"),o=s.getAttribute("data-link"),r=n?"community_id!empty":"author_id!empty",a=n?"transition_to_community":"transition_to_author";oe.cp.getInstance().sendEvent(a,{type:"menu_fast_icons",screen_index:Array.from((null===(e=this.carousel)||void 0===e?void 0:e.els.content.querySelectorAll(".fast-links__item"))||[]).indexOf(s)+1,[r]:s.getAttribute("data-id")}),o&&i.vE.history.redirect(o)},(s="handleClick")in(e=this)?Object.defineProperty(e,s,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[s]=n,this.show()}render(){var t;if(this.isRendered)return this;const e=Ze.S.getInstance().get("UICarousel");return this.carousel=new e({el:this.el}),null===(t=this.carousel)||void 0===t||t.els.content.addEventListener("click",this.handleClick),this}}class es{constructor(t){var e,s,n;e=this,s="analytics",n=oe.cp.getInstance(),s in e?Object.defineProperty(e,s,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[s]=n,this.modal=new k.LD({content:t,destroyAfterHide:!1});const[o]=this.modal.content;this.form=new qt(o.firstElementChild),i.vE.listenTo(i.vE,"error-auth-toast",this.modal.hide.bind(this.modal)),i.vE.listenTo(i.vE,"success-auth-toast",this.modal.hide.bind(this.modal))}showSignIn(){this.show("signin")}showSignUp(){this.show("signup")}show(t){this.analytics.sendEvent("form_show",{type:"signin"===t?"auth":"reg"}),this.modal.show(),this.form.show(),this.form.changeTab(t)}}class ss{static async removeAccount(){const{response:t}=await S.cf.post("/ajax/users_actions.php",{action:"remove_profile"});if(!t.result)throw i.ZP.ui.toasts.showError(t.message),new Error(t.message);return t.result}static async restoreAccount(){const{response:t}=await S.cf.post("/ajax/users_actions.php",{action:"restore_profile"});if(!t.result)throw i.ZP.ui.toasts.showError(t.message),new Error(t.message);return t.result}}class is extends es{constructor(t,e){super(t),this.changeContent(e)}changeContent(t){t.forEach((t=>{const{tabName:e,headerText:s,noticeText:i}=t,n=this.modal.$els.content.get(0);n.classList.add("popup__content_comment");const o=n.querySelector(`[data-id="${e}"]`),r=null==o?void 0:o.querySelector(".auth__header");r&&(r.innerText=s);const a=null==o?void 0:o.querySelector(".auth-modal__notice");a&&i.length>0?a.innerText=i:null==a||a.remove()}))}}function ns(t,e){var s=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),s.push.apply(s,i)}return s}function os(t){for(var e=1;e<arguments.length;e++){var s=null!=arguments[e]?arguments[e]:{};e%2?ns(Object(s),!0).forEach((function(e){rs(t,e,s[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(s)):ns(Object(s)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(s,e))}))}return t}function rs(t,e,s){return e in t?Object.defineProperty(t,e,{value:s,enumerable:!0,configurable:!0,writable:!0}):t[e]=s,t}const as=s(6419),ls=s(9755);class hs extends r.Zv{constructor(){var t;super(),this.$els=os(os({},null!==(t=this.$els)&&void 0!==t?t:{}),{app:ls(".app"),appInner:ls(".app__inner"),sidebar:ls(".sidebar"),sidebarAuth:ls(".sidebar-auth"),sidebarInner:ls(".sidebar__inner"),main:ls(".main"),footer:ls(".footer"),emailBlock:ls("#subscribe-email"),authModal:ls("#auth-modal"),restoreButton:ls('[data-restore="true"]'),fastLinks:ls(".fast-links_carousel")}),this.els.sidebarInner=this.$els.sidebarInner.get(0),this._hotkeys=void 0,function(t){const e=i.vE.applicationType===Xt.Zq.DESKTOP,s=e?"mouseenter":"click";t.$els.document.on(s,".hint",(t=>{const s=t.currentTarget,i=ke(s);if(i.data("hint"))return!0;const o=s.matches("time[datetime]")&&!s.hasAttribute("title")&&!s.hasAttribute("aria-label"),r=s.classList.contains("story__comments-link-icon"),a=r?k.Lh.RIGHT:k.Lh[(s.dataset.direction||"").toUpperCase()]||k.Lh.TOP,l=r?k.SE.CENTER:k.SE[(s.dataset.alignment||"").toUpperCase()]||k.SE.CENTER,h=s.dataset.delay?s.dataset.delay:e?800:10,c=o?Ie(s.getAttribute("datetime")).local().format("D MMMM YYYY [в] H:mm"):s.getAttribute("title")||s.getAttribute("aria-label"),u=k.xb[(s.dataset.theme||"").toUpperCase()]||k.xb.DEFAULT,p=Boolean(s.dataset.interactive),m={target:s,content:ke(document.createElement("div")).addClass("popup__hint"+(s.classList.contains("hint_left")?" popup__hint_left":"")+(r?" popup__hint_new-comment":"")).html(c),direction:a,alignment:l,theme:u,interactive:p,delay:h,destroyAfterHide:1500},_=s.dataset.width;_&&(m.width=Number(_));const g=new k.gR(m);i.data("hint",g),g.onMouseEnter();const v=g.target.$target;g.on(n.eM.MOUNTED,(()=>{v.addClass("hint_shown");const t=i.data("analytics-type");t&&t.length&&d.c.getInstance().sendEvent("tooltip_popup",{type:t,position:"sidebar_right"});const e=i.data("analytics-params");e&&"object"==typeof e&&e.type&&d.c.getInstance().sendEvent("tooltip_popup",e)})),g.on(n.eM.HIDDEN,(()=>v.removeClass("hint_shown")))}))}(this),this._attachUserHints(),this._attachTagMenu(),this._attachPaginationHotkey(),this.overlays={hint:new k.aI({$parent:this.$els.body,zIndex:6002}),balloon:new k.aI({$parent:this.$els.body,zIndex:6001}),modal:new k.aI({$parent:this.$els.body,zIndex:6e3})},this.$els.restoreButton.on("click",(t=>{t.preventDefault(),this._attachRestoreAccount()})),this._marginBody=0,this.listenTo(this.overlays.modal,"show",(()=>this.isPageScrollable=!1)),this.listenTo(this.overlays.modal,"hide",(()=>this.isPageScrollable=!0)),this.$els.footer.length&&this._initFooterEmailForm(),this.$els.emailBlock.length&&(this._subscriptionForm=new Qt.o({$el:this.$els.emailBlock,formClass:a.x,inputClass:T.u3,type:"separate_page"})),this.auth=void 0,this._attachImageViewer(),this._attachExternalVideoViewer(),this._attachSubscribeButtons()._attachCommunityInfoBlock(),this._attachLabels(),this._attachRouteLinks(),this._attachTagsCut(),this._attachImageNewTab(),this._attachPageUpDown(),this._attachBestComment(),this._detectUserIsLeaving(),this._initFastLinksCarousel()}authRequired(){if(i.vE.initParams.isDeleted)return this.modalRestore||this._attachRestoreAccount(),void this.modalRestore.show();this.authModal?this.authModal.showSignUp():this.toasts.showWarningMessage(i.ZF.AUTHORIZATION_REQUIRED)}_scrollHookHandler(t,e){t===O.ZK.FIRST_ON?window.addEventListener("scroll",e,{passive:!0}):window.removeEventListener("scroll",e)}_attachBestComment(){ls(".comment__show-all").on("click",(t=>{t.preventDefault(),ls(t.currentTarget).hide().prev().removeClass("comment__content_overflow")}))}_detectUserIsLeaving(){document.addEventListener("mouseout",(t=>{null===t.relatedTarget&&t.clientY<50&&d.c.getInstance().clickhouse.sendImmediately()}))}_attachPageUpDown(){this.marks.set("page-boost",0);let t=as.throttle(((t=!0)=>{if(!this.marks.get("page-scrolling"))return;let e=this.marks.get("page-boost")+1;this.marks.set("page-boost",e),this.$els.scrollRoot.animate({scrollTop:this.scrollTop+100*e*(t?1:-1)},100,"linear")}),100);this.hotkeys.on("c",(()=>{this.marks.set("page-scrolling",!0),t(!0)}),{type:it.FM.KEYDOWN}),this.hotkeys.on("c",(()=>{this.marks.delete("page-scrolling"),this.marks.set("page-boost",0)}),{type:it.FM.KEYUP}),this.hotkeys.on("z",(()=>{this.marks.set("page-scrolling",!0),t(!1)}),{type:it.FM.KEYDOWN}),this.hotkeys.on("z",(()=>{this.marks.delete("page-scrolling"),this.marks.set("page-boost",0)}),{type:it.FM.KEYUP})}_attachPaginationHotkey(){let t=t=>{let e=ls(`.pagination__to[data-role="${t}"]`);1!==e.length||e.hasClass("pagination__to_disabled")||(e.click(),i.vE.history.location.href=e.attr("href"))};this.hotkeys.on("alt+left",t.bind(this,"prev")),this.hotkeys.on("alt+right",t.bind(this,"next")),this.hotkeys.on("alt+a",t.bind(this,"prev")),this.hotkeys.on("alt+d",t.bind(this,"next"))}_attachAuth(){if(this.$els.sidebarAuth.length&&(this.auth=new qt(this.$els.sidebarAuth.parent()),this.auth.show()),this.$els.authModal.length){const[t]=this.$els.authModal;if(this.authModal=new es(t.content.cloneNode(!0)),i.vE.initParams.experimentRegOnComment){const e=[{tabName:"signup",headerText:"Регистрация",noticeText:"Комментарий будет отправлен сразу же после регистрации.Зарегистрируйтесь при помощи соцсети, чтобы сразу же подтвердить аккаунт и получить возможность писать комментарии."},{tabName:"signin",headerText:"Авторизация",noticeText:"Комментарий будет отправлен сразу же после авторизации."},{tabName:"forget",headerText:"Восстановление пароля",noticeText:"Комментарий будет отправлен сразу же после регистрации.Зарегистрируйтесь при помощи соцсети, чтобы сразу же подтвердить аккаунт и получить возможность писать комментарии."}];this.authModalForComment=new is(t.content.cloneNode(!0),e)}q.V.isUserInExperiment(q.t.REG_PROFIT)&&!i.vE.isUserAuthorized&&(this.authModalEmpty=new is(t.content.cloneNode(!0),[{tabName:"signup",headerText:"Регистрация",noticeText:""}]))}return this}_attachProfile(){return this.$els.app.on("click",".user__exit",(async t=>{const e=t.currentTarget;if(this.marks.has("confirm-logout"))return;if(!e.getAttribute("data-confirm"))return void(await u.User.logout());this.marks.set("confirm-logout",!0);const s=await pt.g.confirmBalloon({target:e,content:"Вы действительно хотите выйти?",buttons:[["Выйти",st.jM.DANGER,!0],["modal.cancel"]],maxWidth:300});this.marks.delete("confirm-logout"),s&&await u.User.logout()})),this}_attachRestoreAccount(){this.modalRestore=new k.LD({content:`<p class="restore-account">\n\t\t\tВаш аккаунт удален. У вас осталось ${i.vE.initParams.remainingRestoringDays} \n\t\t\t${i.vE.i18n("plural.days",i.vE.initParams.remainingRestoringDays)} на восстановление,\n\t\t\tпосле чего аккаунт станет недоступен. Желаете восстановить аккаунт?</p>`}),this.modalRestore.addButtonIntoFooter(i.vE.i18n("modal.restore"),(async()=>{this.modalRestore.hide();await ss.restoreAccount()&&(this.toasts.add({content:i.vE.i18n("warning-message.RESTORE"),theme:v.K.DEFAULT,closeAfter:3e3}),setTimeout((()=>{i.vE.history.location.href="/"}),3e3))}),st.jM.SUCCESS),this.modalRestore.addCloseButtonIntoFooter(i.vE.i18n("modal.cancel")),this.modalRestore.show()}_attachImageViewer(){return this.$els.document.on("click",'img[data-viewable="true"]',(t=>{t.shiftKey||t.ctrlKey||t.metaKey||(t.preventDefault(),t.stopPropagation(),(new zt).setTarget(t.currentTarget).show())})),this}_attachImageNewTab(){this.$els.document.on("click auxclick",".image-link",(t=>{t.preventDefault(),t.stopPropagation(),(1===t.button||t.ctrlKey||t.metaKey)&&window.open(t.currentTarget.getAttribute("href"),"_blank")}))}_attachExternalVideoViewer(){return this.$els.document.on("click",'[data-external-video="true"]',(t=>{t.shiftKey||t.ctrlKey||t.metaKey||(t.preventDefault(),t.stopPropagation(),(new Te).setTarget(t.currentTarget).show())})),this}_attachUserHints(){this.$els.document.on("mouseenter",'.user__nick[data-profile="true"], .user[data-profile="true"], .comment__user[data-profile="true"], .avatar[data-profile="true"][data-name], .user-call[data-profile="true"][data-name], .users-list__nick-inner[data-profile="true"][data-name]',(t=>{let e=t.currentTarget,s=ls(e),o=e.querySelector(".user__nick")||e;if(!o||s.data("hint"))return;let r=String(s.attr("data-name")||o.textContent),a=u.User.getMiniProfile(r),l=as.isString(a),h=new k.gR({interactive:!0,target:s,direction:k.Lh.TOP,content:l?a:ls(document.createElement("div")).addClass("popup__user-hint").html(i.vE.icon("ui__progress-circle","user-hint")),destroyAfterHide:3e3});const d=()=>{const t=new Je({subscribeBtnEl:h.content.find('.button-group[data-role="subscribe"]')[0],uiSubscribeBtnComponet:"UISubscribeButton",notificationBellOptions:{el:h.content.find(".profile__user-notification-bell")[0],user:new u.User(h.content.find(".profile").data("user-id")),showHint:!0,profileType:"author_mini_profile"}});i.vE.listenToOnce(h,n.eM.DESTROYED,(()=>{t.destroy()}))};if([we.AJ.COMMENTS,we.AJ.STORIES].map((t=>{this.listenTo(i.vE,t,(()=>{h.hide(),u.User.flushMiniProfilesCache()}))})),s.data("hint",h),h.onMouseEnter(),l)return d(),void this._initMiniProfileAnalytics(e,h.content);c.cQ.delay(Boolean(a)?500:1500).then((()=>{h.isDestroyed||a.then((t=>{if(h.isDestroyed)return;h.content=t;const s=h.content.find(".profile__note-inner").first(),i=u.User.noteValueToHtml(s.text(),{commentLinks:!0,cropLinks:!0});s.html(i),d(),this._initMiniProfileAnalytics(e,h.content),h.isShown&&(h.updateWidth(),h.updatePosition())}),(()=>{h.destroy()}))}))}))}_attachTagMenu(){let t,e;this.$els.document.on("mouseenter",'[data-tag-menu="true"]',(s=>{let n=ls(s.currentTarget);e=String(n.data("tag")),n.data("hint")||(t=new ye.Z({delay:1200,target:n,direction:k.Lh.TOP,alignment:k.SE.START,interactive:!0,tag:e,content:ls(document.createElement("div")).addClass("popup__tag-menu").html(i.vE.icon("ui__progress-circle","user-hint"))}),n.data("hint",t),t.onMouseEnter())}))}_initFooterEmailForm(){this.$els.footer.find(".email-block").length&&(this._subscriptionForm=new Qt.o({$el:this.$els.footer.find(".email-block"),formClass:a.x,inputClass:T.u3,type:"footer"}))}_attachSubscribeButtons(){return this.$els.document.on("click",".button_add",(t=>{if(!i.vE.isUserAuthorized)return t.preventDefault(),this.authRequired(),void d.c.getInstance().sendEvent("click",{type:"post_add"});d.c.getInstance().sendEvent("click_create_post",{type:"main_sidebar"})})),this.$els.document.on("click",".community__add-story",(t=>{if(!i.vE.isUserAuthorized)return t.preventDefault(),this.authRequired(),void d.c.getInstance().sendEvent("click",{type:"post_add"});d.c.getInstance().sendEvent("click_create_post",{type:"comm_description"})})),this.$els.document.on("click",'.button-group[data-role="subscribe"]',(t=>{t.preventDefault();const e=t.currentTarget,s=ls(t.target);n.u1.getUIElement(e)||(new st.C0(e),s.trigger("click"))})),this}_attachCommunityInfoBlock(){return this.$els.document.on("click",".community-info-block__rules-header",(t=>{let e=ls(t.currentTarget),s=e.find("i"),i=s.hasClass("fa-angle-up");s.toggleClass("fa-angle-up",!i).toggleClass("fa-angle-down",i),e.next().slideToggle(200)})),this.$els.document.on("click",".community-info-block__vote",(t=>{let e=ls(t.currentTarget),s=e.data("id"),i=e.data("value"),n=this.marks.get("community-voting-popup");n||(n=pt.g.popupEnum(e,!0,"communities.voting.popup",i),this.listenTo(n,"change",(async(t,i)=>{try{await new me.S1(s).voteForCurrentAdmin(i),e.find("span").text(i?"устраивает":"не устраивает"),t.saveAsDefault()}catch(o){this.toasts.showError(o)}n.hide()})),this.marks.set("community-voting-popup",n)),n.toggle()})),this}_attachLabels(){return this.$els.document.on("click","label",(t=>{const e=t.currentTarget;if(!e||!e.htmlFor)return;const s=document.getElementById(e.htmlFor);s&&"true"===s.contentEditable&&s.focus()})),this}get profileAvatarCropper(){let t=this._options.profileAvatarCropper;return t||(t=this._options.profileAvatarCropper=new _e.hA({outputSize:[256,256],type:_e.x6.PROFILE_AVATAR,indent:!0})),t}get communityAvatarCropper(){let t=this._options.communityAvatarCropper;return t||(t=this._options.communityAvatarCropper=new _e.hA({outputSize:[256,256],type:_e.x6.COMMUNITY_AVATAR,indent:!0})),t}get backgroundCropper(){let t=this._options.backgroundCropper;return t||(t=this._options.backgroundCropper=new _e.hA({outputSize:[1400,280],type:_e.x6.PROFILE_BACKGROUND,indent:!0})),t}_attachChangeProfileAvatar(){let t=as.map(ls('.avatar[data-editable="true"]'),(t=>ls(t))),e=as.map(ls('.avatar[data-own="true"]'),(t=>ls(t)));return t.filter((t=>!t.data("inited"))).forEach((t=>{let s=ls(document.createElement("input")).attr("type","file").attr("accept","image/*").on("click",(t=>t.stopPropagation())).on("change",(t=>{let s=ge.nO.getImageFiles(t);s.length&&(t.target.value="",this.profileAvatarCropper.file=s[0],this.profileAvatarCropper.show(),this.stopListening(this.profileAvatarCropper),this.listenTo(this.profileAvatarCropper,"upload",(t=>{e.forEach((e=>{let s=e.find("img"),i=t.large.file_url;s.length||(s=ls(document.createElement("img")).appendTo(e),e.find(".avatar__default").remove()),e.hasClass("avatar_large")&&(i=t.share.file_url),s.attr("src",i)}))})))}));t.attr("data-inited",!0).append(ls(document.createElement("div")).addClass("avatar__upload attach").append(i.vE.icon("ui__photo","avatar")).click((()=>s.click())).append(s))})),this}_attachChangeCommunityAvatar(){return as.map(ls('.community-avatar[data-editable="true"]'),(t=>ls(t))).filter((t=>!t.data("inited"))).forEach((t=>{let e=t.data("community-id"),s=Boolean(e),n=ls(document.createElement("input")).attr("type","file").attr("accept","image/*").on("click",(t=>t.stopPropagation())).on("change",(i=>{let n=ge.nO.getImageFiles(i);n.length&&(i.target.value="",this.communityAvatarCropper.data={community_id:e||0,save:Boolean(e)?1:0},this.communityAvatarCropper.file=n[0],this.communityAvatarCropper.show(),this.stopListening(this.communityAvatarCropper),this.listenTo(this.communityAvatarCropper,"upload",(i=>{let n=s?ls('.community-avatar[data-community-id="'+e+'"]'):t,o=s?i.small.file_url:i.tmp_file_url;as.forEach(n,(t=>{let e=ls(t),s=e.find("img"),i=o;s.length||(s=ls(document.createElement("img")).appendTo(e),e.find(".community-avatar__default").remove()),s.attr("src",i)})),s||t.find('input[type="hidden"]').val(i.tmp_file_name)})))}));t.attr("data-inited",!0).append(ls(document.createElement("div")).addClass("community-avatar__upload attach").append(i.vE.icon("ui__photo","avatar")).click((()=>n.click())).append(n))})),this}_initFastLinksCarousel(){0!==this.$els.fastLinks.length&&new ts(this.$els.fastLinks.get(0))}_attachChangeBackground(){return ls('.background[data-editable="true"]').not('[data-inited="true"]').each(((t,e)=>{new fe(e)})),this}_initStoryImageDnd(){q.V.isUserInExperiment(q.t.DRAG_AND_DROP)&&new Re}init(){if(super.init(),this.$els.appInner.hasClass("app__inner_wide")||(this.sidebar=new he(this)),this.toasts=new E,this._showToastAfterReload(),this._showToastListAfterReload(),this.header=new tt(this),this.player=new ce.XM,i.vE.initParams.isScrollTopBtn&&new pe({$parent:this.$els.body}),i.vE.isUserAuthorized?this._attachProfile()._attachChangeProfileAvatar()._attachChangeCommunityAvatar()._attachChangeBackground():this._attachAuth(),!this.isEmbedded&&Oe.x&&(this._themePicker=new g({$parent:ls("body")}),this._themePicker.show(),this.listenTo(this.themeSettings,"external-change",(()=>{this._themePicker.destroy(),this._themePicker=new g({$parent:ls("body")}).show()}))),i.vE.config("modules.ad-video"))try{(()=>{function t(t,e){let s=be(".ad-video-cont"),i=be(window),n=i.width(),o=i.height(),r=n/2,a=o/2;if(e&&"function"==typeof e||(e=function(){}),"start"===t)s.css({left:~~(r-0)+"px",top:~~(a-0)+"px",width:"20px",height:"20px",opacity:0});else if("finish"===t)s.stop().animate({left:~~(r-0)+"px",top:~~(a-0)+"px",width:"20px",height:"20px",opacity:0},e);else{let t=Number(s.data("w")),i=Number(s.data("h")),l=Math.min(1,(n-100)/t,(o-100)/i);1!==l&&(t*=l,i*=l),s.css("display","block");let h={left:~~(r-t/2-0)+"px",top:~~(a-i/2+0)+"px",width:t+"px",height:i+"px",opacity:1};s.stop().animate(h,e)}}be("div.ad-video-layer, div.ad-video-close").click((function(e){e.preventDefault(),e.stopPropagation(),be(".ad-video-close").fadeOut(100),be(window).unbind("resize",t),be(".ad-video-box").html(""),t("finish",(function(){be(".ad-video-bg").fadeOut(200)}))})),be("div.ad-video-btn").click((function(e){e.preventDefault(),e.stopPropagation(),t("start"),be(".ad-video-bg").fadeIn(200,(function(){be(".ad-video-close").fadeIn(200),t("show",(function(){let t=be(".ad-video-box");t.append(be("<iframe></iframe>").attr("type","text/html").attr("width","100%").attr("height","100%").attr("src","https://www.youtube.com/embed/"+t.data("id")+"?autoplay=1").attr("frameborder","0"))})),be(window).bind("resize",t)})),window.yaCounter174977&&yaCounter174977.reachGoal("showbvideo")}));let e=0,s=setInterval((function(){e++,"string"==typeof window.adBrandingID&&(document.getElementById(window.adBrandingID).offsetHeight>50?(be("div.ad-video-btn").fadeIn(200),clearInterval(s)):e>20&&(clearInterval(s),be("div.ad-video-btn").hide()))}),20)})()}catch(e){i.vE.logger.error("ads","error initializing video ads",e)}const t=ls(".sidebar-block_placeholder");return V.Q.instance.watch(t.filter(":not(.sidebar-block_sticky)"),H.L.RIGHT),V.Q.instance.watch(t.filter(".sidebar-block_sticky"),H.L.RIGHT_LAST),V.Q.instance.watch(ls(".page-story__placeholder"),H.L.COMMENTS),this._initStoryImageDnd(),this}get hotkeys(){return this._hotkeys?this._hotkeys:this._hotkeys=new it.SV(this.$els.document)}get isPageScrollable(){return this._options.isPageScrollable}set isPageScrollable(t){this._options.isPageScrollable!==(t=Boolean(t))&&(this._options.isPageScrollable=t,t?(this.$els.body.removeClass("i-overlay_show").css("margin-right",0),this.header.$el.css("padding-right",0)):(this._marginBody=this.$els.body.outerWidth(),this.$els.body.addClass("i-overlay_show"),this._marginBody=this.$els.body.outerWidth()-this._marginBody,this._marginBody>0&&(this.$els.body.css("margin-right",this._marginBody),this.header.$el.css("padding-right",this._marginBody))))}_showToastAfterReload(){const t=c.mM.get("pkb_mar");t&&(this._showToast(t),c.mM.remove("pkb_mar"))}_showToastListAfterReload(){const t=c.mM.get("pkb_msar");null!=t&&t.length&&(t.forEach((t=>this._showToast(t))),c.mM.remove("pkb_msar"))}_showToast({messageAfterReload:t,theme:e,timeBeforeClose:s}={}){t&&this.toasts.add({content:t,theme:e||v.K.DEFAULT,closeAfter:s||3e3})}}var cs=s(3040);s(500),s(1898),s(5635),s(4603);const ds=s(2109),us=/(^|,)\s*:scope/,ps=new RegExp(us.source,"g"),ms=(()=>{try{document.querySelector(":scope body")}catch(t){return!1}return!0})();function _s(t){return function(e){if(us.test(e)){let s=this.id;this.id="__ID_"+Date.now(),e=e.replace(ps,"$1#"+this.id);let i=t.call(this,e);return this.id=s,i}return t.call(this,e)}}const gs=Element.prototype;ds({target:"Element",proto:!0,forced:!ms},{querySelector:_s(gs.querySelector),querySelectorAll:_s(gs.querySelectorAll)});const vs=Document.prototype;ds({target:"Document",proto:!0,forced:!ms},{querySelector:_s(vs.querySelector),querySelectorAll:_s(vs.querySelectorAll)});s(9595);"document"in window.self&&(!("classList"in document.createElement("_"))||document.createElementNS&&!("classList"in document.createElementNS("http://www.w3.org/2000/svg","g"))?function(t){if(!("Element"in t))return;let e="classList",s=t.Element.prototype,i=Object,n=String.prototype.trim||function(){return this.replace(/^\s+|\s+$/g,"")},o=Array.prototype.indexOf||function(t){let e=0,s=this.length;for(;e<s;e++)if(e in this&&this[e]===t)return e;return-1},r=function(t,e){this.name=t,this.code=DOMException[t],this.message=e},a=function(t,e){if(""===e)throw new r("SYNTAX_ERR","An invalid or illegal string was specified");if(/\s/.test(e))throw new r("INVALID_CHARACTER_ERR","String contains an invalid character");return o.call(t,e)},l=function(t){let e=n.call(t.getAttribute("class")||""),s=e?e.split(/\s+/):[],i=0,o=s.length;for(;i<o;i++)this.push(s[i]);this._updateClassName=function(){t.setAttribute("class",this.toString())}},h=l.prototype=[],c=function(){return new l(this)};if(r.prototype=Error.prototype,h.item=function(t){return this[t]||null},h.contains=function(t){return t=String(t),-1!==a(this,t)},h.add=function(){let t,e=arguments,s=0,i=e.length,n=!1;do{t=String(e[s]),-1===a(this,t)&&(this.push(t),n=!0)}while(++s<i);n&&this._updateClassName()},h.remove=function(){let t,e,s=arguments,i=0,n=s.length,o=!1;do{for(t=String(s[i]),e=a(this,t);-1!==e;)this.splice(e,1),o=!0,e=a(this,t)}while(++i<n);o&&this._updateClassName()},h.toggle=function(t,e){t=String(t);let s=this.contains(t),i=s?!0!==e&&"remove":!1!==e&&"add";return i&&this[i](t),!0===e||!1===e?e:!s},h.toString=function(){return this.join(" ")},i.defineProperty){let t={get:c,enumerable:!0,configurable:!0};try{i.defineProperty(s,e,t)}catch(d){-2146823252===d.number&&(t.enumerable=!1,i.defineProperty(s,e,t))}}else i.prototype.__defineGetter__&&s.__defineGetter__(e,c)}(window.self):function(){let t=document.createElement("_");if(t.classList.add("c1","c2"),!t.classList.contains("c2")){let t=function(t){let e=DOMTokenList.prototype[t];DOMTokenList.prototype[t]=function(t){let s,i=arguments.length;for(s=0;s<i;s++)t=arguments[s],e.call(this,t)}};t("add"),t("remove")}if(t.classList.toggle("c3",!1),t.classList.contains("c3")){let t=DOMTokenList.prototype.toggle;DOMTokenList.prototype.toggle=function(e,s){return 1 in arguments&&!this.contains(e)==!s?s:t.call(this,e)}}t=null}());s(3678),s(1817);"undefined"!=typeof FormData&&FormData.prototype.keys||function(){const t="object"==typeof window?window:"object"==typeof self?self:this,e=t.FormData,s=t.XMLHttpRequest&&t.XMLHttpRequest.prototype.send,i=t.Request&&t.fetch,n=t.Symbol&&Symbol.toStringTag,o=new WeakMap,r=t=>o.get(t),a=Array.from||(t=>[].slice.call(t));n&&(Blob.prototype[n]||(Blob.prototype[n]="Blob"),"File"in t&&!File.prototype[n]&&(File.prototype[n]="File"));try{new File([],"")}catch(u){t.File=function(t,e,s){const i=new Blob(t,s),o=s&&void 0!==s.lastModified?new Date(s.lastModified):new Date;return Object.defineProperties(i,{name:{value:e},lastModifiedDate:{value:o},lastModified:{value:Number(o)},toString:{value:()=>"[object File]"}}),n&&Object.defineProperty(i,n,{value:"File"}),i}}function l([t,e]){return t instanceof Blob&&(t=new File([t],e,{type:t.type,lastModified:t.lastModified})),t}function h(t){if(!arguments.length)throw new TypeError("1 argument required, but only 0 present.");return[String(t)]}function c(t,e,s){if(arguments.length<2)throw new TypeError(`2 arguments required, but only ${arguments.length} present.`);return e instanceof Blob?[String(t),e,void 0!==s?String(s):"string"==typeof e.name?e.name:"Blob"]:[String(t),String(e)]}class d{constructor(t){if(o.set(this,Object.create(null)),!t)return this;for(let e of a(t.elements))if(e.name&&!e.disabled)if("file"===e.type)for(let t of e.files)this.append(e.name,t);else if("select-multiple"===e.type||"select-one"===e.type)for(let t of a(e.options))t.selected&&this.append(e.name,t.value);else"checkbox"===e.type||"radio"===e.type?e.checked&&this.append(e.name,e.value):this.append(e.name,e.value)}append(t,e,s){const i=r(this);i[t]||(i[t]=[]),i[t].push([e,s])}delete(t){delete r(this)[t]}*entries(){const t=r(this);for(let e in t)for(let s of t[e])yield[e,l(s)]}forEach(t,e){for(let[s,i]of this)t.call(e,i,s,this)}get(t){const e=r(this);return e[t]?l(e[t][0]):null}getAll(t){return(r(this)[t]||[]).map(l)}has(t){return t in r(this)}*keys(){for(let[t]of this)yield t}set(t,e,s){r(this)[t]=[[e,s]]}*values(){for(let[t,e]of this)yield e}_asNative(){const t=new e;for(let[e,s]of this)t.append(e,s);return t}_blob(){const t="----formdata-polyfill-"+Math.random(),e=[];for(let[s,i]of this)e.push(`--${t}\r\n`),i instanceof Blob?e.push(`Content-Disposition: form-data; name="${s}"; filename="${i.name}"\r\n`,`Content-Type: ${i.type||"application/octet-stream"}\r\n\r\n`,i,"\r\n"):e.push(`Content-Disposition: form-data; name="${s}"\r\n\r\n${i}\r\n`);return e.push(`--${t}--`),new Blob(e,{type:"multipart/form-data; boundary="+t})}[Symbol.iterator](){return this.entries()}toString(){return"[object FormData]"}}n&&(d.prototype[n]="FormData");if([["append",c],["delete",h],["get",h],["getAll",h],["has",h],["set",c]].forEach((t=>{const e=d.prototype[t[0]];d.prototype[t[0]]=function(){return e.apply(this,t[1].apply(this,a(arguments)))}})),s&&(XMLHttpRequest.prototype.send=function(t){if(t instanceof d){const e=t._blob();this.setRequestHeader("Content-Type",e.type),s.call(this,e)}else s.call(this,t)}),i){const e=t.fetch;t.fetch=function(t,s){return s&&s.body&&s.body instanceof d&&(s.body=s.body._blob()),e(t,s)}}t.FormData=d}();var fs=s(8952),ys=(s(5229),s(8705)),bs=(s(2707),s(7725)),ws=s(1573),Es=s(4002),Ss=s(7240);const Cs=new I.xs({FRESH:1,HOT:2,RELEVANCE:3}),Ts=new I.xs({COMMUNITY:"community",USER:"user",TAG:"tag",ALL:"all",VISITED:"visited"});var Os=s(9050);var ks=s(9050);var Is=s(9050);var $s=s(9050);var As=s(9050);var xs=s(5190);function Ds(t,e){var s=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),s.push.apply(s,i)}return s}function Ps(t,e,s){return e in t?Object.defineProperty(t,e,{value:s,enumerable:!0,configurable:!0,writable:!0}):t[e]=s,t}const Rs=s(9755),Ms=s(6419);class Ns extends n.u1{constructor(t){super(t),this.show()}render(){return this.isRendered||(this.feed.loadAnimationName="stories-search",this.$el||(this.$el=Rs(".stories-search")),this.$els={rating:this.$(".stories-search-rating"),ratingCaption:this.$(".stories-search-rating__caption"),ratingSlider:this.$(".stories-search-rating__slider"),type:this.$(".stories-search__types"),typeGroup:this.$(".stories-search__types-group"),dates:this.$(".stories-search__dates"),datesGroup:this.$(".stories-search__dates-group"),dateRangeButton:this.$('.stories-search-item_button[data-value="range"]'),visited:this.$(".stories-search__visited"),visitedGroup:this.$(".stories-search__visited-group"),textInput:this.$('.input[data-role="search"]'),tags:this.$(".stories-search__tags-group .stories-search__tags"),excludeTags:this.$(".stories-search__tags-group .stories-search__exclude-tags"),tagsGroup:this.$(".stories-search__tags-group"),tagsTitleBlock:this.$(".stories-search__tags-title"),user:this.$(".stories-search__user"),userGroup:this.$(".stories-search__user-group"),userAddInput:this.$(".stories-search__user-group .input"),community:this.$(".stories-search__community"),communityGroup:this.$(".stories-search__community-group"),communityAddInput:this.$(".stories-search__community-group .input"),resultBlock:this.$(".stories-search-results"),loader:this.$(".stories-search__loader"),panel:this.$(".stories-search__feed-panel"),storiesCounter:this.$(".stories-search__feed-panel > span"),sortButton:this.$(".stories-search__feed-panel > a"),sortButtonCaption:this.$(".stories-search__feed-panel > a > span")},this._searchData={linkedTags:i.ZP.config("modules.search.found.linkedTags")||[],tags:i.ZP.config("modules.searchTags")||[],excludeTags:i.ZP.config("modules.searchExcludeTags")||[],type:i.ZP.config("modules.searchType")||0,dateFrom:i.ZP.config("modules.searchDateFrom")||"",dateTo:i.ZP.config("modules.searchDateTo")||"",sort:Cs[i.ZP.config("modules.searchSort")]||Cs.FRESH,rating:i.ZP.config("modules.searchRating")||0,visited:i.ZP.config("modules.searchVisited")||!1,user:i.ZP.config("modules.searchUser")||{avatar:"",name:""},community:i.ZP.config("modules.searchCommunity")||{avatar:"",name:"",link:""}},this._prevRequest="",this._calendar=null,this._calendarPopup=null,this._sortPopup=null,this._searchAnalytics=Z.retrieveSearchSession(),this.listenTo(this.feed,"loaded",this._processFeedLoad.bind(this)),this._form=new a.x(this.$("form")),this.listenTo(this._form,"submit",this._search.bind(this,!0)),this._input=new T.u3({$el:this.$els.textInput,sanitizerRules:[mt.o.trim()]}),this._animation=i.ZP.ui.player.createAnimation("stories-search",{$parent:this.$els.loader}),this._createCalendar(),this._prepareTagsControl(),this._prepareTypesControl(),this._prepareDatesControl(),this._prepareRatingControl(),this._prepareUserControl(),this._prepareCommunityControl(),this._prepareSortControl(),this._updateDateCaption(),this._setFeedSearchParams(),this._updateFoundTagsBlock(),this._updateTitleTagsBlock(),this._updateFoundUsersBlock(),this._updateFoundCommunitiesBlock(),this._prepareLinkedBlock(),i.ZP.isUserAuthorized&&this._prepareVisitedControl(),this._setAnalyticsTagParameter(this._searchData.tags),super.render()),this}_prepareSortControl(){this._sortPopup=pt.g.popupEnum(this.$els.sortButton,Cs,"stories-search.sort-mode",this._searchData.sort),this.$els.sortButton.on("click",(()=>{this._sortPopup.toggle()})),this.listenTo(this._sortPopup,"change",((t,e)=>{e&&(this.$els.sortButtonCaption.text(i.ZP.i18n("stories-search.sort-mode."+e.toString())),this._searchData.sort=e,this._sortPopup.isShown&&(this._sortPopup.hide(),this._search()))}));const t=(0,xs.D)((t=>{const e=this._sortPopup.marks.get("form");if(!e)return;const s=t?Cs.RELEVANCE:Cs.FRESH,i=e.getUIElement(null,s.toString());i&&i.toggleChecked(!0)}),300);this.listenTo(this._input,"input",t),this.listenTo(this._input,"change",t)}_createCalendar(){let t=this._calendar=new Es.E;t.width=Math.min(550,window.innerWidth),t.datesRangeMode=!0,t.showButtonsPanel=!1,t.setDate(this._searchData.dateFrom,this._searchData.dateTo),t.on("select",(e=>{t.isFullRangeSelected?(this._searchData.dateFrom="",this._searchData.dateTo=""):(this._searchData.dateFrom=e.startDate,e.endDate&&e.endDate!==e.startDate?this._searchData.dateTo=e.endDate:this._searchData.dateTo=""),this._updateDateCaption(),this._search()}))}_prepareDatesControl(){let t=this.$els.dates;this.$els.dates.find(".stories-search-item_button").click((e=>{let s=Rs(e.target).closest(".stories-search-item_button"),i=s.attr("data-value");if(t.find(".stories-search-item_button").removeClass("stories-search-item_selected"),s.addClass("stories-search-item_selected"),"range"===i){let t,e=this._calendar;this._calendarPopup?t=this._calendarPopup:(t=this._calendarPopup=new k._(s),t.direction=k.Lh.BOTTOM,t.indent=!1,e.show(),t.content=e.$el),t.show()}else this._calendar.setRangeByType(i),this._updateDateCaption(),this._search()})),""===this._searchData.dateFrom?t.find('.stories-search-item_button[data-value="all_time"]').addClass("stories-search-item_selected"):(t.find('.stories-search-item_button[data-value="range"]').addClass("stories-search-item_selected"),n.u1.getUIElement(this.$els.datesGroup).open())}_updateDateCaption(){this._calendar.isFullRangeSelected?this.$els.dateRangeButton.text(i.ZP.i18n("page-search.captions.interval")):this.$els.dateRangeButton.text(this._calendar.selectedDatesCaption)}_prepareVisitedControl(){let t=this.$els.visited;if(!t.length)return;let e=t.find('.stories-search-item_button[data-value="s"]'),s=t.find('.stories-search-item_button[data-value="h"]'),i="h"!==this._searchData.visited;e.toggleClass("stories-search-item_selected",i),s.toggleClass("stories-search-item_selected",!i),n.u1.getUIElement(this.$els.visitedGroup).toggle(!i),this.$els.visited.find(".stories-search-item_button").click((t=>{let n=Rs(t.target).closest(".stories-search-item_button").data("value");i="h"!==n,e.toggleClass("stories-search-item_selected",i),s.toggleClass("stories-search-item_selected",!i),this._searchData.visited=i?"":"h",this._search()}))}_prepareTypesControl(){let t=this.$els.type;if(this.$els.type.find(".stories-search-item_button").click((e=>{let s=Rs(e.target).closest(".stories-search-item_button"),i=s.attr("data-value"),n=s.hasClass("stories-search-item_selected");"0"===i?n||(t.find(".stories-search-item_button").removeClass("stories-search-item_selected"),s.addClass("stories-search-item_selected")):(t.find('.stories-search-item_button[data-value="0"]').removeClass("stories-search-item_selected"),s.toggleClass("stories-search-item_selected",!n)),this._updateTypesList(),this._search()})),0===this._searchData.type)t.find('.stories-search-item_button[data-value="0"]').addClass("stories-search-item_selected");else{for(let e of[2,4,16,32])t.find(`.stories-search-item_button[data-value="${e}"]`).toggleClass("stories-search-item_selected",(this._searchData.type&e)===e);n.u1.getUIElement(this.$els.typeGroup).open()}}_updateTypesList(){let t=0;this.$els.type.find(".stories-search-item_selected[data-value]").each(((e,s)=>{t|=Number(s.getAttribute("data-value"))})),this._searchData.type=t}_prepareTagsControl(){const t=this._tagsList=new Ss.EZ({$el:this.$els.tags,items:this._searchData.tags,analyticsType:"search_similar_tags_popup"});this.listenTo(t,"change",(t=>{this._updateTagsList(t),this._updateTitleTagsBlock(),this._search()}));const e=new Ss.EZ({$el:this.$els.excludeTags,items:this._searchData.excludeTags});e.tagsInput.suggestion.parseFilter=e=>!t.items.includes(e.name),this.listenTo(e,"change",(t=>{this._updateExcludeTagsList(t),this._search()})),n.u1.getUIElement(this.$els.tagsGroup).toggleGroup(t.items.length>0||e.items.length>0)}_prepareUserControl(){if(!this.$els.userAddInput.length)return;const{user:t}=this._searchData;let e=new Ss._d({$el:this.$els.user,items:[t]});e.on("change",(t=>{this._updateUsersList(t),this._search()})),null!=t&&t.name&&(e.addItem(t),n.u1.getUIElement(this.$els.userGroup).open())}_prepareCommunityControl(){if(!this.$els.communityAddInput.length)return;const{community:t}=this._searchData;let e=new Ss.C2({$el:this.$els.community,items:[t]});e.on("change",(t=>{this._updateCommunitiesList(t),this._search()})),null!=t&&t.name&&(e.addItem(t),n.u1.getUIElement(this.$els.communityGroup).open())}_updateTagsList(t){this._searchData.tags=t,this._setAnalyticsTagParameter(t),this._toggleLinkedTagsBlock(!1)}_setAnalyticsTagParameter(t){null!=t&&t.length?oe.cp.getInstance().clickhouse.commonParameters.screen_tag=t.join(","):delete oe.cp.getInstance().clickhouse.commonParameters.screen_tag}_updateExcludeTagsList(t){this._searchData.excludeTags=t,Array.isArray(this._lastLinkedTags)&&this._updateLinkedTagsBlock(this._lastLinkedTags.filter((e=>!t.includes(e))))}_updateUsersList(t){this._searchData.user=t[0]||{name:"",avatar:""}}_updateCommunitiesList(t){this._searchData.community=t[0]||{name:"",avatar:"",link:""}}_prepareRatingControl(){const t=[-200,...W];let e=new ws.T;e.options=t;let s=this._searchData.rating;e.value=t[s]||-200,s>0&&this.$els.ratingCaption.text(i.ZP.i18n("page-search.captions.rating",t[s])),e.on("change",(e=>{this.$els.rating.attr("data-rating",e),this._searchData.rating=t.indexOf(e),this.$els.ratingCaption.text(i.ZP.i18n("page-search.captions.rating",e)),this._search()})),this.$(".stories-search-rating__slider").append(e.show().$el),n.u1.getUIElement(this.$els.rating).toggleGroup(s>0)}_replaceLocation(t){const e=function(t){for(var e=1;e<arguments.length;e++){var s=null!=arguments[e]?arguments[e]:{};e%2?Ds(Object(s),!0).forEach((function(e){Ps(t,e,s[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(s)):Ds(Object(s)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(s,e))}))}return t}({},t),s=this.searchMode===Ts.VISITED;let n;s?n="Просмотренные":(n=Ms.isUndefined(e.q)?Ms.isUndefined(e.t)?"Поиск":e.t.replace(/[<>&]/g,"").replace(/,\s*/g,", "):e.q.replace(/[<>&]/g,"")+" - Поиск",void 0!==e.q?n=e.q.replace(/[<>&]/gi,"")+" - Поиск":void 0!==e.t&&(n=e.t.replace(/[<>&]/gi,"").replace(/,/gi,", ")));const o=!Ms.isUndefined(e.cl)&&this.searchMode===Ts.COMMUNITY,r=!Ms.isUndefined(e.u)&&this.searchMode===Ts.USER,a=!Ms.isUndefined(e.t)&&[Ts.TAG,Ts.ALL].includes(this.searchMode);let l="/search";switch(!0){case s:l="/visited-stories";break;case o:l="/community/"+e.cl+"/search",delete e.cl;break;case r:l="/@"+e.u+"/search",delete e.u;break;case a:const t=e.t.split(",").sort();if(t.length>=3)break;l="/tag/"+t.map((t=>encodeURIComponent(t))).join(","),delete e.t;const i=3===e.r,n={default:!e.hasOwnProperty("st")||1===e.st,best:2===e.st,relevance:3===e.st};n.best&&!i&&(l+="/best",delete e.st),n.relevance&&i&&(l+="/hot",delete e.r),n.default&&i&&(l+="/hot",delete e.st,delete e.r);break;default:l="/search"}const h=Rs.param(e);document.title=n;const c=l+(h?"?"+h:"");i.ZP.history.replaceState(e,n,c),this.feed.requestUrl=c}_search(){const{data:t}=this._getData();this._animation&&this._animation.play(),this._replaceLocation(t),this._clearSearchResults(),this.timeout("request",1500,this._searchRequest)}_searchRequest(){this._setFeedSearchParams(),this._searchAnalytics.sendSearchEvent(this._input.value,this._searchData),this.feed.clear().loadStories(!1)}_setFeedSearchParams(){let{data:t,emptyKeys:e}=this._getData();for(let s of e)this.feed.searchParams.delete(s);for(let s in t)t.hasOwnProperty(s)&&this.feed.searchParams.set(s,t[s])}_clearSearchResults(){this.marks.get("cleanResults")||(this._updateFoundTagsBlock([]),this._updateFoundUsersBlock([]),this._updateFoundCommunitiesBlock([]),this.$els.panel.hide(),this.feed.clear(),this.marks.set("cleanResults",!0))}_processFeedLoad(t){this.marks.set("cleanResults",!1),this.$els.storiesCounter.text(t.total+" "+i.ZP.i18n("^page-search.stories('%0')",t.total)),this.$els.panel.show(),this._animation&&this._animation.stop(),void 0!==t.linked_tags&&this._updateLinkedTagsBlock(t.linked_tags),void 0!==t.tags&&this._updateFoundTagsBlock(t.tags),void 0!==t.users&&this._updateFoundUsersBlock(t.users),void 0!==t.communities&&this._updateFoundCommunitiesBlock(t.communities)}_getData(){let t,e=[],s={};return t=this._input.value,""!==t?s.q=t:e.push("q"),t=this._searchData.tags.sort().join(","),""!==t?s.t=t:e.push("t"),t=this._searchData.excludeTags.join(","),""!==t?s.et=t:e.push("et"),t=this._searchData.type,0!==t?s.n=t:e.push("n"),t=this._searchData.sort.valueOf(),1!==t?s.st=t:e.push("st"),t=this._searchData.rating,0!==t?s.r=t:e.push("r"),t=this._searchData.user.name,""!==t?s.u=t:e.push("u"),t=this._searchData.community.link,""!==t?s.cl=t:e.push("cl"),t=this._searchData.visited,!1!==t&&""!==t?s.vn=t:e.push("vn"),t=this._searchData.dateFrom,""!==t?s.d=String(Ns.date2Days(t)):e.push("d"),t=this._searchData.dateTo,""!==t?s.D=String(Ns.date2Days(t)):e.push("D"),{data:s,emptyKeys:e}}static date2Days(t){let e=t.split("-"),s=new Date(2008,0,1,0,0,0,0),i=new Date(parseInt(e[0]),parseInt(e[1])-1,parseInt(e[2]),0,0,0,0).getTime()-s;return i<0&&(i=0),Math.round(i/864e5)}_prepareLinkedBlock(){this.$els.linkedTags=this.$(".stories-search__linked-tags").on("click",".tags__tag",(t=>{t.preventDefault(),this._tagsList.addItem(t.currentTarget.dataset.tag)})),this.$els.linkedTags.get(0).querySelectorAll(".tags__tag").forEach((t=>{t.dataset.analyticsType="search_similar_tags_popup"}))}_toggleLinkedTagsBlock(t){const e=this.$els.linkedTags;if(!e.length)return;e.is(":visible")!==t&&(t?e.slideDown():e.slideUp())}_updateLinkedTagsBlock(t){const e=this.$els.linkedTags;if(!e.length)return;const s=1===this._searchData.tags.length&&t.length>0;this._lastLinkedTags=t,s?(e.empty().append(function(t){var e="",s=$s.escape;return Array.prototype.join,e+='С этим тегом используют:\n<div class="tags">\n    ',t.tags.forEach((i=>{e+='\n        <a class="tags__tag" href="/tag/'+s([t.key,i].sort().join(","))+'/hot"  data-tag="'+s(i)+'" target="_blank" rel="noopener">'+s(i)+"</a>\n    "})),e+='\n</div>\n<a href="/linked-tags/'+s(t.key)+'" target="_blank" rel="noopener">Все теги</a>\n'}({tags:t,key:this._searchData.tags[0]})),this._toggleLinkedTagsBlock(!0)):this._toggleLinkedTagsBlock(!1)}async _updateTitleTagsBlock(){const t=this._searchData.tags,e=t[0];if(!t.length)return void this.$els.tagsTitleBlock.hide();let s=!1,i=!1;const n=1===t.length,o=t.join(" и ");if(n){const t=await bs.zG.getListSubsIgnore(!0);s=t.subs.map((t=>t.toLowerCase())).includes(e.toLowerCase()),i=t.ignore.map((t=>t.toLowerCase())).includes(e.toLowerCase())}const r=Rs(function(t){var e="",s=As.escape;return Array.prototype.join,e+='<div class="stories-search__tags-wrapper">\n\t<h1>'+s(t.title)+"</h1>\n\n\t",t.renderSubscribeButton&&(e+='\n\t\t<span class="stories-search__tags-buttons button-group ',t.subscribed||(e+=" button-group_success "),e+='"\n\t\t\t  data-role="subscribe"\n\t\t\t  data-type="tag"\n\t\t\t  data-tag="'+s(t.tag)+'"\n\t\t\t  data-ignore-actions="'+s(t.ignored?"unignore":"ignore")+'"\n\t\t\t  data-analytics-type="header"\n\t\t\t  data-id="1">\n\t\t\t<button type="button">',t.subscribed?e+="Отписаться":e+="Подписаться",e+='</button><button type="button" class="button_dot"></button>\n\t\t</span>\n\t'),e+="\n</div>\n"}({renderSubscribeButton:n,subscribed:s,ignored:i,tag:e,title:o}));this.$els.tagsTitleBlock.empty().append(r),this.$els.tagsTitleButton=this.$(".stories-search__tags-wrapper .button-group"),this.$els.tagsTitleButton.toggle(n),this.$els.tagsTitleBlock.show()}_updateFoundTagsBlock(t=null){let e=this.$els.resultBlock.find(".stories-search-result_tags");if(e.slideUp(200,(()=>{e.remove()})),null===t&&(t=i.ZP.config("modules.foundTags")||[]),0===t.length)return;let s=Rs(function(t){var e,s="",i=ks.escape;Array.prototype.join,s+='<section class="stories-search-result stories-search-result_tags">\n\t',t.tags.length>5&&(s+='\n\t\t<a href="javascript: void(0);" data-role="show-all">'+(null==(e=t.tagsCount)?"":e)+'</a>\n\t\t<a href="javascript: void(0);" data-role="collapse">свернуть</a>\n\t'),s+="\n\t";for(var n=0,o=t.tags,r=o.length;n<r;n++)s+='\n\t\t<a class="tag stories-search-result__tag stories-search-result__item '+i(n>4?"stories-search-result__item_hidden":"")+'"\n\t\t   href="/tag/'+(null==(e=encodeURIComponent(o[n].name))?"":e)+'/hot">'+i(o[n].name)+"</a>\n\t";return s+"\n</section>\n"}({tags:t,tagsCount:t.length+" "+i.ZP.i18n("^page-search.tags('%0')",t.length)}));this.$els.resultBlock.append(s),s.slideDown(200),s.find('a[data-role="show-all"]').click((()=>{s.addClass("stories-search-result_show-all")})),s.find('a[data-role="collapse"]').click((()=>{s.removeClass("stories-search-result_show-all")}))}_updateFoundUsersBlock(t=null){let e=this.$els.resultBlock.find(".stories-search-result_users");if(e.slideUp(200,(()=>{e.remove()})),null===t&&(t=i.ZP.config("modules.foundUsers")||[]),0===t.length)return;let s=Rs(function(t){var e,s="",i=Is.escape;Array.prototype.join,s+='<section class="stories-search-result stories-search-result_users">\n\t',t.users.length>5&&(s+='\n\t\t<a href="javascript: void(0);" data-role="show-all">'+(null==(e=t.usersCount)?"":e)+'</a>\n\t\t<a href="javascript: void(0);" data-role="collapse">свернуть</a>\n\t'),s+="\n\t";for(var n=0,o=t.users,r=o.length;n<r;n++)s+='\n\t\t<a class="user user_inline stories-search-result__user stories-search-result__item '+i(n>4?"stories-search-result__item_hidden":"")+'"\n\t\t   href="/@'+i(o[n].name)+'">\n\t\t\t<span class="avatar avatar_small"><img src="'+i(o[n].avatar)+'"></span>\n\t\t\t<span>'+i(o[n].name)+"</span>\n\t\t\t",o[n].approval&&(s+='\n\t\t\t<span class="user__label hint" data-type="approved" aria-label="'+i(o[n].approval)+'"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon--ui__approved"><use xlink:href="#icon--ui__approved"></use></svg></span>\n\t\t\t'),s+="\n\t\t</a>\n\t";return s+"\n</section>\n"}({users:t,usersCount:t.length+" "+i.ZP.i18n("^page-search.users('%0')",t.length)}));this.$els.resultBlock.append(s),s.slideDown(200),s.find('a[data-role="show-all"]').click((()=>{s.addClass("stories-search-result_show-all")})),s.find('a[data-role="collapse"]').click((()=>{s.removeClass("stories-search-result_show-all")}))}_updateFoundCommunitiesBlock(t=null){let e=this.$els.resultBlock.find(".stories-search-result_communities");if(e.slideUp(200,(()=>{e.remove()})),null===t&&(t=i.ZP.config("modules.foundCommunities")||[]),0===t.length)return;t.forEach((t=>{let e=t.subs.split(" ")[0];t.subs=`<b>${e}</b> ${i.ZP.i18n("plural.subs",e)}`;let s=t.stories.split(" ")[0];t.stories=`<b>${s}</b> ${i.ZP.i18n("plural.stories",s)}`}));let s=Rs(function(t){var e,s="",i=Os.escape;Array.prototype.join,s+='<section class="stories-search-result stories-search-result_communities">\n\t',t.communities.length>3&&(s+='\n\t\t<a href="javascript: void(0);" data-role="show-all">Показать все '+(null==(e=t.communitiesCount)?"":e)+'</a>\n\t\t<a href="javascript: void(0);" data-role="collapse">свернуть</a>\n\t'),s+="\n\t";for(var n=0,o=t.communities,r=o.length;n<r;n++)s+='\n\t\t<div class="community stories-search-result__item '+i(n>3?"stories-search-result__item_hidden":"")+'" data-id="'+i(o[n].id)+'">\n\t\t\t<div class="community-avatar community-avatar_medium"><img src="'+i(o[n].avatar)+'" alt=""></div>\n\t\t\t<div class="community__wrapper">\n\t\t\t\t<div class="community__title"><a href="/community/'+i(o[n].link)+'">'+i(o[n].name)+'</a></div>\n\t\t\t\t<div class="community__information">\n\t\t\t\t\t<span>'+(null==(e=o[n].stories)?"":e)+"</span> <span>•</span> <span>"+(null==(e=o[n].subs)?"":e)+'</span>\n\t\t\t\t</div>\n\t\t\t\t<div class="community__tags tags">\n\t\t\t\t\t',o[n].tags.forEach((function(t){s+='\n\t\t\t\t\t<a href="/communities/tag/'+i(t)+'" class="tags__tag" target="_blank" title="Поиск сообществ по тегу &quot;'+i(t)+'&quot;">\n\t\t\t\t\t\t'+i(t)+"\n\t\t\t\t\t</a>\n\t\t\t\t\t"})),s+="\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</div>\n\t";return s+="\n</section>\n"}({communities:t,communitiesCount:t.length+" "+i.ZP.i18n("page-search.communities",t.length)}));this.$els.resultBlock.append(s),s.slideDown(200),s.find('a[data-role="show-all"]').click((()=>{s.addClass("stories-search-result_show-all")})),s.find('a[data-role="collapse"]').click((()=>{s.removeClass("stories-search-result_show-all")}))}get searchMode(){return this._options.searchMode||Ts.ALL}get feed(){return this._options.feed}set feed(t){this._options.feed!==t&&(this._options.feed=t)}}var Bs=s(150),Ls=s(7944),Fs=s(3589),Us=s(3181),js=s(9050);class Vs extends Fs.T3{render(){var t;null===(t=this.$el)||void 0===t||t.get(0).querySelectorAll('[data-role="subscribe"], [data-role="ignore"], .profile__user-notification-bell').forEach((t=>{t.dataset.analyticsType="header"})),this.initCompanyBlogBadgeAnalytics()}initCompanyBlogBadgeAnalytics(){var t;const e=null===(t=this.el)||void 0===t?void 0:t.querySelector(".profile__company-blog-badge");if(!e)return;const s=()=>{oe.cp.getInstance().sendEvent("click",{type:"company_blog_label"})};e.addEventListener("click",s),e.addEventListener("auxclick",(t=>{1===t.button&&s()}))}initQueueBox({container:t,StoriesFeed:e,SimilarStories:s}){const i=t.find(".community-stories-queue__button");new e({$el:t,feedName:"community-queue"}),i.on("click",(()=>{i.slideUp(200,(()=>i.remove())),t.find(".stories-feed__container").fadeIn(500)}));const n=t=>{var e;return null!==(e=ee()(t).closest(".community-queue-panel").attr("data-queue-id"))&&void 0!==e?e:""},o=t=>Number(ee()(t).data("com-id"))||0;ee()('.community-queue-panel__buttons button[data-role="allow"]').click((({target:t,currentTarget:e})=>{this.approveStory(n(t),o(e),me.dO.APPROVED)})),ee()('.community-queue-panel__buttons button[data-role="deny"]').click((({target:t,currentTarget:e})=>{this.approveStory(n(t),o(e),me.dO.REJECTED)})),ee()('.community-queue-panel__buttons button[data-role="cancel-community-change"]').click((({target:t,currentTarget:e})=>{this.approveStory(n(t),o(e),me.dO.MOVED_TO_COMMON_FEED)})),ee()(".community-queue-panel__buttons .community-queue-panel__cmp").click((({target:t,currentTarget:e})=>{this.showCompareResults(n(t),o(e),s)}))}async showCompareResults(t,e,s){const n=ee()(`.community-queue-panel[data-queue-id="${t}"] .community-queue-panel__similar-stories`);let o=this.marks.get(t);if(o)n.slideToggle();else{o=new s({$parent:n,type:Us.VQ.MANUAL,queueId:t}),this.marks.set(t,o),o.show(),o.state=Us.DX.WAIT;try{const s=new me.S1(e),i=await s.getComporatorResultForQueue(t);js.default.isObject(i)&&Object.keys(i).length?o.addSources(i):o.state=Us.DX.EMPTY}catch(r){i.vE.ui.toasts.showError(r)}n.slideDown()}}async approveStory(t,e,s){const n=ee()(`.community-queue-panel[data-queue-id="${t}"]`),o=n.find("button");if(n.attr("disabled","disabled"),o.attr("disabled","disabled"),s===me.dO.APPROVED){const t=xe.m.get(me.ob)||0;Date.now()-t<me.Qu&&oe.cp.getInstance().yandex.goal("community_fast-approve"),xe.m.set(me.ob,Date.now())}try{const r=new me.S1(e),a=await r.processStoryInQueue(t,s);this.toastApprove&&a.length&&(this.toastApprove.hide(),this.timeout("reopen",200,(()=>{this.toastApprove.content=a,this.toastApprove.show()}))),n.removeAttr("disabled"),o.removeAttr("disabled");const l=n.find(".community-queue-panel__message"),h=n.closest(".story"),c=l.find("a");let d,u=4;l.find("span").text(i.vE.i18n("page-community."+(s===me.dO.APPROVED?"approved":"disapproved")));const p=()=>{d&&clearTimeout(d),h.slideUp(400,(()=>h.remove()))},m=()=>{u--,u>=0&&(c.text(`закрыть (${u} сек)`),u>0?d=setTimeout(m,1e3):p())};c.click(p),m(),l.slideDown(400);const _=ee()('.bell[data-role="community"]');let g=Number(_.text()||"0");--g>0?_.text(String(g)):_.hide()}catch(r){n.removeAttr("disabled"),o.removeAttr("disabled"),r.message.length&&i.vE.ui.toasts.showError(r)}}}var Hs=s(8941),qs=s(9050);var Ws=s(103);const Gs=s(9755),Ys=s(6419);class zs extends Vs{render(){if(this.isRendered)return this;if(this.$el=Gs(".profile"),this._userId=this.$el.data("user-id"),this._userNick=this.$el.find(".profile__nick a").text(),this._userRating=Number(this.$el.data("rating")),this._xhrNote=void 0,this._profileUserCache=c.hG.getInstance("profileUser"),i.vE.ui.screen=lt.d.USER,oe.cp.getInstance().clickhouse.commonParameters.screen_user=this._userId,this.$els={note:this.$('.input[data-role="note"]'),noteText:this.$(".profile-note__text"),noteTextarea:this.$(".profile-note__textarea"),noteLoading:this.$(".profile-note__loading"),aboutInfo:this.$(".profile__user-about"),aboutInfoContent:this.$(".profile__user-about-content"),notificationBell:this.$(".profile__user-notification-bell"),subscribeBtnGroup:this.$('.button-group[data-role="subscribe"]'),awardsMore:this.$('button[data-role="awards-more"]').on("click",this._onClickAwardsMore.bind(this)),communitiesMore:this.$('button[data-role="communities-more"]').on("click",this._onClickCommunitiesMore.bind(this)),bansMore:Gs(".profile__bans-more").on("click",this._onClickBannedMore.bind(this)),block:this.$('.profile__mod[data-role="block"]').on("click",this._onClickBlockNewUser.bind(this)),search:Gs(".stories-search"),adminNotes:Gs(".admin-notes")},this.$els.note.length){this._note=new fs.G(this.$els.note),this.$els.noteText.removeClass("profile-note__text_invisible"),this.$els.noteTextarea.removeClass("profile-note__textarea_initial"),this.$els.noteLoading.length&&this.$els.noteLoading.fadeOut(200);const t=(0,xs.D)(this._onChangeNote.bind(this),1500);this.listenTo(i.vE.ui,"resize",Ys.throttle((()=>{this._note.autoSize()}),400)),this.listenTo(this._note,"input",t),this.listenTo(this._note,"cut",t),this.listenTo(this._note,"paste",t),this.listenTo(this._note,"blur",(t=>{this._note.value=this._note.value.replace(/ +/gm," "),this.$els.noteText.html(u.User.noteValueToHtml(t.target.value,{cropLinks:!0,commentLinks:!0})),this._note.value=this._note.value.trim(),this._note.value.length&&this._note.$els.input.filter("textarea").addClass("profile-note__textarea_invisible"),this._note.autoSize()})),this.listenTo(this._note,"focus",(t=>{this._note.$els.input.filter("textarea").removeClass("profile-note__textarea_invisible"),t.target.setSelectionRange(t.target.value.length,t.target.value.length)})),this.$els.noteText.on("click","a",(t=>(window.open(t.target.href,"_blank").focus(),!1))),this._noteSaved=this._note.value}if(this.$els.adminNotes.length){const t=Gs(".admin-note__body");this.$els.adminNotes.find(".admin-notes__header").on("click",(()=>this.$els.adminNotes.toggleClass("admin-notes_collapsed"))),t.each(((t,e)=>{e.innerHTML=u.User.noteValueToHtml(e.innerText,{newLineToBr:!0,commentLinks:!0})}))}return this.$els.aboutInfo.length&&(this.$els.aboutInfoContent.html(u.User.noteValueToHtml(this.$els.aboutInfoContent.text(),{noFollow:!0})),this.$els.aboutInfo.removeClass("profile__user-about_invisible")),this._feed=new ys._D({$el:Gs(".stories-feed"),feedName:this.$els.search.length?"profile-search":"profile",focused:!0}),this.$els.search.length&&(this._search=new Ns({feed:this._feed,searchMode:Ts.USER,$el:this.$els.search})),new Je({subscribeBtnEl:this.$els.subscribeBtnGroup[0],uiSubscribeBtnComponet:"UISubscribeButton",notificationBellOptions:{el:this.$els.notificationBell[0],user:this.user,showHint:!0,profileType:"author_page"}}),"?subscribe_suggestion"===i.vE.history.location.search&&oe.cp.getInstance().sendEvent("transition_to_author",{type:"subscribe_suggest_author",author_id:this._userId}),this.$el.find(".profile__communities a.community__title").on("click auxclick",(t=>{0!==t.button&&1!==t.button||oe.cp.getInstance().sendEvent("transition_to_community",{type:"from_user",community_id:Number(t.currentTarget.dataset.id||0)})})),new Hs.n,super.render(),this.initQueueBox(),this}async _onClickBlockNewUser(t){t.preventDefault();let e=Gs(function(t){var e="",s=qs.escape;return Array.prototype.join,e+='<div class="profile__mod-confirm">\n\tВы&nbsp;действительно хотите забанить пользователя, а&nbsp;также <b>безвозвратно удалить</b> все комментарии и&nbsp;посты данного пользователя?\n\t<p>Данная операция необратима!</p>\n\t',t&&t.length>0&&(e+='\n\t\t<form class="profile__mod-form">\n\t\t\t<p><label class="profile__mod-label" for="profile__mod-reason">Причина:</label></p>\n\t\t\t<select class="profile__mod-select" id="profile__mod-reason" name="reason">\n\t\t\t\t',t.forEach((function(t){e+='\n\t\t\t\t<option value="'+s(t.id)+'"'+s(124===t.id?" selected":"")+">"+s(t.name)+"</option>\n\t\t\t\t"})),e+="\n\t\t\t</select>\n\t\t</form>\n\t"),e+="\n</div>\n"}(this.$els.block.data("reasons"))),s=new Ls.C(e.find("select"));await pt.g.confirmBalloon({target:this.$els.block,content:e,buttons:[["modal.ban",Bs.j.DANGER,!0],["modal.cancel"]]})&&(await this.user.block(Number(s.value)),window.location.reload())}_onClickAwardsMore(t){t&&Ys.isFunction(t.preventDefault)&&t.preventDefault(),this.$(".profile__award").fadeIn(),this.$els.awardsMore.hide()}_onClickCommunitiesMore(t){t&&Ys.isFunction(t.preventDefault)&&t.preventDefault(),this.$(".community").show(),this.$els.communitiesMore.hide()}_onClickBannedMore(t){t&&Ys.isFunction(t.preventDefault)&&t.preventDefault(),Gs(".profile__bans tr:hidden").show(),this.$els.bansMore.hide()}async _onChangeNote(t){if(this._xhrNote||t===this._noteSaved)return this;this._resetNoteCacheValue(t),this._xhrNote=!0;try{await this.user.note(t),i.vE.ui.toasts.add("profile-note-saved",{content:i.vE.i18n("users.note-saved"),closeAfter:3e3}),u.User.changeMiniProfileNote(this._userNick,t),oe.cp.getInstance().sendEvent(this._noteSaved?"user_note_edit":"user_note_add",{"author_id!empty":this._userId,"rating!undefined":this._userRating},[oe.b0.CLICKHOUSE]),this._noteSaved=t}catch(e){i.vE.ui.toasts.showError(e)}this._xhrNote=!1}_resetNoteCacheValue(t){(""===this._noteSaved&&""!==t||""!==this._noteSaved&&""===t)&&this._profileUserCache.has(this._userNick)&&this._profileUserCache.remove(this._userNick)}initQueueBox(){const t=Gs(".community-stories-queue");t.length&&(this.toastApprove=new v.O({closeAfter:1e4,destroyAfterHide:!1,addCloseButton:!0}),super.initQueueBox({container:t,StoriesFeed:ys._D,SimilarStories:Ws.Bi}))}get user(){let t=this._options.user;return t||(t=this._options.user=new u.User(this._userId)),t}}s(1637);var Zs=s(4850);let Ks;!function(t){t[t.RATING_ALREADY_ACCEPTED=101]="RATING_ALREADY_ACCEPTED",t[t.RATING_ALREADY_REJECTED=102]="RATING_ALREADY_REJECTED"}(Ks||(Ks={}));var Xs=s(9895);function Qs(t,e){var s=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),s.push.apply(s,i)}return s}function Js(t){for(var e=1;e<arguments.length;e++){var s=null!=arguments[e]?arguments[e]:{};e%2?Qs(Object(s),!0).forEach((function(e){ti(t,e,s[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(s)):Qs(Object(s)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(s,e))}))}return t}function ti(t,e,s){return e in t?Object.defineProperty(t,e,{value:s,enumerable:!0,configurable:!0,writable:!0}):t[e]=s,t}const ei="adm_rcm_tip";class si extends Fs.T3{render(){const t=this.el.querySelector(".section_recommend-tip");if(t){var e;if(!Boolean(xe.m.get(ei)))t.classList.remove("section_hidden"),null===(e=t.querySelector('[data-role="close"]'))||void 0===e||e.addEventListener("click",(e=>{t.style.display="none",xe.m.set(ei,!0)}),{once:!0})}super.render()}initFirstStoryAlert(){var t,e;const s=document.querySelector(".story__first-story_author");if(!s)return;const i={post_id:this._storyId,pluses:s.dataset.pluses,minuses:s.dataset.minuses};null===(t=s.querySelector(".story__first-story-accept"))||void 0===t||t.addEventListener("click",(async()=>{let{response:t}=await S.cf.post("/ajax/first_story/accept",{story_id:this._storyId});t.result?(d.c.getInstance().sendEvent("click",Js({type:"get_first_rating"},i)),window.location.reload()):this.handleFirstStoryErrorResponse(t)}),{once:!0}),null===(e=s.querySelector(".story__first-story-reject"))||void 0===e||e.addEventListener("click",(async()=>{let{response:t}=await S.cf.post("/ajax/first_story/reject",{story_id:this._storyId});var e;t.result?(d.c.getInstance().sendEvent("click",Js({type:"not_get_first_rating"},i)),s.remove(),null===(e=document.querySelector(".story__first-story_readers"))||void 0===e||e.remove()):this.handleFirstStoryErrorResponse(t)}),{once:!0})}handleFirstStoryErrorResponse(t){i.vE.ui.toasts.showError(t.message||"comments.error.400");const e={[Ks.RATING_ALREADY_ACCEPTED]:"already_recieved_first_rating",[Ks.RATING_ALREADY_REJECTED]:"already_refused_first_rating"}[t.messageCode];e&&d.c.getInstance().sendEvent("tip_show",{type:e})}initViewTimeRecorder(){let t={};document.querySelectorAll("article[data-story-id]").forEach((e=>{const s=`story-${e.dataset.storyId}`;t[s]||(t[s]=[]),t[s].push(e)})),Xs.Z.getInstance().addItems(t)}}s(7207);const ii=s(9755);class ni{constructor(t){this.$page=t||ii(".page-story__story .story").first(),this.storyLink=this._getStoryLink(),0!==this.storyLink.length&&(this.$classes={box:"smm-copy-tool",msg:"smm-copy-tool__message"},this._render())}_getStoryLink(){let t=this.$page.data("story-id");return t>0?"pikabu.ru/story/_"+t:""}_render(){const t=this.$page.find(".story__main").first();this.$els={story:t,app:ii(".app").first(),title:t.find(".story__title-link"),author:t.find(".story__header a.user__nick"),tags:t.find(".story__tags a.tags__tag"),blocks:t.find(".story-block")},this.$els.author.length||(this.$els.author=t.find(".story__user-info")),this.imageCount=0,this._showedMsg=!1,setTimeout((()=>{this._parseTags(),this._parseBlocks(),this._renderButton()}),2e3)}_renderButton(){this.$els.box=ii(function(t){var e,s="";return s+'<div class="'+(null==(e=t.$classes.box)?"":e)+'">\n\t<div class="'+(null==(e=t.$classes.box)?"":e)+'__button-set">\n\t\t<div class="'+(null==(e=t.$classes.box)?"":e)+"__button "+(null==(e=t.$classes.box)?"":e)+'__action" data-type="simple" title="Копировать пост (img: '+(null==(e=t.imageCount)?"":e)+')">\n\t\t\t<div class="'+(null==(e=t.$classes.box)?"":e)+'__button-icon fa fa-clipboard"></div>\n\t\t\t<span>&nbsp;'+(null==(e=t.imageCount)?"":e)+'</span>\n\t\t</div>\n\t\t<div class="'+(null==(e=t.$classes.box)?"":e)+"__button "+(null==(e=t.$classes.box)?"":e)+'__action" data-type="links-only" title="Копировать только ссылку и автора">\n\t\t\t<i class="fa fa-link '+(null==(e=t.$classes.box)?"":e)+'__button-icon" aria-hidden="true"></i>\n\t\t</div>\n\t\t<div class="'+(null==(e=t.$classes.box)?"":e)+"__button "+(null==(e=t.$classes.box)?"":e)+'__sublist-box">\n\t\t\t<i class="'+(null==(e=t.$classes.box)?"":e)+'__button-icon" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon--ui__extra"><use xlink:href="#icon--ui__extra"></use></svg></i>\n\t\t\t<ul class="'+(null==(e=t.$classes.box)?"":e)+'__sublist">\n\t\t\t\t<li class="'+(null==(e=t.$classes.box)?"":e)+'__action" data-type="simple" data-type-override="post" title="Копировать как обычный пост">\n\t\t\t\t\t<i class="fa fa-clipboard" aria-hidden="true"></i>\n\t\t\t\t\t<span>Пост</span>\n\t\t\t\t</li>\n\t\t\t\t<li class="'+(null==(e=t.$classes.box)?"":e)+'__action" data-type="simple" data-type-override="longpost" title="Копировать как длиннопост">\n\t\t\t\t\t<i class="fa fa-clipboard" aria-hidden="true"></i>\n\t\t\t\t\t<span>Длиннопост</span>\n\t\t\t\t</li>\n\t\t\t\t<li class="'+(null==(e=t.$classes.box)?"":e)+'__action" data-type="links-only" data-type-override="post" title="Копировать ссылку и автора как обычный пост">\n\t\t\t\t\t<i class="fa fa-link" aria-hidden="true"></i>\n\t\t\t\t\t<span>Пост (ссылка)</span>\n\t\t\t\t</li>\n\t\t\t\t<li class="'+(null==(e=t.$classes.box)?"":e)+'__action" data-type="links-only" data-type-override="longpost" title="Копировать ссылку и автора как длиннопост">\n\t\t\t\t\t<i class="fa fa-link" aria-hidden="true"></i>\n\t\t\t\t\t<span>Длиннопост (ссылка)</span>\n\t\t\t\t</li>\n\t\t\t</ul>\n\t\t</div>\n\t</div>\n\t<div class="'+(null==(e=t.$classes.msg)?"":e)+'">Скопировано в буфер обмена 👍</div>\n</div>'}({$classes:this.$classes,imageCount:this.imageCount})),this.$els.box.on("click",`.${this.$classes.box}__action`,(t=>{let e=ii(t.currentTarget);this._copyToClipboard(e.data("type"),e.data("type-override"))})),this.$els.msg=this.$els.box.find(`.${this.$classes.msg}`),this.$els.app.append(this.$els.box)}_parseTags(){this.tags=Array.from(this.$els.tags).map((t=>t.innerText)).filter((t=>t.length>0)),this.isMine=!1,this.longPost=!1;for(let t=0;t<this.tags.length;t++){let e=this.tags[t].toLowerCase();this.isMine||(this.isMine=e.indexOf("моё")>-1),this.longPost||(this.longPost="длиннопост"===e)}}_parseBlocks(){this.blocks=[],this.$els.blocks.each(((t,e)=>{e.classList.contains("story-block_type_text")?this.blocks.push(this._parseText(e)):e.classList.contains("story-block_type_image")?(this.imageCount++,this.blocks.push(this._parseImage(e))):e.classList.contains("story-block_type_video")&&this.blocks.push(this._parseVideo(e))}))}_parseText(t){let e="",s=t.querySelectorAll("a");return s.length>0&&this._fixLinks(s),e=this._parseParagraph(t),{type:"text",data:e.trim()+"\n"}}_parseParagraph(t){let e=Array.from(t.childNodes),s="";return e.forEach((t=>{"#text"===t.nodeName.toLowerCase()?s+=t.data.replaceAll(/\s?\n\s?/g," "):"#comment"===t.nodeName.toLowerCase()?s+=" ":"p"===t.nodeName.toLowerCase()||"blockquote"===t.nodeName.toLowerCase()?s+=this._parseParagraph(t).trim()+"\n":(t.tagName&&["a","b","i","strong","span"].indexOf(t.tagName.toLowerCase()),s+=t.textContent,t.children&&t.children.length>0?void 0!==t.children[t.children.length-1]&&"br"===t.children[t.children.length-1].tagName.toLowerCase()&&(s+="\n"):"br"===t.tagName.toLowerCase()&&(s+="\n"))})),s}_parseImage(t){let e=t.querySelector(".player"),s={type:"",data:""};return null!==e?(s.type="image-gif",s.data=e.getAttribute("data-source")):(s.type="image",s.data=t.querySelector("img").src),s}_parseVideo(t){let e=t.querySelector(".player");if(!e)return!1;let s=e.getAttribute("data-type"),i={type:s,data:""};if("video"===s)i.data=this._getVideoUrl(e);else if("video-file"===s){const t=e.getAttribute("data-source");i.data=t+("true"===e.dataset.webm?".webm":"mp4")}return i}_fixLinks(t){t.forEach((t=>{t.href!==t.innerText&&t.href.substring(0,16)===t.innerText.substring(0,16)&&(t.innerText=t.href)}))}_getVideoUrl(t){let e=t.getAttribute("data-source");return-1!==e.indexOf("youtube.com/")?"https://www.youtube.com/watch?v="+e.split("/embed/")[1]:-1!==e.indexOf("vimeo.com/")?"https://vimeo.com/"+e.split("/video/")[1]:-1!==e.indexOf("rutube.ru/")?e.split("/embed/").join("/"):""}_getFormattedPost(t,e){let s="",i="longpost"===e||this.longPost,n="post"===e;if("simple"===t){s+=this._getMainMedia(),s+=this.$els.title.text()+"\n";let t=this.blocks.filter((t=>"text"===t.type)).reduce(((t,e)=>(t.push(e.data),t)),[]).join("\n");s+=t.length?"\n"+t:""}if(s+=s.length>0?"\n":"",this.isMine&&!n&&i)s+="Длиннопост от "+this.$els.author.text().trim()+": "+this.storyLink+"\n";else if(!n&&i)s+="Длиннопост: "+this.storyLink+"\n";else if(this.isMine){s+=`Автор на Пикабу: ${this.$els.author.text().trim()}\n`,s+="Комментарии: "+this.storyLink+"\n"}else s+="Комментарии: "+this.storyLink+"\n";return s}_getMainMedia(){let t=this.blocks.filter((t=>t.type.indexOf("video")>-1));return 0===t.length?"":1===t.length?t[0].data+"\n":t.reduce(((t,e)=>(t.push(e.data),t)),[]).join("\n")+"\n"}_copyToClipboard(t,e){let s=this._getFormattedPost(t,e);const i=document.createElement("textarea");i.value=s,i.setAttribute("readonly",""),i.style.position="absolute",i.style.left="-9999px",this.$els.box[0].appendChild(i),i.select(),document.execCommand("copy"),this.$els.box[0].removeChild(i),this._showMessage()}_showMessage(){this._showedMsg||(this._showedMsg=!0,this.$els.msg.addClass(`${this.$classes.msg}_active`),setTimeout((()=>{this.$els.msg.removeClass(`${this.$classes.msg}_active`),this._showedMsg=!1}),3e3))}}var oi=s(3491),ri=s(9050);const ai=s(9755);class li extends n.u1{constructor(t){r.Zv.isJQuery(t)||(i.vE.logger.log("ui-menu","no element passed, component will be rendered as null-object"),t=ai(document.createElement("div"))),super(t),this.render()}render(){return this.isRendered||(this.$els={items:this.$(".menu__item"),spinner:ai(document.createElement("div")).addClass("menu__spinner").appendTo(this.$el).hide()},this._spinner=new oi.j({parent:this.$el}),this._spinner.appendTo(this.$els.spinner)),this}setLoading(t){this.$els.spinner.toggle(Boolean(t)),this.$els.items.toggleClass("menu__item_loading",t)}updateMenuItemById(t){let{id:e,diff:s={}}=t,n=this.$els.items.filter(`[data-id=${e}]`);if(!n.length)return void i.vE.logger.warn("menu",`can't find menu item by id "${e}"`);let{disabled:o}=s;ri.isUndefined(o)||n.toggleClass("menu__item_disabled",o)}updateMultipleMenuItemsById(t=[]){t.forEach((t=>this.updateMenuItemById(t)))}}var hi=s(4473),ci=s(203),di=s(8854),ui=s(3016);function pi(t,e){var s=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),s.push.apply(s,i)}return s}function mi(t){for(var e=1;e<arguments.length;e++){var s=null!=arguments[e]?arguments[e]:{};e%2?pi(Object(s),!0).forEach((function(e){_i(t,e,s[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(s)):pi(Object(s)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(s,e))}))}return t}function _i(t,e,s){return e in t?Object.defineProperty(t,e,{value:s,enumerable:!0,configurable:!0,writable:!0}):t[e]=s,t}class gi extends ui.z{constructor(t){super(mi(mi({},t),{},{mode:f.lL.STORY_AUTHOR}))}render(){return this.isRendered||(super.render(),this.$el&&this.$el.is(":hidden")?(this.$el.show(),this.loadComments().then(this.showEmptyMessage.bind(this)).catch((t=>i.vE.logger.error("all-comments",t)))):(this.initComments(),this.showEmptyMessage())),this}async loadComments(){if(!this.$el)return;const t=i.vE.ui.player.createAnimation("comments-spinner",{$parent:ee()('<div class="comments__spinner"></div>').appendTo(this.$el)}),e=Date.now();t.play();const{response:s,data:n}=await S.cf.post("/ajax/comments_actions.php",{action:"get_story_author_comments",story_id:this._options.storyId});if(await(0,di.g)(500-(Date.now()-e)),t.stop(),t.$parent.remove(),t.destroy(),!s.result)return void i.vE.ui.toasts.showError(s.message);const o=this.$el;if(o){n.comments.forEach((t=>o.append(t.html)))}this.initComments()}showEmptyMessage(){this.$el&&!this.$el.find(".comments").length&&this.$el.append(`\n\t\t\t<div class="story-comments__empty-message">\n\t\t\t\t${(0,wt.t)("comments-next__empty")}\n\t\t\t\t<div>Автор не оставил комментариев в своем посте</div>\n\t\t\t</div>\n\t\t`)}}var vi=s(8246),fi=s(2859),yi=s(2015),bi=s(623),wi=s(4029);const Ei=/#comment_(\d+)/;var Si=s(7245);class Ci extends vi.t{constructor(...t){var e,s,i;super(...t),i=!1,(s="isDetected")in(e=this)?Object.defineProperty(e,s,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[s]=i}render(){return this.isRendered||(super.render(),fi.X.getInstance().init(this.comments),yi.F.getInstance().init(),this.initComments(),this.detectNeedScrolling()),this}async detectNeedScrolling(){const t=function(t){const e=t?(0,bi.k)(t):wi.$.location,s=Ei.exec(e.hash),i=new URLSearchParams(e.search).get("cid");return s?Number(s[1]):i?Number(i):void 0}();if(!t||this.isDetected)return;if(this.isDetected=!0,history.scrollRestoration="auto",!this.comments.has(t))return;history.scrollRestoration="manual";const e=this.comments.get(t);if(!e)return;e.open(),await(0,di.g)(500);for(let s=0;s<3;s++){await e.scrollTo(),await(0,Si.W)(),e.highlight("green",!0),await(0,di.g)(500);if(i.vE.ui.elementInViewport(e.$body,0))break}}}var Ti=s(1471);class Oi extends Jt.u{constructor(t){var e,s,i;super(t),i=!1,(s="isShowing")in(e=this)?Object.defineProperty(e,s,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[s]=i,this.init()}init(){if(!i.vE.initParams.showTopHotStory||!this._options.popupTarget||!this._options.storyEl)return;const t=(0,Ti.P)((async e=>{if(!this.isNeedToShowPopup(e)){this.isShowing=!0;try{await this.showPopup()&&this.stopListening(i.vE.ui,"document-scroll",t)}catch(s){console.error(s)}this.isShowing=!1}}),100);this.listenTo(i.vE.ui,"document-scroll",t)}isNeedToShowPopup(t){return this.isShowing||t<=0&&!i.vE.isMobileApp||t<this.getStoryElHeight()-i.vE.ui.screenHeight}getStoryElHeight(){return parseInt(getComputedStyle(this._options.storyEl).height,10)+i.vE.isMobileApp?300:0}async showPopup(){if(this._popup)return!0;const t=await class{static async getTopStory(t){const e={action:"get_top_story",current_story_id:t};q.V.isUserInExperiment(q.t.NEW_TOP_HOT)&&(e.version=2);const{response:s,data:i}=await S.cf.post("/ajax/stories_actions.php",e);return s.result?i.story:{id:null,html:""}}}.getTopStory(this._options.storyId);return!!t&&(this._popup=new k._({target:this._options.popupTarget,direction:k.Lh.TOP,content:t.html,bottomPosition:"16px",hideByScroll:!1,autoCorrectPosition:!1,autoCloseOutsideClick:!1,showArrow:!1}),this._popup.$els.content.on("click",(()=>{d.c.getInstance().sendEvent("click",{type:"top_hot_click"})})),this._popup.$els.content.find(".top-story-popup__close, .top-story-popup-v2__close").on("click",(t=>{t.preventDefault(),t.stopPropagation(),this._popup.hide()})),this._popup.show(),!0)}}var ki=s(8487),Ii=s(7579);const $i=s(9755),Ai=s(6419);class xi extends n.u1{constructor(t){super(t),this._current=-1,this._newest=[]}render(){return this.isRendered||(this.$el=$i('<div class="comments-navigator__inner">\n\t<div class="comments-navigator__scroll">\n\t\t<div class="comments-navigator__controls">\n\t\t\t<div class="comments-navigator__button" data-role="prev" title="Перейти к предыдущему комментарию (горячая клавиша A)">\n\t\t\t\t<svg xmlns="http://www.w3.org/2000/svg" class="icon icon--ui__to-prev"><use xlink:href="#icon--ui__to-prev"></use></svg>\n\t\t\t</div>\n\t\t\t<div class="comments-navigator__count" title="Количество непрочитанных комментариев">0</div>\n\t\t\t<div class="comments-navigator__button" data-role="next" title="Перейти к следующему комментарию (горячая клавиша D)">\n\t\t\t\t<svg xmlns="http://www.w3.org/2000/svg" class="icon icon--ui__to-next"><use xlink:href="#icon--ui__to-next"></use></svg>\n\t\t\t</div>\n\t\t</div>\n\t</div>\n</div>'),this.$els={count:this.$(".comments-navigator__count")},this._options.firstMount=!0,this.listenTo(this,n.eM.MOUNTED,(()=>{this._options.firstMount&&!i.vE.ui.isPositionSticky?(this.$el.addClass("comments-navigator__inner_no-sticky"),this._options.firstMount=!1,this._options.commentsBlock=this.$el.closest(".page-story__comments")[0],this._options.navigatorHeight=this.$el.height(),this.listenTo(i.vE.ui,"document-scroll",this._scrollHandler)):this._options.firstMount=!1})),this.$(".comments-navigator__button").click(this._onClickTo.bind(this)),this._updateComments(this.comments.comments),i.vE.ui.hotkeys.on(["a","numpad4"],(()=>{this.comments.focused&&this._onClickTo(!1)})),i.vE.ui.hotkeys.on(["d","numpad6"],(()=>{this.comments.focused&&this._onClickTo(!0)}))),this}async _onClickTo(t){let e=Ai.isBoolean(t)?t:"next"===t.currentTarget.getAttribute("data-role"),s=this._newest.length;if(!s)return;this._current+=e?1:-1,this._current=this._current<0?s-1:this._current>=s?0:this._current;let i=this._newest[this._current];i&&(i.isNewest&&(i.isNewest=!1),i.open(),await i.scrollTo(!0),i.highlight("yellow",!0,!0),this._updateComments(this.comments.comments))}_updateComments(t){let e=[];this._current=-1,t.items.forEach((t=>{t.isNewest&&e.push(t)})),this.count=e.length,this._newest=e}_scrollHandler(t){const e=i.vE.ui.windowHeight/2,s=this._options.commentsBlock.offsetTop,n=this._options.commentsBlock.offsetHeight,o=s+this._options.navigatorHeight-t,r=e>=o,a=e<=o+n-this._options.navigatorHeight;this.$el.toggleClass("comments-navigator__inner_enabled",r&&a).toggleClass("comments-navigator__inner_bottom",r&&!a)}get count(){return this._options.count}set count(t){this._options.count!==(t=Number(t))&&(this._options.count=t,this.$els.count.text((t>0?"+":"")+t))}get comments(){return this._options.comments}set comments(t){this._options.comments!==t&&(this._options.comments=t)}}function Di(t){let e=0,s=t;for(;s;){if(s.dataset.id){e=Number(s.dataset.id);break}s=s.parentElement}return e}var Pi=s(1778);const Ri=s(9755),Mi=s(6419);class Ni extends Fs.T3{async _confirmAdult(t){var e;let s=!0;return t&&null!==(e=t.$els)&&void 0!==e&&e.input.data("confirmAdult")&&!t.checked&&(s=await k.nk.confirmModal({header:t.$parent.text(),content:"page-settings.confirmations.adult.content",buttons:[["modal.activate",Bs.j.SUCCESS,!0],["modal.cancel"]],isHeaderLeftAlign:!0,wrapperExtraClass:"popup_modal-menu"}),s||(t.checked=!1)),s}}const Bi=new I.xs({VK:"vk",FACEBOOK:"fb",TWITTER:"tw",GOOGLE:"google"}),Li=new I.xs({WAIT:0,BAD:1,GOOD:2}),Fi=new I.xs({PASSWORD:"password",PHONE:"phone",EMAIL:"email",NICKNAME:"nickname"}),Ui=new I.xs({BELL:"bell",PUSH:"push"}),ji=s(9755),Vi=s(6419);class Hi extends Ni{render(){return this.isRendered||(this._saveSettingsDebounce=Vi.debounce(this._saveSettings,800),this.$parent=ji(".settings"),super.render()),this}async _detectNeedFocusToOption(t){if(!this.ctx.hash||0!==this.ctx.hash.indexOf("option-"))return;let e=this.ctx.hash.slice(7),s=!!e.length&&this.$(`.${t}[data-role="${e}"]`);i.vE.ui.scrollRestoration="auto",s&&1===s.length&&(i.vE.ui.scrollRestoration="manual",i.vE.ui.elementInViewport(s)||await i.vE.ui.scrollTo(s.offset().top-s.height(),!0),s.addClass(`${t}_highlight`),setTimeout((()=>s.removeClass(`${t}_highlight`)),2400))}async _onChangeGeneral(){this._settings.update(this._currentFormOptions),this._isSaved?this.state=Li.GOOD:(this.state=Li.WAIT,this._saveSettingsDebounce())}get _isSaved(){return 0===this._settings.diff("saved").length}get state(){return this._options.state||Li.GOOD}set state(t){let e=this.state;if((t=Li[t])!==e)if(t){switch(this._saveToast||(this._saveToast=new v.O),t){case Li.GOOD:this._saveToast.theme=v.K.DEFAULT,this._saveToast.closeAfter=1500;break;case Li.BAD:this._saveToast.theme=v.K.DANGER,this._saveToast.closeAfter=!0;break;case Li.WAIT:default:this._saveToast.theme=v.K.WARNING,this._saveToast.closeAfter=!1}this._saveToast.content=i.vE.i18n(`page-settings.main.save-message.${t.toString().toLowerCase()}`),this._saveToast.show(),this._options.state=t}else this._saveToast&&this._saveToast.hide()}}var qi=s(2906),Wi=(s(1712),s(9050));var Gi=s(5012);function Yi(t,e){var s=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),s.push.apply(s,i)}return s}function zi(t,e,s){return e in t?Object.defineProperty(t,e,{value:s,enumerable:!0,configurable:!0,writable:!0}):t[e]=s,t}const Zi=s(9755),Ki=s(6419);class Xi extends Hi{route(t,e){return this.ctx=t,this.isShown?this._detectNeedFocusToOption("settings-main__option"):(this.show(),this._about.autoSize(),this.timeout("detect",2e3,(()=>{this._detectNeedFocusToOption("settings-main__option")}))),e()}render(){if(this._xhrAbout=void 0,super.render(),this.config=i.vE.config("modules.settings.main"),this.$el=Zi(function(t){var e,s="",i=Wi.escape;Array.prototype.join,s+='<div class="settings-main">\n\t<form name="general" method="POST" action="javascript:void 0;" autocomplete="off" novalidate>\n\t\t<section class="section section_padding_none profile" data-user-id="'+i(t.userId)+'">\n\t\t\t<div class="profile__header">\n\t\t\t\t<div class="background background_show-upload" data-editable="true" '+(null==(e=(t.headerBackgroundUrl?"":' data-default="true"')+(t.headerBackgroundForbidden?' data-forbidden="true"':""))?"":e)+'>\n\t\t\t\t\t<div class="background__placeholder"'+(null==(e=t.headerBackgroundUrl?' style="background-image: url('+t.headerBackgroundUrl+')"':"")?"":e)+'></div>\n\t\t\t\t</div>\n\t\t\t\t<div class="avatar avatar_large avatar_show-upload" data-own="true" data-editable="true"><img src="'+(null==(e=t.avatar)?"":e)+'"></div>\n\t\t\t</div>\n\t\t\t<div class="profile__user">\n\t\t\t\t<div class="settings-main__block">\n\t\t\t\t\t<h1 class="profile__nick">\n\t\t\t\t\t\t<a href="/@'+i(t.userName)+'">'+i(t.userName)+'</a>\n\t\t\t\t\t</h1>\n\x3c!--\t\t\t\t\t<div class="settings-main__profession">--\x3e\n\x3c!--\t\t\t\t\t\t<div>Специализация или сфера интересов</div>--\x3e\n\x3c!--\t\t\t\t\t\t<section class="input input_editor profile-block" data-role="profession">--\x3e\n\x3c!--\t\t\t\t\t\t\t<textarea class="input__input profile-block__textarea profile-block__textarea_initial"--\x3e\n\x3c!--\t\t\t\t\t\t\t\t\t  rows="1" tabindex="1" placeholder="Например, Javascript-программист">'+(null==(e=t.profession_proposal?t.profession_proposal:t.profession)?"":e)+'</textarea>--\x3e\n\x3c!--\t\t\t\t\t\t\t<div tabindex="1" class="input__input profile-block__text profile-block__text_invisible"--\x3e\n\x3c!--\t\t\t\t\t\t\t\t title="Например, Javascript-программист">'+(null==(e=t.profession_proposal?t.profession_proposal:t.profession)?"":e)+'</div>--\x3e\n\x3c!--\t\t\t\t\t\t</section>--\x3e\n\x3c!--\t\t\t\t\t</div>--\x3e\n\t\t\t\t\t<div class="settings-main__about">\n\t\t\t\t\t\t<div class="settings-main__label">О себе</div>\n\t\t\t\t\t\t<section class="input input_editor profile-block" data-role="about">\n\t\t\t\t\t\t\t<textarea class="input__input profile-block__textarea profile-block__textarea_initial"\n\t\t\t\t\t\t\t\t\t  rows="1" placeholder="Не более 140 символов">'+(null==(e=t.about_info?t.about_info:"")?"":e)+'</textarea>\n\t\t\t\t\t\t\t<div class="input__input profile-block__text profile-block__text_invisible"\n\t\t\t\t\t\t\t\t title="Не более 140 символов">'+(null==(e=t.about_info?t.about_info:"")?"":e)+'</div>\n\t\t\t\t\t\t</section>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="settings-main__sex">\n\t\t\t\t\t\t<div class="settings-main__label">Пол</div>\n\t\t\t\t\t\t<div class="select">\n\t\t\t\t\t\t\t<select name="gender" data-role="listbox">\n\t\t\t\t\t\t\t\t<option value="0" '+(null==(e=0===t.gender?'selected="selected"':"")?"":e)+'>Не показывать </option>\n\t\t\t\t\t\t\t\t<option value="1" '+(null==(e=1===t.gender?'selected="selected"':"")?"":e)+'>Мужской</option>\n\t\t\t\t\t\t\t\t<option value="2" '+(null==(e=2===t.gender?'selected="selected"':"")?"":e)+'>Женский</option>\n\t\t\t\t\t\t\t</select>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</div>\n\n\t\t\t<div class="settings-main__options">\n\t\t\t\t<h4 class="settings-main__sub-header" id="links-stories-feed">Лента</h4>\n\t\t\t\t\x3c!-- Показывать посты с рейтингом выше --\x3e\n\t\t\t\t<div class="settings-main__option" data-role="minimum-story-rating-view">\n\t\t\t\t\t<div class="settings-main__slider-wrapper">\n\t\t\t\t\t\t<div>\n\t\t\t\t\t\t\t<select name="newst" data-role="slider">\n\t\t\t\t\t\t\t\t',[-15,-10,-5,0,5,10,15].forEach((function(i){s+='\n\t\t\t\t\t\t\t\t<option value="'+(null==(e=i)?"":e)+'"'+(null==(e=t.minimumStoryRatingView===i?' selected="selected"':"")?"":e)+">рейтингом выше "+(null==(e=i)?"":e)+"</option>\n\t\t\t\t\t\t\t\t"})),s+='\n\t\t\t\t\t\t\t</select>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<div>Показывать посты с <span class="settings-main__value" data-role="newst">рейтингом выше '+i(t.minimumStoryRatingView)+'</span></div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\n\t\t\t\t\x3c!-- Постраничный просмотр --\x3e\n\t\t\t\t<div class="settings-main__option" data-role="used-ajax-load">\n\t\t\t\t\t<label><input type="checkbox" name="is_twitmode" class="checkbox_switch" value="false" '+(null==(e=0==t.isUsedAjaxLoad?'checked="checked"':"")?"":e)+'>Постраничный просмотр</label>\n\t\t\t\t</div>\n\n\t\t\t\t\x3c!-- Сворачивать содержание постов --\x3e\n\t\t\t\t<div class="settings-main__option">\n\t\t\t\t\t<label><input type="checkbox" name="is_scrollmode" class="checkbox_switch" value="false" '+(null==(e=0==t.isUsedScrollMode?'checked="checked"':"")?"":e)+'>Сворачивать содержание постов</label>\n\t\t\t\t</div>\n\n\t\t\t\t\x3c!-- Показывать полностью длинные посты --\x3e\n\t\t\t\t<div class="settings-main__option">\n\t\t\t\t\t<label><input name="is_full_story_view" type="checkbox" class="checkbox_switch" value="1" '+(null==(e=!0===t.isFullStoryView?'checked="checked"':"")?"":e)+'>Показывать полностью длинные посты</label>\n\t\t\t\t</div>\n\n\t\t\t\t\x3c!-- Показывать материалы 16+ --\x3e\n\t\t\t\t<div class="settings-main__option">\n\t\t\t\t\t<label><input name="show_porno" type="checkbox" class="checkbox_switch" value="1" data-confirm-adult="1" '+(null==(e=1==t.isAdultVisible?'checked="checked"':"")?"":e)+'>Показывать NSFW-контент</label>\n\t\t\t\t</div>\n\n\t\t\t\t\x3c!-- Показывать посты с тегом жесть --\x3e\n\t\t\t\t<div class="settings-main__option">\n\t\t\t\t\t<label><input name="is_horror" type="checkbox" class="checkbox_switch" value="1" data-confirm-adult="1" '+(null==(e=1==t.isHorrorVisible?'checked="checked"':"")?"":e)+'>Показывать посты с тегом <span class="tag">жесть</span></label>\n\t\t\t\t</div>\n\n\t\t\t\t<h4 class="settings-main__sub-header">Пост</h4>\n\n\t\t\t\t\x3c!-- Показывать теги вверху поста --\x3e\n\t\t\t\t<div class="settings-main__option">\n\t\t\t\t\t<label><input name="is_tags_at_top_dv" type="checkbox" class="checkbox_switch" value="1" '+(null==(e=1==t.isTagsAtTop?'checked="checked"':"")?"":e)+'>Показывать теги вверху поста</label>\n\t\t\t\t</div>\n\n\t\t\t\t\x3c!-- Автоматическое воспроизведение видео/гиф в лентах --\x3e\n\t\t\t\t<div class="settings-main__option">\n\t\t\t\t\t<label><input name="is_video_autoplay_mode" value="1" type="checkbox" class="checkbox_switch" '+(null==(e=1==t.isVideoAutoplayMode?'checked="checked"':"")?"":e)+'>Воспроизводить видео и GIF в постах автоматически</label>\n\t\t\t\t</div>\n\n\t\t\t\t\x3c!-- Показывать дополнительные посты под комментариями --\x3e\n\t\t\t\t<div class="settings-main__option">\n\t\t\t\t\t<label><input name="show_related_stories" type="checkbox" class="checkbox_switch" value="1" '+(null==(e=1==t.isShowRelatedStories?'checked="checked"':"")?"":e)+'>Показывать дополнительные посты под комментариями</label>\n\t\t\t\t</div>\n\n\t\t\t\t<div class="settings-main__option">\n\t\t\t\t\t<div class="settings-main__dropdown settings-main__tags-fold">\n\t\t\t\t\t\t<input name="tags_fold_mode" class="hidden" value="'+i(t.tagsFoldMode)+'" />\n\t\t\t\t\t\t<label>\n\t\t\t\t\t\t\tТеги\n\t\t\t\t\t\t\t<span data-role="tags_fold_mode" data-mode="'+i(t.tagsFoldMode)+'">\n\t\t\t\t\t\t\t\t'+i(0===t.tagsFoldMode?"Сворачивать частично":1===t.tagsFoldMode?"Показывать все":"Скрывать")+'\n\t\t\t\t\t\t\t</span> <span> <svg xmlns="http://www.w3.org/2000/svg" class="icon icon--ui__arrow-down icon--ui__arrow-down_settings"><use xlink:href="#icon--ui__arrow-down"></use></svg></span>\n\t\t\t\t\t\t</label>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\n\t\t\t\t<h4 class="settings-main__sub-header">Комментарии</h4>\n\n\t\t\t\t\x3c!-- Показывать комментарии с --\x3e\n\t\t\t\t<div class="settings-main__option">\n\t\t\t\t\t<div class="settings-main__slider-wrapper">\n\t\t\t\t\t\t<div>\n\t\t\t\t\t\t\t<select name="commentst" data-role="slider">\n\t\t\t\t\t\t\t\t',[-4,-3,-2,-1,0].forEach((function(i){s+='\n\t\t\t\t\t\t\t\t<option value="'+(null==(e=i)?"":e)+'"'+(null==(e=t.minimumCommentRatingView===i?' selected="selected"':"")?"":e)+">"+(null==(e=0===i?"любым рейтингом":"рейтингом выше "+i)?"":e)+"</option>\n\t\t\t\t\t\t\t\t"})),s+='\n\t\t\t\t\t\t\t</select>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<div>Показывать комментарии с <span class="settings-main__value" data-role="commentst">'+(null==(e=0===t.minimumCommentRatingView?"любым рейтингом":"рейтингом выше "+t.minimumCommentRatingView)?"":e)+'</span></div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\n\t\t\t\t\x3c!-- Сворачивать вложенные комментарии после --\x3e\n\t\t\t\t<div class="settings-main__option">\n\t\t\t\t\t<div class="settings-main__slider-wrapper">\n\t\t\t\t\t\t<div>\n\t\t\t\t\t\t\t<select name="max_comments_branch_depth" data-role="slider">\n\t\t\t\t\t\t\t\t';for(var n=1;n<10;n++)s+='\n\t\t\t\t\t\t\t\t\t<option value="'+(null==(e=n)?"":e)+'"'+(null==(e=t.maxCommentsBranchDepth===n?' selected="selected"':"")?"":e)+">"+i(n)+" ур.</option>\n\t\t\t\t\t\t\t\t";return s+='\n\t\t\t\t\t\t\t\t<option value="0"'+(null==(e=0==t.maxCommentsBranchDepth?' selected="selected"':"")?"":e)+'>10 ур.</option>\n\t\t\t\t\t\t\t</select>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<div>Сворачивать вложенные комментарии после <span class="settings-main__value" data-role="max_comments_branch_depth">'+(null==(e=0===t.maxCommentsBranchDepth?10:t.maxCommentsBranchDepth)?"":e)+' ур.</span></div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\n\t\t\t\t\x3c!-- Останавливать Gif анимацию в комментариях --\x3e\n\t\t\t\t<div class="settings-main__option">\n\t\t\t\t\t<label><input name="hide_gifs" type="checkbox" class="checkbox_switch" value="1" '+(null==(e=1==t.isAnimPreviewComment?'checked="checked"':"")?"":e)+'>Ставить GIF на паузу в комментариях</label>\n\t\t\t\t</div>\n\n\t\t\t\t<div class="settings-main__option">\n\t\t\t\t\t<div class="settings-main__dropdown settings-main__sorting">\n\t\t\t\t\t\t<input name="default_com_view" class="hidden" value="'+i(t.defaultCommentsViewMode)+'" />\n\t\t\t\t\t\t<label>Сортировать комментарии <span data-role="default_com_view" data-order="'+i(t.defaultCommentsViewMode)+'">'+i(1===t.defaultCommentsViewMode?"по рейтингу":2===t.defaultCommentsViewMode?"по времени":"по актуальности")+' </span><span> <svg xmlns="http://www.w3.org/2000/svg" class="icon icon--ui__arrow-down icon--ui__arrow-down_settings"><use xlink:href="#icon--ui__arrow-down"></use></svg></span></label>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\n\t\t\t\t<h4 class="settings-main__sub-header" id="links-others">Другие</h4>\n\n\t\t\t\t\x3c!-- Показывать полосу прокрутки наверх --\x3e\n\t\t\t\t<div class="settings-main__option">\n\t\t\t\t\t<label><input name="scroll_top" type="checkbox" class="checkbox_switch" value="1" '+(null==(e=1==t.isUsedScrollTopButton?'checked="checked"':"")?"":e)+'>Показывать полосу прокрутки наверх</label>\n\t\t\t\t</div>\n\n\t\t\t\t\x3c!-- Отключить рекламу --\x3e\n\t\t\t\t<div class="settings-main__option" data-role="is-ads-disabled">\n\t\t\t\t\t<label>\n\t\t\t\t\t\t<input name="is_ads_disabled" '+(null==(e=t.isDisableAdsAllowed?"":"disabled")?"":e)+' type="checkbox" class="checkbox_switch" value="1" '+(null==(e=t.isDisableAds?'checked="checked"':"")?"":e)+'>Отключить рекламу\n\t\t\t\t\t\t<i class="fa fa-question-circle hint" aria-label="'+(null==(e=t.disableAdsHint)?"":e)+'"></i>\n\t\t\t\t\t</label>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</section>\n\t</form>\n</div>'}(this.config)),this.$orderMode=this.$('span[data-role="default_com_view"]'),this.$tagsFoldMode=this.$('span[data-role="tags_fold_mode"]'),this._userId=this.$(".profile").data("user-id"),this.$els={about:this.$('.input[data-role="about"]'),aboutText:this.$(".profile-block__text"),aboutTextarea:this.$(".profile-block__textarea"),profession:this.$('.input[data-role="profession"]')},this.$els.about.length){this._about=new fs.G(this.$els.about),this.$els.aboutText.removeClass("profile-block__text_invisible"),this.$els.aboutTextarea.removeClass("profile-block__textarea_initial");const t=(0,xs.D)(this._onChangeAbout.bind(this),1500);this.listenTo(this._about,"input",t),this.listenTo(this._about,"cut",t),this.listenTo(this._about,"paste",t),this.listenTo(this._about,"blur",(t=>{this._about.value=this._about.value.replace(/ +/gm," "),this.$els.aboutText.html(u.User.noteValueToHtml(t.target.value)),this._about.value=this._about.value.trim(),this._about.value.length&&this._about.$els.input.filter("textarea").addClass("profile-block__textarea_invisible"),this._about.autoSize()})),this.listenTo(this._about,"focus",(t=>{this._about.$els.input.filter("textarea").removeClass("profile-block__textarea_invisible"),t.target.setSelectionRange&&t.target.setSelectionRange(t.target.value.length,t.target.value.length)})),this.$els.aboutText.on("click","a",(t=>(window.open(t.target.href,"_blank").focus(),!1))).html(u.User.noteValueToHtml(this._about.value)),this._aboutSaved=this._about.value}this.$els.profession.length&&(this._professionsDropdown=new Gi.v({$el:this.$els.profession,closeAfterSelect:!0})),this._saveToast=void 0,this._formGeneral=new a.x(this.$('form[name="general"]')),this.listenTo(this._formGeneral,"change",this._onChangeGeneral),["commentst","newst","page_num","max_comments_branch_depth"].forEach((t=>{let e=n.u1.closestUIElement(this.$('select[name="'+t+'"]')),s=this.$(`.settings-main__value[data-role="${t}"]`);e&&this.listenTo(e,"change",((t,e)=>{s.text(e)}))})),this.$orderMode.on("click",this._onClickOrder.bind(this)),this.$tagsFoldMode.on("click",this._onClickTagsFold.bind(this));i.vE.config("modules.settings.main");return this._settings=new qi.Lo(this._currentFormOptions),this._settings.save("saved"),this._formOptionsBeforeSave=function(t){for(var e=1;e<arguments.length;e++){var s=null!=arguments[e]?arguments[e]:{};e%2?Yi(Object(s),!0).forEach((function(e){zi(t,e,s[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(s)):Yi(Object(s)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(s,e))}))}return t}({},this._currentFormOptions),Object.keys(this._formOptionsBeforeSave).forEach((t=>{this.listenTo(this._settings,t,((e,s,i)=>{this.state!==Li.WAIT&&(this._formOptionsBeforeSave[t]=i)}))})),this.listenTo(i.vE.ui,"beforeunload",(t=>{if(!this._isSaved){let e=i.vE.i18n("page-settings.main.before-close");return t.returnValue=e,e}})),this}mount(){return super.mount(),i.vE.ui._attachChangeBackground(),i.vE.ui._attachChangeProfileAvatar(),this}async _saveSettings(){if(this._isSaved)return void(this.state=Li.GOOD);if(await u.User.saveSettings(this._settings.plainData)){this.state=Li.GOOD;const t=this._settings.diff("saved")[0];t&&u.User.sendSettingsChangeAnalytics(t.property,this._formOptionsBeforeSave[t.property],t.value),this._settings.save("saved")}else this.state=Li.BAD}async _onChangeGeneral(t,e){await this._confirmAdult(e)&&super._onChangeGeneral()}_onClickOrder(){let t=this.marks.get("order-mode-popup");if(!t){const e=this.$(".settings-main__sorting input");t=pt.g.popupEnum(this.$orderMode,new I.xs({RATING:1,TIME:2,RELEVANCE:3}),"comments.order-mode",this.$orderMode.data("order")),this.listenTo(t,"change",(async(s,n)=>{e.val(n.valueOf()),this.$orderMode.text(i.vE.i18n("comments.order-mode."+n.toString())),this._onChangeGeneral(),t.hide()})),this.marks.set("order-mode-popup",t)}return t.toggle(),this}_onClickTagsFold(){let t=this.marks.get("tags-fold-popup");if(!t){const e=this.$(".settings-main__tags-fold input");t=pt.g.popupEnum(this.$tagsFoldMode,bs.yX,"tags.fold-mode",this.$tagsFoldMode.data("mode")),this.listenTo(t,"change",(async(s,n)=>{e.val(n.valueOf()),this.$tagsFoldMode.text(i.vE.i18n("tags.fold-mode."+n.toString())),this._onChangeGeneral(),t.hide()})),this.marks.set("tags-fold-popup",t)}return t.toggle(),this}get _currentFormOptions(){return Ki.defaults(this._formGeneral.serialize(),{is_scrollmode:0,is_full_story_view:0,is_video_autoplay_mode:0,hide_gifs:0,show_porno:0,is_horror:0,scroll_top:0,show_related_stories:0,is_tags_at_top_dv:0,is_ads_disabled:0,default_com_view:3,tags_fold_mode:0,action:"change_settings"})}async _onChangeAbout(t){if(this._xhrAbout||t===this._aboutSaved)return this;this._xhrAbout=!0;try{await this.user.about(t),i.vE.ui.toasts.add("settings-about-saved",{content:i.vE.i18n("page-settings.main.about.saved"),closeAfter:3e3}),u.User.sendSettingsChangeAnalytics("about"),this._aboutSaved=t}catch(e){i.vE.ui.toasts.showError(e)}this._xhrAbout=!1}get user(){let t=this._options.user;return t||(t=this._options.user=new u.User(this._userId)),t}}var Qi=s(3968),Ji=s(9050);var tn=s(9050);var en=s(9050);const sn=s(9755),nn=s(6419);class on extends Fs.T3{render(){return this.isRendered||(this.$parent=sn(".settings"),this.$el=sn(function(t){var e,s="",i=en.escape;return Array.prototype.join,s+='<div class="settings-save">\n\t<div class="settings-saves">\n\t\t<form class="settings-saves__form">\n\t\t\t<div class="">\n\t\t\t\t<div class="section section_gray">\n\t\t\t\t\t<label><input type="checkbox" value="1" class="checkbox checkbox_switch settings-saves__hide-menu-btn" data-role="change-settings" '+(null==(e=t.isHideSaveMenu?"checked":"")?"":e)+'> Скрыть меню выбора категорий при сохранении поста</label>\n\t\t\t\t</div>\n\t\t\t\t\x3c!-- Список категорий --\x3e\n\t\t\t\t<div class="section_padding_left settings-saves__categories">\n\t\t\t\t\t<div class="settings-saves__list" id="settings-saves__list">\n\t\t\t\t\t\t',en.forEach(t.categories||[],(function(t){s+='\n\t\t\t\t\t\t<div class="input input_box input_flat settings-saves__category'+(null==(e=0==t.id?" settings-saves__category_uneditable":"")?"":e)+'" data-role="find" data-id="'+(null==(e=t.id)?"":e)+'" data-count="'+(null==(e=t.count)?"":e)+'">\n\t\t\t\t\t\t\t<span class="input__icon settings-saves__edit"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon--ui__pencil icon--ui__pencil_size-large"><use xlink:href="#icon--ui__pencil"></use></svg></span>\n\t\t\t\t\t\t\t<span class="input__box">\n\t\t\t\t\t\t\t\t<input class="input__input settings-saves__input" placeholder="Введите название" maxlength="25" autocomplete="off" data-role="name" value="'+i(t.name)+'" data-id="'+i(t.id)+'" '+(null==(e=0==t.id?' readonly="readonly"':"")?"":e)+'>\n\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t<span data-role="count" class="settings-saves__count">'+(null==(e=t.count)?"":e)+'</span>\n\t\t\t\t\t\t\t<button data-role="remove" class="button_link settings-saves__remove"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon--ui__close icon--ui__close_size-middle"><use xlink:href="#icon--ui__close"></use></svg></button>\n\t\t\t\t\t\t\t<span class="input__icon settings-saves__drag"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon--ui__hamburger icon--ui__hamburger_size-large"><use xlink:href="#icon--ui__hamburger"></use></svg></span>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t'})),s+='\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t\x3c!-- Конец списка категорий --\x3e\n\t\t\t\t<div class="input input_box input_section input_gray settings-saves__add-b" data-role="find">\n\t\t\t\t\t<button class="input__icon settings-saves__plus button_link"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon--ui__plus icon--ui__plus_size-middle"><use xlink:href="#icon--ui__plus"></use></svg></button>\n\t\t\t\t\t<span class="input__box">\n\t\t\t\t\t\t<input class="input__input" maxlength="25" data-role="create_new" placeholder="Новая категория" name="create_new_cat" value="" autocomplete="off">\n\t\t\t\t\t</span>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</form>\n\t</div>\n</div>'}(i.ZP.config("modules.settings.save-categories"))),this.$els={form:this.$(".settings-saves__form"),checkbox:this.$(".settings-saves__hide-menu-btn"),list:this.$(".settings-saves__list"),categories:this.$(".settings-saves__category"),inputs:this.$(".settings-saves__input"),addBlock:this.$(".settings-saves__add-b"),addInput:this.$('[data-role="create_new"]'),addBtn:this.$(".settings-saves__plus")},this._form=new a.x(this.$els.form),this._addInput=new T.u3({$el:this.$els.addBlock,addClearButton:!1}),this._saveCategoryToast=new v.O({destroyAfterHide:!1}),this.$els.addBtn.click((t=>{t.preventDefault(),this._createNewCategory()})),this.$els.addInput.on("keypress",(t=>{13!==event.which&&13!==event.keyCode||(t.preventDefault(),this._createNewCategory())})),this.listenTo(this._addInput,"input",(()=>{""!==this._addInput.value?this.$els.addBtn.addClass("settings-saves__add-b_green"):this.$els.addBtn.removeClass("settings-saves__add-b_green")})),this.$els.list.on("mousedown",".settings-saves__drag",(t=>{t.preventDefault(),this._dragCategory(t)})),this.$els.categories.each(((t,e)=>{this._categoryInputListeners(e)})),this.$els.list.on("click",".settings-saves__remove",(t=>{t.preventDefault(),t.stopPropagation(),this._removeCategory(t)})),this.$els.checkbox.change((t=>{let e=sn(t.target).is(":checked");Qi.YD.changeSettings(e).then((async()=>{this._saveCategoryToast.theme=v.K.DEFAULT,this._saveCategoryToast.content=i.ZP.i18n("page-settings.main.save.good"),this._showSettingsToast()}),(async()=>{this._saveCategoryToast.theme=v.K.DANGER,this._saveCategoryToast.content=i.ZP.i18n(i.ZP.i18n("page-settings.main.save.bad")||"Ошибка"),this._showSettingsToast()}))})),super.render()),this}_categoryInputListeners(t){let e=t instanceof sn?t:sn(t),s=e.find(".settings-saves__edit"),i=new T.u3({$el:e,addClearButton:!1}),n=nn.debounce(this._renameCategory.bind(this,i),800);i._savedValue=i.value,s.click((()=>{i.els.input.setSelectionRange(i.value.length,i.value.length)})),this.listenTo(i,"input",(()=>{s.removeClass("settings-saves__edit_error"),n()})),this.listenTo(i,"blur",(()=>{""===i.value&&(i.value=i._savedValue)}))}_createNewCategory(){let t=this._addInput;t.value.length&&(this._isNameAvailable(t.value)?Qi.YD.add(t.value).then((e=>{let s={id:e,name:t.value,count:0},i=sn(function(t){var e="",s=tn.escape;return e+'<div class="input input_box input_flat settings-saves__category" data-role="find" data-id="'+s(t.id)+'" data-count="'+s(t.count)+'">\n\t<span class="input__icon settings-saves__edit"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon--ui__pencil icon--ui__pencil_size-large"><use xlink:href="#icon--ui__pencil"></use></svg></span>\n\t<span class="input__box">\n\t\t<input class="input__input settings-saves__input" placeholder="Введите название" maxlength="25" autocomplete="off" value="'+s(t.name)+'" data-role="name" data-id="'+s(t.id)+'">\n\t</span>\n\t<span data-role="count" class="settings-saves__count">'+s(t.count)+'</span>\n\t<button data-role="remove" class="button_link settings-saves__remove"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon--ui__close icon--ui__close_size-middle"><use xlink:href="#icon--ui__close"></use></svg></button>\n\t<span class="input__icon settings-saves__drag"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon--ui__hamburger icon--ui__hamburger_size-large"><use xlink:href="#icon--ui__hamburger"></use></svg></span>\n</div>'}(s));this.$els.list.append(i),this._categoryInputListeners(i),this.$els.categories=this.$els.list.find(".settings-saves__category"),this.$els.inputs=this.$els.list.find(".settings-saves__input"),t.value=""}),(t=>{i.ZP.ui.toasts.showError(t)})):i.ZP.ui.toasts.showError(i.ZP.i18n("page-settings.save-categories.name-duplication")||"Ошибка"))}_renameCategory(t){if(t._savedValue===t.value.trim()||""===t.value)return;let e=sn(t.els.input).closest(".settings-saves__category"),s=e.find(".settings-saves__edit"),n=e.data("id");s.removeClass("settings-saves__edit_success"),this._isNameAvailable(t.value,n)?(Qi.YD.renameCategory(t.value,n).then((()=>{s.addClass("settings-saves__edit_success"),t._savedValue=t.value.trim()}),(t=>{i.ZP.ui.toasts.showError(t)})),s.removeClass("settings-saves__edit_valid").addClass("settings-saves__edit_valid")):(s.addClass("settings-saves__edit_error"),i.ZP.ui.toasts.showError(i.ZP.i18n("page-settings.save-categories.name-duplication")||"Ошибка"))}_isNameAvailable(t,e=-1){let s=!0,i=t.trim().toLowerCase().replace(/^\s+|\s+$/g,"");return this.$els.inputs.each(((t,n)=>{let o=sn(n);if(Number(o.data("id"))!==e&&o.val().trim().toLowerCase().replace(/^\s+|\s+$/g,"")===i)return s=!1,!1})),s}_dragCategory(t){let e=sn(t.target),s=e.closest(".settings-saves__category"),n=this.$els.list,o=n.find(".settings-saves__category"),r=o.length-1,a=s.outerHeight(),l=s[0].offsetTop,h=t.clientY,c=~~(l/a),d=c,u="settings-saves__category_dragging",p="settings-saves__categories_dragging",m="settings-saves__drag_success",_=[];s.addClass(u),n.addClass(p).css("height",a*(r+1)+"px"),o.css("position","absolute").each((function(){sn(this).css("top",_.length*a+"px"),_.push(this)}));let g=t=>{let e=Math.max(0,Math.min(r,c+~~((t.clientY-h)/a)));if(_[e]!==s[0]){let t=_[d]=_[e];sn(t).css("top",d*a+"px"),_[e]=s[0],s.css("top",e*a+"px"),d=e}},v=()=>{if(document.removeEventListener("mousemove",g,!0),document.removeEventListener("mouseup",v,!0),d!==c){0===d?s.insertBefore(_[1]):s.insertAfter(_[d-1]);let t=[],n="";for(let e=0,s=_.length;e<s;e++)""===n&&(n=sn(_[e]).find("input").val()),t.push(_[e].getAttribute("data-id"));Qi.YD.setCategoriesOrder(t).then((()=>{e.removeClass(m).addClass(m)}),(t=>{i.ZP.ui.toasts.showError(t)}))}o.css({top:"",position:""}),n.removeClass(p).css("height",""),s.removeClass(u)};document.addEventListener("mousemove",g,!0),document.addEventListener("mouseup",v,!0)}_removeCategory(t){let e=!1,s=-1,n=sn(t.target).closest(".settings-saves__category"),o=n.data("count"),r=n.data("id"),l=n.find('[data-role="name"]').val();if(0!==r)if(o>0){let t={categories:[],name:l,id:r};this.$els.categories.each(((e,s)=>{let i=sn(s),n=i.data("id");n!==r&&t.categories.push({name:i.find('[data-role="name"]').val(),id:n})}));let h=function(t){var e="",s=Ji.escape;if(Array.prototype.join,e+='<form class="settings-saves__popup">\n\t<p class="settings-saves__group">В удаляемой категории <b>'+s(t.name)+'</b> имеются сохраненные посты.\n\t\t<br>Какое действие необходимо выполнить с постами из этой категории?</p>\n\t<div class="settings-saves__group settings-saves__group_mb">\n\t\t<p class="settings-saves__option"><label><input type="radio" name="categoryDeleteType" value="0" checked>удалить все посты вместе с категорией</label></p>\n\t\t<p class="settings-saves__option"><label><input type="radio" name="categoryDeleteType" value="1">переместить все посты в\n\t\t\t\t',1===t.categories.length)e+=' категорию <b>Общее</b>\n\t\t\t\t<input type="hidden" value="0" name="moveStoriesToID">\n\t\t\t\t';else{e+='\n\t\t\t\tдругую категорию\n\t\t\t\t<div class="settings-saves__group settings-saves__group_ml">\n\t\t\t\t\t<select data-role="listbox" name="moveStoriesToID">\n\t\t\t\t\t\t';for(var i=0;i<t.categories.length;i++)e+='\n\t\t\t\t\t\t<option value="'+s(t.categories[i].id)+'" ',0==t.categories[i].id&&(e+='selected="selected"'),e+=">\n\t\t\t\t\t\t\t"+s(t.categories[i].name)+"</option>\n\t\t\t\t\t\t";e+="\n\t\t\t\t\t</select>\n\t\t\t\t</div>\n\t\t\t\t"}return e+"\n\t\t\t</label>\n\t\t</p>\n\t</div>\n</form>\n"}(t);e=new k.LD({header:"Удалить категорию",indent:!0,content:sn(h)}),new a.x(e.content.find("form")),e.addButtonIntoFooter(i.ZP.i18n("page-settings.save-categories.yes"),(async()=>{let t=e.content.find('.radio_checked [name="categoryDeleteType"]').val(),a=e.content.find('[name="moveStoriesToID"]').val();s=Number(t)?Number(a):-1,Qi.YD.deleteCategory(r,s).then((()=>{if(s>-1){let t=this.$els.categories.filter(`[data-id="${s}"]`),e=Number(t.data("count"))+Number(o);t.data("count",e).find('[data-role="count"]').html(e)}n.remove(),this.$els.categories=this.$els.list.find(".settings-saves__category"),this.$els.inputs=this.$els.list.find(".settings-saves__input")}),(t=>{i.ZP.ui.toasts.showError(t)})),e.hide()}),Bs.j.SUCCESS),e.addButtonIntoFooter(i.ZP.i18n("page-settings.save-categories.no"),(()=>{e.hide()})),e.show()}else Qi.YD.deleteCategory(r,s).then((()=>{n.remove(),this.$els.categories=this.$els.list.find(".settings-saves__category"),this.$els.inputs=this.$els.list.find(".settings-saves__input")}),(t=>{i.ZP.ui.toasts.showError(t)}))}async _showSettingsToast(){this._saveCategoryToast.isShown&&(this._saveCategoryToast.hide(),await c.cQ.delay(200)),this._saveCategoryToast.show()}}class rn extends Fs.T3{route(t,e){return this.ctx=t,this.isRendered?this._tabs.currentTab=t.params.typeName||"users":this.show(),e()}_initAnalytics(){this.$els.tabUsers.find(".user").on("click auxclick",(t=>{0!==t.button&&1!==t.button||d.c.getInstance().sendEvent("transition_to_author",{type:"from_subs_manage","author_id!empty":Number(t.currentTarget.dataset.id)})})),this.$els.tabTags.find(".tag").on("click auxclick",(t=>{0!==t.button&&1!==t.button||d.c.getInstance().sendEvent("transition_to_tag",{type:"from_subs_manage",tag_id:t.currentTarget.textContent.trim()})})),this.$els.tabCommunities.find(".community__title").on("click auxclick",(t=>{0!==t.button&&1!==t.button||d.c.getInstance().sendEvent("transition_to_community",{type:"from_subs_manage","community_id!empty":Number(t.currentTarget.dataset.id)})}))}}var an=s(7754),ln=s(9050);var hn=s(9050);var cn=s(9050);var dn=s(9050);var un=s(9050);var pn=s(9050);const mn=s(9755),_n=s(6419);class gn extends n.u1{constructor(t,e,s){super(),this.$el=t,this._type=e,this._prefix=s,this.$el.length&&this.render()}render(){this.$els={form:this.$el.find(`.${this._prefix}__form`),searchInput:this.$el.find("[data-role=find]"),searchSubmit:this.$el.find('button[type="submit"]'),userList:this.$el.find(`.${this._prefix}-list`),userListItems:this.$el.find(`.${this._prefix}-list__item`),globalList:this.$el.find(`.${this._prefix}-global-list`),globalBlock:this.$el.find(`.${this._prefix}__global-block`),loadMoreBtn:this.$el.find(`.${this._prefix}__show-more-btn`)},this._form=new a.x(this.$els.form),this._searchInput=new T.u3(this.$els.searchInput),this._form.add(this._searchInput),this._lastSearch=this._searchInput.value,this._currentSearch=this._searchInput.value,this._currentRegexp=new RegExp(c.cQ.escapeStringRegExp(this._searchInput.value),"i"),this._pageType="settings-subs"===this._prefix?"subscribe":"ignore",this._lastListItemsArray=[],this.$els.userListItems.each(((t,e)=>{this._lastListItemsArray.push(mn(e).data("id"))}));let t=this.$els.form.attr("data-has-more");this._hasMore=void 0!==t&&!1!==t,this.listenTo(this._searchInput,"input",_n.debounce(this._searchController,500)),this.listenTo(this._searchInput,"change",_n.debounce((()=>{0===this._searchInput.value.length&&this._searchController()}),400)),this.listenTo(this._searchInput,"enter",(t=>t.preventDefault())),this.$els.globalList.on("click",`.${this._prefix}-list__item-add-btn`,this._addOrRemoveItem.bind(this,!0,this._type)),this.$els.userList.on("click",`.${this._prefix}-list__item-remove-btn`,this._addOrRemoveItem.bind(this,!1,this._type)),this.$els.loadMoreBtn.click((t=>{t.preventDefault(),this._loadUserItems()}))}async _loadUserItems(t="loadMore",e=""){let s,i=this.$el.data("id"),n=_n.last(this._lastListItemsArray);s="ignore"===this._pageType?await Qi.mB.getList(i,e,n):await Qi.bF.getList(i,e,n),s.hasMore||"loadMore"!==t||(this.$els.form.removeAttr("data-has-more"),this._hasMore=!1),s.list.forEach((e=>{let s=e;"string"==typeof e&&(s={label:e,hidden:"loadMore"!==t});let n=this._prepareItemData(i,s,this._prefix,"removable"),o=this._createListItem(n);this.$els.userList.append(o)})),this.$els.userListItems=this.$el.find(`.${this._prefix}-list__item`),"loadMore"===t&&(this._lastListItemsArray=[],this.$els.userListItems.each(((t,e)=>{this._lastListItemsArray.push(mn(e).data("id"))})))}async _searchController(t=!1){let e=this._searchInput.value;if(this._searchInput.progress=!0,this._currentSearch=e,this._currentRegexp=new RegExp(c.cQ.escapeStringRegExp(this._currentSearch),"i"),t||this._currentSearch!==this._lastSearch){if(this._lastSearch=this._currentSearch,this.$els.userListItems.filter(((t,e)=>mn(e).data("to-hide"))).remove(),this.$els.globalList.html(""),an.y.remove(this.$els.form,"dropdown-item__highlight"),""===this._currentSearch)return this.$els.userListItems.show(),this._hasMore&&this.$els.form.attr("data-has-more",""),0===this.$els.userListItems.length?this.$els.form.attr("data-not-found-user","").attr("data-not-found-global",""):this.$els.form.removeAttr("data-not-found-user").attr("data-not-found-global",""),void(this._searchInput.progress=!1);this._hasMore&&(this.$els.form.removeAttr("data-has-more"),await this._loadUserItems("search",e)),this._searchUserItems(),Qi.k0.getList(e,this._type).then((t=>{this._searchInput.value===e&&(this._updateGlobalList(this._type,t),this._searchInput.progress=!1)}))}else this._searchInput.progress=!1}_searchUserItems(){let t=this._currentRegexp,e=0;this.$els.userListItems.filter(((s,i)=>{let n=mn(i);return t.test(n.data("name"))?(an.y.add(n,t,"dropdown-item__highlight"),e++,!0):(n.hide(),!1)})).show(),e?this.$els.form.removeAttr("data-not-found-user"):this.$els.form.attr("data-not-found-user","")}_updateGlobalList(t,e){let s=this.$els.globalList,i=this.$els.userListItems,n=this._prefix,o=0;e.length?(e.every((e=>{let r=!0;if(i.each((function(){if((e.name||e.label)===mn(this).data("name"))return r=!1,!1})),r){o++;let i=this._prepareItemData(t,e,n,"addable"),r=this._createListItem(i);s.append(r)}return o<=17}),this),o>0?(an.y.add(s,this._currentRegexp,"dropdown-item__highlight"),this.$els.form.removeAttr("data-not-found-global")):this.$els.form.attr("data-not-found-global","")):this.$els.form.attr("data-not-found-global","")}async _addOrRemoveItem(t,e,s){let n,o="settings-subs"===this._prefix;n=t?o?"subscribe":"ignore":o?"unsubscribe":"remove-ignore";let r,a,l,h=mn(s.currentTarget).parent(`.${this._prefix}-list__item`),c=h.data("id"),d=this._prepareItemData(e,h,this._prefix),p={type:t?"my_subs_search":"my_subs"};switch(e){case"users":r=i.ZP.i18n(`page-settings.confirmations.${n}.users.middle`),a=function(t){var e="",s=un.escape;return e+'<a class="user user_inline" href="/@'+s(t.label)+'" target="_blank" data-id="'+s(t.id)+'" data-name="'+s(t.label)+'" data-avatar="'+s(t.avatar)+'">\n\t<span class="avatar avatar_small"><img src="'+s(t.avatar)+'"></span>\n\t<span class="user__nick">'+s(t.label)+"</span>\n</a>"}(d);break;case"tags":r=i.ZP.i18n(`page-settings.confirmations.${n}.tags.middle`),a=function(t){var e="",s=cn.escape;return e+'<a class="'+s(t.prefix)+'__tag tag" data-name="'+s(t.label)+'" href="/tag/'+s(t.label)+'" target="_blank" title="Поиск по тегу '+s(t.label)+'">'+s(t.label)+"</a>"}(d);break;case"communities":r=i.ZP.i18n(`page-settings.confirmations.${n}.communities.middle`),a=function(t){var e="",s=ln.escape;return e+'<div class="'+s(t.prefix)+'__community community community_inline">\n\t<div class="community-avatar community-avatar_small" data-id="'+s(t.id)+'" data-name="'+s(t.label)+'" data-link="'+s(t.link)+'" data-avatar="'+s(t.avatar)+'">\n\t\t<a href="/community/'+s(t.link)+'" target="_blank">\n\t\t\t<img src="'+s(t.avatar)+'">\n\t\t</a>\n\t</div>\n\t<a class="community__title" href="/community/'+s(t.link)+'" target="_blank">'+s(t.label)+"</a>\n</div>"}(d)}h.addClass(`${this._prefix}-list__item_translucent`);try{switch(e){case"users":o?await new u.User(c).subscribe(t,p):await new u.User(c).ignore(t,p);break;case"tags":o?await bs.zG.subscribe(c,t,p):await bs.zG.ignore(c,t,p);break;case"communities":o?await new me.S1(c).subscribe(t,p):await new me.S1(c).ignore(t,p)}}catch(m){return i.ZP.ui.toasts.showError(m.message||m),void h.removeClass(`${this._prefix}-list__item_translucent`)}if(t){let t=this._prepareItemData(e,h,this._prefix,"removable");l=this._createListItem(t),this.$els.userList.append(l),an.y.add(l,this._currentRegexp,"dropdown-item__highlight")}else if(!t&&""!==this._currentSearch){let t=this._prepareItemData(e,h,this._prefix,"addable");l=this._createListItem(t),this.$els.globalList.append(l),an.y.add(l,this._currentRegexp,"dropdown-item__highlight")}!t&&this._hasMore&&(this._lastListItemsArray=_n.without(this._lastListItemsArray,c)),h.remove(),this.$els.userListItems=this.$els.userList.find(`.${this._prefix}-list__item`),this.$els.userListItems.filter(":visible").length?this.$els.form.removeAttr("data-not-found-user"):this.$els.form.attr("data-not-found-user",""),this.$els.globalList.find("li").length?this.$els.form.removeAttr("data-not-found-global"):this.$els.form.attr("data-not-found-global","")}_prepareItemData(t,e,s,i="addable"){let n=e;return n.variant=i,n.prefix=s,n.type=t,n.label||(n.label=e.name?e.name:""),r.Zv.isJQuery(e)&&(n.id=e.data("id"),n.label=e.data("name"),n.avatar=e.data("avatar"),n.link=e.data("link"),n.has_note=e.data("has-note")),n}_createListItem(t){let e;switch(t.type){case"users":e=function(t){var e="",s=pn.escape;return Array.prototype.join,e+='<li class="'+s(t.prefix)+'-list__item" data-to-hide="'+s(t.hidden)+'" data-id="'+s(t.id)+'" data-avatar="'+s(t.avatar)+'" data-name="'+s(t.label)+'" data-has-note="'+s(t.has_note)+'">\n\t<button\n\t',"addable"===t.variant?e+='\n       class="'+s(t.prefix)+'-list__item-add-btn button_link" title="'+s("settings-ignore"===t.prefix?"Добавить в игнор-лист":"Подписаться на пользователя")+'"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon--ui__plus icon--ui__plus_settings-list"><use xlink:href="#icon--ui__plus"></use></svg></button>\n    ':e+='\n      class="'+s(t.prefix)+'-list__item-remove-btn button_link" title="'+s("settings-ignore"===t.prefix?"Убрать пользователя из игнор-листа":"Отписаться от пользователя")+'"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon--ui__close icon--ui__close_settings-list"><use xlink:href="#icon--ui__close"></use></svg></button>\n    ',e+='\n\t<div class="'+s(t.prefix)+'-list__item-content">\n\t\t<a class="user user_inline" data-profile="true" target="_blank" href="/@'+s(t.label)+'" data-id="'+s(t.id)+'" data-name="'+s(t.label)+'" data-avatar="'+s(t.avatar)+'">\n\t\t\t<span class="avatar avatar_small avatar_note">\n\t\t\t\t<span class="avatar__inner"><img src="'+s(t.avatar)+'"></span>\n\t\t\t\t',t.has_note&&(e+='\n\t\t\t\t\t<span class="avatar__note"></span>\n\t\t\t\t'),e+='\n\t\t\t</span><span class="user__nick">'+s(t.label)+"</span>\n\t\t</a>\n\t</div>\n</li>\n"}(t);break;case"tags":e=function(t){var e="",s=dn.escape;return Array.prototype.join,e+='<li class="'+s(t.prefix)+'-list__item" data-to-hide="'+s(t.hidden)+'" data-id="'+s(t.label)+'" data-name="'+s(t.label)+'">\n\t<button\n\t',"addable"===t.variant?e+='\n       class="'+s(t.prefix)+'-list__item-add-btn button_link" title="'+s("settings-ignore"===t.prefix?"В скрытое":"Подписаться на тег")+'"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon--ui__plus icon--ui__plus_size-middle"><use xlink:href="#icon--ui__plus"></use></svg></button>\n\t':e+='\n       class="'+s(t.prefix)+'-list__item-remove-btn button_link" title="'+s("settings-ignore"===t.prefix?"Убрать из скрытого":"Отписаться от тега")+'"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon--ui__close icon--ui__close_size-middle"><use xlink:href="#icon--ui__close"></use></svg></button>\n\t',e+='\n\t<div class="'+s(t.prefix)+'-list__item-content">\n\t\t<a class="'+s(t.prefix)+'__tag tag" data-name="'+s(t.label)+'" href="/tag/'+s(t.label)+'" target="_blank" title="Поиск по тегу '+s(t.label)+'">'+s(t.label)+"</a>\n\t</div>\n</li>\n"}(t);break;case"communities":e=function(t){var e="",s=hn.escape;return Array.prototype.join,e+='<li class="'+s(t.prefix)+'-list__item" data-to-hide="'+s(t.hidden)+'" data-id="'+s(t.id)+'" data-name="'+s(t.label)+'" data-link="'+s(t.link)+'" data-avatar="'+s(t.avatar)+'">\n\t<button\n\t',"addable"===t.variant?e+='\n       class="'+s(t.prefix)+'-list__item-add-btn button_link" title="'+s("settings-ignore"===t.prefix?"Добавить в игнор-лист":"Подписаться на сообщество")+'"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon--ui__plus icon--ui__plus_size-middle"><use xlink:href="#icon--ui__plus"></use></svg></button>\n    ':e+='\n       class="'+s(t.prefix)+'-list__item-remove-btn button_link" title="'+s("settings-ignore"===t.prefix?"Убрать сообщество из игнор-листа":"Отписаться от сообщества")+'"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon--ui__close icon--ui__close_size-middle"><use xlink:href="#icon--ui__close"></use></svg></button>\n    ',e+='\n\t<div class="'+s(t.prefix)+'-list__item-content">\n\t\t<div class="'+s(t.prefix)+'__community community" >\n\t\t\t<div class="community-avatar community-avatar_small">\n\t\t\t\t<a href="/community/'+s(t.link)+'" target="_blank">\n\t\t\t\t\t<img src="'+s(t.avatar)+'">\n\t\t\t\t</a>\n\t\t\t</div>\n\t\t\t<a class="community__title" target="_blank" href="/community/'+s(t.link)+'">'+s(t.label)+"</a>\n\t\t</div>\n\t</div>\n</li>\n"}(t)}return mn(mn.parseHTML(e))}}const vn=s(9755);class fn extends rn{render(){let t="settings-subs";return this.$el=vn(`.${t}`),this.$els={tabs:this.$el.find(`.${t}__tabs`),tabUsers:this.$el.find(`.${t}__tab[data-id="users"]`),tabTags:this.$el.find(`.${t}__tab[data-id="tags"]`),tabCommunities:this.$el.find(`.${t}__tab[data-id="communities"]`)},this._tabs=new et.F(this.$els.tabs),new gn(this.$els.tabUsers,"users",t),new gn(this.$els.tabTags,"tags",t),new gn(this.$els.tabCommunities,"communities",t),i.vE.ui.screen=lt.d.USER_SUBS_LIST,this._initAnalytics(),super.render(),this}}var yn=s(5358),bn=s(8375);const wn={render:()=>yn.vu.create("form",{className:"security-option__fields",name:"password",autoComplete:"off",noValidate:"true"},yn.vu.create("label",{className:"security-option__field"},yn.vu.create("div",{className:"security-option__label"},"Текущий пароль"),yn.vu.create("div",{className:"security-option__value"},yn.vu.create("div",{className:"input input_box input_small"},yn.vu.create("div",{className:"input__box"},yn.vu.create("input",{type:"password",className:"input__input",name:"password_current",required:!0,minLength:"4",maxLength:"160"}))))),yn.vu.create("label",{className:"security-option__field"},yn.vu.create("div",{className:"security-option__label"},"Новый пароль"),yn.vu.create("div",{className:"security-option__value"},yn.vu.create("div",{className:"input input_box input_small"},yn.vu.create("div",{className:"input__box"},yn.vu.create("input",{type:"password",className:"input__input",name:"password_new",required:!0,minLength:"4",maxLength:"160"})),yn.vu.create("span",{className:"input__complexity"})))),yn.vu.create("label",{className:"security-option__field"},yn.vu.create("div",{className:"security-option__label"},"Повторите пароль"),yn.vu.create("div",{className:"security-option__value"},yn.vu.create("div",{className:"input input_box input_small"},yn.vu.create("div",{className:"input__box"},yn.vu.create("input",{type:"password",className:"input__input",name:"password_confirm",required:!0,minLength:"4",maxLength:"160"}))))),yn.vu.create("div",{className:"security-option__footer"},yn.vu.create("button",{type:"submit",className:"button_success"}),yn.vu.create("div",{className:"security-option__value-hint"}),yn.vu.create("button",{className:"security-option__close","data-to":"cancel"},"Отмена"))),notUpdate:!0},En={render:()=>yn.vu.create("form",{className:"security-option__fields",name:"email",autoComplete:"off",noValidate:"true"},yn.vu.create("div",{className:"security-option__header"},yn.vu.create("div",{className:"security-option__field"},yn.vu.create("div",{className:"security-option__label"},"Email"),yn.vu.create("div",{className:"security-option__value"}))),yn.vu.create("label",{className:"security-option__field"},yn.vu.create("div",{className:"security-option__label"},"Новая почта"),yn.vu.create("div",{className:"security-option__value"},yn.vu.create("div",{className:"input input_box input_small"},yn.vu.create("div",{className:"input__box"},yn.vu.create("input",{type:"email",className:"input__input",name:"email",required:!0}))))),yn.vu.create("label",{className:"security-option__field"},yn.vu.create("div",{className:"security-option__label"},"Текущий пароль"),yn.vu.create("div",{className:"security-option__value"},yn.vu.create("div",{className:"input input_box input_small"},yn.vu.create("div",{className:"input__box"},yn.vu.create("input",{type:"password",className:"input__input",name:"password",required:!0}))))),yn.vu.create("div",{className:"security-option__footer"},yn.vu.create("button",{type:"submit",className:"button_success"}),yn.vu.create("div",{className:"security-option__value-hint"}),yn.vu.create("button",{className:"security-option__close","data-to":"cancel"},"Отмена"))),notUpdate:!0},Sn={render:()=>yn.vu.create("form",{className:"security-option__fields",name:"phone",autoComplete:"off",noValidate:"true"},yn.vu.create("div",{className:"security-option__header"},yn.vu.create("div",{className:"security-option__field"},yn.vu.create("div",{className:"security-option__label"},"Телефон"),yn.vu.create("div",{className:"security-option__value"}))),yn.vu.create("label",{className:"security-option__field"},yn.vu.create("div",{className:"security-option__label"},"Новый номер"),yn.vu.create("div",{className:"security-option__value"},yn.vu.create("div",{className:"input input_box input_small"},yn.vu.create("div",{className:"input__box"},yn.vu.create("input",{type:"tel",className:"input__input",autoComplete:"tel",name:"phone",required:!0}))))),yn.vu.create("label",{className:"security-option__field"},yn.vu.create("div",{className:"security-option__label"},"Текущий пароль"),yn.vu.create("div",{className:"security-option__value"},yn.vu.create("div",{className:"input input_box input_small"},yn.vu.create("div",{className:"input__box"},yn.vu.create("input",{type:"password",className:"input__input",name:"password",required:!0,minLength:"4",maxLength:"160"}))))),yn.vu.create("div",{className:"security-option__footer"},yn.vu.create("button",{type:"submit",className:"button_success"}),yn.vu.create("div",{className:"security-option__value-hint"}),yn.vu.create("button",{className:"security-option__close","data-to":"cancel"},"Отмена"))),notUpdate:!0},Cn={render:()=>yn.vu.create("form",{className:"security-option__fields",name:"nickname",autoComplete:"off",noValidate:"true"},yn.vu.create("div",{className:"security-option__header"},yn.vu.create("div",{className:"security-option__field"},yn.vu.create("div",{className:"security-option__label"},"Никнейм"),yn.vu.create("div",{className:"security-option__value"}))),yn.vu.create("div",{className:"security-option__warning",hidden:!0},yn.vu.create("p",{className:"security-option__warning_nickname"},"Вы слишком часто меняете никнейм. Попробуйте позже")),yn.vu.create("label",{className:"security-option__field"},yn.vu.create("div",{className:"security-option__label"},"Новый никнейм"),yn.vu.create("div",{className:"security-option__value"},yn.vu.create("div",{className:"input input_box input_small"},yn.vu.create("div",{className:"input__box"},yn.vu.create("input",{type:"text",className:"input__input",name:"nickname",autoComplete:"off",autoCapitalize:"none",autoCorrect:"off",minLength:"4",maxLength:"16",required:!0}))))),yn.vu.create("label",{className:"security-option__field"},yn.vu.create("div",{className:"security-option__label"},"Текущий пароль"),yn.vu.create("div",{className:"security-option__value"},yn.vu.create("div",{className:"input input_box input_small"},yn.vu.create("div",{className:"input__box"},yn.vu.create("input",{type:"password",className:"input__input",name:"password",required:!0}))))),yn.vu.create("div",{className:"security-option__footer"},yn.vu.create("button",{type:"submit",className:"button_success"}),yn.vu.create("button",{className:"security-option__close","data-to":"cancel"},"Отмена"))),notUpdate:!0},Tn=s(381);function On(t,e){const s="page-settings.security.promo",n="security-option security-option_type_header",o="security-option security-option_type_form";let r=e===Fi.PASSWORD,a=e===Fi.EMAIL,l=e===Fi.PHONE,h=e===Fi.NICKNAME,c=t.data.isEmptyPassword,d=t.data.isEmptyPhone,u=t.data.isEmptyEmail,p=Boolean(t.data.phoneNew),m=!(c||u||d),_=d&&u&&c,g=i.vE.i18n(s+".header."+(m?"strong":_?"week":"good")),v=m?"success":_?"danger":"warning";return yn.vu.create("div",{className:"settings-security"},i.vE.initParams.isConfirmed?null:yn.vu.create("section",{className:"section_warning","data-role":"account-confirm"},"Ваш аккаунт ещё не подтверждён. Привяжите соцсеть или номер телефона, чтобы получить возможность публиковать посты и оставлять комментарии."),yn.vu.create("div",{className:"section-group"},yn.vu.create("section",{className:"section_gray settings-security__promo"},yn.vu.create("div",null,yn.vu.create(bn.t,{block:"ui__shield",modifiers:"settings_security "+v}),yn.vu.create("h4",null,g)),yn.vu.create("div",null,c?yn.vu.create("div",null,yn.vu.create("a",{href:"#set-password"},i.vE.i18n(s+".messages.need-password"))):null,d?yn.vu.create("div",null,yn.vu.create("a",{href:"#set-phone"},i.vE.i18n(s+".messages.need-phone"))):null,u?yn.vu.create("div",null,yn.vu.create("a",{href:"#set-email"},i.vE.i18n(s+".messages.need-email"))):null)),yn.vu.create("section",{className:"section_padding_none settings-security__options"},yn.vu.create("div",{className:n+(r?" security-option_hide":"")},yn.vu.create("div",{className:"security-option__field"},yn.vu.create("div",{className:"security-option__label"},"Пароль"),yn.vu.create("div",{className:"security-option__value"},!c&&t.data.passwordLastUpdate?i.vE.i18n("page-settings.security.password.last-set",Tn(t.data.passwordLastUpdate).fromNow()):"")),yn.vu.create("button",{className:"button_link security-option__action","data-to":"password"},i.vE.i18n(c?"modal.set":"modal.change"))),yn.vu.create("hr",{style:r||l?"display: none":""}),yn.vu.create("div",{className:o+(r?"":" security-option_hide")},yn.vu.create(wn,null)),yn.vu.create("div",{className:n+(l?" security-option_hide":"")},yn.vu.create("div",{className:"security-option__field"},yn.vu.create("div",{className:"security-option__label"},"Телефон"),yn.vu.create("div",{className:"security-option__value"},t.data.phoneNew?i.vE.i18n("page-settings.security.phone.change-after",Tn(t.data.phoneNewDate).fromNow(),t.data.phoneNew):t.data.phoneCurrent||null)),yn.vu.create("button",{className:"button_link security-option__action","data-to":"phone"},i.vE.i18n(d?"modal.add":p?"page-settings.security.phone.cancel-phone-change":"modal.change"))),yn.vu.create("hr",{style:l||h?"display: none":""}),yn.vu.create("div",{className:o+(l?"":" security-option_hide")},yn.vu.create(Sn,null)),yn.vu.create("div",{className:n+(h?" security-option_hide":"")},yn.vu.create("div",{className:"security-option__field"},yn.vu.create("div",{className:"security-option__label"},"Никнейм"),yn.vu.create("div",{className:"security-option__value"},t.data.nicknameCurrent||"")),yn.vu.create("button",{className:"button_link security-option__action","data-to":"nickname"},i.vE.i18n("modal.change"))),yn.vu.create("hr",{style:h||a?"display: none":""}),yn.vu.create("div",{className:o+(h?"":" security-option_hide")},yn.vu.create(Cn,null)),yn.vu.create("div",{className:n+(a?" security-option_hide":"")},yn.vu.create("div",{className:"security-option__field"},yn.vu.create("div",{className:"security-option__label"},"Email"),yn.vu.create("div",{className:"security-option__value"},t.data.emailCurrent||"")),yn.vu.create("button",{className:"button_link security-option__action","data-to":"email"},i.vE.i18n(u?"modal.add":"modal.change"))),yn.vu.create("div",{className:o+(a?"":" security-option_hide")},yn.vu.create(En,null))),yn.vu.create("section",{className:"section_gray section_center"},yn.vu.create("button",{type:"button",className:"button_danger","data-role":"logout"},"Выйти на всех устройствах"))),(({vk:t,fb:e,tw:s,google:n,canDelete:o})=>yn.vu.create("div",{className:"settings-security-social section-group"},yn.vu.create("section",{className:"section_gray"},yn.vu.create("h4",null,"Вход через социальные сети")),yn.vu.create("section",{className:"section_padding_none settings-security-social__list"},yn.vu.create("div",{className:"settings-security-social__item"},yn.vu.create("div",{className:"settings-security-social__item-wrapper"},yn.vu.create("span",{className:"settings-security-social__item-icon social-icon social-icon_color","data-role":"vk"},yn.vu.create(bn.t,{block:"social__vk"})),yn.vu.create("div",{className:"settings-security-social__item-value"},t||"VK"),yn.vu.create("button",{className:"settings-security-social__item-button button_link","data-to":"vk"},i.vE.i18n("page-settings.security.social."+(t?"unset":"set"))))),yn.vu.create("div",{className:"settings-security-social__item"},yn.vu.create("div",{className:"settings-security-social__item-wrapper"},yn.vu.create("span",{className:"settings-security-social__item-icon social-icon social-icon_color","data-role":"facebook"},yn.vu.create(bn.t,{block:"social__facebook"})),yn.vu.create("div",{className:"settings-security-social__item-value"},e||"Facebook"),yn.vu.create("button",{className:"settings-security-social__item-button button_link","data-to":"facebook"},i.vE.i18n("page-settings.security.social."+(e?"unset":"set"))))),yn.vu.create("div",{className:"settings-security-social__item"},yn.vu.create("div",{className:"settings-security-social__item-wrapper"},yn.vu.create("span",{className:"settings-security-social__item-icon social-icon social-icon_color","data-role":"twitter"},yn.vu.create(bn.t,{block:"social__twitter"})),yn.vu.create("div",{className:"settings-security-social__item-value"},s||"Twitter"),yn.vu.create("button",{className:"settings-security-social__item-button button_link","data-to":"twitter"},i.vE.i18n("page-settings.security.social."+(s?"unset":"set"))))),yn.vu.create("div",{className:"settings-security-social__item"},yn.vu.create("div",{className:"settings-security-social__item-wrapper"},yn.vu.create("span",{className:"settings-security-social__item-icon social-icon social-icon_color","data-role":"google"},yn.vu.create(bn.t,{block:"social__google"})),yn.vu.create("div",{className:"settings-security-social__item-value"},n||"Google"),yn.vu.create("button",{className:"settings-security-social__item-button button_link","data-to":"google"},i.vE.i18n("page-settings.security.social."+(n?"unset":"set")))))),yn.vu.create("section",{className:"section_gray section_center"},o&&yn.vu.create("button",{type:"button","data-role":"delete",className:"button_danger"},"Удалить аккаунт"),!o&&yn.vu.create("button",{type:"button",disabled:"true","data-role":"delete",className:"button_danger"},"Удалить аккаунт",yn.vu.create("span",{className:"hint hint_left","aria-label":"Вы недавно восстанавливали аккаунт. <br> Удаление аккаунта вам пока недоступно."})))))(t.data))}var kn=s(3086);const In=s(9755),$n=s(381),An=s(6419),xn={validationEvent:T.km.MANUAL,validationHint:{direction:k.Lh.RIGHT,alignment:k.SE.CENTER}};class Dn extends Fs.T3{route(t,e){return this.ctx=t,this.isShown||this.show(),this._detectNeedFocusToOption(),e()}async _detectNeedFocusToOption(){if(!this.ctx.hash||0!==this.ctx.hash.indexOf("set-"))return void(this.currentOption&&(this.currentOption=void 0));let t=Fi[this.ctx.hash.slice(4)];if(t){this.currentOption=t;try{if(this.currentOption===t&&this._forms.has(t)){let e=this._forms.get(t).form.$el;i.vE.ui.elementInViewport(e)||await i.vE.ui.scrollTo(e.offset().top-20,!0)}}catch(e){}}}render(){if(this.isRendered)return this;this.$parent=In(".settings");const t=i.vE.config("modules.settings.security");this._updateStateThrottle=An.throttle(this._updateState.bind(this),30),this._forms=new Map,this._options.state=new qi.Lo({isEmptyPassword:t.isEmptyPassword,isEmptyPhone:!(An.isString(t.phoneCurrent)&&t.phoneCurrent.length>0),isEmptyEmail:!(An.isString(t.emailCurrent)&&t.emailCurrent.length>0),passwordLastUpdate:t.passwordLastUpdate?$n(t.passwordLastUpdate):void 0,phoneCurrent:t.phoneCurrent,phoneNew:t.phoneNew,oauthError:Number(t.oauthError),oauthErrorMessage:t.oauthErrorMessage||"",phoneNewDate:t.phoneNewDate,emailCurrent:t.emailCurrent,nicknameCurrent:i.vE.config("modules.settings.main.userName"),lastChangeNicknameTimestamp:t.lastChangeNicknameTimestamp,vk:t.oauth[Bi.VK.valueOf()],fb:t.oauth[Bi.FACEBOOK.valueOf()],tw:t.oauth[Bi.TWITTER.valueOf()],google:t.oauth[Bi.GOOGLE.valueOf()],canDelete:t.isProfileDeletionAllowed}),this.listenTo(this.state,qi.u$.CHANGE,this._updateStateThrottle),this._update(!0),this.state.data.oauthError&&this.state.data.oauthErrorMessage.length&&i.vE.ui.toasts.add("oauth-error",{theme:v.K.DANGER,closeAfter:5e3,content:this.state.data.oauthErrorMessage}),this._initPasswordForm(),this._initPhoneForm(),this._initEmailForm(),this._initNicknameForm(),this.$('button[data-role="logout"]').click(u.User.logout.bind(this,!0)),this.$('button[data-role="delete"]').click(this._attachDeleteConfirmPopup);const e=".security-option__action, .settings-security-social__item-button, .security-option__close";return this.$el.on("click",e,this._routeToOption.bind(this)),this.$el.on("click",".security-option_type_header, .settings-security-social__item",(t=>{In(t.target).closest("button").length||In(t.currentTarget).find(e).trigger("click")})),super.render(),this}_update(t=!1){if(!t&&!this.isRendered)return;let e=On(this.state,this.currentOption);this.el?this.marks.has("_vNode")?yn.zM.node(this.marks.get("_vNode"),e,"root").reduce(yn.nq.updateElement(void 0,this),this.el):r.Zv.clearEmptyTextNode(this.el):this.el=yn.wK.createElement(e,"root",void 0,this),this.marks.set("_vNode",e)}_attachDeleteConfirmPopup(){const t=new k.LD({content:'<div class="delete-modal">\n    <h3 class="delete-modal__title">Вы действительно хотите удалить аккаунт? Его можно восстановить в течение 6 месяцев</h3>\n    <p>Перед удалением аккаунта не&nbsp;забудьте повторно ознакомиться с&nbsp;правилами сайта:</p>\n    <ul class="delete-modal__list">\n        <li class="delete-modal__item"><a href="https://pikabu.ru/information/rules#10" target="_blank">Мультиаккаунты</a></li>\n        <li class="delete-modal__item"><a href="https://pikabu.ru/information/rules#12" target="_blank">Юридическая информация</a></li>\n        <li class="delete-modal__item"><a href="https://pikabu.ru/information/terms" target="_blank">Политика конфиденциальности</a></li>\n    </ul>\n</div>'});t.addButtonIntoFooter(i.vE.i18n("page-settings.save-categories.yes"),(async()=>{await ss.removeAccount()&&(i.vE.history.location.href="/"),t.hide()}),Bs.j.DANGER),t.addCloseButtonIntoFooter(i.vE.i18n("page-settings.save-categories.no")),t.show()}_updateState(){if(this._update(!0),!this.currentOption||!this._forms.has(this.currentOption))return;const t=this._forms.get(this.currentOption);switch(t.form.reset(),this.currentOption){case Fi.PASSWORD:this._showPasswordForm(t);break;case Fi.PHONE:this._showPhoneForm(t);break;case Fi.NICKNAME:this._showNicknameForm(t);break;case Fi.EMAIL:this._showEmailForm(t)}}_showPasswordForm(t){const e=this.state.data.isEmptyPassword;t.$current.toggle(!e),e?(t.passwordNew.focus(),t.submit.title=i.vE.i18n("page-settings.security.password.set")):(t.passwordCurrent.focus(),t.submit.title=i.vE.i18n("page-settings.security.password.change")),t.$passwordComplexity.dataset.type=""}_showPhoneForm(t){let e=this.state.data.isEmptyPhone,s=Boolean(this.state.data.phoneNew);s?t.passwordCurrent.focus():t.phone.focus(),t.$phone.toggle(!s),t.$password.toggle(!e),t.$current.toggle(!e&&!s).find(".security-option__value").text(this.state.data.phoneCurrent||""),e&&t.$current.parent().remove(),t.submit.title=i.vE.i18n("page-settings.security.phone."+(e?"set":s?"cancel-phone-change-button":"change"))}_showNicknameForm(t){if(d.c.getInstance().sendEvent("click",{button:"nickname_change_expand"}),this._isNicknameChangeRecently()){this._disableNicknameForm(t),t.$current.find(".security-option__value").text(this.state.data.nicknameCurrent);t.form.el.querySelector(".security-option__warning").removeAttribute("hidden");t.form.el.querySelectorAll(".input__box").forEach((t=>t.classList.add("input_disabled")))}else t.nickname.focus(),t.$current.toggle(!0).find(".security-option__value").text(this.state.data.nicknameCurrent),t.submit.title=i.vE.i18n("page-settings.security.nickname.change")}_showEmailForm(t){let e=this.state.data.isEmptyEmail;t.email.focus(),t.$current.toggle(!e).find(".security-option__value").text(this.state.data.emailCurrent||""),t.submit.title=i.vE.i18n("page-settings.security.email."+(e?"set":"change"))}_isNicknameChangeRecently(){return Date.now()-(this.state.data.lastChangeNicknameTimestamp||0)<15552e6}_disableNicknameForm(t){t.nickname.disabled=!0,t.passwordCurrent.disabled=!0,t.submit.title=i.vE.i18n("page-settings.security.nickname.change"),t.submit.disabled=!0}async _routeToOption(t){const e=In(t.currentTarget).closest("button"),s=String(e.data("to"));if("cancel"===s)t.preventDefault(),this.currentOption=void 0;else if(Fi[s])this.currentOption=Fi[s];else if(Bi[s.toUpperCase()]){const t=Bi[s.toUpperCase()],e=t.valueOf().toLowerCase(),n=this.state.data[e];if(!Boolean(n)){const{result:t,message:s,accounts:n}=await(new kn.S).link(e);return t?(setTimeout((()=>{document.querySelectorAll('[data-role="account-confirm"]').forEach((t=>t.hidden=!0))}),100),void Object.entries(n).forEach((([t,e])=>{t in this.state.data&&(this.state.data[t]=e)}))):(this.state.data.oauthErrorMessage=s,void i.vE.ui.toasts.add("oauth-error",{theme:v.K.DANGER,closeAfter:5e3,content:s}))}if(this.state.data.isEmptyPassword)return void this._needPasswordToast("social");await pt.g.confirmModal({header:i.vE.i18n("page-settings.security.social.deactive.header"),content:`\n\t\t\t\t\t<div class="security-option_popup">\n\t\t\t\t\t\t<span class="social-icon social-icon_color" data-type="${t.name.toLowerCase()}">\n\t\t\t\t\t\t${i.vE.icon("social__"+t.name.toLowerCase())}\n\t\t\t\t\t\t</span> ${n}\n\t\t\t\t\t</div>\n\t\t\t\t`,buttons:[["page-settings.security.social.deactive.button",Bs.j.DANGER,!0],["modal.cancel"]]})&&await u.User.removeOAuth(t)&&(setTimeout((()=>{document.querySelectorAll('[data-role="account-confirm"]').forEach((t=>t.hidden=!1))}),100),this.state.data[t.toString().toLowerCase()]=!1)}}_lockForm(t,e){if(!this._forms.has(t))return this;let s=this._forms.get(t);return(e=e||0)>1e3?(s.submit.disabled=!0,s.$tryHint.show(),s.$tryHint.text(i.vE.i18n("page-settings.security.try",$n(e).format("mm:ss"))),this.interval("lock-"+t,1e3,(()=>{(e-=1e3)>0?s.$tryHint.text(i.vE.i18n("page-settings.security.try",$n(e).format("mm:ss"))):this._lockForm(t,0)}))):(s.submit.disabled=!1,s.$tryHint.hide(),this.cancelInterval("lock-"+t)),this}_initPasswordForm(){let t=this.$('form[name="password"]');if(!t.length)return;let e=new a.x(t);this.listenTo(e,"submit",this._onSubmitPassword);let s=new st.y3({$el:t.find('button[type="submit"]'),animationName:"signup"}),i=new T.u3({$el:t.find('input[name="password_current"]').closest(".input")});i.setOptions(xn),e.add(i);let n=t.find(".input__complexity").get(0),o=new T.u3({$el:t.find('input[name="password_new"]').closest(".input"),validationRules:{"page-settings.security.password.identical":t=>!!this.state.data.isEmptyPassword||t!==i.value,"auth.up.errors.password-short":T.cX.isLength(4),"auth.up.errors.password-week":()=>c.YV.test(o.value)>c.eU.WEEK}});o.setOptions(xn),this.listenTo(o,"input",An.throttle((()=>n.dataset.type=c.YV.test(o.value).toString().toLowerCase()),200)),e.add(o);let r=new T.u3({$el:t.find('input[name="password_confirm"]').closest(".input"),validationRules:{"page-settings.security.password.not-identical":t=>o.value===t}});r.setOptions(xn),e.add(r),this._forms.set(Fi.PASSWORD,{form:e,submit:s,passwordCurrent:i,passwordNew:o,passwordConfirm:r,$passwordComplexity:n,$current:t.find('input[name="password_current"]').closest(".security-option__field"),$tryHint:t.find(".security-option__value-hint")})}async _onSubmitPassword(t,e){t&&An.isFunction(t.preventDefault)&&t.preventDefault();let s=this._forms.get(Fi.PASSWORD);if(s.submit.disabled||s.submit.animation||!(await e.checkValidity()))return;s.submit.animation=!0;let n=e.serialize(),o=this.state.data.isEmptyPassword,r=Date.now();try{let t=await u.User.changePassword(n.password_new,n.password_current),a=!0===t;if(await c.cQ.delay(1e3-(Date.now()-r)),!a){let e=3;a=await pt.g.confirmSMS({header:"Введите код из SMS сообщения",id:t,callback:async s=>e-- >0&&await u.User.changePasswordConfirm(t,s)})}a?(this.state.data.passwordLastUpdate=new Date,this.state.data.isEmptyPassword=!1,this.currentOption=void 0,i.vE.ui.toasts.add({content:i.vE.i18n("page-settings.security.password.good-"+(o?"set":"change"))}),e.reset()):this._lockForm(Fi.PASSWORD,u.SETTINGS_TIMEOUTE-(Date.now()-r)),s.submit.animation=!1}catch(a){switch(await c.cQ.delay(1e3-(Date.now()-r)),a.param){case"password_current":s.passwordCurrent.setCustomValidity(a.message);break;case"password_new":s.passwordNew.setCustomValidity(a.message);break;case"password_confirm":s.passwordConfirm.setCustomValidity(a.message);break;default:i.vE.ui.toasts.showError(a.message||i.vE.i18n("page-settings.save.password-bad"))}s.submit.animation=!1}}_initPhoneForm(){let t=this.$('form[name="phone"]');if(!t.length)return;let e=new a.x(t);this.listenTo(e,"submit",this._onSubmitPhone);let s=new st.y3({$el:t.find('button[type="submit"]'),animationName:"signup"}),i=new T.u3({$el:t.find('input[name="phone"]').closest(".input"),sanitizerRules:[T.op.whitelist("0-9\\+"),c.cQ.preparePhone],validationRules:{"auth.up.errors.phone":t=>(i.value=t,Pt.E.test(t))}});i.setOptions(xn),e.add(i);let n=new T.u3({$el:t.find('input[name="password"]').closest(".input")});n.setOptions(xn),e.add(n),this._forms.set(Fi.PHONE,{form:e,submit:s,phone:i,passwordCurrent:n,$phone:i.$el.closest(".security-option__field"),$current:t.find(".security-option__field:first"),$password:t.find('input[name="password"]').closest(".security-option__field"),$tryHint:t.find(".security-option__value-hint")})}async _onSubmitPhone(t,e){t&&An.isFunction(t.preventDefault)&&t.preventDefault();let s=this._forms.get(Fi.PHONE);if(s.submit.disabled||s.submit.animation||!(await e.checkValidity()))return;let n=this.state.data.isEmptyPhone,o=Boolean(this.state.data.phoneNew),r=s.passwordCurrent.value,a=s.phone.value;s.submit.animation=!0;let l=Date.now();try{let t;t=o?await u.User.cancelChangePhone(r):n?await u.User.addPhone(a):await u.User.changePhone(a,r),await c.cQ.delay(1e3-(Date.now()-l));let h=3;await pt.g.confirmSMS({header:"Введите код из SMS сообщения",id:t,callback:async e=>h-- >0&&(o?await u.User.cancelChangePhoneConfirm(t,e):n?await u.User.addPhoneConfirm(t,e):await u.User.changePhoneConfirm(t,e))})?(this.state.data.isEmptyPhone=!1,o?(this.state.data.phoneNew=void 0,this.state.data.phoneNewDate=void 0):n?this.state.data.phoneCurrent=c.cQ.maskPhone(a):(this.state.data.phoneNew=c.cQ.maskPhone(a),this.state.data.phoneNewDate=$n().add(1,"days").toDate()),this.currentOption=void 0,i.vE.ui.toasts.add({content:i.vE.i18n("page-settings.security.phone.good-"+(n?"set":o?"change-cancel":"change"))}),e.reset(),document.querySelectorAll('[data-role="account-confirm"]').forEach((t=>t.remove()))):this._lockForm(Fi.PHONE,u.SETTINGS_TIMEOUTE-(Date.now()-l)),s.submit.animation=!1}catch(h){switch(await c.cQ.delay(1e3-(Date.now()-l)),h.param){case"password":s.passwordCurrent.setCustomValidity(h.message);break;case"phone":case"new_phone":s.phone.setCustomValidity(h.message);break;default:i.vE.ui.toasts.showError(h.message||i.vE.i18n("page-settings.save.password-bad"))}s.submit.animation=!1}}_initEmailForm(){let t=this.$('form[name="email"]');if(!t.length)return;let e=new a.x(t);this.listenTo(e,"submit",this._onSubmitEmail);let s=new st.y3({$el:t.find('button[type="submit"]'),animationName:"signup"}),i=new T.u3({$el:t.find('input[name="email"]').closest(".input")});i.setOptions(xn),e.add(i);let n=new T.u3({$el:t.find('input[name="password"]').closest(".input")});n.setOptions(xn),e.add(n),this._forms.set(Fi.EMAIL,{form:e,submit:s,email:i,passwordCurrent:n,$current:t.find(".security-option__field:first"),$password:t.find('input[name="password"]').closest(".security-option__field"),$tryHint:t.find(".security-option__value-hint")})}_initNicknameForm(){let t=this.$('form[name="nickname"]');if(!t.length)return;let e=new a.x(t);this.listenTo(e,"submit",this._onSubmitNickname);let s=new st.y3({$el:t.find('button[type="submit"]'),animationName:"signup"}),i=new T.u3({$el:t.find('input[name="nickname"]').closest(".input"),sanitizerRules:[T.op.trim(),T.op.clearHTMLTags(),T.op.clearURLs(),T.op.escape()],validationRules:{"validation-rules.required":T.cX.required(),"auth.up.errors.username-short":T.cX.isLength(4),"auth.up.errors.username-long":[T.cX.isLength(0,16)],"auth.up.errors.username-whitelist":T.cX.patternMatch(/^([A-Za-z0-9.]*)$/),"auth.up.errors.username-last-dot":T.cX.patternMatch(/[^.]$/),"auth.up.errors.username-first-dot":T.cX.patternMatch(/^[^.]/),"auth.up.errors.username-many-dot":t=>(t.match(/\./g)||[]).length<2,"auth.up.errors.username-busy":async t=>{let e=await u.User.isUserAvailable(t);return!Boolean(null==e?void 0:e.message.length)}},onValidityErrorMessage:(t,{input:e})=>{this._sendOnValidationErrorAnalytics(t,{input:e})}});i.setOptions(xn),e.add(i);let n=new T.u3({$el:t.find('input[name="password"]').closest(".input")});n.setOptions(xn),e.add(n),this._forms.set(Fi.NICKNAME,{form:e,submit:s,nickname:i,passwordCurrent:n,$nickname:i.$el.closest(".security-option__field"),$current:t.find(".security-option__field:first"),$password:t.find('input[name="password"]').closest(".security-option__field"),$tryHint:t.find(".security-option__value-hint")})}async _onSubmitNickname(t,e){t.preventDefault();let s=this._forms.get(Fi.NICKNAME);if(s.submit.disabled||s.submit.animation)return;const n=this.state.data.nicknameCurrent,o=s.nickname.value;if(d.c.getInstance().sendEvent("click",{button:"nickname_change",value_old:n,value_new:o}),!(await e.checkValidity()))return;const r=s.passwordCurrent.value,a=Date.now();s.submit.animation=!0;try{let t=await u.User.changeNickname(o,r);await c.cQ.delay(1e3-(Date.now()-a)),t?(u.User.sendSettingsChangeAnalytics("nickname",n,o),this._changeNicknameOnPage(o),this.currentOption=void 0,i.vE.ui.toasts.add({content:i.vE.i18n("page-settings.security.nickname.good-change")}),e.reset()):this._lockForm(Fi.NICKNAME,u.SETTINGS_TIMEOUTE-(Date.now()-a)),s.submit.animation=!1}catch(l){switch(await c.cQ.delay(1e3-(Date.now()-a)),l.param){case"password":s.passwordCurrent.setCustomValidity(l.message);break;case"nickname":s.nickname.setCustomValidity(l.message);break;default:i.vE.ui.toasts.showError(l.message||i.vE.i18n("page-settings.save.password-bad"))}s.submit.animation=!1}}_changeNicknameOnPage(t){this.state.data.nicknameCurrent=t;const e=document.querySelector("a.user__nick");e.textContent=t,e.setAttribute("title",t),e.setAttribute("href",i.vE.history.location.origin+"/@"+t)}async _onSubmitEmail(t,e){t&&An.isFunction(t.preventDefault)&&t.preventDefault();let s=this._forms.get(Fi.EMAIL);if(s.submit.disabled||s.submit.animation||!(await e.checkValidity()))return;let n=this.state.data.isEmptyEmail,o=s.passwordCurrent.value,r=s.email.value,a=Date.now();s.submit.animation=!0;try{let t=await u.User.changeEmail(r,o);await c.cQ.delay(1e3-(Date.now()-a)),t?(this.state.data.emailCurrent=c.cQ.maskEmail(r),this.state.data.isEmptyEmail=!1,this.currentOption=void 0,i.vE.ui.toasts.add({content:i.vE.i18n("page-settings.security.email.good-"+(n?"set":"change"))}),e.reset()):this._lockForm(Fi.EMAIL,u.SETTINGS_TIMEOUTE-(Date.now()-a)),s.submit.animation=!1}catch(l){switch(await c.cQ.delay(1e3-(Date.now()-a)),l.param){case"password":s.passwordCurrent.setCustomValidity(l.message);break;case"email":s.email.setCustomValidity(l.message);break;default:i.vE.ui.toasts.showError(l.message||i.vE.i18n("page-settings.save.password-bad"))}s.submit.animation=!1}}_needPasswordToast(t){i.vE.ui.toasts.add("need-password-"+t,{content:`page-settings.security.${t}.need-password`,theme:v.K.DANGER}).$el.find("a").off(".message").click("click.message",(t=>n.u1.closestUIElement(t.target).hide()))}_sendOnValidationErrorAnalytics(t,{input:e}){const s=t.match(/^.+\.(.+?)(?:\(.*)?$/i),i="nickname"===e.attr("name")?"username":e.attr("name"),n=s&&s[1]?s[1]:t,o=ot[i][n]||"unknown_error";d.c.getInstance().sendEvent("error_occurred",{type:o},[oe.b0.CLICKHOUSE])}get state(){return this._options.state}get currentOption(){return this._options.currentOption}set currentOption(t){t=Fi[t];let e=this._options.currentOption,s=(t||"").toString().toLowerCase();t!==e&&(!this.state.data.isEmptyPassword||(t!==Fi.PHONE||this.state.data.isEmptyPhone)&&t!==Fi.EMAIL&&t!==Fi.NICKNAME?(this._options.currentOption=t,this.isRendered&&this._updateStateThrottle()):this._needPasswordToast(s))}}class Pn extends Fs.T3{_initAnalytics(){this.$el.find(".user").on("click auxclick",(t=>{0!==t.button&&1!==t.button||d.c.getInstance().sendEvent("transition_to_author",{type:"from_notes",author_id:Di(t.currentTarget)})}))}}const Rn=s(9755);const Mn=s(9755);class Nn extends Fs.GR{onMatch(t,e){document.title=i.vE.i18n(`page-settings.${t.params.page||"main"}.title`),super.onMatch(t,e)}constructor(t){super(t),this.use({"/settings/:page(save-categories|security|notifications)?":this,"/settings":Xi,"/settings/save-categories":on,"/settings/security":Dn,"/settings/notifications":Un})}render(){return this.isRendered||(this.$el=Mn(".settings"),this.$('div[data-role="spinner"]').hide(),i.vE.ui.screen=lt.d.USER_SETTINGS,super.render()),this}}var Bn=s(9050);const Ln=s(9755),Fn=s(6419);class Un extends Hi{route(t,e){return this.ctx=t,this.isShown||this.show(),this._detectNeedFocusToOption("notification-option__wrapper"),e()}render(){super.render();const t=i.ZP.config("modules.settings.notifications");return t.showAchievements=q.V.isUserInExperiment(q.t.GAMIFICATION),this.$el=Ln(function(t){var e="",s=Bn.escape;return Array.prototype.join,e+='<div class="settings-notifications">\n\t\x3c!-- Аккаунт --\x3e\n\t<form class="settings-notifications__form" name="notification" method="POST" action="javascript:void 0;" autocomplete="off" novalidate>\n\t\t<div class="section-group">\n\t\t\t<section class="section section_gray">\n\t\t\t\t<h4>Аккаунт</h4>\n\t\t\t</section>\n\t\t\t<section class="section_padding_none settings-notifications__options">\n\t\t\t\t<div class="notification-option__wrapper" data-role="moderator_user_action">\n\t\t\t\t\t<div class="notification-option">\n\t\t\t\t\t\t<div class="notification-option__label">Модерация и поддержка</div>\n\t\t\t\t\t\t<div class="notification-option__action" data-option="moderator_user_action" data-disabled="bell">\n\t\t\t\t\t\t\t<input type="hidden" name="moderator_user_action" value="'+s(JSON.stringify(t.moderator_user_action))+'"/>\n\t\t\t\t\t\t\t<span class="notification-option__text">Включены</span>\n\t\t\t\t\t\t\t<span class="notification-option__arrow"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon--ui__arrow-down icon--ui__arrow-down_settings"><use xlink:href="#icon--ui__arrow-down"></use></svg></span>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</section>\n\t\t</div>\n\n\t\t\x3c!-- Посты --\x3e\n\t\t<div class="section-group">\n\t\t\t<section class="section section_gray">\n\t\t\t\t<h4>Посты</h4>\n\t\t\t</section>\n\t\t\t<section class="section_padding_none settings-notifications__options">\n\t\t\t\t<div class="notification-option__wrapper" data-role="moderator_story_action">\n\t\t\t\t\t<div class="notification-option">\n\t\t\t\t\t\t<div class="notification-option__label">Модерация и поддержка</div>\n\t\t\t\t\t\t<div class="notification-option__action" data-option="moderator_story_action" data-disabled="bell">\n\t\t\t\t\t\t\t<input type="hidden" name="moderator_story_action" value="'+s(JSON.stringify(t.moderator_story_action))+'"/>\n\t\t\t\t\t\t\t<span class="notification-option__text">Включены</span>\n\t\t\t\t\t\t\t<span class="notification-option__arrow"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon--ui__arrow-down icon--ui__arrow-down_settings"><use xlink:href="#icon--ui__arrow-down"></use></svg></span>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t<div class="notification-option__wrapper" data-role="community_story_reject">\n\t\t\t\t\t<div class="notification-option">\n\t\t\t\t\t\t<div class="notification-option__label">Отклонение поста <br>с премодерации в сообществе</div>\n\t\t\t\t\t\t<div class="notification-option__action" data-option="community_story_reject" data-disabled="bell">\n\t\t\t\t\t\t\t<input type="hidden" name="community_story_reject" value="'+s(JSON.stringify(t.community_story_reject))+'">\n\t\t\t\t\t\t\t<span class="notification-option__text">Включены</span>\n\t\t\t\t\t\t\t<span class="notification-option__arrow"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon--ui__arrow-down icon--ui__arrow-down_settings"><use xlink:href="#icon--ui__arrow-down"></use></svg></span>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t<div class="notification-option__wrapper" data-role="interesting_stories">\n\t\t\t\t\t<div class="notification-option">\n\t\t\t\t\t\t<div class="notification-option__label">Интересные посты</div>\n\t\t\t\t\t\t<div class="notification-option__action" data-option="interesting_stories">\n\t\t\t\t\t\t\t<input type="hidden" name="interesting_stories" value="'+s(JSON.stringify(t.interesting_stories))+'">\n\t\t\t\t\t\t\t<span class="notification-option__text">Включены</span>\n\t\t\t\t\t\t\t<span class="notification-option__arrow"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon--ui__arrow-down icon--ui__arrow-down_settings"><use xlink:href="#icon--ui__arrow-down"></use></svg></span>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t<div class="notification-option__wrapper" data-role="community_story_move">\n\t\t\t\t\t<div class="notification-option">\n\t\t\t\t\t\t<div class="notification-option__label">Перемещение поста в сообщество</div>\n\t\t\t\t\t\t<div class="notification-option__action" data-option="community_story_move">\n\t\t\t\t\t\t\t<input type="hidden" name="community_story_move" value="'+s(JSON.stringify(t.community_story_move))+'">\n\t\t\t\t\t\t\t<span class="notification-option__text">Включены</span>\n\t\t\t\t\t\t\t<span class="notification-option__arrow"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon--ui__arrow-down icon--ui__arrow-down_settings"><use xlink:href="#icon--ui__arrow-down"></use></svg></span>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t<div class="notification-option__wrapper" data-role="story_in_hot">\n\t\t\t\t\t<div class="notification-option">\n\t\t\t\t\t\t<div class="notification-option__label">Выход поста в горячее</div>\n\t\t\t\t\t\t<div class="notification-option__action" data-option="story_in_hot">\n\t\t\t\t\t\t\t<input type="hidden" name="story_in_hot" value="'+s(JSON.stringify(t.story_in_hot))+'">\n\t\t\t\t\t\t\t<span class="notification-option__text">Включены</span>\n\t\t\t\t\t\t\t<span class="notification-option__arrow"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon--ui__arrow-down icon--ui__arrow-down_settings"><use xlink:href="#icon--ui__arrow-down"></use></svg></span>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t<div class="notification-option__wrapper" data-role="story_social_publish">\n\t\t\t\t\t<div class="notification-option">\n\t\t\t\t\t\t<div class="notification-option__label">Публикация поста в соцсетях Пикабу</div>\n\t\t\t\t\t\t<div class="notification-option__action" data-option="story_social_publish">\n\t\t\t\t\t\t\t<input type="hidden" name="story_social_publish" value="'+s(JSON.stringify(t.story_social_publish))+'">\n\t\t\t\t\t\t\t<span class="notification-option__text">Включены</span>\n\t\t\t\t\t\t\t<span class="notification-option__arrow"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon--ui__arrow-down icon--ui__arrow-down_settings"><use xlink:href="#icon--ui__arrow-down"></use></svg></span>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</section>\n\t\t</div>\n\n\t\t\x3c!-- Комментарии --\x3e\n\t\t<div class="section-group">\n\t\t\t<section class="section section_gray">\n\t\t\t\t<h4>Комментарии</h4>\n\t\t\t</section>\n\t\t\t<section class="section_padding_none settings-notifications__options">\n\t\t\t\t<div class="notification-option__wrapper" data-role="story_reply">\n\t\t\t\t\t<div class="notification-option">\n\t\t\t\t\t\t<div class="notification-option__label">Ответы на посты</div>\n\t\t\t\t\t\t<div class="notification-option__action" data-option="story_reply">\n\t\t\t\t\t\t\t<input type="hidden" name="comment_incoming" value="'+s(JSON.stringify(t.story_reply))+'">\n\t\t\t\t\t\t\t<span class="notification-option__text">Включены</span>\n\t\t\t\t\t\t\t<span class="notification-option__arrow"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon--ui__arrow-down icon--ui__arrow-down_settings"><use xlink:href="#icon--ui__arrow-down"></use></svg></span>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t<div class="notification-option__wrapper" data-role="comment_incoming">\n\t\t\t\t\t<div class="notification-option">\n\t\t\t\t\t\t<div class="notification-option__label">Ответы на комментарии</div>\n\t\t\t\t\t\t<div class="notification-option__action" data-option="comment_incoming">\n\t\t\t\t\t\t\t<input type="hidden" name="comment_incoming" value="'+s(JSON.stringify(t.comment_incoming))+'">\n\t\t\t\t\t\t\t<span class="notification-option__text">Включены</span>\n\t\t\t\t\t\t\t<span class="notification-option__arrow"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon--ui__arrow-down icon--ui__arrow-down_settings"><use xlink:href="#icon--ui__arrow-down"></use></svg></span>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t<div class="notification-option__wrapper" data-role="comment_mention">\n\t\t\t\t\t<div class="notification-option">\n\t\t\t\t\t\t<div class="notification-option__label">Упоминания вас</div>\n\t\t\t\t\t\t<div class="notification-option__action" data-option="comment_mention">\n\t\t\t\t\t\t\t<input type="hidden" name="comment_mention" value="'+s(JSON.stringify(t.comment_mention))+'">\n\t\t\t\t\t\t\t<span class="notification-option__text">Включены</span>\n\t\t\t\t\t\t\t<span class="notification-option__arrow"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon--ui__arrow-down icon--ui__arrow-down_settings"><use xlink:href="#icon--ui__arrow-down"></use></svg></span>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</section>\n\t\t</div>\n\n\t\t\x3c!-- Теги --\x3e\n\t\t<div class="section-group">\n\t\t\t<section class="section section_gray">\n\t\t\t\t<h4>Теги</h4>\n\t\t\t</section>\n\t\t\t<section class="section_padding_none settings-notifications__options">\n\t\t\t\t<div class="notification-option__wrapper" data-role="tag_edit">\n\t\t\t\t\t<div class="notification-option">\n\t\t\t\t\t\t<div class="notification-option__label">Редактирование тегов</div>\n\t\t\t\t\t\t<div class="notification-option__action" data-option="tag_edit">\n\t\t\t\t\t\t\t<input type="hidden" name="tag_edit" value="'+s(JSON.stringify(t.tag_edit))+'">\n\t\t\t\t\t\t\t<span class="notification-option__text">Включены</span>\n\t\t\t\t\t\t\t<span class="notification-option__arrow"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon--ui__arrow-down icon--ui__arrow-down_settings"><use xlink:href="#icon--ui__arrow-down"></use></svg></span>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</section>\n\t\t</div>\n\n\t\t\x3c!-- Сообщества --\x3e\n\t\t<div class="section-group">\n\t\t\t<section class="section section_gray">\n\t\t\t\t<h4>Сообщества</h4>\n\t\t\t</section>\n\t\t\t<section class="section_padding_none settings-notifications__options">\n\t\t\t\t<div class="notification-option__wrapper" data-role="community_manage">\n\t\t\t\t\t<div class="notification-option">\n\t\t\t\t\t\t<div class="notification-option__label">Управление сообществами</div>\n\t\t\t\t\t\t<div class="notification-option__action" data-option="community_manage" data-disabled="bell">\n\t\t\t\t\t\t\t<input type="hidden" name="community_manage" value="'+s(JSON.stringify(t.community_manage))+'">\n\t\t\t\t\t\t\t<span class="notification-option__text">Включены</span>\n\t\t\t\t\t\t\t<span class="notification-option__arrow"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon--ui__arrow-down icon--ui__arrow-down_settings"><use xlink:href="#icon--ui__arrow-down"></use></svg></span>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\n\t\t\t\t<div class="notification-option__wrapper" data-role="interesting_communities">\n\t\t\t\t\t<div class="notification-option">\n\t\t\t\t\t\t<div class="notification-option__label">Интересные сообщества</div>\n\t\t\t\t\t\t<div class="notification-option__action" data-option="interesting_communities">\n\t\t\t\t\t\t\t<input type="hidden" name="interesting_communities" value="'+s(JSON.stringify(t.interesting_communities))+'">\n\t\t\t\t\t\t\t<span class="notification-option__text">Включены</span>\n\t\t\t\t\t\t\t<span class="notification-option__arrow"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon--ui__arrow-down icon--ui__arrow-down_settings"><use xlink:href="#icon--ui__arrow-down"></use></svg></span>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</section>\n\t\t</div>\n\n\t\t\x3c!-- Другое --\x3e\n\t\t<div class="section-group">\n\t\t\t<section class="section section_gray">\n\t\t\t\t<h4>Другое</h4>\n\t\t\t</section>\n\t\t\t<section class="section_padding_none settings-notifications__options">\n\t\t\t\t<div class="notification-option__wrapper" data-role="pikabu_news">\n\t\t\t\t\t<div class="notification-option">\n\t\t\t\t\t\t<div class="notification-option__label">Новости Пикабу</div>\n\t\t\t\t\t\t<div class="notification-option__action" data-option="pikabu_news" data-disabled="bell">\n\t\t\t\t\t\t\t<input type="hidden" name="pikabu_news" value="'+s(JSON.stringify(t.pikabu_news))+'">\n\t\t\t\t\t\t\t<span class="notification-option__text">Включены</span>\n\t\t\t\t\t\t\t<span class="notification-option__arrow"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon--ui__arrow-down icon--ui__arrow-down_settings"><use xlink:href="#icon--ui__arrow-down"></use></svg></span>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t<div class="notification-option__wrapper" data-role="interesting_events">\n\t\t\t\t\t<div class="notification-option">\n\t\t\t\t\t\t<div class="notification-option__label">Интересные события на Пикабу</div>\n\t\t\t\t\t\t<div class="notification-option__action" data-option="interesting_events">\n\t\t\t\t\t\t\t<input type="hidden" name="interesting_events" value="'+s(JSON.stringify(t.interesting_events))+'">\n\t\t\t\t\t\t\t<span class="notification-option__text">Включены</span>\n\t\t\t\t\t\t\t<span class="notification-option__arrow"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon--ui__arrow-down icon--ui__arrow-down_settings"><use xlink:href="#icon--ui__arrow-down"></use></svg></span>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t\x3c!-- @exp(gamification_20220217) --\x3e\n\t\t\t\t',t.showAchievements&&(e+='\n\t\t\t\t\t<div class="notification-option__wrapper" data-role="achievements">\n\t\t\t\t\t\t<div class="notification-option">\n\t\t\t\t\t\t\t<div class="notification-option__label">Достижения</div>\n\t\t\t\t\t\t\t<div class="notification-option__action" data-option="achievements">\n\t\t\t\t\t\t\t\t<input type="hidden" name="achievements" value="'+s(JSON.stringify(t.achievements))+'">\n\t\t\t\t\t\t\t\t<span class="notification-option__text">Включены</span>\n\t\t\t\t\t\t\t\t<span class="notification-option__arrow"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon--ui__arrow-down icon--ui__arrow-down_settings"><use xlink:href="#icon--ui__arrow-down"></use></svg></span>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t'),e+="\n\t\t\t</section>\n\t\t</div>\n\t</form>\n</div>"}(t)),this._actions=new Map,this._defaultValues={},this.$els={options:this.$(".notification-option__action")},this.$els.options.each(((t,e)=>{let s=Ln(e),i=s.data("option"),n=s.find("input"),o=s.find(".notification-option__text");n.length&&o.length&&this._actions.set(i,{input:n,title:o}),s.on("click",(()=>this._initOptionPopup(s)))})),this._settings=new qi.Lo(this._currentFormOptions),this._settings.save("saved"),this._actions.forEach(((t,e)=>{this._changeOptionTitle(e),this._defaultValues[e]={bell:!0,push:!0}})),this}get _currentFormOptions(){return Fn.defaults(this._serializeForm(),this._defaultValues)}_serializeForm(){let t={};return this._actions.forEach(((e,s)=>t[s]=JSON.parse(e.input.val()))),t}async _saveSettings(){if(this._isSaved)return void(this.state=Li.GOOD);await u.User.saveSettings({action:"save_notification_settings",payload:JSON.stringify(this._settings.plainData)})?(this.state=Li.GOOD,this._settings.save("saved")):this.state=Li.BAD}_changeOptionTitle(t){let e=this._settings.plainData[t],s=this._actions.get(t).title;if(new Set(Object.values(e)).size<=1)return void s.text(i.ZP.i18n("page-settings.notifications.flags."+(Object.values(e)[0]?"on":"off")));let n=Object.entries(e).filter((t=>!0===t[1])).map((t=>i.ZP.i18n(`page-settings.notifications.flags.${t[0]}`)));s.text(n.join(","))}_initOptionPopup(t){let e=t.data("option"),s=t.data("disabled"),i=this._settings.plainData[e]||[],n=this.marks.get(`${e}-popup`);n||(n=pt.g.popupCheckboxes({target:t,enumEntries:Ui,localePrefix:"page-settings.notifications.flags.",currentValues:i,disabledOptions:s}),this.listenTo(n,"change",(async(t,s)=>{this._actions.get(e).input.val(JSON.stringify(s)),this._onChangeGeneral(),this._changeOptionTitle(e)}))),this.marks.set(`${e}-popup`,n),n.toggle()}}var jn=s(9050);var Vn=s(9050);var Hn=s(9050);var qn=s(9050);const Wn=s(6419);class Gn extends Fs.T3{reloadList(){this._list&&(this._list.clear(),this._page=0,this._hasMore=!0,this.loadMore())}attachHandlers(){this.listenTo(i.vE.ui,"document-scroll",Wn.throttle((()=>this.handleScrolling()),200)),this.listenTo(this._form,"submit",(t=>this.handleSearch(t))),this.listenTo(i.vE,we.AJ.STORIES,this.reloadList.bind(this)),this.listenTo(i.vE,we.AJ.COMMENTS,this.reloadList.bind(this))}handleScrolling(){this._hasMore&&!this._list.loading&&this._list.elementWillSoonScrolled&&this.loadMore()}handleSearch(t){t.preventDefault();let e=this._searchInput.value;""===e?i.vE.history.searchParams.delete("q"):i.vE.history.searchParams.set("q",e);let s=i.vE.history.searchParams.toString(),n=s?"?"+s:"";i.vE.history.pushUrl(i.vE.history.location.pathname+n,!0)}}const Yn=s(9755),zn=s(6419);class Zn extends n.u1{constructor(t){super(t),this.render()}render(){if(this.isRendered)return;const{usersListTemplate:t}=this.useRegistry();this._selectors={listItem:".ignored-user",blink:".ignored-user_blink",tool:".ignored-user__tool"};let e=t=>this.$(`.ignore-users-list__${t}`);this.$el.append(t()),this.$els={list:e("list").hide(),header:e("header"),spinner:e("spinner"),count:e("count"),empty:e("empty")},this.$els.empty.text(i.vE.i18n("page-ignore-list.empty.users")).hide(),this._users=[],this._spinner=i.vE.ui.player.createAnimation("stories-spinner",{$parent:this.$els.spinner}),this._attachActions()}add(t,e=!1){const{userTemplate:s}=this.useRegistry();return t=zn.isArray(t)?t:[t],this.$els.list[e?"prepend":"append"](Yn(t.map(s).join(""))),this._users=e?this._users.concat(t):t.concat(this._users),this}remove(t){let e=this.$els.list.find(this._selectors.listItem+`[data-id="${t}"]`);return this._animateUpdate(e).then((()=>e.remove())),this._users=this._users.filter((e=>Number(e.id)!==t)),this}clear(){this._users=[]}async toggleLoading(t){t=Boolean(t),this.loading!==t&&(t?(this._options.animationStart=Date.now(),this.$els.empty.hide(),this.$els.header.toggle(this.hasUsers)):this._options.animationStart&&(await c.cQ.delay(500-(Date.now()-this._options.animationStart)),this.$els.header.show()),this.loading=t,this._spinner.togglePlay(t))}async _animateUpdate(t){let e=this._selectors.blink.substring(1);t.addClass(e),await c.cQ.delay(200),t.removeClass(e)}_onChange(){this.$els.empty.toggle(!this.hasUsers),this.$els.list.toggle(this.hasUsers),!this.hasUsers&&this.$els.list.empty()}_attachActions(){[{name:"delete",handler:this._handleDelete}].forEach((t=>{this.$el.on("click",this._selectors.tool+`[data-action="${t.name}"]`,zn.debounce(t.handler.bind(this),200))}))}async _handleDelete(t){let e=Yn(t.currentTarget).closest(this._selectors.listItem).data("id");if(e)try{await we.jj.removeCommentsIgnore(e)&&this.remove(e)}catch(s){i.vE.ui.toasts.showError(s)}}get _users(){return this._options.users}set _users(t){this._options.users=t,this._onChange()}get users(){return this._users}get hasUsers(){return this._users.length>0}get elementWillSoonScrolled(){return i.vE.ui.elementWillSoonScrolled(this.$els.list[0])}}const Kn=s(9755);s(6419);class Xn extends Gn{route(t,e){this.ctx=t;let s=i.vE.history.searchParams.get("q")||null,n=s!==this.query;return this.query=s,n&&this.reloadList(),this.isShown||this.show(),e()}render(){if(this.isRendered)return this;const{Sanitizers:t,UIForm:e,UIInput:s,pageCommentsTemplate:i}=this.useRegistry();let n=t=>this.$(`.ignore-comments__${t}`);return this.$parent=Kn(".ignore-settings"),this.$el=Kn(i()),this.$els={container:n("container"),categories:n("categories"),form:n("form"),searchInput:this.$('.input[data-role="search"]')},this._list=new Zn(this.$els.container),this._form=new e(this.$els.form),this._searchInput=new s({$el:this.$els.searchInput,sanitizerRules:[t.trim(),t.singleSpace()]}),this._form.add(this._searchInput),this.attachHandlers(),this.loadMore(),super.render(),this}async loadMore(){if(this._loading)return;this._loading=!0,await this._list.toggleLoading(!0);let t=this._page+1||1,{total:e,users:s}=await we.jj.getCommentsIgnoreRules({page:t,search:this.query||void 0});this._page=t,this._hasMore=this._list.users.length<e,await this._list.toggleLoading(!1),this._list.add(s),this._initAnalytics(),this._loading=!1}_initAnalytics(){this.$els.container.find(".user").off("click.analytics auxclick.analytics").on("click.analytics auxclick.analytics",(t=>{0!==t.button&&1!==t.button||d.c.getInstance().sendEvent("transition_to_author",{type:"from_ignore",author_id:Di(t.currentTarget)})}))}}const Qn=s(9755),Jn=s(6419);class to extends n.u1{constructor(t){super(t),this.setOptions({reload:t.reload}),this.render()}render(){if(this.isRendered)return;const{rulesListTemplate:t}=this.useRegistry();this._selectors={rule:".ignore-rule",blink:".ignore-rule_blink",tool:".ignore-rule__tool"};const e=t=>this.$(`.ignore-rules-list__${t}`);this.$el.append(t()),this.$els={list:e("list"),header:e("header"),spinner:e("spinner"),total:e("total"),add:e("add"),empty:e("empty")},this.$els.add.text(i.vE.i18n("page-ignore-list.button.add")).on("click",this._handleCreate.bind(this)),this.$els.empty.text(i.vE.i18n("page-ignore-list.empty.stories")).hide(),this._rules=[],this._popup=void 0,this._spinner=i.vE.ui.player.createAnimation("stories-spinner",{$parent:this.$els.spinner}),this._attachActions()}add(t,e=!1){return t=Jn.isArray(t)?t:[t],this.$els.list[e?"prepend":"append"](Qn(t.map((t=>this._renderRule(t))).join(""))),this._rules=e?this._rules.concat(t):t.concat(this._rules),this}remove(t){let e=this.$els.list.find(this._selectors.rule+`[data-id="${t}"]`);return this._animateUpdate(e).then((()=>e.remove())),this._rules=this._rules.filter((e=>Number(e.id)!==t)),this.total=this.total-1,this}update(t){let e=Jn.findIndex(this._rules,(e=>Number(e.id)===Number(t.id)));if(e<0)return this;this._rules[e]=t;let s=this.$els.list.find(this._selectors.rule+`[data-id="${t.id}"]`);return this._animateUpdate(s).then((()=>{s.replaceWith(Qn(this._renderRule(t)))})),this}clear(){this._rules=[]}reload(){this._options.reload?this._options.reload():i.vE.logger.error("нужно передать обработчик перезагрузки списка!")}async toggleLoading(t){(t=Boolean(t))?(this._options.animationStart=Date.now(),this.$els.empty.hide(),this.$els.total.hide()):this._options.animationStart&&await c.cQ.delay(500-(Date.now()-this._options.animationStart)),this.loading=t,this._spinner.togglePlay(t)}async _animateUpdate(t){let e=this._selectors.blink.substring(1);t.addClass(e),await c.cQ.delay(200),t.removeClass(e)}_onChange(){!this.hasRules&&this.$els.list.empty(),this.$els.empty.toggle(!this.hasRules),this.$els.total.toggle(this.hasRules),this.$els.list.toggle(this.hasRules)}_renderRule(t){const{ruleTemplate:e}=this.useRegistry(),s=t.valid_until,{dateEnds:i,daysUntil:n}=c.cQ.timestampToDaysUntil(s);return e(Jn.extend(t,{dateEnds:i,daysUntil:n}))}_attachActions(){[{name:"update",handler:this._handleEdit},{name:"delete",handler:this._handleDelete}].forEach((t=>{this.$el.on("click",this._selectors.tool+`[data-action="${t.name}"]`,Jn.debounce(t.handler.bind(this),200))}))}async _handleEdit(t){const{UIIgnoreRulePopup:e}=this.useRegistry();let s=Qn(t.currentTarget).closest(this._selectors.rule).data("id");if(!s)return;let i=Jn.find(this._rules,(t=>Number(t.id)===Number(s)));this._popup=new e({ignoreRule:i,updateRule:!0});let{result:n}=await this._popup.show().ready();n&&this.update(n)}async _handleDelete(t){let e=Qn(t.currentTarget).closest(this._selectors.rule).data("id");if(e)try{await we.jj.removeRule(e)&&this.remove(e)}catch(s){i.vE.logger.error("ignore",s.message)}}async _handleCreate(){const{UIIgnoreRulePopup:t}=this.useRegistry();this._popup=new t;let{result:e}=await this._popup.show().ready();e&&this.reload()}get _rules(){return this._options.rules}set _rules(t){this._options.rules=t,this._onChange()}get rules(){return this._rules}get hasRules(){return this._rules.length>0}get total(){return this._options.total}set total(t){let e=t?`${t} ${i.vE.i18n("plural.records",t)}`:"";this.$els.total.text(e),this._options.total=t}get elementWillSoonScrolled(){return i.vE.ui.elementWillSoonScrolled(this.$els.list[0])}}const eo=s(9755),so=s(6419);class io extends Gn{route(t,e){this.ctx=t;let s=t.params.category||null,n=i.vE.history.searchParams.get("q")||null,o=s!==this.category||n!==this.query;return this.category=s,this.query=n,this._updateCategoriesMenu(),o&&this.reloadList(),this.isShown||this.show(),e()}render(){if(this.isRendered)return this;const{Sanitizers:t,UIForm:e,UIInput:s,pageStoriesTemplate:i}=this.useRegistry();let n=t=>this.$(`.ignore-stories__${t}`);return this.$parent=eo(".ignore-settings"),this.$el=eo(i()),this.$els={container:n("container"),categories:n("categories"),form:n("form"),searchInput:this.$('.input[data-role="search"]')},this._list=new to({$el:this.$els.container,reload:this.reloadList.bind(this)}),this._form=new e(this.$els.form),this._searchInput=new s({$el:this.$els.searchInput,sanitizerRules:[t.trim(),t.singleSpace()]}),this._form.add(this._searchInput),this._updateCategoriesMenu(),this.attachHandlers(),this.loadMore(),super.render(),this}hide(){return super.hide(),this._form.reset(),this}_updateCategoriesMenu(){let t=this.category||we.BF.ALL.valueOf();this.$els.categories&&this.$els.categories.find(".menu__item_route").removeClass("menu__item_current").filter(`[data-category="${t}"]`).addClass("menu__item_current")}async loadMore(){this._loading=!0;try{let t=this._lastRequestId=so.uniqueId("ignore-rules_");await this._list.toggleLoading(!0);let e=this._page+1||1,{total:s,rules:i}=await we.jj.getIgnoreRules({page:e,search:this.query||void 0,type:this.category?we.BF[this.category.toUpperCase()+"_CONVOLUTED"]:void 0});if(this._page=e,await this._list.toggleLoading(!1),t!==this._lastRequestId)return void(await this._list.toggleLoading(!0));this._list.total=s,this._list.add(i),this._initAnalytics(),this._hasMore=this._list.rules.length<s}catch(t){i.vE.ui.toasts.showError(t)}this._loading=!1}_initAnalytics(){this.$els.container.find(".ignore-rule__item_user").off("click.analytics auxclick.analytics").on("click.analytics auxclick.analytics",(t=>{0!==t.button&&1!==t.button||d.c.getInstance().sendEvent("transition_to_author",{type:"from_ignore","author_id!empty":Number(t.currentTarget.dataset.id)})})),this.$els.container.find(".ignore-rule__item_tag").off("click.analytics auxclick.analytics").on("click.analytics auxclick.analytics",(t=>{0!==t.button&&1!==t.button||d.c.getInstance().sendEvent("transition_to_tag",{type:"from_ignore",tag_id:t.currentTarget.textContent.trim()})})),this.$els.container.find(".ignore-rule__item_community").off("click.analytics auxclick.analytics").on("click.analytics auxclick.analytics",(t=>{0!==t.button&&1!==t.button||d.c.getInstance().sendEvent("transition_to_community",{type:"from_ignore","community_id!empty":Number(t.currentTarget.dataset.id)})}))}}const no=s(9755);class oo extends Fs.GR{onMatch(t,e){super.onMatch(t,e)}constructor(t){super(t),this.use({"/ignore-list":this,"/ignore-list/:category(tags|users|communities|keywords)?":io,"/ignore-list/comments":Xn})}render(){return this.isRendered||(this.$el=no(".ignore-settings"),this.$('div[data-role="spinner"]').hide(),i.vE.ui.screen=lt.d.USER_IGNORE_LIST,Ii.SR.getInstance().init("ignore_list_visit"),super.render()),this}}Ze.S.getInstance().fillLocal(io,{pageStoriesTemplate:function(t){var e="",i=jn.escape;Array.prototype.join;const n=s(8211).vE;return e+='\n<div class="ignore-stories">\n\t<form class="section-group ignore-stories__form" method="POST" action="javascript:void 0;" novalidate>\n\t\t<section class="input input_box input_section" data-role="search">\n\t\t\t<span class="input__icon"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon--ui__search icon--ui__search_input"><use xlink:href="#icon--ui__search"></use></svg></span>\n\t\t\t<span class="input__box">\n\t\t\t\t<input class="input__input" placeholder="'+i(n.i18n("page-ignore-list.placeholders.posts"))+'" autocomplete="off" name="search" value="">\n\t\t\t</span>\n\t\t\t<button class="button button_success">Поиск</button>\n\t\t</section>\n\t\t<section class="section_gray ignore-stories__categories">\n\t\t\t',[{route:"",name:"all"},{route:"/tags",name:"tags"},{route:"/users",name:"users"},{route:"/communities",name:"communities"},{route:"/keywords",name:"keywords"}].forEach((function(t){e+='\n\t\t\t\t<a href="/ignore-list'+i(t.route)+'" data-category="'+i(t.name)+'" class="button button_small menu__item_route">\n\t\t\t\t\t'+i(n.i18n("page-ignore-list.categories."+t.name))+"\n\t\t\t\t</a>\n\t\t\t"})),e+='\n\t\t</section>\n\t</form>\n\n\t<div class="ignore-stories__container"></div>\n</div>\n'}}).fillLocal(Xn,{pageCommentsTemplate:function(t){var e="",i=Vn.escape;Array.prototype.join;const n=s(8211).vE;return e+='\n<div class="ignore-comments">\n\t<form class="section-group ignore-comments__form" method="POST" action="javascript:void 0;" novalidate>\n\t\t<section class="input input_box input_section" data-role="search">\n\t\t\t<span class="input__icon"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon--ui__search icon--ui__search_input"><use xlink:href="#icon--ui__search"></use></svg></span>\n\t\t\t<span class="input__box">\n\t\t\t\t<input class="input__input" placeholder="'+i(n.i18n("page-ignore-list.placeholders.comments"))+'" autocomplete="off" name="search" value="">\n\t\t\t</span>\n\t\t\t<button class="button button_success">Поиск</button>\n\t\t</section>\n\t</form>\n\n\t<div class="ignore-comments__container"></div>\n</div>\n'}}).fillLocal(to,{rulesListTemplate:function(t){return'<div class="section-group">\n\t<section class="ignore-rules-list__header section_gray">\n\t\t<strong class="ignore-rules-list__total"></strong>\n\t\t<button class="ignore-rules-list__add button_success button_small"></button>\n\t</section>\n\t<section class="ignore-rules-list__list-container">\n\t\t<div class="ignore-rules-list__list"></div>\n\t\t<div class="ignore-rules-list__spinner"></div>\n\t\t<div class="ignore-rules-list__empty"></div>\n\t</section>\n</div>\n\n\n','<div class="section-group">\n\t<section class="ignore-rules-list__header section_gray">\n\t\t<strong class="ignore-rules-list__total"></strong>\n\t\t<button class="ignore-rules-list__add button_success button_small"></button>\n\t</section>\n\t<section class="ignore-rules-list__list-container">\n\t\t<div class="ignore-rules-list__list"></div>\n\t\t<div class="ignore-rules-list__spinner"></div>\n\t\t<div class="ignore-rules-list__empty"></div>\n\t</section>\n</div>\n\n\n'},ruleTemplate:function(t){var e="",i=qn.escape;Array.prototype.join;const n=s(8211).vE;return e+='\n\n<div class="ignore-rule" data-id="'+i(t.id)+'">\n\t<div class="ignore-rule__content">\n\t\t',t.keywords&&(e+="\n\t\t\t",t.keywords.forEach((function(t){e+='\n\t\t\t\t<div class="ignore-rule__wrapper">\n\t\t\t\t\t<svg xmlns="http://www.w3.org/2000/svg" class="icon icon--ui__plus"><use xlink:href="#icon--ui__plus"></use></svg>\n\t\t\t\t\t<span class="ignore-rule__item ignore-rule__item_keyword">'+i(t)+"</span>\n\t\t\t\t</div>\n\t\t\t"})),e+="\n\t\t"),e+="\n\n\t\t",t.tags&&(e+="\n\t\t\t",t.tags.forEach((function(t){e+='\n\t\t\t\t<div class="ignore-rule__wrapper">\n\t\t\t\t\t<svg xmlns="http://www.w3.org/2000/svg" class="icon icon--ui__plus"><use xlink:href="#icon--ui__plus"></use></svg>\n\t\t\t\t\t<a href="'+i("/tag/"+encodeURIComponent(t))+'" rel="noopener" target="_blank"\n\t\t\t\t\t   class="ignore-rule__item ignore-rule__item_tag">'+i(t)+"</a>\n\t\t\t\t</div>\n\t\t\t"})),e+="\n\t\t"),e+="\n\n\t\t",t.communities&&(e+="\n\t\t\t",t.communities.forEach((function(t){e+='\n\t\t\t\t<div class="ignore-rule__wrapper">\n\t\t\t\t\t<svg xmlns="http://www.w3.org/2000/svg" class="icon icon--ui__plus"><use xlink:href="#icon--ui__plus"></use></svg>\n\t\t\t\t\t<a href="/community/'+i(t.slug)+'" data-id="'+i(t.id)+'" class="ignore-rule__item ignore-rule__item_community">\n\t\t\t\t\t\t<span class="community-avatar community-avatar_small">\n\t\t\t\t\t\t\t',t.avatar?e+='\n\t\t\t\t\t\t\t\t<img src="'+i(t.avatar)+'" alt="'+i(t.name)+'" />\n\t\t\t\t\t\t\t':e+='\n\t\t\t\t\t\t\t\t<span class="community-avatar__default"></span>\n\t\t\t\t\t\t\t',e+='\n\t\t\t\t\t\t</span>\n\t\t\t\t\t\t<span class="community__title">'+i(t.name)+"</span>\n\t\t\t\t\t</a>\n\t\t\t\t</div>\n\t\t\t"})),e+="\n\t\t"),e+="\n\n\t\t",t.authors&&(e+="\n\t\t\t",t.authors.forEach((function(t){e+='\n\t\t\t\t<div class="ignore-rule__wrapper">\n\t\t\t\t\t<svg xmlns="http://www.w3.org/2000/svg" class="icon icon--ui__plus"><use xlink:href="#icon--ui__plus"></use></svg>\n\t\t\t\t\t<a href="/@'+i(t.name)+'" data-id="'+i(t.id)+'" class="ignore-rule__item ignore-rule__item_user user user_inline">\n\t\t\t\t\t\t<span class="avatar avatar_small">\n\t\t\t\t\t\t\t',t.avatar?e+='\n\t\t\t\t\t\t\t\t<img src="'+i(t.avatar)+'" alt="'+i(t.name)+'" />\n\t\t\t\t\t\t\t':e+='\n\t\t\t\t\t\t\t\t<span class="community-avatar__default"></span>\n\t\t\t\t\t\t\t',e+='\n\t\t\t\t\t\t</span>\n\t\t\t\t\t\t<span class="user__nick" data-profile="true">'+i(t.name)+"</span>\n\t\t\t\t\t</a>\n                    ",t.is_permabanned&&(e+='\n\t\t\t\t\t\t<span class="ignore-rule__ban-status hint" aria-label="'+i(n.i18n("users."+(t.ban_reason?"permabanned":"permabanned-without-reason"),t.ban_reason))+'">\n\t\t\t\t\t\t\t\t<svg xmlns="http://www.w3.org/2000/svg" class="icon icon--ui__ban icon--ui__ban_profile"><use xlink:href="#icon--ui__ban"></use></svg>\n\t\t\t\t\t\t</span>\n                    '),e+="\n\t\t\t\t</div>\n\t\t\t"})),e+="\n\t\t"),e+='\n\t</div>\n\n\t<div class="ignore-rule__controls">\n\t\t',t.dateEnds&&(e+='\n\t\t\t<div class="ignore-rule__days hint" aria-label="'+i(n.i18n("ignore.hints.date",t.dateEnds))+'">\n\t\t\t\t'+i(t.daysUntil)+" "+i(n.i18n("plural.days",t.daysUntil))+"\n\t\t\t</div>\n\t\t"),e+='\n\n\t\t<span class="ignore-rule__tool" data-action="update" aria-label="'+i(n.i18n("page-ignore-list.tools.edit"))+'">\n\t\t\t<svg xmlns="http://www.w3.org/2000/svg" class="icon icon--ui__pencil"><use xlink:href="#icon--ui__pencil"></use></svg>\n\t\t</span>\n\n\t\t<span class="ignore-rule__tool" data-action="delete" aria-label="'+i(n.i18n("page-ignore-list.tools.delete"))+'">\n\t\t\t<svg xmlns="http://www.w3.org/2000/svg" class="icon icon--ui__close"><use xlink:href="#icon--ui__close"></use></svg>\n\t\t</span>\n\t</div>\n</div>\n'}}).fillLocal(Zn,{usersListTemplate:function(t){return'<div class="section-group">\n\t<section class="ignore-users-list__list-container">\n\t\t<div class="ignore-users-list__list"></div>\n\t\t<div class="ignore-users-list__empty"></div>\n\t\t<div class="ignore-users-list__spinner"></div>\n\t</section>\n</div>\n\n','<div class="section-group">\n\t<section class="ignore-users-list__list-container">\n\t\t<div class="ignore-users-list__list"></div>\n\t\t<div class="ignore-users-list__empty"></div>\n\t\t<div class="ignore-users-list__spinner"></div>\n\t</section>\n</div>\n\n'},userTemplate:function(t){var e="",i=Hn.escape;Array.prototype.join;const n=s(8211).vE;return e+='\n\n<div class="ignored-user" data-id="'+i(t.id)+'">\n\t<button class="ignored-user__tool button_link" data-action="delete"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon--ui__close icon--ui__close_settings-list"><use xlink:href="#icon--ui__close"></use></svg></button>\n\t<div class="ignored-user__content">\n\t\t<a href="/@'+i(t.name)+'" class="user user_inline">\n\t\t\t<span class="avatar avatar_small">\n\t\t\t\t',t.avatar?(e+='\n\t\t\t\t\t<img src="'+i(t.avatar)+'" alt="',t.name,e+='"/>\n\t\t\t\t'):e+='\n\t\t\t\t\t<span class="avatar__default"/>\n\t\t\t\t',e+='\n\t\t\t</span>\n\t\t\t<span class="user__nick" data-profile="true">'+i(t.name)+"</span>\n\t\t</a>\n        ",t.is_permabanned&&(e+='\n            <span class="ignore-rule__ban-status hint" aria-label="'+i(n.i18n("users."+(t.ban_reason?"permabanned":"permabanned-without-reason"),t.ban_reason))+'">\n                \t<svg xmlns="http://www.w3.org/2000/svg" class="icon icon--ui__ban icon--ui__ban_profile"><use xlink:href="#icon--ui__ban"></use></svg>\n            </span>\n        '),e+="\n\t</div>\n</div>\n\n"}});const ro=s(9755),ao=s(6419),lo=s(381);class ho extends Fs.T3{render(){return this.isRendered||(this.$el=ro(".page-notifications"),this.$els={items:this.$(".notification"),time:this.$(".notification__datetime"),removeBtn:this.$('[data-role="remove"]').on("click",this._removeAllNotifications.bind(this)),spinner:this.$(".page-notifications__spinner").hide(),container:this.$(".page-notifications__container").show()},this._syncWithUserTimezone(),i.vE.ui.screen=lt.d.NOTIFICATIONS,super.render()),this}_syncWithUserTimezone(){ao.forEach(this.$els.time,(t=>{t.textContent=lo(t.getAttribute("datetime")).format("DD MMMM YYYY, HH:mm")}))}async _removeAllNotifications(){if(this.marks.has("request"))return;const{PopupMaster:t}=this.useRegistry();if(this.marks.set("request",!0),await t.confirmModal({content:"page-notifications.remove-all",buttons:[["modal.remove",Bs.j.DANGER,!0],["modal.cancel"]]}))try{await u.User.removeNotifications(),window.location.reload()}catch(e){i.vE.ui.toasts.showError(e),this.marks.delete("request")}else this.marks.delete("request")}}s(9755),s(6419);class co extends Fs.T3{}const uo=s(9755),po=s(6419),mo=[-10,0,25,100,250,500,1e3,2500];class _o extends me.W_{constructor(t){super(t),this.el&&this.show()}render(){return this.isRendered||(this.$els={container:this.$(".communities-feed__container"),message:this.$(".communities-feed__message"),spinner:this.$(".communities-feed__spinner"),addButton:this.$(".feed-panel .menu__item_button-success")},this.$els.spinner.length&&(this.animation=i.vE.ui.player.createAnimation("stories-spinner",{$parent:this.$els.spinner})),this.$els.addButton.on("click",(()=>{d.c.getInstance().sendEvent("click",{type:"community_create"})})),this.listenTo(i.vE.ui,"document-scroll",this._feedScrolling),this.$el.data("has-more")||(this.endOfFeed=!0),this.amount=this.$els.container.find(".community").length,super.render()),this}_feedScrolling(){i.vE.ui.elementWillSoonScrolled(this.el)&&this._loadCommunitiesThrottle()}_updateEndOfFeed(t){this.$els.message.toggle(t)}_updateLoadAnimation(t){this.$els.container.toggle(this.amount>0&&!t||this.amount>0),this.animation&&this.animation.togglePlay(t)}}const go=s(9755),vo=s(6419);class fo extends co{route(t,e){return this.ctx=t,this.state.update({sortMode:me.$z[t.params.sort]||me.$z.ACTUAL,type:me.WV[t.params.type]||me.WV.ALL,tag:t.params.tag,filterType:me.Av[i.vE.history.searchParams.get("t")]||me.Av.ALL,searchText:i.vE.history.searchParams.get("q")||""}),this.show(),e()}render(){var t;if(this.isRendered)return this;this.$el=go(".communities-feed"),this.$els={sortBlock:this.$(".communities-feed__filter"),sortOrder:this.$('.communities-feed__filter > span[data-role="sort"]').on("click",this._toggleSortMode.bind(this)),message:this.$(".communities-feed__message"),menu:this.$(".menu"),search:{section:this.$('section[data-role="filter"]'),input:this.$('.input[data-role="search"]'),form:this.$(".communities-feed__search")},tags:this.$(".stories-search__tags-group .stories-search__tags"),tagsGroup:this.$(".stories-search__tags-group"),tagsInput:this.$(".stories-search__tags-group input"),linkCommunityAdd:this.$(".button_community-add")},this.$els.search.form.length&&(this._form=new a.x(this.$els.search.form),this.listenTo(this._form,"submit",(t=>{t.preventDefault(),this.state.data.searchText=this._searchInput.value}))),this._prepareTagsControl();let e=this.$('.form-group[data-role="type"]');if(this.$els.search.type={group:e,items:e.find(".items-list__item").on("click",this._selectType.bind(this))},this._feed=new _o({$el:this.$el,params:this.state}),this.listenTo(this._feed,me.cP.PARSED,((t,e,s)=>{if(!s)return;let n=this.state.data.searchText.length>0||this.state.data.tag,o=this._feed.amount+e<=0,r=(n?"search-":"")+(o?"empty":"message");o&&this.state.data.type===me.WV.MINE&&(r="mine-empty"),this.$els.message.html(i.vE.i18n("communities.feed.eof."+r))})),this.$el.on("click",".tags__tag",(t=>{t.preventDefault(),i.vE.navigate(null,null,t.currentTarget.getAttribute("href"),!0)})),this.$els.search.input.length){this._searchInput=new T.u3({$el:this.$els.search.input,sanitizerRules:[T.op.trim()]});const t=()=>{this.$els.sortBlock.toggle(0===this._searchInput.value.length)};this.listenTo(this._searchInput,"input",t),this.listenTo(this._searchInput,"change",t),this._form.add(this._searchInput),t()}return i.vE.ui.screen=lt.d.COMMUNITIES,null===(t=this.$els.linkCommunityAdd[0])||void 0===t||t.addEventListener("click",(t=>{i.vE.isUserAuthorized||(t.preventDefault(),i.vE.ui.authRequired())})),this.$el.find(".community a.community-avatar, .community__title a").on("click auxclick",(t=>{0!==t.button&&1!==t.button||oe.cp.getInstance().sendEvent("transition_to_community",{type:"from_tab",community_id:Di(t.currentTarget)})})),super.render(),this}_syncComponent(t){if(!this.isShown)return;let e=t.diff("sync");if(!e.length)return;for(let a of e){let{property:t,value:e,type:o}=a;if("searchText"===t&&(this._searchInput.value=e),"tag"===t&&"set"===o){const t=this.$els.tags.find(".items-list__item_tag");t&&this.tagsList.removeItem(t),e&&(this.tagsList.addItem(e),this._tagGroup.toggleGroup(!0))}if("sortMode"===t&&this.$els.sortOrder.find("span:first-child").text(i.vE.i18n("communities.feed.sort-mode."+e.toString()).toLowerCase()),"type"===t){var s,n;if(e===me.WV.MINE)null===(s=this._tagGroup)||void 0===s||s.toggleGroup(!1),null===(n=this._typeGroup)||void 0===n||n.toggleGroup(!1);this.$els.menu.find(".menu__item_current").removeClass("menu__item_current"),this.$els.menu.find('a[href="/communities'+(e===me.WV.MINE?"/mine":"")+'"]').addClass("menu__item_current"),this.$els.search.section.toggle(e!==me.WV.MINE),i.vE.ui.screen=this.state.data.type===me.WV.MINE?lt.d.COMMUNITIES_MINE:lt.d.COMMUNITIES}"filterType"===t&&(e!==me.Av.ALL&&this._toggleTypeFilter(!0),this.$els.search.type.items.removeClass("items-list__item_selected").filter(`[data-value="${e.valueOf()}"]`).addClass("items-list__item_selected"))}t.save("sync");let o=this.state.plainData,r="/communities"+(o.type!==me.WV.ALL?`/${o.type.valueOf()}`:"")+(o.type===me.WV.TAG?"/"+(o.tag||""):"")+(o.sortMode!==me.$z.ACTUAL?"/"+o.sortMode.valueOf():"");o.filterType!==me.Av.ALL&&(r+=(r.includes("?")?"&":"?")+"t="+o.filterType.valueOf()),o.searchText.length&&(r+=(r.includes("?")?"&":"?")+"q="+encodeURIComponent(o.searchText)),i.vE.history.replaceState({},"",r,!1)}_prepareTagsControl(){this.tagsList=new Ss.EZ({$el:this.$els.tags,items:this.state.data.tag?[this.state.data.tag]:[],maxItems:1,addTagMenu:!1}),this.tagsList.on("change",(t=>{this.state.data.tag=t[0]})),this.$els.tagsInput.on("blur",(async()=>{this.tagsList.items.length||(await c.cQ.delay(100),this.$els.tagsInput.val(""))})),this._toggleTagFilter(this.tagsList.items.length>0)}_toggleTagFilter(t){this._tagGroup||(this._tagGroup=n.u1.getUIElement(this.$els.tagsGroup)),this._tagGroup.toggleGroup(Boolean(t))}_toggleTypeFilter(t){this._typeGroup||(this._typeGroup=n.u1.getUIElement(this.$els.search.type.group)),this._typeGroup.toggleGroup(Boolean(t))}_selectType(t){let e=go(t.target);this.state.data.filterType=me.Av[e.attr("data-value")]}_toggleSortMode(){let t=this.marks.get("sort-popup");t||(t=pt.g.popupEnum(this.$els.sortOrder,me.$z,"communities.feed.sort-mode",me.$z.ACTUAL),this.listenTo(t,"change",((e,s)=>{this.state.data.sortMode=s,t.hide()})),this.marks.set("sort-popup",t)),t.toggle()}get state(){let t=this._options.state;return t||(t=this._options.state=new qi.Lo({sortMode:void 0,type:void 0,tag:void 0,filterType:void 0,searchText:void 0}),this.listenTo(t,qi.u$.CHANGE,((t,e)=>{if("tag"in e){let e=t.data.tag,s=t.data.type;e&&s!==me.WV.TAG?t.update({type:me.WV.TAG},!0):e||s!==me.WV.TAG||t.update({type:me.WV.ALL},!0)}})),this.listenTo(t,qi.u$.CHANGE,vo.debounce(this._syncComponent.bind(this),20))),t}}var yo=s(1398);const bo=s(9755);class wo extends yo.Z{init(){var t,e;if(this.maxVisibleRows=null!==(t=this.maxVisibleRows)&&void 0!==t?t:1,this.oneRowHeight=null!==(e=this.oneRowHeight)&&void 0!==e?e:32,this.$els={wrapper:this.$(".community-top-tags__wrap"),list:this.$(".community-top-tags__list")},this._initAnalytics(),this._getRowsCount()<=this.maxVisibleRows)return this._hideSkeleton(),this;const s=this._findLastVisibleTag();if(!s)return this._hideSkeleton(),this;this._transformToButton(s),this._hideSkeleton()}_getRowsCount(){return Math.ceil(this.$els.list.height()/this.oneRowHeight)}_findLastVisibleTag(){const t=this.$els.wrapper.offset().top,e=[...this.$els.list.find(".community-top-tags__list-item")];for(let s=0;s<e.length;s++){if(bo(e[s]).offset().top-t>this.oneRowHeight*this.maxVisibleRows)return e[s-1]}return null}_hideSkeleton(){this.$el.removeClass("community-top-tags_skeleton")}_transformToButton(t){const e=t.firstElementChild,s=bo('<button class="community-top-tags__expand" title="Показать больше тегов"></button>'),i=s[0];s.css("margin-right",Math.ceil(bo(e).width())-16+"px"),s.on("click",(()=>{i.remove(),t.appendChild(e),this.$els.wrapper.css("height",this.$els.list.height()+"px").removeClass("community-top-tags__wrap_collapsed")})),e.remove(),t.appendChild(i)}_initAnalytics(){const t=this._options.communityId,e=oe.cp.getInstance();this.$els.list.on("click auxclick",".community-top-tags__list-link",(({currentTarget:s})=>{e.sendEvent("transition_to_tag",{type:"community_top_tags",tags:s.dataset.tag,community_id:t})}))}}class Eo extends wo{constructor(t){super(t),this.maxVisibleRows=1,this.oneRowHeight=32,this.init()}}var So=s(1370);const Co="accordion__item",To="accordion__item-header-icon",Oo="accordion__item_expanded";function ko(t,e){var s=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),s.push.apply(s,i)}return s}function Io(t){for(var e=1;e<arguments.length;e++){var s=null!=arguments[e]?arguments[e]:{};e%2?ko(Object(s),!0).forEach((function(e){$o(t,e,s[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(s)):ko(Object(s)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(s,e))}))}return t}function $o(t,e,s){return e in t?Object.defineProperty(t,e,{value:s,enumerable:!0,configurable:!0,writable:!0}):t[e]=s,t}const Ao={closeOthersOnChange:!1,toggleOnIconOnly:!1};class xo{constructor(t,e=Ao){if($o(this,"expandedItems",new Map),$o(this,"hideSection",((t,e)=>{const s=this.getContentHeight(t);e.classList.remove(Oo),s&&(t.style.height="0")})),$o(this,"showSection",((t,e)=>{const s=this.getContentHeight(t);e.classList.add(Oo),s&&(t.style.height=s)})),$o(this,"getContentHeight",(t=>{const e=t.firstElementChild;if(!(e instanceof HTMLElement))return null;const s=window.getComputedStyle(e),i=s.getPropertyValue("margin-top"),n=s.getPropertyValue("margin-bottom");try{return e.clientHeight+parseInt(i,10)+parseInt(n,10)+"px"}catch(o){return null}})),!t)throw new Error("No container element found");this.el=t,this.options=e===Ao?e:Io(Io({},Ao),e);const s=Array.from(this.el.querySelectorAll("."+Co));this.setListeners(s)}setListeners(t){for(const e of t){const t=e.firstElementChild,s=e.lastElementChild;if(e instanceof HTMLElement&&t instanceof HTMLElement&&s instanceof HTMLElement){if(e.classList.contains(Oo)){this.expandedItems.set(e,s);const t=this.getContentHeight(s);t&&(s.style.height=t)}t.addEventListener("click",this.onClickToggle({item:e,content:s}))}}}onClickToggle({item:t,content:e}){const{closeOthersOnChange:s,toggleOnIconOnly:i,stateId:n}=this.options;return({target:o})=>{const r=o instanceof HTMLElement&&o.classList.contains(To);if(i&&!r)return;const a=t.classList.contains(Oo);s&&(this.expandedItems.forEach(this.hideSection.bind(this)),this.expandedItems.clear()),a?s||this.hideSection(e,t):(this.showSection(e,t),s&&this.expandedItems.set(t,e)),n&&(new cs.U).set(n,a)}}getExpandedItems(){return this.expandedItems}}const Do="tabset__item-btn",Po="tabset__wrapper",Ro="tabset__item-btn_current";class Mo{constructor(t){if(!t)throw new Error("No container element found");this.el=t,this.tabWrapper=this.el.querySelector("."+Po);const e=Array.from(this.el.querySelectorAll("."+Do));this.setListeners(e)}setListeners(t){t.forEach(((t,e)=>{t instanceof HTMLButtonElement&&(t.classList.contains(Ro)&&(this.tabButtonCurrent=t),t.addEventListener("click",this.onClickToggle({tabWrapper:this.tabWrapper,btn:t,i:e})))}))}onClickToggle({tabWrapper:t,btn:e,i:s}){return()=>{var i;if(e===this.tabButtonCurrent)return;null===(i=this.tabButtonCurrent)||void 0===i||i.classList.remove(Ro),e.classList.add(Ro),this.tabButtonCurrent=e;const n=t.clientWidth;t.style.transform=`translateX(-${n*s}px)`}}}let No;!function(t){t[t.NONE=1]="NONE",t[t.COMMUNITY_STAT_TOOLTIP=1]="COMMUNITY_STAT_TOOLTIP",t[t.COMMUNITY_STAT_TOOLTIP_STEP1=2]="COMMUNITY_STAT_TOOLTIP_STEP1",t[t.COMMUNITY_STAT_TOOLTIP_STEP2=3]="COMMUNITY_STAT_TOOLTIP_STEP2",t[t.COMMUNITY_STAT_TOOLTIP_NEW_STEP2=4]="COMMUNITY_STAT_TOOLTIP_NEW_STEP2"}(No||(No={}));class Bo{static setInit(t){Bo.currentFlags=t}static get(){return Bo.currentFlags}static has(t){return(Bo.currentFlags&t)===t}static set(t,e){Bo.has(t)!==e&&(Bo.currentFlags=e?Bo.currentFlags|t:Bo.currentFlags&~t,S.cf.post("/ajax/user/property-change",{flag_number:t,value:Number(e)}))}}var Lo,Fo,Uo;Lo=Bo,Fo="currentFlags",Uo=No.NONE,Fo in Lo?Object.defineProperty(Lo,Fo,{value:Uo,enumerable:!0,configurable:!0,writable:!0}):Lo[Fo]=Uo;class jo{constructor(t){if(!(t instanceof HTMLElement))throw new Error("No container element found");const e=t.querySelector(".tabset");if(!(e instanceof HTMLElement))throw new Error("No tabset container element found");this.el=t,this.accordion=new xo(this.el,{stateId:"comStatsAccordionHidden"}),this.tabset=new Mo(e),this.initTooltips()}initTooltips(){const t=this.el.dataset.tooltip;if(!t)return;const[e,s]=JSON.parse(t),i=this.el.querySelector(".accordion__item-header-text");i instanceof HTMLElement&&(e?s||this.showTooltip2(i):this.showTooltip1(i))}async showTooltip1(t){const e=await(0,U.aM)({target:t,content:'\n\t\t\t<div class="popup__content-notification community-statistics__tooltip">\n\t\t\t\t<div class="community-statistics__tooltip-label">Статистика сообщества</div>\n\t\t\t\t<p class="community-statistics__tooltip-text">\n\t\t\t\t\tВ этом окне администраторы сообщества могут наблюдать динамику по основным показателям сообщества.\n\t\t\t\t\t<br>Этот блок видят только <strong>адмодеры</strong> — администрация вашего сообщества.\n\t\t\t\t</p>\n\t\t\t</div>\n\t\t',theme:r.xb.GREEN,overlapSidebars:!1,direction:r.Lh.BOTTOM,alignment:r.SE.CENTER,autoCloseIfTargetNotVisible:!0,autoCloseOutsideClick:!0,delay:500,delayClose:500,hideByScroll:!1,wrapperExtraClass:"com-value-hint"});So.v.userExperiments.admoders_stat_promo2_20220405?e.addCloseButtonIntoFooter("Далее"):e.addCloseButtonIntoFooter("Понятно!"),e.footer.find(".button").on("click",(()=>this.showTooltip2(t)))}async showTooltip2(t){if(!So.v.userExperiments.admoders_stat_promo2_20220405)return;const e=this.el.querySelector(".community-statistics__item_recommendations");if(!(e instanceof HTMLElement))return;if("false"===e.dataset.popup)return;this.accordion.getExpandedItems().size&&(t=e);(await(0,U.aM)({target:t,content:'\n\t\t\t<div class="popup__content-notification community-statistics__tooltip">\n\t\t\t\t<div class="community-statistics__tooltip-label">Рекомендации за посты</div>\n\t\t\t\t<p class="community-statistics__tooltip-text">\n\t\t\t\t\tТут вы можете увидеть влияние ваших постов на рекомендации сообщества.\n\t\t\t\t\tДобавляйте хотя бы один пост за неделю, чтобы попасть в рекомендации.<br>\n\t\t\t\t\tНа вкладке «Адмодеры» можно узнать, сколько подписчиков вы привлекли в сообщество\n\t\t\t\t\tс помощью ваших постов.\n\t\t\t\t</p>\n\t\t\t</div>\n\t\t',theme:r.xb.GREEN,overlapSidebars:!1,direction:r.Lh.TOP,alignment:r.SE.START,autoCloseIfTargetNotVisible:!0,autoCloseOutsideClick:!0,delay:500,delayClose:500,hideByScroll:!1,wrapperExtraClass:"com-value-hint"})).addCloseButtonIntoFooter("Понятно!"),Bo.set(No.COMMUNITY_STAT_TOOLTIP_NEW_STEP2,!0)}}class Vo extends Fs.T3{initQueueBox({container:t,StoriesFeed:e,SimilarStories:s}){const i=t.find(".community-stories-queue__button");new e({$el:t,feedName:"community-queue"}),i.on("click",(()=>{i.slideUp(200,(()=>i.remove())),t.find(".stories-feed__container").fadeIn(500)}));const n=t=>{var e;return null!==(e=ee()(t).closest(".community-queue-panel").attr("data-queue-id"))&&void 0!==e?e:""};ee()('.community-queue-panel__buttons button[data-role="allow"]').click((({target:t})=>{this.approveStory(n(t),me.dO.APPROVED)})),ee()('.community-queue-panel__buttons button[data-role="deny"]').click((({target:t})=>{this.approveStory(n(t),me.dO.REJECTED)})),ee()('.community-queue-panel__buttons button[data-role="cancel-community-change"]').click((({target:t})=>{this.approveStory(n(t),me.dO.MOVED_TO_COMMON_FEED)})),ee()(".community-queue-panel__buttons .community-queue-panel__cmp").click((({target:t})=>{this.showCompareResults(n(t),s)}))}async showCompareResults(t,e){const s=ee()(`.community-queue-panel[data-queue-id="${t}"] .community-queue-panel__similar-stories`);let n=this.marks.get(t);if(n)s.slideToggle();else{n=new e({$parent:s,type:Us.VQ.MANUAL,queueId:t}),this.marks.set(t,n),n.show(),n.state=Us.DX.WAIT;try{const e=await this.community.getComporatorResultForQueue(t);js.default.isObject(e)&&Object.keys(e).length?n.addSources(e):n.state=Us.DX.EMPTY}catch(o){i.vE.ui.toasts.showError(o)}s.slideDown()}}async approveStory(t,e){const s=ee()(`.community-queue-panel[data-queue-id="${t}"]`),n=s.find("button");if(s.attr("disabled","disabled"),n.attr("disabled","disabled"),e===me.dO.APPROVED){const t=xe.m.get(me.ob)||0;Date.now()-t<me.Qu&&oe.cp.getInstance().yandex.goal("community_fast-approve"),xe.m.set(me.ob,Date.now())}try{const o=await this.community.processStoryInQueue(t,e);this.toastApprove&&o.length&&(this.toastApprove.hide(),this.timeout("reopen",200,(()=>{this.toastApprove.content=o,this.toastApprove.show()}))),s.removeAttr("disabled"),n.removeAttr("disabled");const r=s.find(".community-queue-panel__message"),a=s.closest(".story"),l=r.find("a");let h,c=4;r.find("span").text(i.vE.i18n("page-community."+(e===me.dO.APPROVED?"approved":"disapproved")));const d=()=>{h&&clearTimeout(h),a.slideUp(400,(()=>a.remove()))},u=()=>{c--,c>=0&&(l.text(`закрыть (${c} сек)`),c>0?h=setTimeout(u,1e3):d())};l.click(d),u(),r.slideDown(400);const p=ee()('.bell[data-role="community"]');let m=Number(p.text()||"0");--m>0?p.text(String(m)):p.hide()}catch(o){s.removeAttr("disabled"),n.removeAttr("disabled"),o.message.length&&i.vE.ui.toasts.showError(o)}}}var Ho=s(9050);const qo=s(9755);class Wo extends Vo{render(){if(this.isRendered)return this;this.$el=qo(".community-header"),this._communityID=this._options.communityId=Number(this.$el.data("id"))||0,this._community=this._options.community=new me.S1(this._communityID),this._showSimilarCommunities(),this._isLocked=this._options.isLocked=1===Number(this.$el.data("locked")),super.render();const t=document.querySelector(".community-statistics");t&&new jo(t);const e=qo(".community-top-tags");return e.length&&new Eo({$el:e,communityId:this.communityId}),this}async _showSimilarCommunities(){if("community_hot"!==i.ZP.config("modules.feed-filter.feedMode"))return;const t=await this.community.getSimilarCommunities();if(!t.length)return;const e=Ze.S.getInstance().get("UICarousel"),n=function(t){var e="",i=Ho.escape;Array.prototype.join;const n=s(8211).vE;e+="\n",e+='\n<section class="carousel recommended-communities '+i(t.addExpClass)+'">\n    <h2 class="carousel__title">Похожие сообщества</h2>\n    <div class="carousel__main">\n        <button type="button" class="carousel__scroll button carousel__scroll_left carousel__scroll_hidden">\n            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon--ui__arrow-left"><use xlink:href="#icon--ui__arrow-left"></use></svg>\n        </button>\n        <div class="carousel__content">\n            <div class="carousel__helper">\n                <div class="carousel__border-left"></div>\n                ';for(var o=0;o<t.items.length;o++)e+='\n                    <article class="carousel__item recommended-community">\n                        <a href="/community/'+i(t.items[o].link_name)+'" class="recommended-community__link" data-id="'+i(t.items[o].id)+'">\n                            ',t.items[o].avatar?e+='\n                                <img class="recommended-community__logo" src="'+i(t.items[o].avatar)+'" alt="'+i(t.items[o].name)+'">\n                            ':e+='\n                                <div class="community-avatar community-avatar_big">\n                                    <span class="community-avatar__default"></span>\n                                </div>\n                            ',e+='\n                            <p class="recommended-community__name">'+i(t.items[o].name)+'</p>\n                        </a>\n                        <span class="recommended-community__followers">\n                            '+i(t.items[o].subs_cnt)+" "+i(n.i18n("plural.subs",t.items[o].subs_cnt))+'\n                        </span>\n                        <div class="button-group button-group_success"\n                             data-role="subscribe"\n                             data-type="community"\n                             data-analytics="'+i(t.subscribeParams)+'"\n                             data-id="'+i(t.items[o].id)+'"\n                        >\n                            <button type="button" class="button recommended-community__follow">Подписаться</button>\n                            <button type="button" class="button recommended-community-hidden"></button>\n                        </div>\n                    </article>\n                ';return e+'\n                <div class="carousel__border-right"></div>\n            </div>\n        </div>\n        <button type="button" class="carousel__scroll button carousel__scroll_right">\n            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon--ui__arrow-right"><use xlink:href="#icon--ui__arrow-right"></use></svg>\n        </button>\n    </div>\n</section>'}({items:t,subscribeParams:JSON.stringify({type:"community_similar"}),addExpClass:q.V.isUserInExperiment(q.t.COMMUNITY_SIMILAR,"in_feed")?"carousel_big-top-margin":""}),o=qo(n)[0];this._insertSimilarCommunitiesCarousel(o);const r=new e({el:o});this.listenToOnce(r,"carouselShown",(()=>{oe.cp.getInstance().sendEvent("reach_element",{type:"community_similar"},[oe.b0.CLICKHOUSE])}));const a=({target:t})=>{const e=t.closest(".recommended-community__link");if(!e)return;const s=Number(e.dataset.id);!Number.isNaN(s)&&s&&oe.cp.getInstance().sendEvent("transition_to_community",{type:"community_similar",community_id:s},[oe.b0.CLICKHOUSE])};o.addEventListener("click",a),o.addEventListener("auxclick",a);const l=Ze.S.getInstance().get("UISubscribeButton"),h=o.querySelectorAll(".button-group");for(const s of h)new l(s)}_insertSimilarCommunitiesCarousel(t){if(q.V.isUserInExperiment(q.t.COMMUNITY_SIMILAR,"in_feed")){const e=this._feed.el.querySelectorAll(".stories-feed__container article");e.length>2&&e[1].after(t)}else this.el.after(t)}get communityId(){return this._options.communityId}get community(){return this._options.community}get isLocked(){return this._options.isLocked}}const Go=s(9755);class Yo extends Wo{route(t,e){return this.ctx=t,this.isRendered?(this._feed.requestUrl=t.path,this._feed.clear(),this._feed.loadStories(!1)):this.show(),e()}render(){return this.isRendered||(super.render(),i.vE.ui.screen=lt.d.COMMUNITY,d.c.getInstance().clickhouse.commonParameters.screen_community=this.communityId,this.$els={queue:Go(".community-stories-queue"),search:Go(".stories-search")},this.$els.queue.length>0&&this.initQueueBox(),this._feed=new ys._D({$el:Go(".stories-feed"),feedName:this.$els.search.length?"community-search":"community",feedRecordId:document.location.pathname,focused:!0}),new ys.RP({$el:Go(".feed-panel"),feed:this._feed,isDisableCalendar:Boolean(this.communityId)}),this.$els.search.length&&(this._search=new Ns({feed:this._feed,searchMode:Ts.COMMUNITY,$el:this.$els.search})),this.toastApprove=new v.O({closeAfter:1e4,destroyAfterHide:!1,addCloseButton:!0})),this}initQueueBox(){super.initQueueBox({container:this.$els.queue,StoriesFeed:ys._D,SimilarStories:Ws.Bi})}}const zo=s(9755);var Zo=s(1845),Ko=s(9050);function Xo(t){var e="",s=Ko.escape;return e+='Вы действительно хотите проголосовать за пользователя <a href="/@'+s(t.name)+'" target="_blank" class="user user_inline"><span class="avatar avatar_small"><img src="'+s(t.avatar)+'"></span><span class="user__nick">'+s(t.name)+"</span></a>?\n"}const Qo=s(9755);var Jo=s(7154);class tr{static async loadBanList(t="",e=1){let{response:s,data:n}=await S.cf.get(i.vE.history.location.pathname,{q:t,ajax_mode:"1",page:e});if(!s.result)throw new Error(s.message);return{list:n.list,hasMore:n.has_more}}static getInitialTitle(t=""){return 0===t.length?document.title:document.title.replace(`${t} - `,"")}static formatTitle(t,e=""){return i.vE.i18n("banned-profiles.title."+(e.length>0?"query":"empty"),e,e.length>0?(s=t).charAt(0).toLowerCase()+s.substr(1):(t=>t.charAt(0).toUpperCase()+t.substr(1))(t));var s}}const er=new I.xs({STORY:1,COMMENT:2,PERMANENT:3,SLOWMODE:4}),sr=s(9755),ir=s(381),nr=s(6419);class or extends Fs.T3{render(){if(this.isRendered)return this;this.$el=sr(".banned-profiles"),this.$els={input:this.$('.input[data-role="search"]'),spinner:this.$('section[data-role="spinner"]'),form:this.$("form"),table:this.$('section[data-role="table"]')};let t=this._searchInput=new T.u3({$el:this.$els.input,suggestion:new C.xI,sanitizerRules:[T.op.trim()]});this.listenTo(new a.x(this.$els.form),"submit",(t=>{t.preventDefault(),this._loadList()})),this.listenTo(t.suggestion,C.nT.SELECT,(e=>{e&&(t.value=e.data.name,this._loadList())}));let e=[["Пользователь",20],["Причина",40],["Дата",20]];return i.vE.isUserModerator&&e.push(["Модератор",0]),this._initialTitle=tr.getInitialTitle(t.value),this._table=new Jo.$({$parent:this.$els.table,renderBody:this._renderTable.bind(this),header:e}),this._table.rows.fieldId="id",this._loadList(!1,i.vE.config("modules.banned-profile")),this._table.show(),this._table.$el.on("click",".banned-profiles__more",this._loadList.bind(this,!0,null)),this.$els.spinner.remove(),this.$els.table.show(),i.vE.ui.screen=lt.d.BANNED_PROFILES,super.render(),this}async _loadList(t=!1,e){let s=this._searchInput.value;if(!t&&this.marks.get("query")===s)return;this.marks.set("query",s);let n=tr.formatTitle(this._initialTitle,s);s.length?i.vE.history.searchParams.set("q",s):i.vE.history.searchParams.delete("q");let o=i.vE.history.searchParams.toString();i.vE.history.replaceState({},n,i.vE.history.location.pathname+(o.length>0?"?"+o:""),!1),document.title=n;let r=t?(this.marks.get("page")||1)+1:1;if(!e||!nr.isObject(e))try{e=await tr.loadBanList(s,r)}catch(h){return void i.vE.ui.toasts.showError(h)}let{list:a,hasMore:l}=e;this.marks.set("has-more",l),a=(nr.isArray(a)?a:[]).map((t=>(t.time=Number(ir(t.datetime).format("X")),t.ban_type=er[t.ban_type],t))),this.marks.set("page",r),this._table.rows.set(a,{merge:t})}_renderTable(t){let e=i.vE.isUserModerator?4:3;return yn.vu.create("tbody",null,t.size?null:yn.vu.create("tr",{className:"table__message"},yn.vu.create("td",{colSpan:e},i.vE.i18n("banned-profiles."+(this.marks.get("query").length>0?"search-":"")+"empty"))),t.items.map((t=>{const e=t.data.ban_type,s=i.vE.i18n("page-banned-profiles.source."+e.toString());let n=t.data.reason,o=null;return e===er.COMMENT||e===er.STORY?t.data.ban_source_url&&(o=yn.vu.create("a",{href:t.data.ban_source_url,target:"_blank"},s)):n+=", "+s,yn.vu.create("tr",{key:t.id,"data-id":t.id},yn.vu.create("td",null,yn.vu.create(bn.N,{name:t.data.user_name,avatar:t.data.user_avatar})),yn.vu.create("td",{className:"caption banned-profiles__reason"},n,o),yn.vu.create("td",null,yn.vu.create("time",{className:"caption hint",dateTime:t.data.datetime},ir(t.data.datetime).fromNow())),i.vE.isUserModerator&&yn.vu.create("td",null,yn.vu.create(bn.N,{name:t.data.moderator_name,avatar:t.data.moderator_avatar,short:!0})))})),Boolean(this.marks.get("has-more"))&&yn.vu.create("tr",{key:"hasMore"},yn.vu.create("td",{colSpan:e,className:"banned-profiles__more"},yn.vu.create("button",{type:"button",className:"button button_success"},i.vE.i18n("page-banned-profiles.more")))))}}const rr=new I.xs({DEFAULT:"default",STORIES:"stories",NAME:"name"});const ar=s(9755),lr=s(6419);class hr extends Fs.T3{route(t,e){const{page:s,internal:n,sort:o,hasMore:r}=i.vE.config("modules.approved-users"),{q:a}=c.cQ.getQueryParams(i.vE.location.search);let l;switch(o){case"stories":l=rr.STORIES;break;case"name":l=rr.NAME;break;default:l=rr.DEFAULT}return this.state.update({page:s,hasMore:r,internal:n,search:a,sort:l}),this.marks.set("first-load",!0),this.show(),e()}render(){return this.isRendered||(this.$el=ar(".page-approved-users"),this.$els={container:this.$(".users-list__container").addClass("users-list__container_no-pagination"),usersList:this.$(".users-list__grid"),showMore:this.$(".users-list__show-more button"),sortOrder:this.$('.page-approved-users__filter span[data-role="sort"]'),message:this.$(".users-list__message"),spinner:{top:this.$(".page-approved-users__spinner_top"),bottom:this.$(".page-approved-users__spinner_bottom")},search:{form:this.$(".page-approved-users__form"),input:this.$('.input[data-role="search"]')},navigation:{menu:this.$(".menu_horizontal"),items:this.$(".menu__item").not(".menu__item_right")}},this._form=new a.x(this.$els.search.form),this.listenTo(this._form,"submit",(t=>{t.preventDefault(),this.state.data.search=this._searchInput.value})),this._searchInput=new T.u3({$el:this.$els.search.input,sanitizerRules:[T.op.trim()]}),this._form.add(this._searchInput),this.topSpinner=i.vE.ui.player.createAnimation("stories-spinner",{$parent:this.$els.spinner.top}),this.bottomSpinner=i.vE.ui.player.createAnimation("stories-spinner",{$parent:this.$els.spinner.bottom}),this.$els.navigation.items.on("click",(t=>this._toggleListType(t))),this.$els.showMore.on("click",(()=>this._loadUsers())),this.$els.sortOrder.on("click",(()=>this._toggleSortMode())),this.listenTo(i.vE.ui,"document-scroll",lr.throttle(this._handleScrolling,200)),i.vE.ui.screen=lt.d.APPROVED_USERS,super.render()),this}_syncComponent(t){if(!this.isShown)return;let e=t.diff("sync");if(!e.length)return;let s=!1;for(let r of e){let{property:t,value:e}=r;if("search"===t&&(this._searchInput.value=e,s=!0),"sort"===t&&(this.$els.sortOrder.find("span:first-child").text(i.vE.i18n("approved-users.sort-mode."+e.toString()).toLowerCase()),s=!0),"internal"===t){const t=this.state.data.internal?'[href*="staff"]':':not([href*="staff"])';this.$els.navigation.items.removeClass("menu__item_current").filter(t).addClass("menu__item_current"),s=!0}}t.save("sync"),!this.marks.has("first-load")&&s&&this._loadUsers(!0),this.marks.delete("first-load");let n=this.state.plainData,o="/approved-users"+(n.internal?"/staff":"")+(n.sort!==rr.DEFAULT?"/"+n.sort.valueOf():"");n.search&&n.search.length&&(o+=(o.includes("?")?"&":"?")+"q="+encodeURIComponent(n.search)),i.vE.replaceState({},"",o,!1)}_handleScrolling(){this.state.data.hasMore&&!this.marks.get("loading")&&i.vE.ui.elementWillSoonScrolled(this.$els.spinner.bottom[0])&&this._loadUsers()}_toggleSortMode(){let t=this.marks.get("sort-popup");if(!t){const e=this.state.data.sort||rr.DEFAULT;t=pt.g.popupEnum(this.$els.sortOrder,rr,"approved-users.sort-mode",e),this.listenTo(t,"change",((e,s)=>{this.state.data.sort=s,t.hide()})),this.marks.set("sort-popup",t)}t.toggle()}_toggleListType(t){t.preventDefault(),this.state.data.internal=-1!==ar(t.currentTarget).attr("href").indexOf("staff")}_loadUsers(t=!1){if(!t&&!this.state.data.hasMore)return;let{sort:e,search:s,internal:n,page:o}=this.state.data,r=this.lastRequestId=lr.uniqueId("approved-users_");this._toggleLoadAnimation(!0,t),t&&(this.$els.container.hide(),this.$els.usersList.html(""),this.state.data.page=1),class{static async loadUsers(t={}){const e=t.page||1,s=t.sort||"default",i=t.search||"",n=t.internal?1:0,{response:o,data:r}=await S.cf.get("/ajax/get_approved_users.php",{page:e,sort:s,search:i,internal:n});if(!o.result)throw new Error(o.message);return{users:r.users,total:r.total,hasMore:r.has_more}}}.loadUsers({page:t?1:o+1,sort:e.valueOf(),search:s,internal:n}).then((async e=>{await c.cQ.delay(400),r===this.lastRequestId&&(this._toggleLoadAnimation(!1),lr.isArray(e.users)&&(e.users.length>0?(this._toggleNoUsers(!1),this.$els.usersList.append(this._renderUsers(e.users)),this.state.data.page++):t&&this._toggleNoUsers(!0)),this.state.data.hasMore=Boolean(e.hasMore))})).catch((t=>{this._toggleLoadAnimation(!1),this._toggleNoUsers(!0),i.vE.logger.error("approved-users","error loading more approved users",t)}))}_toggleNoUsers(t){lr.isUndefined(t)||(t?(this.$els.message.show(),this.$els.container.hide()):(this.$els.message.hide(),this.$els.container.show()))}_toggleLoadAnimation(t,e=!0){if(t){(e?this.topSpinner:this.bottomSpinner).togglePlay(!0),this.marks.set("loading",!0)}else this.topSpinner.togglePlay(!1),this.bottomSpinner.togglePlay(!1),this.marks.set("loading",!1)}_renderUsers(t){if(!lr.isArray(t)||t.length<1)return;let e=[],s=this.state.data.internal;return t.map((t=>{const i=t.stories>0?`${t.stories} ${c.cQ.pluralNounRU(t.stories,["пост","поста","постов"])}`:"Ещё нет постов";e.push(function(t){var e,s="";return Array.prototype.join,s+='<li class="users-list__user">\n\t<div class="users-list__avatar-wrapper">\n\t\t<div class="avatar avatar_medium-big">\n\t\t\t',t.avatar?s+='\n\t\t\t\t<img src="'+(null==(e=t.avatar)?"":e)+'" alt="Аватар пользователя '+(null==(e=t.name)?"":e)+'">\n\t\t\t':s+='\n\t\t\t\t<span class="avatar__default"></span>\n\t\t\t',s+='\n\t\t</div>\n\t</div>\n\t<div class="users-list__information">\n\t\t<a class="users-list__nick" href="'+(null==(e=t.url)?"":e)+'">\n\t\t\t<span class="users-list__nick-inner" data-profile="true" data-name="'+(null==(e=t.name)?"":e)+'">\n\t\t\t\t'+(null==(e=t.isStaffPage?t.name:t.approved)?"":e)+'\n\t\t\t</span>\n\t\t\t<span class="users-list__approved">\n\t\t\t\t',t.isStaffPage?s+='\n\t\t\t\t\t<svg xmlns="http://www.w3.org/2000/svg" class="icon icon--ui__pikabu-team"><use xlink:href="#icon--ui__pikabu-team"></use></svg>\n\t\t\t\t':s+='\n\t\t\t\t\t<svg xmlns="http://www.w3.org/2000/svg" class="icon icon--ui__approved"><use xlink:href="#icon--ui__approved"></use></svg>\n\t\t\t\t',s+='\n\t\t\t</span>\n\t\t</a>\n\t\t<span class="users-list__posts-count">\n\t\t\t',t.isStaffPage?s+="\n\t\t\t\t"+(null==(e=""!==t.approvedRole?t.approvedRole:t.approved)?"":e)+"\n\t\t\t":s+="\n\t\t\t\t"+(null==(e=t.storiesCount)?"":e)+"\n\t\t\t",s+="\n\t\t</span>\n\t</div>\n</li>\n"}({storiesCount:i,isStaffPage:s,url:t.url,name:t.name,avatar:t.avatar,approved:t.value,approvedRole:t.role}))})),e.join("")}get state(){let t=this._options.state;return t||(t=this._options.state=new qi.Lo({page:void 0,hasMore:void 0,internal:void 0,search:void 0,sort:void 0}),this.listenTo(t,qi.u$.CHANGE,lr.debounce(this._syncComponent.bind(this),20))),this._options.state}set lastRequestId(t){t&&(this._options.lastRequestId=t)}get lastRequestId(){return this._options.lastRequestId}}const cr=s(9755);class dr extends Fs.T3{route(t,e){return this.ctx=t,this._searchMode=t.params.hasOwnProperty("name")?Ts.TAG:Ts.ALL,this.isRendered||this.show(),e()}render(){return this.isRendered||(i.vE.ui.screen=this._searchMode===Ts.TAG?lt.d.TAGS:lt.d.SEARCH,this._feed=new ys._D({$el:cr(".stories-feed"),feedName:"search",focused:!0}),this._search=new Ns({feed:this._feed,searchMode:this._searchMode,$el:cr(".stories-search")}),super.render()),this}}const ur=s(9755);class pr extends Fs.T3{render(){return this.isRendered||(this.$el=ur(".stories-feed"),this._feed=new ys._D({$el:this.$el,feedName:"adverts",focused:!0}),super.render()),this}}const mr=s(9755);class _r extends Fs.T3{render(){return this.isRendered||(this.$el=mr(".stories-feed"),i.vE.ui.screen=lt.d.SAVED,this._feed=new ys._D({$el:this.$el,feedName:"most-saved",focused:!0}),new ys.RP({$el:mr(".feed-panel"),feed:this._feed,isDisableCalendar:!0}),super.render()),this}}const gr=s(9755);class vr extends Fs.T3{render(){return this.isRendered||(this.$el=gr(".stories-feed"),i.vE.ui.screen=lt.d.DISCUSSED,this._feed=new ys._D({$el:this.$el,feedName:"disputed",focused:!0}),new ys.RP({$el:gr(".feed-panel"),feed:this._feed,isDisableCalendar:!0}),super.render()),this}}const fr=s(9755);class yr extends Fs.T3{render(){return this.isRendered||(this.$el=fr(".stories-feed"),this._feed=new ys._D({$el:this.$el,feedName:"discussed",focused:!0}),super.render()),this}}const br=s(9755),wr=s(6419);class Er extends Fs.T3{route(t,e){return this.ctx=t,this.isLiked=void 0===t.params.not,this.show(),e()}render(){return this.isRendered||(this.$el=br(".stories-liked"),this.$els.message=br(".stories-feed > .stories-feed__message"),this._form=new a.x(this.$("form")),this.listenTo(this._form,"submit",this._formSubmit),this._feed=new ys._D({$el:br(".stories-feed"),feedName:"liked",focused:!0}),i.ZP.ui.screen=lt.d.USER_LIKED,Ii.SR.getInstance().init("rates_visit"),this.listenTo(this._feed,"loaded",((t,e)=>{let s=!(this._feed.stories.size||wr.isArray(t.stories)&&t.stories.length);e&&s&&this.$els.message.html(i.ZP.i18n(this._lastSearch.length?"stories-feed.eof.search-empty":"stories-feed.eof.empty"))})),this._searchInput=new T.u3({$el:this.$(".input"),sanitizerRules:[T.op.trim()]}),this.listenTo(this._searchInput,"input",(t=>{this._submitButton.disabled=this._lastSearch===t})),this._lastSearch=this._searchInput.value,this._submitButton=new st.y3(this.$("button")),super.render()),this}async _formSubmit(t){t.preventDefault();let e=this._searchInput.value;e!==this._lastSearch&&(this._lastSearch=e,this._submitButton.progress=!0,await this._updateFeed(),this._submitButton.progress=!1,this._submitButton.disabled=!0)}_updateEndOfFeedMessage(){this.$els.message.text(i.ZP.i18n(this._lastSearch.length?"stories-feed.eof.search":"stories-feed.eof.default"))}async _updateFeed(){let t=this._searchInput.value;this._updateEndOfFeedMessage(),this._feed.clear().searchParams.set("search",t),this._feed.requestUrl=i.ZP.location.pathname,await this._feed.loadStories(!1)}get isLiked(){return this._options.isLiked}set isLiked(t){this._options.isLiked!==(t=Boolean(t))&&(this._options.isLiked=t,this.isRendered&&(this._lastSearch=this._searchInput.value="",this._updateFeed()))}}const Sr=s(9755),Cr=s(6419);class Tr extends Fs.T3{route(t,e){return this.ctx=t,this.categoryId=t.params.cid||0,this.show(),e()}render(){if(this.isRendered)return this;this.$el=Sr(".saved-stories"),this.$els={form:this.$("form"),message:Sr(".stories-feed > .stories-feed__message"),categories:this.$(".saved-stories__categories"),share:this.$(".saved-stories__share"),shareSwitchBtn:this.$(".saved-stories__share-switch"),copyLinkBtn:this.$(".saved-stories__copy-link")},this._isCheckboxChangedAutomatically=!1,this.$el.on("click",".saved-stories__category",(t=>{this.$(".saved-stories__category.button_success").removeClass("button_success");let e=Sr(t.currentTarget);e.addClass("button_success"),this._lastSearch=this._searchInput.value="",this.categoryId=Number(t.currentTarget.getAttribute("data-id")),Boolean(e.data("shared"))!==this._shareSwitch.checked&&(this._isCheckboxChangedAutomatically=!0,this._shareSwitch.checked=Boolean(e.data("shared"))),this._copyLink.$el.data("link",e.data("shared-link"))}));let t=this.$(".saved-stories__category.button_success").data("id");return this.categoryId=t?Number(t):this.categoryId,this._searchInput=new T.u3({$el:this.$(".input"),sanitizerRules:[T.op.trim()]}),this.listenTo(this._searchInput,"input",(t=>{this._submitButton.disabled=this._lastSearch===t})),this._lastSearch=this._searchInput.value,this._submitButton=new st.y3(this.$("button")),this.listenTo(new a.x(this.$els.form),"submit",this._formSubmit),this._feed=new ys._D({$el:Sr(".stories-feed"),feedName:"saved",focused:!0}),i.ZP.ui.screen=lt.d.USER_SAVED_STORIES,this.listenTo(this._feed,"loaded",((t,e)=>{let s=!(this._feed.stories.size||Cr.isArray(t.stories)&&t.stories.length);e&&s&&this.$els.message.html(i.ZP.i18n(this._lastSearch.length?"stories-feed.eof.search-empty":"stories-feed.eof.empty"))})),this.shareMsg=new v.O({destroyAfterHide:!1,addCloseButton:!0,closeAfter:3e3}),this.$els.shareSwitchBtn.length&&(this._shareSwitch=new Zo.m(this.$els.shareSwitchBtn),this._copyLink=new st.y3(this.$els.copyLinkBtn),this.listenTo(this._shareSwitch,"change",(async t=>{if(this._isCheckboxChangedAutomatically)return void(this._isCheckboxChangedAutomatically=!1);this._copyLink.progress=!0;let e=await class{static async share(t,e){let s={action:t?"share":"unshare",category_id:e},{response:i,data:n}=await S.cf.post("/ajax/saved_category_sharing.php",s);if(!i.result)throw new Error(i.message);return n}}.share(t,this.categoryId);this._copyLink.progress=!1,this._copyLink.disabled=!e.is_shared,this.$els.categories.find(`.saved-stories__category[data-id="${this.categoryId}"]`).data("shared",e.is_shared),this.shareMsg.hide(),this.timeout("reopen",200,(()=>{this.shareMsg.content=i.ZP.i18n("page-stories-saved.category."+(e.is_shared?"shared":"unshared")),this.shareMsg.show()}))})),this.listenTo(this._copyLink,"click",(()=>{let t=this._copyLink.$el.data("link");c.cQ.copyToClipboard(t),this.shareMsg.hide(),this.timeout("reopen",200,(()=>{this.shareMsg.content=i.ZP.i18n("page-stories-saved.copy-link"),this.shareMsg.show()}))}))),Ii.SR.getInstance().init("my_saved_visit"),super.render(),this}_updateEndOfFeedMessage(){this.$els.message.text(i.ZP.i18n(this._lastSearch.length?"stories-feed.eof.search":"stories-feed.eof.default"))}async _formSubmit(t){t.preventDefault();let e=this._searchInput.value;e!==this._lastSearch&&(this._lastSearch=e,this._submitButton.progress=!0,await this._updateFeed(),this._submitButton.progress=!1,this._submitButton.disabled=!0)}async _updateFeed(){let t=this._searchInput.value;this._updateEndOfFeedMessage(),this._feed.clear().searchParams.set("search",t),this._feed.requestUrl=i.ZP.location.pathname,await this._feed.loadStories(!1)}get categoryId(){return this._options.categoryId}set categoryId(t){let e=this._options.categoryId;e!==(t="number"==typeof t?t:parseInt(t,10))&&(this._options.categoryId=t,!Cr.isUndefined(e)&&this.isRendered&&(i.ZP.replaceState({},"Моя лента","/saved-stories"+(t>=0?"/"+t:"")),this._updateFeed()))}}const Or=s(9755),kr=s(6419);class Ir extends Fs.T3{render(){if(this.isRendered)return this;if(this.$el=Or(".tags-search"),this.$els={searchFrom:this.$(".tags-search__form"),searchInput:this.$("#tags-search-search"),tagsSection:this.$(".tags__section")},this.$els.searchFrom.length){let t=new a.x(this.$els.searchFrom);this.search=new T.u3(kr.defaults({$el:this.$els.searchInput.closest(".input")},{validationHint:{direction:k.Lh.TOP,alignment:k.SE.CENTER}})),this.search.validationRules={"page-tags-search.form.invalid-text-length":t=>1!==t.length},this.listenTo(t,"submit",this._handleSearch),this._lastSearchedText=this.$els.searchInput.val()}return super.render(),this}async _handleSearch(){const t=this.$els.searchInput.val();await this.search.checkValidity()&&(i.ZP.searchParams.delete("q"),i.ZP.searchParams.set("q",t),i.ZP.location.href=i.ZP.location.pathname+"?"+i.ZP.searchParams.toString())}static _updateHistoryState(t){let e=`${t} - поиск тегов`.replace(/[<>&]/gi,""),s="?q="+encodeURIComponent(t);i.ZP.replaceState({},e,s,!0),document.title=e}}var $r=s(6265),Ar=s(3023),xr=s(7686);const Dr=s(6419);class Pr extends C.Vd{constructor(t){super(t),this._options.items.DataObject=C.U}async _requestItems(t,e){let s=await bs.Hx.searchMerge(t);return s&&s.forEach((t=>this.tags.set(t.name.toLowerCase(),t))),s}addTag(t,e){let s={label:t,info:e},i=t.toLowerCase();this.tags.has(i)||this.tags.set(i,s)}get tags(){return Dr.isObject(i.ZP.storage.cacheDropList)||(i.ZP.storage.cacheDropList={}),Dr.isObject(i.ZP.storage.cacheDropList.mergeTags)?i.ZP.storage.cacheDropList.mergeTags:i.ZP.storage.cacheDropList.mergeTags=new Map}get cache(){return Dr.isObject(i.ZP.storage.cacheDropList)||(i.ZP.storage.cacheDropList={}),Dr.isObject(i.ZP.storage.cacheDropList.mergeTagsSearchResults)?i.ZP.storage.cacheDropList.mergeTagsSearchResults:i.ZP.storage.cacheDropList.mergeTagsSearchResults=new Map}}var Rr=s(9050);var Mr=s(9050);var Nr=s(9050);var Br=s(9050);function Lr(t){var e="",s=Br.escape;return e+='<div class="tm-conflicts__issue">\n\tОбъединение тега\n\t<a href="/tag/'+s(t.tag1)+'" class="tm-tag" target="_blank">\n\t\t<span class="tm-tag__name">'+s(t.tag1)+'</span>\n\t\t<span class="tm-tag__counter">'+s(t.count1)+'</span>\n\t</a>\n\tв тег\n\t<a href="/tag/'+s(t.tag2)+'" class="tm-tag" target="_blank">\n        <span class="tm-tag__name">'+s(t.tag2)+'</span>\n        <span class="tm-tag__counter">'+s(t.count2)+"</span>\n    </a>\n\tранее было отменено модератором\n</div>"}var Fr=s(9050);function Ur(t){var e="",s=Fr.escape;Array.prototype.join;return e+='<div class="tm-conflicts__issue">\n\tДля тега\n\t<a href="/tag/'+s(t.tag1)+'" class="tm-tag" target="_blank">\n\t\t<span class="tm-tag__name">'+s(t.tag1)+'</span>\n\t\t<span class="tm-tag__counter">'+s(t.count1)+'</span>\n\t</a>\n\tуже есть предложение объединения в тег\n\t<a href="/tag/'+s(t.tag2)+'" class="tm-tag" target="_blank">\n\t\t<span class="tm-tag__name">'+s(t.tag2)+'</span>\n\t\t<span class="tm-tag__counter">'+s(t.count2)+"</span>\n\t</a>\n\t",t.isModerator&&t.ruleId>0&&(e+='\n\t\t<button class="button_small"\n\t\t\tdata-tag-from="'+s(t.tag1)+'"\n\t\t\tdata-tag-to="'+s(t.tag2)+'"\n\t\t\tdata-id="'+s(t.ruleId)+'"\n\t\t    data-is-approved="false"\n\t\t\tdata-role="cancel">отклонить</button>\n\t'),e+="\n</div>"}var jr=s(9050);function Vr(t){var e="",s=jr.escape;Array.prototype.join;return e+='<div class="tm-conflicts__issue">\n\tТег\n\t<a href="/tag/'+s(t.tag1)+'" class="tm-tag" target="_blank">\n\t\t<span class="tm-tag__name">'+s(t.tag1)+'</span>\n\t\t<span class="tm-tag__counter">'+s(t.count1)+'</span>\n\t</a>\n\tуже имеет объединение в тег\n\t<a href="/tag/'+s(t.tag2)+'" class="tm-tag" target="_blank">\n\t\t<span class="tm-tag__name">'+s(t.tag2)+'</span>\n\t\t<span class="tm-tag__counter">'+s(t.count2)+"</span>\n\t</a>\n\t",t.isModerator&&t.ruleId>0&&(e+='\n\t\t<button class="button_small"\n\t\t\tdata-tag-from="'+s(t.tag1)+'"\n\t\t\tdata-tag-to="'+s(t.tag2)+'"\n\t\t\tdata-id="'+s(t.ruleId)+'"\n\t\t\tdata-is-approved="true"\n\t\t\tdata-role="cancel">отменить правило</button>\n\t'),e+="\n</div>"}var Hr=s(9050);function qr(t){var e="",s=Hr.escape;Array.prototype.join;return e+='<div class="tm-conflicts__issue">\n\tДля тега\n\t<a href="/tag/'+s(t.tag2)+'" class="tm-tag" target="_blank">\n\t\t<span class="tm-tag__name">'+s(t.tag2)+'</span>\n\t\t<span class="tm-tag__counter">'+s(t.count2)+'</span>\n\t</a>\n\tсуществует объединение тега\n\t<a href="/tag/'+s(t.tag1)+'" class="tm-tag" target="_blank">\n        <span class="tm-tag__name">'+s(t.tag1)+'</span>\n        <span class="tm-tag__counter">'+s(t.count1)+"</span>\n    </a>\n\t",t.isModerator&&t.ruleId>0&&(e+='\n        <button class="button_small"\n            data-tag-from="'+s(t.tag1)+'"\n            data-tag-to="'+s(t.tag2)+'"\n            data-id="'+s(t.ruleId)+'"\n            data-is-approved="true"\n            data-role="cancel">отменить правило</button>\n\t\t<button class="button_small"\n\t        data-tag="'+s(t.tag1)+'"\n\t        data-id="'+s(t.ruleId)+'"\n\t        data-is-approved="true"\n\t        data-role="remerge">переобъединить</button>\n    '),e+="\n</div>"}var Wr=s(9050);function Gr(t){var e="",s=Wr.escape;return e+='<div class="tm-conflicts__issue">\n\tТег\n\t<a href="/tag/'+s(t.tag1)+'" class="tm-tag" target="_blank">\n\t\t<span class="tm-tag__name">'+s(t.tag1)+'</span>\n\t\t<span class="tm-tag__counter">'+s(t.count1)+"</span>\n\t</a>\n\tне найден среди тегов\n</div>"}var Yr=s(9050);function zr(t){var e="",s=Yr.escape;Array.prototype.join;return e+='<div class="tm-conflicts__issue">\n\tПредложение на объединение тега\n\t<a href="/tag/'+s(t.tag1)+'" class="tm-tag" target="_blank">\n\t\t<span class="tm-tag__name">'+s(t.tag1)+'</span>\n\t\t<span class="tm-tag__counter">'+s(t.count1)+'</span>\n\t</a>\n\tв тег\n\t<a href="/tag/'+s(t.tag2)+'" class="tm-tag" target="_blank">\n        <span class="tm-tag__name">'+s(t.tag2)+'</span>\n        <span class="tm-tag__counter">'+s(t.count2)+"</span>\n    </a>\n\tранее было отклонено модератором\n\t",t.isModerator&&(e+='\n\t<button class="button_small"\n\t        data-tag-from="'+s(t.tag1)+'"\n\t        data-tag-to="'+s(t.tag2)+'"\n\t        data-role="cancel-rejection">отменить отклонение</button>\n\t'),e+="\n</div>"}const Zr=s(9755),Kr=s(6419);class Xr extends Fs.T3{render(){return this.el=document.querySelector(".tags-merge"),this.els={tagsSearchForm:this.el.querySelector(".tags-search"),tagsFoundSectionGroup:this.el.querySelector(".tags-found"),paginationContainer:this.el.querySelector(".tags-found__pagination-container"),tagsFoundList:this.el.querySelector(".tags-found__list"),mergeProposalForm:this.el.querySelector(".merge-proposal"),fromProposalContainer:this.el.querySelector('.merge-proposal__find[data-role="from"]'),storiesQuantityButton:this.el.querySelector(".tags-search__quantity-button"),storiesQuantityNumber:this.el.querySelector(".tags-search__quantity-number"),mergingSection:this.el.querySelector(".merging-section"),bannedSection:this.el.querySelector(".tm-banned-section")},this.$els={mergeProposalForm:this.$(".merge-proposal"),mergeProposalFormButton:this.$(".merge-proposal button"),conflicts:this.$(".tm-conflicts"),conflictsBody:this.$(".tm-conflicts__body"),conflictsMessage:this.$(".tm-conflicts__message"),conflictsApplyButton:this.$('.tm-conflicts button[data-role="apply"]'),conflictsBackButton:this.$('.tm-conflicts button[data-role="back"]')},this._data=i.ZP.config("modules.params"),this._loadingButton={$button:null,button:null},this.els.tagsSearchForm&&this._initTagsSearch(),this.els.mergingSection&&this._initMergingSection(),this.els.mergeProposalForm&&this._initMergeProposal(),this.els.bannedSection&&this._initBannedSection(),this.$els.conflicts.length>0&&this._initConflicts(),this}async _initTagsSearch(){this.els.tagsSearchInput=this.els.tagsSearchForm.querySelector(".input"),this._tagsSearchInput=new T.u3(this.els.tagsSearchInput),this._tagsSearchForm=new a.x(this.els.tagsSearchForm),this._tagsSearchForm.add(this._tagsSearchInput),this._storiesQuantityNumber=this.els.storiesQuantityNumber.innerText||30,this.els.tagsSearchForm.dataset.lastQuantity=this._storiesQuantityNumber,this._initQuantityPicker(),this.els.storiesQuantityButton.addEventListener("click",this._quantityBalloonShow.bind(this)),this.listenTo(this._tagsSearchForm,"submit",this._handleSearchSubmit)}async _initMergingSection(){this.els.nonApprovedForm=this.els.mergingSection.querySelector(".merging-section__item_non-approved"),this.els.nonApprovedInput=this.els.nonApprovedForm.querySelector('.input[data-role="find"]'),this.els.nonApprovedRulesList=this.els.nonApprovedForm.querySelector(".tm-small-search__list"),this.els.approvedForm=this.els.mergingSection.querySelector(".merging-section__item_approved"),this.els.approvedInput=this.els.approvedForm.querySelector('.input[data-role="find"]'),this.els.approvedRulesList=this.els.approvedForm.querySelector(".tm-small-search__list"),this._rulesLimit=30,this._initRules(!1),this._initRules(!0),this.els.mergingSection.addEventListener("click",this._handleBtnMoreClick.bind(this)),this.els.approvedRulesList.addEventListener("click",this._rollbackRule.bind(this)),this.els.nonApprovedRulesList.addEventListener("click",this._approveRule.bind(this)),this.els.nonApprovedRulesList.addEventListener("click",this._disapproveRule.bind(this)),this._approvedForm=new a.x(this.els.approvedForm),this._approvedInput=new T.u3(this.els.approvedInput),this._approvedForm.add(this._approvedInput),this.listenTo(this._approvedForm,"submit",this._handleSmallSearchSubmit),this._nonApprovedForm=new a.x(this.els.nonApprovedForm),this._nonApprovedInput=new T.u3(this.els.nonApprovedInput),this._nonApprovedForm.add(this._nonApprovedInput),this.listenTo(this._nonApprovedForm,"submit",this._handleSmallSearchSubmit)}async _initMergeProposal(){this._UIInputsByInputs=new Map,this._mergeProposalForm=new a.x(this.els.mergeProposalForm),this.listenTo(this._mergeProposalForm,"submit",this._handleProposalSubmit),this._initProposalInputs(),this.els.fromProposalContainer.addEventListener("focusin",this._handleProposalFocus.bind(this)),this.els.fromProposalContainer.addEventListener("click",this._handleProposalRemove.bind(this)),this.els.tagsFoundList.addEventListener("click",this._handleFoundTagClick.bind(this))}async _initBannedSection(){this.els.bannedSearchForm=this.els.bannedSection.querySelector(".tm-banned-container__item_search"),this.els.bannedSearchInput=this.els.bannedSearchForm.querySelector(".input"),this.els.bannedList=this.els.bannedSearchForm.querySelector(".tm-small-search__list"),this.els.bannedSearchForm.addEventListener("click",this._handleBtnMoreClick.bind(this)),this.els.bannedList.addEventListener("click",this._unbanTag.bind(this)),this._bannedSearchForm=new a.x(this.els.bannedSearchForm),this._bannedSearchInput=new T.u3(this.els.bannedSearchInput),this._bannedSearchForm.add(this._bannedSearchInput),this.listenTo(this._bannedSearchForm,"submit",this._handleSmallSearchSubmit),this.els.bannedAddForm=this.els.bannedSection.querySelector(".tm-banned-container__item_add"),this.els.bannedAddInput=this.els.bannedAddForm.querySelector(".input"),this._bannedAddForm=new a.x(this.els.bannedAddForm);let t=this.els.bannedAddInput.querySelector("input");this._bannedAddInput=new T.u3({el:this.els.bannedAddInput,validationHint:{direction:k.Lh.TOP,alignment:k.SE.CENTER},suggestion:new Pr}),this._bannedAddInput.validationRules={"page-tags-merge.proposal-form.non-existent-tag":t=>{let e=this._bannedAddInput.suggestion.tags.has(t.toLowerCase());return this.els.bannedAddInput.dataset.novalidate||e}},this._bannedAddForm.add(this._bannedAddInput),this.listenTo(this._bannedAddInput,xr.n.SELECT,(t=>{this._bannedAddInput.suggestion.hide(),t&&t.data&&t.data.name&&(this._bannedAddInput.value=t.data.name)})),t.disabled=!1,this.listenTo(this._bannedAddForm,"submit",this._handleBanTagSubmit),this._badTagsLimit=30,this._updateBadTagsList(this._data.badTags)}async _updateBadTagsList(t,e){let s=this.els.bannedList;e&&(s.innerHTML="");let i=s.childElementCount;for(let n of t){let t=Xr._constructBannedTag(n.tag,n.count);s.appendChild(t)}if(!t.length&&!i)return s.dataset.notFound="",void delete s.dataset.hasMore;delete s.dataset.notFound,t.length<this._badTagsLimit?delete s.dataset.hasMore:s.dataset.hasMore=""}async _initRules(t){let e;e=t?this._data.approvedRules.rules:this._data.nonApprovedRules.rules,this._insertIntoRulesList(e,t)}async _insertIntoRulesList(t,e,s,i){let n;n=e?this.els.approvedRulesList:this.els.nonApprovedRulesList,s&&(n.innerHTML="");let o=n.childElementCount,r=!!this._data.isModerator&&Boolean(this._data.isModerator);for(let a of t){let t=Xr._constructRule(a,e,r);i?n.insertAdjacentElement("afterbegin",t):n.appendChild(t)}if(!t.length&&!o)return n.dataset.notFound="",void delete n.dataset.hasMore;delete n.dataset.notFound,t.length<this._rulesLimit?delete n.dataset.hasMore:n.dataset.hasMore=""}async _handleSmallSearchSubmit(t){t.preventDefault();let e,s,i=t.target,n=i.dataset.type,o=i.dataset.lastSearch;switch(n){case"approved":e=this._approvedInput.value,s=!0;break;case"non-approved":e=this._nonApprovedInput.value,s=!1;break;case"banned":e=this._bannedSearchInput.value;break;default:return}if(i.dataset.lastSearch=e,o!==e){if("approved"===n||"non-approved"===n){let{rules:t}=await bs.lX.getRules(s,0,e);this._insertIntoRulesList(t,s,!0)}if("banned"===n){let t=await bs.Hx.getBannedByName(0,e);this._updateBadTagsList(t,!0)}}}async _handleBtnMoreClick(t){let e=t.target.closest(".tm-small-search__show-more-btn");if(!e)return;if(e.disabled)return;t.preventDefault(),e.disabled=!0;let s,i=e.closest("form"),n=e.dataset.approved,o=i.dataset.type,r=i.dataset.lastSearch;switch(o){case"approved":s=this.els.approvedRulesList.childElementCount;break;case"non-approved":s=this.els.nonApprovedRulesList.childElementCount;break;case"banned":s=this.els.bannedList.childElementCount;break;default:return}if("approved"===o||"non-approved"===o){let{rules:t}=await bs.lX.getRules(n,s,r);this._insertIntoRulesList(t,n)}if("banned"===o){let t=await bs.Hx.getBannedByName(s,r);this._updateBadTagsList(t)}e.disabled=!1}async _approveRule(t){let e=t.target.closest('a[data-role="approve"]');if(!e)return;t.preventDefault();let s=e.closest(".tm-rule"),n=s.dataset.from,o=s.dataset.to,r=`\n\t\t\t<p>${i.ZP.i18n("page-tags-merge.confirmation.approve-rule.start")} <span class="tm-tag__name">${n}</span>\n\t\t\t${i.ZP.i18n("page-tags-merge.confirmation.approve-rule.end")} <span class="tm-tag__name">${o}</span> ?</p>\n\t\t`;pt.g.confirmModal({content:r,header:i.ZP.i18n("page-tags-merge.confirmation.approve-rule.header"),indent:!0,buttonsAlign:"left",buttons:[[i.ZP.i18n("page-tags-merge.confirmation.yes"),Bs.j.SUCCESS,!0],[i.ZP.i18n("page-tags-merge.confirmation.no")]]}).then((async t=>{if(t){let t=s.dataset.id;try{let e=await bs.lX.approveRule(t);if(e){let t=this.els.nonApprovedRulesList;t.removeChild(s),t.childElementCount||t.hasAttribute("data-has-more")||(t.dataset.notFound=""),this._insertIntoRulesList([e],!0,!1,!0)}}catch(e){i.ZP.ui.toasts.showError(e)}}}))}async _unbanTag(t){t.preventDefault();let e=t.target.closest('a[data-role="unban"]');if(!e)return;let s=e.closest(".tm-tag"),n=s.dataset.name,o=`\n\t\t\t<p>\n\t\t\t\t${i.ZP.i18n("page-tags-merge.confirmation.unban-tag.start")} \n\t\t\t\t<span class="tm-tag__name">${n}</span> ?\n\t\t\t</p>\n\t\t`;pt.g.confirmModal({content:o,header:i.ZP.i18n("page-tags-merge.confirmation.unban-tag.header"),indent:!0,buttonsAlign:"left",buttons:[[i.ZP.i18n("page-tags-merge.confirmation.yes"),Bs.j.SUCCESS,!0],[i.ZP.i18n("page-tags-merge.confirmation.no")]]}).then((async t=>{if(t)try{if(await bs.lX.unbanTag(n)){let t=this.els.bannedList;t.removeChild(s),t.childElementCount||t.hasAttribute("data-has-more")||(t.dataset.notFound="")}}catch(e){i.ZP.ui.toasts.showError(e)}}))}async _disapproveRule(t){let e=t.target.closest('a[data-role="disapprove"]');if(!e)return;t.preventDefault();let s=e.closest(".tm-rule");try{await this._showDisapproveRuleConfirm(s.dataset.id,s.dataset.from,s.dataset.to)}catch(n){return}let i=this.els.nonApprovedRulesList;i.removeChild(s),i.childElementCount||i.hasAttribute("data-has-more")||(i.dataset.notFound="")}_showDisapproveRuleConfirm(t,e,s,n=null){return new Promise(((o,r)=>{pt.g.confirmModal({content:`\n\t\t\t\t\t<p>\n\t\t\t\t\t\t${i.ZP.i18n("page-tags-merge.confirmation.disapprove-rule.start")} \n\t\t\t\t\t\t<span class="tm-tag__name">${e}</span>\n\t\t\t\t\t\t${i.ZP.i18n("page-tags-merge.confirmation.disapprove-rule.end")} \n\t\t\t\t\t\t<span class="tm-tag__name">${s}</span> ?\n\t\t\t\t\t</p>\n\t\t\t\t`,header:i.ZP.i18n("page-tags-merge.confirmation.disapprove-rule.header"),indent:!0,buttonsAlign:"left",buttons:[[i.ZP.i18n("page-tags-merge.confirmation.yes"),"green",!0],[i.ZP.i18n("page-tags-merge.confirmation.no"),"gray",!1]]}).then((async e=>{if(e)try{this._displayLoading(!0,n);let e=await bs.lX.disapproveRule(t);this._displayLoading(!1),e?o():r()}catch(s){this._displayLoading(!1),r(),i.ZP.ui.toasts.showError(s)}}))}))}async _rollbackRule(t){let e=t.target.closest('a[data-role="rollback"]');if(!e)return;t.preventDefault();let s=e.closest(".tm-rule");try{await this._showRollbackRuleConfirm(s.dataset.id,s.dataset.from,s.dataset.to)}catch(n){return}let i=this.els.approvedRulesList;i.removeChild(s),i.childElementCount||i.hasAttribute("data-has-more")||(i.dataset.notFound="")}_showRollbackRuleConfirm(t,e,s,n=null){return new Promise(((o,r)=>{pt.g.confirmModal({content:`\n\t\t\t\t\t<p>\n\t\t\t\t\t\t${i.ZP.i18n("page-tags-merge.confirmation.rollback-rule.start")} \n\t\t\t\t\t\t<span class="tm-tag"><span class="tm-tag__name">${e}</span></span>\n\t\t\t\t\t\t${i.ZP.i18n("page-tags-merge.confirmation.rollback-rule.middle")} \n\t\t\t\t\t\t<span class="tm-tag"><span class="tm-tag__name">${s}</span></span>\n\t\t\t\t\t\t${i.ZP.i18n("page-tags-merge.confirmation.rollback-rule.end")} ?\n\t\t\t\t\t</p>\n\t\t\t\t`,header:i.ZP.i18n("page-tags-merge.confirmation.rollback-rule.header"),indent:!0,buttonsAlign:"left",buttons:[[i.ZP.i18n("page-tags-merge.confirmation.yes"),"green",!0],[i.ZP.i18n("page-tags-merge.confirmation.no"),"gray",!1]]}).then((async e=>{if(e)try{this._displayLoading(!0,n);let e=await bs.lX.rollbackRule(t);this._displayLoading(!1),e?o():r()}catch(s){this._displayLoading(!1),r(),i.ZP.ui.toasts.showError(s)}}))}))}_quantityBalloonShow(t){t.preventDefault();let e=this._selectedOption;if(e&&e.classList.contains("tm-quantity-baloon__option_custom")){let t=e.querySelector('input[name="quantity"]'),s=e.querySelector('input[name="custom-quantity"]');if(!s.value){let e=this._quantityRadioElements.find((t=>Number(t.value)===this._storiesQuantityNumber));e?this._checkOptionByRadioEl(e):(s.value=this._storiesQuantityNumber,this._checkOptionByRadioEl(t))}}this._storiesQuantityBaloon.show()}_initQuantityPicker(){let t=r.Zv.fragment('<form class="tm-quantity-baloon">\n\x3c!--<div class="tm-quantity-baloon">--\x3e\n\t<p class="tm-quantity-baloon__option tm-quantity-baloon__option_default">\n\t\t<label><input checked type="radio" name="quantity" value="30"> 30</label>\n\t</p>\n\t<p class="tm-quantity-baloon__option">\n\t\t<label><input type="radio" name="quantity" value="50"> 50</label>\n\t</p>\n\t<p class="tm-quantity-baloon__option">\n\t\t<label><input type="radio" name="quantity" value="100"> 100</label>\n\t</p>\n\t<hr>\n\t<p class="tm-quantity-baloon__option tm-quantity-baloon__option_custom">\n\t\t<label><input type="radio" name="quantity" value="custom-quantity"></label>\n\t\t<input tabindex="-1" type="text" name="custom-quantity" placeholder="Ваш вариант">\n\t</p>\n\x3c!--</div>--\x3e\n</form>\n').firstElementChild;this._storiesQuantityBaloon=new k._({target:this.els.storiesQuantityButton,indent:!0,direction:k.Lh.START,alignment:k.SE.END,content:t}),this._quantityRadioElements=Array.from(t.querySelectorAll('input[type="radio"]')),this._quantityRadios=new Map,this._quantityRadioElements.forEach((t=>{let e=new $r.Z({el:t});this._quantityRadios.set(t,e)}));let e=t.querySelector(".tm-quantity-baloon__option_custom"),s=e.querySelector('input[name="custom-quantity"]');t.addEventListener("submit",(t=>{t.preventDefault(),this._storiesQuantityBaloon.hide()})),t.addEventListener("change",(t=>{let i=t.target.closest(".tm-quantity-baloon__option"),n=i.querySelector('input[name="quantity"]');if(i.classList.contains("tm-quantity-baloon__option_custom"))return s.focus(),void(this._selectedOption=e);this._storiesQuantityBaloon.hide(),this._selectedOption=i,this._storiesQuantityNumber=n.value,this.els.storiesQuantityNumber.innerText=n.value})),s.addEventListener("focus",this._updateQuantityNumberByCustom.bind(this));let i=Kr.debounce(this._updateQuantityNumberByCustom.bind(this),500);s.addEventListener("input",i)}_updateQuantityNumberByCustom(t){let e=t.target,s=e.value,i=this._quantityRadioElements.find((t=>"custom-quantity"===t.value));this._quantityRadios.get(i).checked||this._checkOptionByRadioEl(i),this._selectedOption=e.closest(".tm-quantity-baloon__option"),/^\d+$/.test(s)&&(this._storiesQuantityNumber=e.value,this.els.storiesQuantityNumber.innerText=e.value)}_checkOptionByRadioEl(t){this._quantityRadioElements.forEach((e=>{let s=this._quantityRadios.get(e);e===t?(s.$els.input.prop("checked",!0).change(),s.checked=!0):s.checked=!1}))}async _handleBanTagSubmit(t){if(t.preventDefault(),!(await this._bannedAddForm.checkValidity()))return;let e=this._bannedAddInput.value,s=(this._bannedAddInput.suggestion.tags.get(e.toLowerCase()),`\n\t\t\t<p>\n\t\t\t\t${i.ZP.i18n("page-tags-merge.confirmation.ban-tag.start")} \n\t\t\t\t<span class="tm-tag__name">${e}</span> ?\n\t\t\t</p>\n\t\t`);pt.g.confirmModal({content:s,header:i.ZP.i18n("page-tags-merge.confirmation.ban-tag.header"),indent:!0,buttonsAlign:"left",buttons:[[i.ZP.i18n("page-tags-merge.confirmation.yes"),Bs.j.SUCCESS,!0],[i.ZP.i18n("page-tags-merge.confirmation.no")]]}).then((async t=>{if(t)try{if(await bs.lX.banTag(e)){this._bannedAddInput.value="",this._bannedSearchInput.value=e;let t=await bs.Hx.getBannedByName(0,e);this.els.bannedSearchForm.dataset.lastSearch=e,this._updateBadTagsList(t,!0)}}catch(s){i.ZP.ui.toasts.showError(s)}}))}_handleFoundTagClick(t){if(t.target.closest(".tm-tag__counter"))return;t.preventDefault();let e=t.target.closest(".tm-tag"),s=e.dataset.name,i=e.dataset.count,o=Array.from(this.els.mergeProposalForm.elements).filter((t=>"from"===t.dataset.role)),r=o.find((t=>t.value===s));if(r)return void r.focus();let a=o.pop(),l=this._handleFromProposalInputs(a);this._UIInputsByInputs.get(l).suggestion.addTag(s,i),n.u1.closestUIElement(l).toggleClearButton(!0),this._addTagCount(l,s,i),l.value=s,l.focus()}async _handleProposalSubmit(t){t.preventDefault(),await this._mergeProposalForm.checkValidity()&&await this._proposeNewRules()}async _proposeNewRules(){this._displayLoading(!0,this.$els.mergeProposalFormButton);let t=Array.from(this.els.mergeProposalForm.elements),e=t.filter((t=>"from"===t.dataset.role));e.pop();let s=e.map((t=>t.value)).filter((t=>t.length)),n=t.find((t=>"to"===t.dataset.role)).value;try{let t=await bs.lX.validateSuggestion(s,n);if(""!==t.message||t.issues.length>0)return this._displayLoading(!1),void this._displayConflicts(t)}catch(o){return this._displayLoading(!1),void i.ZP.ui.toasts.add({theme:v.K.RED,content:o.message?o.message:o})}try{let{rules:t}=await bs.lX.sendSuggestion(s,n);this._displayLoading(!1),i.ZP.ui.toasts.add({content:i.ZP.i18n("page-tags-merge.proposal-form.messages.merged")}),this._insertIntoRulesList(t,!1,!1,!0),this._resetProposalInputs()}catch(o){this._displayLoading(!1),i.ZP.ui.toasts.showError(o)}}_initConflicts(){this.$els.conflictsBackButton.click((()=>{this.$els.conflicts.slideUp(200),this.$els.mergeProposalForm.slideDown(200)})),this.$els.conflictsApplyButton.toggle(this._data.isModerator),this.$els.conflictsApplyButton.click((async()=>{this.$els.conflicts.slideUp(200),this.$els.mergeProposalForm.slideDown(200,(async()=>{await this._proposeNewRules()}))})),this.$els.conflictsBody.on("click",'button[data-role="cancel"]',(async t=>{let e=Zr(t.target).closest("button"),s="true"===e.attr("data-is-approved");try{s?await this._showRollbackRuleConfirm(parseInt(String(e.attr("data-id"))),String(e.attr("data-tag-from")),String(e.attr("data-tag-to")),e):await this._showDisapproveRuleConfirm(parseInt(String(e.attr("data-id"))),String(e.attr("data-tag-from")),String(e.attr("data-tag-to")),e)}catch(i){return}e.closest(".tm-conflicts__issue").remove(),this._updateConflictsApplyButtonState()})),this.$els.conflictsBody.on("click",'button[data-role="cancel-rejection"]',(async t=>{let e=Zr(t.target).closest("button");try{this._displayLoading(!0,e),await bs.lX.cancelRejection(String(e.attr("data-tag-from")),String(e.attr("data-tag-to"))),this._displayLoading(!1)}catch(s){return this._displayLoading(!1),void i.ZP.ui.toasts.showError(s)}e.closest(".tm-conflicts__issue").remove(),this._updateConflictsApplyButtonState()})),this.$els.conflictsBody.on("click",'button[data-role="remerge"]',(async t=>{let e=Zr(t.target).closest("button");if(!("true"===e.attr("data-is-approved")))return;let s=Array.from(this.els.mergeProposalForm.elements).find((t=>"to"===t.dataset.role));try{this._displayLoading(!0,e),await bs.lX.remergeRule(String(e.attr("data-id")),s.value),this._displayLoading(!1)}catch(n){return this._displayLoading(!1),void i.ZP.ui.toasts.showError(n)}e.closest(".tm-conflicts__issue").remove(),this._updateConflictsApplyButtonState()}))}_updateConflictsApplyButtonState(){0===this.$els.conflictsBody.find(".tm-conflicts__issue").length&&(this.$els.conflictsApplyButton.prop("disabled",!1),this.$els.conflictsMessage.removeClass("section_red").addClass("section_green").text(i.ZP.i18n("page-tags-merge.conflicts.empty")))}_displayConflicts(t){this.$els.conflictsMessage.removeClass("section_green").addClass("section_red").text(t.issues.length>0?i.ZP.i18n("page-tags-merge.conflicts.has-issues"):t.message),this.$els.conflictsApplyButton.prop("disabled",!0);let e=this._data.isModerator,s="",n={canceled:Lr,"exists-not-approved":Ur,"exists-from":Vr,"exists-to":qr,"not-found":Gr,rejected:zr},o=new Map(t.count);for(let i of t.issues)n[i.type]&&(s+=n[i.type]({isModerator:e,ruleId:i.rule_id||0,tag1:i.tag1,count1:o.get((i.tag1||"").toLowerCase())||"",tag2:i.tag2,count2:o.get((i.tag2||"").toLowerCase())||""}));this.$els.conflictsBody.html(s),this.$els.mergeProposalForm.slideUp(200),this.$els.conflicts.slideDown(200)}_handleProposalFocus(t){t.preventDefault();let e=t.target.closest('input[data-role="from"]');e&&this._handleFromProposalInputs(e)}_handleFromProposalInputs(t){let e=Array.from(this.els.mergeProposalForm.elements).filter((t=>"from"===t.dataset.role));if(t!==e[e.length-1])return;e.pop();let s=e.filter((t=>""===t.value));if(s.length)return s[0].focus(),s[0];let i=t.parentElement.parentElement;i.insertAdjacentHTML("beforeEnd",'<a data-role="remove" role="button"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon--ui__close icon--ui__close_table-row"><use xlink:href="#icon--ui__close"></use></svg></a>\n'),delete i.dataset.novalidate,t.removeAttribute("tabindex");let n=r.Zv.fragment('<div class="merge-proposal__input input" data-novalidate="novalidate" data-role="from">\n\t<span class="input__box">\n\t\t<input data-role="from" class="input__input" type="text" placeholder="Добавить тег">\n\t</span>\n\t\x3c!--<a data-role="remove" role="button"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon--ui__close"><use xlink:href="#icon--ui__close"></use></svg></a>--\x3e\n</div>\n');return this._initProposalInput(n.firstElementChild),n.querySelector("input").setAttribute("tabindex",-1),this.els.fromProposalContainer.appendChild(n),t}_handleProposalRemove(t){t.preventDefault();let e=t.target.closest('a[data-role="remove"]');if(!e)return;let s=e.parentElement;s.classList.contains("merge-proposal__input")&&this._removeProposalInput(s)}_removeProposalInput(t){let e=t.querySelector("input"),s=this._UIInputsByInputs.get(e);s.emit("destroy",s),this._UIInputsByInputs.delete(e);let i=t.parentElement;i.removeChild(t),i.childElementCount||i.hasAttribute("data-has-more")||(i.dataset.notFound="")}async _initProposalInputs(){let t=Array.from(document.querySelectorAll(".merge-proposal__input"));for(let e of t)this._initProposalInput(e)}_initProposalInput(t){let e=t.querySelector("input"),s=new T.u3({el:t,validationHint:{direction:k.Lh.TOP,alignment:k.SE.CENTER},suggestion:new Pr});this._UIInputsByInputs.set(e,s),"to"===e.dataset.count?s.validationRules={"page-tags-merge.proposal-form.non-existent-tag":e=>{let i=s.suggestion.tags.has(e.toLowerCase());return t.dataset.novalidate||i}}:s.validationRules={"page-tags-merge.proposal-form.non-existent-tag":e=>{let i=0,n=s.suggestion.tags.has(e.toLowerCase());if(!e.length){for(let t of this._UIInputsByInputs)"to"!==t[0].dataset.role&&t[0].value&&i++;return i>0}return t.dataset.novalidate||n}},this._mergeProposalForm.add(s),this.listenTo(s.suggestion,xr.n.SELECT,(t=>{s.suggestion.hide(),t&&t.data&&t.data.name&&(s.value=t.data.name),this._addTagCount(s,t.data.name,t.data.count)})),this.listenTo(s.suggestion,xr.n.SEARCH_START,(()=>{this._deleteTagCount(s)})),this.listenTo(s,"change",(()=>{this._deleteTagCount(s)})),e.disabled=!1}_addTagCount(t,e,s){let i=Zr(`<a target="_blank" href="tag/${encodeURIComponent(e)}" class="merge-proposal__count">\n\t\t\t\t\t\t${s}\n\t\t\t\t\t\t</a>`);i.click((t=>{t.stopPropagation()})),t instanceof n.u1||(t=n.u1.closestUIElement(t)),t.$els.input.after(i)}_deleteTagCount(t){let e;t instanceof n.u1||(t=n.u1.closestUIElement(t)),e=t.$els.input.next(".merge-proposal__count"),e.length&&e.remove()}_resetProposalInputs(){let t=0;Zr(".merge-proposal__input").each(((e,s)=>{let i=Zr(s);i.find("input").val(""),this._deleteTagCount(i),"to"!==i.data("role")&&(++t<=2?i.find('[data-role="remove"]').remove():this._removeProposalInput(s))}))}_initTagsSearchPagination(t){this._tagsSearchPagination&&(delete this._tagsSearchPagination,this.els.paginationContainer.firstElementChild&&this.els.paginationContainer.removeChild(this.els.paginationContainer.firstElementChild)),!t||t<2||(this._tagsSearchPagination=new Ar.S({currentPage:1,endPage:t}),this.els.paginationContainer.appendChild(this._tagsSearchPagination.show().el),this.listenTo(this._tagsSearchPagination,"change",this._handlePageChange))}_handlePageChange(t){this._searchTags(this._lastSearch,null,t-1,!0)}async _handleSearchSubmit(t){t.preventDefault();let e=this._lastSearch,s=this._tagsSearchInput.value;this._lastSearch=this._tagsSearchInput.value;let i=Number(this.els.tagsSearchForm.dataset.lastQuantity);this.els.tagsSearchForm.dataset.lastQuantity=this._storiesQuantityNumber,e===s&&this._storiesQuantityNumber===i||this._searchTags(s,this._storiesQuantityNumber)}async _searchTags(t="",e=0,s=0,n=!1){if(this.els.tagsFoundList.innerHTML="",""===t)return this.els.tagsFoundList.dataset.type="empty",void this._initTagsSearchPagination();this.els.tagsFoundList.dataset.type="";try{let{tags:i,total:o}=await bs.Hx.getListByName(t,e,s);if(o=Number(o),i.length&&o&&o>0){n||this._initTagsSearchPagination(Math.ceil(o/i.length));let t=document.createDocumentFragment();for(let e of i){let s=Xr._constructTag(...e);t.appendChild(s)}this.els.tagsFoundList.appendChild(t)}else this._initTagsSearchPagination(),this.els.tagsFoundList.dataset.type="not-found"}catch(o){i.ZP.ui.toasts.showError(o),this.els.tagsFoundList.dataset.type="empty"}}_displayLoading(t,e=null){this.$el.toggleClass("tags-merge_loading",t),null!==this._loadingButton.$button&&(this._loadingButton.$button=null,this._loadingButton.button.progress=!1,this._loadingButton.button=null),t&&e&&(this._loadingButton.$button=e,this._loadingButton.button=new st.y3(e),this._loadingButton.button.progress=!0)}static _constructTag(t,e){if(!t||!e)return;let s=function(t){var e="",s=Nr.escape;return e+'<div class="tm-tag tm-tag_search" data-name="'+s(t.name)+'" data-count="'+s(t.count)+'">\n\t<a class="tm-tag__name" href="javascript: void(0)">'+s(t.name)+'</a>\n\t<a class="tm-tag__counter" href="'+s("/tag/"+encodeURIComponent(t.name))+'" target="_blank"><b>'+s(t.count)+"</b></a>\n</div>"}({name:t,count:e});return r.Zv.fragment(s).firstElementChild}static _constructBannedTag(t,e){if(!t||!e)throw new Error("Banned tag name or count was not specified");let s=function(t){var e="",s=Rr.escape;return e+'<div class="tm-tag tm-tag_banned" data-name="'+s(t.name)+'" data-count="'+s(t.count)+'">\n\t<a class="tm-tag__name" href="javascript: void(0)">'+s(t.name)+'</a>\n\t<a class="tm-tag__counter" href="'+s("/tag/"+encodeURIComponent(t.name))+'" target="_blank"><b>'+s(t.count)+'</b></a>\n\t<div class="tm-tag__buttons">\n\t\t<a title="'+s(t.tagActions.unban)+'" class="tm-tag__btn" data-role="unban" role="button"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon--ui__close icon--ui__close_remove-tag-merge"><use xlink:href="#icon--ui__close"></use></svg></a>\n\t</div>\n</div>'}({name:t,count:e,tagActions:{unban:i.ZP.i18n("page-tags-merge.tag-actions.unban")}});return r.Zv.fragment(s).firstElementChild}static _constructRule(t,e,s){if(!t)throw new Error("Rule was not specified");Object.assign(t,{isModerator:s,isApproved:e,ruleActions:{rollback:i.ZP.i18n("page-tags-merge.rule-actions.rollback"),approve:i.ZP.i18n("page-tags-merge.rule-actions.approve"),disapprove:i.ZP.i18n("page-tags-merge.rule-actions.disapprove")}});let n=function(t){var e="",s=Mr.escape;return Array.prototype.join,e+='<div class="tm-rule '+s(t.isApproved?"tm-rule_approved":"tm-rule_non-approved")+'" data-id="'+s(t.id)+'" data-from="'+s(t.from)+'" data-to="'+s(t.to)+'">\n\t<div class="tm-rule__tags-container">\n\t\t<a\n\t\t\tclass="tm-tag"\n\t\t\thref="'+s("/tag/"+t.from)+s(t.isApproved?"?is_merged_tag=1":"")+'"\n\t\t\ttarget="_blank">\n\t\t\t<span class="tm-tag__name">'+s(t.from)+"</span>\n\t\t\t",t.fromCount&&(e+='\n\t\t\t<span class="tm-tag__counter"><b>'+s(t.fromCount)+"</b></span>\n\t\t\t"),e+='\n\t\t</a>\n\t\t<span class="tm-rule__arrow">&#10140;</span>\n\t\t<a class="tm-tag" href="'+s("/tag/"+t.to)+'" target="_blank">\n\t\t\t<span class="tm-tag__name">'+s(t.to)+'</span>\n\t\t\t<span class="tm-tag__counter"><b>'+s(t.toCount)+"</b></span>\n\t\t</a>\n\t</div>\n\t",t.isModerator&&(e+="\n\t",t.isApproved?e+='\n\t<div class="tm-rule__user user">\n\t\t<div class="user__info">\n\t\t\t<div class="user__info-item">\n\t\t\t\t<a href="'+s("/@"+t.offerer)+'" class="user__nick">'+s(t.offerer)+'</a>\n\t\t\t</div>\n\t\t</div>\n\t</div>\n\t<div class="tm-rule__buttons">\n\t\t<a title="'+s(t.ruleActions.rollback)+'" class="tm-rule__btn" data-role="rollback" role="button"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon--ui__close icon--ui__close_remove-tag-merge"><use xlink:href="#icon--ui__close"></use></svg></a>\n\t</div>\n\t':e+='\n\t<div class="tm-rule__user user">\n\t\t<div class="user__info">\n\t\t\t<div class="user__info-item">\n\t\t\t\t<a href="'+s("/@"+t.offerer)+'" class="user__nick">'+s(t.offerer)+'</a>\n\t\t\t</div>\n\t\t</div>\n\t</div>\n\t<div class="tm-rule__buttons">\n\t\t<a title="'+s(t.ruleActions.approve)+'" class="tm-rule__btn" data-role="approve" role="button"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon--ui__success icon--ui__success_approve-merge"><use xlink:href="#icon--ui__success"></use></svg></a>\n\t\t<a title="'+s(t.ruleActions.disapprove)+'" class="tm-rule__btn" data-role="disapprove" role="button"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon--ui__close icon--ui__close_remove-tag-merge"><use xlink:href="#icon--ui__close"></use></svg></a>\n\t</div>\n\t',e+="\n\t"),e+="\n</div>\n"}(t);return r.Zv.fragment(n).firstElementChild}}s(4944);function Qr(t,e,s){return e in t?Object.defineProperty(t,e,{value:s,enumerable:!0,configurable:!0,writable:!0}):t[e]=s,t}class Jr extends Fs.T3{constructor(...t){super(...t),Qr(this,"unreadClass",".comments__container_highlight_yellow"),Qr(this,"blocks",new Map),Qr(this,"blocksObserver",new IntersectionObserver(this.blocksObserverCallback.bind(this),{rootMargin:"300px 0px"}))}isMarkAsReadObserverStrategy(){return u.SUPPORT_TECH_USER_ID!==i.vE.initParams.userID}initMarkAsReadStrategy(){this.isMarkAsReadObserverStrategy()?this.initMarkAsReadObserver():this.initMarkAsReadOnClick()}getLastBlock(t){return t.children().last()[0]}observeBlock(t,e){t&&(this.blocks.set(t,e),this.blocksObserver.observe(t))}unobserveBlock(t){t&&(this.blocksObserver.unobserve(t),this.blocks.delete(t))}initMarkAsReadOnClick(){this.$el&&this.$el.on("click",".comments__container_highlight_yellow",(async t=>{const e=t.currentTarget.parentElement;if(!e)return;const s=e.dataset.commentId?Number(e.dataset.commentId):void 0;if(!s)return;await ui.z.markAsRead([s])&&(t.currentTarget.classList.remove(this.unreadClass.slice(1)),this.updateUnreadCounter([s]))}))}updateUnreadCounter(t){const e=ee()('.bell[data-role="answers"]');let s=parseInt(e.text(),10);if(e.length&&99!==s){s-=t.length,e.text(s).toggle(s>0),this.$els&&s<=0&&this.$els.markAll.remove();const i=ee()(".avatar__notifications");i.length&&s<=0&&i.remove()}}getAnswerIds(t){return t.map((t=>{var e,s;return parseInt(null!==(e=null===(s=t.el)||void 0===s?void 0:s.dataset.commentId)&&void 0!==e?e:"0")})).filter((t=>t>0))}prepareIds(t,e=[]){const s=[...t,...e],i=Math.min(...s);return{excludeIds:s.map((t=>t-i)),baseId:i}}blocksObserverCallback(t){for(const{target:e,isIntersecting:s}of t){const t=e,i=this.blocks.get(t);i&&(s?(i.forEach((t=>t.show())),t.style.removeProperty("height"),this.togglePlayers(t,s)):(t.style.height=`${t.offsetHeight}px`,this.togglePlayers(t,s),i.forEach((t=>t.hide()))))}}togglePlayers(t,e){ee()(t).find('.player[data-type="gifx"]').each(((t,s)=>{const i=ee()(s).data("player");i&&i.togglePlay(!!e&&i.playAfterInitialization)}))}}const ta=[...Array(10).keys()].map((t=>(t+1)/10));var ea=s(2925),sa=s(2154),ia=s(5997),na=s(7323),oa=s(8553),ra=s(7770),aa=s(3479);var la=s(5924),ha=s(5595),ca=s(6099);function da(t,e){var s=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),s.push.apply(s,i)}return s}function ua(t){for(var e=1;e<arguments.length;e++){var s=null!=arguments[e]?arguments[e]:{};e%2?da(Object(s),!0).forEach((function(e){pa(t,e,s[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(s)):da(Object(s)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(s,e))}))}return t}function pa(t,e,s){return e in t?Object.defineProperty(t,e,{value:s,enumerable:!0,configurable:!0,writable:!0}):t[e]=s,t}const ma=s(9755),_a=s(6419),ga=s(381),va=/ data-indent="(\d+)"/;class fa extends ea.K5{constructor(t,e){super(t,e),this._onDragFilesBound=this._onDragFiles.bind(this),this._onDropFilesBound=this._onDropFiles.bind(this)}destroy(){super.destroy()}render(){if(this.isRendered)return this;let t=[this.comment.ignoreType,this.comment.comments.ignoreType],e=_a.contains(t,ea.IV.COMMUNITY_IGNORES_YOU),s=_a.contains(t,ea.IV.AUTHOR_OF_COMMENT_IGNORES_YOU),o=_a.contains(t,ea.IV.AUTHOR_OF_STORY_IGNORES_YOU),r=i.vE.isUserModerator&&(this.comment.isModeratorAutoSelect||e),l=[],h="create"===this.replyType&&this.comment.isMain&&this.comment.comments.hasClientMentions;s&&l.push(this.comment.userName),o&&l.push(this.comment.comments.storyUserName),l=_a.uniq(l),l.length&&(this._options.noteHidden=i.vE.i18n("comments.hidden.reply-note-"+(l.length>1?"plural":"single"),c.cQ.formatUsernamesList(l))),this.comment.hasParent||(this._menuItems.push({action:"comstory",text:i.vE.i18n("comments.reply-menu.comstory")}),this._hint=new k._({content:ma(document.createElement("div")).addClass("popup__hint").append(i.vE.i18n("comments.compost-hint")),direction:k.Lh.BOTTOM,autoCloseOutsideClick:!1,destroyAfterHide:!1,autoCorrectPosition:!1})),this.$el=ma(document.createElement("div")).addClass("comment-reply").append(function(t){var e,s="";return Array.prototype.join,s+='<form method="POST" action="javascript:void 0;">\n\t<div class="comment-reply__wrapper">\n\t\t<div class="input input_editor input_comment-reply">\n\t\t\t<div class="input__input"\n\t\t\t\t data-name="desc"\n\t\t\t\t contenteditable="true"\n\t\t\t\t title=""\n\t\t\t\t data-placeholder="'+(null==(e=t.isMain?"Введите текст комментария":"Введите текст ответа")?"":e)+'">\n\t\t\t\t<p><br></p>\n\t\t\t</div>\n\t\t</div>\n\t\t<div class="comment-reply__thumbs"></div>\n\t\t',null!==t.slowModeText&&(s+='\n\t\t\t<div class="comment-reply__slow-mode-text" style="display: none">\n\t\t\t\t'+(null==(e=t.slowModeText)?"":e)+"\n\t\t\t</div>\n\t\t"),s+="\n\t\t",null!==t.canUserCommentMessage&&(s+='\n\t\t\t<div class="comment-reply__slow-mode-text">\n\t\t\t\t'+(null==(e=t.canUserCommentMessage)?"":e)+"\n\t\t\t</div>\n\t\t"),s+='\n\t</div>\n\t<div class="comment-reply__feedback-offer"></div>\n\t<ul class="comment-reply__controls">\n\t\t',t.noteHidden&&(s+='\n\t\t<li class="comment-reply__note">\n\t\t\t'+(null==(e=t.noteHidden)?"":e)+"\n\t\t</li>\n\t\t"),s+="\n\t\t<li>\n\t\t\t",t.menu?s+='\n\t\t\t\t<span class="button-group button-group_success button-group_small">\n\t\t\t\t\t<button type="submit">Отправить</button><button data-action="menu" type="button" class="button_dot"></button>\n\t\t\t\t</span>\n\t\t\t':s+='\n\t\t\t\t<button type="submit" class="button_small">Отправить</button>\n\t\t\t',s+="\n\t\t</li>\n\t\t",t.accessImage&&(s+='\n\t\t<li>\n\t\t\t<div class="comment-reply__attach-files attach">\n\t\t\t\t<svg xmlns="http://www.w3.org/2000/svg" class="icon icon--ui__photo icon--ui__photo_comment-reply"><use xlink:href="#icon--ui__photo"></use></svg>\n\t\t\t\t<input type="file" name="files0" accept="image/*" multiple="">\n\t\t\t</div>\n\t\t</li>\n\t\t'),s+="\n\t\t",t.showIsOfficialCheckbox&&(s+='\n\t\t\t<li><label><input type="checkbox" data-to-boolean="true" name="is_official"'+(null==(e=t.isOfficial?' checked="checked"':"")?"":e)+' class="checkbox checkbox_switch">Официальный ответ</label></li>\n\t\t'),s+="\n\t\t",t.moderation.is&&(s+='\n\t\t<li><label><input type="checkbox" data-to-boolean="true" name="by_moderator"'+(null==(e=t.moderation.autoSelect?' checked="checked"':"")?"":e)+(null==(e=t.moderation.changeable?"":" disabled")?"":e)+' class="checkbox checkbox_switch"><span class="user user_inline"><span class="user__nick">moderator</span></span></label></li>\n\t\t'),s+="\n\t\t",(t.moderation.is||t.hasLinkedUsers)&&(s+='\n\t\t<li><span class="comment-reply__by-user-caption">От аккаунта:</span> <span class="comment-reply__user-name">moderator</span></li>\n\t\t'),s+='\n\t\t<li class="comment-reply__draft-date"></li>\n\t\t<li class="comment-reply__error"></li>\n\t</ul>\n</form>\n'}({plainText:!1,accessImage:!0,noteHidden:this._options.noteHidden,menu:Boolean(this._menuItems.length),showIsOfficialCheckbox:h,isOfficial:this.comment.isOfficial,moderation:{is:i.vE.isUserModerator,autoSelect:r,changeable:!this.comment.isEditable&&!e},hasLinkedUsers:Boolean(i.vE.initParams.linkedUsers),slowModeText:i.vE.initParams.isSlowModeEnabled?i.vE.initParams.slowModeText:null,canUserCommentMessage:i.vE.initParams.canUserComment?null:i.vE.initParams.canUserCommentMessage,isMain:this.comment.isMain})),this.$els={form:this.$("form"),thumbs:this.$(".comment-reply__thumbs"),controls:this.$(".comment-reply__controls"),attach:this.$(".comment-reply__attach-files").on("click",(()=>{this.$els.attach.hasClass("comment-reply__attach-files_disabled")||this.$els.input.click()})),input:this.$(".comment-reply__attach-files > input"),noteHidden:this.$(".comment-reply__note"),submit:this.$('button[type="submit"]'),menuButton:this.$('button[data-action="menu"]'),buttonGroup:this.$(".button-group"),draftDate:this.$(".comment-reply__draft-date"),feedbackOffer:this.$(".comment-reply__feedback-offer")},this._submitButton=new st.y3({$el:this.$els.submit,theme:this.comment.isModeratorAutoSelect?st.jM.DARK:st.jM.SUCCESS,animationName:"comment-send",animationIndent:3}),this._feedbackOffer=new aa.t({$el:this.$els.feedbackOffer,cssModifiers:["comments"]}),this.$els.menuButton.length&&(this._menuButton=new st.y3(this.$els.menuButton),this.listenTo(this._menuButton,"click",(()=>this._menu.toggle())),this._hint&&(this._hint.target=this.$els.menuButton,this.listenToOnce(this._menuButton,"click",(()=>{this._hint.hide(),this.isComPostHintEnabled=!1})))),this._form=new a.x(this.$els.form),this.listenTo(this._form,"submit",this._onSubmit);const d=this.$(".comment-reply__user-name");if(d.length>0&&d.text(this.byModerator?"moderator":i.vE.initParams.userName),this._editor=new sa.Y({$el:this.$(".input"),submitHotkey:"cmd+enter",suggestion:new C.xI,canAddAnchor:!1}),this._hint&&this.listenTo(this._editor,"resize",(()=>{this._hint.updatePosition()})),this._editor._hotkeys.on("backspace",(t=>{this._editor.isEmpty&&(t.preventDefault(),t.stopPropagation())}),{type:it.FM.KEYDOWN}),this.listenToOnce(this._editor,"focus",(()=>{this._editor.suggestion.setPredefinedUsersInStory(this.storyId,u.PREDEFINED_USERS_TYPE.COMMENT)})),this.listenTo(this._editor,"escape",(()=>{this.comment.id&&(this.comment.isReplyShown=!1)})),i.vE.isUserModerator){const t=n.u1.closestUIElement(this.$els.form.find('input[type="checkbox"][name="by_moderator"]'));this.listenTo(t,"change",(t=>{this.byModerator=t,d.text(t?"moderator":i.vE.initParams.userName)})),this.byModerator=r}this._isOfficialCheckbox=n.u1.closestUIElement(this.$els.form.find('input[type="checkbox"][name="is_official"]')),this.listenTo(this,n.eM.UNMOUNTED,(()=>{"create"===this.comment.currentReplyMode&&(this.comment.savedReplyText=this.comment.reply._editor.value)})),this._thumbs=new na.c({limit:10,limitImageBytes:i.vE.initParams.maxImageFileSize||12582912,storageId:`comment_${this.comment.id}`}),this._thumbs.appendTo(this.$els.thumbs).show(),this.listenTo(i.vE.ui,"paste-image",((t,e)=>{this._editor.focused&&(e.preventDefault(),e.stopPropagation(),this._thumbs.add(t))})),this.listenTo(this._thumbs,"load-video-data",(t=>{this._submitButton.disabled=t,this._submitButton.progress=t})),this.listenTo(this._thumbs,"update",(t=>{let e=t>=this._thumbs.limit;this.$els.thumbs.toggleClass("comment-reply__thumbs_show",t>0),this.$els.attach.toggleClass("comment-reply__attach-files_disabled",e),e?this._hintImageLimit||(this._hintImageLimit=new k.gR({target:this.$els.attach,destroyAfterHide:!1,content:ma(document.createElement("div")).addClass("popup__hint").append(i.vE.i18n("comments.reply.image-limit",this._thumbs.limit))})):this._hintImageLimit&&this._hintImageLimit.destroy()})),this.listenTo(this._thumbs,"failed-to-add",(t=>{t.forEach((t=>{switch(t.type){case ra.O.COUNT_LIMIT:i.vE.ui.toasts.showError(i.vE.i18n("image-thumbs.errors.exceed-max-count",t.limits));break;case ra.O.SIZE_LIMIT:i.vE.ui.toasts.showError(i.vE.i18n("image-thumbs.errors.exceed-size",t.file,Math.floor(t.limits/1048576)));break;case ra.O.MIME_LIMIT:i.vE.ui.toasts.showError(i.vE.i18n("image-thumbs.errors.wrong-mime",t.file,t.limits.join(", ")));break;default:i.vE.ui.toasts.showError("image-thumbs.errors.failed-to-add")}}))})),this.listenTo(i.vE.ui,"dnd",(t=>{this.$el.toggleClass("comment-reply_drag",t),t?this.$el.on({"dragenter dragleave":this._onDragFilesBound,drop:this._onDropFilesBound}):this.$el.off("dragenter dragleave drop")})),this.listenTo(this._editor,"input",_a.debounce(this._onMediaUrlInput.bind(this),500)),this.listenTo(this._editor,"paste",this._onMediaUrlInput.bind(this)),this.listenTo(this._editor,"paste",this.displayComPostHint),this.listenTo(this._editor,"input",this.displayComPostHint),this.listenTo(this._editor,"paste",this.detectOffensive),this.listenTo(this._editor,"input",this.detectOffensive),this.listenTo(this._editor,"paste",this.detectModerators),this.listenTo(this._editor,"input",this.detectModerators),this.listenTo(this._editor.suggestion,n.eM.HIDDEN,this.detectModerators);const p=()=>this.emit("change");return this.listenTo(this._editor,"change",p),this.listenTo(this._thumbs,"update",p),this._initInputTextCorrector(),this.on("change",this.autoSaveDraft),this.on("change",this.checkMentions),this.on("change",(()=>this.isSaved=!1)),this.$els.input.on("click",(t=>t.stopPropagation())).on("change",(t=>{let e=ge.nO.File.getFiles(t);this.$els.input.val(""),this._thumbs.add(e)})),this.listenTo(this,"lock-editing",(()=>{this.isShown&&i.vE.ui.toasts.showError("comments.errors.lock-editing"),this._submitButton.disabled=!0})),this.hasCommentLimitBeenReached||this.getDraft().then((t=>this.renderDraft(t))),super.render(),this}focus(){return this._editor.focus(),this}paste(t){return this._editor.focus(),this._editor.paste(t),this}async _setDraftSaveDate(t){const e=this.$els.draftDate,s="comment-reply__draft-date_animate-in",o="comment-reply__draft-date_animate-out",r=t?i.vE.i18n("comments.draft.saved",ga.unix(t).format("HH:mm")):"";e.removeClass(s+" "+o).addClass(t?s:o),t||await c.cQ.delay(200);const a=n.u1.getUIElement(e);a&&(a.content=r),e.attr("aria-label",r).text(r).toggleClass("hint",c.cQ.isOverflowed(e[0]))}_onDragFiles(t){this.$el.toggleClass("comment-reply_drop","dragenter"===t.type)}_onDropFiles(t){if(t.stopPropagation(),t.preventDefault(),this.$el.toggleClass("comment-reply_drop",!1),!t.originalEvent.dataTransfer||!t.originalEvent.dataTransfer.files)return;let e=t.originalEvent.dataTransfer.files,s=[];for(let i=0;i<e.length;i++)-1!==e[i].type.indexOf("image")&&s.push(e[i]);s.length&&this._thumbs.add(s)}mount(){return this.isMounted||(super.mount(),this.isCommentEditMode||(this.comment.savedReplyText&&(this._editor.value=this.comment.savedReplyText),this.draft&&this.draft.timestamp&&this._setDraftSaveDate(this.draft.timestamp),this._editor.value.length&&this._editor.emit("input",this._editor.value))),this}async _onMediaUrlInput(t){let e=await oa.j.instance.extractImageVideoUrls(t);this._thumbs.add(e)}async _onMenuItemClick(t){if(this._submitButton.disabled||this._submitButton.animation)return;let e=t.currentTarget.getAttribute("data-action");try{if("comstory"===e){let t=this.comment.comments.storyId,{desc:e}=this._form.serialize()||{};ia.c.create({id:t,content:this._removeImageLinks(e),images:this._thumbs.items.items.map((t=>t.data.source)),beforeRedirect:async()=>{this._form.reset(),this._thumbs.clear(),await c.cQ.delay(50)}})}}catch(s){i.vE.logger.warn("reply",s),i.vE.ui.toasts.showError()}}hide(){return"edit"===this.comment.currentReplyMode&&this._thumbs.clear(),super.hide()}_switchPreviousOfficialComment(){const{comments:t}=this.comment,e=t.el.querySelector('.comment__label[data-role="official"]');if(!e)return;const s=t.comments.get(ja.getCommentIDByElement(e));s&&(s.isOfficial=!1)}async _onSubmit(t,e){var s;if(t.preventDefault(),this._submitButton.disabled||this._submitButton.animation)return;if(!i.vE.initParams.isConfirmed&&!(await(new ca.R).show(ca.J.COMMENT)))return;d.c.getInstance().yandex.goal("tap-comment-send"),d.c.getInstance().google.event("submit","comment"),await c.cQ.allSettled(this._thumbs.videoDataPromises);const n=Date.now();if(this.isEmpty)return void i.vE.ui.toasts.showError(i.vE.i18n("comments.errors.empty"));null===(s=this._invalidInputDetector)||void 0===s||s.destroyMessage(),this._submitButton.animation=!0;const o=this.replyType,r=await this.serialize(!0);if(!r)return void(this._submitButton.animation=!1);const{response:a,data:l}=await S.cf.post("/ajax/comments_actions.php",r);if(await c.cQ.delay(1e3-(Date.now()-n)),this._submitButton.animation=!1,this.closeOffensiveMsg(),!a.result)return void i.vE.ui.toasts.showError(400===a.status?i.vE.i18n("comments.errors.400"):a.message);this.draft=null,i.vE.emit(ea.m4.REPLY_SUBMIT),this.hideSpecialUsersHint();let h=l.html,u=Number(l.comment_id);if("edit"===this.comment.currentReplyMode)i.vE.emit("comment_edit",{id:u,content:h}),this.comment.$content.innerHTML=ma(h).find(`.${ea.OW.comment.content}`).html(),this.comment.highlight("green"),i.vE.ui.player.init(this.comment.$content),la.z.getInstance().init();else{h=h.replace(va,""),this.comment.addChildComment(h),this.comment.comments.totalComments++,this.comment.isChildrenShown=!0,this.comment.comments.initComments(!1),this.comment.isMain&&this.emit("add");let t=this.comment.comments.comments.get(u);t.isNewest=!1,t.highlight("green"),this._isOfficialCheckbox&&this._isOfficialCheckbox.checked&&(this._sendCommentPinAnalytics(t),this._switchPreviousOfficialComment(),this._isOfficialCheckbox.checked=!1);const e=ma(l.html).data("meta");let s=e.match(/de=(\d+)/);s=s?Number(s[1])+1:null;const n=this.comment.authorId||Number(e.match(/aid=(\d+)/)[1])||0,{story:o}=this.comment;d.c.getInstance().sendEvent("leave_comment",ua(ua(ua({post_id:this.storyId,author_id:this.comment.comments.storyAuthorId,comment_author_id:n,comment_id:l.comment_id},null!==s&&{level:s}),{},{"comments!undefined":null==o?void 0:o.commentsCount},i.vE.initParams.isReputationClient&&{type:"company"}),{},{"type_i8!empty":null==o?void 0:o.subsCode})),Ii.SR.getInstance().init("comment_publish",null==o?void 0:o.getShowPostAnalyticsData())}this.comment.currentReplyMode="",this._options.source={source:l.source,images:l.images};let p=oa.j.getPrefixedStorage(`comment_${this.comment.id}_edit`);this._thumbs.storage.forEach((t=>p.add(t))),this._thumbs.clear(),this._editor.value="",this.comment.isMain||(this.comment.isReplyShown=!1),i.vE.initParams.isSlowModeEnabled&&i.vE.initParams.availableNumberOfCommentsForToday>0&&"create"===o&&(i.vE.initParams.availableNumberOfCommentsForToday--,this.hasCommentLimitBeenReached&&this._turnOff()),this.focus()}_sendCommentPinAnalytics(t){let e,s,n;try{const i=this._getCommentStory(t),o=i.analyticsData;n=i.rating,e=o.minuses,s=o.pluses}catch(o){}d.c.getInstance().sendEvent("company_comment_pin",{partner_id:i.vE.initParams.reputationClientId,comment_id:t.id,comment_author_id:t.authorId,post_id:t.comments.storyId,author_id:t.comments.storyAuthorId,"pluses!undefined":s,"minuses!undefined":e,"rating!undefined":n})}_getCommentStory(t){return t.comments.story.feed.stories.items[0]}get _menu(){return this._options.menu||(this._options.menu=new k._({direction:k.Lh.BOTTOM,alignment:k.SE.END,destroyAfterHide:!1,showArrow:!1,target:this.$els.buttonGroup,content:ma(document.createElement("div")).addClass("menu menu_vertical menu_padding_none").on("click",".menu__item",(t=>this._onMenuItemClick(t))).append(ma(this._menuItems.map((t=>`\n\t\t\t\t\t\t<div class="menu__item" data-action="${t.action}">\n\t\t\t\t\t\t\t${t.text}\n\t\t\t\t\t\t</div>\n\t\t\t\t\t`)).join("")))})),this._options.menu}get byModerator(){return this._options.byModerator}set byModerator(t){if(this._options.byModerator!==(t=Boolean(t))){if(this._options.byModerator=t,this.$els.noteHidden.toggle(!t),t&&!this._autoCorrectModerationText){let t=t=>t.charAt(0)+t.charAt(1).toUpperCase()+t.slice(2);this._autoCorrectModerationText=()=>{let e=this._editor.value;ea.Y2.test(e)&&(this._editor.saveCaretPosition(!0),this._editor.$els.input.html(e.replace(ea.Y2,t)),this._editor.restoreCaretPosition())},this.listenTo(this._editor,"input",this._autoCorrectModerationText)}else!t&&this._autoCorrectModerationText&&(this.stopListening(this._editor,"input",this._autoCorrectModerationText),this._autoCorrectModerationText=void 0);this.$el.toggleClass("comment-reply_by-moderator",t),this._submitButton.theme=t?st.jM.DARK:st.jM.SUCCESS}}get isCommentEditMode(){return this.comment.isEditable&&"edit"===this.comment.currentReplyMode}_initInputTextCorrector(){this._invalidInputDetector=new ha.l({showMessage:t=>{this.$els.controls.before(t)},setText:t=>{this._editor.value=t.trim()}}),this.listenTo(this._editor,"paste",(()=>{var t;return null===(t=this._invalidInputDetector)||void 0===t?void 0:t.processText(this._editor.textContent)})),this.listenTo(this._editor,"input",(()=>{var t;return null===(t=this._invalidInputDetector)||void 0===t?void 0:t.processText(this._editor.textContent)}))}}var ya=s(7977);const ba=s(9755);class wa extends O.vp{constructor(t){if(!(t instanceof xa))throw new Error("comment object should be passed");super(),this._comment=t,this._story=void 0,this.$els={},this._moreButtonText=[i.vE.i18n("comments.comstory.collapse"),i.vE.i18n("comments.comstory.expand")],this.render()}render(){const t=this._comment.el.querySelector(`.${ya.BO.item}`),e=t&&t.getAttribute("data-story-id");t&&e&&(this._story=new ya.s6(e,t),this.$els.readMore=ba(this._story.$readMore),this.$els.readMore.on("click",(t=>{if(void 0===t.originalEvent)return;const e=this._story.isCollapsedLongStory;e||this._scrollTop(),this._story.isCollapsedLongStory=!e,this._toggleMoreButton(e)})))}_toggleMoreButton(t){const e=this.$els.readMore.html(),s=[...this._moreButtonText];this.$els.readMore.html(e.replace(...t?s.reverse():s)),this.$els.readMore.find("svg").parent().toggle(!t)}_scrollTop(){i.vE.ui.scrollTo(this._comment.$el.offset().top,!0)}}var Ea=s(5636);!function(){if("object"==typeof window)if("IntersectionObserver"in window&&"IntersectionObserverEntry"in window&&"intersectionRatio"in window.IntersectionObserverEntry.prototype)"isIntersecting"in window.IntersectionObserverEntry.prototype||Object.defineProperty(window.IntersectionObserverEntry.prototype,"isIntersecting",{get:function(){return this.intersectionRatio>0}});else{var t=window.document,e=[];i.prototype.THROTTLE_TIMEOUT=100,i.prototype.POLL_INTERVAL=null,i.prototype.USE_MUTATION_OBSERVER=!0,i.prototype.observe=function(t){if(!this._observationTargets.some((function(e){return e.element==t}))){if(!t||1!=t.nodeType)throw new Error("target must be an Element");this._registerInstance(),this._observationTargets.push({element:t,entry:null}),this._monitorIntersections(),this._checkForIntersections()}},i.prototype.unobserve=function(t){this._observationTargets=this._observationTargets.filter((function(e){return e.element!=t})),this._observationTargets.length||(this._unmonitorIntersections(),this._unregisterInstance())},i.prototype.disconnect=function(){this._observationTargets=[],this._unmonitorIntersections(),this._unregisterInstance()},i.prototype.takeRecords=function(){var t=this._queuedEntries.slice();return this._queuedEntries=[],t},i.prototype._initThresholds=function(t){var e=t||[0];return Array.isArray(e)||(e=[e]),e.sort().filter((function(t,e,s){if("number"!=typeof t||isNaN(t)||t<0||t>1)throw new Error("threshold must be a number between 0 and 1 inclusively");return t!==s[e-1]}))},i.prototype._parseRootMargin=function(t){var e=(t||"0px").split(/\s+/).map((function(t){var e=/^(-?\d*\.?\d+)(px|%)$/.exec(t);if(!e)throw new Error("rootMargin must be specified in pixels or percent");return{value:parseFloat(e[1]),unit:e[2]}}));return e[1]=e[1]||e[0],e[2]=e[2]||e[0],e[3]=e[3]||e[1],e},i.prototype._monitorIntersections=function(){this._monitoringIntersections||(this._monitoringIntersections=!0,this.POLL_INTERVAL?this._monitoringInterval=setInterval(this._checkForIntersections,this.POLL_INTERVAL):(n(window,"resize",this._checkForIntersections,!0),n(t,"scroll",this._checkForIntersections,!0),this.USE_MUTATION_OBSERVER&&"MutationObserver"in window&&(this._domObserver=new MutationObserver(this._checkForIntersections),this._domObserver.observe(t,{attributes:!0,childList:!0,characterData:!0,subtree:!0}))))},i.prototype._unmonitorIntersections=function(){this._monitoringIntersections&&(this._monitoringIntersections=!1,clearInterval(this._monitoringInterval),this._monitoringInterval=null,o(window,"resize",this._checkForIntersections,!0),o(t,"scroll",this._checkForIntersections,!0),this._domObserver&&(this._domObserver.disconnect(),this._domObserver=null))},i.prototype._checkForIntersections=function(){var t=this._rootIsInDom(),e=t?this._getRootRect():{top:0,bottom:0,left:0,right:0,width:0,height:0};this._observationTargets.forEach((function(i){var n=i.element,o=r(n),a=this._rootContainsTarget(n),l=i.entry,h=t&&a&&this._computeTargetAndRootIntersection(n,e),c=i.entry=new s({time:window.performance&&performance.now&&performance.now(),target:n,boundingClientRect:o,rootBounds:e,intersectionRect:h});l?t&&a?this._hasCrossedThreshold(l,c)&&this._queuedEntries.push(c):l&&l.isIntersecting&&this._queuedEntries.push(c):this._queuedEntries.push(c)}),this),this._queuedEntries.length&&this._callback(this.takeRecords(),this)},i.prototype._computeTargetAndRootIntersection=function(e,s){if("none"!=window.getComputedStyle(e).display){for(var i,n,o,a,h,c,d,u,p=r(e),m=l(e),_=!1;!_;){var g=null,v=1==m.nodeType?window.getComputedStyle(m):{};if("none"==v.display)return;if(m==this.root||m==t?(_=!0,g=s):m!=t.body&&m!=t.documentElement&&"visible"!=v.overflow&&(g=r(m)),g&&(i=g,n=p,o=void 0,a=void 0,h=void 0,c=void 0,d=void 0,u=void 0,o=Math.max(i.top,n.top),a=Math.min(i.bottom,n.bottom),h=Math.max(i.left,n.left),c=Math.min(i.right,n.right),u=a-o,!(p=(d=c-h)>=0&&u>=0&&{top:o,bottom:a,left:h,right:c,width:d,height:u})))break;m=l(m)}return p}},i.prototype._getRootRect=function(){var e;if(this.root)e=r(this.root);else{var s=t.documentElement,i=t.body;e={top:0,left:0,right:s.clientWidth||i.clientWidth,width:s.clientWidth||i.clientWidth,bottom:s.clientHeight||i.clientHeight,height:s.clientHeight||i.clientHeight}}return this._expandRectByRootMargin(e)},i.prototype._expandRectByRootMargin=function(t){var e=this._rootMarginValues.map((function(e,s){return"px"==e.unit?e.value:e.value*(s%2?t.width:t.height)/100})),s={top:t.top-e[0],right:t.right+e[1],bottom:t.bottom+e[2],left:t.left-e[3]};return s.width=s.right-s.left,s.height=s.bottom-s.top,s},i.prototype._hasCrossedThreshold=function(t,e){var s=t&&t.isIntersecting?t.intersectionRatio||0:-1,i=e.isIntersecting?e.intersectionRatio||0:-1;if(s!==i)for(var n=0;n<this.thresholds.length;n++){var o=this.thresholds[n];if(o==s||o==i||o<s!=o<i)return!0}},i.prototype._rootIsInDom=function(){return!this.root||a(t,this.root)},i.prototype._rootContainsTarget=function(e){return a(this.root||t,e)},i.prototype._registerInstance=function(){e.indexOf(this)<0&&e.push(this)},i.prototype._unregisterInstance=function(){var t=e.indexOf(this);-1!=t&&e.splice(t,1)},window.IntersectionObserver=i,window.IntersectionObserverEntry=s}function s(t){this.time=t.time,this.target=t.target,this.rootBounds=t.rootBounds,this.boundingClientRect=t.boundingClientRect,this.intersectionRect=t.intersectionRect||{top:0,bottom:0,left:0,right:0,width:0,height:0},this.isIntersecting=!!t.intersectionRect;var e=this.boundingClientRect,s=e.width*e.height,i=this.intersectionRect,n=i.width*i.height;this.intersectionRatio=s?Number((n/s).toFixed(4)):this.isIntersecting?1:0}function i(t,e){var s,i,n,o=e||{};if("function"!=typeof t)throw new Error("callback must be a function");if(o.root&&1!=o.root.nodeType)throw new Error("root must be an Element");this._checkForIntersections=(s=this._checkForIntersections.bind(this),i=this.THROTTLE_TIMEOUT,n=null,function(){n||(n=setTimeout((function(){s(),n=null}),i))}),this._callback=t,this._observationTargets=[],this._queuedEntries=[],this._rootMarginValues=this._parseRootMargin(o.rootMargin),this.thresholds=this._initThresholds(o.threshold),this.root=o.root||null,this.rootMargin=this._rootMarginValues.map((function(t){return t.value+t.unit})).join(" ")}function n(t,e,s,i){"function"==typeof t.addEventListener?t.addEventListener(e,s,i||!1):"function"==typeof t.attachEvent&&t.attachEvent("on"+e,s)}function o(t,e,s,i){"function"==typeof t.removeEventListener?t.removeEventListener(e,s,i||!1):"function"==typeof t.detatchEvent&&t.detatchEvent("on"+e,s)}function r(t){var e;try{e=t.getBoundingClientRect()}catch(s){}return e?(e.width&&e.height||(e={top:e.top,right:e.right,bottom:e.bottom,left:e.left,width:e.right-e.left,height:e.bottom-e.top}),e):{top:0,bottom:0,left:0,right:0,width:0,height:0}}function a(t,e){for(var s=e;s;){if(s==t)return!0;s=l(s)}return!1}function l(t){var e=t.parentNode;return e&&11==e.nodeType&&e.host?e.host:e&&e.assignedSlot?e.assignedSlot.parentNode:e}}();var Sa=s(7912);const Ca=s(9755);let Ta;const Oa=Symbol();class ka{constructor(t){if(t!==Oa)throw new Error("Cannot construct singleton");this._intersectionObserver=this._getIntersectionObserver(),this._storiesWithTimer=new WeakMap}static getInstance(){return Ta||(Ta=new ka(Oa)),Ta}observeCommentElem(t){this._intersectionObserver.observe(t)}_getIntersectionObserver(){if(this._intersectionObserver)return this._intersectionObserver;const t=i.vE.isMobileApp?`-${i.vE.ui.getHeaderHeight()}px`:"0px";return this._intersectionObserver=new IntersectionObserver((t=>{t.forEach((t=>{const e=t.target;if(!t.isIntersecting||!Sa.E.isShown)return;if(this._storiesWithTimer.has(e))return;const s=Number(Ca(".story_comment",e).attr("data-story-id"));this._storiesWithTimer.set(e,s),setTimeout((()=>this._setVisitedCommentPost(e,s)),5e3)}))}),{rootMargin:t,threshold:.5}),this._intersectionObserver}_setVisitedCommentPost(t,e){this._storiesWithTimer.delete(t);i.vE.ui.elementInViewport(t)&&(Ea.C.setVisited(e,!1),this._intersectionObserver.unobserve(t))}}const Ia=s(6419),$a=s(9755),Aa=s(381);class xa extends ea.Cj{constructor(t,e){super(t,e),this.$el.data("id")?(this._getInformationFromData(),this._options.isReplyShown=!1,this._handleIgnoreIcon(),this._handleComstory(),this._options.currentReplyMode="",this.isResponseDisabled(!1)&&i.vE.isUserAuthorized&&this.$controlCreate.classList.add("button_disabled")):(this._options.id=ea.iM,this._options.isChildrenShown=!0,this._options.isReplyShown=!0,this._options.$children=this.el),this._displayNone="on-desktop-hide"}_getInformationFromData(){var t;let e=this.el,s=e.dataset,i={},n=[],o=!1;if(e.classList.contains(ea.OW.comment.fake))return Ia.extend(this._options,{hasChildren:!0,isChildrenShown:!0,isFake:!0}),this;s.meta.split(",").forEach((t=>{let[e,s]=t.split("=");i[ea.hb[e]]=s||!0})),s.ignoredBy&&(n=s.ignoredBy.split(",").filter((t=>""!==t.trim()))),this.authorId=i.authorId;let r=Number(i.parentID),a=Ia.isUndefined(s.indent)&&this.comments.comments.has(r),l=a&&r?this.comments.comments.get(r).depth+1:Number(i.depth),h=l%ea.Iz,c=Boolean(i.hasChildren),d=ea.OC[i.vote]||ea.OC.NONE,u=this.recountVotesAndRating(i.amountVotes,i.rating,d);h=0===l?0:0===h?10:h,a&&(s.indent=String(h));const p=e.querySelector(`.${ea.OW.comment.user}`);return p&&p.hasAttribute("data-own-story")&&(o=!0),Ia.extend(this._options,u,{id:Number(i.id)||0,parentID:Number(i.parentID)||0,datetime:Aa(i.datetime),indent:h,depth:l,floor:Math.floor((0===l?0:l-1)/ea.Iz),ignoreType:ea.IV[i.ignoreType]||ea.IV.NONE,ignoredByList:n,communityName:i.communityName||"",vote:d,voteSync:d,hasChildren:c,isStoryAuthorComment:o,isOfficial:i.isOfficial,canUnpin:i.canUnpin,isComstory:e.classList.contains(ea.OW.comment.comstory),isCommenterCurrentUser:Boolean(i.isCommenterCurrentUser),isModeratorAutoSelect:Boolean(i.isModeratorAutoSelect),isEditable:Boolean(i.isEditable),isSaved:Boolean(i.isSaved),isInHiddenGroup:Boolean(i.isInHiddenGroup),isNewest:"true"===s.newest,isStoryComment:Boolean(i.isStoryComment),amountVotesHidden:null===(t=i.amountVotesHidden)||void 0===t?void 0:t.split(":"),isChildrenShown:!!c&&!this.$toggleChildren.classList.contains(ea.OW.children.toggle.collapse)}),this._options.isComstory&&ka.getInstance().observeCommentElem(this.el),this.meta=i,this}getBranchIDs(){let t=[],e=this;if(this.hasChildren&&this.$children){let e=this.$children.querySelectorAll(`.${ea.OW.comment.item}`);for(let s of e)t.push(s.getAttribute("data-id"))}for(;e&&e.hasParent&&!e.isMain;)t.push(e.id),e=e.parent;return t}async toggleToolParent(t,e=!0){this.toolsShown=t,this.parent.$toolFromParent.style.display=t?"block":"none",this.parent.toolsShown=t,t?(await this.parent.scrollTo(!0),this.parent.highlight("green",!0,t)):e&&(await this.scrollTo(!0),this.highlight("green",!0,!0))}open(){if(this.isInHiddenGroup){let t=this.$el.parent();t.is(":visible")||t.show().next().hide()}return!this.hasChildren||this.isChildrenShown||this.$toggleChildren&&"none"===this.$toggleChildren.style.display||(this.isChildrenShown=!0),this.parentID!==ea.iM&&this.hasParent&&this.parent&&this.parent.open(),this}highlight(t,e=!0,s){if(!this.$body)return this;t=ea.OW.highlight.item+t;let i=this.$body.classList.contains(t);return i===(s=Ia.isBoolean(s)?s:!i)||(this.$body.classList.toggle(t,s),e&&(this.$body.classList.toggle(ea.OW.highlight.blink,s),s?this.timeout(t,2e3,(()=>this.$body.classList.remove(t,ea.OW.highlight.blink))):this.cancelTimeout(t))),this}async remove(){return!(!this.isEditable||this._awaitRemove)&&(this._awaitRemove=!0,await super.removeSync()?(this.$el&&this.$el.addClass(ea.OW.comment.deleted),this._awaitRemove=!1,this._removed=!0,!0):(this._awaitRemove=!1,!1))}async restore(){return!(!this._removed&&this._awaitRestore)&&(this._awaitRestore=!0,await super.restoreSync()?(this.$el&&this.$el.hasClass(ea.OW.comment.deleted)&&this.$el.removeClass(ea.OW.comment.deleted),this._awaitRestore=!1,!0):(this._awaitRestore=!1,!1))}_renderToggleChildren(){let t=this._options.$toggleChildren;if(t)return t;t=this._options.$toggleChildren=document.createElement("div"),t.classList.add(ea.OW.children.toggle.button);let e=document.createElement("div"),s=document.createElement("div"),n=this._options.$toggleChildrenText=document.createElement("span"),o=this._options.$toggleChildrenCount=document.createElement("span");return e.classList.add(ea.OW.children.toggle.icon),e.innerHTML=i.vE.icon("comments__toggle"),t.appendChild(e),s.classList.add(ea.OW.children.toggle.label),t.appendChild(s),n.classList.add(ea.OW.children.toggle.text),o.classList.add(ea.OW.children.toggle.count),s.appendChild(n),s.appendChild(o),s.insertAdjacentHTML("beforeend",i.vE.icon("ui__comments")),this.indent===ea.Iz&&t.classList.add(ea.OW.children.toggle.nextFloor),t}_renderChildren(){this.isToggleButtonHidden=!1;let t=this._options.$children;return t||(this._options.$children=t=document.createElement("div"),t.classList.add(ea.OW.children.el),this.indent===ea.Iz&&t.classList.add(ea.OW.children.nextFloor),this.el.appendChild(this._renderToggleChildren()),this.el.appendChild(t),t)}_renderHiddenGroup(){let t=this._options.$hiddenGroup=document.createElement("div"),e=document.createElement("div");return t.classList.add(ea.OW.children.hidden.group),e.classList.add(ea.OW.children.hidden.button),e.textContent=i.vE.i18n("comments.more-comments"),this.$children.appendChild(t),this.$children.appendChild(e),t}updateChildrenCount(){const t=`.${ea.OW.comment.item}:not(.${this._displayNone})`,e=this.$children.querySelectorAll(t),s=Ia.reduce(e,((t,e)=>t+(e.getAttribute("data-newest")?1:0)),0),n=e.length-s;return this.$toggleChildrenText.textContent=i.vE.i18n("comments.more-comments"),this.detectOnlyHiddenGroup()?(this.$toggleChildrenCount.textContent="",this):(this.$toggleChildrenCount.textContent=(0===n?"":` ${n} `)+(s>0?" +"+s:""),this.$toggleChildren.classList.toggle(ea.OW.children.toggle.newest,s>0),this)}async branchHide(){if(!(await super.branchHide()))return!1;if(this.comments.isSliceMode)return this.$notice.textContent=i.vE.i18n("comments.notice.branch-hidden"),this.$notice.classList.remove(this._displayNone),this.$controlBranchHide&&this.$controlBranchHide.classList.add(this._displayNone),this.$controlBranchShow&&this.$controlBranchShow.classList.remove(this._displayNone),!0;const t=this.parent;if(this.$el.addClass(this._displayNone),t.isMain||!t.$children)return!0;const e=`:scope > .${ea.OW.comment.item}:not(.${this._displayNone})`;return t.$children.querySelectorAll(e).length||(t.isToggleButtonHidden=!0),!0}async branchShow(){return!!(await super.branchShow())&&(this.$notice.classList.add(this._displayNone),this.$controlBranchShow&&this.$controlBranchShow.classList.add(this._displayNone),this.$controlBranchHide&&this.$controlBranchHide.classList.remove(this._displayNone),!0)}_handleIgnoreIcon(){let{ignoredByList:t}=this._options,e="_hint-rendered";if(!t||!t.length)return;let s=this.$body.querySelector(".user__label_ignore");s&&!s.getAttribute(e)&&(s.setAttribute(e,"1"),new k.gR({target:s,destroyAfterHide:!1,direction:k.Lh.TOP,content:$a(document.createElement("div")).addClass("popup__hint").html(i.vE.i18n("comments.hidden.ignore-hint",c.cQ.formatUsernamesList(t)))}))}_handleComstory(){this._options.isComstory&&new wa(this)}_updateControls(){this.isResponseDisabled(!1)&&this.$controlCreate.classList.add("button_disabled");let t=Boolean(this._options.currentReplyMode);this.$controlRemove.style.display=this.isEditable?"inline":"none",this.$controlCancel.style.display=this.isReplyShown?"inline":"none",this.$controlCreate.style.display=t&&this.isReplyShown?"none":"inline",this.$controlUnpin.style.display=this.isOfficial&&this.canUnpin?"inline":"none",this.$controlEdit&&(this.$controlEdit.style.display=t&&this.isReplyShown||!this.isEditable?"none":"inline")}_updateReplyPosition(){this.isMain||(this.isEditable&&"edit"===this._options.currentReplyMode?this.$controls.insertAdjacentElement("beforebegin",this.$replyWrapper):(this.$controls.insertAdjacentElement("afterend",this.$replyWrapper),this._options.currentReplyMode="create"))}_updateIsEditable(t){this.reply&&this.reply.emit("lock-editing"),this.$controlRemove.style.display=t?"block":"none",this._updateControls()}_updateRating(){const t=this.rating,e=this.vote,s=e===ea.OC.UP,n=e===ea.OC.DOWN;if(this.$ratingUp.classList.toggle(ea.OW.rating.up+ea.OW.rating.active,s),this.$ratingDown.classList.toggle(ea.OW.rating.down+ea.OW.rating.active,n),Ia.isNumber(t)&&!isNaN(t)&&e){const r=t+e.valueOf();if(this.$ratingCount.textContent=(r>0?"+":"")+r,this.amountVotes){const[t,e]=this.amountVotes,r=t+(s?1:0),a=e+(n?1:0);this.$ratingCount.setAttribute("aria-label",i.vE.i18n("comments.rating-hint",r,a));try{$a(this.$ratingCount).data("hint").destroy()}catch(o){}}}}_updateChildrenShown(t){var e;if(this.isMain)return;if(!this.$children)return void Ia.forEach($a(`.comment[data-id=${this.id}]`),(e=>{if(this.el!==e){let s=new xa(e,this.comments);t=!s.isChildrenShown,s.$children.style.display=t?"block":"none",s.$toggleChildren.classList.toggle(ea.OW.children.toggle.collapse,!t)}}));this.$children.style.display=t?"block":"none",t&&this.detectOnlyHiddenGroup()&&(this.$hiddenGroup.style.display="block",this.$hiddenGroup.nextElementSibling.style.display="none"),this.$toggleChildren.classList.toggle(ea.OW.children.toggle.collapse,!t);const[s,i]=this.amountVotes||[];oe.cp.getInstance().sendEvent(t?"comment_branch_show":"comment_branch_collapse",{"comment_id!empty":this.id,"post_id!empty":null===(e=this.story)||void 0===e?void 0:e.id,"comment_author_id!empty":this.authorId,"pluses!undefined":s,"minuses!undefined":i,"rating!undefiend":this.rating,"level!undefined":this._options.depth+1},[oe.b0.CLICKHOUSE]),t||this.updateChildrenCount()}get isReplyShown(){return this._options.isReplyShown}set isReplyShown(t){if(this._options.isReplyShown===(t=Boolean(t)))return;this._options.isReplyShown=t;let e=this.reply;t?(this._updateReplyPosition(),e||(e=this._options.reply=new fa(this.comments.storyId,this),e.$parent=this.$replyWrapper),e.show().focus(),e.$el.addClass(ea.OW.reply.border)):e&&e.hide(),this._updateControls(),this.$content.style.display=t&&this.isEditable&&"edit"===this._options.currentReplyMode?"none":""}get reply(){return this._options.reply}get userName(){if(this._options.userName)return this._options.userName;let t=this.$el.find(`.${ea.OW.comment.user}`);if(!t.length)return;let e=t.data("name");return this._options.userName=e,e}get $content(){let t=this._options.$content;return t||(t=this._options.$content=this.$body.querySelector(`.${ea.OW.comment.content}`)),t}get $replyWrapper(){let t=this._options.$replyWrapper;return t||(t=this._options.$replyWrapper=document.createElement("div"),t.classList.add(ea.OW.reply.wrapper)),t}get $datetime(){let t=this._options.$datetime;return t||(t=this._options.$datetime=this.$body.querySelector(`.${ea.OW.datetime}`)),t}get $toggleChildren(){return this._options.$toggleChildren||(this._options.$toggleChildren=this.el.querySelector(`:scope > .${ea.OW.children.toggle.button}`)),this._options.$toggleChildren}get $toggleChildrenCount(){return this._options.$toggleChildrenCount||(this._options.$toggleChildrenCount=this.$toggleChildren.querySelector(`.${ea.OW.children.toggle.count}`)),this._options.$toggleChildrenCount}get $toggleChildrenText(){return this._options.$toggleChildrenText||(this._options.$toggleChildrenText=this.$toggleChildren.querySelector(`.${ea.OW.children.toggle.text}`)),this._options.$toggleChildrenText}get $controls(){let t=this._options.$controls;return t||(t=this._options.$controls=this.$body.querySelector(`:scope > .${ea.OW.controls.el}`)),t}get $controlRemove(){let t=this._options.$controlRemove;return t||(t=this._options.$controlRemove=this.$controls.querySelector(`.${ea.OW.controls.item}[data-type="remove"]`)),t}get $controlEdit(){let t=this._options.$controlEdit;return t||(t=this._options.$controlEdit=this.$controls.querySelector(`.${ea.OW.controls.item}[data-type="edit"]`)),t}get $controlUnpin(){let t=this._options.$controlUnpin;return t||(t=this._options.$controlUnpin=this.$controls.querySelector(`.${ea.OW.controls.item}[data-type="unpin"]`)),t}get $controlCreate(){let t=this._options.$controlCreate;return t||(t=this._options.$controlCreate=this.$controls.querySelector(`.${ea.OW.controls.item}[data-type="create"]`)),t}get $controlCancel(){let t=this._options.$controlCancel;return t||(t=this._options.$controlCancel=this.$controls.querySelector(`.${ea.OW.controls.item}[data-type="cancel"]`)),t}get $controlBranchHide(){return this._options.$controlBranchHide||(this._options.$controlBranchHide=this.$controls.querySelector(`.${ea.OW.tools.item}[data-role="branch-hide"]`)),this._options.$controlBranchHide}get $controlBranchShow(){return this._options.$controlBranchShow||(this._options.$controlBranchShow=this.$controls.querySelector(`.${ea.OW.tools.item}[data-role="branch-show"]`)),this._options.$controlBranchShow}get $notice(){return this._options.$notice||(this._options.$notice=this.$body.querySelector(`.${ea.OW.notice}`)),this._options.$notice||(this._options.$notice=$a(document.createElement("div")).addClass(ea.OW.notice+" "+this._displayNone).insertBefore(this.$controls)[0]),this._options.$notice}get $body(){return this._options.$body||(this._options.$body=this.el.querySelector(`:scope > .${ea.OW.comment.body}`)),this._options.$body}get $ratingUp(){return this._options.$ratingUp||(this._options.$ratingUp=this.$body.querySelector(`.${ea.OW.rating.up}`)),this._options.$ratingUp}get $ratingDown(){return this._options.$ratingDown||(this._options.$ratingDown=this.$body.querySelector(`.${ea.OW.rating.down}`)),this._options.$ratingDown}get $ratingCount(){return this._options.$ratingCount||(this._options.$ratingCount=this.$body.querySelector(`.${ea.OW.rating.count}`)),this._options.$ratingCount}get $toolBranch(){return this._options.$toolBranch||(this._options.$toolBranch=this.$body.querySelector(`.${ea.OW.tools.item}[data-role="branch"]`)),this._options.$toolBranch}get $toolFromParent(){return this._options.$toolFromParent||(this._options.$toolFromParent=this.$body.querySelector(`.${ea.OW.tools.item}[data-role="from-parent"]`)),this._options.$toolFromParent}get $toolSave(){return this._options.$toolSave||(this._options.$toolSave=this.$body.querySelector(`.${ea.OW.tools.item}[data-role="save"]`)),this._options.$toolSave}get toolsShown(){return this._options.toolsShown}set toolsShown(t){this._options.toolsShown!==(t=Boolean(t))&&(this._options.toolsShown=t,this.$body.classList.toggle(ea.OW.comment.active,t))}get currentReplyMode(){return this._options.currentReplyMode}set currentReplyMode(t){this._options.currentReplyMode!==t&&(this._options.currentReplyMode=t)}get isComstory(){return this._options.isComstory}get isOfficial(){return Boolean(this._options.isOfficial)}set isOfficial(t){if(this._options.isOfficial=Boolean(t),!t){this.canUnpin=!1;const t=this.el.querySelector('.comment__label[data-role="official"]');t&&t.remove()}}get canUnpin(){return Boolean(this._options.canUnpin)}set canUnpin(t){this._options.canUnpin=Boolean(t),this._updateControls()}get isToggleButtonHidden(){return this._options.toggleButtonHidden}set isToggleButtonHidden(t){const e=this._options.$toggleChildren;e&&e.classList.toggle(this._displayNone,t),this._options.toggleButtonHidden=t}get displayNoneClass(){return this._displayNone}}var Da=s(1835);var Pa=s(4051);function Ra(t,e){var s=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),s.push.apply(s,i)}return s}function Ma(t,e,s){return e in t?Object.defineProperty(t,e,{value:s,enumerable:!0,configurable:!0,writable:!0}):t[e]=s,t}const Na=s(9755),Ba=s(6419),La=s(381);let Fa=!1,Ua=!1;class ja extends ea.HW{constructor(t){super(t),this._mouseEnterDisable=!1,this._answersTogglersAttached=!1,this._commentClass=xa,this._isReplacedCommentsButtonText=!1,this._options.loadAnimation=!1,this.render(),this._getInformationFromData(),this.type===ea.tz.STORY&&(this.maxCommentId=this.getMaxCommentIDFromStorage()),this._attachDetectFocusIn(),this._attachTools(),this._attachModTools(),this._attachMouseEnterComment(),this._attachHotkeys(),this.listenTo(this,"could-not-find-comment",(()=>{this.type===ea.tz.STORY&&(i.vE.ui.scrollRestoration="manual");let t=Na(".section_danger");i.vE.ui.scrollTo(t.offset().top-50,!0)})),this.initComments(),this.isSliceMode&&Na(".comment__children_fake.comment__children_next-floor").last().attr("data-on",!0),this.interval("updateTime",ea.ly,(()=>{let t=La();this.comments.forEach((e=>{if(e.isMain)return;let s=t.diff(e.datetime);s<ea.aH&&!i.vE.ui.elementInViewport(e.$el)&&(e.$datetime.textContent=e.datetime.fromNow()),e.isEditable&&s>ea.KF&&(e.isEditable=!1)}))})),this.type!==ea.tz.INCOMING&&this.type!==ea.tz.OUTCOMING&&this.type!==ea.tz.AUTHORS||this._attachParentButtons(),this.type===ea.tz.SINGLE||this.type!==ea.tz.STORY&&this.type!==ea.tz.AUTHORS||i.vE.isFullyBanned||this._attachQuote(),this._showNewFeatureNotifications(),this._initAdAnalytics()}_getInformationFromData(){let t=this.$el.data("story-id"),e=this.$el.data("story-username");return this._options.storyId="number"==typeof t?t:parseInt(t,10),this._options.storyAuthorId=this.$el.data("story-author-id"),this._options.ignoreType=ea.IV[this.$el.data("ignore-type")]||ea.IV.NONE,this._options.isUserInComments=Boolean(this.$el.data("user-in-comments")),this._options.sliceMode=Boolean(this.$el.data("slice-mode")),this._options.endOfComments=!0,this._options.totalComments=this.$els.totalComments.length?this.$els.totalComments.data("total"):0,this.orderMode=this.$el.data("order-mode"),this.storyUserName=e||"",this.hasClientMentions=Boolean(this.$el.data("has-client-mentions")),this.type===ea.tz.STORY&&this.$els.more.button.is(":visible")&&(this.lastViewCommentId=this.$els.comments.find(`.${ea.OW.comment.item}:last`).data("id"),this._options.endOfComments=!1),this}render(){return this.isRendered||(super.render(),this.$els.spinner=Na("."+ea.OW.spinner)),this}initMainReply(){if(!this.$reply||!this.$reply.length)return this;let t;if(i.vE.isUserAuthorized){if(i.vE.isUserBanned||i.vE.isFullyBanned)t=i.vE.i18n("comments.reply.banned");else if(i.vE.userRating<ea.r7)t=i.vE.i18n("comments.reply.rating");else if(this.ignoreType===ea.IV.COMMUNITY_IGNORES_YOU&&!i.vE.isUserModerator){let e=Na('.community-info-block[data-type="about"] .community__title > a').text();e=e&&e.length?` «${e}»`:e,t=i.vE.i18n("comments.ignore."+this.ignoreType.toString(),e)}}else t=function(t){var e="";return Array.prototype.join,e+=t?"\n\tЧтобы оставить комментарий, необходимо зарегистрироваться или войти\n":'\n\tЧтобы оставить комментарий, необходимо <a href="#signup" class="to-signup">зарегистрироваться</a> или <a href="#signin" class="to-signin">войти</a>\n'}(!Boolean(i.vE.ui.auth));if(t)this.$reply.addClass("section_gray").html(t).show();else{let t=new fa(this.storyId,this.comments.get(ea.iM));this.listenToOnce(t,"add",this._updateHeader),t.appendTo(this.$reply),t.show(),this.$reply.addClass("section_padding_none").show(),t.isComPostHintEnabled=this.$reply.data("show-hint"),this.comments.get(ea.iM)._options.reply=t}return this}_attachParentButtons(){return this.$els.main=this.$(`.${ea.OW.user.main}`),this.$els.parent=this.$(`.${ea.OW.user.parent}`),this.$els.toggleParent=this.$(`.${ea.OW.user.toggleParent}`).on("click",(()=>{let t=this.$els.toggleParent.hasClass(ea.OW.user.toggleParentActive);t?this.$els.parent.slideDown(200):this.$els.parent.slideUp(200),this.$els.toggleParent.toggleClass(ea.OW.user.toggleParentActive,!t),this.$els.main.toggleClass(ea.OW.user.mainIndent,t),this._showNewFeatureNotifications()})),this.$els.answers=this.$(`.${ea.OW.user.answers}`),this.$els.toggleAnswers=this.$(`.${ea.OW.user.toggleAnswers}`).off().on("click",(async()=>{if(this.marks.has("get-answers"))return;let t=this.$els.toggleAnswers.data("id");this._answersTogglersAttached||this._attachAnswersTogglers(t),this.marks.set("get-answers",!0);let e=!this.$els.toggleAnswers.hasClass(ea.OW.children.toggle.collapse);if(!e&&this.$els.answers.is(":empty")){let{result:e,freshCommentsCount:s}=await ea.HW.getAnswers(t);if(e&&(this.$els.answers.html(e),this.initComments(),this.type===ea.tz.INCOMING)){let t=Na('.bell[data-role="answers"]'),e=parseInt(t.text(),10);t.length&&99!==e&&(e-=s,t.text(e).toggle(e>0))}}this.$els.toggleAnswers.toggleClass(ea.OW.children.toggle.collapse,e),this.$els.answers.toggle(!e),this.marks.delete("get-answers")})),this}static closestComment(t,e){for(;t;){if(1===t.nodeType&&t.matches(e))return t;t=t.parentNode}return null}_attachQuote(){let t=0,e=Ba.debounce((()=>{if(t>0)return;let e=window.getSelection();if(!e.rangeCount)return;let s,n=e.getRangeAt(0),o=n.cloneRange(),r=document.createElement("div");const a=8===e.anchorNode.nodeType?null:ja.closestComment(e.anchorNode,".comment"),l=ja.closestComment(e.focusNode,".comment");if(!a||a!==l||ja.closestComment(e.anchorNode,".comment__reply-wrapper")||Na(l).hasClass("comment_comstory"))return;let h=ja.getCommentIDByElement(a,this.isAuthorsType);if(!Ba.isNumber(h))return;this.currentComments=this.isAuthorsType?this.story.commentsAuthors.get(Number(h)).comments.comments:this.story.allComments.comments;let c=this.currentComments.get(ja.getCommentIDByElement(a)),d=n.startContainer,u=n.endContainer,p=ja.closestComment(d,".comment__content"),m=ja.closestComment(u,".comment__content");if(!p||c.isEditable)return;if(!m){let t=c.$content;p||o.setStart(t.firstChild,0),m||o.setEndAfter(t.lastChild)}if(e.removeAllRanges(),e.addRange(o),r.appendChild(o.cloneContents()),r.textContent.length<5)return;s=r.innerHTML,this.marks.set("quote",`<blockquote>${s}</blockquote><br>`),this.marks.set("quoteCommentId",c.id);let _=o.getBoundingClientRect(),g=this._createQuoteDialog();g.target={offset:{top:_.top+i.vE.ui.scrollTop,left:_.left+i.vE.ui.scrollLeft},height:_.height,width:_.width},g.show()}),200);return Na(document).off("mousedown mouseup"),Na(document).on({mousedown:()=>{t++,this._createQuoteDialog()&&this._createQuoteDialog().hide()},mouseup:()=>{0==--t&&e()}}),this}_createQuoteDialog(){return this._quoteDialog||(this._quoteDialog=new k._({delay:800,content:'<div class="comment-quote">\n\t<svg xmlns="http://www.w3.org/2000/svg" class="icon icon--editor__quote"><use xlink:href="#icon--editor__quote"></use></svg>\n</div>',minWidth:1,theme:k.xb.WARNING,direction:k.Lh.TOP}),this._quoteDialog.content.on("mousedown",(()=>{if(d.c.getInstance().yandex.goal("Quote_text_selection"),!i.vE.isUserAuthorized)return void i.vE.ui.authRequired();let t;if(this.currentComments.forEach((e=>{e.isMain||t||e.reply&&e.isReplyShown&&(t=e)})),!t){if(t=this.currentComments.get(this.marks.get("quoteCommentId")),t.depth>=ea.BE)return;t.isReplyShown=!0}t.reply.paste(this.marks.get("quote")),this._quoteDialog.hide()}))),this._quoteDialog}_attachDetectFocusIn(){return this.$el.on("mouseenter",Ba.throttle((()=>{this.focused=!0,i.vE.logger.log("comments","focus in",this.eid)}),50)),this.focused=!0,this}_attachHotkeys(){i.vE.ui.hotkeys.on(["w","add"],(()=>{if(!this.currentCommentId||!this.focused)return;let t=this.comments.get(this.currentCommentId);t&&this._voteComment(t,ea.OC.UP,!0)}),{type:it.FM.KEYDOWN,repeat:!1}),i.vE.ui.hotkeys.on(["s","subtract"],(()=>{if(!this.currentCommentId||!this.focused)return;let t=this.comments.get(this.currentCommentId);t&&this._voteComment(t,ea.OC.DOWN,!0)}),{type:it.FM.KEYDOWN}),i.vE.ui.hotkeys.on(["a","numpad4"],(()=>{this.focused})),i.vE.ui.hotkeys.on(["d","numpad6"],(()=>{this.focused}))}_attachTools(){this.$el.on("click",`.${ea.OW.children.hidden.button}`,(t=>{let e=t.target.closest(`.${ea.OW.children.hidden.button}`);e.style.display="none",e.previousElementSibling.style.display="block"})),this.$el.on("click",`.${ea.OW.children.toggle.button}`,(t=>{let e,s,n=ja.getCommentIDByElement(t.target),o=this.comments.get(n);return o?((o.amountVotes||o.amountVotesHidden)&&([e,s]=o.amountVotesHidden?o.amountVotesHidden:o.amountVotes),d.c.getInstance().sendEvent("click_show_comments_thread",{post_id:this.storyId,author_id:this.storyAuthorId,comment_id:o.id,comment_author_id:o.authorId,level:o.depth+1,"pluses!undefined":e,"minuses!undefined":s}),o.isChildrenShown=!o.isChildrenShown,this._showNewFeatureNotifications(),!0):(i.vE.logger.warn("comments","not found comment by id ",n),!0)})),this.$el.on("click",`.${ea.OW.tools.item}[data-role="branch"]`,(t=>{let e=ja.getCommentIDByElement(t.target);this.currentBranchId=this.currentBranchId!==e&&e})),this.$el.on("click",`.${ea.OW.tools.item}[data-role="to-parent"]`,(t=>{let e=ja.getCommentIDByElement(t.target);this.currentToParentID=this.currentToParentID!==e&&e})),this.$el.on("click",`.${ea.OW.tools.item}[data-role="from-parent"]`,(()=>{this.currentToParentID=!1})),this.$el.on("click",`.${ea.OW.rating.up}`,(t=>{let e=this.comments.get(ja.getCommentIDByElement(t.target));this._voteComment(e,ea.OC.UP,!0)})),this.$el.on("click",`.${ea.OW.rating.down}`,(t=>{let e=this.comments.get(ja.getCommentIDByElement(t.target));this._voteComment(e,ea.OC.DOWN,!0)})),this.$el.on("click",`.${ea.OW.tools.item}[data-role="save"]`,(t=>{let e=this.comments.get(ja.getCommentIDByElement(t.target));if(!i.vE.isUserAuthorized)return void i.vE.ui.authRequired();let s=!e.isSaved;e.isSaved=s,e.$toolSave.classList.toggle(ea.OW.tools.active,s),e.toolsShown=s})),this.$el.on("click",`.${ea.OW.controls.item}`,(t=>{let e=this.comments.get(ja.getCommentIDByElement(t.target)),s=t.currentTarget.getAttribute("data-type");if(!e)return;if("unpin"===s)return void this._handleUnpin(e);let n="create"===e.currentReplyMode,o="edit"===e.currentReplyMode;if("create"===s&&(d.c.getInstance().yandex.goal("tap-comment-reply"),d.c.getInstance().google.event("submit","comment")),"create"===s||"edit"===s?e.currentReplyMode=s:"remove"!==s&&(e.currentReplyMode=""),"create"===s&&this.lastOpenedCommentID&&this.lastOpenedCommentID!==e.id){let t=this.comments.get(this.lastOpenedCommentID);t.reply&&(t.savedReplyText=t.reply._editor.value)}if(this.lastOpenedCommentID=e.id,e._options.$controlAction=t.target,"remove"!==s)if(e.isResponseDisabled(!0)){if(!i.vE.isUserAuthorized){let t,s;(e.amountVotes||e.amountVotesHidden)&&([t,s]=e.amountVotesHidden?e.amountVotesHidden:e.amountVotes),d.c.getInstance().sendEvent("click",{post_id:e.meta.storyId,author_id:e.meta.storyAuthorId,type:"comment_reply",comment_id:e.id,comment_author_id:e.authorId,"pluses!undefined":t,"minuses!undefined":s})}}else"cancel"===s?(e.isReplyShown=!1,n&&(e.savedReplyText=e.reply._editor.value),o&&(e.reply._thumbs.clear(),oa.j.getPrefixedStorage(`comment_${e.id}`).clear())):(this._hideCurrentReply(),e.isReplyShown=!0);else this._handleRemoveComment(e)})),this.$el.on("click",`.${ea.OW.restore}`,(async t=>{var e;t.preventDefault();const s=this.comments.get(ja.getCommentIDByElement(t.target));var n,o;await s.restore()&&(null===(e=s.story)||void 0===e?void 0:e.authorId)===s.authorId&&(Na(`.${ea.OW.comment.deleted}[data-id="${s.id}"]`).removeClass(ea.OW.comment.deleted),"author"===i.vE.history.pathname.split("/").pop()&&(null===(n=this.story)||void 0===n||n.$els.commentsAuthors.data("total",Number(null===(o=this.story)||void 0===o?void 0:o.$els.commentsAuthors.data("total"))+1)))})),this.$el.on("click",`.${ea.OW.tools.item}[data-role="link"]`,(async t=>{const e=t.currentTarget,s=e.getAttribute("href");let n=ea.HW.extractCommentID(s);if(n||this.type!==ea.tz.STORY||(n=Number(Na(e).closest(`.${ea.OW.comment.comstory}`).attr("data-id"))),!n||!this.comments.has(n)||t.ctrlKey||t.metaKey)return;t.preventDefault();const o=this.comments.get(n);o.isComstory||i.vE.replaceState({},"",s),i.vE.ui.elementInViewport(o.el)||await o.scrollTo(),x.$.request((()=>{o.highlight("green",!0)}));const r=document.createElement("span");r.textContent=s,document.body.appendChild(r);const a=document.createRange();a.selectNodeContents(r);const l=window.getSelection();l.removeAllRanges(),l.addRange(a),document.execCommand("copy"),r.remove(),d.c.getInstance().sendEvent("share_to_social_network",{type:"link_comment",social_network:"link_comment"});let h=Na(e).data("hint");h&&(h.content.find(".popup__hint").html("Скопирована!"),h.updatePosition(),h.destroyAfterHide=!0)}));let t=`.${ea.OW.children.el}`;return this.$el.on("mousemove",t,Ba.throttle((e=>{let s=e.offsetX;e.target.matches(t)&&s>=-2&&s<20&&e.offsetY>20&&(this.currentChildrenCollapsingArea=ja.getCommentIDByElement(e.target),e.stopPropagation())}),10)),this.$el.on("click",(async e=>{if(!window.getSelection().toString()&&e.target.matches(t)&&this.currentChildrenCollapsingArea){let t=this.comments.get(this.currentChildrenCollapsingArea);if(t.isFake)return void ja.toFakeComment();i.vE.ui.elementInViewport(t.$body)||await t.scrollTo(!0),t.isChildrenShown=!1,t.highlight("green")}})),this.$el.on("click",`.${ea.OW.tools.item}[data-role="complain"]`,(t=>{if(t.preventDefault(),!i.vE.isUserAuthorized)return void i.vE.ui.toasts.showWarningMessage(i.ZF.AUTHORIZATION_REQUIRED);const e=t.target.dataset.iscomstory?"post":"comment";this._complainModalPopup=new Pa.n({destroyAfterHide:!0,targetId:t.target.dataset.parentstoryid||t.target.dataset.id,authorId:t.target.dataset.commentauthorid,targetType:e,name:"UIComplainModalPopup"}),this._complainModalPopup.show()})),this.$el.on("mouseout",(()=>{this.currentChildrenCollapsingArea=!1})),this.listenTo(i.vE.ui,"beforeunload",(t=>{let e;this.type!==ea.tz.STORY||this.isSliceMode||this.setMaxCommentIDToStorage();for(let s of this.comments.values())if(s.isReplyShown&&s.reply&&!s.reply.isEmpty&&!s.reply.isSaved){e=s;break}if(e){this.timeout("close-timeout",100,(()=>{let t=e.reply.$el;e.highlight("yellow",!0),t&&!i.vE.ui.elementInViewport(t)&&i.vE.ui.scrollTo(e.reply.$el.offset().top-50,!0)}));let s=i.vE.i18n("comments.before-exit");return t.returnValue=s,s}})),this.listenTo(i.vE.ui,"unload",(()=>{this.cancelTimeout("close-timeout")})),this.listenTo(i.vE,"comment_edit",(t=>{var e;if(this.$el.hasClass("comments_show"))return;const s=this.comments.get(t.id);if(!s||(null===(e=s.story)||void 0===e?void 0:e.authorId)!==s.authorId)return;const i=Na(t.content).find(".comment__content");s&&i.length&&(s.$content.innerHTML=i.html())})),this.$els.more.button.off(),this.$els.more.button.click(this.handleClickMoreButton.bind(this)),this}async _handleRemoveComment(t){var e,s,n,o,r,a;await t.remove()&&(null===(e=t.story)||void 0===e?void 0:e.authorId)===t.authorId&&("author"===i.vE.history.pathname.split("/").pop()?null===(s=this.story)||void 0===s||null===(n=s.allComments.comments.get(t.id))||void 0===n||n.$el.addClass(ea.OW.comment.deleted):(null===(o=this.story)||void 0===o||o.$els.commentsAuthors.data("total",Number(null===(r=this.story)||void 0===r?void 0:r.$els.commentsAuthors.data("total"))-1),null===(a=this.story)||void 0===a||a.$els.commentsAuthors.find(`.comments_author[data-id="${t.id}"]`).addClass(ea.OW.comment.deleted)))}_attachAnswersTogglers(t){let e=`.${ea.OW.user.answers}`,s=this.$els.answers.parent();return this.$els.answers.on("mousemove",Ba.throttle((t=>{let i=t.offsetX;t.target.matches(e)&&i>=-2&&i<20&&t.offsetY>20?(s.addClass(ea.OW.comment.collapsingArea),t.stopPropagation()):s.removeClass(ea.OW.comment.collapsingArea)}),10)),this.$els.answers.on("mouseleave",Ba.throttle((()=>{s.removeClass(ea.OW.comment.collapsingArea)}),10)),this.$els.answers.on("click",(async n=>{if(!window.getSelection().toString()&&n.target.matches(e)&&s.hasClass(ea.OW.comment.collapsingArea)){let e=this.comments.get(t);i.vE.ui.elementInViewport(e.el)||await e.scrollTo(!0),this.$els.toggleAnswers.trigger("click")}})),this._answersTogglersAttached=!0,this}static toFakeComment(t){i.vE.ui.toasts.add("slice-mode",{content:'Родительский комментарий находится на другой стороне луны, <a href="'+i.vE.location.pathname+(t?"?cid="+t:"#comments")+'">вылететь за ним</a>'})}async loadComments(t=!1){this.$els.more.button.hide();const e=await super.loadComments(t);return t||(this.isAuthorsType?(Ba.forEach(this.$parent.find(".comments_author"),(t=>{const e=Number(Na(t).data("id"));this.story.commentsAuthors.has(e)||this.story.commentsAuthors.set(e,new xa(t.querySelector(".comment"),this))})),this._updateEndOfComments()):this._updateHeader()),e}_attachModTools(){this.$el.on("click",`.${ea.OW.tools.item}[data-role="ban"]`,(t=>{t.stopPropagation(),t.preventDefault();let e=Na(t.target).closest(`.${ea.OW.tools.item}`),s=Na(t.target).closest(`.${ea.OW.comment.body}`),i=e.data("user-id"),n=e.data("comment-id");i&&(s.length&&s.addClass(`${ea.OW.comment.body}_active`),(new Da.$).on("cancel",(()=>{s.removeClass(`${ea.OW.comment.body}_active`)})).on("complete",(()=>{e.addClass(`${ea.OW.tools.item}_active`),s.removeClass(`${ea.OW.comment.body}_active`)})).showBanUserDialog(t.target,i,n,2))})),this.$el.on("click",`.${ea.OW.tools.item}[data-role="branch-hide"]`,(t=>{t.stopPropagation(),t.preventDefault();const e=Na(t.target).closest(`.${ea.OW.tools.item}`),s=e.data("user-id"),n=e.data("comment-id");s&&n&&(new Da.$).on("complete",(async()=>{const t=this.comments.get(n);await t.branchHide()&&new v.O({content:i.vE.i18n("comments.success.hidden")}).show()})).showHideBranchDialog(t.target,s,n)})),this.$el.on("click",`.${ea.OW.tools.item}[data-role="branch-show"]`,(t=>{t.stopPropagation(),t.preventDefault();const e=Na(t.target).closest(`.${ea.OW.tools.item}`),s=e.data("user-id"),n=e.data("comment-id");s&&n&&(new Da.$).on("complete",(async()=>{const t=this.comments.get(n);await t.branchShow()&&new v.O({content:i.vE.i18n("comments.success.shown")}).show()})).showRestoreBranchDialog(t.target,s,n)})),this.$el.on("click",`.${ea.OW.tools.item}[data-role="remove"]`,(t=>{let e=Na(t.target).closest(`.${ea.OW.tools.item}`),s=Na(t.target).closest(`.${ea.OW.comment.body}`),n=s.find(`.${ea.OW.comment.content}`),o=e.data("comment-id");o&&(s.length&&s.addClass(`${ea.OW.comment.body}_active`),(new Da.$).on("cancel",(()=>{s.removeClass(`${ea.OW.comment.body}_active`)})).on("complete",(t=>{e.hide(),s.find(`.${ea.OW.tools.item}[data-role="restore"]`).show(),n.html('<span style="color: #888888;">'+i.vE.i18n("comments.success.deleted")+t.toLowerCase()+"</span>"),new v.O({content:`${i.vE.i18n("comments.success.deleted")}${t.toLowerCase()}`}).show()})).showDeleteCommentDialog(t.target,o))})),this.$el.on("click",`.${ea.OW.tools.item}[data-role="restore"]`,(t=>{let e=Na(t.target).closest(`.${ea.OW.tools.item}`),s=e.data("comment-id"),n=Na(t.target).closest(`.${ea.OW.comment.body}`);s&&(new Da.$).on("complete",(function(){e.hide(),n.find(`.${ea.OW.tools.item}[data-role="remove"]`).show(),new v.O({content:i.vE.i18n("comments.success.restored")}).show()})).restoreComment(s)})),this.$el.on("click",`.${ea.OW.tools.item}[data-role="history"]`,(t=>{t.preventDefault(),t.stopPropagation();let e=Na(t.target),s=e.closest(`.${ea.OW.comment.body}`),i=e.data("comment-id"),n=s.find(`.${ea.OW.comment.history}`);if(n.length)return n.slideToggle("fast"),void e.toggleClass(`${ea.OW.tools.item}_active`);i&&(new Da.$).on("complete",(t=>{if(0===t.length)return;let i=t.map((t=>({deleteModeratorName:t.delete_moderator_name?t.delete_moderator_name:"",date:t.date?t.date:"",restoreModeratorName:t.restore_moderator_name?t.restore_moderator_name:"",reason:t.reason?t.reason:""}))),n=Na(restoreHistoryTemplate(i)),o=s.find(`.${ea.OW.comment.content}`);n.hide().insertBefore(o).slideToggle("fast"),e.addClass(`${ea.OW.tools.item}_active`)})).getCommentRestoreHistory(i)})),this.$el.on("click",`.${ea.OW.tools.item}[data-role="take"]`,(t=>{t.preventDefault(),t.stopPropagation();let e=Na(t.target),s=e.data("current"),i=e.siblings(".comment__moderator-loading"),n=e.data("id");n&&(i.show(),(new Da.$).on("cancel",(()=>{i.hide()})).on("complete",(()=>{e.data("current",s?0:1).text(s?"берусь":"вернуть").attr("title",s?"Взяться на проверку":"Вернуть с проверки"),i.hide()})).takeModCall(n,s))})),this.$el.on("click",`.${ea.OW.tools.item}[data-role="check"]`,(t=>{t.preventDefault(),t.stopPropagation();let e=Na(t.target).closest(`.${ea.OW.tools.item}`),s=e.siblings(".comment__moderator-loading"),i=e.siblings(`.${ea.OW.tools.item}[data-role="take"]`),n=e.data("current"),o=e.data("id");o&&(s.show(),(new Da.$).on("cancel",(()=>{s.hide()})).on("complete",(()=>{e.data("current",n?0:1).find(".comment__tool-text").text(n?"проверено":"отмена").toggleClass("comment__tool_moderator-active",!n).attr("title",n?"Проверка выполнена":"Убрать отметку о проверке"),i[n?"fadeIn":"fadeOut"](200),s.hide()})).approveModCall(o,n))}))}_hideCurrentReply(){return this.comments.forEach((t=>{t.isMain||t.reply&&t.isReplyShown&&(t.isReplyShown=!1)})),this}_attachMouseEnterComment(){return this.$el.on("mouseenter",`.${ea.OW.comment.body}`,Ba.debounce((t=>{this.currentCommentId=ja.getCommentIDByElement(t.target)}),50)),this}static getCommentIDByElement(t,e=!1){if(!r.Zv.isHTMLElement(t))throw new Error("expected HTMLElement");let s=e?".comments_author":`.${ea.OW.comment.item}`,i=t.closest(s);return i?parseInt(i.getAttribute("data-id")||0,10):null}_voteComment(t,e,s=!1){if(!t)return this;if(!i.vE.isUserAuthorized){let s,n;return i.vE.ui.authRequired(),(t.amountVotes||t.amountVotesHidden)&&([s,n]=t.amountVotesHidden?t.amountVotesHidden:t.amountVotes),d.c.getInstance().sendEvent("click",{type:"comment_rate",post_id:t.meta.storyId,author_id:t.meta.storyAuthorId,user_rate:e.value,comment_id:t.id,comment_author_id:t.authorId,"pluses!undefined":s,"minuses!undefined":n}),this}return i.vE.isLostAccount?(i.vE.ui.toasts.showWarningMessage(i.ZF.LOST_ACCOUNT),this):(t.voteDirection(e),this)}_updateHeader(){let t=this.comments.size;Na(".section_header-comments").removeClass("section_header-comments_disabled"),this.$el.toggleClass("comments_show",t>1)}_updateEndOfComments(){let t=this.isAuthorsType?Na(".comments_author").length:this.story.$els.comments.find(".comment").length,e=this.isAuthorsType?this.story.$els.commentsAuthors.data("total"):this.story.$els.comments.data("total");this.$els.more.button.toggle(t<e),t<e&&this.$els.more.count.html(i.vE.i18n("comments.remained",e-t))}_updateTotalComments(t){this.$els.totalComments.length&&this.$els.totalComments.html(i.vE.i18n(t>0?"comments.remained":"comments.no-comments",t))}async handleClickMoreButton(){var t;i.vE.history.replaceState({},"","//"+i.vE.history.location.host+i.vE.history.location.pathname);const e=null===(t=this.story.$els.story.find("[data-subs-code]"))||void 0===t?void 0:t.data("subs-code");d.c.getInstance().sendEvent("click_show_comments",function(t){for(var e=1;e<arguments.length;e++){var s=null!=arguments[e]?arguments[e]:{};e%2?Ra(Object(s),!0).forEach((function(e){Ma(t,e,s[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(s)):Ra(Object(s)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(s,e))}))}return t}({post_id:this.storyId,author_id:this.storyAuthorId},e&&{type_i8:Number(e)})),this.$els.more.prefix.length&&!this._isReplacedCommentsButtonText&&(this.$els.more.prefix.text(this.$els.more.prefix.data("replace-on-update")),this._isReplacedCommentsButtonText=!0),await this.loadComments(),this.emit("comments-loaded"),this._showNewFeatureNotifications()}_showNewFeatureNotifications(){const t=this._getUserFollowerNotificationOptions(),e=this._getAuthorFollowerNotificationOptions(),s=[];t&&s.push((()=>this._showNewIconFeaturePopup(t))),e&&s.push((()=>this._showNewIconFeaturePopup(e))),s.length&&super._showNewFeatureNotifications(s)}_getAuthorFollowerNotificationOptions(){if(Fa)return;const t="author-follower",e=this._getFirstIconLabel(t);if(!e)return;Fa=!0;return{id:t,target:e,content:`\n\t\t\t<div class="popup__content-notification" style="max-width: 240px">\n\t\t\t\t<button data-role="close" class="button_link popup__icon-close">\n\t\t\t\t\t${(0,j.q)("ui__close","popup")}\n\t\t\t\t</button>\n\t\t\t\t<p>Хорошие новости! Теперь вы&nbsp;можете видеть, кто из&nbsp;комментаторов является подписчиком автора 👀</p>\n\t\t\t</div>\n\t\t`}}_getUserFollowerNotificationOptions(){if(Ua)return;const t="user-follower",e=this._getFirstIconLabel(t);if(!e)return;Ua=!0;return{id:t,target:e,content:`\n\t\t\t<div class="popup__content-notification" style="max-width: 240px">\n\t\t\t\t<button data-role="close" class="button_link popup__icon-close">\n\t\t\t\t\t${(0,j.q)("ui__close","popup")}\n\t\t\t\t</button>\n\t\t\t\t<p>Хорошие новости! Теперь вы&nbsp;можете видеть, кто из&nbsp;комментаторов является вашим подписчиком 👀</p>\n\t\t\t</div>\n\t\t`}}get currentCommentId(){return this._options.currentCommentId}set currentCommentId(t){this._options.currentCommentId!==(t="number"==typeof t?t:parseInt(t,10))&&(this._options.currentCommentId=t,i.vE.logger.log("comments","set current comment",t))}get currentBranchId(){return this._options.currentBranchId}set currentBranchId(t){let e=this._options.currentBranchId,s=!(!1===t||t===e);t=Ba.isBoolean(t)?e:Number(t);let n=this.comments.get(t);if(!n||n.parentID===ea.iM)return;if(!n.parent)return void ja.toFakeComment(n.parentID);if(s&&e&&t!==e){let t=this.comments.get(e);t.$toolBranch.classList.remove(ea.OW.tools.active),t.toolsShown=!1,t.highlight("green",!1,!1)}let o=ea.OW.comment.hidden,r="."+(s?ea.OW.comment.item:o),a=ea.OW.children.hidden.buttonHidden,l=this.$els.comments.get(0),h=n.el.getBoundingClientRect().top;s&&(r+=n.getBranchIDs().reduce(((t,e)=>t+':not([data-id="'+e+'"])'),"")),l.querySelectorAll(r).forEach((t=>t.classList.toggle(o,s))),l.querySelectorAll(`.${s?ea.OW.children.hidden.button:a}`).forEach((t=>t.classList.toggle(a,s))),this.animationFrame("scrollTo",(()=>{s&&(i.vE.ui.sidebar._lastScrollTop=0),i.vE.ui.scrollTo(i.vE.ui.scrollTop+n.el.getBoundingClientRect().top-h)})),n.$toolBranch.classList.toggle(ea.OW.tools.active,s),n.toolsShown=s,n.highlight("green",!1,s),this._options.currentBranchId=!!s&&t}get currentToParentID(){return this._options.currentToParentID}set currentToParentID(t){let e=this._options.currentToParentID,s=!(!1===t||t===e);t=Ba.isBoolean(t)?e:Number(t),e&&e!==t&&this.comments.get(this.currentToParentID).toggleToolParent(!1,!1);let i=this.comments.get(t);i&&i.hasParent&&i.parentID!==ea.iM?i.parent?(i.toggleToolParent(s),this._options.currentToParentID=!!s&&t):ja.toFakeComment(i.parentID):this._options.currentToParentID=!1}get currentChildrenCollapsingArea(){return this._options.currentChildrenCollapsingArea}set currentChildrenCollapsingArea(t){let e=this._options.currentChildrenCollapsingArea;if(e!==t){if(e&&this.comments.get(e).el.classList.remove(ea.OW.comment.collapsingArea),t){let e=this.comments.get(t);e.hasChildren&&e.el?e.el.classList.add(ea.OW.comment.collapsingArea):t=!1}this._options.currentChildrenCollapsingArea=t}}get loadAnimation(){return this._options.loadAnimation}set loadAnimation(t){let e=this._options.loadAnimation;if((t=Boolean(t))===e)return t;t&&!this._loadingAnimation&&this.$els.spinner.length&&(this._loadingAnimation=i.vE.ui.player.createAnimation("comments-spinner",{$parent:this.$els.spinner})),this._loadingAnimation&&this._loadingAnimation.togglePlay(t),this._options.loadAnimation=t}_initAdAnalytics(){V.Q.instance.watch(Na(".ads-under-post"),H.L.UNDER_POST)}}var Va=s(9537);const Ha=s(9755);class qa extends Fs.T3{render(){return this.isRendered||(this.$el=ee()(".page-comments"),this.$els={input:this.$('.input[data-role="search"]')},this.$els.input.length&&(this._searchInput=new T.u3(this.$els.input)),new ui.z({$el:this.$(".comments-part"),mode:f.lL.OUTCOMING}).show().initComments(),new hi.B,i.vE.ui.screen=lt.d.USER_COMMENTS,Ii.SR.getInstance().init("my_comments_visit"),super.render()),this}}const Wa=s(9755);class Ga extends Fs.T3{render(){return this.isRendered||(this.$el=Wa(".page-comments"),this.$els={input:this.$('.input[data-role="search"]')},this.$els.input.length&&(this._searchInput=new T.u3(this.$els.input)),new ui.z({$el:this.$(".comments-part"),mode:f.lL.OUTCOMING}).show().initComments(),new hi.B,super.render()),this}}const za=s(9755);class Za extends Fs.T3{render(){return this.isRendered||(this.$el=za("#subscribe-success"),setTimeout((()=>{window.location.href="/"}),5e3),super.render()),this}}const Ka=s(9755);class Xa extends Fs.T3{render(){return this.isRendered||(this.$el=Ka(".page-top-comments"),this.$els={},new hi.B,new ui.z({$el:this.$(".comments-part"),mode:f.lL.BEST}).show().initComments(),i.vE.ui.screen=lt.d.TOP_COMMENTS,super.render()),this}}const Qa=s(9755);class Ja extends Fs.T3{render(){return this.isRendered||(this.$el=Qa(".page-story-preview"),this._initStoryFeed(),super.render()),this}_initStoryFeed(){return new ys._D({useEmptyIds:!0,$el:this.$el,feedName:"story-preview"}),this}}var tl=s(4437),el=s(5035),sl=s(6553);const il=s(9755);class nl extends tl.vr{render(){return this.isRendered||(this.$el=il('<div class="story-editor-add__wrapper">\n\t<div class="story-editor-add__button">\n\t\t<button class="button_success" type="button" data-role="text" data-name="текст"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon--story-editor__text"><use xlink:href="#icon--story-editor__text"></use></svg></button>\n\t</div>\n\t<div class="story-editor-add__button attach">\n\t\t<button class="button_success attach" type="button" data-role="image" data-name="картинка"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon--ui__photo icon--ui__photo_add"><use xlink:href="#icon--ui__photo"></use></svg></button>\n\t\t<input type="file" accept="image/*" multiple>\n\t</div>\n\t<div class="story-editor-add__button">\n\t\t<button class="button_success" type="button" data-role="video-input" data-name="видео"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon--story-editor__play icon--story-editor__play_add"><use xlink:href="#icon--story-editor__play"></use></svg></button>\n\t</div>\n</div>'),this._onClickAddBound=this._onClickAdd.bind(this),this.$els={wrapper:this.$(".story-editor-add__wrapper"),image:this.$('button[data-role="image"]'),video:this.$('button[data-role="video-input"]').on("click",this._onClickAddBound),text:this.$('button[data-role="text"]').on("click",this._onClickAddBound),imageInput:this.$('button[data-role="image"]').on("click",(t=>{t.currentTarget.classList.contains("button_disabled")||this.$els.imageInput.click()})).next().on("click",(t=>t.stopPropagation())).on("change",this._onImageInputChange.bind(this)),locked:il(document.createElement("div")).addClass("story-editor-add__locked").hide().appendTo(this.$parent)},super.render(),this._updateLimits(this.editor.limits)),this}_updateLimits(t){if(!this.isRendered)return;if(t.has(tl.R6.MIN_RATING)||t.has(tl.R6.MAX_BLOCKS))return this.$els.locked.html(t.has(tl.R6.MIN_RATING)?this._renderDisabledHint():t.has(tl.R6.MAX_BLOCKS)?i.vE.i18n("story-editor.limits.max-blocks",this.editor.maxBlocks):""),void this.$parent.attr("data-locked",!0);this.$parent.removeAttr("data-locked");let e=t.has(tl.R6.MAX_MEDIA),s=e||t.hasSome(tl.R6.MAX_IMAGES,tl.R6.MIN_RATING_IMAGES),n=e||t.hasSome(tl.R6.MAX_VIDEOS,tl.R6.MIN_RATING_VIDEOS),o=e?i.vE.i18n("story-editor.limits.max-media",this.editor.maxMedia):"",r=o,a=o;e||(t.has(tl.R6.MAX_IMAGES)?r=i.vE.i18n("story-editor.limits.max-images",this.editor.maxImages):t.has(tl.R6.MIN_RATING_IMAGES)&&(r=i.vE.i18n("story-editor.limits.min-rating-images",this.editor.minRatingImages-i.vE.userRating))),e||(t.has(tl.R6.MAX_VIDEOS)?a=i.vE.i18n("story-editor.limits.max-videos",this.editor.maxVideos):t.has(tl.R6.MIN_RATING_VIDEOS)&&(a=i.vE.i18n("story-editor.limits.min-rating-videos",this.editor.minRatingVideo-i.vE.userRating))),this.$els.image.toggleClass("button_disabled",s).toggleClass("hint",s).attr("aria-label",r),this.$els.video.toggleClass("button_disabled",n).toggleClass("hint",n).attr("aria-label",a)}_renderDisabledHint(){if(this._$disabledHint)return this._$disabledHint;let t=Boolean(this.editor.minRatingVideo)&&Boolean(this.editor.minRatingImages)?Math.min(this.editor.minRatingVideo,this.editor.minRatingImages):this.editor.minRatingVideo||this.editor.minRatingImages;return this._$disabledHint=il(`<p>${i.vE.i18n("story-editor.limits.min-rating",t)}</p><a href="/information/faq#3" target="_blank">${i.vE.i18n("story-editor.more-information")}</a>`)}_onClickAdd(t){let e=il(t.currentTarget),s=sl.STORY_BLOCK_TYPE[e.data("role")];return e.hasClass("button_disabled")?this:(t&&t.preventDefault()&&t.stopPropagation(),e.prop("disabled")||(s&&this.editor.addBlock(s,this.block),this.block&&this.hide()),this)}_onImageInputChange(t){if(this.editor.limits.has(tl.R6.MAX_IMAGES)||this.editor.limits.has(tl.R6.MIN_RATING_IMAGES))return;let e=ge.nO.getImageFiles(t);e.length&&(this.editor.addImageBlock(e,this.block),this.$els.imageInput.val("")),this.block&&this.hide()}toggleShown(t,e=!1){return e?this.isShown=t:t?(this.show(),this.$el.fadeIn(200)):(this.$el.fadeOut(200),this.timeout("toggle",200,(()=>{this.hide()}))),this}}const ol=s(9755),rl=s(6419);class al extends tl.k9{destroy(t,e=!0){d.c.getInstance().yandex.goal("tgp-dv__remove-block");const s=()=>{this.$el.remove(),this.$elMini.remove(),super.destroy(t),this._addPanel.destroy()};e?(this.$elMini.fadeOut(200),this.$el.fadeOut(200,s)):s()}render(){return this._canCancelRemove=!0,this.$el=ol(function(t){var e,s="";return Array.prototype.join,s+='<div class="story-editor-block story-editor-block_type_'+(null==(e=t.type.toString())?"":e)+'">\n\t<div class="story-editor-block__adding-before" style="display: block" title="Добавить блок">\n\t\t<svg xmlns="http://www.w3.org/2000/svg" class="icon icon--story-editor__plus"><use xlink:href="#icon--story-editor__plus"></use></svg>\n\t</div>\n\t<div class="story-editor-add"></div>\n\t<div class="story-editor-block__wrapper">\n\t\t',t.isDisabledLeaveLink||(s+='\n\t\t<div class="story-editor-block__leave-link">оставить ссылкой</div>\n\t\t'),s+='\n\t\t<div class="story-editor-block__move"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon--ui__hamburger icon--ui__hamburger_story-editor"><use xlink:href="#icon--ui__hamburger"></use></svg></div>\n\t\t<div class="story-editor-block__content"></div>\n\t\t<div class="story-editor-block__tools">\n\t\t\t<div class="story-editor-block__remove" style="display: block" title="Удалить">\n\t\t\t\t<svg xmlns="http://www.w3.org/2000/svg" class="icon icon--ui__remove icon--ui__remove_story-editor"><use xlink:href="#icon--ui__remove"></use></svg>\n\t\t\t</div>\n\t\t</div>\n\t</div>\n\t<div class="story-editor-block__remove-overlay" style="display: none">\n\t\t<span class="story-editor-block__remove-message"></span>\n\t\t<div>\n\t\t\t<button class="button_success story-editor-block__remove-tool" type="button" data-role="retry" style="display: none;">повторить</button>\n\t\t\t<button class="button_success story-editor-block__remove-tool" type="button" data-role="cancel">оставить</button>\n\t\t\t<button class="button_danger story-editor-block__remove-tool" type="button" data-role="success">удалить</button>\n\t\t</div>\n\t</div>\n\t<div class="story-editor-block__loading" style="display: none"></div>\n</div>'}({type:this.data.type.valueOf(),isDisabledLeaveLink:this.data.isDisabledLeaveLink})),this.el=this.$el.get(0),this.$el.hide(),this.$els={adding:this.$(".story-editor-block__adding-before").click(this._onClickAdd.bind(this)).toggle(!this.data.isDisabledAdding),addPanel:this.$(".story-editor-add"),wrapper:this.$(".story-editor-block__wrapper"),content:this.$(".story-editor-block__content"),loading:this.$(".story-editor-block__loading"),leaveLink:this.$(".story-editor-block__leave-link").on("click",this._onClickLeaveLink.bind(this)),remove:{icon:this.$(".story-editor-block__remove").click(this._onClickRemove.bind(this)).toggle(!this.data.isDisabledDelete),overlay:this.$(".story-editor-block__remove-overlay"),message:this.$(".story-editor-block__remove-message"),retry:this.$('.story-editor-block__remove-tool[data-role="retry"]'),success:this.$('.story-editor-block__remove-tool[data-role="success"]').click(this._onClickRemoveSuccess.bind(this)),cancel:this.$('.story-editor-block__remove-tool[data-role="cancel"]').click(this._onClickRemove.bind(this))}},this._addPanel=new nl({editor:this.editor,$parent:this.$els.addPanel,block:this}),this.listenTo(this._addPanel,n.eM.UNMOUNTED,this._updateAddButton.bind(this,!1)),this.listenTo(this._addPanel,n.eM.MOUNTED,this._updateAddButton.bind(this,!0)),this.$el.fadeIn(200),this.$el}renderMini(){return this.$elMini=ol(document.createElement("div")).addClass("story-editor-block-mini").addClass("story-editor-block-mini_type_"+this.data.type.valueOf()),this.elMini=this.$elMini.get(0),this.$elMini.on("click",(async()=>{await i.vE.ui.scrollTo(this.$el.offset().top-15,!0),this.focus()})),this.$elMini}_onClickLeaveLink(){this.destroy()}focus(){return this}_updateAddButton(t){return this.$els.adding.toggleClass("story-editor-block__adding-before_open",t),this}_onClickAdd(){let t=this.$els.adding.hasClass("story-editor-block__adding-before_open");this._addPanel.toggleShown(!t)}_onClickRemoveSuccess(t){return t&&t.preventDefault&&t.preventDefault(),this.destroy(),this}_onClickRemove(t){t&&t.preventDefault&&t.preventDefault(),this.data.isDisabledDeleteConfirm?this.destroy():this._toggleRemoveOverlay(void 0,!1,!0)}_toggleRemoveOverlay(t,e,s=!0,n=!1){if(!(t=rl.isBoolean(t)?t:!this.$els.remove.overlay.is(":visible"))&&!1!==t&&!this._canCancelRemove)return this;if(rl.isBoolean(s)&&(this.$els.remove.cancel.toggle(s),this._canCancelRemove=s),this.$els.remove.retry.toggle(!0===n),this.$els.remove.message.html(i.vE.i18n(rl.isString(e)?e:"story-editor.remove.confirmation")),t){if(!n){const t=this.$el.offset().top+this.$el.height()/2-window.innerHeight/2;i.vE.ui.scrollTo(t,!0)}this.$els.remove.overlay.fadeIn(200)}else this.$els.remove.overlay.fadeOut(200);return this}}const ll=s(9755),hl=s(6419);class cl extends al{destroy(t,e){this.isUploaded&&this._removeImage(),super.destroy(t,e)}render(){return this.$el||(super.render(),this.preview.then((()=>{const t=this._getSize(),e=t[0],s=t[1];e&&s&&e<700&&this.$el.addClass("story-editor-block_padding_left"),this.isUploaded||(this.loading=!0),this.data.is_animated_image?(ll(function(t){var e,s="";return s+'<div class="player" data-type="gifx" data-probe="true" data-width="'+(null==(e=t.width)?"":e)+'" data-height="'+(null==(e=t.height)?"":e)+'">\n\t<svg class="player__svg-stretch" aria-hidden="true" width="'+(null==(e=t.width)?"":e)+'" height="100%" viewBox="0 0 '+(null==(e=t.width)?"":e)+" "+(null==(e=t.height)?"":e)+'"></svg>\n\t<div class="player__play"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon--player__play"><use xlink:href="#icon--player__play"></use></svg></div>\n\t<div class="player__state" data-type="loading"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon--ui__progress-circle icon--ui__progress-circle_player"><use xlink:href="#icon--ui__progress-circle"></use></svg></div>\n\t<div class="player__state player__state_show" type="unstarted" style="">GIF</div>\n</div>'}({width:e,height:s})).append(this.data.$preview.addClass("player__preview")).appendTo(this.$els.content),i.vE.ui.player.init(this.$el)):this.$els.content.append(this.data.$preview)})),this.listenTo(this,"progress",(()=>{this._progress&&this.data.progress>8&&(this._progress.percent=this.data.progress)})),this.$els.remove.retry.on("click",(()=>{this._toggleRemoveOverlay(!1),this.upload()}))),this.$el}renderMini(){return this.$elMini||(super.renderMini(),this.preview.then((()=>{ll(this.data.$previewMini).appendTo(this.$elMini),this.data.is_animated_image&&ll(document.createElement("div")).addClass("story-editor-block-mini__play").append(i.vE.icon("player__play","mini")).appendTo(this.$elMini)}))),this.$elMini}_getSize(){let t=0,e=0;return this.data.size&&this.data.size.length&&(t=this.data.size[0],e=this.data.size[1]),t>650&&t<700&&([t,e]=c.cQ.calculateAspectRatioFit(t,e,650,9100)),i.vE.logger.log("_getSize",[t,e]),[Number(t),Number(e)]}async _getPreviewFile(){const t=await ge.nO.getInfo(this.data.source);t.exif&&t.exif.Orientation&&t.exif.Orientation>4?this.data.size=[t.height,t.width]:this.data.size=[t.width,t.height],this.data.is_animated_image=await ge.nO.isAnimatedGif(this.data.source);const e=new ge.Np(this.data.source),s=this._getSize(),n=s[0],o=s[1];e.rotate("auto");try{this.data.$preview=ll(await e.preview(n,o).get()),this.data.$previewMini=ll(await e.preview(250,40).get())}catch(r){return i.vE.logger.error(r),this.destroy(),!1}return!0}async _getPreviewUrl(){const t=this.data.url_preview||this.data.url;if("string"!=typeof t)return!1;const e=this._getSize(),s=e[0],i=e[1],n=ll(document.createElement("img")).attr("src",t);return s&&i&&n.attr("width",s).attr("height",i),this.data.$preview=n,this.data.$previewMini=ll(document.createElement("div")).addClass("story-editor-block-mini__image").css("background-image","url("+(this.data.url_preview||this.data.url)+")"),!0}_getPreviewSource(){return"string"!=typeof this.data.source?Promise.resolve(!1):new Promise((t=>{let e,s=()=>{this.data.size=[e[0].width,e[0].height],t(!0)};e=ll(document.createElement("img")).on({error:()=>t(!1),load:()=>s}).attr("src",this.data.source),this.data.$preview=e,this.data.$previewMini=ll(document.createElement("div")).addClass("story-editor-block-mini__image").css("background-image","url("+this.data.source+")"),e[0].complete&&s()}))}async _upload(){let t,e={type:"story_image",save:1};if(this.data.attempts++,ge.nO.isSupportedImage(this.data.source))e.uid=0,t=await S.ff.upload(e,this.data.source,{progress:t=>{this.isDestroyed||(this.data.progress=t.loaded/t.total*100)}});else{e.url=this.data.source;let s=setInterval((()=>{this.isDestroyed||this.data.progress>=100?clearInterval(s):this.data.progress+=5}),1e3);t=await S.ff.post(e),clearInterval(s)}if(this.loading=!1,t.response.result&&t.data){let e=Boolean(t.data.preview),s=Boolean(t.data.small),i=s?t.data.small.file_url:e?t.data.preview.file_url:"";return this.isDestroyed?(this._removeImage(i),!0):(this.data.is_animated_image=s&&t.data.small.is_animated_image,e&&(this.data.url_preview=t.data.preview.url_preview),this.data.url=i,!0)}{if(this.isDestroyed)return!0;let e=t.response.message||"story-editor.errors.upload";413===t.response.status&&(this.data.attempts=tl._E,e=i.vE.i18n("story-editor.errors.upload-max",c.cQ.formatBytes(this.editor.limitImageBytes))),this._toggleRemoveOverlay(!0,e,!1,this.data.attempts<tl._E)}return this.marks.delete("upload"),!1}upload(){if(this.marks.has("upload"))return this.marks.get("upload");let t;return t=this.data.url?Promise.resolve(!0):this.data.attempts>=tl._E?Promise.resolve(!1):this._upload(),this.marks.set("upload",t),t}async _removeImage(t){S.cf.post("/ajax/gtpost_actions.php",{action:"delete_block",block_data:JSON.stringify({type:"image",url:t||this.data.url})})}get isUploaded(){return Boolean(this.data.url)}get preview(){return this._preview?this._preview:ge.nO.isSupportedImage(this.data.source)?this._preview=this._getPreviewFile():"string"==typeof this.data.source?this._preview=this._getPreviewSource():this._preview=this._getPreviewUrl()}canSerialize(){return Boolean(this.data.url)}}cl.prototype.defaults=hl.extend({url_preview:void 0,is_animated_image:!1,size:void 0,source:void 0,uploadedFileName:void 0,progress:void 0,error:void 0,attempts:0,$preview:void 0,$previewMini:void 0},al.prototype.defaults);const dl=s(9755),ul=s(6419),pl=T.op.escape();class ml extends al{destroy(t,e){this._textEditor.destroy(),super.destroy(t,e)}render(){return this.$el||(super.render(),this.$els.editor=dl(function(t){var e,s="";return s+'<div class="input input_editor input_flat" draggable="false">\n\t<div class="input__input" data-name="desc" contenteditable="true" title="" data-placeholder="Введите текст">'+(null==(e=t.body?t.body:"<p><br></p>")?"":e)+"</div>\n</div>"}({body:this.data.body})).appendTo(this.$els.content),oa.j.instance.add(oa.j.extract(this.data.body)),this._textEditor=new sa.Y(this.$els.editor),this._textEditor.suggestion=new C.xI,this._textEditor.suggestion.setPredefinedUsersInStory(0,u.PREDEFINED_USERS_TYPE.STORY),this.data.plainBody=pl(this._textEditor.textContent),this.listenTo(i.vE.ui,"paste-image",((t,e)=>{this._textEditor.focused&&this.editor.addImageBlock(t,this,!0)})),this.data.isDisabledDeleteConfirm=this._textEditor.isEmpty,this.listenTo(this.editor,"force-update-text",(()=>this._onUpdateText(this._textEditor.value))),this.listenTo(this._textEditor,"change",ul.debounce(this._onUpdateText.bind(this),tl.uW))),this.$el}async _onUpdateText(t){this.data.body!==t&&(this.data.body=t,this.data.plainBody=pl(this._textEditor.textContent),this.$elMini.html(pl(this._textEditor.textContent)),(await oa.j.instance.extractImageVideoUrls(t)).forEach((e=>{let s=t.indexOf(e.url)>(t.length-e.url.length)/2;e.type===oa.v.IMAGE&&this.editor.addImageBlock(e.url,this,s,!0),e.type===oa.v.VIDEO&&ce.tv.getVideoDetails(e.url).then((({response:t,data:e})=>{t.result?this.editor.addVideoBlock(e,this,s,!0):i.vE.ui.toasts.showError(t.message)})).catch((t=>i.vE.logger.error("video-block",t)))})),this.data.isDisabledDeleteConfirm=this._textEditor.isEmpty,this.editor.emit("text-changed"))}focus(){return this._textEditor.focus(),this}get isFocused(){return this._textEditor.focused}renderMini(){return this.$elMini||(super.renderMini(),this.$elMini.html(pl(this._textEditor?this._textEditor.textContent:this.data.body))),this.$elMini}canSerialize(){return Boolean(this.data.body)}}const _l=s(9755),gl=s(6419);class vl extends al{destroy(t,e){oa.j.instance.has(this.data.url)&&oa.j.instance.remove(this.data.url),super.destroy(t,e)}render(){return this.$el||(super.render(),_l(function(t){var e,s="";return s+'<div class="player" data-type="video" data-probe="true" data-id="4552579" data-ratio="'+(null==(e=t.ratio)?"":e)+'" data-duration="'+(null==(e=t.duration)?"":e)+'" data-source="'+(null==(e=t.url)?"":e)+'">\n\t<div class="player__stretch" style="padding-bottom: '+(null==(e=100/t.ratio)?"":e)+'%"></div>\n\t<div class="player__play"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon--player__play"><use xlink:href="#icon--player__play"></use></svg></div>\n\t<div class="player__preview" style="background-image: url(\''+(null==(e=t.url_preview)?"":e)+'\')"></div>\n\t<div class="player__state" data-type="loading"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon--ui__progress-circle icon--ui__progress-circle_player"><use xlink:href="#icon--ui__progress-circle"></use></svg></div>\n</div>'}({host:this.data.host,ratio:this.data.ratio,duration:this.data.duration,url:this.data.url,url_preview:this.data.url_preview})).appendTo(this.$els.content),i.vE.ui.player.init(this.$el)),this.$el}renderMini(){return this.$elMini||(super.renderMini(),this.$elMini.attr("style","background-image: url("+this.data.url_preview+")"),_l(document.createElement("div")).addClass("story-editor-block-mini__play").append(i.vE.icon("player__play","mini")).appendTo(this.$elMini)),this.$elMini}canSerialize(){return!0}}vl.prototype.defaults=gl.extend({url_preview:void 0,ratio:1.7,host:void 0,duration:0},al.prototype.defaults);var fl=s(7580);var yl=s(9050);class bl extends k.LD{constructor(t){super(),this.setOptions(t)}render(){if(this.isRendered)return this;super.render(),this._togglePlayBound=this._togglePlay.bind(this,void 0),this.$els.content.html(function(t){var e,s="";return s+'<form method="POST" action="javascript:void 0;" class="video-editor">\n\t<div class="video-editor__wrapper">\n\t\t<div class="video-editor__stretch" style="padding-bottom: '+(null==(e=100/t.ratio)?"":e)+'%"></div>\n\t\t<div class="video-editor__video-loader">\n\t\t\t<svg xmlns="http://www.w3.org/2000/svg" class="icon icon--ui__progress-circle icon--ui__progress-circle_player-native"><use xlink:href="#icon--ui__progress-circle"></use></svg>\n\t\t</div>\n\t\t<div class="video-editor__toast">Обрезка выполнена успешно</div>\n\t\t<video class="video-editor__video" crossorigin="" playsinline="" preload="auto" poster="'+(null==(e=t.source)?"":e)+'.jpg">\n\t\t\t<source src="'+(null==(e=t.source)?"":e)+'.mp4" type="video/mp4">\n\t\t</video>\n\t\t<div class="video-editor__controls-wrapper" style="display: none;">\n\t\t\t<div class="video-editor__controls">\n\t\t\t\t<div class="player__play-button">\n\t\t\t\t\t<div class="player__play-arrow player__play-arrow_left"></div>\n\t\t\t\t\t<div class="player__play-arrow player__play-arrow_right"></div>\n\t\t\t\t</div>\n\n\t\t\t\t<div class="video-editor-timeline">\n\t\t\t\t\t<div class="video-editor-timeline__amounts">\n\t\t\t\t\t\t<div class="video-editor-timeline__buffered-amount"></div>\n\t\t\t\t\t\t<div class="video-editor-timeline__progress-amount"></div>\n\t\t\t\t\t</div>\n\n\t\t\t\t\t<div class="video-editor-timeline__sliders">\n\t\t\t\t\t\t<div class="video-editor-timeline__slider" data-type="left">\n\t\t\t\t\t\t\t<svg width="10" height="36" viewBox="0 0 10 36" xmlns="http://www.w3.org/2000/svg">\n\t\t\t\t\t\t\t\t<g fill="none" fill-rule="evenodd">\n\t\t\t\t\t\t\t\t\t<path d="M8 34.998V35a1 1 0 0 0 2 0V1a1 1 0 1 0-2 0v33.998zM2 11h6v14H2a2 2 0 0 1-2-2V13a2 2 0 0 1 2-2z" fill="#EAEAEA"/>\n\t\t\t\t\t\t\t\t\t<path d="M4 22v-8H3v8h1zm2-8H5v8h1v-8z" fill="#000" fill-rule="nonzero"/>\n\t\t\t\t\t\t\t\t</g>\n\t\t\t\t\t\t\t</svg>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<div class="video-editor-timeline__slider" data-type="right">\n\t\t\t\t\t\t\t<svg width="10" height="36" viewBox="0 0 10 36" xmlns="http://www.w3.org/2000/svg">\n\t\t\t\t\t\t\t\t<g fill="none" fill-rule="evenodd">\n\t\t\t\t\t\t\t\t\t<path d="M2 34.998V35a1 1 0 0 1-2 0V1a1 1 0 1 1 2 0v33.998zM8 11H2v14h6a2 2 0 0 0 2-2V13a2 2 0 0 0-2-2z" fill="#EAEAEA"/>\n\t\t\t\t\t\t\t\t\t<path d="M6 22v-8h1v8H6zm-2-8h1v8H4v-8z" fill="#000" fill-rule="nonzero"/>\n\t\t\t\t\t\t\t\t</g>\n\t\t\t\t\t\t\t</svg>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\n\t\t\t\t\t<div class="video-editor-timeline__handler-wrapper">\n\t\t\t\t\t\t<div class="video-editor-timeline__handler"></div>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="video-editor-timeline__hint"></div>\n\t\t\t\t</div>\n\t\t\t\t<button type="button" data-type="cut">Обрезать</button>\n\t\t\t</div>\n\t\t</div>\n\t</div>\n\t<div class="video-editor__settings">\n\t\t<label'+(null==(e=t.hasAudio?"":' style="display: none;"')?"":e)+'>\n\t\t\t<input type="checkbox" name="isMuted" data-to-boolean="true" '+(null==(e=t.isMuted?"checked":"")?"":e)+'>\n\t\t\t<span>Удалить звук из видео</span>\n\t\t</label>\n\t\t<input type="hidden" name="cutFrom" value="'+(null==(e=t.cutFrom)?"":e)+'">\n\t\t<input type="hidden" name="cutTo" value="'+(null==(e=t.cutTo)?"":e)+'">\n\t</div>\n\t<div class="video-editor__main-controls">\n\t\t<button class="button_success" type="submit">Сохранить</button>\n\t\t<button type="button" data-type="cancel">Отменить</button>\n\t</div>\n</form>'}({source:this.block.data.info.src.url.replace(".mp4",""),ratio:1.7777,cutFrom:this.settings.data.cutFrom,cutTo:this.settings.data.cutTo,isMuted:this.settings.data.isMuted,hasAudio:this.settings.data.hasAudio})),this._form=new a.x(this.$("form")),this.listenTo(this._form,"submit",((t,e)=>{t.preventDefault(),this.emit("change",e.serialize()),this.hide()})),this.$els.controls=this.$(".video-editor__controls-wrapper"),this.$els.video=this.$(".video-editor__video").on({loadedmetadata:()=>{let t=this.settings.data.cutFrom,e=this.settings.data.cutTo;this._updateSliderLeft(t),this._updateSliderRight(e),this._updateBufferedTime(t,e),this.$els.controls.fadeIn(300)},timeupdate:()=>{this.marks.has("is-mousedown-in-timeline")||(this._updateProgressTime(this.currentTime),this.isPlayed&&(this.currentTime>=this.settings.data.cutTo||this.currentTime<this.settings.data.cutFrom)&&(this.currentTime=this.settings.data.cutFrom,this.play()))}}),this.$els.toast=this.$(".video-editor__toast"),this.$els.cutFrom=this.$('input[name="cutFrom"]'),this.$els.cutTo=this.$('input[name="cutTo"]'),this.$els.playButton=this.$(".player__play-button").on("click",this._togglePlayBound),this.$els.submitCutButton=this.$('button[data-type="cut"]').prop("disabled",!0).on("click",(()=>{this.settings.save("cut"),this.$els.toast.addClass("video-editor__toast_show"),this.timeout("toast-show",1500,(()=>{this.$els.toast.removeClass("video-editor__toast_show")}))})),this.$els.submitButton=this.$('button[type="submit"]'),this.$els.cancelButton=this.$('button[data-type="cancel"]').on("click",(()=>{this.hide()})),this.$els.loader=this.$(".video-editor__video-loader"),this.$el.addClass("popup_video-editor");let t=x.$.requestThrottle(this._onTimelineMouseMove.bind(this));return this.$els.timeline={el:this.$(".video-editor-timeline").on({mouseenter:this._onTimelineMouseEnter.bind(this),mouseleave:this._onTimelineMouseLeave.bind(this),mousedown:this._onTimelineMouseDown.bind(this),mousemove:e=>{this.marks.has("is-mousedown-in-timeline")||t(e)}}),handlerWrapper:this.$(".video-editor-timeline__handler-wrapper"),handler:this.$(".video-editor-timeline__handler"),sliderLeft:this.$('.video-editor-timeline__slider[data-type="left"]'),sliderRight:this.$('.video-editor-timeline__slider[data-type="right"]'),bufferedAmount:this.$(".video-editor-timeline__buffered-amount"),hint:this.$(".video-editor-timeline__hint")},this.els={video:this.$els.video.get(0),timeline:{el:this.$els.timeline.el.get(0)}},this.play(),this.els.video.volume=0,this}_onTimelineMouseDown(t){this.marks.set("is-mousedown-in-timeline",!0),this.listenTo(i.vE.ui,"pointer-move",this._onTimelineMouseMove),this.listenTo(i.vE.ui,"pointer-up",this._onTimelineMouseUp);let e=t.target.closest(".video-editor-timeline__slider");e?this.marks.set("slider",e.dataset.type):this.marks.delete("slider"),this._onTimelineMouseMove(t.pageX,!0),this.els.video.paused||(this.els.video.pause(),this.marks.set("video-playing-before-mouse-down",!0))}_onTimelineMouseMove(t,e){let s=t.pageX||t,i=this.marks.get("timeline-width"),n=Math.max(0,Math.min(s-this.$els.timeline.el.offset().left,i))/i,o=this.duration*n,r=fl.F.durationTime(o)+" ("+fl.F.durationTime(this.settings.data.cutTo-this.settings.data.cutFrom)+")";this._lastHintTime!==r&&(this._lastHintTime=r,this.$els.timeline.hint.text(r)),this.$els.timeline.hint.css("left",100*n+"%"),this.marks.has("is-mousedown-in-timeline")&&(this.marks.has("slider")?("left"===this.marks.get("slider")?this._normalizeSliders(!0,o):this._normalizeSliders(!1,o),this.currentTime=o):this._updateProgressTime(o)),!0===e&&(this.currentTime=o)}_onTimelineMouseUp(t){this.marks.delete("is-mousedown-in-timeline"),this.stopListening(i.vE.ui,"pointer-move"),this.stopListening(i.vE.ui,"pointer-up"),this._onTimelineMouseMove(t.pageX,!0),this.marks.has("video-playing-before-mouse-down")&&(this.currentTime>=this.settings.data.cutTo&&(this.currentTime=this.settings.data.cutFrom),this.els.video.play(),this.marks.delete("video-playing-before-mouse-down")),this.marks.has("is-mouse-in-timeline")||this.$els.timeline.hint.removeClass("player-timeline__hint_visible")}_onTimelineMouseEnter(){this.marks.set("is-mouse-in-timeline",!0),this.marks.set("timeline-width",this.els.timeline.el.offsetWidth),this.$els.timeline.hint.addClass("video-editor-timeline__hint_visible")}_onTimelineMouseLeave(){this.marks.delete("is-mouse-in-timeline"),this.marks.has("is-mousedown-in-timeline")||this.$els.timeline.hint.removeClass("video-editor-timeline__hint_visible")}_updateProgressTime(t){let e=this.duration,s=`translateX(${(t/e*100).toFixed(2)}%`;this.$els.timeline.handlerWrapper.css("transform",s);let i=fl.F.durationTime(e-t);i!==this._lastTimeBeforeEnd&&(this._lastTimeBeforeEnd=i)}_updateSliderLeft(t){if(this.isRendered){let e=this.duration;this.$els.timeline.sliderLeft.css("transform",`translateX(${(t/e*100).toFixed(2)}%`)}}_updateSliderRight(t){if(this.isRendered){let e=this.duration;this.$els.timeline.sliderRight.css("transform",`translateX(-${100-(t/e*100).toFixed(2)}%`)}}_updateBufferedTime(t,e){let s=this.duration,i=(t/s*100).toFixed(2),n=(e/s*100).toFixed(2)-i;this.$els.timeline.bufferedAmount.css("left",i+"%").css("width",n+"%")}_togglePlay(t){return yl.isUndefined(t)&&(t=!this.isPlayed),t?this.play():this.pause()}play(){if(this.isPlayed)return this;this.els.video.play(),this.$els.playButton.addClass("player__play-button_active");let t=this.els.video,e=0;return this.interval("detect-buffering",50,(()=>{let s=this.isVideoBuffering,i=this.currentTime;!s&&i<e+.03&&!t.paused&&(this.isVideoBuffering=!0),s&&i>e+.03&&!t.paused&&(this.isVideoBuffering=!1),e=i})),this}pause(){return this.isPlayed?(this.els.video.pause(),this.$els.playButton.removeClass("player__play-button_active"),this.cancelInterval("detect-buffering"),this.isVideoBuffering=!1,this):this}get isVideoBuffering(){return this._options.isVideoBuffering}set isVideoBuffering(t){this._options.isVideoBuffering!==t&&(this._options.isVideoBuffering=t,this.cancelTimeout("buffering"),t?this.timeout("buffering",500,(()=>{this.$els.loader.show()})):this.$els.loader.hide())}get isPlayed(){return!Boolean(this.els.video.paused)}get duration(){return this.els.video.duration}get currentTime(){return this.els.video.currentTime||0}set currentTime(t){this.currentTime!==t&&(this.els.video.currentTime=t,this._updateProgressTime(t))}get block(){return this._options.block}_normalizeSliders(t,e){let s,i=this.settings.data.cutFrom,n=this.settings.data.cutTo,o=this.block.editor.limitVideoInputMinDuration,r=this.block.editor.limitVideoOutputMaxDuration,a=i,l=n;t?(a=Math.min(this.duration-o,e),s=n-a,s<o?l=a+o:r&&s>r&&(l=a+r)):(l=Math.max(o,e),s=l-i,s<o?a=l-o:r&&s>r&&(a=l-r)),this.settings.update({cutFrom:a,cutTo:l}),this._updateBufferedTime(a,l)}set settings(t){this.settings.update(t)}get settings(){let t=this._options.settings;if(!t){t=this._options.settings=new qi.Lo({cutFrom:0,cutTo:0,isMuted:!1,hasAudio:!0});let e=!0,s=!0;this.listenTo(t,qi.u$.CHANGE,((s,i)=>{e&&(t.save("cut"),e=!1),void 0!==i.cutFrom&&this._updateSliderLeft(t.data.cutFrom),void 0!==i.cutTo&&this._updateSliderRight(t.data.cutTo);let n=t.diff("cut").length>0;this.isRendered&&this.$els.submitCutButton.prop("disabled",!n)})),this.listenTo(t,qi.u$.SAVE_SNAPSHOT,(()=>{s?s=!1:this.isRendered&&(this.$els.submitCutButton.prop("disabled",!0),this.$els.cutFrom.val(t.data.cutFrom),this.$els.cutTo.val(t.data.cutTo))}))}return t}}const wl=s(9755),El=s(6419);class Sl extends al{render(){return this.$el||(super.render(),this.data.isShownEditHint=this.data.info.duration>this.editor.limitVideoOutputMaxDuration,this._renderPlayer(),this.listenTo(this,qi.u$.CHANGE,((t,e)=>{void 0===e.cut_from&&void 0===e.cut_to&&void 0===e.is_muted||this._renderPlayer()})),this.$el.on("click",".player__edit",this._onClickEdit.bind(this))),this.$el}_onClickEdit(){if(!this.isEditable)return;this.data.isShownEditHint=!1,this.$(".player__edit-hint").removeClass("player__edit-hint_show"),this._player.stop();let{cutFrom:t,cutTo:e}=this.getCutData(),s=new bl({block:this,settings:{cutFrom:t,cutTo:e,isMuted:this.data.is_muted,hasAudio:this.data.has_audio}});this.listenTo(s,"change",(t=>{i.vE.logger.warn("PLAYER","set new cut",t),this.update({is_muted:t.isMuted,cut_from:t.cutFrom,cut_to:t.cutTo})})),this.listenTo(s,n.eM.UNMOUNTED,El.debounce((()=>{this.stopListening(s),s.destroy()}),50)),s.show()}_renderPlayer(){let t=this.data.info;this.$els.content.empty().append(wl(function(t){var e,s="";return s+'<div class="player" data-type="video-file" data-ratio="'+(null==(e=t.ratio)?"":e)+'" data-duration="'+(null==(e=t.duration)?"":e)+'" data-source="'+(null==(e=t.url)?"":e)+'" data-muted="'+(null==(e=t.isMuted?'true"':"false")?"":e)+'" data-cut="'+(null==(e=t.cut.cutFrom+","+t.cut.cutTo)?"":e)+'">\n\t<svg class="player__svg-stretch" aria-hidden="true" preserveAspectRatio="xMinYMax meet" width="'+(null==(e=t.width)?"":e)+'" height="100%" viewBox="0 0 '+(null==(e=t.width)?"":e)+" "+(null==(e=t.height)?"":e)+'"></svg>\n\t<div class="player__play"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon--player__play"><use xlink:href="#icon--player__play"></use></svg></div>\n\t<div class="player__preview" style="background-image: url(\''+(null==(e=t.url_preview)?"":e)+'\')"></div>\n\t<div class="player__state" data-type="loading"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon--ui__progress-circle icon--ui__progress-circle_player"><use xlink:href="#icon--ui__progress-circle"></use></svg></div>\n\t<div class="player__edit '+(null==(e=t.isEditable?"":" player__edit_disabled hint")?"":e)+'" '+(null==(e=t.isEditable?"":' aria-label="Редактирование видео более невозможно"')?"":e)+'><svg xmlns="http://www.w3.org/2000/svg" class="icon icon--ui__pencil icon--ui__pencil_player"><use xlink:href="#icon--ui__pencil"></use></svg></div>\n\t<div class="player__edit-hint'+(null==(e=t.isShownEditHint?" player__edit-hint_show":"")?"":e)+'">\n\t\t<div class="player__edit-hint-arrow"></div>\n\t\t<p>Видео обрезано до '+(null==(e=t.limitVideoOutputMaxDuration/60)?"":e)+" минут</p>\n\t\t<p>Измените интервал проигрывания в редактировании</p>\n\t</div>\n</div>"}({host:"Пикабу",ratio:t.width/t.height,duration:t.duration,url:t.src.url.replace(".mp4",""),width:t.width,height:t.height,cut:this.getCutData(),isMuted:this.data.is_muted,url_preview:t.thumb,isEditable:this.isEditable,isShownEditHint:this.data.isShownEditHint,limitVideoOutputMaxDuration:this.editor.limitVideoOutputMaxDuration}))),i.vE.ui.player.init(this.$el),this._player=this.$(".player").data("player")}getCutData(){let t=this.data.info,e=this.data.cut_from,s=this.data.cut_to;return s=!El.isFinite(s)||s<0?0:s,e=!El.isFinite(e)||e<0?0:e,0===s&&0===e&&(s=Math.min(this.editor.limitVideoOutputMaxDuration,t.duration)),s-e<this.editor.limitVideoInputMinDuration&&(s=e+this.editor.limitVideoInputMinDuration),{cutFrom:e,cutTo:s}}renderMini(){return this.$elMini||(super.renderMini(),this.$elMini.attr("style","background-image: url("+this.data.info.thumb+")"),wl(document.createElement("div")).addClass("story-editor-block-mini__play").append(i.vE.icon("player__play","mini")).appendTo(this.$elMini)),this.$elMini}canSerialize(){return!0}get isEditable(){return!0}}Sl.prototype.defaults=El.extend({fid:void 0,cut_from:0,cut_to:0,is_muted:!1,has_audio:!0,isShownEditHint:!1,info:void 0},al.prototype.defaults);const Cl=s(9755),Tl=s(6419);class Ol extends al{render(){if(this.$el)return this.$el;super.render(),this._detectUrlDebounce=Tl.debounce(this._detectUrl,500),Cl(function(t){var e,s="";return Array.prototype.join,s+='<div class="section-group">\n\t<section class="input input_section">\n\t\t<span class="input__icon">\n\t\t\t<svg xmlns="http://www.w3.org/2000/svg" class="icon icon--story-editor__play"><use xlink:href="#icon--story-editor__play"></use></svg>\n\t\t</span>\n\t\t<span class="input__box">\n\t\t\t<input class="input__input" name="video-url" autocomplete="off" placeholder="Ссылка на Youtube, YouTube Shorts, VK, Vimeo">\n\n\t\t</span>\n\t</section>\n\t',t.isVideoFileEnabled&&(s+="\n\t<section>\n\t\t"+(null==(e=t.limits)?"":e)+'\n\t\t<div class="button button_inline-block attach">\n\t\t\tВыбрать файл\n\t\t\t<input type="file" accept="video/*">\n\t\t</div>\n\t</section>\n\t'),s+="\n</div>"}({limits:i.vE.i18n("story-editor.video-input.upload",this.editor.limitVideoOutputMaxDuration/60,c.cQ.formatBytes(this.editor.limitVideoBytes)),isVideoFileEnabled:this.editor.isVideoFileEnabled})).appendTo(this.$els.content),this.$els.input=this.$(".input"),this._input=new T.u3({$el:this.$els.input,validationHint:{width:"100%",alignment:k.SE.CENTER,direction:k.Lh.BOTTOM}}),this._input.sanitizerRules.add(mt.o.trim()),this._input.$els.error.addClass("popup__hint_width_100");const t=t=>{this._input.setCustomValidity(),this._detectUrlDebounce(t)};this.listenTo(this._input,"input",t),this.listenTo(this._input,"paste",t),this.listenTo(this._input,"enter",(t=>{t.preventDefault()}));let e=this.$('input[type="file"]').on("change",(t=>{let s=ge.nO.File.getFiles(t);e.val("");let i=s.pop();x.$.request((async()=>{await this.editor.addVideoFile(i,this),this.destroy()}))}));return this.$el}async _detectUrl(t){if(this._startDetectUrl||!t)return;if(this._startDetectUrl=!0,!Boolean(ce.tv.getProviderTypeBySource(t)))return void(this._startDetectUrl=!1);const{response:e,data:s}=await ce.tv.getVideoDetails(t);if(!e.result)return this._input.setCustomValidity(e.message),void(this._startDetectUrl=!1);this.editor.addVideoBlock(s,this),oa.j.instance.add(s.url),this.destroy(),this._startDetectUrl=!1}renderMini(){return this.$elMini||super.renderMini(),this.$elMini}focus(){return this._input.focus(),this}canSerialize(){return!1}}Ol.prototype.defaults=Tl.extend({},al.prototype.defaults,{isDisabledDeleteConfirm:!0,isDisabledAdding:!0});s(285);const kl=s(9755),Il=s(6419);class $l extends al{destroy(t,e){this._previewVideo&&(URL.revokeObjectURL(this._previewVideo.src),this._previewVideo.remove()),this._idleSimulationConvert&&clearInterval(this._idleSimulationConvert),super.destroy(t,e)}render(){if(this.$el)return this.$el;super.render();let t=this.data.info;return this.$els.content.append(function(t){var e,s="";return s+'<div class="video-upload" data-type="upload">\n\t<div class="video-upload__stretch" style="padding-bottom: '+(null==(e=100/t.ratio)?"":e)+'%"></div>\n\t<div class="video-upload__content">\n\t\t<div class="video-upload__animation"></div>\n\t\t<div class="video-upload__hint">Загрузка 0%</div>\n\t</div>\n</div>'}({ratio:t&&t.ratio?t.ratio:1.7777})),this.$els.container=this.$(".video-upload"),this.$els.hint=this.$(".video-upload__hint"),this.$els.animation=this.$(".video-upload__animation"),t&&this._initPreview(t),this._animation=i.vE.ui.player.createAnimation("video-upload").appendTo(this.$els.animation).play(),this.$els.container.attr("data-type","upload"),this._startUpload(),this.$el}async _startUpload(){let t=i.vE.initParams.uploadVideoServerUrl+"/ajax/upload_video.php",{response:e,data:s}=await S.cf.upload(t,{uid:"video"},this.data.file,{progress:t=>{let e=t.loaded/t.total;this.$els.hint.text(i.vE.i18n("story-editor.video-upload.uploading",Math.floor(100*e))),this._previewVideo&&(this._previewVideo.currentTime=this.data.info.duration*e),e>=1&&this._startConvert()}});e.result?this.editor.addBlock({type:sl.STORY_BLOCK_TYPE.VIDEO_FILE,fid:s.fid,info:s},this):i.vE.ui.toasts.showError(e.message),this.destroy()}_startConvert(){if(this.$els.hint.text(i.vE.i18n("story-editor.video-upload.convert")),this._animation.destroy(),this._animation=i.vE.ui.player.createAnimation("video-convert").appendTo(this.$els.animation).play(),this.$els.container.attr("data-type","convert"),this._previewVideo){let t=0,e=this.data.info.duration;this._idleSimulationConvert=setInterval((()=>{t+=c.cQ.random(3,10);let s=this._previewVideo.currentTime;this._previewVideo.currentTime=s+t>e?0:s+t}),1e3)}}_initPreview(t){let e=document.createElement("canvas");e.classList.add("video-upload__preview"),e.width=t.width,e.height=t.height,this.$(".video-upload__content").append(e),this._previewVideo=t.video,kl(t.video).on("seeked",(()=>{e.getContext("2d").drawImage(this._previewVideo,0,0,t.width,t.height)})),t.video.currentTime=0,e.getContext("2d").drawImage(this._previewVideo,0,0,t.width,t.height)}renderMini(){return this.$elMini||super.renderMini(),this.$elMini}canSerialize(){return!1}}$l.prototype.defaults=Il.extend({},al.prototype.defaults,{isDisabledDeleteConfirm:!1,file:void 0,info:void 0});var Al=s(5240);var xl=s(4440),Dl=s(8924);class Pl extends xl.A{runCallbackOnBlur(){this.tagsInput&&this.tagsInput.runTimeoutImmediately("onBlur")}init(){this.els.inputWrapper&&(this.tagsInput=new T.K1({$el:this.els.inputWrapper,validationHint:!0,validationEvent:T.km.MANUAL}),this.tagsInput.suggestion=new C.Z6({filter:Dl.ll.STORY}),this.editor._form.add(this.tagsInput),this.listenTo(this.tagsInput,"new-tag",(()=>{this.editor.handleUserAction(el.oY.ADD_TAG)})),this.listenTo(this.tagsInput,"change",(0,js.debounce)((()=>this.editor.recommendationObserver.call()),1e3)))}}var Rl=s(8044),Ml=s(9050);function Nl(t){var e,s="",i=Ml.escape;Array.prototype.join;return s+='<div class="community">\n\t<div class="community-avatar community-avatar_medium"><img src="'+(null==(e=t.avatar)?"":e)+'" alt=""></div>\n\t<div class="community__wrapper">\n\t\t<div class="community__title">\n\t\t\t',t.is_nsfw&&(s+='\n        \t\t<span class="text-muted">[NSFW]</span>\n        \t'),s+='\n\t\t\t<a href="/community/'+i(t.link)+'" target="_blank">'+(null==(e=t.name)?"":e)+'</a>\n\t\t</div>\n\t\t<div class="community__information caption">\n\t\t\t<span>'+(null==(e=t.stories)?"":e)+"</span> • <span>"+(null==(e=t.subs)?"":e)+'</span>\n\t\t</div>\n\t</div>\n    <button class="community__remove" type="button">Убрать</button>\n</div>\n'}function Bl(t){var e,s="";return s+='<div class="community" data-url="/community/'+(null==(e=t.link)?"":e)+'">\n\t<div class="community-avatar"><img src="'+(null==(e=t.avatar)?"":e)+'" alt=""></div>\n\t<div class="community__wrapper">\n        <div class="community__title">\n            <a href="/community/'+(null==(e=t.link)?"":e)+'" target="_blank">'+(null==(e=t.name)?"":e)+'</a>\n        </div>\n\t\t<div class="community__information caption">\n\t\t\t<span>'+(null==(e=t.stories)?"":e)+"</span> • <span>"+(null==(e=t.subs)?"":e)+'</span>\n\t\t</div>\n\t</div>\n    <button class="button button_success community__add" type="button">Добавить</button>\n</div>\n'}class Ll extends Rl.s{setCommunityMode(t){var e;const{inputSearch:s,ownCommunities:i,recommendedCommunities:n,recommended:o}=this.els,r=t===tl.p9.CHOICE||t===tl.p9.OFF;s&&ee()(s).parent().toggle(r),null==o||null===(e=o.classList)||void 0===e||e.toggle("story-editor__communities-recommended_hidden",!r),i.el&&ee()(i.el).toggle(Boolean(this.editor.marks.get("hasOwnCommunities"))&&t===tl.p9.CHOICE),n.el&&ee()(n.el).toggle(this.editor.marks.has("hasRecommendedCommunities")&&t!==tl.p9.SELECTED),t===tl.p9.CHOICE&&(this.uiInput.focus(),this.searchOwnCommunities()),t!==tl.p9.SELECTED&&(this.uiInput&&(this.uiInput.value=""),this.editor.community=!1),this.editor.emit("community-changed")}setCommunity(t){super.setCommunity(t,Nl)}showRecommendations(t){super.showRecommendations(t,Bl)}init(){if(!this.exists||this.editor.type===tl.ik.CA)return;if(this.uiInput=new T.u3({$el:this.els.inputSearch,validationHint:!0}),this.uiInputDropdown=new C.dt,this.uiInput.suggestion=this.uiInputDropdown,this.listenTo(this.uiInputDropdown,C.nT.SELECT,(t=>{t&&(this.editor.community=t.plainData)})),!this.els.selectedCommunity)return;let t=ee()(this.els.selectedCommunity);this.els.ownCommunities.el&&(t=t.add(this.els.ownCommunities.el)),this.els.recommendedCommunities.el&&(t=t.add(this.els.recommendedCommunities.el)),t.on("click",".community",(t=>{var e,s;if(t.target.classList.contains("community__remove"))return this.editor.community=!1,this.editor.communityMode=tl.p9.CHOICE,null===(e=this.els.realInputSearch)||void 0===e||e.blur(),void(null===(s=this.els.realInputSearch)||void 0===s||s.focus());const i=ee()(t.currentTarget),n=i.data("community"),o=i.data("url");if("a"!==ee()(t.target).prop("tagName").toLowerCase()&&n){if((t.ctrlKey||t.metaKey)&&o)return void window.open(o,"_blank");this.editor.community=n}})),this.showOwnCommunitiesOnFocus(),this.addRecommendedCommunity()}showOwnCommunitiesOnFocus(){const{realInputSearch:t}=this.els;if(!t||!this.uiInputDropdown)return;let e=[];const s=async()=>{e=await me.yV.search(),e.length&&!t.value.length&&(this.uiInputDropdown.items.set(e),this.uiInputDropdown.show())};t.addEventListener("focus",(()=>{s()}))}addRecommendedCommunity(){const{recommended:t}=this.els;t&&t.addEventListener("click",(t=>{const e=t.target;if("A"===e.tagName)return;const s=ee()(e).closest(".community").data("community");if(s){this.editor.community=s;const{id:t,score:e,screen_index:i}=s;d.c.getInstance().sendEvent("click",{type:"recommended_community",community_id:t,rec_score:e,screen_index:i})}}))}async searchOwnCommunities(){if(this.editor.type===tl.ik.CA||!this.editor.tagsExist||this.editor.marks.has("hasOwnCommunities"))return;const t=await me.yV.search(),e=(null==t?void 0:t.length)>0;this.editor.marks.set("hasOwnCommunities",e),e&&(this.els.ownCommunities.inner&&ee()(this.els.ownCommunities.inner).append(this.renderCommunitiesList(t,Bl)),this.editor.communityMode===tl.p9.CHOICE&&this.els.ownCommunities.el&&ee()(this.els.ownCommunities.el).show())}}function Fl(t){var e,s="";Array.prototype.join;if(s+='<div class="story-drafts-list">\n\t',t.isDraftsLimit&&(s+='\n\t<div class="story-drafts-list__limit">\n\t\tВы создали максимальное количество черновиков. Продолжите один из них или удалите неактуальные черновики\n\t</div>\n\t'),s+="\n\t",t.isLoading)for(let i=0;i<t.draftsCount;i++)s+='\n\t\t<div class="story-draft-skeleton">\n\t\t\t<div class="story-draft-skeleton__line story-draft-skeleton__line_short"></div>\n\t\t\t<div class="story-draft-skeleton__line"></div>\n\t\t</div>\n\t';return s+="\n\t",t.drafts&&t.drafts.forEach((function(t){s+='\n\t\t<div class="story-draft-item story-drafts-list__item" data-id="'+(null==(e=t.id)?"":e)+'">\n\t\t\t<div class="story-draft-item__row">\n\t\t\t\t<div class="story-draft-item__title">'+(null==(e=t.title)?"":e)+'</div>\n\t\t\t\t<div class="story-draft-item__time">'+(null==(e=t.created_interval)?"":e)+' назад</div>\n\t\t\t\t<div class="story-draft-item__delete" title="Удалить черновик">\n\t\t\t\t\t<svg xmlns="http://www.w3.org/2000/svg" class="icon icon--ui__trash"><use xlink:href="#icon--ui__trash"></use></svg>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t\t<div class="story-draft-item__text">'+(null==(e=t.text)?"":e)+"</div>\n\t\t\t",(t.img_count>0||t.video_count>0)&&(s+='\n\t\t\t<div class="story-draft-item__media">\n\t\t\t\t',t.img_count>0&&(s+='\n\t\t\t\t\t<svg xmlns="http://www.w3.org/2000/svg" class="icon icon--ui__photo"><use xlink:href="#icon--ui__photo"></use></svg>\n\t\t\t\t'),s+="\n\t\t\t\t",t.video_count>0&&(s+='\n\t\t\t\t\t<svg xmlns="http://www.w3.org/2000/svg" class="icon icon--story-editor__play"><use xlink:href="#icon--story-editor__play"></use></svg>\n\t\t\t\t'),s+="\n\t\t\t\t"+(null==(e=t.img_count+t.video_count)?"":e)+"\n\t\t\t</div>\n\t\t\t"),s+="\n\t\t</div>\n\t"})),s+="\n</div>"}function Ul(t,e){var s=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),s.push.apply(s,i)}return s}function jl(t){for(var e=1;e<arguments.length;e++){var s=null!=arguments[e]?arguments[e]:{};e%2?Ul(Object(s),!0).forEach((function(e){Vl(t,e,s[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(s)):Ul(Object(s)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(s,e))}))}return t}function Vl(t,e,s){return e in t?Object.defineProperty(t,e,{value:s,enumerable:!0,configurable:!0,writable:!0}):t[e]=s,t}class Hl extends class{async show(t){const{draftsCount:e,draftsLimit:s,onSelectDraft:i,onDeleteDraft:n,isCloseLocked:o}=t,r=e>=s;this.isCloseLocked=o,this.createPopup(`Черновики (<span class="story-drafts-popup__drafts-count">${e}</span>/${s})`,Fl({isDraftsLimit:r,isLoading:!0,draftsCount:e}),o);const[a]=await Promise.all([Ae.c.getPreviewList(),(0,di.g)(500)]);this.popupContent.innerHTML=Fl(jl(jl({},a),{},{isDraftsLimit:r})),this.popupContent.addEventListener("click",(t=>{const e=t.target,s=e.closest(".story-drafts-list__item"),o=Number(null==s?void 0:s.dataset.id);if(o)if(e.closest(".story-draft-item__delete"))n(o);else{const t=a.drafts.findIndex((t=>t.id===o));i(o,t)}})),d.c.getInstance().sendEvent("click",{type:"drafts_create_post",size:e}),r&&d.c.getInstance().sendEvent("tip_show",{type:"drafts_limit"})}deleteItem(t){var e,s;null===(e=this.popupContent.querySelector(`.story-drafts-list__item[data-id="${t}"]`))||void 0===e||e.remove();const i=this.popupTitle.querySelector(".story-drafts-popup__drafts-count");i&&(i.textContent=(Number(i.textContent)-1).toString()),this.isCloseLocked&&(this.unlockPopupClose(),this.isCloseLocked=!1),null===(s=this.popupContent.querySelector(".story-drafts-list__limit"))||void 0===s||s.remove()}}{createPopup(t,e,s){const n=new r.LD({header:`<div class="story-drafts-popup__header">\n\t\t\t\t\t<div>${t}</div>\n\t\t\t\t\t<button data-role="close" class="button_link">\n\t\t\t\t\t\t${i.vE.icon("ui__close","popup")}\n\t\t\t\t\t</button>\n\t\t\t\t</div>`,content:e,destroyAfterHide:!0,autoCloseOutsideClick:!s,autoClosePressEscape:!s,wrapperExtraClass:"story-drafts-popup-modal"});n.show(),this.resizeModal=(0,Ti.P)((()=>{null==n||n.updateSize()}),100),window.addEventListener("resize",this.resizeModal);const o=n.el.querySelector('button[data-role="close"]');s&&(this.unlockModal=()=>{o.style.display="block",n.setOptions({autoClosePressEscape:!0,autoCloseOutsideClick:!0})},o.style.display="none"),o.addEventListener("click",n.hide.bind(n)),this.modal=n}get popupContent(){return this.modal.content[0]}get popupTitle(){return this.modal.$els.header[0]}unlockPopupClose(){var t;null===(t=this.unlockModal)||void 0===t||t.call(this)}close(){var t;null===(t=this.modal)||void 0===t||t.hide(),this.resizeModal&&window.removeEventListener("resize",this.resizeModal)}get isShown(){var t;return null===(t=this.modal)||void 0===t?void 0:t.isShown}}const ql=s(9755),Wl=s(6419),Gl=s(381),Yl=s(9709),zl=T.op.escape();class Zl extends tl.CI{constructor(t){super(t),this._errorToasts=new Map,this.listenTo(this.blocks,qi.u$.SORT,(()=>this._relocationViewportPointer(i.vE.ui.scrollTop))),this.blocks.prepareData=this.prepareBlock.bind(this),this._onDropFilesBound=this._onDropFiles.bind(this),this.listenTo(i.vE.ui,"dnd-drop",(t=>t.preventDefault())),this.listenTo(i.vE.ui,"dnd",(t=>{let e=this.$(".story-editor-add");e.toggleClass("story-editor-add_drag",t),t?e.on({"dragenter dragleave":Zl.onDragFiles,drop:this._onDropFilesBound}):e.off("dragenter dragleave drop")})),parent&&"function"==typeof parent.addEventListener&&parent.addEventListener("close",(async()=>{if(this.isSaved)return void parent.__closeStoryModal();await pt.g.confirmModal({header:"Подтверждение выхода",content:"Не вся информация была сохранена. Вы действительно хотите выйти из редактора?",buttons:[["modal.cancel"],["Выйти",st.jM.SUCCESS,!0]]})&&parent.__closeStoryModal()})),this.$el&&this.show(),ht.K.getInstance().render()}render(){if(this.isRendered)return this;let t=ql('<div class="sidebar-block story-editor-navigator">\n\t<div class="story-editor-navigator__viewport-pointer"></div>\n\t<div class="story-editor-navigator__blocks"></div>\n</div>');i.vE.ui.sidebar&&i.vE.ui.sidebar.append(t),this.listenTo(i.vE.ui,"document-scroll",this._relocationViewportPointer),this.listenTo(i.vE.ui,"resize",(()=>this._relocationViewportPointer(i.vE.ui.scrollTop))),this.$els={form:this.$("form"),blocks:this.$(".story-editor__blocks"),blocksInner:this.$(".story-editor__blocks-inner"),addPanel:this.$(".story-editor-add"),navigator:{viewportPointer:t.find(".story-editor-navigator__viewport-pointer"),blocks:t.find(".story-editor-navigator__blocks")},feedbackOffer:this.$(".story-editor__feedback-offer"),preview:{button:this.$('button[data-role="preview"]').on("click",this._onClickPreview.bind(this)),section:this.$('.section-group[data-role="preview"]'),loading:this.$(".story-preview-loading"),stories:this.$('div[data-role="stories-preview"]'),close:this.$('.story-editor__preview button[data-role="close"]').on("click",(()=>this.currentPreview=!1))},draft:{button:this.$('button[data-role="save-draft"]').on("click",this._onClickSaveDraft.bind(this)),reset:this.$('button[data-role="reset-draft"]').on("click",this._onClickResetDraft.bind(this)),message:this.$(".story-editor__draft-message")},similarStories:{el:this.$('.section-group[data-role="similar-stories"]'),fragments:this.$('section[data-role="similar-stories-fragments"]'),message:this.$('section[data-role="similar-stories-message"]'),wait:this.$('section[data-role="similar-stories-wait"]')},controls:this.$('.section-group[data-role="controls"]').on("mouseenter",this._forceUpdateTextBlocks.bind(this)),themeColor:{notification:this.$(".story-editor__theme-notification"),switch:this.$(".story-editor__theme-notification-switch input"),hintInfo:this.$(".story-editor__theme-notification-switch-group .fa"),colors:this.$(".story-editor__theme-notification-radio-group")},draftsCount:document.querySelector(".story-drafts-count"),draftsCountValue:document.querySelector(".story-drafts-count__value"),meta:this.$('section[data-role="meta"]'),community:this.$(".story-editor__communities")},this.$els.submit=this.$('button[data-role="publish"]').length?this.$('button[data-role="publish"]'):this.$('button[data-role="validate"]'),this._isImageSearchDisabled=Boolean(this.$els.controls.find("[data-is-image-similar-fail]").length),this._form=new a.x(this.$els.form),this.listenTo(this._form,"submit",this._onSubmit),this.listenTo(this._form,"change",this._autoSaveDraft),this._editorExtra=new tl.jj(this),this._submitButton=new st.y3({$el:this.$els.submit,animationName:"story-publish"}),this._disableButtonHint=new r._({target:this.$els.submit,delay:0,destroyAfterHide:!1,direction:r.Lh.TOP,content:ql(document.createElement("div")).addClass("popup__hint").html(i.vE.i18n("story-editor.similar.message"))}),this.$els.submit.find(".button__title").on("mouseenter",(()=>{this._submitButton.disabled&&this._disableButtonHint.show()})).on("mouseleave",(()=>{this._disableButtonHint.hide()}));const e=this.$('input[name="is_adult"]');return null==e||e.on("change",(t=>{i.vE.initParams.isNsfwStory=t.currentTarget.checked,t.currentTarget.checked&&this.handleUserAction(el.oY.MARK_NSFW)})),this.$els.draft.button.length&&(this._saveDraftButton=new st.y3(this.$els.draft.button),this._options.storyId>0&&this.$els.draft.reset.hide()),this._title=new sa.Y({$el:this.$('.input[data-role="title"]'),validationHint:!0,isToolbarButtonsDisabled:!0,disableReturn:!0,addClearButton:!0,validationEvent:T.km.MANUAL}),this._title.on("change",Wl.debounce(this.onTitleChange.bind(this),1e3)),this._title.on("change",(t=>{t||(this.parentStoryId=void 0)})),this._form.add(this._title),this._feedbackOffer=new aa.t(this.$els.feedbackOffer),this._editorTags=new Pl(this),this._editorCommunities=new Ll(this),this._editorCommunities.exists&&this.type===tl.ik.CA&&this._editorExtra.listenCheckboxCommunityChange(),this._initSortable(),this._addPanel=new nl({$parent:this.$els.addPanel,editor:this}),this._addPanel.show(),this.listenTo(i.vE.ui,"paste-image",((t,e)=>{this.blocks.items.some((t=>t.isFocused))||(e.preventDefault(),e.stopPropagation(),this.addImageBlock(t))})),this.$els.similarStories.fragments.length&&this.$els.similarStories.el.length&&!this.isUserModerator&&this.type===tl.ik.NORMAL&&(this._similarStories=new Ws.Bi({$parent:this.$els.similarStories.fragments,type:Ws.VQ.EDITOR,blocks:this.blocks,isImageSearchDisabled:this._isImageSearchDisabled}),this.storyId&&(this._similarStories.filterFragments=t=>t.story_id!==this.storyId),this.listenTo(this._similarStories,"state",(t=>{if(t===Ws.DX.ERROR)this.$els.similarStories.el.show(),this.$els.similarStories.message.hide();else{if(t===Ws.DX.READY){const t=this._similarStories.getPageFragments(!0).map((t=>({id:t.story_id,probability:t.relevance})));d.c.getInstance().sendEvent("show_duplicates",{draft_id:this.draftId,duplicates_count:t.length,duplicates_id:t.map((t=>t.id)).join(","),duplicates_probability:t.map((t=>t.probability)).join(",")})}this.$els.similarStories.el.toggle(t===Ws.DX.READY),this.$els.similarStories.message.toggle(t!==Ws.DX.READY).html(t===Ws.DX.WAIT?i.vE.icon("ui__progress-circle")+" "+i.vE.i18n("story-editor.similar.wait"):i.vE.i18n("story-editor.similar.empty"))}t===Ws.DX.WAIT||t===Ws.DX.ERROR?(this._submitButton.disabled=!0,this.$els.controls.attr("data-wait",!0)):(this._submitButton.disabled=!1,this.$els.controls.removeAttr("data-wait"),this._autoSaveDraft())})),this._similarStories.show()),setTimeout((()=>{var t;i.vE.initParams.isNsfwStory=null===(t=e[0])||void 0===t?void 0:t.checked}),100),super.render(),this._initThemeColor(),this._showAuthorContentNotification(),this._initScheduledStorySettings(),this}_lockEditor(){const t=document.createElement("div");t.setAttribute("class","story-editor-skeleton"),t.innerHTML="<div></div>".repeat(6),this.$els.blocks[0].prepend(t);const e=document.createElement("div");return e.setAttribute("class","story-editor-lock-overlay"),this.$els.form[0].append(e),function(){t.remove(),e.remove()}}_createDraftsPopup(){return new Hl}async deserialize(t){await super.deserialize(t),this._editorTags.set(t.tags)}_forceUpdateTextBlocks(){this.emit("force-update-text")}async _onClickPreview(){if(this.marks.has("get-preview"))return;this.handleUserAction(el.oY.POST_PREVIEW),this._forceUpdateTextBlocks(),this._editorTags.runCallbackOnBlur();let t=Date.now();this.marks.set("get-preview",!0),this.$els.preview.section.show(),await this.preview()?(i.vE.ui.scrollTo(this.$els.preview.section.offset().top-20,!0),await c.cQ.delay(1e3-(Date.now()-t))):this.$els.preview.section.hide(),this.marks.delete("get-preview"),this.marks.delete("skip-preview")}_resetEditor(...t){super._resetEditor(...t),this._title.$els.input.blur()}_updatePreview(t){let e=Boolean(t),s=this._previewFeed;if(this.cancelTimeout("clear-preview"),e){if(this.marks.has("skip-preview"))return void this.marks.delete("skip-preview");this.$els.preview.section.show(),s||(s=this._previewFeed=new Al._({useEmptyIds:!0,$el:this.$els.preview.stories,feedName:"story-preview"})),s.clear(),s.$els.container.html(t),s.initStories(),this.$els.preview.loading.hide(),this.$els.preview.stories.show()}else x.$.request((()=>{this.$els.preview.section.slideUp(400)})),s&&this.timeout("clear-preview",200,(()=>{s.clear()})),this.marks.has("get-preview")&&this.marks.set("skip-preview",!0),this.$els.preview.loading.show(),this.$els.preview.stories.hide()}async _onClickSaveDraft(){d.c.getInstance().sendEvent("save_draft_post",{draft_id:this.draftId}),await this._uploadImages(),await this._onSaveDraft()}async _onSaveDraft(){var t;if(!(this.type!==tl.ik.NORMAL||this.isLocked||this.isSaved||this.storyId||null!==(t=this._saveDraftButton)&&void 0!==t&&t.progress)){this.marks.set("save-draft",Date.now()),this._saveDraftButton.progress=!0;try{await this.saveDraft()}finally{await c.cQ.delay(500-this.marks.get("save-draft")),this._saveDraftButton.progress=!1}this.$els.draft.message.addClass("story-editor__draft-message_show").text(i.vE.i18n("story-editor.draft-save",Gl(this._options.lastDraftSave).format("HH:mm"))).addClass("story-editor__draft-message_animate"),this.timeout("draft-message",300,(()=>{this.$els.draft.message.removeClass("story-editor__draft-message_animate")}))}}async _onClickResetDraft(){if(await this._showDeleteDraftConfirmation()){var t;if(this._resetEditor({addBlankTextBlock:!0,focusTitleInput:!0}),this._options.hasBlogsAccess)null===(t=this._form.getUIElement("is_advert_blogs"))||void 0===t||t.setChecked(!0);this.draftId&&(d.c.getInstance().sendEvent("delete_draft_post",{draft_id:this.draftId,type:"post_editor"}),Ae.c.deleteDraft(this.draftId),this.lastDraft=null,this.draftsCount--)}}_updateCommunityMode(t){this._editorCommunities.setCommunityMode(t)}_updateCommunity(t){this._editorCommunities.setCommunity(t),t&&this._editorExtra.toggleCommunityChecked(!0,!0,!1)}_onUpdateBlocks(t,e){if(e&&e.inserted){let s=1===e.inserted.length;e.inserted.forEach((e=>{let i=e.data.insertBetween,n=e.data.insertionDirection;i&&!i.isDestroyed?(e.render()[n?"insertAfter":"insertBefore"](i.$el),e.renderMini()[n?"insertAfter":"insertBefore"](i.$elMini)):(this.$els.blocksInner.append(e.render()),this.$els.navigator.blocks.append(e.renderMini())),s&&t.size>1&&this.timeout("focus",100,(()=>{e.focus()})),e.data.type===sl.STORY_BLOCK_TYPE.TEXT?(this.listenTo(e,"plainBody",this._onUpdateTextBlocks),this._onUpdateTextBlocks()):e.data.type!==sl.STORY_BLOCK_TYPE.IMAGE||e.isUploaded||this._autoUpload()}))}e&&e.removed&&e.removed.forEach((t=>{t.data.type===sl.STORY_BLOCK_TYPE.TEXT&&this._onUpdateTextBlocks()})),super._onUpdateBlocks(t,e),i.vE.ui.sidebar&&i.vE.ui.sidebar.refresh(),this.emit(el.Ks.BLOCKS_UPDATED)}prepareBlock(t){if(t instanceof qi.Lo)return t;switch(t.id=t.id||Date.now()/1e3,t.type=sl.STORY_BLOCK_TYPE[t.type],t.type){case sl.STORY_BLOCK_TYPE.TEXT:return new ml(t,this);case sl.STORY_BLOCK_TYPE.IMAGE:return new cl(t,this);case sl.STORY_BLOCK_TYPE.VIDEO:return new vl(t,this);case sl.STORY_BLOCK_TYPE.VIDEO_INPUT:return new Ol(t,this);case sl.STORY_BLOCK_TYPE.VIDEO_UPLOAD:return new $l(t,this);case sl.STORY_BLOCK_TYPE.VIDEO_FILE:return new Sl(t,this)}}_onUpdateTextBlocks(){const t=this.blocks.items.filter((t=>t.data.type===sl.STORY_BLOCK_TYPE.TEXT)),e=t.reduce(((t,e)=>t+(e.data.plainBody||e.data.body||"")),"").replace(tl.dT,"#").trim();this.checkLengthTextBlocks(e.length),this._similarStories&&(this._similarStories.textBlock=e),this.checkShortStory(),this._checkMentions(),this._autoSaveDraft()}static onDragFiles(t){ql(t.target).toggleClass("story-editor-add_drop","dragenter"===t.type)}_onDropFiles(t){t.stopPropagation(),t.preventDefault();let e=ql(t.target),s=this.getBlockFromEl(e.closest(".story-editor-block"));if(e.toggleClass("story-editor-add_drop",!1),!t.originalEvent.dataTransfer||!t.originalEvent.dataTransfer.files)return;let i=t.originalEvent.dataTransfer.files,n=[],o=[];for(let r,a=0;a<i.length;a++)r=i[a].type,0===r.indexOf("image")?n.push(i[a]):0===r.indexOf("video")&&o.push(i[a]);n.length&&this.addImageBlock(n,s),o.length&&this.addVideoFile(i[0],s)}_initSortable(){return new Yl(this.$els.blocksInner.get(0),{sort:!0,animation:200,delay:10,ghostClass:"story-editor-block_ghost",chosenClass:"story-editor-block_chosen",filter:".input__input, .player__player",preventOnFilter:!1,onEnd:t=>{if(t.newIndex===t.oldIndex)return;let e=ql(t.item),s=this.getBlockFromEl(e),i=this.getBlockFromEl(e.next()),n=!!t.originalEvt&&0===t.originalEvt.target.closest(".story-editor-block__content").length;d.c.getInstance().yandex.goal(n?"tgp-dv__change-position-handler":"tgp-dv__change-position-content"),i?s.$elMini.insertBefore(zl(i.$elMini)):s.$elMini.appendTo(zl(this.$els.navigator.blocks)),this._updateBlockPosition(),this._autoSaveDraft()}}),this.$els.navigator.blocks.length&&new Yl(this.$els.navigator.blocks.get(0),{sort:!0,animation:200,ghostClass:"story-editor-block_ghost",chosenClass:"story-editor-block_chosen",preventOnFilter:!1,onEnd:t=>{if(t.newIndex===t.oldIndex)return;let e=ql(t.item),s=this.getBlockFromEl(e,!0),i=this.getBlockFromEl(e.next(),!0);d.c.getInstance().yandex.goal("tgp-dv__change-position-navigator"),i?s.$el.insertBefore(zl(i.$el)):s.$el.appendTo(zl(this.$els.blocksInner)),this._updateBlockPosition(),this._autoSaveDraft()}}),this}_relocationViewportPointer(t){let e,s=10,n=10,o=!1,r=i.vE.ui.windowHeight;for(let i=0,a=this.blocks.items.length;i<a;i++){e=this.blocks.items[i];let a=e.el.offsetTop-t,l=a+e.el.offsetHeight;if(a>=50&&a<=r||l<=r&&l>=50){let t=e.elMini.offsetTop;o||(s=t,o=!0),n=t+e.elMini.offsetHeight-s}}this.$els.navigator.viewportPointer.css({top:s,height:n})}getBlockFromEl(t,e=!1){if(t){if(r.Zv.isHTMLElement(t))return this.blocks.items.find((s=>e?s.elMini===t:s.el===t));if(t.length)return this.blocks.items.find((s=>e?s.$elMini.is(t):s.$el.is(t)))}}_updateLocked(t){this.$els.freeze||(this.$els.freeze=ql(document.createElement("div")).addClass("story-editor__locked").appendTo(this.$el).html(i.vE.i18n("story-editor.locked-message"))),t?this.$el.attr("data-locked",!0):this.$el.removeAttr("data-locked")}_updateError(t,e=!0,s){let n,o=!0;switch(t){case tl.oD.BLOCKS_MISSING:n="story-editor.errors.blocks-missing";break;case tl.oD.TEXT_LENGTH:n=i.vE.i18n("story-editor.errors.text-length",s-this.maxTextLength);break;case tl.oD.UPLOAD_NOT_ALL:n="story-editor.errors.upload-not-all";break;case tl.oD.FILE_SIZE:n=i.vE.i18n("story-editor.errors.image-max",c.cQ.formatBytes(this.limitImageBytes));break;case tl.oD.FILE_MIME:n="story-editor.errors.image-mime";break;case tl.oD.VIDEO_FILE_SIZE:n=i.vE.i18n("story-editor.errors.VIDEO_FILE_SIZE",c.cQ.formatBytes(this.limitVideoBytes));break;case tl.oD.VIDEO_MIN_DURATION:n=i.vE.i18n("story-editor.errors.VIDEO_MIN_DURATION",this.limitVideoInputMinDuration);break;case tl.oD.VIDEO_MAX_DURATION:n=i.vE.i18n("story-editor.errors.VIDEO_MAX_DURATION",this.limitVideoInputMaxDuration/60);break;case tl.oD.VIDEO_MIN_WIDTH:n=i.vE.i18n("story-editor.errors.VIDEO_MIN_WIDTH",this.limitVideoMinWidth);break;case tl.oD.VIDEO_MIN_HEIGHT:n=i.vE.i18n("story-editor.errors.VIDEO_MIN_HEIGHT",this.limitVideoMinHeight);break;case tl.oD.VIDEO_MIN_RATIO:case tl.oD.VIDEO_MAX_RATIO:n=i.vE.i18n("story-editor.errors.VIDEO_RATIO",this.limitVideoMinRatio,this.limitVideoMaxRatio);break;case tl.oD.BACKEND_PREVIEW:case tl.oD.BACKEND_PUBLISH:n=s;break;case tl.oD.COMMUNITY_EMPTY:this.type!==tl.ik.CA&&this._editorCommunities.showEmptyCommunityToast(),o=!1}if(!o)return;let r=this._errorToasts.get(t);!r&&e&&(r=t===tl.oD.TEXT_LENGTH?new v.O({addCloseButton:!1,closeAfter:!1,theme:v.K.DANGER}):new v.O({theme:v.K.DANGER,content:i.vE.i18n(n)}),this._errorToasts.set(t,r)),e?(r.content=i.vE.i18n(n),r.show()):r&&r.hide()}}const Kl=JSON.parse('["<p><b>Как оформить пост</b></p><ul><li>Придумайте заголовок, который будет отражать смысл поста</li><li>Поставьте теги, соответствующие содержанию поста</li><li>Разместите пост в&nbsp;одном из&nbsp;тематических сообществ</li></ul>","<p>Разбивайте текст на&nbsp;абзацы&nbsp;&mdash; так его проще воспринимать и&nbsp;читать</p>","<p>Добавляйте ссылки на&nbsp;источники и&nbsp;указывайте авторство текста&nbsp;&mdash; проверенная информация внушает доверие</p>","<p>Перед публикацией обратите внимание на&nbsp;результаты баянометра&nbsp;&mdash; не&nbsp;стоит постить&nbsp;то, что уже было на&nbsp;Пикабу</p>","<p>Дополните пост иллюстрациями по&nbsp;смыслу: они помогут привлечь внимание и&nbsp;заинтересовать (в&nbsp;идеале 1&nbsp;картинка на&nbsp;2&ndash;3&nbsp;абзаца)</p>","<p>Если вы&nbsp;сами написали текст, не&nbsp;забудьте поставить метку [моё]. Пользователи Пикабу любят авторские посты</p>","<p>Загружайте видео напрямую, через внутренний плеер Пикабу,&nbsp;&mdash; такие посты воспринимаются лучше, чем ролики с&nbsp;видеохостингов</p>","<p>Добавьте описание к&nbsp;картинкам и&nbsp;видео, чтобы читатели поняли, о&nbsp;чем идет речь</p>","<p>Не&nbsp;бойтесь ошибиться в&nbsp;одной букве или запятой&nbsp;&mdash; после публикации у&nbsp;вас будут сутки на&nbsp;редактирование поста</p>","<p>А&nbsp;еще у&nbsp;нас есть подробное руководство по&nbsp;созданию поста</p>"]'),Xl="pkb_sg_viewed",Ql=["https://cs.pikabu.ru/images/misc/pechenka/story-guide.png 1x","https://cs.pikabu.ru/images/misc/pechenka/story-guide@2x.png 2x"];class Jl extends n.u1{constructor(t){super(t),function(t,e,s){e in t?Object.defineProperty(t,e,{value:s,enumerable:!0,configurable:!0,writable:!0}):t[e]=s}(this,"_handleClickOutsidePopup",(t=>{this.$el.get(0).contains(t.target)||this._closePopup()})),this.render()}get _wasViewed(){return xe.m.get(Xl)}set _wasViewed(t){return xe.m.set(Xl,t)}getTips(){return Kl.length<3?Kl.slice():[Kl[0],...Kl.slice(1,-1).sort((()=>.5-Math.random())),Kl[Kl.length-1]]}render(){return this.isRendered||(super.render(),this.$el=ee()('<div class="story-guide">\n    <div class="story-guide__inner">\n        <div class="story-guide__popup story-guide__popup_hidden">\n            <div class="story-guide__tip">\n                <div class="story-guide__text"></div>\n                <button type="button" class="story-guide__next-button button_success">Показать еще совет</button>\n                <button type="button" class="story-guide__full-guide-button button_success">Посмотреть</button>\n                <button type="button" class="story-guide__close-button">Закрыть</button>\n            </div>\n        </div>\n        <div class="story-guide__image"></div>\n    </div>\n</div>').addClass("story-guide_hidden"),this.$els={popup:this.$el.find(".story-guide__popup"),popupText:this.$el.find(".story-guide__text"),popupNextButton:this.$el.find(".story-guide__next-button").on("click",(()=>this._renderTip(this._extractNextTip()))),popupFullGuideButton:this.$el.find(".story-guide__full-guide-button").hide().on("click",(()=>window.open("/information/guide","_blank"))),popupCloseButton:this.$el.find(".story-guide__close-button").on("click",(()=>this._closePopup())),image:this.$el.find(".story-guide__image").on("click",(()=>this._openPopup()))},this._runGuide()),this}destroy(){document.removeEventListener("click",this._handleClickOutsidePopup),super.destroy()}_runGuide(){c.cQ.preloadImageSet(Ql).then((()=>{this.$el.removeClass("story-guide_hidden"),this._wasViewed?this._playAnimation():(this._openPopup(),this._wasViewed=!0)}))}_playAnimation(){this.$el.addClass("story-guide_animated"),this.timeout("stopAnimation",1e4,(()=>this._stopAnimation()))}_stopAnimation(){this.$el.removeClass("story-guide_animated")}_isPopupOpened(){return!this.$els.popup.hasClass("story-guide__popup_hidden")}_openPopup(){this._isPopupOpened()||(this._tips=this.getTips(),this._renderTip(this._extractNextTip()),this._stopAnimation(),this.$els.popup.show().removeClass("story-guide__popup_hidden"),document.addEventListener("click",this._handleClickOutsidePopup))}_closePopup(){this._isPopupOpened()&&(this.$els.popup.one("transitionend",(()=>this.$els.popup.hide())).addClass("story-guide__popup_hidden"),this._tips=[],document.removeEventListener("click",this._handleClickOutsidePopup))}_extractNextTip(){return this._tips.shift()}_renderTip(t){this.$els.popupText.html(t);const e=!this._tips.length;this.$els.popupNextButton.toggle(!e),this.$els.popupFullGuideButton.toggle(e)}}const th=s(9755);class eh extends Fs.T3{async render(){var t;if(this.isRendered)return this;if(this.$els={loading:th(".story-editor-loading"),message:th(".story-editor-message"),editor:th(".story-editor").hide()},this.$els.editor.length){i.vE.ui.sidebar&&(i.vE.ui.sidebar.empty(),i.vE.ui.sidebar.maxWidth=254);const t=i.vE.config("modules.story-editor");if(this._editor=new Zl({$el:this.$els.editor,type:tl.ik[i.vE.config("modules.story-editor.type")]||tl.ik.NORMAL,authorId:t.author_id,storyId:i.vE.config("modules.story-editor.story_id"),editorId:i.vE.config("modules.story-editor.page_id"),isUserModerator:i.vE.config("modules.story-editor.is_moderator"),maxTextLength:i.vE.config("modules.story-editor.LIMIT_MAX_TEXT_BLOCKS_LENGTH"),minTitleLength:i.vE.config("modules.story-editor.LIMIT_MIN_TITLE_LENGTH"),maxTitleLength:i.vE.config("modules.story-editor.LIMIT_MAX_TITLE_LENGTH"),limitImageBytes:i.vE.initParams.maxImageFileSize||i.vE.config("modules.story-editor.LIMIT_IMAGES_BYTES"),limitVideoMinWidth:t.LIMIT_INPUT_MIN_WIDTH,limitVideoMinHeight:t.LIMIT_INPUT_MIN_HEIGHT,limitVideoBytes:t.LIMIT_MAX_FILE_SIZE,limitVideoInputMinDuration:t.LIMIT_INPUT_MIN_DURATION,limitVideoOutputMaxDuration:t.LIMIT_OUTPUT_MAX_DURATION,limitVideoInputMaxDuration:t.LIMIT_INPUT_MAX_DURATION,limitVideoMinRatio:t.LIMIT_INPUT_MIN_RATIO,limitVideoMaxRatio:t.LIMIT_INPUT_MAX_RATIO,isVideoFileEnabled:t.LIMIT_ADD_VIDEO_ENABLED,isImageSearchDisabled:t.is_image_search_disabled,maxVideos:i.vE.config("modules.story-editor.LIMIT_MAX_VIDEO_BLOCKS_COUNT"),maxMedia:i.vE.config("modules.story-editor.LIMIT_MAX_MEDIA_BLOCKS_COUNT"),maxBlocks:i.vE.config("modules.story-editor.LIMIT_MAX_BLOCKS_COUNT"),minRatingVideo:i.vE.config("modules.story-editor.LIMIT_ADD_VIDEO_MIN_RATING"),saveTargetId:i.vE.config("modules.story-editor.save_target_id"),hasBlogsAccess:i.vE.config("modules.story-editor.has_blogs_access"),page:this}),this._initCommunityToast(),await this._loadData(),this._editor.addBlankTextBlock(),q.V.isUserInExperiment(q.t.ADD_POST_GUIDE,"gr1")){this._storyGuide=new Jl,i.vE.ui.$els.sidebar.css("overflow","visible"),i.vE.ui.$els.sidebarInner.append(this._storyGuide.$el);const t=i.vE.ui.$els.main.get(0),e=this._storyGuide.el,s=()=>{const s=Math.min(window.innerHeight,t.getBoundingClientRect().bottom),n=e.parentElement.getBoundingClientRect().bottom,o=Math.max(s-n-i.vE.ui.css.margin,0);e.style.setProperty("--shift",o+"px")};s(),this.listenTo(i.vE.ui,"document-scroll",s),this.listenTo(this._editor,el.Ks.BLOCKS_UPDATED,s)}}return i.vE.ui.screen=lt.d.POST_ADD,null===(t=this._editor._title)||void 0===t||t.updateTitleValidationRules(Boolean(this._editor.parentStoryId)),super.render(),this}_initCommunityToast(){this.listenToOnce(this._editor,"community-changed",(()=>{const{community:t}=this._editor;if(t&&!t.is_locked){new v.O({content:`Вы добавляете пост в сообщество «${t.name}».`}).show()}})),this.listenTo(this._editor,"community-changed",(()=>{const{community:t}=this._editor;null!=t&&t.is_locked&&i.vE.ui.toasts.showError("story-editor.errors.community-locked")}))}async _loadData(){if("function"==typeof parent.__setStoryData){const t=parent.__getStoryData();t&&await this._editor.deserialize(t)}else i.vE.config("modules.story-editor.story_id")||"schedule"===i.vE.config("modules.story-editor.type")?await this._editor.deserialize(i.vE.config("modules.story-editor.story")):await this._editor.initDrafts(i.vE.config("modules.story-editor.draft"));await c.cQ.delay(300),this.$els.loading.remove(),this.$els.editor.show(),this.emit("data-loaded")}}const sh=s(9755);class ih extends Fs.T3{render(){return this.isRendered||(this.$el=sh(".awards-feed"),this.$els={loadMore:this.$(".awards-feed__show-more button"),list:this.$(".awards-feed__list")},this._page=2,this.$els.loadMore.length&&(this._loadMoreBtn=new st.y3({$el:this.$els.loadMore}),this.listenTo(this._loadMoreBtn,"click",this._loadMore)),i.ZP.ui.screen=lt.d.AWARDS_LENT,super.render()),this}_loadMore(){const t=window.location.pathname.match(/\/awards(?:\/(individual|community))?$/)[1]||"all";this._loadMoreBtn.progress=!0,class{static async getAwards(t,e){const s={ajax_mode:1,page:t,mode:e},i="individual"===e?"/awards/individual":"/awards",{response:n,data:o}=await S.cf.get(i,s);if(!n.result)throw new Error(n.message);return o}}.getAwards(this._page,t).then((t=>{this._loadMoreBtn.progress=!1,t.eof&&this.$els.loadMore.fadeOut(),this._page=this._page+1;let e=sh(t.html).hide();this.$els.list.append(e),e.slideDown("fast")}),(t=>{this._loadMoreBtn.progress=!1,i.ZP.ui.toasts.showError(t)}))}}const nh=ih,oh=s(9755);class rh extends Fs.T3{render(){return this.isRendered||(this.$el=oh(".password-restore"),"new_password"===this.$el.data("role")?new Gt(this.$el):new Ut(this.$el),super.render()),this}}const ah=s(9755);class lh extends Fs.T3{render(){return this.isRendered||(this.$el=ah(".survey"),this.$els={saveButton:this.$(".survey__buttons-bar button"),radioAnswers:this.$('.survey-question__answer input[type="radio"]'),questions:this.$(".survey-question")},this._id=this.$el.data("id"),this.$els.saveButton.click(this.save.bind(this)),this.$els.radioAnswers.each(((t,e)=>{new $r.Z({$el:ah(e)}).on("change",(()=>{"n"===this.$els.saveButton.data("disabled")&&ah('.survey-question__answer input[type="radio"]:checked').length>0?this.$els.saveButton.removeAttr("disabled"):this.$els.saveButton.attr("disabled","disabled")}))})),super.render()),this}async save(){let t={},e=!0;if(this.$els.questions.each(((s,n)=>{let o=ah(n),r=o.find('input[type="radio"]:checked').val();r?t[o.data("id")]=r:(e&&i.ZP.ui.toasts.showError("page-survey.errors."+(this.$els.questions.length>1?"no-answer-all":"no-answer")),e=!1)})),e){this.$els.saveButton.attr("disabled","disabled"),this.$els.radioAnswers.attr("disabled","disabled");try{await class{static async save(t,e){const{response:s,data:i}=await S.cf.post("/ajax/surveys_actions.php",{action:"vote",id:t,answers:JSON.stringify(e)});if(!s.result)throw new Error(s.message);return i.result}}.save(this._id,t),window.scrollTo(0,0),window.location.reload()}catch(s){this.$els.radioAnswers.removeAttr("disabled"),this.$els.saveButton.removeAttr("disabled"),i.ZP.ui.toasts.showError(s.message||i.ZP.i18n("page-survey.errors.invalid-request"))}}}}s(2087);var hh=s(9415);function ch(t,e,s){return e in t?Object.defineProperty(t,e,{value:s,enumerable:!0,configurable:!0,writable:!0}):t[e]=s,t}class dh{constructor(t){ch(this,"flags",{}),ch(this,"scoreBasedResult",0),ch(this,"_current",0),ch(this,"_isFinished",!1),ch(this,"_isStarted",!1),ch(this,"_results",{score:0,data:{}}),this._defaults=t,this._final=t.final,this.questionsCount=t.questions.length,this.isScoreBased=t.settings.score_based,this.id=t.id,this.oid=t.oid,this.pixels=t.pixels,this.questions=t.questions,this._initFlags(),this._pixelReplaceRandom("feed"),this._pixelReplaceRandom("result"),this._addFeedPixel()}start(){this._isStarted=!0,this._isFinished=!1,this._current=1,this._results.score=0,this._results.data={},this._saveStart()}next(){this._current++}finish(){this._saveResult(this._results.data),this._isStarted&&this._current>=this.questionsCount&&(this._isFinished=!0)}pushResult(t){t.success&&this._results.score++,this._results.data[t.question]=[t.answer],this._current!==this.questionsCount&&this._saveResult(this._results.data)}loadImage(t,e,s){const i=new Image;i.src=t,i.onload=()=>{e(s)}}getImageSrc(t){const e=t.find(".pt-question__desc img");return e.length?e.attr("src"):""}showImageBlock(t){const e=this.getImageSrc(t),s=t.find(".pt-question__loading");e?this.loadImage(e,(()=>{s.hide()})):s.hide()}getResults(t){const e=this._final.scores.length;let s=this._final.scores[0],i=0;for(let n=0;n<e;n++)t<=this._final.scores[n].score&&t>i&&(s=this._final.scores[n]),i=this._final.scores[n].score;return t>=this._final.scores[e-1].score&&(s=this._final.scores[e-1]),{title:this._final.title||this._defaults.general.title,fontColor:this._final.font.color,data:s,isShowCountAnswers:this.flags.show_correct_answers_count,pixel:this.pixels.result}}pushMetricsGoal(t){window.ym&&t&&d.c.getInstance().yandex.goal(t)}async _saveStart(){const t={action:"start",id:this.id},{response:e,data:s}=await S.cf.post("/ajax/promo_test_actions.php",t);if(!e.result)throw new Error(e.message);return s.result}async _saveResult(t){const e={action:"result",id:this.id,result:JSON.stringify(t)},{response:s,data:i}=await S.cf.post("/ajax/promo_test_actions.php",e);if(!s.result)throw new Error(s.message);return i.result}_initFlags(){js.default.each(this._defaults.flags,(t=>{this.flags[t.type]=t.value}))}_pixelReplaceRandom(t){if(!this.pixels[t])return;const e=Math.round(1e6*Math.random());this.pixels[t]=this.pixels[t].replace("%random%",String(e))}_addFeedPixel(){const t=ee()(".promo-test__pixel-feed");if(!t.length||"string"!=typeof this.pixels.feed)return;if(!hh.v)return void t.attr("src",this.pixels.feed);new IntersectionObserver((t=>{t.forEach((t=>{t.isIntersecting&&!t.target.getAttribute("src")&&t.target.setAttribute("src",this.pixels.feed)}))})).observe(t[0])}get score(){return this._results.score}get isFinished(){return this._isFinished}get current(){return this._current}}var uh=s(9050);const ph=s(9755),mh=s(6419);class _h extends n.u1{constructor(t){super(t),this.akey="a_",this._data=t.data,this._parent=t.parent,this._ptcontroller=t.controller,this._ptmodel=this._ptcontroller.model,this.orderId=t.orderId,this.isPassed=!1,this.selected=null,this.classes={answer:"pt-answer",checked:"pt-answer_checked",checkedFail:"pt-answer_checked-fail",correct:"pt-answer_correct",short:"pt-answer_short",nextbtn:"promo-test__next-button",result:"promo-test__answer-text"},this._initAnswers(),this._initMode()}_initAnswers(){this._answers={};for(let t=0;t<this._data.options.length;t++)this._answers[this.akey+this._data.options[t].id]=this._data.options[t]}_initMode(){this._mode=0,this._ptmodel.flags.mode&&Number(this._ptmodel.flags.mode)>0&&(this._mode=Number(this._ptmodel.flags.mode))}render(){return this.isRendered||(this.$el=ph(function(t){var e,s="",i=uh.escape;Array.prototype.join,s+='<div class="promo-test__screen promo-test__screen_question pt-question">\n\t<div class="pt-question__info">\n\t\t<div class="pt-question__number">\n\t\t\t';let n=t.questionsCount>9&&t.orderId<10?"0"+t.orderId:t.orderId;s+='\n\t\t\t<span class="pt-question__n-current">'+i(n)+'</span> / <span class="pt-question__n-all">'+i(t.questionsCount)+'</span>\n\t\t</div>\n\t\t<h3 class="pt-question__question">'+(null==(e=t.title)?"":e)+'</h3>\n\t\t<div class="pt-question__desc">\n\t\t\t<div class="pt-question__loading"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon--ui__progress-circle icon--ui__progress-circle_story-editor"><use xlink:href="#icon--ui__progress-circle"></use></svg></div>\n\t\t\t'+(null==(e=t.desc)?"":e)+'\n\t\t</div>\n\t</div>\n\t<div class="pt-question__answers">\n\t\t<ul>\n\t\t';for(let o=0;o<t.options.length;o++)s+='\n\t\t\t<li class="pt-question__answer pt-answer" data-id="'+i(t.options[o].id)+'">\n\t\t\t\t<span>'+(null==(e=t.options[o].desc)?"":e)+"</span>\n\t\t\t</li>\n\t\t";return s+='\n\t\t</ul>\n\t</div>\n\t<div class="pt-question__bottom">\n\t\t<div class="promo-test__answer-text"></div>\n\t\t<button class="button_success promo-test__button promo-test__next-button">\n\t\t\t',t.orderId===t.questionsCount?s+="\n\t\t\t\t<span>"+(null==(e=t.i18n.resultbtn)?"":e)+"</span>\n\t\t\t":s+="\n\t\t\t\t<span>"+(null==(e=t.i18n.nextbtn)?"":e)+"</span>\n\t\t\t",s+"\n\t\t</button>\n\t</div>\n</div>"}(mh.extend(this._data,{orderId:this.orderId,questionsCount:this._ptmodel.questionsCount,i18n:{nextbtn:i.vE.i18n("promo-test.buttons.next"),resultbtn:i.vE.i18n("promo-test.buttons.result")}}))),this.$el.on("click",`.${this.classes.answer}`,this._clickAnswer.bind(this)),this.$el.on("click",`.${this.classes.nextbtn}`,this._goNext.bind(this)),this.$els={result:this.$el.find(`.${this.classes.result}`),nextbtn:this.$el.find(`.${this.classes.nextbtn}`)},this.reset(),this.$el.appendTo(this._parent),super.render()),this}show(){return this.isRendered||this.render(),this.$el.show(),this}_goNext(){this.emit("next",{success:this.selected.is_correct,question:this._data.id,answer:this.selected.id})}_clickAnswer(t){if(t.preventDefault(),this.isPassed)return;let e=ph(t.currentTarget),s=this._answers[this.akey+e.data("id")];this.isPassed=!0,this.selected=s,e.addClass(this.classes.checked),d.c.getInstance().sendEvent("click",{type:"promo_quiz_click"}),1!==this._mode&&(this.selected.is_correct?e.addClass(this.classes.correct):e.addClass(this.classes.checkedFail)),s.note&&s.note.length>0?(this.$els.result.html(s.note).show(),e.siblings(`.${this.classes.answer}`).hide()):e.addClass(this.classes.short),this._ptmodel.isScoreBased&&(this._ptmodel.scoreBasedResult+=s.score),this.$els.nextbtn.show()}reset(){this.isPassed=!1,this.selected=null,this.$el.find(`.${this.classes.answer}`).removeClass(this.classes.checked).removeClass(this.classes.correct).removeClass(this.classes.checkedFail).show(),this.$els.result.hide(),this.$els.nextbtn.hide()}}var gh=s(9050);const vh=s(9755),fh=s(6419);class yh extends Fs.T3{render(){return this.isRendered||(this.$els={box:vh(".promo-test").first(),startscreen:vh(".promo-test__screen_start"),startbutton:vh(".promo-test__start-button"),questionsbox:vh(".promo-test__questions"),finalbox:vh(".promo-test__final")},this._init(),this._initQuestions(),this.$els.startbutton.on("click",this.start.bind(this)),this.$els.finalbox.on("click",".promo-test__restart",this.restart.bind(this)),super.render()),this}_init(){let t=JSON.parse(vh('.app__config[data-entry="promo-test-data"]').text());t.id=this.$els.box.data("id"),t.oid=this.$els.box.data("oid"),this.model=new dh(t),this.$els.box.data("embedded")&&window.parent&&this._runEmbeddedMode(),this.$els.box.on("click","[data-goal]",(t=>{let e=vh(t.currentTarget).data("goal");this.model.pushMetricsGoal(e)}))}_initQuestions(){this._questions=this.model.questions;let t=0;fh.each(this._questions,(e=>{e.view=new _h({parent:this.$els.questionsbox,data:e,controller:this,orderId:++t}),e.view.on("next",this.next.bind(this))}))}start(){this.model.start(),this.$els.startscreen.hide(),this.showQuestion(1),this.$els.questionsbox.show()}showQuestion(t){this.$els.questionsbox.find(".pt-question").hide(),this._questions[t-1].view.show(),this.scrollTop(),this.model.showImageBlock(this._questions[t-1].view.$el),t<this.model.questionsCount&&this._questions[t].view.render().$el.hide()}next(t){this.model.pushResult(t),this.model.current>=this.model.questionsCount?this.showResults():(this.model.next(),this.showQuestion(this.model.current))}scrollTop(){if(this._isEmbedded){let t=window.parent.pageYOffset+window.frameElement.getBoundingClientRect().top;window.parent.scrollTo(0,t-48)}else i.vE.ui.scrollTo(this.$els.box)}getResults(){if(!this.model.isFinished)return!1;const t=this.model.isScoreBased?this.model.scoreBasedResult:this.model.score,e=this.model.getResults(t);return{id:this.model.id,questionsCount:this.model.questionsCount,fontColor:e.fontColor,img:e.img,title:e.title,result:e.data,isShowCountAnswers:e.isShowCountAnswers,isScoreBased:this.model.isScoreBased,pixel:this.model.pixels.result,settings:this.model._defaults.settings,score:t}}showResults(){this.model.finish();let t=this.getResults();this.$els.questionsbox.hide();const e=this.$els.finalbox.html(function(t){var e,s="",i=gh.escape;Array.prototype.join,s+='<div class="promo-test__loading"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon--ui__progress-circle icon--ui__progress-circle_story-editor"><use xlink:href="#icon--ui__progress-circle"></use></svg></div>\n<div class="promo-test__screen promo-test__screen_final promo-test__screen_final_hide">\n\t',t.pixel&&(s+='\n\t\t<img src="'+(null==(e=t.pixel)?"":e)+'" border=0 width=1 height=1>\n\t'),s+='\n\t<div class="promo-test__result-image">\n\t\t<div class="promo-test__bg" style="background-image:url(\''+(null==(e=t.result.img)?"":e)+'\')"></div>\n\t\t<div class="promo-test__text" style="color: '+(null==(e=t.fontColor)?"":e)+'">\n\t\t\t<h3>'+i(t.title)+"</h3>\n\t\t\t",t.isShowCountAnswers&&(s+="\n\t\t\t\t",t.isScoreBased||(s+='\n\t\t\t\t\t<div class="promo-test__result-score">'+(null==(e=t.score)?"":e)+"/"+(null==(e=t.questionsCount)?"":e)+"</div>\n\t\t\t\t"),s+="\n\t\t\t\t",t.isScoreBased&&(s+='\n\t\t\t\t\t<div class="promo-test__result-score">'+(null==(e=t.score)?"":e)+"</div>\n\t\t\t\t"),s+="\n\t\t\t"),s+='\n\t\t\t<p class="promo-test__result-title">'+(null==(e=t.result.title)?"":e)+"</p>\n\t\t</div>\n\t</div>\n\t";let n=t.settings.share&&t.settings.share.goal_prefix?t.settings.share.goal_prefix:null;s+="\n\t";let o=encodeURIComponent("https://pikabu.ru/promo-test/"+t.id+"?share=1&score="+t.score);return s+'\n\t<div class="promo-test__sharer">\n\t\t<a class="promo-test__share-btn promo-test__share-btn_fb" href="https://www.facebook.com/sharer/sharer.php?u='+(null==(e=o)?"":e)+'" data-goal="'+(null==(e=n?n+"_fb_web":"")?"":e)+'" target="_blank">\n\t\t\t<i class="fa fa-facebook" aria-hidden="true"></i>\n\t\t</a>\n\t\t<a class="promo-test__share-btn promo-test__share-btn_tw" href="https://twitter.com/share?url='+(null==(e=o)?"":e)+'" data-goal="'+(null==(e=n?n+"_tw_web":"")?"":e)+'" target="_blank">\n\t\t\t<i class="fa fa-twitter" aria-hidden="true"></i>\n\t\t</a>\n\t\t<a class="promo-test__share-btn promo-test__share-btn_vk" href="https://vk.com/share.php?url='+(null==(e=o)?"":e)+'" data-goal="'+(null==(e=n?n+"_vk_web":"")?"":e)+'" target="_blank">\n\t\t\t<i class="fa fa-vk" aria-hidden="true"></i>\n\t\t</a>\n\t\t<a class="promo-test__share-btn promo-test__share-btn_ok" href="https://connect.ok.ru/offer?url='+(null==(e=o)?"":e)+'" data-goal="'+(null==(e=n?n+"_ok_web":"")?"":e)+'" target="_blank">\n\t\t\t<i class="fa fa-odnoklassniki" aria-hidden="true"></i>\n\t\t</a>\n\t</div>\n\t<div class="promo-test__hr"></div>\n\t<div class="promo-test__result-note">'+(null==(e=t.result.note)?"":e)+'</div>\n\t<div class="promo-test__restart">\n\t\t<span>Ещё раз</span><i class="fa fa-undo" aria-hidden="true"></i>\n\t</div>\n</div>'}(t));e.show(),t.result.img?this.model.loadImage(t.result.img,this.showFinalScreen,e):this.showFinalScreen(e),this.scrollTop()}showFinalScreen(t){t.find(".promo-test__loading").hide(),t.find(".promo-test__screen_final").removeClass("promo-test__screen_final_hide")}restart(){for(let t=0;t<this._questions.length;t++)this._questions[t].view.reset();this.model.scoreBasedResult=0,this.$els.finalbox.hide().html(""),this.$els.startscreen.show(),this.scrollTop()}_runEmbeddedMode(){this._isEmbedded=!0,this._ro=new ne.Z(((t,e)=>{for(const s of t)window.frameElement.style.height=s.contentRect.height+"px"})),this._ro.observe(this.$els.box[0]),document.body.style.overflow="hidden"}}const bh=s(9755);class wh extends Fs.T3{render(){return this.isRendered||(this.$el=bh(".stories-feed"),this._feed=new ys._D({$el:this.$el,feedName:"news-preview",focused:!0}),super.render()),this}}var Eh=s(6171),Sh=s(2164),Ch=s(3246);const Th=s(6419);class Oh{static async save(t,e,s){let{response:i,data:n}=await S.cf.post("/ajax/cedit_actions.php",Th.defaults({action:"save",type:t,sid:e},s));if(!i.result)throw new Error(i.message);return n.id}static async vote(t,e){let{response:s}=await S.cf.post("/ajax/cedit_actions.php",{action:"vote",id:e,v:t});if(!s.result)throw new Error(s.message)}static async approve(t){let{response:e}=await S.cf.post("/ajax/cedit_actions.php",{action:"approve",id:t});if(!e.result)throw new Error(e.message)}static async reject(t){let{response:e}=await S.cf.post("/ajax/cedit_actions.php",{action:"reject",id:t});if(!e.result)throw new Error(e.message)}static async revert(t){let{response:e}=await S.cf.post("/ajax/cedit_actions.php",{action:"revert",id:t});if(!e.result)throw new Error(e.message)}static async remove(t){let{response:e}=await S.cf.post("/ajax/cedit_actions.php",{action:"delete",id:t});if(!e.result)throw new Error(e.message)}static async blockStory(t,e,s){let{response:i}=await S.cf.post("/ajax/cedit_actions.php",{action:"block_story",sid:t,type:e,flag:s?"1":"0"});if(!i.result)throw new Error(i.message)}static async hidePromoBlock(){let{response:t}=await S.cf.post("/ajax/cedit_actions.php",{action:"hide_promo"});if(!t.result)throw new Error(t.message)}}var kh=s(2427);class Ih extends n.u1{constructor(t,e){super(t),this.$els={tags:this.$(".cedit-record__tag"),ratingUp:this.$(".cedit-record__rating-up"),ratingDown:this.$(".cedit-record__rating-down"),approveButton:this.$(".cedit-record__button_approve"),rejectButton:this.$(".cedit-record__button_reject"),revertButton:this.$(".cedit-record__button_revert"),deleteButton:this.$(".cedit-record__button_delete"),plusesBar:this.$(".cedit-record__rating-bar-pluses"),label:this.$(".cedit-record__label")},this._id=this.$el.data("id"),this._isLocked=!1,this._story=e,this._assignListeners()}_assignListeners(){this.$els.ratingUp.length>0&&(this.$els.ratingUp.on("click",(()=>{this.$els.ratingUp.hasClass("cedit-record__rating-up_disabled")||this.vote(!0)})),this.$els.ratingDown.on("click",(()=>{this.$els.ratingDown.hasClass("cedit-record__rating-down_disabled")||this.vote(!1)}))),this.$els.deleteButton.on("click",(()=>{this.remove()})),this.$els.approveButton.length>0&&(this.$els.approveButton.on("click",(()=>{this.approve()})),this.$els.rejectButton.on("click",(()=>{this.reject()})),this.$els.revertButton.on("click",(()=>{this.revert()})))}_updateState(){let t="true"===this.$el.attr("data-is-approved"),e="true"===this.$el.attr("data-is-rejected");this.$els.ratingUp.toggleClass("cedit-record__rating-up_disabled",t||e),this.$els.ratingDown.toggleClass("cedit-record__rating-down_disabled",t||e),t||e?this.$els.label.text(i.vE.i18n("cedit.label."+(t?"approved":"rejected"),i.vE.initParams.isUserModerator?"":i.vE.initParams.userName)).attr("class","cedit-record__label "+(t?"cedit-record__label_approved":"cedit-record__label_rejected")):this.$els.label.text(i.vE.i18n("cedit.label.waiting")).attr("class","cedit-record__label cedit-record__label_waiting")}async approve(){if(!this._isLocked&&"true"!==this.$el.attr("data-is-approved")&&"true"!==this.$el.attr("data-is-canceled")){this.$el.attr("data-is-approved","true"),this.$el.attr("data-is-rejected","false");try{this._isLocked=!0,await Oh.approve(this._id),this._isLocked=!1,this._updateState()}catch(t){this.$el.attr("data-is-approved","false"),this._updateState(),i.vE.ui.toasts.add({theme:v.K.DANGER,content:t.message}),this._isLocked=!1}}}async reject(){if(!this._isLocked&&"true"!==this.$el.attr("data-is-rejected")&&"true"!==this.$el.attr("data-is-canceled")){this.$el.attr("data-is-approved","false"),this.$el.attr("data-is-rejected","true");try{this._isLocked=!0,await Oh.reject(this._id),this._isLocked=!1,this._updateState()}catch(t){this.$el.attr("data-is-rejected","false"),this._updateState(),i.vE.ui.toasts.add({theme:v.K.DANGER,content:t.message}),this._isLocked=!1}}}async revert(){let t=this.$el.attr("data-is-approved"),e=this.$el.attr("data-is-rejected");if(!(this._isLocked||"false"===t&&"false"===e||"true"===this.$el.attr("data-is-canceled"))){this.$el.attr("data-is-approved","false"),this.$el.attr("data-is-rejected","false");try{this._isLocked=!0,await Oh.revert(this._id),this._isLocked=!1,this._updateState()}catch(s){this.$el.attr("data-is-approved",t),this.$el.attr("data-is-reject",e),this._updateState(),i.vE.ui.toasts.add({theme:v.K.DANGER,content:s.message})}}}async remove(){if(!this._isLocked)try{await Oh.remove(this._id),this._story&&kh.l.getInstance().sendAddedOrRemovedTagsAnalytics(this._story.tagsList,[...this.$els.tags].map((t=>t.dataset.tag)),{event:"tag_edit_propose",story:this._story,extraParams:{proposal:Dl.a8.CANCEL.value}}),this._isLocked=!0,window.location.reload()}catch(t){i.vE.ui.toasts.add({theme:v.K.DANGER,content:t.message})}}async vote(t){if("true"!==this.$el.attr("data-is-available"))return;if(!i.vE.isUserAuthorized)return void i.vE.ui.authRequired();let e=0,s=t?10:-10;if(this.$els.ratingUp.hasClass("cedit-record__rating-up_active")?(e=1,s=t?0:-10):this.$els.ratingDown.hasClass("cedit-record__rating-down_active")&&(e=-1,s=t?10:0),t){if(1===e)return;-1===e?(this.$els.ratingDown.removeClass("cedit-record__rating-down_active"),e=0):(this.$els.ratingUp.addClass("cedit-record__rating-up_active"),e=1)}else{if(-1===e)return;1===e?(this.$els.ratingUp.removeClass("cedit-record__rating-up_active"),e=0):(this.$els.ratingDown.addClass("cedit-record__rating-down_active"),e=-1)}let n=parseInt(this.$els.plusesBar.attr("data-new-width")||this.$els.plusesBar.attr("data-width"))+s,o=Math.min(100,Math.max(0,n));this.$els.plusesBar.attr("data-new-width",n).attr("data-width",o).css("width",o+"%");try{await Oh.vote(e,this._id),0!==e&&this._story&&kh.l.getInstance().sendAddedOrRemovedTagsAnalytics(this._story.tagsList,[...this.$els.tags].map((t=>t.dataset.tag)),{event:"tag_edit_vote",story:this._story,extraParams:{user_rate:e}})}catch(r){1===e?this.$els.ratingUp.removeClass("cedit-record__rating-up_active"):-1===e&&this.$els.ratingDown.removeClass("cedit-record__rating-down_active"),i.vE.ui.toasts.add({theme:v.K.DANGER,content:r.message})}}}const $h=s(9755);class Ah extends Fs.T3{route(t,e){return this.ctx=t,this.show(),this._mode=t.params.mode||"waiting",this.filterRecordsByMode(),e()}render(){if(this.isRendered)return this;let t=$h(".cedit-records");if(this.$els=Object.assign(this.$els||{},{recsCont:t,recs:t.find(".cedit-record").detach(),story:$h(".cedit-story"),emptyMessages:t.find(".cedit-records__empty-msg")}),this._mode=this.$els.recsCont.data("mode")||"waiting",this._records=new WeakMap,this.$els.story.length>0){const t=new Al._({$el:this.$els.story,feedName:"story"});this._story=t.stories.items[0]}return this.$els.recs.each(((t,e)=>{this._records.has(e)||this._records.set(e,new Ih(e,this._story))})),i.vE.ui.screen=lt.d.POST_TAG_EDIT,super.render(),this}filterRecordsByMode(){let t=null;switch(this.$els.recs.detach(),this._mode){case"waiting":t=this.$els.recs.filter('[data-is-approved="false"][data-is-rejected="false"][data-is-canceled="false"]');break;case"approved":t=this.$els.recs.filter('[data-is-approved="true"]');break;case"rejected":t=this.$els.recs.filter('[data-is-rejected="true"]');break;case"canceled":t=this.$els.recs.filter('[data-is-canceled="true"]')}return this.$els.emptyMessages.removeClass("cedit-records__empty-msg_show"),t&&(this.$els.recsCont.prepend(t.addClass("cedit-record_show")),this.$els.emptyMessages.filter(`[data-mode="${this._mode}"]`).toggleClass("cedit-records__empty-msg_show",0===t.length)),this}}var xh=s(9025),Dh=s(8969);const Ph=s(9755);class Rh extends Ah{render(){if(this.isRendered)return this;this.$el=Ph(".cedit-editor"),this.$els=Object.assign(this.$els||{},{form:this.$(".cedit-editor__form"),submitButton:this.$('.cedit-editor__form button[type="submit"]'),blockButton:this.$(".cedit-story__block-btn")}),this._storyId=parseInt(this.$el.data("story-id"))||0,this._type=this.$el.data("type")||"tags",this._id=parseInt(this.$el.data("id"))||0,this._form=this.$els.form.length>0?new Eh.x(this.$els.form):null,this._submitButton=this.$els.submitButton.length>0?new Sh.y(this.$els.submitButton):null,this._form&&(this.listenTo(this._form,"submit",this._onSubmit),"tags"===this._type&&this._initTagsEditor()),this.$els.blockButton.on("click",this._onToggleBlock.bind(this)),i.vE.ui.screen=lt.d.POST_TAG_EDIT,super.render()}async _onToggleBlock(){let t=this.$els.blockButton;if(!this.marks.has("is_blocked")){this.marks.set("is_blocked",!0),t.toggleClass("cedit-story__block-btn_active");try{await Oh.blockStory(this._storyId,this._type,t.hasClass("cedit-story__block-btn_active"))}catch(e){this._submitButton.disabled=!1,i.vE.ui.toasts.showError(e)}this.marks.delete("is_blocked")}}async _onSubmit(t,e){if(t.preventDefault(),this._submitButton.progress)return!1;await c.cQ.delay(100);const s=e instanceof Eh.x?e:this._form;if(!(await s.checkValidity(!0)))return!1;this._submitButton.progress=!0;try{this._submitButton.disabled=!0;const t=this._form.serialize(),e=t.tags.split(",");let s=await Oh.save(this._type,this._storyId,t);kh.l.getInstance().sendAddedOrRemovedTagsAnalytics(this._story.tagsList,e,{event:"tag_edit_propose",story:this._story}),i.vE.ui.toasts.add({content:i.vE.i18n("cedit.editor.form.saved")}),await c.cQ.delay(500),window.location.href=`/edits/${this._storyId}/${s}`}catch(n){this._submitButton.disabled=!1,i.vE.ui.toasts.showError(n)}this._submitButton.progress=!1}_initTagsEditor(){if(this.$(".input_tags").length>0){let t=new Ch.K({$el:this.$(".input_tags"),validationHint:!0,validationEvent:Dh.k.BLUR,softLimitsValidation:!0});t.suggestion=new xh.Z({tagsLine:!0}),this._form.add(t),this._hotkeys=new it.SV(t.$el.find("input")),this._hotkeys.on("cmd+enter",this._onSubmit.bind(this),{type:it.FM.KEYDOWN})}}}const Mh=s(9755);class Nh extends Fs.T3{render(){if(this.isRendered)return this;const t=new Al._({$el:Mh(".cedit-story"),feedName:"story"});return new Ih(Mh(".cedit-record"),t.stories.items[0]),i.vE.ui.screen=lt.d.POST_TAG_EDIT,super.render(),this}}const Bh=new I.xs({SHOW_ALL:0,HIDE_VOTED:1}),Lh=new I.xs({ACTUALITY:0,TIME_DESC:1,TIME_ASC:2}),Fh=new I.xs({ALL:"all",WAITING:"waiting",APPROVED:"approved",REJECTED:"rejected",CANCELED:"canceled"}),Uh=new I.xs({SHOW:0,HIDE:1});function jh(t){var e,s="";return s+='<form class="cedit-feed-filter">\n\t<label class="cedit-feed-filter__field">\n\t\t<span class="cedit-feed-filter__title">Скрывать оценённые</span>\n\t\t<input type="checkbox" name="hideVoted" class="checkbox_switch" value="true" data-to-boolean="true" '+(null==(e=t.hideVoted?'checked="checked"':"")?"":e)+'>\n\t</label>\n    <label class="cedit-feed-filter__field">\n        <span class="cedit-feed-filter__title">Скрывать автоматические предложения</span>\n        <input type="checkbox" name="botFilter" class="checkbox_switch" value="true" data-to-boolean="true" '+(null==(e=t.botFilter?'checked="checked"':"")?"":e)+'>\n    </label>\n\t<label class="cedit-feed-filter__field">\n\t\t<span class="cedit-feed-filter__title">Сортировка</span>\n\t\t<select data-role="listbox" name="sort">\n\t\t\t<option value="0" '+(null==(e=0===t.sort?'selected="selected"':"")?"":e)+'>По актуальности</option>\n\t\t\t<option value="1" '+(null==(e=1===t.sort?'selected="selected"':"")?"":e)+'>Сначала новые</option>\n\t\t\t<option value="2" '+(null==(e=2===t.sort?'selected="selected"':"")?"":e)+">Сначала старые</option>\n\t\t</select>\n\t</label>\n</form>\n"}const Vh=s(9755),Hh=s(6419);class qh extends Fs.T3{route(t,e){this.ctx=t,this.show();const s="string"==typeof t.params.user?"user":t.params.mode||"waiting";return this._mode===s||"mine"===this._mode&&"user"===s&&t.params.user===i.vE.initParams.userName||(this._mode=s,this.$el&&this.$el.attr("data-mode",this._mode),this._rebuildFeed()),e()}render(){if(this.isRendered)return this;this.$el=Vh(".cedit-feed"),this.$els={panel:this.$(".cedit-feed__panel"),statusFilter:this.$(".cedit-feed__status-filter"),statusFilterButtons:this.$(".cedit-feed__status-filter .cedit-feed__button"),filterButton:this.$el.find(".button-filter"),total:this.$(".cedit-feed__total")};const t=new URLSearchParams(window.location.search),e=t.get("filter")||this.$el.data("filter"),s=t.get("bot_filter")||this.$el.data("bot-filter"),n=t.get("sort")||this.$el.data("sort"),o=t.get("status")||this.$els.statusFilter.data("status")||"all";return this._mode=this.$el.data("mode")||"waiting",this._status=Fh[o]||Fh.ALL,this._records=new WeakMap,this._filterMode=Bh[parseInt(e)]||Bh.SHOW_ALL,this._botFilterMode=Uh[parseInt(s)]||Uh.SHOW,this._sortMode=Lh[parseInt(n)]||Lh.ACTUALITY,this._feed=new Al._({$el:this.$el,feedName:"cedit",focused:!0}),this.$els.filterButton.toggleClass("cedit-feed__filter-button_hide","waiting"!==this._mode),this.listenTo(this._feed,"loaded",this._processFeedLoad.bind(this)),Vh(".cedit-promo button").on("click",this._hidePromo.bind(this)),i.vE.ui.screen=lt.d.TAGS_EDITS,super.render(),this._prepareFeedFilter(),this._prepareStatusFilter(),this._processFeedLoad(),this}_prepareFeedFilter(){if(!this.$els.filterButton.length)return;const t=new k._({target:this.$els.filterButton,alignment:k.SE.END,distance:-12,indent:!1,content:jh({hideVoted:this._filterMode===Bh.HIDE_VOTED,sort:this._sortMode.valueOf(),botFilter:this._botFilterMode===Uh.HIDE})}),e=t.content;this.$els.filterButton.on("click",(()=>t.toggle())),this.listenTo(t,n.eM.RENDERED,(()=>{const s=new a.x(e);this.listenTo(s,"change",(()=>{const e=s.serialize();this._filterMode=Bh[e.hideVoted?1:0],this._botFilterMode=Uh[e.botFilter?1:0],this._sortMode=Lh[parseInt(e.sort)],t.hide(),this._rebuildFeed()}))}))}_prepareStatusFilter(){this.$els.statusFilterButtons.on("click",(t=>{const e=Vh(t.target).closest(".cedit-feed__button").data("value");this._status=Fh[e],this.$els.statusFilter.attr("data-status",this._status.valueOf());const s=new URLSearchParams(window.location.search);s.delete("page"),i.vE.history.replaceUrl(window.location.pathname+"?"+s.toString()),this._rebuildFeed()}))}_hidePromo(){Oh.hidePromoBlock(),Vh(".cedit-promo").slideUp(500)}_rebuildFeed(){this.$els.panel.addClass("cedit-feed__panel_hide"),this.$els.filterButton.toggleClass("cedit-feed__filter-button_hide","waiting"!==this._mode);const t=new URLSearchParams(window.location.search);this._records=new WeakMap,this._feed.requestUrl=window.location.pathname,this._feed.searchParams.set("filter",this._filterMode.valueOf()),this._feed.searchParams.set("bot_filter",this._botFilterMode.valueOf()),this._feed.searchParams.set("sort",this._sortMode.valueOf()),this._feed.searchParams.set("status",this._status.valueOf()),t.set("filter",this._filterMode.valueOf()),t.set("bot_filter",this._botFilterMode.valueOf()),t.set("sort",this._sortMode.valueOf()),t.set("status",this._status.valueOf());const e=t.get("page");e&&(this._feed.page=parseInt(e)),i.vE.history.replaceUrl(window.location.pathname+"?"+t.toString()),this._feed.clear().loadStories(!1)}_processFeedLoad(t){t&&this.$els.total.text(i.vE.i18n("cedit.feed.total",parseInt(t.total_cedit_recs))),this.$els.panel.removeClass("cedit-feed__panel_hide"),Hh.defer((()=>{this.$el.find(".cedit-record").each(((t,e)=>{if(!this._records.has(e)){const t=this._feed.stories.get(Number(e.closest(".story").dataset.storyId));this._records.set(e,new Ih(e,t))}})),this.$el.find(".cedit-records__show-more:not(.cedit-records__show-more_processed)").addClass("cedit-records__show-more_processed").on("click",qh._onShowMore)}))}static _onShowMore(t){Vh(t.target).closest(".cedit-records").addClass("cedit-records_view-all").find(".cedit-record").addClass("cedit-record_show")}}var Wh=s(3432),Gh=s(9050);var Yh=s(9050);function zh(t,e,s){return e in t?Object.defineProperty(t,e,{value:s,enumerable:!0,configurable:!0,writable:!0}):t[e]=s,t}const Zh=s(9755);class Kh extends n.u1{constructor(t){super(),zh(this,"_labelPopupShown",!1),zh(this,"_onMentionMarked",(()=>{})),this.mention=t.mention,this._onMentionMarked=t.onMentionMarked}render(){return this.isRendered?this:(this.$el=Zh(function(t){var e,i="",n=Gh.escape;Array.prototype.join;const o=s(8211).vE;return i+='\n\n<section class="client-mention" data-type="'+n(t.type)+'" data-id="'+n(t.id)+'">\n    <div class="client-mention__header">\n        ',t.isRead||(i+='\n            <span class="client-mention__badge client-mention__badge_new">Новое</span>\n        '),i+='\n\n        <span class="client-mention__badge">'+n(o.i18n("reputation.typeCaptions."+t.type))+'</span>\n        <div class="client-mention__label-controls"></div>\n\n        ',t.isRead||(i+='\n            <div class="client-mention__read-btn button_link-icon">\n                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon--ui__message"><use xlink:href="#icon--ui__message"></use></svg> Прочитано\n            </div>\n        '),i+='\n    </div>\n\n    <div class="client-mention__main">\n        ',i+"\n        "+(null==(e=t.html)?"":e)+"\n    </div>\n</section>"}(this.mention)),this.$els={label:this.$(".client-mention__label-controls"),readBtn:this.$(".client-mention__read-btn"),badgeNew:this.$(".client-mention__badge_new")},["comment","comment_reply"].includes(this.mention.type)&&this._initComment(),this._attachHandlers(),this._updateLabel(),super.render())}async _markAsRead(){this.mention.isRead||(await Wh.Y.markAsRead([this.mention]),this.mention.isRead=!0,this.$els.readBtn.hide(),this.$els.badgeNew.hide(),i.vE.ui.sidebar.reputationMonitoringMenuItem.decrementMentionsByType(this.mention.type),this._onMentionMarked())}removeLabel(){i.vE.ui.overlays.modal.hidePopup(),Wh.b.unstick(this.mention),this.mention.labelId=null,this.mention.labelName="",this._updateLabel()}async addLabel(){if(this._labelPopupShown)return;this._labelPopupShown=!0;const t=await Wh.b.popup(this.$els.label);this._labelPopupShown=!1,t&&(await Wh.b.stick(this.mention,t.id),this.mention.labelId=t.id,this.mention.labelName=t.name,this._updateLabel())}_initComment(){const t=this.$el.find(".comments").parent().addClass("comments-part");new ui.z({$el:t,mode:f.lL.REPUTATION}).show().initComments()}_attachHandlers(){this.$els.label.on("click",(t=>this._onLabelClick(t))),this.$els.readBtn.on("click",(()=>this._markAsRead()))}_updateLabel(){this.$els.label.html(function(t){var e="",s=Yh.escape;return Array.prototype.join,t.labelName?e+='\n    <span data-role="label-badge" class="client-mention__badge client-mention__badge_label">'+s(t.labelName)+'</span>\n\n    <span data-action="remove-label" role="button" class="client-mention__label-button hint" aria-label="Снять метку">\n        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon--ui__reputation-label-remove"><use xlink:href="#icon--ui__reputation-label-remove"></use></svg>\n    </span>\n':e+='\n    <span data-action="add-label" role="button" class="client-mention__label-button" aria-label="Добавить метку">\n        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon--ui__reputation-label-add"><use xlink:href="#icon--ui__reputation-label-add"></use></svg>\n    </span>\n',e+="\n\n"}(this.mention))}_onLabelClick(t){const{target:e}=t;switch(e.getAttribute("data-action")){case"add-label":this.addLabel();break;case"remove-label":this.removeLabel()}}}var Xh=s(9050);const Qh=s(9755);class Jh extends n.u1{constructor(t){super(t),this._filter="",this._label=null,this._offset=0,this._timestamp=Date.now(),this._keywords=[],this._mentions=[],this._hasMore=!0,this._loading=!1,this._animationStart=Date.now(),this._spinner=null,this._storiesFeed=null}render(){return this.isRendered||(this.$els={empty:this.$(".mentions-feed__empty").hide(),feed:this.$(".mentions-feed__feed"),storiesFeed:this.$(".stories-feed"),spinner:this.$(".mentions-feed__spinner"),downloads:Qh(".mentions-feed__downloads"),getCsvButton:Qh(".mentions-feed__get-csv")},this._spinner=this._renderSpinner(),this._storiesFeed=this._renderStoriesFeed(),this.listenTo(i.vE.ui,"document-scroll",Xh.throttle((()=>this._handleScrolling()),200)),this.$els.downloads.hide(),this.loadMore(),this._createCsvButton()),this}clear(){this._mentions=[],this._offset=0,this._hasMore=!0,this.$els.feed.empty(),this.$els.empty.hide()}setFilter(t){return this._filter=t,this}setLabel(t){return this._label=t,this}async toggleLoading(t){this._loading!==t&&(t?(this._animationStart=Date.now(),this.$els.empty.hide()):await c.cQ.delay(500-(Date.now()-this._animationStart)),this._loading=t,this._spinner.togglePlay(t))}async loadMore(){try{const t=this._lastRequestId=Xh.uniqueId("client-mentions-feed_");await this.toggleLoading(!0);const{mentions:e=[],keywords:s,hasMore:i,timestamp:n}=await Wh.Y.getMentions(this._filter,this._label,this._offset,this._timestamp);if(t!==this._lastRequestId)return void(await this.toggleLoading(!0));await this.toggleLoading(!1),this._offset+=e.length||0,this._hasMore=i,this._keywords=s,this._timestamp=n,this._addMentions(e),this._storiesFeed.initStories(),this._toggleEmpty(),this.emit("mentions-loaded")}catch(t){i.vE.ui.toasts.showError(t)}}_renderSpinner(){return i.vE.ui.player.createAnimation("stories-spinner",{$parent:this.$els.spinner})}_renderStoriesFeed(){const{ReputationStoriesFeed:t}=this.useRegistry();return new t(this.$els.storiesFeed)}_highlightKeywords(t){const e=[".comment__content",".comments__title",".story__header",".story__content",".story__tags"].join(",");an.y.add(t.find(e),this._keywords)}_handleScrolling(){this._hasMore&&!this._loading&&i.vE.ui.elementWillSoonScrolled(this.$els.feed[0])&&this.loadMore()}_toggleEmpty(){const t=this._mentions.length>0;this.$els.downloads.toggle(null!==i.vE.storage.reputationLabelStorage.labelId&&t),this.$els.empty.toggle(!t)}_addMentions(t=[]){const e=Qh(document.createDocumentFragment());for(const s of t){const t=new Kh({mention:s,onMentionMarked:()=>this.emit("mention-marked-as-read")});t.appendTo(e).mount(),this._mentions.push(t)}this._highlightKeywords(e),this.$els.feed.append(e)}_createCsvButton(){this.$els.getCsvButton.off("click").on("click",(()=>{null!==i.vE.storage.reputationLabelStorage.labelId&&0!==this._mentions.length&&Wh.Y.getMentionsCSV(this._filter,this._label,this._timestamp)}))}get loading(){return this._loading}}function tc(t,e,s){return e in t?Object.defineProperty(t,e,{value:s,enumerable:!0,configurable:!0,writable:!0}):t[e]=s,t}const ec=s(9755),sc=["story","comment","comment_reply","feedback"];class ic extends Fs.T3{constructor(...t){super(...t),tc(this,"_hasUnreadMention",!1),tc(this,"_onMentionsLoaded",(()=>{const t=i.ZP.ui.sidebar.reputationMonitoringMenuItem,e=t.getTotalUnreadMentionsCount(),s=t.getMentionsCountsMap();this._hasUnreadMention=this._filter?s[this._filter]>0:e>0,this.$els.readAll.css("display",this._hasUnreadMention?"flex":"none")})),tc(this,"_loadTotalMentionsForSidebar",(()=>{Wh.Y.getSidebarCounters().then((({answers:t,mentions:e})=>{this.$els.sidebarMentions.text(e).toggle(Boolean(e)),this.$els.sidebarAnswers.text(t).toggle(Boolean(t))}))})),tc(this,"_onMentionMarkedAsRead",(()=>{const t=i.ZP.ui.sidebar.reputationMonitoringMenuItem,e=t.getTotalUnreadMentionsCount(),s=t.getMentionsCountsMap();(0===e||s&&0===s[this._filter])&&(this._hasUnreadMention=!1,this.$els.readAll.hide())}))}route(t,e){this.ctx=t;const s=t.params.filter||"",n=String(s).replace(/-/g,"_"),o=this._filter;this._filter=sc.includes(n)?n:"",this._filter!==o&&this._reloadFeed();const{reputationLabelStorage:r}=i.ZP.storage;return this._label=r?r.labelId:null,this.isShown||this.show(),this.$els.sidebarMentions.length&&this.$els.sidebarAnswers.length&&this._loadTotalMentionsForSidebar(),e()}render(){return this.isRendered||(this.$parent=ec(".page-reputation-monitoring"),this.$el=ec('<div class="mentions-feed-page">\n    <div class="mentions-feed">\n        <div class="mentions-feed__container">\n            <div class="mentions-feed__read-all">\n                <div class="button_link-icon">\n                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon--ui__message"><use xlink:href="#icon--ui__message"></use></svg> Отметить всё прочитанным\n                </div>\n            </div>\n            <div class="stories-feed">\n                <div class="stories-feed__container">\n                    <div class="mentions-feed__feed"></div>\n                    <div class="mentions-feed__spinner center"></div>\n                    <section class="mentions-feed__empty" style="display: none">\n                        К сожалению, по вашему запросу ничего нет. Попробуйте изменить параметры поиска\n                    </section>\n                </div>\n            </div>\n        </div>\n    </div>\n</div>\n'),this.$els={readAll:this.$(".mentions-feed__read-all"),sidebarMentions:ec('.bell_profile-menu[data-role="reputation"]'),sidebarAnswers:ec('.bell_profile-menu[data-role="answers"]')},this._feed=this._createFeed().setFilter(this._filter).setLabel(this._label).show(),this.listenTo(this._feed,"mentions-loaded",this._onMentionsLoaded),this.listenTo(this._feed,"mention-marked-as-read",this._onMentionMarkedAsRead),i.ZP.storage.reputationLabelStorage.on("change search-by-label",(t=>{this._label=t,this._reloadFeed()})),this._createReadAllButton()),this}_createFeed(){return new Jh({$el:this.$(".mentions-feed")})}_reloadFeed(){this._feed&&(this._feed.clear(),this._feed.setFilter(this._filter),this._feed.setLabel(this._label),this._feed.loadMore())}_createReadAllButton(){this.$els.readAll.find(".button_link-icon").on("click",(async()=>{this._hasUnreadMention&&(await Wh.Y.markAllAsRead(this._filter),i.ZP.ui.sidebar.reputationMonitoringMenuItem.reduceAllCountByType(this._filter),this._reloadFeed())}))}}var nc=s(5538);const oc=s(9755);class rc extends Fs.T3{render(){return this.isRendered||(this.$el=oc('<div class="reputation-labels-page">\n    <div class="reputation-labels-page__container"></div>\n</div>\n'),this.$parent=oc(".page-reputation-monitoring"),this.$els={container:this.$(".reputation-labels-page__container")},this._labelsList=new nc.Y({$el:this.$el,$parent:this.$els.container}).show()),this}}var ac=s(1916),lc=s(2334);const hc=new I.xs({FIRST_ON:0,LAST_OFF:1,ON:2,OFF:3}),cc=s(6419);class dc{constructor(t=!1){this._listeningTo=void 0,this._events=void 0,t&&this.initHook(),this._listenId=cc.uniqueId("lid")}get hook(){return this._hook}initHook(){return this._hook||(this._hook=new dc),this}static prepare(t,e,s,...i){if(!s)return!0;let n=s instanceof I.Tf;if("object"==typeof s&&!n){if(cc.isArray(s))for(let n of s)t[e].call(t,n,...i);else for(let n in s)s.hasOwnProperty(n)&&t[e].call(t,n,s[n],...i);return!1}if(!n&&lc.X.test(s)){for(let n of s.split(lc.X))t[e].call(t,n,...i);return!1}return!0}_createListenMethod(t,e,s,i){if(!e)throw new Error(`Trying to listenTo event: '${s}' but the target object is undefined`);if(!e._listenId)throw new Error(`Trying to listenTo event: '${s}' but the target object does not have listen id`);if((this._listeningTo||(this._listeningTo={}))[e._listenId]=e,i||"object"!=typeof s||(i=this),"function"!=typeof e[t])throw new Error(`Trying to listenTo event: '${s}' on object: ${e.toString()} but it does not have an \n\t\t\t\t'${t}' method so is unbindable`);return e[t](s,i,this),this}listenTo(t,e,s){return this._createListenMethod("on",t,e,s)}listenToOnce(t,e,s){return this._createListenMethod("once",t,e,s)}stopListening(t,e,s){if(!this._listeningTo)return this;let i=this._listeningTo,n=!e&&!s;return s||"object"!=typeof e||e instanceof I.Tf||(s=this),t&&((i={})[t._listenId]=t),cc.forEach(i,((t,i)=>{t.off(e,s,this),(n||cc.isEmpty(t._events))&&delete this._listeningTo[i]})),this}on(t,e,s){if(!dc.prepare(this,"on",t,e,s)||!e)return this;let i;return this._events||(this._events=new Map),this._events.has(t)?(i=this._events.get(t),this._hook&&this._hook.emit(t,hc.ON,e)):(this._events.set(t,i=[]),this._hook&&(this._hook.emit(t,hc.FIRST_ON),this._hook.emit(t,hc.ON,e))),i.push({callback:e,context:s,ctx:s||this}),this}once(t,e,s){if(!dc.prepare(this,"once",t,e,s)||!e)return this;let i=this,n=function(){i.off(t,n),e.apply(this,arguments)};return n._callback=e,this.on(t,n,s)}off(t,e,s){let i;if(!this._events||!dc.prepare(this,"off",t,e,s))return this;if(!t&&!e&&!s)return this._events.clear(),this._events=void 0,this._hook,this;i=t?[t]:this._events.keys();for(let n of i){let t,i=this._events.get(n);if(i){if(this._events.set(n,t=[]),e||s)for(let n of i)(e&&e!==n.callback&&e!==n.callback._callback||s&&s!==n.context)&&t.push(n);t.length||(this._events.delete(n),this._hook&&this._hook.emit(n,hc.LAST_OFF))}}return this}removeAllListeners(){this.off()}emit(t,...e){return this._events&&dc.prepare(this,"emit",t,...e)?(this._events.has(t)&&this._emit(this._events.get(t),e),this._events.has(lc.b)&&this._emit(this._events.get(lc.b),[t].concat(e)),this):this}_emit(t,e){if(!t)return this;for(let s=0,i=t.length;s<i;s++){let i=t[s];i.callback.apply(i.ctx,e)}return this}emitResult(t,...e){let s;if(this._events&&this._events.has(t)){s=this._events.get(t);for(let t=s.length;t--;){let i=s[t],n=i.callback.apply(i.ctx,e);if(void 0!==n)return n}}}listeners(t){return this._events&&this._events.get(t)||[]}}dc.prototype.removeEventListener=dc.prototype.removeListener=dc.prototype.off,dc.prototype.addEventListener=dc.prototype.addListener=dc.on,dc.prototype.emitEvent=dc.prototype.trigger=dc.prototype.emit;var uc=s(9050);class pc extends dc{constructor(...t){super(...t),function(t,e,s){e in t?Object.defineProperty(t,e,{value:s,enumerable:!0,configurable:!0,writable:!0}):t[e]=s}(this,"_label",null)}setLabel(t){return uc.isEqual(t,this._label)||(this._label=t,this.emit("change",null==t?void 0:t.id)),this}search(){this.emit("search-by-label",this.labelId)}get labelId(){return this._label?this._label.id:null}}function mc(t,e,s){return e in t?Object.defineProperty(t,e,{value:s,enumerable:!0,configurable:!0,writable:!0}):t[e]=s,t}const _c=s(9755);class gc extends Fs.GR{constructor(t){super(t),this.use({[gc._reputationRoute]:this,[`${gc._reputationRoute}/:filter(story|comment|comment-reply|feedback)?`]:ic,[gc._reputationLabelsRoute]:rc})}render(){return this.isRendered||(this.$el=_c(".page-reputation-monitoring"),this.$els={spinner:this.$('[data-role="spinner"]').hide(),readAll:this.$(".mentions-feed__read-all"),downloads:_c(".mentions-feed__downloads"),search:_c("#page-reputation-monitoring__search")},this._createSearchInput(),this.listenTo(this._router,"match",(t=>{this.$els.readAll.hide(),this._toggleCsvDownloadsButton(t)})),super.render()),this}_toggleCsvDownloadsButton(t){this.$els.downloads.toggle(null!==i.ZP.storage.reputationLabelStorage.labelId&&t!==gc._reputationLabelsRoute)}_createSearchInput(){const{UIInput:t,UIDropDownReputationLabels:e}=this.useRegistry();this._searchInput=new t({$el:this.$els.search,addClearButton:!0}),this._searchInput.suggestion=new e,i.ZP.storage.reputationLabelStorage=new pc,this._searchInput.$("button").on("click",(()=>{i.ZP.storage.reputationLabelStorage.search()})),this.listenTo(this._searchInput,"change",(t=>{""===t&&i.ZP.storage.reputationLabelStorage.setLabel(null)})),this.listenTo(this._searchInput,ac.nT.SELECT,(t=>{if(!t)return;const{id:e,name:s,count:n}=t.data;i.ZP.storage.reputationLabelStorage.setLabel({id:e,name:s,count:n}),this._searchInput.value=s}))}}mc(gc,"_reputationRoute","/reputation"),mc(gc,"_reputationLabelsRoute",`${gc._reputationRoute}/labels`);class vc extends Jt.u{constructor(){super();const t=document.querySelector(".page-reputation-monitoring__menu > .menu");if(!t)throw new Error;this.els={menu:t},this.scrollToActiveElement(),this.initMouseDragScroll()}scrollToActiveElement(){const{menu:t}=this.els,e=t.querySelector(".menu__item_current");if(!e)return;const s=t.clientWidth,i=e.offsetLeft+e.offsetWidth;i>s&&(t.scrollLeft=i-s)}initMouseDragScroll(){const t=this.els.menu;let e,s,i=!1;const n=()=>{i=!1,t.classList.remove("scrolling")};t.addEventListener("pointerdown",(n=>{t.scrollWidth!==t.clientWidth&&(i=!0,e=n.pageX-t.offsetLeft,s=t.scrollLeft)})),t.addEventListener("pointerleave",n),t.addEventListener("pointercancel",n),t.addEventListener("pointerup",n),t.addEventListener("pointermove",(n=>{if(!i)return;const o=n.pageX-t.offsetLeft-e;!t.hasPointerCapture(n.pointerId)&&Math.abs(o)>=4&&(t.setPointerCapture(n.pointerId),t.classList.add("scrolling")),t.scrollLeft=s-o})),t.addEventListener("dragstart",(t=>{i&&(t.preventDefault(),t.stopPropagation())}))}}var fc=s(5198);const yc=s(9755);class bc extends Fs.T3{render(){if(this.isRendered)return this;const{UIForm:t}=this.useRegistry();return this.$el=yc(".page-profile"),this.$els={container:this.$(".reputation-feedback-form"),form:this.$(".reputation-feedback-form__form"),error:this.$(".reputation-feedback-form__error")},this._form=new t(this.$els.form),this._form.on("submit",this._onSubmit.bind(this)),this._hintStyle={direction:k.Lh.LEFT,alignment:k.SE.CENTER},this._name=this._prepareNameInput(),this._message=this._prepareMessageInput(),this._phone=this._preparePhoneInput(),this._email=this._prepareEmailInput(),[this._name,this._message,this._phone,this._email].forEach((t=>{this._form.add(t),this.listenTo(t,"enter",(t=>t.preventDefault()))})),this}getClientID(){return parseInt(this.$els.container.data("client-id"),10)}_getInputElement(t){return this.$(`[name="${t}"]`).closest(".input")}_prepareNameInput(){const{UIInput:t}=this.useRegistry();return new t({$el:this._getInputElement("name"),sanitizerRules:[mt.o.whitelist("A-Za-zА-Яа-яЁё "),mt.o.singleSpace()],autocorrect:!0,validationRules:{"validation-rules.required":Rt.c.required()},validationHint:this._hintStyle})}_prepareEmailInput(){const{UIInput:t}=this.useRegistry();return new t({$el:this._getInputElement("email"),autocorrect:!0,sanitizerRules:[mt.o.trim()],validationRules:{"validation-rules.email":Rt.c.email()},validationHint:this._hintStyle})}_preparePhoneInput(){const{UIInput:t}=this.useRegistry();return new t({$el:this._getInputElement("phone"),autocorrect:!0,sanitizerRules:[mt.o.whitelist("0-9\\+\\-\\(\\)"),mt.o.singleSpace()]})}_prepareMessageInput(){const{UITextArea:t}=this.useRegistry();return new t({$el:this._getInputElement("message"),sanitizerRules:[mt.o.trim()],validationRules:{"validation-rules.required":Rt.c.required()},validationHint:this._hintStyle})}async _checkSecondaryFieldsValidity(){const t=i.vE.i18n("page-reputation-feedback.secondary-inputs-empty");if(!Boolean(this._email.value||this._phone.value))return[this._email,this._phone].forEach((t=>t.removeState(fc.d.SUCCESS).addState(fc.d.ERROR))),this.$els.error.text(t).show(),!1;this.$els.error.empty().hide();return(await Promise.all([this._email.checkValidity(),this._phone.checkValidity()])).every((t=>!0===t))}async _onSubmit(t){t.preventDefault();const e=await this._name.checkValidity(),s=await this._message.checkValidity();if(e&&s&&await this._checkSecondaryFieldsValidity())try{await Wh.Y.saveFeedback(this._form.serialize()),this._form.reset(),this.$el.hide().after('<section class="reputation-feedback-success">\n    <h1 class="reputation-feedback-success__title">Ваше сообщение отправлено!</h1>\n\n    <p class="reputation-feedback-success__text">Спасибо, что воспользовались формой обращения в поддержку. Мы надеемся, что представители компании оперативно свяжутся с вами для решения вопроса.</p>\n\n    <a href="/" class="button button_success reputation-feedback-success__button">НА ГЛАВНУЮ</a>\n</section>'),d.c.getInstance().sendEvent("send_company_feedback",{partner_id:this.getClientID()}),setTimeout((()=>{window.location.href="/"}),5e3)}catch(n){i.vE.logger.error("reputation","error submitting form",n),i.vE.ui.toasts.showError(n.message)}}}const wc="community-progress__helper-1",Ec="community-progress__helper-2",Sc="community-progress__close",Cc="community-progress__progress",Tc="community-progress__checkbox",Oc="community-progress_done",kc="community-progress__close_hidden",Ic="community-progress__checkbox_done";class $c{constructor(t){!function(t,e,s){e in t?Object.defineProperty(t,e,{value:s,enumerable:!0,configurable:!0,writable:!0}):t[e]=s}(this,"itemsCount",7),this.container=t,this.progress=this.container.querySelector("."+Cc);const e=this.container.querySelector("."+wc);this.main={wrapper:e,inner:e.firstElementChild,btnClose:e.querySelector("."+Sc)};const s=this.container.querySelector("."+Ec);this.success={wrapper:s,inner:s.firstElementChild,btnClose:s.querySelector("."+Sc)},this.done=this.container.classList.contains(Oc),this.updateAnimation(),this.main.btnClose.addEventListener("click",this.onBtnCloseClick.bind(this)),this.success.btnClose.addEventListener("click",this.onBtnCloseClick.bind(this))}setCommunityId(t){return this.communityId=t,this}async updateState(t){if(this.done)return;this.done=t.is_done,delete t.is_done;const e=this.main.inner.querySelectorAll("."+Tc);if(e.length!==this.itemsCount)return;const s={has_avatar:e[0],has_description:e[1],has_rules:e[2],has_1_story:e[3],has_2_stories:e[4],has_author:e[5],has_10_comments:e[6]};if(this.done){for(const t of Array.from(e))t.classList.add(Ic);this.updateProgress(this.itemsCount),await c.cQ.delay(300),this.showBtnClose(),this.updateAnimation()}else{let e=0;Object.entries(t).forEach((([t,i])=>{var n;i&&(null===(n=s[t])||void 0===n||n.classList.add(Ic),e++)})),this.updateProgress(e),e===this.itemsCount&&await c.cQ.delay(300);t.has_avatar&&t.has_description&&t.has_1_story&&this.showBtnClose(),e===this.itemsCount&&this.updateAnimation()}}updateProgress(t){this.progress.firstElementChild.textContent=`${t} из ${this.itemsCount}`,this.progress.style.setProperty("--val",String(t))}updateAnimation(){this.done?(this.main.wrapper.style.height="0px",this.success.wrapper.style.height=`${this.success.inner.offsetHeight}px`):(this.main.wrapper.style.height=`${this.main.inner.offsetHeight}px`,this.success.wrapper.style.height="0px"),this.container.classList.toggle(Oc,this.done)}showBtnClose(){this.main.btnClose.classList.remove(kc),this.success.btnClose.classList.remove(kc)}onBtnCloseClick({currentTarget:t}){t instanceof HTMLElement&&!t.classList.contains(kc)&&(this.hide(),S.cf.post("/ajax.php?route=community-actions/hide-progress",{community_id:this.communityId}))}hide(){this.main.wrapper.style.height="0px",this.success.wrapper.style.height="0px",this.container.style.marginTop="0px"}}const Ac=s(9755);s(6419);class xc extends Fs.T3{render(){return super.render(),this.$el=Ac(".page-community-editor"),this._options.communityId=Number(this.$el.data("community-id"))||0,this._options.isLocked=1===Number(this.$el.data("locked")),this.initFillingProgress(),this}initFillingProgress(){const t=document.querySelector(".community-progress");t&&(this.communityProgress=new $c(t).setCommunityId(this.communityId))}get communityId(){return this._options.communityId}get community(){let t=this._options.community;return t||(t=this._options.community=new me.S1(this.communityId)),t}get isLocked(){return this._options.isLocked}}s(6419);const Dc=s(6419),Pc=[-200,-100,-50,0,25,100,250,500,1e3,2500,5e3,1e4,1e5];const Rc=s(381),Mc=s(6419);const Nc=s(9755);const Bc=s(381),Lc=s(6419);const Fc=s(6419);var Uc=s(6179),jc=s(9626);class Vc extends n.u1{constructor(t){super(t),function(t,e,s){e in t?Object.defineProperty(t,e,{value:s,enumerable:!0,configurable:!0,writable:!0}):t[e]=s}(this,"_close",(()=>{this._clientProps.set(this._getClientPropKey(),!0),this.destroy()})),this._clientProps=new cs.U,this.render()}render(){return this.isRendered||(super.render(),this.$els={closeButton:this.$(".info-banner__close-button").on("click",this._close),actionButton:this.$(".info-banner__action-button").on("click",this._close)}),this}_getClientPropKey(){return{[jc.DV.HOT]:Uc.m.HOT,[jc.DV.BEST]:Uc.m.BEST,[jc.DV.NEW]:Uc.m.NEW}[this._options.feedType]}}const Hc=s(9755);class qc extends Fs.T3{route(t,e){this._isSubsMode="/subs"===t.path||"subs"===t.params.subs,this._currentMode=this._getModeFromPath(t.path),this._isRecommendMode=this._currentMode===ys.DV.RECOMMEND,this._customFeed=t.params.feedName;const s=this.$els.announcement&&this.$els.announcement.length,n=c.mM.get("pkb_thematic-poll");if(this._customFeed){if(d.c.getInstance().yandex.goal("theme_feed_opening",{theme_feed_opening_url:i.vE.history.pathname}),i.vE.ui.screen=lt.d.THEME_FEED,s&&!n){const t=this.$els.feedPanel.find(".menu__item_current"),e=t.data("int"),s=t.data("dis");this.$els.interview.attr("href",e).toggleClass("announcement__button_hide",!e),this.$els.discussion.attr("href",s).toggleClass("announcement__button_hide",!s),this.$els.announcement.toggleClass("announcement_show",Boolean(e||s))}}else this._customFeed&&!n||!s||this.$els.announcement.removeClass("announcement_show");let o=lt.d[this._currentMode.toString()];return o||(this._currentMode===ys.DV.COMMUNITIES?o=lt.d.COMMUNITIES_FEED:this._currentMode===ys.DV.MOST_SAVED?o=lt.d.SAVED:this._isSubsMode&&(o=lt.d.MY_LENT)),i.vE.ui.screen=o,this.isRendered?(this._feed.viewObserver.forceSaveWhenGoing(),this._isRecommendMode||(this._filter.isSubsMode=this._isSubsMode,this._filter.customFeed=this._customFeed,this._filter.isDisableCalendar=Boolean(this._customFeed),this._filter.feedName=this._currentMode.valueOf()),r.Zv.reloadScripts()):this.show(),"thematic-feed"===t.pageName&&d.c.getInstance().yandex.goal("theme_feed_opening",{theme_feed_opening_url:t.path}),r.Zv.removeOldAds(),e()}destroy(){this.isDestroyed||(this._feed.destroy(),this._calendar.destroy(),super.destroy())}render(){return this.isRendered||(this.$el=Hc(".stories-feed"),this.$els={feedPanel:Hc(".feed-panel").on("click",".menu__item_route",this._onClickMenuRouting.bind(this)),feedPanelContainer:Hc(".feed-panel__container"),headerMenuItems:Hc(['.header-menu__item > a[href="/"]','.header-menu__item > a[href="/best"]','.header-menu__item > a[href="/new"]','.header-menu__item > a[href="/rec"]'].join(",")),feedNotify:Hc(".feed-notify")},this.$els.announcement=Hc(".thematic-poll"),this.$els.announcement.length&&(this.$els.interview=this.$els.announcement.find(".thematic-poll__interview"),this.$els.discussion=this.$els.announcement.find(".thematic-poll__discussion")),this._initFeed(),this._initFeedFilterPanel(),this.$els.feedNotify.length&&new Vc({$el:this.$els.feedNotify,feedType:this._currentMode}),this._initEvaluations(),super.render()),this}_initFeed(){(()=>{this.$el.attr("data-pagination-mode");const t={$el:this.$el,feedName:this._currentMode.valueOf(),customFeed:this._customFeed,focused:!0,isSubsMode:"subs"===this.$el.data("subs-sort")};this._feed=new ys._D(t),this.listenTo(this._feed,"loaded",(({title:t})=>{t&&(document.title=t)}))})()}_initFeedFilterPanel(){this._isRecommendMode||(this._filter=new ys.pd({$el:this.$els.feedPanel,feed:this._feed,feedName:this._currentMode.valueOf(),customFeed:this._customFeed,isDisableCalendar:Boolean(this._customFeed),isSubsMode:this._isSubsMode,inlineFiltersMode:!0}))}_getModeFromPath(t){switch(!0){case 0===t.indexOf("/best"):return ys.DV.BEST;case 0===t.indexOf("/new"):return ys.DV.NEW;case 0===t.indexOf("/rec"):return ys.DV.RECOMMEND;case 0===t.indexOf("/subs"):return ys.DV.SUBS;case 0===t.indexOf("/visited-stories"):return ys.DV.VISITED;case 0===t.indexOf("/companies"):return ys.DV.COMPANIES;default:return ys.DV.HOT}}_onClickMenuRouting(t){const e=t.target.getAttribute("href")||t.target.getAttribute("data-route");i.vE.history.location.pathname===e&&(t.preventDefault(),t.stopPropagation(),this._feed.clear().loadStories(!1))}_initEvaluations(){this._currentMode===ys.DV.HOT&&Ii.L5.getInstance().init(this._feed),this._currentMode!==ys.DV.HOT&&this._currentMode!==ys.DV.BEST&&this._currentMode!==ys.DV.NEW||Ii.JX.getInstance().init(),this._currentMode===ys.DV.SUBS&&Ii.SR.getInstance().init("subs_feed_visit")}}const Wc=s(9755);class Gc extends Fs.T3{render(){return this.isRendered||(this.$el=Wc(".stories-feed"),this._feed=new ys._D({$el:this.$el,feedName:"thematic",focused:!0}),i.vE.ui.screen=lt.d.THEME_FEED,d.c.getInstance().yandex.goal("theme_feed_opening",{theme_feed_opening_url:i.vE.location.pathname}),super.render()),this}}var Yc=s(3821),zc=s(2584),Zc=s(5448),Kc=s(8588);class Xc extends Kc.X{constructor(...t){super(...t),function(t,e,s){e in t?Object.defineProperty(t,e,{value:s,enumerable:!0,configurable:!0,writable:!0}):t[e]=s}(this,"fieldId","id")}render(){if(this.el)return this.el;super.render();const t=this.els.label=document.createElement("div");t.classList.add("dropdown-item__label"),t.textContent=this.data.name,this.el.setAttribute("data-type","reputation-label");const e=this.els.count=document.createElement("div");return e.classList.add("dropdown-item__info"),e.textContent=this.data.count,this.el.appendChild(t),this.el.appendChild(e),this.el}}function Qc(t,e){var s=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),s.push.apply(s,i)}return s}function Jc(t,e,s){return e in t?Object.defineProperty(t,e,{value:s,enumerable:!0,configurable:!0,writable:!0}):t[e]=s,t}class td extends Zc.V{constructor(t){super(function(t){for(var e=1;e<arguments.length;e++){var s=null!=arguments[e]?arguments[e]:{};e%2?Qc(Object(s),!0).forEach((function(e){Jc(t,e,s[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(s)):Qc(Object(s)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(s,e))}))}return t}({highlightResult:!0,useNumericIds:!0},t)),this.items.DataObject=Xc}async _requestItems(t,e){const s=await Wh.b.get(),i=t.trim().toLocaleLowerCase();return s.filter((t=>-1!==t.name.toLocaleLowerCase().indexOf(i)))}}var ed=s(3674);function sd(t){var e,s="";Array.prototype.join;return s+='<form method="POST" action="javascript:void 0;">\n\t<div class="comment-reply__wrapper">\n\t\t<div class="input input_editor input_comment-reply">\n\t\t\t<div class="input__input" data-name="desc" contenteditable="true" data-placeholder="'+(null==(e=t.isMain?"Введите текст комментария":"Введите текст ответа")?"":e)+'"><p><br></p></div>\n\t\t</div>\n\t\t<div class="comment-reply__thumbs"></div>\n\t\t',null!==t.slowModeText&&(s+='\n\t\t\t<div class="comment-reply__slow-mode-text">\n\t\t\t\t'+(null==(e=t.slowModeText)?"":e)+"\n\t\t\t</div>\n\t\t"),s+="\n        ",null!==t.canUserCommentMessage&&(s+='\n            <div class="comment-reply__slow-mode-text">\n                '+(null==(e=t.canUserCommentMessage)?"":e)+"\n            </div>\n        "),s+='\n\t</div>\n\t<div class="comment-reply__feedback-offer"></div>\n\t<ul class="comment-reply__controls">\n\t\t',t.noteHidden&&(s+='\n\t\t<li class="comment-reply__note">'+(null==(e=t.noteHidden)?"":e)+"</li>\n\t\t"),s+="\n\n\t\t<li>\n\t\t\t",t.menu?s+='\n\t\t\t\t<span class="button-group button-group_success">\n\t\t\t\t\t<button type="submit">Отправить</button><button data-action="menu" type="button" class="button_dot"></button>\n\t\t\t\t</span>\n\t\t\t':s+='\n\t\t\t\t<button type="submit" class="button_small">Отправить</button>\n\t\t\t',s+="\n\t\t</li>\n\t\t",t.accessImage&&(s+='\n\t\t<li>\n\t\t\t<div class="comment-reply__attach-files attach">\n\t\t\t\t<svg xmlns="http://www.w3.org/2000/svg" class="icon icon--ui__photo icon--ui__photo_comment-reply"><use xlink:href="#icon--ui__photo"></use></svg>\n\t\t\t\t<input type="file" name="files0" accept="image/*" multiple>\n\t\t\t</div>\n\t\t</li>\n\t\t'),s+="\n\t\t",t.showIsOfficialCheckbox&&(s+='\n\t\t\t<li><label><input type="checkbox" data-to-boolean="true" name="is_official"'+(null==(e=t.isOfficial?' checked="checked"':"")?"":e)+' class="checkbox checkbox_switch">Официальный ответ</label></li>\n\t\t'),s+='\n\t\t<li class="comment-reply__draft-date"></li>\n\t\t<li class="comment-reply__error"></li>\n\t</ul>\n\t',(t.moderation.is||t.hasLinkedUsers)&&(s+='\n\t\t<div class="comment-reply__checkbox-by-moderator" data-changeable="'+(null==(e=t.moderation.changeable?"true":"false")?"":e)+'" data-active="'+(null==(e=t.moderation.autoSelect?"true":"false")?"":e)+'">\n\t\t\t',t.moderation.is&&(s+='\n\t\t\t\t<label><input type="checkbox" data-to-boolean="true" name="by_moderator"'+(null==(e=t.moderation.autoSelect?' checked="checked"':"")?"":e)+(null==(e=t.moderation.changeable?"":" disabled")?"":e)+' class="checkbox checkbox_switch"><span class="user user_inline"><span class="user__nick">moderator</span></span></label>\n\t\t\t'),s+='\n\t\t\t<span class="comment-reply__by-user-caption">От аккаунта:</span> <span class="comment-reply__user-name">'+(null==(e=t.userName)?"":e)+"</span>\n\t\t</div>\n\t"),s+="\n</form>\n"}var id=s(9019),nd=s(8437),od=s(3310),rd=s(8334);function ad(t){return t.charAt(0)+t.charAt(1).toUpperCase()+t.slice(2)}class ld extends nd.c{render(){if(this.isRendered)return this;this.renderForm(sd),this.initIntersectionOberver();const t=this.$(".comment-reply__attach-files > input");t&&t.length&&(t.on("click",(t=>t.stopPropagation())),t.on("change",(()=>{const e=Array.from(t.get(0).files||[]);this.thumbs.add(e),t.val("")}))),this.editor=new sa.Y({$el:this.$(".input"),submitHotkey:"cmd+enter",suggestion:new ed.x,canAddAnchor:!1}),this.listenToOnce(this.editor,"focus",(()=>{this.editor.suggestion instanceof ed.x&&this.editor.suggestion.setPredefinedUsersInStory(this.storyId,id.D.COMMENT)})),this.listenTo(this.editor,"paste",(()=>this.onEditorEvent("paste"))),this.listenTo(this.editor,"input",(()=>this.onEditorEvent("input")));const e=this.$('button[type="submit"]');e&&e.length&&(this.submitButton=new st.y3({$el:e,theme:this.comment.isModeratorAutoSelect?od.j.DARK:od.j.SUCCESS,animationName:"comment-send",animationIndent:3}));const s=this.$('button[data-action="menu"]');if(s&&s.length){const t=new st.y3(s);this.submitMenu.target=s,this.listenTo(t,"click",(()=>this.submitMenu.toggle())),this.comment.isRoot&&this.isComstoryHintEnabled&&(this.comstoryHint.target=s,this.listenToOnce(t,"click",(()=>this.comstoryHint.hide())))}const n=this.$(".comment-reply__thumbs");n&&n.length&&this.thumbs.appendTo(n).show(),this.listenTo(i.vE.ui,"paste-image",((t,e)=>{this.editor.focused&&(e.preventDefault(),e.stopPropagation(),this.thumbs.add(t))})),this.comment.isRoot||this.listenTo(this.editor,"escape",(()=>{this.comment.id&&(this.comment.replyEditor.isReplyShown=!1)})),this.form=new a.x(this.$("form")),this.listenTo(this.form,"submit",(t=>{t.preventDefault(),this.onSubmit()}));const o=this.$(".comment-reply__user-name");return i.vE.isUserModerator&&o&&o.length&&this.listenTo(this.form,"change",(()=>{this.byModerator=this.form.serialize().by_moderator,o.text(this.byModerator?"moderator":i.vE.initParams.userName)})),this.replyMode!==f.tT.CREATE||this.hasCommentLimitBeenReached||this.loadDraft(),this.listenTo(this,"lockEditing",(()=>{this.replyMode===f.tT.EDIT&&(this.isShown&&i.vE.ui.toasts.showError("comments.errors.lock-editing"),this.submitButton.disabled=!0)})),this.listenTo(i.vE.ui,"dnd",this.onDragAndDrop.bind(this)),super.render(),this}paste(t){this.editor.focus(),this.editor.paste(t)}focus(){this.editor.focus()}initIntersectionOberver(){if(!this.el)return;new IntersectionObserver((t=>{t.forEach((t=>{i.vE.ui.emit("disable-story-image-dnd",t.isIntersecting)}))}),{threshold:0}).observe(this.el)}onDragAndDrop(t){this.$el&&this.$el.toggleClass("comment-reply_drag",t),t?this.$el&&this.$el.on({"dragenter dragleave":t=>{this.$el&&this.$el.toggleClass("comment-reply_drop","dragenter"===t.type)},drop:t=>{var e,s;if(t.stopPropagation(),t.preventDefault(),this.$el&&this.$el.toggleClass("comment-reply_drop",!1),null===(e=t.originalEvent)||void 0===e||!e.dataTransfer||null===(s=t.originalEvent)||void 0===s||!s.dataTransfer.files)return;const i=t.originalEvent.dataTransfer.files,n=[];for(let o=0;o<i.length;o++)-1!==i[o].type.indexOf("image")&&n.push(i[o]);n.length&&this.thumbs.add(n)}}):this.$el&&this.$el.off("dragenter dragleave drop")}autoCorrectModerationText(){const t=this.editor.value;rd.Y2.test(t)&&(this.editor.saveCaretPosition(!0),this.editor.$els.input.html(t.replace(rd.Y2,ad)),this.editor.restoreCaretPosition())}get isLoading(){return this.submitButton.animation||this.submitButton.progress}set isLoading(t){this.submitButton.animation=t}get formSerialize(){return this.form.serialize()}get editorTextContent(){return this.editor.textContent}get editorValue(){return this.editor.value}set editorValue(t){this.editor.value=t,null!=t&&t.length&&this.editor.els.input.classList.remove("medium-editor-placeholder")}get isEditorEmpty(){return this.editor.isEmpty}get byModerator(){return this._byModerator}set byModerator(t){this._byModerator!==(t=Boolean(t))&&(this._byModerator=t,t?this.$usersHiddenMessage.slideUp(300):this.$usersHiddenMessage.slideDown(300),t?this.listenTo(this.editor,"input",this.autoCorrectModerationText):this.stopListening(this.editor,"input",this.autoCorrectModerationText),this.submitButton.theme=t?od.j.DARK:od.j.SUCCESS)}}var hd=s(9624);Ze.S.getInstance().fill({storyStyle:ya.lO,Story:ya.s6,ModeratorTools:Da.$,UIIgnoreRulePopup:Yc.M,UIDropDownReputationLabels:td,Sanitizers:T.op,UIInput:T.u3,UITextArea:fs.G,UIForm:a.x,UIDropDownProfessions:zc.J,PopupMaster:pt.g,ReputationStoriesFeed:ys.$m,UISubscribeButton:st.C0,UICommentReply:ld,UICarousel:hd.y,UICommentsExtension:class{constructor(t){this.ui=t}get currentCommentId(){return this._currentCommentId}set currentCommentId(t){this._currentCommentId!==t&&(this._currentCommentId=t,i.vE.logger.log("comments-extension","set current comment",t))}render(){this.initHotkeys(),this.attachDetectFocusIn(),this.attachMouseEnterComment()}initHotkeys(){i.vE.ui.hotkeys.on(["w","add"],(()=>{if(!this.currentCommentId||!this.focused)return;const t=this.ui.comments.get(this.currentCommentId);t&&i.vE.ui.elementInViewport(t.$el)&&this.ui.vote(t,f.OC.UP)}),{type:it.FM.KEYDOWN,repeat:!1}),i.vE.ui.hotkeys.on(["s","subtract"],(()=>{if(!this.currentCommentId||!this.focused)return;const t=this.ui.comments.get(this.currentCommentId);t&&i.vE.ui.elementInViewport(t.$el)&&this.ui.vote(t,f.OC.DOWN)}),{type:it.FM.KEYDOWN})}attachDetectFocusIn(){var t;return null===(t=this.ui.$el)||void 0===t||t.on("mouseenter",js.default.throttle((()=>{this.focused=!0,i.vE.logger.log("comments-extension","focus in",this.ui.eid)}),50)),this}attachMouseEnterComment(){var t;return null===(t=this.ui.$el)||void 0===t||t.on("mouseenter",".comment__body",js.default.debounce((t=>{this.currentCommentId=this.ui.getCommentIdByElement(t.target)}),50)),this}get focused(){return i.vE.storage.focused===this.ui.eid}set focused(t){this.focused!==(t=Boolean(t))&&(i.vE.storage.focused=t?this.ui.eid:void 0)}}});const cd=s(9755);class dd extends Fs.T3{route(t,e){return this.ctx=t,this._searchMode=Ts.VISITED,this.isRendered||this.show(),e()}render(){return this.isRendered||(i.vE.ui.screen=lt.d.VISITED,this._feed=new ys._D({$el:cd(".stories-feed"),feedName:"visited",focused:!0}),this._search=new Ns({feed:this._feed,searchMode:Ts.VISITED}),super.render()),this}}const ud="company-blogs-info__companies-container",pd="company-blogs-info_expanded",md="company-blogs-info__toggle",_d="company-blogs-info__company",gd="company-blogs-info__subscribe";class vd extends Jt.u{constructor(t){if(!t.el)throw Error();if(super(t),this.els={toggle:t.el.querySelector("."+md),companiesContainer:document.querySelector("."+ud),subscribeBtn:document.querySelector("."+gd)},!this.els.toggle||!this.els.companiesContainer)throw Error();this.attachToggleHandler(),this.attachCompanyClickHandler(),this.initSubscribeButton()}attachToggleHandler(){const t=this.el;this.els.toggle.addEventListener("click",(()=>{if(t.classList.contains(pd))t.classList.remove(pd),this.els.companiesContainer.style.height="0";else{t.classList.add(pd);const e=this.els.companiesContainer.firstElementChild,s=window.getComputedStyle(e),i=parseInt(s.marginTop,10)+parseInt(s.marginBottom,10)+e.offsetHeight;this.els.companiesContainer.style.height=`${i}px`,oe.cp.getInstance().sendEvent("click",{type:"companies"},[oe.b0.CLICKHOUSE])}}))}attachCompanyClickHandler(){const t=t=>{if(!(t.target instanceof HTMLElement))return;const e=t.target.closest("."+_d);e&&oe.cp.getInstance().sendEvent("transition_to_author",{type:"company",author_id:e.dataset.id},[oe.b0.CLICKHOUSE])};this.els.companiesContainer.addEventListener("click",t),this.els.companiesContainer.addEventListener("auxclick",(e=>{1===e.button&&t(e)}))}}class fd extends vd{initSubscribeButton(){new st.C0(this.els.subscribeBtn)}}s(8559);var yd=s(381),bd=s.n(yd);const wd=new I.xs({DATE:"date",VIEWS:"views",UNIQUE_VIEWS:"unique_views",READS:"reads",READS_CTR:"reads_ctr",CLICKS:"clicks",CLICKS_CTR:"clicks_ctr"});function Ed(t,e){var s=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),s.push.apply(s,i)}return s}function Sd(t){for(var e=1;e<arguments.length;e++){var s=null!=arguments[e]?arguments[e]:{};e%2?Ed(Object(s),!0).forEach((function(e){Cd(t,e,s[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(s)):Ed(Object(s)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(s,e))}))}return t}function Cd(t,e,s){return e in t?Object.defineProperty(t,e,{value:s,enumerable:!0,configurable:!0,writable:!0}):t[e]=s,t}class Td extends Jt.u{show(){return this.popup.show(),this}hide(){return this.popup.hide(),this}get calendar(){return this.calendarInstance||(this.calendarInstance=new Es.E(Sd({width:Math.min(550,window.innerWidth)},this._options.calendarOptions))),this.calendarInstance}get popup(){var t;this.popupInstance||(this.popupInstance=new k._(Sd({target:this._options.target,content:this.calendar.show().$el,wrapperExtraClass:"popup_company-blog-select-date"},this._options.popupOptions)),this.popupInstance.addButtonIntoFooter(null!==(t=this._options.submitButtonTitle)&&void 0!==t?t:"Выбрать",this.onSubmitClick.bind(this),Bs.j.SUCCESS),this.listenTo(this.popup,n.eM.UNMOUNTED,(()=>{this.emit("close")})));return this.popupInstance}onSubmitClick(){const t=this.calendar.selectedDates;this.emit("submit",t)}}const Od="YYYY-MM-DD",kd="company-blog-search-panel__type-group",Id="company-blog-search-panel__type",$d="company-blog-search-panel__sort-group",Ad="company-blog-search-panel__dates-group",xd="company-blog-search-panel__dates",Dd="company-blog-search-panel__item_button",Pd="company-blog-search-panel__item_selected";class Rd extends Jt.u{constructor(t){super({}),function(t,e,s){e in t?Object.defineProperty(t,e,{value:s,enumerable:!0,configurable:!0,writable:!0}):t[e]=s}(this,"searchData",{}),this.el=t,this.els={typeGroup:t.querySelector(`.${kd}`),type:t.querySelector(`.${Id}`),textInput:t.querySelector('.input[data-role="search"]'),sortButton:t.querySelector(`.${$d} .link`),sortButtonCaption:t.querySelector(`.${$d} .link > span`),datesGroup:t.querySelector(`.${Ad}`),dates:t.querySelector(`.${xd}`),dateRangeButton:t.querySelector(`.${Dd}[data-value="range"]`)}}render(){var t;if(this.isRendered||!this.el)return this;this.searchData=null!==(t=i.ZP.config("modules.searchData"))&&void 0!==t?t:{};const e=new a.x(this.el.querySelector("form"));return this.listenTo(e,"submit",this.search.bind(this,!0)),this.prepareTextInput(),this.prepareDatesControl(),this.prepareSortControl(),this.prepareTypeControl(),super.render(),this}prepareTextInput(){this.input=new T.u3({el:this.els.textInput,sanitizerRules:[mt.o.trim()]}),this.listenTo(this.input,"change",(t=>{this.searchData.text=t}))}prepareSortControl(){this.sortPopup=pt.g.popupEnum(this.els.sortButton,wd,"page-company-blog.sort-mode",this.searchData.order),this.els.sortButton.addEventListener("click",(()=>{this.sortPopup.toggle()})),this.listenTo(this.sortPopup,"change",((t,e)=>{e&&(this.els.sortButtonCaption.textContent=i.ZP.i18n("page-company-blog.sort-mode."+e.toString()),this.searchData.order=e.value,this.sortPopup.isShown&&(this.sortPopup.hide(),this.search()))}))}prepareDatesControl(){const t=this.els.dates;if(!t)return;const e=new Td({target:this.els.dateRangeButton,submitButtonTitle:i.ZP.i18n("modal.apply"),popupOptions:{direction:k.Lh.BOTTOM,indent:!1},calendarOptions:{datesRangeMode:!0,showButtonsPanel:!1}});e.render(),this.listenTo(e,"submit",(t=>{this.searchData.date_from=t.startDate,this.searchData.date_to=t.endDate,this.search()})),t.querySelectorAll(`.${Dd}`).forEach((s=>{s.addEventListener("click",(()=>{const i=s.dataset.value;if(t.querySelectorAll(`.${Pd}`).forEach((t=>{t.classList.remove(Pd)})),s.classList.add(Pd),"range"===i){var n;e.calendar.setDate(this.searchData.date_from,null!==(n=this.searchData.date_to)&&void 0!==n?n:bd()().format(Od)),e.show()}else{let t;"week"!==i&&"month"!==i||(t=bd()().subtract(1,i).format(Od)),this.searchData.date_from=t,this.searchData.date_to=void 0,this.search()}}))}))}prepareTypeControl(){const t=this.els.type;if(!t)return;this.els.type.querySelectorAll(`.${Dd}`).forEach((e=>{e.addEventListener("click",(e=>{var s,i;const n=null===(s=e.target)||void 0===s||null===(i=s.dataset)||void 0===i?void 0:i.value;n&&((e=>{t.querySelectorAll(`.${Dd}`).forEach((t=>{const s=t;s.classList.toggle(Pd,s.dataset.value===e)}))})(n),this.searchData.type=n,this.search())}))}))}search(){const t=new URLSearchParams(this.filterParamsToQuery()).toString(),e=i.ZP.history.location.pathname+"?"+t;i.ZP.history.redirect(e)}filterParamsToQuery(){const t=this.searchData,e={text:t.text,order:t.order,date_from:t.date_from,date_to:t.date_to?t.date_to+" 23:59:59":""};return"adverts"===t.type?e.is_advert=1:"hot"===t.type&&(e.is_in_hot=1),Object.fromEntries(Object.entries(e).filter((([t,e])=>Boolean(e))))}}class Md extends Fs.T3{render(){if(this.isRendered)return this;const t=document.querySelector(".company-blog-search-panel");return t&&new Rd(t).render(),super.render(),this}}class Nd extends Jt.u{constructor(t){super(t),this.els={btn:document.querySelector(".company-blog-story-stats-panel__select-date")},this.params=i.ZP.config("modules.pageParams")}render(){return this.isRendered||this.initCalendar(),this}initCalendar(){const t=new Td({target:this.els.btn,submitButtonTitle:"Показать статистику",popupOptions:{alignment:k.SE.START,showArrow:!1},calendarOptions:{datesRangeMode:!0,showButtonsPanel:!1}});return t.render(),this.els.btn.addEventListener("click",(()=>{t.calendar.setDate(this.params.date_from,this.params.date_to),this.els.btn.classList.add("company-blog-story-stats-panel__select-date_active"),t.show()})),this.listenTo(t,"close",(()=>{this.els.btn.classList.remove("company-blog-story-stats-panel__select-date_active")})),this.listenTo(t,"submit",(t=>{const e=new URLSearchParams({date_from:t.startDate,date_to:t.endDate}).toString(),s=i.ZP.history.location.pathname+"?"+e;i.ZP.history.redirect(s)})),this}}class Bd extends Fs.T3{render(){return this.isRendered||((new Nd).render(),super.render()),this}}var Ld=s(9050);var Fd=s(9050);var Ud=s(9050);var jd=s(5388);const Vd=s(9755),Hd=(s(6419),/(https?:\/\/)[^\s"'<>[\]^`{|}]+/gi);class qd extends Fs.T3{route(t,e){return this.ctx=t,this.isShown||this.show(),e()}render(){return this.isRendered||(this._initComments(),this._resolveButtons=Vd(".report__button-resolve .button"),this._reportsCount=Vd(".report__count"),this._copyLinkButton=Vd('[data-role="link"]'),this.el=window.document.querySelector(".reports"),this.addHandlers(),super.render()),this}_initComments(){[...Vd(".comments")].forEach((t=>{const e=new jd.C({$el:Vd(t)}),s=Array.from(e.el.querySelectorAll(".comment__user"));for(let i=0;i<s.length;i++)Array.from(s[i].querySelectorAll("a")).map((t=>{null==t||t.setAttribute("target","_blank")}));e.initComments()}))}hide(){return super.hide(),this._form.reset(),this}addHandlers(){this._resolveButtons.on("click",(t=>this._handleResolve(t))),this._reportsCount.on("click",(t=>this._showSummary(t))),this._copyLinkButton.on("click",(t=>this._copyLink(t)))}async _handleResolve(t){const{targetId:e,reasonId:s}=t.target.dataset,n=await this._sendResolve(e,s);if(!n.result)return void i.vE.ui.toasts.showError(n.message);Vd(t.target).closest(".report").remove(),this.el.firstElementChild||(this.el.innerHTML='<p class="no-reports">Жалоб нет</p>')}async _sendResolve(t,e){const{response:s}=await S.cf.post(Gd,{action:"resolve",target_id:t,reason_id:e});return s}async _showSummary(t){const{id:e}=t.target.dataset,n=Vd(t.target).parent().parent(),o=n.find(".summary");if(n.find(".summary__wrapper").length)return n.find(".summary__wrapper").remove(),void o.toggleClass("hidden");if(!this._isRequestSending){this._isRequestSending=!0;try{const{data:t}=await S.cf.post(Gd,{action:"get_summary_details",summary_id:e});if(null==t||!t.length)return;t.forEach((t=>{t.note=this._replaceStringToValidHtml(t.note)}));const n=i.vE.isMobileApp?function(t){var e,i="",n=Ud.escape;Array.prototype.join,s(8211).vE;var o=s(381);i+='\n\n<div class="summary__wrapper">\n    ';for(let s=0;s<t.length;s++){i+="\n        ";const r=t[s];i+="\n        ";const a=new Date(1e3*r.created_at).toISOString();i+="\n        ";const l=o(a).fromNow();i+='\n        <div class="summary__item">\n            <div class="summary__user">\n                <div class="summary__img">\n                    <img class="summary__avatar" src="'+n(r.user_avatar||"https://cs.pikabu.ru/images/def_avatar/def_avatar_64.png")+'" />\n                </div>\n                <div class="summary__name">\n                    <a href="'+n(window.location.origin+"/@"+r.user_name)+'">'+n(r.user_name)+'</a>\n                </div>\n                <time class="comment__datetime hint" datetime="'+n(a)+'">'+n(l)+"</time>\n            </div>\n            ",r.note.length>0&&(i+='\n                <div class="summary__note">'+(null==(e=r.note)?"":e)+"</div>\n            "),i+="\n        </div>\n    "}return i+"\n</div> "}(t):function(t){var e,i="",n=Fd.escape;Array.prototype.join,s(8211).vE;var o=s(381);i+='\n\n<div class="summary__wrapper">\n    ';for(let s=0;s<t.length;s++){i+="\n        ";const r=t[s];i+="\n        ";const a=new Date(1e3*r.created_at).toISOString();i+="\n        ";const l=o(a).fromNow();i+='\n        <div class="summary__item">\n            <div class="summary__user">\n                <div class="summary__img">\n                    <img class="summary__avatar" src="'+n(r.user_avatar||"https://cs.pikabu.ru/images/def_avatar/def_avatar_64.png")+'"  alt=""/>\n                </div>\n                <div class="summary__name">\n                    <a href="'+n(window.location.origin+"/@"+r.user_name)+'">'+n(r.user_name)+'</a>\n                </div>\n            </div>\n            <div class="summary__note">\n                '+(null==(e=r.note)?"":e)+'\n            </div>\n            <div class="summary__date">\n                <time class="comment__datetime hint" datetime="'+n(a)+'">'+n(l)+"</time>\n            </div>\n        </div>\n    "}return i+"\n</div> "}(t);o.toggleClass("hidden"),o.append(n)}catch(r){console.log("Error getting summary details:",r)}finally{this._isRequestSending=!1}}}_copyLink(t){t.preventDefault();const e=t.currentTarget,s=e.getAttribute("href");if(c.cQ.copyToClipboard(s),i.vE.isMobileApp)i.vE.ui.toasts.add("copy-link",{content:"Ссылка скопирована!"});else{let t=Vd(e).data("hint");t&&(t.content.find(".popup__hint").html("Скопирована!"),t.updatePosition(),t.destroyAfterHide=!0)}}_replaceStringToValidHtml(t){return"<p>"+t.replace(Hd,'<a href="$&" target="_blank">$&</a>')+"</p>"}}s(9755);class Wd extends Fs.GR{onMatch(t,e){super.onMatch(t,e)}constructor(t){super(t),this.use({"/reports-feed":qd,"/reports-feed/time":qd,"/reports-feed/checked":qd,"/reports-feed/mine":qd,"/reports-feed/time-asc":qd,"/reports-feed/checked/time":qd,"/reports-feed/checked/time-asc":qd,"/reports-feed/mine/time":qd,"/reports-feed/mine/time-asc":qd})}render(){return this.isRendered||(i.vE.ui.screen=lt.d.COMPLAINTS_LIST,super.render()),this}}const Gd="/ajax/reports_actions.php";function Yd(t,e,s){return e in t?Object.defineProperty(t,e,{value:s,enumerable:!0,configurable:!0,writable:!0}):t[e]=s,t}Ze.S.getInstance().fillLocal(qd,{pageComplaintsTemplate:function(t){var e="",i=Ld.escape;Array.prototype.join;const n=s(8211).vE;return e+='\n<div class="complaints-list">\n    <form class="section-group complaints-list__form" method="POST" action="javascript:void 0;" novalidate>\n        <section class="input input_box input_section" data-role="search">\n            <span class="input__icon"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon--ui__search icon--ui__search_input"><use xlink:href="#icon--ui__search"></use></svg></span>\n            <span class="input__box">\n\t\t\t\t<input class="input__input" placeholder="'+i(n.i18n("page-ignore-list.placeholders.posts"))+'" autocomplete="off" name="search" value="">\n\t\t\t</span>\n            <button class="button button_success">Поиск</button>\n        </section>\n        <section class="section_gray complaints-list__categories">\n            ',[{route:"",name:"all"},{route:"/tags",name:"tags"},{route:"/users",name:"users"},{route:"/communities",name:"communities"},{route:"/keywords",name:"keywords"}].forEach((function(t){e+='\n                <a href="/ignore-list'+i(t.route)+'" data-category="'+i(t.name)+'" class="button button_small menu__item_route">\n                    '+i(n.i18n("page-ignore-list.categories."+t.name))+"\n                </a>\n            "})),e+='\n        </section>\n    </form>\n\n    <div class="ignore-stories__container"></div>\n</div>'}});class zd extends Jt.u{constructor(...t){super(...t),Yd(this,"isCaptchaConfirmed",!1),Yd(this,"onCaptchaConfirm",(t=>{this.isCaptchaConfirmed=Boolean(t),this.updateSubmitButtonState()})),Yd(this,"updateSubmitButtonState",(()=>{const t=this.els.form.checkValidity()&&this.isCaptchaConfirmed;this.els.button.disabled=!t}))}render(){return this.isRendered||(this.el=document.querySelector(".law-violation-report"),this.els={form:this.el.querySelector("form"),button:this.el.querySelector("button")},this.initCaptcha(),this.initForm(),this.showError()),this}async initCaptcha(){var t;await nt.k.initScript(),grecaptcha.render(null===(t=this.el)||void 0===t?void 0:t.querySelector(".g-recaptcha"),{sitekey:i.vE.config("grecaptchaKey"),callback:this.onCaptchaConfirm,size:"normal"})}initForm(){const t=new(Ze.S.getInstance().get("UIForm"))(this.els.form),e=Array.from(this.els.form.elements);e.filter((t=>{const e=t.tagName.toLowerCase();return"input"===e||"textarea"===e})).forEach((t=>{t.addEventListener("paste",(t=>{t.preventDefault()}))})),e.forEach((t=>{const e=t.tagName.toLowerCase(),s="input"===e||"textarea"===e?"input":"change";t.addEventListener(s,this.updateSubmitButtonState)})),this.listenTo(t,"change",((t,e)=>{var s,i;"checkbox"===(null===(s=e.$els)||void 0===s||null===(i=s.input)||void 0===i?void 0:i.get(0).type)&&this.updateSubmitButtonState()}))}showError(){const t=i.vE.config("modules.law-violation-report-form.error");t&&i.vE.ui.toasts.showError(t)}}class Zd extends Fs.T3{render(){return this.isRendered||(new zd).render(),this}}var Kd=s(1253);const Xd={"магазин":"shop","промокоды":"promo","скидки":"skidki"};class Qd extends Fs.T3{render(){this.el=document.querySelector(".page-achievements");this.el.querySelectorAll("a").forEach((t=>{const e=t.text.trim().toLowerCase();Xd[e]&&t.addEventListener("mousedown",(()=>{Kd.D.sendEvent("sites",{site:Xd[e]})}),{once:!0})})),i.vE.ui.screen=lt.d.ACHIEVEMENTS,this.scrollToHash(),window.addEventListener("hashchange",this.scrollToHash.bind(this)),super.render()}scrollToHash(){location.hash&&setTimeout((()=>{var t;const e=this.el.querySelector(`.achievement_${location.hash.substring(1)}`),s=null===(t=document.querySelector(".header"))||void 0===t?void 0:t.getBoundingClientRect(),n=s&&i.vE.isMobileApp?Math.max(0,s.height+s.top):0;e&&i.vE.ui.scrollTo(e.offsetTop-n-5,!0)}))}}const Jd="https://skidki.pikabu.ru";function tu(t,e){var s=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),s.push.apply(s,i)}return s}function eu(t){for(var e=1;e<arguments.length;e++){var s=null!=arguments[e]?arguments[e]:{};e%2?tu(Object(s),!0).forEach((function(e){su(t,e,s[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(s)):tu(Object(s)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(s,e))}))}return t}function su(t,e,s){return e in t?Object.defineProperty(t,e,{value:s,enumerable:!0,configurable:!0,writable:!0}):t[e]=s,t}class iu extends Jt.u{constructor(t){super({el:t}),this.show()}render(){return this.isRendered||!this.el||this.loadCarousel(),this}async loadCarousel(){if(!this.el)return;const t=await this.getDeals();if(null==t||!t.length)return;this.el.innerHTML=function(t){var e,s="";return Array.prototype.join,s+='<section class="carousel deals-carousel">\n\t<h2 class="carousel__title">Лучшее на Скидках от Пикабу</h2>\n\t<div class="carousel__main">\n\t\t<button\n\t\t\ttype="button"\n\t\t\tclass="carousel__scroll button carousel__scroll_left carousel__scroll_hidden"\n\t\t>\n\t\t\t<svg xmlns="http://www.w3.org/2000/svg" class="icon icon--ui__arrow-left"><use xlink:href="#icon--ui__arrow-left"></use></svg>\n\t\t</button>\n\t\t<div class="carousel__content">\n\t\t\t<div class="carousel__helper">\n\t\t\t\t<div class="carousel__border-left"></div>\n\n\t\t\t\t',t.deals.forEach((t=>{s+='\n\t\t\t\t\t<article class="carousel__item">\n\t\t\t\t\t\t<div class="deals-carousel__discount">\n\t\t\t\t\t\t\t-'+(null==(e=t.benefit)?"":e)+'%\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\n\t\t\t\t\t\t<a href="'+(null==(e=t.url)?"":e)+'" target="_blank">\n\t\t\t\t\t\t\t<img class="deals-carousel__logo" src="'+(null==(e=t.attachments[0].small)?"":e)+'" alt="'+(null==(e=t.name)?"":e)+'" />\n\t\t\t\t\t\t</a>\n\n\t\t\t\t\t\t<a class="deals-carousel__title" href="'+(null==(e=t.url)?"":e)+'" target="_blank">'+(null==(e=t.name)?"":e)+'</a>\n\n\t\t\t\t\t\t<div class="deals-carousel__price">\n\t\t\t\t\t\t\t'+(null==(e=t.priceAfterFormatted)?"":e)+' ₽\n\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t<a href="'+(null==(e=t.url)?"":e)+'" target="_blank" class="button button_success deals-carousel__go-button">\n\t\t\t\t\t\t\tПерейти\n\t\t\t\t\t\t</a>\n\n\t\t\t\t\t\t<div class="deals-carousel__footer">\n\t\t\t\t\t\t\t<div class="deals-carousel__rating">\n\t\t\t\t\t\t\t\t<svg xmlns="http://www.w3.org/2000/svg" class="icon icon--ui__pulse_16"><use xlink:href="#icon--ui__pulse_16"></use></svg>\n\t\t\t\t\t\t\t\t'+(null==(e=t.rating)?"":e)+'\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t<div class="deals-carousel__comments">\n\t\t\t\t\t\t\t\t<svg xmlns="http://www.w3.org/2000/svg" class="icon icon--ui__comments"><use xlink:href="#icon--ui__comments"></use></svg>\n\t\t\t\t\t\t\t\t'+(null==(e=t.commentCount)?"":e)+"\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\n\t\t\t\t\t</article>\n\t\t\t\t"})),s+='\n\t\t\t\t\n\t\t\t\t<div class="carousel__border-right"></div>\n\t\t\t</div>\n\t\t</div>\n\t\t<button\n\t\t\ttype="button"\n\t\t\tclass="carousel__scroll button carousel__scroll_right"\n\t\t>\n\t\t\t<svg xmlns="http://www.w3.org/2000/svg" class="icon icon--ui__arrow-right"><use xlink:href="#icon--ui__arrow-right"></use></svg>\n\t\t</button>\n\t</div>\n</section>\n'}({deals:t});new(Ze.S.getInstance().get("UICarousel"))({el:this.el})}async getDeals(){const t=await fetch("https://skidki.pikabu.ru/api/deals-for-banner");return(await t.json()).map((t=>eu(eu({},t),{},{priceAfterFormatted:this.formatPrice(t.priceAfter),url:`${Jd}${t.url}?utm_source=pikabu&utm_medium=post-banner`})))}formatPrice(t){return Math.floor(t).toString().replace(/\B(?=(\d{3})+(?!\d))/g," ")}}window.pkbDealsWidget=t=>{const e="string"==typeof t?document.getElementById(t):t;return e?(e.classList.add("deals-widget-container"),new iu(e)):null};const nu=s(9755);i.vE.use((function(t,e){if(!nu(".app__warning").length)return e()})),i.vE.use({"/":qc,"/hot/:subs(subs)?/:mode(time|actual)?":qc,"/old-hot/:mode(time|actual)?":qc,"/best/:subs(subs)?/:data(24h|week|month|all|[0-9--]{10}|[0-9-]{10}_[0-9-]{10})?":qc,"/new/:subs(subs)?/:sort(popular)?/:data([0-9--]{10})?":qc,"/subs":qc,"/subs/(user|community|tag)/:subscription":qc,"/(new|best|hot)/feed/:feedName":qc,"most-saved-stories":_r,"disputed-stories":vr,"user-discussed-stories":yr,"/saved-stories/:cid?":Tr,"shared-saved-stories":Tr,"/liked/:not?":Er,"advert-stories":pr,"news-preview":wh,coronavirus:Gc,"stay home":Gc,"/visited-stories":dd,"/companies/:date([0-9--]{10})?":class extends qc{render(){if(this.isRendered)return this;const t=document.querySelector(".company-blogs-info");return t&&new fd({el:t}),super.render(),this}}}),i.vE.use("story-editor",eh),i.vE.use("story-preview",Ja),i.vE.use("/story/:id/:type(author)?",class extends si{async route(t,e){var s;this.ctx=t;const n="author"===t.params.type;if(!this.isRendered){if(this.show(),this.$els.commentsSlice.length)this.sliceComments.show();else if(n){var o;if(i.vE.initParams.experimentCommentsOnTop)null===(o=this.allComments)||void 0===o||o.show();this.authorComments.show()}else{var r;null===(r=this.allComments)||void 0===r||r.show()}return e()}return n?(this.allComments.hide(),this.authorComments.show(),e()):(this.authorComments.hide(),null===(s=this.allComments)||void 0===s||s.show(),e())}render(){return this.isRendered||(this.$el=Ri(".page-story"),this.$els={story:this.$(".page-story__story").eq(0),menu:this.$(".menu"),similarGroup:this.$('.section-group[data-role="similar-group"]'),similarStories:this.$('section[data-role="similar-stories"]'),similarTitle:this.$('.section_header[data-role="similar-title"]').on("click",this._onClickCompare.bind(this)),relatedStories:Ri('.stories-feed[data-role="related"]'),relatedTitle:Ri('.section-hr[data-role="related-title"]'),tags:this.$(".story__tags"),commentsContainer:this.$(".story-comments"),commentsAll:this.$(".story-comments__all"),commentsAuthor:this.$(".story-comments__author"),commentsSlice:this.$(".story-comments__slice"),authorIgnoreWarning:this.$(".page-story__author-ignore-warning"),adBlockWarning:this.$('section[data-role="adb-warning"]'),adDisclaimer:this.$(".story__sponsor_disclaimer"),communityMore:this.$(".community-comments__rules-more"),hideCommentsButton:this.$(".comments_fold"),commentsNavigator:this.$(".comments-navigator")},this._maxCommunityRulesHeight=60,this._storyId=this.$el.data("story-id"),this._minPageHeightForSharings=245,this._similarStories=void 0,this._menu=new li(this.$els.menu),this._menu.setLoading(!0),i.vE.ui.screen=lt.d.POST,this._handleTransitionFromAdvertStory(),this._initStoryFeed(),this._initAdsFeed(),this._initRelatedStories(),this._initSmmTool(),this._initEvaluation(),this._initCommentsViewEvaluation(),this.$els.commentsAll.length&&new Oi({storyId:this._storyId,popupTarget:this.el,storyEl:this.$els.story[0]}),this.$els.adBlockWarning.length&&this._checkAd(),i.vE.ui.screen=lt.d.POST,this.$els.communityMore.length&&(this.$(".community-comments__rules div").height()>this._maxCommunityRulesHeight&&this.$els.communityMore.addClass("community-comments__rules-more_show"),this.$els.communityMore.on("click",(()=>{this.$(".community-comments__rules").addClass("community-comments__rules_open"),this.$els.communityMore.removeClass("community-comments__rules-more_show")}))),this.$els.hideCommentsButton.length&&(this.$els.hideCommentsButton.on("click",(()=>{this.$els.hideCommentsButton.addClass("hidden"),this.$(".comments__container").removeClass("hidden"),this.$els.hideCommentsButton.hasClass("comments_fold")&&(i.vE.history.location.hash="comments"),this.$els.hideCommentsButton.removeClass("comments_fold")})),"#comments"===i.vE.history.location.hash&&this.$els.hideCommentsButton.trigger("click")),this.$el.find(".community-comments__header-left-group a").on("click auxclick",(t=>{0!==t.button&&1!==t.button||d.c.getInstance().sendEvent("transition_to_community",{type:"from_under_post",community_id:Di(t.currentTarget)})})),super.render(),this._menu.setLoading(!1),this.initFirstStoryAlert(),this.initViewTimeRecorder()),this}_attachScrollAnalytics(){let t=!this.$els.comments.length,e=!1,s=!this.$els.relatedStories.length,n=.3*i.vE.ui.screenHeight,o=t?0:this.$els.comments.offset().top-n-50,r=s?0:this.$els.relatedTitle.offset().top-n,a=Mi.throttle((l=>{!t&&l>o&&(d.c.getInstance().yandex.goal("scroll-to-comments"),c.xg.get("gaCS")||(c.xg.set("gaCS",1),d.c.getInstance().google.event("scroll","comment")),t=!0),s||e||!i.vE.ui.elementWillSoonScrolled(this.$els.relatedTitle[0])||(r=this.$els.relatedTitle.offset().top-n,e=!0),!s&&e&&l>r&&(d.c.getInstance().yandex.goal("scroll-to-similar-stories"),s=!0),t&&s&&this.stopListening(i.vE.ui,"document-scroll",a)}),400);t&&s||this.listenTo(i.vE.ui,"document-scroll",a)}_onClickCompare(){return this.$els.similarGroup.data("level")<1||(this._initCompare(),this.$els.similarGroup.toggleClass("section-group_collapse")),this}_initStoryFeed(){return this._feed=new ys._D({$el:this.$els.story,feedName:"story"}),this}_initAdsFeed(){const t=this.$(".page-story__story").get(1);t&&new ys._D({$el:t,feedName:"adverts",referrerStoryId:this._storyId})}_initRelatedStories(){if(this.$els.relatedStories.length)if(q.V.isUserInExperiment(q.t.TILES_POSTS,"gr1")){const t=this.$els.relatedStories[0];t.classList.contains("short-story-tiles")&&new Pi.T({el:t})}else this._relatedStories=new ys._D({$el:this.$els.relatedStories,feedName:"related"}),new hi.B(this._relatedStories)}_initSmmTool(){this.$el.data("smmtool")&&new ni(this.$el)}_initEvaluation(){var t;(null===(t=i.vE.history.state)||void 0===t?void 0:t.storyPublishedId)===this._storyId&&(Ii.SR.getInstance().init("post_publish"),i.vE.history.replaceState({},document.title))}_initCommentsViewEvaluation(){0!==this.$els.commentsContainer.length&&Ii.Nx.getInstance().initObserver(this.$els.commentsContainer.get(0),this._storyId)}async _initCompare(){return this._similarStories||(this._similarStories=new Ws.Bi({$parent:this.$els.similarStories,type:Ws.VQ.STORY,storyId:this._storyId}),this._similarStories.show(),this.$(".compare__close").on("click",this._onClickCompare.bind(this))),this._similarStories}_initCommentsTyping(){i.vE.initParams.isAvailableMessageCommentsTyping&&(Zs.P||i.vE.ua.ios)&&(this._commentsTypingFeature&&(this._commentsTypingFeature.destroy(),delete this._commentsTypingFeature),this._commentsTypingFeature=new CommentsTypingFeatureD(this._storyId,this._comments))}get allComments(){if(this._allComments)return this._allComments;if(!this.$els.commentsAll.length)return;const t=this._feed.stories.firstId(),e=this._feed.stories.get(t),s=this._allComments=new ci.UIAllComments({story:e,$el:this.$els.commentsAll});return this.$els.commentsNavigator.length&&(this._navigator=new xi({comments:s,$parent:this.$els.commentsNavigator}),this._navigator.show()),s}get authorComments(){if(this._authorComments)return this._authorComments;const t=this._feed.stories.firstId(),e=this._feed.stories.get(t);return this._authorComments=new gi({story:e,storyId:this._storyId,$el:this.$els.commentsAuthor})}get sliceComments(){if(this._sliceComments)return this._sliceComments;const t=this._feed.stories.firstId(),e=this._feed.stories.get(t);return this._sliceComments=new Ci({story:e,storyId:this._storyId,$el:this.$els.commentsSlice})}async _checkAd(){const t=await i.vE.adblock.ready;void 0===window.isABPEnabled?(window.isABPEnabled=Boolean(await(0,ki.pJ)()),t&&!window.isABPEnabled?(this.$els.adBlockWarning.removeClass("section_hidden"),this.$els.adDisclaimer.addClass("hidden")):t&&window.isABPEnabled&&this.$els.adDisclaimer.removeClass("hidden")):window.isABPEnabled&&this.$els.adDisclaimer.removeClass("hidden")}_handleTransitionFromAdvertStory(){if("cpm"===i.vE.history.searchParams.get("from")){const t=new URLSearchParams(i.vE.history.location.search);t.delete("from");const e=t.toString(),s=i.vE.history.location.pathname+(e?"?"+e:"");i.vE.history.replaceUrl(s,!1,!1),i.vE.storage.isTransitionFromAdvertStory=!0}}get feed(){return this._feed}}),i.vE.use("incoming-comments",class extends Jr{render(){if(this.isRendered)return this;this.$el=Ha(".page-answers"),this.$els={author:this.$('input[name="auth"]'),form:this.$("form"),loading:this.$(".page-answers__loading").hide(),filters:this.$(".page-answers__filters").show(),markAll:this.$('span[data-role="mark-all-as-read"]'),commentsContainer:this.$(".comments-part"),spinner:this.$(".stories-feed__spinner")},this._form=new a.x(this.$els.form),this._searchInput=new T.u3(this.$('.input[data-role="search"]')),this.initBtnMarkAll(),this._author=new Ss._d({$el:this.$(".form-group__body")});const t=i.vE.config("modules.author");t&&(this._author.addItem({name:t.name,avatar:t.avatar}),n.u1.getUIElement(this.$(".form-group")).open()),this.listenTo(this._author,"change",(t=>{this.$els.author.val(t.length>0?t[0].name:""),this._form.submit()})),this._shareFeature=new hi.B,this._commentsParts=new ui.z({$el:this.$(".comments-part"),mode:f.lL.INCOMING}).show();const e=this._commentsParts.addComments();return this.observeBlock(this.getLastBlock(this.$els.commentsContainer),e),i.vE.ui.screen=lt.d.USER_ANSWERS,Ii.SR.getInstance().init("responses_visit"),this.initMarkAsReadStrategy(),this.initLoadOnScroll(),super.render(),this}initBtnMarkAll(){this.$els.markAll.on("click",(async()=>{await ja.markAllAsRead()&&window.location.reload()}))}initLoadOnScroll(){if(!this.$els.spinner.length)return;this.loadOnScrollOptions={onDocumentEndThrottle:(0,Ti.P)((()=>this.loadAnswers()),100),spinner:i.vE.ui.player.createAnimation("stories-spinner",{$parent:this.$els.spinner}),isLoadingAnswers:!1,nextPage:2,filteredIds:[],attempts:5},this.loadOnScrollOptions.hasMoreAnswers=Boolean(this.$els.commentsContainer.data("has-more"));this.listenTo(i.vE.ui,"document-scroll",(()=>{const{hasMoreAnswers:t,isLoadingAnswers:e,nextPage:s}=this.loadOnScrollOptions;t&&!e&&s<=101&&i.vE.ui.elementWillSoonScrolled(this.el,500)&&this.loadOnScrollOptions.onDocumentEndThrottle()}))}async loadAnswers(){if(this.loadOnScrollOptions.isLoadingAnswers)return;this.loadOnScrollOptions.isLoadingAnswers=!0,this.loadOnScrollOptions.spinner.play();const t=Array.from(this.blocks.values()).flat(),{excludeIds:e,baseId:s}=this.prepareIds(this.getAnswerIds(t),this.loadOnScrollOptions.filteredIds),i=new Va._(location.search);i.set("exclude_ids",e),i.set("base_id",s),this.loadOnScrollOptions.nextPage++;const{response:n,data:o}=await S.cf.post(location.pathname,i);if(!n.result)return this.loadOnScrollOptions.spinner.stop(),void(this.loadOnScrollOptions.isLoadingAnswers=!1);const{has_more:a,comments:l,filtered_ids:h}=o;if(this.loadOnScrollOptions.hasMoreAnswers=a,null!=h&&h.length&&(this.loadOnScrollOptions.filteredIds=[...this.loadOnScrollOptions.filteredIds,...h]),this.loadOnScrollOptions.attempts&&a&&!l.length&&null!=h&&h.length)return this.loadOnScrollOptions.attempts--,this.loadOnScrollOptions.spinner.stop(),this.loadOnScrollOptions.isLoadingAnswers=!1,void this.loadAnswers();if(this.loadOnScrollOptions.attempts=5,!l.length)return this.loadOnScrollOptions.hasMoreAnswers=!1,this.loadOnScrollOptions.spinner.stop(),void(this.loadOnScrollOptions.isLoadingAnswers=!1);const c=r.Zv.fragment(`\n\t\t\t<div class="comments-part__group">\n\t\t\t\t${l.map((({html:t})=>t)).join("")}\n\t\t\t</div>\n\t\t`),d=[...Ha(c).find(".comments")];this.$els.commentsContainer.append(c);const u=this._commentsParts.addComments();d.forEach((t=>{if(this.isMarkAsReadObserverStrategy()){const e=Ha(t).find(this.unreadClass);this.addToMarkAsReadObserver([...e])}})),this.observeBlock(this.getLastBlock(this.$els.commentsContainer),u),this._shareFeature.updateShareButtons(),this.loadOnScrollOptions.spinner.stop(),this.loadOnScrollOptions.isLoadingAnswers=!1}initMarkAsReadObserver(){if(!this.$els.markAll.length)return;this.answersToMark=[];const t=(0,xs.D)(this.markAsRead.bind(this),500),e=new WeakMap;this.markAsReadObserver=new IntersectionObserver((s=>{s.forEach((({target:s,intersectionRatio:i,rootBounds:n,boundingClientRect:o,intersectionRect:r})=>{const a=n.height<=o.height,l=1===i,h=r.height>=n.height/2,c=e.has(s);if(!(a?h:l)||c)c&&(clearTimeout(e.get(s)),e.delete(s));else{const i=setTimeout((()=>{this.markAsReadObserver.unobserve(s);const e=Ha(s),i=e.data("comment-id");i&&(this.answersToMark.push({id:i,$answer:e}),t())}),2e3);e.set(s,i)}}))}),{threshold:ta});const s=this.$els.commentsContainer.find(this.unreadClass);this.addToMarkAsReadObserver([...s])}addToMarkAsReadObserver(t){this.markAsReadObserver&&t.length&&t.forEach((t=>this.markAsReadObserver.observe(t.parentNode)))}async markAsRead(){if(!this.answersToMark.length)return;const{ids:t,$answers:e}=this.answersToMark.reduce(((t,{id:e,$answer:s})=>(t.ids.push(e),t.$answers.push(s),t)),{ids:[],$answers:[]});this.answersToMark=[];await ea.HW.markAsRead(t)&&(e.forEach((t=>{t.find(this.unreadClass).removeClass(this.unreadClass.slice(1))})),this.updateUnreadCounter(t))}}),i.vE.use("outcoming-comments",qa),i.vE.use("saved-comments",Ga),i.vE.use("top50-comments",Xa),i.vE.use("survey",lh),i.vE.use({"/promo-test/:id([A-Za-z0-9+/]{9,16})":yh,"/promo_test.php":yh}),i.vE.use("/edits/:story(\\d+)/:mode(waiting|approved|rejected|canceled|history)?",Ah),i.vE.use("/edits/:story(\\d+)/:type(tags|title)/:mode(waiting|approved|rejected|canceled|history)?",Rh),i.vE.use("/edits/:story(\\d+)/:type(text|image|video)/:id(\\d+)/:mode(waiting|approved|rejected|canceled|history)?",Rh),i.vE.use("/edits/:story(\\d+)/:id(\\d+)",Nh),i.vE.use("/edits/:mode(waiting|approved|rejected|canceled|mine)?",qh),i.vE.use("/edits/@:user",qh),i.vE.use({"/search":dr,"/search.php":dr,"/tag/:name/:mode?":dr}),i.vE.use({"user-notifications":ho}),i.vE.use({"communities-stories":class extends co{render(){return this.isRendered||(i.vE.ui.screen=lt.d.COMMUNITIES_FEED,super.render(),this.$el=uo(".communities-stories-feed"),this.$els={rating:this.$(".communities-stories-feed__rating").on("click",this._showRatingBox.bind(this))},this._loadListDebounced=po.debounce(this._loadList,500),this._feed=new ys._D({$el:uo(".stories-feed"),feedName:"communities",focused:!0}),new ys.RP({$el:uo(".communities-stories .feed-panel"),feed:this._feed,isDisableCalendar:!0})),this}_showRatingBox(){let t=this.marks.get("rating-box");if(!t){let e=Number(this.$els.rating.data("value")||0),s=new ws.T({options:mo,value:e});t=new k._({target:this.$els.rating,indent:!0,content:s.render().el}),this.marks.set("rating-box",t),s.$el.css("width",200),this.listenTo(s,"change",(t=>{this._ratingLimit=t,this.$els.rating.text(i.vE.i18n("page-communities.rating",t)),this._loadListDebounced()}))}t.toggle()}_loadList(){let t=this._feed;this._ratingLimit&&t.searchParams.set("mr",this._ratingLimit),t.clear().loadStories(!1)}},"/communities/:type(mine)?/:sort(actual|time|subs)?":fo,"/communities/:type(tag)/:tag/:sort(actual|time|subs)?":fo,community:Yo,"/community/:name/search":Yo,"community-banlist":class extends Wo{render(){return this.isRendered||(super.render(),zo('.page-community-banlist__record .page-community-banlist__record__button[data-role="show-history"]').each((function(){let t=zo(this),e=t.closest(".page-community-banlist__record").attr("data-id");zo(`.page-community-banlist__record[data-parent-id="${e}"]`).length>0&&t.show()})).off("click").on("click",(t=>{let e=zo(t.target).closest(".page-community-banlist__record__button"),s=e.closest(".page-community-banlist__record").attr("data-id");e.toggleClass("page-community-banlist__record__button_open"),zo(`.page-community-banlist__record[data-parent-id="${s}"]`).toggle()}))),this}},"community-setup":class extends xc{render(){super.render(),this.$els={loading:this.$('.section[data-role="spinner"]'),form:this.$(".community-settings"),desc:this.$('.input[data-role="desc"]'),rules:this.$('.input[data-role="rules"]'),rating:this.$('input[name="min_rating"]'),tags:this.$('.input[data-role="tags"]'),pinnedStoryURL:this.$('.input[data-role="pinned-story-url"]'),ratingButton:this.$('span[data-role="min-rating"]').on("click",this._showRatingBox.bind(this)),button:this.$('.community-settings button[type="submit"]')};let t=new T.u3(this.$els.pinnedStoryURL);this.listenTo(t,"input",this._onChange);let e=this._form=new a.x(this.$els.form);e.add(new sa.Y({$el:this.$els.desc})),e.add(new sa.Y({$el:this.$els.rules}));const s=new T.K1({$el:this.$els.tags,validationEvent:T.km.MANUAL,validationHint:!0});return s.suggestion=new C.Z6({filter:Dl.ll.STORY}),e.add(s),e.add(t),this._submitButton=new st.y3(this.$els.button),this.marks.set("data",e.serialize()),this.listenTo(e,"change",this._onChange),this.listenTo(e,"submit",this._onSubmit),this.$els.loading.remove(),this.$els.form.show(),this}_onChange(){this._submitButton.disabled=this.isLocked||Dc.isEqual(this.marks.get("data"),this._form.serialize())}async _onSubmit(t,e){if(t.preventDefault(),this._submitButton.progress)return!1;let s=e.serialize(),n=Date.now();this._submitButton.progress=!0;try{var o;const{progress:t}=await this.community.edit(s);await c.cQ.delay(1e3-(Date.now()-n)),this._submitButton.disabled=!0,i.vE.ui.toasts.add({content:i.vE.i18n("communities.editor.form.saved")}),this.marks.set("data",s),null===(o=this.communityProgress)||void 0===o||o.updateState(t)}catch(r){i.vE.ui.toasts.showError(r)}this._submitButton.progress=!1}_showRatingBox(){if(!this._ratingBox){let t=new ws.T({options:Pc,value:Number(this.$els.rating.val())});t.on("change",(t=>{this.$els.rating.val(t).change(),this.$els.ratingButton.find("span").text(i.vE.i18n("communities.editor.rating."+(-200===t?"any":"over"),t))})),this._ratingBox=new k._({target:this.$els.ratingButton,width:200,indent:!0,content:t.show().$el})}this._ratingBox.toggle()}get isLocked(){return this._options.isLocked}set isLocked(t){this._options.isLocked!==(t=Boolean(t))&&(this._options.isLocked=t)}},"community-add":class extends xc{render(){if(this.isRendered)return this;super.render(),this.$els={form:this.$(".community-settings"),button:this.$('.community-settings button[type="submit"]'),name:this.$('input[name="name"]').closest(".input"),link:this.$('input[name="link"]').closest(".input"),tags:this.$('.input[data-role="tags"]')};let t=new a.x(this.$els.form);t.add(new T.u3({$el:this.$els.name,validationHint:!0,validationRules:{"communities.editor.form.invalid-name":t=>!0}})),t.add(new T.u3({$el:this.$els.link,validationHint:!0,validationRules:{"communities.editor.form.invalid-link":t=>/^[a-z0-9_]+$/i.test(t)&&/^[^_].+[^_]$/.test(t)&&-1===t.indexOf("__")}}));const e=new T.K1({$el:this.$els.tags,validationEvent:T.km.MANUAL,validationHint:!0});return e.suggestion=new C.Z6({filter:Dl.ll.STORY}),t.add(e),this._submitButton=new st.y3(this.$els.button),this.listenTo(t,"submit",this._onSubmit),this}async _onSubmit(t,e){if(t.preventDefault(),this._submitButton.progress||!(await e.checkValidity()))return;let s=e.serialize(),n=Date.now();this._submitButton.progress=!0;try{await this.community.create(s),i.vE.ui.toasts.add({content:i.vE.i18n("communities.editor.form.created")}),await c.cQ.delay(1e3-(Date.now()-n)),window.location.href="/community/"+s.link}catch(o){this._submitButton.progress=!1,i.vE.ui.toasts.showError(o)}}},"community-admin-banlist":class extends xc{render(){if(this.isRendered)return this;super.render(),this.$els={input:this.$('.input[data-role="search"]'),spinner:this.$('section[data-role="spinner"]'),editor:this.$(".community-editor"),table:this.$('section[data-role="table"]')};let t=this._searchInput=new T.u3({$el:this.$els.input,suggestion:new C.xI,sanitizerRules:[T.op.trim()]});return this.listenTo(new a.x(this.$els.editor),"submit",(t=>{t.preventDefault(),this._loadList()})),this.listenTo(t.suggestion,C.nT.SELECT,(e=>{e&&(t.value=e.data.name,this._loadList())})),this._table=new Jo.$({$parent:this.$els.table,renderBody:this._renderTable.bind(this),header:[["Пользователь",0,"user_name","string"],["Причина",0,"type"],["Действует до",20,"time"],["Модератор",0,"moder_name","string"],["",5]]}),this._table.rows.fieldId="id",this._loadList(!1,{list:i.vE.config("modules.community-ban-list"),hasMore:this.$els.editor.data("has-more")}),this._table.show(),this._table.$el.on("click",'span[data-role="delete"]',this._onClickCancelBan.bind(this)),this._table.$el.on("click",".community-editor__more",this._loadList.bind(this,!0,null)),this._table.$el.on("click",'span[data-role="history"]',(t=>{let e=this._table.rows.get(Number(t.currentTarget.closest("tr").getAttribute("data-id")));e&&(e.marks.set("isShown",!e.marks.get("isShown")),this._table.update())})),this.$els.spinner.remove(),this.$els.editor.show(),this}async _loadList(t=!1,e){let s=this._searchInput.value;if(!t&&this.marks.get("search")===s)return;this.marks.set("search",s);let n=t?this.marks.get("last-id"):0;if(!e||!Mc.isObject(e))try{e=await this.community.loadBanList(s,n)}catch(a){return void i.vE.ui.toasts.showError(a)}let{list:o,hasMore:r}=e;this.marks.set("has-more",r),o=(Mc.isArray(o)?o:[]).map((t=>(t.type=me.o6[t.type],t.time=Number(Rc(t.datetime).format("X")),t.url="/story/_"+t.target.split(",").slice(0,2).join("?cid="),t.ban_type=me.Zg[t.ban_type],n=t.id,t))),this.marks.set("last-id",n),this._table.rows.set(o,{merge:t})}_renderTable(t){let e=t.items.filter((t=>0===t.data.parent_id)).map((e=>({isShownChild:Boolean(e.marks.get("isShown")),rows:[e,...t.items.filter((t=>t.data.parent_id===e.id))]})));return yn.vu.create("tbody",null,t.size?null:yn.vu.create("tr",{className:"table__message"},yn.vu.create("td",{colSpan:"5"},i.vE.i18n("communities.editor.ban-list."+(this.marks.get("search").length>0?"search-":"")+"empty"))),e.map((({isShownChild:t,rows:e})=>e.map((s=>{let n,o="";s.data.type&&s.data.type!==me.o6.NO_TARGET&&(n=i.vE.i18n("communities.editor.target."+s.data.type.toString())||"",o=s.data.url?yn.vu.create("a",{href:s.data.url,target:"_blank"},n):yn.vu.create("span",null,n));let r=s.data.parent_id>0,a=r?"community-ban-list__canceled"+(t?" community-ban-list__canceled_shown":""):"",l=s.data.ban_type===me.Zg.LIMITED?yn.vu.create("time",{className:"caption",dateTime:s.data.datetime},Rc(s.data.datetime).format("D MMMM, H:mm")):yn.vu.create("caption",{className:"caption"},i.vE.i18n("communities.ban-type."+s.data.ban_type.toString()));return yn.vu.create("tr",{key:s.id,"data-id":s.id,className:a},yn.vu.create("td",null,!r&&yn.vu.create(bn.N,{name:s.data.user_name,avatar:s.data.avatar})),yn.vu.create("td",null,i.vE.i18n("communities.editor.target-for")," ",o),yn.vu.create("td",null,l),yn.vu.create("td",null,yn.vu.create(bn.N,{key:s.data.name,name:s.data.moder_name,avatar:s.data.moder_avatar})),r?yn.vu.create("td",null):yn.vu.create("td",{className:"community-editor__actions"},e.length>1&&yn.vu.create("span",{className:"hint","aria-label":"Показать историю","data-role":"history","data-shown":t},yn.vu.create(bn.t,{block:"ui__history",modifiers:"table-row"})),yn.vu.create("span",{className:"hint","aria-label":"Снять бан","data-role":"delete"},yn.vu.create(bn.t,{block:"ui__close",modifiers:"table-row"}))))})))),Boolean(this.marks.get("has-more"))&&yn.vu.create("tr",{key:"hasMore"},yn.vu.create("td",{colSpan:"5",className:"community-editor__more"},yn.vu.create("button",{type:"button",className:"button button_small button_width_100"},i.vE.i18n("communities.editor.more")))))}async _onClickCancelBan(t){let e=this._table.rows.get(Number(t.currentTarget.closest("tr").getAttribute("data-id")));if(!e||e.marks.has("lock"))return;e.marks.set("lock",!0);let s=await pt.g.confirmBalloon({target:t.currentTarget,content:i.vE.i18n("communities.editor.ban-list.remove",e.data.user_name,e.data.avatar),buttons:[["modal.revoke",Bs.j.SUCCESS,!0],["modal.cancel"]]});if(e.marks.delete("lock"),s)try{await this.community.cancelBan(e.data.user_id),e.destroy()}catch(n){i.vE.ui.toasts.showError(n)}}},"community-moderators":class extends xc{render(){if(this.isRendered)return this;super.render(),this.$els={input:this.$('.input[data-role="search"]'),addState:this.$(".community-editor__add"),spinner:this.$('section[data-role="spinner"]'),editor:this.$(".community-editor"),table:this.$('section[data-role="table"]')},this._isEditable=this.$els.editor.data("editable");const t=this._nameInput=new T.u3({$el:this.$els.input,suggestion:new C.xI({parseFilter:t=>!this._table.rows.items.some((e=>e.data.name===t.name))})});return this.listenTo(t.suggestion,C.nT.CURRENT,(t=>{this.$els.addState.toggleClass("community-editor__add_active",Boolean(t))})),this.listenTo(t.suggestion,C.nT.SELECT,this._onSelectUser),this.listenTo(t,"blur",(()=>t.value="")),this._table=new Jo.$({$parent:this.$els.table,renderBody:this._renderTable.bind(this),header:[["",0,"name","string"],["Забанил",15,"ban_count"],["Отклонил постов",20,"disapproved_count"],["Одобрил постов",20,"approved_count"],["",10]]}),this._table.rows.fieldId="user_id",this._loadList(i.vE.config("modules.community-moderators")),this._table.show(),this._table.$el.on("click",'span[data-role="delete"]',this._onClickDeleteModerator.bind(this)),this._table.$el.on("click",'span[data-role="edit"]',this._onClickEditModeratorPermissions.bind(this)),this.$els.spinner.hide(),this.$els.editor.show(),this}async _loadList(t){t=Array.isArray(t)?t.map((t=>(t.is_chief=Boolean(Number(t.is_chief)),t))):[],this._table.rows.set(t,{merge:!1})}_renderTable(t){const e=[],s=t.items.filter((t=>!!t.data.is_chief||(e.push(t),!1))),n=this._isEditable?yn.vu.create("td",{className:"community-editor__actions"},yn.vu.create("span",{"data-role":"edit"},yn.vu.create(bn.t,{block:"ui__pencil",modifiers:"table-row"})),yn.vu.create("span",{"data-role":"delete"},yn.vu.create(bn.t,{block:"ui__close",modifiers:"table-row"}))):yn.vu.create("td",null);return yn.vu.create("tbody",null,t.size?null:yn.vu.create("tr",{className:"table__message"},yn.vu.create("td",{colSpan:"5"},i.vE.i18n("communities.editor.moderator.empty"))),s.length?yn.vu.create("tr",{className:"table__title"},yn.vu.create("td",{colSpan:"5"},i.vE.i18n("communities.editor.moderator.chiefs"))):null,s.map((t=>yn.vu.create("tr",{key:t.id,"data-id":t.id},yn.vu.create("td",null,yn.vu.create(bn.N,{key:t.data.name,name:t.data.name,avatar:t.data.avatar})),yn.vu.create("td",null,t.data.ban_count),yn.vu.create("td",null,t.data.disapproved_count),yn.vu.create("td",null,t.data.approved_count),n))),e.length?yn.vu.create("tr",{className:"table__title"},yn.vu.create("td",{colSpan:"5"},i.vE.i18n("communities.editor.moderator.moderators"))):null,e.map((t=>!t.data.is_chief&&yn.vu.create("tr",{key:t.id,"data-id":t.id},yn.vu.create("td",null,yn.vu.create(bn.N,{key:t.data.name,name:t.data.name,avatar:t.data.avatar})),yn.vu.create("td",null,t.data.ban_count),yn.vu.create("td",null,t.data.disapproved_count),yn.vu.create("td",null,t.data.approved_count),yn.vu.create("td",{className:"community-editor__actions"},this._isEditable&&yn.vu.create("span",{"data-role":"edit"},yn.vu.create(bn.t,{block:"ui__pencil",modifiers:"table-row"})),yn.vu.create("span",{"data-role":"delete"},yn.vu.create(bn.t,{block:"ui__close",modifiers:"table-row"})))))))}_onSelectUser(t){this._nameInput.value="",this._showModeratorPermissionsConfirmModal(t)}_getRowsItem(t){return this._table.rows.get(Number(t.currentTarget.closest("tr").getAttribute("data-id")))}async _onClickDeleteModerator(t){const e=this._getRowsItem(t);if(!e||e.marks.has("lock"))return;e.marks.set("lock",!0);const s=await pt.g.confirmBalloon({target:t.currentTarget,content:i.vE.i18n("communities.editor.moderator."+(e.data.is_chief?"remove-chief":"remove-moderator"),e.data.name,e.data.avatar),buttons:[["modal.remove",Bs.j.DANGER,!0],["modal.cancel"]]});if(e.marks.delete("lock"),s)try{await this.community.deleteModerator(e.id),e.destroy()}catch(n){i.vE.ui.toasts.showError(n)}}_onClickEditModeratorPermissions(t){this._showModeratorPermissionsConfirmModal(this._getRowsItem(t),!0)}async _showModeratorPermissionsConfirmModal(t,e){if(!t)return;const s=t.plainData;s.isEditable=this._isEditable,s.chiefDisabled=e&&s.is_chief,s.moderatorDisabled=e&&!s.is_chief;const n=Nc(function(t){var e,s="";return Array.prototype.join,s+='<div>\n\tНазначить пользователя&nbsp;\n\t<a href="'+(null==(e=t.profile)?"":e)+'" class="user user_inline">\n\t\t<span class="avatar avatar_small"><img src="'+(null==(e=t.avatar)?"":e)+'"></span>\n\t\t<span class="user__nick">'+(null==(e=t.name)?"":e)+"</span>\n\t</a>\n\t",t.isEditable?s+='\n\t<div class="community-editor__checkboxes">\n\t\t<form>\n\t\t\t<p>\n\t\t\t\t<label><input type="radio" name="isChief" value="1" '+(null==(e=t.chiefDisabled?"":"checked")?"":e)+" "+(null==(e=t.chiefDisabled?"disabled":"")?"":e)+'> руководителем</label>\n\t\t\t</p>\n\t\t\t<p>\n\t\t\t\t<label><input type="radio" name="isChief" value="0" '+(null==(e=t.chiefDisabled?"checked":"")?"":e)+" "+(null==(e=t.moderatorDisabled?"disabled":"")?"":e)+"> модератором</label>\n\t\t\t</p>\n\t\t</form>\n\t</div>\n\t":s+=" модератором?",s+="\n</div>\n"}(s));let o;this._isEditable&&(o=new a.x(n));if(await pt.g.confirmModal({content:n,buttons:[["communities.editor.moderator.button-add",Bs.j.SUCCESS,!0],["modal.cancel"]]}))try{let i=!1;this._isEditable&&(i=Boolean(o.serialize().isChief));const n=await this.community.addModerator(s.name,i);e&&this._table.rows.remove(t,{silent:!0}),this._loadList(n)}catch(r){i.vE.ui.toasts.showError(r)}}},"community-history":class extends xc{render(){return this.isRendered||(super.render(),this.$els={spinner:this.$('section[data-role="spinner"]'),editor:this.$(".community-editor")},this._table=new Jo.$({$parent:this.$els.editor,renderBody:this._renderTable.bind(this),header:[["Время",15,"time"],["Модератор",0,"moder_name","string"],["Действие",0,"action"],["Пользователь",0,"user_name","string"]]}),this._table.rows.fieldId="time",this._loadList(!1,{hasMore:this.$els.editor.data("has-more"),list:i.vE.config("modules.community-history")}),this._table.show(),this._table.$el.on("click",".community-editor__more",this._loadList.bind(this,!0,null)),this.$els.spinner.hide(),this.$els.editor.show()),this}async _loadList(t=!1,e){let s=this.marks.get("last-time")||0;if(!e||!Lc.isObject(e))try{e=await this.community.loadModerationHistory(s)}catch(r){return void i.vE.ui.toasts.showError(r)}let{list:n,hasMore:o}=e;this.marks.set("has-more",o),n=(Lc.isArray(n)?n:[]).map((t=>(t.type=me.o6[t.type],t.url=t.type?"/story/_"+t.target.split(",").slice(0,2).join("?cid="):"",s=t.time<s||0===s?t.time:s,t))),this.marks.set("last-time",s),this._table.rows.set(n,{merge:t})}_renderTable(t){return yn.vu.create("tbody",null,t.size?null:yn.vu.create("tr",{className:"table__message"},yn.vu.create("td",{colSpan:"4"},i.vE.i18n("communities.editor.history.empty"))),t.items.map((t=>{let e,s,n="";if(t.data.type&&t.data.type!==me.o6.NO_TARGET){if(t.data.type===me.o6.PERMANENT)s=i.vE.i18n("communities.editor.target."+t.data.type.toString())||"";else{const n=2;e=t.data.action===n?1:2,s=t.data.type===me.o6.STORY?i.vE.i18n("plural.stories",e):i.vE.i18n("plural.comments",e)}n=t.data.url?yn.vu.create("a",{href:t.data.url,target:"_blank"},s):yn.vu.create("span",null,s)}return yn.vu.create("tr",{key:t.id,"data-id":t.id},yn.vu.create("td",null,yn.vu.create("time",{className:"caption hint",dateTime:t.data.datetime},Bc(t.data.datetime).fromNow())),yn.vu.create("td",null,yn.vu.create(bn.N,{name:t.data.moder_name,avatar:t.data.moder_avatar})),yn.vu.create("td",null,t.data.action_text," ",n),t.data.user_name?yn.vu.create("td",null,yn.vu.create(bn.N,{name:t.data.user_name,avatar:t.data.user_avatar})):yn.vu.create("td",null))})),Boolean(this.marks.get("has-more"))&&yn.vu.create("tr",{key:"hasMore"},yn.vu.create("td",{colSpan:"4",className:"community-editor__more"},yn.vu.create("button",{type:"button",className:"button button_small button_width_100"},i.vE.i18n("communities.editor.more")))))}},"community-trusted":class extends xc{render(){if(this.isRendered)return this;super.render(),this.$els={input:this.$('.input[data-role="search"]'),addState:this.$(".community-editor__add"),spinner:this.$('section[data-role="spinner"]'),editor:this.$(".community-editor"),table:this.$('section[data-role="table"]')};let t=this._nameInput=new T.u3({$el:this.$els.input,suggestion:new C.xI({parseFilter:t=>!this._table.rows.items.some((e=>e.data.name===t.name))})});return this.listenTo(t.suggestion,C.nT.CURRENT,(t=>{this.$els.addState.toggleClass("community-editor__add_active",Boolean(t))})),this.listenTo(t.suggestion,C.nT.SELECT,this._onSelectUser),this.listenTo(t,"blur",(()=>t.value="")),this._table=new Jo.$({$parent:this.$els.table,renderBody:this._renderTable.bind(this),header:[["Пользователь",0,"name","string"],["Добавил постов",30,"ban_count"],["",5]]}),this._table.rows.fieldId="user_id",this._loadList(!1,{list:i.vE.config("modules.community-users"),hasMore:this.$els.editor.data("has-more")}),this._table.show(),this._table.$el.on("click",'span[data-role="delete"]',this._onClickRemove.bind(this)),this._table.$el.on("click",".community-editor__more",this._loadList.bind(this,!0,null)),this.$els.spinner.hide(),this.$els.editor.show(),this}async _loadList(t=!1,e){let s=t?this.marks.get("last-id"):0;if(!e||!Fc.isObject(e))try{e=await this.community.loadTrustedUsersList(s)}catch(r){return void i.vE.ui.toasts.showError(r)}let{list:n,hasMore:o}=e;s=n.length?n[n.length-1].user_id:s,this.marks.set("has-more",o),n=Fc.isArray(n)?n:[],this.marks.set("last-id",s),this._table.rows.set(n,{merge:t})}_renderTable(t){return yn.vu.create("tbody",null,t.size?null:yn.vu.create("tr",{className:"table__message"},yn.vu.create("td",{colSpan:"3"},i.vE.i18n("communities.editor.trusted.empty"))),t.items.map((t=>yn.vu.create("tr",{key:t.id,"data-id":t.id},yn.vu.create("td",null,yn.vu.create(bn.N,{key:t.data.name,name:t.data.name,avatar:t.data.avatar})),yn.vu.create("td",null,t.data.stories),yn.vu.create("td",{className:"community-editor__actions"},yn.vu.create("span",{"data-role":"delete"},yn.vu.create(bn.t,{block:"ui__close",modifiers:"table-row"}))))))||null,this.marks.get("has-more")&&yn.vu.create("tr",{key:"hasMore"},yn.vu.create("td",{colSpan:"3",className:"community-editor__more"},yn.vu.create("button",{type:"button",className:"button button_small button_width_100"},i.vE.i18n("communities.editor.more")))))}async _onSelectUser(t){if(this._nameInput.value="",!t)return;let e=t.data.name;if(await pt.g.confirmModal({content:i.vE.i18n("communities.editor.trusted.add",e,t.data.avatar),buttons:[["modal.add",Bs.j.SUCCESS,!0],["modal.cancel"]]}))try{this._loadList(!1,await this.community.addTrustedUser(e))}catch(s){i.vE.ui.toasts.showError(s)}}async _onClickRemove(t){let e=this._table.rows.get(Number(t.currentTarget.closest("tr").getAttribute("data-id")));if(!e||e.marks.has("lock"))return;e.marks.set("lock",!0);let s=await pt.g.confirmBalloon({target:t.currentTarget,content:i.vE.i18n("communities.editor.trusted.remove",e.data.name,e.data.avatar),buttons:[["modal.remove",Bs.j.DANGER,!0],["modal.cancel"]]});if(e.marks.delete("lock"),s)try{await this.community.deleteTrustedUser(e.id),e.destroy()}catch(n){i.vE.ui.toasts.showError(n)}}},"community-voting":class extends Wo{render(){return this.isRendered||(super.render(),this.$el=Qo(".community-voting"),this.$els={selectUser:this.$('.community-voting__select input[type="checkbox"]'),searchUser:this.$(".community-editor__add"),selfRemove:this.$(".community-voting__self-remove"),candidate:this.$(".community-voting__candidate")},this._communityID=this.$el.data("id"),this.$els.selectUser.each(((t,e)=>{let s=new Zo.m({$el:Qo(e)});this.listenTo(s,"change",(()=>{s.checked||this._createModal(s.$els.input.val(),s.$els.input.data("img"))})),this.on("modalCancel",(()=>{s.checked=!1}))})),this.$els.selfRemove.click((()=>{this.community.cancelVotingCandidate().then((()=>{this.$els.candidate.slideUp(400,(()=>{window.location.reload()}))}),(t=>{i.ZP.ui.toasts.showError(t||i.ZP.i18n("moderator-tools.errors.request"))}))})),this.$els.searchUser.length&&(this._searchUser=new T.u3({$el:this.$els.searchUser,suggestion:new C.xI}),this.listenTo(this._searchUser.suggestion,C.nT.SELECT,(t=>{this._createModal(t._data.name,t._data.avatar)})),this.listenTo(this._searchUser,"blur",(()=>this._searchUser.value="")))),this}async _createModal(t,e){if(!t)return void i.ZP.ui.toasts.showError(i.ZP.i18n("moderator-tools.errors.request"));let s={name:t,avatar:e};await pt.g.confirmModal({content:Xo(s),minWidth:500,buttons:[["Да, хочу!",Bs.j.SUCCESS,!0],["Нет, я промазал"]]})?this.community.voteForNewAdmin(t,!0).then((()=>{window.location.reload()}),(t=>{i.ZP.ui.toasts.add({theme:v.K.WARNING,content:t||i.ZP.i18n("moderator-tools.errors.request")})})):this.emit("modalCancel")}}}),i.vE.use({"/@:username":zs,"/@:username/:mode(search|rating|mine|time)":zs,"/@:username/:mode(search|rating|mine|time)/asc":zs}),i.vE.use(new Nn),i.vE.use({"/subs-list":fn,"/subs-list/:typeName":fn,"/notes":class extends Pn{render(){return this.isRendered||(this.$el=Rn(".settings-notes"),this.$els={list:this.$(".settings-notes__list")},this.$els.list.on("click",".settings-note__remove",this._onRemoveClick.bind(this)),i.ZP.ui.screen=lt.d.USER_NOTES,this._initAnalytics(),super.render()),this}_onRemoveClick(t){t.preventDefault();let e=Rn(t.currentTarget).closest(".settings-note");this._removeNoteConfirmation(e,Number(e.data("id")))}_removeNoteConfirmation(t,e){let s=t.find(".user").prop("outerHTML"),n=new k.LD({header:i.ZP.i18n("page-settings.remove-note.header"),indent:!0,content:Rn(document.createElement("span")).html(i.ZP.i18n("page-settings.remove-note.message",s))});n.addButtonIntoFooter("page-settings.remove-note.success",(async()=>{try{await new u.User(e).note()}catch(s){i.ZP.ui.toasts.showError(s)}t.remove(),this.$els.list.find(".settings-note").length||this.$el.attr("data-empty",!0),n.hide()}),Bs.j.DANGER),n.addCloseButtonIntoFooter("page-settings.confirmations.no"),n.show()}}}),i.vE.use(new oo),i.vE.use(new class extends gc{render(){return this.isRendered||(super.render(),this._initMenu()),this}_initMenu(){try{new vc}catch(t){}}}),i.vE.use("/@:username/feedback",bc),i.vE.use("/subscribe-email-success",Za),i.vE.use("banned-users",or),i.vE.use("approved-users",hr),i.vE.use("tags-list",Ir),i.vE.use("tags-merge",Xr),i.vE.use("user-awards-feed",nh),i.vE.use("restore-password",rh),i.vE.use("/my-blog",Md),i.vE.use("/my-blog/story/:id(\\d+)",Bd),i.vE.use(new Wd),i.vE.use("/violation-report",Zd),i.vE.use("/achievements",Qd);var ou=s(1963),ru=s(9922);class au{constructor(t=!1){this._options={excludeUserAgent:!0,userDefinedFonts:["Open Sans","Lato","Presto","Montserrat","PT Serif","Ubuntu","Liberation Mono","Myriad Pro","MYRIAD","MYRIAD PRO","ADOBE CASLON PRO","Adobe Garamond","DejaVu Sans","EmojiOne Color","Ink Free","Aparajita","Apple Chancery","Apple Color Emoji","ZWAdobeF","Fira Sans","Exo 2","Lobster","Philosopher","Prosto One","Yeseva One"],preprocessor:this._preprocessor.bind(this)},this.isMobile=t,this.cname="fps",this.source={},this.fp=new ou.v(this._options)}run(t=9e3){return setTimeout((()=>{this.makeFP(),this._timerId&&clearInterval(this._timerId),this._timerId=setInterval(this.makeFP.bind(this),6e4)}),t),this}makeFP(t){this.getSavedValue()||this.fp.get(((e,s)=>{this.save(e),"function"==typeof t&&t(e,s)}))}getSavedValue(){let t=this._getFromCookies();return t||(t=this._getFromLS(),t&&this._saveToCookies(t)),t}_getFromCookies(){let t=ru.e.get(this.cname);return t&&""!==t&&34===t.length?t:void 0}_getFromLS(){let t=xe.m.get(this.cname,!0);if(t&&t.expires&&!(t.expires<Math.round(Date.now()/1e3)))return t.value&&""!==t.value&&34===t.value.length?t.value:void 0}save(t){let e=this.source.has_lied_browser||this.source.has_lied_os?1:0,s={value:(this.isMobile?"m":"d")+e+t,expires:Math.round(Date.now()/1e3)+172800};return this._saveToCookies(s.value),xe.m.set(this.cname,s),s.value}_saveToCookies(t){ru.e.set(this.cname,t,{expires:new Date(Date.now()+324e5)})}_preprocessor(t,e){return this.source[t]=e,"has_lied_browser"!==t&&("has_lied_os"!==t&&("navigator_platform"!==t&&e))}}var lu=s(8204);s.e(360).then(s.bind(s,5277)),s.e(238).then(s.bind(s,9867));const hu=s(9755);try{let t=/^https?:\/\/(([sv](\d+)|[^.]+)\.)?pikabu\.(ru|lh)$/,e=()=>Array.prototype.slice.call(document.getElementsByTagName("iframe"));window.addEventListener("message",(function(s){let n=t.test(s.origin);if(n&&"getHeight"===s.data){let t=document.body,e=document.documentElement,i=Math.max(t.scrollHeight,t.offsetHeight,e.clientHeight,e.scrollHeight,e.offsetHeight);s.source.postMessage(JSON.stringify({event:"setHeight",height:i}),s.origin)}else if(n||"https://specials-pikabu.ru"===s.origin){let t;try{t=JSON.parse(s.data)}catch(o){}if("object"!=typeof t||!t.hasOwnProperty("event"))return;switch(t.event){case"init":setTimeout((()=>{s.source.postMessage("getHeight","*"),s.source.document&&(s.source.document.body.style.backgroundColor=i.vE.ui.css.colors.bg)}),100);break;case"setHeight":let n=e().find((t=>t.contentWindow===s.source));n&&(n.style.height=Number(t.height||0)+"px")}}})),e().forEach((t=>t.contentWindow.postMessage("getHeight","*"))),window.parent!==window&&window.parent.postMessage('{"event":"init"}',"*")}catch(cu){}i.vE.ready.then((function(){hu.ajaxSetup({headers:{"X-Csrf-Token":i.vE.initParams.csrfToken}}),i.vE.ui=new hs,i.vE.ui.init(),requestAnimationFrame((()=>{i.vE.history.init()})),requestAnimationFrame(()),lu.U.init()})).catch((function(t){i.vE.logger.error("application",t)})),window.__printClientProps=()=>{const t=new cs.U;return{version:t.getVersion(),"cookie name":t.getCookieName(),encoded:t.getCookieValue(),boolean:t.getBoolFieldNames(),"int 8":t.getInt8FieldNames(),"int 16":t.getInt16FieldNames(),"int 32":t.getInt32FieldNames()}}},1835:(t,e,s)=>{"use strict";s.d(e,{$:()=>g});s(8674),s(4916);var i=s(8211),n=s(7025),o=s(2493),r=s(9569),a=s(2025),l=s(3363),h=s(7422),c=s(9050);var d=s(8709),u=s(5304),p=s(9050);const m=new(s(7892).xs)({DELETE_POST:0,DELETE_COMMENT:1,BAN_POST:2,BAN_COMMENT:3,HIDE_COMMENT:4,SHOW_COMMENT:5}),_=s(9755);s(6419);class g extends o.D{constructor(){super()}showDeleteStoryDialog(t,e){this._createBox(t,m.DELETE_POST,e)}showDeleteCommentDialog(t,e){this._createBox(t,m.DELETE_COMMENT,e)}showBanUserDialog(t,e,s,i){const n=1===i?m.BAN_POST:m.BAN_COMMENT;this._createBox(t,n,e,s)}showHideBranchDialog(t,e,s){this._createBox(t,m.HIDE_COMMENT,e,s)}showRestoreBranchDialog(t,e,s){this._createBox(t,m.SHOW_COMMENT,e,s)}moveStoryToCommonFeed(t){let e={action:"move_to_common_feed",story_id:t},s=new n.LD({content:_((0,d.Z)(i.vE.i18n("moderator-tools.modal-box.move-to-common.title")))});s.addCloseButtonIntoFooter(i.vE.i18n("moderator-tools.modal-box.move-to-common.button-cancel")),s.addButtonIntoFooter(i.vE.i18n("moderator-tools.modal-box.move-to-common.button-confirm"),(async()=>{o.c.moderatorAction(e).then((()=>{this.emit("complete")}),(t=>{i.vE.ui.toasts.showError(t||i.vE.i18n("moderator-tools.errors.request"))})),s.hide()}),a.jM.DANGER),s.show()}_createBox(t,e,s,n){void 0===n&&(n=0),this._lastTarget=_(t);const r=e.valueOf();let a=String(r)+"_"+String(s)+"_"+String(n),l=o.D._lastBox;if(l&&l.isShown&&o.D._lastTargetKey===a)return this._lastTargetKey="",void l.hide();this._closeCurrentBox(),o.D._lastTargetKey=a,this._processed=!1;let h={current_ban:null,ban_count_info:null,ban_for_story:0,ban_for_comment:0,message:""};const c=[m.HIDE_COMMENT,m.SHOW_COMMENT].includes(e),d=[m.BAN_POST,m.BAN_COMMENT].includes(e);if(c){const s=()=>{this._processed=!0,this._closeCurrentBox(),this.emit("complete")};l=this._createBalloonBox(e,s,h),o.D._lastBox=l,this.listenTo(o.D._lastBox,"hide",(()=>{o.D._lastBox=null,o.D._lastBox="",this._processed||this.emit("cancel")})),l.isShown||(l.target=t,l.show())}else if(!this._reasons[r]||d){let a="N";void 0===this._reasons[r]&&(a="Y"),o.c.getInfo(r,s,a,n).then((a=>{if(void 0!==a.reasons&&(this._reasons=a.reasons),void 0!==a.ban&&(h.current_ban=a.ban),void 0!==a.ban_count_info&&(h.ban_count_info=a.ban_count_info),void 0!==a.ban_for_story&&(h.ban_for_story=a.ban_for_story),void 0!==a.ban_for_comment&&(h.ban_for_comment=a.ban_for_comment),null!==h.current_ban&&h.current_ban.status)return void this._showBanInfo(this._lastTarget,h.current_ban);if(h.ban_for_story||h.ban_for_comment){if(1===h.ban_for_story)return void i.vE.ui.toasts.showError(i.vE.i18n("moderator-tools.errors.user-post-punished"));if(2===h.ban_for_story)return void(h.message+=i.vE.i18n("moderator-tools.errors.user-post-forgiven"));if(1===h.ban_for_comment)return void i.vE.ui.toasts.showError(i.vE.i18n("moderator-tools.errors.user-comment-punished"));2===h.ban_for_comment&&(h.message+=i.vE.i18n("moderator-tools.errors.user-comment-forgiven"))}l=this._createBalloonBox(e,(t=>{this._doAction(r,s,n,t)}),h),o.D._lastBox=l,this.listenTo(o.D._lastBox,"hide",(()=>{o.D._lastBox=null,o.D._lastBox="",this._processed||this.emit("cancel")})),l.isShown||(l.target=t,l.show())}),(t=>{i.vE.ui.toasts.showError(t||i.vE.i18n("moderator-tools.errors.request"))}))}}_createBalloonBox(t,e,s){let o,l,h=this._reasons[t.valueOf()],d={};switch(t){default:case m.DELETE_POST:d={title:i.vE.i18n("moderator-tools.balloon-box.delete-post.title"),buttonName:i.vE.i18n("moderator-tools.balloon-box.delete-post.button-name"),buttonName2:i.vE.i18n("moderator-tools.balloon-box.delete-post.button-name2"),action:i.vE.i18n("moderator-tools.balloon-box.delete-post.action")};break;case m.DELETE_COMMENT:d={title:i.vE.i18n("moderator-tools.balloon-box.delete-comment.title"),buttonName:i.vE.i18n("moderator-tools.balloon-box.delete-comment.button-name"),buttonName2:i.vE.i18n("moderator-tools.balloon-box.delete-comment.button-name2"),action:i.vE.i18n("moderator-tools.balloon-box.delete-comment.action")};break;case m.BAN_POST:d={title:i.vE.i18n("moderator-tools.balloon-box.ban-post.title"),buttonName:i.vE.i18n("moderator-tools.balloon-box.ban-post.button-name"),buttonName2:i.vE.i18n("moderator-tools.balloon-box.ban-post.button-name2"),action:i.vE.i18n("moderator-tools.balloon-box.ban-post.action")};break;case m.BAN_COMMENT:d={title:i.vE.i18n("moderator-tools.balloon-box.ban-comment.title"),buttonName:i.vE.i18n("moderator-tools.balloon-box.ban-comment.button-name"),buttonName2:i.vE.i18n("moderator-tools.balloon-box.ban-comment.button-name2"),action:i.vE.i18n("moderator-tools.balloon-box.ban-comment.action")};break;case m.HIDE_COMMENT:d={title:i.vE.i18n("moderator-tools.balloon-box.hide-comment-branch.title"),buttonName:i.vE.i18n("moderator-tools.balloon-box.hide-comment-branch.button-name"),buttonName2:i.vE.i18n("moderator-tools.balloon-box.hide-comment-branch.button-name2"),action:i.vE.i18n("moderator-tools.balloon-box.hide-comment-branch.action")};break;case m.SHOW_COMMENT:d={title:i.vE.i18n("moderator-tools.balloon-box.show-comment-branch.title"),buttonName:i.vE.i18n("moderator-tools.balloon-box.show-comment-branch.button-name"),buttonName2:i.vE.i18n("moderator-tools.balloon-box.show-comment-branch.button-name2"),action:i.vE.i18n("moderator-tools.balloon-box.show-comment-branch.action")}}if(!h||_.isEmptyObject(h))l=_((u=d,g="",v=p.escape,g+'<form class="mt__box">\n\t<div class="mt__text">Вы действительно хотите '+v(u.action)+'?</div>\n\t<p>\n\t\t<button class="mt__btn button_danger" data-role="yes">Да, '+v(u.buttonName2)+'</button>\n\t\t\x3c!--<button class="button_danger" data-role="no">Отмена</button>--\x3e\n\t</p>\n</form>\n')),l.find("button").on("click",(t=>{t.preventDefault(),"yes"===_(t.target).data("role")?e("0"):o.hide()}));else{d.reasons=h,s.message&&(d.userBanMsg=s.message),s.ban_count_info&&(d.banCountInfo=s.ban_count_info),l=_(function(t){var e,s="",i=c.escape;Array.prototype.join,s+='<form class="mt__box">\n\t<div class="mt__list">\n\t\t';var n=0;return s+="\n\t\t",c.forEach(t.reasons,(function(t,o){s+='\n\t\t<p class="mt__list-item">\n\t\t\t<label>\n\t\t\t\t<input type="radio" '+(null==(e=0==n++?'checked="checked"':"")?"":e)+'    name="mt_reason" value="'+i(o)+'"> '+i(t.name)+"\n\t\t\t</label>\n\t\t</p>\n\t\t"})),s+='\n\t</div>\n\t<button class="mt__btn button_danger" data-role="yes">'+i(t.buttonName)+"</button>\n\t",t.userBanMsg&&(s+='\n\t<div class="mt__msg">\n\t\t<i class="fa fa-warning"></i> test'+i(t.userBanMsg)+"\n\t</div>\n\t"),s+="\n\t",t.banCountInfo&&(s+='\n\t<div class="mt__ban-info">\n\t\t<a href="'+i(t.banCountInfo.profile)+'" target="_blank">История банов '+i(t.banCountInfo.count)+"</a>\n\t</div>\n\t"),s+="\n</form>"}(d)),new r.x(l.closest("form"));let t=new a.y3(l.find("button"));this.listenTo(t,"click",(s=>{s.preventDefault(),t.progress=!0;let i=l.find("input:checked");if(i.length>0){let t=i.val();e(t)}}))}var u,g,v;return o=new n._({content:l})}editTags(t,e){if(!t||!e.length)return!1;let s=e.find('[data-role="edit-tags"]'),n=e.find('[data-role="save-tags"]'),r=new l.K1({$el:s,maxTags:8,minTags:2});r.suggestion=new h.Z6({tagsLine:!0});let c=r.value,d=new a.y3(n);return setTimeout((()=>{r.focus()}),400),this.listenTo(r,"change",(()=>{d.disabled=c===r.value})),this.listenTo(d,"click",(()=>{let e={action:"set_story_tags",tag:r.value,story_id:t};d.progress=!0,o.c.moderatorAction(e).then((()=>{this.emit("complete")}),(t=>{i.vE.ui.toasts.showError(t||i.vE.i18n("moderator-tools.errors.request")),d.progress=!1}))})),this._showTagsHistory(t,e),!0}_showTagsHistory(t,e){let s={action:"get_tags_history",story_id:t},n=e.find('[data-role="tags-history"]');o.c.moderatorAction(s).then((t=>{t.length&&(t.map((t=>{t.addedTags=[],t.removedTags=[],t.oldTags=[],t.tags_old=t.tags_old.split(", "),t.tags_new=t.tags_new.split(", "),t.tags_new.forEach((e=>{_.inArray(e,t.tags_old)>-1?t.oldTags.push(e):t.addedTags.push(e)})),t.tags_old.forEach((e=>{-1===_.inArray(e,t.tags_new)&&t.removedTags.push(e)}))})),n.append((0,u.Z)(t)))}),(t=>{i.vE.ui.toasts.showError(t||i.vE.i18n("moderator-tools.errors.request"))}))}}},5240:(t,e,s)=>{"use strict";s.d(e,{_:()=>G});s(8674),s(4916),s(6992),s(3948);var i=s(8211),n=s(9626),o=s(8097),r=s(7977),a=s(6553),l=s(6572),h=s(7022),c=(s(5306),s(7025)),d=s(3363),u=s(4519),p=s(3968),m=s(9050);var _=s(9050);const g=s(9755);class v extends u.u1{constructor(t,e){super(t),this.$el&&this.show(),this._analyticsData=e}render(){return this.isRendered?this:(i.ZP.storage["stories-save-cats"]||(i.ZP.storage["stories-save-cats"]=i.ZP.config("modules.stories-save-cats")),this.$el.hasClass("story__save_active")?(this._deleteStory(),this):i.ZP.initParams.isHideSaveMenu?(this._saveStory(-2),this):(this._createPopup(),this._balloon&&this._balloon.show(),super.render(),this))}saveController(t){this.$el=t,this._balloon&&this._balloon.isShown&&this._balloon.hide(),this.$el.hasClass("story__save_active")?this._deleteStory():i.ZP.initParams.isHideSaveMenu?this._saveStory(-2):this._balloon?(this._balloon.target=t,this.$els.catBlocks.removeClass("story-save__cat_added"),this._balloon.show()):this._createPopup()}_createPopup(){let t=(e=i.ZP.storage["stories-save-cats"],s="",n=m.escape,Array.prototype.join,s+='<div class="story-save">\n\t<div class="story-save__cat-list" data-role="cat_list">\n\t\t',m.forEach(e,(t=>{s+='\n\t\t\t<div class="story-save__cat" data-id="'+n(t.id)+'" data-name="'+n(t.name)+'" data-role="add_to_cat_btn">\n\t\t\t\t<i class="story-save__check-icon"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon--ui__check-mark icon--ui__check-mark_size-medium"><use xlink:href="#icon--ui__check-mark"></use></svg></i>\n\t\t\t\t<span class="story-save__name" data-role="cat_name">'+n(t.name)+'</span>\n\t\t\t\t<a class="story-save__link" target="_blank" href="/saved-stories/'+n(t.id)+'">\n\t\t\t\t\t<svg xmlns="http://www.w3.org/2000/svg" class="icon icon--ui__external icon--ui__external_size-medium"><use xlink:href="#icon--ui__external"></use></svg>\n\t\t\t\t</a>\n\t\t\t\t<span class="story-save__count" data-role="cat_counter">'+n(t.count)+"</span>\n\t\t\t</div>\n\t\t"})),s+='\n\t</div>\n\t<div class="input input_box input_flat input_gray story-save__add-b" data-role="create_new_block">\n\t\t<button class="input__icon button_link story-save__add-bnt" data-role="add_btn"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon--ui__plus icon--ui__plus_size-middle"><use xlink:href="#icon--ui__plus"></use></svg></button>\n\t\t<span class="input__box">\n\t\t\t<input class="input__input story-save__add-input" maxlength="25" data-role="create_new" placeholder="Новая категория" name="create_new_cat" value="" autocomplete="off">\n\t\t</span>\n\t</div>\n</div>\n\n');var e,s,n;this._balloon=new c._({target:this.$el,direction:c.Lh.BOTTOM,content:t}),this.$els={},this.$els.block=this._balloon.content,this.$els.catList=this.$els.block.find('[data-role="cat_list"]'),this.$els.catBlocks=this.$els.catList.find('[data-role="add_to_cat_btn"]'),this.$els.addNewCatBtn=this.$els.block.find('[data-role="add_btn"]'),this.$els.block.on("click",'[data-role="add_to_cat_btn"]',(t=>{g(t.target).hasClass("story-save__link")||(t.preventDefault(),this._saveStory(g(t.target)))})),this._addInput=new d.u3({$el:this.$els.block.find('[data-role="create_new_block"]'),addClearButton:!1}),this.listenTo(this._addInput,"input",(()=>{""!==this._addInput.value?this.$els.addNewCatBtn.addClass("story-save__svg-green"):this.$els.addNewCatBtn.removeClass("story-save__svg-green")})),this.$els.block.find('[data-role="create_new_block"]').on("keypress",(t=>{13!==event.which&&13!==event.keyCode||(t.preventDefault(),this._createNewCategory())})),this.$els.addNewCatBtn.on("click",(t=>{t.preventDefault(),this._createNewCategory()})),this._balloon.show()}_createNewCategory(){let t=this._addInput;t.value.length&&(this._isNameAvailable(t.value)?p.YD.add(t.value).then((e=>{let s={id:e,name:t.value,count:0},n=g((o=s,r="",a=_.escape,r+'<div class="story-save__cat" data-id="'+a(o.id)+'" data-name="'+a(o.name)+'" data-role="add_to_cat_btn">\n\t<i class="story-save__check-icon"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon--ui__check-mark icon--ui__check-mark_size-medium"><use xlink:href="#icon--ui__check-mark"></use></svg></i>\n\t<span class="story-save__name" data-role="cat_name">'+a(o.name)+'</span>\n\t<a class="story-save__link" target="_blank" href="/saved-stories/'+a(o.id)+'">\n\t\t<svg xmlns="http://www.w3.org/2000/svg" class="icon icon--ui__external icon--ui__external_size-medium"><use xlink:href="#icon--ui__external"></use></svg>\n\t</a>\n\t<span class="story-save__count" data-role="cat_counter">'+a(o.count)+"</span>\n</div>\n\n\n"));var o,r,a;this.$els.catList.append(n),this.$els.catBlocks=this.$els.catList.find('[data-role="add_to_cat_btn"]'),i.ZP.storage["stories-save-cats"].push(s),t.value="";let l=this.$els.catList[0].scrollHeight;this.$els.catList.animate({scrollTop:l},400)}),(t=>{i.ZP.ui.toasts.showError(t||"story-save.message.bad")})):i.ZP.ui.toasts.showError("story-save.message.cat-duplicate"))}_isNameAvailable(t){let e=t.trim().toLowerCase().replace(/^\s+|\s+$/g,"");return i.ZP.storage["stories-save-cats"].every((t=>t.name.trim().toLowerCase().replace(/^\s+|\s+$/g,"")!==e))}_saveStory(t){let e,s,n,o,r,a="number"==typeof t&&-2===t;a?n=t:(e=t.closest('[data-role="add_to_cat_btn"]'),s=e.find('[data-role="cat_counter"]'),r=Number(s.text()),n=Number(e.data("id")),o=e.data("name"));const l=this.$el.data("story-id");p.YD.addOrRemoveStory(!0,l,n,o,this._analyticsData).then((t=>{this.$el.addClass("story__save_active");let n=this.$el.find(".story__save-count");n.length&&n.text(Number(n.text())+1),i.ZP.storage["stories-save-cats"].map((e=>{t===e.id&&(e.count=Number(e.count)+1)})),a||(s.text(r+1),e.addClass("story-save__cat_added"),this._balloon.hide(),this._hint=new c._({target:this.$el,content:`<span class="story-save__hint">Сохранено в «${o}»</span>`}),this._hint.show(),this.timeout("hide-hint",2e3,this._hint.hide.bind(this._hint)))}),(t=>{i.ZP.ui.toasts.showError(t||"story-save.message.bad")}))}_deleteStory(){const t=this.$el.data("story-id");p.YD.addOrRemoveStory(!1,t).then((t=>{this.$el.removeClass("story__save_active");let e=this.$el.find(".story__save-count");e.length&&e.text(Number(e.text())-1),i.ZP.storage["stories-save-cats"].map((e=>{t===e.id&&(e.count=e.count-1,this._balloon&&this.$els.catBlocks.filter(`[data-id="${t}"]`).find('[data-role="cat_counter"]').text(e.count))}))}),(t=>{i.ZP.ui.toasts.showError(t||"story-save.message.bad")}))}}var f=s(1835),y=s(4473),b=s(5494),w=s(103),E=s(4644),S=s(9569),C=s(4122),T=s(2308),O=s(2822);function k(t,e,s){return e in t?Object.defineProperty(t,e,{value:s,enumerable:!0,configurable:!0,writable:!0}):t[e]=s,t}class I{constructor(){k(this,"_mainStory",null),k(this,"_isMainStoryInViewport",!1),k(this,"_relatedStoriesInViewport",[])}static getInstance(){return I.instance?I.instance:I.instance=new I}setViewportForAnalytics(t,e){if(!t||!t.length&&"related"!==e)return;if("adverts"===e)return;const s="story"===e,i="related"===e;s||i?this._findStoryInViewportOnStoryPage(t,s,i):this._findStoryinViewportOnFeed(t)}_checkStoryForViewport(t){const e=i.vE.ui.scrollTop,s=i.vE.ui.windowHeight*a.VIEWPORT_LIMIT,n=t.offsetTop-e;return n+t.offsetHeight>=a.VIEWPORT_START&&n<s}_findStoryInViewportOnStoryPage(t,e,s){if(e&&(this._mainStory=t[0],this._isMainStoryInViewport=this._checkStoryForViewport(this._mainStory),this._isMainStoryInViewport||(this._mainStory.inViewportForAnalytics=!1)),s){if(t&&0===t.length)return void(this._mainStory.inViewportForAnalytics=this._isMainStoryInViewport);if(this._relatedStoriesInViewport=t.filter((t=>this._checkStoryForViewport(t))),0===this._relatedStoriesInViewport.length)return t.forEach((t=>t.inViewportForAnalytics=!1)),void(this._mainStory.inViewportForAnalytics=this._isMainStoryInViewport);{this._mainStory.inViewportForAnalytics=!1;const e=this._relatedStoriesInViewport[this._relatedStoriesInViewport.length-1];for(const s of t)s.inViewportForAnalytics=s===e}}}_findStoryinViewportOnFeed(t){const e=t.filter((t=>this._checkStoryForViewport(t))),s=e[e.length-1];for(const i of t)i!==s&&(i.inViewportForAnalytics=!1);s&&(s.inViewportForAnalytics=!0)}}var $=s(4877),A=s(8245);const x="recommended-community",D=x,P=`${x}__link`;var R,M=s(3040);function N(t,e){var s=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),s.push.apply(s,i)}return s}function B(t,e,s){return e in t?Object.defineProperty(t,e,{value:s,enumerable:!0,configurable:!0,writable:!0}):t[e]=s,t}!function(t){t.Recommended="rec",t.Raw="raw"}(R||(R={}));class L extends $.u{constructor(t){super({el:t}),B(this,"clientProperties",new M.U),B(this,"isTagsPage",!1),this.show()}render(){if(this.isRendered)return this;const t=A.S.getInstance().get("UICarousel"),e={clientPropertyKey:"recComBlockTime",clientPropertyMS:Math.round(Date.now()/1e3/60/60)};return this.isTagsPage=["stories-search","search"].includes(i.ZP.initParams.pageName),this.isTagsPage?this.carousel=new t({el:this.el,useEmitter:!1,tempHidingConfig:e,contextMenu:!0,storageKey:"recComBlockTime",analytics:{onBlockShow:"communities_with_tag"}}):(this.carousel=new t({el:this.el,useEmitter:!0}),this.listenToOnce(this.carousel,"carouselHidden",this.setTemporarilyHidden.bind(this)),this.blockType===R.Raw&&this.listenToOnce(this.carousel,"carouselShown",(()=>{O.c.getInstance().sendEvent("reach_element",{type:"community_raw_in_feed"})}))),this.initLinkClick(),this}initLinkClick(){var t,e;const s=t=>{var e;this.sendAnalytics(t),this.isTagsPage?null===(e=this.carousel)||void 0===e||e.setTemporarilyHidden():this.setTemporarilyHidden()};null===(t=this.carousel)||void 0===t||t.els.content.addEventListener("click",s),null===(e=this.carousel)||void 0===e||e.els.content.addEventListener("auxclick",s)}sendAnalytics(t){var e;if(!(t.target instanceof HTMLElement&&t.target.closest("."+P)))return;const s=null===(e=this.carousel)||void 0===e?void 0:e.els.content.querySelectorAll(".carousel__item"),i=t.target.closest("."+D),n=null==i?void 0:i.querySelector('[data-role="subscribe"]'),o=null==n?void 0:n.children[0],r=n instanceof HTMLElement?Number(n.dataset.id):null,a=s&&i?Array.from(s).indexOf(i)+1:null;let l={};if(r&&null!=o&&o.dataset.analytics){try{l=JSON.parse(o.dataset.analytics)}catch(h){return}this.isTagsPage?O.c.getInstance().sendEvent("transition_to_community",{type:"communities_with_tag",community_id:r,screen_index:a}):O.c.getInstance().sendEvent("transition_to_community",function(t){for(var e=1;e<arguments.length;e++){var s=null!=arguments[e]?arguments[e]:{};e%2?N(Object(s),!0).forEach((function(e){B(t,e,s[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(s)):N(Object(s)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(s,e))}))}return t}({community_id:r},l))}}setTemporarilyHidden(){const t=Math.round(Date.now()/1e3/60/60);this.clientProperties.set("recComBlockTime",t)}get blockType(){var t,e;return null===(t=this.el)||void 0===t||null===(e=t.dataset)||void 0===e?void 0:e.type}}var F=s(1778),U=s(2134);var j=s(4069);class V extends $.u{constructor(t){super({el:t}),this.el&&this.show()}render(){return this.isRendered||new F.v({el:this._options.el,getHideBlockPromise:()=>class{static async hideBlock(){const{response:t,data:e}=await U.cf.post("/ajax/users_actions.php",{action:"hide_new_subs_block"});if(!t.result)throw new Error(t.message);return e}}.hideBlock(),analyticsParams:{contentType:"subs_new_in_feed",onStoryClickEvent:"transition_to_tab",onStoryClickType:"subs_new_in_feed_post",followBtnClickType:"subs_new_in_feed_button",level:j.L.my_lent}}),this}}var H=s(8487);const q=s(6419),W=s(9755);class G extends n.nT{constructor(t){if(super(t),this.stories.DataObject=r.s6,this._firstJump=i.vE.ui.scrollTop<50,this.show(),this.isPaginationMode&&"story"!==this.feedName){let t=this._detectNeedScrolling();t&&this.changeStory(t)}this._storiesInViewport();const e=this.$(".recommended-communities");e.length&&new L(e[0]);const s=this.$(".carousel_short-stories");s.length&&new V(s[0])}render(){return this.isRendered||(this.$els={container:this.$("."+n.FG.container),spinner:this.$("."+n.FG.spinner),spinnerBefore:this.$("."+n.FG.spinnerBefore),loadingBefore:this.$("."+n.FG.loadingBefore).on("click",(async()=>{this.$els.loadingBefore.toggle(!1),await this.loadStoriesByIds(null,!0),this.$els.loadingBefore.toggle(this.storiesBefore.length>0)})),message:this.$("."+n.FG.message.item),pagination:W("."+n.FG.pagination),hiddenCounter:W("."+n.FG.hiddenCounter.item),messageSubs:this.$("."+n.FG.messageSubs.item),relatedStoriesAdv:this.$("."+n.FG.relatedStoriesAdv),adDisclaimer:this.$("."+n.FG.adDisclaimer)},"story"!==this.feedName&&"story-preview"!==this.feedName&&"adverts"!==this.feedName||(this.$els.container=this.$el),this._options.hiddenStories=this.$els.hiddenCounter.data("amount"),this._showSubsStub=!this.$els.container.find(`.${r.lO.item}`).length,this._init(),this.$els.adDisclaimer.length&&this._checkAd(),super.render()),this}_init(){return this._createLoadAnimation(),this._createLoadAnimationBefore(),this._getOptionsFromData(),this._attachTools(),this._attachMouseHoverStory(),this._attachHotkeys(),this._initHotkeysListeners(),["community-queue"].includes(this.feedName)||this._attachDetectFocusIn(),this._attachScroll(),this._attachSocialButton(),this._attachStorySave(),this._attachModeratorTools(),["hot","new","best","search","community","community-search","profile-search","subscriptions"].includes(this.feedName)&&(this.isRestoreStateMode=!0,this.loadStateSnapshot()),this.initStories(),this.assignScreenIndex(),this._initFeedNotifications(),this._initAnalytics(),this._initAdAnalytics(),"adverts"===this.feedName&&this._initUnderCommentsAdAnalytics(),this}_initFeedNotifications(){const t=this.$el.find(".stories-feed__rec-message");if(!t.length)return;t.find("button").on("click",(()=>{i.eR.set("rec_feed_message_shown",!0,{expires:365}),t.remove()}))}_initAnalytics(){const t=this.$els.message.data("type");t&&!["read_all_posts","more_votes_advice"].includes(t)&&this.$els.message.hasClass(n.FG.message.show)&&O.c.getInstance().sendEvent("reach_element",{type:t})}_initAdAnalytics(){C.Q.instance.watch(this.$els.relatedStoriesAdv,T.L.FEED)}_initUnderCommentsAdAnalytics(){C.Q.instance.watch(this.$el,T.L.UNDER_COMMENTS)}_updateTitle(t){document.title=t}_updateMenuCaption(t){}_storiesInViewport(t){if(h.I.isSupported&&h.I.isFullScreen||this.marks.has("orientationStoryId"))return this;t=t||i.vE.ui.scrollTop;const e=.6*i.vE.ui.windowHeight;let s=!1;"adverts"!==this.feedName&&0!==this.feedName.length&&I.getInstance().setViewportForAnalytics(this.stories.items,this.feedName);for(let n=0,o=this.stories.items.length;n<o;n++){const o=this.stories.items[n];let r=o.offsetTop,a=o.offsetHeight,l=r-t,h=l+a,c=l<=e&&h>=150;c&&(s||(s=!0,i.vE.ui.isPositionSticky||(this.currentScrollStoryId=l<0&&l>140-a&&o.id),this.isExpandedMode&&(this._firstJump?this._firstJump=!1:(this.mouseStoryId!==o.id&&this.marks.set("mouseStoryIdNeedsUpdate",!0),this.navigationStoryId=this.mouseStoryId=o.id),o.setCurrentPlayer())),o.updateViewBounds()),o.isMetrikaVisited||!o.inViewport||c||"story"===this.feedName||"story-preview"===this.feedName||(o.isMetrikaVisited=!0,O.c.getInstance().yandex.goal("one-scrolled-story")),o.inViewport!==c&&(o.inViewport=c)}return s||i.vE.ui.isPositionSticky||(this.currentScrollStoryId=!1),this.viewObserver.update(),this}async scrollTo(t,e=!1){this.marks.set("scrolling",!0),await i.vE.ui.scrollTo(t,e),await l.cQ.delay(150),this.marks.delete("scrolling")}_attachTools(){return super._attachTools(),this.$el.on("click",".story__scroll-next-btn",(t=>{let e=W(t.target),s=e.closest(".story").data("story-id");e.hasClass("story__scroll-next-btn")&&(e.addClass("story__scroll-next-btn_unhoverable"),this.timeout("post-remove-unhoverable",500,(()=>{e.removeClass("story__scroll-next-btn_unhoverable")})),this.focused&&"story"!==this.feedName&&"story-preview"!==this.feedName&&(O.c.getInstance().yandex.goal("story_move-to-next"),this.navigationStoryId=s,this._toNextStory()))})),this.$els.message.on("click",".button_link",(t=>{this._toCalendar(),t.preventDefault()})),this}_attachSocialButton(){return this._socialButtons=new y.B(this),this}_attachStorySave(){let t;return this.$el.on("click",".story__save",(e=>{O.c.getInstance().yandex.goal("tap-post-save"),O.c.getInstance().google.event("save","post");const s=this.stories.get(W(e.currentTarget).data("story-id"));O.c.getInstance().sendEvent("click",{type:"save_post",post_id:s.id});let n={};s&&(n={post_id:s.id,author_id:s.authorId,"type_i8!empty":s.subsCode,pluses:s.pluses,minuses:s.minuses,comments:s.commentsCount}),i.vE.isUserAuthorized?i.vE.isLostAccount?i.vE.ui.toasts.showWarningMessage(i.ZF.LOST_ACCOUNT):!t||t.isDestroyed?t=new v(W(e.currentTarget),n):t.saveController(e.currentTarget):i.vE.ui.authRequired()})),this}_attachModeratorTools(){if(!this.$el.find(".story__mods-list").length)return;this.$el.on("click",'.story__mod[data-role="sharing"]',(t=>{t.stopPropagation(),t.preventDefault();const e=W(t.currentTarget).data("story-id");e&&(new f.$).markStoryShared(e)})),this.$el.on("click",'.story__mod[data-role="ban"]',(t=>{t.stopPropagation(),t.preventDefault();let e=W(t.currentTarget),s=e.data("user-id"),i=e.data("story-id");s&&i&&(new f.$).on("complete",(function(){e.addClass("story__mod_active")})).showBanUserDialog(t.target,s,i,1)})),this.$el.on("click",'.story__mod[data-role="delete"]',(t=>{t.stopPropagation(),t.preventDefault();let e=W(t.currentTarget).data("story-id");if(!e)return;let s=W(".story__header",".story").addClass("story__header_highlight");(new f.$).on("complete",(function(){i.vE.history.replaceUrl(window.location.pathname+window.location.search),window.location.reload()})).on("cancel",(function(){s.removeClass("story__header_highlight")})).showDeleteStoryDialog(t.currentTarget,e)})),this.$el.on("click",`.${r.lO.moderator.button}[data-role^="restore"]`,(t=>{t.stopPropagation(),t.preventDefault();let e=W(t.currentTarget);e.attr("disabled","disabled");let s=e.attr("data-story-id");s&&(new f.$).on("cancel",(function(){e.removeAttr("disabled")})).on("complete",(function(){e.fadeOut(),window.location.reload()})).restoreStory(s)})),this.$el.on("click",".story__mod-btn_18",(t=>{t.stopPropagation(),t.preventDefault();let e=W(t.currentTarget).closest(".story__mod-btn"),s=e.data("story-id"),i=!e.data("18");s&&(new f.$).on("complete",(function(){e.toggleClass(" story__mod-btn_18-active",i).data("18",i)})).setStoryAdultFlag(e,s,i)})),this.$el.on("click",".story__mod-btn_my",(t=>{t.stopPropagation(),t.preventDefault();let e=W(t.currentTarget).closest(".story__mod-btn"),s=e.data("story-id"),i=!e.data("my");s&&(new f.$).on("complete",(function(){e.toggleClass("story__mod-btn_my-active",i).data("my",i)})).setStoryAuthorsFlag(e,s,i)})),this.$el.on("click",".story__mod-btn_feed",(t=>{t.stopPropagation(),t.preventDefault();let e=W(t.currentTarget).closest(".story__mod-btn"),s=e.data("story-id"),i=!e.data("feed");s&&(new f.$).on("complete",(function(){e.toggleClass("story__mod-btn_feed-active",i).data("feed",i),e.next(".story__mod-text").remove()})).setStoryVisibilityFlag(e,s,i)})),this.$el.on("click",'.story__mod[data-role="move"]',(t=>{t.stopPropagation(),t.preventDefault();let e=W(t.currentTarget).data("story-id");e&&(new f.$).on("complete",(function(){window.location.reload()})).moveStoryToCommonFeed(e)})),this.$el.on("click",'.story__mod[data-role="history"]',(t=>{t.stopPropagation(),t.preventDefault();let e=W(t.target),s=this.$el.find(".story__restore-history");s.length&&(e.toggleClass("story__mod_active"),s.slideToggle())}));let t=!1;this.$el.on("click",".story__tags-edit_mod",(e=>{e.stopPropagation(),e.preventDefault();let s=W(e.currentTarget),i=s.data("story-id"),n=this.$(".mt__tags");n&&i&&(t||(t=(new f.$).on("complete",(function(){window.location.reload()})).editTags(i,n)),s.toggleClass("story__tags-edit_active"),n.slideToggle())}))}_attachDetectFocusIn(){return this.$el.on("mouseenter",q.throttle((()=>this.focused=!0),50)),this}_attachMouseHoverStory(){let t;return this.$el.on("mousemove",`.${r.lO.item}`,q.throttle((e=>{(t!==e.currentTarget||this.marks.has("mouseStoryIdNeedsUpdate"))&&(t=e.currentTarget,this._mouseEnterDisable||this.marks.has("scrolling")||(this.marks.delete("mouseStoryIdNeedsUpdate"),this.mouseStoryId=n.nT.getStoryIdByElement(e.target)))}),50)),this}_initHotkeysListeners(){i.vE.on("pauseHotkeys",(()=>{i.vE.ui.hotkeys.off()})),i.vE.on("restoreHotkeys",this._attachHotkeys.bind(this))}_attachHotkeys(){return i.vE.ui.hotkeys.on(["w","add"],(()=>{if(!this.mouseStoryId||!this.focused)return;let t=this.stories.get(this.mouseStoryId);t&&this._voteStory(t,a.STORY_VOTE.UP,!0)}),{type:o.FM.KEYDOWN,repeat:!1}),i.vE.ui.hotkeys.on(["s","subtract"],(()=>{if(!this.mouseStoryId||!this.focused)return;let t=this.stories.get(this.mouseStoryId);t&&this._voteStory(t,a.STORY_VOTE.DOWN,!0)}),{type:o.FM.KEYDOWN}),i.vE.ui.hotkeys.on(["a","numpad4"],(()=>{this.focused&&"story"!==this.feedName&&"story-preview"!==this.feedName&&this._toPrevStory()})),i.vE.ui.hotkeys.on(["d","numpad6"],(()=>{this.focused&&"story"!==this.feedName&&"story-preview"!==this.feedName&&this._toNextStory()})),i.vE.ui.hotkeys.on("e",(()=>{if(!this.focused||!this.navigationStoryId||"story"===this.feedName&&"story-preview"!==this.feedName)return;let t=this.stories.get(this.navigationStoryId);if(!t||t.isCommentsDisabled)return;i.vE.ui.header.hideNext=!0;let e=window.open(t.titleLink+"#comments","_blank");try{e.focus()}catch(s){}})),i.vE.ui.hotkeys.on("x",(()=>{let t=this.stories.get(this.navigationStoryId);t&&this.focused&&this.scrollTo(t.offsetTop-10,!0)}),{type:o.FM.KEYDOWN}),"story"===this.feedName?this._attachHotkeyStoryPage():i.vE.ui.hotkeys.on("f",(()=>{let t=this.stories.get(this.navigationStoryId);t&&this.focused&&t.isLongStory&&(t.isCollapsedLongStory=!1)}),{type:o.FM.KEYDOWN}),i.vE.ui.player.attachHotkey(),this}_attachHotkeyStoryPage(){return i.vE.ui.hotkeys.on("q",(()=>{window.opener&&(window.opener.focus(),window.close())})),this}_onToolClick(t,e,s){Array.isArray(e)||(s=e,e=[]);const i=this.stories.get(n.nT.getStoryIdByElement(s.target));i&&!0===t.call(this,i,...e)&&s.preventDefault()}_showSimilarStories(t){const e=new c._({target:t.$el.find(`.${r.lO.footer}`),showArrow:!1,addOverlay:!0,autoCorrectPosition:!1,width:"100%"});this._similarStories=new w.Bi({$parent:e.content,type:w.VQ.STORY,storyId:t.id}),this._similarStories.show(),this.listenTo(this._similarStories,"update",(()=>{e.updatePosition(),e.updateWidth()})),e.show()}_readMore(t){return t&&t.isLongStory&&(t.isCollapsedLongStory=!1),!0}_toNextStory(){let t=this.navigationStoryId?this.stories.nextId(this.navigationStoryId):this.stories.firstId();const e=this.stories.get(t);e&&e.isHidden&&(t=this.stories.nextId(t));let s=this.stories.get(this.navigationStoryId);return s&&this.viewObserver.setVisit(s),t?(this.changeStory(t),this):(this.isPaginationMode&&"related"!==this.feedName&&this._toPage(!0),this)}_toPrevStory(){if(this.isExpandedMode&&this.navigationStoryId){let t=this.stories.get(this.navigationStoryId);if(t&&i.vE.ui.scrollTop-t.offsetTop>200)return i.vE.logger.log("stories-feed","before"),this.changeStory(this.navigationStoryId),this}let t=this.navigationStoryId?this.stories.prevId(this.navigationStoryId):this.stories.firstId();const e=this.stories.get(t);return e&&e.isHidden&&(t=this.stories.prevId(t)),t?(this.changeStory(t),this):(this.isPaginationMode&&"related"!==this.feedName&&this._toPage(!1),this)}_toPage(t){let e=Math.max(1,Math.min(this.page+(t?1:-1),this._options.lastPage));return e!==this.page&&(i.vE.history.searchParams.set("page",e),i.vE.history.searchParams.set("scrollto",t?"first":"last"),i.vE.history.location.href=i.vE.history.location.pathname+"?"+i.vE.history.searchParams.toString()),this}changeStory(t){super.changeStory(t);const e=this.stories.get(t);return b.$.request((()=>{this.scrollTo(e.offsetTop-13,!i.vE.ua.safari)})),this}async _toCalendar(){await this.scrollTo(i.vE.ui.$els.main.offset().top,!0),i.vE.emit("ui-calendar-feed-popup:open")}initStories(){i.vE.ui.player.init(this.$els.container);let t=q.map(this.$els.container.find(`.${r.lO.item}`),(t=>{let e=parseInt(t.getAttribute("data-story-id"),10),s=t.getAttribute("data-vid"),i=new Date(1e3*t.getAttribute("data-timestamp")),n=!!s&&s.charCodeAt(0)-65<=i.getUTCHours();if(this.useEmptyIds||!isNaN(e)&&0!==e&&!n)return this.stories.hasById(e)?this.stories.get(e):new this.stories.DataObject(e,t,this.referrerStoryId);C.Q.instance.watch(t,T.L.FEED)}));return this.stories.set(t,{uniq:!0}),!this.stories.size||this.navigationStoryId&&this.stories.hasById(this.navigationStoryId)||(this.navigationStoryId=this.mouseStoryId=0),this.initLazyLoad(),this.initVoteAnnouncement(),this._initStats(),this}initSubscriptionForm(){const t=this.$("."+n.FG.emailForm);t.length&&(this._subscriptionForm=new E.o({$el:t,formClass:S.x,inputClass:d.u3,isFeedElement:!0,type:"feed"}))}async _checkAd(){const t=await i.vE.adblock.ready;void 0===window.isABPEnabled?(window.isABPEnabled=Boolean(await(0,H.pJ)()),t&&window.isABPEnabled&&this.$els.adDisclaimer.removeClass("hidden")):window.isABPEnabled&&this.$els.adDisclaimer.removeClass("hidden")}get currentScrollStoryId(){return this._options.currentScrollStoryId}set currentScrollStoryId(t){let e,s=this._options.currentScrollStoryId;s!==(t="boolean"==typeof t?0:Number(t))&&(this._options.currentScrollStoryId=t,s&&(e=this.stories.get(s),e.scrollMode=!1),t&&(e=this.stories.get(t),e.scrollMode=!0))}}},8705:(t,e,s)=>{"use strict";s.d(e,{DV:()=>n.DV,$m:()=>w,_D:()=>i._,RP:()=>b,pd:()=>O});var i=s(5240),n=s(9626),o=(s(8674),s(8211));s(3274),s(6777);s(9755);var r=s(4519),a=s(7025),l=s(5494);function h(t){var e,s="";Array.prototype.join;return s+='<form class="stories-feed-filter">\n\t',"hot"!==t.feedName||t.isSubsMode||(s+='\n\t\t<label class="stories-feed-filter__field">\n\t\t\t<span class="stories-feed-filter__title">Сортировать по времени</span>\n\t\t\t<input class="checkbox_switch" type="checkbox" name="isSortedByTime" value="true" data-to-boolean="true" '+(null==(e=t.isSortedByTime?'checked="checked"':"")?"":e)+">\n\t\t</label>\n\t\t<hr>\n\t"),s+="\n\n\t"+(null==(e=t.dateFilterTemplate)?"":e)+'\n\n\t<label class="stories-feed-filter__field" data-role="hide-visited">\n\t\t<span class="stories-feed-filter__title">Просмотренные</span>\n\t\t<select data-role="listbox" name="displayMode">\n\t\t\t<option value="0" '+(null==(e=0===t.displayMode?'selected="selected"':"")?"":e)+'>показывать</option>\n\t\t\t<option value="1" '+(null==(e=1===t.displayMode?'selected="selected"':"")?"":e)+'>сворачивать</option>\n\t\t\t<option value="2" '+(null==(e=2===t.displayMode?'selected="selected"':"")?"":e)+">скрывать</option>\n\t\t</select>\n\t</label>\n\n\t",t.isUserAuthorized&&(s+='\n\t\t<label class="stories-feed-filter__field">\n\t\t\t<span class="stories-feed-filter__title">Показывать NSFW-контент</span>\n\t\t\t<input type="checkbox" name="isAdultVisible" class="checkbox_switch" value="true" data-to-boolean="true" '+(null==(e=t.isAdultVisible?'checked="checked"':'data-confirm-adult="1"')?"":e)+">\n\t\t</label>\n\t"),s+="\n</form>\n"}var c=s(6572),d=(s(2906),s(2630),s(2822)),u=s(9569),p=s(150);function m(t){var e,s="";Array.prototype.join;return t.isDateFilterOnly&&(s+='\n\t<form class="stories-feed-filter">\n'),s+="\n\t\n\t","most-saved"!==t.feedName&&(t.isDisableCalendar||t.isSubsMode||"best"!==t.feedName)||(s+='\n\t\t<label class="stories-feed-filter__field">\n\t\t\t<input type="radio" name="time" value="today" '+(null==(e=t.date&&"today"!==t.date?"":'checked="checked"')?"":e)+'>\n\t\t\t<span class="stories-feed-filter__title">За сегодня</span>\n\t\t</label>\n\t\t<label class="stories-feed-filter__field">\n\t\t\t<input type="radio" name="time" value="week" '+(null==(e="week"===t.date?'checked="checked"':"")?"":e)+'>\n\t\t\t<span class="stories-feed-filter__title">За неделю</span>\n\t\t</label>\n\t\t<label class="stories-feed-filter__field">\n\t\t\t<input type="radio" name="time" value="month" '+(null==(e="month"===t.date?'checked="checked"':"")?"":e)+'>\n\t\t\t<span class="stories-feed-filter__title">За месяц</span>\n\t\t</label>\n\t\t<label class="stories-feed-filter__field">\n\t\t\t<input type="radio" name="time" value="all_time" '+(null==(e="all"===t.date?'checked="checked"':"")?"":e)+'>\n\t\t\t<span class="stories-feed-filter__title">За всё время</span>\n\t\t</label>\n\t'),s+="\n\t\n\t",t.isDisableCalendar||t.isSubsMode||(s+='\n\t\t<p class="stories-feed-filter__field'+(null==(e="range"===t.date?" stories-feed-filter__field_current":"")?"":e)+'" data-role="calendar">\n\t\t\t<svg xmlns="http://www.w3.org/2000/svg" class="icon icon--ui__calendar icon--ui__calendar_modal"><use xlink:href="#icon--ui__calendar"></use></svg> <span class="stories-feed-filter__title">'+(null==(e="range"===t.date&&"today"!==t.date?t.dateCaption:"Выбрать дату")?"":e)+'</span>\n\t\t</p>\n\t\t<p class="stories-feed-filter__field" data-role="random">\n\t\t\t<svg xmlns="http://www.w3.org/2000/svg" class="icon icon--ui__random icon--ui__random_modal"><use xlink:href="#icon--ui__random"></use></svg> <span class="stories-feed-filter__title">Случайная дата</span>\n\t\t</p>\n\t\t',t.isDateFilterOnly||(s+="\n\t\t<hr>\n\t\t"),s+="\n\t"),s+="\n\t\n",t.isDateFilterOnly&&(s+="\n</form>\n"),s+="\n\t"}function _(t,e){var s=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),s.push.apply(s,i)}return s}function g(t){for(var e=1;e<arguments.length;e++){var s=null!=arguments[e]?arguments[e]:{};e%2?_(Object(s),!0).forEach((function(e){v(t,e,s[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(s)):_(Object(s)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(s,e))}))}return t}function v(t,e,s){return e in t?Object.defineProperty(t,e,{value:s,enumerable:!0,configurable:!0,writable:!0}):t[e]=s,t}const f=s(9755);class y extends n.mC{constructor(t){super(t),v(this,"_initDateForm",(()=>{const t=this.dateFilterPopup.content;if(!t)return;const e=new u.x(t),s=t.find('p[data-role="calendar"]');this.$els.calendarCustom={el:s,title:s.find(".stories-feed-filter__title")},this.listenTo(e,"change",this._handleDateFormChange.bind(this)),t.on("mouseenter",'p[data-role="calendar"]',(()=>{this.$els.calendarCustom.el.data("hint")||(this.calendarPopup.target=this.$els.calendarCustom.el,this.calendarPopup.onMouseEnter())})),t.on("click",'p[data-role="calendar"]',(()=>{this.calendarPopup.target=this.$els.calendarCustom.el,this.calendarPopup.show()})),t.on("click",'p[data-role="random"]',(()=>{this.calendar.setRangeByType("random",this.feedType!==n.DV.MOST_SAVED),this.calendar.datesRangeMode&&this._onSelectRange(),this._dateFilterPopup.hide()}))})),this.$el&&this.show()}render(){if(this.isRendered)return this;super.render(),this.$els=g(g({},this.$els),{},{selectedDateRange:this.$(".feed-panel__selected-date")}),this.$els.selectedDateRange.find(".items-list__close").on("click",(()=>{const{datesRangeMode:t,defaultDate:e}=this.feedDateFilterParameters;this.calendar.setRangeByType("all"===e?"all_time":e,t),t&&this._onSelectRange(),this.$els.selectedDateRange.hide(),this._resetDateFilterRadio(e),this.filter.update({date:e,dateCaption:""})}))}_reset(){this._options.calendar&&(this._options.calendar.destroy(),delete this._options.calendar),this._calendarPopup&&(this._calendarPopup.destroy(),this._calendarPopup=void 0),this._dateFilterPopup&&this.dateFilterPopup.destroy()}_resetDateFilterRadio(t=""){this._dateFilterPopup&&this.dateFilterPopup.$('input[type="radio"]').each(((e,s)=>{s.checked=s.value===t,f(s).trigger("update")}))}_onSelectRange(){const t=this._getRange(),e=n._h.includes(t.type);if((this.feedType===n.DV.MOST_SAVED||this.feedType===n.DV.BEST)&&!e&&this._dateFilterPopup&&this._resetDateFilterRadio(),this.$els.selectedDateRange.length){this.$els.selectedDateRange.find("span:first").text(t.caption);const e=this.feedType===n.DV.NEW&&"today"===t.type;this.$els.selectedDateRange.toggle(!e&&void 0!==t.type&&"all"!==t.type||!this._selectedDateReseted&&void 0===t.type),this._selectedDateReseted=!1}return super._onSelectRange(),this.calendarPopup.hide(),this.dateFilterPopup.hide(),!0}_initDateFilterPopup(t=(()=>"")){const e=this.isDisableCalendar||this.isSubsMode||["community","community-search"].includes(this.feedName),s=this._options.inlineFiltersMode,i=g(g({},this.filter.plainData),{},{feedName:this.feedName,isDisableCalendar:e,isSubsMode:this.isSubsMode,isDateFilterOnly:s});i.date&&!n._h.includes(i.date)&&(i.date="range"),s||(i.dateFilterTemplate=m(i));const o=t(i);this._dateFilterPopup=new a._({alignment:this._options.inlineFiltersMode?a.SE.START:a.SE.END,indent:!1,content:o,autoCloseOutsideClick:!0,zIndex:7e3}),this.listenToOnce(this._dateFilterPopup,r.eM.DESTROYED,(()=>{this._dateFilterPopup=void 0,delete this.$els.calendarCustom.el,delete this.$els.calendarCustom.title})),this.listenTo(this._dateFilterPopup,r.eM.RENDERED,this._initDateForm),this.listenToOnce(this._dateFilterPopup,r.eM.UNMOUNTED,(()=>{this._dateFilterPopup.content.find(`.${n.FG.filter.fields.hideVisited}`).removeClass(n.FG.filter.fieldHighlight)}))}async _handleDateFormChange(t,e){var s;const i=t.serialize();if(null!=e&&null!==(s=e.$els)&&void 0!==s&&s.input.data("confirmAdult")&&!e.checked){if(!(await a.nk.confirmModal({header:"page-settings.confirmations.adult.header",content:"page-settings.confirmations.adult.content",buttons:[["modal.activate",p.j.SUCCESS,!0],["modal.cancel"]],isHeaderLeftAlign:!0,zIndex:8e3})))return void(e.checked=!1);e.$els.input.data("confirmAdult",0)}if(!o.ZP.isUserAuthorized&&2===i.displayMode)return t.reset(),this._dateFilterPopup.hide(),o.ZP.checkAccessUserActions(),void Analytics.getInstance().sendEvent("click",{type:"hide_viewed"});t.saveAsDefault(),2!==i.displayMode&&0!==i.displayMode||window.history.replaceState(null,null,window.location.pathname),i.time&&(this.calendar.setRangeByType(i.time,this.feedType!==n.DV.MOST_SAVED),this._onSelectRange(),delete i.time),this.filter.update(i)}get dateFilterPopup(){return this._dateFilterPopup||this._initDateFilterPopup(h),this._dateFilterPopup}get calendarPopup(){return this._calendarPopup||(this._calendarPopup=new a.gR({alignment:a.SE.END,direction:a.Lh.LEFT,theme:a.xb.GRAY,indent:!1,content:this.calendar.show().$el,distance:30,delay:200,destroyAfterHide:!1,interactive:!0}),this.$els.calendarCustom.el&&this.$els.calendarCustom.el.length&&(this._calendarPopup.target=this.$els.calendarCustom.el),this._calendarPopup.footer.addClass("popup__footer_indent popup__footer_center"),this._calendarPopup.addButtonIntoFooter("Показать посты",(()=>this._onSelectRange()),p.j.SUCCESS),this.listenToOnce(this._calendarPopup,r.eM.DESTROYED,(()=>this._calendarPopup=void 0)),this.listenTo(this._calendarPopup,r.eM.MOUNTED,(()=>this.dateFilterPopup.autoCloseOutsideHandler=!1)),this.listenTo(this._calendarPopup,r.eM.UNMOUNTED,(()=>this.dateFilterPopup.autoCloseOutsideHandler=!0))),this._calendarPopup}}s(9755);class b extends y{render(){if(this.isRendered)return this;if(super.render(),this.$els=Object.assign(this.$els,{container:this.$(".feed-panel__container"),menu:this.$(".menu")}),this._isNeedShowHint()&&(this.$els.target.addClass(n.FG.filter.hideVisitedMark),this.$els.target.one("click",(()=>{c.mM.set(n.fo,!0),this.$els.target.removeClass(n.FG.filter.hideVisitedMark),this.dateFilterPopup.content.find(`.${n.FG.filter.fields.hideVisited}`).addClass(n.FG.filter.fieldHighlight)})),!c.mM.get(n.of,!1))){const t=new a._({target:this.$els.target,alignment:a.SE.END,direction:a.Lh.TOP,autoCloseOutsideClick:!1,distance:-12,indent:!1,content:'<div class="stories-feed-hint">\n\t<div class="stories-feed-hint__close"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon--ui__close icon--ui__close_size-middle"><use xlink:href="#icon--ui__close"></use></svg></div>\n\t<span class="stories-feed-hint__text">\n\t\tМы изменили настройки отображения просмотренных постов\n\t</span>\n</div>'});t.content.find(".stories-feed-hint__close").on("click",(()=>t.hide())),t.show(),c.mM.set(n.of,!0)}if(this.$els.target&&this.$els.target.length){const t="button-filter_active";this.listenTo(this.dateFilterPopup,r.eM.MOUNTED,(()=>this.$els.target.addClass(t))),this.listenTo(this.dateFilterPopup,r.eM.HIDDEN,(()=>this.$els.target.removeClass(t))),this.$els.target.on("click",(()=>this.dateFilterPopup.toggle())),this.listenTo(o.ZP,"ui-calendar-feed-popup:open",(()=>{this.dateFilterPopup.show()}))}return this.thematicFeedsEnabled&&!this.isSubsMode&&this._initMenuDrag(),this}_onChangeFilter(t,e){void 0!==e.displayMode&&(this.feed.displayModeViewedStories=n.kc[t.data.displayMode],d.c.getInstance().sendEvent("change_viewed_posts_settings",{settings_type:["show","roll","hide"][t.data.displayMode]})),void 0!==e.isAdultVisible&&(this.feed.adultVisible=t.data.isAdultVisible),void 0!==e.isSortedByTime&&this._changeSortByTime(),this._dateFilterPopup&&this.dateFilterPopup.hide()}_initMenuDrag(){const t=parseInt(window.getComputedStyle(this.$els.container.get(0),":after").width,10),e=()=>this.$els.container.width()-this.$els.menu.get(0).scrollWidth-t,s=()=>n+t<0,i=()=>this.$els.menu.find(".menu__item_current");let n=e(),r=!1,a=!1,h=0;const d=t=>{t.preventDefault(),t.stopImmediatePropagation()},u=async(t=(()=>{}))=>{this.$els.menu.addClass("menu_transition"),await t(),await c.cQ.delay(o.ZP.ui.css.transitionTimeDefault),l.$.request((()=>this.$els.menu.removeClass("menu_transition")))},p=async()=>{await u(_(h))},m=()=>h>0?(h=0,!0):h<n?(h=n,!0):void 0,_=t=>{this.$els.menu.css("transform",`translateX(${t}px)`),this.$els.container.toggleClass("feed-panel__container_before",t<0)},g=t=>{const e=this.$els.container.width();return t[0].getBoundingClientRect().left-this.$els.container[0].getBoundingClientRect().left+t.width()<=e},v=async(e,s=!1)=>{if(g(e))return;const i=e.is(":last-child")?0:20;h=-1*Math.floor(e[0].getBoundingClientRect().left-this.$els.container[0].getBoundingClientRect().left-this.$els.container.width()+e.width()+2*t+i),s?await u(_(h)):_(h)};v(i(),!0),this.on("sticky",(async t=>{h=0,n=e(),this.$els.container.removeClass("feed-panel__container_before"),t?await p():await v(i(),!1)})),this.$els.container.on("mousedown",(t=>{t.preventDefault(),this.$els.menuItems.off("click",d),r=!0})),o.ZP.ui.$els.document.on("mouseup",(()=>{r&&(r=!1,a&&this.$els.menuItems.one("click",d),a=!1,m()&&p())})),this.$els.container.on("wheel",(t=>{if(!s())return;if(t.preventDefault(),r||this.$els.menu.hasClass("menu_transition"))return;const{deltaX:e,deltaY:i}=t.originalEvent,n=Math.abs(e)>Math.abs(i)?e:i;h+=-n,_(h),m()&&p()})),o.ZP.ui.$els.document.on("mousemove",(t=>{if(!r||!s())return;const{movementX:e}=t.originalEvent;h+=e,a=!0,_(h)}))}_initDateFilterPopup(){super._initDateFilterPopup(h);const t=this.$els.target.find(".button-filter__popup-target");t.length?this._dateFilterPopup.target=t:(this._dateFilterPopup.distance=-12,this._dateFilterPopup.target=this.$els.target)}get thematicFeedsEnabled(){return this.$el.hasClass("feed-panel_thematic")}}class w extends i._{constructor(t){super(t)}_init(){return this._attachTools(),this._attachSocialButton(),this._attachStorySave(),this._attachModeratorTools(),this.initStories(),this}initStories(){super.initStories(),this._socialButtons.updateShareButtons()}}s(6992),s(3948);function E(t){var e,s="";return s+='<form class="stories-feed-filter">\n\t<label class="stories-feed-filter__field">\n\t\t<input type="radio" name="displayMode" value="2" '+(null==(e=2===t.displayMode?'checked="checked"':"")?"":e)+'>\n\t\t<span class="stories-feed-filter__title">Скрыть просмотренные</span>\n\t</label>\n\t<label class="stories-feed-filter__field">\n\t\t<input type="radio" name="displayMode" value="1" '+(null==(e=1===t.displayMode?'checked="checked"':"")?"":e)+'>\n\t\t<span class="stories-feed-filter__title">Сворачивать просмотренные</span>\n\t</label>\n\t<label class="stories-feed-filter__field">\n\t\t<input type="radio" name="displayMode" value="0" '+(null==(e=0===t.displayMode?'checked="checked"':"")?"":e)+'>\n\t\t<span class="stories-feed-filter__title">Показывать просмотренные</span>\n\t</label>\n</form>'}function S(t,e){var s=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),s.push.apply(s,i)}return s}function C(t){for(var e=1;e<arguments.length;e++){var s=null!=arguments[e]?arguments[e]:{};e%2?S(Object(s),!0).forEach((function(e){T(t,e,s[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(s)):S(Object(s)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(s,e))}))}return t}function T(t,e,s){return e in t?Object.defineProperty(t,e,{value:s,enumerable:!0,configurable:!0,writable:!0}):t[e]=s,t}class O extends y{constructor(...t){super(...t),T(this,"_handleHideViewedFormChange",(t=>{const e=t.serialize();if(!o.ZP.isUserAuthorized&&2===e.displayMode)return t.reset(),this._hideViewedPopup.hide(),o.ZP.checkAccessUserActions(),void d.c.getInstance().sendEvent("click",{type:"hide_viewed"});2!==e.displayMode&&0!==e.displayMode||window.history.replaceState(null,null,window.location.pathname),this.$els.hideViewedBtnLabel.text(["Показывать просмотренные","Сворачивать просмотренные","Скрыть просмотренные"][e.displayMode]),t.saveAsDefault(),this.feed.displayModeViewedStories=n.kc[e.displayMode],d.c.getInstance().sendEvent("change_viewed_posts_settings",{settings_type:["show","roll","hide"][e.displayMode]}),this.filter.update(e),this._hideViewedPopup.hide()}))}render(){if(this.isRendered)return this;super.render(),this.$els=C(C({},this.$els),{},{dateBtn:this.$(".button-filter_date"),nsfwBtn:this.$(".button-filter_nsfw"),sortByTimeBtn:this.$(".button-filter_time"),hideViewedBtn:this.$(".button-filter_viewed")}),this.$els.hideViewedBtnLabel=this.$els.hideViewedBtn.find("span"),this.$els.dateBtn.on("click",(()=>{this.$els.dateBtn.toggleClass("button-filter_active",!this.dateFilterPopup.isShown),this.dateFilterPopup.isShown?this.dateFilterPopup.hide():this.dateFilterPopup.show()})),this.$els.nsfwBtn.on("click",this._handleNsfwBtnClick.bind(this)),this.$els.sortByTimeBtn.on("click",this._handleSortByTimeBtnClick.bind(this)),this.$els.hideViewedBtn.on("click",(()=>{this.$els.hideViewedBtn.toggleClass("button-filter_active",!this.hideViewedPopup.isShown),this.hideViewedPopup.isShown?this.hideViewedPopup.hide():this.hideViewedPopup.show()})),this.listenTo(o.ZP,"ui-calendar-feed-popup:open",(()=>{this.dateFilterPopup.show()})),this.listenTo(this.dateFilterPopup,"overlayClicked",(()=>{this.$els.dateBtn.removeClass("button-filter_active")})),this.listenTo(this.hideViewedPopup,"overlayClicked",(()=>{this.$els.hideViewedBtn.removeClass("button-filter_active")})),this.listenTo(this.dateFilterPopup,r.eM.UNMOUNTED,(()=>{this.$els.dateBtn.removeClass("button-filter_active")})),this.listenTo(this.hideViewedPopup,r.eM.UNMOUNTED,(()=>{this.$els.hideViewedBtn.removeClass("button-filter_active")})),"companies"===this.feed.feedName&&(this.$els.sortByRatingBtn=this.$(".button-filter_sort-by-rating"),this.$els.sortByRatingBtn.on("click",this._handleSortByRatingBtnClick.bind(this)))}async _handleNsfwBtnClick(){if(this.$els.nsfwBtn.data("confirmAdult")){if(!(await a.nk.confirmModal({header:"page-settings.confirmations.adult.header",content:"page-settings.confirmations.adult.content",buttons:[["modal.activate",p.j.SUCCESS,!0],["modal.cancel"]],isHeaderLeftAlign:!0})))return;this.$els.nsfwBtn.data("confirmAdult",0)}const t=!this.filter.plainData.isAdultVisible;this.$els.nsfwBtn.toggleClass("button-filter_active",t),this.feed.adultVisible=t,this.filter.update({isAdultVisible:t})}_handleSortByRatingBtnClick(){const t=!this.filter.plainData.isSortByRating;this.$els.sortByRatingBtn.toggleClass("button-filter_active",t),t?this.feed.searchParams.set("s","r"):this.feed.searchParams.delete("s"),this.filter.update({isSortByRating:t}),this._updateFeed(),d.c.getInstance().sendEvent("filter",{filter_type:"rating",value_old:t?1:0,value_new:t?0:1})}_handleSortByTimeBtnClick(){const t=!Boolean(this.filter.data.isSortedByTime);this.$els.sortByTimeBtn.toggleClass("button-filter_active",t),this.filter.update({isSortedByTime:t}),this._changeSortByTime()}_initDateFilterPopup(){super._initDateFilterPopup(m),this._dateFilterPopup.target=this.$els.dateBtn}_handleDateFormChange(t){super._handleDateFormChange(t),this.dateFilterPopup.hide()}_initHideViewedForm(){const t=this._hideViewedPopup.content;if(!t)return;const e=new u.x(t);this.listenTo(e,"change",this._handleHideViewedFormChange)}get hideViewedPopup(){return this._hideViewedPopup||(this._hideViewedPopup=new a._({target:this.$els.hideViewedBtn,alignment:a.SE.START,content:E(this.filter.plainData)}),this.listenTo(this._hideViewedPopup,r.eM.RENDERED,this._initHideViewedForm)),this._hideViewedPopup}}},4473:(t,e,s)=>{"use strict";s.d(e,{B:()=>O});s(4916),s(6992),s(8559),s(3948),s(8674);var i=s(2906),n=s(6572),o=s(7025);var r=s(4519);class a extends o._{constructor(){super({addOverlay:!0,direction:o.Lh.BOTTOM,alignment:o.Lh.LEFT,distance:10,autoCorrectPosition:!0,destroyAfterRemove:!0,destroyAfterHide:!0,content:'<div class="social-widget" data-is-loading>\n    <div class="social-widget__spinner"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon--ui__progress-circle icon--ui__progress-circle_story-editor"><use xlink:href="#icon--ui__progress-circle"></use></svg></div>\n    <div class="social-widget__content">\n        <div class="social-widget__widget"></div>\n        <div class="social-widget__controls">\n            <button class="button_success button_small">Я уже с вами</button>\n        </div>\n    </div>\n</div>\n'});const t=this.content.find(".social-widget");this.$els.widget=t[0],this.$els.widgetFrame=t.find(".social-widget__widget")[0],t.on("click",".button_success",(()=>{this._onSubscribe(!0)})),this._isSubscribe=void 0,this._onSubscribeBind=this._onSubscribe.bind(this,!0),this._onUnsubscribeBind=this._onSubscribe.bind(this,!1)}async waitSubscribe(t){return this._isSubscribe}destroy(){super.destroy(),delete this._onSubscribeBind,delete this._onUnsubscribeBind,delete this._ready,delete this._isSubscribe}_onSubscribe(t){this._isSubscribe=t,this.hide()}_onUnmounted(){return new Promise((t=>{this.listenToOnce(this,r.eM.UNMOUNTED,(()=>{t()}))}))}addScript(t){return new Promise(((e,s)=>{let i=document.createElement("script");function n(t,n){(n||!i.readyState||/loaded|complete/.test(i.readyState))&&(i.onload=null,i.onreadystatechange=null,i=void 0,n?s():e())}i.async=!0,i.defer=!0,i.onload=n,i.onreadystatechange=n,i.src=t,document.body.appendChild(i)}))}get apiReady(){}}var l=s(8211);const h="pkb_Sgr",c=36e5,d="pikabu_vk";class u extends a{static createGroup(t,e){t.Widgets.Group(e,{mode:0,width:"380",height:"320",color1:l.vE.ui.css.colors.bg,color2:l.vE.ui.css.colors.caption,color3:l.vE.ui.css.colors.textGreen},31480508)}async waitSubscribe(t){this.target=t,this.show(),this.$els.widget.dataset.isLoading="true";try{const t=await this.apiReady;return t.Observer.subscribe("widgets.groups.joined",this._onSubscribeBind),t.Observer.subscribe("widgets.groups.leaved",this._onUnsubscribeBind),this.$els.widgetFrame.id="social-vk-widget",delete this.$els.widget.dataset.isLoading,this.updateWidth(),this.updatePosition(),u.createGroup(t,"social-vk-widget"),await this._onUnmounted(),t.Observer.unsubscribe("widgets.groups.joined",this._onSubscribeBind),t.Observer.unsubscribe("widgets.groups.leaved",this._onUnsubscribeBind),this._isSubscribe}catch(e){l.vE.logger.warn("social",e),this.isShown&&this.hide()}}get apiReady(){return this._ready?this._ready:window.VK?this._ready=window.VK:new Promise(((t,e)=>{setTimeout((()=>e(new Error("vk api timeout"))),c),window.vkAsyncInit=()=>{delete window.vkAsyncInit,window.VK.init({apiId:4725981,onlyWidgets:!0}),t(this._ready=window.VK)},this.addScript("//vk.com/js/api/openapi.js")}))}static get instance(){return new u}}class p extends a{static createWidget(){const t=document.createElement("div");return t.classList.add("social-widget__facebook"),t.innerHTML='<span>👇 Подписаться на Пикабу</span>\n\t\t\t\t\t\t\t<div class="fb-like" data-href="https://www.facebook.com/pikabu.ru/" data-width="154"\n\t\t\t\t\t\t\t data-layout="button_count" data-action="like" data-size="large" data-show-faces="true"\n\t\t\t\t\t\t\t data-share="false"></div>',t}_onReadyWidget(t){return new Promise((e=>{const s=()=>{t.Event.unsubscribe("xfbml.render",s),e()};t.Event.subscribe("xfbml.render",s)}))}async waitSubscribe(t){this.target=t,this.show(),this.$els.widget.dataset.isLoading="true";try{const t=await this.apiReady;this.$els.widgetFrame.append(p.createWidget()),t.XFBML.parse(this.$els.widgetFrame),await this._onReadyWidget(t),delete this.$els.widget.dataset.isLoading,this.updateWidth(),this.updatePosition(),await this._onUnmounted()}catch(e){l.vE.logger.warn("social",e),this.isShown&&this.hide()}}get apiReady(){return this._ready?this._ready:window.FB?this._ready=window.FB:new Promise(((t,e)=>{setTimeout((()=>e(new Error("facebook api timeout"))),c),window.fbAsyncInit=()=>{delete window.fbAsyncInit;const s=window.FB;s?(s.init({appId:586543721489673,xfbml:!0,version:"v2.1"}),t(this._ready=s)):e(new Error("facebook api not init"))},this.addScript("//connect.facebook.net/ru_RU/sdk.js#xfbml=1&version=v2.0")}))}static get instance(){return new p}}class m extends a{static createTimeLine(t,e){return t.widgets.createTimeline({sourceType:"profile",screenName:d},e,{height:400,chrome:"nofooter",theme:l.vE.ui.themeSettings.isDarkTheme?"dark":"light",linkColor:l.vE.ui.css.colors.textGreen,borderColor:l.vE.ui.css.colors.border})}static createFollow(t,e){return t.widgets.createFollowButton(d,e,{size:"large"})}async waitSubscribe(t){this.target=t,this.show(),this.$els.widget.dataset.isLoading="true";try{const t=await this.apiReady;t.events.bind("follow",this._onSubscribeBind),t.events.bind("unfollow",this._onUnsubscribeBind);const e=document.createElement("div"),s=document.createElement("div");return s.classList.add("social-widget__button"),this.$els.widgetFrame.append(e),this.$els.widgetFrame.append(s),await Promise.all([m.createTimeLine(t,e),m.createFollow(t,s)]),delete this.$els.widget.dataset.isLoading,this.updateWidth(),this.updatePosition(),await this._onUnmounted(),t.events.unbind("widgets.groups.joined",this._onSubscribeBind),t.events.unbind("widgets.groups.leaved",this._onUnsubscribeBind),this._isSubscribe}catch(e){l.vE.logger.warn("social",e),this.isShown&&this.hide()}}get apiReady(){return this._ready?this._ready:window.twttr?this._ready=window.twttr:new Promise(((t,e)=>{setTimeout((()=>e(new Error("twitter api timeout"))),c),window.twttr={_e:[e=>{t(this._ready=e)}]},this.addScript("//platform.twitter.com/widgets.js")}))}static get instance(){return new m}}var _=s(6777),g=s(9050);var v=s(9050);function f(t){switch(t){case"facebook":return"fb";case"twitter":return"tw"}return t}var y=s(2822),b=s(1253);function w(t,e){var s=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),s.push.apply(s,i)}return s}function E(t){for(var e=1;e<arguments.length;e++){var s=null!=arguments[e]?arguments[e]:{};e%2?w(Object(s),!0).forEach((function(e){S(t,e,s[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(s)):w(Object(s)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(s,e))}))}return t}function S(t,e,s){return e in t?Object.defineProperty(t,e,{value:s,enumerable:!0,configurable:!0,writable:!0}):t[e]=s,t}const C=s(9755);let T=!1;class O extends _.vp{constructor(t){super(),this._popup=void 0,this._tiPopup=void 0,this._userSocialGroup=void 0,this._hasUtmParameters=!0,this._feed=t,this._storyShareClass="story__share",this._commentShareClass="comment__tool",t&&t.el&&(this._feed=t,t.$el.on("click",`.${this._storyShareClass}`,(t=>{this._hasUtmParameters=!0,this.balloonTarget=t.currentTarget,y.c.getInstance().yandex.goal("share-post")}))),T||(T=!0,C(".comments").on("click.share",`.${this._commentShareClass}[data-role="share"]`,(t=>{this._hasUtmParameters=!1,this.balloonTarget=t.currentTarget,y.c.getInstance().yandex.goal("share-comment")})))}updateShareButtons(){const t=C(".comments");t.off("click.share"),t.on("click.share",`.${this._commentShareClass}[data-role="share"]`,(t=>{this._hasUtmParameters=!1,this.balloonTarget=t.currentTarget,y.c.getInstance().yandex.goal("share-comment")}))}_closePopup(){if(!this._popup)return;const t=this._popup;this._tiPopup&&(clearInterval(this._tiPopup),delete this._tiPopup),t.closed||t.close(),delete this._popup}onClickSocialButton(t){var e;t.preventDefault(),this.balloon.hide();let s=this._getStoryIdOfClickedBalloon(t);const i=null===(e=this._getStoryById(s))||void 0===e?void 0:e.subsCode;if(!s){const t=this.balloonTarget.closest(".comments");t&&(s=t.dataset.storyId)}if(s){const e=t.currentTarget.dataset.type;y.c.getInstance().google.event("share","post"),y.c.getInstance().sendEvent("share_to_social_network",E({social_network:f(e),type:"under_post","type_i8!empty":i},this._getAnalyticsData())),b.D.sendEvent("share")}this._closePopup();const n=t.currentTarget.href,o=`left=${t.screenX||Math.round(screen.width/2-325)},top=${t.screenY||screen.height>570?Math.round(screen.height/3-285):0},width=650,height=570,personalbar=no,toolbar=no,scrollbars=yes,resizable=yes`,r=this._popup=window.open(n,"social share",o)||window.open(n);r.focus();let a=0;this._tiPopup=setInterval((()=>{!r.closed&&500*a++<3e5||(this._closePopup(),this._showWidget(t))}),500)}onClickCopyButton(t){var e;t.preventDefault();const s=this.balloonTarget?this.balloonTarget:this.menuTarget,i=s?s.dataset.url:t.target.dataset.url,o=this._hasUtmParameters?(i.includes("?")||i.includes("%3F")?"&":"?")+"utm_source=linkshare&utm_medium=sharing":"",r=this._getStoryIdOfClickedBalloon(t),a=null===(e=this._getStoryById(r))||void 0===e?void 0:e.subsCode;n.cQ.copyToClipboard(decodeURIComponent(i)+o);const h=s.classList.contains(this._commentShareClass);y.c.getInstance().sendEvent("share_to_social_network",E(E({},this._getAnalyticsData()),{},{type:h?"link_comment":"link_post"},a&&{type_i8:a})),this.balloonTarget?(this.balloon.content.html('<div class="social-balloon-copy">Скопировано! 👍</div>'),this.balloon.updatePosition(),this.balloon._skipNextClick=!0,setTimeout((()=>this.balloon.isShown&&this.balloon.hide()),2e3)):l.vE.ui.toasts.add("story-link-copy",{content:"Скопировано! 👍"})}_getAnalyticsData(){const t=this.balloonTarget;if(!t)return{};const e=t.classList.contains(this._storyShareClass),s=t.classList.contains(this._commentShareClass);if(!e&&!s)return{};let i,n,o,r,a,l,h;if(e&&this._feed&&this._feed.stories){if(a=t.dataset.storyId,!a)return{};const e=this._feed.stories.get(Number(a));e&&(i=e.pluses,n=e.minuses,o=e.commentsCount,r=e.authorId)}if(s){var c,d;const e=t.closest(".comment");l=e.dataset.id,h=null===(c=e.dataset.meta.match(/aid=(\d+)/))||void 0===c?void 0:c[1];const s=e.dataset.meta.match(/av=(\d+),(\d+)/);s&&(i=Number(s[1]),n=Number(s[2]));const u=t.closest(".comments");if(a=null!==(d=null==u?void 0:u.dataset.storyId)&&void 0!==d?d:void 0,a&&this._feed&&this._feed.stories){const t=this._feed.stories.get(Number(a));t&&(o=t.commentsCount,r=t.authorId)}}const u={pluses:i,minuses:n,comments:o,author_id:r,post_id:a,comment_id:l,comment_author_id:h};return Object.fromEntries(Object.entries(u).filter((([t,e])=>void 0!==e)))}async _showWidget(t){const e=t.currentTarget.dataset.type,s=C(this.balloonTarget),i=this.subscribesToSocial.data[e];if(!s.length||void 0!==i&&("number"!=typeof i||i>Date.now()-72e5))return;let n;switch(e){case"vk":n=await u.instance.waitSubscribe(s);break;case"facebook":n=await p.instance.waitSubscribe(s);break;case"twitter":n=await m.instance.waitSubscribe(s)}this.subscribesToSocial.data[e]="boolean"==typeof n?n:Date.now()}_getStoryById(t){var e,s;return null===(e=this._feed)||void 0===e||null===(s=e.stories)||void 0===s?void 0:s.items.find((e=>e.id===Number(t)))}_getStoryIdOfClickedBalloon(t){return this.balloonTarget?this.balloonTarget.dataset.storyId:C(t.currentTarget).parent().data("storyId")}get subscribesToSocial(){if(this._userSocialGroup)return this._userSocialGroup;const t=n.mM.get(h),e="object"==typeof t&&(t.N||0)>Date.now()-108e6,s={vk:e?t.V:void 0,facebook:e?t.F:void 0,twitter:e?t.T:void 0,ok:e?t.O:void 0},o=this._userSocialGroup=new i.Lo(s);return this.listenTo(o,i.u$.CHANGE,(()=>{const t=o.plainData;n.mM.set(h,{V:t.vk,F:t.facebook,T:t.twitter,O:t.ok,N:Date.now()})})),o}get balloon(){let t=this._balloon;return t||(t=this._balloon=new o._({}),t.content.on("click",".social__button",this.onClickSocialButton.bind(this)),t.content.on("click",".social-balloon__copy",this.onClickCopyButton.bind(this)),t)}get menu(){let t=this._menu;return t||(t=this._menu=new o._({direction:o.Lh.RIGHT,stickyPosition:!0,autoCorrectPosition:!1}),t.content.on("click",".social-menu__button",this.onClickSocialButton.bind(this)),t.content.on("click",".social-menu__copy",this.onClickCopyButton.bind(this)),t)}get menuTarget(){return this._menuTarget}set menuTarget(t){if(this._menuTarget===t&&this.menu.isShown)return this.menu.hide(),this.menu.target.$target.removeClass("menu_open"),void delete this._menuTarget;const e=t.dataset.url+(t.dataset.url.includes("?")||t.dataset.url.includes("%3F")?"%26":"%3F"),s=t.dataset.title,i=t.dataset.storyId;this.menu.content=function(t){var e="",s=g.escape;return e+'<div class="social-menu">\n    <div class="social-menu__content" data-story-id="'+s(t.storyId)+'">\n        <a href="https://vk.com/share.php?url='+s(t.url+encodeURIComponent("utm_source=vshare&utm_medium=test_sharing&utm_campaign=side"))+'" target="_blank" rel="nofollow noopener" class="social-menu__button social__button" data-type="vk"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon--social__vk"><use xlink:href="#icon--social__vk"></use></svg></a>\n        <a href="https://www.facebook.com/sharer.php?u='+s(t.url+encodeURIComponent("utm_source=fshare&utm_medium=test_sharing&utm_campaign=side"))+'" target="_blank" rel="nofollow noopener" class="social-menu__button social__button" data-type="facebook"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon--social__facebook"><use xlink:href="#icon--social__facebook"></use></svg></a>\n        <a href="https://connect.ok.ru/offer?url='+s(t.url+encodeURIComponent("utm_source=okshare&utm_medium=test_sharing&utm_campaign=side"))+'" target="_blank" rel="nofollow noopener" class="social-menu__button social__button" data-type="ok"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon--social__ok"><use xlink:href="#icon--social__ok"></use></svg></a>\n        <a href="https://twitter.com/share?url='+s(t.url+encodeURIComponent("utm_source=twshare&utm_medium=test_sharing&utm_campaign=side")+(t.title?"&text="+t.title:""))+'" target="_blank" rel="nofollow noopener" class="social-menu__button social__button" data-type="twitter"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon--social__twitter"><use xlink:href="#icon--social__twitter"></use></svg></a>\n        <a href="/" class="social-menu__copy"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon--social__link"><use xlink:href="#icon--social__link"></use></svg></a>\n    </div>\n</div>\n'}({url:e,title:s,storyId:i}),this.menu.target=this._menuTarget=t,this.menu.target.$target.addClass("menu_open"),this.menu.target.$target.hasClass("story__share-new_open")||this.menu.show()}get balloonTarget(){return this._balloonTarget}set balloonTarget(t){if(this._balloonTarget===t&&this.balloon.isShown)return this.balloon.hide(),void delete this._balloonTarget;const e=t.dataset.url+(t.dataset.url.includes("?")||t.dataset.url.includes("%3F")?"%26":"%3F"),s=t.dataset.title,i="string"==typeof t.dataset.counters&&t.dataset.counters.indexOf(",")>-1;this.balloon.content=function(t){var e,s="",i=v.escape;return s+'<div class="social-balloon">\n    <div class="social-balloon__header">\n        <a href="https://vk.com/share.php?url='+i(t.url+encodeURIComponent("utm_source=vshare&utm_medium=sharing"))+'" target="_blank" rel="nofollow noopener" class="social__button" data-type="vk"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon--social__vk"><use xlink:href="#icon--social__vk"></use></svg> '+(null==(e=t.counter?`<span class="social__count">${t.counter[0]}</span>`:"")?"":e)+'</a>\n        <a href="https://www.facebook.com/sharer.php?u='+i(t.url+encodeURIComponent("utm_source=fshare&utm_medium=sharing"))+'" target="_blank" rel="nofollow noopener" class="social__button" data-type="facebook"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon--social__facebook"><use xlink:href="#icon--social__facebook"></use></svg> '+(null==(e=t.counter?`<span class="social__count">${t.counter[1]}</span>`:"")?"":e)+'</a>\n        <a href="https://connect.ok.ru/offer?url='+i(t.url+encodeURIComponent("utm_source=okshare&utm_medium=sharing"))+'" target="_blank" rel="nofollow noopener" class="social__button" data-type="ok"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon--social__ok"><use xlink:href="#icon--social__ok"></use></svg> '+(null==(e=t.counter?`<span class="social__count">${t.counter[2]}</span>`:"")?"":e)+'</a>\n        <a href="https://twitter.com/share?url='+i(t.url+encodeURIComponent("utm_source=twshare&utm_medium=sharing")+(t.title?"&text="+t.title:""))+'" target="_blank" rel="nofollow noopener" class="social__button" data-type="twitter"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon--social__twitter"><use xlink:href="#icon--social__twitter"></use></svg> '+(null==(e=t.counter?`<span class="social__count">${t.counter[3]}</span>`:"")?"":e)+'</a>\n    </div>\n    <div class="social-balloon__footer">\n        <a href="/" class="social-balloon__copy"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon--ui__link icon--ui__link_story"><use xlink:href="#icon--ui__link"></use></svg> Скопировать ссылку</a>\n    </div>\n</div>\n'}({url:e,title:s,counter:i?t.dataset.counters.split(",").map((t=>Number(t)||0)):null}),this.balloon.target=this._balloonTarget=t,this.balloon.show()}}},103:(t,e,s)=>{"use strict";s.d(e,{DX:()=>i.DX,VQ:()=>i.VQ,Bi:()=>h});s(6992),s(3948);var i=s(3181),n=s(6553),o=s(6572);var r=s(2822);s(5271);const a=s(9755),l=s(6419);class h extends i.kc{constructor(t){super(t),this._options.fragmentsLinePerPage=3,this._options.fragmentSize={[n.STORY_BLOCK_TYPE.VIDEO]:1,[n.STORY_BLOCK_TYPE.IMAGE]:1,[n.STORY_BLOCK_TYPE.VIDEO_FILE]:1,[n.STORY_BLOCK_TYPE.TEXT]:3}}render(){return this.isRendered||(this.$el=a((t={},e="",Array.prototype.join,e+='<div class="stories-similar">\n\t<div class="stories-similar__progress">\n\t\t<div class="stories-similar__progress-bar"></div>\n\t\t<div class="stories-similar__progress-message"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon--ui__progress-circle"><use xlink:href="#icon--ui__progress-circle"></use></svg> Сбор информации о возможных дубликатах</div>\n\t</div>\n\t<div class="stories-similar__empty">Похожих постов не найдено</div>\n\t<div class="stories-similar__error">\n\t\t<span>Ну вот :( При поиске похожих постов обнаружена ошибка!</span>\n\t\t<button class="button" type="button">Повторим поиск?</button>\n\t</div>\n\t<div class="stories-similar__main">\n\t\t<div class="stories-similar__fragments"></div>\n\t\t<div class="stories-similar__controls">\n\t\t\t<button type="button" class="stories-similar__more" data-role="more">Показать ещё</button>\n\t\t\t',t.existStory&&(e+='\n\t\t\t<button type="button" class="button_link stories-similar__close">Закрыть</button>\n\t\t\t'),e+="\n\t\t</div>\n\t</div>\n</div>")),this.$els={main:this.$(".stories-similar__main"),progress:{el:this.$(".stories-similar__progress"),bar:this.$(".stories-similar__progress-bar")},empty:this.$(".stories-similar__empty"),repeatButton:this.$(".stories-similar__error button"),fragments:this.$(".stories-similar__fragments"),controls:this.$(".stories-similar__controls"),more:this.$(".stories-similar__more").on("click",this._renderPage.bind(this,!1))},this.$el.on("click",".story-fragment__text-more",(t=>{a(t.currentTarget).hide().prev().addClass("story-fragment__hidden-text_show")})),this.$els.repeatButton.click((t=>{this.relaunchErrorSources()})),this._updateType(this.type),super.render()),this;var t,e}_updateType(t){switch(this.sources.clear(),this.type){case i.VQ.STORY:this.state=i.DX.WAIT,this.getStoryDuplications();break;case i.VQ.EDITOR:case i.VQ.MANUAL:this.state=i.DX.EMPTY}this._updateMoreButton()}_updateState(t){this.$el.attr("data-state",t.toString().toLowerCase()),t===i.DX.READY&&this._renderPage(!0)}_renderPage(t=!1){t&&this.$els.fragments.empty(),this.getPageFragments(t).map((t=>h._renderFragment(t).appendTo(this.$els.fragments))),this.emit("update"),l.forEach(this.$(".story-fragment"),(t=>t.classList.add("story-fragment_show"))),this._updateMoreButton()}_updateMoreButton(){return this.$els.more.toggle(!this.sources.items.every((t=>t.isEmpty||t.isFinished))),this}static _renderFragment(t){let e,i=(t.story_display_type&n.STORY_TYPE.TGP.valueOf())===n.STORY_TYPE.TGP.valueOf()||!t.story_display_type&&t.is_gtext||2===t.img_type;if(t.type===n.STORY_BLOCK_TYPE.IMAGE){let e=t.frg_width||t.width,[s,i]=o.cQ.calculateAspectRatioFit(e,t.frg_height||t.height,142,600),n=t.frg_y*(-s/e);t.style=`width: ${s}px; height: ${i}px; background-image: url(`+(t.preview_url||t.image_url)+"); "+(2===t.img_type?"; background-position-y: "+n+"px":"")}else t.type===n.STORY_BLOCK_TYPE.VIDEO?t.style=`width: 142px; height: ${142/(t.ratio||1.75)}px;`+(t.preview_url?` background: url(${t.preview_url})`:""):(t.type,n.STORY_BLOCK_TYPE.VIDEO_FILE);return e=a(function(t){var e,i="";Array.prototype.join;const{STORY_BLOCK_TYPE:n}=s(6553),o=s(381);return i+='\n<div class="story-fragment story-fragment_type_'+(null==(e=t.type.toString().toLowerCase())?"":e)+'" >\n\t',t.type===n.TEXT?(i+='\n\t<div class="story-fragment__header">\n\t\t<span class="story-fragment__relevance '+(null==(e=t.relevance>=80?"story-fragment__relevance_critical":"")?"":e)+'">'+(null==(e=t.relevance)?"":e)+'%</span>\n\t\t<a target="_blank" href="'+(null==(e=t.story_url)?"":e)+'" class="story-fragment__title">'+(null==(e=t.story_title)?"":e)+'</a>\n\t\t<time class="story-fragment__datetime hint" datetime="'+(null==(e=t.story_datetime)?"":e)+'">'+(null==(e=o(t.story_datetime).fromNow())?"":e)+'</time>\n\t</div>\n\t<div class="story-fragment__text">\n\t\t',t.text_before&&(i+='<span class="story-fragment__hidden-text">'+(null==(e=t.text_before)?"":e)+'</span><span class="story-fragment__text-more hint" aria-label="Раскрыть скрытый текст">...</span>'),i+=null==(e=t.text)?"":e,t.text_after&&(i+='<span class="story-fragment__hidden-text">'+(null==(e=t.text_after)?"":e)+'</span><span class="story-fragment__text-more hint" aria-label="Раскрыть скрытый текст">...</span>'),i+="\n\t</div>\n\t"):t.type!==n.IMAGE&&t.type!==n.VIDEO||(i+='\n\t<span class="story-fragment__relevance '+(null==(e=t.relevance>=80?"story-fragment__relevance_critical":"")?"":e)+'">'+(null==(e=t.relevance)?"":e)+'%</span>\n\t<a href="'+(null==(e=t.story_url)?"":e)+'" target="_blank" class="story-fragment__media hint" aria-label="'+(null==(e=t.story_title)?"":e)+'" style="'+(null==(e=t.style)?"":e)+';background-size: cover;">\n\t\t',t.type!==n.VIDEO&&3!==t.img_type||(i+='\n\t\t<div class="story-fragment__play"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon--player__play"><use xlink:href="#icon--player__play"></use></svg></div>\n\t\t'),i+="\n\t</a>\n\t"),i+"\n</div>"}(t)),e.find("a").on("click contextmenu",(s=>{const i=[...e[0].parentNode.querySelectorAll(".story-fragment")].indexOf(s.target.closest(".story-fragment"))+1;r.c.getInstance().sendEvent("transition_to_post",{type:"show_duplicates",screen_index:i,rec_score:t.relevance,post_id:t.story_id})})),i&&e.attr("data-is-part","true"),t.is_adult&&e.attr("data-is-adult","true"),e}}},7977:(t,e,s)=>{"use strict";s.d(e,{s6:()=>L,BO:()=>n.storyStyle,lO:()=>I});s(8674),s(6992),s(3948);var i=s(8211),n=s(6553),o=s(9404),r=s(8097),a=s(7025),l=s(2134),h=s(3363),c=s(7422),d=s(2164),u=s(8924),p=s(2427);class m{constructor(t){this._story=t,this._popup=void 0,this._input=void 0,this._submitButton=void 0,this._isChoicedTag=!1,this.$els={icon:this._story.$main.find(".story__tags-edit")},this.$els.icon.length&&(this._initEditPopup(),this.$els.icon.on("click",(t=>{window.location.pathname.includes("/edits")||(t.preventDefault(),this.$els.icon.addClass("clicked"),this._popup.show(),setTimeout((()=>{this._input.focus()}),100))})),this._submitButton.on("click",this._onSubmitForm.bind(this)))}_initEditPopup(){var t,e;this._popup=new a._({target:this.$els.icon,showArrow:!0,addOverlay:!1,autoCorrectPosition:!0,direction:a.Lh.TOP}),this._popup.content.html((t={id:this._story.id},""+'<div class="tags-edit">\n\t<form class="tags-edit_form">\n\t\t<input autocomplete="off" class="tags-edit_input" name="tags" placeholder="Введите тег" />\n\t\t<button class="tags-edit_button button button_success" type="submit">Отправить</button>\n\t</form>\n</div>\n<a class="tags-edit_link" target="_blank" href="/edits/'+(null==(e=t.id)?"":e)+'/tags">Перейти к полному редактированию</a>\n')),this.$els.submit=this._popup.content.find(".tags-edit_button"),this._submitButton=this.$els.submit.length>0?new d.y(this.$els.submit):null,this._input=new h.u3({$el:this._popup.content.find(".tags-edit_input"),suggestion:new c.Z6({maxHeight:110,tagsLine:!0,parseFilter:t=>!this._story.tagsList.includes(t.name)})}),this._hotkeys=new r.SV(this._input.$el.find("input")),this._hotkeys.on("cmd+enter",this._onSubmitForm.bind(this),{type:r.FM.KEYDOWN}),this._input.listenTo(this._input,c.nT.SELECT,(t=>{t&&(this._input.value=t.id,this._isChoicedTag=!0)})),this._input.$els.input.on("keypress",(t=>{44===t.charCode&&t.preventDefault()})),this._input.listenTo(this._input,"input",(()=>this._isChoicedTag=!1))}async _onSubmitForm(t){if(t.preventDefault(),!this._isChoicedTag)return i.vE.ui.toasts.showError("cedit.editor.form.from-list"),!1;if(!this._submitButton)return!1;try{this._submitButton.disabled=!0;const{response:t}=await l.cf.post("/ajax/cedit_actions.php",{action:"add-tag",sid:this._story.id,tag:this._input.value});if(!t.result)return this._submitButton.disabled=!1,void i.vE.ui.toasts.showError(t.message);p.l.getInstance().sendTagAnalytics({event:"tag_edit_propose",proposal:u.a8.ADD.value,tag:this._input.value,story:this._story}),i.vE.ui.toasts.add({content:t.result&&t.message?t.message:"cedit.editor.form.saved"}),this._isChoicedTag=!1,this._popup.hide(),this._submitButton.disabled=!1,this._input.value=""}catch(e){this._submitButton.disabled=!1,i.vE.ui.toasts.showError(e)}}}class _{static async getAllowedCommunities(){let{response:t,data:e}=await l.cf.post("/ajax/story-actions/get-allowed-communities");if(!t.result)throw new Error(t.message);return e}static async toggleStoryInProfile(t,e){let{response:s}=await l.cf.post("/ajax/stories_actions.php",{action:e?"hide_story":"unhide_story",story_id:t});if(!s.result)throw i.vE.ui.toasts.showError(s.message),new Error(s.message);i.vE.ui.toasts.add("settings-hide-story",{content:e?i.vE.i18n("page-settings.toggle-story.hide"):i.vE.i18n("page-settings.toggle-story.unhide")})}static async getCountStoriesHide(){let{response:t,data:e}=await l.cf.post("/ajax/stories_actions.php",{action:"get_hiding_limit"});if(!t.result)throw i.vE.ui.toasts.showError(t.message),new Error(t.message);return e.count}static async moveToFeed(t){let{response:e}=await l.cf.post("/ajax/story-actions/transfer-story",{to:"common-feed",story_id:t});if(!e.result)throw i.vE.ui.toasts.showError(e.message),new Error(e.message)}static async moveToCommunity(t,e){let{response:s}=await l.cf.post("/ajax/story-actions/transfer-story",{to:"community",story_id:t,id:e});if(!s.result)throw i.vE.ui.toasts.showError(s.message),new Error(s.message)}}var g=s(9412),v=s(9050);var f=s(7111),y=s(4951),b=s(2822),w=s(150),E=s(4519),S=s(4051);s(9755);class C extends E.u1{constructor(t){super(t),this._items=this._options.items,this.onMovedToCommunity=this._options.onMovedToCommunity,this._isMobilApp=i.vE.isMobileApp,this.show()}render(){if(this.isRendered)return this;this._initDotsMenu()}async _initDotsMenu(){if(this._dotsMenu||!this._options.el)return;const t=this._items.map((t=>{const e={id:t,title:i.vE.i18n("context-menu.context-menu."+t)};return"to_community"===t&&(e.submenu={items:[],getItemsPromise:()=>new Promise((async t=>{this.allowedCommunitiesIsLoading?this._showToast("wait",1500):(this.allowedCommunitiesIsLoading=!0,this.allowedCommunities=await _.getAllowedCommunities(),t(this.allowedCommunities.map((t=>{return{id:t.id,meta:{communityId:t.id},template:(e={communityId:t.id,name:t.name,avatar:t.avatar},s="",i=v.escape,s+='<img class="context-menu-community__avatar" src="'+i(e.avatar)+'" alt="'+i(e.name)+'">\n<span class="context-menu-community__group-name">'+i(e.name)+"</span>")};var e,s,i}))),this.allowedCommunitiesIsLoading=!1)}))}),e}));this._dotsMenu=new y.K({el:this._options.el,items:t}),this.listenTo(this._dotsMenu,"onItemClick",(t=>{this._clickOnContextMenuItem(t)})),this._options.storyBlock.find(".story__title-link").on("click",(t=>{t.target.classList.contains("story__hide-icon")&&t.preventDefault()}))}async _createAttentionPopup(t){const e=t?await _.getCountStoriesHide():0,s=new a.LD({content:`<div class="story__hide-modal">\n\t\t\t\t\t\t${i.vE.i18n("context-menu.confirm-popup."+(t?"hide":"unhide"),e)}\n\t\t\t\t\t </div>`});s.addButtonIntoFooter(i.vE.i18n("context-menu.confirm-popup."+(t?"hide-ok":"unhide-ok")),(async()=>{await this._togglePostInProfile(this._options.storyId,t),s.hide(),"profile"===i.vE.initParams.pageName&&t&&this._options.storyBlock.hide(500),"story"===i.vE.initParams.pageName&&this._options.storyBlock.find(".story__hide-icon").toggleClass("story__hide-icon_hide",!t),1===e&&(i.vE.initParams.isHidePostsFromProfile=!0)}),t?w.j.DANGER:w.j.SUCCESS),s.addCloseButtonIntoFooter(i.vE.i18n("context-menu.confirm-popup.hide-cancel")),s.show(),this._dotsMenu.closeAllMenus()}async _clickOnContextMenuItem(t){var e;if(null!=t&&null!==(e=t.meta)&&void 0!==e&&e.communityId)this._clickOnContextSubMenuItem(t.meta.communityId);else switch(t.id){case"edit":i.vE.location.href=i.vE.location.origin+"/edit/"+this._options.storyId;break;case"profile_hide":await this._createAttentionPopup(!0);break;case"profile_unhide":await this._createAttentionPopup(!1);break;case"to_feed":this._moveToFeed();break;case"to_community":t.submenu.instance?t.submenu.instance.show():(t.submenu.items=await t.submenu.getItemsPromise(),t.submenu.init(t.submenu),t.submenu.instance?t.submenu.instance.show():this._showToast("no-communities-found",1500));break;case"report":if(!i.vE.isUserAuthorized)return void i.vE.ui.authRequired();this._dotsMenu.closeAllMenus(),this._createAndShowComplainModalPopup()}}_createAndShowComplainModalPopup(){this._complainModalPopup=new S.n({destroyAfterHide:!0,targetId:this.storyId,authorId:this.authorId,targetType:"post",name:"UIComplainModalPopup"}),this._complainModalPopup.show()}async _togglePostInProfile(t,e){await _.toggleStoryInProfile(t,e);const s=e?"post_profile_hide":"post_profile_unhide";b.c.getInstance().sendEvent(s,{type:s})}async _moveToFeed(){this._showToast("move-to-feed"),await _.moveToFeed(this._options.storyId),f.m.set("pkb_mar",{messageAfterReload:"Пост успешно перенесен в ленту"}),window.location.reload()}_showToast(t,e,s=g.K.WARNING){i.vE.ui.toasts.add({content:i.vE.i18n("page-settings.main.move."+t),closeAfter:e,theme:s})}_clickOnContextSubMenuItem(t){this._communityId=t,this._moveToCommunity()}async _moveToCommunity(){this.communityIsMoving=!0,this._dotsMenu.closeAllMenus(),this._showToast("move-to-community");try{await _.moveToCommunity(this._options.storyId,this._communityId);const t=Number(this._communityId),e=this.allowedCommunities.find((({id:e})=>e===t));this._showToast("move-to-community-success",4e3,g.K.DEFAULT);const s=this._items.filter((t=>"to_community"!==t));s.length?this._dotsMenu.updateItems(s):this.destroy(),this.onMovedToCommunity&&this.onMovedToCommunity(e)}catch(t){}this.communityIsMoving=!1}toggle(){this.communityIsMoving||this._popup.toggle()}get storyId(){return this._options.storyId}get authorId(){return this._options.authorId}}function T(t,e){var s=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),s.push.apply(s,i)}return s}function O(t){for(var e=1;e<arguments.length;e++){var s=null!=arguments[e]?arguments[e]:{};e%2?T(Object(s),!0).forEach((function(e){k(t,e,s[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(s)):T(Object(s)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(s,e))}))}return t}function k(t,e,s){return e in t?Object.defineProperty(t,e,{value:s,enumerable:!0,configurable:!0,writable:!0}):t[e]=s,t}const I=O(O({},n.storyStyle),{similarIndicator:"story__has-similar-stories",footer:"story__footer",sharings:"story__share-new",rating:{up:"story__rating-up",down:"story__rating-down",active:"_active",count:"story__rating-count",hidden:"story__bull",animated:"story__rating-count_animated"}});function $(t){var e,s="";return s+='<svg version="1.1" class="vote-anim-svg '+(null==(e=t?"":" vote-anim-svg_down")?"":e)+'" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 86 48" style="enable-background:new 0 0 86.4 48.2;" xml:space="preserve">\n\t<g class="vote-anim-group vote-anim-group_1">\n\t\t<line x1="43.2" y1="5.2" x2="43.2" y2="48.2" class="vote-anim-line"/>\n\t</g>\n\t<g class="vote-anim-group vote-anim-group_2">\n\t\t<line x1="52.2" y1="4.2" x2="66.2" y2="43.2" class="vote-anim-line"/>\n\t</g>\n\t<g class="vote-anim-group vote-anim-group_2">\n\t\t<line x1="59" y1="0.2" x2="86.2" y2="31.2" class="vote-anim-line"/>\n\t</g>\n\t<g class="vote-anim-group vote-anim-group_3">\n\t\t<line x1="34.2" y1="4.2" x2="20.2" y2="43.2" class="vote-anim-line"/>\n\t</g>\n\t<g class="vote-anim-group vote-anim-group_3">\n\t\t<line x1="27.2" y1="0.2" x2="0.2" y2="31.2" class="vote-anim-line"/>\n\t</g>\n</svg>'}function A(t){var e,s="";return s+='<div class="story__community">\n    <span>\n        <a class="story__community-link" data-id="'+(null==(e=t.id)?"":e)+'" href="/community/'+(null==(e=t.link)?"":e)+'">\n            <div class="community-avatar community-avatar_small avatar_small avatar">\n                <span class="avatar__inner">\n                    <img src="'+(null==(e=t.avatar)?"":e)+'">\n                </span>\n            </div>\n            '+(null==(e=t.name)?"":e)+"\n        </a>\n    </span>\n</div>\n"}var x=s(6572);var D=s(2025),P=s(984);const R="pkb_popup_sa";class M extends class{constructor(t){this.story=t,this.show()}show(){const{lastTimeClosed:t,lastTimeShown:e,shownCount:s}=this.getLocalStorageConfig(),n=Date.now();if(null!==t&&n-t<=3*P.mf)return;const o=s>=2;if(null!==e){const t=n-e;if(o&&t<=P.mf||!o&&t<=10*P.g4)return}const r=this.createPopup();r.listenToOnce(r,E.eM.MOUNTED,(()=>setTimeout((()=>{i.vE.ui.elementInViewport(r.el)&&(x.mM.set(R,{lastTimeClosed:null,lastTimeShown:n,shownCount:o?1:s+1}),b.c.getInstance().sendEvent("tip_show",{type:"subscribe_suggest_author"}))})))),r.show()}getLocalStorageConfig(){var t;return null!==(t=x.mM.get(R))&&void 0!==t?t:{lastTimeClosed:null,lastTimeShown:null,shownCount:0}}saveLastTimeClosed(t){x.mM.set(R,{lastTimeClosed:t,lastTimeShown:null,shownCount:0})}}{createPopup(){const{$ratingUp:t,authorId:e,authorName:s}=this.story,n=new a._({target:t,content:(o={authorId:e,authorName:s},l="",l+='<div class="popup__content-notification story__subscribe-author-popup">\n    <button data-role="close" class="button_link popup__icon-close"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon--ui__close icon--ui__close_popup"><use xlink:href="#icon--ui__close"></use></svg></button>\n    <p class="story__subscribe-author-popup-text">Похоже, вам нравятся посты <a href="/@'+(null==(r=o.authorName)?"":r)+'?subscribe_suggestion" target="_blank">@'+(null==(r=o.authorName)?"":r)+'</a>. Подпишитесь на автора, чтобы не пропустить новые публикации</p>\n    <span class="button-group" data-role="subscribe-author" data-type="user" data-name="'+(null==(r=o.authorName)?"":r)+'" data-id="'+(null==(r=o.authorId)?"":r)+'" data-actions="subscribe">\n        <button class="button" data-analytics=\'{"type": "subscribe_suggestion"}\'>Подписаться</button>\n    </span>\n</div>'),destroyAfterHide:!0,autoCloseOutsideClick:!1,autoCloseIfTargetNotVisible:!0,direction:a.Lh.RIGHT,width:272,distance:-20});var o,r,l;return n.zIndex=5001,n.content.find('[data-role="close"]').on("click",(()=>{this.saveLastTimeClosed(Date.now()),n.hide()})),n.content.find('[data-role="subscribe-author"]')[0].addEventListener("click",(t=>{new D.C0(t.currentTarget).onClickSubscribe(t),i.vE.listenToOnce(i.vE,"subscribeEnded",n.hide.bind(n))})),n.content.find("a").on("click auxclick",(t=>{(0===t.button||1===t.button)&&n.hide()})),n}}s(2630);var N=s(8977);const B=s(6419);class L extends n.Story{constructor(t,e,s){super(t,e,s),this._getOptionsFromData(),this.classes=I,this._markUpdateImageSrc=!1,this._options.isStoryEditable&&new m(this),this._attachTagsCopy(),this._attachContextMenu(),this._initLabelRecommendedAnalytics();const i=this.$hiddenRating;i.length&&new a.gR({target:i,delay:300,destroyAfterHide:!1,direction:a.Lh.TOP,alignment:a.SE.START,wrapperExtraClass:"popup_bull",content:`<div class="story__popup-bull">${i.data("hint")}</div>`})}destroy(){i.vE.logger.log("story","destroy"),super.destroy()}_getOptionsFromData(){super._getOptionsFromData();const t=this.el.dataset;this._options.isStoryPage="true"===t.page,this._options.isStoryEditable="true"===t.editable}async _attachContextMenu(){this._contextMenuPopup||(this.$dots=this.$el.find("."+I.dots.button),this.$dots.length&&(this._contextMenuPopup=new C({$el:this.$dots,items:this._options.contextActions,storyId:this.id,storyBlock:this.$el,authorId:this.authorId,onMovedToCommunity:t=>{this.$el.find(`.${I.user.info} > div:last-child`).after(A(t))}})))}_toggleContextMenu(){this._contextMenuPopup||(this._contextMenuPopup=new C({$el:this.$dots,items:this._options.contextActions,storyId:this.id,storyBlock:this.$el,authorId:this.authorId,onMovedToCommunity:t=>{this.$el.find(`.${I.user.info} > div:last-child`).after(A(t))}})),this._contextMenuPopup.toggle()}highlight(t,e,s){t=I.highlight.item+t;let i=this.$main.hasClass(t);return i===(s=B.isBoolean(s)?s:!i)||(this.$main.toggleClass(t,s).toggleClass(I.highlight.blink,e&&s),e&&(s?this.timeout(t,2e3,(()=>this.$main.removeClass(t+" "+I.highlight.blink))):this.cancelTimeout(t))),this}setCurrentPlayer(){let t=this.$content.find(".player:first-child");t.length>0?i.vE.ui.player.currentPlayer=t.eq(0):i.vE.ui.player.currentPlayer=""}_updateCollapsed(t){t?(this.scrollMode&&(this.scrollMode=!1),b.c.getInstance().yandex.goal("story_collapse"),i.vE.ui.player.stop(this.$content)):this.setCurrentPlayer(),this.$el.toggleClass(I.collapse,t),this.$collapseButton.toggleClass(I.collapseButton.active,t),this.$socialsButton.toggle(!t),this.$content.toggleClass(I.content.show,!t).toggle(!t)}_attachTagsCopy(){this.$tags.on("copy",(t=>{const e=document.getSelection();if(!e.rangeCount)return;let s="";const i=e.getRangeAt(0).cloneContents().children;if(i.length>0){for(let t of i)s+=t.textContent+",";t.originalEvent.clipboardData.setData("text/plain",s),t.preventDefault()}}))}_updateCollapsedLongStory(t){let e=this.$readMore;if(!e)return;e.style.display=t?"block":"none",e.classList.toggle(I.readMore.collapsed,!t);let s=this.el.querySelector("."+I.contentInner.item);if(!t&&(this.$collapseButton.toggleClass(I.collapseButton.active,!1),!this._markUpdateImageSrc)){const t=s.querySelectorAll("img[data-src]");for(let e=0,s=t.length;e<s;++e){const s=t[e];if(s.classList.contains(o.Qs))continue;const i=s.getAttribute("src"),n=s.getAttribute("data-src");i||"string"!=typeof n||(s.setAttribute("src",n),s.removeAttribute("data-src")),s.classList.add(o.Qs),s.addEventListener("load",(()=>{s.naturalWidth>N.g&&new N.D(s)}))}this._markUpdateImageSrc=!0}if(this.sliceType!==n.STORY_SLICE_TYPE.BY_HEIGHT){if(this.sliceType===n.STORY_SLICE_TYPE.BY_BLOCK){let e=this.el.querySelector("."+I.hiddenBlocksWrapper);if(t){let t,i=document.createDocumentFragment(),n=B.find(s.childNodes,(t=>t.nodeType===Node.COMMENT_NODE&&t.nodeValue===I.cut));for(;t=n.nextElementSibling;)i.appendChild(t);e||(e=document.createElement("div"),e.classList.add(I.hiddenBlocksWrapper),s.appendChild(e)),e.appendChild(i)}else{let t=document.createDocumentFragment();for(;e.firstChild;)t.appendChild(e.firstChild);e.parentNode.replaceChild(t,e)}}}else s.classList.toggle(I.contentInner.sliceByHeight,t)}_updateRating(){const t=this.vote,e=I,s=t===n.STORY_VOTE.UP,i=t===n.STORY_VOTE.DOWN;if(this.$ratingUp.toggleClass(e.rating.up+e.rating.active,s),this.$ratingDown.toggleClass(e.rating.down+e.rating.active,i),this.$hiddenRating.length)return;this.$ratingCount.addClass(e.rating.animated),this.timeout("paste",600,(async()=>{this.$ratingCount.removeClass(e.rating.animated)}));const o=this.rating;B.isNumber(o)&&!isNaN(o)&&t&&this.$ratingCount.text(o+t.valueOf())}_updateSaved(t){}_createSubscribeAuthorPopup(){return new M(this)}get scrollMode(){return this._options.scrollMode}set scrollMode(t){return(t=Boolean(t))===this.scrollMode?t:(this.isCollapsed||this.$scrollTools.toggleClass(I.scrollTools.enabled,t).toggleClass(I.scrollTools.disabled,!t),this._options.scrollMode=t)}get $collapseButton(){return this._options.$collapseButton||(this._options.$collapseButton=this.$el.find(`.${I.collapseButton.button}`).eq(0)),this._options.$collapseButton}get $scrollTools(){return this._options.$scrollTools||(this._options.$scrollTools=this.$el.find(`.${I.scrollTools.item}`).eq(0)),this._options.$scrollTools}get $content(){return this._options.$content||(this._options.$content=this.$el.find(`.${I.content.item}`).eq(0)),this._options.$content}get $tags(){return this._options.$tags||(this._options.$tags=this.$el.find(`.${I.tags.wrapper}`).eq(0)),this._options.$tags}get $socialsButton(){return this._options.$socialsButton||(this._options.$socialsButton=this.$el.find(`.${I.sharings}`).eq(0)),this._options.$socialsButton}get $main(){return this._options.$main||(this._options.$main=this.$el.find(`.${I.main}`).eq(0)),this._options.$main}get titleLink(){let t=this.el.querySelector(`.${I.title.link}`);return t?t.getAttribute("href"):""}get $ratingUp(){return this._options.$ratingUp||(this._options.$ratingUp=this.$el.find(`.${I.rating.up}`).eq(0),this._options.$ratingUp.append($(!0))),this._options.$ratingUp}get $ratingDown(){return this._options.$ratingDown||(this._options.$ratingDown=this.$el.find(`.${I.rating.down}`).eq(0),this._options.$ratingDown.append($(!1))),this._options.$ratingDown}get $ratingCount(){return this._options.$ratingCount||(this._options.$ratingCount=this.$el.find(`.${I.rating.count}`).eq(0)),this._options.$ratingCount}get $hiddenRating(){return this._options.$hiddenRating||(this._options.$hiddenRating=this.$el.find(`.${I.rating.hidden}`).eq(0)),this._options.$hiddenRating}get $viewedCount(){return this._options.$viewedCount||(this._options.$viewedCount=this.$el.find(`.${I.viewed.count}`).eq(0)),this._options.$viewedCount}}},8223:(t,e,s)=>{"use strict";s.d(e,{Z:()=>g});s(8674);var i=s(8211),n=s(7725),o=s(7025),r=s(6572),a=s(6683),l=s(9412),h=s(3821);s(7591);var c=s(4519),d=s(5229),u=s(2822);const p=s(9755),m=s(6419);let _;class g extends o.gR{constructor(t){super(t),this.showArrow=!1,this._tagVal=t.tag,this._actionCallback=()=>{},m.isFunction(t.actionCallback)&&(this._actionCallback=t.actionCallback)}render(){return this.isRendered||(this.target.$target.length&&this.updateContent(),super.render()),this}async updateContent(){let t=this._tagVal||String(this.target.$target.data("tag")),e=await n.zG.getListSubsIgnore(!0),i=e.subs.map((t=>t.toLowerCase())).includes(t.toLowerCase()),o=e.ignore.map((t=>t.toLowerCase())).includes(t.toLowerCase()),r=p(function(t){var e,i="";Array.prototype.join;const n=s(8211).vE;return i+='\n\n<div class="tag-hint menu menu_vertical menu_padding_none">\n\t',t.subscribed?i+='\n\t\t<div class="menu__item" data-action="unsubscribe">Отписаться</div>\n\t':i+='\n\t\t<div class="menu__item" data-action="subscribe">Подписаться</div>\n\t',i+="\n\n\t",t.ignored?i+='\n\t\t<div class="menu__item" data-action="unignore">'+(null==(e=n.i18n("ignore.tags.UNIGNORE"))?"":e)+"</div>\n\t":i+='\n\t\t<div class="menu__item" data-action="ignore">'+(null==(e=n.i18n("ignore.tags.IGNORE"))?"":e)+"</div>\n\t",i+"\n</div>\n"}({subscribed:i,ignored:o}));r.find(".menu__item").on("click",(e=>{let s=p(e.currentTarget).data("action");this._handleAction(t,s)})),this.content=r,this.updateWidth(),this.updatePosition()}async _showIgnorePopup(t){if(!i.vE.isUserAuthorized)return i.vE.ui.authRequired(),void this._actionCallback();let e=new h.M({ignoreRule:{tags:[t]}});this.hide();let{isInitial:s}=await e.show().ready();return Boolean(s)}async _handleAction(t,e){if(this.hide(),this.emit("select"),!i.vE.isUserAuthorized)return i.vE.ui.authRequired(),"subscribe"===e&&u.c.getInstance().sendEvent("click",{type:"subscribe_tag",tag:t}),void this._actionCallback();try{const s={type:this.target.$target.data("analyticsType")||""};switch(e){case"subscribe":this._isSearchPage()&&u.c.getInstance().yandex.goal("subscribe-tag_context"),await n.zG.subscribe(t,!0,s),this._switchButtons(t,!0,"subscribe");break;case"unsubscribe":await n.zG.subscribe(t,!1,s),this._switchButtons(t,!1);break;case"ignore":return this._isSearchPage()&&u.c.getInstance().yandex.goal("ignore-tag_context"),await this._showIgnorePopup(t),this._switchButtons(t,!0,"ignore"),void this._actionCallback();case"unignore":let e=await a.jj.getTagIgnore(t);e.total&&await a.jj.removeRule(e.rules[0].id),this._switchButtons(t,!1,"ignore")}}catch(s){return void this.actionError(s)}this.actionSuccess(e)}_switchButtons(t,e,s="subscribe"){p(`.button-group[data-role="subscribe"][data-type="tags"][data-tags="${t}"]`).each(((t,i)=>{let n=c.u1.getUIElement(i);if(n||(n=new d.C(i)),n instanceof d.C){if("subscribe"===s)return void(n.isSubscribed=e);n.toggleIgnore(e)}}))}_isSearchPage(){const{pathname:t}=i.vE.history;return-1!==t.indexOf("/tag/")||-1!==t.indexOf("/search")}async actionSuccess(t){let e=this.toast;switch(e.isShown&&(e.hide(),await r.cQ.delay(200)),t){case"ignore":case"unignore":e.content=i.vE.i18n("ignore.messages.success");break;default:e.content=i.vE.i18n(`stories-search.tags.${t}`)}e.show(),this._actionCallback()}async actionError(t){let e=this.toast;e.isShown&&(e.hide(),await r.cQ.delay(200)),e.content=t.message||t,e.theme=l.K.DANGER,e.show(),this._actionCallback()}get toast(){return _||(_=new l.O({destroyAfterHide:!1})),_}}},6885:(t,e,s)=>{"use strict";s.d(e,{E:()=>i});const i=/^\+?([87](?!95[4-79]|99[08]|907|94[^0]|336)([348]\d|9[0-6789]|7[0247])\d{8}|[1246]\d{9,13}|68\d{7}|5[1-46-9]\d{8,12}|55[1-9]\d{9}|55[12]19\d{8}|500[56]\d{4}|5016\d{6}|5068\d{7}|502[45]\d{7}|5037\d{7}|50[4567]\d{8}|50855\d{4}|509[34]\d{7}|376\d{6}|855\d{8}|856\d{10}|85[0-4789]\d{8,10}|8[68]\d{10,11}|8[14]\d{10}|82\d{9,10}|852\d{8}|90\d{10}|96(0[79]|17[01]|13)\d{6}|96[23]\d{9}|964\d{10}|96(5[69]|89)\d{7}|96(65|77)\d{8}|92[023]\d{9}|91[1879]\d{9}|9[34]7\d{8}|959\d{7}|989\d{9}|97\d{8,12}|99[^4568]\d{7,11}|994\d{9}|9955\d{8}|996[257]\d{8}|9989\d{8}|380[3-79]\d{8}|381\d{9}|385\d{8,9}|375[234]\d{8}|372\d{7,8}|37[0-4]\d{8}|37[6-9]\d{7,11}|30[69]\d{9}|34[67]\d{8}|3[12359]\d{8,12}|36\d{9}|38[1679]\d{8}|382\d{8,9}|46719\d{10}|968\d{8})$/},2164:(t,e,s)=>{"use strict";s.d(e,{y:()=>h});var i=s(8211),n=s(150),o=s(4519),r=s(3491);const a=s(6419),l=s(9755);class h extends o.u1{constructor(t){super(t),this.classes={item:"button",animation:"button_animation"},this.$el&&this.show()}render(){if(this.isRendered)return this;this.$el||(this.$el=l(document.createElement("button")).addClass("button"));let t=this.$el.find("button");this.$els.buttons=t.length?t:this.$el;let e=this.$els.buttons.eq(0);return e.on("click",(t=>{this.emit("click",t,this)})),this.$els.title=l(document.createElement("span")).addClass("button__title").html(this.title||e.html()),e.html(this.$els.title),this.theme&&this.theme.valueOf().length&&!e.hasClass(`button_${this.theme.valueOf()}`)&&e.addClass(`button_${this.theme.valueOf()}`),super.render(),this}_renderProgress(){return this._progress||(this.isRendered||this.render(),this._progress=new r.j({inside:this.$el})),this._progress}_renderAnimate(){return this._animation?this._animation:this._animation=i.ZP.ui.player.createAnimation(this.animationName,{inside:this.$el,indent:this.animationIndent||2})}get progress(){return this._options.progress}set progress(t){var e;let s=Boolean(t);return t=!(!a.isBoolean(t)&&!a.isNumber(t))&&t,this._options.progress===t?t:(this._renderProgress(),s?a.isBoolean(t)?(this._progress.percent=20,this._progress.indeterminate=!0):(this._progress.indeterminate=!1,this._progress.percent=t):this._progress.stop(),this._progress.toggle(s),null===(e=this.$el)||void 0===e||e.toggleClass(this.classes.animation,s),this._options.progress=t)}get animation(){return this._options.animation}set animation(t){return t=Boolean(t),this.animation===t?this:(this.animationName&&this._renderAnimate().togglePlay(t),this.$el.toggleClass(this.classes.animation,t),this._options.animation=t)}get animationIndent(){return this._options.animationIndent}set animationIndent(t){this._options.animationIndent!==(t=parseInt(t,10))&&(this._options.animationIndent=t)}get animationName(){return this._options.animationName}set animationName(t){return t=String(t),this._options.animationName===t?this.animationName:(i.ZP.ui.player.preloadAnimation(t),this._options.animationName=t)}get disabled(){return this._options.disabled}set disabled(t){return t=Boolean(t),this.$els.buttons&&a.forEach(this.$els.buttons,(e=>{t?e.setAttribute("disabled","disabled"):e.removeAttribute("disabled")})),this._options.disabled=t}get title(){return this._options.title}set title(t){return this.$els.title&&this.$els.title.text(t),this._options.title=t}get theme(){return this._options.theme||n.j.DEFAULT}set theme(t){let e=this._options.theme;(t=n.j[t])&&t!==e&&(this._options.theme=t,this.isRendered&&(e&&e.valueOf().length&&this.$el.removeClass(`button_${e.valueOf()}`),t&&t.valueOf().length&&this.$el.addClass(`button_${t.valueOf()}`)))}}},8814:(t,e,s)=>{"use strict";s.d(e,{x:()=>n,g:()=>o});var i=s(7892);const n=new i.xs({COMMUNITY:"community",USER:"user",TAG:"tag"}),o=new i.xs({SETTINGS:"settings",SETTINGS_BAN:"settings-ban",SUBSCRIBE:"subscribe",UNSUBSCRIBE:"unsubscribe",IGNORE_LIST:"ignore-list",COMPLAIN:"complain"})},2396:(t,e,s)=>{"use strict";s.d(e,{B:()=>a});var i=s(2164),n=s(8799);const o=s(6419),r=s(9755);class a extends i.y{constructor(t){super({}),this.classes={item:"button-group",animation:"button-group_animation"},n.Zv.isHTMLElement(t)&&(t=r(t)),t instanceof r&&(t={$el:t.eq(0)}),t&&this.setOptions(o.defaults(t,{destroyAfterRemove:!0})),this.$el&&this.show()}render(){return this.isRendered||(this.$el||(this.$el=r(document.createElement("div")).addClass("button-group")),this.$el.find("button").length||(r(document.createElement("button")).html("Подписаться").appendTo(this.$el),r(document.createElement("button")).addClass("button_dot").appendTo(this.$el),this.$els.buttons=this.$el.find("button")),super.render()),this}}},2025:(t,e,s)=>{"use strict";s.d(e,{y3:()=>i.y,BO:()=>n.B,C0:()=>o.C,jM:()=>r.j});var i=s(2164),n=s(2396),o=s(5229),r=(s(8814),s(150))},5229:(t,e,s)=>{"use strict";s.d(e,{C:()=>b});s(4916),s(8674),s(6992),s(3948);var i=s(8211),n=s(4519),o=s(2396),r=s(7025),a=s(8814),l=s(7725),h=s(8881),c=s(1433),d=s(6683),u=s(6572),p=s(3414),m=s(3821),_=s(2822),g=s(4051),v=s(9537);const f=s(9755),y=s(6419);class b extends o.B{_getMetaFromData(){let t=this.$el.data("type"),e=this.$el.data("id"),s=this.$el.data("name"),n=this.$el.data("actions"),o=this.$el.data("ignore-actions"),r=this.$el.data("avatar"),l=this.$el.data("tag"),h=this.$el.data("linkName"),c=this.$el.data("full-ban"),d=f(".profile__ban-status").attr("aria-label");this._source=this.$el.data("subs-src");return"admoder"===new v._(location.search).get("from")&&(this._source=1,i.vE.history.replaceState({},"",location.href.split("?")[0])),t&&(this.type=a.x[t]||a.x.USER),e&&(this.id=e),s&&(this.userName=s),r&&(this.avatar=r),h&&(this.linkName=h),n&&(this.actionList=n.split(",")),l&&(this.tag=l),d&&(this.banReason=d),c&&(this.fullBan=c),o&&(this.ignoreActionList=o.split(",")),this.$el.hasClass("button-group_success")?this.actionList.set(a.g.SUBSCRIBE):this.actionList.set(a.g.UNSUBSCRIBE),this}render(){return this.isRendered||(super.render(),this._getMetaFromData(),this._ignoredByRules=[],this._isActionsPrevented=!1,this.listenTo(this,"click",this.onClickSubscribe.bind(this)),this.$els.buttons.eq(1).on("click",this._onClickMenu.bind(this)),this.listenTo(i.vE,"successIgnoreCommentsInComplain",(()=>{this._toggleCommentsIgnore(!0)}))),this}setEachSubscribeBtnState(t){f(this.buttonsSelector).each(((e,s)=>{let i=n.u1.getUIElement(s);i||(i=new b(s)),i instanceof b&&(i.isSubscribed=t)}))}_renderMenuElement(t,e){if(this.$els[t])return this.$els[t];let s=y.isFunction(e),n=this.$els[t]=f(document.createElement(s?"div":"a")).addClass("menu__item").text(i.vE.i18n("button.subscribe."+t));return s?n.on(e.bind(this)):n.attr("href",e),n}async _renderMenu(){return this._menu=new r._({target:this.$el,direction:r.Lh.BOTTOM,alignment:r.SE.END,showArrow:!1,destroyAfterHide:!0,content:f(document.createElement("div")).addClass("popup__subscribe-menu").html(i.vE.icon("ui__progress-circle","user-hint"))}),this._renderMenuContent(),this._menu}async _renderMenuContent(){i.vE.isUserAuthorized&&await this._updateIgnoreState();let t=f(document.createElement("div")).addClass("menu menu_vertical menu_padding_none").append(this._renderIgnore());this.actionList.has(a.g.SETTINGS)&&this._renderMenuElement("settings","/community/"+this.linkName+"/settings").appendTo(t),this.actionList.has(a.g.SETTINGS_BAN)&&this._renderMenuElement("settings-ban","/community/"+this.linkName+"/settings/ban-list").appendTo(t),this.actionList.has(a.g.IGNORE_LIST)&&this._renderMenuElement("ignore-list","/community/"+this.linkName+"/ban-list").appendTo(t),this._menu.content=t,this._menu.updatePosition()}_renderIgnore(){return this.renderMenuItems(this.ignoreActionList,this.type).on("click",this._onClickIgnore.bind(this))}async _onClickMenu(){this.disabled||this.progress||this._isActionsPrevented||(!this._menu||this._menu.isDestroyed?(this._menu=await this._renderMenu(),this._menu.show(),this._menu&&(this._menu.zIndex=6004)):this._menu.hide())}async onClickSubscribe(t){var e;if(this.progress||this._isActionsPrevented)return this;if(null!==(e=this._menu)&&void 0!==e&&e.isShown&&this._menu.hide(),!i.vE.isUserAuthorized)return i.vE.ui.authRequired(),this.type===a.x.TAG?_.c.getInstance().sendEvent("click",{type:"subscribe_tag",tag:this.tag}):this.type===a.x.USER?_.c.getInstance().sendEvent("click",{type:"subscribe_author",author_id:this.subject._id}):this.type===a.x.COMMUNITY&&_.c.getInstance().sendEvent("click",{type:"subscribe_community",community_id:this.subject._id}),this;let s=Date.now();t&&y.isFunction(t.preventDefault)&&t.preventDefault();const n=this.actionList.has(a.g.SUBSCRIBE);this._menu&&this._menu.hide(),this.progress=!0;try{this.type===a.x.TAG?(n&&_.c.getInstance().yandex.goal("subscribe-tag_header"),await l.zG.subscribe(this.tag,n,this._analyticsParams)):await this.subject.subscribe(n,this._analyticsParams,this._source),await u.cQ.delay(500-(Date.now()-s)),this.setEachSubscribeBtnState(n),this.emit("subscribeEnded",n)}catch(o){i.vE.ui.toasts.showError(o)}this.progress=!1,i.vE.emit("subscribeEnded",this)}get _analyticsParams(){if(this.$el.length)try{const t=this.$el[0].dataset.analytics;if(t)return JSON.parse(t)}catch(e){}if(this.$els.buttons.length){const t=this.$els.buttons[0];if(t.dataset.analytics)try{return JSON.parse(t.dataset.analytics)}catch(e){}}const t=this.$el.data("analytics-type");return t?{type:t}:"?subscribe_suggestion"===i.vE.history.location.search?{type:"subscribe_suggestion"}:{}}async _onClickIgnore(t){if(this.progress)return this;const e=f(t.target).data("role");return e?i.vE.isUserAuthorized?(t&&y.isFunction(t.preventDefault)&&t.preventDefault(),this._menu&&this._menu.hide(),await this._handleIgnoreAction(d.ZD[e]),void this._switchIgnoreButtons()):(i.vE.ui.authRequired(),this._menu&&this._menu.hide(),d.ZD[e]===d.ZD.IGNORE?_.c.getInstance().sendEvent("click",{type:"author_posts_hide",author_id:this._options.id}):d.ZD[e]===d.ZD.IGNORE_COMMENTS&&_.c.getInstance().sendEvent("click",{type:"author_comments_hide",author_id:this._options.id}),this):this}async _updateIgnoreState(){let t;try{switch(this.type){case a.x.USER:t=await d.jj.getUserIgnore(this.id);break;case a.x.TAG:t=(await d.jj.getTagIgnore(this.tag)).rules;break;case a.x.COMMUNITY:t=await d.jj.getCommunityIgnore(this.id)}t&&t.length?(this._ignoredByRules=t,this.toggleIgnore(!0)):(this._ignoredByRules=[],this.toggleIgnore(!1))}catch(e){i.vE.logger.error(e),i.vE.ui.toasts.showError(e)}}async _handleIgnoreAction(t){let e=()=>i.vE.ui.toasts.add({content:i.vE.i18n("ignore.messages.success")});try{switch(t){case d.ZD.IGNORE:this.type===a.x.TAG&&_.c.getInstance().yandex.goal("ignore-tag_header"),await this._showIgnorePopup()&&(this.toggleIgnore(!0),i.vE.emit(d.AJ.STORIES));break;case d.ZD.UNIGNORE:let t=isNaN(this._ignoredByRules[0])?this._ignoredByRules[0].id:this._ignoredByRules[0];await d.jj.removeRule(t),this.toggleIgnore(!1),i.vE.emit(d.AJ.STORIES),e();break;case d.ZD.IGNORE_COMMENTS:await d.jj.addCommentsIgnore(this.id,this.el.dataset.analyticsType||"","user"),this._toggleCommentsIgnore(!0),i.vE.emit(d.AJ.COMMENTS),e();break;case d.ZD.UNIGNORE_COMMENTS:await d.jj.removeCommentsIgnore(this.id),this._toggleCommentsIgnore(!1),i.vE.emit(d.AJ.COMMENTS),e();break;case d.ZD.COMPLAIN:this._complainModalPopup=await new g.n({destroyAfterHide:!0,targetId:this.id,authorId:this.id,targetType:"user",name:"UIComplainModalPopup"}),i.vE.emit("ignore-actions-complain"),this._complainModalPopup.show()}}catch(s){i.vE.logger.error(s),i.vE.ui.toasts.showError(s)}}async _showIgnorePopup(){if(!i.vE.isUserAuthorized)return i.vE.ui.authRequired(),this._actionCallback(),!1;let t={};if(this.type===a.x.TAG)t.tags=[this.tag];else{let e=this.type===a.x.USER,s={id:this.id,name:this.userName,avatar:this.avatar,banReason:this.banReason,link:this.linkName?`/community/${this.linkName}`:void 0,is_permabanned:Boolean(this.fullBan)};t[e?"authors":"communities"]=[s]}let e=new m.M({ignoreRule:t,analyticsType:this.el.dataset.analyticsType||""});return this._menu.hide(),e.show().ready()}toggleIgnore(t){this.ignoreActionList.toggle(d.ZD.IGNORE,!t).toggle(d.ZD.UNIGNORE,t)}_toggleCommentsIgnore(t){this.ignoreActionList.toggle(d.ZD.IGNORE_COMMENTS,!t).toggle(d.ZD.UNIGNORE_COMMENTS,t)}_switchIgnoreButtons(){f(this.buttonsSelector).each(((t,e)=>{let s=n.u1.getUIElement(e);s||(s=new b(e)),s instanceof b&&(s.ignoreActionList=this.ignoreActionList)}))}renderMenuItems(t,e){var s;let n=`ignore.${e===a.x.USER?"authors":"communities"}.`,o="";const r=null===(s=i.vE.initParams.reportReasons)||void 0===s?void 0:s.some((t=>3===t.type));return e===a.x.USER&&r&&(o+=`\n\t\t\t\t<div class="menu__item" data-role="complain">\n\t\t\t\t\t${i.vE.i18n(n+"COMPLAIN")}\n\t\t\t\t</div>\n\t\t\t`),d.ZD.entries().forEach((e=>{t.has(e)&&(o+=`\n\t\t\t\t<div class="menu__item" data-role="${e.value}">\n\t\t\t\t\t${i.vE.i18n(n+e.name)}\n\t\t\t\t</div>\n\t\t\t`)})),f(o)}get buttonsSelector(){return`.button-group[data-role="subscribe"][data-type="${this.type.valueOf()}"][data-id="${this.id}"]`}get isSubscribed(){var t;return void 0===this._options.isSubscribed?!Boolean(null===(t=this.el)||void 0===t?void 0:t.classList.contains("button-group_success")):this._options.isSubscribed}set isSubscribed(t){var e,s,n;this._options.isSubscribed!==(t=Boolean(t))&&(this._options.isSubscribed=t,this.actionList.toggle(a.g.SUBSCRIBE,!t).toggle(a.g.UNSUBSCRIBE,t),null===(e=this.$el)||void 0===e||e.toggleClass("button-group_success",!t),null===(s=this.$els)||void 0===s||!s.title.length||null!==(n=this.$els.title)&&void 0!==n&&n.find("svg").length||(this.title=i.vE.i18n("button.subscribe."+(t?"unsubscribe":"subscribe"))))}get actionList(){return this._options.actionList?this._options.actionList:this._options.actionList=new p.F}set actionList(t){if(t.constructor!==p.F)for(let e of t)a.g[e]&&this.actionList.set(a.g[e]);else this._options.actionList=t}get ignoreActionList(){return this._options.ignoreActionList?this._options.ignoreActionList:this._options.ignoreActionList=new p.F}set ignoreActionList(t){if(t.constructor!==p.F)for(let e of t)d.ZD[e]&&this.ignoreActionList.set(d.ZD[e]);else this._options.ignoreActionList=t}get id(){return this._options.id}set id(t){this._options.id="number"==typeof t?t:parseInt(t,10)}get type(){return this._options.type}set type(t){this._options.type=a.x[t]||a.x.COMMUNITY}get subject(){return this._options.subject||(this._options.subject=this.type===a.x.USER?new h.User(this.id):new c.S1(this.id)),this._options.subject}get linkName(){return this._options.linkName}set linkName(t){this._options.linkName!==(t=String(t))&&(this._options.linkName=t)}set preventActions(t){t=Boolean(t),this._isActionsPrevented!==t&&(this._isActionsPrevented=t)}}},9624:(t,e,s)=>{"use strict";s.d(e,{y:()=>d});s(6992),s(3948);var i=s(4877);const n="carousel",o={container:n,content:"carousel__content",item:"carousel__item",borderLeft:"carousel__border-left",borderRight:"carousel__border-right",btnLeft:"carousel__scroll_left",btnRight:"carousel__scroll_right",btnIsHidden:"carousel__scroll_hidden",community:{container:"carousel__community",link:"carousel__community-link",btnSubscribe:"carousel__community-follow"}};var r=s(3040),a=s(4951),l=s(6349);function h(t,e,s){return e in t?Object.defineProperty(t,e,{value:s,enumerable:!0,configurable:!0,writable:!0}):t[e]=s,t}class c extends i.u{constructor(t){var e,s,i,n;super(t),h(this,"els",{}),h(this,"scrollRatio",1),h(this,"scrollDuration",200),h(this,"clientProperties",new r.U),h(this,"contextMenu",!1),h(this,"storageKey",""),h(this,"analyticsEvents",{}),h(this,"analytics",l.cp.getInstance()),h(this,"isScrolling",!1),this.el&&(this.els={content:this.el.querySelector("."+o.content),btnLeft:this.el.querySelector("."+o.btnLeft),btnRight:this.el.querySelector("."+o.btnRight),borderLeft:this.el.querySelector("."+o.borderLeft),borderRight:this.el.querySelector("."+o.borderRight),items:Array.from(this.el.querySelectorAll("."+o.item))},this.contextMenu=null!==(e=t.contextMenu)&&void 0!==e&&e,this.storageKey=null!==(s=t.storageKey)&&void 0!==s?s:"",this.analyticsEvents=null!==(i=t.analytics)&&void 0!==i?i:{},this._options.useEmitter=null===(n=t.useEmitter)||void 0===n||n,this.show())}render(){return this.isRendered||(this.initCarousel(),this.initObserver(),this.initContextMenu(),super.render()),this}setTemporarilyHidden(){if(!this._options.tempHidingConfig)return;const{clientPropertyKey:t="",clientPropertyMS:e=0}=this._options.tempHidingConfig;this.clientProperties.set(t,e)}initCarousel(){var t,e;const s=this.getOneBlockWidth();if(!s)return;const i=s*this.scrollRatio;null===(t=this.els.btnRight)||void 0===t||t.addEventListener("click",(()=>this.scroll(i))),null===(e=this.els.btnLeft)||void 0===e||e.addEventListener("click",(()=>this.scroll(-i))),this.els.content.addEventListener("wheel",(t=>{const{shiftKey:e}=t;e&&(t.preventDefault(),this.scroll(t.deltaY>0?i:-i))})),this.toggleBtnObserver()}toggleBtnObserver(){if(!this.els.btnLeft&&!this.els.btnRight)return;const t=new IntersectionObserver((t=>{for(const{target:i,intersectionRatio:n}of t){var e;if(i===this.els.borderLeft)null===(e=this.els.btnLeft)||void 0===e||e.classList.toggle(o.btnIsHidden,Boolean(n));else if(i===this.els.borderRight){var s;null===(s=this.els.btnRight)||void 0===s||s.classList.toggle(o.btnIsHidden,Boolean(n))}}}),{root:this.els.content,threshold:[0,1]});t.observe(this.els.borderLeft),t.observe(this.els.borderRight)}scroll(t){if(this.isScrolling)return;this.isScrolling=!0;const e=this.els.content,s=e.scrollLeft,i=s+t,n=i-s,o=performance.now();if(0===t)return void(this.isScrolling=!1);const r=t=>{const a=t-o;e.scrollLeft=Math.round(((t,e,s,i)=>(t/=i/2)<1?s/2*t*t+e:-s/2*(--t*(t-2)-1)+e)(a,s,n,this.scrollDuration)),a<this.scrollDuration?requestAnimationFrame(r):(e.scrollLeft=i,this.isScrolling=!1)};requestAnimationFrame(r)}getOneBlockWidth(){const t=this.els.items[0];return t?t.offsetWidth+parseInt(window.getComputedStyle(t).marginRight,10):0}initObserver(){if(!this.el)return;let t=!1;const e=new IntersectionObserver((s=>{for(const{intersectionRatio:i}of s)1===i&&(t=!0,this.emit("carouselShown"),this.analyticsEvents.onBlockShow&&this.analytics.sendEvent("reach_element",{type:this.analyticsEvents.onBlockShow},[l.b0.CLICKHOUSE])),t&&0===i&&this.el&&(this._options.useEmitter?this.emit("carouselHidden"):this.setTemporarilyHidden(),e.unobserve(this.el))}),{threshold:[0,1]});e.observe(this.el)}initContextMenu(){var t;if(!this.contextMenu)return;const e=null===(t=this.el)||void 0===t?void 0:t.querySelector(".carousel__dots");if(!e)return;const s=new a.K({el:e,items:[{id:0,title:"Это не интересно"}]});this.listenTo(s,"onItemClick",(()=>{if(s.closeAllMenus(),this.storageKey){const t=Math.round(Date.now()/1e3/60/60);this.clientProperties.set(this.storageKey,t)}this.hide(),this.analyticsEvents.onHideClick&&l.cp.getInstance().sendEvent("click",{type:this.analyticsEvents.onHideClick},[l.b0.CLICKHOUSE])}))}}class d extends c{render(){return this.isRendered||(this.scrollRatio=this._options.scrollRatio||3,super.render(),this.initMouseSwipe()),this}initMouseSwipe(){const t=this.els.content;let e,s,i=!1;const n=()=>{i&&(i=!1,t.classList.remove("grabbing"),this.scrollSnap())};t.addEventListener("mousedown",(n=>{i=!0,e=n.pageX,s=t.scrollLeft,t.classList.add("grabbing")})),t.addEventListener("mouseleave",n),t.addEventListener("mouseup",n),t.addEventListener("mousemove",(n=>{i&&(n.preventDefault(),t.scrollLeft=s-2*(n.pageX-e))}))}scrollSnap(){const t=this.els.content.scrollLeft,e=this.els.items.find((e=>e.offsetLeft+e.offsetWidth/2>=t));if(!e)return;const s=this.els.items[0].offsetLeft,i=e.offsetLeft-t-s;this.scroll(i)}}},8051:(t,e,s)=>{"use strict";s.d(e,{m:()=>h});var i=s(8211),n=s(4519),o=s(8799),r=s(8097);const a=s(9755),l=s(6419);class h extends n.u1{constructor(t){super(),o.Zv.isHTMLElement(t)&&(t=a(t)),t instanceof a&&(t={$el:t.eq(0)}),t&&this.setOptions(t),this.$els={input:void 0},this.el&&this.el.parentNode&&this.show()}render(){if(this.isRendered)return this;let t;return this.$el?(this.$els.input=this.$el,t=this.$el.parent()):this.$els.input=a(document.createElement("input")).type(this.classes.type),this.$el=a(document.createElement("span")).addClass(this.classes.item).append(this._createChecked()).prop("tabindex",0).attr("unselectable","on"),this._hotkeys=new r.SV(this.$el),this._hotkeys.on("space",(t=>{t.preventDefault()}),{type:r.FM.KEYDOWN}).on("space",(t=>{t.preventDefault(),this.disabled||(this.checked=!this.checked)})),t?(this.$el.insertBefore(this.$els.input),this.$els.input.appendTo(this.$el).hide()):this.$el.append(this.$els.input),this.$els.input.attr("class")&&this.$el.addClass(this.$els.input.attr("class")),this.$els.input.on({change:this._onChange.bind(this),update:this._onUpdate.bind(this)}),this.checked=this.$els.input.prop("checked"),this.disabled=this.$els.input.prop("disabled"),this.$el.parent().is("label")||this.$el.click(this.toggleChecked.bind(this,null,!0)),super.render(),this}_onChange(){this.checked=this.$els.input.prop("checked")}_onUpdate(){this._options.checked=this.$els.input.prop("checked"),this._updateToggle(this._options.checked,!0)}toggleChecked(t,e,s=!0){this.disabled||(t=l.isBoolean(t)?t:!this.checked,e&&this.$els.input.prop("checked",t),this.checked=t,s&&this.$el.focus())}setChecked(t,e=!1){return t=Boolean(t),this._options.checked===t?this._options.checked:(this.$els.input.prop("checked",t),this._updateToggle(t,!1),e||this.emit("change",t),this._options.checked=t)}_createChecked(){return this.$els.checkedIcon?this.$els.checkedIcon:this.$els.checkedIcon=a(i.ZP.icon("ui__success","checkbox"))}_updateToggle(t,e=!0){this.$el.toggleClass(this.classes.checked,t)}destroy(){this.$els.input.off(),delete this.$els.input,super.destroy()}get disabled(){return this._options.disabled}set disabled(t){return t=Boolean(t),this._options.disabled===t?this._options.disabled:(this.$el.toggleClass(this.classes.disabled,t),this._options.disabled=t)}get checked(){return this._options.checked}set checked(t){return this.setChecked(t)}}h.prototype.classes={item:"checkbox",checked:"checkbox_checked",disabled:"checkbox_disabled",type:"checkbox",input:'input[type="checkbox"]'}},1845:(t,e,s)=>{"use strict";s.d(e,{m:()=>i.m});var i=s(8051)},7422:(t,e,s)=>{"use strict";s.d(e,{nT:()=>m.nT,U:()=>m.U,dt:()=>a,Vd:()=>i.V,DC:()=>p,Z6:()=>n.Z,xI:()=>l.x});var i=s(5448),n=s(9025),o=(s(8674),s(4916),s(2567)),r=s(1433);class a extends i.V{constructor(t){super(t),this.minQueryLength=2,this.items.DataObject=o.Ys}_hasRequestCache(t){return r.yV.hasSearchCache(t)}async _requestItems(t,e){return await r.yV.search(t)}}var l=s(3674),h=(s(5827),s(6992),s(3948),s(4706)),c=s(2134),d=s(6889);const u=s(6419);class p extends i.V{constructor(t){super(t),this.minQueryLength=3,this.items.prepareData=t=>{switch(t.type){case"header":return new o.fP(t);case"separator":return new o.mX;case"user":return new h.VV(t);case"tag":return new o.U(t);case"community":return new o.Up(t);case"search":return new o.NY}}}render(){return this.isRendered||(super.render(),this.$el.addClass("dropdown-list_search")),this}_hasRequestCache(t){let e=d.h.getInstance("dropdownSearch");return e.has(t)&&!(e.get(t)instanceof Promise)}async _requestItems(t,e){let s=d.h.getInstance("dropdownSearch");if(s.has(t))return s.get(t);let i=c.cf.post("/ajax/search_actions.php",{query:t,action:"find_tags_users_communities"});return s.set(t,i.then((t=>{let e=[];if(!t.response.result)return[];let s=[t.data.tags.reverse().map((t=>u.extend(t,{type:"tag"}))).slice(-9),t.data.users.reverse().map((t=>u.extend(t,{type:"user"}))).slice(-9),t.data.communities.reverse().map((t=>u.extend(t,{type:"community",id:Number(t.id)}))).slice(-9)],i=s.length,n=0,o=Math.min(9,s.reduce(((t,e)=>t+e.length),0)),r=[];for(;o;){let t=s[n++].pop();n>=i&&(n=0),t&&(r.push(t),o--)}let a=u.groupBy(r,(t=>t.type));return a.tag&&(e.push({type:"header",title:"Теги"}),e.push(...a.tag)),a.user&&(e.length&&e.push({type:"separator"}),e.push({type:"header",title:"Пользователи"}),e.push(...a.user)),a.community&&(e.length&&e.push({type:"separator"}),e.push({type:"header",title:"Сообщества"}),e.push(...a.community)),e.unshift({type:"search"}),e})))}}s(2584);var m=s(1916)},8588:(t,e,s)=>{"use strict";s.d(e,{X:()=>n});s(6992),s(3948);var i=s(2906);class n extends i.Lo{constructor(t){super(t||{}),this.el=void 0,this.els={},this.on("current",this._updateCurrent),this.on(i.u$.REMOVE,this._onRemove)}render(){if(this.el)return this.el;let t;return t=this.el=document.createElement("div"),t.classList.add("dropdown-item"),t.setAttribute("data-id",this.id),this.el}_onRemove(){this.data.current=!1,this.el&&this.el.parentNode&&this.el.parentNode.removeChild(this.el)}_updateCurrent(t,e){this.el&&this.el.parentNode&&this.el.classList.toggle("dropdown-item_current",e)}destroy(...t){this.isDestroyed||this.marks.has("isPredefined")||(this._onRemove(),super.destroy(...t))}}n.prototype.defaults={label:"",info:"",current:!1}},2567:(t,e,s)=>{"use strict";s.d(e,{X:()=>i.X,Ys:()=>r,Up:()=>d,fP:()=>c,NY:()=>u,mX:()=>h,U:()=>n});var i=s(8588);class n extends i.X{render(){if(this.el)return this.el;let t,e;return super.render(),t=this.els.label=document.createElement("div"),t.classList.add("dropdown-item__label"),t.textContent=this.data.name,this.el.appendChild(t),this.el.setAttribute("data-type","tag"),this.data.count&&(e=this.els.count=document.createElement("div"),e.classList.add("dropdown-item__info"),e.textContent=this.data.count,this.el.appendChild(e)),this.el}}n.prototype.fieldId="name",n.prototype.defaults={count:0,current:!1};var o=s(8799);class r extends i.X{render(){if(this.el)return this.el;let t=this.el=o.Zv.fragment((e=this.data,i="",Array.prototype.join,i+='<div class="community">\n\t<div class="community-avatar"><img src="'+(null==(s=e.avatar)?"":s)+'" alt=""></div>\n\t<div class="community__wrapper">\n\t\t<div class="community__title">\n\t\t\t',e.is_nsfw&&(i+='\n\t\t\t\t<span class="text-muted">[NSFW]</span>\n\t\t\t'),i+="\n\t\t\t<a>"+(null==(s=e.name)?"":s)+'</a>\n\t\t</div>\n\t\t<div class="community__information caption">\n\t\t\t<span>'+(null==(s=e.stories)?"":s)+"</span> • <span>"+(null==(s=e.subs)?"":s)+"</span>\n\t\t</div>\n\t</div>\n</div>\n")).firstChild;var e,s,i;return t.classList.add("dropdown-item"),t.setAttribute("data-id",this.id),this.el}}r.prototype.fieldId="id",r.prototype.defaults={avatar:"",name:"",current:!1,subs:"",stories:"",link:"",tags:void 0,is_nsfw:!1};var a=s(4706);class l extends a.VV{render(){if(this.el)return this.el;super.render();let t=document.createElement("div");return t.classList.add("dropdown-item__info"),t.textContent=this.data.is_developer?"разработчик":"модератор",this.el.appendChild(t),this.el}search(t){return t.test(this.data.name)}}l.prototype.fieldId="id",l.prototype.defaults={avatar:"",avatar80:"",name:"",is_developer:!1,current:!1};class h extends i.X{render(){return this.el||(this.el=document.createElement("hr")),this.el}}h.prototype.isSeparator=!0,h.prototype.defaults={current:!1};class c extends i.X{render(){return this.el||(this.el=document.createElement("h4"),this.el.textContent=this.data.title||"Header"),this.el}}c.prototype.isSeparator=!0,c.prototype.defaults={current:!1,title:void 0};class d extends i.X{render(){if(this.el)return this.el;let t,e,s;return super.render(),t=document.createElement("div"),t.classList.add("dropdown-item__icon","community-avatar","community-avatar_small"),"string"==typeof this.data.avatar?(s=document.createElement("img"),s.setAttribute("src",this.data.avatar),t.appendChild(s)):t.classList.add("community-avatar__default"),this.el.appendChild(t),e=document.createElement("div"),e.classList.add("community__title","dropdown-item__label"),e.textContent=this.data.name,this.el.appendChild(e),this.el}search(t){return t.test(this.data.name)}}d.prototype.fieldId="id",d.prototype.defaults={avatar:"",name:"",current:!1};class u extends i.X{render(){if(this.el)return this.el;super.render();let t=document.createElement("i");return t.classList.add("caption"),t.innerHTML="Показать все результаты",this.el.appendChild(t),this.el}}u.prototype.defaults={current:!1}},5448:(t,e,s)=>{"use strict";s.d(e,{V:()=>g});s(8674),s(4916),s(4603);var i=s(8211),n=s(4519),o=s(2906),r=s(3363),a=s(2154),l=s(7686),h=s(7025),c=s(8097),d=s(2567),u=s(6572),p=s(7754);const m=s(9755),_=s(6419);class g extends n.u1{constructor(t){super(),t instanceof r.Y1&&(t={target:t}),this.setOptions(_.defaults(t||{},{autoPreselectFirst:!0,highlightResult:!0,useNumericIds:!0})),this.classes={empty:"dropdown-list__empty",items:"dropdown-list__items",item:{el:"dropdown-item"}},this._options.items=new o.qg,this._options.items.DataObject=d.X,this.listenTo(this._options.items,o.u$.UPDATE,this._onChangeItems),this._searchItemsDebounce=void 0,this._isPressed=!1,this.render()}render(){return this.isRendered||(this.$el=m(document.createElement("div")).addClass("dropdown-list"),this.$els.empty=m(document.createElement("div")).addClass(this.classes.empty).appendTo(this.$el),this.$els.items=m(document.createElement("div")).addClass(this.classes.items).on("mousedown",this._onMouseDown.bind(this)).on("mouseenter",".dropdown-item",this._onMouseEnterItem.bind(this)).on("click",".dropdown-item",this._onClickItem.bind(this)).appendTo(this.$el),this.maxHeight&&this.$els.items.css("maxHeight",this.maxHeight),this._popup=new h._({alignment:h.SE.START,direction:h.Lh.BOTTOM,autoCorrectPosition:!0,distance:-1,showArrow:!1}),this.listenTo(this._popup,n.eM.HIDDEN,this.hide),this.$parent=this._popup.content,super.render()),this}show(){return this.isShown||(super.show(),this._popup&&(this.cancelTimeout("hide"),this._popup.show())),this}hide(){return this.isShown?(this.currentItemId=!1,this._popup?(this.emit(n.eM.HIDDEN),this._popup.hide(),this._clearQuery(),this._options.isShown=!1,this.timeout("hide",i.ZP.ui.css.transitionTimeDefault,(()=>{super.hide()}))):super.hide(),this):this}_onKeyUpDown(t,e){if(!this.items.size||!this.isShown)return!0;e&&_.isFunction(e.preventDefault)&&e.preventDefault();let s=this.currentItemId,i=10;do{if(s=t?this.items.nextId(s):this.items.prevId(s),!s||!this.items.get(s).isSeparator)break}while(i-- >0);return _.isUndefined(s)&&(s=t?this.items.firstId():this.items.lastId()),this.currentItemId=s,this.currentItemId&&this._scrollToItem(this.items.get(this.currentItemId).el),!1}_onKeyEnter(t){if(!this.items.size||!this.isShown)return!0;let e=_.isUndefined(this.currentItemId)?null:this.items.get(this.currentItemId);return e&&t&&(_.isFunction(t.preventDefault)&&t.preventDefault(),_.isFunction(t.stopPropagation)&&t.stopPropagation()),i.ZP.logger.log("dropdown","select item by enter",this.currentItemId),this.emit(l.n.SELECT,e),this}_scrollToItem(t){let e=m(t),s=this.$els.items.height(),i=e.outerHeight(!0),n=this.$els.items.scrollTop()||0,o=e.offset().top-this.$els.items.offset().top+n,r=o-s+i;o+i>s+n?this.$els.items.scrollTop(r):o<n&&this.$els.items.scrollTop(o)}_onChangeItems(t,e){i.ZP.logger.log("dropdown","update items, size:",t.size),e&&e.inserted&&t.items.forEach((t=>this.$els.items.append(t.render()))),this._popup&&this._popup.$el&&this._popup.updatePosition(),t.size?this.autoPreselectFirst&&!this.items.has(this.currentItemId)&&(this.currentItemId=t.items[0].id):this.currentItemId=!1,this.emit(l.n.SET,t,e),this.$els.empty&&this.$els.empty.toggle(!t.size),this.highlightResult&&(p.y.remove(this.el,"dropdown-item__highlight"),this.query&&this.query.length>0&&p.y.add(this.el,this.queryRegExp,"dropdown-item__highlight"))}_onMouseDown(){this._isPressed=!0;const t=()=>{this._isPressed=!1,document.removeEventListener("mouseup",t,{capture:!0})};document.addEventListener("mouseup",t,{capture:!0})}_onMouseEnterItem(t){let e,s,i=t.currentTarget;i&&(e=i.getAttribute("data-id"),s=i.getAttribute("data-type")),this._options.useNumericIds&&"tag"!==s&&_.isFinite(e)&&(e=Number(e)),_.isUndefined(e)||(this.currentItemId=e)}_onClickItem(t){let e,s,n=t.currentTarget;n&&(e=n.getAttribute("data-id"),s=n.getAttribute("data-type")),this._options.useNumericIds&&"tag"!==s&&_.isFinite(e)&&(e=Number(e)),_.isUndefined(e)||(this.currentItemId=e,i.ZP.logger.log("dropdown","select item by click",this.currentItemId),this.emit(l.n.SELECT,_.isUndefined(this.currentItemId)?null:this.items.get(this.currentItemId),t))}async _searchItems(t,e){let s=await this._requestItems(t,e);this.query===t?(this.parseFilter&&(s=s.filter(this.parseFilter)),this.items.set(s),this.emit(l.n.SEARCH_END)):i.ZP.logger.log("dropdown","search ignore response for",t)}_hasRequestCache(t){return!1}async _requestItems(t,e){return[]}_searchPredefinedItems(t){let e=t?this.predefinedItems.items.filter((e=>e.search&&e.search(t))):this.predefinedItems.items;this.parseFilter&&(e=e.filter(this.parseFilter)),this.items.set(e),this.emit(l.n.SEARCH_END)}_clearQuery(){this._options.query=this._options.queryRegExp=void 0,this.emit(l.n.SEARCH_END)}get query(){return this._options.query}set query(t){let e=this._options.query;if("boolean"==typeof t)return this._clearQuery(),void this.items.clear();if(e===(t=t.trim().toLowerCase()))return;i.ZP.logger.log("suggestion","search",'"',t,'"'),this._options.query=t;let s=this._options.queryRegExp=new RegExp(u.cQ.escapeStringRegExp(t),"i");this.emit(l.n.SEARCH_START);let n=t.length,o=this.minQueryLength;this.strategy===l.$.PREDEFINED||n<o&&this.predefinedItems.size?this._searchPredefinedItems(n?s:void 0):n>=o?this._hasRequestCache(t)?this._searchItems(t,s):(this._searchItemsDebounce||(this._searchItemsDebounce=_.debounce(this._searchItems.bind(this),300)),this._searchItemsDebounce(t,s)):(this.emit(l.n.SEARCH_END),this.items.clear())}get queryRegExp(){return this._options.queryRegExp}get currentItemId(){return this._options.currentItemId}set currentItemId(t){let e=this.currentItemId,s=null;return t===e?e:(this.items.has(e)&&(this.items.get(e).data.current=!1),this.items.has(t)&&(s=this.items.get(t),s.data.current=!0),this.emit(l.n.CURRENT,s),this._options.currentItemId=t)}get items(){let t=this._options.items;return t||(t=this._options.items=new o.qg,t.DataObject=d.X,this.listenTo(t,o.u$.UPDATE,this._onChangeItems)),t}get predefinedItems(){let t=this._options.predefinedItems;return t||(t=this._options.predefinedItems=new o.qg(!1,this.items.DataObject)),t}get target(){return this._options.target}set target(t){return this.target!==t&&(this._popup&&(t instanceof r.Y1?(t instanceof a.Y?this._popup.distance=0:(this._popup.minWidth="100%",this._popup.maxWidth="300%"),this._popup.target=t.$el):this._popup.target=t),this._options.target=t)}get targetInput(){return this._options.targetInput}set targetInput(t){return this.targetInput===t?this.targetInput:(this._hotkeys=new c.SV(t),this._hotkeys.on("up",this._onKeyUpDown.bind(this,!1),{type:c.FM.KEYDOWN}),this._hotkeys.on("down",this._onKeyUpDown.bind(this,!0),{type:c.FM.KEYDOWN}),this._hotkeys.on("enter",this._onKeyEnter.bind(this),{type:c.FM.KEYDOWN}),this._options.targetInput=t)}get minQueryLength(){return this._options.minQueryLength||2}set minQueryLength(t){t=Math.max(0,Math.min(10,parseInt(t,10))),this._options.minQueryLength=t}get editorReplacer(){return this._options.editorReplacer}set editorReplacer(t){t instanceof a.l||(t=new a.l(t)),this._options.editorReplacer=t}get highlightResult(){return this._options.highlightResult}set highlightResult(t){this._options.highlightResult=Boolean(t)}get autoPreselectFirst(){return this._options.autoPreselectFirst}set autoPreselectFirst(t){this._options.autoPreselectFirst=Boolean(t)}get strategy(){return this._options.strategy||l.$.REQUEST}set strategy(t){this._options.strategy=l.$[t]||l.$.REQUEST}get parseFilter(){return this._options.parseFilter}set parseFilter(t){return _.isFunction(t)?this._options.parseFilter=t:this.parseFilter}get maxHeight(){return this._options.maxHeight}set maxHeight(t){_.isString(t)&&t.includes("px")&&(t=Math.max(50,parseInt(t,10)||0)),t=this._options.maxHeight=_.isFinite(t)&&t>0?t:"auto",this.isShown&&this.$els.items.css("max-height",t)}get isPressed(){return!0===this._isPressed}}},2584:(t,e,s)=>{"use strict";s.d(e,{J:()=>r});s(8674),s(4916);var i=s(5448),n=s(226),o=s(1712);s(9755);class r extends i.V{constructor(t){super(t),this.minQueryLength=2,this.items.DataObject=n.v,this.$els.empty.append('<div class="dropdown-item__empty-block"><p>К сожалению, по вашему запросу ничего не найдено</p><button tabindex="2" class="button button_success dropdown-item__empty-button">Запросить добавление</button></div>'),this.$els.empty.button=this.$els.empty.find(".dropdown-item__empty-button"),this.$el.append('<div class="dropdown-item__black-list">Данная информация находится в черном списке</div>'),this.$els.blacklist=this.$(".dropdown-item__black-list"),this.$els.blacklist.hide()}showBlacklist(){this.show(),this.$els.blacklist.show(),this.$els.items.hide()}_hasRequestCache(t){return o.F.hasSearchCache(t)}async _requestItems(t,e){return this.$els.items.show(),this.$els.blacklist.hide(),await o.F.search(t)}}},9025:(t,e,s)=>{"use strict";s.d(e,{Z:()=>l});s(4916);var i=s(5448),n=s(2567),o=s(7725),r=s(8924),a=s(9050);class l extends i.V{constructor(t){super(a.defaults(t,{useNumericIds:!1,filter:r.ll.ALL})),this.items.DataObject=n.U,this._tagsLineMode=!0===(t||{}).tagsLine}_hasRequestCache(t){return o.Hx.hasSearchCache(t,this.filter)}_requestItems(t,e){return this._tagsLineMode?o.Hx.searchTagsLine(t):o.Hx.search(t,this.filter)}get filter(){return this._options.filter}}},3674:(t,e,s)=>{"use strict";s.d(e,{x:()=>r});s(4916),s(8674);var i=s(5448),n=s(4706),o=s(8881);class r extends i.V{constructor(t){super(t),this.items.DataObject=n.VV,this.minQueryLength=3,this.editorReplacer={prefix:"@",suffix:", ",whitelist:/([.+a-zа-яё0-9]*)/i}}_requestItems(t,e){return o.Users.search(t)}_hasRequestCache(t){return o.Users.hasSearchCache(t)}async setPredefinedUsersInStory(t,e){let s=await o.Users.predefinedInStory(t,e);this.predefinedItems.set(s),this.predefinedItems.items.forEach((t=>t.marks.set("isPredefined",!0)))}}},2154:(t,e,s)=>{"use strict";s.d(e,{l:()=>C,Y:()=>E});s(6992),s(3948),s(8674),s(4916),s(5306);var i=s(8211),n=s(637);const o=s(9755);let r=function(){var t=this;this.button=document.createElement("button"),this.button.className="medium-editor-action medium-editor-action-quote",this.button.innerHTML='<i class="fa fa-quote-left"></i>',this.button.onclick=function(e){t.onClick.call(t,e)},this.up=function(t,e){do{if(1===t.nodeType&&t.nodeName.toLowerCase()===e.toLowerCase())return t}while(t=t.parentNode);return!1}};r.prototype.onClick=function(){var t=window.getSelection().getRangeAt(0),e=this.up(t.startContainer,"blockquote"),s=o(e);if(e)s.parent().append(e.innerHTML),s.remove();else{let s=t.startContainer.parentNode,i=t.endContainer.parentNode,n=this.up(t.startContainer,"p"),o=this.up(t.endContainer,"p");"#text"===t.startContainer.nodeName&&n&&(s=n),"#text"===t.endContainer.nodeName&&o&&(i=o),0===t.endOffset&&i?t.setEndBefore(t.endContainer):i&&t.setEndAfter(i),s&&t.setStartBefore(s),e=document.createElement("blockquote"),t.surroundContents(e)}},r.prototype.getButton=function(){return this.button},r.prototype.checkState=function(t){this.up(t,"blockquote")&&this.button.classList.add("medium-editor-button-active")},r.prototype.coverAll=function(t){var e,s=[];for(e=0;e<this.rangeCount;e++){let t=this.getRangeAt(e);t.setStart(t.startContainer,0),t.setEnd(t.endContainer,t.endContainer.nodeValue.length),s.push(t)}for(t.removeAllRanges(),e=0;e<s.length;e++)t.addRange(s[e])};var a=s(8097),l=s(3363),h=s(7686);const c={name:"bold",action:"bold",aria:i.ZP.i18n("editor.buttons.bold"),tagNames:["b"],style:{prop:"font-weight",value:"700|bold"},useQueryState:!0,contentDefault:i.ZP.icon("editor__bold")},d={name:"italic",action:"italic",aria:i.ZP.i18n("editor.buttons.italic"),tagNames:["i"],useQueryState:!1,contentDefault:i.ZP.icon("editor__italic")},u={name:"strikethrough",action:"strikethrough",aria:i.ZP.i18n("editor.buttons.strikethrough"),tagNames:["strike"],style:{prop:"text-decoration",value:"line-through"},useQueryState:!0,contentDefault:i.ZP.icon("editor__strikethrough")},p={name:"anchor",action:"createLink",aria:i.ZP.i18n("editor.buttons.anchor"),tagNames:["a"],contentDefault:i.ZP.icon("editor__anchor")},m={name:"quote",action:"append-blockquote",aria:i.ZP.i18n("editor.buttons.quote"),tagNames:["blockquote"],contentDefault:i.ZP.icon("editor__quote")},_={name:"justifyLeft",action:"justifyLeft",aria:i.ZP.i18n("editor.buttons.justifyLeft"),tagNames:[],style:{prop:"text-align",value:"left"},contentDefault:i.ZP.icon("editor__justify-left")},g={name:"justifyCenter",action:"justifyCenter",aria:i.ZP.i18n("editor.buttons.justifyCenter"),tagNames:[],style:{prop:"text-align",value:"center"},contentDefault:i.ZP.icon("editor__justify-center")},v={name:"justifyRight",action:"justifyRight",aria:i.ZP.i18n("editor.buttons.justifyRight"),tagNames:[],style:{prop:"text-align",value:"right"},contentDefault:i.ZP.icon("editor__justify-right")};var f=s(4437),y=s(5035);const b=s(9755),w=s(6419);class E extends l.Y1{constructor(t){super(t),w.isUndefined(this._options.canAddAnchor)&&(this._options.canAddAnchor=!0),this.$el&&this.render()}destroy(){this._editor.destroy(),super.destroy()}render(){if(this.isRendered)return this;super.render(),this.els.input.defaultValue=this.value;const t=this.canAddAnchor?[c,d,u,p,m]:[c,d,u,m];return(i.vE.isUserModerator||i.vE.isInternalStaff)&&t.push(_,g,v),this.validationRules=new Map,this.validationRules.set("^validation-rules.not-contain-link",{validationFunction:l.cX.isNotContainLink(),analyticsType:y.tQ[y.A2.ERROR_TITLE_CONTAIN_LINK]}),this._editor=new n.t(this.$els.input[0],{disableReturn:this.disableReturn,imageDragging:!1,toolbar:{buttons:t,static:this.isToolbarButtonsDisabled},placeholder:{text:this.$els.input.data("placeholder")||i.vE.i18n("editor.placeholder.editor"),hideOnClick:!0},extensions:{bq:new r},anchor:{placeholderText:i.vE.i18n("editor.placeholder.anchor"),linkValidation:!0,targetCheckbox:!1},paste:{forcePlainText:!0},keyboardCommands:{commands:[{command:function(){},key:"U",meta:!0,shift:!1,alt:!1}]}}),this._lastHeight=this.$els.input.height(),this._initialHeight=this._lastHeight,this._editor.subscribe("editableInput",this.onChange.bind(this)),this.$els.input.on("update",this.onChange.bind(this)),this._editor.subscribe("editablePaste",(()=>{this.$els.input.focus(),this.onChange()})),this.$els.input.on("update",(()=>this.timeout("update",50,(()=>{this._editor.trigger("blur",null,this.els.input)})))),this._hotkeys=new a.SV(this.$els.input),this._hotkeys.on(["left","right"],(async()=>{this.suggestion&&await this._searchSuggestion()})),this._hotkeys.on("backspace",this.onChange.bind(this)),this._hotkeys.on("escape",(()=>{this.suggestion&&this.suggestion.isShown?this.suggestion.hide():this.emit("escape")})),this._hotkeys.on("enter",(t=>{this.emit("enter",t)}),{type:a.FM.KEYDOWN,ignoreModifiers:!0}),this.submitHotkey&&this._hotkeys.on(this.submitHotkey,this._submit.bind(this),{type:a.FM.KEYDOWN}),this.newlineHotkey&&this._hotkeys.on(this.newlineHotkey,this._newline.bind(this),{type:a.FM.KEYDOWN}),this.suggestion&&(this.suggestion.targetInput=this.$els.input),this._saveCaretPositionThrottle=w.throttle(this.saveCaretPosition.bind(this),400),this}focus(){return this.$els.input.focus(),this._editor.trigger("focus",null,this.els.input),this.restoreCaretPosition(),this}updateTitleValidationRules(t){const e=t?f.Jc:f.S8;this.validationRules.set(`^validation-rules.range-title('${f.RI}', '${f.S8}')`,{validationFunction:l.cX.isLength(f.RI,e),analyticsType:y.tQ[y.A2.ERROR_TITLE_RANGE]})}blur(){return this.$els.input.blur(),this._editor.trigger("blur",null,this.els.input),this}turnOff(){return this.disabled=!0,this._hotkeys.off(),this._editor.destroy(),this._editor=new n.t(this.$els.input[0],{disableEditing:!0,disableReturn:!0,imageDragging:!1,paste:{forcePlainText:!1,cleanPastedHTML:!1},placeholder:{text:this.$els.input.data("placeholder")||i.vE.i18n("editor.placeholder.editor"),hideOnClick:!1}}),this}onChange(t){this.value||(this.isFixedValue=!1);const e=this.$els.input.height();return this._lastHeight!==e&&(this._lastHeight=e,this.emit("resize",this._initialHeight===e)),super.onChange(t)}_searchSuggestion(){if(this.marks.has("skipNextSearch"))return void this.marks.delete("skipNextSearch");let t=window.getSelection();if(!t.rangeCount)return void(this.suggestion.query=!1);let e,s,n,o,r,a,l=t.getRangeAt(0),h=l.cloneRange();l.startContainer&&3===l.startContainer.nodeType?(h.selectNodeContents(l.startContainer),e=h.toString(),s=e.substring(0,l.startOffset),o=this.suggestion.editorReplacer.search(s),w.isNull(o)?this.suggestion.query=!1:(r=l.cloneRange(),r.setStart(l.startContainer,l.startOffset-(o.length+1)),a=r.getBoundingClientRect(),n={top:a.top+i.vE.ui.scrollTop,left:a.left+i.vE.ui.scrollLeft},r.detach(),this.suggestion.target={height:a.height,offset:n},this.suggestion.query=o)):this.suggestion.query=!1}_onSuggestionSelect(t){if(w.isNull(t))return this.suggestion.hide(),this;this.isFocused?this.marks.set("skipNextSearch",!0):this.restoreCaretPosition();let e,s,i=window.getSelection(),n=i.getRangeAt(0),o=n.cloneRange();o.selectNodeContents(n.startContainer),e=o.toString();const[r,a]=this.suggestion.editorReplacer.replace(e.substring(0,n.startOffset),e.substring(n.startOffset),t.data.name);return n.selectNodeContents(n.startContainer),n.deleteContents(),s=document.createTextNode(r+a),n.insertNode(s),n.setStart(s,r.length),n.collapse(!0),i.removeAllRanges(),i.addRange(n),this.suggestion.hide(),this}saveCaretPosition(t=!1){let e=window.getSelection().getRangeAt(0).cloneRange();return t?(e.setStart(this.els.input,0),this._lastRange=e.toString().length):this._lastRange=e,this}restoreCaretPosition(){if(w.isUndefined(this._lastRange))return this;let t=window.getSelection();if(w.isNumber(this._lastRange)){let e=E.getTextNodeAtPosition(this.els.input,this._lastRange),s=new Range;t.removeAllRanges(),s.setStart(e.node,e.position),t.addRange(s)}else t.removeAllRanges(),t.addRange(this._lastRange);return this}static getTextNodeAtPosition(t,e){let s=null,i=document.createTreeWalker(t,NodeFilter.SHOW_TEXT,(t=>e>t.textContent.length?(e-=t.textContent.length,s=t,NodeFilter.FILTER_REJECT):NodeFilter.FILTER_ACCEPT),void 0).nextNode();return{node:i||t,position:i?e:0}}onKeyUp(t){super.onKeyUp(t),this._saveCaretPositionThrottle()}onBlur(t){return super.onBlur(t),this}onClick(t){this.els.input.contains(t.target)?this.saveCaretPosition():this.focus()}paste(t,e){return this._editor.pasteHTML(t,e),this.saveCaretPosition(),this}_submit(t){if(t&&w.isFunction(t.preventDefault)&&t.preventDefault(),this.suggestion&&this.suggestion.isShown)return;let e=this.el.closest("form");e&&b(e).trigger("submit")}_newline(t){t&&w.isFunction(t.preventDefault)&&t.preventDefault(),document.execCommand("insertHTML",!1,"<br>")}get textContentLength(){return this.textContent.length}